Imports System.Drawing
Imports System.Drawing.Imaging

' ********************************************************************************
' Copyright 2004-11. JETNET,LLC. All rights reserved.
'
'$$Archive: /commonWebProject/PDF_Creator.aspx.vb $
'$$Author: Amanda $

'$$Date: 7/06/20 4:20p $
'$$Modtime: 7/06/20 2:33p $



'$$Revision: 24 $
'$$Workfile: PDF_Creator.aspx.vb $
'  
' ********************************************************************************
Partial Public Class PDF_Creator

    Inherits System.Web.UI.Page

    Public report_id As Integer = 0
    Public ac_id As Long = 0

    Public yacht_id As Long = 0
    Public comp_id As Long = 0
    Public report_area As String = ""

    Public Const RPT_MAX_DIM = 4

    Public Const RPT_ID = 0
    Public Const RPT_DESC = 1
    Public Const RPT_TITLE = 2
    Public Const RPT_OUTPUT = 3
    Public Const RPT_SUBMIT = 4

    Public report_array(,) As String = Nothing

    Public bBlockedReport As Boolean = False
    Public bSubmitSuccess As Boolean = False
    Public bCantSubmitFlag As Boolean = False

    Public bHtmlReport As Boolean = False
    Public bExcelReport As Boolean = False
    Public bTextCommaReport As Boolean = False
    Public bTextTabReport As Boolean = False
    Public bWordReport As Boolean = False
    Public bPdfReport As Boolean = False

    Public bDemoUser As Boolean = False
    Public bMarketingUser As Boolean = False

    Public bAerodexFlag As Boolean = False
    Public bExportFlag As Boolean = False
    Public bCanUseLocalNotes As Boolean = False
    Public bHasServerNotes As Boolean = False
    Public bHasStandardCloudNotes As Boolean = False
    Public bIsHomebase As Boolean = False
    Public bFromEventDetail As Boolean = False
    Public Counter_For_PDF As Integer = 0

    Public sReportFilename As String = ""

    Protected localFunctions As reportFunctions

    Private nFractionalExpireYear As Long = 0
    Private sFractionalExpireFlag As String = ""

    Private nFractionalModelID As Long = 0
    Private nFractionalProgramID As Long = 0
    Private nFractionalProgramCompanyID As Long = 0
    Private yacht_journal_id As Long = 0
    Private yacht_journal_date As String = ""

    Private bIsMac As Boolean = False
    Public nAircraftJournalID_Full As Long = 0



    Public first_ac_pic As String = ""
    Public ac_features As String = ""
    Public add_data As String = ""
    Public int_section As String = ""
    Public int_moyear As String = ""
    Public ext_section As String = ""
    Public ext_moyear As String = ""
    Public Header_Company_Name As String = ""
    Public comp_address As String = ""
    Public comp_logo As String = ""
    Public NEW_AC_ID As Long = 0
    Public NEW_AMOD_ID As Long = 0
    Public NEW_COMP_ID As Long = 0
    Public acdet = New StringBuilder()
    Public engine_info As String = ""
    Public apu_data As String = ""
    Public ac_year_display As String = ""
    Public word_width_new As String = "640"
    Public word_width_new_half As String = "300"
    Public word_half As String = "350"

    Public spacer_width As String = "218"
    Public word_width As String = "110%"
    Public pdf_html_width As String = "95%"
    Public feat_string As String = ""
    Public made_first_page As Boolean = False
    Public has_desription_spec As Boolean = True
    Dim util_functions As New utilization_functions
    Dim searchCriteria As New viewSelectionCriteriaClass
    Dim use_insight_op As Boolean = False
    Dim use_insight_roll As Boolean = False
    Dim use_insight_own As Boolean = False
    Dim use_insight_manu As Boolean = False
    Dim use_insight_dealer As Boolean = False
    Dim use_insight_lease As Boolean = False
    Dim use_insight_finance As Boolean = False
    Dim operator_functions As New operator_view_functions
    Dim acdealer_view_function As New aircraft_dealer_functions
    Dim AclsData_Temp As New clsData_Manager_SQL
    Dim manufacturer_functions As New manufacturer_view_functions
    Dim financial_documents_functions As New financial_view_functions
    Dim market_functions As New market_model_functions
    Private localDatalayer As viewsDataLayer
    Dim lease_functions As New lease_view_functions
    Dim comp_functions As New CompanyFunctions
    Dim ShowNewTemplate As Boolean = False
    Dim SerNoHeader As String = ""
    Dim ac_ser As String = ""
    Dim ac_reg As String = ""
    Dim ac_make As String = ""
    Dim ac_model As String = ""
    Dim TableColor As String = "blue"
    Dim AirframeString As String = ""
    Dim int_ext_count As Integer = 0
    Dim maint_count As Integer = 0
    Dim apu_count As Integer = 0
    Dim avionics_count As Integer = 0
    Dim temp_ac_dlv_year As Long = 0
    Dim JETNET_OR_CLIENT As String = "JETNET"
    Public COMP_JETNET_ID As Long = 0
    Public client_comp_id As Long = 0
    Dim feature_code_list(,) As String = Nothing
    Dim feature_code_count As Integer = 0

    Protected Sub Page_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load

        Dim sErrorString As String = ""
        Dim reportIDExistInURL As Boolean = False
        If Session.Item("crmUserLogon") <> True And Trim(Request("homebase")) <> "Y" Then
            Response.Redirect("Default.aspx", False)
        ElseIf HttpContext.Current.Session.Item("jetnetWebHostType") <> crmWebClient.eWebHostTypes.HOMEBASE And Trim(Request("homebase")) = "Y" Then
            ' if we arent on homebase.com, but have passed homebasee, then bad
            Response.Redirect("Default.aspx", False)
        Else

            Server.ScriptTimeout = 1200

            localFunctions = New reportFunctions
            localFunctions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim

            If Not Session.Item("localPreferences").loadUserSession(sErrorString,
                                                                    CLng(Session.Item("localUser").crmSubSubID.ToString),
                                                                    Session.Item("localUser").crmUserLogin.ToString,
                                                                    CLng(Session.Item("localUser").crmSubSeqNo.ToString),
                                                                    CLng(Session.Item("localUser").crmUserContactID.ToString)) Then
                Response.Write("error in load PDF Creator : " + sErrorString)
            End If

            localFunctions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            localFunctions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            localFunctions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            localFunctions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

            Dim fSubins_platform_os As String = commonEvo.getBrowserCapabilities(Request.Browser)

            If fSubins_platform_os.Substring(0, 7).ToLower.Trim.Contains("mac") Then
                bIsMac = True
            End If

            ' set aerodex flag for sample script
            bAerodexFlag = HttpContext.Current.Session.Item("localPreferences").AerodexFlag
            bCanUseLocalNotes = HttpContext.Current.Session.Item("localPreferences").EnableNotesFlag
            bHasStandardCloudNotes = HttpContext.Current.Session.Item("localPreferences").HasCloudNotes
            bHasServerNotes = HttpContext.Current.Session.Item("localPreferences").HasServerNotes

            bExportFlag = HttpContext.Current.Session.Item("localPreferences").ExportReportFlag
            bDemoUser = Session.Item("localPreferences").DemoFlag
            bMarketingUser = Session.Item("localPreferences").MarketingFlag

            ' override the export flag for marketing or demo users
            bExportFlag = IIf(bDemoUser, False, True)

            bExportFlag = IIf(bMarketingUser, False, True)

            ' overides selected report
            If Not IsNothing(Request.Item("r_id")) Then
                If Not String.IsNullOrEmpty(Request.Item("r_id").ToString.Trim) Then
                    If IsNumeric(Request.Item("r_id").ToString) And CInt(Request.Item("r_id").ToString) Then
                        report_id = CInt(Request.Item("r_id").ToString)
                        reportIDExistInURL = True
                    End If
                End If
            End If

            If Not IsNothing(Request.Item("export_type")) Then
                If Not String.IsNullOrEmpty(Request.Item("export_type").ToString.Trim) Then
                    report_area = Request.Item("export_type").ToString.ToUpper.Trim
                End If
            End If

            'Checking for Aircraft ID, meaning we're doing a report on a single aircraft
            If Not IsNothing(Request.Item("ac_id")) Then
                If Not String.IsNullOrEmpty(Request.Item("ac_id").ToString.Trim) Then
                    If IsNumeric(Request.Item("ac_id").ToString) Then
                        ac_id = CLng(Request.Item("ac_id").ToString)
                    End If
                End If
            End If

            'Checking for Aircraft ID, meaning we're doing a report on a single aircraft
            If Not IsNothing(Request.Item("amod_id")) Then
                If Not String.IsNullOrEmpty(Request.Item("amod_id").ToString.Trim) Then
                    If IsNumeric(Request.Item("amod_id").ToString) Then
                        NEW_AMOD_ID = CLng(Request.Item("amod_id").ToString)
                    End If
                End If
            End If



            If Not IsNothing(Request("IS_CLIENT")) Then
                If Trim(Request("IS_CLIENT")) = "CLIENT" Then

                    If Not IsNothing(Request.Item("comp_id")) Then
                        If Not String.IsNullOrEmpty(Request.Item("comp_id").ToString.Trim) Then
                            If IsNumeric(Request.Item("comp_id").ToString) Then
                                client_comp_id = CLng(Request.Item("comp_id").ToString)
                            End If
                        End If
                    End If

                    Dim ClientCheck As DataTable = Master.aclsData_Temp.GetCompanyInfo_ID(client_comp_id, "CLIENT", 0)
                    If Not IsNothing(ClientCheck) Then 'not nothing
                        If ClientCheck.Rows.Count > 0 Then
                            comp_id = ClientCheck.Rows(0).Item("jetnet_comp_id")
                        End If
                    End If

                Else
                    If Not IsNothing(Request.Item("comp_id")) Then
                        If Not String.IsNullOrEmpty(Request.Item("comp_id").ToString.Trim) Then
                            If IsNumeric(Request.Item("comp_id").ToString) Then
                                comp_id = CLng(Request.Item("comp_id").ToString)
                            End If
                        End If
                    End If
                End If
            Else
                If Not IsNothing(Request.Item("comp_id")) Then
                    If Not String.IsNullOrEmpty(Request.Item("comp_id").ToString.Trim) Then
                        If IsNumeric(Request.Item("comp_id").ToString) Then
                            comp_id = CLng(Request.Item("comp_id").ToString)
                        End If
                    End If
                End If
            End If









            'Checking for Yacht ID, meaning we're doing a report on a single yacht
            If Not IsNothing(Request.Item("yacht_id")) Then
                If Not String.IsNullOrEmpty(Request.Item("yacht_id").ToString.Trim) Then
                    If IsNumeric(Request.Item("yacht_id").ToString) Then
                        yacht_id = CLng(Request.Item("yacht_id").ToString)
                    End If
                End If
            End If

            If Not IsNothing(Request.Item("jid")) Then
                If Not String.IsNullOrEmpty(Request.Item("jid").ToString.Trim) Then
                    If IsNumeric(Request.Item("jid").ToString) Then
                        yacht_journal_id = CLng(Request.Item("jid").ToString)
                    End If
                End If
            End If


            If Not IsNothing(Request.Item("journ_id")) Then
                If Not String.IsNullOrEmpty(Request.Item("journ_id").ToString.Trim) Then
                    If IsNumeric(Request.Item("journ_id").ToString) Then
                        If report_id = 53 And CLng(Request.Item("journ_id")) > 0 Then
                            report_id = 41
                            nAircraftJournalID_Full = CLng(Trim(Request("journ_id")))
                        End If
                    End If
                End If
            End If


            ' values for fractional report
            If Not IsNothing(Request.Item("expireYear")) Then
                If Not String.IsNullOrEmpty(Request.Item("expireYear").ToString.Trim) Then
                    If IsNumeric(Request.Item("expireYear").ToString) And CLng(Request.Item("expireYear").ToString) Then
                        nFractionalExpireYear = CLng(Request.Item("expireYear").ToString)
                    End If
                End If
            End If

            If Not IsNothing(Request.Item("expireFlag")) Then
                If Not String.IsNullOrEmpty(Request.Item("expireFlag").ToString.Trim) Then
                    sFractionalExpireFlag = Request.Item("expireFlag").ToString.ToUpper.Trim
                End If
            End If

            If Not IsNothing(Request.Item("frAmodID")) Then
                If Not String.IsNullOrEmpty(Request.Item("frAmodID").ToString.Trim) Then
                    If IsNumeric(Request.Item("frAmodID").ToString) And CLng(Request.Item("frAmodID").ToString) Then
                        nFractionalModelID = CLng(Request.Item("frAmodID").ToString)
                    End If
                End If
            End If

            If Not IsNothing(Request.Item("frProgramID")) Then
                If Not String.IsNullOrEmpty(Request.Item("frProgramID").ToString.Trim) Then
                    If IsNumeric(Request.Item("frProgramID").ToString) And CLng(Request.Item("frProgramID").ToString) Then
                        nFractionalProgramID = CLng(Request.Item("frProgramID").ToString)
                    End If
                End If
            End If

            If Not IsNothing(Request.Item("homebase")) Then
                If Not String.IsNullOrEmpty(Request.Item("homebase").ToString.Trim) Then
                    bIsHomebase = Request.Item("homebase").ToString.ToUpper.Contains("Y")
                End If
            End If

            If Not IsNothing(Request.Item("eventDetail")) Then
                If Not String.IsNullOrEmpty(Request.Item("eventDetail").ToString.Trim) Then
                    bFromEventDetail = Request.Item("eventDetail").ToString.ToUpper.Contains("Y")
                End If
            End If

            If Not IsNothing(Request.Item("word_width")) Then
                If Not String.IsNullOrEmpty(Request.Item("word_width").ToString.Trim) Then
                    word_width = Request.Item("word_width").ToString.ToUpper.Contains("Y")
                End If
            End If

            If Not IsNothing(Request.Item("pdf_html_width")) Then
                If Not String.IsNullOrEmpty(Request.Item("pdf_html_width").ToString.Trim) Then
                    pdf_html_width = Request.Item("pdf_html_width").ToString.ToUpper.Contains("Y")
                End If
            End If


            set_start_help_text(bExportFlag)

            standard_report_options.Visible = False

            ' if report is selected then show   Trim(Request("homebase")) = "Y"
            If Not IsNothing(reportsListID.SelectedValue) And Not String.IsNullOrEmpty(reportsListID.SelectedValue) Then
                If CInt(reportsListID.SelectedValue.ToString) > 0 Then

                    'check and see if a user selected an item so we can set right selection on postback
                    For x As Integer = 0 To reportType.Items.Count - 1

                        If reportType.Items(x).Selected Then

                            Select Case reportType.Items(x).Text.ToLower

                                Case "html"
                                    bHtmlReport = True
                                Case "excel"
                                    bExcelReport = True
                                Case "word"
                                    bWordReport = True
                                Case "pdf"
                                    bPdfReport = True
                                Case "text (comma delimited)"
                                    bTextCommaReport = True
                                Case "text (tab delimited)"
                                    bTextTabReport = True
                            End Select

                        End If

                    Next

                    report_id = CInt(reportsListID.SelectedValue.ToString)

                    create_reports_list()

                    Select Case report_id

                        Case Is = 39, 40, 41, 43, 53

                            If bExportFlag Then btnRunReport.Visible = True

                            btnSampleID.Visible = False

                        Case Else

                            If bExportFlag Then btnRunReport.Visible = True

                            btnSampleID.Visible = True

                    End Select

                End If

            Else

                If report_id > 0 Then

                    reportsListID.SelectedValue = report_id.ToString

                    Select Case report_id

                        Case Is = 39, 40, 41, 43, 53

                            If bExportFlag Then btnRunReport.Visible = True

                            btnSampleID.Visible = False

                        Case Else

                            If bExportFlag Then btnRunReport.Visible = True

                            btnSampleID.Visible = True

                    End Select

                End If

                create_reports_list()

            End If

            ' report options are "enabled / disabled" inset_report_types_checks function not on page load

            ' have to clear values between different reports
            If Not IsNothing(HttpContext.Current.Session.Item("lastSelectedReport")) Then
                If CInt(HttpContext.Current.Session.Item("lastSelectedReport").ToString) <> report_id Then

                    bHtmlReport = False
                    bExcelReport = False
                    bWordReport = False
                    bPdfReport = False
                    bTextCommaReport = False
                    bTextTabReport = False

                    If report_id <> 18 And report_id <> 19 Then
                        chkSubmitReport.Checked = False
                    End If

                    HttpContext.Current.Session.Item("lastSelectedReport") = report_id

                End If


                ' If Trim(Request("test")) = "Y" Then
                ' officially replacing report 47 with report 54 - per requuest 3/2/17
                If report_id = 47 And Trim(Request("homebase")) <> "Y" Then
                    report_id = 54
                End If
                ' End If  

                set_report_types_checks()

                'If Trim(Request("test")) = "Y" Then
                'If report_id = 54 Then
                '   report_id = 47
                '  End If
                '  End If


            Else

                HttpContext.Current.Session.Item("lastSelectedReport") = report_id

                If report_id = 39 Or report_id = 40 Or report_id = 41 Or report_id = 43 Or report_id = 47 Or report_id = 53 Or report_id = 54 Then
                    If report_id = 47 And Trim(Request("homebase")) <> "Y" Then
                        report_id = 54
                    End If

                    set_report_types_checks()

                    '  If report_id = 54 Then
                    '    report_id = 47
                    '  End If
                End If

            End If

            Dim postbackString As String = ScriptManager.GetCurrent(Page).AsyncPostBackSourceElementID

            If ((Not IsPostBack) Or (postbackString = reportsListID.UniqueID And reportIDExistInURL)) Then
                Run53Graphs()
            End If


            ' if there is an ac_id then get the make / model name
            If ac_id > 0 And (report_id = 39 Or report_id = 40 Or report_id = 41 Or report_id = 53) Then
                Dim CRMSource As String = ""
                Dim acInfoArray() As String = Split("", "")

                If Not String.IsNullOrEmpty(Trim(Request("source"))) Then
                    If Trim(Request("source")) = "CLIENT" Then
                        If IsNumeric(Trim(Request("otherID"))) Then
                            acInfoArray = Split(commonEvo.GetAircraftInfo(CLng(Trim(Request("otherID"))), False), Constants.cSvrDataSeperator)
                        End If
                    End If
                End If

                If UBound(acInfoArray) = 0 Then
                    acInfoArray = Split(commonEvo.GetAircraftInfo(ac_id, False), Constants.cSvrDataSeperator)
                End If

                Dim type_of_ac As String = acInfoArray(0).ToString + " " + acInfoArray(1).ToString

                'Setting the tab container inside headers (blue bar)
                If Not String.IsNullOrEmpty(type_of_ac.Trim) Then
                    report_description_label.Text += " for <strong>" + type_of_ac.Trim + "</strong>"
                End If

                report_description_label.Text += " <strong> Ser#: " + acInfoArray(2).ToString.Trim + "</strong>"

                If Not IsPostBack Then
                    features_text.Text = feat_string
                End If

                If report_id = 53 Then
                    features_panel.Visible = True
                Else
                    features_panel.Visible = False
                End If

            ElseIf ac_id = 0 And (report_id = 39 Or report_id = 40 Or report_id = 41 Or report_id = 53) Then
                report_description_label.Text += " for <strong>ALL aircraft in current list</strong>"
            End If


            ' if there is an yacht_id then get the brand / model name
            If yacht_id > 0 And report_id = 43 Then

                Dim yachtInfoArray() As String = Split(commonEvo.GetYachtInfo(yacht_id, False), Constants.cSvrDataSeperator)
                Dim type_of_yacht As String = yachtInfoArray(0).ToString + " " + yachtInfoArray(1).ToString

                'Setting the tab container inside headers (blue bar)
                If Not String.IsNullOrEmpty(type_of_yacht.Trim) Then
                    report_description_label.Text += " for <strong>" + type_of_yacht.Trim + "</strong>"
                End If

            ElseIf yacht_id = 0 And report_id = 43 Then
                report_description_label.Text += " for <strong>ALL yachts in current list</strong>"
            End If

            If Not IsPostBack Then

                If report_id = 0 Then
                    Master.SetPageTitle("Jetnet Export/Reports")  ' sets the report title when a report is not selected
                End If

                submit_report_panel.Visible = False
                chkShowAsking.Checked = True
                If Not IsNothing(HttpContext.Current.Request.Cookies("chkShowAsking")) Then
                    If Not IsNothing(HttpContext.Current.Request.Cookies("chkShowAsking").Values("ID")) Then
                        If Trim(Left(HttpContext.Current.Request.Cookies("chkShowAsking").Values("ID"), 1)) = "1" Then
                            chkShowAsking.Checked = True
                        Else
                            chkShowAsking.Checked = False
                        End If
                    End If
                End If

            Else

                If chkSubmitReport.Checked And Not String.IsNullOrEmpty(replyEmail.Text.Trim) And Not String.IsNullOrEmpty(replyUsername.Text.Trim) Then

                    Dim tmpIndex As Integer = 0
                    Dim bSubmit As Boolean = False

                    For x As Integer = 0 To UBound(report_array)
                        If report_id = CInt(report_array(x, RPT_ID).ToString) Then
                            tmpIndex = x
                            bSubmit = report_array(x, RPT_SUBMIT).ToString.ToUpper.Contains("Y")
                            Exit For
                        End If
                    Next

                    ' double check that we can still "submit" this report
                    If bSubmit Then
                        ' make sure a report type is selected before submitting
                        If bHtmlReport Or bExcelReport Or bTextCommaReport Or bTextTabReport Then
                            bSubmitSuccess = submit_report_request(report_id, report_array(tmpIndex, RPT_TITLE).ToString)
                        Else
                            bCantSubmitFlag = True
                        End If

                    Else
                        bCantSubmitFlag = True
                    End If

                End If

            End If

            replyEmail.Attributes.Add("onblur", "javascript:validateEmailAddress();")
            add_ValidateEmailAddress_Script(replyEmail)

            replyUsername.Attributes.Add("onblur", "javascript:validateEmailText();")
            add_validateEmailText_Script(replyUsername)

            chkSubmitReport.Attributes.Add("onclick", "javascript:toggleRunButtonName();")
            add_ToggleSubmitReport_Script(chkSubmitReport, btnRunReport)

            chkShowAsking.Attributes.Add("onclick", "javascript:EnableAddAskingTextBox();")
            add_EnableShowAskingTextBox_Script(chkShowAsking, addToAsking)

            chkIncludeContacts.Attributes.Add("onclick", "javascript:EnableShowAllContacts();")
            add_EnableShowAllContactsCheckBox_Script(chkIncludeContacts, chkIncludeAllContacts)

            btnSampleID.OnClientClick = "javascript:viewSampleReportJS('" + report_id.ToString + "');"

        End If

        If Not IsPostBack Then

            If (bIsHomebase And report_id = 47) Or (bIsHomebase And report_id = 999) Or (bIsHomebase And report_id = 54) Then

                If Not IsNothing(HttpContext.Current.Session.Item("jetnetAdminDatabase")) Then
                    Master.aclsData_Temp.JETNET_DB = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
                End If

                HttpContext.Current.Session.Item("localSubscription").crmBusiness_Flag = True
                HttpContext.Current.Session.Item("localSubscription").crmHelicopter_Flag = True
                HttpContext.Current.Session.Item("localSubscription").crmCommercial_Flag = True
                HttpContext.Current.Session.Item("localSubscription").crmJets_Flag = True
                HttpContext.Current.Session.Item("localSubscription").crmExecutive_Flag = True
                HttpContext.Current.Session.Item("localSubscription").crmTurboprops = True


                reportType.SelectedIndex = 2
                chkIncludeContacts.Checked = True
                chk_related_comp.Checked = True
                chkIncludeCompAC.Checked = True
                chkincludeCompYacht.Checked = True
                If (bIsHomebase And (report_id = 47 Or report_id = 54)) Then
                    chk_comp_wanteds.Checked = True
                End If
                bHtmlReport = True
                create_report_file()

            End If
        End If



        If HttpContext.Current.Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.YACHT Then
            btnSampleID.Visible = False
        End If

        ' moved from the 53 section above to also be down here 
        System.Web.UI.ScriptManager.RegisterStartupScript(Page, Me.GetType(), "ToggleHidden", "<script type=""text/javascript"">$(""body"").removeClass(""loading"");</script>", False)


    End Sub
    Private Sub Run53Graphs()
        If report_id = 53 Then
            Dim flight_data_temp As New flightDataFunctions
            Dim temp_string As String = ""
            Dim google_string As String = ""
            Dim charting_string As String = ""
            Dim graphVal1 As String = ""
            Dim graphVal2 As String = ""
            Dim graph30_ticks_string As String = ""
            Dim temp_count As Integer = 0
            Dim has_info As Boolean = False
            flight_data_temp.serverConnectStr = Session.Item("jetnetClientDatabase")
            flight_data_temp.clientConnectStr = Session.Item("jetnetServerNotesDatabase")

            If IsNothing(HttpContext.Current.Session.Item("graph_color")) Then
                HttpContext.Current.Session.Item("graph_color") = "#B7DCF6"
            End If

            Call flight_data_temp.make_ac_flights_comparisons(ac_id, temp_string, Nothing, Nothing, NEW_AMOD_ID, start_date, end_date, start_date.Text, ac_reg, 0, 0, False, "", "", 0, Page, check_update, Report_Panel, google_string) '  chart_panel, map_panel)


            Dim utilization_functions1 As New utilization_view_functions
            utilization_functions1.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            utilization_functions1.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            utilization_functions1.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            utilization_functions1.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            utilization_functions1.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

            ' added in MSW - cleared the servernotes so it doesnt bomb out all of the way 
            If HttpContext.Current.Session.Item("jetnetWebHostType") = crmWebClient.eWebHostTypes.HOMEBASE And Trim(Request("homebase")) = "Y" Then
                If Trim(Session.Item("localPreferences").UserDatabaseConn) = "" Then
                    Session.Item("localPreferences").UserDatabaseConn = utilization_functions1.clientConnectStr
                    HttpContext.Current.Session.Item("jetnetServerNotesDatabase") = ""
                End If
            End If

            If temp_ac_dlv_year = 0 Then
                temp_ac_dlv_year = Get_AC_DLV_YEAR(ac_id)
            End If
            Call utilization_functions1.FillAssettInsightGraphs("ASKSOLD", 0, "", select_report_panel, 111, ac_id, 0, 400, 0, True, True, True, "", "A", "", "", "", "", "", "", "", "", "", graphVal1, "", False, True, has_info)

            Call utilization_functions1.FillAssettInsightGraphs("RESIDUALAC", NEW_AMOD_ID, "", select_report_panel, 222, ac_id, 0, 400, temp_ac_dlv_year, True, True, True, "", "Y", "", temp_count, graph30_ticks_string, "", "", "", "", "", "", graphVal2, "", False, True, has_info)


            google_string = Replace(google_string, "data1", "data13")
            google_string = Replace(google_string, "Flights per Month", "Flights/Month")
            google_string = Replace(google_string, "AVG Model Flights/Mo", "Avg Model Flights/Month")
            DisplayFunctions.load_google_chart(select_report_panel, google_string, "", "", "chart_div_tab13_all", 950, 500, "POINTS", 13, charting_string, Page, check_update, False, False, True, False, False, False, False, False, False, False, 0, "top", png13.ClientID, True)

            DisplayFunctions.load_google_chart(New AjaxControlToolkit.TabPanel, graphVal1, "", "Aircraft Value ($k)", "chart_div_tabVal1_all", 950, 500, "POINTS", 111, charting_string, Page, check_update, False, False, True, False, False, False, False, False, False, False, 0, "bottom", pngVal1.ClientID, True)

            DisplayFunctions.load_google_chart(New AjaxControlToolkit.TabPanel, graphVal2, "", "Aircraft Value ($k)", "chart_div_tabVal2_all", 950, 500, "POINTS", 222, charting_string, Page, check_update, False, False, True, False, False, False, False, False, False, False, 0, "bottom", pngVal2.ClientID, True, CInt(temp_count), graph30_ticks_string)


            Call load_google_chart_all(charting_string)

            Call SetUpJavascriptOnClickGoogleGraph()
            System.Web.UI.ScriptManager.RegisterStartupScript(Page, Me.GetType(), "ToggleHidden", "<script type=""text/javascript"">$(""body"").removeClass(""loading"");</script>", False)
        End If
    End Sub
    Protected Sub save_checks_click(ByVal sender As Object, ByVal e As EventArgs) Handles save_checks.Click
        If check_cover.Checked = True Then
            clsGeneral.clsGeneral.Recent_Cookies("check_cover", 1, "JETNET")
        Else
            clsGeneral.clsGeneral.Recent_Cookies("check_cover", 0, "JETNET")
        End If

        If check_airframe.Checked = True Then
            ' Call NEW_CREATE_SPEC_PAGE("airframe", htmlOut)
            clsGeneral.clsGeneral.Recent_Cookies("check_airframe", 1, "JETNET")
        Else
            clsGeneral.clsGeneral.Recent_Cookies("check_airframe", 0, "JETNET")
        End If

        If check_avionics.Checked = True Then
            ' Call NEW_CREATE_SPEC_PAGE("avionics", htmlOut)
            clsGeneral.clsGeneral.Recent_Cookies("check_avionics", 1, "JETNET")
        Else
            clsGeneral.clsGeneral.Recent_Cookies("check_avionics", 0, "JETNET")
        End If

        If check_int_ext.Checked = True Then
            ' Call NEW_CREATE_SPEC_PAGE("intext", htmlOut)
            clsGeneral.clsGeneral.Recent_Cookies("check_int_ext", 1, "JETNET")
        Else
            clsGeneral.clsGeneral.Recent_Cookies("check_int_ext", 0, "JETNET")
        End If

        If check_maint.Checked = True Then
            '  Call NEW_CREATE_SPEC_PAGE("maintadd", htmlOut)
            clsGeneral.clsGeneral.Recent_Cookies("check_maint", 1, "JETNET")
        Else
            clsGeneral.clsGeneral.Recent_Cookies("check_maint", 0, "JETNET")
        End If

        If chkIncludeNotes_53.Checked = True Then
            ' Call NEW_CREATE_SPEC_PAGE("notes", htmlOut)
            clsGeneral.clsGeneral.Recent_Cookies("chkIncludeNotes_53", 1, "JETNET")
        Else
            clsGeneral.clsGeneral.Recent_Cookies("chkIncludeNotes_53", 0, "JETNET")
        End If

        If chkTP_53.Checked = True Then
            ' Call NEW_CREATE_SPEC_PAGE("compcontacts", htmlOut)
            clsGeneral.clsGeneral.Recent_Cookies("chkTP_53", 1, "JETNET")
        Else
            clsGeneral.clsGeneral.Recent_Cookies("chkTP_53", 0, "JETNET")
        End If

        If chkIncludeHistory_53.Checked = True Then
            ' Call NEW_CREATE_SPEC_PAGE("history", htmlOut)
            clsGeneral.clsGeneral.Recent_Cookies("chkIncludeHistory_53", 1, "JETNET")
        Else
            clsGeneral.clsGeneral.Recent_Cookies("chkIncludeHistory_53", 0, "JETNET")
        End If

        If chkPP.Checked = True Then
            '  Call NEW_CREATE_SPEC_PAGE("pics", htmlOut)
            clsGeneral.clsGeneral.Recent_Cookies("chkPP", 1, "JETNET")
        Else
            clsGeneral.clsGeneral.Recent_Cookies("chkPP", 0, "JETNET")
        End If

        '---------- RIGHT SECTION OF CHECKBOXES --------------------------------------

        If logo_check.Checked = True Then
            '  Call NEW_CREATE_SPEC_PAGE("pics", htmlOut)
            clsGeneral.clsGeneral.Recent_Cookies("logo_check", 1, "JETNET")
        Else
            clsGeneral.clsGeneral.Recent_Cookies("logo_check", 0, "JETNET")
        End If

        If check_prepared_for.Checked = True Then
            '  Call NEW_CREATE_SPEC_PAGE("pics", htmlOut)
            clsGeneral.clsGeneral.Recent_Cookies("check_prepared_for", 1, "JETNET")
        Else
            clsGeneral.clsGeneral.Recent_Cookies("check_prepared_for", 0, "JETNET")
        End If


        If chkIncludeKeyFeatures.Checked = True Then
            '  Call NEW_CREATE_SPEC_PAGE("pics", htmlOut)
            clsGeneral.clsGeneral.Recent_Cookies("chkIncludeKeyFeatures", 1, "JETNET")
        Else
            clsGeneral.clsGeneral.Recent_Cookies("chkIncludeKeyFeatures", 0, "JETNET")
        End If

        If chkBlindReport.Checked = True Then
            '  Call NEW_CREATE_SPEC_PAGE("pics", htmlOut)
            clsGeneral.clsGeneral.Recent_Cookies("chkBlindReport", 1, "JETNET")
        Else
            clsGeneral.clsGeneral.Recent_Cookies("chkBlindReport", 0, "JETNET")
        End If

        If chkShowAsking.Checked = True Then
            '  Call NEW_CREATE_SPEC_PAGE("pics", htmlOut)
            clsGeneral.clsGeneral.Recent_Cookies("chkShowAsking", 1, "JETNET")
        Else
            clsGeneral.clsGeneral.Recent_Cookies("chkShowAsking", 0, "JETNET")
        End If


        If chkEB.Checked = True Then
            '  Call NEW_CREATE_SPEC_PAGE("pics", htmlOut)
            clsGeneral.clsGeneral.Recent_Cookies("chkEB", 1, "JETNET")
        Else
            clsGeneral.clsGeneral.Recent_Cookies("chkEB", 0, "JETNET")
        End If

        If chkIncludeBaseLocation.Checked = True Then
            '  Call NEW_CREATE_SPEC_PAGE("pics", htmlOut)
            clsGeneral.clsGeneral.Recent_Cookies("chkIncludeBaseLocation", 1, "JETNET")
        Else
            clsGeneral.clsGeneral.Recent_Cookies("chkIncludeBaseLocation", 0, "JETNET")
        End If

        If chkPP.Checked = True Then
            '  Call NEW_CREATE_SPEC_PAGE("pics", htmlOut)
            clsGeneral.clsGeneral.Recent_Cookies("chkPP_Large", 1, "JETNET")
        Else
            clsGeneral.clsGeneral.Recent_Cookies("chkPP_Large", 0, "JETNET")
        End If



    End Sub

#Region "report_page_script_functions"

    Private Sub add_ValidateEmailAddress_Script(ByVal tbSource As TextBox)

        'Register the script block  /^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i
        '
        Dim sScptStr As StringBuilder = New StringBuilder()

        If Not Page.ClientScript.IsClientScriptBlockRegistered("vea-tb-onblur") Then

            sScptStr.Append("<script type='text/javascript'>")
            sScptStr.Append(vbCrLf + "  function validateEmailAddress() {")
            sScptStr.Append(vbCrLf + "    var txttext = document.getElementById('" + tbSource.ClientID.ToString + "').value;")
            sScptStr.Append(vbCrLf + "    var regex = /^((\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*)\s*[;,]{0,1}\s*)+$/;")

            sScptStr.Append(vbCrLf + "    if (eval(regex.test(txttext)) == false && txttext != """") {")
            sScptStr.Append(vbCrLf + "      alert('Please enter a valid e-mail address i.e. \'youremail@email.com\'');")
            sScptStr.Append(vbCrLf + "      document.getElementById('" + tbSource.ClientID.ToString + "').focus();")
            sScptStr.Append(vbCrLf + "    }")
            sScptStr.Append(vbCrLf + "  }")
            sScptStr.Append(vbCrLf + "</script>")

            Page.ClientScript.RegisterClientScriptBlock(Me.GetType(), "vea-tb-onblur", sScptStr.ToString, False)

        End If

        sScptStr = Nothing

    End Sub

    Private Sub add_validateEmailText_Script(ByVal tbSource As TextBox)

        'Register the script block
        Dim sScptStr As StringBuilder = New StringBuilder()

        If Not Page.ClientScript.IsClientScriptBlockRegistered("vet-tb-onblur") Then

            sScptStr.Append("<script type='text/javascript'>")
            sScptStr.Append(vbCrLf + "  function validateEmailText() {")
            sScptStr.Append(vbCrLf + "    var txttext = document.getElementById('" + tbSource.ClientID.ToString + "').value;")
            sScptStr.Append(vbCrLf + "    var regex = /^([a-zA-Z0-9,\s\-\'\.\@\;\(\)]{1,100})$/;")

            sScptStr.Append(vbCrLf + "    if (eval(regex.test(txttext)) == false && txttext != """") {")
            sScptStr.Append(vbCrLf + "      alert('There are invalid characters in your Reply To name. Please Correct and re-submit');")
            sScptStr.Append(vbCrLf + "      document.getElementById('" + tbSource.ClientID.ToString + "').focus();")
            sScptStr.Append(vbCrLf + "    }")
            sScptStr.Append(vbCrLf + "  }")
            sScptStr.Append(vbCrLf + "</script>")

            Page.ClientScript.RegisterClientScriptBlock(Me.GetType(), "vet-tb-onblur", sScptStr.ToString, False)

        End If

        sScptStr = Nothing

    End Sub

    Private Sub add_ToggleSubmitReport_Script(ByVal cbSource As CheckBox, ByVal btnSource1 As LinkButton)

        'Register the script block  
        Dim sScptStr As StringBuilder = New StringBuilder()

        If Not Page.ClientScript.IsClientScriptBlockRegistered("tsr-cb-onclick") Then

            sScptStr.Append("<script type='text/javascript'>")
            sScptStr.Append(vbCrLf & "  function toggleRunButtonName() {")
            sScptStr.Append(vbCrLf & "    if (document.getElementById('" + cbSource.ClientID.ToString + "').checked == true) {")
            sScptStr.Append(vbCrLf & "      document.getElementById('" + btnSource1.ClientID.ToString + "').innerHTML = 'Submit Report';")
            sScptStr.Append(vbCrLf & "      document.getElementById('" + btnSource1.ClientID.ToString + "').title = 'Submit a request for JETNET to run selected report with options chosen';")
            sScptStr.Append(vbCrLf & "    }")
            sScptStr.Append(vbCrLf & "    else {")
            sScptStr.Append(vbCrLf & "      document.getElementById('" + btnSource1.ClientID.ToString + "').innerHTML = 'Run Report';")
            sScptStr.Append(vbCrLf & "      document.getElementById('" + btnSource1.ClientID.ToString + "').title = 'Run selected report with options chosen';")
            sScptStr.Append(vbCrLf & "    }")
            sScptStr.Append(vbCrLf & "  }")
            sScptStr.Append(vbCrLf & "</script>")

            Page.ClientScript.RegisterClientScriptBlock(Me.GetType(), "tsr-cb-onclick", sScptStr.ToString, False)
        End If

        sScptStr = Nothing

    End Sub

    Private Sub add_EnableShowAskingTextBox_Script(ByVal cbSource As CheckBox, ByVal tbSource As TextBox)

        'Register the script block  
        Dim sScptStr As StringBuilder = New StringBuilder()

        If Not Page.ClientScript.IsClientScriptBlockRegistered("esa-tb-onclick") Then

            sScptStr.Append("<script type='text/javascript'>")
            sScptStr.Append(vbCrLf & "  function EnableAddAskingTextBox() {")
            sScptStr.Append(vbCrLf & "    if (document.getElementById('" + cbSource.ClientID.ToString + "').checked == true) {")
            sScptStr.Append(vbCrLf & "      document.getElementById('" + tbSource.ClientID.ToString + "').disabled = false;")
            sScptStr.Append(vbCrLf & "      document.getElementById('" + tbSource.ClientID.ToString + "').focus();")
            sScptStr.Append(vbCrLf & "    }")
            sScptStr.Append(vbCrLf & "    else {")
            sScptStr.Append(vbCrLf & "      document.getElementById('" + tbSource.ClientID.ToString + "').disabled = true;")
            sScptStr.Append(vbCrLf & "      document.getElementById('" + tbSource.ClientID.ToString + "').value = """";")
            sScptStr.Append(vbCrLf & "      document.getElementById('" + cbSource.ClientID.ToString + "').checked = false;")
            sScptStr.Append(vbCrLf & "    }")
            sScptStr.Append(vbCrLf & "  }")
            sScptStr.Append(vbCrLf & "</script>")

            Page.ClientScript.RegisterClientScriptBlock(Me.GetType(), "esa-tb-onclick", sScptStr.ToString, False)

        End If

        sScptStr = Nothing

    End Sub

    Private Sub add_EnableShowAllContactsCheckBox_Script(ByVal cbSource As CheckBox, ByVal cbSource1 As CheckBox)

        'Register the script block  
        Dim sScptStr As StringBuilder = New StringBuilder()

        If Not Page.ClientScript.IsClientScriptBlockRegistered("esac-ck-onclick") Then

            sScptStr.Append("<script type='text/javascript'>")
            sScptStr.Append(vbCrLf & "  function EnableShowAllContacts() {")
            sScptStr.Append(vbCrLf & "    if (document.getElementById('" + cbSource.ClientID.ToString + "').checked == true) {")
            sScptStr.Append(vbCrLf & "      document.getElementById('" + cbSource1.ClientID.ToString + "').disabled = false;")
            sScptStr.Append(vbCrLf & "    }")
            sScptStr.Append(vbCrLf & "    else {")
            sScptStr.Append(vbCrLf & "      document.getElementById('" + cbSource1.ClientID.ToString + "').disabled = true;")
            sScptStr.Append(vbCrLf & "      document.getElementById('" + cbSource1.ClientID.ToString + "').checked = false;")
            sScptStr.Append(vbCrLf & "    }")
            sScptStr.Append(vbCrLf & "  }")
            sScptStr.Append(vbCrLf & "</script>")

            Page.ClientScript.RegisterClientScriptBlock(Me.GetType(), "esac-ck-onclick", sScptStr.ToString, False)

        End If

        sScptStr = Nothing

    End Sub

#End Region

#Region "report_page_functions"

    Private Sub set_report_types_checks()

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim localAdoRs As System.Data.SqlClient.SqlDataReader : localAdoRs = Nothing
        Dim Query As String : Query = ""
        Dim imgDisplayFolder As String = ""
        Dim sub_comp_id As Long = 0

        reportType.Items.Clear()

        ' *** MATT you have to "turn all options OFF" before "turing ON" options for "report"
        ' if you don't is shows up for "other reports" that dont include the "option"


        ' *** ALL REPORT OPTIONS ARE ENABLED / DISABLED in this function

        TableRow0.Visible = False  ' include report header
        TableRow1.Visible = False  ' include asking price
        TableRow2.Visible = False  ' add to asking amount
        TableRow3.Visible = False  ' include confidential notes
        TableRow4.Visible = False  ' include contacts
        TableRow5.Visible = False  ' include all contacts
        TableRow6.Visible = False  ' include base aircraft
        TableRow7.Visible = False  ' include company aircraft
        TableRow8.Visible = False  ' blind report
        TableRow9.Visible = False  ' include spec page
        TableRow10.Visible = False ' include company /contacts
        TableRow11.Visible = False ' include pictures page
        TableRow12.Visible = False ' exclude broker
        TableRow13.Visible = False ' include logo
        TableRow14.Visible = False ' include notes
        TableRow15.Visible = False ' include history
        TableRow16.Visible = False ' include base location info
        TableRow17.Visible = False ' include large pictures
        TableRow18.Visible = False ' include Related Companies
        TableRow19.Visible = False ' include yachts
        TableRow20.Visible = False ' include company wanteds
        TableRow21.Visible = False ' include Key Features
        TableRow22.Visible = False ' include Status/Asking Price
        TableRow23.Visible = False ' include prepared for 

        operator_tablerow.Visible = False
        owner_tablerow.Visible = False
        manu_tablerow.Visible = False
        dealer_tablerow.Visible = False
        leasing_tablerow.Visible = False
        finance_tablerow.Visible = False


        report_pages.Visible = False

        HelpText2.Text = ""

        If report_id > 0 Then

            Dim tmpIndex As Integer = 0

            For x As Integer = 0 To UBound(report_array)
                If report_id = CInt(report_array(x, RPT_ID).ToString) Then
                    tmpIndex = x
                    Exit For
                End If
            Next

            Dim outputFormatArr As Array = Split(report_array(tmpIndex, RPT_OUTPUT).ToString, Constants.cSemiColonDelim)
            Dim bHadASelection As Boolean = False

            For x As Integer = 0 To UBound(outputFormatArr)

                reportType.Items.Add(New ListItem(outputFormatArr(x).ToString))

                Select Case outputFormatArr(x).ToString.ToLower

                    Case "html"
                        If bHtmlReport Then
                            reportType.Items(x).Selected = True
                            bHadASelection = True
                        End If
                    Case "excel"
                        If bExcelReport Then
                            reportType.Items(x).Selected = True
                            bHadASelection = True
                        End If
                    Case "word"
                        If bWordReport Then
                            reportType.Items(x).Selected = True
                            bHadASelection = True
                            HelpText2.Text = "<font color='red'>When the Word document is opened in the browser, select File, Save As, and select Word Document as the type.</font>"
                        End If
                    Case "pdf"
                        If bPdfReport Then
                            reportType.Items(x).Selected = True
                            bHadASelection = True
                        End If
                    Case "text (comma delimited)"
                        If bTextCommaReport Then
                            reportType.Items(x).Selected = True
                            bHadASelection = True
                        End If
                    Case "text (tab delimited)"
                        If bTextTabReport Then
                            reportType.Items(x).Selected = True
                            bHadASelection = True
                        End If

                End Select

            Next

            If report_id = 10 Or report_id = 11 Or report_id = 24 Or report_id = 25 Or report_id = 17 Then
                reportType.Items.Add(New ListItem("PDF"))
            End If

            If Not bHadASelection Then
                reportType.Items(0).Selected = True  ' default to select the first item if nothing has been selected
            End If

            reportType.ToolTip = "Available report formats"
            reportType.Visible = True

            report_description_label.Text = report_array(tmpIndex, RPT_DESC).ToString

            If report_id = 18 Or report_id = 19 Then
                report_description_label.Text += "<br /><br /><font color='red'> * SUBMIT ONLY * </font>"
            End If

            Master.SetPageTitle(report_array(tmpIndex, RPT_TITLE))

            If bExportFlag Then

                If report_array(tmpIndex, RPT_SUBMIT).ToString.ToUpper.Contains("Y") Then

                    submit_report_panel.Visible = True
                    chkSubmitReport.Enabled = True

                    If report_id = 18 Or report_id = 19 Then
                        chkSubmitReport.Checked = True
                        chkSubmitReport.Enabled = False
                    End If

                    get_subscriber_name_email()

                Else
                    submit_report_panel.Visible = False
                End If

            Else
                submit_report_panel.Visible = False
            End If

            If Not IsPostBack Then
                If report_id = 53 Then
                    If clsGeneral.clsGeneral.isEValuesAvailable() = True Then
                        chk_include_evalues.Visible = True
                    End If
                    If clsGeneral.clsGeneral.isShowingEvalues() = True Then
                        chk_include_evalues.Checked = True
                    Else
                        chk_include_evalues.Checked = False
                    End If
                End If

                ' then we need to make the checkbox un-checked to start 
                If HttpContext.Current.Session.Item("jetnetWebHostType") = crmWebClient.eWebHostTypes.HOMEBASE And Trim(Request("homebase")) = "Y" Then
                    chk_include_evalues.Checked = False
                End If
            End If

            ' turn on "check box" table rows based on report_id
            If (report_id = 15 Or report_id = 16 Or report_id = 27 Or report_id = 28 Or report_id = 34 Or report_id = 41 Or report_id = 43 Or report_id = 39 Or report_id = 53 Or report_id = 40) And Not bAerodexFlag Then ' MSW - added 40 condensed spec per request 4/8/19
                TableRow1.Visible = True ' include asking price
                If report_id <> 43 Then
                    TableRow2.Visible = True ' add to asking amount
                End If
            End If

            If (report_id = 12 Or report_id = 13) And Not bAerodexFlag Then
                TableRow3.Visible = True ' include confidential notes
            End If

            If (report_id = 7 Or report_id = 8 Or report_id = 14 Or report_id = 17 Or report_id = 21 Or report_id = 22 Or report_id = 23 Or
                report_id = 30 Or report_id = 31 Or report_id = 32 Or report_id = 33 Or report_id = 35 Or report_id = 36 Or
                report_id = 45 Or report_id = 48 Or report_id = 52) Then
                TableRow0.Visible = True ' include report header
            End If

            If (report_id = 24 Or report_id = 25) Then
                TableRow16.Visible = True ' include base location info
            End If

            If (report_id = 23 Or report_id = 14 Or report_id = 7 Or report_id = 35 Or report_id = 36 Or report_id = 47 Or report_id = 48 Or report_id = 54) Then

                TableRow4.Visible = True  ' include contacts

                If HttpContext.Current.Session.Item("searchCriteria").SearchCriteriaCompanyDisplayContactInfo Then
                    chkIncludeContacts.Checked = True
                End If

                If report_id <> 35 And report_id <> 47 And report_id <> 48 And report_id <> 54 Then
                    TableRow5.Visible = True ' include all contacts
                End If

            End If

            If report_id = 39 Then

                If Not bAerodexFlag Then
                    TableRow22.Visible = True
                End If
                TableRow23.Visible = True
                TableRow21.Visible = True
            End If

            If (report_id = 18 Or report_id = 19) Then
                TableRow5.Visible = True ' include all contacts
                TableRow6.Visible = True ' include base aircraft
                TableRow7.Visible = True ' include company aircraft
            End If

            If (report_id = 39 Or report_id = 40 Or report_id = 41 Or report_id = 53) Then
                TableRow8.Visible = True ' blind report
                TableRow23.Visible = True
            End If

            If report_id = 33 Then
                If bCanUseLocalNotes Then
                    If bHasServerNotes Or bHasStandardCloudNotes Then
                        chkIncludeNotes_std.Text = "Show Notes"
                        chkIncludeNotes_std.Checked = True
                        TableRow14.Visible = True ' include notes  
                    End If
                End If
            End If

            If report_id = 40 Then
                TableRow16.Visible = True ' include base location info
                TableRow10.Visible = True ' include company /contacts
            End If

            If (report_id = 41 Or report_id = 43 Or report_id = 53) Then
                TableRow9.Visible = True ' include spec page
                TableRow10.Visible = True ' include company /contacts

                If bCanUseLocalNotes Then
                    If bHasServerNotes Or bHasStandardCloudNotes Then
                        notes_page.Visible = True ' include notes (41 OR 53)
                    End If
                End If

                If report_id = 41 Or report_id = 53 Then

                    report_pages.Visible = True

                    TableRow9.Visible = False ' include spec page
                    TableRow10.Visible = False ' include company /contacts

                    TableRow15.Visible = False ' include history (std)
                    TableRow14.Visible = False ' include notes (std)

                    TableRow12.Visible = True ' exclude broker
                    TableRow16.Visible = True ' include base location info
                    TableRow21.Visible = True ' include key features 

                End If

                If report_id = 41 Then
                    TableRow11.Visible = True ' include pictures page
                    TableCell11.Visible = True ' include all pic
                    tr_airframe.Visible = False   ' used for 53 not 41
                    check_avionics.Visible = False ' used for 53 not 41
                    tr_int_ext.Visible = False   ' used for 53 not 41
                    tr_maint.Visible = False  ' used for 53 not 41
                    spec_page.Visible = True
                End If

                If report_id = 43 Then
                    TableRow15.Visible = True ' include history
                    TableRow14.Visible = True ' include notes (std)
                End If

                If report_id = 53 Then
                    TableRow17.Visible = True ' Show Each Picture On Its Own Page
                    spec_page.Visible = False
                    tr_airframe.Visible = True   ' used for 53 not 41
                    tr_enginesAPU.Visible = True
                    check_avionics.Visible = True ' used for 53 not 41
                    tr_int_ext.Visible = True   ' used for 53 not 41
                    tr_maint.Visible = True  ' used for 53 not 41
                    spec_page.Visible = False
                    ' reportType.Items.Remove(reportType.Items.FindByText("Word"))
                    reportType.Items.Remove(reportType.Items.FindByText("HTML"))
                End If
            End If

            If report_id = 54 Then
                If use_insight_roll = True And use_insight_dealer = False And use_insight_finance = False And use_insight_lease = False And use_insight_manu = False And use_insight_op = False And use_insight_own = False Then
                    TableRow22.Visible = True
                Else
                    TableRow22.Visible = False
                End If

                chkCompanyLocations.Visible = True
                chkIncludesale.Visible = False
            Else
                TableRow22.Visible = False
                chkCompanyLocations.Visible = False
            End If

            If report_id = 53 Then
                check_cover.Text = "Cover Page (with Picture)"
            Else
                check_cover.Text = "Cover Page"
            End If


            If report_id = 47 Or report_id = 54 Then

                If (HttpContext.Current.Session.Item("localSubscription").crmYacht_Flag = True) Then

                    TableRow19.Visible = True

                    If Not IsNothing(HttpContext.Current.Session.Item("COMPANY_HAS_YACHTS")) Then

                        If Not String.IsNullOrEmpty(HttpContext.Current.Session.Item("COMPANY_HAS_YACHTS").ToString.Trim) Then

                            If HttpContext.Current.Session.Item("COMPANY_HAS_YACHTS").ToString.ToUpper.Contains("Y") Then
                                chkincludeCompYacht.Checked = True
                            Else
                                chkincludeCompYacht.Checked = False
                            End If

                        End If

                    End If
                End If

                TableRow7.Visible = True ' include company aircraft
                TableRow18.Visible = True
                TableRow20.Visible = True
            End If


            If report_id = 54 Then
                If Not IsNothing(Request("use_insight_roll")) Then
                    If Trim(Request("use_insight_roll")) = "Y" Then
                        use_insight_roll = True
                        op_locations.Visible = True
                        own_locations.Visible = True
                        lease_locations.Visible = True
                        ' fin_locations.Visible = True
                        dealer_locations.Visible = True
                    End If
                End If

                If Not IsNothing(Request("use_insight_op")) Then
                    If Trim(Request("use_insight_op")) = "Y" Then
                        use_insight_op = True
                        operator_tablerow.Visible = True
                    Else
                        operator_tablerow.Visible = False
                    End If
                Else
                    operator_tablerow.Visible = False
                End If

                If Not IsNothing(Request("use_insight_own")) Then
                    If Trim(Request("use_insight_own")) = "Y" Then
                        use_insight_own = True
                        owner_tablerow.Visible = True
                    Else
                        owner_tablerow.Visible = False
                    End If
                Else
                    owner_tablerow.Visible = False
                End If

                If Not IsNothing(Request("use_insight_manu")) Then
                    If Trim(Request("use_insight_manu")) = "Y" Then
                        use_insight_manu = True
                        manu_tablerow.Visible = True
                    Else
                        manu_tablerow.Visible = False
                    End If
                Else
                    manu_tablerow.Visible = False
                End If

                If Not IsNothing(Request("use_insight_dealer")) Then
                    If Trim(Request("use_insight_dealer")) = "Y" Then
                        use_insight_dealer = True
                        dealer_tablerow.Visible = True
                    Else
                        dealer_tablerow.Visible = False
                    End If
                Else
                    dealer_tablerow.Visible = False
                End If

                If Not IsNothing(Request("use_insight_lease")) Then
                    If Trim(Request("use_insight_lease")) = "Y" Then
                        use_insight_lease = True
                        leasing_tablerow.Visible = True
                    Else
                        leasing_tablerow.Visible = False
                    End If
                Else
                    leasing_tablerow.Visible = False
                End If

                If Not IsNothing(Request("use_insight_finance")) Then
                    If Trim(Request("use_insight_finance")) = "Y" Then
                        financial_documents_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim

                        use_insight_finance = True
                        finance_tablerow.Visible = True
                    Else
                        finance_tablerow.Visible = False
                    End If
                Else
                    finance_tablerow.Visible = False
                End If

                check_update.Update()
            End If


            If report_id = 53 Then
                save_checks.Visible = True
            Else
                save_checks.Visible = False
            End If

            ' REPORTS WITH LOGO INCLUDED
            If (report_id = 39 Or report_id = 40 Or report_id = 41 Or report_id = 43 Or report_id = 47 Or report_id = 53 Or report_id = 54) Then

                Try

                    SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
                    SqlConn.Open()

                    SqlCommand.Connection = SqlConn
                    SqlCommand.CommandType = System.Data.CommandType.Text
                    SqlCommand.CommandTimeout = 90

                    Query = "SELECT DISTINCT * FROM Company WITH(NOLOCK)"
                    Query += " INNER JOIN Subscription on sub_comp_id = comp_id "
                    Query += " WHERE (comp_journ_id =  0 AND sub_id = " + HttpContext.Current.Session.Item("localUser").crmSubSubID.ToString + " AND comp_hide_flag = 'N')"

                    SqlCommand.CommandText = Query
                    localAdoRs = SqlCommand.ExecuteReader()

                    If localAdoRs.HasRows Then
                        localAdoRs.Read()

                        If comp_id = 0 And Not IsDBNull(localAdoRs("comp_id")) Then
                            comp_id = CLng(localAdoRs.Item("comp_id").ToString)
                        End If

                        If Not IsDBNull(localAdoRs("comp_id")) Then
                            sub_comp_id = CLng(localAdoRs.Item("comp_id").ToString)
                        End If


                        If HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then

                            If Not Application.Item("crmClientSiteData").crmClientHostName.ToString.ToUpper.Contains("NEWEVONET") Then
                                imgDisplayFolder = "https://www.testjetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                            Else
                                imgDisplayFolder = "http://www.jetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                            End If

                        Else
                            imgDisplayFolder = Application.Item("crmClientSiteData").ClientFullHostName.ToString.Trim + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                        End If

                        If Not IsDBNull(localAdoRs("comp_logo_flag")) Then

                            If localAdoRs.Item("comp_logo_flag").ToString.ToUpper.Contains("Y") Then

                                TableRow13.Visible = True ' include logo
                                logo_check.Visible = True
                                logo_image.Visible = True
                                logo_image.Text = "<img src='" + imgDisplayFolder + Constants.cSingleForwardSlash + localAdoRs.Item("comp_id").ToString + ".png' onerror=""if (this.src != '/images/spacer.gif') {this.src='" + imgDisplayFolder + Constants.cSingleForwardSlash + localAdoRs.Item("comp_id").ToString + ".jpg'};"" width='150'>"

                            End If

                        End If

                    End If

                    localAdoRs.Close()
                    localAdoRs = Nothing

                    If logo_check.Visible = False Then
                        logo_image.Text = ""
                        If display_company_logo_check("N", sub_comp_id, logo_image.Text, invisible_label_parent_image.Text) Then
                            TableRow13.Visible = True ' include logo
                            logo_check.Visible = True
                            logo_image.Visible = True
                        End If
                    End If

                Catch SqlException
                    HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in set_report_types_checks() SqlDataReader " + SqlException.Message
                Finally
                    SqlCommand.Dispose()
                    SqlConn.Close()
                    SqlConn.Dispose()
                End Try

            Else

                logo_check.Visible = False
                logo_image.Visible = False

            End If

        End If

        If Not IsPostBack Then
            If report_id = 53 Then

                'leave invisible for now - asked for 
                ' name_alt_check.Visible = True

                If Not IsNothing(HttpContext.Current.Request.Cookies("check_cover")) Then
                    If Not IsNothing(HttpContext.Current.Request.Cookies("check_cover").Values("ID")) Then
                        If Trim(Left(HttpContext.Current.Request.Cookies("check_cover").Values("ID"), 1)) = "1" Then
                            check_cover.Checked = True
                        Else
                            check_cover.Checked = False
                        End If
                    End If
                End If


                If Not IsNothing(HttpContext.Current.Request.Cookies("check_airframe")) Then
                    If Not IsNothing(HttpContext.Current.Request.Cookies("check_airframe").Values("ID")) Then
                        If Trim(Left(HttpContext.Current.Request.Cookies("check_airframe").Values("ID"), 1)) = "1" Then
                            check_airframe.Checked = True
                        Else
                            check_airframe.Checked = False
                        End If
                    End If
                End If

                If Not IsNothing(HttpContext.Current.Request.Cookies("check_avionics")) Then
                    If Not IsNothing(HttpContext.Current.Request.Cookies("check_avionics").Values("ID")) Then
                        If Trim(Left(HttpContext.Current.Request.Cookies("check_avionics").Values("ID"), 1)) = "1" Then
                            check_avionics.Checked = True
                        Else
                            check_avionics.Checked = False
                        End If
                    End If
                End If


                If Not IsNothing(HttpContext.Current.Request.Cookies("check_int_ext")) Then
                    If Not IsNothing(HttpContext.Current.Request.Cookies("check_int_ext").Values("ID")) Then
                        If Trim(Left(HttpContext.Current.Request.Cookies("check_int_ext").Values("ID"), 1)) = "1" Then
                            check_int_ext.Checked = True
                        Else
                            check_int_ext.Checked = False
                        End If
                    End If
                End If

                If Not IsNothing(HttpContext.Current.Request.Cookies("check_maint")) Then
                    If Not IsNothing(HttpContext.Current.Request.Cookies("check_maint").Values("ID")) Then
                        If Trim(Left(HttpContext.Current.Request.Cookies("check_maint").Values("ID"), 1)) = "1" Then
                            check_maint.Checked = True
                        Else
                            check_maint.Checked = False
                        End If
                    End If
                End If


                If Not IsNothing(HttpContext.Current.Request.Cookies("chkIncludeNotes_53")) Then
                    If Not IsNothing(HttpContext.Current.Request.Cookies("chkIncludeNotes_53").Values("ID")) Then
                        If Trim(Left(HttpContext.Current.Request.Cookies("chkIncludeNotes_53").Values("ID"), 1)) = "1" Then
                            chkIncludeNotes_53.Checked = True
                        Else
                            chkIncludeNotes_53.Checked = False
                        End If
                    End If
                End If

                If Not IsNothing(HttpContext.Current.Request.Cookies("chkTP_53")) Then
                    If Not IsNothing(HttpContext.Current.Request.Cookies("chkTP_53").Values("ID")) Then
                        If Trim(Left(HttpContext.Current.Request.Cookies("chkTP_53").Values("ID"), 1)) = "1" Then
                            chkTP_53.Checked = True
                        Else
                            chkTP_53.Checked = False
                        End If
                    End If
                End If

                If Not IsNothing(HttpContext.Current.Request.Cookies("chkIncludeHistory_53")) Then
                    If Not IsNothing(HttpContext.Current.Request.Cookies("chkIncludeHistory_53").Values("ID")) Then
                        If Trim(Left(HttpContext.Current.Request.Cookies("chkIncludeHistory_53").Values("ID"), 1)) = "1" Then
                            chkIncludeHistory_53.Checked = True
                        Else
                            chkIncludeHistory_53.Checked = False
                        End If
                    End If
                End If

                If Not IsNothing(HttpContext.Current.Request.Cookies("chkPP")) Then
                    If Not IsNothing(HttpContext.Current.Request.Cookies("chkPP").Values("ID")) Then
                        If Trim(Left(HttpContext.Current.Request.Cookies("chkPP").Values("ID"), 1)) = "1" Then
                            chkPP.Checked = True
                        Else
                            chkPP.Checked = False
                        End If
                    End If
                End If


                If Not IsNothing(HttpContext.Current.Request.Cookies("logo_check")) Then
                    If Not IsNothing(HttpContext.Current.Request.Cookies("logo_check").Values("ID")) Then
                        If Trim(Left(HttpContext.Current.Request.Cookies("logo_check").Values("ID"), 1)) = "1" Then
                            logo_check.Checked = True
                        Else
                            logo_check.Checked = False
                        End If
                    End If
                End If

                If Not IsNothing(HttpContext.Current.Request.Cookies("check_prepared_for")) Then
                    If Not IsNothing(HttpContext.Current.Request.Cookies("check_prepared_for").Values("ID")) Then
                        If Trim(Left(HttpContext.Current.Request.Cookies("check_prepared_for").Values("ID"), 1)) = "1" Then
                            check_prepared_for.Checked = True
                        Else
                            check_prepared_for.Checked = False
                        End If
                    End If
                End If

                If Not IsNothing(HttpContext.Current.Request.Cookies("chkIncludeKeyFeatures")) Then
                    If Not IsNothing(HttpContext.Current.Request.Cookies("chkIncludeKeyFeatures").Values("ID")) Then
                        If Trim(Left(HttpContext.Current.Request.Cookies("chkIncludeKeyFeatures").Values("ID"), 1)) = "1" Then
                            chkIncludeKeyFeatures.Checked = True
                        Else
                            chkIncludeKeyFeatures.Checked = False
                        End If
                    End If
                End If

                If Not IsNothing(HttpContext.Current.Request.Cookies("chkBlindReport")) Then
                    If Not IsNothing(HttpContext.Current.Request.Cookies("chkBlindReport").Values("ID")) Then
                        If Trim(Left(HttpContext.Current.Request.Cookies("chkBlindReport").Values("ID"), 1)) = "1" Then
                            chkBlindReport.Checked = True
                        Else
                            chkBlindReport.Checked = False
                        End If
                    End If
                End If


                If Not IsNothing(HttpContext.Current.Request.Cookies("chkShowAsking")) Then
                    If Not IsNothing(HttpContext.Current.Request.Cookies("chkShowAsking").Values("ID")) Then
                        If Trim(Left(HttpContext.Current.Request.Cookies("chkShowAsking").Values("ID"), 1)) = "1" Then
                            chkShowAsking.Checked = True
                        Else
                            chkShowAsking.Checked = False
                        End If
                    End If
                End If

                If Not IsNothing(HttpContext.Current.Request.Cookies("chkEB")) Then
                    If Not IsNothing(HttpContext.Current.Request.Cookies("chkEB").Values("ID")) Then
                        If Trim(Left(HttpContext.Current.Request.Cookies("chkEB").Values("ID"), 1)) = "1" Then
                            chkEB.Checked = True
                        Else
                            chkEB.Checked = False
                        End If
                    End If
                End If

                If Not IsNothing(HttpContext.Current.Request.Cookies("chkIncludeBaseLocation")) Then
                    If Not IsNothing(HttpContext.Current.Request.Cookies("chkIncludeBaseLocation").Values("ID")) Then
                        If Trim(Left(HttpContext.Current.Request.Cookies("chkIncludeBaseLocation").Values("ID"), 1)) = "1" Then
                            chkIncludeBaseLocation.Checked = True
                        Else
                            chkIncludeBaseLocation.Checked = False
                        End If
                    End If
                End If

                If Not IsNothing(HttpContext.Current.Request.Cookies("chkPP_Large")) Then
                    If Not IsNothing(HttpContext.Current.Request.Cookies("chkPP_Large").Values("ID")) Then
                        If Trim(Left(HttpContext.Current.Request.Cookies("chkPP_Large").Values("ID"), 1)) = "1" Then
                            chkPP_Large.Checked = True
                        Else
                            chkPP_Large.Checked = False
                        End If
                    End If
                End If


            End If
        End If



        If Trim(Request("journ_id")) <> "" Then
            nAircraftJournalID_Full = CLng(Trim(Request("journ_id")))
        End If


        ' ADDED IN MSW - IF HISTORICAL AC THEN NO PICTURES
        If nAircraftJournalID_Full > 0 Then
            picture_pages.Visible = False
            chkPP.Checked = False
            chkPP.Visible = False
            TableRow11.Visible = False
            Chk_ALLPIC.Checked = False
            Chk_ALLPIC.Visible = False
        End If


    End Sub

    Protected Sub reportsListIDClick(ByVal sender As Object, ByVal e As EventArgs) Handles reportsListID.SelectedIndexChanged

        ' reset them after each check
        check_cover.Checked = True
        chkPP_Large.Checked = True
        chkEB.Checked = False
        chkPP.Checked = True
        chkBlindReport.Checked = False

    End Sub

    Protected Sub chkBlindReportClick(ByVal sender As Object, ByVal e As EventArgs) Handles chkBlindReport.CheckedChanged

        If chkBlindReport.Checked = True Then
            check_cover.Checked = False
            chkPP_Large.Checked = False
            chkEB.Checked = True
            chkPP.Checked = False
        End If

    End Sub

    Public Function display_company_logo_check(ByVal companyLogoFlag As String, ByVal CompanyID As Long, ByRef logo_image As String, ByRef logo_string_to_save As String) As Boolean

        Dim imgDisplayFolder As String = ""
        Dim MainLocationDataTable As New DataTable
        Dim logoID As Long = 0
        Dim bReturnValue As Boolean = False

        logo_string_to_save = ""
        logo_image = ""

        Try

            'if the flag is going to be Y then the company ID is the logo ID.
            If companyLogoFlag.ToUpper.Contains("Y") Then
                logoID = CompanyID
            Else
                'Look up the other locations logo. If there's a main location that has a logo, that ID is the logo ID
                MainLocationDataTable = Master.aclsData_Temp.GetCompanyMainLocationDescriptionLogo(CompanyID)
                If Not IsNothing(MainLocationDataTable) Then
                    If MainLocationDataTable.Rows.Count > 0 Then
                        'This means there is a main location, let's check for a logo here.
                        If Not IsDBNull(MainLocationDataTable.Rows(0).Item("comp_logo_flag")) Then
                            If MainLocationDataTable.Rows(0).Item("comp_logo_flag").ToString.ToUpper.Contains("Y") Then
                                logoID = CLng(MainLocationDataTable.Rows(0).Item("comp_id").ToString)
                            End If
                        End If
                    End If
                End If
            End If

            If HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then

                If Not Application.Item("crmClientSiteData").crmClientHostName.ToString.ToUpper.Contains("NEWEVONET") Then
                    imgDisplayFolder = "https://www.testjetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                Else
                    imgDisplayFolder = "http://www.jetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                End If

            Else
                imgDisplayFolder = Application.Item("crmClientSiteData").ClientFullHostName.ToString.Trim + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
            End If

            If logoID = 0 Then
                logo_image = "<img src='../images/comp_no_image.png' class='float_left' width='220' /></span>"
                logo_string_to_save = logoID.ToString
            Else
                bReturnValue = True
                logo_image = "<span class='company_picture_pad'><img src='" + imgDisplayFolder + Constants.cSingleForwardSlash + logoID.ToString + ".jpg' class='float_left border' width='220' /></span>"
                logo_string_to_save = logoID.ToString
            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in display_company_logo_check(ByVal companyLogoFlag As String, ByVal CompanyID As Long, ByRef logo_image As String, ByRef logo_string_to_save As String) As Boolean" + ex.Message
        End Try

        Return bReturnValue

    End Function

    Private Function find_report_name(ByVal report_id As Long) As String
        find_report_name = ""

        Dim atemptable As New DataTable
        Dim sQuery = New StringBuilder()

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing

        Dim x As Integer = 0

        Try

            sQuery.Append("SELECT * FROM Web_Report WHERE webrep_id = " & report_id)

            SqlConn.ConnectionString = Session.Item("jetnetAdminDatabase").ToString.Trim
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString
            SqlReader = SqlCommand.ExecuteReader()

            Try
                atemptable.Load(SqlReader)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
                HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in create_reports_list() load datatable " + constrExc.Message
            Finally
                SqlReader.Close()
            End Try

            If Not IsNothing(atemptable) Then

                If atemptable.Rows.Count > 0 Then

                    For Each r As DataRow In atemptable.Rows

                        If Not (IsDBNull(r("webrep_title"))) Then
                            find_report_name = r("webrep_title")
                        End If

                    Next

                End If
            End If


        Catch ex As Exception

            Report_Panel.Visible = False
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in create_reports_list() " + ex.Message

        Finally
            SqlReader = Nothing

            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

            atemptable = Nothing
        End Try



    End Function



    Private Sub create_reports_list()

        Dim atemptable As New DataTable
        Dim sQuery = New StringBuilder()

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing

        Dim x As Integer = 0

        Try

            sQuery.Append("SELECT * FROM Web_Report WHERE webrep_id > 0")

            If (HttpContext.Current.Session.Item("localPreferences").UserID.ToString.ToLower.Contains("rickwanner") Or
                HttpContext.Current.Session.Item("localPreferences").UserID.ToString.ToLower.Contains("admin") Or
                HttpContext.Current.Session.Item("localPreferences").UserID.ToString.ToLower.Contains("mvintech") Or
                HttpContext.Current.Session.Item("localPreferences").UserID.ToString.ToLower.Contains("davidcruger") Or
                HttpContext.Current.Session.Item("localPreferences").UserID.ToString.ToLower.Contains("jason") Or
                HttpContext.Current.Session.Item("localPreferences").UserID.ToString.ToLower.Contains("therese") Or
                HttpContext.Current.Session.Item("localPreferences").UserID.ToString.ToLower.Contains("ken") Or
                HttpContext.Current.Session.Item("localPreferences").UserID.ToString.ToLower.Contains("mikemaggi")) And HttpContext.Current.Session.Item("localPreferences").SubID.ToString = "777" Then
                'We ignore the hide flag when logged in as mvintech or admin
            Else
                If report_id <> 39 And report_id <> 40 And report_id <> 41 And report_id <> 43 And report_id <> 53 Then
                    sQuery.Append(" AND webrep_status = 'Y'")
                End If
            End If

            If report_id <> 39 And report_id <> 40 And report_id <> 41 And report_id <> 43 And report_id <> 53 Then
                If bAerodexFlag Then
                    sQuery.Append(" AND webrep_aerodex_flag = 'Y'")
                Else
                    sQuery.Append(" AND webrep_jetnet_flag = 'Y'")
                End If
            End If

            If Trim(Request("journ_id")) <> "" And Trim(Request("journ_id")) <> "0" Then
                sQuery.Append(" AND webrep_id NOT IN (53) ")
            End If

            If Not String.IsNullOrEmpty(report_area.Trim) Then

                If report_area.ToLower.Trim.Contains("operating") Then
                    report_area = "operating costs"
                End If

                If report_area.ToLower.Trim.Contains("performance") Then
                    report_area = "performance specs"
                End If

                If report_area.ToLower.Trim.Contains("yacht") Then

                    If report_area.ToLower.Trim.Contains("yachtevents") Then
                        report_area = "yacht events"
                    End If

                    If report_area.ToLower.Trim.Contains("yachthistory") Then
                        report_area = "yacht history"
                    End If

                End If

                If report_area.ToLower.Trim.Contains("market") Then
                    report_area = "market summary"
                End If

                If report_area.ToLower.Trim.Contains("shareholder") Then
                    report_area = "view7" ' shareholder report
                End If

                If report_area.ToLower.Trim.Contains("document") Then
                    report_area = "view4" ' shareholder report
                End If

                Select Case report_area.ToLower
                    Case "aircraft"
                        sQuery.Append(" AND webrep_id NOT IN (12, 13, 15, 16, 18, 29, 34)") ' not compleated reports
                    Case "history"
                        sQuery.Append(" AND webrep_id NOT IN (22, 38)") ' not compleated reports
                    Case "company"
                    Case "events"
                        If Not bFromEventDetail Then
                            If HttpContext.Current.Session.Item("MasterAircraftEventsFrom").ToString.ToLower.Contains("priorev_ac_id") Then
                                sQuery.Append(" AND webrep_id <> 26") ' not compleated reports
                            ElseIf HttpContext.Current.Session.Item("MasterAircraftEventsFrom").ToString.ToLower.Contains("priorev_amwant_id") Then
                                ' remove the seller/purchaser report (31) if user has selected "wanted events"
                                sQuery.Append(" AND webrep_id NOT IN (26, 31)")
                            ElseIf HttpContext.Current.Session.Item("MasterAircraftEventsFrom").ToString.ToLower.Contains("priorev_comp_id") Then
                                ' remove the seller/purchaser report (31) if user has selected "company events"
                                sQuery.Append(" AND webrep_id NOT IN (26, 31)")
                            End If
                        Else
                            sQuery.Append(" AND webrep_id <> 26") ' not compleated reports
                        End If
                    Case "performance specs"
                    Case "operating costs"
                    Case "market summary"
                    Case "view7" ' shareholder report
                    Case "view4" ' documents report
                    Case "wanted"
                    Case "yacht events"
                    Case "yacht", "yacht history"

                End Select

                sQuery.Append(" AND lower(webrep_area) = '" + report_area.ToLower.Trim + "'")

                Select Case report_area.ToLower
                    Case "aircraft"
                        sQuery.Append(" OR webrep_id = 39 OR webrep_id = 40 OR webrep_id = 41 OR webrep_id = 53")
                    Case "events"
                        If Not bFromEventDetail Then
                            If HttpContext.Current.Session.Item("MasterAircraftEventsFrom").ToString.ToLower.Contains("priorev_ac_id") Then
                                sQuery.Append(" OR webrep_id = 39 OR webrep_id = 40 OR webrep_id = 41")
                            End If
                        End If
                    Case "yacht"
                        sQuery.Append(" OR webrep_id = 43")
                    Case "yacht events"
                        sQuery.Append(" OR webrep_id = 43")
                    Case "yacht history"
                        sQuery.Append(" OR webrep_id = 46 OR webrep_id = 43")

                End Select

            ElseIf ac_id > 0 Then

                sQuery.Append(" AND webrep_id IN (39, 40, 41, 53)")

            ElseIf yacht_id > 0 Then

                sQuery.Append(" AND webrep_id IN (43)")

            End If

            sQuery.Append(" ORDER BY webrep_title")

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />create_reports_list()<br />" + sQuery.ToString

            SqlConn.ConnectionString = Session.Item("jetnetAdminDatabase").ToString.Trim
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString
            SqlReader = SqlCommand.ExecuteReader()

            Try
                atemptable.Load(SqlReader)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
                HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in create_reports_list() load datatable " + constrExc.Message
            Finally
                SqlReader.Close()
            End Try

            If Not IsNothing(atemptable) Then

                If atemptable.Rows.Count > 0 Then

                    reportsListID.Items.Clear()

                    ' make the array the same size as our returned records
                    ReDim report_array(atemptable.Rows.Count - 1, RPT_MAX_DIM)

                    For Each r As DataRow In atemptable.Rows

                        If Not (IsDBNull(r("webrep_id"))) Then

                            reportsListID.Items.Add(New ListItem(r.Item("webrep_title").ToString, r.Item("webrep_id").ToString))

                            If report_id = CInt(r.Item("webrep_id").ToString) Then
                                reportsListID.SelectedValue = report_id.ToString
                                standard_report_options.Visible = True
                            End If

                            report_array(x, RPT_ID) = r.Item("webrep_id").ToString.Trim

                        End If

                        If Not (IsDBNull(r("webrep_description"))) Then
                            report_array(x, RPT_DESC) = r.Item("webrep_description").ToString.Trim
                        End If

                        If Not (IsDBNull(r("webrep_title"))) Then
                            report_array(x, RPT_TITLE) = r.Item("webrep_title").ToString.Trim
                        End If

                        If Not (IsDBNull(r("webrep_output"))) Then
                            report_array(x, RPT_OUTPUT) = r.Item("webrep_output").ToString.Trim
                        End If

                        If Not (IsDBNull(r("webrep_report_request_dotnet_flag"))) Then
                            report_array(x, RPT_SUBMIT) = r.Item("webrep_report_request_dotnet_flag").ToString.Trim
                        End If

                        x += 1

                    Next

                    Report_Panel.Visible = True

                End If

            End If

            If Not IsPostBack Then
                Try
                    If ac_id > 0 Then
                        Call NEW_build_full_spec_aircraft_features(ac_id, SqlCommand, SqlReader, "")
                    End If
                Catch ex As Exception
                Finally
                    SqlReader.Close()
                End Try
            End If

        Catch ex As Exception

            Report_Panel.Visible = False
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in create_reports_list() " + ex.Message

        Finally
            SqlReader = Nothing

            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

            atemptable = Nothing

        End Try

    End Sub

    Private Sub get_subscriber_name_email()

        Dim tempTable As New DataTable
        Dim tmpPrefobj As New preferencesDataLayer

        tmpPrefobj.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim

        Try
            tempTable = tmpPrefobj.ReturnUserDetailsAndImage(HttpContext.Current.Session.Item("localUser").crmUserContactID)

            If Not IsNothing(tempTable) Then
                If tempTable.Rows.Count > 0 Then

                    For Each r As DataRow In tempTable.Rows

                        If String.IsNullOrEmpty(replyUsername.Text.Trim) Then
                            If Not (IsDBNull(r.Item("contact_first_name"))) And Not String.IsNullOrEmpty(r.Item("contact_first_name").ToString.Trim) Then
                                replyUsername.Text = r.Item("contact_first_name").ToString.Trim
                            End If

                            If Not (IsDBNull(r.Item("contact_middle_initial"))) And Not String.IsNullOrEmpty(r.Item("contact_middle_initial").ToString.Trim) Then
                                replyUsername.Text += " " + r.Item("contact_middle_initial").ToString.Trim + Constants.cDot
                            End If

                            If Not (IsDBNull(r.Item("contact_last_name"))) And Not String.IsNullOrEmpty(r.Item("contact_last_name").ToString.Trim) Then
                                replyUsername.Text += " " + r.Item("contact_last_name").ToString.Trim
                            End If
                        End If

                        If String.IsNullOrEmpty(replyEmail.Text.Trim) Then
                            If Not (IsDBNull(r.Item("contact_email_address"))) And Not String.IsNullOrEmpty(r.Item("contact_email_address").ToString.Trim) Then
                                replyEmail.Text = r.Item("contact_email_address").ToString.Trim
                            End If
                        End If

                    Next

                End If

            End If

        Catch ex As Exception
            Master.LogError("Error in PDF_Creator.aspx.vb (set_report_types_checks) - " + ex.Message)
        End Try

        tempTable = Nothing
        tmpPrefobj = Nothing

    End Sub

    Private Function check_for_report_limit(ByVal in_nRecordCount As Long, ByVal insert_record As Boolean) As String

        Const sLimitText1 = "<b><font color='red'>The report that you have selected will take too long to run interactively based on the quantity of records you have selected.  "
        Const sLimitText2 = "We will automatically run this report in background for you and email you a link to the report when the report is complete. "
        Const sLimitText3 = "Click 'Submit Report' in the menu above to have us run the report for you. "
        Const sLimitText4 = "</font></b>"

        If in_nRecordCount > Constants.MAX_ASP_REPORT_LIMIT Then

            bBlockedReport = True
            btnRunReport.Text = "Submit Report"

            If insert_record Then
                Call commonLogFunctions.Log_User_Event_Data("UserExportLimit", "JETNET ASP REPORTS LIMIT : " + Constants.MAX_ASP_REPORT_LIMIT.ToString + " Records Attempted : " + in_nRecordCount.ToString, Nothing, 0, 0, 0, 0, 0, 0, 0)
            End If

            Return Trim(sLimitText1 + sLimitText2 + sLimitText3 + sLimitText4)
        Else
            btnRunReport.Text = "Run Report"
        End If

        Return ""

    End Function

    Private Function get_report_query_record_count() As DataTable
        Dim atemptable As New DataTable
        Dim sQuery = New StringBuilder()

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing

        Try

            Select Case report_area.ToLower

                Case "aircraft"
                    sQuery.Append(HttpContext.Current.Session.Item("MasterAircraft").ToString)

                Case "history"
                    sQuery.Append(HttpContext.Current.Session.Item("MasterAircraft").ToString)

                Case "company"
                    sQuery.Append(HttpContext.Current.Session.Item("MasterCompany").ToString)

                Case "events"
                    sQuery.Append(HttpContext.Current.Session.Item("MasterEvents").ToString)

                Case "performance specs"

                    sQuery.Append("SELECT * FROM Aircraft_Model WITH(NOLOCK) INNER JOIN Aircraft_Type WITH(NOLOCK) ON amod_type_code = atype_code ")
                    sQuery.Append(HttpContext.Current.Session.Item("MasterAircraftPerformanceSpecsWhere").ToString)

                Case "operating costs"
                    sQuery.Append("SELECT * FROM Aircraft_Model WITH(NOLOCK) INNER JOIN Aircraft_Type WITH(NOLOCK) ON amod_type_code = atype_code ")
                    sQuery.Append(HttpContext.Current.Session.Item("MasterAircraftOperatingCostWhere").ToString)

                Case "market summary"
                    sQuery.Append(HttpContext.Current.Session.Item("MasterMarketSummary").ToString)

                Case "view7"
                    sQuery.Append(HttpContext.Current.Session.Item("MasterShareholder").ToString)

                Case "view4"
                    sQuery.Append(HttpContext.Current.Session.Item("MasterDocumentList").ToString)

                Case "wanted"
                    sQuery.Append(HttpContext.Current.Session.Item("MasterWanted").ToString)

                Case "yacht events"
                    sQuery.Append(HttpContext.Current.Session.Item("MasterYachtEvents").ToString)

                Case "yacht", "yacht history"
                    sQuery.Append(HttpContext.Current.Session.Item("MasterYacht").ToString)

            End Select

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />get_report_query_record_count() As DataTable<br />" + sQuery.ToString

            SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString
            SqlConn.Open()
            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString
            SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

            Try
                atemptable.Load(SqlReader)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
                HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in get_report_query_record_count load datatable" + constrExc.Message
            End Try

        Catch ex As Exception
            Return Nothing

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in get_report_query_record_count() As DataTable" + ex.Message

        Finally
            SqlReader = Nothing

            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing
        End Try

        Return atemptable

    End Function

    Private Function submit_report_request(ByVal reportNumber As Integer, ByVal reportName As String) As Boolean

        Dim bReturnValue As Boolean = False

        Dim sQuery = New StringBuilder()
        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing

        Dim results_table As New DataTable

        Dim reportRecCount As Long = 0

        If reportRecCount = 0 Then


            results_table = get_report_query_record_count()
            If Not IsNothing(results_table) Then
                If results_table.Rows.Count > 0 Then
                    reportRecCount = results_table.Rows.Count
                End If
            End If

            results_table = Nothing

        End If

        Try

            sQuery.Append("INSERT INTO Report_Request_DotNet (rrdn_sub_comp_id, rrdn_sub_contact_id, rrdn_sub_id, rrdn_login, rrdn_seq_no,")
            sQuery.Append(" rrdn_report_nbr, rrdn_report_query, rrdn_html_flag, rrdn_excel_flag, rrdn_textcomma_flag, rrdn_texttab_flag, rrdn_showheaderrow_flag,")
            sQuery.Append(" rrdn_web_action_date, rrdn_processed_date, rrdn_action_date, rrdn_ftp_file_delete_date,")
            sQuery.Append(" rrdn_reply_username, rrdn_reply_email, rrdn_report_filename, rrdn_zip_filename,")
            sQuery.Append(" rrdn_on_hold, rrdn_status, rrdn_total_query_records, rrdn_host_name, rrdn_app_name,")
            sQuery.Append(" rrdn_include_confidential, rrdn_include_contacts, rrdn_include_all_contacts, rrdn_include_all_base_aircraft,")
            sQuery.Append(" rrdn_include_asking_price, rrdn_add_to_asking_price, rrdn_company_subquery, rrdn_contact_subquery, rrdn_progholder_id")

            sQuery.Append(") VALUES (")

            sQuery.Append(HttpContext.Current.Session.Item("localUser").crmUserCompanyID.ToString + ",") ' rrdn_sub_comp_id
            sQuery.Append(HttpContext.Current.Session.Item("localUser").crmUserContactID.ToString + ",") ' rrdn_sub_contact_id
            sQuery.Append(HttpContext.Current.Session.Item("localUser").crmSubSubID.ToString + ",") ' rrdn_sub_id
            sQuery.Append("'" + HttpContext.Current.Session.Item("localUser").crmUserLogin.ToString.Trim + "',") ' rrdn_login
            sQuery.Append(HttpContext.Current.Session.Item("localUser").crmSubSeqNo.ToString + ",") ' rrdn_seq_no

            sQuery.Append(reportNumber.ToString + ",")   '  rrdn_report_no

            Select Case report_area.ToLower

                Case "aircraft"
                    sQuery.Append("'" + clsData_Manager_SQL.FormatForSQL(HttpContext.Current.Session.Item("MasterAircraft").ToString.ToLower) + "',")  ' rrdn_query

                Case "history"
                    sQuery.Append("'" + clsData_Manager_SQL.FormatForSQL(HttpContext.Current.Session.Item("MasterAircraft").ToString.ToLower) + "',")  ' rrdn_query

                Case "company"

                    If reportNumber = 7 Then

                        If chkIncludeContacts.Checked Then
                            Dim tmpQueryString As String = ""

                            tmpQueryString = HttpContext.Current.Session.Item("MasterCompany").ToString.Replace("'' as", "")
                            HttpContext.Current.Session.Item("MasterCompany") = tmpQueryString.Replace("0 as contact_id", "contact_id")
                            tmpQueryString = ""

                        End If

                        If HttpContext.Current.Session.Item("MasterCompany").ToString.ToLower.Contains("business_type_reference") Then
                            Dim tmpQueryString As String = ""
                            tmpQueryString = HttpContext.Current.Session.Item("MasterCompany").ToString.Replace("comp_action_date,", "comp_action_date, (SELECT DISTINCT cbus_name FROM Company_Business_Type WITH (NOLOCK) WHERE comp_business_type = cbus_type) AS comp_rel, (SELECT DISTINCT country_continent_name FROM country WITH (NOLOCK) WHERE comp_country = country_name) AS comp_continent,")
                            HttpContext.Current.Session.Item("MasterCompany") = tmpQueryString
                        End If

                    End If

                    sQuery.Append("'" + clsData_Manager_SQL.FormatForSQL(HttpContext.Current.Session.Item("MasterCompany").ToString.ToLower) + "',")  ' rrdn_query

                Case "events"
                    sQuery.Append("'" + clsData_Manager_SQL.FormatForSQL(HttpContext.Current.Session.Item("MasterEvents").ToString.ToLower) + "',")  ' rrdn_query

                Case "performance specs"

                    sQuery.Append("'" + "select * from aircraft_model with(nolock) inner join aircraft_type with(nolock) on amod_type_code = atype_code ")
                    sQuery.Append(clsData_Manager_SQL.FormatForSQL(HttpContext.Current.Session.Item("MasterAircraftPerformanceSpecsWhere").ToString.ToLower) + "',")  ' rrdn_query

                Case "operating costs"
                    sQuery.Append("'" + "select * from aircraft_model with(nolock) inner join aircraft_type with(nolock) on amod_type_code = atype_code ")
                    sQuery.Append(clsData_Manager_SQL.FormatForSQL(HttpContext.Current.Session.Item("MasterAircraftOperatingCostWhere").ToString.ToLower) + "',")  ' rrdn_query

                Case "market summary"
                    sQuery.Append("'" + clsData_Manager_SQL.FormatForSQL(HttpContext.Current.Session.Item("MasterMarketSummary").ToString.ToLower) + "',")  ' rrdn_query

                Case "view7" ' shareholder report
                    sQuery.Append("'" + clsData_Manager_SQL.FormatForSQL(HttpContext.Current.Session.Item("MasterShareholder").ToString.ToLower) + "',")  ' rrdn_query

                Case "view4" ' document report
                    sQuery.Append("'" + clsData_Manager_SQL.FormatForSQL(HttpContext.Current.Session.Item("MasterDocumentList").ToString.ToLower) + "',")  ' rrdn_query

                Case "wanted"
                    sQuery.Append("'" + clsData_Manager_SQL.FormatForSQL(HttpContext.Current.Session.Item("MasterWanted").ToString.ToLower) + "',")  ' rrdn_query

                Case "yacht events"
                    sQuery.Append("'" + clsData_Manager_SQL.FormatForSQL(HttpContext.Current.Session.Item("MasterYachtEvents").ToString.ToLower) + "',")  ' rrdn_query

                Case "yacht", "yacht history"
                    sQuery.Append("'" + clsData_Manager_SQL.FormatForSQL(HttpContext.Current.Session.Item("MasterYacht").ToString.ToLower) + "',")  ' rrdn_query

            End Select

            If bHtmlReport Then      ' html report
                sQuery.Append("'Y',")
            Else
                sQuery.Append("'N',")
            End If

            If bExcelReport Then     ' excel report
                sQuery.Append("'Y',")
            Else
                sQuery.Append("'N',")
            End If

            If bTextCommaReport Then ' text comma delimited
                sQuery.Append("'Y',")
            Else
                sQuery.Append("'N',")
            End If

            If bTextTabReport Then ' text tab delimited
                sQuery.Append("'Y',")
            Else
                sQuery.Append("'N',")
            End If

            If chkShowReportHeader.Checked Then
                sQuery.Append("'Y',")
            Else
                sQuery.Append("'N',")
            End If

            sQuery.Append("NULL,NULL,NULL,NULL,") ' rrdn_web_action_date, rrdn_processed_date, rrdn_action_date, rrdn_ftp_file_delete_date

            sQuery.Append("'" + replyUsername.Text.Replace(Constants.cSingleQuote, Constants.cDoubleSingleQuote) + "',") ' rrdn_reply_username
            sQuery.Append("'" + replyEmail.Text + "',") ' rrdn_reply_email

            sQuery.Append("'',") ' rrdn_report_filename 
            sQuery.Append("'',") ' rrdn_zip_filename 
            sQuery.Append("'N',") ' rrdn_on_hold 

            sQuery.Append("'Started .NET Report (#" + reportNumber.ToString + ") " + reportName + " - AT " + FormatDateTime(Now(), DateFormat.GeneralDate).ToString + "',")

            sQuery.Append(reportRecCount.ToString + ",") ' 


            sQuery.Append("'" + HttpContext.Current.Application.Item("crmClientSiteData").crmClientHostName.ToString.Trim + "',") ' rrdn_host_name 
            sQuery.Append("'" + HttpContext.Current.Application.Item("crmClientSiteData").webSiteHostName(HttpContext.Current.Session.Item("jetnetWebHostType")).ToString + "',") ' rrdn_app_name 


            If chkShowConfidential.Checked Then ' rrdn_include_confidential
                sQuery.Append("'Y',")
            Else
                sQuery.Append("'N',")
            End If

            If chkIncludeContacts.Checked Then ' rrdn_include_contacts
                sQuery.Append("'Y',")
            Else
                sQuery.Append("'N',")
            End If

            If chkIncludeAllContacts.Checked Then ' rrdn_include_all_contacts
                sQuery.Append("'Y',")
            Else
                sQuery.Append("'N',")
            End If

            If chkIncludeBaseAC.Checked Then ' rrdn_include_all_base_aircraft
                sQuery.Append("'Y',")
            Else
                sQuery.Append("'N',")
            End If

            If chkShowAsking.Checked Then ' rrdn_include_asking_price
                sQuery.Append("'Y',")
            Else
                sQuery.Append("'N',")
            End If

            If Not String.IsNullOrEmpty(addToAsking.Text.Trim) Then ' rrdn_add_to_asking_price
                sQuery.Append(Replace(addToAsking.Text, Constants.cCommaDelim, Constants.cEmptyString) + ",")
            Else
                sQuery.Append("0,")
            End If

            If Not IsNothing(HttpContext.Current.Session.Item("MasterAircraftCompany")) Then
                If Not String.IsNullOrEmpty(HttpContext.Current.Session.Item("MasterAircraftCompany").ToString.Trim) Then ' rrdn_company_subquery
                    sQuery.Append("'" + clsData_Manager_SQL.FormatForSQL(HttpContext.Current.Session.Item("MasterAircraftCompany").ToString.ToLower) + "',")
                Else
                    sQuery.Append("NULL,")
                End If
            Else
                sQuery.Append("NULL,")
            End If

            If Not IsNothing(HttpContext.Current.Session.Item("MasterAircraftContact")) Then
                If Not String.IsNullOrEmpty(HttpContext.Current.Session.Item("MasterAircraftContact").ToString.Trim) Then ' rrdn_contact_subquery
                    sQuery.Append("'" + clsData_Manager_SQL.FormatForSQL(HttpContext.Current.Session.Item("MasterAircraftContact").ToString.ToLower) + "',")
                Else
                    sQuery.Append("NULL,")
                End If
            Else
                sQuery.Append("NULL,")
            End If

            If report_area.ToLower = "view7" Then
                sQuery.Append(nFractionalProgramID.ToString) ' rrdn_progholder_id
            Else
                sQuery.Append("0") ' rrdn_progholder_id
            End If

            sQuery.Append(")")

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>AddRecordToReportRequest(ByVal reportNumber As Integer, ByVal reportName As String, ByVal reportRecCount As Integer) As Boolean<br />" + sQuery.ToString

            SqlConn.ConnectionString = Session.Item("jetnetAdminDatabase").ToString.Trim
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            Try
                SqlCommand.CommandText = sQuery.ToString
                SqlCommand.ExecuteNonQuery()
                bReturnValue = True
            Catch SqlException
                HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in AddRecordToReportRequest SqlCommand.ExecuteNonQuery : " + SqlException.Message
            End Try

        Catch ex As Exception

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in AddRecordToReportRequest(ByVal reportNumber As Integer, ByVal reportName As String, ByVal reportRecCount As Integer) As Boolean" + ex.Message

        Finally

            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return bReturnValue

    End Function

    Private Function generate_report_filename() As String

        Dim sFileName As String = ""
        Dim sReportTitle As String = ""

        Dim subscriptionInfo As String = Session.Item("localUser").crmSubSubID.ToString + "_" + Session.Item("localUser").crmUserLogin.ToString.Trim + "_" + Session.Item("localUser").crmSubSeqNo.ToString + "_"

        Dim tmpIndex As Integer = 0

        For x As Integer = 0 To UBound(report_array)
            If report_id = CInt(report_array(x, RPT_ID).ToString) Then
                tmpIndex = x
                Exit For
            End If
        Next

        Dim sTmpRptTitle As String = report_array(tmpIndex, RPT_TITLE).ToLower.Trim

        ' clean out "-" Hyphens from title
        ' change spaces and forwardslash to underscores " " spaces "/" ForwardSlash -> cImbedComa = "_"
        sTmpRptTitle = Replace(sTmpRptTitle, Constants.cSingleForwardSlash, Constants.cImbedComa)
        sTmpRptTitle = Replace(sTmpRptTitle, Constants.cHyphen, Constants.cEmptyString)
        sTmpRptTitle = Replace(sTmpRptTitle, Constants.cSpaceDelim, Constants.cImbedComa)


        subscriptionInfo = Replace(subscriptionInfo, ".", "")
        subscriptionInfo = Replace(subscriptionInfo, "@", "")

        sReportTitle = subscriptionInfo + sTmpRptTitle + "_" + report_id.ToString

        If comp_id > 0 Then  ' add company id to report name
            sReportTitle += "_" + comp_id.ToString
        End If

        If ac_id > 0 Then ' add aircraft id to report name
            sReportTitle += "_" + ac_id.ToString
        End If

        Select Case report_id

            Case Is = 10, 11, 24, 25, 39, 40, 41, 43, 47, 999, 53, 54

                If bWordReport Then
                    sFileName = commonEvo.GenerateFileName(sReportTitle, ".doc", False)
                ElseIf bHtmlReport Or bPdfReport Then
                    sFileName = commonEvo.GenerateFileName(sReportTitle, ".html", False)
                ElseIf bExcelReport Then

                    If bIsMac = True Then
                        sFileName = commonEvo.GenerateFileName(sReportTitle, ".xlsx", False)
                    Else
                        sFileName = commonEvo.GenerateFileName(sReportTitle, ".xls", False)
                    End If

                End If

            Case Else

                If bWordReport Then
                    sFileName = commonEvo.GenerateFileName(sReportTitle, ".doc", False)
                ElseIf bExcelReport Then

                    If bIsMac = True Then
                        sFileName = commonEvo.GenerateFileName(sReportTitle, ".xlsx", False)
                    Else
                        sFileName = commonEvo.GenerateFileName(sReportTitle, ".xls", False)
                    End If

                ElseIf (bTextCommaReport Or bTextTabReport) Then
                    sFileName = commonEvo.GenerateFileName(sReportTitle, ".txt", False)
                ElseIf bHtmlReport Then
                    sFileName = commonEvo.GenerateFileName(sReportTitle, ".html", False)
                End If

        End Select

        Return sFileName

    End Function

    Private Sub set_start_help_text(ByVal bExportReport As Boolean)

        Dim sTextString As New StringBuilder

        If bExportReport Then
            sTextString.Append("Please select the <b>REPORT</b> and <b>OPTIONS</b> that you would like. When you have picked your options, click the <em>'Run Report'</em> or <em>'Submit Report'</em> button.")
            sTextString.Append("<br/><br/><strong>LEGAL&nbsp;NOTICE:&nbsp;Export/Report&nbsp;Data&nbsp;Usage:</strong>&nbsp;&nbsp;")
            sTextString.Append("Subscribers agree that: (1) ALL JETNET data is available to users on a subscription only basis. ")
            sTextString.Append("(2) ALL JETNET data is the property of JETNET and may not be used or otherwise published without the express written permission of JETNET. ")
            sTextString.Append("(3) No JETNET data shall be exported for any purposes that directly or indirectly compete with JETNET's services. ")
            sTextString.Append("(4) No JETNET data shall be exported for use in 3rd party systems or CRMs for the purpose of reducing subscriptions to JETNET services. ")
            sTextString.Append("- Any breach of the data usage agreement above by the subscribing company and/or their respective employees, agents, or representatives will be subject to legal action.")
        Else
            sTextString.Append("<b><font color='red'>You are currently on a Demo or Marketing Account and are not able to use this capability</font></b>")
        End If

        SetReportHelpText(sTextString.ToString)

        sTextString = Nothing

    End Sub

    Protected Sub btnRunReportOnClick(ByVal sender As Object, ByVal e As EventArgs) Handles btnRunReport.Click
        create_report_file()
    End Sub

    Public Sub create_report_file()

        Dim tmpReportString As String = ""
        Dim results_table As DataTable = Nothing
        Dim item_string() As String = Nothing
        Dim reportRecCount As Integer = 0

        Dim report_name As String = ""
        Dim report_name_plain As String = ""
        Dim nCount = 0

        Dim nHoldItemID As Long = 0
        Dim record_count As Long = 0

        Try

            If bExportFlag Then

                If Not chkSubmitReport.Checked Then

                    If report_area.ToLower.Trim.Contains("aircraft") Then

                        If Not IsNothing(Session.Item("Aircraft_Master")) And ac_id = 0 Then
                            results_table = Session.Item("Aircraft_Master")

                            If results_table.Rows.Count > 0 And ac_id = 0 Then
                                reportRecCount = results_table.Rows.Count

                                ReDim item_string(results_table.Rows.Count - 1)
                                For i As Integer = 0 To results_table.Rows.Count - 1
                                    item_string(i) = results_table.Rows(i).Item("ac_id").ToString
                                Next

                            End If

                            reportRecCount = item_string.Length

                        End If

                    ElseIf report_area.ToLower.Trim.Contains("yacht") Then

                        If report_area.ToLower.Trim.Contains("yacht events") Then

                            If Not IsNothing(Session.Item("Yacht_Master")) And yacht_id = 0 Then

                                results_table = Session.Item("Yacht_Master")

                                If results_table.Rows.Count > 0 And yacht_id = 0 Then

                                    ReDim item_string(nCount)
                                    For i As Integer = 0 To results_table.Rows.Count - 1
                                        If nHoldItemID <> CLng(results_table.Rows(i).Item("ype_yt_id").ToString) Then
                                            ReDim Preserve item_string(nCount)
                                            item_string(nCount) = results_table.Rows(i).Item("ype_yt_id").ToString
                                            nHoldItemID = CLng(results_table.Rows(i).Item("ype_yt_id").ToString)
                                            nCount += 1
                                        End If
                                    Next

                                End If

                                reportRecCount = item_string.Length

                            End If

                        Else

                            If Not IsNothing(Session.Item("Yacht_Master")) And yacht_id = 0 Then

                                results_table = Session.Item("Yacht_Master")

                                If results_table.Rows.Count > 0 And yacht_id = 0 Then

                                    reportRecCount = results_table.Rows.Count

                                    ReDim item_string(results_table.Rows.Count - 1)
                                    For i As Integer = 0 To results_table.Rows.Count - 1
                                        item_string(i) = results_table.Rows(i).Item("yt_id").ToString
                                    Next

                                End If

                                reportRecCount = item_string.Length

                            End If

                        End If

                    ElseIf report_area.ToLower.Trim.Contains("events") Then

                        If Not IsNothing(Session.Item("Aircraft_Master")) And ac_id = 0 Then

                            results_table = Session.Item("Aircraft_Master")

                            If results_table.Rows.Count > 0 And ac_id = 0 Then

                                ReDim item_string(nCount)
                                For i As Integer = 0 To results_table.Rows.Count - 1
                                    If nHoldItemID <> CLng(results_table.Rows(i).Item("ac_id").ToString) Then
                                        ReDim Preserve item_string(nCount)
                                        item_string(nCount) = results_table.Rows(i).Item("ac_id").ToString
                                        nHoldItemID = CLng(results_table.Rows(i).Item("ac_id").ToString)
                                        nCount += 1
                                    End If
                                Next

                            End If

                            reportRecCount = item_string.Length

                        End If

                    ElseIf ac_id > 0 And String.IsNullOrEmpty(report_area.Trim) Then
                        ReDim item_string(0)
                        item_string(0) = ac_id.ToString
                        reportRecCount = item_string.Length
                    ElseIf yacht_id > 0 And String.IsNullOrEmpty(report_area.Trim) Then
                        ReDim item_string(0)
                        item_string(0) = yacht_id.ToString
                        reportRecCount = item_string.Length
                    End If

                    If reportRecCount = 0 And (ac_id = 0 Or yacht_id = 0) Then

                        Dim results_table2 As New DataTable
                        results_table2 = get_report_query_record_count()
                        If Not IsNothing(results_table2) Then
                            If results_table2.Rows.Count > 0 Then
                                reportRecCount = results_table2.Rows.Count
                            End If
                        End If

                        results_table2 = Nothing

                    End If

                    ' only block reports other than 17 (market summary)
                    If report_id <> 17 Then
                        If Not String.IsNullOrEmpty(check_for_report_limit(reportRecCount, True)) Then
                            SetReportHelpText(check_for_report_limit(reportRecCount, False))
                        End If
                    End If

                    If Not bBlockedReport Then

                        Dim tmpIndex As Integer = 0

                        For x As Integer = 0 To UBound(report_array)
                            If report_id = CInt(report_array(x, RPT_ID).ToString) Then
                                tmpIndex = x
                                Exit For
                            End If
                        Next

                        Call commonLogFunctions.Log_User_Event_Data("UserJetnetReport", report_array(tmpIndex, RPT_TITLE).ToString.Trim, Nothing)

                        If Trim(Request("test")) = "Y" Then
                            If report_id = 47 Then
                                report_id = 54
                            End If
                        End If



                        Select Case (report_id)
                            Case 1
                                tmpReportString = create_report_1_export_current_company_list(record_count)
                            Case 2
                                tmpReportString = create_report_2_export_current_aircraft_list(record_count)
                            Case 3
                                tmpReportString = create_report_3_export_current_history_list(record_count)
                            Case 4
                                tmpReportString = create_report_4_export_current_performance_list(record_count)
                            Case 5
                                create_report_5_export_current_operating_costs_list(record_count)
                            Case 6
                                tmpReportString = create_report_6_export_current_wanteds_list(record_count)
                            Case 7
                                tmpReportString = create_report_7_labels_export_current_company_list(record_count)
                            Case 8
                                tmpReportString = create_report_8_condensed_record_with_owner_operator(record_count)
                            Case 9
                                tmpReportString = create_report_9_export_aircraft_list_extra_company_info(record_count)
                            Case 10
                                tmpReportString = create_report_10_standard_available_listing(record_count)
                            Case 11
                                tmpReportString = create_report_11_standard_non_available_listing(record_count)
                            Case 12
                'tmpReportString = Create_Report_12()
                            Case 13
                'tmpReportString = Create_Report_13()
                            Case 14
                                tmpReportString = create_report_14_label_export_current_aircraft_list(record_count)
                            Case 15
                'tmpReportString = Create_Report_15()
                            Case 16
                'tmpReportString = Create_Report_16() 
                            Case 17
                ' market summary is generated on "market summary page"
                            Case 18
                'tmpReportString = Create_Report_18()
                            Case 19
                'tmpReportString = Create_Report_19_Offline_Report()
                            Case 20
                                tmpReportString = create_report_20_export_current_events_list(record_count)
                            Case 21
                                tmpReportString = create_report_21_labels_export_current_events_list(record_count)
                            Case 22
                'tmpReportString = Create_Report_22()
                            Case 23
                                tmpReportString = create_report_23_company_contact_labels(record_count)
                            Case 24
                                tmpReportString = create_report_24_aircraft_identifying_information_and_contact_information(record_count)
                            Case 25
                                tmpReportString = create_report_25_aircraft_identifying_information_and_contact_information_history(record_count)
                            Case 26
                'tmpReportString = Create_Report_26()
                            Case 27
                                tmpReportString = create_report_27_condensed_aircraft_listing_blind_form(record_count)
                            Case 28
                                tmpReportString = create_report_28_condensed_aircraft_listing(record_count)
                            Case 29
                'tmpReportString = Create_Report_29()
                            Case 30
                                tmpReportString = create_report_30_aircraft_seller_purchaser_history(record_count)
                            Case 31
                                tmpReportString = create_report_31_aircraft_seller_purchaser_events(record_count)
                            Case 32
                                tmpReportString = create_report_32_aircraft_company_fractional_information(record_count)
                            Case 33
                                tmpReportString = create_report_33_aircraft_comparison_report(record_count)
                            Case 34
                'tmpReportString = Create_Report_34()
                            Case 35
                                tmpReportString = create_report_35_share_holder_with_aircraft_information(record_count)
                            Case 36
                                tmpReportString = create_report_36_unique_company_contact_email(record_count)
                            Case 37
                'tmpReportString = Create_Report_37() ' no report 37
                            Case 38
                'tmpReportString = Create_Report_38()
                            Case 39
                                tmpReportString = create_single_page_spec_sheet(item_string, record_count)
                            Case 40
                                tmpReportString = create_condensed_spec_sheet(item_string, record_count)
                            Case 41
                                tmpReportString = create_aircraft_full_spec_sheet(item_string, record_count)
                            Case 42
                                tmpReportString = create_report_42_export_current_yacht_events_list(record_count)
                            Case 43
                                tmpReportString = create_yacht_full_spec_sheet(item_string, record_count)
                            Case 44
                'tmpReportString = create_yacht_single_page_spec_sheet(item_string)
                            Case 45
                                tmpReportString = create_report_45_documents_list_with_aircraft_information(record_count)
                            Case 46
                                tmpReportString = create_report_46_export_current_yacht_list(record_count)
                            Case 47
                                tmpReportString = create_report_47_export_company_details(record_count)
                            Case 48
                                tmpReportString = create_report_48_unique_company_contact_email(record_count)
                            Case 49
                                tmpReportString = create_report_49_yacht_seller_purchaser_history(record_count)
                            Case 50
                                tmpReportString = create_report_50_condensed_spec_jfw_format(record_count)
                            Case 51
                                tmpReportString = create_report_51_detailed_spec_jfw_format(record_count)
                            Case 52
                                tmpReportString = create_report_52_aircraft_seller_purchaser_history_with_fractional(record_count)
                            Case 53
                                tmpReportString = create_report_53_aircraft_full_spec_sheet(item_string, record_count)
                            Case 54
                                tmpReportString = create_report_54_company_full_spec(record_count)

                'Case 998
                '  tmpReportString = create_report_998_model_values_full_spec_sheet()
                            Case 999
                                tmpReportString = create_report_999_export_company_sold_transactions(record_count)
                        End Select


                        'If report_id = 998 And InStr(Session.Item("localUser").crmLocalUserName, "@mvintech.com") <> 0 And Trim(Request("new")) = "Y" Then
                        '  report_id = 22
                        'End If

                        sReportFilename = ""
                        report_name_plain = find_report_name(report_id)


                        If Not String.IsNullOrEmpty(tmpReportString.Trim) Or report_id = 5 Or report_id = 17 Then

                            Select Case report_id

                                Case 5

                                    If Not String.IsNullOrEmpty(HttpContext.Current.Session.Item("OpCostsBaseFileName").ToString.Trim) Then

                                        If bExcelReport Then
                                            sReportFilename = HttpContext.Current.Session.Item("MarketSummaryFolderVirtualPath").ToString + "/" + HttpContext.Current.Session.Item("OpCostsBaseFileName") + ".xls"
                                        ElseIf bHtmlReport Then
                                            sReportFilename = HttpContext.Current.Session.Item("MarketSummaryFolderVirtualPath").ToString + "/" + HttpContext.Current.Session.Item("OpCostsBaseFileName") + ".html"
                                        End If

                                        sReportFilename = Application.Item("crmClientSiteData").ClientFullHostName.ToString.Trim + sReportFilename

                                    End If

                                Case 17

                                    If Not String.IsNullOrEmpty(HttpContext.Current.Session.Item("marketSummaryBaseFileName").ToString.Trim) Then

                                        If bExcelReport Then
                                            report_name = HttpContext.Current.Session.Item("MarketSummaryFolderVirtualPath").ToString + "/" + HttpContext.Current.Session.Item("marketSummaryBaseFileName") + ".xls"
                                        ElseIf bHtmlReport Then
                                            report_name = HttpContext.Current.Session.Item("MarketSummaryFolderVirtualPath").ToString + "/" + HttpContext.Current.Session.Item("marketSummaryBaseFileName") + ".html"
                                        ElseIf bPdfReport Then
                                            report_name = HttpContext.Current.Session.Item("marketSummaryBaseFileName") + ".html"
                                        End If


                                        If chkShowReportHeader.Checked = True And chkShowReportHeader.Visible = True And TableRow0.Visible = True Then
                                            report_name = Replace(report_name, ".html", "_wHeader.html")
                                        Else

                                        End If

                                        If bPdfReport Then

                                            If convert_to_pdf(report_name) Then

                                                report_name = commonEvo.GenerateFileName(report_name, ".pdf", True) ' just change the file extentsion

                                                report_name = HttpContext.Current.Session.Item("MarketSummaryFolderVirtualPath").ToString + "/" + report_name

                                            Else
                                                HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in convert HTML to PDF"
                                            End If

                                        End If

                                        sReportFilename = Application.Item("crmClientSiteData").ClientFullHostName.ToString.Trim + report_name

                                    End If

                                Case Else

                                    report_name = generate_report_filename()


                                    If Not bPdfReport Then

                                        If write_report_string_to_file(tmpReportString, report_name) Then
                                            sReportFilename = HttpContext.Current.Session.Item("MarketSummaryFolderVirtualPath").ToString + "/" + report_name
                                        Else
                                            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in sending string to file"
                                        End If

                                    Else

                                        If write_report_string_to_file(tmpReportString, report_name) Then

                                            If convert_to_pdf(report_name) Then

                                                report_name = commonEvo.GenerateFileName(report_name, ".pdf", True) ' just change the file extentsion
                                                sReportFilename = HttpContext.Current.Session.Item("MarketSummaryFolderVirtualPath").ToString + "/" + report_name

                                            Else
                                                HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in convert HTML to PDF"
                                            End If

                                        Else
                                            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in sending string to file"
                                        End If

                                    End If

                                    sReportFilename = Application.Item("crmClientSiteData").ClientFullHostName + sReportFilename

                            End Select

                            If String.IsNullOrEmpty(sReportFilename.Trim) Then
                                SetReportHelpText("<b><font color='red'>There was an error generateing your report! Please check your selections and try running again.</font></b>")
                            Else
                                Dim reportURL As String = "openReportWindow('" + sReportFilename.Trim + "','" + report_id.ToString + "');"
                                System.Web.UI.ScriptManager.RegisterStartupScript(Me, Me.GetType(), "PopUpSelectedReportWindow", reportURL, True)
                            End If

                        Else
                            SetReportHelpText("<b><font color='red'>There was an error generateing your report! Please check your selections and try running again.</font></b>")
                        End If


                        'report_name


                    Else

                        ' if report was blocked show the submit report panel

                        get_subscriber_name_email()

                        submit_report_panel.Visible = True
                        chkSubmitReport.Checked = True

                    End If

                Else

                    If String.IsNullOrEmpty(replyEmail.Text.Trim) Or String.IsNullOrEmpty(replyUsername.Text.Trim) Then
                        SetReportHelpText("<b><font color='red'>Your 'reply to name' and/or your 'email address' is blank. Please Correct and re-submit report ...</font></b>")
                    Else
                        If Not bSubmitSuccess Then
                            If Not bCantSubmitFlag Then
                                SetReportHelpText("<b><font color='red'>There was an error submitting your report to Jetnet for processing!</font></b>")
                            Else
                                Dim sHelpText1 = "<b><font color='red'>The report that you have selected is not 'available' to be submitted at this time.</font><br />"
                                sHelpText1 += "Please Contact JETNET Customer Service for further assistance at <a href='mailto:customerservice@jetnet.com'>customerservice@jetnet.com</a> or 1-(800)-553-8638.</b>"
                                SetReportHelpText(sHelpText1)
                                submit_report_panel.Visible = False
                            End If
                        Else
                            SetReportHelpText("<b>Your Report Has Been Submitted to Jetnet for processing ...</b>")
                            System.Web.UI.ScriptManager.RegisterStartupScript(Me, Me.GetType(), "SubmitSelectedReportWindow", "alert('Your Report Has Been Submitted to Jetnet for processing ...');", True)
                        End If
                    End If

                End If
            End If



            Try
                Call commonLogFunctions.Log_User_Event_Data("UserExport", "Records: " & record_count & ", Export: " & report_name_plain, Nothing)
            Catch ex As Exception

            End Try


        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in create_report_file()" + ex.Message
        Finally

        End Try

    End Sub

    Private Sub SetReportHelpText(ByVal helpText As String)
        help_text_label.Text = helpText
    End Sub

    Private Function write_report_string_to_file(ByVal sOutoutString As String, ByVal sReportname As String) As Boolean

        Try

            Dim f As System.IO.StreamWriter

            f = System.IO.File.CreateText(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" + sReportname.Trim)

            ' write to the file
            f.WriteLine(sOutoutString)

            'close the streamwriter
            f.Close()
            f.Dispose()
            f = Nothing

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in write_report_string_to_file(ByVal sOutoutString As String, ByVal sReportname As String) As Boolean " + ex.Message
            Return False
        End Try

        Return True

    End Function

    Private Function convert_to_pdf(ByVal report_name As String) As Boolean

        Dim reportFolder As String = HttpContext.Current.Server.MapPath(HttpContext.Current.Session.Item("MarketSummaryFolderVirtualPath").ToString)
        Dim bReturnValue As Boolean = False
        Dim varURL As String = ""
        Dim varTimeout As Integer = 0

        Dim htmlToPdfConverter As New EvoPdf.HtmlToPdfConverter()

        Try

            varURL = reportFolder + "\" + report_name
            varTimeout = 60

            ' Set license key received after purchase to use the converter in licensed mode
            ' Leave it not set to use the converter in demo mode
            ' htmlToPdfConverter.LicenseKey = "" '"31FCUEVAUEJCSFBGXkBQQ0FeQUJeSUlJSVBA" old key
            htmlToPdfConverter.LicenseKey = "9Xtoem9qemp6bXRqemlrdGtodGNjY2N6ag=="

            ' Set HTML Viewer width in pixels which is the equivalent in converter of the browser window width
            htmlToPdfConverter.HtmlViewerWidth = 1024

            ' Set HTML viewer height in pixels to convert the top part of a HTML page 
            ' Leave it not set to convert the entire HTML
            htmlToPdfConverter.HtmlViewerHeight = 0

            ' Set PDF page size which can be a predefined size like A4 or a custom size in points 
            ' Leave it not set to have a default A4 PDF page
            htmlToPdfConverter.PdfDocumentOptions.PdfPageSize = EvoPdf.PdfPageSize.A4

            ' Set PDF page orientation to Portrait or Landscape
            ' Leave it not set to have a default Portrait orientation for PDF page
            htmlToPdfConverter.PdfDocumentOptions.PdfPageOrientation = EvoPdf.PdfPageOrientation.Portrait

            ' Set the maximum time in seconds to wait for HTML page to be loaded 
            ' Leave it not set for a default 60 seconds maximum wait time
            htmlToPdfConverter.NavigationTimeout = varTimeout

            ' Set an adddional delay in seconds to wait for JavaScript or AJAX calls after page load completed
            ' Set this property to 0 if you don't need to wait for such asynchcronous operations to finish
            htmlToPdfConverter.ConversionDelay = 0

            htmlToPdfConverter.ConvertUrlToFile(varURL, reportFolder + "\" + commonEvo.GenerateFileName(report_name, ".pdf", True))

            bReturnValue = True

        Catch ex As Exception

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "error in convert_to_pdf: " + ex.Message
            AclsData_Temp.LogError(Application.Item("crmClientSiteData").crmClientHostName, "PDF_Creator.aspx.vb convert_to_pdf(): Error in Aircraft Spec Generation: " & ex.Message, DateTime.Now.ToString())
        Finally

            ' Clear Objects
            htmlToPdfConverter = Nothing

        End Try

        Return bReturnValue

    End Function

#End Region

#Region "report_1_functions"

    Public Function create_report_1_export_current_company_list(ByRef record_count As Long) As String

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim report_1_datatable As New DataTable

        Dim adoRS_1 As System.Data.SqlClient.SqlDataReader : adoRS_1 = Nothing

        Dim htmlOut = New StringBuilder()
        Dim sQuery As New StringBuilder()

        Try

            SqlConn.ConnectionString = localFunctions.clientConnectStr

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 90

            sQuery.Append(HttpContext.Current.Session.Item("MasterCompany").ToString)

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />Create_Report_1_Export_Current_Company_List()<br />" + sQuery.ToString

            If bHtmlReport Then
                htmlOut.Append("<!DOCTYPE html>")
                htmlOut.Append("<html lang='en'>")
                htmlOut.Append("<head>")
                htmlOut.Append("<meta http-equiv='Content-Language' content='en-us' />")
                htmlOut.Append("<meta http-equiv='Content-Type' content='text/html; charset=windows-1252' />")
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='common/jetnet.css' />")
                htmlOut.Append("<title>JETNET - Export of Current Company List</title>")
                htmlOut.Append("</head>")
                htmlOut.Append("<body style='background: white; margin-top:10px; margin-left:10px;'>")
                htmlOut.Append("<div style='text-align:center;'>")
            End If

            If bExcelReport Then
                htmlOut.Append("<table border='1' cellpadding='2' cellspacing='0'>")
            ElseIf bHtmlReport Then
                htmlOut.Append("<table class='centerTable' border='0' cellpadding='2' cellspacing='0' width='100%'>")
            End If

            SqlCommand.CommandText = sQuery.ToString
            adoRS_1 = SqlCommand.ExecuteReader()

            Try
                report_1_datatable.Load(adoRS_1)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = report_1_datatable.GetErrors()
            End Try

            record_count = report_1_datatable.Rows.Count

            adoRS_1.Close()
            adoRS_1 = Nothing

            If report_1_datatable.Rows.Count > 0 Then

                If chkShowReportHeader.Checked Then

                    If bExcelReport Or bHtmlReport Then

                        htmlOut.Append("<tr bgcolor='#CCCCCC'>")

                        htmlOut.Append("<td align='left'>COMPANY</td>")
                        htmlOut.Append("<td align='left'>COMPALTNAME</td>")

                        If HttpContext.Current.Session.Item("searchCriteria").SearchCriteriaCompanyDisplayContactInfo Then
                            htmlOut.Append("<td align='left'>CONTACT</td>")
                            htmlOut.Append("<td align='left'>TITLE</td>")
                            htmlOut.Append("<td align='left'>CONTACTEMAIL</td>")
                        End If

                        htmlOut.Append("<td align='left'>ADDRESS</td>")
                        htmlOut.Append("<td align='left'>CITY</td>")
                        htmlOut.Append("<td align='left'>STATE</td>")
                        htmlOut.Append("<td align='left'>POSTALCODE</td>")
                        htmlOut.Append("<td align='left'>COUNTRY</td>")
                        htmlOut.Append("<td align='left'>LASTCHANGE</td>")

                        htmlOut.Append("</tr>")

                    ElseIf bTextCommaReport Then

                        htmlOut.Append(Constants.QUOTE + "COMPANY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPALTNAME" + Constants.QUOTE + Constants.cCommaDelim)

                        If HttpContext.Current.Session.Item("searchCriteria").SearchCriteriaCompanyDisplayContactInfo Then
                            htmlOut.Append(Constants.QUOTE + "CONTACT" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "TITLE" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "CONTACTEMAIL" + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        htmlOut.Append(Constants.QUOTE + "ADDRESS" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CITY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "STATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "POSTALCODE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COUNTRY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "LASTCHANGE" + Constants.QUOTE)

                        htmlOut.Append(vbCrLf)

                    ElseIf bTextTabReport Then

                        htmlOut.Append("COMPANY" + vbTab)
                        htmlOut.Append("COMPALTNAME" + vbTab)

                        If HttpContext.Current.Session.Item("searchCriteria").SearchCriteriaCompanyDisplayContactInfo Then
                            htmlOut.Append("CONTACT" + vbTab)
                            htmlOut.Append("TITLE" + vbTab)
                            htmlOut.Append("CONTACTEMAIL" + vbTab)
                        End If

                        htmlOut.Append("ADDRESS" + vbTab)
                        htmlOut.Append("CITY" + vbTab)
                        htmlOut.Append("STATE" + vbTab)
                        htmlOut.Append("POSTALCODE" + vbTab)
                        htmlOut.Append("COUNTRY" + vbTab)
                        htmlOut.Append("LASTCHANGE")

                        htmlOut.Append(vbCrLf)

                    End If   ' 

                End If ' chkShowReportHeader.Checked Then

                For Each Row As DataRow In report_1_datatable.Rows

                    If bHtmlReport Or bExcelReport Then

                        htmlOut.Append("<tr>")

                        If Not (IsDBNull(Row.Item("comp_name"))) Then
                            htmlOut.Append("<td valign='middle' align='left'>" + Row.Item("comp_name").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td valign='middle' align='left'></td>")
                        End If

                        htmlOut.Append("<td valign='middle' align='left'>")

                        If Not IsDBNull(Row.Item("comp_alternate_name_type")) And Not IsDBNull(Row.Item("comp_alternate_name")) Then
                            If Not String.IsNullOrEmpty(Row.Item("comp_alternate_name_type").ToString.Trim) And Not String.IsNullOrEmpty(Row.Item("comp_alternate_name").ToString.Trim) Then
                                htmlOut.Append(Row.Item("comp_alternate_name_type").ToString.Trim + Constants.cSingleSpace + Row.Item("comp_alternate_name").ToString.Trim)
                            End If
                        Else
                            If Not IsDBNull(Row.Item("comp_alternate_name")) Then
                                If Not String.IsNullOrEmpty(Row.Item("comp_alternate_name").ToString.Trim) Then
                                    htmlOut.Append(Row.Item("comp_alternate_name").ToString.Trim)
                                End If
                            End If
                        End If

                        htmlOut.Append("</td>")

                        If HttpContext.Current.Session.Item("searchCriteria").SearchCriteriaCompanyDisplayContactInfo Then

                            htmlOut.Append("<td valign='middle' align='left'>")

                            If Not (IsDBNull(Row.Item("contact_sirname"))) Then
                                htmlOut.Append(Row.Item("contact_sirname").ToString.Trim + Constants.cSingleSpace)
                            End If

                            If Not (IsDBNull(Row.Item("contact_first_name"))) Then
                                htmlOut.Append(Row.Item("contact_first_name").ToString.Trim)
                            End If

                            If Not (IsDBNull(Row.Item("contact_last_name"))) Then
                                htmlOut.Append(Constants.cSingleSpace + Row.Item("contact_last_name").ToString.Trim)
                            End If

                            htmlOut.Append("</td>")

                            If Not (IsDBNull(Row.Item("contact_title"))) Then
                                htmlOut.Append("<td valign='middle' align='left'>" + Row.Item("contact_title").ToString.Trim + "</td>")
                            Else
                                htmlOut.Append("<td valign='middle' align='left'></td>")
                            End If

                            Dim sEmailAddress As String = localFunctions.get_contact_email_address_report(CLng(Row.Item("comp_id")), CLng(Row.Item("contact_id")))

                            If Not String.IsNullOrEmpty(sEmailAddress) Then
                                htmlOut.Append("<td valign='middle' align='left'>" + sEmailAddress.Trim + "</td>")
                            Else
                                htmlOut.Append("<td valign='middle' align='left'></td>")
                            End If

                        End If

                        If Not (IsDBNull(Row.Item("comp_address1"))) Then
                            htmlOut.Append("<td valign='middle' align='left'>" + Row.Item("comp_address1").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td valign='middle' align='left'></td>")
                        End If

                        If Not (IsDBNull(Row.Item("comp_city"))) Then
                            htmlOut.Append("<td valign='middle' align='left'>" + Row.Item("comp_city").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td valign='middle' align='left'></td>")
                        End If

                        If Not (IsDBNull(Row.Item("comp_state"))) Then
                            htmlOut.Append("<td valign='middle' align='left'>" + Row.Item("comp_state").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td valign='middle' align='left'></td>")
                        End If

                        If Not (IsDBNull(Row.Item("comp_zip_code"))) Then
                            htmlOut.Append("<td valign='middle' align='left'>" + Row.Item("comp_zip_code").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td valign='middle' align='left'></td>")
                        End If

                        If Not (IsDBNull(Row.Item("comp_country"))) Then
                            htmlOut.Append("<td valign='middle' align='left'>" + Row.Item("comp_country").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td valign='middle' align='left'></td>")
                        End If

                        If Not (IsDBNull(Row.Item("comp_action_date"))) Then
                            If IsDate(Row.Item("comp_action_date").ToString) Then
                                htmlOut.Append("<td valign='middle' align='left'>" + FormatDateTime(Row.Item("comp_action_date").ToString, DateFormat.ShortDate).Trim + "</td>")
                            Else
                                htmlOut.Append("<td valign='middle' align='left'></td>")
                            End If
                        Else
                            htmlOut.Append("<td valign='middle' align='left'></td>")
                        End If

                        htmlOut.Append("</tr>")

                    ElseIf bTextCommaReport Then

                        If Not (IsDBNull(Row.Item("comp_name"))) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("comp_name").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        htmlOut.Append(Constants.QUOTE)

                        If Not IsDBNull(Row.Item("comp_alternate_name_type")) And Not IsDBNull(Row.Item("comp_alternate_name")) Then
                            If Not String.IsNullOrEmpty(Row.Item("comp_alternate_name_type").ToString.Trim) And Not String.IsNullOrEmpty(Row.Item("comp_alternate_name").ToString.Trim) Then
                                htmlOut.Append(Row.Item("comp_alternate_name_type").ToString.Trim + Constants.cSingleSpace + Row.Item("comp_alternate_name").ToString.Trim)
                            End If
                        Else
                            If Not IsDBNull(Row.Item("comp_alternate_name")) Then
                                If Not String.IsNullOrEmpty(Row.Item("comp_alternate_name").ToString.Trim) Then
                                    htmlOut.Append(Row.Item("comp_alternate_name").ToString.Trim)
                                End If
                            End If
                        End If

                        htmlOut.Append(Constants.QUOTE + Constants.cCommaDelim)

                        If HttpContext.Current.Session.Item("searchCriteria").SearchCriteriaCompanyDisplayContactInfo Then

                            htmlOut.Append(Constants.QUOTE)

                            If Not (IsDBNull(Row.Item("contact_sirname"))) Then
                                htmlOut.Append(Row.Item("contact_sirname").ToString.Trim + Constants.cSingleSpace)
                            End If

                            If Not (IsDBNull(Row.Item("contact_first_name"))) Then
                                htmlOut.Append(Row.Item("contact_first_name").ToString.Trim)
                            End If

                            If Not (IsDBNull(Row.Item("contact_last_name"))) Then
                                htmlOut.Append(Constants.cSingleSpace + Row.Item("contact_last_name").ToString.Trim)
                            End If

                            htmlOut.Append(Constants.QUOTE + Constants.cCommaDelim)

                            If Not (IsDBNull(Row.Item("contact_title"))) Then
                                htmlOut.Append(Constants.QUOTE + Row.Item("contact_title").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                            Else
                                htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                            End If

                            Dim sEmailAddress As String = localFunctions.get_contact_email_address_report(CLng(Row.Item("comp_id")), CLng(Row.Item("contact_id")))

                            If Not String.IsNullOrEmpty(sEmailAddress) Then
                                htmlOut.Append(Constants.QUOTE + sEmailAddress.Trim + Constants.QUOTE + Constants.cCommaDelim)
                            Else
                                htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                            End If

                        End If

                        If Not (IsDBNull(Row.Item("comp_address1"))) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("comp_address1").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        If Not (IsDBNull(Row.Item("comp_city"))) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("comp_city").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        If Not (IsDBNull(Row.Item("comp_state"))) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("comp_state").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        If Not (IsDBNull(Row.Item("comp_zip_code"))) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("comp_zip_code").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        If Not (IsDBNull(Row.Item("comp_country"))) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("comp_country").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        If Not (IsDBNull(Row.Item("comp_action_date"))) Then
                            If IsDate(Row.Item("comp_action_date").ToString) Then
                                htmlOut.Append(Constants.QUOTE + FormatDateTime(Row.Item("comp_action_date").ToString, DateFormat.ShortDate).Trim + Constants.QUOTE)
                            Else
                                htmlOut.Append(Constants.QUOTE + Constants.QUOTE)
                            End If
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE)
                        End If

                        htmlOut.Append(vbCrLf)

                    ElseIf bTextTabReport Then

                        If Not (IsDBNull(Row.Item("comp_name"))) Then
                            htmlOut.Append(Row.Item("comp_name").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        If Not IsDBNull(Row.Item("comp_alternate_name_type")) And Not IsDBNull(Row.Item("comp_alternate_name")) Then
                            If Not String.IsNullOrEmpty(Row.Item("comp_alternate_name_type").ToString.Trim) And Not String.IsNullOrEmpty(Row.Item("comp_alternate_name").ToString.Trim) Then
                                htmlOut.Append(Row.Item("comp_alternate_name_type").ToString.Trim + Constants.cSingleSpace + Row.Item("comp_alternate_name").ToString.Trim)
                            End If
                        Else
                            If Not IsDBNull(Row.Item("comp_alternate_name")) Then
                                If Not String.IsNullOrEmpty(Row.Item("comp_alternate_name").ToString.Trim) Then
                                    htmlOut.Append(Row.Item("comp_alternate_name").ToString.Trim)
                                End If
                            End If
                        End If

                        htmlOut.Append(vbTab)

                        If HttpContext.Current.Session.Item("searchCriteria").SearchCriteriaCompanyDisplayContactInfo Then

                            If Not (IsDBNull(Row.Item("contact_sirname"))) Then
                                htmlOut.Append(Row.Item("contact_sirname").ToString.Trim + Constants.cSingleSpace)
                            End If

                            If Not (IsDBNull(Row.Item("contact_first_name"))) Then
                                htmlOut.Append(Row.Item("contact_first_name").ToString.Trim)
                            End If

                            If Not (IsDBNull(Row.Item("contact_last_name"))) Then
                                htmlOut.Append(Constants.cSingleSpace + Row.Item("contact_last_name").ToString.Trim)
                            End If

                            htmlOut.Append(vbTab)

                            If Not (IsDBNull(Row.Item("contact_title"))) Then
                                htmlOut.Append(Row.Item("contact_title").ToString.Trim + vbTab)
                            Else
                                htmlOut.Append(vbTab)
                            End If

                            Dim sEmailAddress As String = localFunctions.get_contact_email_address_report(CLng(Row.Item("comp_id")), CLng(Row.Item("contact_id")))

                            If Not String.IsNullOrEmpty(sEmailAddress) Then
                                htmlOut.Append(sEmailAddress.Trim + vbTab)
                            Else
                                htmlOut.Append(vbTab)
                            End If

                        End If

                        If Not (IsDBNull(Row.Item("comp_address1"))) Then
                            htmlOut.Append(Row.Item("comp_address1").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        If Not (IsDBNull(Row.Item("comp_city"))) Then
                            htmlOut.Append(Row.Item("comp_city").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        If Not (IsDBNull(Row.Item("comp_state"))) Then
                            htmlOut.Append(Row.Item("comp_state").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        If Not (IsDBNull(Row.Item("comp_zip_code"))) Then
                            htmlOut.Append(Row.Item("comp_zip_code").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        If Not (IsDBNull(Row.Item("comp_country"))) Then
                            htmlOut.Append(Row.Item("comp_country").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        If Not (IsDBNull(Row.Item("comp_action_date"))) Then
                            If IsDate(Row.Item("comp_action_date").ToString) Then
                                htmlOut.Append(FormatDateTime(Row.Item("comp_action_date").ToString, DateFormat.ShortDate).Trim)
                            End If
                        End If

                        htmlOut.Append(vbCrLf)

                    End If

                Next

            End If

            If bHtmlReport Or bExcelReport Then
                htmlOut.Append("</table>")
            End If

            If bHtmlReport Then
                htmlOut.Append("</div>")
                htmlOut.Append("</body>")
                htmlOut.Append("</html>")
            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Create_Report_1_Export_Current_Company_List()" + ex.Message
        Finally

            report_1_datatable = Nothing

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOut.ToString

    End Function

#End Region

#Region "report_2_functions"

    Public Function create_report_2_export_current_aircraft_list(ByRef record_count As Long) As String

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim report_2_datatable As New DataTable

        Dim adoRS_2 As System.Data.SqlClient.SqlDataReader : adoRS_2 = Nothing

        Dim htmlOut = New StringBuilder()
        Dim sQuery As New StringBuilder()

        Try

            SqlConn.ConnectionString = localFunctions.clientConnectStr

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 90

            sQuery.Append("SELECT DISTINCT * ")
            sQuery.Append(HttpContext.Current.Session.Item("MasterAircraftFrom").ToString)
            sQuery.Append(HttpContext.Current.Session.Item("MasterAircraftWhere").ToString)
            sQuery.Append(" ORDER BY amod_make_name, amod_airframe_type_code, amod_type_code, amod_id, amod_model_name, ac_ser_no_sort")

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />Create_Report_2_Export_Current_Aircraft_List()<br />" + sQuery.ToString

            If bHtmlReport Then
                htmlOut.Append("<!DOCTYPE html>")
                htmlOut.Append("<html lang='en'>")
                htmlOut.Append("<head>")
                htmlOut.Append("<meta http-equiv='Content-Language' content='en-us' />")
                htmlOut.Append("<meta http-equiv='Content-Type' content='text/html; charset=windows-1252' />")
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='common/jetnet.css' />")
                htmlOut.Append("<title>JETNET - Export of Current Aircraft List</title>")
                htmlOut.Append("</head>")
                htmlOut.Append("<body style='background: white; margin-top:10px; margin-left:10px;'>")
                htmlOut.Append("<div style='text-align:center;'>")
            End If

            If bExcelReport Then
                htmlOut.Append(localFunctions.include_excel_report_style() + vbCrLf)
                htmlOut.Append("<table border='1' cellpadding='2' cellspacing='0'>")
            ElseIf bHtmlReport Then
                htmlOut.Append("<table class='centerTable' border='0' cellpadding='2' cellspacing='0' width='100%'>")
            End If

            SqlCommand.CommandText = sQuery.ToString
            adoRS_2 = SqlCommand.ExecuteReader()

            Try
                report_2_datatable.Load(adoRS_2)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = report_2_datatable.GetErrors()
            End Try

            record_count = report_2_datatable.Rows.Count

            adoRS_2.Close()
            adoRS_2 = Nothing

            If report_2_datatable.Rows.Count > 0 Then

                If chkShowReportHeader.Checked Then

                    If bExcelReport Or bHtmlReport Then

                        htmlOut.Append("<tr bgcolor='#CCCCCC'>")

                        htmlOut.Append("<td align='left'>MAKE</td>")
                        htmlOut.Append("<td align='left'>MODEL</td>")
                        htmlOut.Append("<td align='left'>YEAR&nbsp;MFG</td>")
                        htmlOut.Append("<td align='left'>YEAR&nbsp;DLV</td>")
                        htmlOut.Append("<td align='left'>SERIALNBR</td>")
                        htmlOut.Append("<td align='left'>REGNBR</td>")

                        If Not bAerodexFlag Then
                            htmlOut.Append("<td align='left'>STATUS</td>")
                            htmlOut.Append("<td align='left'>PRICE</td>")
                            htmlOut.Append("<td align='left'>DELIVERY</td>")
                            htmlOut.Append("<td align='left'>DATE&nbsp;LISTED</td>")
                        End If

                        htmlOut.Append("<td align='left'>COMPANY</td>")
                        htmlOut.Append("<td align='left'>LAST&nbsp;CHANGED</td>")

                        htmlOut.Append("<td align='left'>AFTT</td>")
                        htmlOut.Append("<td align='left'>ENG&nbsp;1&nbsp;TT</td>")
                        htmlOut.Append("<td align='left'>ENG&nbsp;2&nbsp;TT</td>")
                        htmlOut.Append("<td align='left'>ENG&nbsp;3&nbsp;TT</td>")
                        htmlOut.Append("<td align='left'>ENG&nbsp;4&nbsp;TT</td>")
                        htmlOut.Append("<td align='left'>SMOH&nbsp;1</td>")
                        htmlOut.Append("<td align='left'>SMOH&nbsp;2</td>")
                        htmlOut.Append("<td align='left'>SMOH&nbsp;3</td>")
                        htmlOut.Append("<td align='left'>SMOH&nbsp;4</td>")

                        htmlOut.Append("</tr>")

                    ElseIf bTextCommaReport Then

                        htmlOut.Append(Constants.QUOTE + "MAKE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "MODEL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "YEAR MFG" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "YEAR DLV" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SERIALNBR" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "REGNBR" + Constants.QUOTE + Constants.cCommaDelim)

                        If Not bAerodexFlag Then
                            htmlOut.Append(Constants.QUOTE + "STATUS" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "PRICE" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "DELIVERY" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "DATE LISTED" + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        htmlOut.Append(Constants.QUOTE + "COMPANY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "LAST CHANGED" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "AFTT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "ENG 1 TT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "ENG 2 TT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "ENG 3 TT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "ENG 4 TT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SMOH 1" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SMOH 2" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SMOH 3" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SMOH 4" + Constants.QUOTE)

                        htmlOut.Append(vbCrLf)

                    ElseIf bTextTabReport Then

                        htmlOut.Append("MAKE" + vbTab)
                        htmlOut.Append("MODEL" + vbTab)
                        htmlOut.Append("YEAR MFG" + vbTab)
                        htmlOut.Append("YEAR DLV" + vbTab)
                        htmlOut.Append("SERIALNBR" + vbTab)
                        htmlOut.Append("REGNBR" + vbTab)

                        If Not bAerodexFlag Then
                            htmlOut.Append("STATUS" + vbTab)
                            htmlOut.Append("PRICE" + vbTab)
                            htmlOut.Append("DELIVERY" + vbTab)
                            htmlOut.Append("DATE LISTED" + vbTab)
                        End If

                        htmlOut.Append("COMPANY" + vbTab)
                        htmlOut.Append("LAST CHANGED" + vbTab)

                        htmlOut.Append("AFTT" + vbTab)
                        htmlOut.Append("ENG 1 TT" + vbTab)
                        htmlOut.Append("ENG 2 TT" + vbTab)
                        htmlOut.Append("ENG 3 TT" + vbTab)
                        htmlOut.Append("ENG 4 TT" + vbTab)
                        htmlOut.Append("SMOH 1" + vbTab)
                        htmlOut.Append("SMOH 2" + vbTab)
                        htmlOut.Append("SMOH 3" + vbTab)
                        htmlOut.Append("SMOH 4")

                        htmlOut.Append(vbCrLf)

                    End If   ' 

                End If ' chkShowReportHeader.Checked Then

                For Each Row As DataRow In report_2_datatable.Rows

                    If bHtmlReport Or bExcelReport Then

                        htmlOut.Append("<tr>")

                        htmlOut.Append("<td align='left' valign='top'>" + Row.Item("amod_make_name").ToString.Trim + "</td>")
                        htmlOut.Append("<td align='left' valign='top' nowrap='nowrap'>" + Row.Item("amod_model_name").ToString.Trim + "</td>")

                        If Not IsDBNull(Row.Item("ac_mfr_year")) Then
                            htmlOut.Append("<td align='left' valign='top'>" + Row.Item("ac_mfr_year").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td align='left' valign='top'></td>")
                        End If

                        If Not IsDBNull(Row.Item("ac_year")) Then
                            htmlOut.Append("<td align='left' valign='top'>" + Row.Item("ac_year").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td align='left' valign='top'></td>")
                        End If

                        If Not IsDBNull(Row.Item("ac_ser_no_full")) Then
                            htmlOut.Append("<td align='left' valign='top' class='textformat'>" + Row.Item("ac_ser_no_full").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td align='left' valign='top'></td>")
                        End If

                        If Not IsDBNull(Row.Item("ac_reg_no")) Then
                            htmlOut.Append("<td align='left' valign='top' class='textformat'>" + Row.Item("ac_reg_no").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td align='left' valign='top'></td>")
                        End If

                        ' Aerodex users don't get this column at all
                        If Not bAerodexFlag Then

                            If Not IsDBNull(Row.Item("ac_forsale_flag")) Then

                                If Row.Item("ac_forsale_flag").ToString.Trim.ToUpper.Contains("Y") Then
                                    htmlOut.Append("<td align='left' valign='top' nowrap='nowrap'>" + Row.Item("ac_status").ToString.Trim + "</td>")

                                    If Not IsDBNull(Row.Item("ac_asking")) Then
                                        If Row.Item("ac_asking").ToString.Trim.ToLower.Contains("price") Then
                                            If Not IsDBNull(Row.Item("ac_asking_price")) Then
                                                htmlOut.Append("<td align='left' valign='top' nowrap='nowrap'>$" + FormatNumber(Row.Item("ac_asking_price").ToString, 0, False, False, True) + "</td>")
                                            Else
                                                htmlOut.Append("<td align='left' valign='top'></td>")
                                            End If
                                        Else
                                            htmlOut.Append("<td align='left' valign='top' nowrap='nowrap'>" + Row.Item("ac_asking").ToString.Trim + "</td>")
                                        End If
                                    Else
                                        htmlOut.Append("<td align='left' valign='top'></td>")
                                    End If

                                    If Not IsDBNull(Row.Item("ac_delivery")) Then
                                        If Row.Item("ac_delivery").ToString.Trim.ToLower.Contains("date") Then
                                            htmlOut.Append("<td align='left' valign='top'>" + FormatDateTime(Row.Item("ac_delivery_date").ToString.Trim, DateFormat.ShortDate) + "</td>")
                                        Else
                                            htmlOut.Append("<td align='left' valign='top'>" + Row.Item("ac_delivery").ToString.Trim + "</td>")
                                        End If
                                    Else
                                        htmlOut.Append("<td align='left' valign='top'></td>")
                                    End If

                                    If Not IsDBNull(Row.Item("ac_list_date")) Then
                                        htmlOut.Append("<td align='left' valign='top'>" + FormatDateTime(Row.Item("ac_list_date").ToString.Trim, DateFormat.ShortDate) + "</td>")
                                    Else
                                        htmlOut.Append("<td align='left' valign='top'></td>")
                                    End If
                                Else
                                    If Not IsDBNull(Row.Item("ac_status")) Then
                                        htmlOut.Append("<td align='left' valign='top' nowrap='nowrap'>" + Row.Item("ac_status").ToString.Trim + "</td>")
                                        htmlOut.Append("<td align='left' valign='top'></td>")
                                        htmlOut.Append("<td align='left' valign='top'></td>")
                                        htmlOut.Append("<td align='left' valign='top'></td>")
                                    Else
                                        htmlOut.Append("<td align='left' valign='top'></td>")
                                        htmlOut.Append("<td align='left' valign='top'></td>")
                                        htmlOut.Append("<td align='left' valign='top'></td>")
                                        htmlOut.Append("<td align='left' valign='top'></td>")
                                    End If
                                End If
                            Else
                                If Not IsDBNull(Row.Item("ac_status")) Then
                                    htmlOut.Append("<td align='left' valign='top' nowrap='nowrap'>" + Row.Item("ac_status").ToString.Trim + "</td>")
                                    htmlOut.Append("<td align='left' valign='top'></td>")
                                    htmlOut.Append("<td align='left' valign='top'></td>")
                                    htmlOut.Append("<td align='left' valign='top'></td>")
                                Else
                                    htmlOut.Append("<td align='left' valign='top'></td>")
                                    htmlOut.Append("<td align='left' valign='top'></td>")
                                    htmlOut.Append("<td align='left' valign='top'></td>")
                                    htmlOut.Append("<td align='left' valign='top'></td>")
                                End If
                            End If
                        End If

                        htmlOut.Append("<td align='left' valign='top' nowrap='nowrap'>")
                        htmlOut.Append(ReturnAircraftReferenceCompanyInformation_Report(CLng(Row.Item("ac_id").ToString), 0, False))
                        htmlOut.Append("</td><td align='left' valign='top'>")

                        If Not IsDBNull(Row.Item("ac_upd_date")) Then
                            If IsDate(Row.Item("ac_upd_date").ToString) Then
                                htmlOut.Append(FormatDateTime(Row.Item("ac_upd_date"), DateFormat.ShortDate).ToString.Trim)
                            End If
                        End If

                        htmlOut.Append("</td><td align='left' valign='top'>")

                        If Not IsDBNull(Row.Item("ac_airframe_tot_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_airframe_tot_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_airframe_tot_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append("</td><td align='left' valign='top'>")

                        If Not IsDBNull(Row.Item("ac_engine_1_tot_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_1_tot_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_1_tot_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append("</td><td align='left' valign='top'>")

                        If Not IsDBNull(Row.Item("ac_engine_2_tot_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_2_tot_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_2_tot_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append("</td><td align='left' valign='top'>")

                        If Not IsDBNull(Row.Item("ac_engine_3_tot_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_3_tot_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_3_tot_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append("</td><td align='left' valign='top'>")

                        If Not IsDBNull(Row.Item("ac_engine_4_tot_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_4_tot_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_4_tot_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append("</td><td align='left' valign='top'>")

                        If Not IsDBNull(Row.Item("ac_engine_1_soh_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_1_soh_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_1_soh_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append("</td><td align='left' valign='top'>")

                        If Not IsDBNull(Row.Item("ac_engine_2_soh_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_2_soh_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_2_soh_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append("</td><td align='left' valign='top'>")

                        If Not IsDBNull(Row.Item("ac_engine_3_soh_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_3_soh_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_3_soh_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append("</td><td align='left' valign='top'>")

                        If Not IsDBNull(Row.Item("ac_engine_4_soh_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_4_soh_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_4_soh_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append("</td></tr>")

                        htmlOut.Append(IIf(bHtmlReport, "<tr><td colspan='" + IIf(bAerodexFlag, "17", "21") + "'><hr height='1'></td></tr>", ""))

                    ElseIf bTextCommaReport Then

                        htmlOut.Append(Constants.QUOTE + Row.Item("amod_make_name").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + Row.Item("amod_model_name").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE)

                        If Not IsDBNull(Row.Item("ac_mfr_year")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_mfr_year").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_mfr_year").ToString)
                            End If
                        End If

                        htmlOut.Append(Constants.QUOTE + Constants.cCommaDelim + Constants.QUOTE)

                        If Not IsDBNull(Row.Item("ac_year")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_year").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_year").ToString)
                            End If
                        End If

                        htmlOut.Append(Constants.QUOTE + Constants.cCommaDelim + Constants.QUOTE)

                        If Not IsDBNull(Row.Item("ac_ser_no_full")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_ser_no_full").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_ser_no_full").ToString)
                            End If
                        End If

                        htmlOut.Append(Constants.QUOTE + Constants.cCommaDelim + Constants.QUOTE)

                        If Not IsDBNull(Row.Item("ac_reg_no")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_reg_no").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_reg_no").ToString)
                            End If
                        End If

                        htmlOut.Append(Constants.QUOTE + Constants.cCommaDelim + Constants.QUOTE)

                        ' Aerodex users don't get this column at all
                        If Not bAerodexFlag Then

                            If Not IsDBNull(Row.Item("ac_forsale_flag")) Then

                                If Row.Item("ac_forsale_flag").ToString.Trim.ToUpper.Contains("Y") Then
                                    htmlOut.Append(Constants.QUOTE + Row.Item("ac_status").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)

                                    If Not IsDBNull(Row.Item("ac_asking")) Then
                                        If Row.Item("ac_asking").ToString.Trim.ToLower.Contains("price") Then
                                            If Not IsDBNull(Row.Item("ac_asking_price")) Then
                                                htmlOut.Append(Constants.QUOTE + "$" + FormatNumber(Row.Item("ac_asking_price").ToString, 0, False, False, True) + Constants.QUOTE + Constants.cCommaDelim)
                                            Else
                                                htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                            End If
                                        Else
                                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_asking").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                                        End If
                                    Else
                                        htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                    End If


                                    If Not IsDBNull(Row.Item("ac_delivery")) Then
                                        If Row.Item("ac_delivery").ToString.Trim.ToLower.Contains("date") Then
                                            htmlOut.Append(Constants.QUOTE + FormatDateTime(Row.Item("ac_delivery_date").ToString.Trim, DateFormat.ShortDate) + Constants.QUOTE + Constants.cCommaDelim)
                                        Else
                                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_delivery").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                                        End If
                                    Else
                                        htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                    End If

                                    If Not IsDBNull(Row.Item("ac_list_date")) Then
                                        htmlOut.Append(Constants.QUOTE + FormatDateTime(Row.Item("ac_list_date").ToString.Trim, DateFormat.ShortDate) + Constants.QUOTE + Constants.cCommaDelim)
                                    Else
                                        htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                    End If
                                Else
                                    If Not IsDBNull(Row.Item("ac_status")) Then
                                        htmlOut.Append(Constants.QUOTE + Row.Item("ac_status").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                                        htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                        htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                        htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                    Else
                                        htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                        htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                        htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                        htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                    End If
                                End If
                            Else
                                If Not IsDBNull(Row.Item("ac_status")) Then
                                    htmlOut.Append(Constants.QUOTE + Row.Item("ac_status").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                Else
                                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                End If
                            End If
                        End If

                        htmlOut.Append(Constants.QUOTE)

                        htmlOut.Append(ReturnAircraftReferenceCompanyInformation_Report(CLng(Row.Item("ac_id").ToString), 0, False))

                        htmlOut.Append(Constants.QUOTE + Constants.cCommaDelim + Constants.QUOTE)

                        If Not IsDBNull(Row.Item("ac_upd_date")) Then
                            If IsDate(Row.Item("ac_upd_date").ToString) Then
                                htmlOut.Append(FormatDateTime(Row.Item("ac_upd_date"), DateFormat.ShortDate).ToString.Trim)
                            End If
                        End If

                        htmlOut.Append(Constants.QUOTE + Constants.cCommaDelim + Constants.QUOTE)

                        If Not IsDBNull(Row.Item("ac_airframe_tot_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_airframe_tot_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_airframe_tot_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append(Constants.QUOTE + Constants.cCommaDelim + Constants.QUOTE)

                        If Not IsDBNull(Row.Item("ac_engine_1_tot_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_1_tot_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_1_tot_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append(Constants.QUOTE + Constants.cCommaDelim + Constants.QUOTE)

                        If Not IsDBNull(Row.Item("ac_engine_2_tot_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_2_tot_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_2_tot_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append(Constants.QUOTE + Constants.cCommaDelim + Constants.QUOTE)

                        If Not IsDBNull(Row.Item("ac_engine_3_tot_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_3_tot_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_3_tot_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append(Constants.QUOTE + Constants.cCommaDelim + Constants.QUOTE)

                        If Not IsDBNull(Row.Item("ac_engine_4_tot_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_4_tot_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_4_tot_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append(Constants.QUOTE + Constants.cCommaDelim + Constants.QUOTE)

                        If Not IsDBNull(Row.Item("ac_engine_1_soh_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_1_soh_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_1_soh_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append(Constants.QUOTE + Constants.cCommaDelim + Constants.QUOTE)

                        If Not IsDBNull(Row.Item("ac_engine_2_soh_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_2_soh_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_2_soh_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append(Constants.QUOTE + Constants.cCommaDelim + Constants.QUOTE)

                        If Not IsDBNull(Row.Item("ac_engine_3_soh_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_3_soh_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_3_soh_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append(Constants.QUOTE + Constants.cCommaDelim + Constants.QUOTE)

                        If Not IsDBNull(Row.Item("ac_engine_4_soh_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_4_soh_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_4_soh_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append(Constants.QUOTE + vbCrLf)

                    ElseIf bTextTabReport Then

                        htmlOut.Append(Row.Item("amod_make_name").ToString.Trim + vbTab)
                        htmlOut.Append(Row.Item("amod_model_name").ToString.Trim + vbTab)

                        If Not IsDBNull(Row.Item("ac_mfr_year")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_mfr_year").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_mfr_year").ToString)
                            End If
                        End If

                        htmlOut.Append(vbTab)

                        If Not IsDBNull(Row.Item("ac_year")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_year").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_year").ToString)
                            End If
                        End If

                        htmlOut.Append(vbTab)

                        If Not IsDBNull(Row.Item("ac_ser_no_full")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_ser_no_full").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_ser_no_full").ToString)
                            End If
                        End If

                        htmlOut.Append(vbTab)

                        If Not IsDBNull(Row.Item("ac_reg_no")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_reg_no").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_reg_no").ToString)
                            End If
                        End If

                        htmlOut.Append(vbTab)

                        ' Aerodex users don't get this column at all
                        If Not bAerodexFlag Then

                            If Not IsDBNull(Row.Item("ac_forsale_flag")) Then

                                If Row.Item("ac_forsale_flag").ToString.Trim.ToUpper.Contains("Y") Then
                                    htmlOut.Append(Row.Item("ac_status").ToString.Trim + vbTab)

                                    If Not IsDBNull(Row.Item("ac_asking")) Then
                                        If Row.Item("ac_asking").ToString.Trim.ToLower.Contains("price") Then
                                            If Not IsDBNull(Row.Item("ac_asking_price")) Then
                                                htmlOut.Append("$" + FormatNumber(Row.Item("ac_asking_price").ToString, 0, False, False, True) + vbTab)
                                            Else
                                                htmlOut.Append(vbTab)
                                            End If
                                        Else
                                            htmlOut.Append(Row.Item("ac_asking").ToString.Trim + vbTab)
                                        End If
                                    Else
                                        htmlOut.Append(vbTab)
                                    End If

                                    If Not IsDBNull(Row.Item("ac_delivery")) Then
                                        If Row.Item("ac_delivery").ToString.Trim.ToLower.Contains("date") Then
                                            htmlOut.Append(FormatDateTime(Row.Item("ac_delivery_date").ToString.Trim, DateFormat.ShortDate) + vbTab)
                                        Else
                                            htmlOut.Append(Row.Item("ac_delivery").ToString.Trim + vbTab)
                                        End If
                                    Else
                                        htmlOut.Append(vbTab)
                                    End If

                                    If Not IsDBNull(Row.Item("ac_list_date")) Then
                                        htmlOut.Append(FormatDateTime(Row.Item("ac_list_date").ToString.Trim, DateFormat.ShortDate) + vbTab)
                                    Else
                                        htmlOut.Append(vbTab)
                                    End If
                                Else
                                    If Not IsDBNull(Row.Item("ac_status")) Then
                                        htmlOut.Append(Row.Item("ac_status").ToString.Trim + vbTab)
                                        htmlOut.Append(vbTab)
                                        htmlOut.Append(vbTab)
                                        htmlOut.Append(vbTab)
                                    Else
                                        htmlOut.Append(vbTab)
                                        htmlOut.Append(vbTab)
                                        htmlOut.Append(vbTab)
                                        htmlOut.Append(vbTab)
                                    End If
                                End If
                            Else
                                If Not IsDBNull(Row.Item("ac_status")) Then
                                    htmlOut.Append(Row.Item("ac_status").ToString.Trim + vbTab)
                                    htmlOut.Append(vbTab)
                                    htmlOut.Append(vbTab)
                                    htmlOut.Append(vbTab)
                                Else
                                    htmlOut.Append(vbTab)
                                    htmlOut.Append(vbTab)
                                    htmlOut.Append(vbTab)
                                    htmlOut.Append(vbTab)
                                End If
                            End If
                        End If

                        htmlOut.Append(ReturnAircraftReferenceCompanyInformation_Report(CLng(Row.Item("ac_id").ToString), 0, False))

                        htmlOut.Append(vbTab)

                        If Not IsDBNull(Row.Item("ac_upd_date")) Then
                            If IsDate(Row.Item("ac_upd_date").ToString) Then
                                htmlOut.Append(FormatDateTime(Row.Item("ac_upd_date"), DateFormat.ShortDate).ToString.Trim)
                            End If
                        End If

                        htmlOut.Append(vbTab)

                        If Not IsDBNull(Row.Item("ac_airframe_tot_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_airframe_tot_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_airframe_tot_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append(vbTab)

                        If Not IsDBNull(Row.Item("ac_engine_1_tot_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_1_tot_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_1_tot_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append(vbTab)

                        If Not IsDBNull(Row.Item("ac_engine_2_tot_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_2_tot_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_2_tot_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append(vbTab)

                        If Not IsDBNull(Row.Item("ac_engine_3_tot_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_3_tot_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_3_tot_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append(vbTab)

                        If Not IsDBNull(Row.Item("ac_engine_4_tot_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_4_tot_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_4_tot_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append(vbTab)

                        If Not IsDBNull(Row.Item("ac_engine_1_soh_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_1_soh_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_1_soh_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append(vbTab)

                        If Not IsDBNull(Row.Item("ac_engine_2_soh_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_2_soh_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_2_soh_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append(vbTab)

                        If Not IsDBNull(Row.Item("ac_engine_3_soh_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_3_soh_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_3_soh_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append(vbTab)

                        If Not IsDBNull(Row.Item("ac_engine_4_soh_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_4_soh_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_4_soh_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append(vbCrLf)

                    End If

                Next

            End If

            If bHtmlReport Or bExcelReport Then
                htmlOut.Append("</table>")
            End If

            If bHtmlReport Then
                htmlOut.Append("</div>")
                htmlOut.Append("</body>")
                htmlOut.Append("</html>")
            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Create_Report_2_Export_Current_Aircraft_List()" + ex.Message
        Finally

            report_2_datatable = Nothing

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOut.ToString

    End Function

#End Region

#Region "report_3_functions"

    Public Function create_report_3_export_current_history_list(ByRef record_count As Long) As String

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim report_3_datatable As New DataTable

        Dim adoRS_3 As System.Data.SqlClient.SqlDataReader : adoRS_3 = Nothing

        Dim htmlOut = New StringBuilder()
        Dim sQuery As New StringBuilder()

        Try

            SqlConn.ConnectionString = localFunctions.clientConnectStr

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 90

            If HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("comp_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("contact_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("state_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("country_") Then
                sQuery.Append("SELECT DISTINCT * FROM View_Aircraft_Company_History_Flat WITH(NOLOCK) ")
            Else
                sQuery.Append("SELECT DISTINCT * FROM View_Aircraft_History_Flat WITH(NOLOCK) ")
            End If

            sQuery.Append(HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.Trim)
            sQuery.Append("ORDER BY ac_ser_no_sort, journ_date DESC, journ_id DESC")

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />Create_Report_3_Export_Current_History_List()<br />" + sQuery.ToString

            If bHtmlReport Then
                htmlOut.Append("<!DOCTYPE html>")
                htmlOut.Append("<html lang='en'>")
                htmlOut.Append("<head>")
                htmlOut.Append("<meta http-equiv='Content-Language' content='en-us' />")
                htmlOut.Append("<meta http-equiv='Content-Type' content='text/html; charset=windows-1252' />")
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='common/jetnet.css' />")
                htmlOut.Append("<title>JETNET - Export of Current History List</title>")
                htmlOut.Append("</head>")
                htmlOut.Append("<body style='background: white; margin-top:10px; margin-left:10px;'>")
                htmlOut.Append("<div style='text-align:center;'>")
            End If

            If bExcelReport Then
                htmlOut.Append(localFunctions.include_excel_report_style() + vbCrLf)
                htmlOut.Append("<table border='1' cellpadding='2' cellspacing='0'>")
            ElseIf bHtmlReport Then
                htmlOut.Append("<table class='centerTable' border='0' cellpadding='2' cellspacing='0' width='100%'>")
            End If

            SqlCommand.CommandText = sQuery.ToString
            adoRS_3 = SqlCommand.ExecuteReader()

            Try
                report_3_datatable.Load(adoRS_3)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = report_3_datatable.GetErrors()
            End Try

            record_count = report_3_datatable.Rows.Count

            adoRS_3.Close()
            adoRS_3 = Nothing

            If report_3_datatable.Rows.Count > 0 Then

                If chkShowReportHeader.Checked Then

                    If bExcelReport Or bHtmlReport Then

                        htmlOut.Append("<tr bgcolor='#CCCCCC'>")

                        htmlOut.Append("<td>MAKE&nbsp;&nbsp;&nbsp;</td>")
                        htmlOut.Append("<td>MODEL&nbsp;&nbsp;</td>")
                        htmlOut.Append("<td>YEAR<br />MFG</td>")
                        htmlOut.Append("<td>YEAR<br />DLV</td>")
                        htmlOut.Append("<td>SERNBR</td>")
                        htmlOut.Append("<td>REGNO</td>")
                        htmlOut.Append("<td>DATE</td>")
                        htmlOut.Append("<td>DESCRIPTION</td>")
                        htmlOut.Append("<td>LIST&nbsp;DATE</td>")
                        htmlOut.Append("<td>%&nbsp;SOLD</td>")

                        htmlOut.Append("</tr>")

                    ElseIf bTextCommaReport Then

                        htmlOut.Append(Constants.QUOTE + "MAKE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "MODEL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "YEARMFG" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "YEARDLV" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SERNBR" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "REGNO" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "DATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "DESCRIPTION" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "LISTDATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "%SOLD" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(vbCrLf)

                    ElseIf bTextTabReport Then

                        htmlOut.Append("MAKE" + vbTab)
                        htmlOut.Append("MODEL" + vbTab)
                        htmlOut.Append("YEARMFG" + vbTab)
                        htmlOut.Append("YEARDLV" + vbTab)
                        htmlOut.Append("SERNBR" + vbTab)
                        htmlOut.Append("REGNO" + vbTab)
                        htmlOut.Append("DATE" + vbTab)
                        htmlOut.Append("DESCRIPTION" + vbTab)
                        htmlOut.Append("LISTDATE" + vbTab)
                        htmlOut.Append("%SOLD" + vbTab)

                        htmlOut.Append(vbCrLf)

                    End If   ' 

                End If ' chkShowReportHeader.Checked Then

                For Each Row As DataRow In report_3_datatable.Rows

                    If bHtmlReport Or bExcelReport Then

                        htmlOut.Append("<tr>")

                        htmlOut.Append("<td valign='middle' align='left'>" + Row.Item("amod_make_name").ToString.Trim + "</td>")
                        htmlOut.Append("<td valign='middle' align='left'>" + Row.Item("amod_model_name").ToString.Trim + "</td>")

                        If Not (IsDBNull(Row.Item("ac_mfr_year"))) Then
                            htmlOut.Append("<td valign='middle' align='left'>" + Row.Item("ac_mfr_year").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td valign='middle' align='left'></td>")
                        End If

                        If Not (IsDBNull(Row.Item("ac_year"))) Then
                            htmlOut.Append("<td valign='middle' align='left'>" + Row.Item("ac_year").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td valign='middle' align='left'></td>")
                        End If

                        If Not (IsDBNull(Row.Item("ac_ser_no_full"))) Then
                            htmlOut.Append("<td valign='middle' align='left' class='textformat'>" + Row.Item("ac_ser_no_full").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td valign='middle' align='left'></td>")
                        End If

                        If Not (IsDBNull(Row.Item("ac_reg_no"))) Then
                            htmlOut.Append("<td valign='middle' align='left' class='textformat'>" + Row.Item("ac_reg_no").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td valign='middle' align='left'></td>")
                        End If

                        If Not (IsDBNull(Row.Item("journ_date"))) Then
                            htmlOut.Append("<td valign='middle' align='left'>" + FormatDateTime(Row.Item("journ_date").ToString, DateFormat.ShortDate).Trim + "</td>")
                        Else
                            htmlOut.Append("<td valign='middle' align='left'></td>")
                        End If

                        If Row.Item("jcat_auto_subject_flag").ToString.ToUpper.Contains("Y") Then
                            htmlOut.Append("<td valign='middle' align='left'>" + Row.Item("jcat_subcategory_name").ToString.Trim + "&nbsp;-&nbsp;" + Row.Item("journ_subject").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td valign='middle' align='left'>" + Row.Item("journ_subject").ToString.Trim + "</td>")
                        End If

                        If Not (IsDBNull(Row.Item("ac_list_date"))) Then
                            htmlOut.Append("<td valign='middle' align='left'>" + FormatDateTime(Row.Item("ac_list_date").ToString, DateFormat.ShortDate).Trim + "</td>")
                        Else
                            htmlOut.Append("<td valign='middle' align='left'></td>")
                        End If

                        Dim sFractionPercent As String = ""
                        Dim sFractionExpiresDate As String = ""

                        localFunctions.get_fraction_percent_and_expire_date(CLng(Row.Item("journ_id").ToString), True, sFractionPercent, sFractionExpiresDate)

                        htmlOut.Append("<td valign='middle' align='left'>" + sFractionPercent.Trim + "</td>")

                        htmlOut.Append("</tr>")

                    ElseIf bTextCommaReport Then

                        htmlOut.Append(Constants.QUOTE + Row.Item("amod_make_name").ToString.Trim + Constants.QUOTE & Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + Row.Item("amod_model_name").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)

                        If Not (IsDBNull(Row.Item("ac_mfr_year"))) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_mfr_year").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        If Not (IsDBNull(Row.Item("ac_year"))) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_year").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        If Not (IsDBNull(Row.Item("ac_ser_no_full"))) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_ser_no_full").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        If Not (IsDBNull(Row.Item("ac_reg_no"))) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_reg_no").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        If Not (IsDBNull(Row.Item("journ_date"))) Then
                            htmlOut.Append(Constants.QUOTE + FormatDateTime(Row.Item("journ_date").ToString, DateFormat.ShortDate).Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        If Row.Item("jcat_auto_subject_flag").ToString.ToUpper.Contains("Y") Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("jcat_subcategory_name").ToString.Trim + "&nbsp;-&nbsp;" + Row.Item("journ_subject").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Row.Item("journ_subject").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        If Not (IsDBNull(Row.Item("ac_list_date"))) Then
                            htmlOut.Append(Constants.QUOTE + FormatDateTime(Row.Item("ac_list_date").ToString, DateFormat.ShortDate).Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        Dim sFractionPercent As String = ""
                        Dim sFractionExpiresDate As String = ""

                        localFunctions.get_fraction_percent_and_expire_date(CLng(Row.Item("journ_id").ToString), True, sFractionPercent, sFractionExpiresDate)

                        htmlOut.Append(Constants.QUOTE + sFractionPercent + Constants.QUOTE)

                        htmlOut.Append(vbCrLf)

                    ElseIf bTextTabReport Then
                        htmlOut.Append(Row.Item("amod_make_name").ToString.Trim + vbTab)
                        htmlOut.Append(Row.Item("amod_model_name").ToString.Trim + vbTab)

                        If Not (IsDBNull(Row.Item("ac_mfr_year"))) Then
                            htmlOut.Append(Row.Item("ac_mfr_year").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        If Not (IsDBNull(Row.Item("ac_year"))) Then
                            htmlOut.Append(Row.Item("ac_year").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        If Not (IsDBNull(Row.Item("ac_ser_no_full"))) Then
                            htmlOut.Append(Row.Item("ac_ser_no_full").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        If Not (IsDBNull(Row.Item("ac_reg_no"))) Then
                            htmlOut.Append(Row.Item("ac_reg_no").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        If Not (IsDBNull(Row.Item("journ_date"))) Then
                            htmlOut.Append(FormatDateTime(Row.Item("journ_date").ToString, DateFormat.ShortDate).Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        If Row.Item("jcat_auto_subject_flag").ToString.ToUpper.Contains("Y") Then
                            htmlOut.Append(Row.Item("jcat_subcategory_name").ToString.Trim + "&nbsp;-&nbsp;" + Row.Item("journ_subject").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(Row.Item("journ_subject").ToString.Trim + vbTab)
                        End If

                        If Not (IsDBNull(Row.Item("ac_list_date"))) Then
                            htmlOut.Append(FormatDateTime(Row.Item("ac_list_date").ToString, DateFormat.ShortDate).Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        Dim sFractionPercent As String = ""
                        Dim sFractionExpiresDate As String = ""

                        localFunctions.get_fraction_percent_and_expire_date(CLng(Row.Item("journ_id").ToString), True, sFractionPercent, sFractionExpiresDate)

                        htmlOut.Append(sFractionPercent)

                        htmlOut.Append(vbCrLf)

                    End If

                Next

            End If

            If bHtmlReport Or bExcelReport Then
                htmlOut.Append("</table>")
            End If

            If bHtmlReport Then
                htmlOut.Append("</div>")
                htmlOut.Append("</body>")
                htmlOut.Append("</html>")
            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Create_Report_3_Export_Current_History_List()" + ex.Message
        Finally

            report_3_datatable = Nothing

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOut.ToString

    End Function

#End Region

#Region "report_4_functions"

    Public Function create_report_4_export_current_performance_list(ByRef record_count As Long) As String
        Dim atemptable As New DataTable
        Dim sQuery = New StringBuilder()

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing

        Dim amod_list As String = ""

        Dim nModelCount As Long = 0
        Dim excelOutputLimit As Long = 256

        Dim htmlModelPerformance As String = ""
        Dim htmlOut As New StringBuilder

        Dim performanceSearchCriteria As New viewSelectionCriteriaClass
        Dim tmpViewObj As New viewsDataLayer

        tmpViewObj.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
        tmpViewObj.clientConnectStr = localFunctions.clientConnectStr

        Dim bMultiAirframe As Boolean = False

        Try

            If Not IsNothing(Session.Item("searchCriteria").SearchCriteriaDisplayUnits) Then

                If Not String.IsNullOrEmpty(Session.Item("searchCriteria").SearchCriteriaDisplayUnits.ToString.Trim) Then

                    If Session.Item("searchCriteria").SearchCriteriaDisplayUnits.tolower.contains("m") Then
                        HttpContext.Current.Session.Item("localPreferences").UseMetricValues = True
                    Else
                        HttpContext.Current.Session.Item("localPreferences").UseMetricValues = False
                    End If
                Else
                    HttpContext.Current.Session.Item("localPreferences").UseMetricValues = False
                End If

            End If

            If Not IsNothing(Session.Item("searchCriteria").SearchCriteriaDisplayMiles) Then

                If Not String.IsNullOrEmpty(Session.Item("searchCriteria").SearchCriteriaDisplayMiles.ToString.Trim) Then

                    If Session.Item("searchCriteria").SearchCriteriaDisplayMiles.tolower.contains("s") Then
                        HttpContext.Current.Session.Item("localPreferences").UseStatuteMile = True
                    Else
                        HttpContext.Current.Session.Item("localPreferences").UseStatuteMile = False
                    End If
                Else
                    HttpContext.Current.Session.Item("localPreferences").UseStatuteMile = False
                End If

            End If

            sQuery.Append("SELECT * FROM Aircraft_Model WITH(NOLOCK) INNER JOIN Aircraft_Type WITH(NOLOCK) ON amod_type_code = atype_code ")
            sQuery.Append(HttpContext.Current.Session.Item("MasterAircraftPerformanceSpecsWhere").ToString)

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />Create_Report_4_Export_Current_Performance_List() As String<br />" + sQuery.ToString

            SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString
            SqlConn.Open()
            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString
            SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

            Try

                atemptable.Load(SqlReader)

                record_count = atemptable.Rows.Count

                If Not IsNothing(atemptable) Then

                    If atemptable.Rows.Count > 1 Then

                        For Each r As DataRow In atemptable.Rows

                            ' can only output 256 ac if its an excel report
                            If nModelCount < excelOutputLimit Then

                                If String.IsNullOrEmpty(amod_list.Trim) Then
                                    amod_list = r.Item("amod_id").ToString
                                Else
                                    amod_list += Constants.cCommaDelim + r.Item("amod_id").ToString
                                End If

                                nModelCount += 1

                            End If

                        Next

                        bMultiAirframe = commonEvo.check_for_multi_airframes(atemptable)

                        If Not bMultiAirframe Then
                            performanceSearchCriteria.ViewCriteriaAirframeTypeStr = atemptable.Rows(0).Item("amod_airframe_type_code").ToString.ToUpper.Trim
                        End If

                        performanceSearchCriteria.ViewCriteriaAmodID = -1 ' clear any single model id
                        performanceSearchCriteria.ViewCriteriaAmodIDArray = Split(amod_list, Constants.cCommaDelim)

                    Else

                        If atemptable.Rows.Count = 1 Then

                            performanceSearchCriteria.ViewCriteriaAirframeTypeStr = atemptable.Rows(0).Item("amod_airframe_type_code").ToString.ToUpper.Trim
                            performanceSearchCriteria.ViewCriteriaAmodID = CLng(atemptable.Rows(0).Item("amod_id").ToString)
                            performanceSearchCriteria.ViewCriteriaAmodIDArray = Nothing ' clear any model list

                        End If

                    End If

                    If HttpContext.Current.Session.Item("localPreferences").UseMetricValues Then
                        performanceSearchCriteria.ViewCriteriaUseMetricValues = True
                    Else
                        performanceSearchCriteria.ViewCriteriaUseMetricValues = False
                    End If

                    If bHtmlReport Then
                        htmlOut.Append("<!DOCTYPE html>")
                        htmlOut.Append("<html lang='en'>")
                        htmlOut.Append("<head>")
                        htmlOut.Append("<meta http-equiv='Content-Language' content='en-us' />")
                        htmlOut.Append("<meta http-equiv='Content-Type' content='text/html; charset=windows-1252' />")
                        htmlOut.Append("<link rel='stylesheet' type='text/css' href='common/jetnet.css' />")
                        htmlOut.Append("<title>JETNET - Export of Current Performance Specs List</title>")
                        htmlOut.Append("</head>")
                        htmlOut.Append("<body style='background: white; margin-top:10px; margin-left:10px;'>")
                        htmlOut.Append("<div style='text-align:center;'>")
                    End If

                    If bExcelReport Then
                        htmlOut.Append("<table border='1' cellpadding='2' cellspacing='0'>")
                    ElseIf bHtmlReport Then
                        htmlOut.Append("<table class='centerTable' border='0' cellpadding='2' cellspacing='0'>")
                    End If

                    htmlOut.Append("<tr bgcolor='#CCCCCC'><td valign='middle' align='center' colspan='" + (atemptable.Rows.Count + 1).ToString + "' style='border: 2px solid; border-color: rgb(48, 48, 48);'><strong>" + FormatDateTime(Now(), DateFormat.LongDate).ToString + "&nbsp;&nbsp;&nbsp;&nbsp;")
                    htmlOut.Append("Export of Current Performance Specs List</strong></td></tr>")

                    htmlOut.Append("<tr>")

                    If bExcelReport Then
                        tmpViewObj.views_display_performance_specs(True, "Excel", True, bMultiAirframe, performanceSearchCriteria, htmlModelPerformance)
                        htmlOut.Append(htmlModelPerformance)

                        tmpViewObj.views_display_performance_specs(True, "Excel", False, bMultiAirframe, performanceSearchCriteria, htmlModelPerformance)
                        htmlOut.Append(htmlModelPerformance)
                    Else
                        tmpViewObj.views_display_performance_specs(True, "Html", True, bMultiAirframe, performanceSearchCriteria, htmlModelPerformance)
                        htmlOut.Append(htmlModelPerformance)

                        tmpViewObj.views_display_performance_specs(True, "Html", False, bMultiAirframe, performanceSearchCriteria, htmlModelPerformance)
                        htmlOut.Append(htmlModelPerformance)
                    End If

                    htmlOut.Append("</tr>")

                    If bHtmlReport Or bExcelReport Then
                        htmlOut.Append("</table>")
                    End If

                    If bHtmlReport Then
                        htmlOut.Append("</div>")
                        htmlOut.Append("</body>")
                        htmlOut.Append("</html>")
                    End If

                End If

            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
                HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Create_Report_4_Export_Current_Performance_List() load datatable" + constrExc.Message
            End Try


        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "error in Create_Report_4_Export_Current_Performance_List() As String : " + ex.Message
        End Try

        tmpViewObj = Nothing
        performanceSearchCriteria = Nothing

        Return htmlOut.ToString()

    End Function

#End Region

#Region "report_5_functions"

    Public Sub create_report_5_export_current_operating_costs_list(ByRef record_count As Long)

        Dim atemptable As New DataTable
        Dim sQuery = New StringBuilder()

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing

        Dim amod_list As String = ""

        Dim nModelCount As Long = 0
        Dim excelOutputLimit As Long = 256

        Try

            If Not IsNothing(Session.Item("searchCriteria").SearchCriteriaDisplayUnits) Then

                If Not String.IsNullOrEmpty(Session.Item("searchCriteria").SearchCriteriaDisplayUnits.ToString.Trim) Then

                    If Session.Item("searchCriteria").SearchCriteriaDisplayUnits.tolower.contains("m") Then
                        HttpContext.Current.Session.Item("localPreferences").UseMetricValues = True
                    Else
                        HttpContext.Current.Session.Item("localPreferences").UseMetricValues = False
                    End If
                Else
                    HttpContext.Current.Session.Item("localPreferences").UseMetricValues = False
                End If

            End If

            If Not IsNothing(Session.Item("searchCriteria").SearchCriteriaDisplayMiles) Then

                If Not String.IsNullOrEmpty(Session.Item("searchCriteria").SearchCriteriaDisplayMiles.ToString.Trim) Then

                    If Session.Item("searchCriteria").SearchCriteriaDisplayMiles.tolower.contains("s") Then
                        HttpContext.Current.Session.Item("localPreferences").UseStatuteMile = True
                    Else
                        HttpContext.Current.Session.Item("localPreferences").UseStatuteMile = False
                    End If
                Else
                    HttpContext.Current.Session.Item("localPreferences").UseStatuteMile = False
                End If

            End If

            If Not IsNothing(Session.Item("searchCriteria").SearchCriteriaOpCostsCurrency) Then

                If Not String.IsNullOrEmpty(Session.Item("searchCriteria").SearchCriteriaOpCostsCurrency.ToString.Trim) Then

                    If CLng(Session.Item("searchCriteria").SearchCriteriaOpCostsCurrency.ToString) > 0 Then
                        HttpContext.Current.Session.Item("localPreferences").DefaultCurrency = CLng(Session.Item("searchCriteria").SearchCriteriaOpCostsCurrency.ToString)
                    Else
                        HttpContext.Current.Session.Item("localPreferences").DefaultCurrency = 9 ' 9 = us dollar
                    End If
                Else
                    HttpContext.Current.Session.Item("localPreferences").DefaultCurrency = 9 ' 9 = us dollar
                End If

            End If

            sQuery.Append("SELECT * FROM Aircraft_Model WITH(NOLOCK) INNER JOIN Aircraft_Type WITH(NOLOCK) ON amod_type_code = atype_code ")
            sQuery.Append(HttpContext.Current.Session.Item("MasterAircraftOperatingCostWhere").ToString)

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />Create_Report_5_Export_Current_Operating_Costs_List()<br />" + sQuery.ToString

            SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString
            SqlConn.Open()
            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString
            SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

            Try

                atemptable.Load(SqlReader)

                record_count = atemptable.Rows.Count

                If Not IsNothing(atemptable) Then

                    If atemptable.Rows.Count > 1 Then

                        For Each r As DataRow In atemptable.Rows

                            ' can only output 256 ac if its an excel report
                            If nModelCount < excelOutputLimit Then

                                If String.IsNullOrEmpty(amod_list.Trim) Then
                                    amod_list = r.Item("amod_id").ToString
                                Else
                                    amod_list += Constants.cCommaDelim + r.Item("amod_id").ToString
                                End If

                                nModelCount += 1

                            End If

                        Next

                        HttpContext.Current.Session.Item("OpCostsModelID") = -1 ' clear any single model id
                        HttpContext.Current.Session.Item("OpCostsModelList") = amod_list

                    Else

                        If atemptable.Rows.Count = 1 Then

                            HttpContext.Current.Session.Item("OpCostsModelID") = CLng(atemptable.Rows(0).Item("amod_id").ToString)
                            HttpContext.Current.Session.Item("OpCostsModelList") = "" ' clear any model list

                        End If

                    End If

                    Dim opCostsReport As New generateOpCostsReport

                    If Not opCostsReport.generate_excel_output() Then
                        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Create_Report_5_Export_Current_Operating_Costs_List()" + opCostsReport.class_error
                    End If

                    opCostsReport = Nothing

                End If

            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
                HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Create_Report_5_Export_Current_Operating_Costs_List() load datatable" + constrExc.Message
            End Try

        Catch ex As Exception

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Create_Report_5_Export_Current_Operating_Costs_List()" + ex.Message

        Finally
            SqlReader = Nothing

            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing
        End Try

    End Sub

#End Region

#Region "report_6_functions"

    Public Function create_report_6_export_current_wanteds_list(ByRef record_count As Long) As String

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim report_6_datatable As New DataTable

        Dim adoRS_6 As System.Data.SqlClient.SqlDataReader : adoRS_6 = Nothing

        Dim htmlOut = New StringBuilder()
        Dim sQuery As New StringBuilder()

        Try

            SqlConn.ConnectionString = localFunctions.clientConnectStr

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 90

            sQuery.Append(HttpContext.Current.Session.Item("MasterWanted").ToString.Replace("amwant_max_aftt,", "amwant_max_aftt, amwant_amount_note, amwant_accept_damage_hist,"))

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />create_report_6_export_current_wanteds_list()<br />" + sQuery.ToString

            If bHtmlReport Then
                htmlOut.Append("<!DOCTYPE html>")
                htmlOut.Append("<html lang='en'>")
                htmlOut.Append("<head>")
                htmlOut.Append("<meta http-equiv='Content-Language' content='en-us' />")
                htmlOut.Append("<meta http-equiv='Content-Type' content='text/html; charset=windows-1252' />")
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='common/jetnet.css' />")
                htmlOut.Append("<title>JETNET - Export of Current Wanteds List</title>")
                htmlOut.Append("</head>")
                htmlOut.Append("<body style='background: white; margin-top:10px; margin-left:10px;'>")
                htmlOut.Append("<div style='text-align:center;'>")
            End If

            If bExcelReport Then
                htmlOut.Append("<table border='1' cellpadding='2' cellspacing='0'>")
            ElseIf bHtmlReport Then
                htmlOut.Append("<table class='centerTable' border='0' cellpadding='2' cellspacing='0' width='100%'>")
            End If

            SqlCommand.CommandText = sQuery.ToString
            adoRS_6 = SqlCommand.ExecuteReader()

            Try
                report_6_datatable.Load(adoRS_6)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = report_6_datatable.GetErrors()
            End Try

            record_count = report_6_datatable.Rows.Count

            adoRS_6.Close()
            adoRS_6 = Nothing

            If report_6_datatable.Rows.Count > 0 Then

                If chkShowReportHeader.Checked Then

                    If bExcelReport Or bHtmlReport Then

                        htmlOut.Append("<tr bgcolor='#CCCCCC'>")

                        htmlOut.Append("<td>MAKE&nbsp;&nbsp;&nbsp;</td>")
                        htmlOut.Append("<td>MODEL&nbsp;&nbsp;</td>")
                        htmlOut.Append("<td>DATE&nbsp;LISTED</td>")
                        htmlOut.Append("<td>INTERESTED<br />PARTY</td>")
                        htmlOut.Append("<td>YEAR&nbsp;RANGE</td>")
                        htmlOut.Append("<td>MAX&nbsp;PRICE</td>")
                        htmlOut.Append("<td>MAX&nbsp;AFTT</td>")
                        htmlOut.Append("<td>DAMAGE</td>")
                        htmlOut.Append("<td>NOTES</td>")

                        htmlOut.Append("</tr>")

                    ElseIf bTextCommaReport Then

                        htmlOut.Append(Constants.QUOTE + "MAKE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "MODEL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "DATELISTED" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "INTERESTEDPARTY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "YEARRANGE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "MAXPRICE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "MAXAFTT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "DAMAGE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "NOTES" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(vbCrLf)

                    ElseIf bTextTabReport Then

                        htmlOut.Append("MAKE" + vbTab)
                        htmlOut.Append("MODEL" + vbTab)
                        htmlOut.Append("DATELISTED" + vbTab)
                        htmlOut.Append("INTERESTEDPARTY" + vbTab)
                        htmlOut.Append("YEARRANGE" + vbTab)
                        htmlOut.Append("MAXPRICE" + vbTab)
                        htmlOut.Append("MAXAFTT" + vbTab)
                        htmlOut.Append("DAMAGE" + vbTab)
                        htmlOut.Append("NOTES" + vbTab)

                        htmlOut.Append(vbCrLf)

                    End If   ' 

                End If ' chkShowReportHeader.Checked Then

                For Each Row As DataRow In report_6_datatable.Rows

                    If bHtmlReport Or bExcelReport Then

                        htmlOut.Append("<tr>")

                        htmlOut.Append("<td valign='middle' align='left'>" + Row.Item("amod_make_name").ToString.Trim + "</td>")
                        htmlOut.Append("<td valign='middle' align='left'>" + Row.Item("amod_model_name").ToString.Trim + "</td>")

                        If Not (IsDBNull(Row.Item("amwant_listed_date"))) Then
                            If Not String.IsNullOrEmpty(Row.Item("amwant_listed_date").ToString.Trim) Then
                                htmlOut.Append("<td valign='middle' align='left'>" + FormatDateTime(Row.Item("amwant_listed_date").ToString, DateFormat.ShortDate) + "</td>")
                            Else
                                htmlOut.Append("<td valign='middle' align='left'></td>")
                            End If
                        Else
                            htmlOut.Append("<td valign='middle' align='left'></td>")
                        End If

                        If Not (IsDBNull(Row.Item("comp_name"))) Then
                            If Not String.IsNullOrEmpty(Row.Item("comp_name").ToString.Trim) Then
                                htmlOut.Append("<td valign='middle' align='left'>" + Row.Item("comp_name").ToString.Trim + "</td>")
                            Else
                                htmlOut.Append("<td valign='middle' align='left'></td>")
                            End If
                        Else
                            htmlOut.Append("<td valign='middle' align='left'></td>")
                        End If

                        Dim sTmpYearRange As String = ""

                        If Not (IsDBNull(Row.Item("amwant_start_year"))) Then
                            If Not String.IsNullOrEmpty(Row.Item("amwant_start_year").ToString.Trim) Then
                                sTmpYearRange = Row.Item("amwant_start_year").ToString.Trim
                            End If
                        End If

                        If Not (IsDBNull(Row.Item("amwant_end_year"))) Then
                            If Not String.IsNullOrEmpty(Row.Item("amwant_end_year").ToString.Trim) Then

                                If Not String.IsNullOrEmpty(sTmpYearRange.Trim) Then
                                    sTmpYearRange += " - " + Row.Item("amwant_end_year").ToString.Trim
                                Else
                                    sTmpYearRange = Row.Item("amwant_end_year").ToString.Trim
                                End If

                            End If
                        End If

                        htmlOut.Append("<td valign='middle' align='left'>" + sTmpYearRange.Trim + "</td>")

                        If Not IsDBNull(Row.Item("amwant_amount_note")) Then

                            If ((Not String.IsNullOrEmpty(Row.Item("amwant_amount_note").ToString.Trim)) And (Not Row.Item("amwant_amount_note").ToString.ToUpper.Contains("PRICE"))) Then
                                htmlOut.Append("<td valign='middle' align='left'>" + Row.Item("amwant_amount_note").ToString.Trim + "</td>")
                            Else

                                If Not IsDBNull(Row.Item("amwant_max_price")) Then
                                    If Not String.IsNullOrEmpty(Row.Item("amwant_max_price").ToString.Trim) Then

                                        If IsNumeric(Row.Item("amwant_max_price")) And Row.Item("amwant_max_price") > 0 Then
                                            htmlOut.Append("<td valign='middle' align='right'>$" + FormatNumber(Row.Item("amwant_max_price").ToString, 0, TriState.False, TriState.False, TriState.True) + "</td>")
                                        Else
                                            htmlOut.Append("<td valign='middle' align='right'></td>")
                                        End If

                                    Else
                                        htmlOut.Append("<td valign='middle' align='right'></td>")
                                    End If

                                Else
                                    htmlOut.Append("<td valign='middle' align='right'></td>")
                                End If

                            End If

                        Else

                            If Not IsDBNull(Row.Item("amwant_max_price")) Then
                                If Not String.IsNullOrEmpty(Row.Item("amwant_max_price").ToString.Trim) Then

                                    If IsNumeric(Row.Item("amwant_max_price")) And Row.Item("amwant_max_price") > 0 Then
                                        htmlOut.Append("<td valign='middle' align='right'>$" + FormatNumber(Row.Item("amwant_max_price").ToString, 0, TriState.False, TriState.False, TriState.True) + "</td>")
                                    Else
                                        htmlOut.Append("<td valign='middle' align='right'></td>")
                                    End If

                                Else
                                    htmlOut.Append("<td valign='middle' align='right'></td>")
                                End If

                            Else
                                htmlOut.Append("<td valign='middle' align='right'></td>")
                            End If

                        End If

                        If Not (IsDBNull(Row.Item("amwant_max_aftt"))) Then
                            If Not String.IsNullOrEmpty(Row.Item("amwant_max_aftt").ToString.Trim) Then
                                If IsNumeric(Row.Item("amwant_max_aftt").ToString) And CLng(Row.Item("amwant_max_aftt").ToString) > 0 Then
                                    htmlOut.Append("<td valign='middle' align='right'>" + FormatNumber(Row.Item("amwant_max_aftt").ToString, 0, TriState.False, TriState.False, TriState.True) + "</td>")
                                Else
                                    htmlOut.Append("<td valign='middle' align='right'></td>")
                                End If
                            Else
                                htmlOut.Append("<td valign='middle' align='right'></td>")
                            End If
                        Else
                            htmlOut.Append("<td valign='middle' align='right'></td>")
                        End If

                        If Not (IsDBNull(Row.Item("amwant_accept_damage_hist"))) Then
                            If Not String.IsNullOrEmpty(Row.Item("amwant_accept_damage_hist").ToString.Trim) Then

                                If Row.Item("amwant_accept_damage_hist").ToString.ToUpper.Contains("Y") Then
                                    htmlOut.Append("<td valign='middle' align='left'>Yes</td>")
                                ElseIf Row.Item("amwant_accept_damage_hist").ToString.ToUpper.Contains("N") Then
                                    htmlOut.Append("<td valign='middle' align='left'>No</td>")
                                ElseIf Row.Item("amwant_accept_damage_hist").ToString.ToUpper.Contains("U") Then
                                    htmlOut.Append("<td valign='middle' align='left'></td>")
                                End If

                            Else
                                htmlOut.Append("<td valign='middle' align='left'></td>")
                            End If
                        Else
                            htmlOut.Append("<td valign='middle' align='left'></td>")
                        End If

                        If Not (IsDBNull(Row.Item("amwant_notes"))) Then
                            If Not String.IsNullOrEmpty(Row.Item("amwant_notes").ToString.Trim) Then
                                htmlOut.Append("<td valign='middle' align='left'>" + Row.Item("amwant_notes").ToString.Trim + "</td>")
                            Else
                                htmlOut.Append("<td valign='middle' align='left'></td>")
                            End If
                        Else
                            htmlOut.Append("<td valign='middle' align='left'></td>")
                        End If

                        htmlOut.Append("</tr>")

                    ElseIf bTextCommaReport Then

                        htmlOut.Append(Constants.QUOTE + Row.Item("amod_make_name").ToString.Trim + Constants.QUOTE & Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + Row.Item("amod_model_name").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)

                        If Not (IsDBNull(Row.Item("amwant_listed_date"))) Then
                            If Not String.IsNullOrEmpty(Row.Item("amwant_listed_date").ToString.Trim) Then
                                htmlOut.Append(Constants.QUOTE + FormatDateTime(Row.Item("amwant_listed_date").ToString, DateFormat.ShortDate) + Constants.QUOTE + Constants.cCommaDelim)
                            Else
                                htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                            End If
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        If Not (IsDBNull(Row.Item("comp_name"))) Then
                            If Not String.IsNullOrEmpty(Row.Item("comp_name").ToString.Trim) Then
                                htmlOut.Append(Constants.QUOTE + Row.Item("comp_name").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                            Else
                                htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                            End If
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        Dim sTmpYearRange As String = ""

                        If Not (IsDBNull(Row.Item("amwant_start_year"))) Then
                            If Not String.IsNullOrEmpty(Row.Item("amwant_start_year").ToString.Trim) Then
                                sTmpYearRange = Row.Item("amwant_start_year").ToString.Trim
                            End If
                        End If

                        If Not (IsDBNull(Row.Item("amwant_end_year"))) Then
                            If Not String.IsNullOrEmpty(Row.Item("amwant_end_year").ToString.Trim) Then
                                If Not String.IsNullOrEmpty(sTmpYearRange.Trim) Then
                                    sTmpYearRange += " - " + Row.Item("amwant_end_year").ToString.Trim
                                Else
                                    sTmpYearRange = Row.Item("amwant_end_year").ToString.Trim
                                End If
                            End If
                        End If

                        htmlOut.Append(Constants.QUOTE + sTmpYearRange.Trim + Constants.QUOTE + Constants.cCommaDelim)

                        If Not IsDBNull(Row.Item("amwant_amount_note")) Then

                            If ((Not String.IsNullOrEmpty(Row.Item("amwant_amount_note").ToString.Trim)) And (Not Row.Item("amwant_amount_note").ToString.ToUpper.Contains("PRICE"))) Then
                                htmlOut.Append(Constants.QUOTE + Row.Item("amwant_amount_note").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                            Else

                                If Not IsDBNull(Row.Item("amwant_max_price")) Then
                                    If Not String.IsNullOrEmpty(Row.Item("amwant_max_price").ToString.Trim) Then

                                        If IsNumeric(Row.Item("amwant_max_price")) And Row.Item("amwant_max_price") > 0 Then
                                            htmlOut.Append(Constants.QUOTE + "$" + FormatNumber(Row.Item("amwant_max_price").ToString, 1, TriState.False, TriState.False, TriState.True) + Constants.QUOTE + Constants.cCommaDelim)
                                        Else
                                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                        End If

                                    Else
                                        htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                    End If

                                Else
                                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                End If

                            End If

                        Else

                            If Not IsDBNull(Row.Item("amwant_max_price")) Then
                                If Not String.IsNullOrEmpty(Row.Item("amwant_max_price").ToString.Trim) Then

                                    If IsNumeric(Row.Item("amwant_max_price")) And Row.Item("amwant_max_price") > 0 Then
                                        htmlOut.Append(Constants.QUOTE + "$" + FormatNumber(Row.Item("amwant_max_price").ToString, 1, TriState.False, TriState.False, TriState.True) + Constants.QUOTE + Constants.cCommaDelim)
                                    Else
                                        htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                    End If

                                Else
                                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                End If

                            Else
                                htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                            End If

                        End If

                        If Not (IsDBNull(Row.Item("amwant_max_aftt"))) Then
                            If Not String.IsNullOrEmpty(Row.Item("amwant_max_aftt").ToString.Trim) Then
                                If IsNumeric(Row.Item("amwant_max_aftt").ToString) And CLng(Row.Item("amwant_max_aftt").ToString) > 0 Then
                                    htmlOut.Append(Constants.QUOTE + FormatNumber(Row.Item("amwant_max_aftt").ToString, 1, TriState.False, TriState.False, TriState.True) + Constants.QUOTE + Constants.cCommaDelim)
                                Else
                                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                End If
                            Else
                                htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                            End If
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        If Not (IsDBNull(Row.Item("amwant_accept_damage_hist"))) Then
                            If Not String.IsNullOrEmpty(Row.Item("amwant_accept_damage_hist").ToString.Trim) Then

                                If Row.Item("amwant_accept_damage_hist").ToString.ToUpper.Contains("Y") Then
                                    htmlOut.Append(Constants.QUOTE + "Yes" + Constants.QUOTE + Constants.cCommaDelim)
                                ElseIf Row.Item("amwant_accept_damage_hist").ToString.ToUpper.Contains("N") Then
                                    htmlOut.Append(Constants.QUOTE + "No" + Constants.QUOTE + Constants.cCommaDelim)
                                ElseIf Row.Item("amwant_accept_damage_hist").ToString.ToUpper.Contains("U") Then
                                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                End If

                            Else
                                htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                            End If
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        If Not (IsDBNull(Row.Item("amwant_notes"))) Then
                            If Not String.IsNullOrEmpty(Row.Item("amwant_notes").ToString.Trim) Then
                                htmlOut.Append(Constants.QUOTE + Row.Item("amwant_notes").ToString.Trim + Constants.QUOTE)
                            Else
                                htmlOut.Append(Constants.QUOTE + Constants.QUOTE)
                            End If
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE)
                        End If

                        htmlOut.Append(vbCrLf)

                    ElseIf bTextTabReport Then

                        htmlOut.Append(Row.Item("amod_make_name").ToString.Trim + vbTab)
                        htmlOut.Append(Row.Item("amod_model_name").ToString.Trim + vbTab)

                        If Not (IsDBNull(Row.Item("amwant_listed_date"))) Then
                            If Not String.IsNullOrEmpty(Row.Item("amwant_listed_date").ToString.Trim) Then
                                htmlOut.Append(FormatDateTime(Row.Item("amwant_listed_date").ToString, DateFormat.ShortDate) + vbTab)
                            Else
                                htmlOut.Append(vbTab)
                            End If
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        If Not (IsDBNull(Row.Item("comp_name"))) Then
                            If Not String.IsNullOrEmpty(Row.Item("comp_name").ToString.Trim) Then
                                htmlOut.Append(Row.Item("comp_name").ToString.Trim + vbTab)
                            Else
                                htmlOut.Append(vbTab)
                            End If
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        Dim sTmpYearRange As String = ""

                        If Not (IsDBNull(Row.Item("amwant_start_year"))) Then
                            If Not String.IsNullOrEmpty(Row.Item("amwant_start_year").ToString.Trim) Then
                                sTmpYearRange = Row.Item("amwant_start_year").ToString.Trim
                            End If
                        End If

                        If Not (IsDBNull(Row.Item("amwant_end_year"))) Then
                            If Not String.IsNullOrEmpty(Row.Item("amwant_end_year").ToString.Trim) Then
                                If Not String.IsNullOrEmpty(sTmpYearRange.Trim) Then
                                    sTmpYearRange += " - " + Row.Item("amwant_end_year").ToString.Trim
                                Else
                                    sTmpYearRange = Row.Item("amwant_end_year").ToString.Trim
                                End If
                            End If
                        End If

                        htmlOut.Append(sTmpYearRange.Trim + vbTab)

                        If Not IsDBNull(Row.Item("amwant_amount_note")) Then

                            If ((Not String.IsNullOrEmpty(Row.Item("amwant_amount_note").ToString.Trim)) And (Not Row.Item("amwant_amount_note").ToString.ToUpper.Contains("PRICE"))) Then
                                htmlOut.Append(Row.Item("amwant_amount_note").ToString.Trim + vbTab)
                            Else

                                If Not IsDBNull(Row.Item("amwant_max_price")) Then
                                    If Not String.IsNullOrEmpty(Row.Item("amwant_max_price").ToString.Trim) Then

                                        If IsNumeric(Row.Item("amwant_max_price")) And Row.Item("amwant_max_price") > 0 Then
                                            htmlOut.Append("$" + FormatNumber(Row.Item("amwant_max_price").ToString, 1, TriState.False, TriState.False, TriState.True) + vbTab)
                                        Else
                                            htmlOut.Append(vbTab)
                                        End If

                                    Else
                                        htmlOut.Append(vbTab)
                                    End If

                                Else
                                    htmlOut.Append(vbTab)
                                End If

                            End If

                        Else

                            If Not IsDBNull(Row.Item("amwant_max_price")) Then
                                If Not String.IsNullOrEmpty(Row.Item("amwant_max_price").ToString.Trim) Then

                                    If IsNumeric(Row.Item("amwant_max_price")) And Row.Item("amwant_max_price") > 0 Then
                                        htmlOut.Append("$" + FormatNumber(Row.Item("amwant_max_price").ToString, 1, TriState.False, TriState.False, TriState.True) + vbTab)
                                    Else
                                        htmlOut.Append(vbTab)
                                    End If

                                Else
                                    htmlOut.Append(vbTab)
                                End If

                            Else
                                htmlOut.Append(vbTab)
                            End If

                        End If

                        If Not (IsDBNull(Row.Item("amwant_max_aftt"))) Then
                            If Not String.IsNullOrEmpty(Row.Item("amwant_max_aftt").ToString.Trim) Then
                                If IsNumeric(Row.Item("amwant_max_aftt").ToString) And CLng(Row.Item("amwant_max_aftt").ToString) > 0 Then
                                    htmlOut.Append(FormatNumber(Row.Item("amwant_max_aftt").ToString, 1, TriState.False, TriState.False, TriState.True) + vbTab)
                                Else
                                    htmlOut.Append(vbTab)
                                End If
                            Else
                                htmlOut.Append(vbTab)
                            End If
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        If Not (IsDBNull(Row.Item("amwant_accept_damage_hist"))) Then
                            If Not String.IsNullOrEmpty(Row.Item("amwant_accept_damage_hist").ToString.Trim) Then

                                If Row.Item("amwant_accept_damage_hist").ToString.ToUpper.Contains("Y") Then
                                    htmlOut.Append("Yes" + vbTab)
                                ElseIf Row.Item("amwant_accept_damage_hist").ToString.ToUpper.Contains("N") Then
                                    htmlOut.Append("No" + vbTab)
                                ElseIf Row.Item("amwant_accept_damage_hist").ToString.ToUpper.Contains("U") Then
                                    htmlOut.Append(Constants.cSingleSpace + vbTab)
                                End If

                            Else
                                htmlOut.Append(vbTab)
                            End If
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        If Not (IsDBNull(Row.Item("amwant_notes"))) Then
                            If Not String.IsNullOrEmpty(Row.Item("amwant_notes").ToString.Trim) Then
                                htmlOut.Append(Row.Item("amwant_notes").ToString.Trim)
                            End If
                        End If

                        htmlOut.Append(vbCrLf)

                    End If

                Next

            End If

            If bHtmlReport Or bExcelReport Then
                htmlOut.Append("</table>")
            End If

            If bHtmlReport Then
                htmlOut.Append("</div>")
                htmlOut.Append("</body>")
                htmlOut.Append("</html>")
            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in create_report_6_export_current_wanteds_list()" + ex.Message
        Finally

            report_6_datatable = Nothing

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOut.ToString

    End Function

#End Region

#Region "report_7_functions"

    Public Function create_report_7_labels_export_current_company_list(ByRef record_count As Long) As String

        Dim nHoldCompID As Long = 0
        Dim tmpCompID As String = ""
        Dim sEmailAddress As String = ""

        Dim SqlException As System.Data.SqlClient.SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim report_7_datatable As New DataTable

        Dim adoRS_7 As System.Data.SqlClient.SqlDataReader = Nothing

        Dim htmlOut = New StringBuilder()
        Dim sQuery As New StringBuilder()

        Try

            SqlConn.ConnectionString = localFunctions.clientConnectStr

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 90

            If chkIncludeContacts.Checked Then
                Dim tmpQueryString As String = ""

                tmpQueryString = HttpContext.Current.Session.Item("MasterCompany").ToString.Replace("'' as", "")
                HttpContext.Current.Session.Item("MasterCompany") = tmpQueryString.Replace("0 as contact_id", "contact_id")
                tmpQueryString = ""

            End If

            If HttpContext.Current.Session.Item("MasterCompany").ToString.ToLower.Contains("business_type_reference") Then
                Dim tmpQueryString As String = ""
                tmpQueryString = HttpContext.Current.Session.Item("MasterCompany").ToString.Replace("comp_action_date,", "comp_action_date, (SELECT DISTINCT cbus_name FROM Company_Business_Type WITH (NOLOCK) WHERE comp_business_type = cbus_type) AS comp_rel, (SELECT DISTINCT country_continent_name FROM country WITH (NOLOCK) WHERE comp_country = country_name) AS comp_continent,")
                HttpContext.Current.Session.Item("MasterCompany") = tmpQueryString
            End If

            sQuery.Append(HttpContext.Current.Session.Item("MasterCompany").ToString)

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />Create_Report_7_Labels_Export_Current_Company_List()<br />" + sQuery.ToString

            If bHtmlReport Then
                htmlOut.Append("<!DOCTYPE html>")
                htmlOut.Append("<html lang='en'>")
                htmlOut.Append("<head>")
                htmlOut.Append("<meta http-equiv='Content-Language' content='en-us' />")
                htmlOut.Append("<meta http-equiv='Content-Type' content='text/html; charset=windows-1252' />")
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='common/jetnet.css' />")
                htmlOut.Append("<title>JETNET - Labels Export of Current Company List</title>")
                htmlOut.Append("</head>")
                htmlOut.Append("<body style='background: white; margin-top:10px; margin-left:10px;'>")
                htmlOut.Append("<div style='text-align:center;'>")
            End If

            If bExcelReport Then
                htmlOut.Append("<table border='1' cellpadding='2' cellspacing='0'>")
            ElseIf bHtmlReport Then
                htmlOut.Append("<table class='centerTable' border='0' cellpadding='2' cellspacing='0' width='100%'>")
            End If

            SqlCommand.CommandText = sQuery.ToString
            adoRS_7 = SqlCommand.ExecuteReader()

            Try
                report_7_datatable.Load(adoRS_7)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = report_7_datatable.GetErrors()
            End Try

            record_count = report_7_datatable.Rows.Count

            adoRS_7.Close()
            adoRS_7 = Nothing

            If chkIncludeAllContacts.Checked Then

                For Each Row As DataRow In report_7_datatable.Rows

                    If Not IsDBNull(Row.Item("comp_id")) Then
                        If Not String.IsNullOrEmpty(Row.Item("comp_id").ToString.Trim) Then
                            If String.IsNullOrEmpty(tmpCompID.Trim) Then
                                tmpCompID = Row.Item("comp_id").ToString.Trim
                            Else
                                tmpCompID += Constants.cCommaDelim + Row.Item("comp_id").ToString.Trim
                            End If
                        End If
                    End If

                Next

                sQuery = New StringBuilder()

                sQuery.Append("SELECT DISTINCT contact_id, comp_id, comp_journ_id, comp_name, comp_name_alt as comp_alternate_name, comp_name_alt_type as comp_alternate_name_type, comp_city, comp_state, comp_zip_code,")
                sQuery.Append(" comp_email_address, comp_web_address, comp_address1, comp_address2, comp_country, state_name,")
                sQuery.Append(" (SELECT DISTINCT cbus_name FROM Company_Business_Type WITH (NOLOCK) WHERE comp_business_type = cbus_type) AS comp_rel,")
                sQuery.Append(" (SELECT DISTINCT country_continent_name FROM country WITH (NOLOCK) WHERE comp_country = country_name) AS comp_continent,")
                ' sQuery.Append("(select top 1 yct_name from Yacht_Reference with (NOLOCK) inner join Yacht_Contact_Type with (NOLOCK) on yct_code = yr_contact_type where yr_comp_id = company.comp_id order by yct_seq_no asc) as comp_rel,")
                sQuery.Append(" contact_id, contact_first_name, contact_last_name, contact_middle_initial, contact_sirname, contact_suffix, contact_title, contact_email_address,")
                sQuery.Append(" (SELECT TOP 1 pnum_number_full FROM Phone_Numbers WHERE pnum_type = 'Office' AND comp_id = pnum_comp_id AND pnum_contact_id = 0 AND pnum_journ_id = 0) AS comp_phone_office,")
                sQuery.Append(" (SELECT TOP 1 pnum_number_full FROM Phone_Numbers WHERE pnum_type = 'Fax' AND comp_id = pnum_comp_id AND pnum_contact_id = 0 AND pnum_journ_id = 0) AS comp_phone_fax")
                sQuery.Append(" FROM Company WITH(NOLOCK)")
                sQuery.Append(" LEFT OUTER JOIN Contact WITH(NOLOCK) ON (contact_comp_id = comp_id AND contact_journ_id = comp_journ_id)")
                sQuery.Append(" LEFT OUTER JOIN State WITH(NOLOCK) ON (comp_state = state_code AND comp_country = state_country)")
                sQuery.Append(" WHERE comp_id IN (" + tmpCompID + ") AND comp_journ_id = 0")

                sQuery.Append(" AND (contact_active_flag = 'Y' OR contact_active_flag IS NULL)")
                sQuery.Append(" AND (contact_hide_flag = 'N' OR contact_hide_flag IS NULL)")
                sQuery.Append(" " + commonEvo.MakeCompanyProductCodeClause(HttpContext.Current.Session.Item("localPreferences"), False))
                sQuery.Append(" ORDER BY comp_name")

                HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />Create_Report_7_Labels_Export_Current_Company_List()<br />" + sQuery.ToString

                ' clean up previous results
                report_7_datatable = New DataTable

                SqlCommand.CommandText = sQuery.ToString
                adoRS_7 = SqlCommand.ExecuteReader()

                Try
                    report_7_datatable.Load(adoRS_7)
                Catch constrExc As System.Data.ConstraintException
                    Dim rowsErr As System.Data.DataRow() = report_7_datatable.GetErrors()
                End Try

                adoRS_7.Close()
                adoRS_7 = Nothing

            End If ' chkIncludeAllContacts.Checked  

            If report_7_datatable.Rows.Count > 0 Then

                If chkShowReportHeader.Checked Then

                    If bExcelReport Or bHtmlReport Then

                        htmlOut.Append("<tr bgcolor='#CCCCCC'>")

                        If chkIncludeAllContacts.Checked Then
                            htmlOut.Append("<td align='left'>RELATIONSHIP</td>")
                        End If

                        htmlOut.Append("<td align='left'>COMPANY</td>")
                        htmlOut.Append("<td align='left'>COMPALTNAME</td>")

                        If chkIncludeContacts.Checked Or chkIncludeAllContacts.Checked Then
                            htmlOut.Append("<td align='left'>CONTACTNAME</td>")
                            htmlOut.Append("<td align='left'>SALUTATION</td>")
                            htmlOut.Append("<td align='left'>FIRSTNAME</td>")
                            htmlOut.Append("<td align='left'>MIDDLE</td>")
                            htmlOut.Append("<td align='left'>LASTNAME</td>")
                            htmlOut.Append("<td align='left'>SUFFIX</td>")
                            htmlOut.Append("<td align='left'>TITLE</td>")
                            htmlOut.Append("<td align='left'>CONTACTEMAIL</td>")
                        End If

                        htmlOut.Append("<td align='left'>ADDRESS</td>")
                        htmlOut.Append("<td align='left'>ADDRESS2</td>")
                        htmlOut.Append("<td align='left'>CITY</td>")
                        htmlOut.Append("<td align='left'>STATE</td>")
                        htmlOut.Append("<td align='left'>POSTALCODE</td>")
                        htmlOut.Append("<td align='left'>COUNTRY</td>")
                        If chkIncludeAllContacts.Checked Then
                            htmlOut.Append("<td align='left'>CONTINENT</td>")
                        End If
                        htmlOut.Append("<td align='left'>OFFICE</td>")
                        htmlOut.Append("<td align='left'>FAX</td>")
                        htmlOut.Append("<td align='left'>COMPANYEMAIL</td>")
                        htmlOut.Append("<td align='left'>COMPANYWEBADDRESS</td>")
                        htmlOut.Append("</tr>")

                    ElseIf bTextCommaReport Then
                        If chkIncludeAllContacts.Checked Then
                            htmlOut.Append(Constants.QUOTE + "RELATIONSHIP" + Constants.QUOTE + Constants.cCommaDelim)
                        End If
                        htmlOut.Append(Constants.QUOTE + "COMPANY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPALTNAME" + Constants.QUOTE + Constants.cCommaDelim)

                        If chkIncludeContacts.Checked Or chkIncludeAllContacts.Checked Then
                            htmlOut.Append(Constants.QUOTE + "CONTACTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "SALUTATION" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "FIRSTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "MIDDLE" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "LASTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "SUFFIX" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "TITLE" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "CONTACTEMAIL" + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        htmlOut.Append(Constants.QUOTE + "ADDRESS" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "ADDRES2" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CITY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "STATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "POSTALCODE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COUNTRY" + Constants.QUOTE + Constants.cCommaDelim)
                        If chkIncludeContacts.Checked Or chkIncludeAllContacts.Checked Then
                            htmlOut.Append(Constants.QUOTE + "CONTINENT" + Constants.QUOTE + Constants.cCommaDelim)
                        End If
                        htmlOut.Append(Constants.QUOTE + "OFFICE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "FAX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPANYEMAIL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPANYWEBADDRESS" + Constants.QUOTE)

                        htmlOut.Append(vbCrLf)

                    ElseIf bTextTabReport Then

                        If chkIncludeAllContacts.Checked Then
                            htmlOut.Append("RELATIONSHIP" + vbTab)
                        End If

                        htmlOut.Append("COMPANY" + vbTab)
                        htmlOut.Append("COMPALTNAME" + vbTab)

                        If chkIncludeContacts.Checked Or chkIncludeAllContacts.Checked Then
                            htmlOut.Append("CONTACTNAME" + vbTab)
                            htmlOut.Append("SALUTATION" + vbTab)
                            htmlOut.Append("FIRSTNAME" + vbTab)
                            htmlOut.Append("MIDDLE" + vbTab)
                            htmlOut.Append("LASTNAME" + vbTab)
                            htmlOut.Append("SUFFIX" + vbTab)
                            htmlOut.Append("TITLE" + vbTab)
                            htmlOut.Append("CONTACTEMAIL" + vbTab)
                        End If

                        htmlOut.Append("ADDRESS" + vbTab)
                        htmlOut.Append("ADDRESS2" + vbTab)
                        htmlOut.Append("CITY" + vbTab)
                        htmlOut.Append("STATE" + vbTab)
                        htmlOut.Append("POSTALCODE" + vbTab)
                        htmlOut.Append("COUNTRY" + vbTab)
                        If chkIncludeAllContacts.Checked Then
                            htmlOut.Append("CONTINENT" + vbTab)
                        End If
                        htmlOut.Append("OFFICE" + vbTab)
                        htmlOut.Append("FAX" + vbTab)
                        htmlOut.Append("COMPANYEMAIL" + vbTab)
                        htmlOut.Append("COMPANYWEBADDRESS")

                        htmlOut.Append(vbCrLf)

                    End If   ' 

                End If ' chkShowReportHeader.Checked Then

                For Each Row As DataRow In report_7_datatable.Rows

                    sEmailAddress = ""

                    If CLng(Row.Item("comp_id").ToString) <> nHoldCompID Or chkIncludeContacts.Checked Or chkIncludeAllContacts.Checked Then

                        nHoldCompID = CLng(Row.Item("comp_id").ToString)

                        If bHtmlReport Or bExcelReport Then

                            htmlOut.Append("<tr>")

                            If chkIncludeAllContacts.Checked Then
                                If Not (IsDBNull(Row.Item("comp_rel"))) Then
                                    htmlOut.Append("<td valign='middle' align='left'>" + Row.Item("comp_rel").ToString.Trim + "</td>")
                                Else
                                    htmlOut.Append("<td valign='middle' align='left'></td>")
                                End If
                            End If


                            If Not (IsDBNull(Row.Item("comp_name"))) Then
                                htmlOut.Append("<td valign='middle' align='left'>" + Row.Item("comp_name").ToString.Trim + "</td>")
                            Else
                                htmlOut.Append("<td valign='middle' align='left'></td>")
                            End If

                            htmlOut.Append("<td valign='middle' align='left'>")

                            If Not IsDBNull(Row.Item("comp_alternate_name_type")) And Not IsDBNull(Row.Item("comp_alternate_name")) Then
                                If Not String.IsNullOrEmpty(Row.Item("comp_alternate_name_type").ToString.Trim) And Not String.IsNullOrEmpty(Row.Item("comp_alternate_name").ToString.Trim) Then
                                    htmlOut.Append(Row.Item("comp_alternate_name_type").ToString.Trim + Constants.cSingleSpace + Row.Item("comp_alternate_name").ToString.Trim)
                                End If
                            Else
                                If Not IsDBNull(Row.Item("comp_alternate_name")) Then
                                    If Not String.IsNullOrEmpty(Row.Item("comp_alternate_name").ToString.Trim) Then
                                        htmlOut.Append(Row.Item("comp_alternate_name").ToString.Trim)
                                    End If
                                End If
                            End If

                            htmlOut.Append("</td>")

                            If chkIncludeContacts.Checked Or chkIncludeAllContacts.Checked Then

                                If Not IsDBNull(Row.Item("contact_first_name")) And Not IsDBNull(Row.Item("contact_last_name")) Then
                                    htmlOut.Append("<td valign='middle' align='left'>" + Row.Item("contact_first_name").ToString.Trim + Constants.cSingleSpace + Row.Item("contact_last_name").ToString.Trim + "</td>")
                                Else
                                    htmlOut.Append("<td valign='middle' align='left'></td>")
                                End If

                                If Not (IsDBNull(Row.Item("contact_sirname"))) Then
                                    htmlOut.Append("<td valign='middle' align='left'>" + Row.Item("contact_sirname").ToString.Trim + "</td>")
                                Else
                                    htmlOut.Append("<td valign='middle' align='left'></td>")
                                End If

                                If Not (IsDBNull(Row.Item("contact_first_name"))) Then
                                    htmlOut.Append("<td valign='middle' align='left'>" + Row.Item("contact_first_name").ToString.Trim + "</td>")
                                Else
                                    htmlOut.Append("<td valign='middle' align='left'></td>")
                                End If

                                If Not (IsDBNull(Row.Item("contact_middle_initial"))) Then
                                    htmlOut.Append("<td valign='middle' align='left'>" + Row.Item("contact_middle_initial").ToString.Trim + "</td>")
                                Else
                                    htmlOut.Append("<td valign='middle' align='left'></td>")
                                End If

                                If Not (IsDBNull(Row.Item("contact_last_name"))) Then
                                    htmlOut.Append("<td valign='middle' align='left'>" + Row.Item("contact_last_name").ToString.Trim + "</td>")
                                Else
                                    htmlOut.Append("<td valign='middle' align='left'></td>")
                                End If

                                If Not (IsDBNull(Row.Item("contact_suffix"))) Then
                                    htmlOut.Append("<td valign='middle' align='left'>" + Row.Item("contact_suffix").ToString.Trim + "</td>")
                                Else
                                    htmlOut.Append("<td valign='middle' align='left'></td>")
                                End If

                                If Not (IsDBNull(Row.Item("contact_title"))) Then
                                    htmlOut.Append("<td valign='middle' align='left'>" + Row.Item("contact_title").ToString.Trim + "</td>")
                                Else
                                    htmlOut.Append("<td valign='middle' align='left'></td>")
                                End If

                                If chkIncludeAllContacts.Checked Then

                                    If Not (IsDBNull(Row.Item("contact_email_address"))) Then
                                        htmlOut.Append("<td valign='middle' align='left'>" + Row.Item("contact_email_address").ToString.Trim + "</td>")
                                    Else
                                        htmlOut.Append("<td valign='middle' align='left'></td>")
                                    End If

                                Else

                                    If Not IsDBNull(Row.Item("contact_id")) Then
                                        sEmailAddress = localFunctions.get_contact_email_address_report(CLng(Row.Item("comp_id")), CLng(Row.Item("contact_id")))
                                    End If

                                    If Not String.IsNullOrEmpty(sEmailAddress) Then
                                        htmlOut.Append("<td valign='middle' align='left'>" + sEmailAddress.Trim + "</td>")
                                    Else
                                        htmlOut.Append("<td valign='middle' align='left'></td>")
                                    End If

                                End If

                            End If

                            If Not (IsDBNull(Row.Item("comp_address1"))) Then
                                htmlOut.Append("<td valign='middle' align='left'>" + Row.Item("comp_address1").ToString.Trim + "</td>")
                            Else
                                htmlOut.Append("<td valign='middle' align='left'></td>")
                            End If

                            If Not (IsDBNull(Row.Item("comp_address2"))) Then
                                htmlOut.Append("<td valign='middle' align='left'>" + Row.Item("comp_address2").ToString.Trim + "</td>")
                            Else
                                htmlOut.Append("<td valign='middle' align='left'></td>")
                            End If

                            If Not (IsDBNull(Row.Item("comp_city"))) Then
                                htmlOut.Append("<td valign='middle' align='left'>" + Row.Item("comp_city").ToString.Trim + "</td>")
                            Else
                                htmlOut.Append("<td valign='middle' align='left'></td>")
                            End If

                            If Not (IsDBNull(Row.Item("comp_state"))) Then
                                htmlOut.Append("<td valign='middle' align='left'>" + Row.Item("comp_state").ToString.Trim + "</td>")
                            Else
                                htmlOut.Append("<td valign='middle' align='left'></td>")
                            End If

                            If Not (IsDBNull(Row.Item("comp_zip_code"))) Then
                                htmlOut.Append("<td valign='middle' align='left'>" + Row.Item("comp_zip_code").ToString.Trim + "</td>")
                            Else
                                htmlOut.Append("<td valign='middle' align='left'></td>")
                            End If

                            If Not (IsDBNull(Row.Item("comp_country"))) Then
                                htmlOut.Append("<td valign='middle' align='left'>" + Row.Item("comp_country").ToString.Trim + "</td>")
                            Else
                                htmlOut.Append("<td valign='middle' align='left'></td>")
                            End If

                            If chkIncludeAllContacts.Checked Then
                                If Not (IsDBNull(Row.Item("comp_continent"))) Then
                                    htmlOut.Append("<td valign='middle' align='left'>" + Row.Item("comp_continent").ToString.Trim + "</td>")
                                Else
                                    htmlOut.Append("<td valign='middle' align='left'></td>")
                                End If
                            End If

                            If Not (IsDBNull(Row.Item("comp_phone_office"))) Then
                                htmlOut.Append("<td valign='middle' align='left' nowrap='nowrap'>" + Row.Item("comp_phone_office").ToString.Trim + "</td>")
                            Else
                                htmlOut.Append("<td valign='middle' align='left'></td>")
                            End If

                            If Not (IsDBNull(Row.Item("comp_phone_fax"))) Then
                                htmlOut.Append("<td valign='middle' align='left' nowrap='nowrap'>" + Row.Item("comp_phone_fax").ToString.Trim + "</td>")
                            Else
                                htmlOut.Append("<td valign='middle' align='left'></td>")
                            End If

                            If Not (IsDBNull(Row.Item("comp_email_address"))) Then
                                htmlOut.Append("<td valign='middle' align='left'>" + Row.Item("comp_email_address").ToString.Trim + "</td>")
                            Else
                                htmlOut.Append("<td valign='middle' align='left'></td>")
                            End If

                            If Not (IsDBNull(Row.Item("comp_web_address"))) Then
                                htmlOut.Append("<td valign='middle' align='left'>" + Row.Item("comp_web_address").ToString.Trim + "</td>")
                            Else
                                htmlOut.Append("<td valign='middle' align='left'></td>")
                            End If

                            htmlOut.Append("</tr>")

                        ElseIf bTextCommaReport Then

                            If Not (IsDBNull(Row.Item("comp_rel"))) Then
                                htmlOut.Append(Constants.QUOTE + Row.Item("comp_rel").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                            Else
                                htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                            End If


                            If Not (IsDBNull(Row.Item("comp_name"))) Then
                                htmlOut.Append(Constants.QUOTE + Row.Item("comp_name").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                            Else
                                htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                            End If

                            htmlOut.Append(Constants.QUOTE)

                            If Not IsDBNull(Row.Item("comp_alternate_name_type")) And Not IsDBNull(Row.Item("comp_alternate_name")) Then
                                If Not String.IsNullOrEmpty(Row.Item("comp_alternate_name_type").ToString.Trim) And Not String.IsNullOrEmpty(Row.Item("comp_alternate_name").ToString.Trim) Then
                                    htmlOut.Append(Row.Item("comp_alternate_name_type").ToString.Trim + Constants.cSingleSpace + Row.Item("comp_alternate_name").ToString.Trim)
                                End If
                            Else
                                If Not IsDBNull(Row.Item("comp_alternate_name")) Then
                                    If Not String.IsNullOrEmpty(Row.Item("comp_alternate_name").ToString.Trim) Then
                                        htmlOut.Append(Row.Item("comp_alternate_name").ToString.Trim)
                                    End If
                                End If
                            End If

                            htmlOut.Append(Constants.QUOTE + Constants.cCommaDelim)

                            If chkIncludeContacts.Checked Or chkIncludeAllContacts.Checked Then

                                If Not IsDBNull(Row.Item("contact_first_name")) And Not IsDBNull(Row.Item("contact_last_name")) Then
                                    htmlOut.Append(Constants.QUOTE + Row.Item("contact_first_name").ToString.Trim + Constants.cSingleSpace + Row.Item("contact_last_name").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                                Else
                                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                End If

                                If Not (IsDBNull(Row.Item("contact_sirname"))) Then
                                    htmlOut.Append(Constants.QUOTE + Row.Item("contact_sirname").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                                Else
                                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                End If

                                If Not (IsDBNull(Row.Item("contact_first_name"))) Then
                                    htmlOut.Append(Constants.QUOTE + Row.Item("contact_first_name").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                                Else
                                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                End If

                                If Not (IsDBNull(Row.Item("contact_middle_initial"))) Then
                                    htmlOut.Append(Constants.QUOTE + Row.Item("contact_middle_initial").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                                Else
                                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                End If

                                If Not (IsDBNull(Row.Item("contact_last_name"))) Then
                                    htmlOut.Append(Constants.QUOTE + Row.Item("contact_last_name").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                                Else
                                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                End If

                                If Not (IsDBNull(Row.Item("contact_suffix"))) Then
                                    htmlOut.Append(Constants.QUOTE + Row.Item("contact_suffix").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                                Else
                                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                End If

                                If Not (IsDBNull(Row.Item("contact_title"))) Then
                                    htmlOut.Append(Constants.QUOTE + Row.Item("contact_title").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                                Else
                                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                End If

                                If chkIncludeAllContacts.Checked Then

                                    If Not (IsDBNull(Row.Item("contact_email_address"))) Then
                                        htmlOut.Append(Constants.QUOTE + Row.Item("contact_email_address").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                                    Else
                                        htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                    End If

                                Else

                                    If Not IsDBNull(Row.Item("contact_id")) Then
                                        sEmailAddress = localFunctions.get_contact_email_address_report(CLng(Row.Item("comp_id")), CLng(Row.Item("contact_id")))
                                    End If

                                    If Not String.IsNullOrEmpty(sEmailAddress) Then
                                        htmlOut.Append(Constants.QUOTE + sEmailAddress.Trim + Constants.QUOTE + Constants.cCommaDelim)
                                    Else
                                        htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                    End If

                                End If

                            End If

                            If Not (IsDBNull(Row.Item("comp_address1"))) Then
                                htmlOut.Append(Constants.QUOTE + Row.Item("comp_address1").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                            Else
                                htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                            End If

                            If Not (IsDBNull(Row.Item("comp_address2"))) Then
                                htmlOut.Append(Constants.QUOTE + Row.Item("comp_address2").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                            Else
                                htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                            End If

                            If Not (IsDBNull(Row.Item("comp_city"))) Then
                                htmlOut.Append(Constants.QUOTE + Row.Item("comp_city").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                            Else
                                htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                            End If

                            If Not (IsDBNull(Row.Item("comp_state"))) Then
                                htmlOut.Append(Constants.QUOTE + Row.Item("comp_state").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                            Else
                                htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                            End If

                            If Not (IsDBNull(Row.Item("comp_zip_code"))) Then
                                htmlOut.Append(Constants.QUOTE + Row.Item("comp_zip_code").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                            Else
                                htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                            End If

                            If Not (IsDBNull(Row.Item("comp_country"))) Then
                                htmlOut.Append(Constants.QUOTE + Row.Item("comp_country").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                            Else
                                htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                            End If

                            If Not (IsDBNull(Row.Item("comp_continent"))) Then
                                htmlOut.Append(Constants.QUOTE + Row.Item("comp_continent").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                            Else
                                htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                            End If

                            If Not (IsDBNull(Row.Item("comp_phone_office"))) Then
                                htmlOut.Append(Constants.QUOTE + Row.Item("comp_phone_office").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                            Else
                                htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                            End If

                            If Not (IsDBNull(Row.Item("comp_phone_fax"))) Then
                                htmlOut.Append(Constants.QUOTE + Row.Item("comp_phone_fax").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                            Else
                                htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                            End If

                            If Not (IsDBNull(Row.Item("comp_email_address"))) Then
                                htmlOut.Append(Constants.QUOTE + Row.Item("comp_email_address").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                            Else
                                htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                            End If

                            If Not (IsDBNull(Row.Item("comp_web_address"))) Then
                                htmlOut.Append(Constants.QUOTE + Row.Item("comp_web_address").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                            Else
                                htmlOut.Append(Constants.QUOTE + Constants.QUOTE)
                            End If

                            htmlOut.Append(vbCrLf)

                        ElseIf bTextTabReport Then

                            If Not (IsDBNull(Row.Item("comp_rel"))) Then
                                htmlOut.Append(Row.Item("comp_rel").ToString.Trim + vbTab)
                            Else
                                htmlOut.Append(vbTab)
                            End If

                            If Not (IsDBNull(Row.Item("comp_name"))) Then
                                htmlOut.Append(Row.Item("comp_name").ToString.Trim + vbTab)
                            Else
                                htmlOut.Append(vbTab)
                            End If

                            If Not IsDBNull(Row.Item("comp_alternate_name_type")) And Not IsDBNull(Row.Item("comp_alternate_name")) Then
                                If Not String.IsNullOrEmpty(Row.Item("comp_alternate_name_type").ToString.Trim) And Not String.IsNullOrEmpty(Row.Item("comp_alternate_name").ToString.Trim) Then
                                    htmlOut.Append(Row.Item("comp_alternate_name_type").ToString.Trim + Constants.cSingleSpace + Row.Item("comp_alternate_name").ToString.Trim)
                                End If
                            Else
                                If Not IsDBNull(Row.Item("comp_alternate_name")) Then
                                    If Not String.IsNullOrEmpty(Row.Item("comp_alternate_name").ToString.Trim) Then
                                        htmlOut.Append(Row.Item("comp_alternate_name").ToString.Trim)
                                    End If
                                End If
                            End If

                            htmlOut.Append(vbTab)

                            If chkIncludeContacts.Checked Or chkIncludeAllContacts.Checked Then

                                If Not IsDBNull(Row.Item("contact_first_name")) And Not IsDBNull(Row.Item("contact_last_name")) Then
                                    htmlOut.Append(Row.Item("contact_first_name").ToString.Trim + Constants.cSingleSpace + Row.Item("contact_last_name").ToString.Trim + vbTab)
                                Else
                                    htmlOut.Append(vbTab)
                                End If

                                If Not (IsDBNull(Row.Item("contact_sirname"))) Then
                                    htmlOut.Append(Row.Item("contact_sirname").ToString.Trim + vbTab)
                                Else
                                    htmlOut.Append(vbTab)
                                End If

                                If Not (IsDBNull(Row.Item("contact_first_name"))) Then
                                    htmlOut.Append(Row.Item("contact_first_name").ToString.Trim + vbTab)
                                Else
                                    htmlOut.Append(vbTab)
                                End If

                                If Not (IsDBNull(Row.Item("contact_middle_initial"))) Then
                                    htmlOut.Append(Row.Item("contact_middle_initial").ToString.Trim + vbTab)
                                Else
                                    htmlOut.Append(vbTab)
                                End If

                                If Not (IsDBNull(Row.Item("contact_last_name"))) Then
                                    htmlOut.Append(Row.Item("contact_last_name").ToString.Trim + vbTab)
                                Else
                                    htmlOut.Append(vbTab)
                                End If

                                If Not (IsDBNull(Row.Item("contact_suffix"))) Then
                                    htmlOut.Append(Row.Item("contact_suffix").ToString.Trim + vbTab)
                                Else
                                    htmlOut.Append(vbTab)
                                End If

                                If Not (IsDBNull(Row.Item("contact_title"))) Then
                                    htmlOut.Append(Row.Item("contact_title").ToString.Trim + vbTab)
                                Else
                                    htmlOut.Append(vbTab)
                                End If

                                If chkIncludeAllContacts.Checked Then

                                    If Not (IsDBNull(Row.Item("contact_email_address"))) Then
                                        htmlOut.Append(Row.Item("contact_email_address").ToString.Trim + vbTab)
                                    Else
                                        htmlOut.Append(vbTab)
                                    End If

                                Else

                                    If Not IsDBNull(Row.Item("contact_id")) Then
                                        sEmailAddress = localFunctions.get_contact_email_address_report(CLng(Row.Item("comp_id")), CLng(Row.Item("contact_id")))
                                    End If

                                    If Not String.IsNullOrEmpty(sEmailAddress) Then
                                        htmlOut.Append(sEmailAddress.Trim + vbTab)
                                    Else
                                        htmlOut.Append(vbTab)
                                    End If

                                End If

                            End If

                            If Not (IsDBNull(Row.Item("comp_address1"))) Then
                                htmlOut.Append(Row.Item("comp_address1").ToString.Trim + vbTab)
                            Else
                                htmlOut.Append(vbTab)
                            End If

                            If Not (IsDBNull(Row.Item("comp_address2"))) Then
                                htmlOut.Append(Row.Item("comp_address2").ToString.Trim + vbTab)
                            Else
                                htmlOut.Append(vbTab)
                            End If

                            If Not (IsDBNull(Row.Item("comp_city"))) Then
                                htmlOut.Append(Row.Item("comp_city").ToString.Trim + vbTab)
                            Else
                                htmlOut.Append(vbTab)
                            End If

                            If Not (IsDBNull(Row.Item("comp_state"))) Then
                                htmlOut.Append(Row.Item("comp_state").ToString.Trim + vbTab)
                            Else
                                htmlOut.Append(vbTab)
                            End If

                            If Not (IsDBNull(Row.Item("comp_zip_code"))) Then
                                htmlOut.Append(Row.Item("comp_zip_code").ToString.Trim + vbTab)
                            Else
                                htmlOut.Append(vbTab)
                            End If

                            If Not (IsDBNull(Row.Item("comp_country"))) Then
                                htmlOut.Append(Row.Item("comp_country").ToString.Trim + vbTab)
                            Else
                                htmlOut.Append(vbTab)
                            End If

                            If Not (IsDBNull(Row.Item("comp_continent"))) Then
                                htmlOut.Append(Row.Item("comp_continent").ToString.Trim + vbTab)
                            Else
                                htmlOut.Append(vbTab)
                            End If

                            If Not (IsDBNull(Row.Item("comp_phone_office"))) Then
                                htmlOut.Append(Row.Item("comp_phone_office").ToString.Trim + vbTab)
                            Else
                                htmlOut.Append(vbTab)
                            End If

                            If Not (IsDBNull(Row.Item("comp_phone_fax"))) Then
                                htmlOut.Append(Row.Item("comp_phone_fax").ToString.Trim + vbTab)
                            Else
                                htmlOut.Append(vbTab)
                            End If

                            If Not (IsDBNull(Row.Item("comp_email_address"))) Then
                                htmlOut.Append(Row.Item("comp_email_address").ToString.Trim + vbTab)
                            Else
                                htmlOut.Append(vbTab)
                            End If

                            If Not (IsDBNull(Row.Item("comp_web_address"))) Then
                                htmlOut.Append(Row.Item("comp_web_address").ToString.Trim)
                            End If

                            htmlOut.Append(vbCrLf)

                        End If

                    End If

                Next

            End If

            If bHtmlReport Or bExcelReport Then
                htmlOut.Append("</table>")
            End If

            If bHtmlReport Then
                htmlOut.Append("</div>")
                htmlOut.Append("</body>")
                htmlOut.Append("</html>")
            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in create_report_7_labels_export_current_company_list() As String" + ex.Message
        Finally

            report_7_datatable = Nothing

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOut.ToString

    End Function

#End Region

#Region "report_8_functions"

    Public Function create_report_8_condensed_record_with_owner_operator(ByRef record_count As Long) As String

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim report_8_datatable As New DataTable

        Dim adoRS_8 As System.Data.SqlClient.SqlDataReader : adoRS_8 = Nothing

        Dim htmlOut = New StringBuilder()

        Dim sQuery As New StringBuilder()

        Dim lCompOwrId As Long = 0
        Dim lCompOprId As Long = 0
        Dim lCompChpId As Long = 0
        Dim lCompExcId As Long = 0

        Dim lContactOwrId As Long = 0
        Dim lContactOprId As Long = 0
        Dim lContactChpId As Long = 0
        Dim lContactExcId As Long = 0

        Dim strF1 As String = ""
        Dim strF2 As String = ""
        Dim strF3 As String = ""
        Dim strF4 As String = ""
        Dim strF5 As String = ""
        Dim strF6 As String = ""

        Try

            SqlConn.ConnectionString = localFunctions.clientConnectStr

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 90

            If HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("comp_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("contact_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("state_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("country_") Then
                sQuery.Append("SELECT DISTINCT ac_id, ac_journ_id, amod_id, amod_airframe_type_code, amod_type_code, amod_make_name, amod_model_name, ac_ser_no_full, ac_ser_no_sort, ac_reg_no, ac_status,")
                sQuery.Append(" ac_asking, ac_asking_price, ac_list_date, ac_purchase_date, ac_upd_date, ac_mfr_year, ac_year,")
                sQuery.Append(" ac_aport_iata_code, ac_aport_icao_code, ac_aport_name, ac_aport_city, ac_aport_state, ac_aport_country,")
                sQuery.Append(" ac_airframe_tot_hrs, ac_airframe_tot_landings, ac_engine_maint_prog_name, ac_passenger_count, ac_engine_name,")
                sQuery.Append(" ac_engine_1_ser_no, ac_engine_2_ser_no, ac_engine_3_ser_no, ac_engine_4_ser_no,")
                sQuery.Append(" ac_engine_1_tot_hrs, ac_engine_2_tot_hrs, ac_engine_3_tot_hrs, ac_engine_4_tot_hrs,")
                sQuery.Append(" ac_engine_1_soh_hrs, ac_engine_2_soh_hrs, ac_engine_3_soh_hrs, ac_engine_4_soh_hrs,")
                sQuery.Append(" ac_maint_eoh_by_name, ac_engine_1_shi_hrs, ac_engine_2_shi_hrs, ac_engine_3_shi_hrs, ac_engine_4_shi_hrs,")
                sQuery.Append(" ac_maint_hots_by_name, ac_engine_1_tbo_hrs, ac_engine_2_tbo_hrs, ac_engine_3_tbo_hrs, ac_engine_4_tbo_hrs,")
                sQuery.Append(" ac_maintained, ac_times_as_of_date, ac_exterior_moyear, ac_interior_moyear, ac_lifecycle_stage,")
                sQuery.Append(" ac_avionics_avpackage, ac_avionics_flightdir, ac_avionics_autopilot,")
                sQuery.Append(" ac_avionics_afis, ac_avionics_fms, ac_avionics_gps, ac_avionics_ins, ac_avionics_irs,")
                sQuery.Append(" amp_provider_name, amp_program_name, emp_provider_name, emp_program_name")


                sQuery.Append(",  (select top 1 comp_name from  Aircraft_Reference  with (NOLOCK) inner join company with (NOLOCK) on cref_comp_id = comp_id And comp_journ_id = cref_journ_id ")
                sQuery.Append(" And cref_journ_id = 0 And cref_ac_id = ac_id And cref_contact_type = '13' ) as LESSOR ")

                sQuery.Append(" FROM View_Aircraft_Company_Flat WITH(NOLOCK) ")
            Else
                sQuery.Append("SELECT DISTINCT ac_id, ac_journ_id, amod_id, amod_airframe_type_code, amod_type_code, amod_make_name, amod_model_name, ac_ser_no_full, ac_ser_no_sort, ac_reg_no, ac_status,")
                sQuery.Append(" ac_asking, ac_asking_price, ac_list_date, ac_purchase_date, ac_upd_date, ac_mfr_year, ac_year,")
                sQuery.Append(" ac_aport_iata_code, ac_aport_icao_code, ac_aport_name, ac_aport_city, ac_aport_state, ac_aport_country,")
                sQuery.Append(" ac_airframe_tot_hrs, ac_airframe_tot_landings, ac_engine_maint_prog_name, ac_passenger_count, ac_engine_name,")
                sQuery.Append(" ac_engine_1_ser_no, ac_engine_2_ser_no, ac_engine_3_ser_no, ac_engine_4_ser_no,")
                sQuery.Append(" ac_engine_1_tot_hrs, ac_engine_2_tot_hrs, ac_engine_3_tot_hrs, ac_engine_4_tot_hrs,")
                sQuery.Append(" ac_engine_1_soh_hrs, ac_engine_2_soh_hrs, ac_engine_3_soh_hrs, ac_engine_4_soh_hrs,")
                sQuery.Append(" ac_maint_eoh_by_name, ac_engine_1_shi_hrs, ac_engine_2_shi_hrs, ac_engine_3_shi_hrs, ac_engine_4_shi_hrs,")
                sQuery.Append(" ac_maint_hots_by_name, ac_engine_1_tbo_hrs, ac_engine_2_tbo_hrs, ac_engine_3_tbo_hrs, ac_engine_4_tbo_hrs,")
                sQuery.Append(" ac_maintained, ac_times_as_of_date, ac_exterior_moyear, ac_interior_moyear, ac_lifecycle_stage,")
                sQuery.Append(" ac_avionics_avpackage, ac_avionics_flightdir, ac_avionics_autopilot,")
                sQuery.Append(" ac_avionics_afis, ac_avionics_fms, ac_avionics_gps, ac_avionics_ins, ac_avionics_irs,")
                sQuery.Append(" amp_provider_name, amp_program_name, emp_provider_name, emp_program_name")

                sQuery.Append(",  (select top 1 comp_name from  Aircraft_Reference  with (NOLOCK) inner join company with (NOLOCK) on cref_comp_id = comp_id And comp_journ_id = cref_journ_id ")
                sQuery.Append(" And cref_journ_id = 0 And cref_ac_id = ac_id And cref_contact_type = '13' ) as LESSOR ")

                sQuery.Append(" FROM View_Aircraft_Flat WITH(NOLOCK) ")
            End If

            sQuery.Append(HttpContext.Current.Session.Item("MasterAircraftWhere").ToString)

            sQuery.Append(" ORDER BY amod_make_name, amod_airframe_type_code, amod_type_code, amod_id, amod_model_name, ac_ser_no_sort")

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />Create_Report_8_Condensed_Record_with_Owner_Operator()<br />" + sQuery.ToString

            If bHtmlReport Then
                htmlOut.Append("<!DOCTYPE html>")
                htmlOut.Append("<html lang='en'>")
                htmlOut.Append("<head>")
                htmlOut.Append("<meta http-equiv='Content-Language' content='en-us' />")
                htmlOut.Append("<meta http-equiv='Content-Type' content='text/html; charset=windows-1252' />")
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='common/jetnet.css' />")
                htmlOut.Append("<title>JETNET - Condensed Record with Owner/Operator</title>")
                htmlOut.Append("</head>")
                htmlOut.Append("<body style='background: white; margin-top:10px; margin-left:10px; font-size: 11px;'>")
                htmlOut.Append("<div style='text-align:center;'>")
            End If

            If bExcelReport Then
                htmlOut.Append(localFunctions.include_excel_report_style() + vbCrLf)
                htmlOut.Append("<table border='1' cellpadding='2' cellspacing='0'>")
            ElseIf bHtmlReport Then
                htmlOut.Append("<table class='centerTable' border='0' cellpadding='2' cellspacing='0' width='100%'>")
            End If

            SqlCommand.CommandText = sQuery.ToString
            adoRS_8 = SqlCommand.ExecuteReader()

            Try
                report_8_datatable.Load(adoRS_8)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = report_8_datatable.GetErrors()
            End Try

            record_count = report_8_datatable.Rows.Count

            adoRS_8.Close()
            adoRS_8 = Nothing

            If report_8_datatable.Rows.Count > 0 Then

                If bExcelReport Then

                    If chkShowReportHeader.Checked Then

                        htmlOut.Append("<tr bgcolor='#CCCCCC'>")

                        htmlOut.Append("<td>AIRFRAMETYPE</td>")
                        htmlOut.Append("<td>MAKETYPE</td>")
                        htmlOut.Append("<td>MAKE</td>")
                        htmlOut.Append("<td>MODEL</td>")
                        htmlOut.Append("<td>SERNBR</td>")
                        htmlOut.Append("<td>REGNBR</td>")

                        If Not bAerodexFlag Then
                            htmlOut.Append("<td>STATUS</td>")
                            htmlOut.Append("<td>ASKING</td>")
                            htmlOut.Append("<td>ASKINGAMT</td>")
                            htmlOut.Append("<td>DATELISTED</td>")
                        End If

                        htmlOut.Append("<td>DATEPURCHASED</td>")
                        htmlOut.Append("<td>DATECHANGED</td>")

                        htmlOut.Append("<td>COMP1RELATION</td>")
                        htmlOut.Append("<td>COMP1AGENCYTYPE</td>")
                        htmlOut.Append("<td>COMP1BUSINESSTYPE</td>")
                        htmlOut.Append("<td>COMP1NAME</td>")
                        htmlOut.Append("<td>COMP1ALTNAME</td>")
                        htmlOut.Append("<td>COMP1EMAIL</td>")
                        htmlOut.Append("<td>COMP1WEBADDRESS</td>")
                        htmlOut.Append("<td>COMP1ADDRESS1</td>")
                        htmlOut.Append("<td>COMP1ADDRESS2</td>")
                        htmlOut.Append("<td>COMP1CITY</td>")
                        htmlOut.Append("<td>COMP1STATE</td>")
                        htmlOut.Append("<td>COMP1STATEABBR</td>")
                        htmlOut.Append("<td>COMP1POSTALCODE</td>")
                        htmlOut.Append("<td>COMP1COUNTRY</td>")
                        htmlOut.Append("<td>COMP1OFFICE</td>")
                        htmlOut.Append("<td>COMP1FAX</td>")
                        htmlOut.Append("<td>COMP1MOBILE</td>")
                        htmlOut.Append("<td>CONTACT1SALUTATION</td>")
                        htmlOut.Append("<td>CONTACT1FIRSTNAME</td>")
                        htmlOut.Append("<td>CONTACT1MIDDLE</td>")
                        htmlOut.Append("<td>CONTACT1LASTNAME</td>")
                        htmlOut.Append("<td>CONTACT1SUFFIX</td>")
                        htmlOut.Append("<td>CONTACT1TITLE</td>")   ' 01/13/2003 - By David D. Cruger; Added Contact Title
                        htmlOut.Append("<td>CONTACT1EMAIL</td>")   ' 01/29/2003 - By David D. Cruger; Added Contact EMail
                        htmlOut.Append("<td>CONTACT1OFFICE</td>")
                        htmlOut.Append("<td>CONTACT1FAX</td>")
                        htmlOut.Append("<td>CONTACT1MOBILE</td>")

                        htmlOut.Append("<td>COMP2RELATION</td>")
                        htmlOut.Append("<td>COMP2AGENCYTYPE</td>")
                        htmlOut.Append("<td>COMP2BUSINESSTYPE</td>")
                        htmlOut.Append("<td>COMP2NAME</td>")
                        htmlOut.Append("<td>COMP2ALTNAME</td>")
                        htmlOut.Append("<td>COMP2EMAIL</td>")
                        htmlOut.Append("<td>COMP2WEBADDRESS</td>")
                        htmlOut.Append("<td>COMP2ADDRESS1</td>")
                        htmlOut.Append("<td>COMP2ADDRESS2</td>")
                        htmlOut.Append("<td>COMP2CITY</td>")
                        htmlOut.Append("<td>COMP2STATE</td>")
                        htmlOut.Append("<td>COMP2STATEABBR</td>")
                        htmlOut.Append("<td>COMP2POSTALCODE</td>")
                        htmlOut.Append("<td>COMP2COUNTRY</td>")
                        htmlOut.Append("<td>COMP2OFFICE</td>")
                        htmlOut.Append("<td>COMP2FAX</td>")
                        htmlOut.Append("<td>COMP2MOBILE</td>")
                        htmlOut.Append("<td>CONTACT2SALUTATION</td>")
                        htmlOut.Append("<td>CONTACT2FIRSTNAME</td>")
                        htmlOut.Append("<td>CONTACT2MIDDLE</td>")
                        htmlOut.Append("<td>CONTACT2LASTNAME</td>")
                        htmlOut.Append("<td>CONTACT2SUFFIX</td>")
                        htmlOut.Append("<td>CONTACT2TITLE</td>")   ' 01/13/2003 - By David D. Cruger; Added Contact Title
                        htmlOut.Append("<td>CONTACT2EMAIL</td>")   ' 01/29/2003 - By David D. Cruger; Added Contact EMail
                        htmlOut.Append("<td>CONTACT2OFFICE</td>")
                        htmlOut.Append("<td>CONTACT2FAX</td>")
                        htmlOut.Append("<td>CONTACT2MOBILE</td>") ' 27

                        htmlOut.Append("<td>CHPILOTCOMPRELATION</td>")
                        htmlOut.Append("<td>CHPILOTCOMPAGENCYTYPE</td>")
                        htmlOut.Append("<td>CHPILOTCOMPBUSINESSTYPE</td>")
                        htmlOut.Append("<td>CHPILOTCOMPNAME</td>")
                        htmlOut.Append("<td>CHPILOTCOMPALTNAME</td>")
                        htmlOut.Append("<td>CHPILOTCOMPEMAIL</td>")
                        htmlOut.Append("<td>CHPILOTCOMPWEBADDRESS</td>")
                        htmlOut.Append("<td>CHPILOTCOMPADDRESS1</td>")
                        htmlOut.Append("<td>CHPILOTCOMPADDRESS2</td>")
                        htmlOut.Append("<td>CHPILOTCOMPCITY</td>")
                        htmlOut.Append("<td>CHPILOTCOMPSTATE</td>")
                        htmlOut.Append("<td>CHPILOTCOMPSTATEABBR</td>")
                        htmlOut.Append("<td>CHPILOTCOMPPOSTALCODE</td>")
                        htmlOut.Append("<td>CHPILOTCOMPCOUNTRY</td>")
                        htmlOut.Append("<td>CHPILOTCOMPOFFICE</td>")
                        htmlOut.Append("<td>CHPILOTCOMPFAX</td>")
                        htmlOut.Append("<td>CHPILOTCOMPMOBILE</td>")
                        htmlOut.Append("<td>CHPILOTSALUTATION</td>")
                        htmlOut.Append("<td>CHPILOTFIRSTNAME</td>")
                        htmlOut.Append("<td>CHPILOTMIDDLE</td>")
                        htmlOut.Append("<td>CHPILOTLASTNAME</td>")
                        htmlOut.Append("<td>CHPILOTSUFFIX</td>")
                        htmlOut.Append("<td>CHPILOTTITLE</td>")   ' 01/13/2003 - By David D. Cruger; Added Contact Title
                        htmlOut.Append("<td>CHPILOTEMAIL</td>")   ' 01/29/2003 - By David D. Cruger; Added Contact EMail
                        htmlOut.Append("<td>CHPILOTOFFICE</td>")
                        htmlOut.Append("<td>CHPILOTFAX</td>")
                        htmlOut.Append("<td>CHPILOTMOBILE</td>") '27


                        If Session.Item("localPreferences").AerodexFlag = False Then
                            htmlOut.Append("<td>EXCBROKERCOMPRELATION</td>")
                            htmlOut.Append("<td>EXCBROKERCOMPAGENCYTYPE</td>")
                            htmlOut.Append("<td>EXCBROKERCOMPBUSINESSTYPE</td>")
                            htmlOut.Append("<td>EXCBROKERCOMPNAME</td>")
                            htmlOut.Append("<td>EXCBROKERCOMPALTNAME</td>")
                            htmlOut.Append("<td>EXCBROKERCOMPEMAIL</td>")
                            htmlOut.Append("<td>EXCBROKERCOMPWEBADDRESS</td>")
                            htmlOut.Append("<td>EXCBROKERCOMPADDRESS1</td>")
                            htmlOut.Append("<td>EXCBROKERCOMPADDRESS2</td>")
                            htmlOut.Append("<td>EXCBROKERCOMPCITY</td>")
                            htmlOut.Append("<td>EXCBROKERCOMPSTATE</td>")
                            htmlOut.Append("<td>EXCBROKERCOMPSTATEABBR</td>")
                            htmlOut.Append("<td>EXCBROKERCOMPPOSTALCODE</td>")
                            htmlOut.Append("<td>EXCBROKERCOMPCOUNTRY</td>")
                            htmlOut.Append("<td>EXCBROKERCOMPOFFICE</td>")
                            htmlOut.Append("<td>EXCBROKERCOMPFAX</td>")
                            htmlOut.Append("<td>EXCBROKERCOMPMOBILE</td>")
                            htmlOut.Append("<td>EXCBROKERSALUTATION</td>")
                            htmlOut.Append("<td>EXCBROKERFIRSTNAME</td>")
                            htmlOut.Append("<td>EXCBROKERMIDDLE</td>")
                            htmlOut.Append("<td>EXCBROKERLASTNAME</td>")
                            htmlOut.Append("<td>EXCBROKERSUFFIX</td>")
                            htmlOut.Append("<td>EXCBROKERTITLE</td>")   ' 01/13/2003 - By David D. Cruger; Added Contact Title
                            htmlOut.Append("<td>EXCBROKEREMAIL</td>")   ' 01/29/2003 - By David D. Cruger; Added Contact EMail
                            htmlOut.Append("<td>EXCBROKEROFFICE</td>")
                            htmlOut.Append("<td>EXCBROKERFAX</td>")
                            htmlOut.Append("<td>EXCBROKERMOBILE</td>")
                        End If




                        htmlOut.Append("<td>YEARMFG</td>")
                        htmlOut.Append("<td>YEARDLV</td>")
                        htmlOut.Append("<td>BASEIATA</td>")
                        htmlOut.Append("<td>BASEICAO</td>")
                        htmlOut.Append("<td>BASENAME</td>")
                        htmlOut.Append("<td>BASECITY</td>")
                        htmlOut.Append("<td>BASESTATE</td>")
                        htmlOut.Append("<td>BASECOUNTRY</td>")

                        htmlOut.Append("<td>AFTT</td>")
                        htmlOut.Append("<td>LANDINGS</td>")
                        htmlOut.Append("<td>MXPROG</td>")
                        htmlOut.Append("<td>PASSGR</td>")
                        htmlOut.Append("<td>ENGMODEL</td>")

                        ' 03/28/2006 - By David D. Cruger
                        ' Added Engine SerNbr 1,2,3,4              
                        htmlOut.Append("<td>ENGSERNBR1</td>")
                        htmlOut.Append("<td>ENGSERNBR2</td>")
                        htmlOut.Append("<td>ENGSERNBR3</td>")
                        htmlOut.Append("<td>ENGSERNBR4</td>")

                        htmlOut.Append("<td>ENGTT1</td>")
                        htmlOut.Append("<td>ENGTT2</td>")
                        htmlOut.Append("<td>ENGTT3</td>")
                        htmlOut.Append("<td>ENGTT4</td>")

                        htmlOut.Append("<td>SMOH1</td>")
                        htmlOut.Append("<td>SMOH2</td>")
                        htmlOut.Append("<td>SMOH3</td>")
                        htmlOut.Append("<td>SMOH4</td>")
                        htmlOut.Append("<td>EOHBY</td>")  'ac_maint_eoh_by_name

                        htmlOut.Append("<td>SHOT1</td>")
                        htmlOut.Append("<td>SHOT2</td>")
                        htmlOut.Append("<td>SHOT3</td>")
                        htmlOut.Append("<td>SHOT4</td>")
                        htmlOut.Append("<td>HOTSBY</td>") 'ac_maint_hots_by_name

                        htmlOut.Append("<td>TBO1</td>")
                        htmlOut.Append("<td>TBO2</td>")
                        htmlOut.Append("<td>TBO3</td>")
                        htmlOut.Append("<td>TBO4</td>")

                        htmlOut.Append("<td>AVNCS</td>")
                        htmlOut.Append("<td>FDIR</td>")
                        htmlOut.Append("<td>AP</td>")
                        htmlOut.Append("<td>AFIS</td>")
                        htmlOut.Append("<td>FMS</td>")
                        htmlOut.Append("<td>GPS</td>")
                        htmlOut.Append("<td>INS</td>")
                        htmlOut.Append("<td>IRS</td>")
                        htmlOut.Append("<td>MAINTAINTED</td>")

                        htmlOut.Append("<td>IFC1</td>")
                        htmlOut.Append("<td>IFC1YN</td>")

                        htmlOut.Append("<td>IFC2</td>")
                        htmlOut.Append("<td>IFC2YN</td>")

                        htmlOut.Append("<td>IFC3</td>")
                        htmlOut.Append("<td>IFC3YN</td>")

                        htmlOut.Append("<td>IFC4</td>")
                        htmlOut.Append("<td>IFC4YN</td>")

                        htmlOut.Append("<td>IFC5</td>")
                        htmlOut.Append("<td>IFC5YN</td>")

                        htmlOut.Append("<td>IFC6</td>")
                        htmlOut.Append("<td>IFC6YN</td>")

                        htmlOut.Append("<td>EMP</td>")
                        htmlOut.Append("<td>TCDATE</td>")
                        htmlOut.Append("<td>EXTYR</td>")
                        htmlOut.Append("<td>INTYR</td>")

                        ' 02/20/2007 - By David D. Cruger; Added LifeCycle
                        htmlOut.Append("<td>LIFECYCLE</td>")

                        ' 03/05/2009 - By David D. Cruger; 
                        ' Added InFavorOf Name, DocDate, DocType and DocAmount
                        htmlOut.Append("<td>INFAVOROF</td>")
                        htmlOut.Append("<td>DOCDATE</td>")
                        htmlOut.Append("<td>DOCTYPE</td>")
                        htmlOut.Append("<td>DOCAMOUNT</td>")
                        htmlOut.Append("<td>LESSOR</td>")

                        htmlOut.Append("</tr>")

                    End If ' chkShowReportHeader.Checked

                ElseIf bHtmlReport Then

                    htmlOut.Append("<table class='centerTable' border='0' cellpadding='2' cellspacing='0' width='100%'><tr><td>")

                ElseIf bTextCommaReport Then

                    If chkShowReportHeader.Checked Then

                        htmlOut.Append(Constants.QUOTE + "AIRFRAMETYPE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "MAKETYPE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "MAKE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "MODEL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SERNBR" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "REGNBR" + Constants.QUOTE + Constants.cCommaDelim)

                        If Not bAerodexFlag Then
                            htmlOut.Append(Constants.QUOTE + "STATUS" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "ASKING" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "ASKINGAMT" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "DATELISTED" + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        htmlOut.Append(Constants.QUOTE + "DATEPURCHASED" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "DATECHANGED" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "COMP1RELATION" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMP1AGENCYTYPE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMP1BUSINESSTYPE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMP1NAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMP1ALTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMP1EMAIL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMP1WEBADDRESS" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMP1ADDRESS1" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMP1ADDRESS2" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMP1CITY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMP1STATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMP1STATEABBR" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMP1POSTALCODE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMP1COUNTRY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMP1OFFICE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMP1FAX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMP1MOBILE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACT1SALUTATION" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACT1FIRSTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACT1MIDDLE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACT1LASTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACT1SUFFIX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACT1TITLE" + Constants.QUOTE + Constants.cCommaDelim)   ' 01/13/2003 - By David D. Cruger; Added Contact Title
                        htmlOut.Append(Constants.QUOTE + "CONTACT1EMAIL" + Constants.QUOTE + Constants.cCommaDelim)   ' 01/29/2003 - By David D. Cruger; Added Contact EMail
                        htmlOut.Append(Constants.QUOTE + "CONTACT1OFFICE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACT1FAX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACT1MOBILE" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "COMP2RELATION" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMP2AGENCYTYPE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMP2BUSINESSTYPE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMP2NAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMP2ALTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMP2EMAIL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMP2WEBADDRESS" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMP2ADDRESS1" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMP2ADDRESS2" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMP2CITY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMP2STATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMP2STATEABBR" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMP2POSTALCODE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMP2COUNTRY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMP2OFFICE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMP2FAX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMP2MOBILE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACT2SALUTATION" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACT2FIRSTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACT2MIDDLE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACT2LASTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACT2SUFFIX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACT2TITLE" + Constants.QUOTE + Constants.cCommaDelim)   ' 01/13/2003 - By David D. Cruger; Added Contact Title
                        htmlOut.Append(Constants.QUOTE + "CONTACT2EMAIL" + Constants.QUOTE + Constants.cCommaDelim)   ' 01/29/2003 - By David D. Cruger; Added Contact EMail
                        htmlOut.Append(Constants.QUOTE + "CONTACT2OFFICE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACT2FAX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACT2MOBILE" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "CHPILOTCOMPRELATION" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CHPILOTCOMPAGENCYTYPE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CHPILOTCOMPBUSINESSTYPE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CHPILOTCOMPNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CHPILOTCOMPALTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CHPILOTCOMPEMAIL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CHPILOTCOMPWEBADDRESS" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CHPILOTCOMPADDRESS1" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CHPILOTCOMPADDRESS2" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CHPILOTCOMPCITY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CHPILOTCOMPSTATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CHPILOTCOMPSTATEABBR" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CHPILOTCOMPPOSTALCODE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CHPILOTCOMPCOUNTRY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CHPILOTCOMPOFFICE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CHPILOTCOMPFAX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CHPILOTCOMPMOBILE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CHPILOTSALUTATION" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CHPILOTFIRSTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CHPILOTMIDDLE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CHPILOTLASTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CHPILOTSUFFIX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CHPILOTTITLE" + Constants.QUOTE + Constants.cCommaDelim)   ' 01/13/2003 - By David D. Cruger; Added Contact Title
                        htmlOut.Append(Constants.QUOTE + "CHPILOTEMAIL" + Constants.QUOTE + Constants.cCommaDelim)   ' 01/29/2003 - By David D. Cruger; Added Contact EMail
                        htmlOut.Append(Constants.QUOTE + "CHPILOTOFFICE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CHPILOTFAX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CHPILOTMOBILE" + Constants.QUOTE + Constants.cCommaDelim)

                        If Session.Item("localPreferences").AerodexFlag = False Then
                            htmlOut.Append(Constants.QUOTE + "EXCBROKERCOMPRELATION" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "EXCBROKERCOMPAGENCYTYPE" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "EXCBROKERCOMPBUSINESSTYPE" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "EXCBROKERCOMPNAME" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "EXCBROKERCOMPALTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "EXCBROKERCOMPEMAIL" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "EXCBROKERCOMPWEBADDRESS" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "EXCBROKERCOMPADDRESS1" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "EXCBROKERCOMPADDRESS2" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "EXCBROKERCOMPCITY" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "EXCBROKERCOMPSTATE" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "EXCBROKERCOMPSTATEABBR" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "EXCBROKERCOMPPOSTALCODE" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "EXCBROKERCOMPCOUNTRY" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "EXCBROKERCOMPOFFICE" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "EXCBROKERCOMPFAX" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "EXCBROKERCOMPMOBILE" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "EXCBROKERSALUTATION" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "EXCBROKERFIRSTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "EXCBROKERMIDDLE" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "EXCBROKERLASTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "EXCBROKERSUFFIX" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "EXCBROKERTITLE" + Constants.QUOTE + Constants.cCommaDelim)   ' 01/13/2003 - By David D. Cruger; Added Contact Title
                            htmlOut.Append(Constants.QUOTE + "EXCBROKEREMAIL" + Constants.QUOTE + Constants.cCommaDelim)   ' 01/29/2003 - By David D. Cruger; Added Contact EMail
                            htmlOut.Append(Constants.QUOTE + "EXCBROKEROFFICE" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "EXCBROKERFAX" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "EXCBROKERMOBILE" + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        htmlOut.Append(Constants.QUOTE + "YEARMFG" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "YEARDLV" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BASEIATA" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BASEICAO" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BASENAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BASECITY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BASESTATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BASECOUNTRY" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "AFTT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "LANDINGS" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "MXPROG" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PASSGR" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "ENGMODEL" + Constants.QUOTE + Constants.cCommaDelim)

                        ' 03/28/2006 - By David D. Cruger
                        ' Added Engine SerNbr 1,2,3,4              
                        htmlOut.Append(Constants.QUOTE + "ENGSERNBR1" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "ENGSERNBR2" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "ENGSERNBR3" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "ENGSERNBR4" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "ENGTT1" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "ENGTT2" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "ENGTT3" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "ENGTT4" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "SMOH1" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SMOH2" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SMOH3" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SMOH4" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "EOHBY" + Constants.QUOTE + Constants.cCommaDelim)  'ac_maint_eoh_by_name

                        htmlOut.Append(Constants.QUOTE + "SHOT1" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SHOT2" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SHOT3" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SHOT4" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "HOTSBY" + Constants.QUOTE + Constants.cCommaDelim) 'ac_maint_hots_by_name

                        htmlOut.Append(Constants.QUOTE + "TBO1" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "TBO2" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "TBO3" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "TBO4" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "AVNCS" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "FDIR" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "AP" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "AFIS" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "FMS" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "GPS" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "INS" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "IRS" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "MAINTAINTED" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "IFC1" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "IFC1YN" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "IFC2" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "IFC2YN" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "IFC3" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "IFC3YN" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "IFC4" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "IFC4YN" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "IFC5" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "IFC5YN" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "IFC6" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "IFC6YN" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "EMP" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "TCDATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "EXTYR" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "INTYR" + Constants.QUOTE + Constants.cCommaDelim)

                        ' 02/20/2007 - By David D. Cruger; Added LifeCycle
                        htmlOut.Append(Constants.QUOTE + "LIFECYCLE" + Constants.QUOTE + Constants.cCommaDelim)

                        ' 03/05/2009 - By David D. Cruger; 
                        ' Added InFavorOf Name, DocDate, DocType and DocAmount
                        htmlOut.Append(Constants.QUOTE + "INFAVOROF" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "DOCDATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "DOCTYPE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "DOCAMOUNT" + Constants.QUOTE) ' Last Field Does Not Get Delimiter

                        htmlOut.Append(vbCrLf)

                    End If ' If b_ShowHeaderRow = "Yes" Then

                ElseIf bTextTabReport Then ' optFormat="Text (Tab Delimited)"

                    If chkShowReportHeader.Checked Then

                        htmlOut.Append("AIRFRAMETYPE" + vbTab)
                        htmlOut.Append("MAKETYPE" + vbTab)
                        htmlOut.Append("MAKE" + vbTab)
                        htmlOut.Append("MODEL" + vbTab)
                        htmlOut.Append("SERNBR" + vbTab)
                        htmlOut.Append("REGNBR" + vbTab)

                        If Not bAerodexFlag Then
                            htmlOut.Append("STATUS" + vbTab)
                            htmlOut.Append("ASKING" + vbTab)
                            htmlOut.Append("ASKINGAMT" + vbTab)
                            htmlOut.Append("DATELISTED" + vbTab)
                        End If

                        htmlOut.Append("DATEPURCHASED" + vbTab)
                        htmlOut.Append("DATECHANGED" + vbTab)

                        htmlOut.Append("COMP1RELATION" + vbTab)
                        htmlOut.Append("COMP1AGENCYTYPE" + vbTab)
                        htmlOut.Append("COMP1BUSINESSTYPE" + vbTab)
                        htmlOut.Append("COMP1NAME" + vbTab)
                        htmlOut.Append("COMP1ALTNAME" + vbTab)
                        htmlOut.Append("COMP1EMAIL" + vbTab)
                        htmlOut.Append("COMP1WEBADDRESS" + vbTab)
                        htmlOut.Append("COMP1ADDRESS1" + vbTab)
                        htmlOut.Append("COMP1ADDRESS2" + vbTab)
                        htmlOut.Append("COMP1CITY" + vbTab)
                        htmlOut.Append("COMP1STATE" + vbTab)
                        htmlOut.Append("COMP1STATEABBR" + vbTab)
                        htmlOut.Append("COMP1POSTALCODE" + vbTab)
                        htmlOut.Append("COMP1COUNTRY" + vbTab)
                        htmlOut.Append("COMP1OFFICE" + vbTab)
                        htmlOut.Append("COMP1FAX" + vbTab)
                        htmlOut.Append("COMP1MOBILE" + vbTab)
                        htmlOut.Append("CONTACT1SALUTATION" + vbTab)
                        htmlOut.Append("CONTACT1FIRSTNAME" + vbTab)
                        htmlOut.Append("CONTACT1MIDDLE" + vbTab)
                        htmlOut.Append("CONTACT1LASTNAME" + vbTab)
                        htmlOut.Append("CONTACT1SUFFIX" + vbTab)
                        htmlOut.Append("CONTACT1TITLE" + vbTab)   ' 01/13/2003 - By David D. Cruger; Added Contact Title
                        htmlOut.Append("CONTACT1EMAIL" + vbTab)   ' 01/29/2003 - By David D. Cruger; Added Contact EMail
                        htmlOut.Append("CONTACT1OFFICE" + vbTab)
                        htmlOut.Append("CONTACT1FAX" + vbTab)
                        htmlOut.Append("CONTACT1MOBILE" + vbTab)

                        htmlOut.Append("COMP2RELATION" + vbTab)
                        htmlOut.Append("COMP2AGENCYTYPE" + vbTab)
                        htmlOut.Append("COMP2BUSINESSTYPE" + vbTab)
                        htmlOut.Append("COMP2NAME" + vbTab)
                        htmlOut.Append("COMP2ALTNAME" + vbTab)
                        htmlOut.Append("COMP2EMAIL" + vbTab)
                        htmlOut.Append("COMP2WEBADDRESS" + vbTab)
                        htmlOut.Append("COMP2ADDRESS1" + vbTab)
                        htmlOut.Append("COMP2ADDRESS2" + vbTab)
                        htmlOut.Append("COMP2CITY" + vbTab)
                        htmlOut.Append("COMP2STATE" + vbTab)
                        htmlOut.Append("COMP2STATEABBR" + vbTab)
                        htmlOut.Append("COMP2POSTALCODE" + vbTab)
                        htmlOut.Append("COMP2COUNTRY" + vbTab)
                        htmlOut.Append("COMP2OFFICE" + vbTab)
                        htmlOut.Append("COMP2FAX" + vbTab)
                        htmlOut.Append("COMP2MOBILE" + vbTab)
                        htmlOut.Append("CONTACT2SALUTATION" + vbTab)
                        htmlOut.Append("CONTACT2FIRSTNAME" + vbTab)
                        htmlOut.Append("CONTACT2MIDDLE" + vbTab)
                        htmlOut.Append("CONTACT2LASTNAME" + vbTab)
                        htmlOut.Append("CONTACT2SUFFIX" + vbTab)
                        htmlOut.Append("CONTACT2TITLE" + vbTab)   ' 01/13/2003 - By David D. Cruger; Added Contact Title
                        htmlOut.Append("CONTACT2EMAIL" + vbTab)   ' 01/29/2003 - By David D. Cruger; Added Contact EMail
                        htmlOut.Append("CONTACT2OFFICE" + vbTab)
                        htmlOut.Append("CONTACT2FAX" + vbTab)
                        htmlOut.Append("CONTACT2MOBILE" + vbTab)

                        htmlOut.Append("CHPILOTCOMPRELATION" + vbTab)
                        htmlOut.Append("CHPILOTCOMPAGENCYTYPE" + vbTab)
                        htmlOut.Append("CHPILOTCOMPBUSINESSTYPE" + vbTab)
                        htmlOut.Append("CHPILOTCOMPNAME" + vbTab)
                        htmlOut.Append("CHPILOTCOMPALTNAME" + vbTab)
                        htmlOut.Append("CHPILOTCOMPEMAIL" + vbTab)
                        htmlOut.Append("CHPILOTCOMPWEBADDRESS" + vbTab)
                        htmlOut.Append("CHPILOTCOMPADDRESS1" + vbTab)
                        htmlOut.Append("CHPILOTCOMPADDRESS2" + vbTab)
                        htmlOut.Append("CHPILOTCOMPCITY" + vbTab)
                        htmlOut.Append("CHPILOTCOMPSTATE" + vbTab)
                        htmlOut.Append("CHPILOTCOMPSTATEABBR" + vbTab)
                        htmlOut.Append("CHPILOTCOMPPOSTALCODE" + vbTab)
                        htmlOut.Append("CHPILOTCOMPCOUNTRY" + vbTab)
                        htmlOut.Append("CHPILOTCOMPOFFICE" + vbTab)
                        htmlOut.Append("CHPILOTCOMPFAX" + vbTab)
                        htmlOut.Append("CHPILOTCOMPMOBILE" + vbTab)
                        htmlOut.Append("CHPILOTSALUTATION" + vbTab)
                        htmlOut.Append("CHPILOTFIRSTNAME" + vbTab)
                        htmlOut.Append("CHPILOTMIDDLE" + vbTab)
                        htmlOut.Append("CHPILOTLASTNAME" + vbTab)
                        htmlOut.Append("CHPILOTSUFFIX" + vbTab)
                        htmlOut.Append("CHPILOTTITLE" + vbTab)   ' 01/13/2003 - By David D. Cruger; Added Contact Title
                        htmlOut.Append("CHPILOTEMAIL" + vbTab)   ' 01/29/2003 - By David D. Cruger; Added Contact EMail
                        htmlOut.Append("CHPILOTOFFICE" + vbTab)
                        htmlOut.Append("CHPILOTFAX" + vbTab)
                        htmlOut.Append("CHPILOTMOBILE" + vbTab)

                        If Session.Item("localPreferences").AerodexFlag = False Then
                            htmlOut.Append("EXCBROKERCOMPRELATION" + vbTab)
                            htmlOut.Append("EXCBROKERCOMPAGENCYTYPE" + vbTab)
                            htmlOut.Append("EXCBROKERCOMPBUSINESSTYPE" + vbTab)
                            htmlOut.Append("EXCBROKERCOMPNAME" + vbTab)
                            htmlOut.Append("EXCBROKERCOMPALTNAME" + vbTab)
                            htmlOut.Append("EXCBROKERCOMPEMAIL" + vbTab)
                            htmlOut.Append("EXCBROKERCOMPWEBADDRESS" + vbTab)
                            htmlOut.Append("EXCBROKERCOMPADDRESS1" + vbTab)
                            htmlOut.Append("EXCBROKERCOMPADDRESS2" + vbTab)
                            htmlOut.Append("EXCBROKERCOMPCITY" + vbTab)
                            htmlOut.Append("EXCBROKERCOMPSTATE" + vbTab)
                            htmlOut.Append("EXCBROKERCOMPSTATEABBR" + vbTab)
                            htmlOut.Append("EXCBROKERCOMPPOSTALCODE" + vbTab)
                            htmlOut.Append("EXCBROKERCOMPCOUNTRY" + vbTab)
                            htmlOut.Append("EXCBROKERCOMPOFFICE" + vbTab)
                            htmlOut.Append("EXCBROKERCOMPFAX" + vbTab)
                            htmlOut.Append("EXCBROKERCOMPMOBILE" + vbTab)
                            htmlOut.Append("EXCBROKERSALUTATION" + vbTab)
                            htmlOut.Append("EXCBROKERFIRSTNAME" + vbTab)
                            htmlOut.Append("EXCBROKERMIDDLE" + vbTab)
                            htmlOut.Append("EXCBROKERLASTNAME" + vbTab)
                            htmlOut.Append("EXCBROKERSUFFIX" + vbTab)
                            htmlOut.Append("EXCBROKERTITLE" + vbTab)   ' 01/13/2003 - By David D. Cruger; Added Contact Title
                            htmlOut.Append("EXCBROKEREMAIL" + vbTab)   ' 01/29/2003 - By David D. Cruger; Added Contact EMail
                            htmlOut.Append("EXCBROKEROFFICE" + vbTab)
                            htmlOut.Append("EXCBROKERFAX" + vbTab)
                            htmlOut.Append("EXCBROKERMOBILE" + vbTab)
                        End If

                        htmlOut.Append("YEARMFG" + vbTab)
                        htmlOut.Append("YEARDLV" + vbTab)
                        htmlOut.Append("BASEIATA" + vbTab)
                        htmlOut.Append("BASEICAO" + vbTab)
                        htmlOut.Append("BASENAME" + vbTab)
                        htmlOut.Append("BASECITY" + vbTab)
                        htmlOut.Append("BASESTATE" + vbTab)
                        htmlOut.Append("BASECOUNTRY" + vbTab)

                        htmlOut.Append("AFTT" + vbTab)
                        htmlOut.Append("LANDINGS" + vbTab)
                        htmlOut.Append("MXPROG" + vbTab)
                        htmlOut.Append("PASSGR" + vbTab)
                        htmlOut.Append("ENGMODEL" + vbTab)

                        ' 03/28/2006 - By David D. Cruger
                        ' Added Engine SerNbr 1,2,3,4              
                        htmlOut.Append("ENGSERNBR1" + vbTab)
                        htmlOut.Append("ENGSERNBR2" + vbTab)
                        htmlOut.Append("ENGSERNBR3" + vbTab)
                        htmlOut.Append("ENGSERNBR4" + vbTab)

                        htmlOut.Append("ENGTT1" + vbTab)
                        htmlOut.Append("ENGTT2" + vbTab)
                        htmlOut.Append("ENGTT3" + vbTab)
                        htmlOut.Append("ENGTT4" + vbTab)

                        htmlOut.Append("SMOH1" + vbTab)
                        htmlOut.Append("SMOH2" + vbTab)
                        htmlOut.Append("SMOH3" + vbTab)
                        htmlOut.Append("SMOH4" + vbTab)
                        htmlOut.Append("EOHBY" + vbTab)  'ac_maint_eoh_by_name

                        htmlOut.Append("SHOT1" + vbTab)
                        htmlOut.Append("SHOT2" + vbTab)
                        htmlOut.Append("SHOT3" + vbTab)
                        htmlOut.Append("SHOT4" + vbTab)
                        htmlOut.Append("HOTSBY" + vbTab) 'ac_maint_hots_by_name

                        htmlOut.Append("TBO1" + vbTab)
                        htmlOut.Append("TBO2" + vbTab)
                        htmlOut.Append("TBO3" + vbTab)
                        htmlOut.Append("TBO4" + vbTab)

                        htmlOut.Append("AVNCS" + vbTab)
                        htmlOut.Append("FDIR" + vbTab)
                        htmlOut.Append("AP" + vbTab)
                        htmlOut.Append("AFIS" + vbTab)
                        htmlOut.Append("FMS" + vbTab)
                        htmlOut.Append("GPS" + vbTab)
                        htmlOut.Append("INS" + vbTab)
                        htmlOut.Append("IRS" + vbTab)
                        htmlOut.Append("MAINTAINTED" + vbTab)

                        htmlOut.Append("IFC1" + vbTab)
                        htmlOut.Append("IFC1YN" + vbTab)

                        htmlOut.Append("IFC2" + vbTab)
                        htmlOut.Append("IFC2YN" + vbTab)

                        htmlOut.Append("IFC3" + vbTab)
                        htmlOut.Append("IFC3YN" + vbTab)

                        htmlOut.Append("IFC4" + vbTab)
                        htmlOut.Append("IFC4YN" + vbTab)

                        htmlOut.Append("IFC5" + vbTab)
                        htmlOut.Append("IFC5YN" + vbTab)

                        htmlOut.Append("IFC6" + vbTab)
                        htmlOut.Append("IFC6YN" + vbTab)

                        htmlOut.Append("EMP" + vbTab)
                        htmlOut.Append("TCDATE" + vbTab)
                        htmlOut.Append("EXTYR" + vbTab)
                        htmlOut.Append("INTYR" + vbTab)

                        ' 02/20/2007 - By David D. Cruger; Added LifeCycle
                        htmlOut.Append("LIFECYCLE" + vbTab)

                        ' 03/05/2009 - By David D. Cruger; 
                        ' Added InFavorOf Name, DocDate, DocType and DocAmount
                        htmlOut.Append("INFAVOROF" + vbTab)
                        htmlOut.Append("DOCDATE" + vbTab)
                        htmlOut.Append("DOCTYPE" + vbTab)
                        htmlOut.Append("DOCAMOUNT")  ' Last Field Does Not Get Delimiter

                        htmlOut.Append(vbCrLf)

                    End If ' If b_ShowHeaderRow = "Yes" Then

                End If
                Dim tstCount As Long = 0

                For Each Row As DataRow In report_8_datatable.Rows

                    tstCount += 1

                    If bExcelReport Then

                        htmlOut.Append("<tr>")

                        ' 07/30/2010 - BY David D. Cruger
                        ' Removed the &nbsp; for Excel Export
                        ' It causes problems with sorting

                        ' AIRFRAMETYPE - 03/14/2013 - By David D. Cruger; Added
                        htmlOut.Append("<td>" + Row.Item("amod_airframe_type_code").ToString.Trim + "</td>")

                        ' MAKETYPE - 04/26/2006 - By David D. Cruger; Added
                        htmlOut.Append("<td>" + Row.Item("amod_type_code").ToString.Trim + "</td>")

                        ' MAKE
                        htmlOut.Append("<td>" + Row.Item("amod_make_name").ToString.Trim + "</td>")

                        ' MODEL
                        htmlOut.Append("<td class='textformat'>" + Row.Item("amod_model_name").ToString.Trim + "</td>")

                        ' SERNBR
                        htmlOut.Append("<td class='textformat'>" + Row.Item("ac_ser_no_full").ToString.Trim + "</td>")

                        ' REGNBR
                        htmlOut.Append("<td class='textformat'>" + Row.Item("ac_reg_no").ToString.Trim + "</td>")

                        If Not bAerodexFlag Then

                            ' STATUS 
                            If Not IsDBNull(Row.Item("ac_status")) Then
                                htmlOut.Append("<td>" + Row.Item("ac_status").ToString.Trim + "</td>")
                            Else
                                htmlOut.Append("<td></td>")
                            End If

                            ' ASKING
                            If Not IsDBNull(Row.Item("ac_asking_price")) Then
                                htmlOut.Append("<td>" + Row.Item("ac_asking").ToString.Trim + "</td>")
                            Else
                                htmlOut.Append("<td></td>")
                            End If

                            ' ASKINGAMT
                            If Not IsDBNull(Row.Item("ac_asking_price")) Then
                                If Not String.IsNullOrEmpty(Row.Item("ac_asking_price").ToString.Trim) Then

                                    If CLng(Row.Item("ac_asking_price").ToString) > 0 Then
                                        htmlOut.Append("<td>$" + FormatNumber(Row.Item("ac_asking_price").ToString, 0, False, False, True) + "</td>")
                                    End If

                                Else
                                    htmlOut.Append("<td></td>")
                                End If
                            Else
                                htmlOut.Append("<td></td>")
                            End If

                            ' DATELISTED 
                            If Not IsDBNull(Row.Item("ac_list_date")) Then
                                If Not String.IsNullOrEmpty(Row.Item("ac_list_date").ToString.Trim) Then
                                    htmlOut.Append("<td class='dateformat'>" + FormatDateTime(Row.Item("ac_list_date").ToString, DateFormat.ShortDate) + "</td>")
                                Else
                                    htmlOut.Append("<td></td>")
                                End If
                            Else
                                htmlOut.Append("<td></td>")
                            End If

                        End If ' If Aerodex = False Then

                        ' DATEPURCHASED - 04/26/2006 - By David D. Cruger; Added 
                        If Not IsDBNull(Row.Item("ac_purchase_date")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_purchase_date").ToString.Trim) Then
                                htmlOut.Append("<td class='dateformat'>" + FormatDateTime(Row.Item("ac_purchase_date").ToString, DateFormat.ShortDate) + "</td>")
                            Else
                                htmlOut.Append("<td></td>")
                            End If
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        ' DATECHANGED - 04/26/2006 - By David D. Cruger; Added
                        If Not IsDBNull(Row.Item("ac_upd_date")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_upd_date").ToString.Trim) Then
                                htmlOut.Append("<td class='dateformat'>" + FormatDateTime(Row.Item("ac_upd_date").ToString, DateFormat.ShortDate) + "</td>")
                            Else
                                htmlOut.Append("<td></td>")
                            End If
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        lCompOwrId = 0
                        lCompOprId = 0
                        lCompChpId = 0
                        lCompExcId = 0

                        lContactOwrId = 0
                        lContactOprId = 0
                        lContactChpId = 0
                        lContactExcId = 0

                        Dim report_8_ref_datatable As DataTable = Nothing

                        ' OWNER
                        htmlOut.Append(get_company_contact_info_report_8(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id")), "OWR", report_8_ref_datatable, lCompOwrId, lContactOwrId))

                        ' OPERATOR
                        htmlOut.Append(get_company_contact_info_report_8(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id")), "OPR", report_8_ref_datatable, lCompOprId, lContactOprId))

                        ' CHIEF PILOT
                        htmlOut.Append(get_company_contact_info_report_8(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id")), "CHP", report_8_ref_datatable, lCompChpId, lContactChpId))

                        If Session.Item("localPreferences").AerodexFlag = False Then
                            ' EXCLUSIVE BROKER
                            htmlOut.Append(get_company_contact_info_report_8(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id")), "EXC", report_8_ref_datatable, lCompExcId, lContactExcId))
                        End If

                        report_8_ref_datatable = Nothing

                        ' YEARMFG
                        If Not IsDBNull(Row.Item("ac_mfr_year")) Then
                            htmlOut.Append("<td>" + Row.Item("ac_mfr_year").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If


                        ' YEARDLV 
                        If Not IsDBNull(Row.Item("ac_year")) Then
                            htmlOut.Append("<td>" + Row.Item("ac_year").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        ' BASEIATA 
                        If Not IsDBNull(Row.Item("ac_aport_iata_code")) Then
                            htmlOut.Append("<td>" + Row.Item("ac_aport_iata_code").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        ' BASEICAO 
                        If Not IsDBNull(Row.Item("ac_aport_icao_code")) Then
                            htmlOut.Append("<td>" + Row.Item("ac_aport_icao_code").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        ' BASENAME 
                        If Not IsDBNull(Row.Item("ac_aport_name")) Then
                            htmlOut.Append("<td>" + Row.Item("ac_aport_name").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        ' BASECITY 
                        If Not IsDBNull(Row.Item("ac_aport_city")) Then
                            htmlOut.Append("<td>" + Row.Item("ac_aport_city").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        ' BASESTATE 
                        If Not IsDBNull(Row.Item("ac_aport_state")) Then
                            htmlOut.Append("<td>" + Row.Item("ac_aport_state").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        ' BASECOUNTRY 
                        If Not IsDBNull(Row.Item("ac_aport_country")) Then
                            htmlOut.Append("<td>" + Row.Item("ac_aport_country").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        ' AFTT 
                        If Not IsDBNull(Row.Item("ac_airframe_tot_hrs")) Then
                            htmlOut.Append("<td>" + Row.Item("ac_airframe_tot_hrs").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        ' LANDINGS 
                        If Not IsDBNull(Row.Item("ac_airframe_tot_landings")) Then
                            htmlOut.Append("<td>" + Row.Item("ac_airframe_tot_landings").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        ' MXPROG = Airframe Maintenance Program
                        htmlOut.Append("<td>")

                        If Not IsDBNull(Row.Item("amp_provider_name")) Then
                            htmlOut.Append(Row.Item("amp_provider_name").ToString.Trim)
                        End If

                        If Not IsDBNull(Row.Item("amp_program_name")) Then
                            If Not IsDBNull(Row.Item("amp_provider_name")) Then htmlOut.Append(" ")

                            htmlOut.Append(Row.Item("amp_program_name").ToString.Trim)
                        End If

                        htmlOut.Append("</td>")

                        ' PASSGR 
                        If Not IsDBNull(Row.Item("ac_passenger_count")) Then
                            htmlOut.Append("<td>" + Row.Item("ac_passenger_count").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        ' ENGMODEL 
                        If Not IsDBNull(Row.Item("ac_engine_name")) Then
                            htmlOut.Append("<td nowrap='nowrap'>" + Row.Item("ac_engine_name").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        ' 03/28/2006 - By David D. Cruger; Added
                        ' ENGSERNBR1,2,3,4
                        If Not IsDBNull(Row.Item("ac_engine_1_ser_no")) Then
                            htmlOut.Append("<td nowrap='nowrap'>" + Row.Item("ac_engine_1_ser_no").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        If Not IsDBNull(Row.Item("ac_engine_2_ser_no")) Then
                            htmlOut.Append("<td nowrap='nowrap'>" + Row.Item("ac_engine_2_ser_no").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        If Not IsDBNull(Row.Item("ac_engine_3_ser_no")) Then
                            htmlOut.Append("<td nowrap='nowrap'>" + Row.Item("ac_engine_3_ser_no").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        If Not IsDBNull(Row.Item("ac_engine_4_ser_no")) Then
                            htmlOut.Append("<td nowrap='nowrap'>" + Row.Item("ac_engine_4_ser_no").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        ' ENGTT1,2,3,4
                        If Not IsDBNull(Row.Item("ac_engine_1_tot_hrs")) Then
                            htmlOut.Append("<td>" + Row.Item("ac_engine_1_tot_hrs").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        If Not IsDBNull(Row.Item("ac_engine_2_tot_hrs")) Then
                            htmlOut.Append("<td>" + Row.Item("ac_engine_2_tot_hrs").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        If Not IsDBNull(Row.Item("ac_engine_3_tot_hrs")) Then
                            htmlOut.Append("<td>" + Row.Item("ac_engine_3_tot_hrs").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        If Not IsDBNull(Row.Item("ac_engine_4_tot_hrs")) Then
                            htmlOut.Append("<td>" + Row.Item("ac_engine_4_tot_hrs").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        ' SMOH1,2,3,4
                        If Not IsDBNull(Row.Item("ac_engine_1_soh_hrs")) Then
                            htmlOut.Append("<td>" + Row.Item("ac_engine_1_soh_hrs").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        If Not IsDBNull(Row.Item("ac_engine_2_soh_hrs")) Then
                            htmlOut.Append("<td>" + Row.Item("ac_engine_2_soh_hrs").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        If Not IsDBNull(Row.Item("ac_engine_3_soh_hrs")) Then
                            htmlOut.Append("<td>" + Row.Item("ac_engine_3_soh_hrs").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        If Not IsDBNull(Row.Item("ac_engine_4_soh_hrs")) Then
                            htmlOut.Append("<td>" + Row.Item("ac_engine_4_soh_hrs").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        ' EOHBY
                        If Not IsDBNull(Row.Item("ac_maint_eoh_by_name")) Then
                            htmlOut.Append("<td>" + Row.Item("ac_maint_eoh_by_name").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        ' SHOT1,2,3,4
                        If Not IsDBNull(Row.Item("ac_engine_1_shi_hrs")) Then
                            htmlOut.Append("<td>" + Row.Item("ac_engine_1_shi_hrs").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        If Not IsDBNull(Row.Item("ac_engine_2_shi_hrs")) Then
                            htmlOut.Append("<td>" + Row.Item("ac_engine_2_shi_hrs").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        If Not IsDBNull(Row.Item("ac_engine_3_shi_hrs")) Then
                            htmlOut.Append("<td>" + Row.Item("ac_engine_3_shi_hrs").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        If Not IsDBNull(Row.Item("ac_engine_4_shi_hrs")) Then
                            htmlOut.Append("<td>" + Row.Item("ac_engine_4_shi_hrs").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        ' HOTSBY
                        If Not IsDBNull(Row.Item("ac_maint_hots_by_name")) Then
                            htmlOut.Append("<td>" + Row.Item("ac_maint_hots_by_name").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        ' TBO1,2,3,4
                        If Not IsDBNull(Row.Item("ac_engine_1_tbo_hrs")) Then
                            htmlOut.Append("<td>" + Row.Item("ac_engine_1_tbo_hrs").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td>&nbsp;</td>")
                        End If

                        If Not IsDBNull(Row.Item("ac_engine_2_tbo_hrs")) Then
                            htmlOut.Append("<td>" + Row.Item("ac_engine_2_tbo_hrs").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        If Not IsDBNull(Row.Item("ac_engine_3_tbo_hrs")) Then
                            htmlOut.Append("<td>" + Row.Item("ac_engine_3_tbo_hrs").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        If Not IsDBNull(Row.Item("ac_engine_4_tbo_hrs")) Then
                            htmlOut.Append("<td>" + Row.Item("ac_engine_4_tbo_hrs").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        ' AVNCS
                        If Not IsDBNull(Row.Item("ac_avionics_avpackage")) Then
                            htmlOut.Append("<td>" + Row.Item("ac_avionics_avpackage").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        ' FDIR
                        If Not IsDBNull(Row.Item("ac_avionics_flightdir")) Then
                            htmlOut.Append("<td>" + Row.Item("ac_avionics_flightdir").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        ' AP
                        If Not IsDBNull(Row.Item("ac_avionics_autopilot")) Then
                            htmlOut.Append("<td>" + Row.Item("ac_avionics_autopilot").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        ' AFIS
                        If Not IsDBNull(Row.Item("ac_avionics_afis")) Then
                            htmlOut.Append("<td>" + Row.Item("ac_avionics_afis").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        ' FMS
                        If Not IsDBNull(Row.Item("ac_avionics_fms")) Then
                            htmlOut.Append("<td>" + Row.Item("ac_avionics_fms").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        ' GPS
                        If Not IsDBNull(Row.Item("ac_avionics_gps")) Then
                            htmlOut.Append("<td>" + Row.Item("ac_avionics_gps").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        ' INS
                        If Not IsDBNull(Row.Item("ac_avionics_ins")) Then
                            htmlOut.Append("<td>" + Row.Item("ac_avionics_ins").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        ' IRS
                        If Not IsDBNull(Row.Item("ac_avionics_irs")) Then
                            htmlOut.Append("<td>" + Row.Item("ac_avionics_irs").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        ' MAINTAINED
                        If Not IsDBNull(Row.Item("ac_maintained")) Then
                            htmlOut.Append("<td>" + Row.Item("ac_maintained").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        get_top_six_feature_codes_report_8(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id").ToString), strF1, strF2, strF3, strF4, strF5, strF6)

                        ' FEATURE CODE 1
                        htmlOut.Append("<td>" + Left(strF1, 3) + "</td>")
                        htmlOut.Append("<td>" + Mid(strF1, 4, 1) + "</td>")

                        ' FEATURE CODE 2
                        htmlOut.Append("<td>" + Left(strF2, 3) + "</td>")
                        htmlOut.Append("<td>" + Mid(strF2, 4, 1) + "</td>")

                        ' FEATURE CODE 3
                        htmlOut.Append("<td>" + Left(strF3, 3) + "</td>")
                        htmlOut.Append("<td>" + Mid(strF3, 4, 1) + "</td>")

                        ' FEATURE CODE 4
                        htmlOut.Append("<td>" + Left(strF4, 3) + "</td>")
                        htmlOut.Append("<td>" + Mid(strF4, 4, 1) + "</td>")

                        ' FEATURE CODE 5
                        htmlOut.Append("<td>" + Left(strF5, 3) + "</td>")
                        htmlOut.Append("<td>" + Mid(strF5, 4, 1) + "</td>")

                        ' FEATURE CODE 6
                        htmlOut.Append("<td>" + Left(strF6, 3) + "</td>")
                        htmlOut.Append("<td>" + Mid(strF6, 4, 1) + "</td>")

                        ' EMP = Engine Maintenance Program
                        htmlOut.Append("<td>")

                        If Not IsDBNull(Row.Item("emp_provider_name")) Then
                            htmlOut.Append(Row.Item("emp_provider_name").ToString.Trim)

                        End If

                        If Not IsDBNull(Row.Item("emp_program_name")) Then
                            If Not IsDBNull(Row.Item("emp_provider_name")) Then htmlOut.Append(" ")

                            htmlOut.Append(Row.Item("emp_program_name").ToString.Trim)
                        End If

                        htmlOut.Append("</td>")

                        ' TCDATE
                        If Not IsDBNull(Row.Item("ac_times_as_of_date")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_times_as_of_date").ToString.Trim) Then
                                htmlOut.Append("<td class='dateformat'>" + FormatDateTime(Row.Item("ac_times_as_of_date").ToString, DateFormat.ShortDate) + "</td>")
                            Else
                                htmlOut.Append("<td></td>")
                            End If
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        ' EXTYR
                        If Not IsDBNull(Row.Item("ac_exterior_moyear")) Then
                            If Row.Item("ac_exterior_moyear").ToString.Trim.Length > 4 Then
                                htmlOut.Append("<td class='textformat'>" + Left(Row.Item("ac_exterior_moyear").ToString.Trim, 2) + "/")
                                htmlOut.Append(Right(Row.Item("ac_exterior_moyear").ToString.Trim, 4) + "</td>")
                            ElseIf Row.Item("ac_exterior_moyear").ToString.Trim.Length <= 2 Then
                                htmlOut.Append("<td class='textformat'>" + Left(Row.Item("ac_exterior_moyear"), 2) + "</td>")
                            ElseIf Row.Item("ac_exterior_moyear").ToString.Trim.Length = 4 Then
                                htmlOut.Append("<td class='textformat'>" + Right(Row.Item("ac_exterior_moyear"), 4) + "</td>")
                            End If
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        ' INTYR
                        If Not IsDBNull(Row.Item("ac_interior_moyear")) Then
                            If Row.Item("ac_interior_moyear").ToString.Trim.Length > 4 Then
                                htmlOut.Append("<td class='textformat'>" + Left(Row.Item("ac_interior_moyear").ToString.Trim, 2) + "/")
                                htmlOut.Append(Right(Row.Item("ac_interior_moyear").ToString.Trim, 4) + "</td>")
                            ElseIf Row.Item("ac_interior_moyear").ToString.Trim.Length <= 2 Then
                                htmlOut.Append("<td class='textformat'>" + Left(Row.Item("ac_interior_moyear"), 2) + "</td>")
                            ElseIf Row.Item("ac_interior_moyear").ToString.Trim.Length = 4 Then
                                htmlOut.Append("<td class='textformat'>" + Right(Row.Item("ac_interior_moyear"), 4) + "</td>")
                            End If
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        ' 02/20/2007 - By David D. Cruger; Added LifeCycle
                        htmlOut.Append("<td>" + localFunctions.get_lifecycle_stage_report(CInt(Row.Item("ac_lifecycle_stage").ToString), True) + "</td>")

                        ' 03/05/2009 - By David D. Cruger - Add, InFavorOfName, DocType, DocAmount        
                        htmlOut.Append(ReturnInFavorOfInformation(CLng(Row.Item("ac_id").ToString), lCompOwrId, False))

                        htmlOut.Append("<td class='textformat'>" + Row.Item("LESSOR") + "</td>")   ' added MSW - 7/13/19
                        htmlOut.Append("</tr>")

                    ElseIf bHtmlReport Then

                        htmlOut.Append("<table class='centerTable' border='1' cellspacing='0' cellpadding='2' width='100%'>")  ' Table #1

                        htmlOut.Append("<tr><td width='25%' valign='top' align='left'>") ' Table #1 - 1st Frame
                        htmlOut.Append("<table class='centerTable' border='0' width='100%' cellspacing='0' cellpadding='0'>") ' Table #2

                        htmlOut.Append("<tr>")
                        htmlOut.Append("<td width='50%' valign='top' align='left' nowrap='nowrap'><b>MAKE:</b>&nbsp;" + Row.Item("amod_make_name").ToString.Trim + "</td>")
                        htmlOut.Append("<td width='50%' valign='top' align='right' nowrap='nowrap'>&nbsp;<b>MODEL:</b>&nbsp;" + Row.Item("amod_model_name").ToString.Trim + "</td>")
                        htmlOut.Append("</tr>")

                        htmlOut.Append("<tr>")
                        htmlOut.Append("<td width='50%' valign='top' align='left' nowrap='nowrap'><b>SERNO:</b>&nbsp;" + Row.Item("ac_ser_no_full").ToString.Trim + "</td>")
                        htmlOut.Append("<td width='50%' valign='top' align='right' nowrap='nowrap'><b>REGNO:</b>&nbsp;" + Row.Item("ac_reg_no").ToString.Trim + "</td>")
                        htmlOut.Append("</tr>")

                        htmlOut.Append("</table>") ' Table #2

                        Dim report_8_ref_datatable As DataTable = Nothing

                        ' OWNER
                        htmlOut.Append(get_company_contact_info_report_8(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id")), "OWR", report_8_ref_datatable, lCompOwrId, lContactOwrId))

                        ' CHIEF PILOT
                        htmlOut.Append("<b>CHP:</b>&nbsp;" + get_company_contact_info_report_8(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id")), "CHP", report_8_ref_datatable, lCompChpId, lContactChpId))

                        If Not bAerodexFlag Then

                            If Not IsDBNull(Row.Item("ac_aport_iata_code")) Then
                                htmlOut.Append("<b>A/C BASE:</b>&nbsp;" + Row.Item("ac_aport_iata_code").ToString.Trim)
                            Else
                                htmlOut.Append("<b>A/C BASE:</b>")
                            End If

                            If Not IsDBNull(Row.Item("ac_aport_icao_code")) Then
                                htmlOut.Append("&nbsp;-&nbsp;" + Row.Item("ac_aport_icao_code").ToString.Trim + "<br />")
                            Else
                                htmlOut.Append("<br />")
                            End If

                            If Not IsDBNull(Row.Item("ac_aport_name")) Then
                                htmlOut.Append(Row.Item("ac_aport_name").ToString.Trim + "<br />")
                            Else
                                htmlOut.Append("<br />")
                            End If

                            If Not IsDBNull(Row.Item("ac_aport_city")) Then
                                htmlOut.Append(Row.Item("ac_aport_city").ToString.Trim + "&nbsp;")
                            End If

                            If Not IsDBNull(Row.Item("ac_aport_state")) Then
                                htmlOut.Append(Row.Item("ac_aport_state").ToString.Trim + "&nbsp;")
                            End If

                            If Not IsDBNull(Row.Item("ac_aport_country")) Then
                                htmlOut.Append(Row.Item("ac_aport_country").ToString.Trim)
                            End If

                        End If

                        htmlOut.Append("</td>")  ' Table #1 - 1st Frame
                        htmlOut.Append("<td width='25%' valign='top' align='left'>") ' Table #1 - 2nd Frame
                        htmlOut.Append("<table class='centerTable' border='0' width='100%' cellspacing='0' cellpadding='0'>") ' Table #3

                        htmlOut.Append("<tr><td width='50%' valign='top' align='left' nowrap='nowrap'>")
                        htmlOut.Append("<b>YR DL/MF:</b>")
                        ' YEARDLV 
                        If Not IsDBNull(Row.Item("ac_year")) Then
                            htmlOut.Append("&nbsp;" + Row.Item("ac_year").ToString.Trim)
                        End If

                        If Not IsDBNull(Row.Item("ac_mfr_year")) Then
                            htmlOut.Append("&nbsp;/&nbsp;" + Row.Item("ac_mfr_year").ToString.Trim)
                        End If

                        htmlOut.Append("</td>")

                        htmlOut.Append("<td width='50%' valign='top' align='right' nowrap='nowrap'>&nbsp;<b>REP&nbsp;PURCH:</b>&nbsp;")
                        ' DATEPURCHASED
                        If Not IsDBNull(Row.Item("ac_purchase_date")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_purchase_date").ToString.Trim) Then
                                htmlOut.Append(FormatDateTime(Row.Item("ac_purchase_date").ToString, DateFormat.ShortDate))
                            End If
                        End If

                        htmlOut.Append("</td></tr>")

                        If Not bAerodexFlag Then

                            htmlOut.Append("<tr><td width='50%' valign='top' align='left' nowrap='nowrap'>")
                            htmlOut.Append("<b>ASKING:</b>&nbsp;")

                            If Not bAerodexFlag Then
                                If Not IsDBNull(Row.Item("ac_asking_price")) Then
                                    If Row.Item("ac_asking").ToString.ToLower.Contains("price") Then
                                        If Not IsDBNull(Row.Item("ac_asking_price")) Then
                                            If CDbl(Row.Item("ac_asking_price").ToString) > 0 Then
                                                htmlOut.Append("$" + FormatNumber(CDbl(Row.Item("ac_asking_price").ToString), 0, False, False, True).ToString)
                                            End If
                                        End If
                                    Else
                                        If Not IsDBNull(Row.Item("ac_asking")) Then
                                            htmlOut.Append(Row.Item("ac_asking").ToString.Trim)
                                        End If
                                    End If
                                Else
                                    If Not IsDBNull(Row.Item("ac_asking")) Then
                                        htmlOut.Append(Row.Item("ac_asking").ToString.Trim)
                                    End If
                                End If
                            End If

                            htmlOut.Append("</td><td width='50%' valign='top' align='right' nowrap='nowrap'>")
                            htmlOut.Append("<b>LISTED:</b>&nbsp;")

                            ' DATELISTED 
                            If Not IsDBNull(Row.Item("ac_list_date")) Then
                                If Not String.IsNullOrEmpty(Row.Item("ac_list_date").ToString.Trim) Then
                                    htmlOut.Append(FormatDateTime(Row.Item("ac_list_date").ToString, DateFormat.ShortDate))
                                End If
                            End If

                            htmlOut.Append("</td></tr>")

                        End If ' If bAerodexFlag = False Then

                        htmlOut.Append("</table>") ' Table #3

                        ' OPERATOR
                        htmlOut.Append(get_company_contact_info_report_8(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id")), "OPR", report_8_ref_datatable, lCompOprId, lContactOprId))

                        If Not bAerodexFlag Then

                            ' EXCLUSIVE BROKER
                            htmlOut.Append("<b>EXC:</b>&nbsp;" + get_company_contact_info_report_8(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id")), "EXC", report_8_ref_datatable, lCompExcId, lContactExcId))

                        Else

                            If Not IsDBNull(Row.Item("ac_aport_iata_code")) Then
                                htmlOut.Append("<b>A/C BASE:</b>&nbsp;" + Row.Item("ac_aport_iata_code").ToString.Trim)
                            Else
                                htmlOut.Append("<b>A/C BASE:</b>")
                            End If

                            If Not IsDBNull(Row.Item("ac_aport_icao_code")) Then
                                htmlOut.Append("&nbsp;-&nbsp;" + Row.Item("ac_aport_icao_code").ToString.Trim + "<br />")
                            Else
                                htmlOut.Append("<br />")
                            End If

                            If Not IsDBNull(Row.Item("ac_aport_name")) Then
                                htmlOut.Append(Row.Item("ac_aport_name").ToString.Trim + "<br />")
                            Else
                                htmlOut.Append("<br />")
                            End If

                            If Not IsDBNull(Row.Item("ac_aport_city")) Then
                                htmlOut.Append(Row.Item("ac_aport_city").ToString.Trim + "&nbsp;")
                            End If

                            If Not IsDBNull(Row.Item("ac_aport_state")) Then
                                htmlOut.Append(Row.Item("ac_aport_state").ToString.Trim + "&nbsp;")
                            End If

                            If Not IsDBNull(Row.Item("ac_aport_country")) Then
                                htmlOut.Append(Row.Item("ac_aport_country").ToString.Trim)
                            End If

                        End If

                        htmlOut.Append("</td>") ' Table #1 - 2nd Frame

                        report_8_ref_datatable = Nothing

                        htmlOut.Append("<td width='25%' valign='top' align='left'>") ' Table #1 - 3rd Frame
                        htmlOut.Append("<table class='centerTable' border='0' width='100%' cellspacing='0' cellpadding='0'>") ' Table #4

                        htmlOut.Append("<tr>")
                        If Not IsDBNull(Row.Item("ac_airframe_tot_hrs")) Then
                            htmlOut.Append("<td width='50%' valign='top' align='left' nowrap='nowrap'><b>AIRFRM&nbsp;TT:</b>&nbsp;" + Row.Item("ac_airframe_tot_hrs").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td width='50%' valign='top' align='left' nowrap='nowrap'><b>AIRFRM&nbsp;TT:</b></td>")
                        End If

                        If Not IsDBNull(Row.Item("ac_airframe_tot_landings")) Then
                            htmlOut.Append("<td width='50%' valign='top' align='right' nowrap='nowrap'><b>LANDINGS:</b>&nbsp;" + Row.Item("ac_airframe_tot_landings").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td width='50%' valign='top' align='right' nowrap='nowrap'><b>LANDINGS:</b></td>")
                        End If

                        htmlOut.Append("</tr><tr>")

                        ' MXPROG = Airframe Maintenance Program ' ac_engine_maint_prog is not on the flat table
                        htmlOut.Append("<td width='50%' valign='top' align='left' nowrap='nowrap'><b>MX PROG:</b>&nbsp;")

                        If Not IsDBNull(Row.Item("amp_provider_name")) Then
                            htmlOut.Append(Row.Item("amp_provider_name").ToString.Trim)
                        End If

                        If Not IsDBNull(Row.Item("amp_program_name")) Then
                            If Not IsDBNull(Row.Item("amp_provider_name")) Then htmlOut.Append(" ")

                            htmlOut.Append(Row.Item("amp_program_name").ToString.Trim)
                        End If

                        htmlOut.Append("&nbsp;</td>")

                        If Not IsDBNull(Row.Item("ac_passenger_count")) Then
                            htmlOut.Append("<td width='50%' valign='top' align='right' nowrap='nowrap'><b>PASGR:</b>&nbsp;" + Row.Item("ac_passenger_count").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td width='50%' valign='top' align='right' nowrap='nowrap'><b>PASGR:</b></td>")
                        End If

                        htmlOut.Append("</tr></table>") ' Table #4

                        If Not IsDBNull(Row.Item("ac_engine_name")) Then
                            htmlOut.Append("<b>ENG MODEL:</b>&nbsp;" + Row.Item("ac_engine_name").ToString.Trim + "<br />")
                        Else
                            htmlOut.Append("<b>ENG MODEL:</b><br />")
                        End If

                        htmlOut.Append("<table class='centerTable' border='0' width='100%' cellpadding='0' cellspacing='0'>") ' Table #5

                        ' 03/28/2006 - By David D. Cruger; Added Engine SerNbr 1,2,3,4
                        htmlOut.Append("<tr><td><b>ENG S#:</b></td>")
                        htmlOut.Append("<td>[" + Row.Item("ac_engine_1_ser_no").ToString.Trim + "]</td>")
                        htmlOut.Append("<td>[" + Row.Item("ac_engine_2_ser_no").ToString.Trim + "]</td>")
                        htmlOut.Append("<td>[" + Row.Item("ac_engine_3_ser_no").ToString.Trim + "]</td>")
                        htmlOut.Append("<td>[" + Row.Item("ac_engine_4_ser_no").ToString.Trim + "]</td>")
                        htmlOut.Append("</tr>")

                        htmlOut.Append("<tr><td><b>ENG TT:</b></td>")
                        htmlOut.Append("<td>[" + Row.Item("ac_engine_1_tot_hrs").ToString.Trim + "]</td>")
                        htmlOut.Append("<td>[" + Row.Item("ac_engine_2_tot_hrs").ToString.Trim + "]</td>")
                        htmlOut.Append("<td>[" + Row.Item("ac_engine_3_tot_hrs").ToString.Trim + "]</td>")
                        htmlOut.Append("<td>[" + Row.Item("ac_engine_4_tot_hrs").ToString.Trim + "]</td>")
                        htmlOut.Append("</tr>")

                        htmlOut.Append("<tr><td><b>SMOH/CORE:</b></td>")
                        htmlOut.Append("<td>[" + Row.Item("ac_engine_1_soh_hrs").ToString.Trim + "]</td>")
                        htmlOut.Append("<td>[" + Row.Item("ac_engine_2_soh_hrs").ToString.Trim + "]</td>")
                        htmlOut.Append("<td>[" + Row.Item("ac_engine_3_soh_hrs").ToString.Trim + "]</td>")
                        htmlOut.Append("<td>[" + Row.Item("ac_engine_4_soh_hrs").ToString.Trim + "]</td>")
                        htmlOut.Append("</tr>")

                        htmlOut.Append("<tr><td><b>BY:</b></td>")
                        If Not IsDBNull(Row.Item("ac_maint_eoh_by_name")) Then
                            htmlOut.Append("<td colspan='4'>" + Row.Item("ac_maint_eoh_by_name").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td colspan='4'>&nbsp;</td>")
                        End If
                        htmlOut.Append("</tr>")

                        htmlOut.Append("<tr><td><b>SHOT/MPI:</b></td>")
                        htmlOut.Append("<td>[" + Row.Item("ac_engine_1_shi_hrs").ToString.Trim + "]</td>")
                        htmlOut.Append("<td>[" + Row.Item("ac_engine_2_shi_hrs").ToString.Trim + "]</td>")
                        htmlOut.Append("<td>[" + Row.Item("ac_engine_3_shi_hrs").ToString.Trim + "]</td>")
                        htmlOut.Append("<td>[" + Row.Item("ac_engine_4_shi_hrs").ToString.Trim + "]</td>")
                        htmlOut.Append("</tr>")

                        htmlOut.Append("<tr>")
                        htmlOut.Append("<td><b>BY:</b></td>")
                        If Not IsDBNull(Row.Item("ac_maint_hots_by_name")) Then
                            htmlOut.Append("<td colspan='4'>" + Row.Item("ac_maint_hots_by_name").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td colspan='4'>&nbsp;</td>")
                        End If
                        htmlOut.Append("</tr>")

                        htmlOut.Append("<tr><td><b>TBO:</b></td>")
                        htmlOut.Append("<td>[" + Row.Item("ac_engine_1_tbo_hrs").ToString.Trim + "]</td>")
                        htmlOut.Append("<td>[" + Row.Item("ac_engine_2_tbo_hrs").ToString.Trim + "]</td>")
                        htmlOut.Append("<td>[" + Row.Item("ac_engine_3_tbo_hrs").ToString.Trim + "]</td>")
                        htmlOut.Append("<td>[" + Row.Item("ac_engine_4_tbo_hrs").ToString.Trim + "]</td>")
                        htmlOut.Append("</tr>")

                        htmlOut.Append("</table>")

                        If Not IsDBNull(Row.Item("ac_avionics_avpackage")) Then
                            htmlOut.Append("<b>AVNCS:</b>&nbsp;" + Row.Item("ac_avionics_avpackage").ToString.Trim + "<br />")
                        Else
                            htmlOut.Append("<b>AVNCS:</b>&nbsp;<br />")
                        End If

                        ' FDIR
                        If Not IsDBNull(Row.Item("ac_avionics_flightdir")) Then
                            htmlOut.Append("<b>F/DIR:</b>&nbsp;" + Row.Item("ac_avionics_flightdir").ToString.Trim + "<br />")
                        Else
                            htmlOut.Append("<b>F/DIR:</b>&nbsp;<br />")
                        End If

                        ' AP
                        If Not IsDBNull(Row.Item("ac_avionics_autopilot")) Then
                            htmlOut.Append("<b>AP:</b>&nbsp;" + Row.Item("ac_avionics_autopilot").ToString.Trim + "<br />")
                        Else
                            htmlOut.Append("<b>AP:</b>&nbsp;<br />")
                        End If

                        htmlOut.Append(get_avionics_report_8(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id").ToString), "AFIS' OR av_name = 'FMS' OR av_name = 'GPS' OR av_name = 'INS' OR av_name = 'IRS", True) + "<br />")

                        htmlOut.Append("</td>") ' Table #1 - 3rd Frame
                        htmlOut.Append("<td width='25%' valign='top' align='left'>") ' Table #1 - 4th Frame

                        htmlOut.Append("<table class='centerTable' border='0' width='100%' cellspacing='0' cellpadding='0'>")  ' Table #6
                        htmlOut.Append("<tr><td valign='top' align='left' nowrap='nowrap' colspan='3'>")
                        htmlOut.Append("<b>MAINTAINED:</b>&nbsp;")

                        If Not IsDBNull(Row.Item("ac_maintained")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_maintained").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_maintained").ToString.Trim)
                            End If
                        End If

                        htmlOut.Append("</td></tr>")
                        htmlOut.Append("<tr>" + get_feature_codes_report_8_html(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id").ToString)) + "</tr>")
                        htmlOut.Append("<tr><td valign='top' align='left' nowrap='nowrap' colspan='3'>")

                        ' EMP = Engine Maintenance Program
                        htmlOut.Append("<b>EMP:</b> ")

                        If Not IsDBNull(Row.Item("emp_provider_name")) Then
                            htmlOut.Append(Row.Item("emp_provider_name").ToString.Trim)

                        End If

                        If Not IsDBNull(Row.Item("emp_program_name")) Then
                            If Not IsDBNull(Row.Item("emp_provider_name")) Then htmlOut.Append(" ")

                            htmlOut.Append(Row.Item("emp_program_name").ToString.Trim)
                        End If

                        htmlOut.Append("<br />")

                        htmlOut.Append("</td></tr>")
                        htmlOut.Append("<tr><td valign='top' align='left' nowrap='nowrap' colspan='3'>")
                        ' TCDATE
                        htmlOut.Append("<b>TCDATE:</b>&nbsp;")

                        If Not IsDBNull(Row.Item("ac_times_as_of_date")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_times_as_of_date").ToString.Trim) Then
                                htmlOut.Append(FormatDateTime(Row.Item("ac_times_as_of_date").ToString, DateFormat.ShortDate))
                            End If
                        End If

                        htmlOut.Append("</td></tr>")
                        htmlOut.Append("</table>")   ' Table #6

                        htmlOut.Append("<table class='centerTable' border='0' width='100%' cellspacing='0' cellpadding='2'>") ' Table #7
                        htmlOut.Append("<tr><td width='50%' valign='top' align='left' nowrap='nowrap'>")
                        htmlOut.Append("<b>EXT:</b>&nbsp;")

                        If Not IsDBNull(Row.Item("ac_exterior_moyear")) Then
                            If Row.Item("ac_exterior_moyear").ToString.Trim.Length > 4 Then
                                htmlOut.Append(Left(Row.Item("ac_exterior_moyear").ToString.Trim, 2) + "/")
                                htmlOut.Append(Right(Row.Item("ac_exterior_moyear").ToString.Trim, 4))
                            ElseIf Row.Item("ac_exterior_moyear").ToString.Trim.Length <= 2 Then
                                htmlOut.Append(Left(Row.Item("ac_exterior_moyear"), 2))
                            ElseIf Row.Item("ac_exterior_moyear").ToString.Trim.Length = 4 Then
                                htmlOut.Append(Right(Row.Item("ac_exterior_moyear"), 4))
                            End If
                        End If

                        htmlOut.Append("</td>") ' Table #7
                        htmlOut.Append("<td width='50%' valign='top' align='right' nowrap='nowrap'>") ' Table #7
                        htmlOut.Append("<b>INT:</b>&nbsp;")

                        If Not IsDBNull(Row.Item("ac_interior_moyear")) Then
                            If Row.Item("ac_interior_moyear").ToString.Trim.Length > 4 Then
                                htmlOut.Append(Left(Row.Item("ac_interior_moyear").ToString.Trim, 2) + "/")
                                htmlOut.Append(Right(Row.Item("ac_interior_moyear").ToString.Trim, 4))
                            ElseIf Row.Item("ac_interior_moyear").ToString.Trim.Length <= 2 Then
                                htmlOut.Append(Left(Row.Item("ac_interior_moyear"), 2))
                            ElseIf Row.Item("ac_interior_moyear").ToString.Trim.Length = 4 Then
                                htmlOut.Append(Right(Row.Item("ac_interior_moyear"), 4))
                            End If
                        End If

                        htmlOut.Append("</td></tr></table>")  ' Table #7

                        htmlOut.Append("</td></tr></table>")  ' Table #1
                        htmlOut.Append("<br />")

                    ElseIf bTextCommaReport Then

                        ' AIRFRAMETYPE - 03/14/2013 - By David D. Cruger; Added        
                        htmlOut.Append(Constants.QUOTE + Row.Item("amod_airframe_type_code").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)

                        ' MAKETYPE - 04/26/2006 - By David D. Cruger; Added
                        htmlOut.Append(Constants.QUOTE + Row.Item("amod_type_code").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)

                        ' MAKE
                        htmlOut.Append(Constants.QUOTE + Row.Item("amod_make_name").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)

                        ' MODEL
                        htmlOut.Append(Constants.QUOTE + Row.Item("amod_model_name").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)

                        ' SERNBR
                        htmlOut.Append(Constants.QUOTE + Row.Item("ac_ser_no_full").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)

                        ' REGNBR
                        htmlOut.Append(Constants.QUOTE + Row.Item("ac_reg_no").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)

                        If Not bAerodexFlag Then

                            ' STATUS
                            If Not IsDBNull(Row.Item("ac_status")) Then
                                htmlOut.Append(Constants.QUOTE + Row.Item("ac_status").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                            Else
                                htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                            End If

                            ' ASKING
                            If Not IsDBNull(Row.Item("ac_asking")) Then
                                htmlOut.Append(Constants.QUOTE + Row.Item("ac_asking").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                            Else
                                htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                            End If

                            ' ASKINGAMT
                            If Not IsDBNull(Row.Item("ac_asking_price")) Then
                                If Not String.IsNullOrEmpty(Row.Item("ac_asking_price").ToString.Trim) Then
                                    If CLng(Row.Item("ac_asking_price").ToString) > 0 Then
                                        htmlOut.Append(Constants.QUOTE + "$" + FormatNumber(Row.Item("ac_asking_price"), 0, False, False, True) + Constants.QUOTE + Constants.cCommaDelim)
                                    End If
                                Else
                                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                End If
                            Else
                                htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                            End If

                            ' DATELISTED 
                            If Not IsDBNull(Row.Item("ac_list_date")) Then
                                If Not String.IsNullOrEmpty(Row.Item("ac_list_date").ToString.Trim) Then
                                    htmlOut.Append(Constants.QUOTE + FormatDateTime(Row.Item("ac_list_date").ToString, DateFormat.ShortDate) + Constants.QUOTE + Constants.cCommaDelim)
                                Else
                                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                End If
                            Else
                                htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                            End If

                        End If ' If bAerodexFlag= False Then

                        ' DATEPURCHASED - 04/26/2006 - By David D. Cruger; Added
                        If Not IsDBNull(Row.Item("ac_purchase_date")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_purchase_date").ToString.Trim) Then
                                htmlOut.Append(Constants.QUOTE + FormatDateTime(Row.Item("ac_purchase_date").ToString, DateFormat.ShortDate) + Constants.QUOTE + Constants.cCommaDelim)
                            Else
                                htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                            End If
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        ' DATECHANGED - 04/26/2006 - By David D. Cruger; Added
                        If Not IsDBNull(Row.Item("ac_upd_date")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_upd_date").ToString.Trim) Then
                                htmlOut.Append(Constants.QUOTE + FormatDateTime(Row.Item("ac_upd_date").ToString, DateFormat.ShortDate) + Constants.QUOTE + Constants.cCommaDelim)
                            Else
                                htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                            End If
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        lCompOwrId = 0
                        lCompOprId = 0
                        lCompChpId = 0
                        lCompExcId = 0

                        lContactOwrId = 0
                        lContactOprId = 0
                        lContactChpId = 0
                        lContactExcId = 0

                        Dim report_8_ref_datatable As DataTable = Nothing

                        ' OWNER
                        htmlOut.Append(get_company_contact_info_report_8(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id")), "OWR", report_8_ref_datatable, lCompOwrId, lContactOwrId) + Constants.cCommaDelim)

                        ' OPERATOR
                        htmlOut.Append(get_company_contact_info_report_8(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id")), "OPR", report_8_ref_datatable, lCompOprId, lContactOprId) + Constants.cCommaDelim)

                        ' CHIEF PILOT
                        htmlOut.Append(get_company_contact_info_report_8(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id")), "CHP", report_8_ref_datatable, lCompChpId, lContactChpId) + Constants.cCommaDelim)

                        ' EXCLUSIVE BROKER
                        htmlOut.Append(get_company_contact_info_report_8(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id")), "EXC", report_8_ref_datatable, lCompExcId, lContactExcId) + Constants.cCommaDelim)

                        report_8_ref_datatable = Nothing

                        ' YEARMFG
                        If Not IsDBNull(Row.Item("ac_mfr_year")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_mfr_year").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        ' YEARDLV 
                        If Not IsDBNull(Row.Item("ac_year")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_year").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        ' BASEIATA 
                        If Not IsDBNull(Row.Item("ac_aport_iata_code")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_aport_iata_code").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        ' BASEICAO 
                        If Not IsDBNull(Row.Item("ac_aport_icao_code")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_aport_icao_code").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        ' BASENAME 
                        If Not IsDBNull(Row.Item("ac_aport_name")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_aport_name").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        ' BASECITY 
                        If Not IsDBNull(Row.Item("ac_aport_city")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_aport_city").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        ' BASESTATE 
                        If Not IsDBNull(Row.Item("ac_aport_state")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_aport_state").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        ' BASECOUNTRY 
                        If Not IsDBNull(Row.Item("ac_aport_country")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_aport_country").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        ' AFTT 
                        If Not IsDBNull(Row.Item("ac_airframe_tot_hrs")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_airframe_tot_hrs").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        ' LANDINGS 
                        If Not IsDBNull(Row.Item("ac_airframe_tot_landings")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_airframe_tot_landings").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        ' MXPROG = Airframe Maintenance Program 
                        htmlOut.Append(Constants.QUOTE)

                        If Not IsDBNull(Row.Item("amp_provider_name")) Then
                            htmlOut.Append(Row.Item("amp_provider_name").ToString.Trim)
                        End If

                        If Not IsDBNull(Row.Item("amp_program_name")) Then
                            If Not IsDBNull(Row.Item("amp_provider_name")) Then htmlOut.Append(" ")

                            htmlOut.Append(Row.Item("amp_program_name").ToString.Trim)
                        End If

                        htmlOut.Append(Constants.QUOTE + Constants.cCommaDelim)

                        ' PASSGR 
                        If Not IsDBNull(Row.Item("ac_passenger_count")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_passenger_count").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        ' ENGMODEL 
                        If Not IsDBNull(Row.Item("ac_engine_name")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_engine_name").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        ' 03/28/2006 - By David D. Cruger; Added
                        ' ENGSERNBR1,2,3,4
                        If Not IsDBNull(Row.Item("ac_engine_1_ser_no")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_engine_1_ser_no").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        If Not IsDBNull(Row.Item("ac_engine_2_ser_no")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_engine_2_ser_no").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        If Not IsDBNull(Row.Item("ac_engine_3_ser_no")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_engine_3_ser_no").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        If Not IsDBNull(Row.Item("ac_engine_4_ser_no")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_engine_4_ser_no").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        ' ENGTT1,2,3,4
                        If Not IsDBNull(Row.Item("ac_engine_1_tot_hrs")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_engine_1_tot_hrs").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        If Not IsDBNull(Row.Item("ac_engine_2_tot_hrs")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_engine_2_tot_hrs").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        If Not IsDBNull(Row.Item("ac_engine_3_tot_hrs")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_engine_3_tot_hrs").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If


                        If Not IsDBNull(Row.Item("ac_engine_4_tot_hrs")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_engine_4_tot_hrs").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        ' SMOH1,2,3,4

                        If Not IsDBNull(Row.Item("ac_engine_1_soh_hrs")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_engine_1_soh_hrs").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        If Not IsDBNull(Row.Item("ac_engine_2_soh_hrs")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_engine_2_soh_hrs").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        If Not IsDBNull(Row.Item("ac_engine_3_soh_hrs")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_engine_3_soh_hrs").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        If Not IsDBNull(Row.Item("ac_engine_4_soh_hrs")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_engine_4_soh_hrs").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        ' EOHBY
                        If Not IsDBNull(Row.Item("ac_maint_eoh_by_name")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_maint_eoh_by_name").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        ' SHOT1,2,3,4
                        If Not IsDBNull(Row.Item("ac_engine_1_shi_hrs")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_engine_1_shi_hrs").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        If Not IsDBNull(Row.Item("ac_engine_2_shi_hrs")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_engine_2_shi_hrs").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        If Not IsDBNull(Row.Item("ac_engine_3_shi_hrs")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_engine_3_shi_hrs").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        If Not IsDBNull(Row.Item("ac_engine_4_shi_hrs")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_engine_4_shi_hrs").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        ' HOTSBY
                        If Not IsDBNull(Row.Item("ac_maint_hots_by_name")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_maint_hots_by_name").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        ' TBO1,2,3,4
                        If Not IsDBNull(Row.Item("ac_engine_1_tbo_hrs")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_engine_1_tbo_hrs").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        If Not IsDBNull(Row.Item("ac_engine_2_tbo_hrs")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_engine_2_tbo_hrs").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        If Not IsDBNull(Row.Item("ac_engine_3_tbo_hrs")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_engine_3_tbo_hrs").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        If Not IsDBNull(Row.Item("ac_engine_4_tbo_hrs")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_engine_4_tbo_hrs").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        ' AVNCS
                        If Not IsDBNull(Row.Item("ac_avionics_avpackage")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_avionics_avpackage").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        ' FDIR
                        If Not IsDBNull(Row.Item("ac_avionics_flightdir")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_avionics_flightdir").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        ' AP
                        If Not IsDBNull(Row.Item("ac_avionics_autopilot")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_avionics_autopilot").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        ' AFIS
                        If Not IsDBNull(Row.Item("ac_avionics_afis")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_avionics_afis").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        ' FMS
                        If Not IsDBNull(Row.Item("ac_avionics_fms")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_avionics_fms").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        ' GPS
                        If Not IsDBNull(Row.Item("ac_avionics_gps")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_avionics_gps").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        ' INS
                        If Not IsDBNull(Row.Item("ac_avionics_ins")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_avionics_ins").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        ' IRS
                        If Not IsDBNull(Row.Item("ac_avionics_irs")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_avionics_irs").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        ' MAINTAINED
                        If Not IsDBNull(Row.Item("ac_maintained")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_maintained").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        get_top_six_feature_codes_report_8(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id").ToString), strF1, strF2, strF3, strF4, strF5, strF6)

                        ' FEATURE CODE 1
                        htmlOut.Append(Constants.QUOTE + Left(strF1, 3) + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + Mid(strF1, 4, 1) + Constants.QUOTE + Constants.cCommaDelim)

                        ' FEATURE CODE 2
                        htmlOut.Append(Constants.QUOTE + Left(strF2, 3) + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + Mid(strF2, 4, 1) + Constants.QUOTE + Constants.cCommaDelim)

                        ' FEATURE CODE 3
                        htmlOut.Append(Constants.QUOTE + Left(strF3, 3) + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + Mid(strF3, 4, 1) + Constants.QUOTE + Constants.cCommaDelim)

                        ' FEATURE CODE 4
                        htmlOut.Append(Constants.QUOTE + Left(strF4, 3) + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + Mid(strF4, 4, 1) + Constants.QUOTE + Constants.cCommaDelim)

                        ' FEATURE CODE 5
                        htmlOut.Append(Constants.QUOTE + Left(strF5, 3) + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + Mid(strF5, 4, 1) + Constants.QUOTE + Constants.cCommaDelim)

                        ' FEATURE CODE 6
                        htmlOut.Append(Constants.QUOTE + Left(strF6, 3) + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + Mid(strF6, 4, 1) + Constants.QUOTE + Constants.cCommaDelim)

                        ' EMP = Engine Maintenance Program
                        htmlOut.Append(Constants.QUOTE)

                        If Not IsDBNull(Row.Item("emp_provider_name")) Then
                            htmlOut.Append(Row.Item("emp_provider_name").ToString.Trim)
                        End If

                        If Not IsDBNull(Row.Item("emp_program_name")) Then
                            If Not IsDBNull(Row.Item("emp_provider_name")) Then htmlOut.Append(" ")

                            htmlOut.Append(Row.Item("emp_program_name").ToString.Trim)
                        End If

                        htmlOut.Append(Constants.QUOTE + Constants.cCommaDelim)

                        ' TCDATE
                        If Not IsDBNull(Row.Item("ac_times_as_of_date")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_times_as_of_date").ToString.Trim) Then
                                htmlOut.Append(Constants.QUOTE + FormatDateTime(Row.Item("ac_times_as_of_date").ToString, DateFormat.ShortDate) + Constants.QUOTE + Constants.cCommaDelim)
                            Else
                                htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                            End If
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        ' EXTYR
                        If Not IsDBNull(Row.Item("ac_exterior_moyear")) Then
                            If Row.Item("ac_exterior_moyear").ToString.Trim.Length > 4 Then
                                htmlOut.Append(Constants.QUOTE + Left(Row.Item("ac_exterior_moyear").ToString.Trim, 2) + "/")
                                htmlOut.Append(Right(Row.Item("ac_exterior_moyear").ToString.Trim, 4) + Constants.QUOTE + Constants.cCommaDelim)
                            ElseIf Row.Item("ac_exterior_moyear").ToString.Trim.Length <= 2 Then
                                htmlOut.Append(Constants.QUOTE + Left(Row.Item("ac_exterior_moyear"), 2) + Constants.QUOTE + Constants.cCommaDelim)
                            ElseIf Row.Item("ac_exterior_moyear").ToString.Trim.Length = 4 Then
                                htmlOut.Append(Constants.QUOTE + Right(Row.Item("ac_exterior_moyear"), 4) + Constants.QUOTE + Constants.cCommaDelim)
                            End If
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        ' INTYR
                        If Not IsDBNull(Row.Item("ac_interior_moyear")) Then
                            If Row.Item("ac_interior_moyear").ToString.Trim.Length > 4 Then
                                htmlOut.Append(Constants.QUOTE + Left(Row.Item("ac_interior_moyear").ToString.Trim, 2) + "/")
                                htmlOut.Append(Right(Row.Item("ac_interior_moyear").ToString.Trim, 4) + Constants.QUOTE + Constants.cCommaDelim)
                            ElseIf Row.Item("ac_interior_moyear").ToString.Trim.Length <= 2 Then
                                htmlOut.Append(Constants.QUOTE + Left(Row.Item("ac_interior_moyear"), 2) + Constants.QUOTE + Constants.cCommaDelim)
                            ElseIf Row.Item("ac_interior_moyear").ToString.Trim.Length = 4 Then
                                htmlOut.Append(Constants.QUOTE + Right(Row.Item("ac_interior_moyear"), 4) + Constants.QUOTE + Constants.cCommaDelim)
                            End If
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        ' 02/20/2007 - By David D. Cruger; Added LifeCycle
                        If Not IsDBNull(Row.Item("ac_lifecycle_stage")) Then
                            htmlOut.Append(Constants.QUOTE + localFunctions.get_lifecycle_stage_report(CInt(Row.Item("ac_lifecycle_stage").ToString), True) + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        ' 03/05/2009 - By David D. Cruger - Add, InFavorOfName, DocType, DocAmount        
                        htmlOut.Append(ReturnInFavorOfInformation(CLng(Row.Item("ac_id").ToString), lCompOwrId, True))

                    ElseIf bTextTabReport Then

                        ' AIRFRAMETYPE - 03/14/2013 - By David D. Cruger; Added                
                        htmlOut.Append(Row.Item("amod_airframe_type_code").ToString.Trim + vbTab)

                        ' MAKETYPE - 04/26/2006 - By David D. Cruger; Added
                        htmlOut.Append(Row.Item("amod_type_code").ToString.Trim + vbTab)

                        ' MAKE
                        htmlOut.Append(Row.Item("amod_make_name").ToString.Trim + vbTab)

                        ' MODEL
                        htmlOut.Append(Row.Item("amod_model_name").ToString.Trim + vbTab)

                        ' SERNBR
                        htmlOut.Append(Row.Item("ac_ser_no_full").ToString.Trim + vbTab)

                        ' REGNBR
                        htmlOut.Append(Row.Item("ac_reg_no").ToString.Trim + vbTab)

                        If Not bAerodexFlag Then

                            ' STATUS
                            If Not IsDBNull(Row.Item("ac_status")) Then
                                htmlOut.Append(Row.Item("ac_status").ToString.Trim + vbTab)
                            Else
                                htmlOut.Append(vbTab)
                            End If

                            ' ASKING 
                            If Not IsDBNull(Row.Item("ac_asking")) Then
                                htmlOut.Append(Row.Item("ac_asking").ToString.Trim + vbTab)
                            Else
                                htmlOut.Append(vbTab)
                            End If

                            ' ASKINGAMT
                            If Not IsDBNull(Row.Item("ac_asking_price")) Then
                                If Not String.IsNullOrEmpty(Row.Item("ac_asking_price").ToString.Trim) Then
                                    If CLng(Row.Item("ac_asking_price").ToString) > 0 Then
                                        htmlOut.Append("$" + FormatNumber(Row.Item("ac_asking_price"), 0, False, False, True) + vbTab)
                                    End If
                                Else
                                    htmlOut.Append(vbTab)
                                End If
                            Else
                                htmlOut.Append(vbTab)
                            End If

                            ' DATELISTED
                            If Not IsDBNull(Row.Item("ac_list_date")) Then
                                If Not String.IsNullOrEmpty(Row.Item("ac_list_date").ToString.Trim) Then
                                    htmlOut.Append(FormatDateTime(Row.Item("ac_list_date").ToString, DateFormat.ShortDate) + vbTab)
                                Else
                                    htmlOut.Append(vbTab)
                                End If
                            Else
                                htmlOut.Append(vbTab)
                            End If

                        End If ' If Aerodex = False Then

                        ' DATEPURCHASED - 04/26/2006 - By David D. Cruger; Added
                        If Not IsDBNull(Row.Item("ac_purchase_date")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_purchase_date").ToString.Trim) Then
                                htmlOut.Append(FormatDateTime(Row.Item("ac_purchase_date").ToString, DateFormat.ShortDate) + vbTab)
                            Else
                                htmlOut.Append(vbTab)
                            End If
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        ' DATECHANGED - 04/26/2006 - By David D. Cruger; Added
                        If Not IsDBNull(Row.Item("ac_upd_date")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_upd_date").ToString.Trim) Then
                                htmlOut.Append(FormatDateTime(Row.Item("ac_upd_date").ToString, DateFormat.ShortDate) + vbTab)
                            Else
                                htmlOut.Append(vbTab)
                            End If
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        lCompOwrId = 0
                        lCompOprId = 0
                        lCompChpId = 0
                        lCompExcId = 0

                        lContactOwrId = 0
                        lContactOprId = 0
                        lContactChpId = 0
                        lContactExcId = 0

                        Dim report_8_ref_datatable As DataTable = Nothing

                        ' OWNER
                        htmlOut.Append(get_company_contact_info_report_8(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id")), "OWR", report_8_ref_datatable, lCompOwrId, lContactOwrId) + vbTab)

                        ' OPERATOR
                        htmlOut.Append(get_company_contact_info_report_8(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id")), "OPR", report_8_ref_datatable, lCompOprId, lContactOprId) + vbTab)

                        ' CHIEF PILOT
                        htmlOut.Append(get_company_contact_info_report_8(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id")), "CHP", report_8_ref_datatable, lCompChpId, lContactChpId) + vbTab)

                        ' EXCLUSIVE BROKER
                        htmlOut.Append(get_company_contact_info_report_8(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id")), "EXC", report_8_ref_datatable, lCompExcId, lContactExcId) + vbTab)

                        report_8_ref_datatable = Nothing

                        ' YEARMFG
                        If Not IsDBNull(Row.Item("ac_mfr_year")) Then
                            htmlOut.Append(Row.Item("ac_mfr_year").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        ' YEARDLV 
                        If Not IsDBNull(Row.Item("ac_year")) Then
                            htmlOut.Append(Row.Item("ac_year").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        ' BASEIATA 
                        If Not IsDBNull(Row.Item("ac_aport_iata_code")) Then
                            htmlOut.Append(Row.Item("ac_aport_iata_code").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        ' BASEICAO 
                        If Not IsDBNull(Row.Item("ac_aport_icao_code")) Then
                            htmlOut.Append(Row.Item("ac_aport_icao_code").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        ' BASENAME 
                        If Not IsDBNull(Row.Item("ac_aport_name")) Then
                            htmlOut.Append(Row.Item("ac_aport_name").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        ' BASECITY 
                        If Not IsDBNull(Row.Item("ac_aport_city")) Then
                            htmlOut.Append(Row.Item("ac_aport_city").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        ' BASESTATE 
                        If Not IsDBNull(Row.Item("ac_aport_state")) Then
                            htmlOut.Append(Row.Item("ac_aport_state").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        ' BASECOUNTRY 
                        If Not IsDBNull(Row.Item("ac_aport_country")) Then
                            htmlOut.Append(Row.Item("ac_aport_country").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        ' AFTT 
                        If Not IsDBNull(Row.Item("ac_airframe_tot_hrs")) Then
                            htmlOut.Append(Row.Item("ac_airframe_tot_hrs").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        ' LANDINGS 
                        If Not IsDBNull(Row.Item("ac_airframe_tot_landings")) Then
                            htmlOut.Append(Row.Item("ac_airframe_tot_landings").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        ' MXPROG = Airframe Maintenance Program
                        If Not IsDBNull(Row.Item("amp_provider_name")) Then
                            htmlOut.Append(Row.Item("amp_provider_name").ToString.Trim)
                        End If

                        If Not IsDBNull(Row.Item("amp_program_name")) Then
                            If Not IsDBNull(Row.Item("amp_provider_name")) Then htmlOut.Append(" ")

                            htmlOut.Append(Row.Item("amp_program_name").ToString.Trim)
                        End If

                        htmlOut.Append(vbTab)

                        ' PASSGR 
                        If Not IsDBNull(Row.Item("ac_passenger_count")) Then
                            htmlOut.Append(Row.Item("ac_passenger_count").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        ' ENGMODEL 
                        If Not IsDBNull(Row.Item("ac_engine_name")) Then
                            htmlOut.Append(Row.Item("ac_engine_name").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        ' 03/28/2006 - By David D. Cruger; Added
                        ' ENGSERNBR1,2,3,4
                        If Not IsDBNull(Row.Item("ac_engine_1_ser_no")) Then
                            htmlOut.Append(Row.Item("ac_engine_1_ser_no").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        If Not IsDBNull(Row.Item("ac_engine_2_ser_no")) Then
                            htmlOut.Append(Row.Item("ac_engine_2_ser_no").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        If Not IsDBNull(Row.Item("ac_engine_3_ser_no")) Then
                            htmlOut.Append(Row.Item("ac_engine_3_ser_no").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        If Not IsDBNull(Row.Item("ac_engine_4_ser_no")) Then
                            htmlOut.Append(Row.Item("ac_engine_4_ser_no").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        ' ENGTT1,2,3,4
                        If Not IsDBNull(Row.Item("ac_engine_1_tot_hrs")) Then
                            htmlOut.Append(Row.Item("ac_engine_1_tot_hrs").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        If Not IsDBNull(Row.Item("ac_engine_2_tot_hrs")) Then
                            htmlOut.Append(Row.Item("ac_engine_2_tot_hrs").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        If Not IsDBNull(Row.Item("ac_engine_3_tot_hrs")) Then
                            htmlOut.Append(Row.Item("ac_engine_3_tot_hrs").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        If Not IsDBNull(Row.Item("ac_engine_4_tot_hrs")) Then
                            htmlOut.Append(Row.Item("ac_engine_4_tot_hrs").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        ' SMOH1,2,3,4

                        If Not IsDBNull(Row.Item("ac_engine_1_soh_hrs")) Then
                            htmlOut.Append(Row.Item("ac_engine_1_soh_hrs").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        If Not IsDBNull(Row.Item("ac_engine_2_soh_hrs")) Then
                            htmlOut.Append(Row.Item("ac_engine_2_soh_hrs").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        If Not IsDBNull(Row.Item("ac_engine_3_soh_hrs")) Then
                            htmlOut.Append(Row.Item("ac_engine_3_soh_hrs").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        If Not IsDBNull(Row.Item("ac_engine_4_soh_hrs")) Then
                            htmlOut.Append(Row.Item("ac_engine_4_soh_hrs").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        ' EOHBY
                        If Not IsDBNull(Row.Item("ac_maint_eoh_by_name")) Then
                            htmlOut.Append(Row.Item("ac_maint_eoh_by_name").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        ' SHOT1,2,3,4
                        If Not IsDBNull(Row.Item("ac_engine_1_shi_hrs")) Then
                            htmlOut.Append(Row.Item("ac_engine_1_shi_hrs").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If
                        If Not IsDBNull(Row.Item("ac_engine_2_shi_hrs")) Then
                            htmlOut.Append(Row.Item("ac_engine_2_shi_hrs").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If
                        If Not IsDBNull(Row.Item("ac_engine_3_shi_hrs")) Then
                            htmlOut.Append(Row.Item("ac_engine_3_shi_hrs").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If
                        If Not IsDBNull(Row.Item("ac_engine_4_shi_hrs")) Then
                            htmlOut.Append(Row.Item("ac_engine_4_shi_hrs").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        ' HOTSBY
                        If Not IsDBNull(Row.Item("ac_maint_hots_by_name")) Then
                            htmlOut.Append(Row.Item("ac_maint_hots_by_name").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        ' TBO1,2,3,4
                        If Not IsDBNull(Row.Item("ac_engine_1_tbo_hrs")) Then
                            htmlOut.Append(Row.Item("ac_engine_1_tbo_hrs").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        If Not IsDBNull(Row.Item("ac_engine_2_tbo_hrs")) Then
                            htmlOut.Append(Row.Item("ac_engine_2_tbo_hrs").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        If Not IsDBNull(Row.Item("ac_engine_3_tbo_hrs")) Then
                            htmlOut.Append(Row.Item("ac_engine_3_tbo_hrs").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        If Not IsDBNull(Row.Item("ac_engine_4_tbo_hrs")) Then
                            htmlOut.Append(Row.Item("ac_engine_4_tbo_hrs").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        ' AVNCS
                        If Not IsDBNull(Row.Item("ac_avionics_avpackage")) Then
                            htmlOut.Append(Row.Item("ac_avionics_avpackage").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        ' FDIR
                        If Not IsDBNull(Row.Item("ac_avionics_flightdir")) Then
                            htmlOut.Append(Row.Item("ac_avionics_flightdir").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        ' AP
                        If Not IsDBNull(Row.Item("ac_avionics_autopilot")) Then
                            htmlOut.Append(Row.Item("ac_avionics_autopilot").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        ' AFIS
                        If Not IsDBNull(Row.Item("ac_avionics_afis")) Then
                            htmlOut.Append(Row.Item("ac_avionics_afis").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        ' FMS
                        If Not IsDBNull(Row.Item("ac_avionics_fms")) Then
                            htmlOut.Append(Row.Item("ac_avionics_fms").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        ' GPS
                        If Not IsDBNull(Row.Item("ac_avionics_gps")) Then
                            htmlOut.Append(Row.Item("ac_avionics_gps").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        ' INS
                        If Not IsDBNull(Row.Item("ac_avionics_ins")) Then
                            htmlOut.Append(Row.Item("ac_avionics_ins").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        ' IRS
                        If Not IsDBNull(Row.Item("ac_avionics_irs")) Then
                            htmlOut.Append(Row.Item("ac_avionics_irs").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        ' MAINTAINED
                        If Not IsDBNull(Row.Item("ac_maintained")) Then
                            htmlOut.Append(Row.Item("ac_maintained").ToString.Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        get_top_six_feature_codes_report_8(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id").ToString), strF1, strF2, strF3, strF4, strF5, strF6)

                        ' FEATURE CODE 1
                        htmlOut.Append(Left(strF1, 3) + vbTab)
                        htmlOut.Append(Mid(strF1, 4, 1) + vbTab)

                        ' FEATURE CODE 2
                        htmlOut.Append(Left(strF2, 3) + vbTab)
                        htmlOut.Append(Mid(strF2, 4, 1) + vbTab)

                        ' FEATURE CODE 3
                        htmlOut.Append(Left(strF3, 3) + vbTab)
                        htmlOut.Append(Mid(strF3, 4, 1) + vbTab)

                        ' FEATURE CODE 4
                        htmlOut.Append(Left(strF4, 3) + vbTab)
                        htmlOut.Append(Mid(strF4, 4, 1) + vbTab)

                        ' FEATURE CODE 5
                        htmlOut.Append(Left(strF5, 3) + vbTab)
                        htmlOut.Append(Mid(strF5, 4, 1) + vbTab)

                        ' FEATURE CODE 6
                        htmlOut.Append(Left(strF6, 3) + vbTab)
                        htmlOut.Append(Mid(strF6, 4, 1) + vbTab)

                        ' EMP = Engine Maintenance Program
                        If Not IsDBNull(Row.Item("emp_provider_name")) Then
                            htmlOut.Append(Row.Item("emp_provider_name").ToString.Trim)
                        End If

                        If Not IsDBNull(Row.Item("emp_program_name")) Then
                            If Not IsDBNull(Row.Item("emp_provider_name")) Then htmlOut.Append(" ")

                            htmlOut.Append(Row.Item("emp_program_name").ToString.Trim)
                        End If

                        htmlOut.Append(vbTab)

                        ' TCDATE
                        If Not IsDBNull(Row.Item("ac_times_as_of_date")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_times_as_of_date").ToString.Trim) Then
                                htmlOut.Append(FormatDateTime(Row.Item("ac_times_as_of_date").ToString, DateFormat.ShortDate) + vbTab)
                            Else
                                htmlOut.Append(vbTab)
                            End If
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        ' EXTYR
                        If Not IsDBNull(Row.Item("ac_exterior_moyear")) Then
                            If Row.Item("ac_exterior_moyear").ToString.Trim.Length > 4 Then
                                htmlOut.Append(Left(Row.Item("ac_exterior_moyear").ToString.Trim, 2) + "/")
                                htmlOut.Append(Right(Row.Item("ac_exterior_moyear").ToString.Trim, 4) + vbTab)
                            ElseIf Row.Item("ac_exterior_moyear").ToString.Trim.Length <= 2 Then
                                htmlOut.Append(Left(Row.Item("ac_exterior_moyear"), 2) + vbTab)
                            ElseIf Row.Item("ac_exterior_moyear").ToString.Trim.Length = 4 Then
                                htmlOut.Append(Right(Row.Item("ac_exterior_moyear"), 4) + vbTab)
                            End If
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        ' INTYR
                        If Not IsDBNull(Row.Item("ac_interior_moyear")) Then
                            If Row.Item("ac_interior_moyear").ToString.Trim.Length > 4 Then
                                htmlOut.Append(Left(Row.Item("ac_interior_moyear").ToString.Trim, 2) + "/")
                                htmlOut.Append(Right(Row.Item("ac_interior_moyear").ToString.Trim, 4) + vbTab)
                            ElseIf Row.Item("ac_interior_moyear").ToString.Trim.Length <= 2 Then
                                htmlOut.Append(Left(Row.Item("ac_interior_moyear"), 2) + vbTab)
                            ElseIf Row.Item("ac_interior_moyear").ToString.Trim.Length = 4 Then
                                htmlOut.Append(Right(Row.Item("ac_interior_moyear"), 4) + vbTab)
                            End If
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        ' 02/20/2007 - By David D. Cruger; Added LifeCycle
                        If Not IsDBNull(Row.Item("ac_lifecycle_stage")) Then
                            htmlOut.Append(localFunctions.get_lifecycle_stage_report(CInt(Row.Item("ac_lifecycle_stage").ToString), True) + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        ' 03/05/2009 - By David D. Cruger - Add, InFavorOfName, DocType, DocAmount        
                        htmlOut.Append(ReturnInFavorOfInformation(CLng(Row.Item("ac_id").ToString), lCompOwrId, True))

                    End If

                Next

                If bHtmlReport Then
                    htmlOut.Append("</td></tr></table>")
                ElseIf bExcelReport Then
                    htmlOut.Append("</table>")
                End If

                If bHtmlReport Then
                    htmlOut.Append("</div>")
                    htmlOut.Append("</body>")
                    htmlOut.Append("</html>")
                End If

            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Create_Report_8_Condensed_Record_with_Owner_Operator()" + ex.Message

        Finally
            adoRS_8 = Nothing

            report_8_datatable = Nothing

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOut.ToString

    End Function

    Private Function get_company_contact_info_report_8(ByVal lACid As Long, ByVal lJournID As Long, ByVal strRelationType As String, ByRef report_8_ref_datatable As DataTable, ByRef lCompId As Long, ByRef lContactId As Long, Optional ByVal bGetSecondBroker As Boolean = False) As String

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand

        Dim adoRS_8_ref As System.Data.SqlClient.SqlDataReader : adoRS_8_ref = Nothing

        Dim htmlOut = New StringBuilder()

        Dim sQuery As New StringBuilder()

        Dim strRelation As String = ""
        Dim strAgencyType As String = ""
        Dim strBusinessType As String = ""

        Dim sCompanyInfo As String = ""
        Dim sCompanyPhoneInfo As String = ""

        Dim sContactInfo As String = ""
        Dim sContactPhoneInfo As String = ""

        Dim bGotOwnerRecord As Boolean = False
        Dim bGotOperatorRecord As Boolean = False
        Dim bGotChiefPilotRecord As Boolean = False
        Dim bGotExclusiveRecord As Boolean = False
        Dim bGotSalesRecord As Boolean = False

        Dim nExclusiveCnt As Integer = 0

        Try

            If IsNothing(report_8_ref_datatable) Then

                report_8_ref_datatable = New DataTable

                SqlConn.ConnectionString = localFunctions.clientConnectStr

                SqlConn.Open()

                SqlCommand.Connection = SqlConn
                SqlCommand.CommandType = System.Data.CommandType.Text
                SqlCommand.CommandTimeout = 90

                ' Find Required Data
                sQuery.Append("SELECT cref_ac_id, cref_journ_id, cref_comp_id, cref_contact_id, cref_operator_flag, cref_transmit_seq_no, cref_contact_type, actype_name,")
                sQuery.Append(" comp_name, comp_name_alt_type, comp_name_alt, comp_email_address, comp_web_address,")
                sQuery.Append(" comp_address1, comp_address2, comp_city, state_name, comp_state, comp_zip_code, comp_country,")
                sQuery.Append(" comp_agency_type, cref_business_type")

                sQuery.Append(" FROM Aircraft_Reference WITH(NOLOCK)")

                sQuery.Append(" INNER JOIN Company WITH(NOLOCK) ON (cref_comp_id = comp_id AND cref_journ_id = comp_journ_id)")
                sQuery.Append(" INNER JOIN Aircraft_Contact_Type WITH(NOLOCK) ON (cref_contact_type = actype_code)")
                sQuery.Append(" LEFT OUTER JOIN State WITH(NOLOCK) ON (comp_state = state_code AND comp_country = state_country)")

                sQuery.Append(" WHERE (cref_ac_id = " + lACid.ToString + " AND cref_journ_id = " + lJournID.ToString)

                If lJournID = 0 Then
                    sQuery.Append(" AND comp_active_flag = 'Y'")
                End If

                sQuery.Append(" AND comp_hide_flag = 'N')")
                sQuery.Append(" " + commonEvo.MakeCompanyProductCodeClause(HttpContext.Current.Session.Item("localPreferences"), False) + "ORDER BY cref_transmit_seq_no")

                HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />company_contact_info_report_8(ByVal lACid As Long, ByVal lJournID As Long, ByVal strRelationType As String, ByRef lCompId As Long, ByRef lContactId As Long) As String<br />" + sQuery.ToString

                SqlCommand.CommandText = sQuery.ToString
                adoRS_8_ref = SqlCommand.ExecuteReader()

                Try
                    report_8_ref_datatable.Load(adoRS_8_ref)
                Catch constrExc As System.Data.ConstraintException
                    Dim rowsErr As System.Data.DataRow() = report_8_ref_datatable.GetErrors()
                End Try

                adoRS_8_ref.Close()
                adoRS_8_ref = Nothing

                SqlConn.Close()
                SqlConn.Dispose()
                SqlConn = Nothing

                SqlCommand.Dispose()
                SqlCommand = Nothing

            End If

            If report_8_ref_datatable.Rows.Count > 0 Then

                For Each Row As DataRow In report_8_ref_datatable.Rows

                    If Not IsDBNull(Row.Item("cref_comp_id")) Then
                        lCompId = CLng(Row.Item("cref_comp_id").ToString)
                    Else
                        lCompId = 0
                    End If

                    If Not IsDBNull(Row.Item("cref_contact_id")) Then
                        lContactId = CLng(Row.Item("cref_contact_id").ToString)
                    Else
                        lContactId = 0
                    End If

                    If Not IsDBNull(Row.Item("actype_name")) Then
                        strRelation = Row.Item("actype_name").ToString.Trim
                    Else
                        strRelation = ""
                    End If

                    If Not IsDBNull(Row.Item("comp_agency_type")) Then
                        strAgencyType = Row.Item("comp_agency_type").ToString.Trim
                    Else
                        strRelation = ""
                    End If

                    If Not IsDBNull(Row.Item("cref_business_type")) Then
                        strBusinessType = Row.Item("cref_business_type").ToString.Trim
                    Else
                        strBusinessType = ""
                    End If

                    bGotOwnerRecord = False
                    bGotOperatorRecord = False
                    bGotChiefPilotRecord = False
                    bGotExclusiveRecord = False
                    bGotSalesRecord = False

                    Select Case strRelationType.ToUpper.Trim

                        Case "OWR"

                            If CInt(Row.Item("cref_transmit_seq_no").ToString) = 1 And Not Row.Item("cref_contact_type").ToString.Contains("71") Then
                                bGotOwnerRecord = True
                            End If

                            If bGotOwnerRecord Then

                                If Not bHtmlReport Then

                                    ReturnCompanyInformation_Report(lCompId, lJournID, Row, sCompanyPhoneInfo, sCompanyInfo, True)
                                    ReturnContactInformation_Report(lCompId, lContactId, lJournID, sContactInfo, sContactPhoneInfo)

                                Else

                                    htmlOut.Append("<b>" + localFunctions.get_contact_type_for_contact_id(Row.Item("cref_contact_type").ToString.Trim).ToUpper + ":</b><br />")

                                    htmlOut.Append(Row.Item("comp_name").ToString.Trim + "<br />")

                                    Dim strAltCompType As String = ""
                                    If Not IsDBNull(Row.Item("comp_name_alt_type")) Then
                                        strAltCompType = Row.Item("comp_name_alt_type").ToString.Trim
                                    Else
                                        strAltCompType = ""
                                    End If

                                    If Not IsDBNull(Row.Item("comp_name_alt")) Then
                                        If Not String.IsNullOrEmpty(strAltCompType) Then
                                            htmlOut.Append(strAltCompType + " " + Row.Item("comp_name_alt").ToString.Trim + "<br />")
                                        Else
                                            htmlOut.Append(Row.Item("comp_name_alt").ToString.Trim + "<br />")
                                        End If
                                    End If

                                    If CLng(Row.Item("cref_contact_id").ToString.Trim) > 0 Then
                                        htmlOut.Append(localFunctions.get_contact_name_title(CLng(Row.Item("cref_contact_id").ToString.Trim), False))
                                    End If

                                    If Not IsDBNull(Row.Item("comp_address1")) Then
                                        htmlOut.Append(Row.Item("comp_address1").ToString.Trim + "<br />")
                                    End If

                                    If Not IsDBNull(Row.Item("comp_zip_code")) Then
                                        htmlOut.Append(Row.Item("comp_city").ToString.Trim + ", " + Row.Item("comp_state").ToString.Trim + "&nbsp;" + Row.Item("comp_zip_code").ToString.Trim + "<br />")
                                    Else
                                        htmlOut.Append(Row.Item("comp_city").ToString.Trim + ", " + Row.Item("comp_state").ToString.Trim + "<br />")
                                    End If

                                    htmlOut.Append(Row.Item("comp_country").ToString.Trim + "<br />")

                                    ' 03/28/2006 - By David D. Cruger; Added Company WebSite and EMail
                                    If Not IsDBNull(Row.Item("comp_web_address")) Then
                                        htmlOut.Append(Row.Item("comp_web_address").ToString.Trim + "<br />")
                                    End If

                                    If Not IsDBNull(Row.Item("comp_email_address")) Then
                                        If Not String.IsNullOrEmpty(Row.Item("comp_email_address").ToString.Trim) Then
                                            htmlOut.Append(Row.Item("comp_email_address").ToString.Trim + "<br />")
                                        Else
                                            htmlOut.Append(localFunctions.get_first_contact_email_address_report(CLng(Row.Item("cref_comp_id").ToString), CLng(Row.Item("cref_journ_id").ToString)).Trim + "<br />")
                                        End If
                                    Else
                                        htmlOut.Append(localFunctions.get_first_contact_email_address_report(CLng(Row.Item("cref_comp_id").ToString), CLng(Row.Item("cref_journ_id").ToString)).Trim + "<br />")
                                    End If

                                    htmlOut.Append(localFunctions.get_phone_info(CLng(Row.Item("cref_comp_id").ToString), CLng(Row.Item("cref_journ_id").ToString), CLng(Row.Item("cref_contact_id").ToString)))

                                End If

                                Exit For
                            End If

                        Case "OPR"

                            If Row.Item("cref_operator_flag").ToString.ToUpper.Contains("Y") Then
                                bGotOperatorRecord = True
                            End If

                            If bGotOperatorRecord Then

                                If Not bHtmlReport Then

                                    ReturnCompanyInformation_Report(lCompId, lJournID, Row, sCompanyPhoneInfo, sCompanyInfo, True)
                                    ReturnContactInformation_Report(lCompId, lContactId, lJournID, sContactInfo, sContactPhoneInfo)

                                Else

                                    htmlOut.Append("<b>" + localFunctions.get_contact_type_for_contact_id(Row.Item("cref_contact_type").ToString.Trim).ToUpper + ":</b><br />")

                                    htmlOut.Append(Row.Item("comp_name").ToString.Trim + "<br />")

                                    Dim strAltCompType As String = ""
                                    If Not IsDBNull(Row.Item("comp_name_alt_type")) Then
                                        strAltCompType = Row.Item("comp_name_alt_type").ToString.Trim
                                    Else
                                        strAltCompType = ""
                                    End If

                                    If Not IsDBNull(Row.Item("comp_name_alt")) Then
                                        If Not String.IsNullOrEmpty(strAltCompType) Then
                                            htmlOut.Append(strAltCompType + " " + Row.Item("comp_name_alt").ToString.Trim + "<br />")
                                        Else
                                            htmlOut.Append(Row.Item("comp_name_alt").ToString.Trim + "<br />")
                                        End If
                                    End If

                                    If CLng(Row.Item("cref_contact_id").ToString.Trim) > 0 Then
                                        htmlOut.Append(localFunctions.get_contact_name_title(CLng(Row.Item("cref_contact_id").ToString.Trim), False))
                                    End If

                                    If Not IsDBNull(Row.Item("comp_address1")) Then
                                        htmlOut.Append(Row.Item("comp_address1").ToString.Trim + "<br />")
                                    End If

                                    If Not IsDBNull(Row.Item("comp_zip_code")) Then
                                        htmlOut.Append(Row.Item("comp_city").ToString.Trim + ", " + Row.Item("comp_state").ToString.Trim + "&nbsp;" + Row.Item("comp_zip_code").ToString.Trim + "<br />")
                                    Else
                                        htmlOut.Append(Row.Item("comp_city").ToString.Trim + ", " + Row.Item("comp_state").ToString.Trim + "<br />")
                                    End If

                                    htmlOut.Append(Row.Item("comp_country").ToString.Trim + "<br />")

                                    ' 03/28/2006 - By David D. Cruger; Added Company WebSite and EMail
                                    If Not IsDBNull(Row.Item("comp_web_address")) Then
                                        htmlOut.Append(Row.Item("comp_web_address").ToString.Trim + "<br />")
                                    End If

                                    If Not IsDBNull(Row.Item("comp_email_address")) Then
                                        If Not String.IsNullOrEmpty(Row.Item("comp_email_address").ToString.Trim) Then
                                            htmlOut.Append(Row.Item("comp_email_address").ToString.Trim + "<br />")
                                        Else
                                            htmlOut.Append(localFunctions.get_first_contact_email_address_report(CLng(Row.Item("cref_comp_id").ToString), CLng(Row.Item("cref_journ_id").ToString)).Trim + "<br />")
                                        End If
                                    Else
                                        htmlOut.Append(localFunctions.get_first_contact_email_address_report(CLng(Row.Item("cref_comp_id").ToString), CLng(Row.Item("cref_journ_id").ToString)).Trim + "<br />")
                                    End If

                                    htmlOut.Append(localFunctions.get_phone_info(CLng(Row.Item("cref_comp_id").ToString), CLng(Row.Item("cref_journ_id").ToString), CLng(Row.Item("cref_contact_id").ToString)))

                                End If

                                Exit For
                            End If

                        Case "CHP"

                            If Row.Item("cref_contact_type").ToString.Contains("44") Or CInt(Row.Item("cref_transmit_seq_no").ToString) = 3 Then
                                bGotChiefPilotRecord = True
                            End If

                            If bGotChiefPilotRecord Then

                                If Not bHtmlReport Then

                                    ReturnCompanyInformation_Report(lCompId, lJournID, Row, sCompanyPhoneInfo, sCompanyInfo, True)
                                    ReturnContactInformation_Report(lCompId, lContactId, lJournID, sContactInfo, sContactPhoneInfo)

                                Else

                                    htmlOut.Append(Row.Item("comp_name").ToString.Trim + "<br />")

                                    If CLng(Row.Item("cref_contact_id").ToString.Trim) > 0 Then
                                        htmlOut.Append(localFunctions.get_contact_name_title(CLng(Row.Item("cref_contact_id").ToString.Trim), True))
                                    End If

                                    htmlOut.Append(localFunctions.get_contact_email_address_report(CLng(Row.Item("cref_comp_id").ToString), CLng(Row.Item("cref_contact_id").ToString)).Trim + "<br />")

                                    htmlOut.Append(localFunctions.get_phone_info(CLng(Row.Item("cref_comp_id").ToString), CLng(Row.Item("cref_journ_id").ToString), CLng(Row.Item("cref_contact_id").ToString)))

                                End If

                                Exit For
                            End If

                        Case "EXC"

                            If Row.Item("cref_contact_type").ToString.Contains("99") Or Row.Item("cref_contact_type").ToString.Contains("93") Or CInt(Row.Item("cref_transmit_seq_no").ToString) = 4 Then
                                bGotExclusiveRecord = True
                            End If

                            If bGotExclusiveRecord And Not bGetSecondBroker Then

                                If Not bHtmlReport Then

                                    ReturnCompanyInformation_Report(lCompId, lJournID, Row, sCompanyPhoneInfo, sCompanyInfo, True)
                                    ReturnContactInformation_Report(lCompId, lContactId, lJournID, sContactInfo, sContactPhoneInfo)

                                Else

                                    htmlOut.Append(Row.Item("comp_name").ToString.Trim + "<br />")

                                    If CLng(Row.Item("cref_contact_id").ToString.Trim) > 0 Then
                                        htmlOut.Append(localFunctions.get_contact_name_title(CLng(Row.Item("cref_contact_id").ToString.Trim), True))
                                    End If

                                    htmlOut.Append(localFunctions.get_contact_email_address_report(CLng(Row.Item("cref_comp_id").ToString), CLng(Row.Item("cref_contact_id").ToString)).Trim + "<br />")

                                    htmlOut.Append(localFunctions.get_phone_info(CLng(Row.Item("cref_comp_id").ToString), CLng(Row.Item("cref_journ_id").ToString), CLng(Row.Item("cref_contact_id").ToString)))

                                End If

                                Exit For

                            ElseIf bGotExclusiveRecord And bGetSecondBroker Then

                                If nExclusiveCnt > 0 Then

                                    If Not bHtmlReport Then

                                        ReturnCompanyInformation_Report(lCompId, lJournID, Row, sCompanyPhoneInfo, sCompanyInfo, True)
                                        ReturnContactInformation_Report(lCompId, lContactId, lJournID, sContactInfo, sContactPhoneInfo)

                                    Else

                                        htmlOut.Append(Row.Item("comp_name").ToString.Trim + "<br />")

                                        If CLng(Row.Item("cref_contact_id").ToString.Trim) > 0 Then
                                            htmlOut.Append(localFunctions.get_contact_name_title(CLng(Row.Item("cref_contact_id").ToString.Trim), True))
                                        End If

                                        htmlOut.Append(localFunctions.get_contact_email_address_report(CLng(Row.Item("cref_comp_id").ToString), CLng(Row.Item("cref_contact_id").ToString)).Trim + "<br />")

                                        htmlOut.Append(localFunctions.get_phone_info(CLng(Row.Item("cref_comp_id").ToString), CLng(Row.Item("cref_journ_id").ToString), CLng(Row.Item("cref_contact_id").ToString)))

                                    End If

                                    Exit For
                                Else
                                    nExclusiveCnt += 1
                                End If

                            End If

                        Case "SLS"

                            If Row.Item("cref_contact_type").ToString.Contains("38") Then
                                bGotSalesRecord = True
                            End If

                            If bGotSalesRecord Then

                                If Not bHtmlReport Then

                                    ReturnCompanyInformation_Report(lCompId, lJournID, Row, sCompanyPhoneInfo, sCompanyInfo, True)
                                    ReturnContactInformation_Report(lCompId, lContactId, lJournID, sContactInfo, sContactPhoneInfo)

                                Else

                                    htmlOut.Append(Row.Item("comp_name").ToString.Trim + "<br />")

                                    Dim strAltCompType As String = ""
                                    If Not IsDBNull(Row.Item("comp_name_alt_type")) Then
                                        strAltCompType = Row.Item("comp_name_alt_type").ToString.Trim
                                    Else
                                        strAltCompType = ""
                                    End If

                                    If Not IsDBNull(Row.Item("comp_name_alt")) Then
                                        If Not String.IsNullOrEmpty(strAltCompType) Then
                                            htmlOut.Append(strAltCompType + " " + Row.Item("comp_name_alt").ToString.Trim + "<br />")
                                        Else
                                            htmlOut.Append(Row.Item("comp_name_alt").ToString.Trim + "<br />")
                                        End If
                                    End If

                                    If CLng(Row.Item("cref_contact_id").ToString.Trim) > 0 Then
                                        htmlOut.Append(localFunctions.get_contact_name_title(CLng(Row.Item("cref_contact_id").ToString.Trim), False))
                                    End If

                                    If Not IsDBNull(Row.Item("comp_address1")) Then
                                        htmlOut.Append(Row.Item("comp_address1").ToString.Trim + "<br />")
                                    End If

                                    If Not IsDBNull(Row.Item("comp_zip_code")) Then
                                        htmlOut.Append(Row.Item("comp_city").ToString.Trim + ", " + Row.Item("comp_state").ToString.Trim + "&nbsp;" + Row.Item("comp_zip_code").ToString.Trim + "<br />")
                                    Else
                                        htmlOut.Append(Row.Item("comp_city").ToString.Trim + ", " + Row.Item("comp_state").ToString.Trim + "<br />")
                                    End If

                                    htmlOut.Append(Row.Item("comp_country").ToString.Trim + "<br />")

                                    ' 03/28/2006 - By David D. Cruger; Added Company WebSite and EMail
                                    If Not IsDBNull(Row.Item("comp_web_address")) Then
                                        htmlOut.Append(Row.Item("comp_web_address").ToString.Trim + "<br />")
                                    End If

                                    If Not IsDBNull(Row.Item("comp_email_address")) Then
                                        If Not String.IsNullOrEmpty(Row.Item("comp_email_address").ToString.Trim) Then
                                            htmlOut.Append(Row.Item("comp_email_address").ToString.Trim + "<br />")
                                        Else
                                            htmlOut.Append(localFunctions.get_first_contact_email_address_report(CLng(Row.Item("cref_comp_id").ToString), CLng(Row.Item("cref_journ_id").ToString)).Trim + "<br />")
                                        End If
                                    Else
                                        htmlOut.Append(localFunctions.get_first_contact_email_address_report(CLng(Row.Item("cref_comp_id").ToString), CLng(Row.Item("cref_journ_id").ToString)).Trim + "<br />")
                                    End If

                                    htmlOut.Append(localFunctions.get_phone_info(CLng(Row.Item("cref_comp_id").ToString), CLng(Row.Item("cref_journ_id").ToString), CLng(Row.Item("cref_contact_id").ToString)))

                                End If

                                Exit For

                            End If

                    End Select

                Next

            End If

            If Not bHtmlReport And Not (bGotOwnerRecord Or bGotOperatorRecord Or bGotChiefPilotRecord Or bGotExclusiveRecord Or bGotSalesRecord) Then

                ReturnCompanyInformation_Report(0, 0, Nothing, sCompanyPhoneInfo, sCompanyInfo, True)
                ReturnContactInformation_Report(0, 0, 0, sContactInfo, sContactPhoneInfo)
                strRelation = ""
                strAgencyType = ""
                strBusinessType = ""

            End If

            If bExcelReport Then

                htmlOut.Append("<td>" + strRelation + "</td>")
                htmlOut.Append("<td>" + strAgencyType + "</td>")
                htmlOut.Append("<td>" + strBusinessType + "</td>")
                htmlOut.Append(sCompanyInfo + sCompanyPhoneInfo + sContactInfo + sContactPhoneInfo)

            ElseIf bHtmlReport Then

                If String.IsNullOrEmpty(htmlOut.ToString.Trim) Then

                    Select Case strRelationType.ToUpper.Trim
                        Case "OWR"
                            htmlOut.Append("<b>OWNER:</b>")
                        Case "OPR"
                            htmlOut.Append("<b>OPERATOR:</b>")
                    End Select

                    htmlOut.Append("<br />")
                End If

            ElseIf bTextCommaReport Then

                htmlOut.Append(Constants.QUOTE + strRelation + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + strAgencyType + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + strBusinessType + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(sCompanyInfo + sCompanyPhoneInfo + sContactInfo + sContactPhoneInfo)

            ElseIf bTextTabReport Then

                htmlOut.Append(strRelation + vbTab)
                htmlOut.Append(strAgencyType + vbTab)
                htmlOut.Append(strBusinessType + vbTab)
                htmlOut.Append(sCompanyInfo + sCompanyPhoneInfo + sContactInfo + sContactPhoneInfo)

            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in company_contact_info_report_8(ByVal lACid As Long, ByVal lJournID As Long, ByVal strRelationType As String, ByRef lCompId As Long, ByRef lContactId As Long) As String" + ex.Message
        End Try

        Return htmlOut.ToString

    End Function

    Private Sub get_top_six_feature_codes_report_8(ByVal lACid As Long, ByVal lJournID As Long, ByRef strF1 As String, ByRef strF2 As String, ByRef strF3 As String, ByRef strF4 As String, ByRef strF5 As String, ByRef strF6 As String)

        Dim sQuery = New StringBuilder()

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing

        Dim nFeatureSeqNo As Integer = 0
        Dim sFeatureCodeStatus As String = ""

        Try

            sQuery.Append("SELECT afeat_feature_code, afeat_status_flag, afeat_seq_no FROM Aircraft_Key_Feature WITH(NOLOCK)")
            sQuery.Append(" WHERE (afeat_ac_id = " + lACid.ToString + ")")
            sQuery.Append(" AND (afeat_journ_id = " + lJournID.ToString + ")")
            sQuery.Append(" AND (afeat_seq_no IN (1, 2, 3, 4, 5, 6))")
            sQuery.Append(" ORDER BY afeat_seq_no")

            'HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />get_feature_codes_report_8(ByVal lACid As Long, ByVal lJournID As Long, ByRef strF1 As String, ByRef strF2 As String, ByRef strF3 As String, ByRef strF4 As String, ByRef strF5 As String, ByRef strF6 As String)<br />" + sQuery.ToString

            SqlConn.ConnectionString = localFunctions.clientConnectStr
            SqlConn.Open()
            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString

            SqlReader = SqlCommand.ExecuteReader()

            If SqlReader.HasRows Then

                Do While SqlReader.Read

                    If Not IsDBNull(SqlReader.Item("afeat_seq_no")) Then
                        nFeatureSeqNo = CInt(SqlReader.Item("afeat_seq_no").ToString)
                    Else
                        nFeatureSeqNo = 0
                    End If

                    If Not IsDBNull(SqlReader.Item("afeat_feature_code")) Then
                        If Not String.IsNullOrEmpty(SqlReader.Item("afeat_feature_code").ToString.Trim) Then
                            sFeatureCodeStatus = SqlReader.Item("afeat_feature_code").ToString.PadRight(3)
                        End If
                    End If

                    If Not IsDBNull(SqlReader.Item("afeat_status_flag")) Then
                        If Not String.IsNullOrEmpty(SqlReader.Item("afeat_status_flag").ToString.Trim) Then
                            sFeatureCodeStatus += SqlReader.Item("afeat_status_flag").ToString.ToUpper
                        End If
                    End If

                    Select Case nFeatureSeqNo

                        Case 1
                            strF1 = sFeatureCodeStatus

                        Case 2
                            strF2 = sFeatureCodeStatus

                        Case 3
                            strF3 = sFeatureCodeStatus

                        Case 4
                            strF4 = sFeatureCodeStatus

                        Case 5
                            strF5 = sFeatureCodeStatus

                        Case 6
                            strF6 = sFeatureCodeStatus

                    End Select

                Loop

            End If

            SqlReader.Close()

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in get_feature_codes_report_8(ByVal lACid As Long, ByVal lJournID As Long, ByRef strF1 As String, ByRef strF2 As String, ByRef strF3 As String, ByRef strF4 As String, ByRef strF5 As String, ByRef strF6 As String)" + ex.Message
        Finally
            SqlReader = Nothing

            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing
        End Try

    End Sub

    Private Function get_avionics_report_8(ByVal lACid As Long, ByVal lJournID As Long, ByVal inAVstring As String, ByVal binUseLabels As Boolean) As String

        Dim sQuery = New StringBuilder()
        Dim htmlOut = New StringBuilder()

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing

        Try

            sQuery.Append("SELECT DISTINCT av_name, av_description FROM Aircraft_Avionics WITH(NOLOCK) WHERE av_ac_id = " + lACid.ToString)
            sQuery.Append(" AND (av_ac_journ_id = " + lJournID.ToString + ")")
            sQuery.Append(" AND (av_name = '" + inAVstring.Trim + "')")

            'HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />get_avionics_report_8(ByVal lACid As Long, ByVal lJournID As Long, ByVal inAVstring As String, ByVal binUseLabels As Boolean) As String<br />" + sQuery.ToString

            SqlConn.ConnectionString = localFunctions.clientConnectStr
            SqlConn.Open()
            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString

            SqlReader = SqlCommand.ExecuteReader()

            If SqlReader.HasRows Then

                Do While SqlReader.Read

                    If Not IsDBNull(SqlReader.Item("av_name")) And Not IsDBNull(SqlReader.Item("av_description")) Then

                        If String.IsNullOrEmpty(htmlOut.ToString.Trim) Then
                            If binUseLabels Then
                                htmlOut.Append("<b>" + SqlReader.Item("av_name").ToString.Trim + ":</b>&nbsp;" + HttpContext.Current.Server.HtmlEncode(SqlReader.Item("av_description").ToString.Trim).Trim)
                            Else
                                htmlOut.Append(SqlReader.Item("av_description").ToString.Trim)
                            End If
                        Else
                            If binUseLabels Then
                                htmlOut.Append("<br /><b>" + SqlReader.Item("av_name").ToString.Trim + ":</b>&nbsp;" + HttpContext.Current.Server.HtmlEncode(SqlReader.Item("av_description").ToString.Trim).Trim)
                            Else
                                htmlOut.Append(Constants.cSingleSpace + SqlReader.Item("av_description").ToString.Trim)
                            End If
                        End If

                    End If

                Loop

            End If

            SqlReader.Close()

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in get_avionics_report_8(ByVal lACid As Long, ByVal lJournID As Long, ByVal inAVstring As String, ByVal binUseLabels As Boolean) As String" + ex.Message
        Finally
            SqlReader = Nothing

            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing
        End Try

        Return htmlOut.ToString

    End Function

    Private Function get_feature_codes_report_8_html(ByVal lACid As Long, ByVal lJournID As Long) As String

        Dim sQuery = New StringBuilder()
        Dim htmlOut = New StringBuilder()

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing

        Dim bFirstOne As Boolean = True
        Dim nCounter As Integer = -1

        Try

            sQuery.Append("SELECT * FROM Aircraft_Key_Feature WITH(NOLOCK) WHERE (afeat_ac_id = " + lACid.ToString)
            sQuery.Append(" AND afeat_journ_id = " + lJournID.ToString + ") ORDER BY afeat_seq_no")

            'HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />get_feature_codes_report_8_html(ByVal lACid As Long, ByVal lJournID As Long) As String<br />" + sQuery.ToString

            SqlConn.ConnectionString = localFunctions.clientConnectStr
            SqlConn.Open()
            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString

            SqlReader = SqlCommand.ExecuteReader()

            If SqlReader.HasRows Then

                Do While SqlReader.Read

                    nCounter += 1

                    If nCounter = 3 Then
                        htmlOut.Append("</tr><tr>")
                        nCounter = 0
                    End If

                    If bFirstOne Then
                        htmlOut.Append("<tr>")
                        bFirstOne = False
                    End If

                    htmlOut.Append("<td width='33%' valign='top' align='left' nowrap='nowrap'><b>" + SqlReader.Item("afeat_feature_code").ToString.ToUpper.Trim + ":</b>&nbsp;" + SqlReader.Item("afeat_status_flag").ToString.Trim + "</td>")

                Loop

            End If ' not (adoRs.bof and adoRs.eof) then

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in get_feature_codes_report_8_html(ByVal inACID As Long, ByVal inJournID As Long) As String" + ex.Message
        Finally
            SqlReader = Nothing

            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing
        End Try

        Return htmlOut.ToString

    End Function

#End Region

#Region "report_9_functions"

    Public Function create_report_9_export_aircraft_list_extra_company_info(ByRef record_count As Long) As String

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim report_9_datatable As New DataTable

        Dim adoRS_9 As System.Data.SqlClient.SqlDataReader : adoRS_9 = Nothing

        Dim htmlOut = New StringBuilder()
        Dim sQuery As New StringBuilder()

        Try

            SqlConn.ConnectionString = localFunctions.clientConnectStr

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 90

            sQuery.Append("SELECT DISTINCT * ")
            sQuery.Append(HttpContext.Current.Session.Item("MasterAircraftFrom").ToString)
            sQuery.Append(HttpContext.Current.Session.Item("MasterAircraftWhere").ToString)
            sQuery.Append(" ORDER BY amod_make_name, amod_airframe_type_code, amod_type_code, amod_id, amod_model_name, ac_ser_no_sort")

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />Create_Report_9_Export_Aircraft_List_Extra_Company_Info()<br />" + sQuery.ToString

            If bHtmlReport Then
                htmlOut.Append("<!DOCTYPE html>")
                htmlOut.Append("<html lang='en'>")
                htmlOut.Append("<head>")
                htmlOut.Append("<meta http-equiv='Content-Language' content='en-us' />")
                htmlOut.Append("<meta http-equiv='Content-Type' content='text/html; charset=windows-1252' />")
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='common/jetnet.css' />")
                htmlOut.Append("<title>JETNET - Export of Current Aircraft List With Extra Company Info</title>")
                htmlOut.Append("</head>")
                htmlOut.Append("<body style='background: white; margin-top:10px; margin-left:10px;'>")
                htmlOut.Append("<div style='text-align:center;'>")
            End If

            If bExcelReport Then
                htmlOut.Append(localFunctions.include_excel_report_style() + vbCrLf)
                htmlOut.Append("<table border='1' cellpadding='2' cellspacing='0'>")
            ElseIf bHtmlReport Then
                htmlOut.Append("<table class='centerTable' border='0' cellpadding='2' cellspacing='0' width='100%'>")
            End If

            SqlCommand.CommandText = sQuery.ToString
            adoRS_9 = SqlCommand.ExecuteReader()

            Try
                report_9_datatable.Load(adoRS_9)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = report_9_datatable.GetErrors()
            End Try

            record_count = report_9_datatable.Rows.Count

            adoRS_9.Close()
            adoRS_9 = Nothing

            If report_9_datatable.Rows.Count > 0 Then

                If chkShowReportHeader.Checked Then

                    If bExcelReport Or bHtmlReport Then

                        htmlOut.Append("<tr bgcolor='#CCCCCC'>")

                        htmlOut.Append("<td align='left'>MAKE</td>")
                        htmlOut.Append("<td align='left'>MODEL</td>")
                        htmlOut.Append("<td align='left'>YEAR&nbsp;MFG</td>")
                        htmlOut.Append("<td align='left'>YEAR&nbsp;DLV</td>")
                        htmlOut.Append("<td align='left'>SERIALNBR</td>")
                        htmlOut.Append("<td align='left'>REGNBR</td>")

                        If Not bAerodexFlag Then
                            htmlOut.Append("<td align='left'>STATUS</td>")
                            htmlOut.Append("<td align='left'>PRICE</td>")
                            htmlOut.Append("<td align='left'>DELIVERY</td>")
                            htmlOut.Append("<td align='left'>DATE&nbsp;LISTED</td>")
                        End If

                        htmlOut.Append("<td align='left'>COMPANY</td>")
                        htmlOut.Append("<td align='left'>LAST&nbsp;CHANGED</td>")

                        htmlOut.Append("<td align='left'>AFTT</td>")
                        htmlOut.Append("<td align='left'>ENG&nbsp;1&nbsp;TT</td>")
                        htmlOut.Append("<td align='left'>ENG&nbsp;2&nbsp;TT</td>")
                        htmlOut.Append("<td align='left'>ENG&nbsp;3&nbsp;TT</td>")
                        htmlOut.Append("<td align='left'>ENG&nbsp;4&nbsp;TT</td>")
                        htmlOut.Append("<td align='left'>SMOH&nbsp;1</td>")
                        htmlOut.Append("<td align='left'>SMOH&nbsp;2</td>")
                        htmlOut.Append("<td align='left'>SMOH&nbsp;3</td>")
                        htmlOut.Append("<td align='left'>SMOH&nbsp;4</td>")

                        htmlOut.Append("</tr>")

                    ElseIf bTextCommaReport Then

                        htmlOut.Append(Constants.QUOTE + "MAKE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "MODEL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "YEAR MFG" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "YEAR DLV" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SERIALNBR" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "REGNBR" + Constants.QUOTE + Constants.cCommaDelim)

                        If Not bAerodexFlag Then
                            htmlOut.Append(Constants.QUOTE + "STATUS" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "PRICE" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "DELIVERY" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "DATE LISTED" + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        htmlOut.Append(Constants.QUOTE + "COMPANY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "LAST CHANGED" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "AFTT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "ENG 1 TT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "ENG 2 TT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "ENG 3 TT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "ENG 4 TT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SMOH 1" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SMOH 2" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SMOH 3" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SMOH 4" + Constants.QUOTE)

                        htmlOut.Append(vbCrLf)

                    ElseIf bTextTabReport Then

                        htmlOut.Append("MAKE" + vbTab)
                        htmlOut.Append("MODEL" + vbTab)
                        htmlOut.Append("YEAR MFG" + vbTab)
                        htmlOut.Append("YEAR DLV" + vbTab)
                        htmlOut.Append("SERIALNBR" + vbTab)
                        htmlOut.Append("REGNBR" + vbTab)

                        If Not bAerodexFlag Then
                            htmlOut.Append("STATUS" + vbTab)
                            htmlOut.Append("PRICE" + vbTab)
                            htmlOut.Append("DELIVERY" + vbTab)
                            htmlOut.Append("DATE LISTED" + vbTab)
                        End If

                        htmlOut.Append("COMPANY" + vbTab)
                        htmlOut.Append("LAST CHANGED" + vbTab)

                        htmlOut.Append("AFTT" + vbTab)
                        htmlOut.Append("ENG 1 TT" + vbTab)
                        htmlOut.Append("ENG 2 TT" + vbTab)
                        htmlOut.Append("ENG 3 TT" + vbTab)
                        htmlOut.Append("ENG 4 TT" + vbTab)
                        htmlOut.Append("SMOH 1" + vbTab)
                        htmlOut.Append("SMOH 2" + vbTab)
                        htmlOut.Append("SMOH 3" + vbTab)
                        htmlOut.Append("SMOH 4")

                        htmlOut.Append(vbCrLf)

                    End If   ' 

                End If ' chkShowReportHeader.Checked Then

                For Each Row As DataRow In report_9_datatable.Rows

                    If bHtmlReport Or bExcelReport Then

                        htmlOut.Append("<tr>")

                        htmlOut.Append("<td align='left' valign='top'>" + Row.Item("amod_make_name").ToString.Trim + "</td>")
                        htmlOut.Append("<td align='left' valign='top' nowrap='nowrap'>" + Row.Item("amod_model_name").ToString.Trim + "</td>")

                        If Not IsDBNull(Row.Item("ac_mfr_year")) Then
                            htmlOut.Append("<td align='left' valign='top'>" + Row.Item("ac_mfr_year").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td align='left' valign='top'></td>")
                        End If

                        If Not IsDBNull(Row.Item("ac_year")) Then
                            htmlOut.Append("<td align='left' valign='top'>" + Row.Item("ac_year").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td align='left' valign='top'></td>")
                        End If

                        If Not IsDBNull(Row.Item("ac_ser_no_full")) Then
                            htmlOut.Append("<td align='left' valign='top' class='textformat'>" + Row.Item("ac_ser_no_full").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td align='left' valign='top'></td>")
                        End If

                        If Not IsDBNull(Row.Item("ac_reg_no")) Then
                            htmlOut.Append("<td align='left' valign='top' class='textformat'>" + Row.Item("ac_reg_no").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td align='left' valign='top'></td>")
                        End If

                        ' Aerodex users don't get this column at all
                        If Not bAerodexFlag Then

                            If Not IsDBNull(Row.Item("ac_forsale_flag")) Then

                                If Row.Item("ac_forsale_flag").ToString.Trim.ToUpper.Contains("Y") Then
                                    htmlOut.Append("<td align='left' valign='top' nowrap='nowrap'>" + Row.Item("ac_status").ToString.Trim + "</td>")

                                    If Not IsDBNull(Row.Item("ac_asking")) Then
                                        If Row.Item("ac_asking").ToString.Trim.ToLower.Contains("price") Then
                                            If Not IsDBNull(Row.Item("ac_asking_price")) Then
                                                htmlOut.Append("<td align='left' valign='top' nowrap='nowrap'>$" + FormatNumber(Row.Item("ac_asking_price").ToString, 0, False, False, True) + "</td>")
                                            Else
                                                htmlOut.Append("<td align='left' valign='top'></td>")
                                            End If
                                        Else
                                            htmlOut.Append("<td align='left' valign='top' nowrap='nowrap'>" + Row.Item("ac_asking").ToString.Trim + "</td>")
                                        End If
                                    Else
                                        htmlOut.Append("<td align='left' valign='top'></td>")
                                    End If

                                    If Not IsDBNull(Row.Item("ac_delivery")) Then
                                        If Row.Item("ac_delivery").ToString.Trim.ToLower.Contains("date") Then
                                            htmlOut.Append("<td align='left' valign='top'>" + FormatDateTime(Row.Item("ac_delivery_date").ToString.Trim, DateFormat.ShortDate) + "</td>")
                                        Else
                                            htmlOut.Append("<td align='left' valign='top'>" + Row.Item("ac_delivery").ToString.Trim + "</td>")
                                        End If
                                    Else
                                        htmlOut.Append("<td align='left' valign='top'></td>")
                                    End If

                                    If Not IsDBNull(Row.Item("ac_list_date")) Then
                                        htmlOut.Append("<td align='left' valign='top'>" + FormatDateTime(Row.Item("ac_list_date").ToString.Trim, DateFormat.ShortDate) + "</td>")
                                    Else
                                        htmlOut.Append("<td align='left' valign='top'></td>")
                                    End If
                                Else
                                    If Not IsDBNull(Row.Item("ac_status")) Then
                                        htmlOut.Append("<td align='left' valign='top' nowrap='nowrap'>" + Row.Item("ac_status").ToString.Trim + "</td>")
                                        htmlOut.Append("<td align='left' valign='top'></td>")
                                        htmlOut.Append("<td align='left' valign='top'></td>")
                                        htmlOut.Append("<td align='left' valign='top'></td>")
                                    Else
                                        htmlOut.Append("<td align='left' valign='top'></td>")
                                        htmlOut.Append("<td align='left' valign='top'></td>")
                                        htmlOut.Append("<td align='left' valign='top'></td>")
                                        htmlOut.Append("<td align='left' valign='top'></td>")
                                    End If
                                End If
                            Else
                                If Not IsDBNull(Row.Item("ac_status")) Then
                                    htmlOut.Append("<td align='left' valign='top' nowrap='nowrap'>" + Row.Item("ac_status").ToString.Trim + "</td>")
                                    htmlOut.Append("<td align='left' valign='top'></td>")
                                    htmlOut.Append("<td align='left' valign='top'></td>")
                                    htmlOut.Append("<td align='left' valign='top'></td>")
                                Else
                                    htmlOut.Append("<td align='left' valign='top'></td>")
                                    htmlOut.Append("<td align='left' valign='top'></td>")
                                    htmlOut.Append("<td align='left' valign='top'></td>")
                                    htmlOut.Append("<td align='left' valign='top'></td>")
                                End If
                            End If
                        End If

                        htmlOut.Append("<td align='left' valign='top' nowrap='nowrap'>")
                        htmlOut.Append(ReturnAircraftReferenceCompanyInformation_Report(CLng(Row.Item("ac_id").ToString), 0, True))
                        htmlOut.Append("</td><td align='left' valign='top'>")

                        If Not IsDBNull(Row.Item("ac_upd_date")) Then
                            If IsDate(Row.Item("ac_upd_date").ToString) Then
                                htmlOut.Append(FormatDateTime(Row.Item("ac_upd_date"), DateFormat.ShortDate).ToString.Trim)
                            End If
                        End If

                        htmlOut.Append("</td><td align='left' valign='top'>")

                        If Not IsDBNull(Row.Item("ac_airframe_tot_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_airframe_tot_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_airframe_tot_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append("</td><td align='left' valign='top'>")

                        If Not IsDBNull(Row.Item("ac_engine_1_tot_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_1_tot_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_1_tot_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append("</td><td align='left' valign='top'>")

                        If Not IsDBNull(Row.Item("ac_engine_2_tot_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_2_tot_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_2_tot_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append("</td><td align='left' valign='top'>")

                        If Not IsDBNull(Row.Item("ac_engine_3_tot_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_3_tot_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_3_tot_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append("</td><td align='left' valign='top'>")

                        If Not IsDBNull(Row.Item("ac_engine_4_tot_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_4_tot_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_4_tot_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append("</td><td align='left' valign='top'>")

                        If Not IsDBNull(Row.Item("ac_engine_1_soh_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_1_soh_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_1_soh_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append("</td><td align='left' valign='top'>")

                        If Not IsDBNull(Row.Item("ac_engine_2_soh_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_2_soh_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_2_soh_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append("</td><td align='left' valign='top'>")

                        If Not IsDBNull(Row.Item("ac_engine_3_soh_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_3_soh_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_3_soh_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append("</td><td align='left' valign='top'>")

                        If Not IsDBNull(Row.Item("ac_engine_4_soh_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_4_soh_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_4_soh_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append("</td></tr>")

                        htmlOut.Append(IIf(bHtmlReport, "<tr><td colspan='" + IIf(bAerodexFlag, "17", "21") + "'><hr height='1'></td></tr>", ""))

                    ElseIf bTextCommaReport Then

                        htmlOut.Append(Constants.QUOTE + Row.Item("amod_make_name").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + Row.Item("amod_model_name").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE)

                        If Not IsDBNull(Row.Item("ac_mfr_year")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_mfr_year").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_mfr_year").ToString)
                            End If
                        End If

                        htmlOut.Append(Constants.QUOTE + Constants.cCommaDelim + Constants.QUOTE)

                        If Not IsDBNull(Row.Item("ac_year")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_year").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_year").ToString)
                            End If
                        End If

                        htmlOut.Append(Constants.QUOTE + Constants.cCommaDelim + Constants.QUOTE)

                        If Not IsDBNull(Row.Item("ac_ser_no_full")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_ser_no_full").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_ser_no_full").ToString)
                            End If
                        End If

                        htmlOut.Append(Constants.QUOTE + Constants.cCommaDelim + Constants.QUOTE)

                        If Not IsDBNull(Row.Item("ac_reg_no")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_reg_no").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_reg_no").ToString)
                            End If
                        End If

                        htmlOut.Append(Constants.QUOTE + Constants.cCommaDelim + Constants.QUOTE)

                        ' Aerodex users don't get this column at all
                        If Not bAerodexFlag Then

                            If Not IsDBNull(Row.Item("ac_forsale_flag")) Then

                                If Row.Item("ac_forsale_flag").ToString.Trim.ToUpper.Contains("Y") Then
                                    htmlOut.Append(Constants.QUOTE + Row.Item("ac_status").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)

                                    If Not IsDBNull(Row.Item("ac_asking")) Then
                                        If Row.Item("ac_asking").ToString.Trim.ToLower.Contains("price") Then
                                            If Not IsDBNull(Row.Item("ac_asking_price")) Then
                                                htmlOut.Append(Constants.QUOTE + "$" + FormatNumber(Row.Item("ac_asking_price").ToString, 0, False, False, True) + Constants.QUOTE + Constants.cCommaDelim)
                                            Else
                                                htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                            End If
                                        Else
                                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_asking").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                                        End If
                                    Else
                                        htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                    End If


                                    If Not IsDBNull(Row.Item("ac_delivery")) Then
                                        If Row.Item("ac_delivery").ToString.Trim.ToLower.Contains("date") Then
                                            htmlOut.Append(Constants.QUOTE + FormatDateTime(Row.Item("ac_delivery_date").ToString.Trim, DateFormat.ShortDate) + Constants.QUOTE + Constants.cCommaDelim)
                                        Else
                                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_delivery").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                                        End If
                                    Else
                                        htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                    End If

                                    If Not IsDBNull(Row.Item("ac_list_date")) Then
                                        htmlOut.Append(Constants.QUOTE + FormatDateTime(Row.Item("ac_list_date").ToString.Trim, DateFormat.ShortDate) + Constants.QUOTE + Constants.cCommaDelim)
                                    Else
                                        htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                    End If
                                Else
                                    If Not IsDBNull(Row.Item("ac_status")) Then
                                        htmlOut.Append(Constants.QUOTE + Row.Item("ac_status").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                                        htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                        htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                        htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                    Else
                                        htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                        htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                        htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                        htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                    End If
                                End If
                            Else
                                If Not IsDBNull(Row.Item("ac_status")) Then
                                    htmlOut.Append(Constants.QUOTE + Row.Item("ac_status").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                Else
                                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                End If
                            End If
                        End If

                        htmlOut.Append(Constants.QUOTE)

                        htmlOut.Append(ReturnAircraftReferenceCompanyInformation_Report(CLng(Row.Item("ac_id").ToString), 0, True))

                        htmlOut.Append(Constants.QUOTE + Constants.cCommaDelim + Constants.QUOTE)

                        If Not IsDBNull(Row.Item("ac_upd_date")) Then
                            If IsDate(Row.Item("ac_upd_date").ToString) Then
                                htmlOut.Append(FormatDateTime(Row.Item("ac_upd_date"), DateFormat.ShortDate).ToString.Trim)
                            End If
                        End If

                        htmlOut.Append(Constants.QUOTE + Constants.cCommaDelim + Constants.QUOTE)

                        If Not IsDBNull(Row.Item("ac_airframe_tot_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_airframe_tot_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_airframe_tot_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append(Constants.QUOTE + Constants.cCommaDelim + Constants.QUOTE)

                        If Not IsDBNull(Row.Item("ac_engine_1_tot_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_1_tot_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_1_tot_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append(Constants.QUOTE + Constants.cCommaDelim + Constants.QUOTE)

                        If Not IsDBNull(Row.Item("ac_engine_2_tot_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_2_tot_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_2_tot_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append(Constants.QUOTE + Constants.cCommaDelim + Constants.QUOTE)

                        If Not IsDBNull(Row.Item("ac_engine_3_tot_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_3_tot_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_3_tot_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append(Constants.QUOTE + Constants.cCommaDelim + Constants.QUOTE)

                        If Not IsDBNull(Row.Item("ac_engine_4_tot_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_4_tot_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_4_tot_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append(Constants.QUOTE + Constants.cCommaDelim + Constants.QUOTE)

                        If Not IsDBNull(Row.Item("ac_engine_1_soh_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_1_soh_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_1_soh_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append(Constants.QUOTE + Constants.cCommaDelim + Constants.QUOTE)

                        If Not IsDBNull(Row.Item("ac_engine_2_soh_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_2_soh_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_2_soh_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append(Constants.QUOTE + Constants.cCommaDelim + Constants.QUOTE)

                        If Not IsDBNull(Row.Item("ac_engine_3_soh_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_3_soh_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_3_soh_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append(Constants.QUOTE + Constants.cCommaDelim + Constants.QUOTE)

                        If Not IsDBNull(Row.Item("ac_engine_4_soh_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_4_soh_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_4_soh_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append(Constants.QUOTE + vbCrLf)

                    ElseIf bTextTabReport Then

                        htmlOut.Append(Row.Item("amod_make_name").ToString.Trim + vbTab)
                        htmlOut.Append(Row.Item("amod_model_name").ToString.Trim + vbTab)

                        If Not IsDBNull(Row.Item("ac_mfr_year")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_mfr_year").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_mfr_year").ToString)
                            End If
                        End If

                        htmlOut.Append(vbTab)

                        If Not IsDBNull(Row.Item("ac_year")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_year").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_year").ToString)
                            End If
                        End If

                        htmlOut.Append(vbTab)

                        If Not IsDBNull(Row.Item("ac_ser_no_full")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_ser_no_full").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_ser_no_full").ToString)
                            End If
                        End If

                        htmlOut.Append(vbTab)

                        If Not IsDBNull(Row.Item("ac_reg_no")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_reg_no").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_reg_no").ToString)
                            End If
                        End If

                        htmlOut.Append(vbTab)

                        ' Aerodex users don't get this column at all
                        If Not bAerodexFlag Then

                            If Not IsDBNull(Row.Item("ac_forsale_flag")) Then

                                If Row.Item("ac_forsale_flag").ToString.Trim.ToUpper.Contains("Y") Then
                                    htmlOut.Append(Row.Item("ac_status").ToString.Trim + vbTab)

                                    If Not IsDBNull(Row.Item("ac_asking")) Then
                                        If Row.Item("ac_asking").ToString.Trim.ToLower.Contains("price") Then
                                            If Not IsDBNull(Row.Item("ac_asking_price")) Then
                                                htmlOut.Append("$" + FormatNumber(Row.Item("ac_asking_price").ToString, 0, False, False, True) + vbTab)
                                            Else
                                                htmlOut.Append(vbTab)
                                            End If
                                        Else
                                            htmlOut.Append(Row.Item("ac_asking").ToString.Trim + vbTab)
                                        End If
                                    Else
                                        htmlOut.Append(vbTab)
                                    End If

                                    If Not IsDBNull(Row.Item("ac_delivery")) Then
                                        If Row.Item("ac_delivery").ToString.Trim.ToLower.Contains("date") Then
                                            htmlOut.Append(FormatDateTime(Row.Item("ac_delivery_date").ToString.Trim, DateFormat.ShortDate) + vbTab)
                                        Else
                                            htmlOut.Append(Row.Item("ac_delivery").ToString.Trim + vbTab)
                                        End If
                                    Else
                                        htmlOut.Append(vbTab)
                                    End If

                                    If Not IsDBNull(Row.Item("ac_list_date")) Then
                                        htmlOut.Append(FormatDateTime(Row.Item("ac_list_date").ToString.Trim, DateFormat.ShortDate) + vbTab)
                                    Else
                                        htmlOut.Append(vbTab)
                                    End If
                                Else
                                    If Not IsDBNull(Row.Item("ac_status")) Then
                                        htmlOut.Append(Row.Item("ac_status").ToString.Trim + vbTab)
                                        htmlOut.Append(vbTab)
                                        htmlOut.Append(vbTab)
                                        htmlOut.Append(vbTab)
                                    Else
                                        htmlOut.Append(vbTab)
                                        htmlOut.Append(vbTab)
                                        htmlOut.Append(vbTab)
                                        htmlOut.Append(vbTab)
                                    End If
                                End If
                            Else
                                If Not IsDBNull(Row.Item("ac_status")) Then
                                    htmlOut.Append(Row.Item("ac_status").ToString.Trim + vbTab)
                                    htmlOut.Append(vbTab)
                                    htmlOut.Append(vbTab)
                                    htmlOut.Append(vbTab)
                                Else
                                    htmlOut.Append(vbTab)
                                    htmlOut.Append(vbTab)
                                    htmlOut.Append(vbTab)
                                    htmlOut.Append(vbTab)
                                End If
                            End If
                        End If

                        htmlOut.Append(ReturnAircraftReferenceCompanyInformation_Report(CLng(Row.Item("ac_id").ToString), 0, True))

                        htmlOut.Append(vbTab)

                        If Not IsDBNull(Row.Item("ac_upd_date")) Then
                            If IsDate(Row.Item("ac_upd_date").ToString) Then
                                htmlOut.Append(FormatDateTime(Row.Item("ac_upd_date"), DateFormat.ShortDate).ToString.Trim)
                            End If
                        End If

                        htmlOut.Append(vbTab)

                        If Not IsDBNull(Row.Item("ac_airframe_tot_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_airframe_tot_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_airframe_tot_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append(vbTab)

                        If Not IsDBNull(Row.Item("ac_engine_1_tot_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_1_tot_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_1_tot_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append(vbTab)

                        If Not IsDBNull(Row.Item("ac_engine_2_tot_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_2_tot_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_2_tot_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append(vbTab)

                        If Not IsDBNull(Row.Item("ac_engine_3_tot_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_3_tot_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_3_tot_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append(vbTab)

                        If Not IsDBNull(Row.Item("ac_engine_4_tot_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_4_tot_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_4_tot_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append(vbTab)

                        If Not IsDBNull(Row.Item("ac_engine_1_soh_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_1_soh_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_1_soh_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append(vbTab)

                        If Not IsDBNull(Row.Item("ac_engine_2_soh_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_2_soh_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_2_soh_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append(vbTab)

                        If Not IsDBNull(Row.Item("ac_engine_3_soh_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_3_soh_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_3_soh_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append(vbTab)

                        If Not IsDBNull(Row.Item("ac_engine_4_soh_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_4_soh_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_4_soh_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append(vbCrLf)

                    End If

                Next

            End If

            If bHtmlReport Or bExcelReport Then
                htmlOut.Append("</table>")
            End If

            If bHtmlReport Then
                htmlOut.Append("</div>")
                htmlOut.Append("</body>")
                htmlOut.Append("</html>")
            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Create_Report_9_Export_Aircraft_List_Extra_Company_Info()" + ex.Message
        Finally

            report_9_datatable = Nothing

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOut.ToString

    End Function

#End Region

#Region "report_10_functions"

    Public Function create_report_10_standard_available_listing(ByRef record_count As Long) As String

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim report_10_datatable As New DataTable

        Dim adoRS_10 As System.Data.SqlClient.SqlDataReader : adoRS_10 = Nothing

        Dim htmlOut = New StringBuilder()
        Dim sQuery As New StringBuilder()

        Dim nTotalSpanCount As Integer = 7
        Dim sRememberSerialNo As String = ""

        Try

            SqlConn.ConnectionString = localFunctions.clientConnectStr

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 90

            If HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("comp_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("contact_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("state_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("country_") Then
                sQuery.Append("SELECT DISTINCT * FROM View_Aircraft_Company_Flat WITH(NOLOCK) ")
            Else
                sQuery.Append("SELECT DISTINCT * FROM View_Aircraft_Flat WITH(NOLOCK) ")
            End If

            sQuery.Append(HttpContext.Current.Session.Item("MasterAircraftWhere").ToString)
            sQuery.Append(" ORDER BY amod_make_name, amod_model_name, ac_ser_no_sort")

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />Create_Report_10_Standard_Available_Listing()<br />" + sQuery.ToString

            If bHtmlReport Or bPdfReport Then
                htmlOut.Append("<!DOCTYPE html>")
                htmlOut.Append("<html lang='en'>")
                htmlOut.Append("<head>")
                htmlOut.Append("<meta http-equiv='Content-Language' content='en-us' />")
                htmlOut.Append("<meta http-equiv='Content-Type' content='text/html; charset=windows-1252' />")
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='common/jetnet.css' />")
                htmlOut.Append("<title>JETNET - Standard Available Listing</title>")

                If bPdfReport Then
                    htmlOut.Append(" <style type='text/css'>")
                    htmlOut.Append("   body { margin-top:0px; margin-left:0px; margin-right:0px; margin-bottom:0px; font-family:Tahoma; font-size:11px; background-color:#ffffff; }" + vbCrLf)
                    htmlOut.Append("   table.break { page-break-before: always; }" + vbCrLf)
                    htmlOut.Append("   table.centerTable { margin-right: auto; margin-left: auto; }" + vbCrLf)
                    htmlOut.Append(" </style>")
                    htmlOut.Append("</head>")

                    htmlOut.Append("<body>")

                Else

                    htmlOut.Append("</head>")
                    htmlOut.Append("<body style='background: white; margin-top:10px; margin-left:10px; font-size: 10pt;'>")

                End If

                htmlOut.Append("<div style='text-align:center;'>")
            End If

            SqlCommand.CommandText = sQuery.ToString
            adoRS_10 = SqlCommand.ExecuteReader()

            Try
                report_10_datatable.Load(adoRS_10)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = report_10_datatable.GetErrors()
            End Try

            record_count = report_10_datatable.Rows.Count

            adoRS_10.Close()
            adoRS_10 = Nothing

            If report_10_datatable.Rows.Count > 0 Then

                If bExcelReport Then
                    htmlOut.Append(localFunctions.include_excel_report_style() + vbCrLf)
                    htmlOut.Append("<table border='1' cellpadding='2' cellspacing='0'>")
                    htmlOut.Append("<tr bgcolor='#CCCCCC'><td valign='middle' align='left' colspan='4'><strong>" + FormatDateTime(Now(), DateFormat.GeneralDate).ToString + "</strong></td>")
                    htmlOut.Append("<td valign='middle' align='left' colspan='" + nTotalSpanCount.ToString + "'><strong>Standard Available Listing</strong></td></tr>")
                    htmlOut.Append("<tr bgcolor='#CCCCCC'><td valign='middle' align='left' colspan='" + (nTotalSpanCount + 4).ToString + "'></td></tr>")
                ElseIf bHtmlReport Or bPdfReport Then
                    htmlOut.Append("<table class='centerTable' border='0' cellpadding='2' cellspacing='0' width='100%'>")
                    htmlOut.Append("<tr bgcolor='#CCCCCC'><td valign='middle' align='left' colspan='4'><strong>" + FormatDateTime(Now(), DateFormat.GeneralDate).ToString + "</strong></td>")
                    htmlOut.Append("<td valign='middle' align='left' colspan='" + nTotalSpanCount.ToString + "'><strong>Standard Available Listing</strong></td></tr>")
                    htmlOut.Append("<tr bgcolor='#CCCCCC'><td width='100%' valign='middle' align='left' colspan='" + (nTotalSpanCount + 4).ToString + "'><hr></td></tr>")
                End If

                htmlOut.Append("<tr bgcolor='#CCCCCC'>")

                htmlOut.Append("<td align='left' valign='middle' colspan='2'>MAKE</td>")
                htmlOut.Append("<td align='left' valign='middle' colspan='" + (nTotalSpanCount + 2).ToString + "'>MODEL</td></tr>")

                htmlOut.Append("<tr bgcolor='#CCCCCC'>")
                htmlOut.Append("<td align='left' valign='middle'>SERNBR</td>")
                htmlOut.Append("<td align='left' valign='middle'>AFTT</td>")
                htmlOut.Append("<td align='left' valign='middle'>ENGTT1</td>")
                htmlOut.Append("<td align='left' valign='middle'>ENGTT2</td>")
                htmlOut.Append("<td align='left' valign='middle'>ENGTT3</td>")
                htmlOut.Append("<td align='left' valign='middle'>ENGTT4</td>")
                htmlOut.Append("<td align='left' valign='middle'>FEATURES</td>")

                htmlOut.Append("<td align='left' valign='middle'>ASKING</td>")
                htmlOut.Append("<td align='left' valign='middle'>OWN</td>")
                htmlOut.Append("<td align='left' valign='middle'>&nbsp;</td>")
                htmlOut.Append("<td align='left' valign='middle'>ST</td></tr>")

                htmlOut.Append("<tr bgcolor='#CCCCCC'>")
                htmlOut.Append("<td align='left' valign='middle'>YR</td>")
                htmlOut.Append("<td align='left' valign='middle'>REGNBR</td>")
                htmlOut.Append("<td align='left' valign='middle'>SMOH1</td>")
                htmlOut.Append("<td align='left' valign='middle'>SMOH2</td>")
                htmlOut.Append("<td align='left' valign='middle'>SMOH3</td>")
                htmlOut.Append("<td align='left' valign='middle'>SMOH4</td>")
                htmlOut.Append("<td align='left' valign='middle'>&nbsp;</td>")

                If Not bAerodexFlag Then
                    htmlOut.Append("<td align='left' valign='middle'>STATUS</td>")
                Else
                    htmlOut.Append("<td align='left' valign='middle'></td>")
                End If

                htmlOut.Append("<td align='left' valign='middle'>CDS</td>")
                htmlOut.Append("<td align='left' valign='middle'>DATE&nbsp;LISTED</td>")

                If Not bAerodexFlag Then
                    htmlOut.Append("<td align='left' valign='middle'>EXCBRK</td>")
                Else
                    htmlOut.Append("<td align='left' valign='middle'></td>")
                End If

                htmlOut.Append("</tr>")
                htmlOut.Append("<tr bgcolor='#CCCCCC'>")
                htmlOut.Append("<td align='left' valign='middle' colspan='2'>&nbsp;</td>")
                htmlOut.Append("<td align='left' valign='middle' colspan='" + (nTotalSpanCount + 2).ToString + "'>OWNER</td>")
                htmlOut.Append("</tr>")

                For Each Row As DataRow In report_10_datatable.Rows

                    If Not sRememberSerialNo.ToLower.Contains(Row.Item("ac_ser_no_sort").ToString.ToLower.Trim) Then

                        sRememberSerialNo = Row.Item("ac_ser_no_sort").ToString

                        Dim resultsTable As DataTable = localFunctions.get_owner_info_report(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id").ToString), False, False)

                        htmlOut.Append("<tr>")

                        htmlOut.Append("<td align='left' valign='top' colspan='2'>" + Row.Item("amod_make_name").ToString.Trim + "</td>")
                        htmlOut.Append("<td align='left' valign='top' colspan='4'>" + Row.Item("amod_model_name").ToString.Trim + "</td>")

                        htmlOut.Append("<td align='left' valign='top' rowspan='3'>")

                        Dim sAcFeatureCodes As String = ""
                        localFunctions.get_all_ac_feature_codes(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id").ToString), sAcFeatureCodes)
                        htmlOut.Append(sAcFeatureCodes)

                        htmlOut.Append("</td>")

                        htmlOut.Append("<td align='left' valign='middle' colspan='4'></td>")

                        htmlOut.Append("</tr><tr>")

                        If Not IsDBNull(Row.Item("ac_ser_no_full")) Then
                            htmlOut.Append("<td align='left' valign='top' class='textformat'>" + Row.Item("ac_ser_no_full").ToString.ToUpper.Trim + "</td>")
                        Else
                            htmlOut.Append("<td align='left' valign='top'></td>")
                        End If

                        If Not IsDBNull(Row.Item("ac_airframe_tot_hrs")) Then
                            htmlOut.Append("<td align='left' valign='top'>" + Row.Item("ac_airframe_tot_hrs").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td align='left' valign='top'></td>")
                        End If

                        htmlOut.Append("<td align='left' valign='top'>")

                        If Not IsDBNull(Row.Item("ac_engine_1_tot_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_1_tot_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_1_tot_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append("</td>")
                        htmlOut.Append("<td align='left' valign='top'>")

                        If Not IsDBNull(Row.Item("ac_engine_2_tot_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_2_tot_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_2_tot_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append("</td>")
                        htmlOut.Append("<td align='left' valign='top'>")

                        If Not IsDBNull(Row.Item("ac_engine_3_tot_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_3_tot_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_3_tot_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append("</td>")
                        htmlOut.Append("<td align='left' valign='top'>")

                        If Not IsDBNull(Row.Item("ac_engine_4_tot_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_4_tot_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_4_tot_hrs").ToString)
                            End If
                        End If

                        If Not IsDBNull(Row.Item("ac_asking")) Then
                            If Row.Item("ac_asking").ToString.Trim.ToLower.Contains("price") Then
                                If Not IsDBNull(Row.Item("ac_asking_price")) Then
                                    htmlOut.Append("<td align='left' valign='top' nowrap='nowrap'>$" + FormatNumber(Row.Item("ac_asking_price").ToString, 0, False, False, True) + "</td>")
                                Else
                                    htmlOut.Append("<td align='left' valign='top'></td>")
                                End If
                            Else
                                htmlOut.Append("<td align='left' valign='top' nowrap='nowrap'>" + Row.Item("ac_asking").ToString.Trim + "</td>")
                            End If
                        Else
                            htmlOut.Append("<td align='left' valign='top'></td>")
                        End If

                        If Not IsNothing(resultsTable) Then
                            If resultsTable.Rows.Count > 0 Then
                                htmlOut.Append("<td align='left' valign='top'>" + resultsTable.Rows(0).Item("cref_business_type").ToString.ToUpper.Trim + "</td>")
                            Else
                                htmlOut.Append("<td align='left' valign='top'></td>")
                            End If
                        Else
                            htmlOut.Append("<td align='left' valign='top'></td>")
                        End If

                        htmlOut.Append("<td align='left'></td>")

                        If Not IsNothing(resultsTable) Then
                            If resultsTable.Rows.Count > 0 Then
                                htmlOut.Append("<td align='left' valign='top'>" + resultsTable.Rows(0).Item("comp_state").ToString.ToUpper.Trim + "</td>")
                            Else
                                htmlOut.Append("<td align='left' valign='top'></td>")
                            End If
                        Else
                            htmlOut.Append("<td align='left' valign='top'></td>")
                        End If
                        htmlOut.Append("</td>")

                        htmlOut.Append("</tr><tr>")

                        If Not IsDBNull(Row.Item("ac_year")) Then
                            htmlOut.Append("<td align='left' valign='top'>" + Row.Item("ac_year").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td align='left' valign='top'></td>")
                        End If

                        If Not IsDBNull(Row.Item("ac_reg_no")) Then
                            htmlOut.Append("<td align='left' valign='top' nowrap='nowrap' class='textformat'>" + Row.Item("ac_reg_no").ToString.ToUpper.Trim + "</td>")
                        Else
                            htmlOut.Append("<td align='left' valign='top' nowrap='nowrap'></td>")
                        End If

                        htmlOut.Append("<td align='left' valign='top'>")

                        If Not IsDBNull(Row.Item("ac_engine_1_soh_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_1_soh_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_1_soh_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append("</td>")
                        htmlOut.Append("<td align='left' valign='top'>")

                        If Not IsDBNull(Row.Item("ac_engine_2_soh_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_2_soh_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_2_soh_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append("</td>")
                        htmlOut.Append("<td align='left' valign='top'>")

                        If Not IsDBNull(Row.Item("ac_engine_3_soh_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_3_soh_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_3_soh_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append("</td>")
                        htmlOut.Append("<td align='left' valign='top' colspan='" + IIf(bAerodexFlag, "2", "") + "'>")

                        If Not IsDBNull(Row.Item("ac_engine_4_soh_hrs")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_engine_4_soh_hrs").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_engine_4_soh_hrs").ToString)
                            End If
                        End If

                        htmlOut.Append("</td>")

                        ' Aerodex users don't get this column at all
                        If Not bAerodexFlag Then

                            Dim tmpStatus As String = ""

                            If Not IsDBNull(Row.Item("ac_status")) Then

                                If Not String.IsNullOrEmpty(Row.Item("ac_status").ToString.Trim) Then
                                    tmpStatus = Row.Item("ac_status").ToString.Trim
                                End If

                                If tmpStatus.ToLower.Contains("for sale") Then

                                    If Not IsDBNull(Row.Item("ac_delivery")) Then
                                        If Not String.IsNullOrEmpty(Row.Item("ac_delivery").ToString.Trim) Then
                                            tmpStatus = Row.Item("ac_delivery").ToString.Trim
                                        End If
                                    End If

                                    If tmpStatus.ToLower.Contains("date") Then
                                        tmpStatus = "Deliver " + Row.Item("ac_delivery_date").ToString.Trim
                                    End If

                                End If

                            End If

                            htmlOut.Append("<td align='left' valign='top' nowrap='nowrap'>" + tmpStatus.Trim + "</td>")

                        End If

                        If Not IsNothing(resultsTable) Then
                            If resultsTable.Rows.Count > 0 Then

                                If resultsTable.Rows(0).Item("comp_country").ToString.ToLower.Contains("united states") Then
                                    htmlOut.Append("<td align='left' valign='top'>DM</td>")
                                Else
                                    htmlOut.Append("<td align='left' valign='top'>IL</td>")
                                End If

                            Else
                                htmlOut.Append("<td align='left' valign='top'></td>")
                            End If
                        Else
                            htmlOut.Append("<td align='left' valign='top'></td>")
                        End If

                        htmlOut.Append("<td align='left' valign='top' colspan='" + IIf(bAerodexFlag, "2", "") + "'>")

                        If Not IsDBNull(Row.Item("ac_list_date")) Then
                            If IsDate(Row.Item("ac_list_date").ToString) Then
                                htmlOut.Append(FormatDateTime(Row.Item("ac_list_date"), DateFormat.ShortDate).ToString.Trim)
                            End If
                        End If

                        htmlOut.Append("</td>")

                        If Not bAerodexFlag Then
                            htmlOut.Append("<td align='left' valign='top'>")

                            If Not IsDBNull(Row.Item("ac_exclusive_flag")) Then
                                If Not String.IsNullOrEmpty(Row.Item("ac_exclusive_flag").ToString.Trim) Then
                                    htmlOut.Append(Row.Item("ac_exclusive_flag").ToString.ToUpper.Trim)
                                End If
                            End If

                            htmlOut.Append("</td>")
                        End If

                        htmlOut.Append("</tr>")
                        htmlOut.Append("<tr>")
                        htmlOut.Append("<td align='left' valign='middle' colspan='2'>&nbsp;</td>")

                        If Not IsNothing(resultsTable) Then
                            If resultsTable.Rows.Count > 0 Then
                                htmlOut.Append("<td align='left' valign='top' colspan='" + (nTotalSpanCount + 2).ToString + "'>" + resultsTable.Rows(0).Item("comp_name").ToString + "</td>")
                            Else
                                htmlOut.Append("<td align='left' valign='top' colspan='" + (nTotalSpanCount + 2).ToString + "'></td>")
                            End If
                        Else
                            htmlOut.Append("<td align='left' valign='top' colspan='" + (nTotalSpanCount + 2).ToString + "'></td>")
                        End If

                        htmlOut.Append(IIf(bHtmlReport, "<tr><td colspan='12'><hr height='1'></td></tr>", ""))
                        htmlOut.Append("</tr>")

                    End If

                Next

            End If

            If bHtmlReport Or bExcelReport Or bPdfReport Then
                htmlOut.Append("</table>")
            End If

            If bHtmlReport Or bPdfReport Then
                htmlOut.Append("</div>")
                htmlOut.Append("</body>")
                htmlOut.Append("</html>")
            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Create_Report_10_Standard_Available_Listing()" + ex.Message
        Finally

            report_10_datatable = Nothing

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOut.ToString

    End Function

#End Region

#Region "report_11_functions"

    Public Function create_report_11_standard_non_available_listing(ByRef record_count As Long) As String

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim report_11_datatable As New DataTable

        Dim adoRS_11 As System.Data.SqlClient.SqlDataReader : adoRS_11 = Nothing

        Dim htmlOut = New StringBuilder()
        Dim sQuery As New StringBuilder()

        Dim nTotalSpanCount As Integer = 5
        Dim bHadCity As Boolean = False
        Dim sRememberSerialNo As String = ""

        Try

            SqlConn.ConnectionString = localFunctions.clientConnectStr

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 90

            If HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("comp_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("contact_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("state_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("country_") Then
                sQuery.Append("SELECT DISTINCT * FROM View_Aircraft_Company_Flat WITH(NOLOCK) ")
            Else
                sQuery.Append("SELECT DISTINCT * FROM View_Aircraft_Flat WITH(NOLOCK) ")
            End If

            sQuery.Append(HttpContext.Current.Session.Item("MasterAircraftWhere").ToString)
            sQuery.Append(" ORDER BY amod_make_name, amod_model_name, ac_ser_no_sort")

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />Create_Report_11_Standard_Non_Available_Listing()<br />" + sQuery.ToString

            If bHtmlReport Then
                htmlOut.Append("<!DOCTYPE html>")
                htmlOut.Append("<html lang='en'>")
                htmlOut.Append("<head>")
                htmlOut.Append("<meta http-equiv='Content-Language' content='en-us' />")
                htmlOut.Append("<meta http-equiv='Content-Type' content='text/html; charset=windows-1252' />")
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='common/jetnet.css' />")
                htmlOut.Append("<title>JETNET - Standard Non-Available Listing</title>")

                If bPdfReport Then
                    htmlOut.Append(" <style type='text/css'>")
                    htmlOut.Append("   body { margin-top:0px; margin-left:0px; margin-right:0px; margin-bottom:0px; font-family:Tahoma; font-size:11px; background-color:#ffffff; }" + vbCrLf)
                    htmlOut.Append("   table.break { page-break-before: always; }" + vbCrLf)
                    htmlOut.Append("   table.centerTable { margin-right: auto; margin-left: auto; }" + vbCrLf)
                    htmlOut.Append(" </style>")
                    htmlOut.Append("</head>")

                    htmlOut.Append("<body>")

                Else

                    htmlOut.Append("</head>")
                    htmlOut.Append("<body style='background: white; margin-top:10px; margin-left:10px; font-size: 10pt;'>")

                End If

                htmlOut.Append("<div style='text-align:center;'>")

            End If

            SqlCommand.CommandText = sQuery.ToString
            adoRS_11 = SqlCommand.ExecuteReader()

            Try
                report_11_datatable.Load(adoRS_11)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = report_11_datatable.GetErrors()
            End Try

            record_count = report_11_datatable.Rows.Count

            adoRS_11.Close()
            adoRS_11 = Nothing

            If report_11_datatable.Rows.Count > 0 Then

                If bExcelReport Then
                    htmlOut.Append(localFunctions.include_excel_report_style() + vbCrLf)
                    htmlOut.Append("<table border='1' cellpadding='2' cellspacing='0'>")
                    htmlOut.Append("<tr bgcolor='#CCCCCC'><td valign='middle' align='left' colspan='2'><strong>" + FormatDateTime(Now(), DateFormat.GeneralDate).ToString + "</strong></td>")
                    htmlOut.Append("<td valign='middle' align='left' colspan='" + nTotalSpanCount.ToString + "'><strong>Standard Non-Available Listing</strong></td></tr>")
                    htmlOut.Append("<tr bgcolor='#CCCCCC'><td valign='middle' align='left' colspan='" + (nTotalSpanCount + 2).ToString + "'></td></tr>")
                ElseIf bHtmlReport Or bPdfReport Then
                    htmlOut.Append("<table class='centerTable' border='0' cellpadding='2' cellspacing='0' width='100%'>")
                    htmlOut.Append("<tr bgcolor='#CCCCCC'><td valign='middle' align='left' colspan='2'><strong>" + FormatDateTime(Now(), DateFormat.GeneralDate).ToString + "</strong></td>")
                    htmlOut.Append("<td valign='middle' align='left' colspan='" + nTotalSpanCount.ToString + "'><strong>Standard Non-Available Listing</strong></td></tr>")
                    htmlOut.Append("<tr bgcolor='#CCCCCC'><td width='100%' valign='middle' align='left' colspan='" + (nTotalSpanCount + 2).ToString + "'><hr></td></tr>")
                End If

                htmlOut.Append("<tr bgcolor='#CCCCCC'>")

                htmlOut.Append("<td align='left' valign='middle' colspan='2'>MAKE</td>")
                htmlOut.Append("<td align='left' valign='middle' colspan='" + nTotalSpanCount.ToString + "'>MODEL</td></tr>")

                htmlOut.Append("<tr bgcolor='#CCCCCC'>")
                htmlOut.Append("<td align='left' valign='middle'>YR</td>")
                htmlOut.Append("<td align='left' valign='middle'>SERNBR</td>")
                htmlOut.Append("<td align='left' valign='middle'>REGNBR</td>")
                htmlOut.Append("<td align='left' valign='middle'>OWNER</td>")

                htmlOut.Append("<td align='left' valign='middle'>ST</td>")
                htmlOut.Append("<td align='left' valign='middle'>PURCHASED&nbsp;DATE&nbsp;</td>")
                htmlOut.Append("<td align='left' valign='middle'>BASE</td>")

                htmlOut.Append("</tr>")

                For Each Row As DataRow In report_11_datatable.Rows

                    If Not sRememberSerialNo.ToLower.Contains(Row.Item("ac_ser_no_sort").ToString.ToLower.Trim) Then

                        sRememberSerialNo = Row.Item("ac_ser_no_sort").ToString

                        htmlOut.Append("<tr>")

                        htmlOut.Append("<td align='left' valign='top' colspan='2' width='25%'>" + Row.Item("amod_make_name").ToString.Trim + "</td>")
                        htmlOut.Append("<td align='left' valign='top' colspan='" + (nTotalSpanCount - 1).ToString + "'>" + Row.Item("amod_model_name").ToString.Trim + "</td>")

                        htmlOut.Append("<td align='left' valign='top'>")

                        If Not IsDBNull(Row.Item("ac_aport_iata_code")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_aport_iata_code").ToString) Then
                                htmlOut.Append(Row.Item("ac_aport_iata_code").ToString.Trim)
                            End If
                        End If

                        If Not IsDBNull(Row.Item("ac_aport_icao_code")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_aport_icao_code").ToString) Then
                                htmlOut.Append(Constants.cHyphen + Row.Item("ac_aport_icao_code").ToString.Trim)
                            End If
                        End If

                        htmlOut.Append("</td>")

                        htmlOut.Append("</tr><tr>")

                        If Not IsDBNull(Row.Item("ac_year")) Then
                            htmlOut.Append("<td align='left' valign='top'>" + Row.Item("ac_year").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td align='left' valign='top'></td>")
                        End If

                        If Not IsDBNull(Row.Item("ac_ser_no_full")) Then
                            htmlOut.Append("<td align='left' valign='top' class='textformat'>" + Row.Item("ac_ser_no_full").ToString.ToUpper.Trim + "</td>")
                        Else
                            htmlOut.Append("<td align='left' valign='top'></td>")
                        End If

                        If Not IsDBNull(Row.Item("ac_reg_no")) Then
                            htmlOut.Append("<td align='left' valign='top' nowrap='nowrap' class='textformat'>" + Row.Item("ac_reg_no").ToString.ToUpper.Trim + "</td>")
                        Else
                            htmlOut.Append("<td align='left' valign='top' nowrap='nowrap'></td>")
                        End If

                        Dim resultsTable As DataTable = localFunctions.get_owner_info_report(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id").ToString), False, False)

                        If Not IsNothing(resultsTable) Then
                            If resultsTable.Rows.Count > 0 Then
                                htmlOut.Append("<td align='left' valign='top'>" + resultsTable.Rows(0).Item("comp_name").ToString + "</td>")
                            Else
                                htmlOut.Append("<td align='left' valign='top'></td>")
                            End If
                        Else
                            htmlOut.Append("<td align='left' valign='top'></td>")
                        End If

                        If Not IsNothing(resultsTable) Then
                            If resultsTable.Rows.Count > 0 Then
                                htmlOut.Append("<td align='left' valign='top'>" + resultsTable.Rows(0).Item("comp_state").ToString.ToUpper.Trim + "</td>")
                            Else
                                htmlOut.Append("<td align='left' valign='top'></td>")
                            End If
                        Else
                            htmlOut.Append("<td align='left' valign='top'></td>")
                        End If

                        If Not IsDBNull(Row.Item("ac_purchase_date")) Then
                            htmlOut.Append("<td align='left' valign='top'>" + FormatDateTime(Row.Item("ac_purchase_date").ToString.Trim, DateFormat.ShortDate) + "</td>")
                        Else
                            htmlOut.Append("<td align='left' valign='top'></td>")
                        End If

                        htmlOut.Append("<td align='left' valign='top'>")

                        If Not IsDBNull(Row.Item("ac_aport_city")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_aport_city").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_aport_city").ToString.Trim)
                                bHadCity = True
                            End If
                        End If

                        If Not IsDBNull(Row.Item("ac_aport_state")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_aport_state").ToString.Trim) Then
                                htmlOut.Append(IIf(bHadCity, Constants.cCommaDelim + Constants.cSingleSpace, "") + Row.Item("ac_aport_state").ToString.Trim)
                            End If
                        End If

                        If Not IsDBNull(Row.Item("ac_aport_country")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_aport_country").ToString.Trim) Then
                                htmlOut.Append(Constants.cSingleSpace + Row.Item("ac_aport_country").ToString.Trim)
                            End If
                        End If

                        htmlOut.Append("</td></tr>")

                        htmlOut.Append(IIf(bHtmlReport, "<tr><td colspan='" + (nTotalSpanCount + 2).ToString + "'><hr height='1'></td></tr>", ""))

                        bHadCity = False

                    End If

                Next

            End If

            If bHtmlReport Or bExcelReport Or bPdfReport Then
                htmlOut.Append("</table>")
            End If

            If bHtmlReport Or bPdfReport Then
                htmlOut.Append("</div>")
                htmlOut.Append("</body>")
                htmlOut.Append("</html>")
            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Create_Report_11_Standard_Non_Available_Listing()" + ex.Message
        Finally

            report_11_datatable = Nothing

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOut.ToString

    End Function

#End Region

#Region "report_12_functions"

#End Region

#Region "report_13_functions"

#End Region

#Region "report_14_functions"

    Public Function create_report_14_label_export_current_aircraft_list(ByRef record_count As Long) As String

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand

        Dim report_14_datatable As New DataTable
        Dim adoRS_14 As System.Data.SqlClient.SqlDataReader : adoRS_14 = Nothing

        Dim htmlOut As New StringBuilder()
        Dim sQuery As New StringBuilder()

        Dim ACInfo1 As String = ""
        Dim nRememberAcID As Long = 0

        Try

            SqlConn.ConnectionString = localFunctions.clientConnectStr

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 90

            If HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("comp_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("cref_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("contact_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("state_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("country_") Then
                sQuery.Append("SELECT DISTINCT * FROM View_Aircraft_Company_Flat WITH(NOLOCK) ")
            Else
                sQuery.Append("SELECT DISTINCT * FROM View_Aircraft_Flat WITH(NOLOCK) ")
            End If

            sQuery.Append(HttpContext.Current.Session.Item("MasterAircraftWhere").ToString)
            sQuery.Append(" ORDER BY amod_make_name, amod_airframe_type_code, amod_type_code, amod_id, amod_model_name, ac_ser_no_sort")

            'HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />Create_Report_14_Label_Export_Current_Aircraft_List()<br />" + sQuery.ToString cref_

            If bHtmlReport Then
                htmlOut.Append("<!DOCTYPE html>")
                htmlOut.Append("<html lang='en'>")
                htmlOut.Append("<head>")
                htmlOut.Append("<meta http-equiv='Content-Language' content='en-us' />")
                htmlOut.Append("<meta http-equiv='Content-Type' content='text/html; charset=windows-1252' />")
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='common/jetnet.css' />")
                htmlOut.Append("<title>JETNET - Labels Export of Current Aircraft List</title>")
                htmlOut.Append("</head>")
                htmlOut.Append("<body style='background: white; margin-top:10px; margin-left:10px;'>")
                htmlOut.Append("<div style='text-align:center;'>")
            End If

            If bExcelReport Then
                htmlOut.Append(localFunctions.include_excel_report_style() + vbCrLf)
                htmlOut.Append("<table border='1' cellpadding='2' cellspacing='0'>")
            ElseIf bHtmlReport Then
                htmlOut.Append("<table class='centerTable' border='0' cellpadding='2' cellspacing='0' width='100%'>")
            End If

            SqlCommand.CommandText = sQuery.ToString
            adoRS_14 = SqlCommand.ExecuteReader()

            Try
                report_14_datatable.Load(adoRS_14)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = report_14_datatable.GetErrors()
            End Try

            record_count = report_14_datatable.Rows.Count

            adoRS_14.Close()
            adoRS_14 = Nothing

            If report_14_datatable.Rows.Count > 0 Then

                If chkShowReportHeader.Checked Then

                    If bExcelReport Or bHtmlReport Then

                        htmlOut.Append("<tr bgcolor='#CCCCCC'>")

                        htmlOut.Append("<td>MAKE</td>")
                        htmlOut.Append("<td>MODEL</td>")
                        htmlOut.Append("<td>SERIALNBR</td>")
                        htmlOut.Append("<td>REGNBR</td>")

                        htmlOut.Append("<td>RELATION</td>")
                        htmlOut.Append("<td>FRACTIONPERCENTOWNED</td>")
                        htmlOut.Append("<td>FRACTIONPURCHASEDATE</td>")
                        htmlOut.Append("<td>COMPANY</td>")
                        htmlOut.Append("<td>COMPALTNAME</td>")
                        htmlOut.Append("<td>COMPEMAIL</td>")
                        htmlOut.Append("<td>COMPWEBADDRESS</td>")
                        htmlOut.Append("<td>COMPADDRESS1</td>")
                        htmlOut.Append("<td>COMPADDRESS2</td>")
                        htmlOut.Append("<td>COMPCITY</td>")
                        htmlOut.Append("<td>COMPSTATE</td>")
                        htmlOut.Append("<td>COMPSTATEABBR</td>")
                        htmlOut.Append("<td>COMPPOSTALCODE</td>")
                        htmlOut.Append("<td>COMPCOUNTRY</td>")
                        htmlOut.Append("<td>COMPOFFICE</td>")
                        htmlOut.Append("<td>COMPFAX</td>")
                        htmlOut.Append("<td>COMPMOBILE</td>")

                        htmlOut.Append("<td>CONTACTPREFIX</td>")
                        htmlOut.Append("<td>CONTACTFIRSTNAME</td>")
                        htmlOut.Append("<td>CONTACTMI</td>")
                        htmlOut.Append("<td>CONTACTLASTNAME</td>")
                        htmlOut.Append("<td>CONTACTSUFFIX</td>")
                        htmlOut.Append("<td>CONTACTTITLE</td>")
                        htmlOut.Append("<td>CONTACTEMAILADDRESS</td>")
                        htmlOut.Append("<td>CONTACTOFFICE</td>")
                        htmlOut.Append("<td>CONTACTFAX</td>")
                        htmlOut.Append("<td>CONTACTMOBILE</td>")

                        htmlOut.Append("<td>YEARMFG</td>")
                        htmlOut.Append("<td>YEARDLV</td>")
                        htmlOut.Append("<td>BASEIATA</td>")
                        htmlOut.Append("<td>BASEICAO</td>")
                        htmlOut.Append("<td>BASENAME</td>")
                        htmlOut.Append("<td>BASECITY</td>")
                        htmlOut.Append("<td>BASESTATE</td>")
                        htmlOut.Append("<td>BASESTATEABBR</td>")
                        htmlOut.Append("<td>BASECOUNTRY</td>")

                        htmlOut.Append("<td>AFTT</td>")
                        htmlOut.Append("<td>ENG1TT</td>")
                        htmlOut.Append("<td>ENG2TT</td>")
                        htmlOut.Append("<td>ENG3TT</td>")
                        htmlOut.Append("<td>ENG4TT</td>")
                        htmlOut.Append("<td>SMOH1</td>")
                        htmlOut.Append("<td>SMOH2</td>")
                        htmlOut.Append("<td>SMOH3</td>")
                        htmlOut.Append("<td>SMOH4</td>")

                        'Skip the rest for aerodex
                        If Not bAerodexFlag Then
                            htmlOut.Append("<td>STATUS</td>")
                            htmlOut.Append("<td>ASKING</td>")
                            htmlOut.Append("<td>ASKINGAMT</td>")
                            htmlOut.Append("<td>DATELISTED</td>")
                        End If

                        htmlOut.Append("</tr>")

                    ElseIf bTextCommaReport Then

                        htmlOut.Append(Constants.QUOTE + "MAKE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "MODEL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SERIALNBR" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "REGNBR" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "RELATION" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "FRACTIONPERCENTOWNED" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "FRACTIONPURCHASEDATE" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "COMPANY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPALTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPEMAIL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPWEBADDRESS" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPADDRESS1" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPADDRESS2" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPCITY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPSTATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPSTATEABBR" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPPOSTALCODE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPCOUNTRY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPOFFICEE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPFAX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPMOBILE" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "CONTACTPREFIX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACTFIRSTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACTMI" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACTLASTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACTSUFFIX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACTTITLE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACTEMAILADDRESS" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACTOFFICE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACTFAX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACTMOBILE" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "YEARMFG" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "YEARDLV" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BASEIATA" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BASEICAO" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BASENAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BASECITY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BASESTATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BASESTATEABBR" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BASECOUNTRY" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "AFTT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "ENG1TT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "ENG2TT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "ENG3TT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "ENG4TT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SMOH1" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SMOH2" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SMOH3" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SMOH4" + Constants.QUOTE)

                        'Skip the rest for aerodex
                        If Not bAerodexFlag Then
                            htmlOut.Append(Constants.cCommaDelim + Constants.QUOTE + "STATUS" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "ASKING" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "ASKINGAMT" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "DATELISTED" + Constants.QUOTE)
                        End If

                        htmlOut.Append(vbCrLf)

                    ElseIf bTextTabReport Then

                        htmlOut.Append("MAKE" + vbTab)
                        htmlOut.Append("MODEL" + vbTab)
                        htmlOut.Append("SERIALNBR" + vbTab)
                        htmlOut.Append("REGNBR" + vbTab)
                        htmlOut.Append("RELATION" + vbTab)
                        htmlOut.Append("FRACTIONPERCENTOWNED" + vbTab)
                        htmlOut.Append("FRACTIONPURCHASEDATE" + vbTab)

                        htmlOut.Append("COMPANY" + vbTab)
                        htmlOut.Append("COMPALTNAME" + vbTab)
                        htmlOut.Append("COMPEMAIL" + vbTab)
                        htmlOut.Append("COMPWEBADDRESS" + vbTab)
                        htmlOut.Append("COMPADDRESS1" + vbTab)
                        htmlOut.Append("COMPADDRESS2" + vbTab)
                        htmlOut.Append("COMPCITY" + vbTab)
                        htmlOut.Append("COMPSTATE" + vbTab)
                        htmlOut.Append("COMPSTATEABBR" + vbTab)
                        htmlOut.Append("COMPPOSTALCODE" + vbTab)
                        htmlOut.Append("COMPCOUNTRY" + vbTab)
                        htmlOut.Append("COMPOFFICE" + vbTab)
                        htmlOut.Append("COMPFAX" + vbTab)
                        htmlOut.Append("COMPMOBILE" + vbTab)

                        htmlOut.Append("CONTACTPREFIX" + vbTab)
                        htmlOut.Append("CONTACTFIRST NAME" + vbTab)
                        htmlOut.Append("CONTACTMI" + vbTab)
                        htmlOut.Append("CONTACTLAST NAME" + vbTab)
                        htmlOut.Append("CONTACTSUFFIX" + vbTab)
                        htmlOut.Append("CONTACTTITLE" + vbTab)
                        htmlOut.Append("CONTACTEMAILADDRESS" + vbTab)
                        htmlOut.Append("CONTACTOFFICE" + vbTab)
                        htmlOut.Append("CONTACTFAX" + vbTab)
                        htmlOut.Append("CONTACTMOBILE" + vbTab)

                        htmlOut.Append("YEARMFG" + vbTab)
                        htmlOut.Append("YEARDLV" + vbTab)
                        htmlOut.Append("BASEIATA" + vbTab)
                        htmlOut.Append("BASEICAO" + vbTab)
                        htmlOut.Append("BASENAME" + vbTab)
                        htmlOut.Append("BASECITY" + vbTab)
                        htmlOut.Append("BASESTATE" + vbTab)
                        htmlOut.Append("BASESTATEABBR" + vbTab)
                        htmlOut.Append("BASECOUNTRY" + vbTab)

                        htmlOut.Append("AFTT" + vbTab)
                        htmlOut.Append("ENG1TT" + vbTab)
                        htmlOut.Append("ENG2TT" + vbTab)
                        htmlOut.Append("ENG3TT" + vbTab)
                        htmlOut.Append("ENG4TT" + vbTab)
                        htmlOut.Append("SMOH1" + vbTab)
                        htmlOut.Append("SMOH2" + vbTab)
                        htmlOut.Append("SMOH3" + vbTab)
                        htmlOut.Append("SMOH4")

                        'Skip the rest for aerodex
                        If Not bAerodexFlag Then
                            htmlOut.Append(vbTab + "STATUS" + vbTab)
                            htmlOut.Append("ASKING" + vbTab)
                            htmlOut.Append("ASKINGAMT" + vbTab)
                            htmlOut.Append("DATELISTED")
                        End If

                        htmlOut.Append(vbCrLf)

                    End If 'vbTab

                End If ' chkShowReportHeader.Checked Then

                For Each Row As DataRow In report_14_datatable.Rows

                    If CLng(Row.Item("ac_id").ToString) <> nRememberAcID Then

                        nRememberAcID = CLng(Row.Item("ac_id").ToString)

                        If bHtmlReport Or bExcelReport Then

                            ACInfo1 = "<tr><td>" + Row.Item("amod_make_name").ToString.Trim + "</td>"
                            ACInfo1 += "<td>" + Row.Item("amod_model_name").ToString.Trim + "</td>"
                            ACInfo1 += "<td class='textformat'>" + Row.Item("ac_ser_no_full").ToString.Trim + "</td>"
                            ACInfo1 += "<td class='textformat'>" + Row.Item("ac_reg_no").ToString.Trim + "</td>"

                        ElseIf bTextCommaReport Then

                            ACInfo1 = Constants.QUOTE + Row.Item("amod_make_name").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim
                            ACInfo1 += Constants.QUOTE + Row.Item("amod_model_name").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim
                            ACInfo1 += Constants.QUOTE + Row.Item("ac_ser_no_full").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim
                            ACInfo1 += Constants.QUOTE + Row.Item("ac_reg_no").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim

                        ElseIf bTextTabReport Then

                            ACInfo1 = Row.Item("amod_make_name").ToString.Trim + vbTab
                            ACInfo1 += Row.Item("amod_model_name").ToString.Trim + vbTab
                            ACInfo1 += Row.Item("ac_ser_no_full").ToString.Trim + vbTab
                            ACInfo1 += Row.Item("ac_reg_no").ToString.Trim + vbTab

                        End If

                        htmlOut.Append(get_references_14(ACInfo1, Row))

                    End If

                Next

                If bHtmlReport Or bExcelReport Then
                    htmlOut.Append("</table>")
                End If

                If bHtmlReport Then
                    htmlOut.Append("</div>")
                    htmlOut.Append("</body>")
                    htmlOut.Append("</html>")
                End If

            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Create_Report_14_Label_Export_Current_Aircraft_List()" + ex.Message
        Finally
            adoRS_14 = Nothing

            report_14_datatable = Nothing

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOut.ToString

    End Function

    Public Function get_references_14(ByVal acInfo As String, ByRef currentRow As DataRow) As String

        Dim htmlOut = New StringBuilder()
        Dim sQuery = New StringBuilder()

        Dim RefInfo As String = ""
        Dim CompInfo As String = ""
        Dim CompPhoneInfo As String = ""
        Dim ContactInfo As String = ""
        Dim ContactPhoneInfo As String = ""

        Dim tmpRefType As String = ""
        Dim sFractionOwned As String = ""
        Dim sFractionPurchaseDate As String = ""

        Dim tmpCompID As String = ""
        Dim cref_contact_type As String = ""

        ' these are supposed to be pulled from the selections
        Dim strContactTitleGroup As String = ""

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim report_14_ref_datatable As New DataTable

        Dim adoRS_14_ref As System.Data.SqlClient.SqlDataReader : adoRS_14_ref = Nothing

        Try

            If Not IsNothing(HttpContext.Current.Session.Item("searchCriteria").SearchCriteriaCompanyContactTitle) Then
                strContactTitleGroup = HttpContext.Current.Session.Item("searchCriteria").SearchCriteriaCompanyContactTitle.ToString
            End If

            If Not chkIncludeContacts.Checked And Not chkIncludeAllContacts.Checked Then
                sQuery.Append("SELECT DISTINCT cref_contact_type, cref_contact_id, cref_comp_id, cref_transmit_seq_no, cref_owner_percent, actype_name,")
                sQuery.Append(" comp_name, comp_name_alt_type, comp_name_alt, comp_email_address, comp_web_address,")
                sQuery.Append(" comp_address1, comp_address2, comp_city, comp_state, state_name, comp_zip_code, comp_country")

                If Not String.IsNullOrEmpty(strContactTitleGroup.Trim) Then
                    sQuery.Append(",contact_id, contact_title")
                End If

                sQuery.Append(" FROM Company WITH(NOLOCK)")
                sQuery.Append(" INNER JOIN Aircraft_Reference WITH(NOLOCK) ON (comp_id = cref_comp_id AND comp_journ_id = cref_journ_id)")
                sQuery.Append(" INNER JOIN Aircraft_Contact_Type WITH(NOLOCK) ON (cref_contact_type = actype_code)")

                If Not String.IsNullOrEmpty(strContactTitleGroup.Trim) Then
                    sQuery.Append(" LEFT OUTER JOIN Contact WITH(NOLOCK) ON (cref_contact_id = contact_id AND cref_journ_id = contact_journ_id)")
                End If

                sQuery.Append(" LEFT OUTER JOIN State WITH (NOLOCK) ON (comp_state = state_code AND comp_country = state_country)")

            ElseIf chkIncludeContacts.Checked And Not chkIncludeAllContacts.Checked Then
                sQuery.Append("SELECT DISTINCT cref_contact_type, cref_contact_id, contact_id, cref_comp_id, cref_transmit_seq_no, cref_owner_percent, actype_name,")
                sQuery.Append(" comp_name, comp_name_alt_type, comp_name_alt, comp_email_address, comp_web_address,")
                sQuery.Append(" comp_address1, comp_address2, comp_city, comp_state, state_name, comp_zip_code, comp_country")

                If Not String.IsNullOrEmpty(strContactTitleGroup.Trim) Then
                    sQuery.Append(", contact_title")
                End If

                sQuery.Append(" FROM Company WITH(NOLOCK)")
                sQuery.Append(" INNER JOIN Aircraft_Reference WITH(NOLOCK) ON (comp_id = cref_comp_id AND comp_journ_id = cref_journ_id)")
                sQuery.Append(" INNER JOIN Aircraft_Contact_Type WITH(NOLOCK) ON (cref_contact_type = actype_code)")
                sQuery.Append(" LEFT OUTER JOIN Contact WITH(NOLOCK) ON (cref_contact_id = contact_id AND cref_journ_id = contact_journ_id)")
                sQuery.Append(" LEFT OUTER JOIN State WITH (NOLOCK) ON (comp_state = state_code AND comp_country = state_country)")

            ElseIf chkIncludeContacts.Checked And chkIncludeAllContacts.Checked Then

                sQuery.Append("SELECT DISTINCT cref_contact_type, contact_id, comp_id, cref_transmit_seq_no, cref_owner_percent, actype_name,")
                sQuery.Append(" comp_name, comp_name_alt_type, comp_name_alt, comp_email_address, comp_web_address,")
                sQuery.Append(" comp_address1, comp_address2, comp_city, comp_state, state_name, comp_zip_code, comp_country")
                sQuery.Append(" FROM Company WITH(NOLOCK)")
                sQuery.Append(" INNER JOIN Aircraft_Reference WITH(NOLOCK) ON (comp_id = cref_comp_id AND comp_journ_id = cref_journ_id)")
                sQuery.Append(" INNER JOIN Aircraft_Contact_Type WITH(NOLOCK) ON (cref_contact_type = actype_code)")
                sQuery.Append(" LEFT OUTER JOIN Contact WITH(NOLOCK) ON (cref_comp_id = contact_comp_id AND comp_journ_id = contact_journ_id)")
                sQuery.Append(" LEFT OUTER JOIN State WITH (NOLOCK) ON (comp_state = state_code AND comp_country = state_country)")

            ElseIf chkIncludeAllContacts.Checked Then

                sQuery.Append("SELECT DISTINCT cref_contact_type, contact_id, comp_id, cref_transmit_seq_no, cref_owner_percent, actype_name,")
                sQuery.Append(" comp_name, comp_name_alt_type, comp_name_alt, comp_email_address, comp_web_address,")
                sQuery.Append(" comp_address1, comp_address2, comp_city, comp_state, state_name, comp_zip_code, comp_country")
                sQuery.Append(" FROM Company WITH(NOLOCK)")
                sQuery.Append(" INNER JOIN Aircraft_Reference WITH(NOLOCK) ON (comp_id = cref_comp_id AND comp_journ_id = cref_journ_id)")
                sQuery.Append(" INNER JOIN Aircraft_Contact_Type WITH(NOLOCK) ON (cref_contact_type = actype_code)")
                sQuery.Append(" LEFT OUTER JOIN Contact WITH(NOLOCK) ON (cref_comp_id = contact_comp_id AND comp_journ_id = contact_journ_id)")
                sQuery.Append(" LEFT OUTER JOIN State WITH (NOLOCK) ON (comp_state = state_code AND comp_country = state_country)")

            End If

            sQuery.Append(" WHERE (cref_ac_id = " + currentRow.Item("ac_id").ToString + " AND cref_journ_id = 0")
            sQuery.Append(" AND comp_active_flag = 'Y' AND comp_hide_flag = 'N'")

            ' Hide Exclusive Brokers and Representatives and Dealers from Aerodex users
            If bAerodexFlag Then
                sQuery.Append(" AND (cref_contact_type NOT IN ('93','98','99','66','67','68','71'))")
            Else
                sQuery.Append(" AND (cref_contact_type NOT IN ('66','67','68','71'))")
            End If

            If chkIncludeContacts.Checked Or chkIncludeAllContacts.Checked Or Not String.IsNullOrEmpty(strContactTitleGroup.Trim) Then

                sQuery.Append(" AND (contact_active_flag = 'Y' OR contact_active_flag IS NULL)")
                sQuery.Append(" AND (contact_hide_flag = 'N' OR contact_hide_flag IS NULL)")

            End If

            If Not IsNothing(HttpContext.Current.Session.Item("Advanced-cref_contact_type")) Then

                If Not String.IsNullOrEmpty(HttpContext.Current.Session.Item("Advanced-cref_contact_type")) Then

                    ' special case for "operator"
                    If HttpContext.Current.Session.Item("Advanced-cref_contact_type").ToString.ToUpper.Contains("Y") Then
                        sQuery.Append(" AND cref_operator_flag IN ('Y', 'O')")
                    Else

                        If Not IsNothing(HttpContext.Current.Session.Item("Advanced-comp_not_in_selected")) Then

                            If Not String.IsNullOrEmpty(HttpContext.Current.Session.Item("Advanced-comp_not_in_selected")) Then
                                sQuery.Append(" AND cref_contact_type NOT IN ('" + Replace(HttpContext.Current.Session.Item("Advanced-cref_contact_type").ToString, Constants.cDymDataSeperator, Constants.cValueSeperator) + "')")
                            Else
                                sQuery.Append(" AND cref_contact_type IN ('" + Replace(HttpContext.Current.Session.Item("Advanced-cref_contact_type").ToString, Constants.cDymDataSeperator, Constants.cValueSeperator) + "')")
                            End If

                        Else
                            cref_contact_type = Replace(HttpContext.Current.Session.Item("Advanced-cref_contact_type").ToString, Constants.cDymDataSeperator, Constants.cValueSeperator)

                            cref_contact_type = Replace(cref_contact_type, "00,97,17,08,16", "00','97','17','08','16")

                            sQuery.Append(" AND cref_contact_type IN ('" & cref_contact_type & "')")
                        End If

                    End If

                End If

            End If

            sQuery.Append(") ORDER BY cref_transmit_seq_no")

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />Create_Report_14_Label_Export_Current_Aircraft_List()<br />" + sQuery.ToString

            SqlConn.ConnectionString = localFunctions.clientConnectStr

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString
            adoRS_14_ref = SqlCommand.ExecuteReader()

            Try
                report_14_ref_datatable.Load(adoRS_14_ref)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = report_14_ref_datatable.GetErrors()
            End Try

            adoRS_14_ref.Close()
            adoRS_14_ref = Nothing

            If report_14_ref_datatable.Rows.Count > 0 Then

                If chkIncludeAllContacts.Checked Then

                    Dim nHoldCompID As Long = 0

                    For Each Row As DataRow In report_14_ref_datatable.Rows

                        If Not IsDBNull(Row.Item("comp_id")) Then
                            If Not String.IsNullOrEmpty(Row.Item("comp_id").ToString.Trim) Then
                                If String.IsNullOrEmpty(tmpCompID.Trim) Then

                                    tmpCompID = Row.Item("comp_id").ToString.Trim
                                    nHoldCompID = CLng(Row.Item("comp_id").ToString)

                                Else

                                    If nHoldCompID <> CLng(Row.Item("comp_id").ToString) Then
                                        tmpCompID += Constants.cCommaDelim + Row.Item("comp_id").ToString.Trim
                                        nHoldCompID = CLng(Row.Item("comp_id").ToString)
                                    End If

                                End If
                            End If
                        End If

                    Next

                    sQuery = New StringBuilder()

                    sQuery.Append("SELECT DISTINCT comp_id, cref_transmit_seq_no, cref_owner_percent, contact_id, comp_journ_id, actype_name,")
                    sQuery.Append(" comp_name, comp_name_alt_type, comp_name_alt, comp_email_address, comp_web_address,")
                    sQuery.Append(" comp_address1, comp_address2, comp_city, comp_state, state_name, comp_zip_code, comp_country")
                    sQuery.Append(" FROM Aircraft_Reference WITH(NOLOCK)")
                    sQuery.Append(" INNER JOIN Company WITH(NOLOCK) ON (cref_comp_id = comp_id AND cref_journ_id = comp_journ_id)")
                    sQuery.Append(" INNER JOIN Aircraft_Contact_Type WITH(NOLOCK) ON (cref_contact_type = actype_code)")
                    sQuery.Append(" LEFT OUTER JOIN Contact WITH(NOLOCK) ON (comp_id = contact_comp_id AND comp_journ_id = contact_journ_id)")
                    sQuery.Append(" LEFT OUTER JOIN State WITH (NOLOCK) ON (comp_state = state_code AND comp_country = state_country)")
                    sQuery.Append(" WHERE (cref_ac_id = " + currentRow.Item("ac_id").ToString + " AND cref_journ_id = 0")
                    sQuery.Append(" AND comp_id IN (" + tmpCompID + ") AND comp_active_flag = 'Y' AND comp_hide_flag = 'N'")
                    sQuery.Append(" AND (contact_active_flag = 'Y' OR contact_active_flag IS NULL)")
                    sQuery.Append(" AND (contact_hide_flag = 'N' OR contact_hide_flag IS NULL)")

                    ' Hide Exclusive Brokers and Representatives and Dealers from Aerodex users
                    If bAerodexFlag Then
                        sQuery.Append(" AND (cref_contact_type NOT IN ('93','98','99','66','67','68','71'))")
                    Else
                        sQuery.Append(" AND (cref_contact_type NOT IN ('66','67','68','71'))")
                    End If

                    If Not IsNothing(HttpContext.Current.Session.Item("Advanced-cref_contact_type")) Then

                        If Not String.IsNullOrEmpty(HttpContext.Current.Session.Item("Advanced-cref_contact_type")) Then

                            ' special case for "operator"
                            If HttpContext.Current.Session.Item("Advanced-cref_contact_type").ToString.ToUpper.Contains("Y") Then
                                sQuery.Append(" AND cref_operator_flag IN ('Y', 'O')")
                            Else

                                If Not IsNothing(HttpContext.Current.Session.Item("Advanced-comp_not_in_selected")) Then

                                    If Not String.IsNullOrEmpty(HttpContext.Current.Session.Item("Advanced-comp_not_in_selected")) Then
                                        sQuery.Append(" AND cref_contact_type NOT IN ('" + Replace(HttpContext.Current.Session.Item("Advanced-cref_contact_type").ToString, Constants.cDymDataSeperator, Constants.cValueSeperator) + "')")
                                    Else
                                        sQuery.Append(" AND cref_contact_type IN ('" + Replace(HttpContext.Current.Session.Item("Advanced-cref_contact_type").ToString, Constants.cDymDataSeperator, Constants.cValueSeperator) + "')")
                                    End If

                                Else
                                    sQuery.Append(" AND cref_contact_type IN ('" + Replace(HttpContext.Current.Session.Item("Advanced-cref_contact_type").ToString, Constants.cDymDataSeperator, Constants.cValueSeperator) + "')")
                                End If

                            End If

                        End If

                    End If

                    sQuery.Append(") ORDER BY cref_transmit_seq_no")

                    HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />Create_Report_14_Label_Export_Current_Aircraft_List()<br />" + sQuery.ToString

                    report_14_ref_datatable = New DataTable

                    SqlCommand.CommandText = sQuery.ToString
                    adoRS_14_ref = SqlCommand.ExecuteReader()

                    Try
                        report_14_ref_datatable.Load(adoRS_14_ref)
                    Catch constrExc As System.Data.ConstraintException
                        Dim rowsErr As System.Data.DataRow() = report_14_ref_datatable.GetErrors()
                    End Try

                    adoRS_14_ref.Close()
                    adoRS_14_ref = Nothing

                End If ' chkIncludeAllContacts.Checked   

                If report_14_ref_datatable.Rows.Count > 0 Then

                    For Each Row As DataRow In report_14_ref_datatable.Rows

                        sFractionOwned = ""
                        sFractionPurchaseDate = ""

                        If Not chkIncludeAllContacts.Checked Then

                            If Not IsDBNull(Row.Item("cref_contact_type")) Then
                                tmpRefType = localFunctions.get_reference_type_report(Row.Item("cref_contact_type"), True)
                            Else
                                If Not String.IsNullOrEmpty(strContactTitleGroup) Then
                                    tmpRefType = Row.Item("contact_title").ToString.Trim
                                Else
                                    tmpRefType = ""
                                End If
                            End If

                            If Not IsDBNull(Row.Item("cref_owner_percent")) Then

                                If CLng(Row.Item("cref_owner_percent").ToString) > 0 And CLng(Row.Item("cref_owner_percent").ToString) < 100 Then
                                    sFractionOwned = Row.Item("cref_owner_percent").ToString + "%"
                                End If

                                If Not String.IsNullOrEmpty(sFractionOwned.Trim) Then
                                    sFractionPurchaseDate = localFunctions.get_fraction_purchase_date(CLng(currentRow.Item("ac_id").ToString), CLng(Row.Item("cref_comp_id").ToString), True)
                                End If

                            End If

                        Else

                            If Not IsDBNull(Row.Item("actype_name")) Then
                                tmpRefType = Row.Item("actype_name").ToString.Trim
                            End If

                            sFractionOwned = localFunctions.get_reference_info_report(CLng(Row.Item("comp_id").ToString), True)

                            If Not String.IsNullOrEmpty(sFractionOwned.Trim) Then
                                sFractionPurchaseDate = localFunctions.get_fraction_purchase_date(CLng(currentRow.Item("ac_id").ToString), CLng(Row.Item("comp_id").ToString), True)
                            End If

                        End If

                        If bHtmlReport Or bExcelReport Then
                            RefInfo = acInfo + "<td>" + tmpRefType + "</td>"
                            RefInfo = RefInfo + "<td>" + sFractionOwned + "</td>"
                            RefInfo = RefInfo + "<td>" + sFractionPurchaseDate + "</td>"

                        ElseIf bTextCommaReport Then
                            RefInfo = acInfo + Constants.QUOTE + tmpRefType + Constants.QUOTE + Constants.cCommaDelim
                            RefInfo = RefInfo + Constants.QUOTE + sFractionOwned + Constants.QUOTE + Constants.cCommaDelim
                            RefInfo = RefInfo + Constants.QUOTE + sFractionPurchaseDate + Constants.QUOTE + Constants.cCommaDelim

                        ElseIf bTextTabReport Then
                            RefInfo = acInfo + tmpRefType + vbTab
                            RefInfo = RefInfo + sFractionOwned + vbTab
                            RefInfo = RefInfo + sFractionPurchaseDate + vbTab
                        End If

                        htmlOut.Append(RefInfo)

                        If Not chkIncludeAllContacts.Checked Then
                            If Not String.IsNullOrEmpty(strContactTitleGroup) Then

                                ReturnCompanyInformation_Report(CLng(Row.Item("cref_comp_id").ToString), 0, Row, CompPhoneInfo, CompInfo, True)

                                If Not IsDBNull(Row.Item("contact_id")) Then
                                    ReturnContactInformation_Report(CLng(Row.Item("cref_comp_id").ToString), CLng(Row.Item("contact_id").ToString), 0, ContactInfo, ContactPhoneInfo)
                                Else
                                    ReturnContactInformation_Report(CLng(Row.Item("cref_comp_id").ToString), 0, 0, ContactInfo, ContactPhoneInfo)
                                End If

                            Else

                                ReturnCompanyInformation_Report(CLng(Row.Item("cref_comp_id").ToString), 0, Row, CompPhoneInfo, CompInfo, True)

                                If Not IsDBNull(Row.Item("cref_contact_id")) Then
                                    ReturnContactInformation_Report(CLng(Row.Item("cref_comp_id").ToString), CLng(Row.Item("cref_contact_id").ToString), 0, ContactInfo, ContactPhoneInfo)
                                Else
                                    ReturnContactInformation_Report(CLng(Row.Item("cref_comp_id").ToString), 0, 0, ContactInfo, ContactPhoneInfo)
                                End If

                            End If

                        Else

                            ReturnCompanyInformation_Report(CLng(Row.Item("comp_id").ToString), 0, Row, CompPhoneInfo, CompInfo, True)

                            If Not IsDBNull(Row.Item("contact_id")) Then
                                ReturnContactInformation_Report(CLng(Row.Item("comp_id").ToString), CLng(Row.Item("contact_id").ToString), 0, ContactInfo, ContactPhoneInfo)
                            Else
                                ReturnContactInformation_Report(CLng(Row.Item("comp_id").ToString), 0, 0, ContactInfo, ContactPhoneInfo)
                            End If

                        End If

                        htmlOut.Append(CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo)

                        If bHtmlReport Or bExcelReport Then

                            If Not IsDBNull(currentRow.Item("ac_mfr_year")) Then
                                If Not String.IsNullOrEmpty(currentRow.Item("ac_mfr_year").ToString.Trim) Then
                                    htmlOut.Append("<td>" + currentRow.Item("ac_mfr_year").ToString + "</td>")
                                Else
                                    htmlOut.Append("<td></td>")
                                End If
                            Else
                                htmlOut.Append("<td></td>")
                            End If

                            htmlOut.Append("<td>" + currentRow.Item("ac_year").ToString + "</td>")
                            htmlOut.Append("<td>" + currentRow.Item("ac_aport_iata_code").ToString + "</td>")
                            htmlOut.Append("<td>" + currentRow.Item("ac_aport_icao_code").ToString + "</td>")
                            htmlOut.Append("<td>" + currentRow.Item("ac_aport_name").ToString + "</td>")
                            htmlOut.Append("<td>" + currentRow.Item("ac_aport_city").ToString + "</td>")

                            If Not IsDBNull(currentRow.Item("ac_aport_state")) Then
                                htmlOut.Append("<td>" + localFunctions.get_state_name_report(currentRow.Item("ac_aport_state").ToString, currentRow.Item("ac_aport_country").ToString) + "</td>")
                            Else
                                htmlOut.Append("<td>&nbsp;</td>")
                            End If

                            htmlOut.Append("<td>" + currentRow.Item("ac_aport_state").ToString + "</td>")
                            htmlOut.Append("<td>" + currentRow.Item("ac_aport_country").ToString + "</td>")
                            htmlOut.Append("<td>" + currentRow.Item("ac_airframe_tot_hrs").ToString + "</td>")
                            htmlOut.Append("<td>" + currentRow.Item("ac_engine_1_tot_hrs").ToString + "</td>")
                            htmlOut.Append("<td>" + currentRow.Item("ac_engine_2_tot_hrs").ToString + "</td>")
                            htmlOut.Append("<td>" + currentRow.Item("ac_engine_3_tot_hrs").ToString + "</td>")
                            htmlOut.Append("<td>" + currentRow.Item("ac_engine_4_tot_hrs").ToString + "</td>")
                            htmlOut.Append("<td>" + currentRow.Item("ac_engine_1_soh_hrs").ToString + "</td>")
                            htmlOut.Append("<td>" + currentRow.Item("ac_engine_2_soh_hrs").ToString + "</td>")
                            htmlOut.Append("<td>" + currentRow.Item("ac_engine_3_soh_hrs").ToString + "</td>")
                            htmlOut.Append("<td>" + currentRow.Item("ac_engine_4_soh_hrs").ToString + "</td>")

                            'Skip the rest for aerodex
                            If Not bAerodexFlag Then

                                htmlOut.Append("<td>" + currentRow.Item("ac_status").ToString + "</td>")
                                htmlOut.Append("<td>" + currentRow.Item("ac_asking").ToString + "</td>")

                                If Not IsDBNull(currentRow.Item("ac_asking_price")) Then
                                    If CDbl(currentRow.Item("ac_asking_price").ToString) > 0 Then
                                        htmlOut.Append("<td>$" + FormatNumber(CDbl(currentRow.Item("ac_asking_price").ToString), 0, False, False, True) + "</td>")
                                    Else
                                        htmlOut.Append("<td></td>")
                                    End If
                                Else
                                    htmlOut.Append("<td></td>")
                                End If

                                If Not IsDBNull(currentRow.Item("ac_list_date")) Then
                                    htmlOut.Append("<td class='dateformat'>" + FormatDateTime(currentRow.Item("ac_list_date").ToString, DateFormat.ShortDate) + "</td>")
                                Else
                                    htmlOut.Append("<td class='dateformat'>&nbsp;</td>")
                                End If

                            End If

                            htmlOut.Append("</tr>")

                        ElseIf bTextCommaReport Then

                            If Not IsDBNull(currentRow.Item("ac_mfr_year")) Then
                                If Not String.IsNullOrEmpty(currentRow.Item("ac_mfr_year").ToString.Trim) Then
                                    htmlOut.Append(Constants.QUOTE + currentRow.Item("ac_mfr_year").ToString + Constants.QUOTE + Constants.cCommaDelim)
                                Else
                                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                End If
                            Else
                                htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                            End If

                            htmlOut.Append(Constants.QUOTE + currentRow.Item("ac_year").ToString + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + currentRow.Item("ac_aport_iata_code").ToString + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + currentRow.Item("ac_aport_icao_code").ToString + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + currentRow.Item("ac_aport_name").ToString + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + currentRow.Item("ac_aport_city").ToString + Constants.QUOTE + Constants.cCommaDelim)

                            If Not IsDBNull(currentRow.Item("ac_aport_state")) Then
                                htmlOut.Append("<td>" + localFunctions.get_state_name_report(currentRow.Item("ac_aport_state").ToString, currentRow.Item("ac_aport_country").ToString) + "</td>")
                            Else
                                htmlOut.Append(Constants.QUOTE + Constants.QUOTE)
                            End If

                            htmlOut.Append(Constants.QUOTE + currentRow.Item("ac_aport_state").ToString + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + currentRow.Item("ac_aport_country").ToString + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + currentRow.Item("ac_airframe_tot_hrs").ToString + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + currentRow.Item("ac_engine_1_tot_hrs").ToString + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + currentRow.Item("ac_engine_2_tot_hrs").ToString + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + currentRow.Item("ac_engine_3_tot_hrs").ToString + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + currentRow.Item("ac_engine_4_tot_hrs").ToString + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + currentRow.Item("ac_engine_1_soh_hrs").ToString + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + currentRow.Item("ac_engine_2_soh_hrs").ToString + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + currentRow.Item("ac_engine_3_soh_hrs").ToString + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + currentRow.Item("ac_engine_4_soh_hrs").ToString + Constants.QUOTE + Constants.cCommaDelim)

                            'Skip the rest for aerodex
                            If Not bAerodexFlag Then

                                htmlOut.Append(Constants.QUOTE + currentRow.Item("ac_status").ToString + Constants.QUOTE + Constants.cCommaDelim)
                                htmlOut.Append(Constants.QUOTE + currentRow.Item("ac_asking").ToString + Constants.QUOTE + Constants.cCommaDelim)

                                If Not IsDBNull(currentRow.Item("ac_asking_price")) Then
                                    If CDbl(currentRow.Item("ac_asking_price").ToString) > 0 Then
                                        htmlOut.Append(Constants.QUOTE + "$" + FormatNumber(CDbl(currentRow.Item("ac_asking_price").ToString), 0, False, False, True) + Constants.QUOTE + Constants.cCommaDelim)
                                    Else
                                        htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                    End If
                                Else
                                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                End If

                                If Not IsDBNull(currentRow.Item("ac_list_date")) Then
                                    htmlOut.Append(Constants.QUOTE + FormatDateTime(currentRow.Item("ac_list_date").ToString, DateFormat.ShortDate) + Constants.QUOTE)
                                Else
                                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE)
                                End If

                            End If

                            htmlOut.Append(vbCrLf)

                        ElseIf bTextTabReport Then

                            If Not IsDBNull(currentRow.Item("ac_mfr_year")) Then
                                If Not String.IsNullOrEmpty(currentRow.Item("ac_mfr_year").ToString.Trim) Then
                                    htmlOut.Append(currentRow.Item("ac_mfr_year").ToString + vbTab)
                                Else
                                    htmlOut.Append(vbTab)
                                End If
                            Else
                                htmlOut.Append(vbTab)
                            End If

                            htmlOut.Append(currentRow.Item("ac_year").ToString + vbTab)
                            htmlOut.Append(currentRow.Item("ac_aport_iata_code").ToString + vbTab)
                            htmlOut.Append(currentRow.Item("ac_aport_icao_code").ToString + vbTab)
                            htmlOut.Append(currentRow.Item("ac_aport_name").ToString + vbTab)
                            htmlOut.Append(currentRow.Item("ac_aport_city").ToString + vbTab)

                            If Not IsDBNull(currentRow.Item("ac_aport_state")) Then
                                htmlOut.Append(localFunctions.get_state_name_report(currentRow.Item("ac_aport_state").ToString, currentRow.Item("ac_aport_country").ToString) + vbTab)
                            Else
                                htmlOut.Append(vbTab)
                            End If

                            htmlOut.Append(currentRow.Item("ac_aport_state").ToString + vbTab)
                            htmlOut.Append(currentRow.Item("ac_aport_country").ToString + vbTab)
                            htmlOut.Append(currentRow.Item("ac_airframe_tot_hrs").ToString + vbTab)
                            htmlOut.Append(currentRow.Item("ac_engine_1_tot_hrs").ToString + vbTab)
                            htmlOut.Append(currentRow.Item("ac_engine_2_tot_hrs").ToString + vbTab)
                            htmlOut.Append(currentRow.Item("ac_engine_3_tot_hrs").ToString + vbTab)
                            htmlOut.Append(currentRow.Item("ac_engine_4_tot_hrs").ToString + vbTab)
                            htmlOut.Append(currentRow.Item("ac_engine_1_soh_hrs").ToString + vbTab)
                            htmlOut.Append(currentRow.Item("ac_engine_2_soh_hrs").ToString + vbTab)
                            htmlOut.Append(currentRow.Item("ac_engine_3_soh_hrs").ToString + vbTab)
                            htmlOut.Append(currentRow.Item("ac_engine_4_soh_hrs").ToString + vbTab)

                            'Skip the rest for aerodex
                            If Not bAerodexFlag Then

                                htmlOut.Append(currentRow.Item("ac_status").ToString + vbTab)
                                htmlOut.Append(currentRow.Item("ac_asking").ToString + vbTab)

                                If Not IsDBNull(currentRow.Item("ac_asking_price")) Then
                                    If CDbl(currentRow.Item("ac_asking_price").ToString) > 0 Then
                                        htmlOut.Append("$" + FormatNumber(CDbl(currentRow.Item("ac_asking_price").ToString), 0, False, False, True) + vbTab)
                                    Else
                                        htmlOut.Append(vbTab)
                                    End If
                                Else
                                    htmlOut.Append(vbTab)
                                End If

                                If Not IsDBNull(currentRow.Item("ac_list_date")) Then
                                    htmlOut.Append(FormatDateTime(currentRow.Item("ac_list_date").ToString, DateFormat.ShortDate))
                                End If

                            End If

                            htmlOut.Append(vbCrLf)

                        End If

                        RefInfo = ""
                        CompInfo = ""
                        CompPhoneInfo = ""
                        ContactInfo = ""
                        ContactPhoneInfo = ""

                    Next

                End If ' report_14_ref_datatable.Rows.Count > 0 

            End If ' report_14_ref_datatable.Rows.Count > 0 

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in GetReferences_14(ByVal acInfo As String, ByRef currentRow As DataRow) As String" + ex.Message
        Finally

            report_14_ref_datatable = Nothing

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOut.ToString

    End Function

#End Region

#Region "report_15_functions"

#End Region

#Region "report_17_functions"


#End Region

#Region "report_19_functions"

    Public Function create_report_19_offline_report() As String

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim report_19_datatable As New DataTable

        Dim adoRS_19 As System.Data.SqlClient.SqlDataReader : adoRS_19 = Nothing

        Dim htmlOut = New StringBuilder()
        Dim sQuery As New StringBuilder()

        Try

            SqlConn.ConnectionString = localFunctions.clientConnectStr

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 90

            If HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("comp_") Or
               HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("contact_") Or
               HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("state_") Or
               HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("country_") Then '
                sQuery.Append("SELECT DISTINCT * FROM View_Aircraft_Company_Flat WITH(NOLOCK) ")
            Else
                sQuery.Append("SELECT DISTINCT * FROM View_Aircraft_Flat WITH(NOLOCK) ")
            End If

            sQuery.Append(HttpContext.Current.Session.Item("MasterAircraftWhere").ToString)
            sQuery.Append(" ORDER BY amod_make_name, amod_airframe_type_code, amod_type_code, amod_id, amod_model_name, ac_ser_no_sort")

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />Create_Report_19_Offline_Report() As String<br />" + sQuery.ToString

            If bHtmlReport Then
                htmlOut.Append("<!DOCTYPE html>")
                htmlOut.Append("<html lang='en'>")
                htmlOut.Append("<head>")
                htmlOut.Append("<meta http-equiv='Content-Language' content='en-us' />")
                htmlOut.Append("<meta http-equiv='Content-Type' content='text/html; charset=windows-1252' />")
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='common/jetnet.css' />")
                htmlOut.Append("<title>JETNET - Offline Report</title>")
                htmlOut.Append("</head>")
                htmlOut.Append("<body style='background: white; margin-top:10px; margin-left:10px;'>")
                htmlOut.Append("<div style='text-align:center;'>")
            End If

            If bExcelReport Then
                htmlOut.Append("<table border='1' cellpadding='2' cellspacing='0'><td><tr>")
            ElseIf bHtmlReport Then
                htmlOut.Append("<table class='centerTable' border='0' cellpadding='2' cellspacing='0' width='100%'><td><tr>")
            End If

            SqlCommand.CommandText = sQuery.ToString
            adoRS_19 = SqlCommand.ExecuteReader()

            Try
                report_19_datatable.Load(adoRS_19)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = report_19_datatable.GetErrors()
            End Try

            adoRS_19.Close()
            adoRS_19 = Nothing

            If report_19_datatable.Rows.Count > 0 Then

                For Each Row As DataRow In report_19_datatable.Rows

                    'htmlOut.Append(Report_19_Header())

                    'htmlOut.Append(Report_19_ACList())

                    'htmlOut.Append(Report_19_BaseList())

                    'htmlOut.Append(Report_19_CompList())

                    'htmlOut.Append(Report_19_ACDetails())

                    'htmlOut.Append(Report_19_BaseDetails())

                    'htmlOut.Append(Report_19_CompanyDetails())

                    'htmlOut.Append(Report_19_ContactDetails())

                Next

                If bHtmlReport Or bExcelReport Then
                    htmlOut.Append("</td></tr></table>")
                End If

                If bHtmlReport Then
                    htmlOut.Append("</div>")
                    htmlOut.Append("</body>")
                    htmlOut.Append("</html>")
                End If

            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Create_Report_19_Offline_Report() As String" + ex.Message
        Finally
            adoRS_19 = Nothing

            report_19_datatable = Nothing

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOut.ToString

    End Function

#End Region

#Region "report_20_functions"

    Public Function create_report_20_export_current_events_list(ByRef record_count As Long) As String

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim report_20_datatable As New DataTable

        Dim adoRS_20 As System.Data.SqlClient.SqlDataReader : adoRS_20 = Nothing

        Dim htmlOut = New StringBuilder()
        Dim sQuery As New StringBuilder()

        Try

            SqlConn.ConnectionString = localFunctions.clientConnectStr

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text     '
            SqlCommand.CommandTimeout = 90

            If bFromEventDetail Then
                sQuery.Append(HttpContext.Current.Session.Item("MasterEvents"))
            Else

                sQuery.Append("SELECT DISTINCT *")

                If Not String.IsNullOrEmpty(HttpContext.Current.Session.Item("MasterAircraftEventsFrom").ToString.Trim) Then
                    sQuery.Append(" " + HttpContext.Current.Session.Item("MasterAircraftEventsFrom").ToString.Trim)
                    If HttpContext.Current.Session.Item("MasterAircraftEventsFrom").ToString.ToLower.Contains("priorev_ac_id") Then
                        sQuery.Append(" WHERE " + HttpContext.Current.Session.Item("MasterAircraftEventsWhere").ToString.Trim)
                        sQuery.Append(" ORDER BY amod_make_name, amod_airframe_type_code, amod_type_code, amod_id, amod_model_name, ac_ser_no_sort")
                    ElseIf HttpContext.Current.Session.Item("MasterAircraftEventsFrom").ToString.ToLower.Contains("priorev_amwant_id") Then
                        sQuery.Append(" WHERE " + HttpContext.Current.Session.Item("MasterAircraftEventsWhere").ToString.Trim)
                        sQuery.Append(" ORDER BY amod_make_name, amod_airframe_type_code, amod_type_code, amod_id, amod_model_name, priorev_entry_date ASC")
                    ElseIf HttpContext.Current.Session.Item("MasterAircraftEventsFrom").ToString.ToLower.Contains("priorev_comp_id") Then
                        sQuery.Append(" WHERE " + HttpContext.Current.Session.Item("MasterAircraftEventsWhere").ToString.Trim)
                        sQuery.Append(" ORDER BY priorev_entry_date ASC")
                    End If
                Else
                    sQuery.Append(" FROM Priority_Events WITH(NOLOCK) ")
                    sQuery.Append(" INNER JOIN Priority_Events_Category WITH(NOLOCK) ON priorev_category_code = priorevcat_category_code")

                    If HttpContext.Current.Session.Item("MasterAircraftEventsFrom").ToString.ToLower.Contains("priorev_ac_id") Then
                        sQuery.Append(" LEFT OUTER JOIN Aircraft WITH(NOLOCK) ON (priorev_ac_id = ac_id AND ac_journ_id = 0)")
                        sQuery.Append(" LEFT OUTER JOIN Aircraft_Model WITH(NOLOCK) ON (ac_amod_id = amod_id)")
                        sQuery.Append(" WHERE " + HttpContext.Current.Session.Item("MasterAircraftEventsWhere").ToString.Trim)
                        sQuery.Append(" ORDER BY amod_make_name, amod_airframe_type_code, amod_type_code, amod_id, amod_model_name, ac_ser_no_sort")
                    ElseIf HttpContext.Current.Session.Item("MasterAircraftEventsFrom").ToString.ToLower.Contains("priorev_amwant_id") Then
                        sQuery.Append(" LEFT OUTER JOIN Aircraft_Model_Wanted WITH(NOLOCK) ON (amwant_id = priorev_amwant_id AND priorev_amwant_id > 0)")
                        sQuery.Append(" LEFT OUTER JOIN Aircraft_Model WITH(NOLOCK) ON (amwant_amod_id = amod_id)")
                        sQuery.Append(" WHERE " + HttpContext.Current.Session.Item("MasterAircraftEventsWhere").ToString.Trim)
                        sQuery.Append(" ORDER BY amod_make_name, amod_airframe_type_code, amod_type_code, amod_id, amod_model_name, priorev_entry_date ASC")
                    ElseIf HttpContext.Current.Session.Item("MasterAircraftEventsFrom").ToString.ToLower.Contains("priorev_comp_id") Then
                        sQuery.Append(" LEFT OUTER JOIN Company WITH(NOLOCK) ON (priorev_comp_id = comp_id)")
                        sQuery.Append(" WHERE " + HttpContext.Current.Session.Item("MasterAircraftEventsWhere").ToString.Trim)
                        sQuery.Append(" ORDER BY priorev_entry_date ASC")
                    End If
                End If

            End If

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />create_report_20_export_current_events_list()<br />" + sQuery.ToString

            If bHtmlReport Then
                htmlOut.Append("<!DOCTYPE html>")
                htmlOut.Append("<html lang='en'>")
                htmlOut.Append("<head>")
                htmlOut.Append("<meta http-equiv='Content-Language' content='en-us' />")
                htmlOut.Append("<meta http-equiv='Content-Type' content='text/html; charset=windows-1252' />")
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='common/jetnet.css' />")
                htmlOut.Append("<title>JETNET - Export of Current Events List</title>")
                htmlOut.Append("</head>")
                htmlOut.Append("<body style='background: white; margin-top:10px; margin-left:10px;'>")
                htmlOut.Append("<div style='text-align:center;'>")
            End If

            If bExcelReport Then
                htmlOut.Append(localFunctions.include_excel_report_style() + vbCrLf)
                htmlOut.Append("<table border='1' cellpadding='2' cellspacing='0'>")
            ElseIf bHtmlReport Then
                htmlOut.Append("<table class='centerTable' border='0' cellpadding='2' cellspacing='0' width='100%'>")
            End If

            SqlCommand.CommandText = sQuery.ToString
            adoRS_20 = SqlCommand.ExecuteReader()

            Try
                report_20_datatable.Load(adoRS_20)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = report_20_datatable.GetErrors()
            End Try

            record_count = report_20_datatable.Rows.Count

            adoRS_20.Close()
            adoRS_20 = Nothing

            If report_20_datatable.Rows.Count > 0 Then

                If chkShowReportHeader.Checked Then

                    If bExcelReport Or bHtmlReport Then

                        htmlOut.Append("<tr bgcolor='#CCCCCC'>")

                        htmlOut.Append("<td>MAKE</td>")
                        htmlOut.Append("<td>MODEL</td>")
                        htmlOut.Append("<td>SERNBR</td>")
                        htmlOut.Append("<td>REGNO</td>")
                        htmlOut.Append("<td>EVENTDATETIME</td>")
                        htmlOut.Append("<td>EVENTDESCRIPTION</td>")

                        htmlOut.Append("</tr>")

                    ElseIf bTextCommaReport Then

                        htmlOut.Append(Constants.QUOTE + "MAKE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "MODEL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SERNBR" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "REGNO" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "EVENTDATETIME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "EVENTDESCRIPTION" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(vbCrLf)

                    ElseIf bTextTabReport Then

                        htmlOut.Append("MAKE" + vbTab)
                        htmlOut.Append("MODEL" + vbTab)
                        htmlOut.Append("SERNBR" + vbTab)
                        htmlOut.Append("REGNO" + vbTab)
                        htmlOut.Append("EVENTDATETIME" + vbTab)
                        htmlOut.Append("EVENTDESCRIPTION" + vbTab)

                        htmlOut.Append(vbCrLf)

                    End If

                End If ' chkShowReportHeader.Checked Then

                For Each Row As DataRow In report_20_datatable.Rows

                    If bHtmlReport Or bExcelReport Then

                        htmlOut.Append("<tr>")

                        If Not IsDBNull(Row.Item("priorev_ac_id")) Then
                            If IsNumeric(Row.Item("priorev_ac_id").ToString) Then
                                If CLng(Row.Item("priorev_ac_id").ToString) > 0 Then

                                    htmlOut.Append("<td>" + Row.Item("amod_make_name").ToString.Trim + "</td>")
                                    htmlOut.Append("<td>" + Row.Item("amod_model_name").ToString.Trim + "</td>")

                                    If Not (IsDBNull(Row.Item("ac_ser_no_full"))) Then
                                        htmlOut.Append("<td class='textformat'>" + Row.Item("ac_ser_no_full").ToString.Trim + "</td>")
                                    Else
                                        htmlOut.Append("<td></td>")
                                    End If

                                    If Not (IsDBNull(Row.Item("ac_reg_no"))) Then
                                        htmlOut.Append("<td class='textformat'>" + Row.Item("ac_reg_no").ToString.Trim + "</td>")
                                    Else
                                        htmlOut.Append("<td></td>")
                                    End If
                                End If
                            End If
                        End If

                        If Not IsDBNull(Row.Item("priorev_amwant_id")) Then
                            If IsNumeric(Row.Item("priorev_amwant_id").ToString) Then
                                If CLng(Row.Item("priorev_amwant_id").ToString) > 0 Then

                                    htmlOut.Append("<td>" + Row.Item("amod_make_name").ToString.Trim + "</td>")
                                    htmlOut.Append("<td>" + Row.Item("amod_model_name").ToString.Trim + "</td>")

                                    htmlOut.Append("<td>N/A</td>")
                                    htmlOut.Append("<td>N/A</td>")

                                End If
                            End If
                        End If

                        If Not IsDBNull(Row.Item("priorev_amwant_id")) And Not IsDBNull(Row.Item("priorev_ac_id")) Then
                            If IsNumeric(Row.Item("priorev_amwant_id").ToString) And IsNumeric(Row.Item("priorev_ac_id").ToString) Then
                                If CLng(Row.Item("priorev_amwant_id").ToString) = 0 And CLng(Row.Item("priorev_ac_id").ToString) = 0 Then
                                    htmlOut.Append("<td colspan='4' style='color: red;'>** Not Applicable **</td>")
                                End If
                            End If
                        End If


                        If Not (IsDBNull(Row.Item("priorev_entry_date"))) Then
                            htmlOut.Append("<td>" + FormatDateTime(Row.Item("priorev_entry_date").ToString, DateFormat.GeneralDate).Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        If Not (IsDBNull(Row.Item("priorev_subject"))) Then
                            htmlOut.Append("<td>" + Row.Item("priorev_subject").ToString.Trim + "&nbsp;" + Row.Item("priorev_description").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        htmlOut.Append("</tr>")

                    ElseIf bTextCommaReport Then

                        If Not IsDBNull(Row.Item("priorev_ac_id")) Then
                            If IsNumeric(Row.Item("priorev_ac_id").ToString) Then
                                If CLng(Row.Item("priorev_ac_id").ToString) > 0 Then

                                    htmlOut.Append(Constants.QUOTE + Row.Item("amod_make_name").ToString.Trim + Constants.QUOTE & Constants.cCommaDelim)
                                    htmlOut.Append(Constants.QUOTE + Row.Item("amod_model_name").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)

                                    If Not (IsDBNull(Row.Item("ac_ser_no_full"))) Then
                                        htmlOut.Append(Constants.QUOTE + Row.Item("ac_ser_no_full").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                                    Else
                                        htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                    End If

                                    If Not (IsDBNull(Row.Item("ac_reg_no"))) Then
                                        htmlOut.Append(Constants.QUOTE + Row.Item("ac_reg_no").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                                    Else
                                        htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                    End If

                                End If
                            End If
                        End If

                        If Not IsDBNull(Row.Item("priorev_amwant_id")) Then
                            If IsNumeric(Row.Item("priorev_amwant_id").ToString) Then
                                If CLng(Row.Item("priorev_amwant_id").ToString) > 0 Then

                                    htmlOut.Append(Constants.QUOTE + Row.Item("amod_make_name").ToString.Trim + Constants.QUOTE & Constants.cCommaDelim)
                                    htmlOut.Append(Constants.QUOTE + Row.Item("amod_model_name").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)

                                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)

                                End If
                            End If
                        End If

                        If Not IsDBNull(Row.Item("priorev_amwant_id")) And Not IsDBNull(Row.Item("priorev_ac_id")) Then
                            If IsNumeric(Row.Item("priorev_amwant_id").ToString) And IsNumeric(Row.Item("priorev_ac_id").ToString) Then
                                If CLng(Row.Item("priorev_amwant_id").ToString) = 0 And CLng(Row.Item("priorev_ac_id").ToString) = 0 Then
                                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim + Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim + Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim + Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                End If
                            End If
                        End If

                        If Not (IsDBNull(Row.Item("priorev_entry_date"))) Then
                            htmlOut.Append(Constants.QUOTE + FormatDateTime(Row.Item("priorev_entry_date").ToString, DateFormat.ShortDate).Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        If Not (IsDBNull(Row.Item("priorev_subject"))) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("priorev_subject").ToString.Trim + " " + Row.Item("priorev_description").ToString.Trim + Constants.QUOTE)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE)
                        End If

                        htmlOut.Append(vbCrLf)

                    ElseIf bTextTabReport Then

                        If Not IsDBNull(Row.Item("priorev_ac_id")) Then
                            If IsNumeric(Row.Item("priorev_ac_id").ToString) Then
                                If CLng(Row.Item("priorev_ac_id").ToString) > 0 Then

                                    htmlOut.Append(Row.Item("amod_make_name").ToString.Trim + vbTab)
                                    htmlOut.Append(Row.Item("amod_model_name").ToString.Trim + vbTab)

                                    If Not (IsDBNull(Row.Item("ac_ser_no_full"))) Then
                                        htmlOut.Append(Row.Item("ac_ser_no_full").ToString.Trim + vbTab)
                                    Else
                                        htmlOut.Append(vbTab)
                                    End If

                                    If Not (IsDBNull(Row.Item("ac_reg_no"))) Then
                                        htmlOut.Append(Row.Item("ac_reg_no").ToString.Trim + vbTab)
                                    Else
                                        htmlOut.Append(vbTab)
                                    End If

                                End If
                            End If
                        End If

                        If Not IsDBNull(Row.Item("priorev_amwant_id")) Then
                            If IsNumeric(Row.Item("priorev_amwant_id").ToString) Then
                                If CLng(Row.Item("priorev_amwant_id").ToString) > 0 Then

                                    htmlOut.Append(Row.Item("amod_make_name").ToString.Trim + vbTab)
                                    htmlOut.Append(Row.Item("amod_model_name").ToString.Trim + vbTab)

                                    htmlOut.Append(vbTab)
                                    htmlOut.Append(vbTab)

                                End If
                            End If
                        End If

                        If Not IsDBNull(Row.Item("priorev_amwant_id")) And Not IsDBNull(Row.Item("priorev_ac_id")) Then
                            If IsNumeric(Row.Item("priorev_amwant_id").ToString) And IsNumeric(Row.Item("priorev_ac_id").ToString) Then
                                If CLng(Row.Item("priorev_amwant_id").ToString) = 0 And CLng(Row.Item("priorev_ac_id").ToString) = 0 Then
                                    htmlOut.Append(vbTab + vbTab + vbTab + vbTab)
                                End If
                            End If
                        End If

                        If Not (IsDBNull(Row.Item("priorev_entry_date"))) Then
                            htmlOut.Append(FormatDateTime(Row.Item("priorev_entry_date").ToString, DateFormat.GeneralDate).Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        If Not (IsDBNull(Row.Item("priorev_subject"))) Then
                            htmlOut.Append(Row.Item("priorev_subject").ToString.Trim + " " + Row.Item("priorev_description").ToString.Trim)
                        End If

                        htmlOut.Append(vbCrLf)

                    End If

                Next

            End If

            If bHtmlReport Or bExcelReport Then
                htmlOut.Append("</table>")
            End If

            If bHtmlReport Then
                htmlOut.Append("</div>")
                htmlOut.Append("</body>")
                htmlOut.Append("</html>")
            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in create_report_20_export_current_events_list()" + ex.Message
        Finally

            report_20_datatable = Nothing

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOut.ToString

    End Function

#End Region

#Region "report_21_functions"

    Public Function create_report_21_labels_export_current_events_list(ByRef record_count As Long) As String

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim report_21_datatable As New DataTable

        Dim adoRS_21 As System.Data.SqlClient.SqlDataReader : adoRS_21 = Nothing

        Dim htmlOut = New StringBuilder()
        Dim sQuery As New StringBuilder()

        Dim ACInfo1 As New StringBuilder()
        Dim ACInfo2 As New StringBuilder()
        Dim ACInfo3 As New StringBuilder()

        Dim LeaseInfo As New StringBuilder()

        Dim bIsAircraftEvents As Boolean = False
        Dim bIsWantedEvents As Boolean = False
        Dim bIsCompanyEvents As Boolean = False
        Dim bIsLease As Boolean = False

        Dim strLeaseExpConfirmDate As String = ""
        Dim strScheduledLeaseExpiration As String = ""
        Dim strDateLeaseExpired As String = ""
        Dim strTransactionDate As String = ""

        Dim sCompanyInfo As String = ""
        Dim sCompanyPhoneInfo As String = ""
        Dim sContactInfo As String = ""
        Dim sContactPhoneInfo As String = ""

        Dim sFractionPercent As String = ""
        Dim sFractionExpiresDate As String = ""

        Try

            SqlConn.ConnectionString = localFunctions.clientConnectStr

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text     '
            SqlCommand.CommandTimeout = 90

            If bFromEventDetail Then
                sQuery.Append(HttpContext.Current.Session.Item("MasterEvents"))
            Else
                sQuery.Append("SELECT DISTINCT * FROM Priority_Events WITH(NOLOCK)")
                sQuery.Append(" INNER JOIN Priority_Events_Category WITH(NOLOCK) ON priorev_category_code = priorevcat_category_code")

                ' added MSW - 9/4/19 
                If InStr(HttpContext.Current.Session.Item("MasterAircraftEventsWhere"), "comp_name_search") > 0 Or InStr(HttpContext.Current.Session.Item("MasterAircraftEventsWhere"), "comp_altname_search") > 0 Then
                    sQuery.Append(" LEFT OUTER JOIN View_Aircraft_Company_Flat WITH(NOLOCK) ON (priorev_ac_id = ac_id AND ac_journ_id = 0)")
                Else
                    sQuery.Append(" LEFT OUTER JOIN View_Aircraft_Flat WITH(NOLOCK) ON (priorev_ac_id = ac_id AND ac_journ_id = 0)")
                End If

                sQuery.Append(" WHERE " + HttpContext.Current.Session.Item("MasterAircraftEventsWhere").ToString.Trim)
                sQuery.Append(" ORDER BY amod_make_name, amod_airframe_type_code, amod_type_code, amod_id, amod_model_name, ac_ser_no_sort")
            End If

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />create_report_21_labels_export_current_events_list()<br />" + sQuery.ToString

            If bHtmlReport Then
                htmlOut.Append("<!DOCTYPE html>")
                htmlOut.Append("<html lang='en'>")
                htmlOut.Append("<head>")
                htmlOut.Append("<meta http-equiv='Content-Language' content='en-us' />")
                htmlOut.Append("<meta http-equiv='Content-Type' content='text/html; charset=windows-1252' />")
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='common/jetnet.css' />")
                htmlOut.Append("<title>JETNET - Labels Export of Current Events List</title>")
                htmlOut.Append("</head>")
                htmlOut.Append("<body style='background: white; margin-top:10px; margin-left:10px;'>")
                htmlOut.Append("<div style='text-align:center;'>")
            End If

            If bExcelReport Then
                htmlOut.Append(localFunctions.include_excel_report_style() + vbCrLf)
                htmlOut.Append("<table border='1' cellpadding='2' cellspacing='0'>")
            ElseIf bHtmlReport Then
                htmlOut.Append("<table class='centerTable' border='0' cellpadding='2' cellspacing='0' width='100%'>")
            End If

            SqlCommand.CommandText = sQuery.ToString
            adoRS_21 = SqlCommand.ExecuteReader()

            Try
                report_21_datatable.Load(adoRS_21)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = report_21_datatable.GetErrors()
            End Try

            record_count = report_21_datatable.Rows.Count

            adoRS_21.Close()
            adoRS_21 = Nothing

            If report_21_datatable.Rows.Count > 0 Then

                If chkShowReportHeader.Checked Then

                    If bExcelReport Or bHtmlReport Then

                        htmlOut.Append("<tr bgcolor='#CCCCCC'>")

                        htmlOut.Append("<td>MAKE</td>")
                        htmlOut.Append("<td>MODEL</td>")
                        htmlOut.Append("<td>SERNBR</td>")
                        htmlOut.Append("<td>REGNO</td>")

                        htmlOut.Append("<td>EVENTDATETIME</td>")
                        htmlOut.Append("<td>EVENTDESCRIPTION</td>")

                        htmlOut.Append("<td>FRACTIONPERCENTOWNED</td>")
                        htmlOut.Append("<td>FRACTIONPURCHASEDATE</td>")

                        htmlOut.Append("<td>COMPANY</td>")
                        htmlOut.Append("<td>COMPALTNAME</td>")
                        htmlOut.Append("<td>COMPEMAIL</td>")
                        htmlOut.Append("<td>COMPWEBADDRESS</td>")
                        htmlOut.Append("<td>COMPADDRESS1</td>")
                        htmlOut.Append("<td>COMPADDRESS2</td>")
                        htmlOut.Append("<td>COMPCITY</td>")
                        htmlOut.Append("<td>COMPSTATE</td>")
                        htmlOut.Append("<td>COMPSTATEABBR</td>")
                        htmlOut.Append("<td>COMPPOSTALCODE</td>")
                        htmlOut.Append("<td>COMPCOUNTRY</td>")
                        htmlOut.Append("<td>COMPOFFICE</td>")
                        htmlOut.Append("<td>COMPFAX</td>")
                        htmlOut.Append("<td>COMPMOBILE</td>")

                        htmlOut.Append("<td>CONTACTPREFIX</td>")
                        htmlOut.Append("<td>CONTACTFIRSTNAME</td>")
                        htmlOut.Append("<td>CONTACTMI</td>")
                        htmlOut.Append("<td>CONTACTLASTNAME</td>")
                        htmlOut.Append("<td>CONTACTSUFFIX</td>")
                        htmlOut.Append("<td>CONTACTTITLE</td>")
                        htmlOut.Append("<td>CONTACTEMAILADDRESS</td>")
                        htmlOut.Append("<td>CONTACTOFFICE</td>")
                        htmlOut.Append("<td>CONTACTFAX</td>")
                        htmlOut.Append("<td>CONTACTMOBILE</td>")

                        htmlOut.Append("<td>YEARMFG</td>")
                        htmlOut.Append("<td>YEARDLV</td>")
                        htmlOut.Append("<td>BASEIATA</td>")
                        htmlOut.Append("<td>BASEICAO</td>")
                        htmlOut.Append("<td>BASENAME</td>")
                        htmlOut.Append("<td>BASECITY</td>")
                        htmlOut.Append("<td>BASESTATE</td>")
                        htmlOut.Append("<td>BASESTATEABBR</td>")
                        htmlOut.Append("<td>BASECOUNTRY</td>")

                        htmlOut.Append("<td>AFTT</td>")
                        htmlOut.Append("<td>ENG1TT</td>")
                        htmlOut.Append("<td>ENG2TT</td>")
                        htmlOut.Append("<td>ENG3TT</td>")
                        htmlOut.Append("<td>ENG4TT</td>")
                        htmlOut.Append("<td>SMOH1</td>")
                        htmlOut.Append("<td>SMOH2</td>")
                        htmlOut.Append("<td>SMOH3</td>")
                        htmlOut.Append("<td>SMOH4</td>")

                        htmlOut.Append("<td>SCHEDULEDLEASEEXPIRATION</td>")
                        htmlOut.Append("<td>DATELEASEEXPIRED</td>")
                        htmlOut.Append("<td>TRANSACTIONDATE</td>")

                        If Not bAerodexFlag Then
                            htmlOut.Append("<td>STATUS</td>")
                            htmlOut.Append("<td>ASKING</td>")
                            htmlOut.Append("<td>ASKINGAMT</td>")
                            htmlOut.Append("<td>DATELISTED</td>")
                        End If

                        htmlOut.Append("</tr>")

                    ElseIf bTextCommaReport Then

                        htmlOut.Append(Constants.QUOTE + "MAKE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "MODEL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SERNBR" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "REGNO" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "EVENTDATETIME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "EVENTDESCRIPTION" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "FRACTIONPERCENTOWNED" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "FRACTIONPURCHASEDATE" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "COMPANY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPALTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPEMAIL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPWEBADDRESS" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPADDRESS1" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPADDRESS2" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPCITY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPSTATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPSTATEABBR" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPPOSTALCODE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPCOUNTRY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPOFFICEE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPFAX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPMOBILE" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "CONTACTPREFIX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACTFIRSTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACTMI" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACTLASTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACTSUFFIX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACTTITLE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACTEMAILADDRESS" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACTOFFICE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACTFAX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACTMOBILE" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "YEARMFG" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "YEARDLV" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BASEIATA" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BASEICAO" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BASENAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BASECITY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BASESTATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BASESTATEABBR" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BASECOUNTRY" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "AFTT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "ENG1TT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "ENG2TT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "ENG3TT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "ENG4TT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SMOH1" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SMOH2" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SMOH3" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SMOH4" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "SCHEDULEDLEASEEXPIRATION" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "DATELEASEEXPIRED" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "TRANSACTIONDATE" + Constants.QUOTE)

                        If Not bAerodexFlag Then
                            htmlOut.Append(Constants.cCommaDelim + Constants.QUOTE + "STATUS" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "ASKING" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "ASKINGAMT" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "DATELISTED" + Constants.QUOTE)
                        End If

                        htmlOut.Append(vbCrLf)

                    ElseIf bTextTabReport Then

                        htmlOut.Append("MAKE" + vbTab)
                        htmlOut.Append("MODEL" + vbTab)
                        htmlOut.Append("SERNBR" + vbTab)
                        htmlOut.Append("REGNO" + vbTab)
                        htmlOut.Append("EVENTDATETIME" + vbTab)
                        htmlOut.Append("EVENTDESCRIPTION" + vbTab)

                        htmlOut.Append("FRACTIONPERCENTOWNED" + vbTab)
                        htmlOut.Append("FRACTIONPURCHASEDATE" + vbTab)

                        htmlOut.Append("COMPANY" + vbTab)
                        htmlOut.Append("COMPALTNAME" + vbTab)
                        htmlOut.Append("COMPEMAIL" + vbTab)
                        htmlOut.Append("COMPWEBADDRESS" + vbTab)
                        htmlOut.Append("COMPADDRESS1" + vbTab)
                        htmlOut.Append("COMPADDRESS2" + vbTab)
                        htmlOut.Append("COMPCITY" + vbTab)
                        htmlOut.Append("COMPSTATE" + vbTab)
                        htmlOut.Append("COMPSTATEABBR" + vbTab)
                        htmlOut.Append("COMPPOSTALCODE" + vbTab)
                        htmlOut.Append("COMPCOUNTRY" + vbTab)
                        htmlOut.Append("COMPOFFICE" + vbTab)
                        htmlOut.Append("COMPFAX" + vbTab)
                        htmlOut.Append("COMPMOBILE" + vbTab)

                        htmlOut.Append("CONTACTPREFIX" + vbTab)
                        htmlOut.Append("CONTACTFIRST NAME" + vbTab)
                        htmlOut.Append("CONTACTMI" + vbTab)
                        htmlOut.Append("CONTACTLAST NAME" + vbTab)
                        htmlOut.Append("CONTACTSUFFIX" + vbTab)
                        htmlOut.Append("CONTACTTITLE" + vbTab)
                        htmlOut.Append("CONTACTEMAILADDRESS" + vbTab)
                        htmlOut.Append("CONTACTOFFICE" + vbTab)
                        htmlOut.Append("CONTACTFAX" + vbTab)
                        htmlOut.Append("CONTACTMOBILE" + vbTab)

                        htmlOut.Append("YEARMFG" + vbTab)
                        htmlOut.Append("YEARDLV" + vbTab)
                        htmlOut.Append("BASEIATA" + vbTab)
                        htmlOut.Append("BASEICAO" + vbTab)
                        htmlOut.Append("BASENAME" + vbTab)
                        htmlOut.Append("BASECITY" + vbTab)
                        htmlOut.Append("BASESTATE" + vbTab)
                        htmlOut.Append("BASESTATEABBR" + vbTab)
                        htmlOut.Append("BASECOUNTRY" + vbTab)

                        htmlOut.Append("AFTT" + vbTab)
                        htmlOut.Append("ENG1TT" + vbTab)
                        htmlOut.Append("ENG2TT" + vbTab)
                        htmlOut.Append("ENG3TT" + vbTab)
                        htmlOut.Append("ENG4TT" + vbTab)
                        htmlOut.Append("SMOH1" + vbTab)
                        htmlOut.Append("SMOH2" + vbTab)
                        htmlOut.Append("SMOH3" + vbTab)
                        htmlOut.Append("SMOH4" + vbTab)

                        htmlOut.Append("SCHEDULEDLEASEEXPIRATION" + vbTab)
                        htmlOut.Append("DATELEASEEXPIRED" + vbTab)
                        htmlOut.Append("TRANSACTIONDATE")

                        'Skip the rest for aerodex
                        If Not bAerodexFlag Then
                            htmlOut.Append(vbTab + "STATUS" + vbTab)
                            htmlOut.Append("ASKING" + vbTab)
                            htmlOut.Append("ASKINGAMT" + vbTab)
                            htmlOut.Append("DATELISTED")
                        End If

                        htmlOut.Append(vbCrLf)

                    End If

                End If ' chkShowReportHeader.Checked Then

                For Each Row As DataRow In report_21_datatable.Rows

                    ACInfo1 = New StringBuilder()
                    ACInfo2 = New StringBuilder()
                    ACInfo3 = New StringBuilder()

                    LeaseInfo = New StringBuilder()

                    strLeaseExpConfirmDate = ""
                    strScheduledLeaseExpiration = ""
                    strDateLeaseExpired = ""
                    strTransactionDate = ""

                    sCompanyInfo = ""
                    sCompanyPhoneInfo = ""
                    sContactInfo = ""
                    sContactPhoneInfo = ""

                    If Not IsDBNull(Row.Item("priorev_subject")) And Not IsDBNull(Row.Item("ac_id")) Then

                        If Row.Item("priorev_subject").ToString.Substring(0, 5).ToLower.Contains("lease") Then

                            bIsLease = True

                            If Row.Item("priorev_subject").ToString.ToLower.Contains("expired") Then
                                strLeaseExpConfirmDate = localFunctions.get_lease_expire_confirm_date(CLng(Row.Item("priorev_journ_id").ToString), True)
                            Else
                                strLeaseExpConfirmDate = localFunctions.get_lease_expire_confirm_date(CLng(Row.Item("priorev_journ_id").ToString), False)
                            End If

                            strScheduledLeaseExpiration = localFunctions.get_lease_expire_date(CLng(Row.Item("priorev_journ_id").ToString), CLng(Row.Item("ac_id").ToString), strLeaseExpConfirmDate)

                            strDateLeaseExpired = strLeaseExpConfirmDate
                            strTransactionDate = localFunctions.get_journal_date(CLng(Row.Item("priorev_journ_id").ToString))

                        End If

                    End If

                    If bHtmlReport Or bExcelReport Then

                        ACInfo1.Append("<tr>")

                        ACInfo1.Append("<td>" + Row.Item("amod_make_name").ToString.Trim + "</td>")
                        ACInfo1.Append("<td>" + Row.Item("amod_model_name").ToString.Trim + "</td>")

                        If Not (IsDBNull(Row.Item("ac_ser_no_full"))) Then
                            ACInfo1.Append("<td class='textformat'>" + Row.Item("ac_ser_no_full").ToString.Trim + "</td>")
                        Else
                            ACInfo1.Append("<td></td>")
                        End If

                        If Not (IsDBNull(Row.Item("ac_reg_no"))) Then
                            ACInfo1.Append("<td class='textformat'>" + Row.Item("ac_reg_no").ToString.Trim + "</td>")
                        Else
                            ACInfo1.Append("<td></td>")
                        End If

                        If Not (IsDBNull(Row.Item("priorev_entry_date"))) Then
                            ACInfo1.Append("<td>" + FormatDateTime(Row.Item("priorev_entry_date").ToString, DateFormat.GeneralDate).Trim + "</td>")
                        Else
                            ACInfo1.Append("<td></td>")
                        End If

                        If Not (IsDBNull(Row.Item("priorev_subject"))) Then
                            ACInfo1.Append("<td>" + Row.Item("priorev_subject").ToString.Trim + "&nbsp;" + Row.Item("priorev_description").ToString.Trim + "</td>")
                        Else
                            ACInfo1.Append("<td></td>")
                        End If

                        If Not IsDBNull(Row.Item("ac_mfr_year")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_mfr_year").ToString.Trim) Then
                                ACInfo2.Append("<td>" + Row.Item("ac_mfr_year").ToString + "</td>")
                            Else
                                ACInfo2.Append("<td></td>")
                            End If
                        Else
                            ACInfo2.Append("<td></td>")
                        End If

                        ACInfo2.Append("<td>" + Row.Item("ac_year").ToString + "</td>")
                        ACInfo2.Append("<td>" + Row.Item("ac_aport_iata_code").ToString + "</td>")
                        ACInfo2.Append("<td>" + Row.Item("ac_aport_icao_code").ToString + "</td>")
                        ACInfo2.Append("<td>" + Row.Item("ac_aport_name").ToString + "</td>")
                        ACInfo2.Append("<td>" + Row.Item("ac_aport_city").ToString + "</td>")

                        If Not IsDBNull(Row.Item("ac_aport_state")) Then
                            ACInfo2.Append("<td>" + localFunctions.get_state_name_report(Row.Item("ac_aport_state").ToString, Row.Item("ac_aport_country").ToString) + "</td>")
                        Else
                            ACInfo2.Append("<td>&nbsp;</td>")
                        End If

                        ACInfo2.Append("<td>" + Row.Item("ac_aport_state").ToString + "</td>")
                        ACInfo2.Append("<td>" + Row.Item("ac_aport_country").ToString + "</td>")
                        ACInfo2.Append("<td>" + Row.Item("ac_airframe_tot_hrs").ToString + "</td>")
                        ACInfo2.Append("<td>" + Row.Item("ac_engine_1_tot_hrs").ToString + "</td>")
                        ACInfo2.Append("<td>" + Row.Item("ac_engine_2_tot_hrs").ToString + "</td>")
                        ACInfo2.Append("<td>" + Row.Item("ac_engine_3_tot_hrs").ToString + "</td>")
                        ACInfo2.Append("<td>" + Row.Item("ac_engine_4_tot_hrs").ToString + "</td>")
                        ACInfo2.Append("<td>" + Row.Item("ac_engine_1_soh_hrs").ToString + "</td>")
                        ACInfo2.Append("<td>" + Row.Item("ac_engine_2_soh_hrs").ToString + "</td>")
                        ACInfo2.Append("<td>" + Row.Item("ac_engine_3_soh_hrs").ToString + "</td>")
                        ACInfo2.Append("<td>" + Row.Item("ac_engine_4_soh_hrs").ToString + "</td>")

                        LeaseInfo.Append("<td>" + strScheduledLeaseExpiration + "</td>")
                        LeaseInfo.Append("<td>" + strDateLeaseExpired + "</td>")
                        LeaseInfo.Append("<td>" + strTransactionDate + "</td>")

                        If Not bAerodexFlag Then

                            ACInfo3.Append("<td>" + Row.Item("ac_status").ToString + "</td>")
                            ACInfo3.Append("<td>" + Row.Item("ac_asking").ToString + "</td>")

                            If Not IsDBNull(Row.Item("ac_asking_price")) Then
                                If CDbl(Row.Item("ac_asking_price").ToString) > 0 Then
                                    ACInfo3.Append("<td>$" + FormatNumber(CDbl(Row.Item("ac_asking_price").ToString), 0, False, False, True) + "</td>")
                                Else
                                    ACInfo3.Append("<td></td>")
                                End If
                            Else
                                ACInfo3.Append("<td></td>")
                            End If

                            If Not IsDBNull(Row.Item("ac_list_date")) Then
                                ACInfo3.Append("<td class='dateformat'>" + FormatDateTime(Row.Item("ac_list_date").ToString, DateFormat.ShortDate) + "</td>")
                            Else
                                ACInfo3.Append("<td class='dateformat'>&nbsp;</td>")
                            End If

                        End If

                        ACInfo3.Append("</tr>")

                    ElseIf bTextCommaReport Then

                        ACInfo1.Append(Constants.QUOTE + Row.Item("amod_make_name").ToString.Trim + Constants.QUOTE & Constants.cCommaDelim)
                        ACInfo1.Append(Constants.QUOTE + Row.Item("amod_model_name").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)

                        If Not (IsDBNull(Row.Item("ac_ser_no_full"))) Then
                            ACInfo1.Append(Constants.QUOTE + Row.Item("ac_ser_no_full").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            ACInfo1.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        If Not (IsDBNull(Row.Item("ac_reg_no"))) Then
                            ACInfo1.Append(Constants.QUOTE + Row.Item("ac_reg_no").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            ACInfo1.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If


                        If Not (IsDBNull(Row.Item("priorev_entry_date"))) Then
                            ACInfo1.Append(Constants.QUOTE + FormatDateTime(Row.Item("priorev_entry_date").ToString, DateFormat.ShortDate).Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            ACInfo1.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        If Not (IsDBNull(Row.Item("priorev_subject"))) Then
                            ACInfo1.Append(Constants.QUOTE + Row.Item("priorev_subject").ToString.Trim + " " + Row.Item("priorev_description").ToString.Trim + Constants.QUOTE)
                        Else
                            ACInfo1.Append(Constants.QUOTE + Constants.QUOTE)
                        End If

                        If Not IsDBNull(Row.Item("ac_mfr_year")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_mfr_year").ToString.Trim) Then
                                ACInfo2.Append(Constants.QUOTE + Row.Item("ac_mfr_year").ToString + Constants.QUOTE + Constants.cCommaDelim)
                            Else
                                ACInfo2.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                            End If
                        Else
                            ACInfo2.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        ACInfo2.Append(Constants.QUOTE + Row.Item("ac_year").ToString + Constants.QUOTE + Constants.cCommaDelim)
                        ACInfo2.Append(Constants.QUOTE + Row.Item("ac_aport_iata_code").ToString + Constants.QUOTE + Constants.cCommaDelim)
                        ACInfo2.Append(Constants.QUOTE + Row.Item("ac_aport_icao_code").ToString + Constants.QUOTE + Constants.cCommaDelim)
                        ACInfo2.Append(Constants.QUOTE + Row.Item("ac_aport_name").ToString + Constants.QUOTE + Constants.cCommaDelim)
                        ACInfo2.Append(Constants.QUOTE + Row.Item("ac_aport_city").ToString + Constants.QUOTE + Constants.cCommaDelim)

                        If Not IsDBNull(Row.Item("ac_aport_state")) Then
                            ACInfo2.Append(Constants.QUOTE + localFunctions.get_state_name_report(Row.Item("ac_aport_state").ToString, Row.Item("ac_aport_country").ToString) + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            ACInfo2.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        ACInfo2.Append(Constants.QUOTE + Row.Item("ac_aport_state").ToString + Constants.QUOTE + Constants.cCommaDelim)
                        ACInfo2.Append(Constants.QUOTE + Row.Item("ac_aport_country").ToString + Constants.QUOTE + Constants.cCommaDelim)
                        ACInfo2.Append(Constants.QUOTE + Row.Item("ac_airframe_tot_hrs").ToString + Constants.QUOTE + Constants.cCommaDelim)
                        ACInfo2.Append(Constants.QUOTE + Row.Item("ac_engine_1_tot_hrs").ToString + Constants.QUOTE + Constants.cCommaDelim)
                        ACInfo2.Append(Constants.QUOTE + Row.Item("ac_engine_2_tot_hrs").ToString + Constants.QUOTE + Constants.cCommaDelim)
                        ACInfo2.Append(Constants.QUOTE + Row.Item("ac_engine_3_tot_hrs").ToString + Constants.QUOTE + Constants.cCommaDelim)
                        ACInfo2.Append(Constants.QUOTE + Row.Item("ac_engine_4_tot_hrs").ToString + Constants.QUOTE + Constants.cCommaDelim)
                        ACInfo2.Append(Constants.QUOTE + Row.Item("ac_engine_1_soh_hrs").ToString + Constants.QUOTE + Constants.cCommaDelim)
                        ACInfo2.Append(Constants.QUOTE + Row.Item("ac_engine_2_soh_hrs").ToString + Constants.QUOTE + Constants.cCommaDelim)
                        ACInfo2.Append(Constants.QUOTE + Row.Item("ac_engine_3_soh_hrs").ToString + Constants.QUOTE + Constants.cCommaDelim)
                        ACInfo2.Append(Constants.QUOTE + Row.Item("ac_engine_4_soh_hrs").ToString + Constants.QUOTE + Constants.cCommaDelim)

                        LeaseInfo.Append(Constants.QUOTE + strScheduledLeaseExpiration + Constants.QUOTE + Constants.cCommaDelim)
                        LeaseInfo.Append(Constants.QUOTE + strDateLeaseExpired + Constants.QUOTE + Constants.cCommaDelim)
                        LeaseInfo.Append(Constants.QUOTE + strTransactionDate + Constants.QUOTE + Constants.cCommaDelim)

                        'Skip the rest for aerodex
                        If Not bAerodexFlag Then

                            ACInfo3.Append(Constants.QUOTE + Row.Item("ac_status").ToString + Constants.QUOTE + Constants.cCommaDelim)
                            ACInfo3.Append(Constants.QUOTE + Row.Item("ac_asking").ToString + Constants.QUOTE + Constants.cCommaDelim)

                            If Not IsDBNull(Row.Item("ac_asking_price")) Then
                                If CDbl(Row.Item("ac_asking_price").ToString) > 0 Then
                                    ACInfo3.Append(Constants.QUOTE + "$" + FormatNumber(CDbl(Row.Item("ac_asking_price").ToString), 0, False, False, True) + Constants.QUOTE + Constants.cCommaDelim)
                                Else
                                    ACInfo3.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                End If
                            Else
                                ACInfo3.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                            End If

                            If Not IsDBNull(Row.Item("ac_list_date")) Then
                                ACInfo3.Append(Constants.QUOTE + FormatDateTime(Row.Item("ac_list_date").ToString, DateFormat.ShortDate) + Constants.QUOTE)
                            Else
                                ACInfo3.Append(Constants.QUOTE + Constants.QUOTE)
                            End If

                        End If

                        ACInfo3.Append(vbCrLf)

                    ElseIf bTextTabReport Then

                        ACInfo1.Append(Row.Item("amod_make_name").ToString.Trim + vbTab)
                        ACInfo1.Append(Row.Item("amod_model_name").ToString.Trim + vbTab)

                        If Not (IsDBNull(Row.Item("ac_ser_no_full"))) Then
                            ACInfo1.Append(Row.Item("ac_ser_no_full").ToString.Trim + vbTab)
                        Else
                            ACInfo1.Append(vbTab)
                        End If

                        If Not (IsDBNull(Row.Item("ac_reg_no"))) Then
                            ACInfo1.Append(Row.Item("ac_reg_no").ToString.Trim + vbTab)
                        Else
                            ACInfo1.Append(vbTab)
                        End If

                        If Not (IsDBNull(Row.Item("priorev_entry_date"))) Then
                            ACInfo1.Append(FormatDateTime(Row.Item("priorev_entry_date").ToString, DateFormat.GeneralDate).Trim + vbTab)
                        Else
                            ACInfo1.Append(vbTab)
                        End If

                        If Not (IsDBNull(Row.Item("priorev_subject"))) Then
                            ACInfo1.Append(Row.Item("priorev_subject").ToString.Trim + " " + Row.Item("priorev_description").ToString.Trim)
                        End If

                        If Not IsDBNull(Row.Item("ac_mfr_year")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_mfr_year").ToString.Trim) Then
                                htmlOut.Append(Row.Item("ac_mfr_year").ToString + vbTab)
                            Else
                                htmlOut.Append(vbTab)
                            End If
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        htmlOut.Append(Row.Item("ac_year").ToString + vbTab)
                        htmlOut.Append(Row.Item("ac_aport_iata_code").ToString + vbTab)
                        htmlOut.Append(Row.Item("ac_aport_icao_code").ToString + vbTab)
                        htmlOut.Append(Row.Item("ac_aport_name").ToString + vbTab)
                        htmlOut.Append(Row.Item("ac_aport_city").ToString + vbTab)

                        If Not IsDBNull(Row.Item("ac_aport_state")) Then
                            htmlOut.Append(localFunctions.get_state_name_report(Row.Item("ac_aport_state").ToString, Row.Item("ac_aport_country").ToString) + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        htmlOut.Append(Row.Item("ac_aport_state").ToString + vbTab)
                        htmlOut.Append(Row.Item("ac_aport_country").ToString + vbTab)
                        htmlOut.Append(Row.Item("ac_airframe_tot_hrs").ToString + vbTab)
                        htmlOut.Append(Row.Item("ac_engine_1_tot_hrs").ToString + vbTab)
                        htmlOut.Append(Row.Item("ac_engine_2_tot_hrs").ToString + vbTab)
                        htmlOut.Append(Row.Item("ac_engine_3_tot_hrs").ToString + vbTab)
                        htmlOut.Append(Row.Item("ac_engine_4_tot_hrs").ToString + vbTab)
                        htmlOut.Append(Row.Item("ac_engine_1_soh_hrs").ToString + vbTab)
                        htmlOut.Append(Row.Item("ac_engine_2_soh_hrs").ToString + vbTab)
                        htmlOut.Append(Row.Item("ac_engine_3_soh_hrs").ToString + vbTab)
                        htmlOut.Append(Row.Item("ac_engine_4_soh_hrs").ToString + vbTab)

                        LeaseInfo.Append(strScheduledLeaseExpiration + vbTab)
                        LeaseInfo.Append(strDateLeaseExpired + vbTab)
                        LeaseInfo.Append(strTransactionDate + vbTab)

                        'Skip the rest for aerodex
                        If Not bAerodexFlag Then

                            htmlOut.Append(Row.Item("ac_status").ToString + vbTab)
                            htmlOut.Append(Row.Item("ac_asking").ToString + vbTab)

                            If Not IsDBNull(Row.Item("ac_asking_price")) Then
                                If CDbl(Row.Item("ac_asking_price").ToString) > 0 Then
                                    htmlOut.Append("$" + FormatNumber(CDbl(Row.Item("ac_asking_price").ToString), 0, False, False, True) + vbTab)
                                Else
                                    htmlOut.Append(vbTab)
                                End If
                            Else
                                htmlOut.Append(vbTab)
                            End If

                            If Not IsDBNull(Row.Item("ac_list_date")) Then
                                htmlOut.Append(FormatDateTime(Row.Item("ac_list_date").ToString, DateFormat.ShortDate))
                            End If

                        End If

                        ACInfo3.Append(vbCrLf)

                    End If

                    htmlOut.Append(ACInfo1.ToString)

                    localFunctions.get_fraction_percent_and_expire_date(CLng(Row.Item("priorev_journ_id").ToString), True, sFractionPercent, sFractionExpiresDate)

                    If bHtmlReport Or bExcelReport Then
                        htmlOut.Append("<td>" + sFractionPercent.Trim + "</td>")
                        htmlOut.Append("<td>" + sFractionExpiresDate.Trim + "</td>")
                    ElseIf bTextCommaReport Then
                        htmlOut.Append(Constants.QUOTE + sFractionPercent.Trim + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + sFractionExpiresDate.Trim + Constants.QUOTE + Constants.cCommaDelim)
                    ElseIf bTextTabReport Then
                        htmlOut.Append(sFractionPercent.Trim + vbTab)
                        htmlOut.Append(sFractionExpiresDate.Trim + vbTab)
                    End If

                    get_references_21(Row, sCompanyInfo, sCompanyPhoneInfo, sContactInfo, sContactPhoneInfo)

                    htmlOut.Append(sCompanyInfo + sCompanyPhoneInfo + sContactInfo + sContactPhoneInfo + ACInfo2.ToString + LeaseInfo.ToString + ACInfo3.ToString)

                Next

            End If

            If bHtmlReport Or bExcelReport Then
                htmlOut.Append("</table>")
            End If

            If bHtmlReport Then
                htmlOut.Append("</div>")
                htmlOut.Append("</body>")
                htmlOut.Append("</html>")
            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in create_report_21_labels_export_current_events_list()" + ex.Message
        Finally

            report_21_datatable = Nothing

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOut.ToString

    End Function

    Public Sub get_references_21(ByRef currentRow As DataRow, ByRef sCompanyInfo As String, ByRef sCompanyPhoneInfo As String, ByRef sContactInfo As String, ByRef sContactPhoneInfo As String)
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim references_21_datatable As New DataTable

        Dim adoRS_ref_21 As System.Data.SqlClient.SqlDataReader : adoRS_ref_21 = Nothing

        Dim sQuery As New StringBuilder()

        Try

            SqlConn.ConnectionString = localFunctions.clientConnectStr

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text     '
            SqlCommand.CommandTimeout = 90

            If Not IsNothing(currentRow) Then

                If CLng(currentRow.Item("priorev_comp_id").ToString) > 0 Then

                    If CLng(currentRow.Item("priorev_contact_id").ToString) > 0 Then
                        sQuery.Append("SELECT DISTINCT Company.*, contact_id, state_name FROM Priority_Events, Contact, Company")
                        sQuery.Append(" LEFT OUTER JOIN State ON comp_state = state_code AND comp_country = state_country")
                        sQuery.Append(" WHERE (contact_id = " + currentRow.Item("priorev_contact_id").ToString + " AND contact_journ_id = " + currentRow.Item("priorev_journ_id").ToString)
                        sQuery.Append(" AND comp_id = contact_comp_id AND priorev_comp_id = comp_id")
                    Else
                        sQuery.Append("SELECT DISTINCT Company.*, state_name FROM Priority_Events, Company")
                        sQuery.Append(" LEFT OUTER JOIN State ON comp_state = state_code AND comp_country = state_country")
                        sQuery.Append(" WHERE (comp_id = " + currentRow.Item("priorev_comp_id").ToString + " AND priorev_comp_id = comp_id")
                    End If

                    sQuery.Append(" AND comp_journ_id = 0 AND comp_active_flag = 'Y' AND comp_hide_flag = 'N')")

                    HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />get_references_21(ByRef currentRow As DataRow, ByRef sCompanyInfo As String, ByRef sCompanyPhoneInfo As String, ByRef sContactInfo As String, ByRef sContactPhoneInfo As String)<br />" + sQuery.ToString
                    SqlCommand.CommandText = sQuery.ToString
                    adoRS_ref_21 = SqlCommand.ExecuteReader()

                    Try
                        references_21_datatable.Load(adoRS_ref_21)
                    Catch constrExc As System.Data.ConstraintException
                        Dim rowsErr As System.Data.DataRow() = references_21_datatable.GetErrors()
                    End Try

                    adoRS_ref_21.Close()
                    adoRS_ref_21 = Nothing

                    If references_21_datatable.Rows.Count > 0 Then

                        For Each Row As DataRow In references_21_datatable.Rows

                            ReturnCompanyInformation_Report(CLng(currentRow.Item("priorev_comp_id").ToString), CLng(currentRow.Item("priorev_journ_id").ToString), Row, sCompanyPhoneInfo, sCompanyInfo, True)
                            ReturnContactInformation_Report(CLng(currentRow.Item("priorev_comp_id").ToString), CLng(currentRow.Item("priorev_contact_id").ToString), CLng(currentRow.Item("priorev_journ_id").ToString), sContactInfo, sContactPhoneInfo)

                        Next

                    Else

                        ReturnCompanyInformation_Report(0, 0, Nothing, sCompanyPhoneInfo, sCompanyInfo, True)
                        ReturnContactInformation_Report(0, 0, 0, sContactInfo, sContactPhoneInfo)

                    End If

                Else

                    ReturnCompanyInformation_Report(0, 0, Nothing, sCompanyPhoneInfo, sCompanyInfo, True)
                    ReturnContactInformation_Report(0, 0, 0, sContactInfo, sContactPhoneInfo)

                End If

            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in get_references_21(ByRef currentRow As DataRow, ByRef sCompanyInfo As String, ByRef sCompanyPhoneInfo As String, ByRef sContactInfo As String, ByRef sContactPhoneInfo As String)" + ex.Message
        Finally

            references_21_datatable = Nothing

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

    End Sub

#End Region

#Region "report_22_functions"

#End Region

#Region "report_23_functions"

    Public Function create_report_23_company_contact_labels(ByRef record_count As Long) As String

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim report_23_datatable As New DataTable

        Dim adoRS_23 As System.Data.SqlClient.SqlDataReader : adoRS_23 = Nothing

        Dim htmlOut = New StringBuilder()
        Dim sQuery As New StringBuilder()

        Dim nArrCompanyCount As Long = 0
        Dim arrCompInfo_23() As String = Nothing

        Try

            SqlConn.ConnectionString = localFunctions.clientConnectStr

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 90

            If HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("comp_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("contact_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("state_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("country_") Then
                sQuery.Append("SELECT DISTINCT * FROM View_Aircraft_Company_Flat WITH(NOLOCK) ")
            Else
                sQuery.Append("SELECT DISTINCT * FROM View_Aircraft_Flat WITH(NOLOCK) ")
            End If

            sQuery.Append(HttpContext.Current.Session.Item("MasterAircraftWhere").ToString)
            sQuery.Append(" ORDER BY amod_make_name, amod_airframe_type_code, amod_type_code, amod_id, amod_model_name, ac_ser_no_sort")

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />create_report_23_company_contact_labels()<br />" + sQuery.ToString

            If bHtmlReport Then
                htmlOut.Append("<!DOCTYPE html>")
                htmlOut.Append("<html lang='en'>")
                htmlOut.Append("<head>")
                htmlOut.Append("<meta http-equiv='Content-Language' content='en-us' />")
                htmlOut.Append("<meta http-equiv='Content-Type' content='text/html; charset=windows-1252' />")
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='common/jetnet.css' />")
                htmlOut.Append("<title>JETNET - Company Contact Labels Report</title>")
                htmlOut.Append("</head>")
                htmlOut.Append("<body style='background: white; margin-top:10px; margin-left:10px;'>")
                htmlOut.Append("<div style='text-align:center;'>")
            End If

            If bExcelReport Then
                htmlOut.Append("<table border='1' cellpadding='2' cellspacing='0'>")
            ElseIf bHtmlReport Then
                htmlOut.Append("<table class='centerTable' border='0' cellpadding='2' cellspacing='0' width='100%'>")
            End If

            SqlCommand.CommandText = sQuery.ToString
            adoRS_23 = SqlCommand.ExecuteReader()

            Try
                report_23_datatable.Load(adoRS_23)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = report_23_datatable.GetErrors()
            End Try

            record_count = report_23_datatable.Rows.Count

            adoRS_23.Close()
            adoRS_23 = Nothing

            If report_23_datatable.Rows.Count > 0 Then

                If chkShowReportHeader.Checked Then

                    If bExcelReport Or bHtmlReport Then

                        htmlOut.Append("<tr bgcolor='#CCCCCC'>")

                        htmlOut.Append("<td>COMPNAME</td>")
                        htmlOut.Append("<td>COMPALTNAME</td>")
                        htmlOut.Append("<td>COMPEMAIL</td>")
                        htmlOut.Append("<td>COMPWEBADDRESS</td>")
                        htmlOut.Append("<td>ADDRESS1</td>")
                        htmlOut.Append("<td>ADDRESS2</td>")
                        htmlOut.Append("<td>CITY</td>")
                        htmlOut.Append("<td>STATE</td>")
                        htmlOut.Append("<td>STATEABBR</td>")
                        htmlOut.Append("<td>POSTALCODE</td>")
                        htmlOut.Append("<td>COUNTRY</td>")
                        htmlOut.Append("<td>COMPOFFICE</td>")
                        htmlOut.Append("<td>COMPFAX</td>")
                        htmlOut.Append("<td>COMPMOBILE</td>")

                        If chkIncludeContacts.Checked Or chkIncludeAllContacts.Checked Then

                            htmlOut.Append("<td>SALUTATION</td>")
                            htmlOut.Append("<td>FIRSTNAME</td>")
                            htmlOut.Append("<td>MIDDLE</td>")
                            htmlOut.Append("<td>LASTNAME</td>")
                            htmlOut.Append("<td>SUFFIX</td>")
                            htmlOut.Append("<td>TITLE</td>")          ' 01/13/2003 - By David D. Cruger; Added Contact Title
                            htmlOut.Append("<td>CONTACTEMAIL</td>")   ' 01/29/2003 - By David D. Cruger; Added Contact EMail

                            htmlOut.Append("<td>CONTACTOFFICE</td>")
                            htmlOut.Append("<td>CONTACTFAX</td>")
                            htmlOut.Append("<td>CONTACTMOBILE</td>")

                        End If ' If Request("chkIncludeContacts") = "Yes" Then

                        htmlOut.Append("</tr>")

                    ElseIf bTextCommaReport Then

                        htmlOut.Append(Constants.QUOTE + "COMPNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPALTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPEMAIL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPWEBADDRESS" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "ADDRESS1" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "ADDRESS2" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CITY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "STATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "STATEABBR" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "POSTALCODE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COUNTRY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPOFFICE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPFAX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPMOBILE" + Constants.QUOTE)

                        If chkIncludeContacts.Checked Or chkIncludeAllContacts.Checked Then

                            htmlOut.Append(Constants.cCommaDelim + Constants.QUOTE + "SALUTATION" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "FIRSTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "MIDDLE" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "LASTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "SUFFIX" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "TITLE" + Constants.QUOTE + Constants.cCommaDelim)          ' 01/13/2003 - By David D. Cruger; Added Contact Title
                            htmlOut.Append(Constants.QUOTE + "CONTACTEMAIL" + Constants.QUOTE + Constants.cCommaDelim)   ' 01/29/2003 - By David D. Cruger; Added Contact EMail

                            htmlOut.Append(Constants.QUOTE + "CONTACTOFFICE" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "CONTACTFAX" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "CONTACTMOBILE" + Constants.QUOTE)

                        End If ' If Request("chkIncludeContacts") = "Yes" Then

                        htmlOut.Append(vbCrLf)

                    ElseIf bTextTabReport Then

                        htmlOut.Append("COMPNAME" + vbTab)
                        htmlOut.Append("COMPALTNAME" + vbTab)
                        htmlOut.Append("COMPEMAIL" + vbTab)
                        htmlOut.Append("COMPWEBADDRESS" + vbTab)
                        htmlOut.Append("ADDRESS1" + vbTab)
                        htmlOut.Append("ADDRESS2" + vbTab)
                        htmlOut.Append("CITY" + vbTab)
                        htmlOut.Append("STATE" + vbTab)
                        htmlOut.Append("STATEABBR" + vbTab)
                        htmlOut.Append("POSTALCODE" + vbTab)
                        htmlOut.Append("COUNTRY" + vbTab)
                        htmlOut.Append("COMPOFFICE" + vbTab)
                        htmlOut.Append("COMPFAX" + vbTab)
                        htmlOut.Append("COMPMOBILE")

                        If chkIncludeContacts.Checked Or chkIncludeAllContacts.Checked Then

                            htmlOut.Append(vbTab + "SALUTATION" + vbTab)
                            htmlOut.Append("FIRSTNAME" + vbTab)
                            htmlOut.Append("MIDDLE" + vbTab)
                            htmlOut.Append("LASTNAME" + vbTab)
                            htmlOut.Append("SUFFIX" + vbTab)
                            htmlOut.Append("TITLE" + vbTab)   ' 01/13/2003 - By David D. Cruger; Added Contact Title
                            htmlOut.Append("CONTACTEMAIL" + vbTab)   ' 01/29/2003 - By David D. Cruger; Added Contact EMail

                            htmlOut.Append("CONTACTOFFICE" + vbTab)
                            htmlOut.Append("CONTACTFAX" + vbTab)
                            htmlOut.Append("CONTACTMOBILE")

                        End If 'vbTab

                        htmlOut.Append(vbCrLf)

                    End If   ' ElseIf request("optFormat") = "Text (Tab Delimited)" Then

                End If ' chkShowReportHeader.Checked Then

                For Each Row As DataRow In report_23_datatable.Rows

                    htmlOut.Append(get_references23(Row, arrCompInfo_23, nArrCompanyCount))

                Next

                If bHtmlReport Or bExcelReport Then
                    htmlOut.Append("</table>")
                End If

                If bHtmlReport Then
                    htmlOut.Append("</div>")
                    htmlOut.Append("</body>")
                    htmlOut.Append("</html>")
                End If

            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Create_Report_23_Company_Contact_Labels()" + ex.Message
        Finally
            adoRS_23 = Nothing

            report_23_datatable = Nothing

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOut.ToString

    End Function

    Public Function get_references23(ByVal currentRow As DataRow, ByRef arrCompInfo_23() As String, ByRef nArrCompanyCount As Long) As String

        Dim htmlOut = New StringBuilder()
        Dim sQuery = New StringBuilder()

        Dim CompInfo As String = ""
        Dim CompPhoneInfo As String = ""
        Dim ContactInfo As String = ""
        Dim ContactPhoneInfo As String = ""

        Dim strFractionCondition As String = ""
        Dim strFractionValue As String = ""

        Dim strContactTitleGroup As String = ""
        Dim strBusinessType As String = ""

        Dim tmpCompID As String = ""

        Dim nCompanyID As Long = 0
        Dim nContactID As Long = 0

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim report_23_ref_datatable As New DataTable

        Dim adoRS_23_ref As System.Data.SqlClient.SqlDataReader : adoRS_23_ref = Nothing

        Dim tmpCompContactString As String = ""

        Try

            If Not IsNothing(HttpContext.Current.Session.Item("searchCriteria").SearchCriteriaCompanyContactTitle) Then
                strContactTitleGroup = HttpContext.Current.Session.Item("searchCriteria").SearchCriteriaCompanyContactTitle.ToString
            End If

            If Not IsNothing(HttpContext.Current.Session.Item("searchCriteria").SearchCriteriaCompanyBusinessType) Then
                strBusinessType = HttpContext.Current.Session.Item("searchCriteria").SearchCriteriaCompanyBusinessType.ToString
            End If

            sQuery.Append("SELECT DISTINCT cref_contact_type, cref_contact_id, cref_comp_id, cref_transmit_seq_no, comp_name, comp_id,")
            sQuery.Append("comp_journ_id, comp_name_alt_type, comp_name_alt, comp_city, comp_state, comp_zip_code, actype_name,")
            sQuery.Append("comp_email_address, comp_web_address, comp_address1, comp_address2, comp_country, state_name")

            If Not String.IsNullOrEmpty(strContactTitleGroup.Trim) Then
                sQuery.Append(", contact_title")
            End If

            sQuery.Append(" FROM Aircraft_Reference WITH(NOLOCK) INNER JOIN Company WITH(NOLOCK) ON (cref_comp_id = comp_id and cref_journ_id = comp_journ_id)")
            sQuery.Append(" INNER JOIN Aircraft_Contact_Type WITH(NOLOCK) ON (cref_contact_type = actype_code)")
            sQuery.Append(" LEFT OUTER JOIN State WITH(NOLOCK) ON (comp_state = state_code AND comp_country = state_country)")

            If Not String.IsNullOrEmpty(strContactTitleGroup.Trim) Then
                sQuery.Append(" LEFT OUTER JOIN Contact WITH(NOLOCK) ON (cref_comp_id = contact_comp_id AND cref_journ_id = contact_journ_id)")
            End If

            If Not String.IsNullOrEmpty(strBusinessType.Trim) Then
                sQuery.Append(" LEFT OUTER JOIN Business_Type_Reference WITH(NOLOCK) ON (bustypref_comp_id = comp_id AND bustypref_journ_id = comp_journ_id)")
            End If

            sQuery.Append(" WHERE (cref_ac_id = " + currentRow.Item("ac_id").ToString + " AND cref_journ_id = 0")
            sQuery.Append(" AND comp_active_flag = 'Y' AND comp_hide_flag = 'N')")

            If Not String.IsNullOrEmpty(strContactTitleGroup.Trim) Then
                sQuery.Append(" AND (contact_active_flag = 'Y' OR contact_active_flag IS NULL)")
                sQuery.Append(" AND (contact_hide_flag = 'N' OR contact_hide_flag IS NULL)")
            End If

            ' Hide Exclusive Brokers and Representatives and Dealers from Aerodex users
            If bAerodexFlag Then
                sQuery.Append(" AND cref_contact_type NOT IN ('93','98','99','66','67','68','71')")
            Else
                sQuery.Append(" AND cref_contact_type NOT IN ('66','67','68','71')")
            End If

            sQuery.Append(" ORDER BY cref_transmit_seq_no")

            'HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />GetReferences_23(ByRef currentRow As DataRow) As String<br />" + sQuery.ToString

            Try


                SqlConn.ConnectionString = localFunctions.clientConnectStr

                SqlConn.Open()

                SqlCommand.Connection = SqlConn
                SqlCommand.CommandType = System.Data.CommandType.Text
                SqlCommand.CommandTimeout = 90

                SqlCommand.CommandText = sQuery.ToString
                adoRS_23_ref = SqlCommand.ExecuteReader()

                Try
                    report_23_ref_datatable.Load(adoRS_23_ref)
                Catch constrExc As System.Data.ConstraintException
                    Dim rowsErr As System.Data.DataRow() = report_23_ref_datatable.GetErrors()
                End Try

                adoRS_23_ref.Close()
                adoRS_23_ref = Nothing

                If report_23_ref_datatable.Rows.Count > 0 Then

                    If chkIncludeAllContacts.Checked Then

                        For Each Row As DataRow In report_23_ref_datatable.Rows

                            If Not IsDBNull(Row.Item("comp_id")) Then
                                If Not String.IsNullOrEmpty(Row.Item("comp_id").ToString.Trim) Then
                                    If String.IsNullOrEmpty(tmpCompID.Trim) Then
                                        tmpCompID = Row.Item("comp_id").ToString.Trim
                                    Else
                                        tmpCompID += Constants.cCommaDelim + Row.Item("comp_id").ToString.Trim
                                    End If
                                End If
                            End If

                        Next

                        sQuery = New StringBuilder()

                        sQuery.Append("SELECT DISTINCT contact_id, comp_id, comp_journ_id, comp_name, comp_name_alt_type, comp_name_alt, comp_city, comp_state, comp_zip_code, comp_email_address, comp_web_address, comp_address1, comp_address2, comp_country, state_name")
                        sQuery.Append(" FROM Contact WITH(NOLOCK) INNER JOIN Company WITH(NOLOCK) ON (contact_comp_id = comp_id AND contact_journ_id = comp_journ_id)  INNER JOIN Aircraft_Reference WITH(NOLOCK) ON (comp_id = cref_comp_id and comp_journ_id = cref_journ_id)")
                        sQuery.Append(" INNER JOIN Aircraft_Contact_Type WITH(NOLOCK) ON (cref_contact_type = actype_code)  LEFT OUTER JOIN State WITH(NOLOCK) ON (comp_state = state_code AND comp_country = state_country)")
                        sQuery.Append(" WHERE cref_ac_id = " + currentRow.Item("ac_id").ToString + " AND comp_id IN (" + tmpCompID + ") AND comp_journ_id = 0  AND (contact_active_flag = 'Y' OR contact_active_flag IS NULL)")
                        sQuery.Append(" AND (contact_hide_flag = 'N' OR contact_hide_flag IS NULL)  " + commonEvo.MakeCompanyProductCodeClause(HttpContext.Current.Session.Item("localPreferences"), False))
                        sQuery.Append(" ORDER BY comp_name")

                        'HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />GetReferences_23(ByRef currentRow As DataRow) As String<br />" + sQuery.ToString

                        ' clean up previous results
                        report_23_ref_datatable = New DataTable

                        SqlCommand.CommandText = sQuery.ToString
                        adoRS_23_ref = SqlCommand.ExecuteReader()

                        Try
                            report_23_ref_datatable.Load(adoRS_23_ref)
                        Catch constrExc As System.Data.ConstraintException
                            Dim rowsErr As System.Data.DataRow() = report_23_ref_datatable.GetErrors()
                        End Try

                        adoRS_23_ref.Close()
                        adoRS_23_ref = Nothing

                    End If ' chkIncludeAllContacts.Checked   

                    If report_23_ref_datatable.Rows.Count > 0 Then

                        For Each Row As DataRow In report_23_ref_datatable.Rows

                            If Not chkIncludeAllContacts.Checked Then
                                nCompanyID = CLng(Row.Item("cref_comp_id").ToString)
                            Else
                                nCompanyID = CLng(Row.Item("comp_id").ToString)
                            End If

                            If Not chkIncludeAllContacts.Checked Then
                                nContactID = CLng(Row.Item("cref_contact_id").ToString)
                            Else
                                nContactID = CLng(Row.Item("contact_id").ToString)
                            End If

                            If Not chkIncludeContacts.Checked And Not chkIncludeAllContacts.Checked Then
                                nContactID = 0 ' No Contacts
                            End If

                            tmpCompContactString = nCompanyID.ToString + Constants.cImbedComa + nContactID.ToString

                            ' Check to see if CompId_Contact Id Already In Array
                            If Not commonEvo.inMyArray(arrCompInfo_23, tmpCompContactString) Then

                                If Not IsArray(arrCompInfo_23) And IsNothing(arrCompInfo_23) Then
                                    ReDim arrCompInfo_23(nArrCompanyCount)
                                Else
                                    ReDim Preserve arrCompInfo_23(nArrCompanyCount)
                                End If

                                ' Add CompId_ContactId To Array
                                arrCompInfo_23(nArrCompanyCount) = tmpCompContactString
                                nArrCompanyCount += 1

                                ReturnCompanyInformation_Report(nCompanyID, 0, Row, CompPhoneInfo, CompInfo, chkIncludeContacts.Checked)

                                If chkIncludeContacts.Checked Or chkIncludeAllContacts.Checked Then

                                    ReturnContactInformation_Report(nCompanyID, nContactID, 0, ContactInfo, ContactPhoneInfo)

                                    If bHtmlReport Or bExcelReport Then
                                        htmlOut.Append("<tr>" + CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo + "</tr>")
                                    ElseIf bTextCommaReport Or bTextTabReport Then
                                        htmlOut.Append(CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo + vbCrLf)
                                    End If

                                Else

                                    If bHtmlReport Or bExcelReport Then
                                        htmlOut.Append("<tr>" + CompInfo + CompPhoneInfo + "</tr>")
                                    ElseIf bTextCommaReport Or bTextTabReport Then
                                        htmlOut.Append(CompInfo + CompPhoneInfo + vbCrLf)
                                    End If

                                End If

                            End If ' Not commonEvo.inMyArray(arrCompInfo_23, nCompanyID.ToString + Constants.cImbedComa + nContactID.ToString) then

                            CompInfo = ""
                            CompPhoneInfo = ""
                            ContactInfo = ""
                            ContactPhoneInfo = ""

                        Next

                    End If ' report_23_ref_datatable.Rows.Count > 0 

                End If ' report_23_ref_datatable.Rows.Count > 0 

            Catch ex As Exception

                HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in GetReferences_23(ByRef currentRow As DataRow) As String" + ex.Message

            End Try

        Catch ex As Exception
        Finally
            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing
        End Try

        Return htmlOut.ToString

    End Function

#End Region

#Region "report_24_25_functions"

    Public Function create_report_24_aircraft_identifying_information_and_contact_information(ByRef record_count As Long) As String

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim report_24_datatable As New DataTable

        Dim adoRS_24 As System.Data.SqlClient.SqlDataReader : adoRS_24 = Nothing

        Dim htmlOut = New StringBuilder()
        Dim sQuery As New StringBuilder()

        Dim nRememberAcID As Long = 0
        Dim nCount As Long = 0

        Try

            SqlConn.ConnectionString = localFunctions.clientConnectStr

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 90

            If HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("comp_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("contact_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("state_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("country_") Then
                sQuery.Append("SELECT DISTINCT * FROM View_Aircraft_Company_Flat WITH(NOLOCK)")
            Else
                sQuery.Append("SELECT DISTINCT * FROM View_Aircraft_Flat WITH(NOLOCK)")
            End If

            sQuery.Append(Constants.cSingleSpace + HttpContext.Current.Session.Item("MasterAircraftWhere").ToString)

            If String.IsNullOrEmpty(HttpContext.Current.Session.Item("MasterAircraftSort")) Then
                sQuery.Append(Constants.cSingleSpace + "ORDER BY amod_make_name, amod_airframe_type_code, amod_type_code, amod_id, amod_model_name, ac_ser_no_sort")
            Else
                sQuery.Append(Constants.cSingleSpace + HttpContext.Current.Session.Item("MasterAircraftSort").ToString)
            End If

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />create_report_24_aircraft_identifying_information_and_contact_information()<br />" + sQuery.ToString

            If bHtmlReport Or bPdfReport Then
                htmlOut.Append("<!DOCTYPE html>")
                htmlOut.Append("<html lang='en'>")
                htmlOut.Append("<head>")
                htmlOut.Append("<meta http-equiv='Content-Language' content='en-us' />")
                htmlOut.Append("<meta http-equiv='Content-Type' content='text/html; charset=windows-1252' />")
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='common/jetnet.css' />")
                htmlOut.Append("<title>JETNET - Identifying Information and Contact Information</title>")

                If bPdfReport Then
                    htmlOut.Append(" <style type='text/css'>")
                    htmlOut.Append("   body { margin-top:0px; margin-left:0px; margin-right:0px; margin-bottom:0px; font-family:Tahoma; font-size:11px; background-color:#ffffff; }" + vbCrLf)
                    htmlOut.Append("   table.break { page-break-before: always; }" + vbCrLf)
                    htmlOut.Append("   table.centerTable { margin-right: auto; margin-left: auto; }" + vbCrLf)
                    htmlOut.Append(" </style>")
                    htmlOut.Append("</head>")

                    htmlOut.Append("<body>")

                Else

                    htmlOut.Append("</head>")
                    htmlOut.Append("<body style='background: white; margin-top:10px; margin-left:10px; font-size: 10pt;'>")

                End If

                htmlOut.Append("<div style='text-align:center;'><br />")

            End If

            If bExcelReport Then
                htmlOut.Append("<table border='1' cellpadding='2' cellspacing='0'><tr><td>")
            ElseIf bHtmlReport Or bPdfReport Then
                htmlOut.Append("<table class='centerTable' border='0' cellpadding='2' cellspacing='0' width='100%'><tr><td align='left' valign='middle'>")
            End If

            SqlCommand.CommandText = sQuery.ToString
            adoRS_24 = SqlCommand.ExecuteReader()

            Try
                report_24_datatable.Load(adoRS_24)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = report_24_datatable.GetErrors()
            End Try

            record_count = report_24_datatable.Rows.Count

            adoRS_24.Close()
            adoRS_24 = Nothing

            If report_24_datatable.Rows.Count > 0 Then

                For Each Row As DataRow In report_24_datatable.Rows

                    If CLng(Row.Item("ac_id").ToString) <> nRememberAcID Then

                        nRememberAcID = CLng(Row.Item("ac_id").ToString)

                        If bPdfReport Then
                            nCount += 1
                            htmlOut.Append("<div style='text-align:right; padding-right:18px; padding-bottom:5px;' width='95%'>Page " + nCount.ToString + "</div>")
                        End If

                        htmlOut.Append("<table class='centerTable' border='0' cellpadding='2' cellspacing='0' width='95%'><tr><td align='left' valign='middle'>")

                        htmlOut.Append(Display_AircraftDetailsBlock_Report(Row, Nothing, False, False))
                        htmlOut.Append(GetCompanies_DisplayAircraftDetails_Report(CLng(Row.Item("ac_id").ToString), 0, False))

                        If bHtmlReport Then
                            htmlOut.Append("<br /><hr width='100%'></td></tr></table><br />")
                        ElseIf bWordReport Then
                            htmlOut.Append("</td></tr></table><br style='page-break-before: always'>")
                        ElseIf bPdfReport Then
                            htmlOut.Append("</td></tr></table><br /><table class='centerTable break' border='0' cellpadding='2' cellspacing='0' width='95%'><tr><td>&nbsp;</td></tr></table><br />")
                        Else
                            htmlOut.Append("</td></tr></table>")
                        End If

                    End If

                Next

                htmlOut.Append("</td></tr></table>")

                If bHtmlReport Or bPdfReport Then
                    htmlOut.Append("</div>")
                    htmlOut.Append("</body>")
                    htmlOut.Append("</html>")
                End If

            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in create_report_24_aircraft_identifying_information_and_contact_information()" + ex.Message
        Finally
            adoRS_24 = Nothing

            report_24_datatable = Nothing

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOut.ToString

    End Function

    Public Function create_report_25_aircraft_identifying_information_and_contact_information_history(ByRef record_count As Long) As String

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim report_25_datatable As New DataTable

        Dim adoRS_25 As System.Data.SqlClient.SqlDataReader : adoRS_25 = Nothing

        Dim htmlOut = New StringBuilder()
        Dim sQuery As New StringBuilder()

        Dim nRememberAcID As Long = 0
        Dim nCount As Long = 0

        Try

            SqlConn.ConnectionString = localFunctions.clientConnectStr

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 90

            If HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("comp_") Or
       HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("contact_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("state_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("country_") Then
                sQuery.Append("SELECT DISTINCT * FROM View_Aircraft_Company_History_Flat WITH(NOLOCK)")
            Else
                sQuery.Append("SELECT DISTINCT * FROM View_Aircraft_History_Flat WITH(NOLOCK)")
            End If

            sQuery.Append(Constants.cSingleSpace + HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.Trim)
            If String.IsNullOrEmpty(HttpContext.Current.Session.Item("MasterAircraftSort")) Then
                sQuery.Append(Constants.cSingleSpace + "ORDER BY ac_ser_no_sort, journ_date DESC, journ_id DESC")
            Else
                sQuery.Append(Constants.cSingleSpace + HttpContext.Current.Session.Item("MasterAircraftSort").ToString)
            End If

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />create_report_25_aircraft_identifying_information_and_contact_information_history()<br />" + sQuery.ToString

            If bHtmlReport Or bPdfReport Then
                htmlOut.Append("<!DOCTYPE html>")
                htmlOut.Append("<html lang='en'>")
                htmlOut.Append("<head>")
                htmlOut.Append("<meta http-equiv='Content-Language' content='en-us' />")
                htmlOut.Append("<meta http-equiv='Content-Type' content='text/html; charset=windows-1252' />")
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='common/jetnet.css' />")
                htmlOut.Append("<title>JETNET - Identifying Information and Contact Information</title>")

                If bPdfReport Then
                    htmlOut.Append(" <style type='text/css'>")
                    htmlOut.Append("   body { margin-top:0px; margin-left:0px; margin-right:0px; margin-bottom:0px; font-family:Tahoma; font-size:11px; background-color:#ffffff; }" + vbCrLf)
                    htmlOut.Append("   table.break { page-break-before: always; }" + vbCrLf)
                    htmlOut.Append("   table.centerTable { margin-right: auto; margin-left: auto; }" + vbCrLf)
                    htmlOut.Append(" </style>")
                    htmlOut.Append("</head>")

                    htmlOut.Append("<body>")

                Else

                    htmlOut.Append("</head>")
                    htmlOut.Append("<body style='background: white; margin-top:10px; margin-left:10px; font-size: 10pt;'>")

                End If

                htmlOut.Append("<div style='text-align:center;'><br />")

            End If

            If bExcelReport Then
                htmlOut.Append("<table border='1' cellpadding='2' cellspacing='0'><tr><td>")
            ElseIf bHtmlReport Or bPdfReport Then
                htmlOut.Append("<table class='centerTable' border='0' cellpadding='2' cellspacing='0' width='100%'><tr><td align='left' valign='middle'>")
            End If

            SqlCommand.CommandText = sQuery.ToString
            adoRS_25 = SqlCommand.ExecuteReader()

            Try
                report_25_datatable.Load(adoRS_25)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = report_25_datatable.GetErrors()
            End Try

            record_count = report_25_datatable.Rows.Count

            adoRS_25.Close()
            adoRS_25 = Nothing

            If report_25_datatable.Rows.Count > 0 Then

                For Each Row As DataRow In report_25_datatable.Rows

                    If CLng(Row.Item("ac_id").ToString) <> nRememberAcID Then

                        nRememberAcID = CLng(Row.Item("ac_id").ToString)

                        If bPdfReport Then
                            nCount += 1
                            htmlOut.Append("<div style='text-align:right; padding-right:18px; padding-bottom:5px;' width='95%'>Page " + nCount.ToString + "</div>")
                        End If

                        htmlOut.Append("<table class='centerTable' border='0' cellpadding='2' cellspacing='0' width='95%'><tr><td align='left' valign='middle'>")

                        htmlOut.Append(Display_AircraftDetailsBlock_Report(Row, Row, False, False))
                        htmlOut.Append(GetCompanies_DisplayAircraftDetails_Report(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id").ToString), False))

                        If bHtmlReport Then
                            htmlOut.Append("<br /><hr width='100%'></td></tr></table><br />")
                        ElseIf bWordReport Then
                            htmlOut.Append("</td></tr></table><br style='page-break-before: always'>")
                        ElseIf bPdfReport Then
                            htmlOut.Append("</td></tr></table><br /><table class='break' border='0' cellpadding='2' cellspacing='0' width='95%'><tr><td>&nbsp;</td></tr></table><br />")
                        Else
                            htmlOut.Append("</td></tr></table>")
                        End If

                    End If

                Next

                htmlOut.Append("</td></tr></table>")

                If bHtmlReport Or bPdfReport Then
                    htmlOut.Append("</div>")
                    htmlOut.Append("</body>")
                    htmlOut.Append("</html>")
                End If

            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in create_report_25_aircraft_identifying_information_and_contact_information_history()" + ex.Message
        Finally
            adoRS_25 = Nothing

            report_25_datatable = Nothing

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOut.ToString

    End Function

#End Region

#Region "report_27_28_functions"

    Public Function create_report_27_condensed_aircraft_listing_blind_form(ByRef record_count As Long) As String

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim report_27_datatable As New DataTable

        Dim adoRS_27 As System.Data.SqlClient.SqlDataReader : adoRS_27 = Nothing

        Dim htmlOut = New StringBuilder()
        Dim sQuery As New StringBuilder()

        Dim arrFeatCodes() As String = Nothing
        Dim arrStdFeatCodes(,) As String = Nothing

        Dim nRememberModelID As Long = 0

        Dim nTotalSpanCount As Integer = 13

        Try

            If bAerodexFlag Then
                nTotalSpanCount -= 2
            ElseIf Not chkShowAsking.Checked Then
                nTotalSpanCount -= 1
            End If

            SqlConn.ConnectionString = localFunctions.clientConnectStr

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 90

            If HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("comp_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("contact_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("state_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("country_") Then
                sQuery.Append("SELECT DISTINCT * FROM View_Aircraft_Company_Flat WITH(NOLOCK) ")
            Else
                sQuery.Append("SELECT DISTINCT * FROM View_Aircraft_Flat WITH(NOLOCK) ")
            End If

            sQuery.Append(HttpContext.Current.Session.Item("MasterAircraftWhere").ToString)
            sQuery.Append(" ORDER BY amod_make_name, amod_model_name, ac_ser_no_sort")

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />Create_Report_27_Condensed_Aircraft_Listing_Blind_Form()<br />" + sQuery.ToString

            If bHtmlReport Then
                htmlOut.Append("<!DOCTYPE html>")
                htmlOut.Append("<html lang='en'>")
                htmlOut.Append("<head>")
                htmlOut.Append("<meta http-equiv='Content-Language' content='en-us' />")
                htmlOut.Append("<meta http-equiv='Content-Type' content='text/html; charset=windows-1252' />")
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='common/jetnet.css' />")
                htmlOut.Append("<title>JETNET - Condensed Aircraft Listing (Blind Form)</title>")
                htmlOut.Append("</head>")
                htmlOut.Append("<body style='background: white; margin-top:10px; margin-left:10px;'>")
                htmlOut.Append("<div style='text-align:center;'>")
            End If

            SqlCommand.CommandText = sQuery.ToString
            adoRS_27 = SqlCommand.ExecuteReader()

            Try
                report_27_datatable.Load(adoRS_27)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = report_27_datatable.GetErrors()
            End Try

            record_count = report_27_datatable.Rows.Count

            adoRS_27.Close()
            adoRS_27 = Nothing

            If report_27_datatable.Rows.Count > 0 Then

                If bExcelReport Then
                    htmlOut.Append(localFunctions.include_excel_report_style() + vbCrLf)
                    htmlOut.Append("<table border='1' cellpadding='2' cellspacing='0'>")
                    htmlOut.Append("<tr bgcolor='#CCCCCC'><td valign='middle' align='left' colspan='5'><strong>" + FormatDateTime(Now(), DateFormat.GeneralDate).ToString + "</strong></td>")
                    htmlOut.Append("<td valign='middle' align='left' colspan='" + nTotalSpanCount.ToString + "'><strong>Condensed Aircraft Listing (Blind Form)</strong></td></tr>")
                    htmlOut.Append("<tr bgcolor='#CCCCCC'><td valign='middle' align='left' colspan='" + (nTotalSpanCount + 5).ToString + "'></td></tr>")
                ElseIf bHtmlReport Then
                    htmlOut.Append("<table class='centerTable' border='0' cellpadding='2' cellspacing='0' width='100%'>")
                    htmlOut.Append("<tr bgcolor='#CCCCCC'><td valign='middle' align='left' colspan='5'><strong>" + FormatDateTime(Now(), DateFormat.GeneralDate).ToString + "</strong></td>")
                    htmlOut.Append("<td valign='middle' align='left' colspan='" + nTotalSpanCount.ToString + "'><strong>Condensed Aircraft Listing (Blind Form)</strong></td></tr>")
                    htmlOut.Append("<tr bgcolor='#CCCCCC'><td width='100%' valign='middle' align='left' colspan='" + (nTotalSpanCount + 5).ToString + "'><hr></td></tr>")
                End If

                For Each Row As DataRow In report_27_datatable.Rows

                    If nRememberModelID <> CLng(Row.Item("amod_id").ToString) Then

                        nRememberModelID = CLng(Row.Item("amod_id").ToString)

                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='center' valign='middle' colspan='5'><strong>MAKE : " + Row.Item("amod_make_name").ToString.Trim + "</strong></td>")
                        htmlOut.Append("<td align='center' valign='middle' colspan='" + nTotalSpanCount.ToString + "'><strong>MODEL : " + Row.Item("amod_model_name").ToString.Trim + "</strong></td>")
                        htmlOut.Append("</tr>")

                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='center' valign='bottom'><strong>ID</strong></td>")

                        If chkShowAsking.Checked And Not bAerodexFlag Then
                            htmlOut.Append("<td align='center' valign='bottom'><strong>ASKING</strong></td>")
                        End If

                        If Not bAerodexFlag Then
                            htmlOut.Append("<td align='center' valign='bottom'><strong>DATE<br />LISTED</strong></td>")
                        End If

                        htmlOut.Append("<td align='center' valign='bottom' nowrap='nowrap'><strong>YEAR</strong></td>")
                        htmlOut.Append("<td align='center' valign='bottom' nowrap='nowrap'><strong>AFTT</strong></td>")
                        htmlOut.Append("<td align='center' valign='bottom' nowrap='nowrap'><strong>LANDINGS</strong></td>")
                        htmlOut.Append("<td align='center' valign='bottom' nowrap='nowrap'><strong>ENG-L</strong></td>")
                        htmlOut.Append("<td align='center' valign='bottom' nowrap='nowrap'><strong>ENG-R</strong></td>")
                        htmlOut.Append("<td align='center' valign='bottom' nowrap='nowrap'><strong>SMOH-L</strong></td>")
                        htmlOut.Append("<td align='center' valign='bottom' nowrap='nowrap'><strong>SMOH-R</strong></td>")
                        htmlOut.Append("<td align='center' valign='bottom' nowrap='nowrap'><strong>SHI-L</strong></td>")
                        htmlOut.Append("<td align='center' valign='bottom' nowrap='nowrap'><strong>SHI-R</strong></td>")

                        htmlOut.Append("<td align='center' valign='middle'><strong>FEATURES</strong><br />")

                        htmlOut.Append("<table id='featureHeadingTable' width='100%' cellpadding='1' cellspacing='0' border='0'><tr>")

                        Dim sAcFeature As String = ""

                        ' if the arrStdFeatCodes = nothing then it will return all feature codes
                        localFunctions.display_nonstandard_feature_code_headings_report(CLng(Row.Item("amod_id").ToString), arrFeatCodes, arrStdFeatCodes, sAcFeature)

                        htmlOut.Append(sAcFeature + "</tr></table>")

                        htmlOut.Append("</td>")

                        htmlOut.Append("<th align='center' valign='bottom' nowrap='nowrap'><strong>AVIONICS PACKAGE</strong></td>")
                        htmlOut.Append("<th align='center' valign='bottom'><strong>EY</strong></td>")
                        htmlOut.Append("<th align='center' valign='bottom'><strong>ER</strong></td>")
                        htmlOut.Append("<th align='center' valign='bottom'><strong>IY</strong></td>")
                        htmlOut.Append("<th align='center' valign='bottom'><strong>IR</strong></td></tr>")

                    End If ' If sRememberMakeModel <> sTmpMakeModelname Then

                    If Not IsDBNull(Row.Item("ac_id")) Then
                        htmlOut.Append("<tr><td align='center' valign='middle'>" + Row.Item("ac_id").ToString.Trim + "</td>")
                    Else
                        htmlOut.Append("<tr><td align='center' valign='middle'>0</td>")
                    End If

                    If chkShowAsking.Checked And Not bAerodexFlag Then
                        If Not IsDBNull(Row.Item("ac_asking_price")) Then
                            If Row.Item("ac_asking").ToString.ToLower.Contains("price") Then
                                If Not IsDBNull(Row.Item("ac_asking_price")) Then
                                    If CDbl(Row.Item("ac_asking_price").ToString) > 0 Then
                                        Dim nAddToAskingPrice As Double = 0
                                        If Not String.IsNullOrEmpty(addToAsking.Text.Trim) Then
                                            nAddToAskingPrice = CDbl(Replace(addToAsking.Text, Constants.cCommaDelim, Constants.cEmptyString))
                                        End If
                                        htmlOut.Append("<td align='center' valign='middle' nowrap='nowrap'>$" + FormatNumber(CDbl(Row.Item("ac_asking_price").ToString) + nAddToAskingPrice, 0, False, False, True).ToString + "</td>")
                                    Else
                                        htmlOut.Append("<td align='center' valign='middle'></td>")
                                    End If
                                Else
                                    htmlOut.Append("<td align='center' valign='middle'></td>")
                                End If
                            Else
                                If Not IsDBNull(Row.Item("ac_asking")) Then
                                    htmlOut.Append("<td align='center' valign='middle' nowrap='nowrap'>" + Row.Item("ac_asking").ToString.Trim + "</td>")
                                Else
                                    htmlOut.Append("<td align='center' valign='middle'></td>")
                                End If
                            End If
                        Else
                            If Not IsDBNull(Row.Item("ac_asking")) Then
                                htmlOut.Append("<td align='center' valign='middle' nowrap='nowrap'>" + Row.Item("ac_asking").ToString.Trim + "</td>")
                            Else
                                htmlOut.Append("<td align='center' valign='middle'></td>")
                            End If
                        End If
                    End If

                    If Not bAerodexFlag Then
                        If Not IsDBNull(Row.Item("ac_list_date")) Then
                            htmlOut.Append("<td align='center' valign='middle'>" + FormatDateTime(Row.Item("ac_list_date").ToString, DateFormat.ShortDate) + "</td>")
                        Else
                            htmlOut.Append("<td align='center' valign='middle'></td>")
                        End If
                    End If

                    If Not IsDBNull(Row.Item("ac_year")) Then
                        htmlOut.Append("<td align='right' valign='middle'>" + Row.Item("ac_year").ToString + "</td>")
                    Else
                        htmlOut.Append("<td align='right' valign='middle'></td>")
                    End If

                    If Not IsDBNull(Row.Item("ac_airframe_tot_hrs")) Then
                        htmlOut.Append("<td align='right' valign='middle'>" + Row.Item("ac_airframe_tot_hrs").ToString + "</td>")
                    Else
                        htmlOut.Append("<td align='right' valign='middle'></td>")
                    End If

                    If Not IsDBNull(Row.Item("ac_airframe_tot_landings")) Then
                        htmlOut.Append("<td align='right' valign='middle'>" + Row.Item("ac_airframe_tot_landings").ToString + "</td>")
                    Else
                        htmlOut.Append("<td align='right' valign='middle'></td>")
                    End If

                    If Not IsDBNull(Row.Item("ac_engine_1_tot_hrs")) Then
                        htmlOut.Append("<td align='right' valign='middle'>" + Row.Item("ac_engine_1_tot_hrs").ToString + "</td>")
                    Else
                        htmlOut.Append("<td align='right' valign='middle'></td>")
                    End If

                    If Not IsDBNull(Row.Item("ac_engine_2_tot_hrs")) Then
                        htmlOut.Append("<td align='right' valign='middle'>" + Row.Item("ac_engine_2_tot_hrs").ToString + "</td>")
                    Else
                        htmlOut.Append("<td align='right' valign='middle'></td>")
                    End If

                    If Not IsDBNull(Row.Item("ac_engine_1_soh_hrs")) Then
                        htmlOut.Append("<td align='right' valign='middle'>" + Row.Item("ac_engine_1_soh_hrs").ToString + "</td>")
                    Else
                        htmlOut.Append("<td align='right' valign='middle'></td>")
                    End If

                    If Not IsDBNull(Row.Item("ac_engine_2_soh_hrs")) Then
                        htmlOut.Append("<td align='right' valign='middle'>" + Row.Item("ac_engine_2_soh_hrs").ToString + "</td>")
                    Else
                        htmlOut.Append("<td align='right' valign='middle'></td>")
                    End If

                    If Not IsDBNull(Row.Item("ac_engine_1_shi_hrs")) Then
                        htmlOut.Append("<td align='right' valign='middle'>" + Row.Item("ac_engine_1_shi_hrs").ToString + "</td>")
                    Else
                        htmlOut.Append("<td align='right' valign='middle'></td>")
                    End If

                    If Not IsDBNull(Row.Item("ac_engine_2_shi_hrs")) Then
                        htmlOut.Append("<td align='right' valign='middle'>" + Row.Item("ac_engine_2_shi_hrs").ToString + "</td>")
                    Else
                        htmlOut.Append("<td align='right' valign='middle'></td>")
                    End If

                    htmlOut.Append("<td align='center' valign='middle'>")

                    Dim sAcFeatureCodes As String = ""
                    localFunctions.display_ac_feature_codes_report(CLng(Row.Item("ac_id").ToString), 0, arrFeatCodes, sAcFeatureCodes)
                    htmlOut.Append(sAcFeatureCodes)

                    htmlOut.Append("</td>")

                    htmlOut.Append("<td align='left' valign='middle' nowrap='nowrap'>" + localFunctions.get_avionics_package_report(CLng(Row.Item("ac_id").ToString), 0, True) + "</td>")

                    If Not IsDBNull(Row.Item("ac_exterior_moyear")) Then
                        htmlOut.Append("<td align='right' valign='middle'>" + Right(Row.Item("ac_exterior_moyear").ToString, 4) + "</td>")
                    Else
                        htmlOut.Append("<td align='right' valign='middle'></td>")
                    End If

                    If Not IsDBNull(Row.Item("ac_exterior_rating")) Then
                        htmlOut.Append("<td align='right' valign='middle'>" + Row.Item("ac_exterior_rating").ToString + "</td>")
                    Else
                        htmlOut.Append("<td align='right' valign='middle'></td>")
                    End If

                    If Not IsDBNull(Row.Item("ac_interior_moyear")) Then
                        htmlOut.Append("<td align='right' valign='middle'>" + Right(Row.Item("ac_interior_moyear").ToString, 4) + "</td>")
                    Else
                        htmlOut.Append("<td align='right' valign='middle'></td>")
                    End If

                    If Not IsDBNull(Row.Item("ac_interior_rating")) Then
                        htmlOut.Append("<td align='right' valign='middle'>" + Row.Item("ac_interior_rating").ToString + "</td>")
                    Else
                        htmlOut.Append("<td align='right' valign='middle'></td>")
                    End If

                    htmlOut.Append("</tr>")

                Next

                If bHtmlReport Or bExcelReport Then
                    htmlOut.Append("</table>")
                End If

                If bHtmlReport Then
                    htmlOut.Append("</div>")
                    htmlOut.Append("</body>")
                    htmlOut.Append("</html>")
                End If

            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Create_Report_27_Condensed_Aircraft_Listing_Blind_Form()" + ex.Message
        Finally
            adoRS_27 = Nothing

            report_27_datatable = Nothing

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOut.ToString

    End Function

    Public Function create_report_28_condensed_aircraft_listing(ByRef record_count As Long) As String

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim report_28_datatable As New DataTable

        Dim adoRS_28 As System.Data.SqlClient.SqlDataReader : adoRS_28 = Nothing

        Dim htmlOut = New StringBuilder()
        Dim sQuery As New StringBuilder()

        Dim arrFeatCodes() As String = Nothing
        Dim arrStdFeatCodes(,) As String = Nothing

        Dim nRememberModelID As Long = 0

        Dim nTotalSpanCount As Integer = 11

        Try

            If bAerodexFlag Then
                nTotalSpanCount -= 2
            ElseIf Not chkShowAsking.Checked Then
                nTotalSpanCount -= 1
            End If

            SqlConn.ConnectionString = localFunctions.clientConnectStr

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 90


            'ac_country_continent_name ' changed to comp_country or space contry so that hopefully it works - MSW 6/26/17
            If HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("comp_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("contact_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("state_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("comp_country_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains(" country_") Then
                sQuery.Append("SELECT DISTINCT * FROM View_Aircraft_Company_Flat WITH(NOLOCK) ")
            Else
                sQuery.Append("SELECT DISTINCT * FROM View_Aircraft_Flat WITH(NOLOCK) ")
            End If

            sQuery.Append(HttpContext.Current.Session.Item("MasterAircraftWhere").ToString)
            sQuery.Append(" ORDER BY amod_make_name, amod_model_name, ac_ser_no_sort")

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />Create_Report_28_Condensed_Aircraft_Listing()<br />" + sQuery.ToString

            If bHtmlReport Then
                htmlOut.Append("<!DOCTYPE html>")
                htmlOut.Append("<html lang='en'>")
                htmlOut.Append("<head>")
                htmlOut.Append("<meta http-equiv='Content-Language' content='en-us' />")
                htmlOut.Append("<meta http-equiv='Content-Type' content='text/html; charset=windows-1252' />")
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='common/jetnet.css' />")
                htmlOut.Append("<title>JETNET - Condensed Aircraft Listing</title>")
                htmlOut.Append("</head>")
                htmlOut.Append("<body style='background: white; margin-top:10px; margin-left:10px;'>")
                htmlOut.Append("<div style='text-align:center;'>")
            End If

            SqlCommand.CommandText = sQuery.ToString
            adoRS_28 = SqlCommand.ExecuteReader()

            Try
                report_28_datatable.Load(adoRS_28)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = report_28_datatable.GetErrors()
            End Try

            record_count = report_28_datatable.Rows.Count

            adoRS_28.Close()
            adoRS_28 = Nothing

            If report_28_datatable.Rows.Count > 0 Then

                If bExcelReport Then
                    htmlOut.Append(localFunctions.include_excel_report_style() + vbCrLf)
                    htmlOut.Append("<table border='1' cellpadding='2' cellspacing='0'>")
                    htmlOut.Append("<tr bgcolor='#CCCCCC'><td valign='middle' align='left' colspan='4'><strong>" + FormatDateTime(Now(), DateFormat.GeneralDate).ToString + "</strong></td>")
                    htmlOut.Append("<td valign='middle' align='left' colspan='" + nTotalSpanCount.ToString + "'><strong>Condensed Aircraft Listing</strong></td></tr>")
                    htmlOut.Append("<tr bgcolor='#CCCCCC'><td valign='middle' align='left' colspan='" + (nTotalSpanCount + 4).ToString + "'></td></tr>")
                ElseIf bHtmlReport Then
                    htmlOut.Append("<table class='centerTable' border='0' cellpadding='2' cellspacing='0' width='100%'>")
                    htmlOut.Append("<tr bgcolor='#CCCCCC'><td valign='middle' align='left' colspan='4'><strong>" + FormatDateTime(Now(), DateFormat.GeneralDate).ToString + "</strong></td>")
                    htmlOut.Append("<td valign='middle' align='left' colspan='" + nTotalSpanCount.ToString + "'><strong>Condensed Aircraft Listing</strong></td></tr>")
                    htmlOut.Append("<tr bgcolor='#CCCCCC'><td width='100%' valign='middle' align='left' colspan='" + (nTotalSpanCount + 4).ToString + "'><hr></td></tr>")
                End If

                For Each Row As DataRow In report_28_datatable.Rows

                    If nRememberModelID <> CLng(Row.Item("amod_id").ToString) Then

                        nRememberModelID = CLng(Row.Item("amod_id").ToString)

                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='center' valign='middle' colspan='4'><strong>MAKE : " + Row.Item("amod_make_name").ToString.Trim + "</strong></td>")
                        htmlOut.Append("<td align='center' valign='middle' colspan='" + nTotalSpanCount.ToString + "'><strong>MODEL : " + Row.Item("amod_model_name").ToString.Trim + "</strong></td>")
                        htmlOut.Append("</tr>")

                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='center' valign='bottom'><strong>SERNBR</strong></td>")
                        htmlOut.Append("<td align='center' valign='bottom'><strong>REGNO</strong></td>")
                        htmlOut.Append("<td align='center' valign='bottom'><strong>YEAR</strong></td>")
                        htmlOut.Append("<td align='center' valign='bottom'><strong>OWNER NAME</strong></td>")

                        htmlOut.Append("<td align='center' valign='bottom'><strong>BASE</strong></td>")

                        If chkShowAsking.Checked And Not bAerodexFlag Then
                            htmlOut.Append("<td align='center' valign='bottom'><strong>ASKING</strong></td>")
                        End If

                        If Not bAerodexFlag Then
                            htmlOut.Append("<td align='center' valign='bottom'><strong>DATE<br />LISTED</strong></td>")
                        End If

                        htmlOut.Append("<td align='center' valign='bottom' nowrap='nowrap'><strong>AFTT</strong></td>")
                        htmlOut.Append("<td align='center' valign='bottom' nowrap='nowrap'><strong>ENG-L</strong></td>")
                        htmlOut.Append("<td align='center' valign='bottom' nowrap='nowrap'><strong>ENG-R</strong></td>")
                        htmlOut.Append("<td align='center' valign='bottom' nowrap='nowrap'><strong>SMOH-L</strong></td>")
                        htmlOut.Append("<td align='center' valign='bottom' nowrap='nowrap'><strong>SMOH-R</strong></td>")

                        htmlOut.Append("<td align='center' valign='middle'><strong>FEATURES</strong><br />")

                        htmlOut.Append("<table id='featureHeadingTable' width='100%' cellpadding='1' cellspacing='0' border='0'><tr>")

                        Dim sAcFeature As String = ""

                        ' if the arrStdFeatCodes = nothing then it will return all feature codes
                        localFunctions.display_nonstandard_feature_code_headings_report(CLng(Row.Item("amod_id").ToString), arrFeatCodes, arrStdFeatCodes, sAcFeature)

                        htmlOut.Append(sAcFeature + "</tr></table>")

                        htmlOut.Append("</td>")

                        htmlOut.Append("<th align='center' valign='bottom'><strong>EY</strong></td>")
                        htmlOut.Append("<th align='center' valign='bottom'><strong>IY</strong></td></tr>")

                    End If ' If sRememberMakeModel <> sTmpMakeModelname Then

                    htmlOut.Append("<tr><td align='center' valign='middle' class='textformat'>" + Row.Item("ac_ser_no_full").ToString.Trim + "</td>")
                    htmlOut.Append("<td align='left' valign='middle' class='textformat'>" + Row.Item("ac_reg_no").ToString.Trim + "</td>")

                    If Not IsDBNull(Row.Item("ac_year")) Then
                        htmlOut.Append("<td align='center' valign='top'>" + Row.Item("ac_year").ToString.Trim + "</td>")
                    Else
                        htmlOut.Append("<td align='center' valign='top'></td>")
                    End If

                    Dim resultsTable As DataTable = localFunctions.get_owner_info_report(CLng(Row.Item("ac_id").ToString), 0, False, False)

                    If Not IsNothing(resultsTable) Then
                        If resultsTable.Rows.Count > 0 Then
                            htmlOut.Append("<td align='left' valign='middle' nowrap='nowrap'>" + resultsTable.Rows(0).Item("comp_name").ToString + "</td>")
                        Else
                            htmlOut.Append("<td align='left' valign='middle'></td>")
                        End If
                    Else
                        htmlOut.Append("<td align='left' valign='middle'></td>")
                    End If

                    If Not IsDBNull(Row.Item("ac_aport_iata_code")) Then
                        htmlOut.Append("<td align='center' valign='middle'>" + Row.Item("ac_aport_iata_code").ToString.Trim + "</td>")
                    Else
                        htmlOut.Append("<td align='center' valign='middle'></td>")
                    End If

                    If chkShowAsking.Checked And Not bAerodexFlag Then
                        If Not IsDBNull(Row.Item("ac_asking_price")) Then
                            If Row.Item("ac_asking").ToString.ToLower.Contains("price") Then
                                If Not IsDBNull(Row.Item("ac_asking_price")) Then
                                    If CDbl(Row.Item("ac_asking_price").ToString) > 0 Then
                                        Dim nAddToAskingPrice As Double = 0
                                        If Not String.IsNullOrEmpty(addToAsking.Text.Trim) Then
                                            nAddToAskingPrice = CDbl(Replace(addToAsking.Text, Constants.cCommaDelim, Constants.cEmptyString))
                                        End If
                                        htmlOut.Append("<td align='center' valign='middle' nowrap='nowrap'>$" + FormatNumber(CDbl(Row.Item("ac_asking_price").ToString) + nAddToAskingPrice, 0, False, False, True).ToString + "</td>")
                                    Else
                                        htmlOut.Append("<td align='center' valign='middle'></td>")
                                    End If
                                Else
                                    htmlOut.Append("<td align='center' valign='middle'></td>")
                                End If
                            Else
                                If Not IsDBNull(Row.Item("ac_asking")) Then
                                    htmlOut.Append("<td align='center' valign='middle' nowrap='nowrap'>" + Row.Item("ac_asking").ToString.Trim + "</td>")
                                Else
                                    htmlOut.Append("<td align='center' valign='middle'></td>")
                                End If
                            End If
                        Else
                            If Not IsDBNull(Row.Item("ac_asking")) Then
                                htmlOut.Append("<td align='center' valign='middle' nowrap='nowrap'>" + Row.Item("ac_asking").ToString.Trim + "</td>")
                            Else
                                htmlOut.Append("<td align='center' valign='middle'></td>")
                            End If
                        End If
                    End If

                    If Not bAerodexFlag Then
                        If Not IsDBNull(Row.Item("ac_list_date")) Then
                            htmlOut.Append("<td align='center' valign='middle'>" + FormatDateTime(Row.Item("ac_list_date").ToString, DateFormat.ShortDate) + "</td>")
                        Else
                            htmlOut.Append("<td align='center' valign='middle'></td>")
                        End If
                    End If

                    If Not IsDBNull(Row.Item("ac_airframe_tot_hrs")) Then
                        htmlOut.Append("<td align='right' valign='middle'>" + Row.Item("ac_airframe_tot_hrs").ToString + "</td>")
                    Else
                        htmlOut.Append("<td align='right' valign='middle'></td>")
                    End If

                    If Not IsDBNull(Row.Item("ac_engine_1_tot_hrs")) Then
                        htmlOut.Append("<td align='right' valign='middle'>" + Row.Item("ac_engine_1_tot_hrs").ToString + "</td>")
                    Else
                        htmlOut.Append("<td align='right' valign='middle'></td>")
                    End If

                    If Not IsDBNull(Row.Item("ac_engine_2_tot_hrs")) Then
                        htmlOut.Append("<td align='right' valign='middle'>" + Row.Item("ac_engine_2_tot_hrs").ToString + "</td>")
                    Else
                        htmlOut.Append("<td align='right' valign='middle'></td>")
                    End If

                    If Not IsDBNull(Row.Item("ac_engine_1_soh_hrs")) Then
                        htmlOut.Append("<td align='right' valign='middle'>" + Row.Item("ac_engine_1_soh_hrs").ToString + "</td>")
                    Else
                        htmlOut.Append("<td align='right' valign='middle'></td>")
                    End If

                    If Not IsDBNull(Row.Item("ac_engine_2_soh_hrs")) Then
                        htmlOut.Append("<td align='right' valign='middle'>" + Row.Item("ac_engine_2_soh_hrs").ToString + "</td>")
                    Else
                        htmlOut.Append("<td align='right' valign='middle'></td>")
                    End If

                    htmlOut.Append("<td align='center' valign='middle'>")

                    Dim sAcFeatureCodes As String = ""
                    localFunctions.display_ac_feature_codes_report(CLng(Row.Item("ac_id").ToString), 0, arrFeatCodes, sAcFeatureCodes)
                    htmlOut.Append(sAcFeatureCodes)

                    htmlOut.Append("</td>")

                    If Not IsDBNull(Row.Item("ac_exterior_moyear")) Then
                        htmlOut.Append("<td align='right' valign='middle'>" + Right(Row.Item("ac_exterior_moyear").ToString, 4) + "</td>")
                    Else
                        htmlOut.Append("<td align='right' valign='middle'></td>")
                    End If

                    If Not IsDBNull(Row.Item("ac_interior_moyear")) Then
                        htmlOut.Append("<td align='right' valign='middle'>" + Right(Row.Item("ac_interior_moyear").ToString, 4) + "</td>")
                    Else
                        htmlOut.Append("<td align='right' valign='middle'></td>")
                    End If

                    htmlOut.Append("</tr>")

                Next

                If bHtmlReport Or bExcelReport Then
                    htmlOut.Append("</table>")
                End If

                If bHtmlReport Then
                    htmlOut.Append("</div>")
                    htmlOut.Append("</body>")
                    htmlOut.Append("</html>")
                End If

            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Create_Report_28_Condensed_Aircraft_Listing()" + ex.Message
        Finally
            adoRS_28 = Nothing

            report_28_datatable = Nothing

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOut.ToString

    End Function

#End Region

#Region "report_30_31_functions"

    Public Function create_report_30_aircraft_seller_purchaser_history(ByRef record_count As Long) As String

        Dim ACInfo1 As String = ""

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand

        Dim report_30_datatable As New DataTable
        Dim adoRS_30 As System.Data.SqlClient.SqlDataReader : adoRS_30 = Nothing

        Dim sQuery As New StringBuilder()
        Dim htmlOut = New StringBuilder()

        Dim nRememberJournID As Long = 0

        Try

            SqlConn.ConnectionString = localFunctions.clientConnectStr

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 90

            If HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("comp_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("contact_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("state_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("country_") Then
                sQuery.Append("SELECT DISTINCT * FROM View_Aircraft_Company_History_Flat WITH(NOLOCK) ")
                sQuery.Append(" " + Replace(HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.Trim, "View_Aircraft_History_Flat.", "View_Aircraft_Company_History_Flat."))
            Else
                sQuery.Append("SELECT DISTINCT * FROM View_Aircraft_History_Flat WITH(NOLOCK) ")
                sQuery.Append(" " + HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.Trim)
            End If

            sQuery.Append(" ORDER BY ac_ser_no_sort, journ_date DESC, journ_id DESC")

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />Create_Report_30_Aircraft_Seller_Purchaser_History()<br />" + sQuery.ToString

            If bHtmlReport Then
                htmlOut.Append("<!DOCTYPE html>")
                htmlOut.Append("<html lang='en'>")
                htmlOut.Append("<head>")
                htmlOut.Append("<meta http-equiv='Content-Language' content='en-us' />")
                htmlOut.Append("<meta http-equiv='Content-Type' content='text/html; charset=windows-1252' />")
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='common/jetnet.css' />")
                htmlOut.Append("<title>JETNET - Seller/Purchaser Report</title>")
                htmlOut.Append("</head>")
                htmlOut.Append("<body style='background: white; margin-top:10px; margin-left:10px;'>")
                htmlOut.Append("<div style='text-align:center;'>")
            End If

            If bExcelReport Then
                htmlOut.Append(localFunctions.include_excel_report_style() + vbCrLf)
                htmlOut.Append("<table border='1' cellpadding='2' cellspacing='0'>")
            ElseIf bHtmlReport Then
                htmlOut.Append("<table class='centerTable' border='0' cellpadding='2' cellspacing='0' width='100%'>")
            End If

            SqlCommand.CommandText = sQuery.ToString
            adoRS_30 = SqlCommand.ExecuteReader()

            Try
                report_30_datatable.Load(adoRS_30)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = report_30_datatable.GetErrors()
            End Try

            adoRS_30.Close()

            record_count = report_30_datatable.Rows.Count

            If report_30_datatable.Rows.Count > 0 Then

                If chkShowReportHeader.Checked Then

                    If bExcelReport Or bHtmlReport Then

                        htmlOut.Append("<tr bgcolor='#CCCCCC'>")

                        htmlOut.Append("<td>MAKE</td>")
                        htmlOut.Append("<td>MODEL</td>")
                        htmlOut.Append("<td>SERIALNBR</td>")
                        htmlOut.Append("<td>REGNBR</td>")

                        htmlOut.Append("<td>SELLERCOMPANY</td>")
                        htmlOut.Append("<td>SELLERCOMPALTNAME</td>")
                        htmlOut.Append("<td>SELLERCOMPBUSTYPE</td>")
                        htmlOut.Append("<td>SELLERCOMPEMAIL</td>")
                        htmlOut.Append("<td>SELLERCOMPWEBADDRESS</td>")
                        htmlOut.Append("<td>SELLERCOMPADDRESS1</td>")
                        htmlOut.Append("<td>SELLERCOMPADDRESS2</td>")
                        htmlOut.Append("<td>SELLERCOMPCITY</td>")
                        htmlOut.Append("<td>SELLERCOMPSTATE</td>")
                        htmlOut.Append("<td>SELLERCOMPSTATEABBR</td>")
                        htmlOut.Append("<td>SELLERCOMPPOSTALCODE</td>")
                        htmlOut.Append("<td>SELLERCOMPCOUNTRY</td>")
                        htmlOut.Append("<td>SELLERCOMPOFFICE</td>")
                        htmlOut.Append("<td>SELLERCOMPFAX</td>")
                        htmlOut.Append("<td>SELLERCOMPMOBILE</td>")
                        htmlOut.Append("<td>SELLERCONTACTPREFIX</td>")
                        htmlOut.Append("<td>SELLERCONTACTFIRSTNAME</td>")
                        htmlOut.Append("<td>SELLERCONTACTMI</td>")
                        htmlOut.Append("<td>SELLERCONTACTLASTNAME</td>")
                        htmlOut.Append("<td>SELLERCONTACTSUFFIX</td>")
                        htmlOut.Append("<td>SELLERCONTACTTITLE</td>")
                        htmlOut.Append("<td>SELLERCONTACTEMAIL</td>")
                        htmlOut.Append("<td>SELLERCONTACTOFFICE</td>")
                        htmlOut.Append("<td>SELLERCONTACTFAX</td>")
                        htmlOut.Append("<td>SELLERCONTACTMOBILE</td>")

                        htmlOut.Append("<td>PURCHASERCOMPANY</td>")
                        htmlOut.Append("<td>PURCHASERCOMPALTNAME</td>")
                        htmlOut.Append("<td>PURCHASERCOMPBUSTYPE</td>")
                        htmlOut.Append("<td>PURCHASERCOMPEMAIL</td>")
                        htmlOut.Append("<td>PURCHASERCOMPWEBADDRESS</td>")
                        htmlOut.Append("<td>PURCHASERCOMPADDRESS1</td>")
                        htmlOut.Append("<td>PURCHASERCOMPADDRESS2</td>")
                        htmlOut.Append("<td>PURCHASERCOMPCITY</td>")
                        htmlOut.Append("<td>PURCHASERCOMPSTATE</td>")
                        htmlOut.Append("<td>PURCHASERCOMPSTATEABBR</td>")
                        htmlOut.Append("<td>PURCHASERCOMPPOSTALCODE</td>")
                        htmlOut.Append("<td>PURCHASERCOMPCOUNTRY</td>")
                        htmlOut.Append("<td>PURCHASERCOMPOFFICE</td>")
                        htmlOut.Append("<td>PURCHASERCOMPFAX</td>")
                        htmlOut.Append("<td>PURCHASERCOMPMOBILE</td>")
                        htmlOut.Append("<td>PURCHASERCONTACTPREFIX</td>")
                        htmlOut.Append("<td>PURCHASERCONTACTFIRSTNAME</td>")
                        htmlOut.Append("<td>PURCHASERCONTACTMI</td>")
                        htmlOut.Append("<td>PURCHASERCONTACTLASTNAME</td>")
                        htmlOut.Append("<td>PURCHASERCONTACTSUFFIX</td>")
                        htmlOut.Append("<td>PURCHASERCONTACTTITLE</td>")
                        htmlOut.Append("<td>PURCHASERCONTACTEMAIL</td>")
                        htmlOut.Append("<td>PURCHASERCONTACTOFFICE</td>")
                        htmlOut.Append("<td>PURCHASERCONTACTFAX</td>")
                        htmlOut.Append("<td>PURCHASERCONTACTMOBILE</td>")

                        htmlOut.Append("<td>YEARMFG</td>")
                        htmlOut.Append("<td>YEARDLV</td>")
                        htmlOut.Append("<td>BASEIATA</td>")
                        htmlOut.Append("<td>BASEICAO</td>")
                        htmlOut.Append("<td>BASENAME</td>")
                        htmlOut.Append("<td>BASECITY</td>")
                        htmlOut.Append("<td>BASESTATE</td>")
                        htmlOut.Append("<td>BASESTATEABBR</td>")
                        htmlOut.Append("<td>BASECOUNTRY</td>")

                        htmlOut.Append("<td>AFTT</td>")
                        htmlOut.Append("<td>ENG1TT</td>")
                        htmlOut.Append("<td>ENG2TT</td>")
                        htmlOut.Append("<td>ENG3TT</td>")
                        htmlOut.Append("<td>ENG4TT</td>")
                        htmlOut.Append("<td>SMOH1</td>")
                        htmlOut.Append("<td>SMOH2</td>")
                        htmlOut.Append("<td>SMOH3</td>")
                        htmlOut.Append("<td>SMOH4</td>")
                        htmlOut.Append("<td>TRANSACTIONDATE</td>")
                        htmlOut.Append("<td>TRANSACTIONDESCRIPTION</td>")
                        htmlOut.Append("<td>TRANSACTIONCODE</td>")

                        htmlOut.Append("<td>FRACTIONPERCENT</td>")
                        htmlOut.Append("<td>FRACTIONEXPIRES</td>")
                        htmlOut.Append("<td>SCHEDULEDLEASEEXPIRATION</td>")
                        htmlOut.Append("<td>DATELEASEEXPIRED</td>")

                        If Session.Item("localPreferences").AerodexFlag = False Then
                            htmlOut.Append("<td>ASKING</td>")
                            htmlOut.Append("<td>ASKINGAMT</td>")
                            htmlOut.Append("<td>DATELISTED</td>")
                        End If

                        htmlOut.Append("<td>INFAVOROF</td>")
                        htmlOut.Append("<td>DOCDATE</td>")
                        htmlOut.Append("<td>DOCTYPE</td>")
                        htmlOut.Append("<td>DOCAMOUNT</td>")

                        htmlOut.Append("<td>TRANSACTIONNOTE</td>")

                        htmlOut.Append("<td>LESSORCOMPANY</td>")
                        htmlOut.Append("<td>LESSORCITY</td>")
                        htmlOut.Append("<td>LESSORSTATE</td>")
                        htmlOut.Append("<td>LESSORCOUNTRY</td>")

                        htmlOut.Append("<td>LESSEECOMPANY</td>")
                        htmlOut.Append("<td>LESSEECITY</td>")
                        htmlOut.Append("<td>LESSEESTATE</td>")
                        htmlOut.Append("<td>LESEECOUNTRY</td>")

                        htmlOut.Append("<td>SUBLESSEECOMPANY</td>")
                        htmlOut.Append("<td>SUBLESSEECITY</td>")
                        htmlOut.Append("<td>SUBLESSEESTATE</td>")
                        htmlOut.Append("<td>SUBLESSEECOUNTRY</td>")

                        htmlOut.Append("<td>NEWACFLAG</td>")
                        htmlOut.Append("<td>LEASEDATE</td>")

                        htmlOut.Append("</tr>" + vbCrLf)

                    ElseIf bTextCommaReport Then

                        htmlOut.Append(Constants.QUOTE + "MAKE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "MODEL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SERIALNBR" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "REGNBR" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPANY" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPANY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPALTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPBUSTYPE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPEMAIL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPWEBADDRESS" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPADDRESS1" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPADDRESS2" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPCITY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPSTATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPSTATEABBR" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPPOSTALCODE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPCOUNTRY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPOFFICEPHONE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPFAX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPMOBILEPHONE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCONTACTPREFIX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCONTACTFIRSTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCONTACTMI" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCONTACTLASTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCONTACTSUFFIX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCONTACTTITLE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCONTACTEMAIL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCONTACTOFFICEPHONE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCONTACTFAX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCONTACTMOBILE" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPANY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPALTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPBUSTYPE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPEMAIL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPWEBADDRESS" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPADDRESS1" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPADDRESS2" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPCITY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPSTATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPSTATEABBR" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPPOSTALCODE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPCOUNTRY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPOFFICEPHONE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPFAX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPMOBILEPHONE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCONTACTPREFIX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCONTACTFIRSTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCONTACTMI" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCONTACTLASTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCONTACTSUFFIX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCONTACTTITLE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCONTACTEMAIL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCONTACTOFFICEPHONE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCONTACTFAX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCONTACTMOBILE" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "YEARMFG" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "YEARDLV" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BASEIATA" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BASEICAO" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BASENAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BASECITY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BASESTATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BASESTATEABBR" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BASECOUNTRY" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "AFTT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "ENG1TT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "ENG2TT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "ENG3TT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "ENG4TT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SMOH1" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SMOH2" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SMOH3" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SMOH4" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "TRANSACTIONDATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "TRANSACTIONDESCRIPTION" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "TRANSACTIONCODE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "FRACTIONPERCENT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "FRACTIONEXPIRES" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SCHEDULEDLEASEEXPIRATION" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "DATELEASEEXPIRED" + Constants.QUOTE + Constants.cCommaDelim)

                        If Session.Item("localPreferences").AerodexFlag = False Then
                            htmlOut.Append(Constants.QUOTE + "ASKING" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "ASKINGAMT" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "DATELISTED" + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        htmlOut.Append(Constants.QUOTE + "INFAVOROF" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "DOCDATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "DOCTYPE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "DOCAMOUNT" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "TRANSACTIONNOTE" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "LESSORCOMPANY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "LESSORCITY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "LESSORSTATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "LESSORCOUNTRY" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "LESSEECOMPANY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "LESSEECITY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "LESSEESTATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "LESEECOUNTRY" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "SUBLESSEECOMPANY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SUBLESSEECITY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SUBLESSEESTATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SUBLESSEECOUNTRY" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "NEWACFLAG" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "LEASEDATE" + Constants.QUOTE)

                        htmlOut.Append(vbCrLf)

                    ElseIf bTextTabReport Then

                        htmlOut.Append("MAKE" + vbTab)
                        htmlOut.Append("MODEL" + vbTab)
                        htmlOut.Append("SERIALNBR" + vbTab)
                        htmlOut.Append("REGNBR" + vbTab)

                        htmlOut.Append("SELLERCOMPANY" + vbTab)
                        htmlOut.Append("SELLERCOMPALTNAME" + vbTab)
                        htmlOut.Append("SELLERCOMPBUSTYPE" + vbTab)
                        htmlOut.Append("SELLERCOMPEMAIL" + vbTab)
                        htmlOut.Append("SELLERCOMPWEBADDRESS" + vbTab)
                        htmlOut.Append("SELLERCOMPADDRESS1" + vbTab)
                        htmlOut.Append("SELLERCOMPADDRESS2" + vbTab)
                        htmlOut.Append("SELLERCOMPCITY" + vbTab)
                        htmlOut.Append("SELLERCOMPSTATE" + vbTab)
                        htmlOut.Append("SELLERCOMPSTATEABBR" + vbTab)
                        htmlOut.Append("SELLERCOMPPOSTALCODE" + vbTab)
                        htmlOut.Append("SELLERCOMPCOUNTRY" + vbTab)
                        htmlOut.Append("SELLERCOMPOFFICEPHONE" + vbTab)
                        htmlOut.Append("SELLERCOMPFAX" + vbTab)
                        htmlOut.Append("SELLERCOMPMOBILEPHONE" + vbTab)
                        htmlOut.Append("SELLERCONTACTPREFIX" + vbTab)
                        htmlOut.Append("SELLERCONTACTFIRSTNAME" + vbTab)
                        htmlOut.Append("SELLERCONTACTMI" + vbTab)
                        htmlOut.Append("SELLERCONTACTLASTNAME" + vbTab)
                        htmlOut.Append("SELLERCONTACTSUFFIX" + vbTab)
                        htmlOut.Append("SELLERCONTACTTITLE" + vbTab)
                        htmlOut.Append("SELLERCONTACTEMAIL" + vbTab)
                        htmlOut.Append("SELLERCONTACTOFFICEPHONE" + vbTab)
                        htmlOut.Append("SELLERCONTACTFAX" + vbTab)
                        htmlOut.Append("SELLERCONTACTMOBILE" + vbTab)

                        htmlOut.Append("PURCHASERCOMPANY" + vbTab)
                        htmlOut.Append("PURCHASERCOMPALTNAME" + vbTab)
                        htmlOut.Append("PURCHASERCOMPBUSTYPE" + vbTab)
                        htmlOut.Append("PURCHASERCOMPEMAIL" + vbTab)
                        htmlOut.Append("PURCHASERCOMPWEBADDRESS" + vbTab)
                        htmlOut.Append("PURCHASERCOMPADDRESS1" + vbTab)
                        htmlOut.Append("PURCHASERCOMPADDRESS2" + vbTab)
                        htmlOut.Append("PURCHASERCOMPCITY" + vbTab)
                        htmlOut.Append("PURCHASERCOMPSTATE" + vbTab)
                        htmlOut.Append("PURCHASERCOMPSTATEABBR" + vbTab)
                        htmlOut.Append("PURCHASERCOMPPOSTALCODE" + vbTab)
                        htmlOut.Append("PURCHASERCOMPCOUNTRY" + vbTab)
                        htmlOut.Append("PURCHASERCOMPOFFICEPHONE" + vbTab)
                        htmlOut.Append("PURCHASERCOMPFAX" + vbTab)
                        htmlOut.Append("PURCHASERCOMPMOBILEPHONE" + vbTab)
                        htmlOut.Append("PURCHASERCONTACTPREFIX" + vbTab)
                        htmlOut.Append("PURCHASERCONTACTFIRSTNAME" + vbTab)
                        htmlOut.Append("PURCHASERCONTACTMI" + vbTab)
                        htmlOut.Append("PURCHASERCONTACTLASTNAME" + vbTab)
                        htmlOut.Append("PURCHASERCONTACTSUFFIX" + vbTab)
                        htmlOut.Append("PURCHASERCONTACTTITLE" + vbTab)
                        htmlOut.Append("PURCHASERCONTACTEMAIL" + vbTab)
                        htmlOut.Append("PURCHASERCONTACTOFFICEPHONE" + vbTab)
                        htmlOut.Append("PURCHASERCONTACTFAX" + vbTab)
                        htmlOut.Append("PURCHASERCONTACTMOBILE" + vbTab)

                        htmlOut.Append("YEARMFG" + vbTab)
                        htmlOut.Append("YEARDLV" + vbTab)
                        htmlOut.Append("BASEIATA" + vbTab)
                        htmlOut.Append("BASEICAO" + vbTab)
                        htmlOut.Append("BASENAME" + vbTab)
                        htmlOut.Append("BASECITY" + vbTab)
                        htmlOut.Append("BASESTATE" + vbTab)
                        htmlOut.Append("BASESTATEABBR" + vbTab)
                        htmlOut.Append("BASECOUNTRY" + vbTab)

                        htmlOut.Append("AFTT" + vbTab)
                        htmlOut.Append("ENG1TT" + vbTab)
                        htmlOut.Append("ENG2TT" + vbTab)
                        htmlOut.Append("ENG3TT" + vbTab)
                        htmlOut.Append("ENG4TT" + vbTab)
                        htmlOut.Append("SMOH1" + vbTab)
                        htmlOut.Append("SMOH2" + vbTab)
                        htmlOut.Append("SMOH3" + vbTab)
                        htmlOut.Append("SMOH4" + vbTab)

                        htmlOut.Append("TRANSACTIONDATE" + vbTab)
                        htmlOut.Append("TRANSACTIONDESCRIPTION" + vbTab)
                        htmlOut.Append("TRANSACTIONCODE" + vbTab)
                        htmlOut.Append("FRACTIONPERCENT" + vbTab)
                        htmlOut.Append("FRACTIONEXPIRES" + vbTab)
                        htmlOut.Append("SCHEDULEDLEASEEXPIRATION" + vbTab)
                        htmlOut.Append("DATELEASEEXPIRED" + vbTab)

                        If Session.Item("localPreferences").AerodexFlag = False Then
                            htmlOut.Append("ASKING" + vbTab)
                            htmlOut.Append("ASKINGAMT" + vbTab)
                            htmlOut.Append("DATELISTED" + vbTab)
                        End If

                        htmlOut.Append("INFAVOROF" + vbTab)

                        htmlOut.Append("DOCDATE" + vbTab)
                        htmlOut.Append("DOCTYPE" + vbTab)
                        htmlOut.Append("DOCAMOUNT" + vbTab)
                        htmlOut.Append("TRANSACTIONNOTE" + vbTab)

                        htmlOut.Append("LESSORCOMPANY" + vbTab)
                        htmlOut.Append("LESSORCITY" + vbTab)
                        htmlOut.Append("LESSORSTATE" + vbTab)
                        htmlOut.Append("LESSORCOUNTRY" + vbTab)

                        htmlOut.Append("LESSEECOMPANY" + vbTab)
                        htmlOut.Append("LESSEECITY" + vbTab)
                        htmlOut.Append("LESSEESTATE" + vbTab)
                        htmlOut.Append("LESEECOUNTRY" + vbTab)

                        htmlOut.Append("SUBLESSEECOMPANY" + vbTab)
                        htmlOut.Append("SUBLESSEECITY" + vbTab)
                        htmlOut.Append("SUBLESSEESTATE" + vbTab)
                        htmlOut.Append("SUBLESSEECOUNTRY" + vbTab)

                        htmlOut.Append("NEWACFLAG" + vbTab)
                        htmlOut.Append("LEASEDATE")

                        htmlOut.Append(vbCrLf)

                    End If

                End If ' chkShowReportHeader.Checked Then

                For Each Row As DataRow In report_30_datatable.Rows

                    If CLng(Row.Item("journ_id").ToString) <> nRememberJournID Then

                        nRememberJournID = CLng(Row.Item("journ_id").ToString)

                        ACInfo1 = ""

                        If Not IsDBNull(Row.Item("ac_id")) And Not IsDBNull(Row.Item("journ_id")) Then

                            If bHtmlReport Or bExcelReport Then

                                ACInfo1 = "<tr><td>" + Row.Item("amod_make_name").ToString.Trim + "</td>"
                                ACInfo1 += "<td>" + Row.Item("amod_model_name").ToString.Trim + "</td>"
                                ACInfo1 += "<td class='textformat'>" + Row.Item("ac_ser_no_full").ToString.Trim + "</td>"
                                ACInfo1 += "<td class='textformat'>" + Row.Item("ac_reg_no").ToString.Trim + "</td>"

                            ElseIf bTextCommaReport Then
                                ACInfo1 = Constants.QUOTE + Row.Item("amod_make_name").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim
                                ACInfo1 += Constants.QUOTE + Row.Item("amod_model_name").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim
                                ACInfo1 += Constants.QUOTE + Row.Item("ac_ser_no_full").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim
                                ACInfo1 += Constants.QUOTE + Row.Item("ac_reg_no").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim

                            ElseIf bTextTabReport Then
                                ACInfo1 = Row.Item("amod_make_name").ToString.Trim + vbTab
                                ACInfo1 += Row.Item("amod_model_name").ToString.Trim + vbTab
                                ACInfo1 += Row.Item("ac_ser_no_full").ToString.Trim + vbTab
                                ACInfo1 += Row.Item("ac_reg_no").ToString.Trim + vbTab

                            End If

                            htmlOut.Append(get_references_seller_purchaser_30_31(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("journ_id").ToString), ACInfo1, True, Row))

                        End If

                    End If

                Next

            End If

            If bHtmlReport Or bExcelReport Then
                htmlOut.Append("</table>")
            End If

            If bHtmlReport Then
                htmlOut.Append("</div>")
                htmlOut.Append("</body>")
                htmlOut.Append("</html>")
            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Create_Report_30_Aircraft_Seller_Purchaser()" + ex.Message
        Finally

            adoRS_30 = Nothing

            report_30_datatable = Nothing

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOut.ToString

    End Function

    Public Function create_report_31_aircraft_seller_purchaser_events(ByRef record_count As Long) As String

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand

        Dim report_31_datatable As New DataTable
        Dim adoRS_31 As System.Data.SqlClient.SqlDataReader : adoRS_31 = Nothing

        Dim htmlOut = New StringBuilder()
        Dim sQuery As New StringBuilder()

        Dim ACInfo1 As String = ""
        Dim nRememberAcID As Long = 0

        Try

            SqlConn.ConnectionString = localFunctions.clientConnectStr

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 90


            sQuery.Append("SELECT DISTINCT * FROM Priority_Events WITH(NOLOCK)")
            sQuery.Append(" INNER JOIN Priority_Events_Category WITH(NOLOCK) ON priorev_category_code = priorevcat_category_code")


            If bFromEventDetail Then
                If HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("comp_") Or
           HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("contact_") Or
           HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("state_") Or
           HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("country_") Then
                    sQuery.Append(" LEFT OUTER JOIN View_Aircraft_Company_History_Flat WITH(NOLOCK) ON (priorev_ac_id = ac_id and priorev_journ_id = ac_journ_id)")
                Else
                    sQuery.Append(" LEFT OUTER JOIN View_Aircraft_History_Flat WITH(NOLOCK) ON (priorev_ac_id = ac_id and priorev_journ_id = ac_journ_id)")
                End If

                sQuery.Append(" WHERE (journ_subcategory_code NOT LIKE '%CORR') AND (journ_subcategory_code NOT LIKE '%IT') AND " + HttpContext.Current.Session.Item("MasterAircraftEventsWhere").ToString.Trim)
            Else

                If HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("comp_") Or
           HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("contact_") Then
                    sQuery.Append(" LEFT OUTER JOIN View_Aircraft_Company_History_Flat WITH(NOLOCK) ON (priorev_ac_id = ac_id)")
                Else
                    sQuery.Append(" LEFT OUTER JOIN View_Aircraft_History_Flat WITH(NOLOCK) ON (priorev_ac_id = ac_id)")
                End If

                sQuery.Append(" WHERE " + HttpContext.Current.Session.Item("MasterAircraftEventsWhere").ToString.Trim)
                sQuery.Append(" AND (journ_subcategory_code NOT LIKE '%CORR') ORDER BY amod_make_name, amod_airframe_type_code, amod_type_code, amod_id, amod_model_name, ac_ser_no_sort")

            End If

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />Create_Report_31_Aircraft_Seller_Purchaser_Events()<br />" + sQuery.ToString

            If bHtmlReport Then
                htmlOut.Append("<!DOCTYPE html>")
                htmlOut.Append("<html lang='en'>")
                htmlOut.Append("<head>")
                htmlOut.Append("<meta http-equiv='Content-Language' content='en-us' />")
                htmlOut.Append("<meta http-equiv='Content-Type' content='text/html; charset=windows-1252' />")
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='common/jetnet.css' />")
                htmlOut.Append("<title>JETNET - Seller/Purchaser Report</title>")
                htmlOut.Append("</head>")
                htmlOut.Append("<body style='background: white; margin-top:10px; margin-left:10px;'>")
                htmlOut.Append("<div style='text-align:center;'>")
            End If

            If bExcelReport Then
                htmlOut.Append(localFunctions.include_excel_report_style() + vbCrLf)
                htmlOut.Append("<table border='1' cellpadding='2' cellspacing='0'>")
            ElseIf bHtmlReport Then
                htmlOut.Append("<table class='centerTable' border='0' cellpadding='2' cellspacing='0' width='100%'>")
            End If

            SqlCommand.CommandText = sQuery.ToString
            adoRS_31 = SqlCommand.ExecuteReader()

            Try
                report_31_datatable.Load(adoRS_31)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = report_31_datatable.GetErrors()
            End Try

            adoRS_31.Close()

            record_count = report_31_datatable.Rows.Count

            If report_31_datatable.Rows.Count > 0 Then

                If chkShowReportHeader.Checked Then

                    If bExcelReport Or bHtmlReport Then

                        htmlOut.Append("<tr bgcolor='#CCCCCC'>")

                        htmlOut.Append("<td>MAKE</td>")
                        htmlOut.Append("<td>MODEL</td>")
                        htmlOut.Append("<td>SERIALNBR</td>")
                        htmlOut.Append("<td>REGNBR</td>")

                        htmlOut.Append("<td>SELLERCOMPANY</td>")
                        htmlOut.Append("<td>SELLERCOMPALTNAME</td>")
                        htmlOut.Append("<td>SELLERCOMPBUSTYPE</td>")
                        htmlOut.Append("<td>SELLERCOMPEMAIL</td>")
                        htmlOut.Append("<td>SELLERCOMPWEBADDRESS</td>")
                        htmlOut.Append("<td>SELLERCOMPADDRESS1</td>")
                        htmlOut.Append("<td>SELLERCOMPADDRESS2</td>")
                        htmlOut.Append("<td>SELLERCOMPCITY</td>")
                        htmlOut.Append("<td>SELLERCOMPSTATE</td>")
                        htmlOut.Append("<td>SELLERCOMPSTATEABBR</td>")
                        htmlOut.Append("<td>SELLERCOMPPOSTALCODE</td>")
                        htmlOut.Append("<td>SELLERCOMPCOUNTRY</td>")
                        htmlOut.Append("<td>SELLERCOMPOFFICE</td>")
                        htmlOut.Append("<td>SELLERCOMPFAX</td>")
                        htmlOut.Append("<td>SELLERCOMPMOBILE</td>")
                        htmlOut.Append("<td>SELLERCONTACTPREFIX</td>")
                        htmlOut.Append("<td>SELLERCONTACTFIRSTNAME</td>")
                        htmlOut.Append("<td>SELLERCONTACTMI</td>")
                        htmlOut.Append("<td>SELLERCONTACTLASTNAME</td>")
                        htmlOut.Append("<td>SELLERCONTACTSUFFIX</td>")
                        htmlOut.Append("<td>SELLERCONTACTTITLE</td>")
                        htmlOut.Append("<td>SELLERCONTACTEMAIL</td>")
                        htmlOut.Append("<td>SELLERCONTACTOFFICE</td>")
                        htmlOut.Append("<td>SELLERCONTACTFAX</td>")
                        htmlOut.Append("<td>SELLERCONTACTMOBILE</td>")

                        htmlOut.Append("<td>PURCHASERCOMPANY</td>")
                        htmlOut.Append("<td>PURCHASERCOMPALTNAME</td>")
                        htmlOut.Append("<td>PURCHASERCOMPBUSTYPE</td>")
                        htmlOut.Append("<td>PURCHASERCOMPEMAIL</td>")
                        htmlOut.Append("<td>PURCHASERCOMPWEBADDRESS</td>")
                        htmlOut.Append("<td>PURCHASERCOMPADDRESS1</td>")
                        htmlOut.Append("<td>PURCHASERCOMPADDRESS2</td>")
                        htmlOut.Append("<td>PURCHASERCOMPCITY</td>")
                        htmlOut.Append("<td>PURCHASERCOMPSTATE</td>")
                        htmlOut.Append("<td>PURCHASERCOMPSTATEABBR</td>")
                        htmlOut.Append("<td>PURCHASERCOMPPOSTALCODE</td>")
                        htmlOut.Append("<td>PURCHASERCOMPCOUNTRY</td>")
                        htmlOut.Append("<td>PURCHASERCOMPOFFICE</td>")
                        htmlOut.Append("<td>PURCHASERCOMPFAX</td>")
                        htmlOut.Append("<td>PURCHASERCOMPMOBILE</td>")
                        htmlOut.Append("<td>PURCHASERCONTACTPREFIX</td>")
                        htmlOut.Append("<td>PURCHASERCONTACTFIRSTNAME</td>")
                        htmlOut.Append("<td>PURCHASERCONTACTMI</td>")
                        htmlOut.Append("<td>PURCHASERCONTACTLASTNAME</td>")
                        htmlOut.Append("<td>PURCHASERCONTACTSUFFIX</td>")
                        htmlOut.Append("<td>PURCHASERCONTACTTITLE</td>")
                        htmlOut.Append("<td>PURCHASERCONTACTEMAIL</td>")
                        htmlOut.Append("<td>PURCHASERCONTACTOFFICE</td>")
                        htmlOut.Append("<td>PURCHASERCONTACTFAX</td>")
                        htmlOut.Append("<td>PURCHASERCONTACTMOBILE</td>")

                        htmlOut.Append("<td>YEARMFG</td>")
                        htmlOut.Append("<td>YEARDLV</td>")
                        htmlOut.Append("<td>BASEIATA</td>")
                        htmlOut.Append("<td>BASEICAO</td>")
                        htmlOut.Append("<td>BASENAME</td>")
                        htmlOut.Append("<td>BASECITY</td>")
                        htmlOut.Append("<td>BASESTATE</td>")
                        htmlOut.Append("<td>BASESTATEABBR</td>")
                        htmlOut.Append("<td>BASECOUNTRY</td>")

                        htmlOut.Append("<td>AFTT</td>")
                        htmlOut.Append("<td>ENG1TT</td>")
                        htmlOut.Append("<td>ENG2TT</td>")
                        htmlOut.Append("<td>ENG3TT</td>")
                        htmlOut.Append("<td>ENG4TT</td>")
                        htmlOut.Append("<td>SMOH1</td>")
                        htmlOut.Append("<td>SMOH2</td>")
                        htmlOut.Append("<td>SMOH3</td>")
                        htmlOut.Append("<td>SMOH4</td>")
                        htmlOut.Append("<td>TRANSACTIONDATE</td>")
                        htmlOut.Append("<td>TRANSACTIONDESCRIPTION</td>")
                        htmlOut.Append("<td>TRANSACTIONCODE</td>")

                        htmlOut.Append("<td>EVENTDATETIME</td>")
                        htmlOut.Append("<td>EVENTDESCRIPTION</td>")

                        htmlOut.Append("<td>FRACTIONPERCENT</td>")
                        htmlOut.Append("<td>FRACTIONEXPIRES</td>")
                        htmlOut.Append("<td>SCHEDULEDLEASEEXPIRATION</td>")
                        htmlOut.Append("<td>DATELEASEEXPIRED</td>")

                        If Session.Item("localPreferences").AerodexFlag = False Then
                            htmlOut.Append("<td>ASKING</td>")
                            htmlOut.Append("<td>ASKINGAMT</td>")
                            htmlOut.Append("<td>DATELISTED</td>")
                        End If

                        htmlOut.Append("<td>INFAVOROF</td>")

                        htmlOut.Append("<td>DOCDATE</td>")
                        htmlOut.Append("<td>DOCTYPE</td>")
                        htmlOut.Append("<td>DOCAMOUNT</td>")

                        htmlOut.Append("<td>TRANSACTIONNOTE</td>")

                        htmlOut.Append("<td>LESSORCOMPANY</td>")
                        htmlOut.Append("<td>LESSORCITY</td>")
                        htmlOut.Append("<td>LESSORSTATE</td>")
                        htmlOut.Append("<td>LESSORCOUNTRY</td>")

                        htmlOut.Append("<td>LESSEECOMPANY</td>")
                        htmlOut.Append("<td>LESSEECITY</td>")
                        htmlOut.Append("<td>LESSEESTATE</td>")
                        htmlOut.Append("<td>LESEECOUNTRY</td>")

                        htmlOut.Append("<td>SUBLESSEECOMPANY</td>")
                        htmlOut.Append("<td>SUBLESSEECITY</td>")
                        htmlOut.Append("<td>SUBLESSEESTATE</td>")
                        htmlOut.Append("<td>SUBLESSEECOUNTRY</td>")

                        htmlOut.Append("<td>NEWACFLAG</td>")
                        htmlOut.Append("<td>LEASEDATE</td>")

                        htmlOut.Append("</tr>" & vbCrLf)

                    ElseIf bTextCommaReport Then

                        htmlOut.Append(Constants.QUOTE + "MAKE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "MODEL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SERIALNBR" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "REGNBR" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPANY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPALTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPBUSTYPE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPEMAIL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPWEBADDRESS" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPADDRESS1" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPADDRESS2" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPCITY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPSTATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPSTATEABBR" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPPOSTALCODE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPCOUNTRY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPOFFICEPHONE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPFAX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPMOBILEPHONE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCONTACTPREFIX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCONTACTFIRSTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCONTACTMI" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCONTACTLASTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCONTACTSUFFIX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCONTACTTITLE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCONTACTEMAIL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCONTACTOFFICEPHONE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCONTACTFAX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCONTACTMOBILE" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPANY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPALTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPBUSTYPE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPEMAIL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPWEBADDRESS" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPADDRESS1" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPADDRESS2" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPCITY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPSTATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPSTATEABBR" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPPOSTALCODE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPCOUNTRY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPOFFICEPHONE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPFAX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPMOBILEPHONE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCONTACTPREFIX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCONTACTFIRSTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCONTACTMI" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCONTACTLASTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCONTACTSUFFIX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCONTACTTITLE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCONTACTEMAIL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCONTACTOFFICEPHONE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCONTACTFAX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCONTACTMOBILE" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "YEARMFG" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "YEARDLV" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BASEIATA" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BASEICAO" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BASENAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BASECITY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BASESTATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BASESTATEABBR" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BASECOUNTRY" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "AFTT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "ENG1TT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "ENG2TT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "ENG3TT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "ENG4TT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SMOH1" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SMOH2" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SMOH3" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SMOH4" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "TRANSACTIONDATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "TRANSACTIONDESCRIPTION" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "TRANSACTIONCODE" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "EVENTDATETIME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "EVENTDESCRIPTION" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "FRACTIONPERCENT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "FRACTIONEXPIRES" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SCHEDULEDLEASEEXPIRATION" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "DATELEASEEXPIRED" + Constants.QUOTE)

                        If Session.Item("localPreferences").AerodexFlag = False Then
                            htmlOut.Append(Constants.cCommaDelim + Constants.QUOTE + "ASKING" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "ASKINGAMT" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "DATELISTED" + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        htmlOut.Append(Constants.QUOTE + "INFAVOROF" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "DOCDATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "DOCTYPE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "DOCAMOUNT" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "TRANSACTIONNOTE" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "LESSORCOMPANY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "LESSORCITY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "LESSORSTATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "LESSORCOUNTRY" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "LESSEECOMPANY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "LESSEECITY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "LESSEESTATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "LESEECOUNTRY" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "SUBLESSEECOMPANY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SUBLESSEECITY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SUBLESSEESTATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SUBLESSEECOUNTRY" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "NEWACFLAG" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "LEASEDATE" + Constants.QUOTE)

                        htmlOut.Append(vbCrLf)

                    ElseIf bTextTabReport Then

                        htmlOut.Append("MAKE" + vbTab)
                        htmlOut.Append("MODEL" + vbTab)
                        htmlOut.Append("SERIALNBR" + vbTab)
                        htmlOut.Append("REGNBR" + vbTab)

                        htmlOut.Append("SELLERCOMPANY" + vbTab)
                        htmlOut.Append("SELLERCOMPALTNAME" + vbTab)
                        htmlOut.Append("SELLERCOMPBUSTYPE" + vbTab)
                        htmlOut.Append("SELLERCOMPEMAIL" + vbTab)
                        htmlOut.Append("SELLERCOMPWEBADDRESS" + vbTab)
                        htmlOut.Append("SELLERCOMPADDRESS1" + vbTab)
                        htmlOut.Append("SELLERCOMPADDRESS2" + vbTab)
                        htmlOut.Append("SELLERCOMPCITY" + vbTab)
                        htmlOut.Append("SELLERCOMPSTATE" + vbTab)
                        htmlOut.Append("SELLERCOMPSTATEABBR" + vbTab)
                        htmlOut.Append("SELLERCOMPPOSTALCODE" + vbTab)
                        htmlOut.Append("SELLERCOMPCOUNTRY" + vbTab)
                        htmlOut.Append("SELLERCOMPOFFICEPHONE" + vbTab)
                        htmlOut.Append("SELLERCOMPFAX" + vbTab)
                        htmlOut.Append("SELLERCOMPMOBILEPHONE" + vbTab)
                        htmlOut.Append("SELLERCONTACTPREFIX" + vbTab)
                        htmlOut.Append("SELLERCONTACTFIRSTNAME" + vbTab)
                        htmlOut.Append("SELLERCONTACTMI" + vbTab)
                        htmlOut.Append("SELLERCONTACTLASTNAME" + vbTab)
                        htmlOut.Append("SELLERCONTACTSUFFIX" + vbTab)
                        htmlOut.Append("SELLERCONTACTTITLE" + vbTab)
                        htmlOut.Append("SELLERCONTACTEMAIL" + vbTab)
                        htmlOut.Append("SELLERCONTACTOFFICEPHONE" + vbTab)
                        htmlOut.Append("SELLERCONTACTFAX" + vbTab)
                        htmlOut.Append("SELLERCONTACTMOBILE" + vbTab)

                        htmlOut.Append("PURCHASERCOMPANY" + vbTab)
                        htmlOut.Append("PURCHASERCOMPALTNAME" + vbTab)
                        htmlOut.Append("PURCHASERCOMPBUSTYPE" + vbTab)
                        htmlOut.Append("PURCHASERCOMPEMAIL" + vbTab)
                        htmlOut.Append("PURCHASERCOMPWEBADDRESS" + vbTab)
                        htmlOut.Append("PURCHASERCOMPADDRESS1" + vbTab)
                        htmlOut.Append("PURCHASERCOMPADDRESS2" + vbTab)
                        htmlOut.Append("PURCHASERCOMPCITY" + vbTab)
                        htmlOut.Append("PURCHASERCOMPSTATE" + vbTab)
                        htmlOut.Append("PURCHASERCOMPSTATEABBR" + vbTab)
                        htmlOut.Append("PURCHASERCOMPPOSTALCODE" + vbTab)
                        htmlOut.Append("PURCHASERCOMPCOUNTRY" + vbTab)
                        htmlOut.Append("PURCHASERCOMPOFFICEPHONE" + vbTab)
                        htmlOut.Append("PURCHASERCOMPFAX" + vbTab)
                        htmlOut.Append("PURCHASERCOMPMOBILEPHONE" + vbTab)
                        htmlOut.Append("PURCHASERCONTACTPREFIX" + vbTab)
                        htmlOut.Append("PURCHASERCONTACTFIRSTNAME" + vbTab)
                        htmlOut.Append("PURCHASERCONTACTMI" + vbTab)
                        htmlOut.Append("PURCHASERCONTACTLASTNAME" + vbTab)
                        htmlOut.Append("PURCHASERCONTACTSUFFIX" + vbTab)
                        htmlOut.Append("PURCHASERCONTACTTITLE" + vbTab)
                        htmlOut.Append("PURCHASERCONTACTEMAIL" + vbTab)
                        htmlOut.Append("PURCHASERCONTACTOFFICEPHONE" + vbTab)
                        htmlOut.Append("PURCHASERCONTACTFAX" + vbTab)
                        htmlOut.Append("PURCHASERCONTACTMOBILE" + vbTab)

                        htmlOut.Append("YEARMFG" + vbTab)
                        htmlOut.Append("YEARDLV" + vbTab)
                        htmlOut.Append("BASEIATA" + vbTab)
                        htmlOut.Append("BASEICAO" + vbTab)
                        htmlOut.Append("BASENAME" + vbTab)
                        htmlOut.Append("BASECITY" + vbTab)
                        htmlOut.Append("BASESTATE" + vbTab)
                        htmlOut.Append("BASESTATEABBR" + vbTab)
                        htmlOut.Append("BASECOUNTRY" + vbTab)

                        htmlOut.Append("AFTT" + vbTab)
                        htmlOut.Append("ENG1TT" + vbTab)
                        htmlOut.Append("ENG2TT" + vbTab)
                        htmlOut.Append("ENG3TT" + vbTab)
                        htmlOut.Append("ENG4TT" + vbTab)
                        htmlOut.Append("SMOH1" + vbTab)
                        htmlOut.Append("SMOH2" + vbTab)
                        htmlOut.Append("SMOH3" + vbTab)
                        htmlOut.Append("SMOH4" + vbTab)

                        htmlOut.Append("TRANSACTIONDATE" + vbTab)
                        htmlOut.Append("TRANSACTIONDESCRIPTION" + vbTab)
                        htmlOut.Append("TRANSACTIONCODE" + vbTab)

                        htmlOut.Append("EVENTDATETIME" + vbTab)
                        htmlOut.Append("EVENTDESCRIPTION" + vbTab)

                        htmlOut.Append("FRACTIONPERCENT" + vbTab)
                        htmlOut.Append("FRACTIONEXPIRES" + vbTab)
                        htmlOut.Append("SCHEDULEDLEASEEXPIRATION" + vbTab)
                        htmlOut.Append("DATELEASEEXPIRED")

                        If Session.Item("localPreferences").AerodexFlag = False Then
                            htmlOut.Append(vbTab + "ASKING" + vbTab)
                            htmlOut.Append("ASKINGAMT" + vbTab)
                            htmlOut.Append("DATELISTED" + vbTab)
                        End If

                        ' 7/17/2007 - By David D. Cruger
                        ' Added InFavorOf
                        htmlOut.Append("INFAVOROF" + vbTab)

                        ' 03/05/2009 - BY David D. Cruger
                        ' Added DocDate, DocType and DocAmount        
                        htmlOut.Append("DOCDATE" + vbTab)
                        htmlOut.Append("DOCTYPE" + vbTab)
                        htmlOut.Append("DOCAMOUNT" + vbTab)
                        htmlOut.Append("TRANSACTIONNOTE" + vbTab)

                        htmlOut.Append("LESSORCOMPANY" + vbTab)
                        htmlOut.Append("LESSORCITY" + vbTab)
                        htmlOut.Append("LESSORSTATE" + vbTab)
                        htmlOut.Append("LESSORCOUNTRY" + vbTab)

                        htmlOut.Append("LESSEECOMPANY" + vbTab)
                        htmlOut.Append("LESSEECITY" + vbTab)
                        htmlOut.Append("LESSEESTATE" + vbTab)
                        htmlOut.Append("LESEECOUNTRY" + vbTab)

                        htmlOut.Append("SUBLESSEECOMPANY" + vbTab)
                        htmlOut.Append("SUBLESSEECITY" + vbTab)
                        htmlOut.Append("SUBLESSEESTATE" + vbTab)
                        htmlOut.Append("SUBLESSEECOUNTRY" + vbTab)

                        htmlOut.Append("NEWACFLAG" + vbTab)
                        htmlOut.Append("LEASEDATE")

                        htmlOut.Append(vbCrLf)

                    End If

                End If ' chkShowReportHeader.Checked Then

                For Each Row As DataRow In report_31_datatable.Rows

                    If Not bFromEventDetail Then

                        If CLng(Row.Item("ac_id").ToString) <> nRememberAcID Then

                            nRememberAcID = CLng(Row.Item("ac_id").ToString)

                            ACInfo1 = ""

                            If Not IsDBNull(Row.Item("ac_id")) And Not IsDBNull(Row.Item("journ_id")) Then

                                If bHtmlReport Or bExcelReport Then

                                    ACInfo1 = "<tr><td>" + Row.Item("amod_make_name").ToString.Trim + "</td>"
                                    ACInfo1 += "<td>" + Row.Item("amod_model_name").ToString.Trim + "</td>"
                                    ACInfo1 += "<td class='textformat'>" + Row.Item("ac_ser_no_full").ToString.Trim + "</td>"
                                    ACInfo1 += "<td class='textformat'>" + Row.Item("ac_reg_no").ToString.Trim + "</td>"

                                ElseIf bTextCommaReport Then
                                    ACInfo1 = Constants.QUOTE + Row.Item("amod_make_name").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim
                                    ACInfo1 += Constants.QUOTE + Row.Item("amod_model_name").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim
                                    ACInfo1 += Constants.QUOTE + Row.Item("ac_ser_no_full").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim
                                    ACInfo1 += Constants.QUOTE + Row.Item("ac_reg_no").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim

                                ElseIf bTextTabReport Then
                                    ACInfo1 = Row.Item("amod_make_name").ToString.Trim + vbTab
                                    ACInfo1 += Row.Item("amod_model_name").ToString.Trim + vbTab
                                    ACInfo1 += Row.Item("ac_ser_no_full").ToString.Trim + vbTab
                                    ACInfo1 += Row.Item("ac_reg_no").ToString.Trim + vbTab

                                End If

                                htmlOut.Append(get_references_seller_purchaser_30_31(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("journ_id").ToString), ACInfo1, False, Row))

                            End If

                        End If

                    Else

                        ACInfo1 = ""

                        If Not IsDBNull(Row.Item("ac_id")) And Not IsDBNull(Row.Item("journ_id")) Then

                            If bHtmlReport Or bExcelReport Then

                                ACInfo1 = "<tr><td>" + Row.Item("amod_make_name").ToString.Trim + "</td>"
                                ACInfo1 += "<td>" + Row.Item("amod_model_name").ToString.Trim + "</td>"
                                ACInfo1 += "<td class='textformat'>" + Row.Item("ac_ser_no_full").ToString.Trim + "</td>"
                                ACInfo1 += "<td class='textformat'>" + Row.Item("ac_reg_no").ToString.Trim + "</td>"

                            ElseIf bTextCommaReport Then
                                ACInfo1 = Constants.QUOTE + Row.Item("amod_make_name").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim
                                ACInfo1 += Constants.QUOTE + Row.Item("amod_model_name").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim
                                ACInfo1 += Constants.QUOTE + Row.Item("ac_ser_no_full").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim
                                ACInfo1 += Constants.QUOTE + Row.Item("ac_reg_no").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim

                            ElseIf bTextTabReport Then
                                ACInfo1 = Row.Item("amod_make_name").ToString.Trim + vbTab
                                ACInfo1 += Row.Item("amod_model_name").ToString.Trim + vbTab
                                ACInfo1 += Row.Item("ac_ser_no_full").ToString.Trim + vbTab
                                ACInfo1 += Row.Item("ac_reg_no").ToString.Trim + vbTab

                            End If

                            htmlOut.Append(get_references_seller_purchaser_30_31(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("journ_id").ToString), ACInfo1, False, Row))

                        End If

                    End If

                Next

            End If

            If bHtmlReport Or bExcelReport Then
                htmlOut.Append("</table>")
            End If

            If bHtmlReport Then
                htmlOut.Append("</div>")
                htmlOut.Append("</body>")
                htmlOut.Append("</html>")
            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Create_Report_31_Aircraft_Seller_Purchaser_events()" + ex.Message
        Finally

            adoRS_31 = Nothing

            report_31_datatable = Nothing

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOut.ToString

    End Function

    Public Function get_references_seller_purchaser_30_31(ByVal inACID As Long, ByVal inJournalID As Long, ByVal ACInfo1 As String, ByVal isHistorical As Boolean, ByRef currentRow As DataRow) As String

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim SqlReader As System.Data.SqlClient.SqlDataReader : SqlReader = Nothing

        Dim sSellerLine As String = ""
        Dim sPurchaserLine As String = ""

        Dim CompInfo As String = ""
        Dim CompPhoneInfo As String = ""
        Dim ContactInfo As String = ""
        Dim ContactPhoneInfo As String = ""
        Dim ACInfo2 As String = ""

        Dim lHoldCompId As Long = 0
        Dim lHoldContactId As Long = 0
        Dim lCompId As Long = 0
        Dim lContactId As Long = 0

        Dim strInFavorOf As String = ""
        Dim txNote As String = ""

        Dim txLessor As String = ""
        Dim txLessee As String = ""
        Dim txSublessee As String = ""

        Dim acNewUsed As String = ""
        Dim acLeaseDate As String = ""

        Dim sQuery = New StringBuilder()
        Dim htmlOut = New StringBuilder()

        Dim bIsPurchaser As Boolean = False

        Dim ref_30_31_datatable As New DataTable

        Try

            If Not IsDBNull(currentRow.Item("journ_customer_note")) Then
                If bExcelReport Or bHtmlReport Then
                    txNote = "<td>" + currentRow.Item("journ_customer_note").ToString.Trim + "</td>" + vbCrLf
                ElseIf bTextCommaReport Then
                    txNote = Constants.QUOTE + currentRow.Item("journ_customer_note").ToString.Trim + Constants.QUOTE + vbCrLf
                ElseIf bTextTabReport Then
                    txNote = currentRow.Item("journ_customer_note").ToString.Trim + vbCrLf
                End If
            Else
                If bExcelReport Or bHtmlReport Then
                    txNote = "<td></td>" + vbCrLf
                ElseIf bTextCommaReport Then
                    txNote = Constants.QUOTE + Constants.QUOTE + vbCrLf
                ElseIf bTextTabReport Then
                    txNote = "" + vbCrLf
                End If
            End If

            If Not IsDBNull(currentRow.Item("journ_newac_flag")) Then
                If Not String.IsNullOrEmpty(currentRow.Item("journ_newac_flag").ToString.Trim) Then
                    acNewUsed = IIf(currentRow.Item("journ_newac_flag").ToString.Trim.ToUpper.Contains("Y"), "Yes", "No")
                End If
            End If

            If currentRow.Item("jcat_subcategory_transtype").ToString.Trim.ToUpper.Contains("LEASE") Then
                If Not IsDBNull(currentRow.Item("journ_date")) Then
                    acLeaseDate = FormatDateTime(currentRow.Item("journ_date").ToString, DateFormat.ShortDate)
                End If
            End If

            If bExcelReport Or bHtmlReport Then
                acNewUsed = "<td>" + acNewUsed.Trim + "</td>"
                acLeaseDate = "<td>" + acLeaseDate.Trim + "</td></tr>" + vbCrLf
            ElseIf bTextCommaReport Then
                acNewUsed = Constants.QUOTE + acNewUsed.Trim + Constants.QUOTE + Constants.cCommaDelim
                acLeaseDate = Constants.QUOTE + acLeaseDate.Trim + Constants.QUOTE + vbCrLf
            ElseIf bTextTabReport Then
                acNewUsed = acNewUsed.Trim + vbTab
                acLeaseDate = acLeaseDate.Trim + vbCrLf
            End If

            sQuery.Append("SELECT DISTINCT TOP 2 cref_contact_type, cref_contact_id, comp_id, comp_journ_id, cref_comp_id, cref_transmit_seq_no,")
            sQuery.Append(" comp_name, comp_name_alt_type, comp_name_alt, comp_city, comp_state, comp_zip_code,")
            sQuery.Append(" (SELECT DISTINCT cbus_name FROM Company_Business_Type WITH (NOLOCK) WHERE comp_business_type = cbus_type) AS comp_cbus_name, actype_name,")
            sQuery.Append(" comp_email_address, comp_web_address, comp_address1, comp_address2, comp_country, state_name")
            sQuery.Append(" FROM Aircraft_Reference WITH (NOLOCK) ")
            sQuery.Append(" INNER JOIN Company WITH (NOLOCK) ON cref_comp_id = comp_id AND cref_journ_id = comp_journ_id")
            sQuery.Append(" INNER JOIN Aircraft_Contact_Type WITH (NOLOCK) ON cref_contact_type = actype_code")
            sQuery.Append(" LEFT OUTER JOIN State WITH (NOLOCK) ON (comp_state = state_code AND comp_country = state_country)")
            sQuery.Append(" WHERE ((cref_ac_id = " + inACID.ToString + ") AND (cref_journ_id = " + inJournalID.ToString + ")")

            ' 02 = Additional Company/Contact
            ' 66,67,68 = Additional Contact 1,2,3
            ' 71 = Research Only
            ' 93 = Exclusive Representative
            ' 97 = Dealer Broker
            ' 99 = Exclusive Broker

            sQuery.Append(" AND (cref_contact_type NOT IN ('02','66','67','68','71','93','99'))")
            sQuery.Append(" AND (cref_transmit_seq_no IN (1,10))")
            sQuery.Append(" AND (comp_hide_flag = 'N'))")
            sQuery.Append(" ORDER BY cref_transmit_seq_no")

            Try

                SqlConn.ConnectionString = localFunctions.clientConnectStr
                SqlConn.Open()

                SqlCommand.Connection = SqlConn
                SqlCommand.CommandType = System.Data.CommandType.Text
                SqlCommand.CommandTimeout = 90

                SqlCommand.CommandText = sQuery.ToString
                SqlReader = SqlCommand.ExecuteReader()

                Try
                    ref_30_31_datatable.Load(SqlReader)
                Catch constrExc As System.Data.ConstraintException
                    Dim rowsErr As System.Data.DataRow() = ref_30_31_datatable.GetErrors()
                End Try

                SqlReader.Close()

                If ref_30_31_datatable.Rows.Count > 0 Then

                    CompInfo = ""
                    CompPhoneInfo = ""
                    ContactInfo = ""
                    ContactPhoneInfo = ""
                    strInFavorOf = ""
                    ACInfo2 = ""

                    lHoldCompId = -1
                    lHoldContactId = -1

                    For Each Row As DataRow In ref_30_31_datatable.Rows

                        lCompId = CLng(Row.Item("cref_comp_id").ToString)
                        lContactId = CLng(Row.Item("cref_contact_id").ToString)

                        If lHoldCompId <> lCompId Then

                            ReturnCompanyInformation_Report(lCompId, inJournalID, Row, CompPhoneInfo, CompInfo, True)
                            lHoldCompId = lCompId

                        End If   ' if we have a company id

                        If lHoldContactId <> lContactId Then

                            ReturnContactInformation_Report(lCompId, lContactId, inJournalID, ContactInfo, ContactPhoneInfo)
                            lHoldContactId = lContactId

                        End If

                        ' add Contact Type – 13 – Lessor, 12 or 57 - Lessee, 39 - Sublessee
                        Dim companyInfo(3) As String

                        localFunctions.get_company_info_by_reference(inACID, inJournalID, "'13'", companyInfo)

                        If bExcelReport Or bHtmlReport Then
                            txLessor = "<td>" + companyInfo(0).Trim + "</td>"
                            txLessor += "<td>" + companyInfo(1).Trim + "</td>"
                            txLessor += "<td>" + companyInfo(2).Trim + "</td>"
                            txLessor += "<td>" + companyInfo(3).Trim + "</td>"
                        ElseIf bTextCommaReport Then
                            txLessor = Constants.QUOTE + companyInfo(0).Trim + Constants.QUOTE + Constants.cCommaDelim
                            txLessor += Constants.QUOTE + companyInfo(2).Trim + Constants.QUOTE + Constants.cCommaDelim
                            txLessor += Constants.QUOTE + companyInfo(3).Trim + Constants.QUOTE + Constants.cCommaDelim
                            txLessor += Constants.QUOTE + companyInfo(4).Trim + Constants.QUOTE + Constants.cCommaDelim
                        ElseIf bTextTabReport Then
                            txLessor = companyInfo(0).Trim + vbTab
                            txLessor += companyInfo(2).Trim + vbTab
                            txLessor += companyInfo(3).Trim + vbTab
                            txLessor += companyInfo(4).Trim + vbTab
                        End If

                        localFunctions.get_company_info_by_reference(inACID, inJournalID, "'12','57'", companyInfo)

                        If bExcelReport Or bHtmlReport Then
                            txLessee = "<td>" + companyInfo(0).Trim + "</td>"
                            txLessee += "<td>" + companyInfo(1).Trim + "</td>"
                            txLessee += "<td>" + companyInfo(2).Trim + "</td>"
                            txLessee += "<td>" + companyInfo(3).Trim + "</td>"
                        ElseIf bTextCommaReport Then
                            txLessee = Constants.QUOTE + companyInfo(0).Trim + Constants.QUOTE + Constants.cCommaDelim
                            txLessee += Constants.QUOTE + companyInfo(2).Trim + Constants.QUOTE + Constants.cCommaDelim
                            txLessee += Constants.QUOTE + companyInfo(3).Trim + Constants.QUOTE + Constants.cCommaDelim
                            txLessee += Constants.QUOTE + companyInfo(4).Trim + Constants.QUOTE + Constants.cCommaDelim
                        ElseIf bTextTabReport Then
                            txLessee = companyInfo(0).Trim + vbTab
                            txLessee += companyInfo(2).Trim + vbTab
                            txLessee += companyInfo(3).Trim + vbTab
                            txLessee += companyInfo(4).Trim + vbTab
                        End If

                        localFunctions.get_company_info_by_reference(inACID, inJournalID, "'39'", companyInfo)

                        If bExcelReport Or bHtmlReport Then
                            txSublessee = "<td>" + companyInfo(0).Trim + "</td>"
                            txSublessee += "<td>" + companyInfo(1).Trim + "</td>"
                            txSublessee += "<td>" + companyInfo(2).Trim + "</td>"
                            txSublessee += "<td>" + companyInfo(3).Trim + "</td>"
                        ElseIf bTextCommaReport Then
                            txSublessee = Constants.QUOTE + companyInfo(0).Trim + Constants.QUOTE + Constants.cCommaDelim
                            txSublessee += Constants.QUOTE + companyInfo(2).Trim + Constants.QUOTE + Constants.cCommaDelim
                            txSublessee += Constants.QUOTE + companyInfo(3).Trim + Constants.QUOTE + Constants.cCommaDelim
                            txSublessee += Constants.QUOTE + companyInfo(4).Trim + Constants.QUOTE + Constants.cCommaDelim
                        ElseIf bTextTabReport Then
                            txSublessee = companyInfo(0).Trim + vbTab
                            txSublessee += companyInfo(2).Trim + vbTab
                            txSublessee += companyInfo(3).Trim + vbTab
                            txSublessee += companyInfo(4).Trim + vbTab
                        End If

                        If ref_30_31_datatable.Rows.Count = 1 Then ' we only have a "seller"

                            sSellerLine = ACInfo1 + CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo

                            ACInfo2 = finish_aircraft_info_seller_purchaser_30_31(isHistorical, currentRow)

                            strInFavorOf = ReturnInFavorOfInformation(inACID, lCompId, False)

                            ReturnCompanyInformation_Report(0, 0, Nothing, CompPhoneInfo, CompInfo, True)
                            ReturnContactInformation_Report(0, 0, 0, ContactInfo, ContactPhoneInfo)

                            If bHtmlReport Or bExcelReport Then

                                sPurchaserLine = CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo + ACInfo2 + strInFavorOf + txNote + txLessor + txLessee + txSublessee

                            ElseIf bTextCommaReport Then

                                sPurchaserLine = Constants.cCommaDelim + CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo + Constants.cCommaDelim + ACInfo2 + strInFavorOf + Constants.cCommaDelim + txNote + Constants.cCommaDelim + txLessor + txLessee + txSublessee

                            ElseIf bTextTabReport Then

                                sPurchaserLine = vbTab + CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo + vbTab + ACInfo2 + strInFavorOf + vbTab + txNote + vbTab + txLessor + txLessee + txSublessee

                            End If

                            htmlOut.Append(sSellerLine + sPurchaserLine)

                            htmlOut.Append(acNewUsed + acLeaseDate)

                        Else

                            If Not bIsPurchaser Then

                                sSellerLine = ACInfo1 + CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo
                                bIsPurchaser = True

                            Else

                                ACInfo2 = finish_aircraft_info_seller_purchaser_30_31(isHistorical, currentRow)

                                strInFavorOf = ReturnInFavorOfInformation(inACID, lCompId, False)

                                If bHtmlReport Or bExcelReport Then

                                    sPurchaserLine = CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo + ACInfo2 + strInFavorOf + txNote + txLessor + txLessee + txSublessee

                                ElseIf bTextCommaReport Then

                                    sPurchaserLine = Constants.cCommaDelim + CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo + Constants.cCommaDelim + ACInfo2 + strInFavorOf + Constants.cCommaDelim + txNote + Constants.cCommaDelim + txLessor + txLessee + txSublessee

                                ElseIf bTextTabReport Then

                                    sPurchaserLine = vbTab + CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo + vbTab + ACInfo2 + strInFavorOf + vbTab + txNote + vbTab + txLessor + txLessee + txSublessee

                                End If

                                htmlOut.Append(sSellerLine + sPurchaserLine)

                                htmlOut.Append(acNewUsed + acLeaseDate)

                            End If

                        End If

                    Next

                Else

                    ReturnCompanyInformation_Report(0, 0, Nothing, CompPhoneInfo, CompInfo, True)
                    ReturnContactInformation_Report(0, 0, 0, ContactInfo, ContactPhoneInfo)

                    sSellerLine = ACInfo1 + CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo

                    ACInfo2 = finish_aircraft_info_seller_purchaser_30_31(isHistorical, currentRow)

                    strInFavorOf = ReturnInFavorOfInformation(inACID, 0, False)

                    ReturnCompanyInformation_Report(0, 0, Nothing, CompPhoneInfo, CompInfo, True)
                    ReturnContactInformation_Report(0, 0, 0, ContactInfo, ContactPhoneInfo)

                    If bHtmlReport Or bExcelReport Then

                        sPurchaserLine = CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo + ACInfo2 + strInFavorOf + txNote + txLessor + txLessee + txSublessee

                    ElseIf bTextCommaReport Then

                        sPurchaserLine = Constants.cCommaDelim + CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo + Constants.cCommaDelim + ACInfo2 + strInFavorOf + Constants.cCommaDelim + txNote + Constants.cCommaDelim + txLessor + txLessee + txSublessee

                    ElseIf bTextTabReport Then

                        sPurchaserLine = vbTab + CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo + vbTab + ACInfo2 + strInFavorOf + vbTab + txNote + vbTab + txLessor + txLessee + txSublessee

                    End If

                    htmlOut.Append(sSellerLine + sPurchaserLine)

                    htmlOut.Append(acNewUsed + acLeaseDate)

                End If

            Catch SqlException

                HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in GetReferences_SellerPurchaser(ByVal inACID As Long, ByVal inJournalID As Long, ByVal ACInfo1 As String, ByVal isHistorical As Boolean) As String" + SqlException.Message

            Finally


                SqlReader = Nothing

                SqlConn.Dispose()
                SqlConn.Close()
                SqlConn = Nothing

                SqlCommand.Dispose()
                SqlCommand = Nothing
            End Try

        Catch ex As Exception

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in GetReferences_SellerPurchaser(ByVal inACID As Long, ByVal inJournalID As Long, ByVal ACInfo1 As String, ByVal isHistorical As Boolean) As String" + ex.Message

        End Try

        Return htmlOut.ToString

    End Function

    Public Function finish_aircraft_info_seller_purchaser_30_31(ByVal isHistorical As Boolean, ByRef currentRow As DataRow) As String

        Dim ac_year As String = ""
        Dim ac_mfr_year As String = ""
        Dim ac_aport_iata_code As String = ""
        Dim ac_aport_icao_code As String = ""
        Dim ac_aport_name As String = ""
        Dim ac_aport_city As String = ""
        Dim ac_aport_state As String = ""
        Dim ac_aport_country As String = ""
        Dim ac_airframe_tot_hrs As String = ""
        Dim ac_asking As String = ""
        Dim ac_asking_price As String = "0.0"
        Dim ac_list_date As String = ""
        Dim ac_engine_1_tot_hrs As String = ""
        Dim ac_engine_2_tot_hrs As String = ""
        Dim ac_engine_3_tot_hrs As String = ""
        Dim ac_engine_4_tot_hrs As String = ""
        Dim ac_engine_1_soh_hrs As String = ""
        Dim ac_engine_2_soh_hrs As String = ""
        Dim ac_engine_3_soh_hrs As String = ""
        Dim ac_engine_4_soh_hrs As String = ""

        Dim journ_date As String = ""
        Dim journ_subject As String = ""
        Dim journ_subcategory_code As String = ""
        Dim journ_id As String = ""

        Dim priorev_entry_date As String = ""
        Dim priorev_subject As String = ""
        Dim priorev_description As String = ""

        Dim sFractionPercent As String = ""
        Dim sFractionExpiresDate As String = ""

        Dim sLeaseExpireDate As String = ""
        Dim sLeaseExpConfirmDate As String = ""

        Dim htmlOut = New StringBuilder()

        Try


            If Not (IsDBNull(currentRow.Item("ac_mfr_year"))) Then
                ac_mfr_year = currentRow.Item("ac_mfr_year").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("ac_year"))) Then
                ac_year = currentRow.Item("ac_year").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("ac_aport_iata_code"))) Then
                ac_aport_iata_code = currentRow.Item("ac_aport_iata_code").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("ac_aport_icao_code"))) Then
                ac_aport_icao_code = currentRow.Item("ac_aport_icao_code").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("ac_aport_name"))) Then
                ac_aport_name = currentRow.Item("ac_aport_name").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("ac_aport_city"))) Then
                ac_aport_city = currentRow.Item("ac_aport_city").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("ac_aport_state"))) Then
                ac_aport_state = currentRow.Item("ac_aport_state").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("ac_aport_country"))) Then
                ac_aport_country = currentRow.Item("ac_aport_country").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("ac_airframe_tot_hrs"))) Then
                ac_airframe_tot_hrs = currentRow.Item("ac_airframe_tot_hrs").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("ac_engine_1_tot_hrs"))) Then
                ac_engine_1_tot_hrs = currentRow.Item("ac_engine_1_tot_hrs").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("ac_engine_2_tot_hrs"))) Then
                ac_engine_2_tot_hrs = currentRow.Item("ac_engine_2_tot_hrs").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("ac_engine_3_tot_hrs"))) Then
                ac_engine_3_tot_hrs = currentRow.Item("ac_engine_3_tot_hrs").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("ac_engine_4_tot_hrs"))) Then
                ac_engine_4_tot_hrs = currentRow.Item("ac_engine_4_tot_hrs").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("ac_engine_1_soh_hrs"))) Then
                ac_engine_1_soh_hrs = currentRow.Item("ac_engine_1_soh_hrs").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("ac_engine_2_soh_hrs"))) Then
                ac_engine_2_soh_hrs = currentRow.Item("ac_engine_2_soh_hrs").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("ac_engine_3_soh_hrs"))) Then
                ac_engine_3_soh_hrs = currentRow.Item("ac_engine_3_soh_hrs").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("ac_engine_4_soh_hrs"))) Then
                ac_engine_4_soh_hrs = currentRow.Item("ac_engine_4_soh_hrs").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("ac_asking"))) Then
                ac_asking = currentRow.Item("ac_asking").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("ac_asking_price"))) Then
                ac_asking_price = currentRow.Item("ac_asking_price").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("ac_list_date"))) Then
                ac_list_date = FormatDateTime(currentRow.Item("ac_list_date").ToString, DateFormat.ShortDate).Trim
            End If

            If Not (IsDBNull(currentRow.Item("journ_date"))) Then
                journ_date = FormatDateTime(currentRow.Item("journ_date").ToString, DateFormat.ShortDate).Trim
            End If

            If Not (IsDBNull(currentRow.Item("journ_subject"))) Then
                journ_subject = currentRow.Item("journ_subject").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("journ_subcategory_code"))) Then
                journ_subcategory_code = currentRow.Item("journ_subcategory_code").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("journ_id"))) Then
                journ_id = currentRow.Item("journ_id").ToString.Trim
            End If

            If Not isHistorical Then

                If Not (IsDBNull(currentRow.Item("priorev_entry_date"))) Then
                    priorev_entry_date = FormatDateTime(currentRow.Item("priorev_entry_date").ToString, DateFormat.ShortDate).Trim
                End If

                If Not (IsDBNull(currentRow.Item("priorev_subject"))) Then
                    priorev_subject = currentRow.Item("priorev_subject").ToString.Trim
                End If

                If Not (IsDBNull(currentRow.Item("priorev_description"))) Then
                    priorev_description = currentRow.Item("priorev_description").ToString.Trim
                End If

            End If

            If bExcelReport Or bHtmlReport Then

                If Not String.IsNullOrEmpty(ac_mfr_year.Trim) Then
                    htmlOut.Append("<td>" + ac_mfr_year + "</td>")
                Else
                    htmlOut.Append("<td></td>")
                End If

                htmlOut.Append("<td>" + ac_year + "</td>")
                htmlOut.Append("<td>" + ac_aport_iata_code + "</td>")
                htmlOut.Append("<td>" + ac_aport_icao_code + "</td>")
                htmlOut.Append("<td>" + ac_aport_name + "</td>")
                htmlOut.Append("<td>" + ac_aport_city + "</td>")
                htmlOut.Append("<td>" + localFunctions.get_state_name_report(ac_aport_state, ac_aport_country) + "</td>")
                htmlOut.Append("<td>" + ac_aport_state + "</td>")
                htmlOut.Append("<td>" + ac_aport_country + "</td>")
                htmlOut.Append("<td>" + ac_airframe_tot_hrs + "</td>")
                htmlOut.Append("<td>" + ac_engine_1_tot_hrs + "</td>")
                htmlOut.Append("<td>" + ac_engine_2_tot_hrs + "</td>")
                htmlOut.Append("<td>" + ac_engine_3_tot_hrs + "</td>")
                htmlOut.Append("<td>" + ac_engine_4_tot_hrs + "</td>")
                htmlOut.Append("<td>" + ac_engine_1_soh_hrs + "</td>")
                htmlOut.Append("<td>" + ac_engine_2_soh_hrs + "</td>")
                htmlOut.Append("<td>" + ac_engine_3_soh_hrs + "</td>")
                htmlOut.Append("<td>" + ac_engine_4_soh_hrs + "</td>")

                htmlOut.Append("<td>" + journ_date + "</td>")
                htmlOut.Append("<td>" + journ_subject + "</td>")
                htmlOut.Append("<td>" + journ_subcategory_code + "</td>")

                If Not isHistorical Then
                    htmlOut.Append("<td>" + priorev_entry_date + "</td>")
                    htmlOut.Append("<td>" + priorev_subject)

                    If Not String.IsNullOrEmpty(priorev_description) Then
                        htmlOut.Append(" - " + priorev_description + "</td>")
                    Else
                        htmlOut.Append("</td>")
                    End If
                End If

                localFunctions.get_fraction_percent_and_expire_date(journ_id, True, sFractionPercent, sFractionExpiresDate)
                localFunctions.get_lease_expire_and_confirm_date(journ_id, True, sLeaseExpireDate, sLeaseExpConfirmDate)

                htmlOut.Append("<td>" + sFractionPercent + "</td>")
                htmlOut.Append("<td>" + sFractionExpiresDate + "</td>")
                htmlOut.Append("<td>" + sLeaseExpireDate + "</td>")
                htmlOut.Append("<td>" + sLeaseExpConfirmDate + "</td>")

                If Session.Item("localPreferences").AerodexFlag = False Then
                    htmlOut.Append("<td>" + ac_asking + "</td>")
                    If CDbl(ac_asking_price) > 0 Then
                        htmlOut.Append("<td>$" + FormatNumber(ac_asking_price, 0, False, False, True) + "</td>")
                    Else
                        htmlOut.Append("<td>&nbsp;</td>")
                    End If

                    htmlOut.Append("<td class='dateformat'>" + ac_list_date + "</td>")
                End If

            ElseIf bTextCommaReport Then

                htmlOut.Append(Constants.QUOTE + ac_mfr_year + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + ac_year + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + ac_aport_iata_code + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + ac_aport_icao_code + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + ac_aport_name + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + ac_aport_city + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + localFunctions.get_state_name_report(ac_aport_state, ac_aport_country) + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + ac_aport_state + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + ac_aport_country + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + ac_airframe_tot_hrs + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + ac_engine_1_tot_hrs + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + ac_engine_2_tot_hrs + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + ac_engine_3_tot_hrs + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + ac_engine_4_tot_hrs + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + ac_engine_1_soh_hrs + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + ac_engine_2_soh_hrs + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + ac_engine_3_soh_hrs + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + ac_engine_4_soh_hrs + Constants.QUOTE + Constants.cCommaDelim)

                htmlOut.Append(Constants.QUOTE + journ_date + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + journ_subject + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + journ_subcategory_code + Constants.QUOTE + Constants.cCommaDelim)

                If Not isHistorical Then

                    htmlOut.Append(Constants.QUOTE + priorev_entry_date + Constants.QUOTE + Constants.cCommaDelim)
                    htmlOut.Append(Constants.QUOTE + priorev_subject)

                    If Not String.IsNullOrEmpty(priorev_description) Then
                        htmlOut.Append(" - " + priorev_description + Constants.QUOTE + Constants.cCommaDelim)
                    Else
                        htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                    End If

                End If

                localFunctions.get_fraction_percent_and_expire_date(journ_id, True, sFractionPercent, sFractionExpiresDate)
                localFunctions.get_lease_expire_and_confirm_date(journ_id, True, sLeaseExpireDate, sLeaseExpConfirmDate)

                htmlOut.Append(Constants.QUOTE + sFractionPercent + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + sFractionExpiresDate + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + sLeaseExpireDate + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + sLeaseExpConfirmDate + Constants.QUOTE + Constants.cCommaDelim)

                If Session.Item("localPreferences").AerodexFlag = False Then
                    htmlOut.Append(Constants.QUOTE + ac_asking + Constants.QUOTE + Constants.cCommaDelim)
                    If CDbl(ac_asking_price) > 0 Then
                        htmlOut.Append(Constants.QUOTE + "$" + FormatNumber(ac_asking_price, 0, False, False, True) + Constants.QUOTE + Constants.cCommaDelim)
                    Else
                        htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                    End If

                    htmlOut.Append(Constants.QUOTE + ac_list_date + Constants.QUOTE + Constants.cCommaDelim)
                End If

            ElseIf bTextTabReport Then

                htmlOut.Append(ac_mfr_year + vbTab)
                htmlOut.Append(ac_year + vbTab)
                htmlOut.Append(ac_aport_iata_code + vbTab)
                htmlOut.Append(ac_aport_icao_code + vbTab)
                htmlOut.Append(ac_aport_name + vbTab)
                htmlOut.Append(ac_aport_city + vbTab)
                htmlOut.Append(localFunctions.get_state_name_report(ac_aport_state, ac_aport_country) + vbTab)
                htmlOut.Append(ac_aport_state + vbTab)
                htmlOut.Append(ac_aport_country + vbTab)
                htmlOut.Append(ac_airframe_tot_hrs + vbTab)
                htmlOut.Append(ac_engine_1_tot_hrs + vbTab)
                htmlOut.Append(ac_engine_2_tot_hrs + vbTab)
                htmlOut.Append(ac_engine_3_tot_hrs + vbTab)
                htmlOut.Append(ac_engine_4_tot_hrs + vbTab)
                htmlOut.Append(ac_engine_1_soh_hrs + vbTab)
                htmlOut.Append(ac_engine_2_soh_hrs + vbTab)
                htmlOut.Append(ac_engine_3_soh_hrs + vbTab)
                htmlOut.Append(ac_engine_4_soh_hrs + vbTab)

                htmlOut.Append(journ_date + vbTab)
                htmlOut.Append(journ_subject + vbTab)
                htmlOut.Append(journ_subcategory_code + vbTab)

                If Not isHistorical Then

                    htmlOut.Append(priorev_entry_date + vbTab)
                    htmlOut.Append(priorev_subject)

                    If Not String.IsNullOrEmpty(priorev_description) Then
                        htmlOut.Append(" - " + priorev_description + vbTab)
                    Else
                        htmlOut.Append(vbTab)
                    End If

                End If

                localFunctions.get_fraction_percent_and_expire_date(journ_id, True, sFractionPercent, sFractionExpiresDate)
                localFunctions.get_lease_expire_and_confirm_date(journ_id, True, sLeaseExpireDate, sLeaseExpConfirmDate)

                htmlOut.Append(sFractionPercent + vbTab)
                htmlOut.Append(sFractionExpiresDate + vbTab)
                htmlOut.Append(sLeaseExpireDate + vbTab)
                htmlOut.Append(sLeaseExpConfirmDate + vbTab)

                If Session.Item("localPreferences").AerodexFlag = False Then
                    htmlOut.Append(ac_asking + vbTab)
                    If CDbl(ac_asking_price) > 0 Then
                        htmlOut.Append("$" + FormatNumber(ac_asking_price, 0, False, False, True) + vbTab)
                    Else
                        htmlOut.Append(vbTab)
                    End If

                    htmlOut.Append(ac_list_date + vbTab)
                End If

            End If

        Catch ex As Exception

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in FinishAircraftInfo_SellerPurchaser(ByVal isHistorical As Boolean, ByRef currentRow As DataRow) As String" + ex.Message

        End Try

        Return htmlOut.ToString

    End Function

#End Region

#Region "report_32_functions"

    Public Function create_report_32_aircraft_company_fractional_information(ByRef record_count As Long) As String

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim report_32_datatable As New DataTable

        Dim adoRS_32 As System.Data.SqlClient.SqlDataReader : adoRS_32 = Nothing

        Dim htmlOut = New StringBuilder()
        Dim sQuery As New StringBuilder()

        Try

            SqlConn.ConnectionString = localFunctions.clientConnectStr

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 90

            If HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("comp_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("contact_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("cref_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("state_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("country_") Then
                sQuery.Append("SELECT DISTINCT amod_make_name, amod_airframe_type_code, amod_type_code, amod_id, amod_model_name, ac_ser_no_sort, ac_ser_no_full, ac_reg_no, ac_id, ac_journ_id FROM View_Aircraft_Company_Flat WITH(NOLOCK) ")
            Else
                sQuery.Append("SELECT DISTINCT amod_make_name, amod_airframe_type_code, amod_type_code, amod_id, amod_model_name, ac_ser_no_sort, ac_ser_no_full, ac_reg_no, ac_id, ac_journ_id FROM View_Aircraft_Flat WITH(NOLOCK) ")
            End If

            sQuery.Append(HttpContext.Current.Session.Item("MasterAircraftWhere").ToString)
            sQuery.Append("ORDER BY amod_make_name, amod_airframe_type_code, amod_type_code, amod_id, amod_model_name, ac_ser_no_sort, ac_ser_no_full, ac_reg_no, ac_id")

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />create_report_32_aircraft_company_fractional_information() As String<br />" + sQuery.ToString

            If bHtmlReport Then
                htmlOut.Append("<!DOCTYPE html>")
                htmlOut.Append("<html lang='en'>")
                htmlOut.Append("<head>")
                htmlOut.Append("<meta http-equiv='Content-Language' content='en-us' />")
                htmlOut.Append("<meta http-equiv='Content-Type' content='text/html; charset=windows-1252' />")
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='common/jetnet.css' />")
                htmlOut.Append("<title>JETNET - Fractional Information Report</title>")
                htmlOut.Append("</head>")
                htmlOut.Append("<body style='background: white; margin-top:10px; margin-left:10px;'>")
                htmlOut.Append("<div style='text-align:center;'>")
            End If

            If bExcelReport Then
                htmlOut.Append(localFunctions.include_excel_report_style() + vbCrLf)
                htmlOut.Append("<table border='1' cellpadding='2' cellspacing='0'>")
            ElseIf bHtmlReport Then
                htmlOut.Append("<table class='centerTable' border='0' cellpadding='2' cellspacing='0' width='100%'>")
            End If

            SqlCommand.CommandText = sQuery.ToString
            adoRS_32 = SqlCommand.ExecuteReader()

            Try
                report_32_datatable.Load(adoRS_32)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = report_32_datatable.GetErrors()
            End Try

            adoRS_32.Close()

            record_count = report_32_datatable.Rows.Count

            If report_32_datatable.Rows.Count > 0 Then

                If chkShowReportHeader.Checked Then

                    If bExcelReport Or bHtmlReport Then

                        htmlOut.Append("<tr bgcolor='#CCCCCC'>")

                        htmlOut.Append("<td>MAKE</td>")
                        htmlOut.Append("<td>MODEL</td>")
                        htmlOut.Append("<td>SERIALNBR</td>")
                        htmlOut.Append("<td>REGNBR</td>")

                        htmlOut.Append("<td>RELATION</td>")
                        htmlOut.Append("<td>BUSINESSTYPE</td>")
                        htmlOut.Append("<td>COMPANY</td>")
                        htmlOut.Append("<td>COMPALTNAME</td>")
                        htmlOut.Append("<td>COMPEMAIL</td>")
                        htmlOut.Append("<td>COMPWEBADDRESS</td>")
                        htmlOut.Append("<td>COMPADDRESS1</td>")
                        htmlOut.Append("<td>COMPADDRESS2</td>")
                        htmlOut.Append("<td>COMPCITY</td>")
                        htmlOut.Append("<td>COMPSTATE</td>")
                        htmlOut.Append("<td>COMPSTATEABBR</td>")
                        htmlOut.Append("<td>COMPPOSTALCODE</td>")
                        htmlOut.Append("<td>COMPCOUNTRY</td>")
                        htmlOut.Append("<td>COMPOFFICE</td>")
                        htmlOut.Append("<td>COMPFAX</td>")
                        htmlOut.Append("<td>COMPMOBILE</td>")

                        htmlOut.Append("<td>CONTACTPREFIX</td>")
                        htmlOut.Append("<td>CONTACTFIRSTNAME</td>")
                        htmlOut.Append("<td>CONTACTMI</td>")
                        htmlOut.Append("<td>CONTACTLASTNAME</td>")
                        htmlOut.Append("<td>CONTACTSUFFIX</td>")
                        htmlOut.Append("<td>CONTACTTITLE</td>")
                        htmlOut.Append("<td>CONTACTEMAILADDRESS</td>")
                        htmlOut.Append("<td>CONTACTOFFICE</td>")
                        htmlOut.Append("<td>CONTACTFAX</td>")
                        htmlOut.Append("<td>CONTACTMOBILE</td>")

                        htmlOut.Append("<td>ORIGINALFRACTIONPURCHASEDATE</td>")
                        htmlOut.Append("<td>LASTFRACTIONPURCHASEDATE</td>")
                        htmlOut.Append("<td>FRACTIONPERCENTOWNED</td>")
                        htmlOut.Append("<td>FRACTIONEXPIRESDATE</td>")
                        htmlOut.Append("<td>PROGRAMMANAGER</td>")
                        htmlOut.Append("<td>PROGRAMHOLDER</td>")

                        htmlOut.Append("</tr>")

                    ElseIf bTextCommaReport Then
                        htmlOut.Append(Constants.QUOTE + "MAKE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "MODEL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SERIALNBR" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "REGNBR" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "RELATION" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BUSINESSTYPE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPANY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPALTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPEMAIL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPWEBADDRESS" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPADDRESS1" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPADDRESS2" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPCITY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPSTATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPSTATEABBR" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPPOSTALCODE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPCOUNTRY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPOFFICEE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPFAX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPMOBILE" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "CONTACTPREFIX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACTFIRSTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACTMI" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACTLASTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACTSUFFIX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACTTITLE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACTEMAILADDRESS" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACTOFFICE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACTFAX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CONTACTMOBILE" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "ORIGINALFRACTIONPURCHASEDATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "LASTFRACTIONPURCHASEDATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "FRACTIONPERCENTOWNED" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "FRACTIONEXPIRESDATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PROGRAMMANAGER" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PROGRAMHOLDER" + Constants.QUOTE)

                        htmlOut.Append(vbCrLf)

                    ElseIf bTextTabReport Then

                        htmlOut.Append("MAKE" + vbTab)
                        htmlOut.Append("MODEL" + vbTab)
                        htmlOut.Append("SERIALNBR" + vbTab)
                        htmlOut.Append("REGNBR" + vbTab)

                        htmlOut.Append("RELATION" + vbTab)
                        htmlOut.Append("BUSINESSTYPE" + vbTab)
                        htmlOut.Append("COMPANY" + vbTab)
                        htmlOut.Append("COMPALTNAME" + vbTab)
                        htmlOut.Append("COMPEMAIL" + vbTab)
                        htmlOut.Append("COMPWEBADDRESS" + vbTab)
                        htmlOut.Append("COMPADDRESS1" + vbTab)
                        htmlOut.Append("COMPADDRESS2" + vbTab)
                        htmlOut.Append("COMPCITY" + vbTab)
                        htmlOut.Append("COMPSTATE" + vbTab)
                        htmlOut.Append("COMPSTATEABBR" + vbTab)
                        htmlOut.Append("COMPPOSTALCODE" + vbTab)
                        htmlOut.Append("COMPCOUNTRY" + vbTab)
                        htmlOut.Append("COMPOFFICE" + vbTab)
                        htmlOut.Append("COMPFAX" + vbTab)
                        htmlOut.Append("COMPMOBILE" + vbTab)

                        htmlOut.Append("CONTACTPREFIX" + vbTab)
                        htmlOut.Append("CONTACTFIRST NAME" + vbTab)
                        htmlOut.Append("CONTACTMI" + vbTab)
                        htmlOut.Append("CONTACTLAST NAME" + vbTab)
                        htmlOut.Append("CONTACTSUFFIX" + vbTab)
                        htmlOut.Append("CONTACTTITLE" + vbTab)
                        htmlOut.Append("CONTACTEMAILADDRESS" + vbTab)
                        htmlOut.Append("CONTACTOFFICE" + vbTab)
                        htmlOut.Append("CONTACTFAX" + vbTab)
                        htmlOut.Append("CONTACTMOBILE" + vbTab)

                        htmlOut.Append("ORIGINALFRACTIONPURCHASEDATE" + vbTab)
                        htmlOut.Append("LASTFRACTIONPURCHASEDATE" + vbTab)
                        htmlOut.Append("FRACTIONPERCENTOWNED" + vbTab)
                        htmlOut.Append("FRACTIONEXPIRESDATE" + vbTab)
                        htmlOut.Append("PROGRAMMANAGER" + vbTab)
                        htmlOut.Append("PROGRAMHOLDER")

                        htmlOut.Append(vbCrLf)

                    End If 'vbTab

                End If ' chkShowReportHeader.Checked Then

                For Each Row As DataRow In report_32_datatable.Rows

                    htmlOut.Append(get_references_32(Row))

                Next

                If bHtmlReport Or bExcelReport Then
                    htmlOut.Append("</table>")
                End If

                If bHtmlReport Then
                    htmlOut.Append("</div>")
                    htmlOut.Append("</body>")
                    htmlOut.Append("</html>")
                End If

            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in create_report_32_aircraft_company_fractional_information() As String" + ex.Message
        Finally
            adoRS_32 = Nothing

            report_32_datatable = Nothing

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOut.ToString
        htmlOut = Nothing

    End Function

    Public Function get_references_32(ByVal currentRow As DataRow) As String

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim report_32_ref_datatable As New DataTable

        Dim adoRS_32_ref As System.Data.SqlClient.SqlDataReader : adoRS_32_ref = Nothing

        Dim htmlOut = New StringBuilder()
        Dim sQuery As New StringBuilder()

        Dim strBusinessType As String = ""
        Dim nFractionPercentOwned As Double = 0.0
        Dim strFractionExpiresDate As String = ""
        Dim strCompBusinessType As String = ""
        Dim strCompBusinessTypeName As String = ""
        Dim strCompAcReference As String = ""

        Dim acInfo As String = ""
        Dim CompInfo As String = ""
        Dim CompPhoneInfo As String = ""
        Dim ContactInfo As String = ""
        Dim ContactPhoneInfo As String = ""
        Dim strFractionalInfo As String = ""

        Dim nRememberContactID As Long = 0

        Dim sTmpCompanyName As String = ""
        Dim strProgramManagerName As String = ""
        Dim strProgramHolderName As String = ""
        Dim LastFractionPurchaseDate As String = ""
        Dim OriginalFractionPurchaseDate As String = ""

        Try

            If Not IsNothing(HttpContext.Current.Session.Item("searchCriteria").SearchCriteriaCompanyBusinessType) Then
                If Not String.IsNullOrEmpty(HttpContext.Current.Session.Item("searchCriteria").SearchCriteriaCompanyBusinessType.ToString.Trim) Then
                    strBusinessType = HttpContext.Current.Session.Item("searchCriteria").SearchCriteriaCompanyBusinessType.ToString.Trim
                End If
            End If

            If Not IsNothing(HttpContext.Current.Session.Item("Advanced-cref_business_type")) Then
                If Not String.IsNullOrEmpty(HttpContext.Current.Session.Item("Advanced-cref_business_type").ToString.Trim) Then
                    strBusinessType = HttpContext.Current.Session.Item("Advanced-cref_business_type").ToString.Trim
                End If
            End If

            sQuery.Append("SELECT cref_id, cref_comp_id, cref_contact_id, cref_owner_percent, cref_fraction_expires_date, cref_contact_type, cref_business_type,")
            sQuery.Append(" cbus_name, actype_name, comp_name, comp_name_alt_type, comp_name_alt, comp_city, comp_state, comp_zip_code,")
            sQuery.Append(" comp_email_address, comp_web_address, comp_address1, comp_address2, comp_country, state_name,")

            sQuery.Append(" (SELECT TOP 1 journ_date FROM Aircraft_Reference WITH(NOLOCK)")
            sQuery.Append(" INNER JOIN Journal WITH(NOLOCK) ON (cref_journ_id = journ_id AND cref_ac_id = journ_ac_id)")
            sQuery.Append(" WHERE ((cref_contact_type = '70')")                 ' Purchaser
            sQuery.Append(" AND (cref_ac_id = " + currentRow.Item("ac_id").ToString + ") ")

            sQuery.Append(" and  (acr.cref_fraction_expires_date > journ_date)   ")

            sQuery.Append(" And (cref_comp_id = acr.cref_comp_id) ")
            sQuery.Append(" And (cref_journ_id <> 0)) ORDER BY journ_date asc) As original_purchase_date ")


            sQuery.Append(", (SELECT TOP 1 journ_date FROM Aircraft_Reference WITH(NOLOCK)")
            sQuery.Append(" INNER JOIN Journal WITH(NOLOCK) ON (cref_journ_id = journ_id AND cref_ac_id = journ_ac_id)")
            sQuery.Append(" WHERE ((cref_contact_type = '70')")                 ' Purchaser
            sQuery.Append(" AND (cref_ac_id = " + currentRow.Item("ac_id").ToString + ") ")

            sQuery.Append(" and  (acr.cref_fraction_expires_date > journ_date)   ")

            sQuery.Append(" And (cref_comp_id = acr.cref_comp_id) ")
            sQuery.Append(" And (cref_journ_id <> 0)) ORDER BY journ_date DESC) As last_purchase_date ")






            sQuery.Append(" FROM Aircraft_Reference As acr With(NOLOCK)")
            sQuery.Append(" INNER JOIN Company With(NOLOCK) On (cref_comp_id = comp_id And cref_journ_id = comp_journ_id)")
            sQuery.Append(" LEFT OUTER JOIN State With (NOLOCK) On (comp_state = state_code And comp_country = state_country)")
            sQuery.Append(" LEFT OUTER JOIN Country With (NOLOCK) On country_name = state_country  ") ' added MSW - 5/14/19
            sQuery.Append(" INNER JOIN Aircraft_Contact_Type With(NOLOCK) On (cref_contact_type = actype_code)")
            sQuery.Append(" INNER JOIN Company_Business_Type With(NOLOCK) On (cref_business_type = cbus_type)")


            If Not String.IsNullOrEmpty(strBusinessType.Trim) Then
                sQuery.Append(" LEFT OUTER JOIN Business_Type_Reference With(NOLOCK) On (bustypref_comp_id = comp_id And bustypref_journ_id = comp_journ_id)")
            End If

            sQuery.Append(" WHERE (cref_ac_id = " + currentRow.Item("ac_id").ToString + " And cref_journ_id = 0")
            sQuery.Append(" And comp_active_flag = 'Y' AND comp_hide_flag = 'N'")

            ' Hide Exclusive Brokers and Representatives and Dealers from Aerodex users
            If bAerodexFlag Then
                sQuery.Append(" AND (cref_contact_type NOT IN ('93','98','99','66','67','68','71'))")
            Else
                sQuery.Append(" AND (cref_contact_type NOT IN ('66','67','68','71'))")
            End If

            If Not IsNothing(HttpContext.Current.Session.Item("Advanced-COMPARE_cref_fraction_expires_date")) Then
                If Not String.IsNullOrEmpty(HttpContext.Current.Session.Item("Advanced-COMPARE_cref_fraction_expires_date")) Then
                    If Not IsNothing(HttpContext.Current.Session.Item("Advanced-cref_fraction_expires_date")) Then

                        If Not String.IsNullOrEmpty(HttpContext.Current.Session.Item("Advanced-cref_fraction_expires_date")) Then

                            Dim FractionalDate As String = HttpContext.Current.Session.Item("Advanced-cref_fraction_expires_date").ToString
                            Dim FractionalDateOperator As String = HttpContext.Current.Session.Item("Advanced-COMPARE_cref_fraction_expires_date").ToString

                            sQuery.Append(" AND cref_fraction_expires_date " + clsGeneral.clsGeneral.PrepQueryString(FractionalDateOperator, FractionalDate, "Date", False, "cref_fraction_expires_date", True))

                        End If

                    End If
                End If
            End If

            'If Not IsNothing(HttpContext.Current.Session.Item("Advanced-cref_contact_type")) Then

            '  If Not String.IsNullOrEmpty(HttpContext.Current.Session.Item("Advanced-cref_contact_type").ToString.Trim) Then

            '    ' special case for "operator"
            '    If HttpContext.Current.Session.Item("Advanced-cref_contact_type").ToString.ToUpper.Contains("Y") Then
            '      sQuery.Append(" AND cref_operator_flag IN ('Y', 'O')")
            '    Else

            '      If Not IsNothing(HttpContext.Current.Session.Item("Advanced-comp_not_in_selected")) Then

            '        If Not String.IsNullOrEmpty(HttpContext.Current.Session.Item("Advanced-comp_not_in_selected")) Then
            '          sQuery.Append(" AND cref_contact_type NOT IN ('" + Replace(HttpContext.Current.Session.Item("Advanced-cref_contact_type").ToString, Constants.cDymDataSeperator, Constants.cValueSeperator) + "')")
            '        Else
            '          sQuery.Append(" AND cref_contact_type IN ('" + Replace(HttpContext.Current.Session.Item("Advanced-cref_contact_type").ToString, Constants.cDymDataSeperator, Constants.cValueSeperator) + "')")
            '        End If

            '      Else
            '        sQuery.Append(" AND cref_contact_type IN ('" + Replace(HttpContext.Current.Session.Item("Advanced-cref_contact_type").ToString, Constants.cDymDataSeperator, Constants.cValueSeperator) + "')")
            '      End If

            '    End If

            '  End If

            'End If


            If Not String.IsNullOrEmpty(HttpContext.Current.Session.Item("MasterAircraftCompany").ToString.Trim) Then

                sQuery.Append(Constants.cAndClause + HttpContext.Current.Session.Item("MasterAircraftCompany").ToString.Trim)

            End If


            sQuery.Append(" " + commonEvo.MakeCompanyProductCodeClause(HttpContext.Current.Session.Item("localPreferences"), False))

            sQuery.Append(") ORDER BY cref_transmit_seq_no, comp_name")

            SqlConn.ConnectionString = localFunctions.clientConnectStr

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 90

            'HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />GetReferences32(ByVal currentRow As DataRow, ByVal inACInfo As String) As String<br />" + sQuery.ToString

            SqlCommand.CommandText = sQuery.ToString
            adoRS_32_ref = SqlCommand.ExecuteReader()

            Try
                report_32_ref_datatable.Load(adoRS_32_ref)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = report_32_ref_datatable.GetErrors()
            End Try

            adoRS_32_ref.Close()

            If report_32_ref_datatable.Rows.Count > 0 Then

                If bHtmlReport Or bExcelReport Then

                    acInfo = "<tr><td>" + currentRow.Item("amod_make_name").ToString.Trim + "</td>"
                    acInfo += "<td>" + currentRow.Item("amod_model_name").ToString.Trim + "</td>"
                    acInfo += "<td class='textformat'>" + currentRow.Item("ac_ser_no_full").ToString.Trim + "</td>"
                    acInfo += "<td class='textformat'>" + currentRow.Item("ac_reg_no").ToString.Trim + "</td>"

                ElseIf bTextCommaReport Then

                    acInfo = Constants.QUOTE + currentRow.Item("amod_make_name").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim
                    acInfo += Constants.QUOTE + currentRow.Item("amod_model_name").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim
                    acInfo += Constants.QUOTE + currentRow.Item("ac_ser_no_full").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim
                    acInfo += Constants.QUOTE + currentRow.Item("ac_reg_no").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim

                ElseIf bTextTabReport Then

                    acInfo = currentRow.Item("amod_make_name").ToString.Trim + vbTab
                    acInfo += currentRow.Item("amod_model_name").ToString.Trim + vbTab
                    acInfo += currentRow.Item("ac_ser_no_full").ToString.Trim + vbTab
                    acInfo += currentRow.Item("ac_reg_no").ToString.Trim + vbTab

                End If

                For Each tmpRow As DataRow In report_32_ref_datatable.Rows

                    If Not IsDBNull(tmpRow.Item("comp_name")) Then
                        If Not String.IsNullOrEmpty(tmpRow.Item("comp_name").ToString.Trim) Then
                            sTmpCompanyName = tmpRow.Item("comp_name").ToString
                        End If
                    End If

                    ' ramble through the data set and get the program manager company name
                    If ((tmpRow.Item("cref_contact_type").ToString = "18" Or tmpRow.Item("cref_contact_type").ToString = "36") And tmpRow.Item("cref_business_type").ToString = "PM") Then
                        strProgramManagerName = sTmpCompanyName
                    End If

                    ' ramble through the data set and get the program holder company name
                    If (tmpRow.Item("cref_contact_type").ToString = "17" Or tmpRow.Item("cref_business_type").ToString = "PH") Then
                        strProgramHolderName = sTmpCompanyName
                    End If

                Next

                ' if either is blank then go and Get name.
                If String.IsNullOrEmpty(strProgramManagerName.Trim) Then
                    strProgramManagerName = localFunctions.get_fractional_program_holder_manager(CLng(currentRow.Item("ac_id").ToString.Trim), CLng(currentRow.Item("ac_journ_id").ToString.Trim), True)
                End If

                If String.IsNullOrEmpty(strProgramHolderName.Trim) Then
                    strProgramHolderName = localFunctions.get_fractional_program_holder_manager(CLng(currentRow.Item("ac_id").ToString.Trim), CLng(currentRow.Item("ac_journ_id").ToString.Trim), False)
                End If

                For Each Row As DataRow In report_32_ref_datatable.Rows

                    If Not IsDBNull(Row.Item("actype_name")) Then
                        If Not String.IsNullOrEmpty(Row.Item("actype_name").ToString.Trim) Then
                            strCompAcReference = Row.Item("actype_name").ToString
                        End If
                    End If

                    If Not IsDBNull(Row.Item("cbus_name")) Then
                        If Not String.IsNullOrEmpty(Row.Item("cbus_name").ToString.Trim) Then
                            strCompBusinessTypeName = Row.Item("cbus_name").ToString
                        End If
                    End If

                    If Not IsDBNull(Row.Item("cref_business_type")) Then
                        If Not String.IsNullOrEmpty(Row.Item("cref_business_type").ToString.Trim) Then
                            strCompBusinessType = Row.Item("cref_business_type").ToString
                        End If
                    End If

                    If Not IsDBNull(Row.Item("cref_owner_percent")) Then
                        If Not String.IsNullOrEmpty(Row.Item("cref_owner_percent").ToString.Trim) Then
                            nFractionPercentOwned = CDbl(Row.Item("cref_owner_percent").ToString)
                        End If
                    End If

                    If Not IsDBNull(Row.Item("cref_fraction_expires_date")) Then
                        If Not String.IsNullOrEmpty(Row.Item("cref_fraction_expires_date").ToString.Trim) Then
                            strFractionExpiresDate = Row.Item("cref_fraction_expires_date").ToString
                        End If
                    End If

                    'If Not IsDBNull(Row.Item("fraction_purchase_date")) Then
                    '  If Not String.IsNullOrEmpty(Row.Item("fraction_purchase_date").ToString.Trim) Then
                    '    strFractionPurchaseDate = Row.Item("fraction_purchase_date").ToString
                    '  End If
                    'End If

                    If bHtmlReport Or bExcelReport Then
                        htmlOut.Append(acInfo + "<td nowrap='nowrap'>" + strCompAcReference + "</td>")
                        htmlOut.Append("<td nowrap='nowrap'>" + strCompBusinessTypeName + "</td>")
                    ElseIf bTextCommaReport Then
                        htmlOut.Append(acInfo + Constants.QUOTE + strCompAcReference + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + strCompBusinessTypeName + Constants.QUOTE + Constants.cCommaDelim)
                    ElseIf bTextTabReport Then
                        htmlOut.Append(acInfo + strCompAcReference + vbTab)
                        htmlOut.Append(strCompBusinessTypeName + vbTab)
                    End If

                    ReturnCompanyInformation_Report(CLng(Row.Item("cref_comp_id").ToString), 0, Row, CompPhoneInfo, CompInfo, True)

                    If Not IsDBNull(Row.Item("last_purchase_date")) Then
                        If Not String.IsNullOrEmpty(Row.Item("last_purchase_date").ToString.Trim) Then
                            LastFractionPurchaseDate = Row.Item("last_purchase_date").ToString
                        End If
                    End If

                    If Not IsDBNull(Row.Item("original_purchase_date")) Then
                        If Not String.IsNullOrEmpty(Row.Item("original_purchase_date").ToString.Trim) Then
                            OriginalFractionPurchaseDate = Row.Item("original_purchase_date").ToString
                        End If
                    End If


                    If (strBusinessType.ToUpper <> "PM") And (strBusinessType.ToUpper <> "PH") And (strBusinessType.ToUpper <> "PN") Then
                        strFractionalInfo = display_aircraft_fractional_information32(strProgramManagerName, strProgramHolderName, OriginalFractionPurchaseDate, LastFractionPurchaseDate, nFractionPercentOwned, strFractionExpiresDate)
                    Else
                        strFractionalInfo = display_aircraft_fractional_information32(strProgramManagerName, strProgramHolderName, "", "", nFractionPercentOwned, strFractionExpiresDate)
                    End If

                    If CLng(Row.Item("cref_contact_id").ToString) > 0 Then
                        If nRememberContactID <> CLng(Row.Item("cref_contact_id").ToString) Then
                            ReturnContactInformation_Report(CLng(Row.Item("cref_comp_id").ToString), CLng(Row.Item("cref_contact_id").ToString), 0, ContactInfo, ContactPhoneInfo)
                            nRememberContactID = CLng(Row.Item("cref_contact_id").ToString)
                        End If

                        htmlOut.Append(CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo + strFractionalInfo)
                    Else
                        ReturnContactInformation_Report(0, 0, 0, ContactInfo, ContactPhoneInfo)
                        htmlOut.Append(CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo + strFractionalInfo)
                    End If

                    If bHtmlReport Or bExcelReport Then
                        htmlOut.Append("</tr>" + vbCrLf) ' Last Field - End Row
                    ElseIf bTextCommaReport Then
                        htmlOut.Append(vbCrLf) ' new line
                    ElseIf bTextTabReport Then
                        htmlOut.Append(vbCrLf) ' new line
                    End If

                    strCompAcReference = ""
                    strCompBusinessTypeName = ""
                    strCompBusinessType = ""
                    nFractionPercentOwned = 0
                    strFractionExpiresDate = ""
                    LastFractionPurchaseDate = ""
                    OriginalFractionPurchaseDate = ""
                    '  strFractionPurchaseDate = ""

                Next

                CompInfo = ""
                CompPhoneInfo = ""
                ContactInfo = ""
                ContactPhoneInfo = ""
                strFractionalInfo = ""
                strProgramManagerName = ""
                strProgramHolderName = ""

            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in get_references_32(ByVal currentRow As DataRow) As String" + ex.Message
        Finally
            adoRS_32_ref = Nothing

            report_32_ref_datatable = Nothing

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOut.ToString
        htmlOut = Nothing

    End Function

    Public Function display_aircraft_fractional_information32(ByVal strProgramManagerName As String, ByVal strProgramHolderName As String, ByVal Original_strFractionPurchaseDate As String, ByVal Last_strFractionPurchaseDate As String, ByVal nFractionPercentOwned As Double, ByVal strFractionExpiresDate As String) As String

        Dim htmlOut = New StringBuilder()

        Try

            ' Create The Return String Value
            If bHtmlReport Or bExcelReport Then

                If Trim(Original_strFractionPurchaseDate) <> "skip" Then
                    If IsDate(Original_strFractionPurchaseDate.Trim) Then
                        htmlOut.Append("<td nowrap='nowrap'>" + FormatDateTime(Original_strFractionPurchaseDate, DateFormat.ShortDate) + "</td>")
                    Else
                        htmlOut.Append("<td nowrap='nowrap'></td>")
                    End If
                End If

                If IsDate(Last_strFractionPurchaseDate.Trim) Then
                    htmlOut.Append("<td nowrap='nowrap'>" + FormatDateTime(Last_strFractionPurchaseDate, DateFormat.ShortDate) + "</td>")
                Else
                    htmlOut.Append("<td nowrap='nowrap'></td>")
                End If


                If nFractionPercentOwned > 0 And nFractionPercentOwned < 100 Then
                    htmlOut.Append("<td nowrap='nowrap'>" + FormatNumber(nFractionPercentOwned, 2, TriState.False, TriState.False, TriState.False).ToString + "</td>")
                Else
                    htmlOut.Append("<td nowrap='nowrap'></td>")
                End If

                If IsDate(strFractionExpiresDate.Trim) Then
                    htmlOut.Append("<td nowrap='nowrap'>" + FormatDateTime(strFractionExpiresDate, DateFormat.ShortDate) + "</td>")
                Else
                    htmlOut.Append("<td nowrap='nowrap'></td>")
                End If

                htmlOut.Append("<td nowrap='nowrap'>" + strProgramManagerName.Trim + "</td>")
                htmlOut.Append("<td nowrap='nowrap'>" + strProgramHolderName.Trim + "</td>")

            ElseIf bTextCommaReport Then

                htmlOut.Append(Constants.cCommaDelim)

                If Trim(Original_strFractionPurchaseDate) <> "skip" Then
                    If IsDate(Original_strFractionPurchaseDate.Trim) Then
                        htmlOut.Append(Constants.QUOTE + FormatDateTime(Original_strFractionPurchaseDate, DateFormat.ShortDate) + Constants.QUOTE + Constants.cCommaDelim)
                    Else
                        htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                    End If
                End If

                If IsDate(Last_strFractionPurchaseDate.Trim) Then
                    htmlOut.Append(Constants.QUOTE + FormatDateTime(Last_strFractionPurchaseDate, DateFormat.ShortDate) + Constants.QUOTE + Constants.cCommaDelim)
                Else
                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                End If

                If nFractionPercentOwned > 0 And nFractionPercentOwned < 100 Then
                    htmlOut.Append(Constants.QUOTE + FormatNumber(nFractionPercentOwned, 2, TriState.False, TriState.False, TriState.False).ToString + Constants.QUOTE + Constants.cCommaDelim)
                Else
                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                End If

                If IsDate(strFractionExpiresDate.Trim) Then
                    htmlOut.Append(Constants.QUOTE + FormatDateTime(strFractionExpiresDate, DateFormat.ShortDate) + Constants.QUOTE + Constants.cCommaDelim)
                Else
                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                End If

                htmlOut.Append(Constants.QUOTE + strProgramManagerName.Trim + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + strProgramHolderName.Trim + Constants.QUOTE) ' Last Field Does NOT Have Comma

            ElseIf bTextTabReport Then

                htmlOut.Append(vbTab)

                If Trim(Original_strFractionPurchaseDate) <> "skip" Then
                    If IsDate(Original_strFractionPurchaseDate.Trim) Then
                        htmlOut.Append(FormatDateTime(Original_strFractionPurchaseDate, DateFormat.ShortDate) + vbTab)
                    Else
                        htmlOut.Append(vbTab)
                    End If
                End If

                If IsDate(Last_strFractionPurchaseDate.Trim) Then
                    htmlOut.Append(FormatDateTime(Last_strFractionPurchaseDate, DateFormat.ShortDate) + vbTab)
                Else
                    htmlOut.Append(vbTab)
                End If

                If nFractionPercentOwned > 0 And nFractionPercentOwned < 100 Then
                    htmlOut.Append(FormatNumber(nFractionPercentOwned, 2, TriState.False, TriState.False, TriState.False).ToString + vbTab)
                Else
                    htmlOut.Append(vbTab)
                End If

                If IsDate(strFractionExpiresDate.Trim) Then
                    htmlOut.Append(FormatDateTime(strFractionExpiresDate, DateFormat.ShortDate) + vbTab)
                Else
                    htmlOut.Append(vbTab)
                End If

                htmlOut.Append(strProgramManagerName.Trim + vbTab)
                htmlOut.Append(strProgramHolderName.Trim) ' Last Field Does NOT Have TAB

            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in display_aircraft_fractional_information32(ByVal strProgramManagerName As String, ByVal strProgramHolderName As String, ByVal strFractionPurchaseDate As String, ByVal nFractionPercentOwned As Double, ByVal strFractionExpiresDate As String) As String" + ex.Message

        End Try

        Return htmlOut.ToString

        htmlOut = Nothing

    End Function

#End Region

#Region "report_33_functions"

    Public Function create_report_33_aircraft_comparison_report(ByRef record_count As Long) As String

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim report_33_datatable As New DataTable

        Dim adoRS_33 As System.Data.SqlClient.SqlDataReader : adoRS_33 = Nothing

        Dim htmlOut = New StringBuilder()
        Dim sQuery As New StringBuilder()
        Dim temp_ac_id As Long = 0

        Dim iMaxFCodes As Integer = 0
        Dim nRecCount As Integer = 0

        Try

            SqlConn.ConnectionString = localFunctions.clientConnectStr

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 90

            If HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("comp_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("contact_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("state_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("country_") Then
                sQuery.Append("SELECT DISTINCT * FROM View_Aircraft_Company_Flat WITH(NOLOCK) ")
            Else
                sQuery.Append("SELECT DISTINCT * FROM View_Aircraft_Flat WITH(NOLOCK) ")
            End If

            sQuery.Append(HttpContext.Current.Session.Item("MasterAircraftWhere").ToString)
            sQuery.Append(" ORDER BY amod_make_name, amod_airframe_type_code, amod_type_code, amod_id, amod_model_name, ac_ser_no_sort")

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />create_report_33_aircraft_comparison_report() As String<br />" + sQuery.ToString

            If bHtmlReport Then
                htmlOut.Append("<!DOCTYPE html>")
                htmlOut.Append("<html lang='en'>")
                htmlOut.Append("<head>")
                htmlOut.Append("<meta http-equiv='Content-Language' content='en-us' />")
                htmlOut.Append("<meta http-equiv='Content-Type' content='text/html; charset=windows-1252' />")
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='common/jetnet.css' />")
                htmlOut.Append("<title>JETNET - Aircraft Comparison Report</title>")
                htmlOut.Append("</head>")
                htmlOut.Append("<body style='background: white; margin-top:10px; margin-left:10px;'>")
                htmlOut.Append("<div style='text-align:center;'>")
            End If

            If bExcelReport Then
                htmlOut.Append(localFunctions.include_excel_report_style() + vbCrLf)
                htmlOut.Append("<table border='1' cellpadding='2' cellspacing='0'><tr>")
            ElseIf bHtmlReport Then
                htmlOut.Append("<table class='centerTable' border='0' cellpadding='2' cellspacing='0' width='100%'><tr>")
            End If

            SqlCommand.CommandText = sQuery.ToString
            adoRS_33 = SqlCommand.ExecuteReader()

            Try
                report_33_datatable.Load(adoRS_33)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = report_33_datatable.GetErrors()
            End Try

            adoRS_33.Close()

            record_count = report_33_datatable.Rows.Count

            If (report_33_datatable.Rows.Count > 0) Then

                Dim acFeatureCount As Integer = 0



                'GET ALL OF THE STANDARD FEATURE CODES FOR ALL OF THE MODELS --------------------------- 
                Dim amod_id_list As String = ""
                Dim ac_id_list As String = ""
                Dim report_33_data As New DataTable

                For Each Row As DataRow In report_33_datatable.Rows
                    ' if the model isnt in the list, then add it to the model list 
                    If InStr(amod_id_list, Row.Item("amod_id") & ",") = 0 Then
                        amod_id_list &= Row.Item("amod_id") & ","
                    End If

                    If Trim(ac_id_list) <> "" Then
                        ac_id_list &= ","
                    End If
                    ac_id_list &= Row.Item("ac_id")
                Next

                'get rid of the last column
                If Trim(amod_id_list) <> "" Then
                    amod_id_list = Left(Trim(amod_id_list), Len(Trim(amod_id_list)) - 1)
                End If
                amod_id_list = amod_id_list

                ReDim feature_code_list(500, 1) ' so we know there will be no issues 

                localFunctions.load_standard_ac_features_report_multiple(amod_id_list, feature_code_list, feature_code_count)

                report_33_data = localFunctions.get_ac_features_report_multiple(amod_id_list, 0, feature_code_list)

                If Not IsNothing(report_33_data) Then
                    If report_33_data.Rows.Count > 0 Then
                        For Each k As DataRow In report_33_data.Rows

                            '  ReDim Preserve feature_code_list(feature_code_count, 1)

                            feature_code_list(feature_code_count, 0) = k.Item("kfeat_code").ToString.Trim.ToUpper
                            feature_code_list(feature_code_count, 1) = k.Item("kfeat_name").ToString.Trim
                            feature_code_count += 1
                        Next
                    End If
                End If
                '----------------- GET THE LIST OF FEATURES -----------------

                iMaxFCodes = feature_code_count - 1
                'For Each Row As DataRow In report_33_datatable.Rows

                '  If nRecCount < 200 Then ' only check first 200 items
                '    acFeatureCount = localFunctions.get_max_feature_codes(CLng(Row.Item("ac_id").ToString))

                '    If iMaxFCodes < acFeatureCount Then
                '      iMaxFCodes = acFeatureCount
                '    End If

                '    nRecCount += 1
                '  Else
                '    Exit For
                '  End If

                'Next

                'iMaxFCodes = iMaxFCodes + iMaxFCodes ' added MSW - most possible different ones 

                nRecCount = 0

                If chkShowReportHeader.Checked Then

                    If bExcelReport Or bHtmlReport Then

                        htmlOut.Append("<td valign='top' align='left'>")
                        htmlOut.Append("<table border='1' cellpadding='2' cellspacing='0'>")

                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>MAKE</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>MODEL</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>SERIALNBR</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>REGNBR</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>YEARMFG</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>YEARDLV</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>PURCHASED</td></tr>")

                        If Not bAerodexFlag Then
                            htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>STATUS</td></tr>")
                            htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>ASKINGPRICE</td></tr>")
                            htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>DELIVERY</td></tr>")
                            htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>LISTED</td></tr>")
                        End If

                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>PASSENGERS</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>AIRFRAMETT</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>LANDINGS</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>ENGINENAME</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>ENGSERNBR</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>ENGTT</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>SMOH</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>TBO</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>ONCONDITION</td></tr>")

                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>ACBASECODE</td></tr>")      ' IATA/ICAO - Name, City, State, Country
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>ACBASENAME</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>ACBASELOCATION</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>INTYEAR</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>INTRATE</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>EXTYEAR</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>EXTRATE</td></tr>")

                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>EMP</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>EMGP</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>AMP</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>AMTP</td></tr>")

                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>COMP1TYPE</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>COMPANY1</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>COMP1LOCATION</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>COMP1CONTACT</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>COMP1TITLE</td></tr>")

                        If Not bAerodexFlag Then
                            htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>COMP2TYPE</td></tr>")
                            htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>COMPANY2</td></tr>")
                            htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>COMP2LOCATION</td></tr>")
                            htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>COMP2CONTACT</td></tr>")
                            htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>COMP2TITLE</td></tr>")

                            htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>COMP3TYPE</td></tr>")
                            htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>COMPANY3</td></tr>")
                            htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>COMP3LOCATION</td></tr>")
                            htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>COMP3CONTACT</td></tr>")
                            htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>COMP3TITLE</td></tr>")
                        End If ' If Session("Aerodex") = False Then


                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>FEATURE - DAM</td></tr>")
                        If iMaxFCodes > 0 Then
                            For iCnt1 As Integer = 0 To iMaxFCodes
                                htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>FEATURE - " + feature_code_list(iCnt1, 1).ToString + "</td></tr>")
                            Next ' iCnt1
                        End If

                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>APUMODEL</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>APUSERNBR</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>APUTOTHRS</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>APUSOHHRS</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>APUSHIHRS</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>APUMAINTPROG</td></tr>")

                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>ADF</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>AFIS</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>ALTIMETER</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>AUTOPILOT</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>AVIONICSPACKAGE</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>COMMS</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>COMPASS</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>CVR</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>DME</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>EFIS</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>FDR</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>FLIGHTDIRECTOR</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>FLIGHTPHONE</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>FMS</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>GPS</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>HIFREQUENCY</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>HSI</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>INS</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>IRS</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>LORAN</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>LRN</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>NAVRADIOS</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>RADARALT</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>RMI</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>RNAV</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>SATCOM</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>STORMSCOPE</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>TAWS</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>TCAD</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>TCAS</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>TRANSPONDER</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>WEATHERRADAR</td></tr>")

                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>DAMAGE</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>DAMAGENOTES</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>EQUIPMENT</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>ADDLCOCKPITEQUIP</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>INTNOTES</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>EXTNOTES</td></tr>")
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>MAINTENANCE</td></tr>")

                        If Not bAerodexFlag Then
                            htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>SEE NOTES</td></tr>")
                        End If

                        If chkIncludeNotes_std.Checked Then
                            htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top'>LOCALNOTES</td></tr>")
                        End If

                        htmlOut.Append("</table></td>")

                    End If

                End If ' chkShowReportHeader.Checked Then


                For Each Row As DataRow In report_33_datatable.Rows

                    If CLng(Row.Item("ac_id").ToString) <> temp_ac_id Then ' if we have changed 
                        If nRecCount < 200 Then ' only show first 200 items
                            htmlOut.Append(get_report_33_data(Row, iMaxFCodes))
                            nRecCount += 1
                        Else
                            Exit For
                        End If
                    Else
                        'dont do anything, its the same aircraft - MSW - 2/21 to stop repeating ac 
                    End If


                    temp_ac_id = CLng(Row.Item("ac_id").ToString)

                Next

                If bHtmlReport Or bExcelReport Then
                    htmlOut.Append("</tr></table>")
                End If

                If bHtmlReport Then
                    htmlOut.Append("</div>")
                    htmlOut.Append("</body>")
                    htmlOut.Append("</html>")
                End If

            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in create_report_33_aircraft_comparison_report() As String" + ex.Message
        Finally

            adoRS_33 = Nothing

            report_33_datatable = Nothing

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOut.ToString

    End Function

    Private Function get_report_33_data(ByVal currentRow As DataRow, ByVal iMaxFCodes As Integer) As String

        Dim strConfidential As String = ""
        Dim strDamageNotes As String = ""
        Dim strDamageYN As String = ""

        Dim htmlOut = New StringBuilder()

        Try

            htmlOut.Append("<td valign='top' align='left'>")
            htmlOut.Append("<table border='1' cellpadding='2' cellspacing='0'>")

            htmlOut.Append(display_report_33_aircraft_information(currentRow, strDamageNotes, strConfidential))
            htmlOut.Append(display_report_33_engine_airframe_emp_emgp_amp_amtp_information(CLng(currentRow.Item("ac_id").ToString)))

            htmlOut.Append(display_report_33_company_information(CLng(currentRow.Item("ac_id").ToString), "OWNER"))

            If Not bAerodexFlag Then
                htmlOut.Append(display_report_33_company_information(CLng(currentRow.Item("ac_id").ToString), "BROKER"))
            End If

            htmlOut.Append(display_report_33_feature_code_information(CLng(currentRow.Item("ac_id").ToString), CLng(currentRow.Item("amod_id").ToString), iMaxFCodes, strDamageYN))

            htmlOut.Append(display_report_33_apu_information(currentRow))

            htmlOut.Append(display_report_33_avionics_information(CLng(currentRow.Item("ac_id").ToString)))

            htmlOut.Append(strDamageYN)
            htmlOut.Append(strDamageNotes)

            Dim sTempString As String = ""

            sTempString = display_report_33_aircraft_details_information(CLng(currentRow.Item("ac_id").ToString), "Equipment")
            htmlOut.Append("<tr><td align='left' valign='top'>" + sTempString.Replace(Constants.cSvrStringSeperator, Constants.cEmptyString).Trim + "</td></tr>")

            sTempString = ""
            sTempString = display_report_33_aircraft_details_information(CLng(currentRow.Item("ac_id").ToString), "Addl Cockpit Equipment")
            htmlOut.Append("<tr><td align='left' valign='top'>" + sTempString.Replace(Constants.cSvrStringSeperator, Constants.cEmptyString).Trim + "</td></tr>")

            sTempString = ""
            sTempString = display_report_33_aircraft_details_information(CLng(currentRow.Item("ac_id").ToString), "Interior")
            htmlOut.Append("<tr><td align='left' valign='top'>" + sTempString.Replace(Constants.cSvrStringSeperator, Constants.cEmptyString).Trim + "</td></tr>")

            sTempString = ""
            sTempString = display_report_33_aircraft_details_information(CLng(currentRow.Item("ac_id").ToString), "Exterior")
            htmlOut.Append("<tr><td align='left' valign='top'>" + sTempString.Replace(Constants.cSvrStringSeperator, Constants.cEmptyString).Trim + "</td></tr>")

            sTempString = ""
            sTempString = display_report_33_aircraft_details_information(CLng(currentRow.Item("ac_id").ToString), "Maintenance")
            htmlOut.Append("<tr><td align='left' valign='top'>" + sTempString.Replace(Constants.cSvrStringSeperator, Constants.cEmptyString).Trim + "</td></tr>")

            If Not bAerodexFlag Then
                htmlOut.Append(strConfidential)
            End If

            If chkIncludeNotes_std.Checked Then
                'add first local note ...
                sTempString = ""
                sTempString = display_report_33_notes_information(CLng(currentRow.Item("ac_id").ToString))
                htmlOut.Append("<tr><td align='left' valign='top'>" + sTempString.Replace(Constants.cSvrStringSeperator, Constants.cSingleSpace).Trim + "</td></tr>")
            End If

            htmlOut.Append("</table></td>")

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in get_report_33_data(ByVal currentRow As DataRow, ByVal iMaxFCodes As Integer) As String" + ex.Message
        End Try

        Return htmlOut.ToString

    End Function

    Private Function display_report_33_aircraft_information(ByVal currentRow As DataRow, ByRef strDamage As String, ByRef strConfidential As String) As String

        Dim htmlOut = New StringBuilder()
        Dim strTemp As String = ""
        Dim bHadCity As Boolean = False

        Try

            If Not IsNothing(currentRow) Then

                ' the current row should have all this ac info on it 
                If Not IsDBNull(currentRow.Item("amod_make_name").ToString.Trim) Then
                    If Not String.IsNullOrEmpty(currentRow.Item("amod_make_name").ToString.Trim) Then
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top' nowrap='nowrap'>" + IIf(Not String.IsNullOrEmpty(currentRow.Item("amod_make_name").ToString.Trim), currentRow.Item("amod_make_name").ToString.Trim, "") + "</td></tr>")
                    Else
                        htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'></td></tr>")
                    End If
                Else
                    htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'></td></tr>")
                End If

                If Not IsDBNull(currentRow.Item("amod_model_name").ToString.Trim) Then
                    If Not String.IsNullOrEmpty(currentRow.Item("amod_model_name").ToString.Trim) Then
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top' nowrap='nowrap'>" + IIf(Not String.IsNullOrEmpty(currentRow.Item("amod_model_name").ToString.Trim), currentRow.Item("amod_model_name").ToString.Trim, "") + "</td></tr>")
                    Else
                        htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'></td></tr>")
                    End If
                Else
                    htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'></td></tr>")
                End If

                If Not IsDBNull(currentRow.Item("ac_ser_no_full").ToString.Trim) Then
                    If Not String.IsNullOrEmpty(currentRow.Item("ac_ser_no_full").ToString.Trim) Then
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top' nowrap='nowrap'>" + IIf(Not String.IsNullOrEmpty(currentRow.Item("ac_ser_no_full").ToString.Trim), currentRow.Item("ac_ser_no_full").ToString.Trim, "") + "</td></tr>")
                    Else
                        htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'></td></tr>")
                    End If
                Else
                    htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'></td></tr>")
                End If

                If Not IsDBNull(currentRow.Item("ac_reg_no").ToString.Trim) Then
                    If Not String.IsNullOrEmpty(currentRow.Item("ac_reg_no").ToString.Trim) Then
                        htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='top' nowrap='nowrap'>" + IIf(Not String.IsNullOrEmpty(currentRow.Item("ac_reg_no").ToString.Trim), currentRow.Item("ac_reg_no").ToString.Trim, "") + "</td></tr>")
                    Else
                        htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'></td></tr>")
                    End If
                Else
                    htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'></td></tr>")
                End If

                If Not IsDBNull(currentRow.Item("ac_mfr_year").ToString.Trim) Then
                    If Not String.IsNullOrEmpty(currentRow.Item("ac_mfr_year").ToString.Trim) Then
                        htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'>" + IIf(Not String.IsNullOrEmpty(currentRow.Item("ac_mfr_year").ToString.Trim), currentRow.Item("ac_mfr_year").ToString.Trim, "") + "</td></tr>")
                    Else
                        htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'></td></tr>")
                    End If
                Else
                    htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'></td></tr>")
                End If

                If Not IsDBNull(currentRow.Item("ac_year").ToString.Trim) Then
                    If Not String.IsNullOrEmpty(currentRow.Item("ac_year").ToString.Trim) Then
                        htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'>" + IIf(Not String.IsNullOrEmpty(currentRow.Item("ac_year").ToString.Trim), currentRow.Item("ac_year").ToString.Trim, "") + "</td></tr>")
                    Else
                        htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'></td></tr>")
                    End If
                Else
                    htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'></td></tr>")
                End If

                If Not IsDBNull(currentRow.Item("ac_purchase_date").ToString.Trim) Then
                    If Not String.IsNullOrEmpty(currentRow.Item("ac_purchase_date").ToString.Trim) Then
                        htmlOut.Append("<tr><td align='left' nowrap='nowrap'>" + IIf(Not String.IsNullOrEmpty(currentRow.Item("ac_purchase_date").ToString.Trim), IIf(IsDate(currentRow.Item("ac_purchase_date").ToString), FormatDateTime(currentRow.Item("ac_purchase_date").ToString.Trim, vbShortDate), currentRow.Item("ac_purchase_date").ToString.Trim), "") + "</td></tr>")
                    Else
                        htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'></td></tr>")
                    End If
                Else
                    htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'></td></tr>")
                End If

                If Not bAerodexFlag Then

                    If Not IsDBNull(currentRow.Item("ac_status").ToString.Trim) Then
                        If Not String.IsNullOrEmpty(currentRow.Item("ac_status").ToString.Trim) Then
                            htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'>" + IIf(Not String.IsNullOrEmpty(currentRow.Item("ac_status").ToString.Trim), currentRow.Item("ac_status").ToString.Trim, "") + "</td></tr>")
                        Else
                            htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'></td></tr>")
                        End If
                    Else
                        htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'></td></tr>")
                    End If

                    If Not IsDBNull(currentRow.Item("ac_asking").ToString.Trim) Then
                        If Not String.IsNullOrEmpty(currentRow.Item("ac_asking").ToString.Trim) Then
                            If currentRow.Item("ac_asking").ToString.Trim.ToLower.Contains("price") Then
                                htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'>" + IIf(Not String.IsNullOrEmpty(currentRow.Item("ac_asking_price").ToString.Trim), "$" + FormatNumber(currentRow.Item("ac_asking_price").ToString.Trim, 0), "") + "</td></tr>")
                            Else
                                htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'>" + IIf(Not String.IsNullOrEmpty(currentRow.Item("ac_asking").ToString.Trim), currentRow.Item("ac_asking").ToString.Trim, "") + "</td></tr>")
                            End If
                        Else
                            htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'></td></tr>")
                        End If
                    Else
                        htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'></td></tr>")
                    End If

                    If Not IsDBNull(currentRow.Item("ac_delivery").ToString.Trim) Then
                        If Not String.IsNullOrEmpty(currentRow.Item("ac_delivery").ToString.Trim) Then
                            strTemp = currentRow.Item("ac_delivery").ToString.Trim
                        End If
                    End If

                    If Not IsDBNull(currentRow.Item("ac_delivery_date").ToString.Trim) Then
                        If Not String.IsNullOrEmpty(currentRow.Item("ac_delivery_date").ToString.Trim) Then
                            htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'>" + IIf(Not String.IsNullOrEmpty(currentRow.Item("ac_delivery_date").ToString.Trim), IIf(IsDate(currentRow.Item("ac_delivery_date").ToString), strTemp.Trim + " - " + FormatDateTime(currentRow.Item("ac_delivery_date").ToString.Trim, vbShortDate), IIf(Not String.IsNullOrEmpty(strTemp.Trim), strTemp.Trim, "")), IIf(Not String.IsNullOrEmpty(strTemp.Trim), strTemp.Trim, "")) + "</td></tr>")
                        Else
                            htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'>" + IIf(Not String.IsNullOrEmpty(strTemp.Trim), strTemp.Trim, "") + "</td></tr>")
                        End If
                    Else
                        htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'>" + IIf(Not String.IsNullOrEmpty(strTemp.Trim), strTemp.Trim, "") + "</td></tr>")
                    End If

                    If Not IsDBNull(currentRow.Item("ac_list_date").ToString.Trim) Then
                        If Not String.IsNullOrEmpty(currentRow.Item("ac_list_date").ToString.Trim) Then
                            htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'>" + IIf(Not String.IsNullOrEmpty(currentRow.Item("ac_list_date").ToString.Trim), IIf(IsDate(currentRow.Item("ac_list_date").ToString), FormatDateTime(currentRow.Item("ac_list_date").ToString.Trim, vbShortDate), currentRow.Item("ac_list_date").ToString.Trim), "") + "</td></tr>")
                        Else
                            htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'></td></tr>")
                        End If
                    Else
                        htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'></td></tr>")
                    End If

                End If

                If Not IsDBNull(currentRow.Item("ac_passenger_count").ToString.Trim) Then
                    If Not String.IsNullOrEmpty(currentRow.Item("ac_passenger_count").ToString.Trim) Then
                        htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'>" + IIf(Not String.IsNullOrEmpty(currentRow.Item("ac_passenger_count").ToString.Trim), currentRow.Item("ac_passenger_count").ToString.Trim, "") + "</td></tr>")
                    Else
                        htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'></td></tr>")
                    End If
                Else
                    htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'></td></tr>")
                End If

                If Not IsDBNull(currentRow.Item("ac_airframe_tot_hrs").ToString.Trim) Then
                    If Not String.IsNullOrEmpty(currentRow.Item("ac_airframe_tot_hrs").ToString.Trim) Then
                        htmlOut.Append("<tr><td align='left' nowrap='nowrap'>" + IIf(Not String.IsNullOrEmpty(currentRow.Item("ac_airframe_tot_hrs").ToString.Trim), currentRow.Item("ac_airframe_tot_hrs").ToString.Trim, "") + "</td></tr>")
                    Else
                        htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'></td></tr>")
                    End If
                Else
                    htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'></td></tr>")
                End If

                If Not IsDBNull(currentRow.Item("ac_airframe_tot_landings").ToString.Trim) Then
                    If Not String.IsNullOrEmpty(currentRow.Item("ac_airframe_tot_landings").ToString.Trim) Then
                        htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'>" + IIf(Not String.IsNullOrEmpty(currentRow.Item("ac_airframe_tot_landings").ToString.Trim), currentRow.Item("ac_airframe_tot_landings").ToString.Trim, "") + "</td></tr>")
                    Else
                        htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'></td></tr>")
                    End If
                Else
                    htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'></td></tr>")
                End If

                If Not IsDBNull(currentRow.Item("ac_engine_name").ToString.Trim) Then
                    If Not String.IsNullOrEmpty(currentRow.Item("ac_engine_name").ToString.Trim) Then
                        htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'>" + IIf(Not String.IsNullOrEmpty(currentRow.Item("ac_engine_name").ToString.Trim), currentRow.Item("ac_engine_name").ToString.Trim, "") + "</td></tr>")
                    Else
                        htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'></td></tr>")
                    End If
                Else
                    htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'></td></tr>")
                End If

                strTemp = ""
                If Not IsDBNull(currentRow.Item("ac_engine_1_ser_no").ToString.Trim) Then
                    If Not String.IsNullOrEmpty(currentRow.Item("ac_engine_1_ser_no").ToString.Trim) Then
                        strTemp = currentRow.Item("ac_engine_1_ser_no").ToString.Trim
                    End If
                End If
                If Not IsDBNull(currentRow.Item("ac_engine_2_ser_no").ToString.Trim) Then
                    If Not String.IsNullOrEmpty(currentRow.Item("ac_engine_2_ser_no").ToString.Trim) Then
                        strTemp += ", " + currentRow.Item("ac_engine_2_ser_no").ToString.Trim
                    End If
                End If
                If Not IsDBNull(currentRow.Item("ac_engine_3_ser_no").ToString.Trim) Then
                    If Not String.IsNullOrEmpty(currentRow.Item("ac_engine_3_ser_no").ToString.Trim) Then
                        strTemp += ", " + currentRow.Item("ac_engine_3_ser_no").ToString.Trim
                    End If
                End If
                If Not IsDBNull(currentRow.Item("ac_engine_4_ser_no").ToString.Trim) Then
                    If Not String.IsNullOrEmpty(currentRow.Item("ac_engine_4_ser_no").ToString.Trim) Then
                        strTemp += ", " + currentRow.Item("ac_engine_4_ser_no").ToString.Trim
                    End If
                End If

                htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'>" + IIf(Not String.IsNullOrEmpty(strTemp.Trim), strTemp.Trim, "") + "</td></tr>")

                strTemp = ""
                If Not IsDBNull(currentRow.Item("ac_engine_1_tot_hrs").ToString.Trim) Then
                    If Not String.IsNullOrEmpty(currentRow.Item("ac_engine_1_tot_hrs").ToString.Trim) Then
                        strTemp = currentRow.Item("ac_engine_1_tot_hrs").ToString.Trim
                    End If
                End If
                If Not IsDBNull(currentRow.Item("ac_engine_2_tot_hrs").ToString.Trim) Then
                    If Not String.IsNullOrEmpty(currentRow.Item("ac_engine_2_tot_hrs").ToString.Trim) Then
                        strTemp += ", " + currentRow.Item("ac_engine_2_tot_hrs").ToString.Trim
                    End If
                End If
                If Not IsDBNull(currentRow.Item("ac_engine_3_tot_hrs").ToString.Trim) Then
                    If Not String.IsNullOrEmpty(currentRow.Item("ac_engine_3_tot_hrs").ToString.Trim) Then
                        strTemp += ", " + currentRow.Item("ac_engine_3_tot_hrs").ToString.Trim
                    End If
                End If
                If Not IsDBNull(currentRow.Item("ac_engine_4_tot_hrs").ToString.Trim) Then
                    If Not String.IsNullOrEmpty(currentRow.Item("ac_engine_4_tot_hrs").ToString.Trim) Then
                        strTemp += ", " + currentRow.Item("ac_engine_4_tot_hrs").ToString.Trim
                    End If
                End If

                htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'>" + IIf(Not String.IsNullOrEmpty(strTemp.Trim), strTemp.Trim, "") + "</td></tr>")

                strTemp = ""
                If Not IsDBNull(currentRow.Item("ac_engine_1_soh_hrs").ToString.Trim) Then
                    If Not String.IsNullOrEmpty(currentRow.Item("ac_engine_1_soh_hrs").ToString.Trim) Then
                        strTemp = currentRow.Item("ac_engine_1_soh_hrs").ToString.Trim
                    End If
                End If
                If Not IsDBNull(currentRow.Item("ac_engine_2_soh_hrs").ToString.Trim) Then
                    If Not String.IsNullOrEmpty(currentRow.Item("ac_engine_2_soh_hrs").ToString.Trim) Then
                        strTemp += ", " + currentRow.Item("ac_engine_2_soh_hrs").ToString.Trim
                    End If
                End If
                If Not IsDBNull(currentRow.Item("ac_engine_3_soh_hrs").ToString.Trim) Then
                    If Not String.IsNullOrEmpty(currentRow.Item("ac_engine_3_soh_hrs").ToString.Trim) Then
                        strTemp += ", " + currentRow.Item("ac_engine_3_soh_hrs").ToString.Trim
                    End If
                End If
                If Not IsDBNull(currentRow.Item("ac_engine_4_soh_hrs").ToString.Trim) Then
                    If Not String.IsNullOrEmpty(currentRow.Item("ac_engine_4_soh_hrs").ToString.Trim) Then
                        strTemp += ", " + currentRow.Item("ac_engine_4_soh_hrs").ToString.Trim
                    End If
                End If

                htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'>" + IIf(Not String.IsNullOrEmpty(strTemp.Trim), strTemp.Trim, "") + "</td></tr>")

                strTemp = ""
                If Not IsDBNull(currentRow.Item("ac_engine_1_tbo_hrs").ToString.Trim) Then
                    If Not String.IsNullOrEmpty(currentRow.Item("ac_engine_1_tbo_hrs").ToString.Trim) Then
                        strTemp = currentRow.Item("ac_engine_1_tbo_hrs").ToString.Trim
                    End If
                End If
                If Not IsDBNull(currentRow.Item("ac_engine_2_tbo_hrs").ToString.Trim) Then
                    If Not String.IsNullOrEmpty(currentRow.Item("ac_engine_2_tbo_hrs").ToString.Trim) Then
                        strTemp += ", " + currentRow.Item("ac_engine_2_tbo_hrs").ToString.Trim
                    End If
                End If
                If Not IsDBNull(currentRow.Item("ac_engine_3_tbo_hrs").ToString.Trim) Then
                    If Not String.IsNullOrEmpty(currentRow.Item("ac_engine_3_tbo_hrs").ToString.Trim) Then
                        strTemp += ", " + currentRow.Item("ac_engine_3_tbo_hrs").ToString.Trim
                    End If
                End If
                If Not IsDBNull(currentRow.Item("ac_engine_4_tbo_hrs").ToString.Trim) Then
                    If Not String.IsNullOrEmpty(currentRow.Item("ac_engine_4_tbo_hrs").ToString.Trim) Then
                        strTemp += ", " + currentRow.Item("ac_engine_4_tbo_hrs").ToString.Trim
                    End If
                End If

                htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'>" + IIf(Not String.IsNullOrEmpty(strTemp.Trim), strTemp.Trim, "") + "</td></tr>")


                Dim sTboOnCondition As String = localFunctions.get_tbo_oncondition(CLng(currentRow.Item("ac_id").ToString))

                htmlOut.Append("<tr><td align='left' nowrap='nowrap'>" + IIf(Not String.IsNullOrEmpty(sTboOnCondition.Trim), sTboOnCondition.Trim, "") + "</td></tr>")

                strTemp = ""
                If Not IsDBNull(currentRow.Item("ac_aport_iata_code").ToString.Trim) Then
                    If Not String.IsNullOrEmpty(currentRow.Item("ac_aport_iata_code").ToString.Trim) Then
                        strTemp = "[" + currentRow.Item("ac_aport_iata_code").ToString.Trim + "]"
                    End If
                End If

                If Not IsDBNull(currentRow.Item("ac_aport_icao_code").ToString.Trim) Then
                    If Not String.IsNullOrEmpty(currentRow.Item("ac_aport_icao_code").ToString.Trim) Then
                        strTemp += " [" + currentRow.Item("ac_aport_icao_code").ToString.Trim + "]"
                    End If
                End If

                htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'>" + IIf(Not String.IsNullOrEmpty(strTemp.Trim), strTemp.Trim, "") + "</td></tr>")

                If Not IsDBNull(currentRow.Item("ac_aport_name").ToString.Trim) Then
                    If Not String.IsNullOrEmpty(currentRow.Item("ac_aport_name").ToString.Trim) Then
                        htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'>" + IIf(Not String.IsNullOrEmpty(currentRow.Item("ac_aport_name").ToString.Trim), currentRow.Item("ac_aport_name").ToString.Trim, "") + "</td></tr>")
                    Else
                        htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'></td></tr>")
                    End If
                Else
                    htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'></td></tr>")
                End If

                strTemp = ""

                If Not IsDBNull(currentRow.Item("ac_aport_city").ToString.Trim) Then
                    If Not String.IsNullOrEmpty(currentRow.Item("ac_aport_city").ToString.Trim) Then
                        strTemp = currentRow.Item("ac_aport_city").ToString.Trim
                        bHadCity = True
                    End If
                End If

                If Not IsDBNull(currentRow.Item("ac_aport_state").ToString.Trim) Then
                    If Not String.IsNullOrEmpty(currentRow.Item("ac_aport_state").ToString.Trim) Then
                        strTemp += IIf(bHadCity, ", ", "") + currentRow.Item("ac_aport_state").ToString.Trim
                    End If
                End If

                If Not IsDBNull(currentRow.Item("ac_aport_country").ToString.Trim) Then
                    If Not String.IsNullOrEmpty(currentRow.Item("ac_aport_country").ToString.Trim) Then
                        strTemp += " " + currentRow.Item("ac_aport_country").ToString.Trim
                    End If
                End If

                htmlOut.Append("<tr><td align='left' valign='top'>" + IIf(Not String.IsNullOrEmpty(strTemp.Trim), strTemp.Trim, "") + "</td></tr>") ' City, State, Country

                strTemp = ""

                If Not IsDBNull(currentRow.Item("ac_interior_moyear").ToString.Trim) Then
                    If Not String.IsNullOrEmpty(currentRow.Item("ac_interior_moyear").ToString.Trim) Then
                        If currentRow.Item("ac_interior_moyear").ToString.Trim.Length > 4 Then
                            strTemp = Left(currentRow.Item("ac_interior_moyear").ToString.Trim, 2) + "/"
                            strTemp += Right(currentRow.Item("ac_interior_moyear").ToString.Trim, 4)
                        ElseIf currentRow.Item("ac_interior_moyear").ToString.Trim.Length <= 2 Then
                            strTemp = Left(currentRow.Item("ac_interior_moyear"), 2)
                        ElseIf currentRow.Item("ac_interior_moyear").ToString.Trim.Length = 4 Then
                            strTemp = Right(currentRow.Item("ac_interior_moyear"), 4)
                        End If
                    End If
                End If

                htmlOut.Append("<tr><td align='left' nowrap='nowrap' class='textformat'>" + IIf(Not String.IsNullOrEmpty(strTemp.Trim), strTemp.Trim, "") + "</td></tr>")

                If Not IsDBNull(currentRow.Item("ac_interior_rating").ToString.Trim) Then
                    If Not String.IsNullOrEmpty(currentRow.Item("ac_interior_rating").ToString.Trim) Then
                        htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'>" + IIf(Not String.IsNullOrEmpty(currentRow.Item("ac_interior_rating").ToString.Trim), currentRow.Item("ac_interior_rating").ToString.Trim, "") + "</td></tr>")
                    Else
                        htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'></td></tr>")
                    End If
                Else
                    htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'></td></tr>")
                End If

                strTemp = ""

                If Not IsDBNull(currentRow.Item("ac_exterior_moyear").ToString.Trim) Then
                    If Not String.IsNullOrEmpty(currentRow.Item("ac_exterior_moyear").ToString.Trim) Then

                        If currentRow.Item("ac_exterior_moyear").ToString.Trim.Length > 4 Then
                            strTemp = Left(currentRow.Item("ac_exterior_moyear").ToString.Trim, 2) + "/"
                            strTemp += Right(currentRow.Item("ac_exterior_moyear").ToString.Trim, 4)
                        ElseIf currentRow.Item("ac_exterior_moyear").ToString.Trim.Length <= 2 Then
                            strTemp = Left(currentRow.Item("ac_exterior_moyear"), 2)
                        ElseIf currentRow.Item("ac_exterior_moyear").ToString.Trim.Length = 4 Then
                            strTemp = Right(currentRow.Item("ac_exterior_moyear"), 4)
                        End If

                    End If
                End If

                htmlOut.Append("<tr><td align='left' nowrap='nowrap' class='textformat'>" + IIf(Not String.IsNullOrEmpty(strTemp.Trim), strTemp.Trim, "") + "</td></tr>")

                If Not IsDBNull(currentRow.Item("ac_exterior_rating").ToString.Trim) Then
                    If Not String.IsNullOrEmpty(currentRow.Item("ac_exterior_rating").ToString.Trim) Then
                        htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'>" + IIf(Not String.IsNullOrEmpty(currentRow.Item("ac_exterior_rating").ToString.Trim), currentRow.Item("ac_exterior_rating").ToString.Trim, "") + "</td></tr>")
                    Else
                        htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'></td></tr>")
                    End If
                Else
                    htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'></td></tr>")
                End If

                If Not IsDBNull(currentRow.Item("ac_damage_history_notes").ToString.Trim) Then
                    If Not String.IsNullOrEmpty(currentRow.Item("ac_damage_history_notes").ToString.Trim) Then
                        strDamage = "<tr><td align='left' valign='top'>" + IIf(Not String.IsNullOrEmpty(currentRow.Item("ac_damage_history_notes").ToString.Trim), HttpContext.Current.Server.HtmlEncode(currentRow.Item("ac_damage_history_notes").ToString.Trim), "") + "</td></tr>"
                    Else
                        strDamage = "<tr><td align='left' valign='top'></td></tr>"
                    End If
                Else
                    strDamage = "<tr><td align='left' valign='top'></td></tr>"
                End If

                If Not IsDBNull(currentRow.Item("ac_confidential_notes").ToString.Trim) Then
                    If Not String.IsNullOrEmpty(currentRow.Item("ac_confidential_notes").ToString.Trim) Then
                        strConfidential = "<tr><td align='left' valign='top'>" + IIf(Not String.IsNullOrEmpty(currentRow.Item("ac_confidential_notes").ToString.Trim), HttpContext.Current.Server.HtmlEncode(currentRow.Item("ac_confidential_notes").ToString.Trim), "") + "</td></tr>"
                    Else
                        strConfidential = "<tr><td align='left valign='top'></td></tr>"
                    End If
                Else
                    strConfidential = "<tr><td align='left' valign='top'></td></tr>"
                End If

            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in display_report_33_aircraft_information(ByVal currentRow As DataRow, ByRef strDamage As String, ByRef strConfidential As String) As String" + ex.Message
        Finally

        End Try

        Return htmlOut.ToString

    End Function

    Private Function display_report_33_engine_airframe_emp_emgp_amp_amtp_information(ByVal aircraftID As Long) As String

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim report_33_datatable As New DataTable

        Dim adoRS_33 As System.Data.SqlClient.SqlDataReader : adoRS_33 = Nothing

        Dim htmlOut = New StringBuilder()
        Dim sQuery As New StringBuilder()

        Dim strEMP As String = ""
        Dim strEMGP As String = ""
        Dim strAMP As String = ""
        Dim strAMTP As String = ""

        Dim bHadProviderName As Boolean = False

        Try

            SqlConn.ConnectionString = localFunctions.clientConnectStr

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 90

            sQuery.Append("SELECT emp_provider_name, emp_program_name,")
            sQuery.Append(" emgp_provider_name, emgp_program_name,")
            sQuery.Append(" amp_provider_name, amp_program_name,")
            sQuery.Append(" amtp_provider_name, amtp_program_name")
            sQuery.Append(" FROM Aircraft WITH(NOLOCK)")
            sQuery.Append(" INNER JOIN Engine_Maintenance_Program WITH(NOLOCK) ON ac_engine_maintenance_prog_EMP = emp_id")
            sQuery.Append(" INNER JOIN Engine_Management_Program WITH(NOLOCK) ON ac_engine_management_prog_EMGP = emgp_id")
            sQuery.Append(" INNER JOIN Airframe_Maintenance_Program WITH(NOLOCK) ON ac_airframe_maintenance_prog_AMP = amp_id")
            sQuery.Append(" INNER JOIN Airframe_Maintenance_Tracking_Program WITH(NOLOCK) ON ac_airframe_maint_tracking_prog_AMTP = amtp_id")
            sQuery.Append(" WHERE (ac_id = " + aircraftID.ToString + ")")
            sQuery.Append(" AND (ac_journ_id = 0)")

            'HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />display_report_33_engine_airframe_emp_emgp_amp_amtp_information(ByVal aircraftID As Long) As String<br />" + sQuery.ToString

            SqlCommand.CommandText = sQuery.ToString
            adoRS_33 = SqlCommand.ExecuteReader()

            Try
                report_33_datatable.Load(adoRS_33)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = report_33_datatable.GetErrors()
            End Try

            adoRS_33.Close()

            If Not IsNothing(report_33_datatable) Then

                If report_33_datatable.Rows.Count > 0 Then

                    For Each r As DataRow In report_33_datatable.Rows

                        strEMP = "Unknown"
                        If Not IsDBNull(r.Item("emp_provider_name").ToString.Trim) Then
                            If Not String.IsNullOrEmpty(r.Item("emp_provider_name").ToString.Trim) Then
                                strEMP = r.Item("emp_provider_name").ToString.Trim
                                bHadProviderName = True
                            End If
                        End If

                        If Not IsDBNull(r.Item("emp_program_name").ToString.Trim) Then
                            If Not String.IsNullOrEmpty(r.Item("emp_program_name").ToString.Trim) Then
                                strEMP += IIf(bHadProviderName, " - ", "") + r.Item("emp_program_name").ToString.Trim
                            End If
                        End If

                        If strEMP.ToLower.Trim.Contains("unknown - unknown") Then
                            strEMP = "Unknown"
                        End If

                        strEMGP = "Unknown"
                        If Not IsDBNull(r.Item("emgp_provider_name").ToString.Trim) Then
                            If Not String.IsNullOrEmpty(r.Item("emgp_provider_name").ToString.Trim) Then
                                strEMGP = r.Item("emgp_provider_name").ToString.Trim
                                bHadProviderName = True
                            End If
                        End If

                        If Not IsDBNull(r.Item("emgp_program_name").ToString.Trim) Then
                            If Not String.IsNullOrEmpty(r.Item("emgp_program_name").ToString.Trim) Then
                                strEMGP += IIf(bHadProviderName, " - ", "") + r.Item("emgp_program_name").ToString.Trim
                            End If
                        End If

                        If strEMGP.ToLower.Trim.Contains("unknown - unknown") Then
                            strEMGP = "Unknown"
                        End If

                        strAMP = "Unknown"
                        If Not IsDBNull(r.Item("amp_provider_name").ToString.Trim) Then
                            If Not String.IsNullOrEmpty(r.Item("amp_provider_name").ToString.Trim) Then
                                strAMP = r.Item("amp_provider_name").ToString.Trim
                                bHadProviderName = True
                            End If
                        End If

                        If Not IsDBNull(r.Item("amp_program_name").ToString.Trim) Then
                            If Not String.IsNullOrEmpty(r.Item("amp_program_name").ToString.Trim) Then
                                strAMP += IIf(bHadProviderName, " - ", "") + r.Item("amp_program_name").ToString.Trim
                            End If
                        End If

                        If strAMP.ToLower.Trim.Contains("unknown - unknown") Then
                            strAMP = "Unknown"
                        End If

                        strAMTP = "Unknown"
                        If Not IsDBNull(r.Item("amtp_provider_name").ToString.Trim) Then
                            If Not String.IsNullOrEmpty(r.Item("amtp_provider_name").ToString.Trim) Then
                                strAMTP = r.Item("amtp_provider_name").ToString.Trim
                                bHadProviderName = True
                            End If
                        End If

                        If Not IsDBNull(r.Item("amtp_program_name").ToString.Trim) Then
                            If Not String.IsNullOrEmpty(r.Item("amtp_program_name").ToString.Trim) Then
                                strAMTP += IIf(bHadProviderName, " - ", "") + r.Item("amtp_program_name").ToString.Trim
                            End If
                        End If

                        If strAMTP.ToLower.Trim.Contains("unknown - unknown") Then
                            strAMTP = "Unknown"
                        End If

                    Next

                End If

            End If

            htmlOut.Append("<tr><td align='left' valign='top'>" + IIf(Not String.IsNullOrEmpty(strEMP.Trim), strEMP.Trim, "") + "</td></tr>")
            htmlOut.Append("<tr><td align='left' valign='top'>" + IIf(Not String.IsNullOrEmpty(strEMGP.Trim), strEMGP.Trim, "") + "</td></tr>")
            htmlOut.Append("<tr><td align='left' valign='top'>" + IIf(Not String.IsNullOrEmpty(strAMP.Trim), strAMP.Trim, "") + "</td></tr>")
            htmlOut.Append("<tr><td align='left' valign='top'>" + IIf(Not String.IsNullOrEmpty(strAMTP.Trim), strAMTP.Trim, "") + "</td></tr>")

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in display_report_33_engine_airframe_emp_emgp_amp_amtp_information(ByVal aircraftID As Long) As String" + ex.Message
        Finally

            adoRS_33 = Nothing

            report_33_datatable = Nothing

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOut.ToString

    End Function

    Private Function display_report_33_company_information(ByVal aircraftID As Long, ByVal strType As String) As String

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim report_33_datatable As New DataTable

        Dim adoRS_33 As System.Data.SqlClient.SqlDataReader : adoRS_33 = Nothing

        Dim htmlOut = New StringBuilder()
        Dim sQuery As New StringBuilder()

        Dim iTop As Integer = 1
        Dim nCounter As Integer = 0
        Dim strTemp As String = ""
        Dim strTemp2 As String = ""

        Dim bHadCity As Boolean = False
        Dim bHadMiddleInitial As Boolean = False

        Try

            SqlConn.ConnectionString = localFunctions.clientConnectStr

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 90

            If strType.ToUpper.Trim.Contains("BROKER") Then
                iTop = 2
            End If

            sQuery.Append("SELECT TOP " + iTop.ToString + " actype_name, cbus_name, comp_name, comp_city, comp_state,")
            sQuery.Append(" comp_country, contact_sirname, contact_last_name, contact_first_name, contact_active_flag,")
            sQuery.Append(" contact_middle_initial , contact_suffix, contact_title")
            sQuery.Append(" FROM Aircraft_Reference WITH(NOLOCK)")
            sQuery.Append(" INNER JOIN Aircraft_Contact_Type WITH(NOLOCK) ON (cref_contact_type = actype_code)")
            sQuery.Append(" INNER JOIN Company_Business_Type WITH(NOLOCK) ON (cref_business_type = cbus_type)")
            sQuery.Append(" INNER JOIN Company WITH(NOLOCK) ON (cref_comp_id = comp_id AND cref_journ_id = comp_journ_id)")
            sQuery.Append(" LEFT OUTER JOIN Contact WITH(NOLOCK) ON (cref_contact_id = contact_id AND cref_journ_id = contact_journ_id)")
            sQuery.Append(" WHERE ((cref_ac_id = " + aircraftID.ToString + ") AND (cref_journ_id = 0)")
            sQuery.Append(" AND comp_active_flag = 'Y' AND comp_hide_flag = 'N')")
            sQuery.Append(" " + commonEvo.MakeCompanyProductCodeClause(HttpContext.Current.Session.Item("localPreferences"), False))

            If strType.ToUpper.Trim.Contains("OWNER") Then
                sQuery.Append(" AND (cref_transmit_seq_no = 1)")
            End If

            If strType.ToUpper.Trim.Contains("BROKER") Then
                sQuery.Append(" AND (cref_contact_type IN ('99','93'))")
            End If

            'HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />display_report_33_company_information(ByVal aircraftID As Long, ByVal strType As String) As String<br />" + sQuery.ToString

            SqlCommand.CommandText = sQuery.ToString
            adoRS_33 = SqlCommand.ExecuteReader()

            Try
                report_33_datatable.Load(adoRS_33)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = report_33_datatable.GetErrors()
            End Try

            adoRS_33.Close()

            If Not IsNothing(report_33_datatable) Then

                If report_33_datatable.Rows.Count > 0 Then

                    For Each r As DataRow In report_33_datatable.Rows

                        bHadCity = False
                        bHadMiddleInitial = False

                        If Not IsDBNull(r.Item("actype_name").ToString.Trim) Then
                            If Not String.IsNullOrEmpty(r.Item("actype_name").ToString.Trim) Then
                                strTemp = r.Item("actype_name").ToString.Trim
                            End If
                        End If

                        If Not IsDBNull(r.Item("cbus_name").ToString.Trim) Then
                            If Not String.IsNullOrEmpty(r.Item("cbus_name").ToString.Trim) Then
                                strTemp += " - (" + r.Item("cbus_name").ToString.Trim + ")"
                            End If
                        End If

                        htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'><b>" + IIf(Not String.IsNullOrEmpty(strTemp.Trim), strTemp.Trim, "") + "</b></td></tr>") ' Company Type Code
                        strTemp = ""

                        If Not IsDBNull(r.Item("comp_name").ToString.Trim) Then
                            If Not String.IsNullOrEmpty(r.Item("comp_name").ToString.Trim) Then
                                strTemp = r.Item("comp_name").ToString.Trim
                            End If
                        End If

                        htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'>" + IIf(Not String.IsNullOrEmpty(strTemp.Trim), strTemp.Trim, "") + "</td></tr>") ' Company

                        strTemp = ""
                        If Not IsDBNull(r.Item("comp_city").ToString.Trim) Then
                            If Not String.IsNullOrEmpty(r.Item("comp_city").ToString.Trim) Then
                                strTemp = r.Item("comp_city").ToString.Trim
                                bHadCity = True
                            End If
                        End If

                        If Not IsDBNull(r.Item("comp_state").ToString.Trim) Then
                            If Not String.IsNullOrEmpty(r.Item("comp_state").ToString.Trim) Then
                                strTemp += IIf(bHadCity, ", ", "") + r.Item("comp_state").ToString.Trim
                            End If
                        End If

                        If Not IsDBNull(r.Item("comp_country").ToString.Trim) Then
                            If Not String.IsNullOrEmpty(r.Item("comp_country").ToString.Trim) Then
                                strTemp += " " + r.Item("comp_country").ToString.Trim
                            End If
                        End If

                        htmlOut.Append("<tr><td align='left' valign='top'>" + IIf(Not String.IsNullOrEmpty(strTemp.Trim), strTemp.Trim, "") + "</td></tr>") ' City, State, Country

                        strTemp = ""
                        strTemp2 = ""
                        If Not IsDBNull(r.Item("contact_last_name").ToString.Trim) Then
                            If Not String.IsNullOrEmpty(r.Item("contact_last_name").ToString.Trim) Then

                                If r.Item("contact_active_flag").ToString.ToUpper.Contains("Y") Then

                                    If Not IsDBNull(r.Item("contact_sirname").ToString.Trim) Then
                                        If Not String.IsNullOrEmpty(r.Item("contact_sirname").ToString.Trim) Then
                                            strTemp = r.Item("contact_sirname").ToString.Trim + " "
                                        End If
                                    End If

                                    If Not IsDBNull(r.Item("contact_first_name").ToString.Trim) Then
                                        If Not String.IsNullOrEmpty(r.Item("contact_first_name").ToString.Trim) Then
                                            strTemp += r.Item("contact_first_name").ToString.Trim + " "
                                        End If
                                    End If

                                    If Not IsDBNull(r.Item("contact_middle_initial").ToString.Trim) Then
                                        If Not String.IsNullOrEmpty(r.Item("contact_middle_initial").ToString.Trim) Then
                                            strTemp += r.Item("contact_middle_initial").ToString.Trim
                                            bHadMiddleInitial = True
                                        End If
                                    End If

                                    If Not IsDBNull(r.Item("contact_last_name").ToString.Trim) Then
                                        If Not String.IsNullOrEmpty(r.Item("contact_last_name").ToString.Trim) Then
                                            strTemp += IIf(bHadMiddleInitial, ". ", " ") + r.Item("contact_last_name").ToString.Trim
                                        End If
                                    End If

                                    If Not IsDBNull(r.Item("contact_suffix").ToString.Trim) Then
                                        If Not String.IsNullOrEmpty(r.Item("contact_suffix").ToString.Trim) Then
                                            strTemp += ", " + r.Item("contact_suffix").ToString.Trim
                                        End If
                                    End If

                                    If Not IsDBNull(r.Item("contact_title").ToString.Trim) Then
                                        If Not String.IsNullOrEmpty(r.Item("contact_title").ToString.Trim) Then
                                            strTemp2 = r.Item("contact_title").ToString.Trim
                                        End If
                                    End If

                                End If
                            End If
                        End If

                        htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'>" + IIf(Not String.IsNullOrEmpty(strTemp.Trim), strTemp.Trim, "") + "</td></tr>") ' Contact
                        htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'>" + IIf(Not String.IsNullOrEmpty(strTemp2.Trim), strTemp2.Trim, "") + "</td></tr>") ' Contact Title

                        If nCounter <= iTop Then
                            nCounter += 1
                        Else
                            Exit For
                        End If

                    Next

                End If
            End If

            ' if we have less items than the "iTop" fill in the rest with blank rows
            If nCounter < iTop Then
                For y As Integer = nCounter To iTop
                    If y < iTop Then
                        htmlOut.Append("<tr><td></td></tr>")  ' Company Type Code
                        htmlOut.Append("<tr><td></td></tr>")  ' Company
                        htmlOut.Append("<tr><td></td></tr>")  ' City, State, Country
                        htmlOut.Append("<tr><td></td></tr>")  ' Contact
                        htmlOut.Append("<tr><td></td></tr>")  ' Contact Title
                    End If
                Next
            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in display_report_33_company_information(ByVal aircraftID As Long, ByVal strType As String) As String" + ex.Message
        Finally

            adoRS_33 = Nothing

            report_33_datatable = Nothing

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOut.ToString

    End Function

    Private Function display_report_33_feature_code_information(ByVal aircraftID As Long, ByVal lAmodId As Integer, ByVal iMaxFCodes As Integer, ByRef strDamageYN As String) As String

        Dim htmlOut = New StringBuilder()

        Dim bHasNoStandardFeatures As Boolean = False
        Dim bStandardFeature As Boolean = False

        Dim arrFeatCodes() As String = Nothing
        Dim arrStdFeatCodes(,) As String = Nothing

        Dim report_33_datatable As New DataTable

        Dim nCounter As Integer = 0
        Dim strStatusCode As String = ""
        Dim row_added As Boolean = False
        Dim temp_string As String = ""

        Try

            localFunctions.load_standard_ac_features_report(lAmodId, arrStdFeatCodes)

            If IsNothing(arrStdFeatCodes) Then
                bHasNoStandardFeatures = True
            End If

            strDamageYN = "U"

            report_33_datatable = localFunctions.get_ac_features_report(aircraftID, 0, Nothing, iMaxFCodes)

            If Not IsNothing(report_33_datatable) Then

                If report_33_datatable.Rows.Count > 0 Then

                    If Not IsDBNull(report_33_datatable.Rows(0).Item("kfeat_code").ToString.Trim) Then ' First One Is Damage
                        If Not String.IsNullOrEmpty(report_33_datatable.Rows(0).Item("kfeat_code").ToString.Trim) Then

                            If report_33_datatable.Rows(0).Item("kfeat_code").ToString.Trim.ToLower.Contains("dam") Then

                                Select Case report_33_datatable.Rows(0).Item("afeat_status_flag").ToString.Trim.ToUpper
                                    Case "U"
                                        strDamageYN = "Unknown"
                                    Case "Y"
                                        strDamageYN = "Yes"
                                    Case "N"
                                        strDamageYN = "No"
                                    Case "A"
                                        strDamageYN = "Accident"
                                    Case "I"
                                        strDamageYN = "Incident"
                                    Case Else
                                        strDamageYN = report_33_datatable.Rows(0).Item("afeat_status_flag").ToString.Trim
                                End Select

                            End If

                            strDamageYN = "<tr><td align='left' valign='top'>" + strDamageYN.Trim + "</td></tr>"

                        End If
                    End If

                    htmlOut.Append(strDamageYN)

                    For i = 0 To feature_code_count - 1   ' for every code 

                        row_added = False

                        For Each r As DataRow In report_33_datatable.Rows

                            ' these 3 lines added in msw to fill in the blanks  
                            If row_added = False Then
                                If Not IsDBNull(r.Item("kfeat_code").ToString.Trim) Then
                                    If Trim(r.Item("kfeat_code")) = Trim(feature_code_list(i, 0)) Then

                                        row_added = True

                                        If Not IsDBNull(r.Item("afeat_status_flag").ToString.Trim) Then
                                            If Not String.IsNullOrEmpty(r.Item("afeat_status_flag").ToString.Trim) Then

                                                Select Case r.Item("afeat_status_flag").ToString.Trim.ToUpper
                                                    Case "U"
                                                        strStatusCode = "Unknown"
                                                    Case "Y"
                                                        strStatusCode = "Yes"
                                                    Case "N"
                                                        strStatusCode = "No"
                                                    Case Else
                                                        strStatusCode = r.Item("afeat_status_flag").ToString.Trim
                                                End Select

                                            End If
                                        End If

                                        If Not IsDBNull(r.Item("kfeat_code").ToString.Trim) Then
                                            If Not String.IsNullOrEmpty(r.Item("kfeat_code").ToString.Trim) Then

                                                bStandardFeature = False

                                                ' check and see if this feature is a standard feature
                                                For x As Integer = 0 To UBound(arrStdFeatCodes)
                                                    If arrStdFeatCodes(x, 0).ToUpper.Trim = r.Item("kfeat_code").ToString.Trim.ToUpper Then
                                                        bStandardFeature = True
                                                        Exit For
                                                    End If
                                                Next

                                                If Not bStandardFeature Or bHasNoStandardFeatures Then
                                                    htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'>" + strStatusCode.Trim + "</td></tr>")
                                                Else
                                                    htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'><font color='blue'>" + strStatusCode.Trim + "</td></tr>")
                                                End If

                                            End If
                                        End If

                                        If nCounter <= iMaxFCodes Then
                                            nCounter += 1
                                        Else
                                            Exit For
                                        End If

                                    Else
                                        ' do nothing 
                                        '   temp_string &= ("<tr><td align='left' valign='top' nowrap='nowrap'>&nbsp;</td></tr>")
                                    End If
                                Else
                                    ' do nothing 
                                    '   temp_string &= ("<tr><td align='left' valign='top' nowrap='nowrap'>&nbsp;</td></tr>")
                                End If
                            End If
                        Next

                        If row_added = False Then
                            htmlOut.Append("<tr><td align='left' valign='top' nowrap='nowrap'>&nbsp;</td></tr>")
                        End If


                    Next

                End If

            End If

            '' if we have less features than the "max" features fill in the rest with blank rows
            'If nCounter < iMaxFCodes Then
            '  For y As Integer = nCounter To iMaxFCodes
            '    If y < iMaxFCodes Then
            '      htmlOut.Append("<tr><td></td></tr>")
            '    End If
            '  Next
            'End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in display_report_33_company_information(ByVal aircraftID As Long, ByVal strType As String) As String" + ex.Message
        Finally

            report_33_datatable = Nothing

        End Try

        Return htmlOut.ToString

    End Function

    Private Function display_report_33_avionics_information(ByVal aircraftID As Long)

        Dim htmlOut = New StringBuilder()

        Dim tmpValue As String = ""

        Try


            tmpValue = localFunctions.get_avionics_description_report(aircraftID, 0, "ADF", False)

            htmlOut.Append(IIf(Not String.IsNullOrEmpty(tmpValue.Trim), tmpValue, "<tr><td align='left' valign='top'></td></tr>"))

            tmpValue = ""
            tmpValue = localFunctions.get_avionics_description_report(aircraftID, 0, "AFIS", False)

            htmlOut.Append(IIf(Not String.IsNullOrEmpty(tmpValue.Trim), tmpValue.Trim, "<tr><td align='left' valign='top'></td></tr>"))

            tmpValue = ""
            tmpValue = localFunctions.get_avionics_description_report(aircraftID, 0, "Altimeter", False)

            htmlOut.Append(IIf(Not String.IsNullOrEmpty(tmpValue.Trim), tmpValue.Trim, "<tr><td align='left' valign='top'></td></tr>"))

            tmpValue = ""
            tmpValue = localFunctions.get_avionics_description_report(aircraftID, 0, "Autopilot", False)

            htmlOut.Append(IIf(Not String.IsNullOrEmpty(tmpValue.Trim), tmpValue.Trim, "<tr><td align='left' valign='top'></td></tr>"))

            tmpValue = ""
            tmpValue = localFunctions.get_avionics_description_report(aircraftID, 0, "Avionics Package", False)

            htmlOut.Append(IIf(Not String.IsNullOrEmpty(tmpValue.Trim), tmpValue.Trim, "<tr><td align='left' valign='top'></td></tr>"))

            tmpValue = ""
            tmpValue = localFunctions.get_avionics_description_report(aircraftID, 0, "Communication Radios", False)

            htmlOut.Append(IIf(Not String.IsNullOrEmpty(tmpValue.Trim), tmpValue.Trim, "<tr><td align='left' valign='top'></td></tr>"))

            tmpValue = ""
            tmpValue = localFunctions.get_avionics_description_report(aircraftID, 0, "Compass", False)

            htmlOut.Append(IIf(Not String.IsNullOrEmpty(tmpValue.Trim), tmpValue.Trim, "<tr><td align='left' valign='top'></td></tr>"))

            tmpValue = ""
            tmpValue = localFunctions.get_avionics_description_report(aircraftID, 0, "CVR", False)

            htmlOut.Append(IIf(Not String.IsNullOrEmpty(tmpValue.Trim), tmpValue.Trim, "<tr><td align='left' valign='top'></td></tr>"))

            tmpValue = ""
            tmpValue = localFunctions.get_avionics_description_report(aircraftID, 0, "DME", False)

            htmlOut.Append(IIf(Not String.IsNullOrEmpty(tmpValue.Trim), tmpValue.Trim, "<tr><td align='left' valign='top'></td></tr>"))

            tmpValue = ""
            tmpValue = localFunctions.get_avionics_description_report(aircraftID, 0, "EFIS", False)

            htmlOut.Append(IIf(Not String.IsNullOrEmpty(tmpValue.Trim), tmpValue.Trim, "<tr><td align='left' valign='top'></td></tr>"))

            tmpValue = ""
            tmpValue = localFunctions.get_avionics_description_report(aircraftID, 0, "FDR", False)

            htmlOut.Append(IIf(Not String.IsNullOrEmpty(tmpValue.Trim), tmpValue.Trim, "<tr><td align='left' valign='top'></td></tr>"))

            tmpValue = ""
            tmpValue = localFunctions.get_avionics_description_report(aircraftID, 0, "Flight Director", False)

            htmlOut.Append(IIf(Not String.IsNullOrEmpty(tmpValue.Trim), tmpValue.Trim, "<tr><td align='left' valign='top'></td></tr>"))

            tmpValue = ""
            tmpValue = localFunctions.get_avionics_description_report(aircraftID, 0, "Flight Phone", False)

            htmlOut.Append(IIf(Not String.IsNullOrEmpty(tmpValue.Trim), tmpValue.Trim, "<tr><td align='left' valign='top'></td></tr>"))

            tmpValue = ""
            tmpValue = localFunctions.get_avionics_description_report(aircraftID, 0, "FMS", False)

            htmlOut.Append(IIf(Not String.IsNullOrEmpty(tmpValue.Trim), tmpValue.Trim, "<tr><td align='left' valign='top'></td></tr>"))

            tmpValue = ""
            tmpValue = localFunctions.get_avionics_description_report(aircraftID, 0, "GPS", False)

            htmlOut.Append(IIf(Not String.IsNullOrEmpty(tmpValue.Trim), tmpValue.Trim, "<tr><td align='left' valign='top'></td></tr>"))

            tmpValue = ""
            tmpValue = localFunctions.get_avionics_description_report(aircraftID, 0, "Hi Frequency", False)

            htmlOut.Append(IIf(Not String.IsNullOrEmpty(tmpValue.Trim), tmpValue.Trim, "<tr><td align='left' valign='top'></td></tr>"))

            tmpValue = ""
            tmpValue = localFunctions.get_avionics_description_report(aircraftID, 0, "HSI", False)

            htmlOut.Append(IIf(Not String.IsNullOrEmpty(tmpValue.Trim), tmpValue.Trim, "<tr><td align='left' valign='top'></td></tr>"))

            tmpValue = ""
            tmpValue = localFunctions.get_avionics_description_report(aircraftID, 0, "INS", False)

            htmlOut.Append(IIf(Not String.IsNullOrEmpty(tmpValue.Trim), tmpValue.Trim, "<tr><td align='left' valign='top'></td></tr>"))

            tmpValue = ""
            tmpValue = localFunctions.get_avionics_description_report(aircraftID, 0, "IRS", False)

            htmlOut.Append(IIf(Not String.IsNullOrEmpty(tmpValue.Trim), tmpValue.Trim, "<tr><td align='left' valign='top'></td></tr>"))

            tmpValue = ""
            tmpValue = localFunctions.get_avionics_description_report(aircraftID, 0, "LORAN", False)

            htmlOut.Append(IIf(Not String.IsNullOrEmpty(tmpValue.Trim), tmpValue.Trim, "<tr><td align='left' valign='top'></td></tr>"))

            tmpValue = ""
            tmpValue = localFunctions.get_avionics_description_report(aircraftID, 0, "LRN", False)

            htmlOut.Append(IIf(Not String.IsNullOrEmpty(tmpValue.Trim), tmpValue.Trim, "<tr><td align='left' valign='top'></td></tr>"))

            tmpValue = ""
            tmpValue = localFunctions.get_avionics_description_report(aircraftID, 0, "Navigation Radios", False)

            htmlOut.Append(IIf(Not String.IsNullOrEmpty(tmpValue.Trim), tmpValue.Trim, "<tr><td align='left' valign='top'></td></tr>"))

            tmpValue = ""
            tmpValue = localFunctions.get_avionics_description_report(aircraftID, 0, "Radar Altimeter", False)

            htmlOut.Append(IIf(Not String.IsNullOrEmpty(tmpValue.Trim), tmpValue.Trim, "<tr><td align='left' valign='top'></td></tr>"))

            tmpValue = ""
            tmpValue = localFunctions.get_avionics_description_report(aircraftID, 0, "RMI", False)

            htmlOut.Append(IIf(Not String.IsNullOrEmpty(tmpValue.Trim), tmpValue.Trim, "<tr><td align='left' valign='top'></td></tr>"))

            tmpValue = ""
            tmpValue = localFunctions.get_avionics_description_report(aircraftID, 0, "RNAV", False)

            htmlOut.Append(IIf(Not String.IsNullOrEmpty(tmpValue.Trim), tmpValue.Trim, "<tr><td align='left' valign='top'></td></tr>"))

            tmpValue = ""
            tmpValue = localFunctions.get_avionics_description_report(aircraftID, 0, "SATCOM", False)

            htmlOut.Append(IIf(Not String.IsNullOrEmpty(tmpValue.Trim), tmpValue.Trim, "<tr><td align='left' valign='top'></td></tr>"))

            tmpValue = ""
            tmpValue = localFunctions.get_avionics_description_report(aircraftID, 0, "Stormscope", False)

            htmlOut.Append(IIf(Not String.IsNullOrEmpty(tmpValue.Trim), tmpValue.Trim, "<tr><td align='left' valign='top'></td></tr>"))

            tmpValue = ""
            tmpValue = localFunctions.get_avionics_description_report(aircraftID, 0, "TAWS", False)

            htmlOut.Append(IIf(Not String.IsNullOrEmpty(tmpValue.Trim), tmpValue.Trim, "<tr><td align='left' valign='top'></td></tr>"))

            tmpValue = ""
            tmpValue = localFunctions.get_avionics_description_report(aircraftID, 0, "TCAD", False)

            htmlOut.Append(IIf(Not String.IsNullOrEmpty(tmpValue.Trim), tmpValue.Trim, "<tr><td align='left' valign='top'></td></tr>"))

            tmpValue = ""
            tmpValue = localFunctions.get_avionics_description_report(aircraftID, 0, "TCAS", False)

            htmlOut.Append(IIf(Not String.IsNullOrEmpty(tmpValue.Trim), tmpValue.Trim, "<tr><td align='left' valign='top'></td></tr>"))

            tmpValue = ""
            tmpValue = localFunctions.get_avionics_description_report(aircraftID, 0, "Transponder", False)

            htmlOut.Append(IIf(Not String.IsNullOrEmpty(tmpValue.Trim), tmpValue.Trim, "<tr><td align='left' valign='top'></td></tr>"))

            tmpValue = ""
            tmpValue = localFunctions.get_avionics_description_report(aircraftID, 0, "Weather Radar", False)

            htmlOut.Append(IIf(Not String.IsNullOrEmpty(tmpValue.Trim), tmpValue.Trim, "<tr><td align='left' valign='top'></td></tr>"))


        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in display_report_33_avionics_information(ByVal aircraftID As Long) As String" + ex.Message
        Finally

        End Try

        Return htmlOut.ToString

    End Function

    Private Function display_report_33_aircraft_details_information(ByVal aircraftID As Long, ByVal strType As String) As String

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand

        Dim adoRS_33 As System.Data.SqlClient.SqlDataReader : adoRS_33 = Nothing

        Dim htmlOut = New StringBuilder()
        Dim sQuery As New StringBuilder()

        Try

            SqlConn.ConnectionString = localFunctions.clientConnectStr

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 90

            sQuery.Append("SELECT adet_data_name, adet_data_description")
            sQuery.Append(" FROM Aircraft_Details WITH(NOLOCK)")
            sQuery.Append(" INNER JOIN Aircraft_Data_Type WITH(NOLOCK) ON adet_data_type = adt_data_type AND adet_data_name = adt_data_name")
            sQuery.Append(" WHERE (adet_ac_id = " + aircraftID.ToString + ") AND (adet_journ_id = 0)")
            sQuery.Append(" AND (adet_data_type = '" + strType.Trim + "')")
            sQuery.Append(" ORDER BY adt_seq_no")

            'HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />display_report_33_aircraft_details_information(ByVal aircraftID As Long, ByVal strType As String) As String<br />" + sQuery.ToString

            SqlCommand.CommandText = sQuery.ToString
            adoRS_33 = SqlCommand.ExecuteReader()

            If adoRS_33.HasRows Then

                Do While adoRS_33.Read

                    If Not IsDBNull(adoRS_33.Item("adet_data_name")) Then
                        If Not String.IsNullOrEmpty(adoRS_33.Item("adet_data_name").ToString.Trim) Then
                            htmlOut.Append("<b>" + adoRS_33.Item("adet_data_name").ToString.Trim + ":</b> ")
                        End If
                    End If

                    If Not IsDBNull(adoRS_33.Item("adet_data_description")) Then
                        If Not String.IsNullOrEmpty(adoRS_33.Item("adet_data_description").ToString.Trim) Then

                            For Each ch As Char In adoRS_33.Item("adet_data_description").ToString

                                If Not Char.IsControl(ch) Then
                                    If Char.IsWhiteSpace(ch) Then
                                        htmlOut.Append(Constants.cSingleSpace)
                                    Else
                                        htmlOut.Append(ch)
                                    End If
                                End If

                            Next

                        End If
                    End If

                    htmlOut.Append(Constants.cSvrStringSeperator)

                Loop
            End If

            adoRS_33.Close()

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in display_report_33_aircraft_details_information(ByVal aircraftID As Long, ByVal strType As String) As String" + ex.Message
        Finally

            adoRS_33 = Nothing

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOut.ToString

    End Function

    Private Function display_report_33_apu_information(ByVal currentRow As DataRow) As String

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim report_33_datatable As New DataTable

        Dim adoRS_33 As System.Data.SqlClient.SqlDataReader : adoRS_33 = Nothing

        Dim htmlOut = New StringBuilder()
        Dim sQuery As New StringBuilder()
        Dim apuMaintProg As String = ""

        Try

            If Not IsDBNull(currentRow.Item("ac_apu_maint_prog")) Then
                If Not String.IsNullOrEmpty(currentRow.Item("ac_apu_maint_prog").Trim) Then


                    SqlConn.ConnectionString = localFunctions.clientConnectStr

                    SqlConn.Open()

                    SqlCommand.Connection = SqlConn
                    SqlCommand.CommandType = System.Data.CommandType.Text
                    SqlCommand.CommandTimeout = 90

                    sQuery.Append("SELECT emp_name, emp_provider_name, emp_program_name FROM Engine_Maintenance_Program WITH(NOLOCK)")
                    sQuery.Append(" WHERE (emp_code = '" + currentRow.Item("ac_apu_maint_prog").ToString + "')")

                    'HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />display_report_33_apu_information(ByVal currentRow As DataRow) As String<br />" + sQuery.ToString

                    SqlCommand.CommandText = sQuery.ToString
                    adoRS_33 = SqlCommand.ExecuteReader()

                    Try
                        report_33_datatable.Load(adoRS_33)
                    Catch constrExc As System.Data.ConstraintException
                        Dim rowsErr As System.Data.DataRow() = report_33_datatable.GetErrors()
                    End Try

                    adoRS_33.Close()

                    If Not IsNothing(report_33_datatable) Then

                        If report_33_datatable.Rows.Count > 0 Then

                            For Each r As DataRow In report_33_datatable.Rows

                                If Not IsDBNull(r.Item("emp_name")) Then
                                    If Not String.IsNullOrEmpty(r.Item("emp_name").ToString.Trim) Then
                                        apuMaintProg = r.Item("emp_name").ToString.Trim
                                    End If
                                End If

                            Next

                        End If

                    End If

                End If
            End If

            'apu items 
            If Not IsDBNull(currentRow.Item("ac_apu_model_name")) Then
                If Not String.IsNullOrEmpty(currentRow.Item("ac_apu_model_name").ToString.Trim) Then
                    htmlOut.Append("<tr><td align='left' valign='top'>" + currentRow.Item("ac_apu_model_name").ToString.Trim + "</td></tr>")
                Else
                    htmlOut.Append("<tr><td align='left' valign='top'></td></tr>")
                End If
            Else
                htmlOut.Append("<tr><td align='left' valign='top'></td></tr>")
            End If

            If Not IsDBNull(currentRow.Item("ac_apu_ser_no")) Then
                If Not String.IsNullOrEmpty(currentRow.Item("ac_apu_ser_no").ToString.Trim) Then
                    htmlOut.Append("<tr><td align='left' valign='top'>" + currentRow.Item("ac_apu_ser_no").ToString.Trim + "</td></tr>")
                Else
                    htmlOut.Append("<tr><td align='left' valign='top'></td></tr>")
                End If
            Else
                htmlOut.Append("<tr><td align='left' valign='top'></td></tr>")
            End If

            If Not IsDBNull(currentRow.Item("ac_apu_tot_hrs")) Then
                If Not String.IsNullOrEmpty(currentRow.Item("ac_apu_tot_hrs").ToString.Trim) Then
                    htmlOut.Append("<tr><td align='left' valign='top'>" + currentRow.Item("ac_apu_tot_hrs").ToString.Trim + "</td></tr>")
                Else
                    htmlOut.Append("<tr><td align='left' valign='top'></td></tr>")
                End If
            Else
                htmlOut.Append("<tr><td align='left' valign='top'></td></tr>")
            End If

            If Not IsDBNull(currentRow.Item("ac_apu_soh_hrs")) Then
                If Not String.IsNullOrEmpty(currentRow.Item("ac_apu_soh_hrs").ToString.Trim) Then
                    htmlOut.Append("<tr><td align='left' valign='top'>" + currentRow.Item("ac_apu_soh_hrs").ToString.Trim + "</td></tr>")
                Else
                    htmlOut.Append("<tr><td align='left' valign='top'></td></tr>")
                End If
            Else
                htmlOut.Append("<tr><td align='left' valign='top'></td></tr>")
            End If

            If Not IsDBNull(currentRow.Item("ac_apu_shi_hrs")) Then
                If Not String.IsNullOrEmpty(currentRow.Item("ac_apu_shi_hrs").ToString.Trim) Then
                    htmlOut.Append("<tr><td align='left' valign='top'>" + currentRow.Item("ac_apu_shi_hrs").ToString.Trim + "</td></tr>")
                Else
                    htmlOut.Append("<tr><td align='left' valign='top'></td></tr>")
                End If
            Else
                htmlOut.Append("<tr><td align='left' valign='top'></td></tr>")
            End If

            If Not String.IsNullOrEmpty(apuMaintProg.Trim) Then
                htmlOut.Append("<tr><td align='left' valign='top'>" + apuMaintProg.Trim + "</td></tr>")
            Else
                htmlOut.Append("<tr><td align='left' valign='top'></td></tr>")
            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in display_report_33_apu_information(ByVal currentRow As DataRow) As String" + ex.Message
        Finally
            adoRS_33 = Nothing

            report_33_datatable = Nothing

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOut.ToString

    End Function

    Private Function display_report_33_notes_information(ByVal nAircraftID As Long) As String

        Dim outString As New StringBuilder()
        Dim notes_datatable As DataTable = Nothing

        Try


            If bHasServerNotes And (nAircraftID > 0) Then 'If they're plus + notes users. 
                notes_datatable = localFunctions.get_all_server_notes(nAircraftID, 0)
            ElseIf bHasStandardCloudNotes Then 'if they're standard cloud users
                notes_datatable = localFunctions.get_all_cloud_notes(nAircraftID, 0)
            End If

            If Not IsNothing(notes_datatable) Then

                If notes_datatable.Rows.Count > 0 Then

                    For Each Row As DataRow In notes_datatable.Rows

                        If Not IsDBNull(Row.Item("lnote_entry_date")) Then
                            If Not String.IsNullOrEmpty(Row.Item("lnote_entry_date").ToString.Trim) Then
                                outString.Append(FormatDateTime(Row.Item("lnote_entry_date").ToString, DateFormat.ShortDate))
                            End If
                        End If


                        If Not (IsDBNull(Row.Item("lnote_user_name"))) Then
                            If Not String.IsNullOrEmpty(Row.Item("lnote_user_name").ToString.Trim) Then
                                outString.Append(" : " + Row.Item("lnote_user_name").ToString.Trim)
                            End If
                        End If

                        If Not IsDBNull(Row.Item("lnote_note")) Then
                            If Not String.IsNullOrEmpty(Row.Item("lnote_note").ToString.Trim) Then
                                outString.Append(" - " + Row.Item("lnote_note").ToString.Replace(">", "").Replace("<", "").Trim)
                            End If
                        End If

                        If Not String.IsNullOrEmpty(outString.ToString.Trim) Then
                            outString.Append(Constants.cSvrStringSeperator)
                        End If

                    Next

                End If

            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in display_report_33_notes_information()" + ex.Message

        End Try

        Return outString.ToString

        outString = Nothing

    End Function

#End Region

#Region "report_35_functions"

    Public Function create_report_35_share_holder_with_aircraft_information(ByRef record_count As Long) As String

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim report_35_datatable As New DataTable

        Dim adoRS_35 As System.Data.SqlClient.SqlDataReader : adoRS_35 = Nothing

        Dim htmlOut = New StringBuilder()
        Dim sQuery As New StringBuilder()

        Dim sExpireTitle As String = ""
        Dim sPageTitle As String = ""

        Dim tmpCompID As String = "0"
        Dim sProgramName As String = ""

        Try

            sProgramName = localFunctions.get_fractional_program_name(nFractionalProgramID, nFractionalProgramCompanyID)

            If nFractionalExpireYear > 0 And Not String.IsNullOrEmpty(sFractionalExpireFlag) Then
                If sFractionalExpireFlag.ToUpper.Contains("Y") Then
                    sExpireTitle = " Expiring Shareholders"
                Else
                    sExpireTitle = " Expired Shareholders"
                End If

                sPageTitle = nFractionalExpireYear.ToString + sExpireTitle
            Else
                sPageTitle = "Current Shareholder"
            End If

            SqlConn.ConnectionString = localFunctions.clientConnectStr

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 90

            If Not IsNothing(HttpContext.Current.Session.Item("fractionalDataTable")) Then
                report_35_datatable = CType(HttpContext.Current.Session.Item("fractionalDataTable"), DataTable)
            Else
                Return ""
            End If

            If chkIncludeContacts.Checked Then
                If report_35_datatable.Rows.Count > 0 Then

                    For Each Row As DataRow In report_35_datatable.Rows

                        If Not IsDBNull(Row.Item("comp_id")) Then
                            If Not String.IsNullOrEmpty(Row.Item("comp_id").ToString.Trim) Then
                                If String.IsNullOrEmpty(tmpCompID.Trim) Then
                                    tmpCompID = Row.Item("comp_id").ToString.Trim
                                Else
                                    tmpCompID += Constants.cCommaDelim + Row.Item("comp_id").ToString.Trim
                                End If
                            End If
                        End If

                    Next

                End If

                sQuery = New StringBuilder()

                sQuery.Append("SELECT DISTINCT comp_id, comp_name, comp_name_alt_type, comp_name_alt, comp_city, comp_state, comp_zip_code,")
                sQuery.Append(" comp_email_address, comp_web_address, comp_address1, comp_address2, comp_country, state_name,")
                sQuery.Append(" contact_id, contact_first_name, contact_last_name, contact_middle_initial, contact_sirname, contact_suffix, contact_title, contact_email_address")

                sQuery.Append(" FROM Company WITH(NOLOCK) LEFT OUTER JOIN State WITH(NOLOCK) ON comp_state = state_code AND comp_country = state_country ")
                sQuery.Append(" LEFT OUTER JOIN Contact WITH(NOLOCK) ON (contact_comp_id = comp_id AND contact_journ_id = comp_journ_id)")

                sQuery.Append(" WHERE comp_id IN (" + tmpCompID + ") AND comp_journ_id = 0")
                sQuery.Append(" ORDER BY comp_name")

                HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />(include contacts)Create_Report_35_Share_Holder_With_Aircraft_Information() As String<br />" + sQuery.ToString

                report_35_datatable = New DataTable

                SqlCommand.CommandText = sQuery.ToString
                adoRS_35 = SqlCommand.ExecuteReader()

                Try
                    report_35_datatable.Load(adoRS_35)
                Catch constrExc As System.Data.ConstraintException
                    Dim rowsErr As System.Data.DataRow() = report_35_datatable.GetErrors()
                End Try

                adoRS_35.Close()
                adoRS_35 = Nothing

                record_count = report_35_datatable.Rows.Count

            End If

            If bHtmlReport Then
                htmlOut.Append("<!DOCTYPE html>")
                htmlOut.Append("<html lang='en'>")
                htmlOut.Append("<head>")
                htmlOut.Append("<meta http-equiv='Content-Language' content='en-us' />")
                htmlOut.Append("<meta http-equiv='Content-Type' content='text/html; charset=windows-1252' />")
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='common/jetnet.css' />")
                htmlOut.Append("<title>JETNET - Labels Export of " + sPageTitle.Trim + "</title>")
                htmlOut.Append("</head>")
                htmlOut.Append("<body style='background: white; margin-top:10px; margin-left:10px;'>")
                htmlOut.Append("<div style='text-align:center;'>")
            End If

            If bExcelReport Then
                htmlOut.Append(localFunctions.include_excel_report_style() + vbCrLf)
                htmlOut.Append("<table border='1' cellpadding='2' cellspacing='0'>")
            ElseIf bHtmlReport Then
                htmlOut.Append("<table class='centerTable' border='0' cellpadding='2' cellspacing='0' width='100%'>")
            End If

            If report_35_datatable.Rows.Count > 0 Then

                If chkShowReportHeader.Checked Then

                    If bExcelReport Or bHtmlReport Then

                        htmlOut.Append("<tr bgcolor='#CCCCCC'>")

                        htmlOut.Append("<td>COMPANY</td>")
                        htmlOut.Append("<td>COMPALTNAME</td>")
                        htmlOut.Append("<td>COMPEMAIL</td>")
                        htmlOut.Append("<td>COMPWEBADDRESS</td>")
                        htmlOut.Append("<td>COMPADDRESS1</td>")
                        htmlOut.Append("<td>COMPADDRESS2</td>")
                        htmlOut.Append("<td>COMPCITY</td>")
                        htmlOut.Append("<td>COMPSTATE</td>")
                        htmlOut.Append("<td>COMPSTATEABBR</td>")
                        htmlOut.Append("<td>COMPPOSTALCODE</td>")
                        htmlOut.Append("<td>COMPCOUNTRY</td>")
                        htmlOut.Append("<td>COMPOFFICE</td>")
                        htmlOut.Append("<td>COMPFAX</td>")
                        htmlOut.Append("<td>COMPMOBILE</td>")

                        If chkIncludeContacts.Checked Then
                            htmlOut.Append("<td>CONTACTPREFIX</td>")
                            htmlOut.Append("<td>CONTACTFIRSTNAME</td>")
                            htmlOut.Append("<td>CONTACTMI</td>")
                            htmlOut.Append("<td>CONTACTLASTNAME</td>")
                            htmlOut.Append("<td>CONTACTSUFFIX</td>")
                            htmlOut.Append("<td>CONTACTTITLE</td>")
                            htmlOut.Append("<td>CONTACTEMAILADDRESS</td>")
                            htmlOut.Append("<td>CONTACTOFFICE</td>")
                            htmlOut.Append("<td>CONTACTFAX</td>")
                            htmlOut.Append("<td>CONTACTMOBILE</td>")
                        End If

                        htmlOut.Append("<td>MAKETYPE</td>")
                        htmlOut.Append("<td>MAKE</td>")
                        htmlOut.Append("<td>MODEL</td>")
                        htmlOut.Append("<td>SERIALNBR</td>")
                        htmlOut.Append("<td>REGNBR</td>")
                        htmlOut.Append("<td>PERCENTOWNED</td>")
                        htmlOut.Append("<td>PURCHASEDATE</td>")

                        If nFractionalExpireYear > 0 And Not String.IsNullOrEmpty(sFractionalExpireFlag) Then
                            If sFractionalExpireFlag.ToUpper.Contains("Y") Then
                                htmlOut.Append("<td>EXPIRESDATE</td>")
                            Else
                                htmlOut.Append("<td>EXPIREDDATE</td>")
                            End If
                        Else
                            htmlOut.Append("<td>EXPIRESDATE</td>")
                        End If

                        htmlOut.Append("<td>PROGRAMHOLDER</td>")

                        htmlOut.Append("</tr>")

                    ElseIf bTextCommaReport Then

                        htmlOut.Append(Constants.QUOTE + "COMPANY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPALTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPEMAIL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPWEBADDRESS" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPADDRESS1" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPADDRESS2" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPCITY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPSTATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPSTATEABBR" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPPOSTALCODE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPCOUNTRY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPOFFICEE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPFAX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPMOBILE" + Constants.QUOTE + Constants.cCommaDelim)

                        If chkIncludeContacts.Checked Then
                            htmlOut.Append(Constants.QUOTE + "CONTACTPREFIX" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "CONTACTFIRSTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "CONTACTMI" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "CONTACTLASTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "CONTACTSUFFIX" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "CONTACTTITLE" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "CONTACTEMAILADDRESS" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "CONTACTOFFICE" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "CONTACTFAX" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "CONTACTMOBILE" + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        htmlOut.Append(Constants.QUOTE + "MAKETYPE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "MAKE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "MODEL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SERIALNBR" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "REGNBR" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PERCENTOWNED" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASEDATE" + Constants.QUOTE + Constants.cCommaDelim)

                        If nFractionalExpireYear > 0 And Not String.IsNullOrEmpty(sFractionalExpireFlag) Then
                            If sFractionalExpireFlag.ToUpper.Contains("Y") Then
                                htmlOut.Append(Constants.QUOTE + "EXPIRESDATE" + Constants.QUOTE + Constants.cCommaDelim)
                            Else
                                htmlOut.Append(Constants.QUOTE + "EXPIREDDATE" + Constants.QUOTE + Constants.cCommaDelim)
                            End If
                        Else
                            htmlOut.Append(Constants.QUOTE + "EXPIRESDATE" + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        htmlOut.Append(Constants.QUOTE + "PROGRAMHOLDER" + Constants.QUOTE)

                        htmlOut.Append(vbCrLf)

                    ElseIf bTextTabReport Then

                        htmlOut.Append("COMPANY" + vbTab)
                        htmlOut.Append("COMPALTNAME" + vbTab)
                        htmlOut.Append("COMPEMAIL" + vbTab)
                        htmlOut.Append("COMPWEBADDRESS" + vbTab)
                        htmlOut.Append("COMPADDRESS1" + vbTab)
                        htmlOut.Append("COMPADDRESS2" + vbTab)
                        htmlOut.Append("COMPCITY" + vbTab)
                        htmlOut.Append("COMPSTATE" + vbTab)
                        htmlOut.Append("COMPSTATEABBR" + vbTab)
                        htmlOut.Append("COMPPOSTALCODE" + vbTab)
                        htmlOut.Append("COMPCOUNTRY" + vbTab)
                        htmlOut.Append("COMPOFFICE" + vbTab)
                        htmlOut.Append("COMPFAX" + vbTab)
                        htmlOut.Append("COMPMOBILE" + vbTab)

                        If chkIncludeContacts.Checked Then
                            htmlOut.Append("CONTACTPREFIX" + vbTab)
                            htmlOut.Append("CONTACTFIRST NAME" + vbTab)
                            htmlOut.Append("CONTACTMI" + vbTab)
                            htmlOut.Append("CONTACTLAST NAME" + vbTab)
                            htmlOut.Append("CONTACTSUFFIX" + vbTab)
                            htmlOut.Append("CONTACTTITLE" + vbTab)
                            htmlOut.Append("CONTACTEMAILADDRESS" + vbTab)
                            htmlOut.Append("CONTACTOFFICE" + vbTab)
                            htmlOut.Append("CONTACTFAX" + vbTab)
                            htmlOut.Append("CONTACTMOBILE" + vbTab)
                        End If

                        htmlOut.Append("MAKETYPE" + vbTab)
                        htmlOut.Append("MAKE" + vbTab)
                        htmlOut.Append("MODEL" + vbTab)
                        htmlOut.Append("SERIALNBR" + vbTab)
                        htmlOut.Append("REGNBR" + vbTab)
                        htmlOut.Append("PERCENTOWNED" + vbTab)
                        htmlOut.Append("PURCHASEDATE" + vbTab)

                        If nFractionalExpireYear > 0 And Not String.IsNullOrEmpty(sFractionalExpireFlag) Then
                            If sFractionalExpireFlag.ToUpper.Contains("Y") Then
                                htmlOut.Append("EXPIRESDATE" + vbTab)
                            Else
                                htmlOut.Append("EXPIREDDATE" + vbTab)
                            End If
                        Else
                            htmlOut.Append("EXPIRESDATE" + vbTab)
                        End If

                        htmlOut.Append("PROGRAMHOLDER")

                        htmlOut.Append(vbCrLf)

                    End If 'vbTab

                End If ' chkShowReportHeader.Checked Then

                Dim nHoldCompID As Long = 0

                For Each Row As DataRow In report_35_datatable.Rows

                    htmlOut.Append(get_references_35(Row, nHoldCompID, sProgramName))

                Next

                If bHtmlReport Or bExcelReport Then
                    htmlOut.Append("</td></tr></table>")
                End If

                If bHtmlReport Then
                    htmlOut.Append("</div>")
                    htmlOut.Append("</body>")
                    htmlOut.Append("</html>")
                End If

            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Create_Report_35_Share_Holder_With_Aircraft_Information() As String" + ex.Message
        Finally
            adoRS_35 = Nothing

            report_35_datatable = Nothing

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOut.ToString

    End Function

    Public Function get_references_35(ByRef currentRow As DataRow, ByRef nHoldCompID As Long, ByVal sProgramName As String) As String


        Dim CompInfo As String = ""
        Dim CompPhoneInfo As String = ""
        Dim ContactInfo As String = ""
        Dim ContactPhoneInfo As String = ""

        Dim returnInfo As String = ""
        Dim tempInfo As String = ""

        Try

            If CLng(currentRow.Item("comp_id").ToString) <> nHoldCompID Or chkIncludeContacts.Checked Then

                ReturnCompanyInformation_Report(CLng(currentRow.Item("comp_id").ToString), 0, currentRow, CompPhoneInfo, CompInfo, chkIncludeContacts.Checked)

                If chkIncludeContacts.Checked Then

                    ReturnContactInformation_Report(CLng(currentRow.Item("comp_id").ToString), CLng(currentRow.Item("contact_id").ToString), 0, ContactInfo, ContactPhoneInfo)

                    If bHtmlReport Or bExcelReport Then
                        tempInfo = "<tr>" + CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo
                    ElseIf bTextCommaReport Or bTextTabReport Then
                        tempInfo = CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo
                    End If

                Else

                    If bHtmlReport Or bExcelReport Then
                        tempInfo = "<tr>" + CompInfo + CompPhoneInfo
                    ElseIf bTextCommaReport Or bTextTabReport Then
                        tempInfo = CompInfo + CompPhoneInfo
                    End If

                End If

                returnInfo = get_fractional_aircraft_info_35(CLng(currentRow.Item("comp_id").ToString), tempInfo, sProgramName)

                nHoldCompID = CLng(currentRow.Item("comp_id").ToString)

            End If

        Catch ex As Exception

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in get_references_35(ByVal currentRow As DataRow, ByRef nHoldCompID As Long, ByVal sProgramName As String) As String" + ex.Message

        End Try

        Return returnInfo

    End Function

    Public Function get_fractional_aircraft_info_35(ByVal inCompanyID As Long, ByVal inCompContactStr As String, ByVal inProgramName As String) As String

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim acinfo_35_datatable As New DataTable

        Dim acinfo_35 As System.Data.SqlClient.SqlDataReader : acinfo_35 = Nothing

        Dim htmlOut = New StringBuilder()
        Dim sQuery As New StringBuilder()

        Try

            sQuery.Append("SELECT DISTINCT amod_type_code, amod_make_name, amod_model_name, ac_ser_no_full, ac_reg_no, ac_id, cref_fraction_expires_date, cref_owner_percent")

            sQuery.Append(" FROM aircraft WITH(NOLOCK) INNER JOIN aircraft_reference WITH(NOLOCK) ON ac_id = cref_ac_id AND ac_journ_id = cref_journ_id")
            sQuery.Append(" INNER JOIN aircraft_model WITH(NOLOCK) ON ac_amod_id = amod_id")
            sQuery.Append(" WHERE (ac_journ_id = 0) AND (ac_ownership_type = 'F') AND (cref_comp_id = " + inCompanyID.ToString + ")")

            If nFractionalExpireYear > 0 Then

                sQuery.Append(" AND YEAR(cref_fraction_expires_date) = '" + nFractionalExpireYear.ToString + "'")

                If Now.Year = nFractionalExpireYear Then
                    If sFractionalExpireFlag.ToUpper.Contains("Y") Then
                        sQuery.Append(" AND cref_fraction_expires_date >= GETDATE()")
                    Else
                        sQuery.Append(" AND cref_fraction_expires_date <= GETDATE()")
                    End If
                End If

            End If

            sQuery.Append(" AND (cref_ac_id IN (SELECT cref_ac_id FROM aircraft_reference WITH(NOLOCK) INNER JOIN program_reference WITH(NOLOCK) ON pgref_comp_id = cref_comp_id AND cref_journ_id = 0")
            sQuery.Append(" INNER JOIN aircraft WITH(NOLOCK) ON cref_ac_id = ac_id AND cref_journ_id = ac_journ_id")
            sQuery.Append(" INNER JOIN Aircraft_Model WITH(NOLOCK) ON ac_amod_id = amod_id")
            sQuery.Append(" WHERE cref_contact_type = '17'")

            If nFractionalProgramID > 0 Then
                sQuery.Append(" AND pgref_prog_id = " + nFractionalProgramID.ToString)
            End If

            If nFractionalModelID > 0 Then
                sQuery.Append(" AND ac_amod_id = " + nFractionalModelID.ToString)
            End If

            sQuery.Append(" " + commonEvo.GenerateProductCodeSelectionQuery(HttpContext.Current.Session.Item("localPreferences"), False, False))

            sQuery.Append(" )) ORDER BY cref_fraction_expires_date asc, amod_type_code, amod_make_name, amod_model_name, ac_ser_no_full")

            'HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />get_fractional_aircraft_info_35(ByVal inCompanyID As Long, ByVal inProgramName As String) As String<br />" + sQuery.ToString

            SqlConn.ConnectionString = localFunctions.clientConnectStr

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString
            acinfo_35 = SqlCommand.ExecuteReader()

            Try
                acinfo_35_datatable.Load(acinfo_35)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = acinfo_35_datatable.GetErrors()
            End Try

            acinfo_35.Close()
            acinfo_35 = Nothing

            If acinfo_35_datatable.Rows.Count > 0 Then

                For Each Row As DataRow In acinfo_35_datatable.Rows

                    If nFractionalModelID > 0 Or inProgramName.ToUpper.Contains("UNKNOWN") Then
                        inProgramName = localFunctions.get_fractional_program_name_for_model(CLng(Row.Item("ac_id").ToString), nFractionalModelID)
                    End If

                    htmlOut.Append(inCompContactStr)

                    If bHtmlReport Or bExcelReport Then

                        If Not IsDBNull(Row("amod_type_code")) Then
                            htmlOut.Append("<td valign='middle' align='left' nowrap='nowrap'>" + Row.Item("amod_type_code").ToString + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        If Not IsDBNull(Row("amod_make_name")) Then
                            htmlOut.Append("<td valign='middle' align='left' nowrap='nowrap'>" + Row.Item("amod_make_name").ToString + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        If Not IsDBNull(Row("amod_model_name")) Then
                            htmlOut.Append("<td valign='middle' align='left' nowrap='nowrap'>" + Row.Item("amod_model_name").ToString + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        If Not IsDBNull(Row("ac_ser_no_full")) Then
                            htmlOut.Append("<td valign='middle' align='left' nowrap='nowrap' class='textformat'>" + Row.Item("ac_ser_no_full").ToString + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        If Not IsDBNull(Row("ac_reg_no")) Then
                            htmlOut.Append("<td valign='middle' align='left' nowrap='nowrap' class='textformat'>" + Row.Item("ac_reg_no").ToString + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        If Not IsDBNull(Row("cref_owner_percent")) Then
                            htmlOut.Append("<td valign='middle' align='left' nowrap='nowrap'>" + Row.Item("cref_owner_percent").ToString + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        htmlOut.Append("<td valign='middle' align='left' nowrap='nowrap'>" + localFunctions.get_fraction_purchase_date(CLng(Row.Item("ac_id").ToString), inCompanyID, True) + "</td>")

                        If Not IsDBNull(Row("cref_fraction_expires_date")) Then
                            htmlOut.Append("<td valign='middle' align='left' nowrap='nowrap'>" + FormatDateTime(Row.Item("cref_fraction_expires_date").ToString, DateFormat.ShortDate) + "</td>")
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        htmlOut.Append("<td valign='middle' align='left'>" + inProgramName.Trim + "</td>")
                        htmlOut.Append("</tr>" + vbCrLf)

                    ElseIf bTextCommaReport Then

                        If Not IsDBNull(Row("amod_type_code")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("amod_type_code").ToString + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        If Not IsDBNull(Row("amod_make_name")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("amod_make_name").ToString + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        If Not IsDBNull(Row("amod_model_name")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("amod_model_name").ToString + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        If Not IsDBNull(Row("ac_ser_no_full")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_ser_no_full").ToString + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        If Not IsDBNull(Row("ac_reg_no")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ac_reg_no").ToString + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        If Not IsDBNull(Row("cref_owner_percent")) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("cref_owner_percent").ToString + "%" + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        htmlOut.Append(Constants.QUOTE + localFunctions.get_fraction_purchase_date(CLng(Row.Item("ac_id").ToString), inCompanyID, True) + Constants.QUOTE + Constants.cCommaDelim)

                        If Not IsDBNull(Row("cref_fraction_expires_date")) Then
                            htmlOut.Append(Constants.QUOTE + FormatDateTime(Row.Item("cref_fraction_expires_date").ToString, DateFormat.ShortDate) + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        htmlOut.Append(Constants.QUOTE + inProgramName.Trim + Constants.QUOTE + vbCrLf)

                    ElseIf bTextTabReport Then

                        If Not IsDBNull(Row("amod_type_code")) Then
                            htmlOut.Append(Row.Item("amod_type_code").ToString + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        If Not IsDBNull(Row("amod_make_name")) Then
                            htmlOut.Append(Row.Item("amod_make_name").ToString + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        If Not IsDBNull(Row("amod_model_name")) Then
                            htmlOut.Append(Row.Item("amod_model_name").ToString + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        If Not IsDBNull(Row("ac_ser_no_full")) Then
                            htmlOut.Append(Row.Item("ac_ser_no_full").ToString + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        If Not IsDBNull(Row("ac_reg_no")) Then
                            htmlOut.Append(Row.Item("ac_reg_no").ToString + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        If Not IsDBNull(Row("cref_owner_percent")) Then
                            htmlOut.Append(Row.Item("cref_owner_percent").ToString + "%" + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        htmlOut.Append(localFunctions.get_fraction_purchase_date(CLng(Row.Item("ac_id").ToString), inCompanyID, True) + vbTab)

                        If Not IsDBNull(Row("cref_fraction_expires_date")) Then
                            htmlOut.Append(FormatDateTime(Row.Item("cref_fraction_expires_date").ToString, DateFormat.ShortDate) + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        htmlOut.Append(inProgramName.Trim + vbCrLf)

                    End If

                Next

            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in get_fractional_aircraft_info_35(ByVal inCompanyID As Long, ByVal inProgramName As String) As String" + ex.Message
        Finally
            acinfo_35 = Nothing

            acinfo_35_datatable = Nothing

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOut.ToString

    End Function

#End Region

#Region "report_36_functions"

    Public Function create_report_36_unique_company_contact_email(ByRef record_count As Long) As String

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand

        Dim report_36_datatable As New DataTable

        Dim adoRS_36 As System.Data.SqlClient.SqlDataReader : adoRS_36 = Nothing

        Dim report_36_ref_datatable As New DataTable

        Dim adoRS_36_ref As System.Data.SqlClient.SqlDataReader : adoRS_36_ref = Nothing

        Dim report_36_comp_datatable As New DataTable

        Dim htmlOut = New StringBuilder()
        Dim sQuery As New StringBuilder()

        Dim nEmailCounter As Long = 0
        Dim email_addresses() As String = Nothing

        Dim strContactTitleGroup As String = ""
        Dim strBusinessType As String = ""
        Dim temp_where As String = ""

        Try

            SqlConn.ConnectionString = localFunctions.clientConnectStr
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 90

            If HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("comp_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("contact_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("state_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("country_") Then '
                sQuery.Append("SELECT DISTINCT * FROM View_Aircraft_Company_Flat WITH(NOLOCK) ")
            Else
                sQuery.Append("SELECT DISTINCT * FROM View_Aircraft_Flat WITH(NOLOCK) ")
            End If

            temp_where = HttpContext.Current.Session.Item("MasterAircraftWhere").ToString

            temp_where = Replace(temp_where, "00,97,17,08,16", "00','97','17','08','16")

            sQuery.Append(temp_where)
            sQuery.Append(" ORDER BY amod_make_name, amod_airframe_type_code, amod_type_code, amod_id, amod_model_name, ac_ser_no_sort")

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />Create_Report_36_Unique_Company_Contact_Email() As String<br />" + sQuery.ToString

            SqlCommand.CommandText = sQuery.ToString
            adoRS_36 = SqlCommand.ExecuteReader()

            Try
                report_36_datatable.Load(adoRS_36)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = report_36_datatable.GetErrors()
            End Try

            record_count = report_36_datatable.Rows.Count

            adoRS_36.Close()
            adoRS_36 = Nothing

            If report_36_datatable.Rows.Count > 0 Then

                For Each aircraft_row As DataRow In report_36_datatable.Rows

                    If Not IsNothing(HttpContext.Current.Session.Item("Advanced-cref_business_type")) Then
                        If Not String.IsNullOrEmpty(HttpContext.Current.Session.Item("Advanced-cref_business_type").ToString.Trim) Then
                            strBusinessType = HttpContext.Current.Session.Item("Advanced-cref_business_type").ToString.Trim
                        End If
                    End If

                    sQuery = New StringBuilder()
                    report_36_comp_datatable = New DataTable

                    sQuery.Append("SELECT DISTINCT cref_comp_id, cref_contact_id")
                    sQuery.Append(" FROM Aircraft_Reference WITH(NOLOCK) INNER JOIN Company WITH(NOLOCK) ON (cref_comp_id = comp_id and cref_journ_id = comp_journ_id)")
                    sQuery.Append(" INNER JOIN Aircraft_Contact_Type WITH(NOLOCK) ON (cref_contact_type = actype_code)")
                    sQuery.Append(" LEFT OUTER JOIN State WITH(NOLOCK) ON (comp_state = state_code AND comp_country = state_country)")

                    sQuery.Append(" WHERE (cref_ac_id = " + aircraft_row.Item("ac_id").ToString + " AND cref_journ_id = 0")
                    sQuery.Append(" AND comp_active_flag = 'Y' AND comp_hide_flag = 'N')")

                    If Not String.IsNullOrEmpty(strBusinessType.Trim) Then
                        sQuery.Append(" AND comp_business_type IN ('" + Replace(strBusinessType.Trim, Constants.cDymDataSeperator, Constants.cValueSeperator) + "')")
                    End If

                    ' Hide Exclusive Brokers and Representatives and Dealers from Aerodex users  
                    If bAerodexFlag Then
                        sQuery.Append(" AND cref_contact_type NOT IN ('93','98','99','66','67','68','71')")
                    Else
                        sQuery.Append(" AND cref_contact_type NOT IN ('66','67','68','71')")
                    End If

                    If Not IsNothing(HttpContext.Current.Session.Item("Advanced-cref_contact_type")) Then

                        If Not String.IsNullOrEmpty(HttpContext.Current.Session.Item("Advanced-cref_contact_type")) Then

                            ' special case for "operator"
                            If HttpContext.Current.Session.Item("Advanced-cref_contact_type").ToString.ToUpper.Contains("Y") Then
                                sQuery.Append(" AND cref_operator_flag IN ('Y', 'O')")
                            Else

                                If Not IsNothing(HttpContext.Current.Session.Item("Advanced-comp_not_in_selected")) Then

                                    temp_where = HttpContext.Current.Session.Item("Advanced-cref_contact_type").ToString

                                    temp_where = Replace(temp_where, "00,97,17,08,16", "00','97','17','08','16")


                                    If Not String.IsNullOrEmpty(HttpContext.Current.Session.Item("Advanced-comp_not_in_selected")) Then
                                        sQuery.Append(" AND cref_contact_type NOT IN ('" + Replace(temp_where, Constants.cDymDataSeperator, Constants.cValueSeperator) + "')")
                                    Else
                                        sQuery.Append(" AND cref_contact_type IN ('" + Replace(temp_where, Constants.cDymDataSeperator, Constants.cValueSeperator) + "')")
                                    End If

                                Else


                                    temp_where = HttpContext.Current.Session.Item("Advanced-cref_contact_type").ToString

                                    temp_where = Replace(temp_where, "00,97,17,08,16", "00','97','17','08','16")


                                    sQuery.Append(" AND cref_contact_type IN ('" + Replace(temp_where, Constants.cDymDataSeperator, Constants.cValueSeperator) + "')")
                                End If

                            End If

                        End If

                    End If

                    sQuery.Append(" " + commonEvo.MakeCompanyProductCodeClause(HttpContext.Current.Session.Item("localPreferences"), False))

                    sQuery.Append(" ORDER BY cref_comp_id, cref_contact_id ")

                    SqlCommand.CommandText = sQuery.ToString
                    adoRS_36 = SqlCommand.ExecuteReader()

                    Try
                        report_36_comp_datatable.Load(adoRS_36)
                    Catch constrExc As System.Data.ConstraintException
                        Dim rowsErr As System.Data.DataRow() = report_36_comp_datatable.GetErrors()
                    End Try

                    If report_36_comp_datatable.Rows.Count > 0 Then

                        For Each company_row As DataRow In report_36_comp_datatable.Rows

                            sQuery = New StringBuilder()

                            sQuery.Append("SELECT comp_email_address FROM Company WITH (NOLOCK) ")
                            sQuery.Append("WHERE (comp_id = " + company_row.Item("cref_comp_id").ToString + ") ")
                            sQuery.Append("AND (comp_journ_id = 0) ")
                            sQuery.Append("AND (comp_email_address IS NOT NULL) ")
                            sQuery.Append("AND (comp_email_address <> '') ")

                            SqlCommand.CommandText = sQuery.ToString
                            adoRS_36_ref = SqlCommand.ExecuteReader()

                            Try
                                report_36_ref_datatable.Load(adoRS_36_ref)
                            Catch constrExc As System.Data.ConstraintException
                                Dim rowsErr As System.Data.DataRow() = report_36_ref_datatable.GetErrors()
                            End Try

                            adoRS_36_ref.Close()
                            adoRS_36_ref = Nothing

                            If report_36_ref_datatable.Rows.Count > 0 Then

                                For Each company_email_row As DataRow In report_36_ref_datatable.Rows

                                    If Not IsDBNull(company_email_row.Item("comp_email_address")) Then
                                        If Not String.IsNullOrEmpty(company_email_row.Item("comp_email_address").ToString.Trim) Then

                                            If Not commonEvo.inMyArray(email_addresses, company_email_row.Item("comp_email_address").ToString.Trim) Then

                                                If Not IsArray(email_addresses) And IsNothing(email_addresses) Then
                                                    ReDim email_addresses(nEmailCounter)
                                                Else
                                                    ReDim Preserve email_addresses(nEmailCounter)
                                                End If

                                                ' Add email address To Array
                                                email_addresses(nEmailCounter) = company_email_row.Item("comp_email_address").ToString.Trim
                                                nEmailCounter += 1

                                            End If

                                        End If
                                    End If

                                Next

                            End If

                            report_36_ref_datatable = New DataTable

                            ' CHANGED - IF IT IS INCLUDE ALL - THEN WE MUST GET ALL OF THE CONTACTS 
                            If chkIncludeAllContacts.Checked = True Then

                                sQuery = New StringBuilder()

                                sQuery.Append("SELECT contact_email_address FROM Contact WITH (NOLOCK) ")
                                sQuery.Append("WHERE (contact_comp_id = " + company_row.Item("cref_comp_id").ToString + ") ")
                                sQuery.Append("AND (contact_journ_id = 0) ")
                                sQuery.Append("AND (contact_email_address IS NOT NULL) ")
                                sQuery.Append("AND (contact_email_address <> '') ")
                                sQuery.Append("AND (contact_hide_flag = 'N') ")
                                sQuery.Append("AND (contact_active_flag = 'Y') ")

                                HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />Create_Report_36_Unique_Company_Contact_Email() As String<br />" + sQuery.ToString

                                SqlCommand.CommandText = sQuery.ToString
                                adoRS_36_ref = SqlCommand.ExecuteReader()

                                Try
                                    report_36_ref_datatable.Load(adoRS_36_ref)
                                Catch constrExc As System.Data.ConstraintException
                                    Dim rowsErr As System.Data.DataRow() = report_36_ref_datatable.GetErrors()
                                End Try

                                adoRS_36_ref.Close()
                                adoRS_36_ref = Nothing

                                If report_36_ref_datatable.Rows.Count > 0 Then

                                    For Each contact_email_row As DataRow In report_36_ref_datatable.Rows

                                        If Not IsDBNull(contact_email_row.Item("contact_email_address")) Then
                                            If Not String.IsNullOrEmpty(contact_email_row.Item("contact_email_address").ToString.Trim) Then

                                                ' if contact email is not in array then add it to array
                                                If Not commonEvo.inMyArray(email_addresses, contact_email_row.Item("contact_email_address").ToString) Then

                                                    If Not IsArray(email_addresses) And IsNothing(email_addresses) Then
                                                        ReDim email_addresses(nEmailCounter)
                                                    Else
                                                        ReDim Preserve email_addresses(nEmailCounter)
                                                    End If

                                                    ' Add email address To Array
                                                    email_addresses(nEmailCounter) = contact_email_row.Item("contact_email_address").ToString.Trim
                                                    nEmailCounter += 1

                                                End If

                                            End If
                                        End If

                                    Next ' contact_email_row

                                End If

                            ElseIf chkIncludeContacts.Checked = True Then  'else include just the attached contacts

                                sQuery = New StringBuilder()

                                sQuery.Append("SELECT contact_email_address FROM Contact WITH (NOLOCK) ")
                                sQuery.Append("WHERE (contact_comp_id = " + company_row.Item("cref_comp_id").ToString + ") ")
                                sQuery.Append("AND (contact_id = " + company_row.Item("cref_contact_id").ToString + ") ")
                                sQuery.Append("AND (contact_journ_id = 0) ")
                                sQuery.Append("AND (contact_email_address IS NOT NULL) ")
                                sQuery.Append("AND (contact_email_address <> '') ")
                                sQuery.Append("AND (contact_hide_flag = 'N') ")
                                sQuery.Append("AND (contact_active_flag = 'Y') ")

                                HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />Create_Report_36_Unique_Company_Contact_Email() As String<br />" + sQuery.ToString

                                SqlCommand.CommandText = sQuery.ToString
                                adoRS_36_ref = SqlCommand.ExecuteReader()

                                Try
                                    report_36_ref_datatable.Load(adoRS_36_ref)
                                Catch constrExc As System.Data.ConstraintException
                                    Dim rowsErr As System.Data.DataRow() = report_36_ref_datatable.GetErrors()
                                End Try

                                adoRS_36_ref.Close()
                                adoRS_36_ref = Nothing

                                If report_36_ref_datatable.Rows.Count > 0 Then

                                    For Each contact_email_row As DataRow In report_36_ref_datatable.Rows

                                        If Not IsDBNull(contact_email_row.Item("contact_email_address")) Then
                                            If Not String.IsNullOrEmpty(contact_email_row.Item("contact_email_address").ToString.Trim) Then

                                                ' if contact email is not in array then add it to array
                                                If Not commonEvo.inMyArray(email_addresses, contact_email_row.Item("contact_email_address").ToString) Then

                                                    If Not IsArray(email_addresses) And IsNothing(email_addresses) Then
                                                        ReDim email_addresses(nEmailCounter)
                                                    Else
                                                        ReDim Preserve email_addresses(nEmailCounter)
                                                    End If

                                                    ' Add email address To Array
                                                    email_addresses(nEmailCounter) = contact_email_row.Item("contact_email_address").ToString.Trim
                                                    nEmailCounter += 1

                                                End If

                                            End If
                                        End If

                                    Next ' contact_email_row

                                End If

                            Else


                            End If ' not chkIncludeContacts

                        Next ' company_row

                    End If

                Next ' aircraft_row

            End If

            If bHtmlReport Then
                htmlOut.Append("<!DOCTYPE html>")
                htmlOut.Append("<html lang='en'>")
                htmlOut.Append("<head>")
                htmlOut.Append("<meta http-equiv='Content-Language' content='en-us' />")
                htmlOut.Append("<meta http-equiv='Content-Type' content='text/html; charset=windows-1252' />")
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='common/jetnet.css' />")
                htmlOut.Append("<title>JETNET - Unique Company/Contact Email</title>")
                htmlOut.Append("</head>")
                htmlOut.Append("<body style='background: white; margin-top:10px; margin-left:10px;'>")
                htmlOut.Append("<div style='text-align:center;'>")
            End If

            If bExcelReport Then
                htmlOut.Append("<table border='1' cellpadding='2' cellspacing='0'>")
            ElseIf bHtmlReport Then
                htmlOut.Append("<table class='centerTable' border='0' cellpadding='2' cellspacing='0' width='100%'>")
            End If

            If bHtmlReport Or bExcelReport Then
                htmlOut.Append("<tr bgcolor='#CCCCCC'><td><b>EMAILADDRESS</b></td></tr>")

                For Each email As String In email_addresses
                    If Not String.IsNullOrEmpty(email.Trim) Then
                        htmlOut.Append("<tr><td>" + email.Trim + "</td></tr>")
                    End If
                Next

                htmlOut.Append("</table>")

            ElseIf bTextCommaReport Then

                For Each email As String In email_addresses
                    If Not String.IsNullOrEmpty(email.Trim) Then
                        htmlOut.Append(Constants.QUOTE + email.Trim + Constants.QUOTE + vbCrLf)
                    End If
                Next

            ElseIf bTextTabReport Then

                For Each email As String In email_addresses
                    If Not String.IsNullOrEmpty(email.Trim) Then
                        htmlOut.Append(email.Trim + vbCrLf)
                    End If
                Next

            End If

            If bHtmlReport Then
                htmlOut.Append("</div>")
                htmlOut.Append("</body>")
                htmlOut.Append("</html>")
            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Create_Report_36_Unique_Company_Contact_Email() As String" + ex.Message
        Finally

            adoRS_36 = Nothing

            report_36_ref_datatable = Nothing

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOut.ToString

        sQuery = Nothing

    End Function

#End Region

#Region "report_39_functions"

    Public Function create_single_page_spec_sheet(ByVal item_string As Array, ByRef record_count As Long) As String

        Dim htmlOut = New StringBuilder()

        Try


            htmlOut.Append("<html><head><title>Single Page Spec Sheet</title>" + build_style_single_and_condensed_page_spec() + "</head>")



            If bWordReport = True Then
                htmlOut.Append("<table width='" & word_width_new & "' align='center'>")
                htmlOut.Append("<tr valign='top'><td width='100%'>")
                htmlOut.Append("<table>")
            Else
            End If



            For i As Integer = 0 To UBound(item_string)

                record_count = UBound(item_string)

                If bWordReport = True Then
                    htmlOut.Append("<tr><td>")
                End If

                If i > 0 And bWordReport = True Then
                    htmlOut.Append("</table></td></tr></table>")
                    htmlOut.Append("<br style='page-break-before: always'>")
                    htmlOut.Append("<table width='" & word_width_new & "' align='center'>")
                    htmlOut.Append("<tr valign='top'><td width='100%'>")
                    htmlOut.Append("<table>")
                End If

                htmlOut.Append(build_single_page_spec_sheet(CLng(item_string(i)), comp_id))

                If UBound(item_string) > 0 Then
                    htmlOut.Append("<table width='100%' align='center' class='break'><tr><td>&nbsp;</td></tr></table>")
                End If


                If bWordReport = True Then
                    htmlOut.Append("</td></tr>")
                End If

            Next

            If bWordReport = True Then
                htmlOut.Append("</table></td></tr></table>")
            End If

            '  htmlOut.Append("</div></body></html>")

        Catch ex As Exception

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in create_single_page_spec_sheet(ByVal item_string As Array) As String" + ex.Message

        End Try

        Return htmlOut.ToString

        htmlOut = Nothing

    End Function

    Public Function build_single_page_spec_sheet(ByVal nAircraftID As Long, ByVal comp_id As Long) As String ' 

        Dim imgDisplayFolder As String = ""

        If HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then

            If Not Application.Item("crmClientSiteData").crmClientHostName.ToString.ToUpper.Contains("NEWEVONET") Then
                imgDisplayFolder = "https://www.testjetnetevolution.com/" + HttpContext.Current.Session.Item("AircraftPicturesFolderVirtualPath")
            Else
                imgDisplayFolder = "http://www.jetnetevolution.com/" + HttpContext.Current.Session.Item("AircraftPicturesFolderVirtualPath")
            End If

        Else
            imgDisplayFolder = Application.Item("crmClientSiteData").ClientFullHostName.ToString.Trim + HttpContext.Current.Session.Item("AircraftPicturesFolderVirtualPath")
        End If


        Dim imgFileName As String = ""

        Dim sqlReaderTemp As System.Data.SqlClient.SqlDataReader = Nothing
        Dim sqlReader As System.Data.SqlClient.SqlDataReader = Nothing

        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlConn2 As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim SqlCommand2 As New System.Data.SqlClient.SqlCommand

        Dim fApicSubject As String = ""
        Dim fAcpic_image_type As String = ""
        Dim fAcpic_id As Integer = 0
        Dim pic_seq_num As Integer = 0

        Dim Query As String = ""
        Dim htmlOutput As String = ""
        Dim nAircraftJournalID As Long = 0
        Dim tempStr As String = ""
        Dim xLoop As Integer = 0
        Dim sAirframeType As String = ""
        Dim sAircraftType As String = ""
        Dim nloopCount As Integer = 0
        Dim bHasMainBlades As Boolean = False
        Dim bHasTailBlades As Boolean = False
        Dim sLabel As String = ""
        Dim ajavascript As String = ""
        Dim temp_moyear As String = ""
        Dim htmlOutput_start As String = ""

        Dim string_for_word As String = ""
        Dim logo_link As String = ""

        Dim temp_folder1 As String = ""
        Dim apu_maint_prog As String = ""
        Dim ac_image_file As String = ""
        Dim temp_height As Integer = 0
        Dim temp_width As Integer = 0
        Dim zimage2 As System.Drawing.Image
        Dim zimage3 As System.Drawing.Image
        Dim desired_width As Integer = 360
        Dim desired_height As Integer = 140
        Dim temp_percent1 As Double = 0.0
        Dim temp_percent2 As Double = 0.0
        Dim total_width As Integer = 0
        Dim width_size_total As Integer = 740
        Dim add_pic As String = "Y"
        Dim ac_status As String = ""
        Dim data_details As String = ""
        Dim data_type_last As String = ""
        Dim nAddToAskingPrice As Double = 0
        Dim ext_doneby As String = ""
        Dim realout As String = ""
        Dim logo_string As String = ""

        Try

            If Trim(Request("journ_id")) <> "" Then
                nAircraftJournalID = CLng(Trim(Request("journ_id")))
            End If

            SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            SqlConn2.ConnectionString = localFunctions.clientConnectStr

            SqlConn.Open()
            SqlConn2.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand2.Connection = SqlConn2
            SqlCommand2.CommandType = System.Data.CommandType.Text
            SqlCommand2.CommandTimeout = 60

            htmlOutput_start += "<br /><table class='centerTable' border='1' bordercolor='#949494' cellpadding='2' cellspacing='0' width='95%'>"

            htmlOutput_start += "<tr id='TR_Main_Table_For_AC_ID_Status_Pic'>"
            htmlOutput_start += "<td id='TD_Inner_Table_AC_ID_Status_Pic' valign='top' width='100%'>"
            htmlOutput_start += "<table id='Top_Table_Aircraft_Identification_Status' valign='top' width='100%'  cellspacing='0' cellpadding='0'>"
            htmlOutput_start += "<tr id='TR_Aircraft_Idenification_Status_Logo_N_AC_Pic'>"
            htmlOutput_start += "<td colspan='2' width='40%' id='Aircraft_Idenification_Status' valign='top'>"

            Query = "SELECT DISTINCT * FROM Company WITH(NOLOCK) WHERE (comp_journ_id =  0 AND comp_id = " + comp_id.ToString + " AND comp_hide_flag = 'N')"

            SqlCommand.CommandText = Query
            sqlReaderTemp = SqlCommand.ExecuteReader()

            htmlOutput += "<table cellspacing='0' cellpadding='0'><tr><td width='2%'>&nbsp;</td><td>" ' start outer table

            If sqlReaderTemp.HasRows Then

                sqlReaderTemp.Read()

                htmlOutput += "<table class='FontSize' cellspacing='0' cellpadding='0'>" ' start company info table


                If bWordReport Then ' this section copied and added msw - 4/26/16

                    logo_string &= "<td>"

                    If Not IsDBNull(sqlReaderTemp("comp_logo_flag")) And logo_check.Checked Then
                        If sqlReaderTemp.Item("comp_logo_flag").ToString.ToUpper.Contains("Y") And logo_check.Checked Then

                            If HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then

                                If Not Application.Item("crmClientSiteData").crmClientHostName.ToString.ToUpper.Contains("NEWEVONET") Then
                                    logo_link = "https://www.testjetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                                Else
                                    logo_link = "http://www.jetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                                End If

                            Else
                                logo_link = Application.Item("crmClientSiteData").ClientFullHostName.ToString.Trim + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                            End If

                            logo_string &= "<img src='" + logo_link + "/" + sqlReaderTemp("comp_id").ToString + ".jpg' width='150' height='75'>"
                        ElseIf invisible_label_parent_image.Text.ToString.Trim <> "" And logo_check.Checked Then

                            If HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then

                                If Not Application.Item("crmClientSiteData").crmClientHostName.ToString.ToUpper.Contains("NEWEVONET") Then
                                    logo_link = "https://www.testjetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                                Else
                                    logo_link = "http://www.jetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                                End If

                            Else
                                logo_link = Application.Item("crmClientSiteData").ClientFullHostName.ToString.Trim + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                            End If

                            logo_string &= "<img src='" + logo_link + "/" + invisible_label_parent_image.Text + ".jpg' width='150' height='75'>"
                        End If
                    ElseIf invisible_label_parent_image.Text.ToString.Trim <> "" And logo_check.Checked Then

                        If HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then

                            If Not Application.Item("crmClientSiteData").crmClientHostName.ToString.ToUpper.Contains("NEWEVONET") Then
                                logo_link = "https://www.testjetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                            Else
                                logo_link = "http://www.jetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                            End If

                        Else
                            logo_link = Application.Item("crmClientSiteData").ClientFullHostName.ToString.Trim + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                        End If

                        logo_string &= "<img src='" + logo_link + "/" + invisible_label_parent_image.Text + ".jpg' width='150' height='75'>"
                    End If
                    logo_string &= "</td>"

                Else
                    If Not IsDBNull(sqlReaderTemp("comp_logo_flag")) And logo_check.Checked Then
                        If sqlReaderTemp.Item("comp_logo_flag").ToString.ToUpper.Contains("Y") And logo_check.Checked Then

                            If HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then

                                If Not Application.Item("crmClientSiteData").crmClientHostName.ToString.ToUpper.Contains("NEWEVONET") Then
                                    logo_link = "https://www.testjetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                                Else
                                    logo_link = "http://www.jetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                                End If

                            Else
                                logo_link = Application.Item("crmClientSiteData").ClientFullHostName.ToString.Trim + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                            End If

                            htmlOutput += "<img src='" + logo_link + "/" + sqlReaderTemp("comp_id").ToString + ".jpg' width='150'></td><td>"
                        ElseIf invisible_label_parent_image.Text.ToString.Trim <> "" And logo_check.Checked Then

                            If HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then

                                If Not Application.Item("crmClientSiteData").crmClientHostName.ToString.ToUpper.Contains("NEWEVONET") Then
                                    logo_link = "https://www.testjetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                                Else
                                    logo_link = "http://www.jetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                                End If

                            Else
                                logo_link = Application.Item("crmClientSiteData").ClientFullHostName.ToString.Trim + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                            End If

                            htmlOutput += "<img src='" + logo_link + "/" + invisible_label_parent_image.Text + ".jpg' width='150'></td><td>"
                        End If
                    ElseIf invisible_label_parent_image.Text.ToString.Trim <> "" And logo_check.Checked Then

                        If HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then

                            If Not Application.Item("crmClientSiteData").crmClientHostName.ToString.ToUpper.Contains("NEWEVONET") Then
                                logo_link = "https://www.testjetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                            Else
                                logo_link = "http://www.jetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                            End If

                        Else
                            logo_link = Application.Item("crmClientSiteData").ClientFullHostName.ToString.Trim + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                        End If

                        htmlOutput += "<img src='" + logo_link + "/" + invisible_label_parent_image.Text + ".jpg' width='150'></td><td>"
                    End If
                End If

                If bWordReport Then
                    htmlOutput += "<tr valign='top'><td><table cellspacing='0' cellpadding='0'>"
                End If

                If Not IsDBNull(sqlReaderTemp("comp_name")) Then
                    If Not String.IsNullOrEmpty(sqlReaderTemp.Item("comp_name").ToString.Trim) Then
                        htmlOutput += "<tr><td><font size='-1'><strong><i>" + sqlReaderTemp.Item("comp_name").ToString + "</i></strong></font></td></tr>"
                    End If
                End If

                If Not IsDBNull(sqlReaderTemp("comp_address1")) Then
                    If Not String.IsNullOrEmpty(sqlReaderTemp.Item("comp_address1").ToString.Trim) Then
                        tempStr = "<tr><td><font size='-1'>" + sqlReaderTemp.Item("comp_address1").ToString.Trim + "</font></td></tr>"
                    End If
                End If

                If Not IsDBNull(sqlReaderTemp("comp_address2")) Then
                    If Not String.IsNullOrEmpty(sqlReaderTemp.Item("comp_address2").ToString.Trim) Then
                        tempStr += "<tr><td><font size='-1'>" + sqlReaderTemp.Item("comp_address2").ToString.Trim + "</font></td></tr>"
                    End If
                End If

                If Not IsDBNull(sqlReaderTemp("comp_city")) Or Not IsDBNull(sqlReaderTemp("comp_state")) Or Not IsDBNull(sqlReaderTemp("comp_zip_code")) Then
                    tempStr += "<tr><td><font size='-1'>"
                End If

                If Not IsDBNull(sqlReaderTemp("comp_city")) Then
                    If Not String.IsNullOrEmpty(sqlReaderTemp.Item("comp_city").ToString.Trim) Then

                        tempStr += sqlReaderTemp.Item("comp_city").ToString.Trim

                        If Not IsDBNull(sqlReaderTemp("comp_state")) Then
                            If Not String.IsNullOrEmpty(sqlReaderTemp.Item("comp_state").ToString.Trim) Then
                                tempStr += ", " + sqlReaderTemp.Item("comp_state").ToString.Trim
                            End If
                        End If

                    End If

                Else

                    If Not IsDBNull(sqlReaderTemp("comp_state")) Then
                        If Not String.IsNullOrEmpty(sqlReaderTemp.Item("comp_state").ToString.Trim) Then
                            tempStr += sqlReaderTemp.Item("comp_state").ToString.Trim
                        End If
                    End If

                End If

                If Not IsDBNull(sqlReaderTemp("comp_zip_code")) Then
                    If Not String.IsNullOrEmpty(sqlReaderTemp.Item("comp_zip_code").ToString.Trim) Then
                        tempStr += " " + sqlReaderTemp.Item("comp_zip_code").ToString.Trim
                    End If
                End If

                If Not IsDBNull(sqlReaderTemp("comp_city")) Or Not IsDBNull(sqlReaderTemp("comp_state")) Or Not IsDBNull(sqlReaderTemp("comp_zip_code")) Then
                    tempStr += "</font></td></tr>"
                End If

                If Not IsDBNull(sqlReaderTemp("comp_web_address")) Then
                    If Not String.IsNullOrEmpty(sqlReaderTemp.Item("comp_web_address").ToString.Trim) Then
                        tempStr += "<tr><td><font size='-1'>" + sqlReaderTemp.Item("comp_web_address").ToString.Trim + "</font></td></tr>"
                    End If
                End If
                If Not IsDBNull(sqlReaderTemp("comp_email_address")) Then
                    If Not String.IsNullOrEmpty(sqlReaderTemp.Item("comp_email_address").ToString.Trim) Then
                        tempStr += "<tr><td><font size='-1'>" + sqlReaderTemp.Item("comp_email_address").ToString.Trim + "</font></td></tr>"
                    End If
                End If

            End If

            sqlReaderTemp.Close()

            Query = "SELECT * FROM Phone_Numbers WITH(NOLOCK), Phone_Type WITH(NOLOCK)"
            Query = Query + " WHERE pnum_comp_id = " + comp_id.ToString
            Query = Query + " AND pnum_journ_id = " + nAircraftJournalID.ToString
            Query = Query + " AND pnum_hide_customer = 'N' AND pnum_contact_id = 0"
            Query = Query + " AND pnum_type = ptype_name ORDER BY pnum_type desc"  ' QUERY EDITED TO DISPLAY TOLL FREE THEN OFFICE THEN FAX

            SqlCommand.CommandText = Query
            sqlReaderTemp = SqlCommand.ExecuteReader()

            If sqlReaderTemp.HasRows Then
                Do While sqlReaderTemp.Read
                    tempStr += "<tr><td><font size='-1'><b>" + sqlReaderTemp.Item("pnum_type").ToString.Trim + "</b>: " + sqlReaderTemp.Item("pnum_number_full").ToString.Trim + "</font></td></tr>"
                Loop
            End If

            htmlOutput += tempStr

            sqlReaderTemp.Close()



            If bWordReport Then
                htmlOutput += "</table></td> "
                htmlOutput &= logo_string
                htmlOutput &= "</tr>"
            End If


            htmlOutput += "</table>" ' end company info table


            htmlOutput += "</td></tr>"
            htmlOutput += "<tr><td width='2%'>&nbsp;</td><td>"

            ' get the Aircraft Identification / Status info 
            Query = "SELECT * FROM Aircraft WITH(NOLOCK) INNER JOIN Aircraft_Model WITH(NOLOCK) ON ac_amod_id = amod_id"
            Query = Query + " WHERE ac_journ_id = " + nAircraftJournalID.ToString + " and ac_id = " + nAircraftID.ToString

            SqlCommand2.CommandText = Query
            sqlReader = SqlCommand2.ExecuteReader()

            If sqlReader.HasRows Then

                sqlReader.Read()

                htmlOutput += "<table id='Aircraft_Identification_Status' class='FontSize' cellspacing='0' cellpadding='0'>" 'class='SpecsTableBorderLittle'
                ' make
                If Not IsDBNull(sqlReader.Item("amod_make_name")) Then
                    htmlOutput += "<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font size='-8'>&nbsp</font><br><font size='-1'>"
                    htmlOutput += sqlReader.Item("amod_make_name") + "&nbsp;"
                End If
                ' model
                If Not IsDBNull(sqlReader.Item("amod_model_name")) Then
                    htmlOutput += sqlReader.Item("amod_model_name")
                End If

                If chkBlindReport.Checked = False Then
                    ' serial number
                    htmlOutput &= "&nbsp;&nbsp;&nbsp;<b>Ser#/Reg#: </b>"
                    If Not IsDBNull(sqlReader.Item("ac_ser_no_full")) Then
                        htmlOutput &= sqlReader.Item("ac_ser_no_full")
                    End If

                    If Not IsDBNull(sqlReader.Item("ac_reg_no")) Then
                        htmlOutput += "&nbsp;/&nbsp;" + sqlReader.Item("ac_reg_no")
                    End If
                End If

                htmlOutput += "</font></td></tr>"


                ' year of manufacture
                If Not IsDBNull(sqlReader.Item("ac_mfr_year")) Then
                    htmlOutput += "<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font size='-1'><b>Year Mfr/Dlv: </b>" + sqlReader.Item("ac_mfr_year")
                End If
                ' year dlv
                If Not IsDBNull(sqlReader.Item("ac_year")) Then
                    htmlOutput += "&nbsp;/&nbsp;" + sqlReader.Item("ac_year") + "</font>"
                Else
                    htmlOutput += "</font>"
                End If

                ' airframe total time
                If Not IsDBNull(sqlReader.Item("ac_airframe_tot_hrs")) Then
                    htmlOutput += "&nbsp;&nbsp;&nbsp;<font size='-1'><b>Airframe Total Time(AFTT): </b>" + FormatNumber(sqlReader.Item("ac_airframe_tot_hrs"), 0) + "</font></td></tr>"
                Else
                    htmlOutput += "&nbsp;</td></tr>"
                End If
                ' landing cycles
                If Not IsDBNull(sqlReader.Item("ac_airframe_tot_landings")) Then
                    htmlOutput += "<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font size='-1'><b>Landings/Cycles: </b>" + FormatNumber(sqlReader.Item("ac_airframe_tot_landings"), 0) + "</font></td></tr>"
                End If

                If Not IsDBNull(sqlReader.Item("ac_exterior_rating")) Then
                    ext_doneby &= "<font size='-1'><b>Ext Rating: </b>" + sqlReader.Item("ac_exterior_rating").ToString + " </font>"
                End If

                If Not IsDBNull(sqlReader.Item("ac_exterior_doneby_name")) Then
                    ext_doneby &= "<font size='-1'><b>Ext Done By: </b>" + sqlReader.Item("ac_exterior_doneby_name").ToString + " </font>"
                End If


                If Not bAerodexFlag And chkIncludesale.Checked = True Then


                    htmlOutput &= "<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font size='-1'><b>For Sale Information"

                    If Not IsDBNull(sqlReader.Item("ac_list_date")) And Not String.IsNullOrEmpty(sqlReader.Item("ac_list_date").ToString) Then
                        htmlOutput &= " (Date Listed: " + FormatDateTime(sqlReader.Item("ac_list_date").ToString.Trim, DateFormat.ShortDate) + ")"
                    Else

                        If Not IsDBNull(sqlReader.Item("ac_status")) Then
                            If Trim(sqlReader.Item("ac_status")) = "Not for Sale" Then
                                htmlOutput &= ":</b>&nbsp;Not For Sale"
                            End If
                        End If
                        htmlOutput &= "&nbsp;"
                    End If



                    htmlOutput &= "</b></font>&nbsp;</td></tr>"

                    If chkBlindReport.Checked = False Then
                        If Not IsDBNull(sqlReader.Item("ac_status")) Then
                            If Trim(sqlReader.Item("ac_status")) <> "Not for Sale" Then
                                ac_status = sqlReader.Item("ac_status").ToString.ToUpper
                                If ac_status.ToUpper.Contains("FOR SALE/TRADE") And sqlReader.Item("ac_asking").ToString.ToUpper.Contains("SALE/TRADE") Then
                                    ac_status = ""
                                Else
                                    htmlOutput &= "<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font size='-1'><b>Status:</b> "
                                    htmlOutput &= sqlReader.Item("ac_status").ToString + "</font></td></tr>"

                                    If Not IsDBNull(sqlReader.Item("ac_confidential_notes")) Then
                                        If Not String.IsNullOrEmpty(sqlReader.Item("ac_confidential_notes")) Then
                                            htmlOutput &= ("<tr><td width='2%'>&nbsp;</td><td><font size='-1'><b>Note: </b>&nbsp;")
                                            htmlOutput &= ("" + sqlReader.Item("ac_confidential_notes").ToString + "&nbsp;</font></td></tr>")
                                        End If
                                    End If

                                End If
                            End If
                        End If
                    End If

                    If Not IsDBNull(sqlReader.Item("ac_asking")) And Not String.IsNullOrEmpty(sqlReader.Item("ac_asking").ToString) Then

                        If LCase(sqlReader.Item("ac_asking")).ToString.Contains("price") Then
                            'This means the asking contains the word price so a price needs to be displayed
                            If Not IsDBNull(sqlReader.Item("ac_foreign_currency_price")) And Not String.IsNullOrEmpty(sqlReader.Item("ac_foreign_currency_price").ToString) Then
                                htmlOutput &= "<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font size='-1'><b>Asking&nbsp;Amt&nbsp; </b>"

                                ' If Not IsDBNull(sqlReader.Item("ac_foreign_currency_price")) And Not String.IsNullOrEmpty(sqlReader.Item("ac_foreign_currency_price").ToString) Then
                                If Not IsDBNull(sqlReader.Item("ac_foreign_currency_price")) And Not String.IsNullOrEmpty(sqlReader.Item("ac_foreign_currency_price").ToString) Then
                                    htmlOutput &= FormatNumber(sqlReader.Item("ac_foreign_currency_price").ToString.Trim, 0, True, False, True)
                                Else
                                    htmlOutput &= "&nbsp;"
                                End If
                                htmlOutput &= sqlReader.Item("ac_foreign_currency_name").ToString
                                htmlOutput &= "</font></td></tr>"
                                'End If
                            Else

                                htmlOutput &= "<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font size='-1'><b>Asking&nbsp;Amt&nbsp; </b>"

                                If Not String.IsNullOrEmpty(addToAsking.Text.Trim) Then
                                    nAddToAskingPrice = CDbl(Replace(addToAsking.Text, Constants.cCommaDelim, Constants.cEmptyString))

                                    If Not IsDBNull(sqlReader.Item("ac_asking_price")) And Not String.IsNullOrEmpty(sqlReader.Item("ac_asking_price").ToString) Then
                                        If Not IsDBNull(sqlReader.Item("ac_asking_price")) And Not String.IsNullOrEmpty(sqlReader.Item("ac_asking_price").ToString) Then
                                            htmlOutput &= "$" & FormatNumber(CDbl(CDbl(sqlReader.Item("ac_asking_price").ToString) + CDbl(nAddToAskingPrice)), 0, False, False, True).ToString
                                        Else
                                            htmlOutput &= "&nbsp;"
                                        End If
                                    End If

                                Else
                                    If Not IsDBNull(sqlReader.Item("ac_asking_price")) And Not String.IsNullOrEmpty(sqlReader.Item("ac_asking_price").ToString) Then
                                        If Not IsDBNull(sqlReader.Item("ac_asking_price")) And Not String.IsNullOrEmpty(sqlReader.Item("ac_asking_price").ToString) Then
                                            htmlOutput &= "$" + FormatNumber(sqlReader.Item("ac_asking_price").ToString.Trim, 0, True, False, True) + " (USD)"
                                        Else
                                            htmlOutput &= "&nbsp;"
                                        End If
                                    End If
                                End If






                                htmlOutput &= "</font></td></tr>"
                            End If
                        Else

                            If Not String.IsNullOrEmpty(sqlReader.Item("ac_asking").ToString) Then
                                If Trim(sqlReader.Item("ac_asking").ToString) <> "" Then
                                    htmlOutput &= "<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font size='-1'><b>Asking&nbsp;</b>"
                                    htmlOutput &= "" + sqlReader.Item("ac_asking").ToString.Trim
                                    htmlOutput &= "</font></td></tr>"
                                End If
                            End If

                        End If

                    Else
                    End If ' Not IsDBNull(sqlReader.Item("ac_asking")) Then 

                End If

                htmlOutput += "</table>" 'Aircraft_Identification_Status
                '--------------------------------------------------------------------------------------------------------------------------------------------------------------


                htmlOutput += "</td></tr></table></td>"

                If chkBlindReport.Checked = False Then
                    ' start AC_Pic
                    Query = "SELECT TOP 1 * FROM Aircraft_Pictures WITH(NOLOCK)"
                    Query += " WHERE acpic_ac_id = " + nAircraftID.ToString
                    Query += " AND acpic_journ_id = " + nAircraftJournalID.ToString
                    Query += " AND acpic_seq_no > 0"
                    Query += " AND acpic_image_type = 'JPG'"
                    Query += " AND acpic_hide_flag = 'N'"
                    Query += " ORDER BY acpic_seq_no"

                    SqlCommand.CommandText = Query
                    sqlReaderTemp = SqlCommand.ExecuteReader()

                    If sqlReaderTemp.HasRows Then

                        sqlReaderTemp.Read()

                        pic_seq_num = CInt(sqlReaderTemp.Item("acpic_seq_no").ToString)

                        If Not IsDBNull(sqlReaderTemp("acpic_image_type")) Then
                            fAcpic_image_type = sqlReaderTemp.Item("acpic_image_type").ToString.ToLower.Trim
                        End If

                        If Not IsDBNull(sqlReaderTemp("acpic_id")) Then
                            fAcpic_id = CInt(sqlReaderTemp.Item("acpic_id").ToString.Trim)
                        End If

                        If Not (IsDBNull(sqlReaderTemp("acpic_subject"))) Then
                            fApicSubject = sqlReaderTemp.Item("acpic_subject").ToString.Trim
                        End If



                        imgFileName = nAircraftID.ToString + Constants.cHyphen + nAircraftJournalID.ToString + Constants.cHyphen + fAcpic_id.ToString + Constants.cDot + fAcpic_image_type.ToLower.Trim

                        If bWordReport Then
                            htmlOutput += "<td width='410' id='AC_Pic' align='right' valign='top'>"
                        Else
                            htmlOutput += "<td width='270' id='AC_Pic' align='right' valign='top'>"
                        End If


                        If check_prepared_for.Checked = True Then
                            If prepared_for.Text <> "" Then
                                htmlOutput &= "<table class='FontSize' cellspacing='0' cellpadding='0'><tr><td nowrap='nowrap'><font size='-1'><b>Prepared For: </b>" & Trim(prepared_for.Text) & "</font></td></tr></table>"
                            End If
                        End If


                        Try
                            ac_image_file = HttpContext.Current.Server.MapPath("pictures\aircraft\") & imgFileName
                            zimage2 = System.Drawing.Image.FromFile(ac_image_file)
                            temp_width = zimage2.Width
                            temp_height = zimage2.Height



                            ' if the width minus a little is still greater than the height, then can increase a little
                            ' if height is not close to width, then we can increase size a little 
                            If ((temp_width - 50) > temp_height) And (temp_width > 300) Then
                                ' if the height is greater than the width, desired_width currrently = 378 
                                desired_width = 390   ' can make it a little wider
                            End If

                            If bWordReport Then
                                desired_width = 280
                            End If

                            ' if the image is wider then the desired image width, then shirnk down to size.
                            If temp_width > desired_width Then
                                temp_percent1 = CDbl(CDbl(desired_width) / CDbl(temp_width))
                                temp_width = CDbl(CDbl(temp_width) * CDbl(temp_percent1))
                                temp_height = CDbl(CDbl(temp_height) * CDbl(temp_percent1))
                            End If

                            'assuming generally that a square is fine
                            If temp_height > temp_width Then
                                temp_percent1 = CDbl(CDbl(temp_width) / CDbl(temp_height))
                                temp_width = CDbl(CDbl(temp_width) * CDbl(temp_percent1))
                                temp_height = CDbl(CDbl(temp_height) * CDbl(temp_percent1))
                            End If


                            If bWordReport Then
                                htmlOutput += "<img Title='" + fApicSubject.Trim + "' alt='" + fApicSubject.Trim + "' src='" + imgDisplayFolder.Trim + "/" + imgFileName.Trim + "' width='" + temp_width.ToString + "' height='" + temp_height.ToString + "'/></td>"
                            Else
                                htmlOutput += "<img Title='" + fApicSubject.Trim + "' alt='" + fApicSubject.Trim + "' src='" + imgDisplayFolder.Trim + "/" + imgFileName.Trim + "' width='" + temp_width.ToString + "'/></td>"
                            End If

                        Catch ex As Exception
                            htmlOutput += "<img Title='" + fApicSubject.Trim + "' alt='" + fApicSubject.Trim + "' src='" + imgDisplayFolder.Trim + "/" + imgFileName.Trim + "' width='200'/></td>"
                        End Try

                    End If

                    sqlReaderTemp.Close()
                Else
                    htmlOutput += "</td>"
                End If

                htmlOutput += "</tr></table>"



                If bWordReport Then
                    htmlOutput = "<table align='center' border='0'><tr valign='top'><td valign='top'><table width='100%'><tr valign='top'><td valign='top'>" + htmlOutput
                    htmlOutput += "</td><td valign='top'>" + string_for_word
                    htmlOutput += "</td></tr></table>"
                Else
                    htmlOutput = htmlOutput_start + htmlOutput
                End If

                htmlOutput += "</td>" 'Aircraft_Idenification_Status
                htmlOutput += "</tr>"


                If chkBlindReport.Checked = False Then
                    htmlOutput += "<tr>"


                    ' Addtl_Pics_Inner_Littler_Table
                    Query = "SELECT Top 4 * FROM Aircraft_Pictures WITH(NOLOCK)"
                    Query += " WHERE acpic_ac_id = " + nAircraftID.ToString
                    Query += " AND acpic_journ_id = " + nAircraftJournalID.ToString
                    Query += " AND acpic_seq_no > 0"
                    Query += " AND acpic_image_type = 'JPG'"
                    Query += " AND acpic_hide_flag = 'N'"

                    If pic_seq_num > 0 Then
                        Query = Query + " AND acpic_seq_no <> " + pic_seq_num.ToString
                    End If

                    SqlCommand.CommandText = Query
                    sqlReaderTemp = SqlCommand.ExecuteReader()

                    If sqlReaderTemp.HasRows Then

                        htmlOutput += "<td colspan='2' valign='top' align='center'>" ' start td for Addtl_Pics_Inner_Littler_Table
                        htmlOutput += "<table id='Addtl_Pics_Inner_Little_Table' class='FontSize'>"
                        htmlOutput += "<tr>"

                        Do While sqlReaderTemp.Read
                            pic_seq_num = CInt(sqlReaderTemp.Item("acpic_seq_no").ToString)

                            If Not IsDBNull(sqlReaderTemp("acpic_image_type")) Then
                                fAcpic_image_type = sqlReaderTemp.Item("acpic_image_type").ToString.ToLower.Trim
                            End If

                            If Not IsDBNull(sqlReaderTemp("acpic_id")) Then
                                fAcpic_id = CInt(sqlReaderTemp.Item("acpic_id").ToString.Trim)
                            End If

                            If Not (IsDBNull(sqlReaderTemp("acpic_subject"))) Then
                                fApicSubject = sqlReaderTemp.Item("acpic_subject").ToString.Trim
                            End If

                            imgFileName = nAircraftID.ToString + Constants.cHyphen + nAircraftJournalID.ToString + Constants.cHyphen + fAcpic_id.ToString + Constants.cDot + fAcpic_image_type.ToLower.Trim

                            htmlOutput += "<td align='right'>"


                            Try
                                ac_image_file = HttpContext.Current.Server.MapPath("pictures\aircraft\") & imgFileName
                                zimage3 = System.Drawing.Image.FromFile(ac_image_file)
                                temp_width = zimage3.Width
                                temp_height = zimage3.Height

                                'if its word and u have a logo, shirnk the height of the images
                                If bWordReport = True Then
                                    If logo_check.Checked = True Then
                                        desired_height = 125
                                    End If
                                End If

                                ' if the image is wider then the desired image width, then shirnk down to size.
                                If temp_height > desired_height Then
                                    temp_percent1 = CDbl(CDbl(desired_height) / CDbl(temp_height))
                                    temp_width = CDbl(CDbl(temp_width) * CDbl(temp_percent1))
                                    temp_height = CDbl(CDbl(temp_height) * CDbl(temp_percent1))
                                End If

                                total_width = total_width + temp_width

                                add_pic = "Y"
                                If total_width > width_size_total Then
                                    add_pic = "N"
                                End If

                                If add_pic = "Y" Then
                                    If bWordReport Then
                                        htmlOutput = htmlOutput + "<img Title='" + fApicSubject.Trim + "' alt='" + fApicSubject.Trim + "' src='" + imgDisplayFolder.Trim + "/" + imgFileName.Trim + "' width='" + temp_height.ToString + "' height='" + temp_height.ToString + "'/>"
                                    Else
                                        htmlOutput = htmlOutput + "<img Title='" + fApicSubject.Trim + "' alt='" + fApicSubject.Trim + "' src='" + imgDisplayFolder.Trim + "/" + imgFileName.Trim + "'  height='" + temp_height.ToString + "' />"
                                    End If
                                End If

                            Catch ex As Exception
                                htmlOutput += "<img Title='" + fApicSubject.Trim + "' alt='" + fApicSubject.Trim + "' src='" + imgDisplayFolder.Trim + "/" + imgFileName.Trim + "' width='142' height='125' />"
                            End Try

                            htmlOutput += "</td>"

                        Loop

                        htmlOutput += "<tr></table>" ' end table Addtl_Pics_Inner_Little_Table
                        htmlOutput += "</td>" ' end Addtl_Pics_Inner_Littler_Table

                    End If

                End If

                sqlReaderTemp.Close()

                ' start rest of specs and pics
                htmlOutput += "<tr id='TR_Main_Table_For_AC_Specs_Addtl_Pics'>" 'TR_Main_Table_For_AC_Specs_Addtl_Pics
                htmlOutput += "<td id='TD_Addtl_Specs_Inner_Table_Start' width='80%' colspan='2'>" 'TD_Addtl_Specs_Inner_Table_Start
                htmlOutput += "<table id='Addtl_Specs_N_Pics' width='100%'  class='FontSize' cellpadding='0' cellspacing='0'>" 'Addtl_Specs_N_Pics
                htmlOutput += "<td width='80%' valign='top'>"
                htmlOutput += "<table id='Addtl_Specs_Inner_Little_Table'  class='FontSize' cellpadding='0' cellspacing='0'>" 'Table Addtl_Specs_Inner_Little_Table
                htmlOutput += "<tr id='TR_Engine_Information'>" 'TR_Engine_Information
                htmlOutput += "<td width='55%' colspan='2' valign='top'>"
                htmlOutput += "<table id='Engine_Information'  class='FontSize' cellpadding='1' cellspacing='1'>" ' Table Engine Information
                htmlOutput += "<tr><td colspan='2'><font size='-1'><strong>ENGINE INFORMATION</strong></font></td></tr>"
                ' Engine Model
                htmlOutput += "<tr><td width='2%'><font size='-1'>&nbsp;</font></td><td><font size='-1'><b><i>Model: </b></i>" + sqlReader.Item("ac_engine_name") '& "</td></tr>"
                ' Engine Maintenance Program

                '---------------------------------------------------------------------------- HERE IS SECTION--------------------------------------------------------------------------------------------
                Query = "SELECT emp_provider_name, emp_program_name FROM Engine_Maintenance_Program WITH(NOLOCK) WHERE emp_id = " + sqlReader.Item("ac_engine_maintenance_prog_EMP").ToString.Trim

                'SELECT emgp_program_name FROM Engine_Management_Program WITH(NOLOCK) WHERE emgp_id = " + sqlReader.item("ac_engine_management_prog_EMGP").Value

                SqlCommand.CommandText = Query
                sqlReaderTemp = SqlCommand.ExecuteReader()

                If sqlReaderTemp.HasRows Then
                    sqlReaderTemp.Read()
                    If Not String.IsNullOrEmpty(sqlReaderTemp("emp_provider_name").ToString.Trim) And Not sqlReaderTemp("emp_provider_name").ToString.Trim.ToLower.Contains("unknown") Then
                        htmlOutput += "&nbsp;&nbsp;<b><i>Maint. Plan: </b></i>" + sqlReaderTemp("emp_provider_name").ToString.Trim + "&nbsp;" + sqlReaderTemp("emp_program_name").ToString.Trim + "</font></td></tr>"
                    End If
                End If

                sqlReaderTemp.Close()

                Query = "select top 1 emp_name from Engine_Maintenance_Program where emp_code = '" & sqlReader.Item("ac_apu_maint_prog").ToString.Trim & "' "

                SqlCommand.CommandText = Query
                sqlReaderTemp = SqlCommand.ExecuteReader()
                apu_maint_prog = ""
                If sqlReaderTemp.HasRows Then
                    sqlReaderTemp.Read()
                    If Not String.IsNullOrEmpty(sqlReaderTemp("emp_name").ToString.Trim) Then
                        apu_maint_prog = "<tr><td width='2%'><font size='-1'>&nbsp;</font></td><td><font size='-1'><b><i>APU Maintenance Plan:&nbsp;</b></i>" + sqlReaderTemp("emp_name").ToString.Trim + "&nbsp;</font></td></tr>"
                    End If
                End If

                sqlReaderTemp.Close()


                '---------------------------------------------------------------------------- HERE IS SECTION-------------------------------------------------------------------------------------------- 


                htmlOutput += "<tr id='TR_Engine_Information_Mini_Table'>" 'TR_Engine_Information_Mini_Table
                htmlOutput += "<td width='2%'><font size='-1'>&nbsp;</font></td>"
                htmlOutput += "<td colspan='2'>"
                htmlOutput += "<table id='Engine_Information_Mini_Table'  class='FontSize'>" 'Table Engine_Information_Mini_Table
                htmlOutput += "<tr id='TR_Headers_For_Engine'><td><font size='-1'>&nbsp;</font></td><td><font size='-1'><b>TTSN:</b></font></td><td><font size='-1'><b>SMOH:</b></font></td><td><font size='-1'><b>TBO:</b></font></td></tr>"

                sAirframeType = sqlReader.Item("amod_airframe_type_code").ToString.ToUpper
                sAircraftType = sqlReader.Item("amod_type_code").ToString.ToUpper

                If sAirframeType <> "R" Then
                    nloopCount = 4
                Else
                    nloopCount = 3
                End If

                For xLoop = 1 To nloopCount
                    ' check for Engine info
                    If Not IsDBNull(sqlReader.Item("ac_engine_" + xLoop.ToString + "_tot_hrs")) Or Not IsDBNull(sqlReader.Item("ac_engine_" + xLoop.ToString + "_soh_hrs")) Or Not IsDBNull(sqlReader.Item("ac_engine_" + xLoop.ToString + "_tbo_hrs")) Then
                        ' we have data
                        If xLoop Mod 2 <> 0 Then
                            htmlOutput += "<tr id='TR_Engine_Specs_Specific'>" ' TR_Engine_Specs_Specific
                            htmlOutput += "<td nowrap><font size='-1'><b><i>Engine " + xLoop.ToString + " (left):</i></b></font></td>"
                        Else
                            htmlOutput += "<tr id='TR_Engine_Specs_Specific'>" ' TR_Engine_Specs_Specific
                            htmlOutput += "<td nowrap><font size='-1'><b><i>Engine " + xLoop.ToString + " (right):</i></b></font></td>"
                        End If
                        If Not IsDBNull(sqlReader.Item("ac_engine_" + xLoop.ToString + "_tot_hrs")) Then
                            If IsNumeric(sqlReader.Item("ac_engine_" + xLoop.ToString + "_tot_hrs").ToString) Then
                                htmlOutput += "<td><font size='-1'>" + FormatNumber(CDbl(sqlReader.Item("ac_engine_" + xLoop.ToString + "_tot_hrs").ToString), 0, True, False, True) + "</font></td>"
                            Else
                                htmlOutput += "<td><font size='-1'>" + FormatNumber(0, 0, True, False, True) + "</font></td>"
                            End If
                        Else
                            htmlOutput += "<td><font size='-1'>&nbsp;</font></td>"
                        End If
                        If Not IsDBNull(sqlReader.Item("ac_engine_" + xLoop.ToString + "_soh_hrs")) Then
                            If IsNumeric(sqlReader.Item("ac_engine_" + xLoop.ToString + "_soh_hrs").ToString) Then
                                htmlOutput += "<td><font size='-1'>" + FormatNumber(CDbl(sqlReader.Item("ac_engine_" + xLoop.ToString + "_soh_hrs").ToString), 0, True, False, True) + "</font></td>"
                            Else
                                htmlOutput += "<td><font size='-1'>" + FormatNumber(0, 0, True, False, True) + "</font></td>"
                            End If
                        Else
                            htmlOutput += "<td><font size='-1'>&nbsp;</font></td>"
                        End If
                        If Not IsDBNull(sqlReader.Item("ac_engine_" + xLoop.ToString + "_tbo_hrs")) Then
                            If IsNumeric(sqlReader.Item("ac_engine_" + xLoop.ToString + "_tbo_hrs").ToString) Then
                                htmlOutput += "<td><font size='-1'>" + FormatNumber(CDbl(sqlReader.Item("ac_engine_" + xLoop.ToString + "_tbo_hrs").ToString), 0, True, False, True) + "</font></td></tr>"
                            Else
                                htmlOutput += "<td><font size='-1'>" + FormatNumber(0, 0, True, False, True) + "</font></td></tr>"
                            End If
                        Else
                            htmlOutput += "<td><font size='-1'>&nbsp;</font></td></tr>"
                        End If
                    End If

                Next ' xLoop

                htmlOutput += "</table>" ' Engine_Information_Mini_Table
                htmlOutput += "</td>"
                htmlOutput += "</tr>" ' end TR_Engine_Information_Mini_Table
                htmlOutput += "</table>" ' end Table Engine Information
                htmlOutput += "</td>"

                If sAircraftType = "J" And sAirframeType = "F" Then
                    If Not IsDBNull(sqlReader.Item("ac_apu_model_name")) Then
                        If Not String.IsNullOrEmpty(sqlReader.Item("ac_apu_model_name").ToString.Trim) Then

                            htmlOutput += "<td width='55%' colspan='2' valign='top'>" ' td start table Aux Power Unit
                            htmlOutput += "<table id='Auxiliary_Power_Unit'  class='FontSize'>" ' table Auxiliary_Power_Unit class='SpecsTableBorderLittle' 
                            htmlOutput += "<tr><td colspan='2'><font size='-1'><strong>AUXILIARY POWER UNIT (APU)</strong></font></td></tr>"
                            If sqlReader.Item("ac_apu_model_name") <> "" Then
                                htmlOutput += "<tr><td width='2%'><font size='-1'>&nbsp;</font></td>"
                                htmlOutput += "<td><font size='-1'><b><i>Model: </i></b>" + sqlReader.Item("ac_apu_model_name").ToString + "</font></td></tr>"
                            End If
                            htmlOutput += "<tr><td width='2%'><font size='-1'>&nbsp;</font></td>"
                            If Not IsDBNull(sqlReader.Item("ac_apu_tot_hrs")) Then
                                If Trim(CStr(sqlReader.Item("ac_apu_tot_hrs"))) <> "" Then
                                    htmlOutput += "<td nowrap='nowrap'><font size='-1'><b><i>Total Time (Hours) Since New: </i></b>" + FormatNumber(CDbl(sqlReader.Item("ac_apu_tot_hrs").ToString), 0, True, False, True) + "</font></td></tr>"
                                End If
                            Else
                                htmlOutput += "<td><font size='-1'>&nbsp;</font></td></tr>"
                            End If


                            If Trim(apu_maint_prog) <> "" Then
                                htmlOutput += apu_maint_prog
                            End If


                            ' htmlOutput += "<tr><td width='2%'><font size='-1'>&nbsp;</font></td><td><font size='-1'>&nbsp;</font></td></tr>"
                            htmlOutput += "</table>" ' end Auxiliary_Power_Unit
                            htmlOutput += "</td>" ' end td Aux power unit
                        End If
                    End If
                ElseIf sAircraftType <> "J" And sAirframeType = "F" Then
                    htmlOutput += "<td width='2%'>&nbsp;</td>"
                    htmlOutput += "<td valign='top'>"
                    htmlOutput += "<table id='Prop_Information_Mini_Table' class='FontSize'>" 'Table Prop_Information_Mini_Table
                    htmlOutput += "<tr><td colspan='4'><font size='-1'><strong>PROPELLER INFORMATION</strong></font></td></tr>"
                    htmlOutput += "<tr><td colspan='2'>&nbsp;</td></tr>"
                    htmlOutput += "<tr id='TR_Headers_For_Props'><td>&nbsp;</td><td nowrap='nowrap'><font size='-1'><b>TTSN:</b></font></td>"
                    htmlOutput += "<td nowrap='nowrap'><font size='-1'><b>SPOH:</b></font></td>"
                    htmlOutput += "<td><font size='-1'><b>Date&nbsp;of&nbsp;Overhaul (MM/YY):</b></font></td></tr>"

                    nloopCount = 0
                    xLoop = 0
                    nloopCount = 4

                    For xLoop = 1 To nloopCount

                        ' check for prop info
                        If Not IsDBNull(sqlReader.Item("ac_prop_" + xLoop.ToString + "_snew_hrs")) Or Not IsDBNull(sqlReader.Item("ac_prop_" + xLoop.ToString + "_soh_hrs")) Or Not IsDBNull(sqlReader.Item("ac_prop_" + xLoop.ToString + "_soh_moyear")) Then
                            ' we have data
                            If xLoop Mod 2 <> 0 Then
                                htmlOutput += "<tr id='TR_Prop_Info'>" ' TR_Prop_Info
                                htmlOutput += "<td nowrap='nowrap'><font size='-1'><b><i>Propeller " + xLoop.ToString + " (left):</i></b></font></td>"
                            Else
                                htmlOutput += "<tr id='TR_Prop_Info'>" ' TR_Prop_Info
                                htmlOutput += "<td nowrap='nowrap'><font size='-1'><b><i>Propeller " + xLoop.ToString + " (right):</i></b></font></td>"
                            End If
                            If Not IsDBNull(sqlReader.Item("ac_prop_" + xLoop.ToString + "_snew_hrs")) Then
                                If IsNumeric(sqlReader.Item("ac_prop_" + xLoop.ToString + "_snew_hrs").ToString) Then
                                    htmlOutput += "<td><font size='-1'>" + FormatNumber(CDbl(sqlReader.Item("ac_prop_" + xLoop.ToString + "_snew_hrs").ToString), 0, True, False, True) + "</font></td>"
                                Else
                                    htmlOutput += "<td><font size='-1'>" + FormatNumber(0, 0, True, False, True) + "</font></td>"
                                End If
                            Else
                                htmlOutput += "<td>&nbsp;</td>"
                            End If
                            If Not IsDBNull(sqlReader.Item("ac_prop_" + xLoop.ToString + "_soh_hrs")) Then
                                If IsNumeric(sqlReader.Item("ac_prop_" + xLoop.ToString + "_soh_hrs").ToString) Then
                                    htmlOutput += "<td><font size='-1'>" + FormatNumber(CDbl(sqlReader.Item("ac_prop_" + xLoop.ToString + "_soh_hrs").ToString), 0, True, False, True) + "</font></td>"
                                Else
                                    htmlOutput += "<td><font size='-1'>" + FormatNumber(0, 0, True, False, True) + "</font></td>"
                                End If
                            Else
                                htmlOutput += "<td>&nbsp;</td>"
                            End If
                            If Not IsDBNull(sqlReader.Item("ac_prop_" + xLoop.ToString + "_soh_moyear")) Then
                                If IsNumeric(sqlReader.Item("ac_prop_" + xLoop.ToString + "_soh_moyear").ToString) Then
                                    htmlOutput += "<td><font size='-1'>" & Left(sqlReader.Item("ac_prop_" + xLoop.ToString + "_soh_moyear").ToString.Trim, 2) & "/" & Right(sqlReader.Item("ac_prop_" + xLoop.ToString + "_soh_moyear").ToString.Trim, 4) & "</font></td></tr>"
                                Else
                                    htmlOutput += "<td><font size='-1'>&nbsp;</font></td>"
                                End If
                            Else
                                htmlOutput += "<td>&nbsp;</td>"
                            End If

                        End If

                    Next ' xLoop
                    htmlOutput += "</table>" ' Prop_Information_Mini_Table
                    htmlOutput += "</td>"

                ElseIf sAirframeType = "R" Then

                    Query = "SELECT * FROM Helicopter_Detail_Times WITH(NOLOCK) WHERE heldt_ac_id = " + nAircraftID.ToString
                    Query = Query + " AND heldt_journ_id = " + nAircraftJournalID.ToString + " AND heldt_category_type <> 'Tail Rotor Blades'"

                    SqlCommand.CommandText = Query
                    sqlReaderTemp = SqlCommand.ExecuteReader()

                    If sqlReaderTemp.HasRows Then
                        htmlOutput += "<td width='2%'>&nbsp;</td>"
                        htmlOutput += "<td valign='top'>"
                        htmlOutput += "<table id='Prop_Information_Mini_Table' class='FontSize' cellpadding='2' cellspacing='0'>" 'Table Prop_Information_Mini_Table
                        htmlOutput += "<tr><td colspan='4'><font size='-1'><strong>GEARBOX/ROTOR BLADE INFORMATION</strong></font></td></tr>"
                        ' htmlOutput += "<tr><td colspan='2'>&nbsp;</td></tr>"
                        htmlOutput += "<tr id='TR_Headers_For_Props'><td>&nbsp;</td><td>&nbsp;</td><td><font size='-1'><b>TTSN:</b></font></td><td align='center'><font size='-1'><b>Time Remaining:</b></font></td><td nowrap><font size='-1'><b>TSOH:</b></font></td></tr>"
                        Do While sqlReaderTemp.Read
                            If Not IsDBNull(sqlReaderTemp("heldt_category_type")) And Trim(sqlReaderTemp("heldt_category_type").ToString) <> "" Then
                                Select Case UCase(Trim(sqlReaderTemp("heldt_category_type")))
                                    Case "INTERMEDIATE GEARBOX"
                                        bHasMainBlades = False
                                        bHasTailBlades = False
                                        sLabel = "Intermediate&nbsp;Gearbox"
                                    Case "MAIN ROTOR #1 BLADES", "MAIN ROTOR #2 BLADES"
                                        ' Check for number of blades
                                        sLabel = "Main&nbsp;Blade&nbsp;"
                                        bHasMainBlades = True
                                        bHasTailBlades = False
                                        ' OK Get the Blade Number 1-10
                                        sLabel = sLabel + Right(Trim(sqlReaderTemp("heldt_subcat_type")), 2)
                                    Case "MAIN ROTOR HUB #1", "MAIN ROTOR HUB #2"
                                        bHasMainBlades = False
                                        bHasTailBlades = False
                                        sLabel = "Main&nbsp;Rotor&nbsp;Hub"
                                    Case "MAIN TRANSMISSION #1", "MAIN TRANSMISSION #2"
                                        bHasMainBlades = False
                                        bHasTailBlades = False
                                        sLabel = "Main&nbsp;Transmission"
                                    Case "TAIL ROTOR BLADES"
                                        ' Check for number of blades
                                        sLabel = "Tail&nbsp;Blade&nbsp;"
                                        bHasMainBlades = False
                                        bHasTailBlades = True
                                        ' OK Get the Blade Number 1-10
                                        sLabel = sLabel + Right(Trim(sqlReaderTemp("heldt_subcat_type")), 2)
                                    Case "TAIL ROTOR GEARBOX"
                                        bHasMainBlades = False
                                        bHasTailBlades = False
                                        sLabel = "Tail&nbsp;Rotor&nbsp;Gearbox"
                                    Case "TAIL ROTOR HUB"
                                        bHasMainBlades = False
                                        bHasTailBlades = False
                                        sLabel = "Tail&nbsp;Rotor&nbsp;Hub"
                                End Select
                            End If

                            If Not IsDBNull(sqlReaderTemp("heldt_ttsn")) Or Not IsDBNull(sqlReaderTemp("heldt_remaining_hours")) Or Not IsDBNull(sqlReaderTemp("heldt_soh")) Then
                                htmlOutput += "<tr id='TR_Prop_Info'>" ' TR_Prop_Info
                                htmlOutput += "<td nowrap><font size='-1'>&nbsp;</font></td>"
                                htmlOutput += "<td><font size='-1'>&nbsp;" + sLabel + "&nbsp;&nbsp;</font></td>"
                                If Not IsDBNull(sqlReaderTemp("heldt_ttsn")) Then
                                    htmlOutput += "<td align='center'><font size='-1'>" + FormatNumber(CDbl(sqlReaderTemp("heldt_ttsn").ToString), 0, True, False, True) + "</font></td>"
                                Else
                                    htmlOutput += "<td><font size='-1'>&nbsp;</td>"
                                End If
                                If Not IsDBNull(sqlReaderTemp("heldt_remaining_hours")) Then
                                    htmlOutput += "<td align='center'><font size='-1'>" + FormatNumber(CDbl(sqlReaderTemp("heldt_remaining_hours").ToString), 0, True, False, True) + "</font></td>"
                                Else
                                    htmlOutput += "<td><font size='-1'>&nbsp;</td>"
                                End If
                                If Not IsDBNull(sqlReaderTemp("heldt_soh")) And (Not bHasMainBlades Or Not bHasTailBlades) Then
                                    htmlOutput += "<td align='center'><font size='-1'>" + FormatNumber(CDbl(sqlReaderTemp("heldt_soh").ToString), 0, True, False, True) + "</font></td></tr>"
                                Else
                                    htmlOutput += "<td><font size='-1'>&nbsp;</font></td>"
                                End If
                            End If

                        Loop
                        htmlOutput += "</table>" ' Prop_Information_Mini_Table
                        htmlOutput += "</td>"

                    End If
                End If

                sqlReaderTemp.Close()
                htmlOutput += "</tr></table></table>" ' endTR_Engine_Information

                Query = "SELECT adet_data_description FROM Aircraft_Details WITH(NOLOCK) WHERE adet_ac_id = " + nAircraftID.ToString + " AND adet_journ_id = " + nAircraftJournalID.ToString + " AND adet_data_type = 'Maintenance' AND adet_data_name = 'Inspection'"

                SqlCommand.CommandText = Query
                sqlReaderTemp = SqlCommand.ExecuteReader()

                If sqlReaderTemp.HasRows Or Not IsDBNull(sqlReader.Item("ac_maintained")) Then

                    htmlOutput += "<table id='Maintenance_Certifications' class='FontSize' cellspacing='0' cellpadding='0'>"
                    htmlOutput += "<tr><td colspan='2'><font size='-1'><strong>MAINTENANCE/CERTIFICATIONS</strong></font></td></tr>"

                    If Not IsDBNull(sqlReader.Item("ac_maintained")) Then
                        If Not String.IsNullOrEmpty(sqlReader.Item("ac_maintained").ToString) Then
                            htmlOutput += "<tr><td width='2%'><font size='-1'>&nbsp;</font></td>"
                            htmlOutput += "<td><font size='-1'><b><i>Maintained: </i></b>" + sqlReader.Item("ac_maintained").ToString + "</font>" ' + "</td></tr>"
                        End If
                    End If
                    If sqlReaderTemp.HasRows Then
                        sqlReaderTemp.Read()
                        If Not IsDBNull(sqlReader.Item("ac_maintained")) Then
                            If String.IsNullOrEmpty(sqlReader.Item("ac_maintained").ToString) Then
                                htmlOutput += "<tr><td width='2%'><font size='-1'>&nbsp;</font></td><td>"
                            End If
                        Else
                            htmlOutput += "<tr><td width='2%'><font size='-1'>&nbsp;</font></td><td>"
                        End If
                        htmlOutput += "<font size='-1'>&nbsp;&nbsp;<b><i>Inspection(s): </b></i>" + sqlReaderTemp("adet_data_description").ToString + "</font></td></tr>"
                    End If

                    htmlOutput += "</table>"

                End If

                sqlReaderTemp.Close()

                ' Start Equipment Details    
                Query = "SELECT * FROM Aircraft_Details WITH(NOLOCK) WHERE adet_ac_id = " + nAircraftID.ToString
                Query = Query + " AND adet_journ_id = " + nAircraftJournalID.ToString + " AND adet_data_type = 'Equipment' AND adet_data_name <> 'General'"   ' Lights ? 

                SqlCommand.CommandText = Query
                sqlReaderTemp = SqlCommand.ExecuteReader()

                data_type_last = ""

                If sqlReaderTemp.HasRows Then
                    htmlOutput += "<tr id='TR_Equipment_Details'>" ' TR_Equipment_Details
                    htmlOutput += "<td width='100%' colspan='4'>" ' start td for table
                    htmlOutput += "<table width='100%' id='Equipment_Details'  class='FontSize'>" ' table Equipment_Details
                    htmlOutput += "<tr><td colspan='2'  width='100%'><font size='-1'><strong>EQUIPMENT</strong></font></td></tr>"
                    htmlOutput += "<tr><td width='2%'><font size='-1'>&nbsp;</font></td>"
                    htmlOutput += "<td width='100%'><font size='-1'>"
                    Do While sqlReaderTemp.Read

                        If Trim(data_type_last) <> Trim(sqlReaderTemp.Item("adet_data_name").ToString) Then
                            htmlOutput += "<b><em>" + sqlReaderTemp.Item("adet_data_name").ToString + "</em></b>: "
                        End If
                        htmlOutput += sqlReaderTemp.Item("adet_data_description").ToString + " "

                        data_type_last = Trim(sqlReaderTemp.Item("adet_data_name").ToString)

                    Loop
                    htmlOutput += "</font></td></tr>"
                    'htmlOutput += "<tr><td width='2%'>&nbsp;</td><td>&nbsp;</td></tr>"   
                    htmlOutput += "</table>" ' end table Equipment_Details
                    htmlOutput += "</td>" ' end td
                    htmlOutput += "</tr>" ' TR_Equipment_Details
                End If

                sqlReaderTemp.Close()

                ' Start Interior Details    
                Query = "SELECT * FROM Aircraft_Details WITH(NOLOCK) WHERE adet_ac_id = " + nAircraftID.ToString
                Query = Query + " AND adet_journ_id = " + nAircraftJournalID.ToString + " AND adet_data_type = 'Interior' AND adet_data_name IN ('Configuration','Passengers','Seating')"

                SqlCommand.CommandText = Query
                sqlReaderTemp = SqlCommand.ExecuteReader()

                If sqlReaderTemp.HasRows Then

                    htmlOutput += "<tr id='TR_Interior_Details'>" ' start TR_Interior_Details
                    htmlOutput += "<td width='100%' colspan='4'>" ' start td for table Interior_Details
                    htmlOutput += "<table id='Interior_Details' width='100%'  class='FontSize' cellpadding='0' cellspacing='0'>"
                    htmlOutput += "<tr><td colspan='2' width='100%'><font size='-1'><b>INTERIOR</b>&nbsp;"

                    If Not IsDBNull(sqlReader.Item("ac_interior_moyear")) Then
                        If Not String.IsNullOrEmpty(sqlReader.Item("ac_interior_moyear").ToString.Trim) Then
                            'htmlOutput += "<tr><td width='2%'>&nbsp;</td>"
                            If sqlReader.Item("ac_interior_moyear").ToString.Trim.Length > 4 Then
                                temp_moyear = sqlReader.Item("ac_interior_moyear").ToString.Trim
                                If temp_moyear.Length = 5 Then
                                    temp_moyear = Left(temp_moyear, 1) + "/" + Right(temp_moyear, 4)
                                Else
                                    If temp_moyear.Length = 6 Then
                                        temp_moyear = Left(temp_moyear, 2) + "/" + Right(temp_moyear, 4)
                                    End If
                                End If
                                htmlOutput += " ( <b><i>Updated: </i></b> " + temp_moyear + " )</i></b></font></td></tr>"
                            Else
                                htmlOutput += " ( <b><i>Updated: </i></b> " + sqlReader.Item("ac_interior_moyear").ToString + " )</i></b></font></td></tr>"
                            End If
                        End If
                    End If

                    data_details = ""
                    data_type_last = ""
                    htmlOutput += "<tr><td width='2%'><font size='-1'>&nbsp;</font></td><td><font size='-1'>"

                    Do While sqlReaderTemp.Read

                        If Trim(data_details) <> "" Then
                            data_details &= ", "
                        End If

                        If Trim(data_type_last) <> Trim(sqlReaderTemp.Item("adet_data_name").ToString) Then
                            data_details &= "<b>" & sqlReaderTemp.Item("adet_data_name").ToString & "</b>: "
                        End If
                        data_details &= sqlReaderTemp("adet_data_description").ToString

                        data_type_last = Trim(sqlReaderTemp.Item("adet_data_name").ToString)
                    Loop

                    htmlOutput += data_details
                    htmlOutput += "</font></td></tr>"
                    htmlOutput += "</table>" ' end table TR_Interior_Details
                    htmlOutput += "</td>" ' end td for table TR_Interior_Details
                    htmlOutput += "</tr>" ' end TR_Interior_Details
                End If

                sqlReaderTemp.Close()

                ' Exterior Details
                Query = "SELECT * FROM Aircraft_Details WITH(NOLOCK) WHERE adet_ac_id = " + nAircraftID.ToString
                Query = Query + " AND adet_journ_id = " + nAircraftJournalID.ToString + " AND adet_data_type = 'Exterior' AND adet_data_name <> 'General'"

                SqlCommand.CommandText = Query
                sqlReaderTemp = SqlCommand.ExecuteReader()

                If sqlReaderTemp.HasRows Then

                    htmlOutput += "<tr id='TR_Exterior_Details'>" ' start TR_Exterior_Details
                    htmlOutput += "<td width='100%' colspan='4'>" ' start td for table TR_Exterior_Details
                    htmlOutput += "<table id='Exterior_Details' width='100%'  class='FontSize' cellpadding='0' cellspacing='0'>" ' start table Exterior_Details
                    htmlOutput += "<tr><td colspan='2' width='100%'><font size='-1'><b>EXTERIOR</b>"

                    If Not IsDBNull(sqlReader.Item("ac_exterior_moyear")) Then

                        If Not String.IsNullOrEmpty(sqlReader.Item("ac_exterior_moyear").ToString.Trim) Then
                            If sqlReader.Item("ac_exterior_moyear").ToString.Trim.Length > 4 Then
                                temp_moyear = sqlReader.Item("ac_exterior_moyear").ToString.Trim
                                If temp_moyear.Length = 5 Then
                                    temp_moyear = Left(temp_moyear, 1) + "/" + Right(temp_moyear, 4)
                                Else
                                    If temp_moyear.Length = 6 Then
                                        temp_moyear = Left(temp_moyear, 2) + "/" + Right(temp_moyear, 4)
                                    End If
                                End If
                                htmlOutput += " ( <b><i>Updated: </i></b>" + temp_moyear + " )</font></td>"
                            Else
                                htmlOutput += " ( <b><i>Updated: </i></b>" + sqlReader.Item("ac_exterior_moyear").ToString + " )</font></td>"
                            End If
                        End If
                    End If

                    htmlOutput += "<tr><td width='2%'><font size='-1'>&nbsp;</font></td><td><font size='-1'>"

                    data_details = ""
                    data_type_last = ""

                    Do While sqlReaderTemp.Read
                        If Trim(data_details) <> "" Then
                            data_details &= ", "
                        End If

                        If Trim(data_type_last) <> Trim(sqlReaderTemp.Item("adet_data_name").ToString) Then
                            data_details &= "<b>" & sqlReaderTemp.Item("adet_data_name").ToString & "</b>: "
                        End If
                        data_details &= sqlReaderTemp("adet_data_description").ToString

                        data_type_last = Trim(sqlReaderTemp.Item("adet_data_name").ToString)

                    Loop
                    htmlOutput += data_details

                    htmlOutput += "</font></td></tr>"
                    htmlOutput += "</table>" ' end table Exterior_Details
                    htmlOutput += "</td>" ' end TD for TR_Exterior_Details
                    htmlOutput += "</tr>" ' end TR_Exterior_Details
                ElseIf Trim(ext_doneby) <> "" Then

                    htmlOutput += "<tr id='TR_Exterior_Details'>" ' start TR_Exterior_Details
                    htmlOutput += "<td width='100%' colspan='4'>" ' start td for table TR_Exterior_Details
                    htmlOutput += "<table id='Exterior_Details' width='100%'  class='FontSize' cellpadding='0' cellspacing='0'>" ' start table Exterior_Details
                    htmlOutput += "<tr><td colspan='2' width='100%'><font size='-1'><b>EXTERIOR</b>"


                    If Not IsDBNull(sqlReader.Item("ac_exterior_moyear")) Then

                        If Not String.IsNullOrEmpty(sqlReader.Item("ac_exterior_moyear").ToString.Trim) Then
                            If sqlReader.Item("ac_exterior_moyear").ToString.Trim.Length > 4 Then
                                temp_moyear = sqlReader.Item("ac_exterior_moyear").ToString.Trim
                                If temp_moyear.Length = 5 Then
                                    temp_moyear = Left(temp_moyear, 1) + "/" + Right(temp_moyear, 4)
                                Else
                                    If temp_moyear.Length = 6 Then
                                        temp_moyear = Left(temp_moyear, 2) + "/" + Right(temp_moyear, 4)
                                    End If
                                End If
                                htmlOutput += " ( <b><i>Updated: </i></b>" + temp_moyear + " )</font></td>"
                            Else
                                htmlOutput += " ( <b><i>Updated: </i></b>" + sqlReader.Item("ac_exterior_moyear").ToString + " )</font></td>"
                            End If
                        End If
                    End If

                    htmlOutput += "</tr>"
                    htmlOutput += "<tr><td width='2%'><font size='-1'>&nbsp;</font></td><td>"
                    htmlOutput += ext_doneby
                    htmlOutput += "</td></tr>"
                    htmlOutput += "</table>" ' end table Exterior_Details
                    htmlOutput += "</td>" ' end TD for TR_Exterior_Details
                    htmlOutput += "</tr>" ' end TR_Exterior_Details
                End If

                sqlReaderTemp.Close()

                ' Start Avionics    
                Query = "SELECT * FROM Aircraft_Avionics WITH(NOLOCK) WHERE av_ac_id = " + nAircraftID.ToString + " AND av_ac_journ_id = " + nAircraftJournalID.ToString + " AND av_name IN ('Avioncs Package', 'FMS', 'GPS', 'TAWS', 'TCAS', 'SATCOM', 'EFIS', 'CVR', 'FDR')"

                SqlCommand.CommandText = Query
                sqlReaderTemp = SqlCommand.ExecuteReader()

                If sqlReaderTemp.HasRows Then
                    htmlOutput += "<tr id='TR_Avionics'>" ' TR_Avionics
                    htmlOutput += "<td width='55%' colspan='4'>" ' start td for table Avionics
                    htmlOutput += "<table id='Avionics' width='100%'  class='FontSize' cellpadding='0' cellspacing='0'>" ' start table Avionics
                    htmlOutput += "<tr><td colspan='2'><font size='-1'><b>AVIONICS</b></font></td></tr>"
                    htmlOutput += "<tr><td width='2%'><font size='-1'>&nbsp;</font></td><td><font size='-1'>"


                    data_details = ""
                    data_details = ""

                    Do While sqlReaderTemp.Read
                        If Trim(data_details) <> "" Then
                            data_details &= ", "
                        End If

                        If Trim(data_type_last) <> Trim(sqlReaderTemp.Item("av_name").ToString) Then
                            data_details &= "<b>" & sqlReaderTemp.Item("av_name").ToString & "</b>: "
                        End If
                        data_details &= sqlReaderTemp("av_description").ToString

                        data_type_last = Trim(sqlReaderTemp.Item("av_name").ToString)

                    Loop
                    htmlOutput += data_details

                    htmlOutput += "</font></td></tr>"
                    htmlOutput += "</table>" ' end Avionics
                    htmlOutput += "</td>" ' end td for table Avionics
                    htmlOutput += "</tr>" ' end TR_Avionics
                End If

                sqlReaderTemp.Close()

                ' start Cockpit Details
                Query = "SELECT * FROM Aircraft_Details WITH(NOLOCK) WHERE adet_ac_id = " + nAircraftID.ToString
                Query = Query + " AND adet_journ_id = " + nAircraftJournalID.ToString + " AND lower(adet_data_type) = 'addl cockpit equipment' AND adet_data_name <> 'General'"

                SqlCommand.CommandText = Query
                sqlReaderTemp = SqlCommand.ExecuteReader()

                If sqlReaderTemp.HasRows Then
                    htmlOutput += "<tr id='TR_Cockpit_Details'>" ' start TR_Cockpit_Details
                    htmlOutput += "<td width='55%' colspan='4'>"
                    htmlOutput += "<table id='Cockpit_Details' width='100%'  class='FontSize' cellpadding='0' cellspacing='0'>" ' table Cockpit_Details
                    htmlOutput += "<tr><td colspan='4'><font size='-1'><b>COCKPIT</b></font></td></tr>"
                    htmlOutput += "<tr>"
                    htmlOutput += "<tr><td width='2%'><font size='-1'>&nbsp;</font></td><td><font size='-1'>"


                    data_details = ""
                    data_type_last = ""

                    Do While sqlReaderTemp.Read
                        If Trim(data_details) <> "" Then
                            data_details &= ", "
                        End If

                        If Trim(data_type_last) <> Trim(sqlReaderTemp.Item("adet_data_name").ToString) Then
                            data_details &= "<b>" & sqlReaderTemp.Item("adet_data_name").ToString & "</b>: "
                        End If
                        data_details &= sqlReaderTemp("adet_data_description").ToString


                        data_type_last = Trim(sqlReaderTemp.Item("adet_data_name").ToString)
                    Loop

                    htmlOutput += data_details
                    htmlOutput += "</font></td></tr>"
                    htmlOutput += "</table>" ' end table Cockpit_Details
                    htmlOutput += "</td>"
                    htmlOutput += "</tr>" ' end TR_Cockpit_Details

                End If

                ' end Cockpit Details
                htmlOutput += "</td></tr>" 'end TR_Main_Table_For_AC_Specs_Addtl_Pics

                ' start footer
                htmlOutput += "<tr id='TR_Footer'><td align='center' width='100%' colspan='2'><table  width='100%' class='FontSize' style='border-top:thick solid #C3C3C3; border-width:thin;'><tr width='100%'><td width='100%' align=center colspan=2>"
                'class='tdFooter'
                htmlOutput += "<b><font size='-1'>JETNET LLC.</font></b></td></tr></table></td></tr>"

            End If   ' end of loop for big selection 

            htmlOutput += "</table>" 'Main_Table_AC_Specs

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_single_page_spec_sheet()" + ex.Message
        Finally

            If Not sqlReader.IsClosed Then
                sqlReader.Close()
            End If

            If Not sqlReaderTemp.IsClosed Then
                sqlReaderTemp.Close()
            End If


            sqlReaderTemp = Nothing

            sqlReader = Nothing
            sqlReaderTemp = Nothing

            SqlCommand2.Dispose()
            SqlConn2.Close()
            SqlConn2.Dispose()
            SqlConn2 = Nothing

            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

        End Try

        Return htmlOutput.ToString

    End Function

    Public Function build_style_single_and_condensed_page_spec() As String

        Dim sServerMapPath As String = ""
        Dim sSiteStyleSheet As String = "common\style.css"
        sServerMapPath = Server.MapPath(sSiteStyleSheet)
        Dim txtFile As New System.IO.StreamReader(sServerMapPath)
        Dim readStyle As New StringBuilder
        Dim formatStyle As String = "<style type='text/css'>"

        Try

            readStyle.Append(formatStyle)

            Do While txtFile.EndOfStream <> True
                formatStyle = txtFile.ReadLine()
                If Trim(formatStyle.StartsWith(".border_bottom")) Then
                    formatStyle = formatStyle.Replace("0px", "1px")
                ElseIf Trim(formatStyle.StartsWith(".border_bottom_right")) Then
                    formatStyle = formatStyle.Replace("0px", "1px")
                ElseIf Trim(formatStyle.StartsWith(".leftside")) Then
                    formatStyle = formatStyle.Replace("0px", "1px")
                ElseIf Trim(formatStyle.StartsWith(".rightside")) Then
                    formatStyle = formatStyle.Replace("0px", "1px")
                ElseIf Trim(readStyle.ToString.EndsWith("TD{")) Then
                    formatStyle = formatStyle.Replace("8pt", "12pt")
                End If

                readStyle.Append(formatStyle + vbCrLf)

            Loop

            readStyle.Append(".break { page-break-before: always; }" + vbCrLf)

            If bWordReport Then
                readStyle.Append(".small_text{font-family:Arial;font-size: small}" + vbCrLf)
                readStyle.Append(".small_bold_text{font-family:Arial;font-size:  small; font-weight: bold;}" + vbCrLf)
            Else
                readStyle.Append(".small_text{font-family:Arial;font-size: small}" + vbCrLf)
                readStyle.Append(".small_bold_text{font-family:Arial;font-size:  small; font-weight: bold;}" + vbCrLf)
            End If

            readStyle.Append(".table_specs{font-size:12px;}" + vbCrLf)

            readStyle.Append("table.centerTable{margin-right: auto; margin-left: auto;}" + vbCrLf)

            readStyle.Append("</style>" + vbCrLf)

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Build_PDF_Template_Header()" + ex.Message
        End Try

        Return vbCrLf + readStyle.ToString + vbCrLf

    End Function

#End Region

#Region "report_40_functions"

    Public Function create_condensed_spec_sheet(ByVal item_string As Array, ByRef record_count As Long) As String

        Dim htmlOut = New StringBuilder()

        Try


            htmlOut.Append("<html><head><title>Condensed Spec Sheet</title>" + build_style_single_and_condensed_page_spec() + "</head>")



            If bWordReport = True Then
                htmlOut.Append("<table width='" & word_width_new & "' align='center'>")
                htmlOut.Append("<tr valign='top'><td width='100%'>")
                htmlOut.Append("<table>")
            Else
            End If
            ' htmlOut.Append("<body style='background: white; margin-top:10px; margin-left:10px;'>")
            '  htmlOut.Append("<div style='text-align:center;'>")

            For i As Integer = 0 To UBound(item_string)

                record_count = UBound(item_string)

                htmlOut.Append("<tr><td>")


                htmlOut.Append(build_condensed_spec_sheet_html(CLng(item_string(i))))

                If UBound(item_string) > 0 Then
                    htmlOut.Append("<table width='100%' align='center' class='break'><tr><td>&nbsp;</td></tr></table>")
                End If

                htmlOut.Append("</td></tr>")

            Next


            If bWordReport = True Then
                htmlOut.Append("</table></td></tr></table>")
            End If

            htmlOut.Append("</div></body></html>")

        Catch ex As Exception

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Create_Condensed_Spec_Sheet(ByVal number_ac As Integer, ByVal item_string As Array) As String" + ex.Message

        End Try

        Return htmlOut.ToString

        htmlOut = Nothing

    End Function

    Public Function build_condensed_spec_sheet_html(ByVal nAircraftID As Long) As String

        Dim htmlOut = New StringBuilder()
        Dim htmlOut2 = New StringBuilder()

        Dim ac_apu_model_name As String = ""
        Dim ac_apu_tot_hrs As String = ""
        Dim ac_apu_ser_no As String = ""
        Dim ac_apu_maintance_program As String = ""
        Dim xLoop As Integer
        Dim nloopCount As Integer = 4
        Dim sAirframeType As String = ""
        Dim other_engine_info As String = ""
        Dim ac_airframe_tot_hrs As String = ""
        Dim engine_col_counter As Integer = 1
        Dim temp_string As String = ""
        Dim temp_string2 As String = ""
        Dim temp_moyear As String = ""
        Dim temp_ex_moyear As String = ""
        Dim Query2 As String : Query2 = ""
        Dim temp3 As String = ""
        Dim total_contact_rows As Integer = 0
        Dim item_found As Boolean = False

        Dim sqlReader2 As System.Data.SqlClient.SqlDataReader = Nothing
        Dim sqlReader As System.Data.SqlClient.SqlDataReader = Nothing

        Dim SqlConn2 As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand2 As New System.Data.SqlClient.SqlCommand

        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand

        Dim comp_image_file As String = ""
        Dim temp_height As Integer = 0
        Dim temp_width As Integer = 0
        Dim zimage2 As System.Drawing.Image
        ' Dim zimage3 As System.Drawing.Image
        Dim desired_width As Integer = 500
        Dim desired_height As Integer = 142
        Dim temp_percent1 As Double = 0.0
        Dim temp_percent2 As Double = 0.0
        Dim total_width As Integer = 0
        Dim width_size_total As Integer = 740
        Dim add_pic As String = "Y"
        Dim blow_up As Boolean = False
        Dim temp_calc As Double = 0.0
        Dim logo_link As String = ""
        Dim sQuery As New StringBuilder
        Dim address_info As String = ""
        Dim font_size_for_address As String = ""
        Dim nAircraftJournalID As Long = 0
        Dim realout As String = ""
        Dim nAddToAskingPrice As Double = 0


        Dim font_style As String = " face='sans-serif' "

        Try

            If Trim(Request("journ_id")) <> "" Then
                nAircraftJournalID = CLng(Trim(Request("journ_id")))
            End If

            SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            SqlConn2.ConnectionString = localFunctions.clientConnectStr

            SqlConn.Open()
            SqlConn2.Open()

            SqlCommand2.Connection = SqlConn2
            SqlCommand2.CommandType = System.Data.CommandType.Text
            SqlCommand2.CommandTimeout = 60

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 90

            If bWordReport Then
                htmlOut.Append("<table cellpadding='2' cellspacing='0' width='" & word_width_new & "'><tr><td>")
            End If

            If logo_check.Checked = True Then


                sQuery.Append("SELECT TOP 1 * FROM Company INNER JOIN Subscription ON comp_id = sub_comp_id AND comp_journ_id = 0")
                sQuery.Append(" WHERE sub_id = " + Session.Item("localUser").crmSubSubID.ToString)

                SqlCommand.CommandText = sQuery.ToString
                sqlReader = SqlCommand.ExecuteReader()

                If sqlReader.HasRows Then

                    sqlReader.Read()

                    font_size_for_address = "-2"
                    'If Not IsDBNull(sqlReader.Item("comp_address1")) And Not IsDBNull(sqlReader.Item("comp_address2")) Then
                    '  If (sqlReader.Item("comp_address1").ToString.Length + sqlReader.Item("comp_address2").ToString.Length) > 50 Then
                    '    font_size_for_address = "-3"
                    '  Else
                    '    font_size_for_address = "-2"
                    '  End If
                    'Else

                    'End If

                    ' address_info = ("<table cellspacing='0' cellpadding='0' width='98%'><tr><td colspan='3' cellpadding='0' cellspacing='0'>")

                    If Not IsDBNull(sqlReader.Item("comp_address1")) Then
                        If bWordReport Then
                            address_info &= "<tr valign='top'><td><font size='" + font_size_for_address + "' " & font_style & ">" + sqlReader.Item("comp_address1").ToString
                        Else
                            address_info &= "<tr valign='top'><td class='CompInfo'><font  size='" + font_size_for_address + "'  " & font_style & ">" + sqlReader.Item("comp_address1").ToString + "</font>"
                        End If
                    Else
                        If bWordReport Then
                            address_info &= "<tr valign='top'><td><font size='-1' " & font_style & ">"
                        Else
                            address_info &= "<tr valign='top'><td class='CompInfo'>"
                        End If

                    End If



                    If Not IsDBNull(sqlReader.Item("comp_logo_flag")) And logo_check.Checked Then
                        If sqlReader.Item("comp_logo_flag").ToString.ToUpper.Contains("Y") And logo_check.Checked Then
                            comp_image_file = HttpContext.Current.Server.MapPath("pictures\company\") & sqlReader.Item("comp_id").ToString & ".jpg"
                        ElseIf logo_check.Checked = True And invisible_label_parent_image.Text <> "" Then
                            comp_image_file = HttpContext.Current.Server.MapPath("pictures\company\") & invisible_label_parent_image.Text & ".jpg"
                        End If
                    ElseIf logo_check.Checked = True And invisible_label_parent_image.Text <> "" Then
                        comp_image_file = HttpContext.Current.Server.MapPath("pictures\company\") & invisible_label_parent_image.Text & ".jpg"
                    End If



                    temp_width = 0
                    temp_height = 0
                    If Trim(comp_image_file) <> "" Then
                        Try
                            zimage2 = System.Drawing.Image.FromFile(comp_image_file)
                            temp_width = zimage2.Width
                            temp_height = zimage2.Height
                            desired_width = 140
                            desired_height = 140

                            If temp_width > desired_width Then
                                temp_percent1 = CDbl(CDbl(desired_width) / CDbl(temp_width))
                                temp_width = CDbl(CDbl(temp_width) * CDbl(temp_percent1))
                                temp_height = CDbl(CDbl(temp_height) * CDbl(temp_percent1))
                            End If

                            If temp_height > desired_height Then
                                temp_percent1 = CDbl(CDbl(desired_height) / CDbl(temp_height))
                                temp_width = CDbl(CDbl(temp_width) * CDbl(temp_percent1))
                                temp_height = CDbl(CDbl(temp_height) * CDbl(temp_percent1))
                            End If
                        Catch ex As Exception

                        End Try
                    End If


                    If temp_width = 0 Then
                        temp_width = 140
                    End If

                    If bWordReport Then
                        If Not IsDBNull(sqlReader.Item("comp_logo_flag")) And logo_check.Checked Then
                            If sqlReader.Item("comp_logo_flag").ToString.ToUpper.Contains("Y") And logo_check.Checked Then

                                If HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then

                                    If Not Application.Item("crmClientSiteData").crmClientHostName.ToString.ToUpper.Contains("NEWEVONET") Then
                                        logo_link = "https://www.testjetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                                    Else
                                        logo_link = "http://www.jetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                                    End If

                                Else
                                    logo_link = Application.Item("crmClientSiteData").ClientFullHostName.ToString.Trim + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                                End If
                                logo_link = "<img src='" + logo_link + "/" + sqlReader.Item("comp_id").ToString + ".jpg' width='" & temp_width & "' height='" & (temp_width / 2) & "'>"
                            ElseIf logo_check.Checked = True And invisible_label_parent_image.Text <> "" Then

                                If HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then

                                    If Not Application.Item("crmClientSiteData").crmClientHostName.ToString.ToUpper.Contains("NEWEVONET") Then
                                        logo_link = "https://www.testjetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                                    Else
                                        logo_link = "http://www.jetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                                    End If

                                Else
                                    logo_link = Application.Item("crmClientSiteData").ClientFullHostName.ToString.Trim + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                                End If
                                logo_link = "<img src='" + logo_link + "/" + invisible_label_parent_image.Text + ".jpg' width='" & temp_width & "' height='" & (temp_width / 2) & "'>"
                            End If
                        ElseIf logo_check.Checked = True And invisible_label_parent_image.Text <> "" Then

                            If HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then

                                If Not Application.Item("crmClientSiteData").crmClientHostName.ToString.ToUpper.Contains("NEWEVONET") Then
                                    logo_link = "https://www.testjetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                                Else
                                    logo_link = "http://www.jetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                                End If

                            Else
                                logo_link = Application.Item("crmClientSiteData").ClientFullHostName.ToString.Trim + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                            End If
                            logo_link = "<img src='" + logo_link + "/" + invisible_label_parent_image.Text + ".jpg' width='" & temp_width & "' height='" & (temp_width / 2) & "'>"
                        End If
                    Else
                        If Not IsDBNull(sqlReader.Item("comp_logo_flag")) And logo_check.Checked Then
                            If sqlReader.Item("comp_logo_flag").ToString.ToUpper.Contains("Y") And logo_check.Checked Then

                                If HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then

                                    If Not Application.Item("crmClientSiteData").crmClientHostName.ToString.ToUpper.Contains("NEWEVONET") Then
                                        logo_link = "https://www.testjetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                                    Else
                                        logo_link = "http://www.jetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                                    End If

                                Else
                                    logo_link = Application.Item("crmClientSiteData").ClientFullHostName.ToString.Trim + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                                End If

                                logo_link = "<img src='" + logo_link + "/" + sqlReader.Item("comp_id").ToString + ".jpg' width='" & temp_width & "'>"
                            ElseIf logo_check.Checked = True And invisible_label_parent_image.Text <> "" Then

                                If HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then

                                    If Not Application.Item("crmClientSiteData").crmClientHostName.ToString.ToUpper.Contains("NEWEVONET") Then
                                        logo_link = "https://www.testjetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                                    Else
                                        logo_link = "http://www.jetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                                    End If

                                Else
                                    logo_link = Application.Item("crmClientSiteData").ClientFullHostName.ToString.Trim + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                                End If

                                logo_link = "<img src='" + logo_link + "/" + invisible_label_parent_image.Text + ".jpg' width='" & temp_width & "'>"
                            End If
                        ElseIf logo_check.Checked = True And invisible_label_parent_image.Text <> "" Then

                            If HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then

                                If Not Application.Item("crmClientSiteData").crmClientHostName.ToString.ToUpper.Contains("NEWEVONET") Then
                                    logo_link = "https://www.testjetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                                Else
                                    logo_link = "http://www.jetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                                End If

                            Else
                                logo_link = Application.Item("crmClientSiteData").ClientFullHostName.ToString.Trim + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                            End If

                            logo_link = "<img src='" + logo_link + "/" + invisible_label_parent_image.Text + ".jpg' width='" & temp_width & "'>"
                        End If
                    End If


                    If Not IsDBNull(sqlReader.Item("comp_address2")) Then
                        address_info += "<font " & font_style & "  size='" + font_size_for_address + "' > . " + sqlReader.Item("comp_address2").ToString + "</font>"
                    End If

                    If font_size_for_address = "-2" Or Not String.IsNullOrEmpty(logo_link) Then
                        address_info += "<br />"
                    End If

                    If Not IsDBNull(sqlReader.Item("comp_city")) Then
                        address_info += "<font " & font_style & " size='" + font_size_for_address + "' > " + sqlReader.Item("comp_city").ToString + "</font>"
                    End If

                    If Not IsDBNull(sqlReader.Item("comp_state")) Then
                        address_info += "<font " & font_style & " size='" + font_size_for_address + "' >, " + sqlReader.Item("comp_state").ToString + "</font>"
                    End If

                    If Not IsDBNull(sqlReader.Item("comp_zip_code")) Then
                        address_info += "<font " & font_style & " size='" + font_size_for_address + "' > " + sqlReader.Item("comp_zip_code").ToString + "</font>"
                    End If

                    address_info += "</td></tr>"
                    address_info += "<tr><td>"
                    address_info += "<table cellpadding='0' cellspacing='0' border='0'>"
                    address_info += "<tr><td align='left'>"
                    address_info += "<table cellpadding='0' cellspacing='0' border='0'>"
                    address_info += build_phone_info_full_spec(CLng(Session.Item("localUser").crmSubSubID.ToString), "black", " size='-2'")
                    address_info += "</table>"
                    address_info += "</td><td>"
                    If Not IsDBNull(sqlReader.Item("comp_web_address")) Then
                        address_info += " &#8226; "

                        If sqlReader.Item("comp_web_address").ToString.Trim.ToLower.Contains("www") Then
                            address_info += "<a href='http://" + sqlReader.Item("comp_web_address").ToString.Trim + "' target='new'>" + sqlReader.Item("comp_web_address").ToString.Trim + "</a>"
                        Else
                            address_info += "<a href='" + sqlReader.Item("comp_web_address").ToString.Trim + "' target='new'>" + sqlReader.Item("comp_web_address").ToString.Trim + "</a>"
                        End If

                        address_info += ""

                    Else
                        address_info += "&nbsp;"
                    End If
                    address_info += "</td></tr>"
                    address_info += "</table>"
                    address_info += "</td></tr>"
                    ' address_info += "</table>"

                End If
                sqlReader.Close()

                ' if we are doing a double blind, then allow the company data to dissapear 
                If chkBlindReport.Checked = True And check_blind_company.Checked = True Then
                Else
                    htmlOut.Append(build_full_spec_page_header_condensed(nAircraftID, "Aircraft Information", address_info, logo_link))
                End If


                ' htmlOut.Append(address_info)
                ' htmlOut.Append("<table width='100%' height='1'><tr><td width='100%' height='1px' bgcolor='black'></td></tr></table>")

            Else

                htmlOut.Append("<table width='100%' height='1'><tr><td width='100%' height='1px' bgcolor='black'></td></tr></table>")

            End If







            If check_prepared_for.Checked = True Then
                If prepared_for.Text <> "" Then
                    htmlOut.Append("<table class='FontSize' cellspacing='0' cellpadding='0' align='right'><tr><td nowrap='nowrap' align='right'><font size='-1'><b>Prepared For: </b>" & Trim(prepared_for.Text) & "&nbsp;&nbsp;&nbsp;</font></td></tr></table>")
                End If
            End If

            If bWordReport Then
                htmlOut.Append("</td></tr><tr><td>")
            End If

            Query2 = "SELECT * "
            Query2 &= " , (select top 1 emp_name from Engine_Maintenance_Program where ac_apu_maint_prog = emp_code)as ac_apu_maintance_program "
            Query2 &= " FROM Aircraft WITH(NOLOCK) INNER JOIN Aircraft_Model WITH(NOLOCK) ON ac_amod_id = amod_id"
            Query2 &= " WHERE ac_journ_id = " & nAircraftJournalID & " AND ac_id = " + nAircraftID.ToString

            SqlCommand2.CommandText = Query2
            sqlReader2 = SqlCommand2.ExecuteReader()
            sqlReader2.Read()

            If sqlReader2.HasRows Then
                If bWordReport Then
                    htmlOut.Append("<br /><table class='centerTable' border='1' bordercolor='#949494' cellpadding='2' cellspacing='0' width='" & word_width_new & "'>")
                Else
                    htmlOut.Append("<br /><table class='centerTable' border='1' bordercolor='#949494' cellpadding='2' cellspacing='0' width='98%'>")
                End If

                ' start the Aircraft Identification Status
                ' ------------------------------ THIS IS FIRST ROW OF BLOCK ------------------------
                ' make
                If Not IsDBNull(sqlReader2.Item("amod_make_name")) Or Not IsDBNull(sqlReader2.Item("amod_make_name")) Then
                    htmlOut.Append("<tr valign='top'><td class='small_bold_text' width='10%'>Model</td><td class='small_text' width='15%'>: " + sqlReader2.Item("amod_make_name").ToString + " " + sqlReader2.Item("amod_model_name").ToString + "</td>")
                Else
                    htmlOut.Append("<tr valign='top'><td class='small_bold_text'>Model</td><td class='small_bold_text'>:&nbsp;</td>")
                End If

                If Not bAerodexFlag Then

                    htmlOut.Append("<td class='small_bold_text'>&nbsp;</td><td class='small_bold_text'>&nbsp;</td>") ' leave blank

                    If bWordReport Then

                        If chkShowAsking.Checked And Not bAerodexFlag Then

                            If Not IsDBNull(sqlReader2.Item("ac_asking_price")) Or Not IsDBNull(sqlReader2.Item("ac_asking")) Then
                                If Not IsDBNull(sqlReader2.Item("ac_asking")) Then
                                    If sqlReader2.Item("ac_asking") = "Price" Then
                                        htmlOut.Append("<td class='small_bold_text' width='13%'>")

                                        If Not IsDBNull(sqlReader2.Item("ac_foreign_currency_name")) Then
                                            htmlOut.Append("Ask Amt (" + sqlReader2.Item("ac_foreign_currency_name").ToString + ") ")
                                            htmlOut.Append("<br>Ask Amt (USD)")
                                        Else
                                            htmlOut.Append("Ask Amt (USD)")
                                        End If
                                        htmlOut.Append("</td><td class='small_text' width='17%'>")



                                        If Not String.IsNullOrEmpty(addToAsking.Text.Trim) Then
                                            nAddToAskingPrice = CDbl(Replace(addToAsking.Text, Constants.cCommaDelim, Constants.cEmptyString))
                                        End If

                                        If Not IsDBNull(sqlReader2.Item("ac_foreign_currency_price")) Then
                                            htmlOut.Append(": " + FormatNumber(sqlReader2.Item("ac_foreign_currency_price"), 0))
                                            htmlOut.Append("<br>: " + FormatNumber(FormatCurrency(sqlReader2.Item("ac_asking_price"), 0) + nAddToAskingPrice, 0).ToString)
                                        Else
                                            htmlOut.Append(": " + FormatNumber(FormatCurrency(sqlReader2.Item("ac_asking_price"), 0) + nAddToAskingPrice, 0).ToString)
                                        End If


                                    Else
                                        htmlOut.Append("<td class='small_bold_text' width='13%'>Ask Amt (USD)")
                                        If Not IsDBNull(sqlReader2.Item("ac_foreign_currency_name")) Then
                                            htmlOut.Append("<br>Ask Amt (" + sqlReader2.Item("ac_foreign_currency_name").ToString + ") ")
                                        End If
                                        htmlOut.Append("</td>")
                                        htmlOut.Append("<td class='small_text' width='17%'>: " + sqlReader2.Item("ac_asking").ToString)
                                        If Not IsDBNull(sqlReader2.Item("ac_foreign_currency_price")) Then
                                            htmlOut.Append("<br>: " + FormatNumber(sqlReader2.Item("ac_foreign_currency_price"), 0))
                                        End If

                                    End If

                                    htmlOut.Append("</td>")
                                End If
                            Else
                                htmlOut.Append("<td class='small_bold_text' width='13%'>Ask Amt (USD)</td><td class='small_text' width='17%'>: &nbsp;</td>")
                            End If
                        End If


                        If Not IsDBNull(sqlReader2.Item("ac_purchase_date")) Then
                            htmlOut.Append("<td class='small_bold_text' width='10%' valign='top'>Purch Date</td><td class='small_text' width='10%'>: " + FormatDateTime(sqlReader2.Item("ac_purchase_date"), DateFormat.ShortDate).ToString + "</td>")
                        Else
                            htmlOut.Append("<td class='small_bold_text'>&nbsp;</td><td class='small_bold_text'>&nbsp;</td>")
                        End If
                    Else

                        If chkShowAsking.Checked And Not bAerodexFlag Then

                            If Not IsDBNull(sqlReader2.Item("ac_asking_price")) Or Not IsDBNull(sqlReader2.Item("ac_asking")) Then
                                If Not IsDBNull(sqlReader2.Item("ac_asking")) Then

                                    If sqlReader2.Item("ac_asking") = "Price" Then
                                        htmlOut.Append("<td class='small_bold_text' width='13%'>")
                                        If Not IsDBNull(sqlReader2.Item("ac_foreign_currency_name")) Then
                                            htmlOut.Append("Ask Amt (" + sqlReader2.Item("ac_foreign_currency_name").ToString + ") ")
                                            htmlOut.Append("<br />Asking Amt (USD)")
                                        Else
                                            htmlOut.Append("Asking Amt (USD)")
                                        End If
                                        htmlOut.Append("</td><td class='small_text' width='17%'>")


                                        If Not String.IsNullOrEmpty(addToAsking.Text.Trim) Then
                                            nAddToAskingPrice = CDbl(Replace(addToAsking.Text, Constants.cCommaDelim, Constants.cEmptyString))
                                        End If

                                        If Not IsDBNull(sqlReader2.Item("ac_foreign_currency_price")) Then
                                            htmlOut.Append(": " + FormatNumber(sqlReader2.Item("ac_foreign_currency_price"), 0))
                                            htmlOut.Append("<br>: " + FormatNumber(FormatCurrency(sqlReader2.Item("ac_asking_price"), 0) + nAddToAskingPrice, 0).ToString)
                                        Else
                                            htmlOut.Append(": " + FormatNumber(FormatCurrency(sqlReader2.Item("ac_asking_price"), 0) + nAddToAskingPrice, 0).ToString)
                                        End If


                                        htmlOut.Append("</td>")
                                    Else

                                        htmlOut.Append("<td class='small_bold_text' width='13%'>Asking Amt (USD)")
                                        If Not IsDBNull(sqlReader2.Item("ac_foreign_currency_name")) Then
                                            htmlOut.Append("<br>Ask Amt (" + sqlReader2.Item("ac_foreign_currency_name").ToString + ") ")
                                        End If
                                        htmlOut.Append("</td>")
                                        htmlOut.Append("<td class='small_text' width='17%'>: " + sqlReader2.Item("ac_asking").ToString)

                                        If Not IsDBNull(sqlReader2.Item("ac_foreign_currency_price")) Then
                                            htmlOut.Append("<br>: " + FormatNumber(sqlReader2.Item("ac_foreign_currency_price"), 0))
                                        End If
                                        htmlOut.Append("</td>")

                                    End If
                                End If

                            Else
                                htmlOut.Append("<td class='small_bold_text' width='13%'>Asking Amt (USD)</td><td class='small_text' width='17%'>: &nbsp;</td>")
                            End If
                        End If


                        If Not IsDBNull(sqlReader2.Item("ac_purchase_date")) Then
                            htmlOut.Append("<td class='small_bold_text' width='10%' valign='top'>Purchase Date</td><td class='small_text' width='10%'>: " + FormatDateTime(sqlReader2.Item("ac_purchase_date"), DateFormat.ShortDate).ToString + "</td>")
                        Else
                            htmlOut.Append("<td class='small_bold_text'>&nbsp;</td><td class='small_bold_text'>&nbsp;</td>")
                        End If
                    End If
                End If
                ' ------------------------------ THIS IS FIRST ROW OF BLOCK ------------------------


                ' ------------------------------ THIS IS SECOND ROW OF BLOCK ------------------------

                ' if its not aerodex, break it like it was before
                If Not bAerodexFlag Then
                    htmlOut.Append("</tr><tr>")
                End If

                If Not chkBlindReport.Checked Then
                    If Not IsDBNull(sqlReader2.Item("ac_ser_no_full")) Then
                        If Not String.IsNullOrEmpty(sqlReader2.Item("ac_ser_no_full").ToString) Then
                            htmlOut.Append("<td class='small_bold_text' width='10%'>Serial #</td><td class='small_text' width='15%'>: " + sqlReader2.Item("ac_ser_no_full").ToString + "</font></td>")
                        Else
                            htmlOut.Append("<td class='small_bold_text' width='10%'>Serial #</td><td class='small_text' width='15%'>: &nbsp;</font></td>")
                        End If
                    End If
                Else
                    htmlOut.Append("<td class='small_bold_text' width='10%'>Aircraft ID:</td><td class='small_text' width='15%'> " + sqlReader2.Item("ac_id").ToString + "</font></td>")
                End If

                If Not IsDBNull(sqlReader2.Item("ac_year")) Then
                    htmlOut.Append("<td class='small_bold_text' width='7%'>YR DLV</td><td class='small_text' width='13%'>: " + sqlReader2.Item("ac_year").ToString + "</font></td>")
                Else
                    htmlOut.Append("<td class='small_bold_text' width='7%'>YR DLV</td><td class='small_text' width='13%'>: &nbsp;</font></td>")
                End If

                If Not bAerodexFlag Then
                    If Not IsDBNull(sqlReader2.Item("ac_status")) Then
                        htmlOut.Append("<td class='small_bold_text' width='13%'>Status</td><td class='small_text' width='17%'>: " + sqlReader2.Item("ac_status".ToString) + "</td>")
                    Else
                        htmlOut.Append("<td class='small_bold_text' width='13%'>Status</td><td class='small_text' width='17%'>&nbsp;</td>")
                    End If
                End If

                If Not IsDBNull(sqlReader2.Item("ac_upd_date")) Then
                    htmlOut.Append("<td class='small_bold_text' width='10%' valign='top'>Date Edited</td><td class='small_text' width='10%'>: " + FormatDateTime(sqlReader2.Item("ac_upd_date"), DateFormat.ShortDate).ToString + "</td></tr>") ' Date Edited ac_upd_date
                Else
                    htmlOut.Append("<td class='small_bold_text' width='10%' valign='top'>Date Edited</td><td class='small_text' width='10%'>:&nbsp;</td></tr>") ' Date Edited ac_upd_date
                End If


                ' in both cases
                htmlOut.Append("</tr><tr>")

                If bWordReport Then
                    If Not chkBlindReport.Checked Then
                        If Not IsDBNull(sqlReader2.Item("ac_reg_no")) Then
                            If Not String.IsNullOrEmpty(sqlReader2.Item("ac_ser_no_full").ToString) Then
                                htmlOut.Append("<td class='small_bold_text' width='10%'>Reg #</td><td class='small_text' width='20%'>: " + sqlReader2.Item("ac_reg_no").ToString)
                                If Not IsDBNull(sqlReader2.Item("ac_reg_no_expiration_date")) Then
                                    htmlOut.Append("  <font class='small_bold_text'> Exp:  </font>" + FormatDateTime(sqlReader2.Item("ac_reg_no_expiration_date"), DateFormat.ShortDate).ToString)
                                End If
                                htmlOut.Append("</td>")
                            Else
                                htmlOut.Append("<td class='small_bold_text' width='10%'>Reg #</td><td class='small_text' width='20%'>: &nbsp;</td>")
                            End If
                        Else
                            htmlOut.Append("<td class='small_bold_text' width='10%'>Reg #</td><td class='small_text' width='20%'>: &nbsp;</td>")
                        End If
                    Else
                        htmlOut.Append("<td class='small_bold_text' width='10%'></td><td class='small_text' width='15%'>&nbsp;</font></td>")
                    End If
                Else
                    If Not chkBlindReport.Checked Then
                        If Not IsDBNull(sqlReader2.Item("ac_reg_no")) Then
                            If Not String.IsNullOrEmpty(sqlReader2.Item("ac_ser_no_full").ToString) Then
                                htmlOut.Append("<td class='small_bold_text' width='10%'>Registration #</td><td class='small_text' width='20%'>: " + sqlReader2.Item("ac_reg_no").ToString)
                                If Not IsDBNull(sqlReader2.Item("ac_reg_no_expiration_date")) Then
                                    htmlOut.Append("  <font class='small_bold_text'> Exp:  </font>" + FormatDateTime(sqlReader2.Item("ac_reg_no_expiration_date"), DateFormat.ShortDate).ToString)
                                End If
                                htmlOut.Append("</td>")
                            Else
                                htmlOut.Append("<td class='small_bold_text' width='10%'>Registration #</td><td class='small_text' width='20%'>: &nbsp;</td>")
                            End If
                        Else
                            htmlOut.Append("<td class='small_bold_text' width='10%'>Registration #</td><td class='small_text' width='20%'>: &nbsp;</td>")
                        End If
                    Else
                        htmlOut.Append("<td class='small_bold_text' width='10%'></td><td class='small_text' width='15%'>&nbsp;</font></td>")
                    End If
                End If

                ' year of manufacture
                If Not IsDBNull(sqlReader2.Item("ac_mfr_year")) Then
                    htmlOut.Append("<td class='small_bold_text' width='7%'>YR MFT</td><td class='small_text' width='13%'>: " + sqlReader2.Item("ac_mfr_year").ToString + "</font></td>")
                Else
                    htmlOut.Append("<td class='small_bold_text' width='7%'>YR MFT</td><td class='small_text' width='13%'>:&nbsp;</font></td>")
                End If

                If Not bAerodexFlag Then
                    htmlOut.Append("<td class='small_bold_text' width='13%'>For Sale (Y/N)&nbsp;</td><td class='small_text' width='17%'>:&nbsp;" + sqlReader2.Item("ac_forsale_flag").ToString + "</td>") ' FOR SALE (Y/N)

                    If Not IsDBNull(sqlReader2.Item("ac_list_date")) Then
                        htmlOut.Append("<td class='small_bold_text' width='10%' valign='top'>Date Listed</td><td class='small_text' width='10%'>: " + FormatDateTime(sqlReader2.Item("ac_list_date"), DateFormat.ShortDate).ToString + "</font></td></tr>")
                    Else
                        htmlOut.Append("<td class='small_bold_text' width='10%' valign='top'>Date Listed</td><td class='small_text' width='10%'>:&nbsp;</font></td></tr>")
                    End If
                End If
                ' ------------------------------ THIS IS THIRD ROW OF BLOCK ------------------------

                ' ------------------------------ THIS IS FOURTH ROW OF BLOCK ------------------------

                If chkIncludeBaseLocation.Checked = True Then
                    htmlOut.Append("<td class='small_bold_text' valign='top'>AC/BASE</td><td colspan='3' valign='top'>" + build_condensed_aircraft_airport_information(nAircraftID, sqlReader, SqlCommand) + "</td>")
                Else
                    htmlOut.Append("<td class='small_bold_text' valign='top'>&nbsp;</td><td colspan='3' valign='top'>&nbsp;</td>")
                End If

                If Not bAerodexFlag Then
                    htmlOut.Append("</tr><tr>")
                End If

                If Not IsDBNull(sqlReader2.Item("ac_maintained")) Then
                    htmlOut.Append("<td class='small_bold_text' width='13%' valign='top'>Maintained</td><td class='small_text' width='17%' valign='top'>: " + sqlReader2.Item("ac_maintained").ToString + "</font></td>")
                Else
                    htmlOut.Append("<td class='small_bold_text' width='13%' valign='top'>Maintained</td><td class='small_text' width='17%' valign='top'>: &nbsp;</font></td>")
                End If

                If Not IsDBNull(sqlReader2.Item("ac_lease_flag")) Then
                    If sqlReader2.Item("ac_lease_flag").ToString.ToUpper.Trim.Contains("Y") Then
                        htmlOut.Append("<td class='small_bold_text' width='10%' valign='top'>Leased</td><td class='small_text' width='15%' valign='top'>: Yes</font></td>")
                    Else
                        htmlOut.Append("<td class='small_bold_text' width='10%' valign='top'>Leased</td><td class='small_text' width='15%' valign='top'>: No</font></td>")
                    End If
                Else
                    htmlOut.Append("<td class='small_bold_text' width='10%' valign='top'>Leased</td><td class='small_text' width='15%' valign='top'>: No</font></td>")
                End If

                ' ------------------------------ THIS IS FOURTH ROW OF BLOCK ------------------------

                If Not bAerodexFlag Then
                    htmlOut.Append("</tr>")
                End If

            End If

            If chkBlindReport.Checked = False Then
                If Not IsDBNull(sqlReader2.Item("ac_confidential_notes")) Then
                    If Not String.IsNullOrEmpty(sqlReader2.Item("ac_confidential_notes")) Then
                        htmlOut.Append("<tr><td colspan='15'><font class='small_bold_text'>Note: &nbsp;")
                        htmlOut.Append("</font><font class='small_text'>" + sqlReader2.Item("ac_confidential_notes").ToString + "&nbsp;</td></tr>")
                    End If
                End If
            End If

            htmlOut.Append("</table>")

            '  If bWordReport Then
            '  htmlOut.Append("</td></tr>") 
            '  htmlOut.Append("</table>")
            '  End If

            htmlOut2.Append(htmlOut.ToString)

            realout = htmlOut2.ToString




            If bWordReport Then
                htmlOut2.Append("<br /><table width='" & word_width_new & "' height='1'><tr><td width='100%' height='1px' bgcolor='black'></td></tr></table>")
            Else
                htmlOut2.Append("<br /><table width='100%' height='1'><tr><td width='100%' height='1px' bgcolor='black'></td></tr></table>")
            End If




            If chkTP_std.Checked = True Then

                temp3 = ""
                temp3 = build_condensed_aircraft_contacts(nAircraftID, "Normal", sqlReader, SqlCommand, total_contact_rows, nAircraftJournalID)

                If Not String.IsNullOrEmpty(temp3) Then
                    htmlOut2.Append(temp3)

                    If bWordReport Then
                        htmlOut2.Append("<br /><table width='" & word_width_new & "' height='1'><tr><td width='100%' height='1px' bgcolor='black'></td></tr></table>")
                    Else
                        htmlOut2.Append("<br /><table width='100%' height='1'><tr><td width='100%' height='1px' bgcolor='black'></td></tr></table>")
                    End If

                End If

                temp_string = ""
                If Not bAerodexFlag Then
                    If Not IsDBNull(sqlReader2.Item("ac_exclusive_flag")) Then
                        If sqlReader2.Item("ac_exclusive_flag").ToString.ToUpper.Contains("Y") Then
                            temp_string = build_condensed_aircraft_contacts(nAircraftID, "Broker", sqlReader, SqlCommand, total_contact_rows, nAircraftJournalID)
                            If Not String.IsNullOrEmpty(temp_string) Then
                                htmlOut2.Append(temp_string)

                                If bWordReport Then
                                    htmlOut2.Append("<br /><table width='" & word_width_new & "' height='1'><tr><td width='100%' height='1px' bgcolor='black'></td></tr></table>")
                                Else
                                    htmlOut2.Append("<br /><table width='100%' height='1'><tr><td width='100%' height='1px' bgcolor='black'></td></tr></table>")
                                End If
                            End If
                        End If
                    End If
                End If

                If bWordReport Then
                    htmlOut2.Append("<br /><table class='centerTable' border='1' bordercolor='#949494' cellpadding='2' cellspacing='0' width='" & word_width_new & "'>")
                Else
                    htmlOut2.Append("<br /><table class='centerTable' border='1' bordercolor='#949494' cellpadding='2' cellspacing='0' width='98%'>")
                End If


            End If

            If bWordReport Then
                htmlOut2.Append("<tr><td width='" & word_width_new_half & "'>") ' This starts next section
            Else
                htmlOut2.Append("<tr><td width='50%'>") ' This starts next section
            End If


            If Not bAerodexFlag Then
                If Not IsDBNull(sqlReader2.Item("ac_times_as_of_date")) Then
                    htmlOut2.Append("<table width='50%' cellpadding='2' cellspacing='0'><tr><td valign='middle' align='left' width='100%'><font  class='small_bold_text'>Times Current:</font><font class='small_text'>&nbsp;" + FormatDateTime(sqlReader2.Item("ac_times_as_of_date"), DateFormat.ShortDate).ToString + "</td></tr></table>")
                End If
            End If

            '----------------------------------------- ENGINE INFORMATION--------------------------------------------------------------------
            If bWordReport Then
                htmlOut2.Append("<table width='" & word_width_new_half & "' cellpadding='2' cellspacing='0'><tr><td>")
            Else
                htmlOut2.Append("<table width='50%' cellpadding='2' cellspacing='0'><tr><td>")
            End If



            htmlOut2.Append("<table cellpadding='2' cellspacing='0'><tr><td class='small_bold_text'> ENG TT</td><td class='small_bold_text'>: </td></tr><tr><td class='small_bold_text'>SMOH/CORE</td><td class='small_bold_text'>: </td></tr><tr><td class='small_bold_text'>SHOT/MPI </td><td class='small_bold_text'>: </td></tr><tr><td class='small_bold_text'>TBO </td><td class='small_bold_text'>: </td></tr><tr><td class='small_bold_text'>TCSN</td><td class='small_bold_text'>: </td></tr></table>")
            htmlOut2.Append("</td>")

            For xLoop = 1 To nloopCount

                If (Not IsDBNull(sqlReader2.Item("ac_engine_" + xLoop.ToString + "_tot_hrs")) Or
                    Not IsDBNull(sqlReader2.Item("ac_engine_" + xLoop.ToString + "_soh_hrs")) Or
                    Not IsDBNull(sqlReader2.Item("ac_engine_" + xLoop.ToString + "_shi_hrs")) Or
                    Not IsDBNull(sqlReader2.Item("ac_engine_" + xLoop.ToString + "_tbo_hrs")) Or
                    Not IsDBNull(sqlReader2.Item("ac_engine_" + xLoop.ToString + "_snew_cycles")) Or
                    Not IsDBNull(sqlReader2.Item("ac_engine_" + xLoop.ToString + "_soh_cycles")) Or
                    Not IsDBNull(sqlReader2.Item("ac_engine_" + xLoop.ToString + "_shs_cycles"))) Then

                    htmlOut2.Append("<td><table>")

                    If Not IsDBNull(sqlReader2.Item("ac_engine_" + xLoop.ToString + "_tot_hrs")) Then
                        htmlOut2.Append("<tr><td valign='middle' align='left' class='small_text'>&nbsp;" + FormatNumber(CDbl(sqlReader2.Item("ac_engine_" + xLoop.ToString + "_tot_hrs")), 0, True, False, True) + "</td></tr>")
                    Else
                        htmlOut2.Append("<tr><td valign='middle' align='left' class='small_text'>&nbsp;</td></tr>")
                    End If

                    If Not IsDBNull(sqlReader2.Item("ac_engine_" + xLoop.ToString + "_soh_hrs")) Then
                        htmlOut2.Append("<tr><td valign='middle' align='left' class='small_text'>&nbsp;" + FormatNumber(CDbl(sqlReader2.Item("ac_engine_" + xLoop.ToString + "_soh_hrs")), 0, True, False, True) + "</td></tr>")
                    Else
                        htmlOut2.Append("<tr><td valign='middle' align='left' class='small_text'>&nbsp;</td></tr>")
                    End If

                    If Not IsDBNull(sqlReader2.Item("ac_engine_" + xLoop.ToString + "_shi_hrs")) Then
                        htmlOut2.Append("<tr><td valign='middle' align='left' class='small_text'>&nbsp;" + FormatNumber(CDbl(sqlReader2.Item("ac_engine_" + xLoop.ToString + "_shi_hrs")), 0, True, False, True) + "</td></tr>")
                    Else
                        htmlOut2.Append("<tr><td valign='middle' align='left' class='small_text'>&nbsp;</td></tr>")
                    End If

                    If Not IsDBNull(sqlReader2.Item("ac_engine_" + xLoop.ToString + "_tbo_hrs")) Then
                        htmlOut2.Append("<tr><td valign='middle' align='left' class='small_text'>&nbsp;" + FormatNumber(CDbl(sqlReader2.Item("ac_engine_" + xLoop.ToString + "_tbo_hrs")), 0, True, False, True) + "</td></tr>")
                    Else
                        htmlOut2.Append("<tr><td valign='middle' align='left' class='small_text'>&nbsp;</td></tr>")
                    End If

                    If Not IsDBNull(sqlReader2.Item("ac_engine_" + xLoop.ToString + "_snew_cycles")) Then
                        htmlOut2.Append("<tr><td valign='middle' align='left' class='small_text'>&nbsp;" + FormatNumber(CDbl(sqlReader2.Item("ac_engine_" + xLoop.ToString + "_snew_cycles")), 0, True, False, True) + "</td></tr>")
                    Else
                        htmlOut2.Append("<tr><td valign='middle' align='left' class='small_text'>&nbsp;</td></tr>")
                    End If

                    'If Not IsDBNull(sqlReader2.item("ac_engine_" + xLoop.ToString + "_soh_cycles")) Then
                    '  htmlOut2.Append( "<tr><td valign='middle' align='left'>&nbsp;"  +  FormatNumber(CDbl(sqlReader2.item("ac_engine_" + xLoop.ToString + "_soh_cycles")), 0, True, False, True)  +  "</td></tr>")
                    'Else
                    '  htmlOut2.Append( "<tr><td valign='middle' align='left'>&nbsp;</td></tr>")
                    'End If

                    'If Not IsDBNull(sqlReader2.item("ac_engine_" + xLoop.ToString + "_shs_cycles")) Then
                    '  htmlOut2.Append( "<tr><td valign='middle' align='left'>&nbsp;"  +  FormatNumber(CDbl(sqlReader2.item("ac_engine_" + xLoop.ToString + "_shs_cycles")), 0, True, False, True)  +  "</td></tr>")
                    'Else
                    '  htmlOut2.Append( "<tr><td valign='middle' align='left'>&nbsp;</td></tr>")
                    'End If

                    htmlOut2.Append("</table></td>")

                    If Not IsDBNull(sqlReader2.Item("ac_engine_" + xLoop.ToString + "_ser_no")) Then
                        If engine_col_counter = 1 Then
                            other_engine_info += "<tr><td  width='25%' valign='middle' align='left' class='small_text'>&nbsp;" + sqlReader2.Item("ac_engine_" + xLoop.ToString + "_ser_no")
                            engine_col_counter = engine_col_counter + 1
                        Else
                            other_engine_info += "</td><td  width='25%' valign='middle' align='left' class='small_text'>&nbsp;" + sqlReader2.Item("ac_engine_" + xLoop.ToString + "_ser_no").ToString + "</td></tr>"
                            engine_col_counter = 1
                        End If
                    Else
                        If engine_col_counter = 2 Then
                            other_engine_info += "</td></tr>"
                        End If
                    End If

                End If

            Next ' xLoop
            '----------------------------------------- ENGINE INFORMATION--------------------------------------------------------------------

            htmlOut2.Append("</table>")


            If bWordReport Then
                htmlOut2.Append("</td><td width='" & word_width_new_half & "' valign='top'><table cellpadding='2' cellspacing='0' width='" & word_width_new_half & "'><tr><td valign='top' width='15%'><table cellpadding='2' cellspacing='0' width='" & word_width_new_half & ">")
            Else
                htmlOut2.Append("</td><td width='" & word_width_new_half & "' valign='top'><table cellpadding='2' cellspacing='0' width='100%'><tr><td valign='top' width='15%'><table cellpadding='2' cellspacing='0' width='100%'>")
            End If


            htmlOut2.Append("<tr><td class='small_bold_text' valign='top'>AIRFRM TT</td><td class='small_bold_text'>: </td></tr><tr><td class='small_bold_text'>ENG MODEL</td><td class='small_bold_text'>: </td></tr><tr><td class='small_bold_text' nowrap>ENG SER#</td><td class='small_bold_text'>: </td></tr></table>")

            If Not IsDBNull(sqlReader2.Item("ac_airframe_tot_hrs")) Then
                ac_airframe_tot_hrs = ac_airframe_tot_hrs + "<tr><td width='25%' valign='top' align='left' class='small_text'>&nbsp;" + sqlReader2.Item("ac_airframe_tot_hrs").ToString + "</td>"
            Else
                ac_airframe_tot_hrs = ac_airframe_tot_hrs + "<tr><td width='25%' valign='top' align='left' class='small_text'></td>"
            End If

            If Not IsDBNull(sqlReader2.Item("ac_airframe_tot_landings")) Then
                ac_airframe_tot_hrs = ac_airframe_tot_hrs + "<td valign='middle' align='left' width='35%'><font  class='small_bold_text'>Landings: </font><font class='small_text'>&nbsp;" + sqlReader2.Item("ac_airframe_tot_landings").ToString + "</td></tr>"
            Else
                ac_airframe_tot_hrs = ac_airframe_tot_hrs + "<td valign='middle' align='left' class='small_text' width='35%'></td></tr>"
            End If

            If Not IsDBNull(sqlReader2.Item("ac_engine_name")) Then
                ac_airframe_tot_hrs = ac_airframe_tot_hrs + "<tr><td valign='middle' align='left' class='small_text' colspan='2'>&nbsp;" + sqlReader2.Item("ac_engine_name").ToString + "</td></tr>"
            Else
                ac_airframe_tot_hrs = ac_airframe_tot_hrs + "<tr><td valign='middle' align='left' class='small_text'></td></tr>"
            End If

            htmlOut2.Append("</td><td width='50%' valign='top'><table cellpadding='2' cellspacing='0' width='100%'>" + ac_airframe_tot_hrs + other_engine_info + "</table>")

            htmlOut2.Append("</td></tr></table>")
            htmlOut2.Append("</td></tr></table>")

            '------------------------------------------------------ APU INFORMATION------------------------------------------------
            If Not IsDBNull(sqlReader2.Item("ac_apu_model_name")) Then
                ac_apu_model_name = sqlReader2.Item("ac_apu_model_name").ToString
            Else
                ac_apu_model_name = ""
            End If

            If Not IsDBNull(sqlReader2.Item("ac_apu_tot_hrs")) Then
                ac_apu_tot_hrs = sqlReader2.Item("ac_apu_tot_hrs").ToString
            Else
                ac_apu_tot_hrs = 0
            End If

            If Not IsDBNull(sqlReader2.Item("ac_apu_ser_no")) Then
                ac_apu_ser_no = sqlReader2.Item("ac_apu_ser_no").ToString
            Else
                ac_apu_ser_no = ""
            End If

            If Not IsDBNull(sqlReader2.Item("ac_apu_maintance_program")) Then
                ac_apu_maintance_program = sqlReader2.Item("ac_apu_maintance_program").ToString
            Else
                ac_apu_maintance_program = ""
            End If




            If bWordReport Then
                htmlOut2.Append("<table cellpadding='2' cellspacing='0' width='" & word_width_new & "'><tr><td width='50%'>")
                htmlOut2.Append("<table cellpadding='2' cellspacing='0' width='" & word_width_new_half & "'>")
                htmlOut2.Append("<tr><td colspan='5' class='small_bold_text'>Auxiliary Power Unit (APU)</td></tr>")
                If Not String.IsNullOrEmpty(ac_apu_model_name.ToString) Then
                    htmlOut2.Append("<tr><td width='50%'><font class='small_bold_text'>Model: </font><font class='small_text'>" + ac_apu_model_name)
                End If

            Else
                htmlOut2.Append("<table cellpadding='2' cellspacing='0' width='100%'><tr><td width='50%'>")
                htmlOut2.Append("<table cellpadding='2' cellspacing='0' width='100%'>")
                htmlOut2.Append("<tr><td colspan='5' class='small_bold_text'>Auxiliary Power Unit (APU)</td></tr>")

                If Not String.IsNullOrEmpty(ac_apu_model_name.ToString) Then
                    htmlOut2.Append("<tr><td width='50%'><font class='small_bold_text'>Model: </font><font class='small_text'>" + ac_apu_model_name)
                End If


            End If

            If ac_apu_model_name.ToString = "" Then
                htmlOut2.Append("<tr><td nowrap='nowrap' width='50%'>")
            Else
                htmlOut2.Append("</td><td width='50%'>")
            End If

            If Not String.IsNullOrEmpty(ac_apu_ser_no) Then
                htmlOut2.Append("<font class='small_bold_text'>Serial #:&nbsp;")
                htmlOut2.Append("</font><font class='small_text'>" + sqlReader2.Item("ac_apu_ser_no").ToString + "</td></tr>")
            Else
                htmlOut2.Append("<font class='small_bold_text'>Serial #:&nbsp;</td></tr>")
            End If

            htmlOut2.Append("<tr><td nowrap><font class='small_bold_text'>Total Time (Hours) Since New: ")
            If Not String.IsNullOrEmpty(ac_apu_model_name.Trim) Then
                If ac_apu_tot_hrs > 0 Then
                    htmlOut2.Append("</font><font  class='small_text'>" + FormatNumber(CDbl(ac_apu_tot_hrs), 0, True, False, True) + "</td></tr>")
                Else
                    htmlOut2.Append("</font><font class='small_text'>&nbsp;</td></tr>")
                End If
            End If


            If Not String.IsNullOrEmpty(ac_apu_maintance_program.Trim) Then
                htmlOut2.Append("<tr><td colspan='2'><font class='small_bold_text'>APU Maintenance Plan:&nbsp;:&nbsp;")
                If ac_apu_tot_hrs > 0 Then
                    htmlOut2.Append("</font><font  class='small_text'>" & ac_apu_maintance_program & "</td></tr>")
                Else
                    htmlOut2.Append("</font><font class='small_text'>&nbsp;</td></tr>")
                End If
            End If

            htmlOut2.Append("<tr><td nowrap><font class='small_bold_text'>Since Overhaul (SOH) Hours:&nbsp;")
            If Not IsDBNull(sqlReader2.Item("ac_apu_soh_hrs")) Then
                htmlOut2.Append("</font><font class='small_text'>" + FormatNumber(CDbl(sqlReader2.Item("ac_apu_soh_hrs")), 0, True, False, True) + "&nbsp;</td></tr>")
            Else
                htmlOut2.Append("</font><font class='small_text'>&nbsp;</td></tr>")
            End If

            htmlOut2.Append("<tr><td nowrap='nowrap'><font class='small_bold_text'>Since Hot Inspection (SHI) Hours:&nbsp;")

            If Not IsDBNull(sqlReader2.Item("ac_apu_shi_hrs")) Then
                htmlOut2.Append("</font><font class='small_text'>" + FormatNumber(CDbl(sqlReader2.Item("ac_apu_shi_hrs")), 0, True, False, True) + "&nbsp;</td>")
                htmlOut2.Append("</tr>")
            Else
                htmlOut2.Append("</font><font class='small_text'>&nbsp;</td></tr>")
            End If

            htmlOut2.Append("<tr><td width='50%'><font class='small_bold_text'>Engine OH:&nbsp;")
            If Not IsDBNull(sqlReader2.Item("ac_maint_eoh_by_name")) Then
                htmlOut2.Append("</font><font class='small_text'>" + sqlReader2.Item("ac_maint_eoh_by_name").ToString + "&nbsp;")
            End If

            htmlOut2.Append("</td><td width='50%'><font class='small_bold_text'>Engine OH Date:&nbsp;")
            If Not IsDBNull(sqlReader2.Item("ac_main_eoh_moyear")) Then
                htmlOut2.Append("</font><font class='small_text'>" + sqlReader2.Item("ac_main_eoh_moyear").ToString + "&nbsp;</td></tr>")
            Else
                htmlOut2.Append("&nbsp;</td></tr>")
            End If

            htmlOut2.Append("</table>")

            htmlOut2.Append("</td><td width='50%' valign='top'>")
            htmlOut2.Append(build_condensed_aircraft_features(nAircraftID, sqlReader, SqlCommand, nAircraftJournalID))
            htmlOut2.Append("</td></tr></table>")


            If bWordReport Then
                htmlOut2.Append("<br /><table width='" & word_width_new & "' height='1'><tr><td width='100%' height='1px' bgcolor='black'></td></tr></table>")
            Else
                htmlOut2.Append("<br /><table width='100%' height='1'><tr><td width='100%' height='1px' bgcolor='black'></td></tr></table>")
            End If
            item_found = False


            temp_string = ""
            temp3 = ""
            temp3 = build_condensed_aircraft_details(nAircraftID, "Maintenance", sqlReader, SqlCommand, nAircraftJournalID)

            If Not String.IsNullOrEmpty(temp3) Then
                temp_string += temp3
                item_found = True
            End If

            If Not IsDBNull(sqlReader2.Item("ac_damage_history_notes")) Then
                temp_string += "<tr><td><font class='small_bold_text'>Damage History: &nbsp;"
                temp_string += " </font><font class='small_text'>" + sqlReader2.Item("ac_damage_history_notes").ToString + "&nbsp;</td></tr>"
            End If

            temp3 = ""
            temp3 = build_condensed_aircraft_cert_info(nAircraftID, sqlReader, SqlCommand, nAircraftJournalID)

            If Not String.IsNullOrEmpty(temp3) Then
                temp_string += temp3
                item_found = True
            End If

            temp3 = ""
            temp3 = build_condensed_aircraft_details(nAircraftID, "Interior", sqlReader, SqlCommand, nAircraftJournalID)

            If Not String.IsNullOrEmpty(temp3) Then
                temp_string += temp3
                item_found = True
            End If

            temp_string += "<tr><td valign='top'>"

            If Not IsDBNull(sqlReader2.Item("ac_interior_rating")) Then
                temp_string += "<font class='small_bold_text'> Rating: </font><font class='small_text'>" + sqlReader2.Item("ac_interior_rating").ToString + "</font>"
                item_found = True
            End If

            If Not IsDBNull(sqlReader2.Item("ac_interior_moyear")) Then

                If Not String.IsNullOrEmpty(sqlReader2.Item("ac_interior_moyear").ToString) Then
                    temp_moyear = sqlReader2.Item("ac_interior_moyear")
                    If temp_moyear.ToString.Length = 5 Then
                        temp_moyear = Left(temp_moyear, 1) + "/" + Right(temp_moyear, 4)
                    Else
                        If temp_moyear.ToString.Length = 6 Then
                            temp_moyear = Left(temp_moyear, 2) + "/" + Right(temp_moyear, 4)
                        End If
                    End If
                    temp_string += "<font class='small_bold_text'> Updated: </font><font class='small_text'> " + temp_moyear + "</font>"
                    item_found = True
                Else
                    temp_string += "<font class='small_bold_text'> Updated: </font><font class='small_text'> " + sqlReader2.Item("ac_interior_moyear").ToString + "</font>"
                    item_found = True
                End If
            End If

            If Not IsDBNull(sqlReader2.Item("ac_interior_doneby_name")) Then
                temp_string += "<font class='small_bold_text'> Done By: </font><font class='small_text'>" + sqlReader2.Item("ac_interior_doneby_name").ToString + "</font>"
                item_found = True
            End If

            If Not IsDBNull(sqlReader2.Item("ac_passenger_count")) Then
                temp_string += "<font class='small_bold_text'> Number of Passengers: </font><font class='small_text'>" + sqlReader2.Item("ac_passenger_count").ToString + "</font>"
                item_found = True
            End If

            temp_string += "</tr>"

            temp3 = ""
            temp3 = build_condensed_aircraft_details(nAircraftID, "Exterior", sqlReader, SqlCommand, nAircraftJournalID)

            If Not String.IsNullOrEmpty(temp3) Then
                temp_string += temp3
                item_found = True
            End If

            temp_string += "<tr><td>"

            If Not IsDBNull(sqlReader2.Item("ac_exterior_rating")) Then
                temp_string += " <font class='small_bold_text'>Ext Rating: </font><font class='small_text'>" + sqlReader2.Item("ac_exterior_rating").ToString + " </font>"
                item_found = True
            End If

            If Not String.IsNullOrEmpty(sqlReader2.Item("ac_exterior_moyear").ToString) Then
                If sqlReader2.Item("ac_exterior_moyear").ToString.Trim.Length > 4 Then
                    temp_ex_moyear = sqlReader2.Item("ac_exterior_moyear")
                    If temp_ex_moyear.ToString.Trim.Length = 5 Then
                        temp_ex_moyear = Left(temp_ex_moyear, 1) + "/" + Right(temp_ex_moyear, 4)
                    Else
                        If temp_ex_moyear.ToString.Trim.Length = 6 Then
                            temp_ex_moyear = Left(temp_ex_moyear, 2) + "/" + Right(temp_ex_moyear, 4)
                        End If
                    End If
                    temp_string += " <font class='small_bold_text'>Ext Updated: </font><font class='small_text'>" + temp_ex_moyear + " </font>"
                    item_found = True
                Else
                    temp_string += " <font class='small_bold_text'>Ext Updated: </font><font class='small_text'>" + sqlReader2.Item("ac_exterior_moyear").ToString + " </font>"
                    item_found = True
                End If
            End If

            If Not IsDBNull(sqlReader2.Item("ac_exterior_doneby_name")) Then
                temp_string += " <font class='small_bold_text'>Ext Done By: </font><font class='small_text'>" + sqlReader2.Item("ac_exterior_doneby_name").ToString + " </font>"
                item_found = True
            End If

            temp_string += "</td></tr>"

            temp3 = ""
            temp3 = build_condensed_aircraft_details(nAircraftID, "Equipment", sqlReader, SqlCommand, nAircraftJournalID)

            If Not String.IsNullOrEmpty(temp3) Then
                temp_string += temp3
                item_found = True
            End If

            If item_found = True Then
                temp_string += "<table width='100%' height='1'><tr><td width='100%' height='1px' bgcolor='black'></td></tr></table>"

                If bWordReport Then
                    temp_string += ("<br /><table width='" & word_width_new & "' height='1'><tr><td width='100%' height='1px' bgcolor='black'></td></tr></table>")
                Else
                    temp_string += ("<br /><table width='100%' height='1'><tr><td width='100%' height='1px' bgcolor='black'></td></tr></table>")
                End If
            End If

            temp_string2 = ""
            temp_string2 = build_condensed_aircraft_avionics(nAircraftID, sqlReader, SqlCommand)
            temp_string2 += build_condensed_aircraft_details(nAircraftID, "Addl Cockpit Equipment", sqlReader, SqlCommand, nAircraftJournalID)

            If Not String.IsNullOrEmpty(temp_string2) Then
                If bWordReport Then
                    temp_string2 += ("<br /><table width='" & word_width_new & "' height='1'><tr><td width='100%' height='1px' bgcolor='black'></td></tr></table>")
                Else
                    temp_string2 += ("<br /><table width='100%' height='1'><tr><td width='100%' height='1px' bgcolor='black'></td></tr></table>")
                End If
                temp_string += temp_string2
            End If

            temp_string2 = ""
            If Not IsDBNull(sqlReader2.Item("ac_lease_flag")) Then
                If sqlReader2.Item("ac_lease_flag").ToString.ToUpper.Contains("Y") Then
                    temp_string2 += build_condensed_aircraft_lease_info(nAircraftID, sqlReader, SqlCommand, nAircraftJournalID)
                    If Not String.IsNullOrEmpty(temp_string2) Then
                        If bWordReport Then
                            temp_string2 += ("<br /><table width='" & word_width_new & "' height='1'><tr><td width='100%' height='1px' bgcolor='black'></td></tr></table>")
                        Else
                            temp_string2 += ("<br /><table width='100%' height='1'><tr><td width='100%' height='1px' bgcolor='black'></td></tr></table>")
                        End If
                    End If
                End If
            End If

            temp_string += temp_string2

            If total_contact_rows > 2 Then
                If Not String.IsNullOrEmpty(temp_string) Then
                    If bWordReport Then
                        htmlOut2.Append("<table width='" & word_width_new & "' height='1'><tr><td width='100%' height='1px' bgcolor='black'></td></tr></table>")
                    Else
                        htmlOut2.Append("<table width='100%' height='1'><tr><td width='100%' height='1px' bgcolor='black'></td></tr></table>")
                    End If
                    htmlOut2.Append(comp_functions.NEW_Insert_Page_Break_PDF(Counter_For_PDF, reportType.SelectedValue))
                    htmlOut2.Append(htmlOut.ToString)  ' this is the header section block with the ac details in it 
                    htmlOut2.Append(temp_string) ' temp string is all of the interior/exterior/maint details
                End If
            ElseIf total_contact_rows = 0 Then
                If Not String.IsNullOrEmpty(temp_string) Then
                    ' htmlOut2.Append("<table width='100%' align='center' class='break'><tr><td>&nbsp;</td></tr></table>")
                    htmlOut2.Append(temp_string)
                End If
            Else
                If Not String.IsNullOrEmpty(temp_string) Then
                    If bWordReport Then
                        htmlOut2.Append("<table width='" & word_width_new & "' height='1'><tr><td width='100%' height='1px' bgcolor='black'></td></tr></table>")
                    Else
                        htmlOut2.Append("<table width='100%' height='1'><tr><td width='100%' height='1px' bgcolor='black'></td></tr></table>")
                    End If
                    htmlOut2.Append(comp_functions.NEW_Insert_Page_Break_PDF(Counter_For_PDF, reportType.SelectedValue))
                    htmlOut2.Append(htmlOut.ToString)  ' this is the header section block with the ac details in it 
                    htmlOut2.Append(temp_string)
                End If
            End If

            temp_string = build_condensed_aircraft_contacts(nAircraftID, "Other", sqlReader, SqlCommand, total_contact_rows, nAircraftJournalID)

            If total_contact_rows > 2 Then
                If Not String.IsNullOrEmpty(temp_string) Then
                    If bWordReport Then
                        htmlOut2.Append("<table width='" & word_width_new & "' height='1'><tr><td width='100%' height='1px' bgcolor='black'></td></tr></table>")
                    Else
                        htmlOut2.Append("<table width='100%' height='1'><tr><td width='100%' height='1px' bgcolor='black'></td></tr></table>")
                    End If
                    htmlOut2.Append(comp_functions.NEW_Insert_Page_Break_PDF(Counter_For_PDF, reportType.SelectedValue))
                    htmlOut2.Append(htmlOut.ToString)
                    htmlOut2.Append(temp_string)
                End If
            Else
                If Not String.IsNullOrEmpty(temp_string) Then
                    If bWordReport Then
                        htmlOut2.Append("<table width='" & word_width_new & "' height='1'><tr><td width='100%' height='1px' bgcolor='black'></td></tr></table>")
                    Else
                        htmlOut2.Append("<table width='100%' height='1'><tr><td width='100%' height='1px' bgcolor='black'></td></tr></table>")
                    End If
                    htmlOut2.Append(temp_string)
                End If
            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_condensed_spec_sheet_html(ByRef SqlCommand As SqlClient.SqlCommand, ByRef SqlCommand2 As SqlClient.SqlCommand, ByVal nAircraftID As Long) As String" + ex.Message
        Finally

            If Not sqlReader.IsClosed Then
                sqlReader.Close()
            End If

            If Not sqlReader2.IsClosed Then
                sqlReader2.Close()
            End If


            sqlReader2 = Nothing

            sqlReader = Nothing
            sqlReader2 = Nothing

            SqlCommand2.Dispose()
            SqlConn2.Close()
            SqlConn2.Dispose()
            SqlConn2 = Nothing

            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

        End Try


        'Return realout

        Return htmlOut2.ToString

        htmlOut2 = Nothing

    End Function

    Public Function build_condensed_aircraft_features(ByVal nAircraftID As Long, ByRef adoRSAircraft As SqlClient.SqlDataReader, ByRef SqlCommand As SqlClient.SqlCommand, ByVal nAircraftJournalID As Long) As String
        Dim type_damage As String = ""
        Dim feat_count As Integer = 1

        Dim htmlOut As New StringBuilder()
        Dim Query As String = ""

        Try

            Query = "SELECT Aircraft_Key_Feature.afeat_status_flag, Key_Feature.kfeat_code FROM Aircraft_Key_Feature INNER JOIN Key_Feature ON Aircraft_Key_Feature.afeat_feature_code = Key_Feature.kfeat_code "
            Query = Query & "WHERE (Aircraft_Key_Feature.afeat_ac_id = " + nAircraftID.ToString + ") AND (Aircraft_Key_Feature.afeat_journ_id = " & nAircraftJournalID & ") "
            'Query = Query & " and kfeat_name <> 'Damage History' "
            Query = Query & "ORDER BY Aircraft_Key_Feature.afeat_seq_no"

            SqlCommand.CommandText = Query
            adoRSAircraft = SqlCommand.ExecuteReader()

            If adoRSAircraft.HasRows Then

                If bWordReport Then
                    htmlOut.Append("<table cellpadding='2' cellspacing='0' width='" & word_width_new_half & "'>")
                Else
                    htmlOut.Append("<table cellpadding='2' cellspacing='0' width='95%'>")
                End If

                htmlOut.Append("<tr><td valign='top' colspan='20' class='small_bold_text'>Key Features</td></tr>")

                Do While adoRSAircraft.Read

                    If feat_count = 1 Then
                        htmlOut.Append("<tr valign='top'>")
                    End If

                    htmlOut.Append("<td width='10%' valign='top' class='small_bold_text'>")

                    If Not IsDBNull(adoRSAircraft("afeat_status_flag")) Then
                        htmlOut.Append(adoRSAircraft("kfeat_code") + "</td><td class='small_bold_text' width='5%'>: </td><td class='small_text' width='10%'>")
                        htmlOut.Append(adoRSAircraft("afeat_status_flag") + "</td>")
                    Else
                        type_damage = ""
                    End If

                    feat_count += 1

                    If feat_count = 5 Then
                        htmlOut.Append("</tr>")
                        feat_count = 1
                    End If

                Loop

            End If

            htmlOut.Append("</table>")

            adoRSAircraft.Close()

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Short_Aircraft_Features(ByVal nAircraftID As Long, ByRef adoRSAircraft As SqlClient.SqlDataReader, ByRef SqlCommand As SqlClient.SqlCommand) As String" + ex.Message
        End Try

        Return htmlOut.ToString

        htmlOut = Nothing

    End Function

    Public Function build_condensed_aircraft_contacts(ByVal nAircraftID As Long, ByVal type As String, ByRef adoRSAircraft As SqlClient.SqlDataReader, ByRef SqlCommand As SqlClient.SqlCommand, ByRef contact_count As Integer, ByVal nAircraftJournalID As Long) As String

        Dim contact_counter As Integer = 1
        Dim column_color As String = "white"
        Dim email_web_count As Integer = 1

        Dim htmlOut As New StringBuilder()
        Dim Query As String = ""

        Try

            Query = "select comp_id, actype_name, cref_owner_percent, comp_name, comp_name_alt, comp_address1, comp_address2, comp_city, comp_state, comp_zip_code, comp_country,"
            Query = Query + " comp_email_address, comp_web_address, contact_id, contact_sirname, contact_first_name, contact_middle_initial, contact_last_name, contact_suffix, contact_title,"
            Query = Query + " contact_email_address from aircraft_reference inner join company on cref_comp_id = comp_id and cref_journ_id = comp_journ_id inner join aircraft_contact_type on cref_contact_type = actype_code"
            Query = Query + " left outer join contact on cref_contact_id = contact_id and cref_journ_id = contact_journ_id and contact_hide_flag='N'"
            If type = "Normal" Then
                Query = Query + " where(cref_ac_id = '" + nAircraftID.ToString + "') and cref_journ_id = " & nAircraftJournalID & " and cref_contact_type NOT IN('71', '99', '93') and cref_transmit_seq_no <> 99 order by cref_transmit_seq_no"
            ElseIf type = "Broker" Then
                Query = Query + " where(cref_ac_id = '" + nAircraftID.ToString + "') and cref_journ_id = " & nAircraftJournalID & " and cref_contact_type IN('99','93') order by cref_transmit_seq_no"
            ElseIf type = "Other" Then
                Query = Query + " where(cref_ac_id = '" + nAircraftID.ToString + "') and cref_journ_id = " & nAircraftJournalID & " and cref_contact_type NOT IN('71', '99', '93') and cref_transmit_seq_no = 99 order by cref_transmit_seq_no"
            End If

            SqlCommand.CommandText = Query
            adoRSAircraft = SqlCommand.ExecuteReader()

            If adoRSAircraft.HasRows Then

                If bWordReport Then
                    htmlOut.Append("<table width='" & word_width_new & "' cellpadding='2' cellspacing='0'>")
                Else
                    htmlOut.Append("<table width='100%' cellpadding='2' cellspacing='0'>")
                End If

                If type = "Normal" Then
                    htmlOut.Append("<tr><td class='small_bold_text' colspan='2'>Primary Contacts</td></tr>")
                ElseIf type = "Broker" Then
                    htmlOut.Append("")
                ElseIf type = "Other" Then
                    htmlOut.Append("<tr><td class='small_bold_text' colspan='2'>Additional Contacts</td></tr>")
                End If

                Do While adoRSAircraft.Read

                    If contact_counter = 1 Then
                        htmlOut.Append("<tr>")
                    End If

                    htmlOut.Append("<td valign='top' width='50%'><table valign='top' width='100%'><tr><td valign='top' align='left' class='small_bold_text' width='50%'>")

                    If Not IsDBNull(adoRSAircraft.Item("actype_name")) Then
                        htmlOut.Append(adoRSAircraft.Item("actype_name").ToString)
                    End If

                    If Not IsDBNull(adoRSAircraft.Item("cref_owner_percent")) Then
                        If CLng(adoRSAircraft.Item("cref_owner_percent").ToString) > 0 And CLng(adoRSAircraft.Item("cref_owner_percent").ToString) < 100 Then
                            htmlOut.Append(" [" + adoRSAircraft.Item("cref_owner_percent").ToString + "%] </td></tr><tr><td class='small_text'>")
                        Else
                            htmlOut.Append("</td></tr><tr><td class='small_text'>")
                        End If
                    Else
                        htmlOut.Append("</td></tr><tr><td class='small_text'>")
                    End If

                    If Not IsDBNull(adoRSAircraft.Item("comp_name")) Then
                        htmlOut.Append(adoRSAircraft.Item("comp_name").ToString + "</td></tr><tr><td class='small_text'>")
                    End If

                    If Not IsDBNull(adoRSAircraft.Item("comp_name_alt")) Then
                        htmlOut.Append(adoRSAircraft.Item("comp_name_alt").ToString + "</td></tr><tr><td class='small_text'>")
                    End If

                    '------------------------ PRIM CONTACT----------------
                    If Not IsDBNull(adoRSAircraft.Item("contact_sirname")) Then
                        htmlOut.Append(adoRSAircraft.Item("contact_sirname").ToString + " ")
                    End If

                    If Not IsDBNull(adoRSAircraft.Item("contact_first_name")) Then
                        htmlOut.Append(adoRSAircraft.Item("contact_first_name").ToString + " ")
                    End If

                    If Not IsDBNull(adoRSAircraft.Item("contact_middle_initial")) Then
                        htmlOut.Append(adoRSAircraft.Item("contact_middle_initial").ToString + " ")
                    End If

                    If Not IsDBNull(adoRSAircraft.Item("contact_last_name")) Then
                        htmlOut.Append(adoRSAircraft.Item("contact_last_name").ToString + " ")
                    End If

                    If Not IsDBNull(adoRSAircraft.Item("contact_suffix")) Then
                        If Not String.IsNullOrEmpty(adoRSAircraft.Item("contact_suffix").ToString) Then
                            htmlOut.Append(adoRSAircraft.Item("contact_suffix").ToString + "</td></tr><tr><td class='small_text'>")
                        End If
                    End If

                    If Not IsDBNull(adoRSAircraft.Item("contact_title")) Then
                        If Not String.IsNullOrEmpty(adoRSAircraft.Item("contact_title")) Then
                            htmlOut.Append(adoRSAircraft.Item("contact_title").ToString + "</td></tr><tr><td class='small_text'>")
                        End If
                    End If

                    '------------------------ PRIM CONTACT----------------

                    If Not IsDBNull(adoRSAircraft.Item("comp_address1")) Then
                        htmlOut.Append(adoRSAircraft.Item("comp_address1").ToString + "</td></tr><tr><td class='small_text'>")
                    End If

                    If Not IsDBNull(adoRSAircraft.Item("comp_city")) Then
                        htmlOut.Append(adoRSAircraft.Item("comp_city").ToString)
                    End If

                    If Not IsDBNull(adoRSAircraft.Item("comp_state")) Then
                        htmlOut.Append(", " + adoRSAircraft.Item("comp_state").ToString + " ")
                    End If

                    If Not IsDBNull(adoRSAircraft.Item("comp_zip_code")) Then
                        htmlOut.Append(adoRSAircraft.Item("comp_zip_code").ToString + " ")
                    End If

                    If Not IsDBNull(adoRSAircraft.Item("comp_country")) Then
                        htmlOut.Append(adoRSAircraft.Item("comp_country").ToString + "</td></tr>")
                    Else
                        htmlOut.Append("</td></tr>")
                    End If

                    If bWordReport Then
                        '-------------------------------------------------------------------------------------------------------------------------------------------------
                        If Not IsDBNull(adoRSAircraft.Item("comp_web_address")) Then
                            If Not String.IsNullOrEmpty(adoRSAircraft.Item("comp_web_address").ToString) Then
                                htmlOut.Append("<tr><td class='small_text' width='50%'><u>" + adoRSAircraft.Item("comp_web_address").ToString + "</u></td></tr>")
                            End If
                        End If
                        If Not IsDBNull(adoRSAircraft.Item("contact_email_address")) Then
                            If Not String.IsNullOrEmpty(adoRSAircraft.Item("contact_email_address").ToString.ToString) Then
                                htmlOut.Append("<tr><td class='small_text' width='50%'><u>" + adoRSAircraft.Item("contact_email_address").ToString + "</u></td></tr>")
                            End If
                        End If
                        '-------------------------------------------------------------------------------------------------------------------------------------------------
                    Else
                        '-------------------------------------------------------------------------------------------------------------------------------------------------
                        If Not IsDBNull(adoRSAircraft.Item("comp_web_address")) Then
                            If Not String.IsNullOrEmpty(adoRSAircraft.Item("comp_web_address").ToString) Then
                                htmlOut.Append("<tr><td class='small_text' width='50%'><u>" + adoRSAircraft.Item("comp_web_address").ToString + "</u></td>")
                                email_web_count = 2
                            End If
                        End If


                        If Not IsDBNull(adoRSAircraft.Item("contact_email_address")) Then
                            If Not String.IsNullOrEmpty(adoRSAircraft.Item("contact_email_address").ToString.ToString) Then
                                If email_web_count = 1 Then
                                    htmlOut.Append("<tr>")
                                End If
                                htmlOut.Append("<td class='small_text' width='50%'><u>" + adoRSAircraft.Item("contact_email_address").ToString + "</u></td>")
                                email_web_count = 2
                            Else
                                If Not IsDBNull(adoRSAircraft.Item("comp_email_address")) Then
                                    If Not String.IsNullOrEmpty(adoRSAircraft.Item("comp_email_address").ToString) Then
                                        If email_web_count = 1 Then
                                            htmlOut.Append("<tr>")
                                        End If
                                        htmlOut.Append("<td class='small_text' width='50%'><u>" + adoRSAircraft.Item("comp_email_address").ToString + "</u></td>")
                                        email_web_count = 2
                                    End If
                                End If
                            End If
                        Else
                            If Not IsDBNull(adoRSAircraft.Item("comp_email_address")) Then
                                If Not String.IsNullOrEmpty(adoRSAircraft.Item("comp_email_address").ToString) Then
                                    If email_web_count = 1 Then
                                        htmlOut.Append("<tr>")
                                    End If
                                    htmlOut.Append("<td class='small_text' width='50%'><u>" + adoRSAircraft.Item("comp_email_address").ToString + "</u></td>")
                                    email_web_count = 2
                                End If
                            End If
                        End If

                        If email_web_count = 2 Then
                            htmlOut.Append("</tr>")
                        End If

                    End If

                    If Not IsDBNull(adoRSAircraft.Item("comp_id")) And Not IsDBNull(adoRSAircraft.Item("contact_id")) Then

                        Dim temp_phone = build_condensed_phone_company_contact_info(CLng(adoRSAircraft.Item("comp_id").ToString), CLng(adoRSAircraft.Item("contact_id")), nAircraftJournalID)

                        If String.IsNullOrEmpty(temp_phone.Trim) Then
                            htmlOut.Append(build_condensed_phone_company_contact_info(CLng(adoRSAircraft.Item("comp_id").ToString), 0, nAircraftJournalID))
                        Else
                            htmlOut.Append(temp_phone)
                        End If

                    Else

                        If Not IsDBNull(adoRSAircraft.Item("comp_id")) Then
                            htmlOut.Append(build_condensed_phone_company_contact_info(CLng(adoRSAircraft.Item("comp_id").ToString), 0, nAircraftJournalID))
                        End If

                    End If

                    htmlOut.Append("<tr><td height='2'></td></tr>")
                    htmlOut.Append("</table></td>")

                    If contact_counter = 2 Then
                        htmlOut.Append("</tr>")
                        contact_counter = 1
                        contact_count = contact_count + 1 ' row count
                    Else
                        contact_counter = contact_counter + 1
                    End If

                    email_web_count = 1

                Loop

                If contact_counter = 1 Then
                    htmlOut.Append("</table>")
                Else
                    htmlOut.Append("<td width='100%'>&nbsp;</td></tr></table>")
                    contact_count = contact_count + 1
                End If


            End If

            adoRSAircraft.Close()

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Short_Aircraft_Contacts(ByVal nAircraftID As Long, ByVal type As String, ByRef adoRSAircraft As SqlClient.SqlDataReader, ByRef SqlCommand As SqlClient.SqlCommand, ByRef contact_count As Integer) As String" + ex.Message
        End Try

        Return htmlOut.ToString

        htmlOut = Nothing

    End Function

    Public Function build_condensed_aircraft_airport_information(ByVal nAircraftID As Long, ByRef adoRSAircraft As SqlClient.SqlDataReader, ByRef SqlCommand As SqlClient.SqlCommand) As String

        Dim htmlOut As New StringBuilder()
        Dim Query As String = ""

        Try

            Query = "SELECT ac_aport_iata_code, ac_aport_icao_code, ac_aport_name, ac_aport_city, ac_aport_state, ac_aport_country FROM Aircraft WITH(NOLOCK) INNER JOIN Aircraft_Model WITH(NOLOCK) ON ac_amod_id = amod_id"
            Query = Query & " WHERE ac_journ_id = 0 and ac_id = " & nAircraftID.ToString

            SqlCommand.CommandText = Query
            adoRSAircraft = SqlCommand.ExecuteReader()

            If adoRSAircraft.HasRows Then

                adoRSAircraft.Read()

                htmlOut.Append("<table align='left' width='100%' cellpadding='2' cellspacing='0'><tr><td valign='top' align='left' width='100%' class='small_text'>: ")

                If Not IsDBNull(adoRSAircraft("ac_aport_iata_code")) Then
                    htmlOut.Append(adoRSAircraft("ac_aport_iata_code").ToString.Trim)
                End If

                If Not IsDBNull(adoRSAircraft("ac_aport_icao_code")) Then
                    htmlOut.Append(" - " & adoRSAircraft("ac_aport_icao_code").ToString.Trim)
                End If

                If Not IsDBNull(adoRSAircraft("ac_aport_name")) Then
                    htmlOut.Append(" - " & adoRSAircraft("ac_aport_name").ToString.Trim)
                End If

                If Not IsDBNull(adoRSAircraft("ac_aport_city")) Then
                    htmlOut.Append("<br>&nbsp;&nbsp;" & adoRSAircraft("ac_aport_city").ToString.Trim)
                End If

                If Not IsDBNull(adoRSAircraft("ac_aport_state")) Then
                    htmlOut.Append(" - " & adoRSAircraft("ac_aport_state").ToString.Trim)
                End If

                If Not IsDBNull(adoRSAircraft("ac_aport_country")) Then
                    htmlOut.Append(" - " & adoRSAircraft("ac_aport_country").ToString.Trim)
                End If
                htmlOut.Append("</td></tr></table>")

            End If

            adoRSAircraft.Close()

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Short_Airport_Information(ByVal nAircraftID As Long, ByRef adoRSAircraft As SqlClient.SqlDataReader, ByRef SqlCommand As SqlClient.SqlCommand) As String" + ex.Message
        End Try

        Return htmlOut.ToString

        htmlOut = Nothing

    End Function

    Public Function build_condensed_aircraft_details(ByVal nAircraftID As Long, ByVal detail_type As String, ByRef adoRSAircraft As SqlClient.SqlDataReader, ByRef SqlCommand As SqlClient.SqlCommand, ByVal nAircraftJournalID As Long) As String

        Dim htmlOut As New StringBuilder()
        Dim Query As String = ""
        Dim last_detail_type As String = ""

        Dim first_count As Integer = 1

        Try
            Query = "SELECT * FROM Aircraft_Details WITH(NOLOCK) WHERE adet_ac_id = " + nAircraftID.ToString
            Query = Query + " AND adet_journ_id = " & nAircraftJournalID & " AND lower(adet_data_type) = '" + detail_type.ToLower.Trim + "'"

            SqlCommand.CommandText = Query
            adoRSAircraft = SqlCommand.ExecuteReader()

            If adoRSAircraft.HasRows Then


                If bWordReport Then
                    htmlOut.Append("<table width='" & word_width_new & "'  cellpadding='2' cellspacing='0'>")
                Else
                    htmlOut.Append("<table width='100%'  cellpadding='2' cellspacing='0'>")
                End If

                htmlOut.Append("<tr><td class='small_bold_text' colspan='2'>" + detail_type + " Details</font>&nbsp;</td></tr>")

                Do While adoRSAircraft.Read
                    If Not IsDBNull(adoRSAircraft("adet_data_name")) Then
                        If last_detail_type.ToLower.Trim = adoRSAircraft("adet_data_name").ToString.ToLower.Trim Then
                            htmlOut.Append("<font class='small_text'>; " + adoRSAircraft("adet_data_description").ToString + "</font>")
                        Else
                            If first_count = 2 Then
                                htmlOut.Append("</td></tr>")
                            Else
                                first_count = 2
                            End If
                            htmlOut.Append("<tr><td><font class='small_bold_text'>" + adoRSAircraft("adet_data_name").ToString + "</font><font class='small_text'>: " + adoRSAircraft("adet_data_description").ToString + "</font>")
                        End If
                    Else
                        htmlOut.Append("<tr><td><font class='small_bold_text'>" + adoRSAircraft("adet_data_name").ToString + "</font><font class='small_text'>: " + adoRSAircraft("adet_data_description").ToString + "</font></td></tr>")
                    End If
                    last_detail_type = adoRSAircraft("adet_data_name").ToString

                Loop
                htmlOut.Append("</td></tr></table>")

            End If

            adoRSAircraft.Close()

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Short_Aircraft_Details(ByVal nAircraftID As Long, ByVal detail_type As String, ByRef adoRSAircraft As SqlClient.SqlDataReader, ByRef SqlCommand As SqlClient.SqlCommand) As String" + ex.Message
        End Try

        Return htmlOut.ToString

        htmlOut = Nothing

    End Function

    Public Function build_condensed_aircraft_cert_info(ByVal nAircraftID As Long, ByRef adoRSAircraft As SqlClient.SqlDataReader, ByRef SqlCommand As SqlClient.SqlCommand, ByVal nAircraftJournalID As Long) As String

        Dim htmlOut As New StringBuilder()
        Dim Query As String = ""

        Dim first_count As Integer = 1

        Try

            Query = "select * from aircraft_certified where(accert_ac_journ_id = " & nAircraftJournalID & ") and accert_ac_id= " + nAircraftID.ToString

            SqlCommand.CommandText = Query
            adoRSAircraft = SqlCommand.ExecuteReader()

            If adoRSAircraft.HasRows Then
                If bWordReport Then
                    htmlOut.Append("<tr><td><font class='small_bold_text'>Certifications: </font><font class='small_text'>")
                Else
                    htmlOut.Append("<tr><td></td><td><font class='small_bold_text'>Certifications: </font><font class='small_text'>")
                End If


                Do While adoRSAircraft.Read
                    If first_count = 2 Then
                        htmlOut.Append(",&nbsp;")
                    Else
                        first_count = 2
                    End If
                    htmlOut.Append(adoRSAircraft("accert_name").ToString)
                Loop
                htmlOut.Append("</td></tr>")
            End If

            adoRSAircraft.Close()

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Short_Cert_Info(ByVal nAircraftID As Long, ByRef adoRSAircraft As SqlClient.SqlDataReader, ByRef SqlCommand As SqlClient.SqlCommand) As String" + ex.Message
        End Try

        Return htmlOut.ToString

        htmlOut = Nothing

    End Function

    Public Function build_condensed_aircraft_avionics(ByVal nAircraftID As Long, ByRef adoRSAircraft As SqlClient.SqlDataReader, ByRef SqlCommand As SqlClient.SqlCommand) As String

        Dim htmlOut As New StringBuilder()

        Dim ac_maintained As String = ""
        Dim av_count As Integer = 1

        Dim Query As String : Query = ""

        Try
            ' Start Avionics    
            Query = "SELECT * FROM Aircraft_Avionics WITH(NOLOCK) WHERE av_ac_id = " + nAircraftID.ToString + " AND av_ac_journ_id = 0"

            SqlCommand.CommandText = Query
            adoRSAircraft = SqlCommand.ExecuteReader()

            If adoRSAircraft.HasRows Then

                htmlOut.Append("<table width='100%' cellpadding='2' cellspacing='0'><tr><td class='small_bold_text' colspan='2'>Avionics</td></tr>")

                Do While adoRSAircraft.Read
                    If av_count = 1 Then
                        htmlOut.Append("<tr>")
                    End If
                    htmlOut.Append("<td width='49%'><font class='small_bold_text'>" & adoRSAircraft.Item("av_name").ToString & ": </font><font class='small_text'>" & adoRSAircraft.Item("av_description").ToString & "; </font></td>")
                    av_count = av_count + 1
                    If av_count = 3 Then
                        htmlOut.Append("</tr>")
                        av_count = 1
                    End If
                Loop

                htmlOut.Append("</table>")

            End If

            adoRSAircraft.Close()

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Short_Lease_Info(ByVal nAircraftID As Long, ByRef adoRSAircraft2 As SqlClient.SqlDataReader, ByRef SqlCommand2 As SqlClient.SqlCommand) As String" + ex.Message
        End Try

        Return htmlOut.ToString

        htmlOut = Nothing

    End Function

    Public Function build_condensed_aircraft_lease_info(ByVal nAircraftID As Long, ByRef adoRSAircraft As SqlClient.SqlDataReader, ByRef SqlCommand As SqlClient.SqlCommand, ByVal nAircraftJournalID As Long) As String

        Dim htmlOut As New StringBuilder()
        Dim Query As String = ""

        Try

            Query = "SELECT * FROM Aircraft_Lease WHERE aclease_ac_id = " + nAircraftID.ToString + " and aclease_expired = 'N' and aclease_journ_id = " & nAircraftJournalID & " "

            SqlCommand.CommandText = Query
            adoRSAircraft = SqlCommand.ExecuteReader()

            If adoRSAircraft.HasRows Then

                adoRSAircraft.Read()

                If Not IsDBNull(adoRSAircraft("aclease_expired")) Then
                    '    htmlOut.Append( "LEASE TYPE - LEASE TERM - EXPIRES displayed as mm/dd/yyyy - NOTES")
                End If

                htmlOut.Append("<table width='100%' cellpadding='2' cellspacing='0'><tr><td valign='top' class='small_bold_text' colspan='6'>Lease Information</td></tr>")
                htmlOut.Append("<tr><td class='small_bold_text' width='5%'>Type:</td>")

                If Not IsDBNull(adoRSAircraft("aclease_type")) Then
                    If Not String.IsNullOrEmpty(adoRSAircraft("aclease_type").ToString) Then
                        htmlOut.Append("<td class='small_text' width='20%'>" + adoRSAircraft("aclease_type").ToString.Trim + "</td>")
                    Else
                        htmlOut.Append("<td class='small_text' width='20%'></td>")
                    End If
                Else
                    htmlOut.Append("<td class='small_text' width='20%'></td>")
                End If

                htmlOut.Append("<td class='small_bold_text' width='5%'>Term:</td>")

                If Not IsDBNull(adoRSAircraft("aclease_term")) Then
                    If Not String.IsNullOrEmpty(adoRSAircraft("aclease_term").ToString) Then
                        htmlOut.Append("<td class='small_text' width='20%'>" + adoRSAircraft("aclease_term").ToString.Trim + "</td>")
                    Else
                        htmlOut.Append("<td class='small_text' width='20%'></td>")
                    End If
                Else
                    htmlOut.Append("<td class='small_text' width='20%'></td>")
                End If

                htmlOut.Append("<td class='small_bold_text' width='10%'>Expiration Date:</td>")

                If Not IsDBNull(adoRSAircraft("aclease_expiration_date")) Then
                    If Not String.IsNullOrEmpty(adoRSAircraft("aclease_expiration_date").ToString) Then
                        htmlOut.Append("<td class='small_text' width='15%'>" + adoRSAircraft("aclease_expiration_date") + "</td></tr>")
                    Else
                        htmlOut.Append("<td class='small_text' width='15%'></td></tr>")
                    End If
                Else
                    htmlOut.Append("<td class='small_text' width='15%'></td></tr>")
                End If

                htmlOut.Append("<tr><td class='small_bold_text' width='5%'>Notes: </td>")

                If Not IsDBNull(adoRSAircraft("aclease_note")) Then
                    If Not String.IsNullOrEmpty(adoRSAircraft("aclease_note").ToString) Then
                        htmlOut.Append("<td class='small_text' width='20%' colspan='5'>" + adoRSAircraft("aclease_note").ToString.Trim + "</td></tr>")
                    Else
                        htmlOut.Append("<td class='small_text' width='20%' colspan='5'></td></tr>")
                    End If
                Else

                    htmlOut.Append("<td class='small_text' width='20%' colspan='5'></td></tr>")
                End If

                htmlOut.Append("</table>")

            End If

            adoRSAircraft.Close()

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Short_Lease_Info(ByVal nAircraftID As Long, ByRef adoRSAircraft As SqlClient.SqlDataReader, ByRef SqlCommand As SqlClient.SqlCommand) As String" + ex.Message
        End Try

        Return htmlOut.ToString

        htmlOut = Nothing

    End Function

    Public Function build_condensed_phone_company_contact_info(ByVal comp_id As Long, ByVal contact_id As Long, ByVal nAircraftJournalID As Long) As String

        Dim htmlOut As New StringBuilder()
        Dim sQuery = New StringBuilder()
        Dim num_phones As Integer = 1

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader = Nothing
        Dim SqlException As SqlClient.SqlException = Nothing

        Try

            sQuery.Append("SELECT DISTINCT TOP 2 pnum_type, pnum_number_full FROM Phone_Numbers WHERE pnum_contact_id = " + contact_id.ToString + " AND pnum_comp_id = " + comp_id.ToString + "AND pnum_journ_id = " & nAircraftJournalID & " AND pnum_hide_customer = 'N'")
            sQuery.Append(" ORDER BY pnum_type desc")

            SqlConn.ConnectionString = localFunctions.clientConnectStr
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString
            SqlReader = SqlCommand.ExecuteReader()

            If SqlReader.HasRows Then

                Do While SqlReader.Read
                    If bWordReport Then
                        htmlOut.Append("<tr><td><font class='small_text'>" + SqlReader.Item("pnum_type").ToString + ":</font><font class='small_text'> " + SqlReader.Item("pnum_number_full").ToString + "</td></tr>")
                    Else

                        If num_phones = 1 Then
                            htmlOut.Append("<tr><td><font class='small_text'>" + SqlReader.Item("pnum_type").ToString + ":</font><font class='small_text'> " + SqlReader.Item("pnum_number_full").ToString + "</td>")
                            num_phones += 1
                        Else
                            htmlOut.Append("<td><font class='small_text'>" + SqlReader.Item("pnum_type").ToString + ":</font><font class='small_text'> " + SqlReader.Item("pnum_number_full").ToString + "</td></tr>")
                            num_phones = 1
                        End If
                    End If
                Loop

                If num_phones = 2 Then
                    htmlOut.Append("</tr>")
                End If

            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_condensed_phone_company_contact_info(ByVal comp_id As Long, ByVal contact_id As Long, ByVal nAircraftJournalID As Long) As String" + ex.Message
        Finally

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

            SqlReader.Close()

        End Try

        Return htmlOut.ToString

        htmlOut = Nothing

    End Function

#End Region

#Region "report_41_functions"

    Public Function create_aircraft_full_spec_sheet(ByVal item_string As Array, ByRef record_count As Long) As String

        Dim htmlOut = New StringBuilder()
        Dim first_page As Boolean = False
        Try

            If Trim(Request("journ_id")) <> "" Then
                nAircraftJournalID_Full = CLng(Trim(Request("journ_id")))
            End If


            If Trim(Request("skip")) = "Y" Then
            Else
                htmlOut.Append("<html><head><title>Aircraft Full Spec Sheet</title>" + build_style_page_full_spec() + "</head>")

                htmlOut.Append("<body style='background: white; margin-top:10px; margin-left:10px;'>")
                htmlOut.Append("<div style='text-align:center;'>")
            End If

            For i As Integer = 0 To UBound(item_string)

                record_count = UBound(item_string)

                If check_cover.Checked = True Then
                    htmlOut.Append(build_full_spec_coverpage(CLng(item_string(i))))
                    first_page = True
                End If

                If chkSP_53.Checked Then
                    If first_page = True Then
                        htmlOut.Append(Insert_Page_Break_PDF())
                    End If
                    htmlOut.Append(build_full_spec_second_page(CLng(item_string(i))))
                    first_page = True
                End If

                If Not chkBlindReport.Checked Then
                    If chkTP_53.Checked Then
                        If first_page = True Then
                            htmlOut.Append(Insert_Page_Break_PDF())
                        End If
                        htmlOut.Append(build_full_spec_third_page(CLng(item_string(i))))
                        first_page = True
                    End If
                End If

                If chkIncludeNotes_53.Checked Then
                    If first_page = True Then
                        htmlOut.Append(Insert_Page_Break_PDF())
                    End If
                    htmlOut.Append(build_full_spec_notes_page_aircraft(CLng(item_string(i))))
                    first_page = True
                End If

                If chkIncludeHistory_53.Checked Then
                    If first_page = True Then
                        htmlOut.Append(Insert_Page_Break_PDF())
                    End If
                    htmlOut.Append(build_full_spec_transactions_page_aircraft(CLng(item_string(i))))
                    first_page = True
                End If

                If nAircraftJournalID_Full = 0 Then
                    If chkPP.Checked Or chkPP_Large.Checked Then
                        If first_page = True Then
                            htmlOut.Append(Insert_Page_Break_PDF())
                        End If
                        htmlOut.Append(build_full_spec_pictures_page(CLng(item_string(i))))
                        first_page = True
                    End If
                End If


                If UBound(item_string) > 0 Then
                    htmlOut.Append(Insert_Page_Break_PDF())
                End If

            Next

            If Trim(Request("skip")) = "Y" Then
            Else
                htmlOut.Append("</div></body></html>")
            End If


        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in create_aircraft_full_spec_sheet(ByVal item_string As Array) As String" + ex.Message
        End Try

        Return htmlOut.ToString

        htmlOut = Nothing

    End Function

    Public Function build_full_spec_coverpage(ByVal nAircraftID As Long) As String

        Dim airfram_tot_time As String = ""
        Dim est_tot_time As String = ""
        Dim cycles As String = ""
        Dim asking_price As String = ""
        Dim company_name As String = ""
        Dim temp_moyear As String = ""
        Dim temp_ex_moyear As String = ""
        Dim last_updated As String = ""
        Dim exclusive_flag As String = ""
        Dim list_date As String = ""
        Dim tmp_list_date As String = ""
        Dim asking_type As String = ""
        Dim ex_date As String = ""
        Dim times_date As String = ""
        Dim ac_maintained As String = ""
        Dim ac_status As String = ""
        Dim prev_owned As String = ""
        Dim ex_done_by_and_rating As String = ""
        Dim in_done_by_and_rating As String = ""
        Dim address_info As String = ""


        Dim confidential As String = ""
        Dim days_on_market As String = ""
        Dim font_size_for_address As String = ""

        Dim htmlOutput As New StringBuilder

        Dim logo_link As String = ""

        Dim sQuery = New StringBuilder()

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader = Nothing
        Dim SqlException As SqlClient.SqlException = Nothing

        Dim comp_image_file As String = ""
        Dim temp_height As Integer = 0
        Dim temp_width As Integer = 0
        Dim zimage2 As System.Drawing.Image
        ' Dim zimage3 As System.Drawing.Image
        Dim desired_width As Integer = 500
        Dim desired_height As Integer = 142
        Dim temp_percent1 As Double = 0.0
        Dim temp_percent2 As Double = 0.0
        Dim total_width As Integer = 0
        Dim width_size_total As Integer = 740
        Dim add_pic As String = "Y"
        Dim blow_up As Boolean = False
        Dim temp_calc As Double = 0.0

        Dim font_style As String = " face='sans-serif' "



        Try
            'SECTION 1 - COMPANY INFO ----------------------------------------------------------------------------------------------------------------------------------- 

            sQuery.Append("SELECT TOP 1 * FROM Company INNER JOIN Subscription ON comp_id = sub_comp_id AND comp_journ_id = 0")
            sQuery.Append(" WHERE sub_id = " + Session.Item("localUser").crmSubSubID.ToString)

            SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString
            SqlReader = SqlCommand.ExecuteReader()

            If SqlReader.HasRows Then

                SqlReader.Read()

                If Not IsDBNull(SqlReader.Item("comp_address1")) And Not IsDBNull(SqlReader.Item("comp_address2")) Then
                    If (SqlReader.Item("comp_address1").ToString.Length + SqlReader.Item("comp_address2").ToString.Length) > 50 Then
                        font_size_for_address = "-2"
                    Else
                        font_size_for_address = "-1"
                    End If
                Else

                End If

                If Not IsDBNull(SqlReader.Item("comp_address1")) Then
                    If bWordReport Then
                        address_info = "<tr valign='top'><td><font size='" + font_size_for_address + "' " & font_style & ">" + SqlReader.Item("comp_address1").ToString
                    Else
                        address_info = "<tr valign='top'><td class='CompInfo'><font " & font_style & ">" + SqlReader.Item("comp_address1").ToString + "</font>"
                    End If
                Else
                    If bWordReport Then
                        address_info = "<tr valign='top'><td><font size='-1' " & font_style & ">"
                    Else
                        address_info = "<tr valign='top'><td class='CompInfo'>"
                    End If

                End If



                If Not IsDBNull(SqlReader.Item("comp_logo_flag")) And logo_check.Checked Then
                    If SqlReader.Item("comp_logo_flag").ToString.ToUpper.Contains("Y") And logo_check.Checked Then
                        comp_image_file = HttpContext.Current.Server.MapPath("pictures\company\") & SqlReader.Item("comp_id").ToString & ".jpg"
                    ElseIf logo_check.Checked = True And invisible_label_parent_image.Text <> "" Then
                        comp_image_file = HttpContext.Current.Server.MapPath("pictures\company\") & invisible_label_parent_image.Text & ".jpg"
                    End If
                ElseIf logo_check.Checked = True And invisible_label_parent_image.Text <> "" Then
                    comp_image_file = HttpContext.Current.Server.MapPath("pictures\company\") & invisible_label_parent_image.Text & ".jpg"
                End If



                temp_width = 0
                temp_height = 0
                If Trim(comp_image_file) <> "" Then
                    Try
                        zimage2 = System.Drawing.Image.FromFile(comp_image_file)
                        temp_width = zimage2.Width
                        temp_height = zimage2.Height
                        desired_width = 140
                        desired_height = 100

                        If temp_width > desired_width Then
                            temp_percent1 = CDbl(CDbl(desired_width) / CDbl(temp_width))
                            temp_width = CDbl(CDbl(temp_width) * CDbl(temp_percent1))
                            temp_height = CDbl(CDbl(temp_height) * CDbl(temp_percent1))
                        End If

                        If temp_height > desired_height Then
                            temp_percent1 = CDbl(CDbl(desired_height) / CDbl(temp_height))
                            temp_width = CDbl(CDbl(temp_width) * CDbl(temp_percent1))
                            temp_height = CDbl(CDbl(temp_height) * CDbl(temp_percent1))
                        End If
                    Catch ex As Exception

                    End Try
                End If


                If temp_width = 0 Then
                    temp_width = 140
                End If

                If bWordReport Then
                    If Not IsDBNull(SqlReader.Item("comp_logo_flag")) And logo_check.Checked Then
                        If SqlReader.Item("comp_logo_flag").ToString.ToUpper.Contains("Y") And logo_check.Checked Then

                            If HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then

                                If Not Application.Item("crmClientSiteData").crmClientHostName.ToString.ToUpper.Contains("NEWEVONET") Then
                                    logo_link = "https://www.testjetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                                Else
                                    logo_link = "http://www.jetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                                End If

                            Else
                                logo_link = Application.Item("crmClientSiteData").ClientFullHostName.ToString.Trim + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                            End If

                            logo_link = "<img src='" + logo_link + "/" + SqlReader.Item("comp_id").ToString + ".jpg' width='" & temp_width & "' height='" & (temp_width / 2) & "'>"
                        ElseIf logo_check.Checked = True And invisible_label_parent_image.Text <> "" Then

                            If HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then

                                If Not Application.Item("crmClientSiteData").crmClientHostName.ToString.ToUpper.Contains("NEWEVONET") Then
                                    logo_link = "https://www.testjetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                                Else
                                    logo_link = "http://www.jetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                                End If

                            Else
                                logo_link = Application.Item("crmClientSiteData").ClientFullHostName.ToString.Trim + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                            End If

                            logo_link = "<img src='" + logo_link + "/" + invisible_label_parent_image.Text + ".jpg' width='" & temp_width & "' height='" & (temp_width / 2) & "'>"
                        End If
                    ElseIf logo_check.Checked = True And invisible_label_parent_image.Text <> "" Then

                        If HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then

                            If Not Application.Item("crmClientSiteData").crmClientHostName.ToString.ToUpper.Contains("NEWEVONET") Then
                                logo_link = "https://www.testjetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                            Else
                                logo_link = "http://www.jetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                            End If

                        Else
                            logo_link = Application.Item("crmClientSiteData").ClientFullHostName.ToString.Trim + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                        End If

                        logo_link = "<img src='" + logo_link + "/" + invisible_label_parent_image.Text + ".jpg' width='" & temp_width & "' height='" & (temp_width / 2) & "'>"
                    End If
                Else
                    If Not IsDBNull(SqlReader.Item("comp_logo_flag")) And logo_check.Checked Then
                        If SqlReader.Item("comp_logo_flag").ToString.ToUpper.Contains("Y") And logo_check.Checked Then

                            If HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then

                                If Not Application.Item("crmClientSiteData").crmClientHostName.ToString.ToUpper.Contains("NEWEVONET") Then
                                    logo_link = "https://www.testjetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                                Else
                                    logo_link = "http://www.jetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                                End If

                            Else
                                logo_link = Application.Item("crmClientSiteData").ClientFullHostName.ToString.Trim + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                            End If

                            logo_link = "<img src='" + logo_link + "/" + SqlReader.Item("comp_id").ToString + ".jpg' width='" & temp_width & "'>"
                        ElseIf logo_check.Checked = True And invisible_label_parent_image.Text <> "" Then

                            If HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then

                                If Not Application.Item("crmClientSiteData").crmClientHostName.ToString.ToUpper.Contains("NEWEVONET") Then
                                    logo_link = "https://www.testjetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                                Else
                                    logo_link = "http://www.jetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                                End If

                            Else
                                logo_link = Application.Item("crmClientSiteData").ClientFullHostName.ToString.Trim + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                            End If

                            logo_link = "<img src='" + logo_link + "/" + invisible_label_parent_image.Text + ".jpg' width='" & temp_width & "'>"
                        End If
                    ElseIf logo_check.Checked = True And invisible_label_parent_image.Text <> "" Then

                        If HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then

                            If Not Application.Item("crmClientSiteData").crmClientHostName.ToString.ToUpper.Contains("NEWEVONET") Then
                                logo_link = "https://www.testjetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                            Else
                                logo_link = "http://www.jetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                            End If

                        Else
                            logo_link = Application.Item("crmClientSiteData").ClientFullHostName.ToString.Trim + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                        End If

                        logo_link = "<img src='" + logo_link + "/" + invisible_label_parent_image.Text + ".jpg' width='" & temp_width & "'>"
                    End If
                End If


                If Not IsDBNull(SqlReader.Item("comp_address2")) Then
                    address_info += "<font " & font_style & "> . " + SqlReader.Item("comp_address2").ToString + "</font>"
                End If

                If font_size_for_address = "-2" Or Not String.IsNullOrEmpty(logo_link) Then
                    address_info += "<br />"
                End If

                If Not IsDBNull(SqlReader.Item("comp_city")) Then
                    address_info += "<font " & font_style & "> " + SqlReader.Item("comp_city").ToString + "</font>"
                End If

                If Not IsDBNull(SqlReader.Item("comp_state")) Then
                    address_info += "<font " & font_style & ">, " + SqlReader.Item("comp_state").ToString + "</font>"
                End If

                If Not IsDBNull(SqlReader.Item("comp_zip_code")) Then
                    address_info += "<font " & font_style & "> " + SqlReader.Item("comp_zip_code").ToString + "</font>"
                End If

                address_info += "</td></tr>"
                address_info += "<tr><td>"
                address_info += "<table cellpadding='0' cellspacing='0' border='0'>"
                address_info += "<tr><td align='left'>"
                address_info += "<table cellpadding='0' cellspacing='0' border='0'>"
                address_info += build_phone_info_full_spec(CLng(Session.Item("localUser").crmSubSubID.ToString), "black")
                address_info += "</table>"
                address_info += "</td><td>"
                If Not IsDBNull(SqlReader.Item("comp_web_address")) Then
                    address_info += " &#8226; "

                    If SqlReader.Item("comp_web_address").ToString.Trim.ToLower.Contains("www") Then
                        address_info += "<a href='http://" + SqlReader.Item("comp_web_address").ToString.Trim + "' target='new'>" + SqlReader.Item("comp_web_address").ToString.Trim + "</a>"
                    Else
                        address_info += "<a href='" + SqlReader.Item("comp_web_address").ToString.Trim + "' target='new'>" + SqlReader.Item("comp_web_address").ToString.Trim + "</a>"
                    End If

                    address_info += ""

                Else
                    address_info += "&nbsp;"
                End If
                address_info += "</td></tr>"
                address_info += "</table>"
                address_info += "</td></tr>"

            End If

            SqlReader.Close()

            htmlOutput.Append(build_full_spec_page_header(nAircraftID, "Aircraft Information", address_info, logo_link, 0))

            'SECTION 2  - AIRCRAFT INFO  -----------------------------------------------------------------------------------------------------------------------------------

            htmlOutput.Append("<tr><td height='5'></td></tr>")

            sQuery = New StringBuilder()

            SqlConn.Close()

            If nAircraftJournalID_Full > 0 Then
                Dim out_HistoricalRs As New DataTable
                Dim i As Integer = 0
                out_HistoricalRs = Master.aclsData_Temp.GetJETNET_Historical_Data(nAircraftID, nAircraftJournalID_Full, bAerodexFlag)
                If Not IsNothing(out_HistoricalRs) Then
                    For Each r As DataRow In out_HistoricalRs.Rows
                        If i = 0 Then
                            htmlOutput.Append("<tr><td colspan='2' class='header_text'>")
                            htmlOutput.Append(Display_AircraftHistoryBlock_Report(r))
                            htmlOutput.Append("</td></tr>")
                        End If
                        i = i + 1
                    Next
                End If
            End If




            sQuery.Append("SELECT * ")

            If nAircraftJournalID_Full > 0 Then
                sQuery.Append(", (select AC_EST_AIRFRAME_HRS from View_Aircraft_History_Flat WITH(NOLOCK)  ")
                sQuery.Append(" where(View_Aircraft_History_Flat.ac_id = aircraft.ac_id And View_Aircraft_History_Flat.ac_journ_id = aircraft.ac_journ_id) ")
                sQuery.Append(" ) as est_hrs ")
            End If

            sQuery.Append(" FROM Aircraft WITH(NOLOCK) INNER JOIN Aircraft_Model WITH(NOLOCK) ON ac_amod_id = amod_id")
            If nAircraftJournalID_Full > 0 Then
                sQuery.Append(" inner join journal on journ_id = ac_journ_id ")
            End If
            sQuery.Append(" WHERE ac_journ_id = " & nAircraftJournalID_Full & " AND ac_id = " + nAircraftID.ToString)

            SqlConn.ConnectionString = localFunctions.clientConnectStr
            SqlConn.Open()
            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString
            SqlReader = SqlCommand.ExecuteReader()

            If SqlReader.HasRows Then

                SqlReader.Read()

                htmlOutput.Append("<tr><td colspan='2' class='header_text'>Aircraft Identification</b></font></td></tr>")

                If chkBlindReport.Checked = False Then
                    If Not IsDBNull(SqlReader.Item("ac_confidential_notes")) Then
                        If Not String.IsNullOrEmpty(SqlReader.Item("ac_confidential_notes").ToString.Trim) Then
                            confidential = "<tr><td width='2%'>&nbsp;</td><td><font class='small_header_text'>Note: &nbsp;</font>"
                            confidential += "<font class='text_text'>" + SqlReader.Item("ac_confidential_notes").ToString.Trim + "&nbsp;</td></tr>"
                        End If
                    End If
                End If

                ' make
                If Not IsDBNull(SqlReader.Item("amod_make_name")) Then
                    htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='small_header_text'>Model: </font><font class='text_text'>")
                    htmlOutput.Append(SqlReader.Item("amod_make_name").ToString + "&nbsp;")
                End If

                ' model
                If Not IsDBNull(SqlReader.Item("amod_model_name")) Then
                    htmlOutput.Append(SqlReader.Item("amod_model_name") + "</font></td></tr>")
                End If

                ' year of manufacture
                If Not IsDBNull(SqlReader.Item("ac_mfr_year")) Then
                    htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='small_header_text'>Year of Manufacture: </font><font class='text_text'>" + SqlReader.Item("ac_mfr_year").ToString + "</font>")
                End If

                If Not IsDBNull(SqlReader.Item("ac_year")) Then
                    htmlOutput.Append("<font class='small_header_text'>, Delivery: </font><font class='text_text'>" + SqlReader.Item("ac_year").ToString + "</font></td></tr>")
                Else
                    htmlOutput.Append("</td></tr>")
                End If

                If Not chkBlindReport.Checked Then
                    ' serial number
                    If Not IsDBNull(SqlReader.Item("ac_ser_no_full")) Then
                        htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='small_header_text'>Serial #: </font><font class='text_text'>" + SqlReader.Item("ac_ser_no_full").ToString + "</font></td></tr>")
                    End If

                    ' reg number
                    If Not IsDBNull(SqlReader.Item("ac_reg_no")) Then
                        htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='small_header_text'>Registration #: </font><font class='text_text'>" + SqlReader.Item("ac_reg_no").ToString)

                        If Not IsDBNull(SqlReader.Item("ac_reg_no_expiration_date")) Then
                            htmlOutput.Append(" [Expires: " + SqlReader.Item("ac_reg_no_expiration_date") + "]")
                        End If
                        htmlOutput.Append("</font></td></tr>")
                    End If

                    If Not bAerodexFlag Then
                        ' airframe total time
                        If Not IsDBNull(SqlReader.Item("ac_purchase_date")) Then
                            htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='small_header_text'>Purchase Date: </font><font class='text_text'>" + FormatDateTime(SqlReader.Item("ac_purchase_date"), DateFormat.ShortDate) + "</font></td></tr>")
                        End If
                    End If
                Else
                    htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='small_header_text'>Aircraft ID: </font><font class='text_text'>" + SqlReader.Item("ac_id").ToString + "</font></td></tr>")
                End If

                If Not IsDBNull(SqlReader.Item("ac_airframe_tot_hrs")) Then
                    airfram_tot_time = "<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='small_header_text'>Airframe Total Time(AFTT): </font><font class='text_text'>" + FormatNumber(SqlReader.Item("ac_airframe_tot_hrs"), 0) + "</font></td></tr>"
                End If

                If nAircraftJournalID_Full > 0 Then
                    If Not IsDBNull(SqlReader.Item("est_hrs")) Then
                        est_tot_time = "<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='small_header_text'>Estimated Airframe Total Time at time of Sale&nbsp;: </font><font class='text_text'>" + FormatNumber(SqlReader.Item("est_hrs"), 0) + "</font></td></tr>"
                    End If
                End If

                ' landing cycles
                If Not IsDBNull(SqlReader.Item("ac_airframe_tot_landings")) Then
                    cycles = "<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='small_header_text'>Landings/Cycles: </font><font class='text_text'>" + FormatNumber(SqlReader.Item("ac_airframe_tot_landings"), 0) + "</font></td></tr>"
                End If

                If Not bAerodexFlag Then
                    If chkShowAsking.Checked = True Then

                        If Not IsDBNull(SqlReader.Item("ac_foreign_currency_price")) Then

                            asking_price = "<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'>"
                            asking_price += "<font class='small_header_text'>Asking Amt (" + SqlReader.Item("ac_foreign_currency_name").ToString
                            asking_price += "): </font><font class='text_text'>" + FormatCurrency(CDbl(SqlReader.Item("ac_foreign_currency_price").ToString), 0) + "</font></td></tr>"

                        End If

                        If Not IsDBNull(SqlReader.Item("ac_asking")) Then

                            If Not IsDBNull(SqlReader.Item("ac_status")) Then
                                ac_status = SqlReader.Item("ac_status").ToString.ToUpper
                                If ac_status.ToUpper.Contains("FOR SALE/TRADE") And SqlReader.Item("ac_asking").ToString.ToUpper.Contains("SALE/TRADE") Then
                                    ac_status = ""
                                Else
                                    ac_status = "<tr><td width='2%'>&nbsp;</td><td><font class='small_header_text'>Status: </font><font class='text_text'>"
                                    ac_status += SqlReader.Item("ac_status").ToString + "</font></td></tr>"
                                End If
                            End If

                            asking_type = "<tr><td width='2%'>&nbsp;</td><td nowrap='NOWRAP'>"
                            asking_type += "<font class='small_header_text'>Asking: </font><font class='text_text'>"
                            asking_type += SqlReader.Item("ac_asking").ToString
                            asking_type += "</font></td></tr>"

                            If (SqlReader.Item("ac_asking").ToString.ToUpper.Contains("PRICE")) Then

                                If Not IsDBNull(SqlReader.Item("ac_asking_price")) Then
                                    asking_price += "<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'>"
                                    asking_price += "<font class='small_header_text'>Asking Amt (USD): </font><font class='text_text'>"
                                    If Not String.IsNullOrEmpty(addToAsking.Text) And IsNumeric(addToAsking.Text) Then
                                        asking_price += FormatCurrency(CDbl(SqlReader.Item("ac_asking_price").ToString) + CDbl(addToAsking.Text), 0) + "</font></td></tr>"
                                    Else
                                        asking_price += FormatCurrency(CDbl(SqlReader.Item("ac_asking_price").ToString), 0) + "</font></td></tr>"
                                    End If
                                End If

                                asking_type = ""

                            End If

                        Else

                            If Not IsDBNull(SqlReader.Item("ac_asking_price")) Then
                                asking_price += "<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'>"
                                asking_price += "<font class='small_header_text'>Asking Amt (USD): </font><font class='text_text'>"
                                If Not String.IsNullOrEmpty(addToAsking.Text) And IsNumeric(addToAsking.Text) Then
                                    asking_price += FormatCurrency(CDbl(SqlReader.Item("ac_asking_price").ToString) + CDbl(addToAsking.Text), 0) + "</font></td></tr>"
                                Else
                                    asking_price += FormatCurrency(CDbl(SqlReader.Item("ac_asking_price").ToString), 0) + "</font></td></tr>"
                                End If
                            End If

                        End If
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("ac_interior_doneby_name")) Then
                    in_done_by_and_rating = in_done_by_and_rating + "<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='small_header_text2'>Done By: </font><font class='text_text'>" + SqlReader.Item("ac_interior_doneby_name").ToString + "</font></td></tr>"
                End If
                If Not IsDBNull(SqlReader.Item("ac_interior_rating")) Then
                    in_done_by_and_rating = in_done_by_and_rating + "<tr><td width='2%'>&nbsp;</td><td><font class='small_header_text2'>Rating: </font><font class='text_text'>" + SqlReader.Item("ac_interior_rating").ToString + "</font></td></tr>"
                End If
                If Not IsDBNull(SqlReader.Item("ac_passenger_count")) Then
                    in_done_by_and_rating = in_done_by_and_rating + "<tr><td width='2%'>&nbsp;</td><td><font class='small_header_text2'>Number of Passengers: </font><font class='text_text'>" + SqlReader.Item("ac_passenger_count").ToString + "</font></td></tr>"
                End If

                ' THIS IS FOR INTERIOR SECTION ------ 
                If Not IsDBNull(SqlReader.Item("ac_interior_moyear")) Then
                    If SqlReader.Item("ac_interior_moyear").ToString.Trim.Length > 0 Then
                        If SqlReader.Item("ac_interior_moyear").ToString.Length > 4 Then
                            temp_moyear = SqlReader.Item("ac_interior_moyear").ToString
                            If temp_moyear.ToString.Length = 5 Then
                                temp_moyear = Left(temp_moyear, 1) + "/" + Right(temp_moyear, 4)
                            Else
                                If temp_moyear.ToString.Length = 6 Then
                                    temp_moyear = Left(temp_moyear, 2) + "/" + Right(temp_moyear, 4)
                                End If
                            End If
                            last_updated = " (<font class='small_header_text'>Updated: </font><font class='text_text'> " + temp_moyear + "</font>)"
                        Else
                            last_updated = " (<font class='small_header_text'>Updated: </font><font class='text_text'> " + SqlReader.Item("ac_interior_moyear").ToString + "</font>)"
                        End If
                    End If
                End If




                ' THIS IS FOR INTERIOR SECTION ------ TP.Checked Or PP.Checked Or SP.Checked

                If Not bAerodexFlag Then
                    If chkBlindReport.Checked Or chkEB.Checked Then 'if its blind, or exlcue broker then dont show
                    Else
                        If Not IsDBNull(SqlReader.Item("ac_exclusive_flag")) Then
                            If (SqlReader.Item("ac_exclusive_flag").ToString.ToUpper = "Y") Then
                                exclusive_flag = "<tr><td width='2%'>&nbsp;</td><td><font class='small_header_text'>On Exclusive with " + commonEvo.GetExclusiveBrokerCompany(nAircraftID, 0) + "</font></td></tr>"
                            End If
                        End If
                    End If
                End If


                'AclsData_Temp = New clsData_Manager_SQL
                'AclsData_Temp.JETNET_DB = Session.Item("jetnetClientDatabase")
                'AclsData_Temp.client_DB = Session.Item("jetnetServerNotesDatabase")


                Dim d_exclusiveDate As String = CommonAircraftFunctions.GetExclusiveDate(CLng(nAircraftID), CLng(SqlReader.Item("ac_journ_id").ToString), Master.aclsData_Temp)
                If chkBlindReport.Checked Or chkEB.Checked Then 'if its blind, or exlcue broker then dont show
                Else
                    If chkBlindReport.Checked Or chkEB.Checked Then
                    Else
                        If Not String.IsNullOrEmpty(d_exclusiveDate) Then
                            exclusive_flag = "<tr><td width='2%'>&nbsp;</td><td><font class='small_header_text'>On Exclusive with " + CommonAircraftFunctions.GetExclusive(nAircraftID, CLng(SqlReader.Item("ac_journ_id").ToString), Master.aclsData_Temp, "JETNET", False) + "</em> as of " + d_exclusiveDate + "</font></td></tr>"
                        Else
                            exclusive_flag = ("<tr><td width='2%'>&nbsp;</td><td><font class='small_header_text'>On Exclusive with " + CommonAircraftFunctions.GetExclusive(nAircraftID, CLng(SqlReader.Item("ac_journ_id").ToString), Master.aclsData_Temp, "JETNET", False) + "</font></td></tr>")
                        End If
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("ac_list_date")) Then
                    list_date = "Date Listed: " + FormatDateTime(SqlReader.Item("ac_list_date").ToString, DateFormat.ShortDate)

                    If nAircraftJournalID_Full > 0 Then
                        days_on_market = DateDiff("d", CDate(SqlReader.Item("ac_list_date").ToString), SqlReader.Item("journ_date").ToString).ToString
                    Else
                        days_on_market = DateDiff("d", CDate(SqlReader.Item("ac_list_date").ToString), Now()).ToString
                    End If


                End If

                If Not IsDBNull(SqlReader.Item("ac_exterior_doneby_name")) Then
                    ex_done_by_and_rating = ex_done_by_and_rating + "<tr><td width='2%'>&nbsp;</td><td><font class='small_header_text2'>Done By: </font><font class='text_text'>" + SqlReader.Item("ac_exterior_doneby_name").ToString + "</font></td></tr>"
                End If
                If Not IsDBNull(SqlReader.Item("ac_exterior_rating")) Then
                    ex_done_by_and_rating = ex_done_by_and_rating + "<tr><td width='2%'>&nbsp;</td><td><font class='small_header_text2'>Rating: </font><font class='text_text'>" + SqlReader.Item("ac_exterior_rating").ToString + "</font></td></tr>"
                End If

                If Not IsDBNull(SqlReader.Item("ac_exterior_moyear")) Then
                    If SqlReader.Item("ac_exterior_moyear").ToString.Trim.Length > 0 Then
                        If SqlReader.Item("ac_exterior_moyear").ToString.Trim.Length > 4 Then
                            temp_ex_moyear = SqlReader.Item("ac_exterior_moyear").ToString
                            If temp_ex_moyear.Trim.Length = 5 Then
                                temp_ex_moyear = Left(temp_ex_moyear, 1) + "/" + Right(temp_ex_moyear, 4)
                            Else
                                If temp_ex_moyear.Trim.Length = 6 Then
                                    temp_ex_moyear = Left(temp_ex_moyear, 2) + "/" + Right(temp_ex_moyear, 4)
                                End If
                            End If
                            ex_date = " (<font class='small_header_text'>Updated: </font><font class='text_text'>" + temp_ex_moyear + "</font>)</td>"
                        Else
                            ex_date = " (<font class='small_header_text'>Updated: </font><font class='text_text'>" + SqlReader.Item("ac_exterior_moyear").ToString + "</font>)</td>"
                        End If
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("ac_previously_owned_flag")) Then
                    If Trim(SqlReader.Item("ac_previously_owned_flag")) = "Y" Then
                        prev_owned = "<tr><td width='2%'>&nbsp;</td><td><font class='small_header_text'>Previously Owned</font></td></tr>"
                    ElseIf Trim(SqlReader.Item("ac_previously_owned_flag")) = "N" Then
                        prev_owned = "<tr><td width='2%'>&nbsp;</td><td><font class='small_header_text'>Not Previously Owned</font></td></tr>"
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("ac_times_as_of_date")) Then
                    times_date = "<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='small_header_text'>Times as of: </font><font class='text_text'>" & FormatDateTime(SqlReader.Item("ac_times_as_of_date").ToString, DateFormat.ShortDate).ToString & "</font></td></tr>"
                End If

                'SECTION 2  - AIRCRAFT INFO  -----------------------------------------------------------------------------------------------------------------------------------

                If Not bAerodexFlag Then

                    If (SqlReader.Item("ac_forsale_flag").ToString.ToUpper = "Y") Then
                        htmlOutput.Append("<tr><td height='5'></td></tr>")
                        htmlOutput.Append("<tr><td colspan='2' width='100%' class='header_text'>For Sale Information (" + list_date + ")</b></font>&nbsp;</td></tr>")

                        htmlOutput.Append(ac_status)
                        htmlOutput.Append(asking_type)
                        htmlOutput.Append(asking_price)
                        htmlOutput.Append(confidential)
                        htmlOutput.Append(exclusive_flag)

                        'added MSW 2/26/2013 - upon jason's customer request
                        If Not String.IsNullOrEmpty(days_on_market) Then
                            htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td><font class='small_header_text'>Days on Market: </font><font class='text_text'>" + days_on_market + "</font></td></tr>")
                        End If

                    End If
                End If

                If (Not String.IsNullOrEmpty(airfram_tot_time) Or Not String.IsNullOrEmpty(cycles) Or Not String.IsNullOrEmpty(est_tot_time)) Then
                    htmlOutput.Append("<tr><td height='5'></td></tr>")
                    htmlOutput.Append("<tr><td colspan='2' width='100%' class='header_text'>Usage</font>&nbsp;</td></tr>")
                    htmlOutput.Append(times_date)
                    htmlOutput.Append(airfram_tot_time)
                    htmlOutput.Append(est_tot_time)
                    htmlOutput.Append(cycles)
                    htmlOutput.Append(prev_owned)
                End If

            End If

            Dim airportInfo = build_full_spec_airport_information(SqlReader)

            SqlReader.Close()

            '----------------------------------------- END OF DETAILS SECTION----------------------------------------------------------------

            htmlOutput.Append(build_full_spec_aircraft_details(nAircraftID, nAircraftJournalID_Full, "Interior", last_updated, in_done_by_and_rating))
            htmlOutput.Append(build_full_spec_aircraft_details(nAircraftID, nAircraftJournalID_Full, "Exterior", ex_date, ex_done_by_and_rating))

            htmlOutput.Append(build_format_full_spec(temp_height))
            If Chk_ALLPIC.Checked = True Then
                htmlOutput.Append(build_full_spec_first_picture(nAircraftID, SqlCommand, SqlReader))
            End If


            Session("Damage_History") = ""
            If chkIncludeKeyFeatures.Checked = True Then
                htmlOutput.Append(build_full_spec_aircraft_features(nAircraftID, SqlCommand, SqlReader, 53))
            End If

            htmlOutput.Append(airportInfo)
            htmlOutput.Append("</td></tr></table></td></tr></table>")

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_coverpage()" + ex.Message
        Finally

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing



        End Try

        Return htmlOutput.ToString

    End Function

    Public Function build_full_spec_second_page(ByVal nAircraftID As Long) As String

        Dim htmlOutput As New StringBuilder

        Dim ac_maintained As String = ""
        Dim ac_airframe_maint_tracking_prog_AMTP As String = ""
        Dim ac_airframe_maintenance_prog_AMP As String = ""
        Dim cert_information As String = ""
        Dim en_overhaul As String = ""
        Dim hot_inspec As String = ""
        Dim dam_history As String = ""

        Dim sQuery = New StringBuilder()

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader = Nothing
        Dim SqlException As SqlClient.SqlException = Nothing
        Dim temp_maint As String = ""

        Try

            sQuery.Append("SELECT * ")
            sQuery.Append(", (select top 1 emp_name from Engine_Maintenance_Program where ac_apu_maint_prog = emp_code)as ac_apu_maintance_program ")
            sQuery.Append(" FROM aircraft INNER JOIN Aircraft_Model WITH(NOLOCK) ON ac_amod_id = amod_id ")
            sQuery.Append(" INNER JOIN Airframe_Maintenance_Program WITH(NOLOCK) ON ac_airframe_maintenance_prog_AMP = amp_id")
            sQuery.Append(" INNER JOIN Airframe_Maintenance_Tracking_Program WITH(NOLOCK) ON ac_airframe_maint_tracking_prog_AMTP = amtp_id")
            sQuery.Append(" LEFT OUTER JOIN Aircraft_Certified WITH(NOLOCK) ON accert_ac_id = " + nAircraftID.ToString + " AND accert_ac_journ_id = 0")
            sQuery.Append(" WHERE ac_id = " + nAircraftID.ToString + " AND ac_journ_id = " & nAircraftJournalID_Full & "")

            SqlConn.ConnectionString = localFunctions.clientConnectStr
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString
            SqlReader = SqlCommand.ExecuteReader()

            If SqlReader.HasRows Then

                SqlReader.Read()

                If Not IsDBNull(SqlReader.Item("ac_maintained")) Then
                    ac_maintained = ac_maintained & "<tr><td width='2%'>&nbsp;</td>"
                    ac_maintained = ac_maintained & "<td><font class='small_header_text2'>Maintained : </font><font class='text_text'>" + SqlReader.Item("ac_maintained").ToString.Trim + "</font>" ' & "</td></tr>"
                End If

                If Not IsDBNull(SqlReader.Item("amp_program_name")) Then
                    ac_airframe_maintenance_prog_AMP = "<tr><td width='2%'>&nbsp;</td><td><font class='small_header_text2'>Airframe Maintenance Program : </font><font class='text_text2'>" + SqlReader.Item("amp_program_name").ToString.Trim + "</font></td></tr>"
                End If

                If Not IsDBNull(SqlReader.Item("amtp_program_name")) Then
                    ac_airframe_maint_tracking_prog_AMTP = "<tr><td width='2%'>&nbsp;</td><td><font class='small_header_text2'>Airframe Maintenance Tracking Program : </font><font class='text_text2'>" + SqlReader.Item("amtp_program_name").ToString.Trim + "</font></td></tr>"
                End If

                If Not IsDBNull(SqlReader.Item("accert_name")) Then
                    cert_information = "<tr><td width='2%'>&nbsp;</td><td><font class='small_header_text2'>Certification : </font><font class='text_text2'>" + SqlReader.Item("accert_name").ToString.Trim + "</font></td></tr>"
                End If

                If Not IsDBNull(SqlReader.Item("ac_maint_hots_by_name")) Then
                    hot_inspec = "<tr><td width='2%'>&nbsp;</td><td><font class='small_header_text2'>Hot Inspection By : </font><font class='text_text2'>" + SqlReader.Item("ac_maint_hots_by_name").ToString.Trim + "</font></td></tr>"
                End If

                If Not IsDBNull(SqlReader.Item("ac_maint_eoh_by_name")) Then
                    en_overhaul = "<tr><td width='2%'>&nbsp;</td><td><font class='small_header_text2'>Engine Overhaul By : </font><font class='text_text2'>" + SqlReader.Item("ac_maint_eoh_by_name").ToString.Trim + "</font></td></tr>"
                End If

                If Not IsDBNull(SqlReader.Item("ac_damage_history_notes")) Then
                    dam_history = "<tr><td width='2%'>&nbsp;</td><td><font class='small_header_text2'>Dam History Notes : </font><font class='text_text2'>" + SqlReader.Item("ac_damage_history_notes").ToString.Trim + "</font></td></tr>"
                End If

            End If

            htmlOutput.Append(build_full_spec_page_header(nAircraftID, "Aircraft Specifications", "", "", 0))
            htmlOutput.Append(build_full_spec_engine_info(SqlReader))

            ' check to see if this ac is an helicopter
            Dim makeModelProduct As String = ""
            commonEvo.Get_Aircraft_Model_Info(CLng(commonEvo.GetAircraftInfo(CLng(nAircraftID), True)), False, makeModelProduct)

            If CInt(makeModelProduct.Trim) = Constants.PRODUCT_CODE_HELICOPTERS Then
                htmlOutput.Append(build_full_spec_heli_details(nAircraftID, 0))
            End If

            htmlOutput.Append(build_full_spec_aircraft_apu(SqlReader))

            temp_maint = build_full_spec_aircraft_details(nAircraftID, nAircraftJournalID_Full, "Maintenance", "", ac_maintained)
            htmlOutput.Append(temp_maint)

            If Trim(temp_maint) = "" Then
                htmlOutput.Append("<tr><td height='5'></td></tr>")
                htmlOutput.Append("<tr><td colspan='2' width='100%' class='header_text'>Maintenance Details</font>&nbsp;</td></tr>")
            End If

            If Trim(Session("Damage_History")) <> "" And Trim(dam_history) = "" Then
                htmlOutput.Append(Trim(Session("Damage_History")))
            End If

            htmlOutput.Append(ac_airframe_maintenance_prog_AMP + ac_airframe_maint_tracking_prog_AMTP + cert_information + hot_inspec + en_overhaul + dam_history)


            htmlOutput.Append(build_full_spec_aircraft_details(nAircraftID, nAircraftJournalID_Full, "Equipment", "", ""))
            htmlOutput.Append(build_full_spec_aircraft_details(nAircraftID, nAircraftJournalID_Full, "Addl Cockpit Equipment", "", ""))
            htmlOutput.Append(build_full_spec_aircraft_avionics(nAircraftID, nAircraftJournalID_Full))


            htmlOutput.Append(build_format_full_spec())
            If Chk_ALLPIC.Checked = True Then
                htmlOutput.Append(build_full_spec_next_pictures(nAircraftID))
            End If


            htmlOutput.Append("</td></tr></table></td></tr></table>")

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_second_page()" + ex.Message
        Finally

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

            SqlReader.Close()


        End Try

        Return htmlOutput.ToString

    End Function

    Public Function build_full_spec_notes_page_aircraft(ByVal nAircraftID As Long) As String

        Dim htmlOutput As New StringBuilder()

        Try

            htmlOutput.Append(build_full_spec_page_header(nAircraftID, "Aircraft Notes", "", "", 0))
            htmlOutput.Append(build_full_spec_notes_page(nAircraftID, 0))
            htmlOutput.Append("</td></tr></table></td></tr></table>")

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_notes_page_aircraft()" + ex.Message
        End Try

        Return htmlOutput.ToString

        htmlOutput = Nothing

    End Function

    Public Function build_full_spec_transactions_page_aircraft(ByVal nAircraftID As Long) As String  '

        Dim htmlOutput As New StringBuilder()

        Try

            htmlOutput.Append(build_full_spec_page_header(nAircraftID, "Aircraft Transactions", "", "", 0))
            htmlOutput.Append(build_full_spec_transactions_page(nAircraftID, 0))
            htmlOutput.Append("</td></tr></table></td></tr></table>")

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_transactions_page_aircraft()" + ex.Message
        End Try

        Return htmlOutput.ToString

        htmlOutput = Nothing

    End Function

    Public Function build_full_spec_third_page(ByVal nAircraftID As Long) As String

        Dim htmlOutput As New StringBuilder()

        Try

            htmlOutput.Append(build_full_spec_page_header(nAircraftID, "Aircraft Company / Contacts", "", "", 0))
            htmlOutput.Append(build_full_spec_aircraft_contacts(nAircraftID))
            htmlOutput.Append("</td></tr></table></td></tr></table>")

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_third_page()" + ex.Message
        End Try

        Return htmlOutput.ToString

        htmlOutput = Nothing

    End Function

    Public Function build_pictures_page_full_spec(ByVal nAircraftID As Long) As String

        Dim htmlOutput As New StringBuilder()

        Try

            htmlOutput.Append(build_full_spec_page_header(nAircraftID, "Additional Aircraft Pictures", "", "", 0))
            htmlOutput.Append(build_full_spec_pictures_page(nAircraftID))
            htmlOutput.Append("</td></tr></table></td></tr></table>")

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_pictures_page_full_spec()" + ex.Message
        End Try

        Return htmlOutput.ToString

        htmlOutput = Nothing

    End Function

    Public Function build_style_page_full_spec() As String

        Dim sServerMapPath As String = ""
        Dim sSiteStyleSheet As String = "common\style.css"
        sServerMapPath = Server.MapPath(sSiteStyleSheet)
        Dim txtFile As New System.IO.StreamReader(sServerMapPath)
        Dim readStyle As New StringBuilder
        Dim formatStyle As String = "<style type='text/css'>"
        Dim font_face As String = ""
        Dim font_face_light As String = ""

        Try

            readStyle.Append(formatStyle)

            Do While txtFile.EndOfStream <> True
                formatStyle = txtFile.ReadLine()
                If Trim(formatStyle.StartsWith(".border_bottom")) Then
                    formatStyle = formatStyle.Replace("0px", "1px")
                ElseIf Trim(formatStyle.StartsWith(".border_bottom_right")) Then
                    formatStyle = formatStyle.Replace("0px", "1px")
                ElseIf Trim(formatStyle.StartsWith(".leftside")) Then
                    formatStyle = formatStyle.Replace("0px", "1px")
                ElseIf Trim(formatStyle.StartsWith(".rightside")) Then
                    formatStyle = formatStyle.Replace("0px", "1px")
                ElseIf Trim(readStyle.ToString.EndsWith("TD{")) Then
                    formatStyle = formatStyle.Replace("8pt", "12pt")
                End If

                readStyle.Append(formatStyle)

            Loop

            readStyle.Append(".break { page-break-before: always; }" + vbCrLf)

            'If bWordReport Then
            '  readStyle.Append(".header_text{font-family:Arial ;font-size: x-small; color: #736F6E; font-weight: bold;}" & vbCrLf)
            '  readStyle.Append(".small_header_text{font-family:Arial ;font-size: xx-small; font-style: italic; color: #736F6E} " & vbCrLf)
            '  readStyle.Append(".small_header_text2{font-family:Arial ;font-size: xx-small; font-style: italic; color: #736F6E; font-weight: bold;} " & vbCrLf)
            '  readStyle.Append(".text_text{font-family:Arial;font-size: xx-small; color: #736F6E}" & vbCrLf)
            '  readStyle.Append(".text_text2{font-family:Arial;font-size: xx-small; color: #736F6E}" & vbCrLf)
            '  readStyle.Append(".white_feat_text{font-family:Arial;font-size: x-small; color: white}" & vbCrLf)
            '  readStyle.Append(".white_feat_header_text{font-family:Arial;font-size: small; color: white; font-weight: bold;}" & vbCrLf)
            'Else
            '  readStyle.Append(".header_text{font-family:Arial ;font-size: medium; color: #736F6E; font-weight: bold;}" & vbCrLf)
            '  readStyle.Append(".small_header_text{font-family:Arial ;font-size: smaller; font-style: italic; color: #736F6E} " & vbCrLf)
            '  readStyle.Append(".small_header_text2{font-family:Arial ;font-size: x-small; font-style: italic; color: #736F6E; font-weight: bold;} " & vbCrLf)
            '  readStyle.Append(".text_text{font-family:Arial;font-size: small; color: #736F6E}" & vbCrLf)
            '  readStyle.Append(".text_text2{font-family:Arial;font-size: x-small; color: #736F6E}" & vbCrLf)
            '  readStyle.Append(".white_feat_text{font-family:Arial;font-size: medium; color: white}" & vbCrLf)
            '  readStyle.Append(".white_feat_header_text{font-family:Arial;font-size: large; color: white; font-weight: bold;}" & vbCrLf)
            'End If

            font_face = " face = 'sans-serif'; "
            font_face_light = " face = 'sans-serif-light'; "

            ' small_header_text goes with text_text
            ' small_header_text2 goes with text_text2



            If bWordReport Then
                readStyle.Append(".header_text{" & font_face & " font-size: 14pt; color: #736F6E; }" & vbCrLf)
                readStyle.Append(".small_header_text{" & font_face & "font-size: 9pt; color: #736F6E; font-weight: bold;} " & vbCrLf)
                readStyle.Append(".small_header_text2{" & font_face & "font-size: 9pt; color: #736F6E; font-weight: bold;} " & vbCrLf)
                readStyle.Append(".text_text{" & font_face & "font-size: 9pt; color: #736F6E; font-weight: lighter;}" & vbCrLf)
                readStyle.Append(".text_text2{" & font_face & "; font-size: 9pt; color: #736F6E; font-weight: lighter;}" & vbCrLf)
                readStyle.Append(".white_feat_text{" & font_face & "font-size: 10pt; color: white}" & vbCrLf)
                readStyle.Append(".white_feat_header_text{" & font_face & "font-size: 14pt; color: white;}" & vbCrLf)
            Else
                readStyle.Append(".header_text{" & font_face & " font-size: 14pt; color: #736F6E; }" & vbCrLf)
                readStyle.Append(".small_header_text{" & font_face & "font-size: 9pt;   color: #736F6E; font-weight: bold;} " & vbCrLf)
                readStyle.Append(".small_header_text2{" & font_face & "font-size: 9pt;  color: #736F6E; font-weight: bold;} " & vbCrLf)
                readStyle.Append(".text_text{" & font_face & "font-size: 9pt; color: #736F6E; font-weight: lighter;}" & vbCrLf)
                readStyle.Append(".text_text2{" & font_face & "font-size: 9pt; color: #736F6E; font-weight: lighter;}" & vbCrLf)
                readStyle.Append(".white_feat_text{" & font_face & "font-size: 10pt; color: white}" & vbCrLf)

                ''normal font weight = 400 bold = 700
                'If Trim(Request("try")) = "1" Then
                '  readStyle.Append(".white_feat_header_text{" & font_face & "font-size: 14pt; color: white;}" & vbCrLf)
                'ElseIf Trim(Request("try")) = "2" Then
                '  readStyle.Append(".white_feat_header_text{" & font_face & "font-size: 14pt; color: white; font-weight: Extra Light;}" & vbCrLf)
                'ElseIf Trim(Request("try")) = "3" Then 
                '  readStyle.Append(".white_feat_header_text{" & font_face & "font-size: 14pt; color: white; font-weight: Light;}" & vbCrLf)
                'ElseIf Trim(Request("try")) = "4" Then
                '  readStyle.Append(".white_feat_header_text{" & font_face & "font-size: 14pt; color: white;}" & vbCrLf)
                'ElseIf Trim(Request("try")) = "5" Then
                '  readStyle.Append(".white_feat_header_text{" & font_face & "font-size: 14pt; color: white; font-weight: Ultra Light;}" & vbCrLf)
                'ElseIf Trim(Request("try")) = "6" Then
                '  readStyle.Append(".white_feat_header_text{" & font_face & "font-size: 14pt; color: white; font-weight: bold;}" & vbCrLf)
                'Else
                readStyle.Append(".white_feat_header_text{" & font_face & "font-size: 14pt; color: white;}" & vbCrLf)
                ' End If 

            End If

            readStyle.Append(".table_specs{font-size:12px;}" + vbCrLf)
            readStyle.Append("</style>" + vbCrLf)

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_template_header_full_spec()" + ex.Message
        End Try

        Return vbCrLf + readStyle.ToString + vbCrLf

    End Function

    Public Function build_format_full_spec(Optional ByVal extra_logo_size As Integer = 0) As String

        Dim tmpString As String = ""
        Dim old_page_height As Integer = 890

        Try

            ' changed since it was sometimes going over with image picked
            If logo_check.Checked = True Then
                If extra_logo_size > 50 Then
                    old_page_height = 885 ' was 890
                End If
            End If

            If extra_logo_size > 50 Then
                old_page_height = (old_page_height - extra_logo_size) + 50
            End If

            tmpString = "</table>"
            tmpString += "</td><td width='1%'>&nbsp;&nbsp;&nbsp;"


            If Trim(extra_logo_size) > 0 Then
                If bWordReport Then
                    tmpString += "</td><td width='350' height='500' valign='top'>"
                    tmpString += "<table cellspacing='0' bgcolor='#A4A4A4' height='" & old_page_height & "' width='350' valign='top'><tr height='850' valign='top'><td width='350' height='850' align='center'>"
                Else
                    tmpString += "</td><td width='40%' height='" & old_page_height & "' valign='top'>"
                    tmpString += "<table cellspacing='0' bgcolor='#A4A4A4' height='" & old_page_height & "' width='100%' valign='top'><tr height='" & old_page_height & "' valign='top'><td width='100%' height='" & old_page_height & "' align='center'>"
                End If
            Else
                If bWordReport Then
                    tmpString += "</td><td width='350' height='500' valign='top'>"
                    tmpString += "<table cellspacing='0' bgcolor='#A4A4A4' height='850' width='350' valign='top'><tr height='850' valign='top'><td width='350' height='850' align='center'>"
                Else
                    tmpString += "</td><td width='40%' height='900' valign='top' align='left'>"
                    tmpString += "<table cellspacing='0' bgcolor='#A4A4A4' height='900' width='100%' valign='top'><tr height='900' valign='top'><td width='100%' height='900' align='center'>"
                End If
            End If


        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Build_PDF_Format()" + ex.Message
        End Try

        Return tmpString

    End Function

    Public Function build_full_spec_pictures_page(ByVal nAircraftID As Long) As String

        'LAST SECTION  IN COL 1- PICTURE -----------------------------------------------------------------------------------------------------------------------------------
        Dim outString As String = ""

        Dim imgDisplayFolder As String = ""

        If HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then

            If Not Application.Item("crmClientSiteData").crmClientHostName.ToString.ToUpper.Contains("NEWEVONET") Then
                imgDisplayFolder = "https://www.testjetnetevolution.com/" + HttpContext.Current.Session.Item("AircraftPicturesFolderVirtualPath")
            Else
                imgDisplayFolder = "http://www.jetnetevolution.com/" + HttpContext.Current.Session.Item("AircraftPicturesFolderVirtualPath")
            End If

        Else
            imgDisplayFolder = Application.Item("crmClientSiteData").ClientFullHostName.ToString.Trim + HttpContext.Current.Session.Item("AircraftPicturesFolderVirtualPath")
        End If

        Dim imgFileName As String = ""

        ' This is right side column, should start with an open table already in td

        Dim fApicSubject As String = ""
        Dim fAcpic_image_type As String = ""
        Dim fAcpic_id As Integer = 0
        Dim pic_seq_num As Integer = 0
        Dim row_color As String = "gray"
        Dim pic_counter As Integer = 0

        Dim pic_size As Integer = 250
        Dim pic_height_size As Integer = 200
        Dim nCount As Integer = 0
        Dim something_shown As Boolean = False

        Dim sQuery = New StringBuilder()

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader = Nothing
        Dim SqlException As SqlClient.SqlException = Nothing

        Dim ac_image_file As String = ""
        Dim temp_height As Integer = 0
        Dim temp_width As Integer = 0
        Dim zimage2 As System.Drawing.Image
        Dim desired_width As Integer = 250
        Dim temp_percent1 As Double = 0.0
        Dim temp_percent2 As Double = 0.0
        Dim add_pic As String = "N"
        Dim height_size_total As Integer = 1000
        Dim total_height As Integer = 0



        Try

            sQuery.Append("SELECT * FROM Aircraft_Pictures WITH(NOLOCK)")   ' 1 on title - 3 on next - 6 on this
            sQuery.Append(" WHERE acpic_ac_id = " + nAircraftID.ToString)
            sQuery.Append(" AND acpic_journ_id = 0")
            sQuery.Append(" AND acpic_seq_no > 0")
            sQuery.Append(" AND acpic_image_type = 'JPG'")
            sQuery.Append(" AND acpic_hide_flag = 'N'")
            sQuery.Append(" ORDER BY acpic_seq_no")

            SqlConn.ConnectionString = localFunctions.clientConnectStr
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString
            SqlReader = SqlCommand.ExecuteReader()

            outString = "<table width='100%' align='center' cellspacing='0' cellpadding='4'>"

            If SqlReader.HasRows Then

                Do While SqlReader.Read

                    If nCount > 1 Then

                        pic_seq_num = CInt(SqlReader.Item("acpic_seq_no").ToString)

                        If Not IsDBNull(SqlReader("acpic_image_type")) Then
                            fAcpic_image_type = SqlReader.Item("acpic_image_type").ToString.ToLower.Trim
                        End If

                        If Not IsDBNull(SqlReader("acpic_id")) Then
                            fAcpic_id = SqlReader.Item("acpic_id").ToString.Trim
                        End If

                        If Not (IsDBNull(SqlReader("acpic_subject"))) Then
                            fApicSubject = SqlReader.Item("acpic_subject").ToString.Trim
                        End If

                        imgFileName = nAircraftID.ToString + Constants.cHyphen + "0" + Constants.cHyphen + fAcpic_id.ToString + Constants.cDot + fAcpic_image_type.ToLower.Trim

                        If chkPP_Large.Checked = True And chkPP_Large.Visible = True Then
                            desired_width = 800
                        Else
                            desired_width = 250
                        End If

                        If chkPP_Large.Checked = True And chkPP_Large.Visible = True Then
                            ' 8/17/18 - MSW - added the .visible = true so that on old spec (43) it wouldnt do it 

                            If bWordReport Then
                                'outString += "<tr bgcolor='#F1F1F1'><td valign='middle' align='center' class='text_text'>"
                                If pic_counter = 0 Then
                                    If row_color = "white" Then
                                        outString += "<tr bgcolor='#F1F1F1'><td width='90%' valign='middle' align='center' class='text_text'>"
                                        row_color = "gray"
                                    Else
                                        outString += "<tr bgcolor='#D0D0D0'><td width='90%' valign='middle' align='center' class='text_text'>"
                                        row_color = "white"
                                    End If
                                End If
                            Else
                                If pic_counter = 0 Then
                                    If row_color = "white" Then
                                        outString += "<tr bgcolor='#F1F1F1'><td width='90%' valign='middle' align='center' class='text_text'>"
                                        row_color = "gray"
                                    Else
                                        outString += "<tr bgcolor='#D0D0D0'><td width='90%' valign='middle' align='center' class='text_text'>"
                                        row_color = "white"
                                    End If
                                End If
                            End If

                        Else

                            If bWordReport Then
                                'outString += "<tr bgcolor='#F1F1F1'><td valign='middle' align='center' class='text_text'>"
                                If pic_counter = 0 Then
                                    If row_color = "white" Then
                                        outString += "<tr bgcolor='#F1F1F1'><td width='50%' valign='middle' align='center' class='text_text'>"
                                        row_color = "gray"
                                    Else
                                        outString += "<tr bgcolor='#D0D0D0'><td width='50%' valign='middle' align='center' class='text_text'>"
                                        row_color = "white"
                                    End If
                                End If
                            Else
                                If pic_counter = 0 Then
                                    If row_color = "white" Then
                                        outString += "<tr bgcolor='#F1F1F1'><td width='33%' valign='middle' align='center' class='text_text'>"
                                        row_color = "gray"
                                    Else
                                        outString += "<tr bgcolor='#D0D0D0'><td width='33%' valign='middle' align='center' class='text_text'>"
                                        row_color = "white"
                                    End If
                                End If
                            End If

                        End If



                        Try


                            ac_image_file = HttpContext.Current.Server.MapPath("pictures\aircraft\") & imgFileName
                            zimage2 = System.Drawing.Image.FromFile(ac_image_file)
                            temp_width = zimage2.Width
                            temp_height = zimage2.Height

                            If chkPP_Large.Checked = True And chkPP_Large.Visible = True Then

                                'if width > height, then shrink the width down 
                                If temp_width > temp_height Then
                                    If temp_width > desired_width Then
                                        temp_percent1 = CDbl(CDbl(desired_width) / CDbl(temp_width))
                                        temp_width = CDbl(CDbl(temp_width) * CDbl(temp_percent1))
                                        temp_height = CDbl(CDbl(temp_height) * CDbl(temp_percent1))
                                    End If
                                ElseIf temp_height > temp_width Then
                                    ' if taller than it is wide, then as long as not too wide, its ok till height check
                                    If temp_width > desired_width Then
                                        temp_percent1 = CDbl(CDbl(desired_width) / CDbl(temp_width))
                                        temp_width = CDbl(CDbl(temp_width) * CDbl(temp_percent1))
                                        temp_height = CDbl(CDbl(temp_height) * CDbl(temp_percent1))
                                    End If
                                End If

                                ' make sure not too tall for a given page size
                                If temp_height > height_size_total Then
                                    temp_percent1 = CDbl(CDbl(height_size_total) / CDbl(temp_height))
                                    temp_width = CDbl(CDbl(temp_width) * CDbl(temp_percent1))
                                    temp_height = CDbl(CDbl(temp_height) * CDbl(temp_percent1))
                                End If



                            Else
                                ' if the image is wider then the desired image width, then shirnk down to size.
                                If temp_width > desired_width Then
                                    temp_percent1 = CDbl(CDbl(desired_width) / CDbl(temp_width))
                                    temp_width = CDbl(CDbl(temp_width) * CDbl(temp_percent1))
                                    temp_height = CDbl(CDbl(temp_height) * CDbl(temp_percent1))
                                End If

                                'assuming generally that a square is fine
                                If temp_height > temp_width Then
                                    temp_percent1 = CDbl(CDbl(temp_width) / CDbl(temp_height))
                                    temp_width = CDbl(CDbl(temp_width) * CDbl(temp_percent1))
                                    temp_height = CDbl(CDbl(temp_height) * CDbl(temp_percent1))
                                End If
                            End If


                            ' Call CommonAircraftFunctions.find_image_resize_to_fit(temp_width, temp_height, desired_width, desired_height, javascript_slideshow_begining, r, image_folder_display, fAcpic_id, fAcpic_image_type, fAcpic_subject, "Yacht", yacht_id, journalID)

                            If Trim(Request("pic_test")) = "Y" Then
                                If chkPP_Large.Checked = True And chkPP_Large.Visible = True Then
                                    total_height = total_height + temp_height

                                    add_pic = "Y"
                                    If total_height > height_size_total Then
                                        add_pic = "N"
                                    End If

                                    If add_pic = "N" Then
                                        outString += "</td></tr>"
                                        outString += Insert_Page_Break_PDF()
                                        total_height = 0
                                    End If
                                End If
                            End If


                            If bWordReport Then
                                outString += "<img title='" + fApicSubject.Trim + "' alt='" + fApicSubject.Trim + "' src='" + imgDisplayFolder.Trim + "/" + imgFileName.Trim + "' width='" + temp_width.ToString + "'  height='" + temp_height.ToString + "'/><br /><br />"
                            Else
                                outString += "<img title='" + fApicSubject.Trim + "' alt='" + fApicSubject.Trim + "' src='" + imgDisplayFolder.Trim + "/" + imgFileName.Trim + "' width='" + temp_width.ToString + "' /><br /><br />"
                            End If


                        Catch ex As Exception

                            temp_width = desired_width

                            If bWordReport Then
                                outString += "<img title='" + fApicSubject.Trim + "' alt='" + fApicSubject.Trim + "' src='" + imgDisplayFolder.Trim + "/" + imgFileName.Trim + "' width='" + temp_width.ToString + "'  height='" + temp_height.ToString + "'/><br /><br />"
                            Else
                                outString += "<img title='" + fApicSubject.Trim + "' alt='" + fApicSubject.Trim + "' src='" + imgDisplayFolder.Trim + "/" + imgFileName.Trim + "' width='" + temp_width.ToString + "' /><br /><br />"
                            End If
                        End Try


                        If chkPP_Large.Checked = True And chkPP_Large.Visible = True Then

                            outString += "</td></tr>"
                            something_shown = True

                        Else


                            something_shown = True

                            If bWordReport Then
                                If pic_counter < 1 Then
                                    outString += "</td><td width='33%' valign='middle' align='center' class='text_text'>"
                                    pic_counter += 1
                                Else
                                    outString += "</td></tr>"
                                    pic_counter = 0
                                End If
                            Else
                                If pic_counter < 2 Then
                                    outString += "</td><td width='33%' valign='middle' align='center' class='text_text'>"
                                    pic_counter += 1
                                Else
                                    outString += "</td></tr>"
                                    pic_counter = 0
                                End If
                            End If

                        End If


                    End If

                    nCount += 1


                Loop

                If pic_counter = 0 Then
                    ' dont need to do anything, we just ended
                ElseIf pic_counter = 1 Then ' end second and create third, then end row
                    outString += "</td><td width='33%' valign='middle' align='center' class='text_text'>&nbsp;</td></tr>"
                ElseIf pic_counter = 2 Then ' end second and create third, then end row
                    outString += "</td></tr>"
                End If


                'If pic_counter = 0 Then
                '  outString += "</td>"
                '  outString += "<td width='33%' valign='middle' align='center' class='text_text'>&nbsp;</td></tr>"
                'ElseIf pic_counter = 1 Then
                '  outString += "</td><td width='33%' valign='middle' align='center' class='text_text'>&nbsp;</td></tr>"
                'End If



            End If

            If Not something_shown Then
                outString += "<tr><td valign='middle' align='center' class='text_text'> No Additional Pictures Currently Available </td></tr>"
            End If

            outString += "</table>"


        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_pictures_page_pics()" + ex.Message
        Finally

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

            SqlReader.Close()


        End Try

        Return outString

    End Function

    Public Function build_full_spec_first_picture(ByVal nAircraftID As Long, ByRef SqlCommand As SqlClient.SqlCommand, ByRef adoRSAircraft As SqlClient.SqlDataReader) As String
        'LAST SECTION  IN COL 1- PICTURE -----------------------------------------------------------------------------------------------------------------------------------
        Dim outString As String = ""

        ' This is right side column, should start with an open table already in td
        Dim fAcpic_image_type As String = ""
        Dim fAcpic_id As Integer = 0
        Dim pic_seq_num As Integer = 0
        Dim something_shown As Boolean = False
        Dim pic_size As Integer = 310
        Dim full_image_path As String = ""

        Dim fApicSubject As String = ""
        Dim pic_height_size As Integer = 310
        Dim pic_width As Integer = 310

        Dim imgDisplayFolder As String = ""

        If HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then

            If Not Application.Item("crmClientSiteData").crmClientHostName.ToString.ToUpper.Contains("NEWEVONET") Then
                imgDisplayFolder = "https://www.testjetnetevolution.com/" + HttpContext.Current.Session.Item("AircraftPicturesFolderVirtualPath")
            Else
                imgDisplayFolder = "http://www.jetnetevolution.com/" + HttpContext.Current.Session.Item("AircraftPicturesFolderVirtualPath")
            End If

        Else
            imgDisplayFolder = Application.Item("crmClientSiteData").ClientFullHostName.ToString.Trim + HttpContext.Current.Session.Item("AircraftPicturesFolderVirtualPath")
        End If

        Dim imgFileName As String = ""
        Dim htmlOutput As String = ""
        Dim div_by As Double = 0
        Dim Query As String : Query = ""

        Dim ac_image_file As String = ""
        Dim temp_height As Integer = 0
        Dim temp_width As Integer = 0
        Dim zimage2 As System.Drawing.Image
        Dim desired_width As Integer = 310
        Dim temp_percent1 As Double = 0.0
        Dim temp_percent2 As Double = 0.0


        Try

            ' start AC_Pic
            Query = "SELECT TOP 1 * FROM Aircraft_Pictures WITH(NOLOCK)"
            Query += " WHERE acpic_ac_id = " + nAircraftID.ToString
            Query += " AND acpic_journ_id = " & nAircraftJournalID_Full
            Query += " AND acpic_seq_no > 0"
            Query += " AND acpic_image_type = 'JPG'"
            Query += " AND acpic_hide_flag = 'N'"
            Query += " ORDER BY acpic_seq_no"

            SqlCommand.CommandText = Query
            adoRSAircraft = SqlCommand.ExecuteReader()

            If adoRSAircraft.HasRows Then

                adoRSAircraft.Read()

                pic_seq_num = CInt(adoRSAircraft.Item("acpic_seq_no").ToString)

                If Not IsDBNull(adoRSAircraft("acpic_image_type")) Then
                    fAcpic_image_type = adoRSAircraft.Item("acpic_image_type").ToString.ToLower.Trim
                End If

                If Not IsDBNull(adoRSAircraft("acpic_id")) Then
                    fAcpic_id = adoRSAircraft.Item("acpic_id").ToString.Trim
                End If

                If Not (IsDBNull(adoRSAircraft("acpic_subject"))) Then
                    fApicSubject = adoRSAircraft.Item("acpic_subject").ToString.Trim
                End If

                imgFileName = nAircraftID.ToString + Constants.cHyphen + "0" + Constants.cHyphen + fAcpic_id.ToString + Constants.cDot + fAcpic_image_type.ToLower.Trim

                full_image_path = imgDisplayFolder.Trim + "/" + imgFileName.Trim

                ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
                ' setup the path for the pictures based on which site is running
                ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

                Try


                    ac_image_file = HttpContext.Current.Server.MapPath("pictures\aircraft\") & imgFileName
                    zimage2 = System.Drawing.Image.FromFile(ac_image_file)
                    temp_width = zimage2.Width
                    temp_height = zimage2.Height

                    ' if the image is wider then the desired image width, then shirnk down to size.
                    If temp_width > desired_width Then
                        temp_percent1 = CDbl(CDbl(desired_width) / CDbl(temp_width))
                        temp_width = CDbl(CDbl(temp_width) * CDbl(temp_percent1))
                        temp_height = CDbl(CDbl(temp_height) * CDbl(temp_percent1))
                    End If

                    'assuming generally that a square is fine
                    If temp_height > temp_width Then
                        temp_percent1 = CDbl(CDbl(temp_width) / CDbl(temp_height))
                        temp_width = CDbl(CDbl(temp_width) * CDbl(temp_percent1))
                        temp_height = CDbl(CDbl(temp_height) * CDbl(temp_percent1))
                    End If

                    If bWordReport Then
                        outString += "<img Title='" + fApicSubject.Trim + "' alt='" + fApicSubject.Trim + "' src='" + full_image_path + "' width='" + temp_width.ToString + "' height='" + temp_height.ToString + "' /><br /><br />"
                    Else
                        outString += "<img Title='" + fApicSubject.Trim + "' alt='" + fApicSubject.Trim + "' src='" + full_image_path + "' width='" + temp_width.ToString + "'  /><br /><br />"
                    End If
                Catch ex As Exception

                    If bWordReport Then
                        pic_width = 250
                        pic_height_size = 250
                    End If

                    outString += "<img Title='" + fApicSubject.Trim + "' alt='" + fApicSubject.Trim + "' src='" + full_image_path + "' width='" + pic_width.ToString + "' height='" + pic_height_size.ToString + "' /><br /><br />"
                End Try

                something_shown = True

            End If

            adoRSAircraft.Close()

            If Not something_shown Then
                outString = "No Pictures Available"
            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_first_picture()" + ex.Message
        End Try

        Return outString

    End Function

    Public Function build_full_spec_next_pictures(ByVal nAircraftID As Long) As String
        'LAST SECTION  IN COL 1- PICTURE -----------------------------------------------------------------------------------------------------------------------------------
        Dim outString As String = ""

        ' This is right side column, should start with an open table already in td
        Dim imgDisplayFolder As String = ""

        If HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then

            If Not Application.Item("crmClientSiteData").crmClientHostName.ToString.ToUpper.Contains("NEWEVONET") Then
                imgDisplayFolder = "https://www.testjetnetevolution.com/" + HttpContext.Current.Session.Item("AircraftPicturesFolderVirtualPath")
            Else
                imgDisplayFolder = "http://www.jetnetevolution.com/" + HttpContext.Current.Session.Item("AircraftPicturesFolderVirtualPath")
            End If

        Else
            imgDisplayFolder = Application.Item("crmClientSiteData").ClientFullHostName.ToString.Trim + HttpContext.Current.Session.Item("AircraftPicturesFolderVirtualPath")
        End If


        Dim imgFileName As String = ""
        Dim fApicSubject As String = ""

        Dim fAcpic_image_type As String = ""
        Dim fAcpic_id As Integer = 0
        Dim pic_seq_num As Integer = 0
        Dim pic_size As Integer = 310

        Dim something_shown As Boolean = False
        Dim nCount As Integer = 0

        Dim sQuery = New StringBuilder()

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader = Nothing
        Dim SqlException As SqlClient.SqlException = Nothing

        Dim ac_image_file As String = ""
        Dim temp_height As Integer = 0
        Dim temp_width As Integer = 0
        Dim zimage2 As System.Drawing.Image
        Dim desired_width As Integer = 310
        Dim temp_percent1 As Double = 0.0
        Dim temp_percent2 As Double = 0.0

        Try

            ' start AC_Pic
            sQuery.Append("SELECT TOP 2 * FROM Aircraft_Pictures WITH(NOLOCK)")
            sQuery.Append(" WHERE acpic_ac_id = " + nAircraftID.ToString)
            sQuery.Append(" AND acpic_journ_id = 0")
            sQuery.Append(" AND acpic_seq_no > 0")
            sQuery.Append(" AND acpic_image_type = 'JPG'")
            sQuery.Append(" AND acpic_hide_flag = 'N'")
            sQuery.Append(" ORDER BY acpic_seq_no")

            SqlConn.ConnectionString = localFunctions.clientConnectStr
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString
            SqlReader = SqlCommand.ExecuteReader()

            If SqlReader.HasRows Then
                Do While SqlReader.Read()

                    If nCount > 0 Then

                        pic_seq_num = CInt(SqlReader.Item("acpic_seq_no").ToString)

                        If Not IsDBNull(SqlReader("acpic_image_type")) Then
                            fAcpic_image_type = SqlReader.Item("acpic_image_type").ToString.ToLower.Trim
                        End If

                        If Not IsDBNull(SqlReader("acpic_id")) Then
                            fAcpic_id = SqlReader.Item("acpic_id").ToString.Trim
                        End If

                        If Not (IsDBNull(SqlReader("acpic_subject"))) Then
                            fApicSubject = SqlReader.Item("acpic_subject").ToString.Trim
                        End If

                        imgFileName = nAircraftID.ToString + Constants.cHyphen + "0" + Constants.cHyphen + fAcpic_id.ToString + Constants.cDot + fAcpic_image_type.ToLower.Trim

                        If bWordReport Then
                            pic_size = 250
                        End If



                        Try

                            ac_image_file = HttpContext.Current.Server.MapPath("pictures\aircraft\") & imgFileName
                            zimage2 = System.Drawing.Image.FromFile(ac_image_file)
                            temp_width = zimage2.Width
                            temp_height = zimage2.Height

                            ' if the image is wider then the desired image width, then shirnk down to size.
                            If temp_width > desired_width Then
                                temp_percent1 = CDbl(CDbl(desired_width) / CDbl(temp_width))
                                temp_width = CDbl(CDbl(temp_width) * CDbl(temp_percent1))
                                temp_height = CDbl(CDbl(temp_height) * CDbl(temp_percent1))
                            End If

                            'assuming generally that a square is fine
                            If temp_height > temp_width Then
                                temp_percent1 = CDbl(CDbl(temp_width) / CDbl(temp_height))
                                temp_width = CDbl(CDbl(temp_width) * CDbl(temp_percent1))
                                temp_height = CDbl(CDbl(temp_height) * CDbl(temp_percent1))
                            End If

                            If bWordReport Then
                                outString += "<img Title='" + fApicSubject.Trim + "' alt='" + fApicSubject.Trim + "' src='" + imgDisplayFolder.Trim + "/" + imgFileName.Trim + "' width='" + temp_width.ToString + "' height='" + temp_height.ToString + "'  /><br /><br />"
                            Else
                                outString += "<img Title='" + fApicSubject.Trim + "' alt='" + fApicSubject.Trim + "' src='" + imgDisplayFolder.Trim + "/" + imgFileName.Trim + "' width='" + temp_width.ToString + "' /><br /><br />"
                            End If
                        Catch ex As Exception

                            outString += "<img Title='" + fApicSubject.Trim + "' alt='" + fApicSubject.Trim + "' src='" + imgDisplayFolder.Trim + "/" + imgFileName.Trim + "' width='" + pic_size.ToString + "' /><br /><br />"
                        End Try


                        something_shown = True

                    End If

                    nCount += 1

                Loop

            End If

            If Not something_shown Then
                outString = " No Pictures Available "
            End If

            SqlReader.Close()

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_next_pictures()" + ex.Message
        Finally

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

            SqlReader.Close()


        End Try

        Return outString

    End Function

    Public Function build_full_spec_aircraft_contacts(ByVal nAircraftID As Long) As String

        Dim ac_maintained As String = ""
        Dim column_color As String = "white"
        Dim contact_counter As Integer = 1
        Dim sub_counter As Integer = 1

        Dim sQuery = New StringBuilder()
        Dim outString As String = ""

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader = Nothing
        Dim SqlException As SqlClient.SqlException = Nothing

        Try

            sQuery.Append("SELECT comp_id, actype_name, cref_owner_percent, contact_id, contact_sirname, contact_first_name, contact_middle_initial, contact_last_name, contact_suffix, contact_title, contact_email_address")
            sQuery.Append(" FROM aircraft_reference INNER JOIN company WITH(NOLOCK) ON cref_comp_id = comp_id and cref_journ_id = comp_journ_id")
            sQuery.Append(" INNER JOIN aircraft_contact_type WITH(NOLOCK) ON cref_contact_type = actype_code")
            sQuery.Append(" LEFT OUTER JOIN contact WITH(NOLOCK) ON cref_contact_id = contact_id AND cref_journ_id = contact_journ_id AND contact_hide_flag = 'N'")
            sQuery.Append(" WHERE cref_ac_id = " + nAircraftID.ToString + " and cref_journ_id = " & nAircraftJournalID_Full & " ")

            If bAerodexFlag Then
                ' then dont include exclusive broker
                sQuery.Append(" AND cref_contact_type <> '99'")
            Else
                ' if eb isnt checked, dont include eb
                If chkEB.Checked Then
                    sQuery.Append(" AND cref_contact_type <> '99'")
                End If
            End If

            sQuery.Append(" AND cref_contact_type <> '71'")
            sQuery.Append(" ORDER BY cref_transmit_seq_no")

            SqlConn.ConnectionString = localFunctions.clientConnectStr
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString
            SqlReader = SqlCommand.ExecuteReader()

            outString = "<table width='100%' align='center' cellspacing='0' cellpadding='4'>"

            If SqlReader.HasRows Then

                Do While SqlReader.Read

                    If (column_color = "white") Then
                        If bWordReport Then
                            outString += "<tr valign='top'><td width='60%' height='700' bgcolor='white' valign='top' class='text_text'><b>"
                        Else
                            outString += "<tr valign='top'><td width='60%' bgcolor='white' valign='top' class='text_text'><b>"
                        End If
                    Else
                        If bWordReport Then
                            outString += "<tr valign='top' height='70'><td width='60%' height='700' bgcolor='#E6E6E6' class='text_text'><b>"
                        Else
                            outString += "<tr valign='top'><td width='60%' bgcolor='#E6E6E6' class='text_text'><b>"
                        End If
                    End If

                    If Not IsDBNull(SqlReader.Item("actype_name")) Then
                        outString += SqlReader.Item("actype_name").ToString.Trim + " "
                    End If

                    If Not IsDBNull(SqlReader.Item("cref_owner_percent")) Then
                        If CLng(SqlReader.Item("cref_owner_percent").ToString) > 0 And CLng(SqlReader.Item("cref_owner_percent").ToString) < 100 Then
                            outString += " [" + SqlReader.Item("cref_owner_percent").ToString.Trim + "] "
                        End If
                    End If

                    outString += " - " + commonEvo.get_company_info_fromID(CLng(SqlReader.Item("comp_id").ToString), nAircraftJournalID_Full, True, False, "", "")

                    If (column_color = "white") Then
                        If bWordReport Then
                            outString += "&nbsp;</td><td width='40%' bgcolor='#E6E6E6' valign='top' height='70' class='text_text'><b>"
                        Else
                            outString += "&nbsp;</td><td width='40%' bgcolor='#E6E6E6' valign='top' class='text_text'><b>"
                        End If

                        column_color = "other"
                    Else
                        If bWordReport Then
                            outString += "&nbsp;</td><td width='40%' bgcolor='white' height='70' valign='top' class='text_text'><b>"
                        Else
                            outString += "&nbsp;</td><td width='40%' bgcolor='white' valign='top' class='text_text'><b>"
                        End If
                        column_color = "white"
                    End If

                    If Not IsDBNull(SqlReader.Item("contact_sirname")) Then
                        outString += SqlReader.Item("contact_sirname").ToString.Trim + " "
                    End If

                    If Not IsDBNull(SqlReader.Item("contact_first_name")) Then
                        outString += SqlReader.Item("contact_first_name").ToString.Trim + " "
                    End If

                    If Not IsDBNull(SqlReader.Item("contact_middle_initial")) Then
                        If Trim(SqlReader.Item("contact_middle_initial")) <> "" Then
                            outString += SqlReader.Item("contact_middle_initial").ToString.Trim + ". "
                        End If
                    End If

                    If Not IsDBNull(SqlReader.Item("contact_last_name")) Then
                        outString += SqlReader.Item("contact_last_name").ToString.Trim + "</b> "
                    End If

                    If Not IsDBNull(SqlReader.Item("contact_suffix")) Then
                        outString += "<b>" + SqlReader.Item("contact_suffix").ToString.Trim + "</b>"
                    End If

                    If Not IsDBNull(SqlReader.Item("contact_title")) Then
                        outString += "<br />" + SqlReader.Item("contact_title").ToString.Trim + "<br />"
                    End If

                    If Not IsDBNull(SqlReader.Item("contact_email_address")) Then
                        outString += SqlReader.Item("contact_email_address").ToString.Trim + "<br />"
                    End If

                    If Not IsDBNull(SqlReader.Item("comp_id")) And Not IsDBNull(SqlReader.Item("contact_id")) Then
                        outString += build_full_spec_company_contact_phone(CLng(SqlReader.Item("comp_id").ToString), SqlReader.Item("contact_id"))
                    End If

                    outString += "</td></tr>"

                    contact_counter = contact_counter + 1
                Loop

            End If

            If bWordReport Then
                If contact_counter < 10 Then
                    sub_counter = 10 - contact_counter
                    Do While sub_counter > 0
                        outString += "<tr><td height='70'>&nbsp;</td></tr>"
                        sub_counter = sub_counter - 1
                    Loop
                End If
            End If

            outString += "</table>"

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_aircraft_contacts()" + ex.Message
        Finally

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

            SqlReader.Close()


        End Try

        Return outString

    End Function

    Public Function build_full_spec_aircraft_details(ByVal nAircraftID As Long, ByVal nAircraftJournalID As Long, ByVal detail_type As String, ByVal update_date As String, ByVal done_by As String) As String

        Dim last_detail_type As String = ""
        Dim sQuery = New StringBuilder()
        Dim outString As String = ""

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader = Nothing
        Dim SqlException As SqlClient.SqlException = Nothing

        Try

            sQuery.Append("SELECT * FROM Aircraft_Details WITH(NOLOCK) WHERE adet_ac_id = " + nAircraftID.ToString)
            sQuery.Append(" AND adet_journ_id = " + nAircraftJournalID.ToString + " AND lower(adet_data_type) = '" + detail_type.ToLower.Trim + "'")

            SqlConn.ConnectionString = localFunctions.clientConnectStr
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString
            SqlReader = SqlCommand.ExecuteReader()

            If SqlReader.HasRows Or Trim(done_by) <> "" Then
                outString = "<tr><td height='5'></td></tr>"

                outString &= "<tr><td colspan='2' width='100%' class='header_text'>" & detail_type & " Details " & update_date & "</font>&nbsp;</td></tr>"
                outString &= done_by
            End If


            If SqlReader.HasRows Then


                outString += "<tr><td width='2%'>&nbsp;</td><td>"

                Do While SqlReader.Read

                    If Not IsDBNull(SqlReader.Item("adet_data_name")) Then

                        If last_detail_type.ToLower.Trim = SqlReader.Item("adet_data_name").ToString.ToLower.Trim Then
                            outString += "<font class='text_text2'> " + Server.HtmlEncode(SqlReader.Item("adet_data_description").ToString.Trim) + "; </font>"
                        Else
                            outString += "<font class='small_header_text2'>" & Replace(SqlReader.Item("adet_data_name").ToString.Trim, "Inspection", "Notes") & "</font><font class='text_text2'>: " + Server.HtmlEncode(SqlReader.Item("adet_data_description").ToString.Trim) + "; </font>"
                        End If

                        last_detail_type = SqlReader.Item("adet_data_name").ToString.Trim

                    End If


                Loop

                outString += "</td></tr>"

            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_aircraft_details()" + ex.Message
        Finally

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

            SqlReader.Close()


        End Try

        Return outString

    End Function

    Public Function build_full_spec_aircraft_avionics(ByVal nAircraftID As Long, ByVal nAircraftJournalID As Long) As String

        Dim sQuery = New StringBuilder()
        Dim outString As String = ""

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader = Nothing
        Dim SqlException As SqlClient.SqlException = Nothing

        Try

            ' Start Avionics    
            sQuery.Append("SELECT * FROM Aircraft_Avionics WITH(NOLOCK) WHERE av_ac_id = " + nAircraftID.ToString + " AND av_ac_journ_id = " + nAircraftJournalID.ToString)
            SqlConn.ConnectionString = localFunctions.clientConnectStr
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString
            SqlReader = SqlCommand.ExecuteReader()

            If SqlReader.HasRows Then
                outString = "<tr><td height='5'></td></tr>"
                outString += "<tr><td colspan='2' class='header_text'>Avionics</td></tr>"
                outString += "<tr><td width='2%'>&nbsp;</td><td>"

                Do While SqlReader.Read
                    outString += "<font class='small_header_text2'>" + SqlReader.Item("av_name").ToString.Trim + " : </font><font class='text_text2'>" + SqlReader.Item("av_description").ToString.Trim + "; </font>"
                Loop

                outString += "</td></tr>"
            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_aircraft_avionics()" + ex.Message
        Finally

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

            SqlReader.Close()


        End Try

        Return outString

    End Function

    Public Function build_full_spec_aircraft_apu(ByRef SqlReader As SqlClient.SqlDataReader) As String

        Dim ac_apu_model_name As String = ""
        Dim ac_apu_tot_hrs As Integer
        Dim ac_apu_ser_no As String = ""
        Dim ac_apu_maintance_program As String = ""

        Dim outString As String = ""

        Try

            If Not IsNothing(SqlReader) And SqlReader.HasRows Then

                If Not IsDBNull(SqlReader.Item("ac_apu_model_name")) Then
                    ac_apu_model_name = SqlReader.Item("ac_apu_model_name").ToString.Trim
                Else
                    ac_apu_model_name = ""
                End If

                If Not IsDBNull(SqlReader.Item("ac_apu_tot_hrs")) Then
                    ac_apu_tot_hrs = CLng(SqlReader.Item("ac_apu_tot_hrs").ToString)
                Else
                    ac_apu_tot_hrs = 0
                End If

                If Not IsDBNull(SqlReader.Item("ac_apu_ser_no")) Then
                    ac_apu_ser_no = SqlReader.Item("ac_apu_ser_no").ToString.Trim
                Else
                    ac_apu_ser_no = ""
                End If

                If Not IsDBNull(SqlReader.Item("ac_apu_maintance_program")) Then
                    ac_apu_maintance_program = SqlReader.Item("ac_apu_maintance_program").ToString.Trim
                Else
                    ac_apu_maintance_program = ""
                End If

                outString = "<tr><td height='5'></td></tr>"

                If Not String.IsNullOrEmpty(ac_apu_model_name) Or ac_apu_tot_hrs > 0 Or Not String.IsNullOrEmpty(ac_apu_ser_no) Then
                    outString += "<tr><td colspan='2' width='100%' class='header_text'>Auxiliary Power Unit (APU)</td></tr>"

                    If Not String.IsNullOrEmpty(ac_apu_model_name) Then
                        outString += "<tr><td width='2%'>&nbsp;</td>"
                        outString += "<td><font class='small_header_text2'>Model&nbsp;:&nbsp;</font><font class='text_text2'>" + ac_apu_model_name
                    End If

                    If Not String.IsNullOrEmpty(ac_apu_ser_no) Then

                        If String.IsNullOrEmpty(ac_apu_model_name) Then
                            outString += "<tr><td width='2%'>&nbsp;</td>"
                            outString += "<td nowrap='nowrap'>"
                        Else
                            outString += ", "
                        End If

                        outString += "<font class='small_header_text2'>Serial #&nbsp;:&nbsp;"
                        outString += "</font><font class='text_text2'>" + ac_apu_ser_no.Trim + "</td></tr>"

                    End If

                    If Not String.IsNullOrEmpty(ac_apu_model_name) Then
                        If ac_apu_tot_hrs > 0 Then
                            outString += "<tr><td width='2%'>&nbsp;</td>"
                            outString += "<td nowrap><font class='small_header_text2'>Total Time (Hours) Since New&nbsp;:&nbsp;</font><font class='text_text2'>" + FormatNumber(ac_apu_tot_hrs, 0, True, False, True) + "</td></tr>"
                        End If
                    End If

                    If Not String.IsNullOrEmpty(ac_apu_model_name) Then
                        If Trim(ac_apu_maintance_program) <> "" Then
                            outString += "<tr><td width='2%'>&nbsp;</td>"
                            outString += "<td nowrap><font class='small_header_text2'>APU Maintenance Plan:&nbsp;:&nbsp;</font><font class='text_text2'>" & ac_apu_maintance_program & "</td></tr>"
                        End If
                    End If


                End If

                If Not IsDBNull(SqlReader.Item("ac_apu_soh_hrs")) Then
                    outString += "<tr><td width='2%'>&nbsp;</td>"
                    outString += "<td nowrap><font class='small_header_text2'>Since Overhaul (SOH) Hours:&nbsp;"
                    outString += "</font><font class='text_text2'>" + FormatNumber(CDbl(SqlReader.Item("ac_apu_soh_hrs").ToString), 0, True, False, True) + "</td></tr>"
                End If

                outString += "</tr>" & vbCrLf

                If Not IsDBNull(SqlReader.Item("ac_apu_shi_hrs")) Then
                    outString += "<tr><td width='2%'>&nbsp;</td>"
                    outString += "<td nowrap><font class='small_header_text2'>Since Hot Inspection (SHI) Hours:&nbsp;"

                    outString += "</font><font class='text_text2'>" + FormatNumber(CDbl(SqlReader.Item("ac_apu_shi_hrs").ToString), 0, True, False, True) + "</td>"
                    outString += "</tr>" & vbCrLf
                End If

            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_aircraft_apu()" + ex.Message
        End Try

        Return outString

    End Function

    Public Function build_phone_info_full_spec(ByVal Sub_ID As Long, ByVal color As String, Optional ByVal font_size As String = "") As String

        Dim sQuery = New StringBuilder()
        Dim sOutString As StringBuilder = New StringBuilder()

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing

        Try

            sQuery.Append("SELECT top 1 pnum_type, pnum_number_full FROM Subscription INNER JOIN Company ON Subscription.sub_comp_id = Company.comp_id AND Company.comp_journ_id = 0 INNER JOIN Phone_Numbers")
            sQuery.Append(" ON pnum_comp_id = Company.comp_id and pnum_journ_id = comp_journ_id")
            sQuery.Append(" INNER JOIN Phone_Type ON ptype_name = pnum_type ")
            sQuery.Append(" WHERE Subscription.sub_id = " + Sub_ID.ToString)
            sQuery.Append(" AND pnum_journ_id = 0")
            sQuery.Append(" AND pnum_hide_customer = 'N' AND pnum_contact_id = 0 ")
            sQuery.Append(" ORDER BY ptype_seq_no ASC")  ' QUERY EDITED TO DISPLAY TOLL FREE THEN OFFICE THEN FAX 

            SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            SqlConn.Open()
            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString
            SqlReader = SqlCommand.ExecuteReader()

            If SqlReader.HasRows Then

                Do While SqlReader.Read
                    'If color = "white" Then
                    If Trim(font_size) <> "" Then
                        If bWordReport Then
                            sOutString.Append("<tr><td><font size='-1' color='" & color & "' face='sans-serif'>" + SqlReader.Item("pnum_type").ToString + ": </font><font size='-1' color='" & color & "' face='sans-serif'>" + SqlReader.Item("pnum_number_full").ToString + "</font></td></tr>")
                        Else
                            sOutString.Append("<tr><td><font color='" & color & "' face='sans-serif' " & font_size & ">" + SqlReader.Item("pnum_type").ToString + ": </font><font  " & font_size & " color='" & color & "' face='sans-serif'>" + SqlReader.Item("pnum_number_full").ToString + "</font></td></tr>")
                        End If
                    Else
                        If bWordReport Then
                            sOutString.Append("<tr><td><font size='-1' color='" & color & "' face='sans-serif'>" + SqlReader.Item("pnum_type").ToString + ": </font><font size='-1' color='" & color & "' face='sans-serif'>" + SqlReader.Item("pnum_number_full").ToString + "</font></td></tr>")
                        Else
                            sOutString.Append("<tr><td><font color='" & color & "' face='sans-serif'>" + SqlReader.Item("pnum_type").ToString + ": </font><font size='+1'  color='" & color & "' face='sans-serif'>" + SqlReader.Item("pnum_number_full").ToString + "</font></td></tr>")
                        End If
                    End If

                    ' Else
                    ' sOutString.Append("<tr><td width='2%'>&nbsp;</td><td><font class='small_header_text' color='" & color & "'>" + SqlReader.Item("pnum_type").ToString + ": </font><font class='text_text' color='" & color & "'>" + SqlReader.Item("pnum_number_full").ToString + "</font></td></tr>")
                    ' End If
                Loop

            End If

            SqlReader.Close()

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_phone_info_full_spec " + ex.Message
        Finally
            SqlReader = Nothing

            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing
        End Try

        Return sOutString.ToString

    End Function

    Public Function build_full_spec_page_header_condensed(ByVal nAircraftID As Long, ByVal Title As String, ByVal address_info As String, ByVal image_ref As String) As String

        Dim company_name As String = ""

        Dim sQuery = New StringBuilder()
        Dim sOutString As StringBuilder = New StringBuilder()

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing
        Dim fix_width As String = "640"

        Try

            sQuery.Append("SELECT TOP 1 Company.comp_name, Company.comp_web_address, Company.comp_email_address FROM Company")
            sQuery.Append(" INNER JOIN Subscription ON sub_comp_id = comp_id AND comp_journ_id = 0")
            sQuery.Append(" WHERE Subscription.sub_id = " + Session.Item("localUser").crmSubSubID.ToString)

            SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            SqlConn.Open()
            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString
            SqlReader = SqlCommand.ExecuteReader()

            If SqlReader.HasRows Then
                SqlReader.Read()
                company_name = SqlReader.Item("comp_name").ToString.Trim
            End If

            SqlReader.Close()
            '
            '  If Trim(Request("wfix")) <> "" Then
            '  fix_width = Trim(Request("wfix"))
            '  Else
            '    fix_width = "840"
            '  End If

            If bWordReport Then
                sOutString.Append("<table cellspacing='0' cellpadding='0' width='" & fix_width & "'><tr><td colspan='3' cellpadding='0' cellspacing='0'>")

                If Trim(fix_width) <> "840" Then
                    sOutString.Append("<table style='border-bottom:2px solid black;' cellspacing='0' cellpadding='4' width='" & fix_width & "' height='50'><tr><td>")
                Else
                    sOutString.Append("<table style='border-bottom:2px solid black;' cellspacing='0' cellpadding='4' width='100%' height='50'><tr><td>")
                End If

                sOutString.Append("<table width='" & fix_width & "'><tr>")
            Else
                sOutString.Append("<table cellspacing='0' cellpadding='0' width='98%'><tr><td colspan='3' cellpadding='0' cellspacing='0'>")
                sOutString.Append("<table style='border-bottom:2px solid black;' cellspacing='0' cellpadding='4' width='100%' height='50'><tr><td>")
                sOutString.Append("<table width='100%'><tr>")
            End If

            sOutString.Append("<td width='" & fix_width & "' valign='top'><font size='-1' face='sans-serif'><b>")

            sOutString.Append(company_name + "</b></font><br>")

            If Not String.IsNullOrEmpty(address_info.Trim) Then
                sOutString.Append("<table>" + address_info.Trim)
                sOutString.Append("</table>")
            End If

            If bWordReport Then

                If Trim(fix_width) <> "840" Then
                    sOutString.Append("</td><td width='" & (CDbl(fix_width) * 0.4) & ")' cellpadding='5' valign='top'><font size='-1'>")
                Else
                    sOutString.Append("</td><td width='40%' cellpadding='5' valign='top'><font size='-1'>")
                End If

            Else
                sOutString.Append("</td><td width='40%' cellpadding='5' valign='top'><font>")
            End If

            sOutString.Append("<table align='right' valign='bottom'>")



            If check_prepared_for.Checked = True Then
                If prepared_for.Text <> "" Then
                    sOutString.Append("<tr><td nowrap='nowrap' align='right'><font size='-1'  face='sans-serif'><b>Prepared For: </b>" & Trim(prepared_for.Text) & "</font></td></tr>")

                    If Trim(image_ref) <> "" Then
                        image_ref = Replace(image_ref, "150", "120")
                    End If
                End If
            End If



            sOutString.Append("<tr><td align='right' nowrap='nowrap'><font face='sans-serif' size='-2'>")

            If CInt(nAircraftID) > 0 Then
                Dim acInfoArray() As String = Split(commonEvo.GetAircraftInfo(nAircraftID, False), Constants.cSvrDataSeperator)

                If Not String.IsNullOrEmpty(acInfoArray(0).ToString) Then
                    sOutString.Append(acInfoArray(0).ToString & " ")
                End If

                If Not String.IsNullOrEmpty(acInfoArray(1).ToString) Then
                    sOutString.Append(acInfoArray(1).ToString)
                End If

                If Not chkBlindReport.Checked Then
                    If Not String.IsNullOrEmpty(acInfoArray(2).ToString) Then
                        sOutString.Append(" SN #" + acInfoArray(2).ToString)
                    End If
                End If

                sOutString.Append("</font>")
            End If

            sOutString.Append("</td></tr>")

            If bWordReport Then
                sOutString.Append("<tr><td align='right'><font size='-1' face='sans-serif'><i>" + Title.Trim + "</i></font></td></tr>")
            Else
                sOutString.Append("<tr><td align='right'><font face='sans-serif'  size='-2'><i>" + Title.Trim + "</i></font></td></tr>")
            End If

            If Not String.IsNullOrEmpty(image_ref.Trim) Then
                If bWordReport Then
                    sOutString.Append("<tr><td width='150' align='right'>" + image_ref.Trim + "</td></tr>")
                Else
                    sOutString.Append("<tr><td width='150' align='right'>" + image_ref.Trim + "</td></tr>")
                End If
            End If

            sOutString.Append("</table>")


            '  If bWordReport Then
            '    sOutString.Append("</td></tr></table></td></tr></table></td></tr><tr valign='top'><td width='550' valign='top' height='500'><table valign='top' cellpadding='0' cellspacing='0'>")
            '  Else
            '    sOutString.Append("</td></tr></table></td></tr></table></td></tr><tr valign='top'><td width='60%' height='900' valign='top'><table valign='top' cellpadding='0' cellspacing='0'>")
            '  End If


            If bWordReport Then
                sOutString.Append("</td></tr></table></td></tr></table></td></tr></table>")
            Else
                sOutString.Append("</td></tr></table></td></tr></table></td></tr></table>")
            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_page_header " + ex.Message
        Finally
            SqlReader = Nothing

            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing
        End Try

        Return (sOutString.ToString)

    End Function

    Public Function build_full_spec_page_header(ByVal nAircraftID As Long, ByVal Title As String, ByVal address_info As String, ByVal image_ref As String, ByVal use_width As Integer) As String

        Dim company_name As String = ""

        Dim sQuery = New StringBuilder()
        Dim sOutString As StringBuilder = New StringBuilder()

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing
        Dim fix_width As String = "840"

        Try

            sQuery.Append("SELECT TOP 1 Company.comp_name, Company.comp_web_address, Company.comp_email_address FROM Company")
            sQuery.Append(" INNER JOIN Subscription ON sub_comp_id = comp_id AND comp_journ_id = 0")
            sQuery.Append(" WHERE Subscription.sub_id = " + Session.Item("localUser").crmSubSubID.ToString)

            SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            SqlConn.Open()
            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString
            SqlReader = SqlCommand.ExecuteReader()

            If SqlReader.HasRows Then
                SqlReader.Read()
                company_name = SqlReader.Item("comp_name").ToString.Trim
            End If

            SqlReader.Close()

            If use_width > 0 And bWordReport = True Then
                fix_width = use_width
            ElseIf Trim(Request("wfix")) <> "" Then
                fix_width = Trim(Request("wfix"))
            Else
                fix_width = "840"
            End If

            If use_width > 0 And bWordReport = True Then
                sOutString.Append("<table cellspacing='0' cellpadding='0' width='" & fix_width & "'><tr><td colspan='3' cellpadding='0' cellspacing='0'>")
                sOutString.Append("<table style='border-bottom:2px solid black;' cellspacing='0' cellpadding='4' width='" & fix_width & "' height='50'><tr><td>")
                sOutString.Append("<table width='" & fix_width & "'><tr>")
            ElseIf bWordReport Then
                sOutString.Append("<table cellspacing='0' cellpadding='0' width='" & fix_width & "'><tr><td colspan='3' cellpadding='0' cellspacing='0'>")

                If Trim(fix_width) <> "840" Then
                    sOutString.Append("<table style='border-bottom:2px solid black;' cellspacing='0' cellpadding='4' width='" & fix_width & "' height='50'><tr><td>")
                Else
                    sOutString.Append("<table style='border-bottom:2px solid black;' cellspacing='0' cellpadding='4' width='100%' height='50'><tr><td>")
                End If

                sOutString.Append("<table width='" & fix_width & "'><tr>")
            Else
                sOutString.Append("<table cellspacing='0' cellpadding='0' width='98%'><tr><td colspan='3' cellpadding='0' cellspacing='0'>")
                sOutString.Append("<table style='border-bottom:2px solid black;' cellspacing='0' cellpadding='4' width='100%' height='50'><tr><td>")
                sOutString.Append("<table width='100%'><tr>")
            End If

            sOutString.Append("<td width='" & fix_width & "' valign='top'><font size='-1' face='sans-serif'><b>")

            sOutString.Append(company_name + "</b></font><br>")

            If Not String.IsNullOrEmpty(address_info.Trim) Then
                sOutString.Append("<table>" + address_info.Trim)
                sOutString.Append("</table>")
            End If

            If bWordReport Then

                If Trim(fix_width) <> "840" Then
                    sOutString.Append("</td><td width='" & (CDbl(fix_width) * 0.4) & ")' cellpadding='5' valign='top'><font size='-1'>")
                Else
                    sOutString.Append("</td><td width='40%' cellpadding='5' valign='top'><font size='-1'>")
                End If

            Else
                sOutString.Append("</td><td width='40%' cellpadding='5' valign='top'><font>")
            End If

            sOutString.Append("<table align='right' valign='bottom'>")



            If check_prepared_for.Checked = True Then
                If prepared_for.Text <> "" Then
                    sOutString.Append("<tr><td nowrap='nowrap' align='right'><font size='-1'  face='sans-serif'><b>Prepared For: </b>" & Trim(prepared_for.Text) & "</font></td></tr>")

                    If Trim(image_ref) <> "" Then
                        image_ref = Replace(image_ref, "150", "120")
                    End If
                End If
            End If



            sOutString.Append("<tr><td align='right' nowrap='nowrap'><font face='sans-serif'>")

            If CInt(nAircraftID) > 0 Then
                Dim acInfoArray() As String = Split(commonEvo.GetAircraftInfo(nAircraftID, False), Constants.cSvrDataSeperator)

                If Not String.IsNullOrEmpty(acInfoArray(0).ToString) Then
                    sOutString.Append(acInfoArray(0).ToString & " ")
                End If

                If Not String.IsNullOrEmpty(acInfoArray(1).ToString) Then
                    sOutString.Append(acInfoArray(1).ToString)
                End If

                If Not chkBlindReport.Checked Then
                    If Not String.IsNullOrEmpty(acInfoArray(2).ToString) Then
                        sOutString.Append(" SN #" + acInfoArray(2).ToString)
                    End If
                End If

                sOutString.Append("</font>")
            End If

            sOutString.Append("</td></tr>")

            If bWordReport Then
                sOutString.Append("<tr><td align='right'><font size='-1' face='sans-serif'><i>" + Title.Trim + "</i></font></td></tr>")
            Else
                sOutString.Append("<tr><td align='right'><font face='sans-serif'><i>" + Title.Trim + "</i></font></td></tr>")
            End If

            If Not String.IsNullOrEmpty(image_ref.Trim) Then
                If bWordReport Then
                    sOutString.Append("<tr><td width='150' align='right'>" + image_ref.Trim + "</td></tr>")
                Else
                    sOutString.Append("<tr><td width='150' align='right'>" + image_ref.Trim + "</td></tr>")
                End If
            End If

            sOutString.Append("</table>")


            If bWordReport Then
                sOutString.Append("</td></tr></table></td></tr></table></td></tr><tr valign='top'><td width='550' valign='top' height='500'><table valign='top' cellpadding='0' cellspacing='0'>")
            Else
                sOutString.Append("</td></tr></table></td></tr></table></td></tr><tr valign='top'><td width='60%' height='900' valign='top'><table valign='top' cellpadding='0' cellspacing='0'>")
            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_page_header " + ex.Message
        Finally
            SqlReader = Nothing

            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing
        End Try

        Return (sOutString.ToString)

    End Function

    Public Function build_full_spec_engine_info(ByRef SqlReader As SqlClient.SqlDataReader) As String

        Dim xLoop As Integer = 0
        Dim nloopCount As Integer = 0

        Dim sAircraftType As String = ""
        Dim sAirframeType As String = ""
        Dim htmlOutput As String = ""
        Dim type_damage As String = ""

        Dim Query As String : Query = ""

        Dim SqlReader2 As SqlClient.SqlDataReader = Nothing
        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing

        Try

            If Not IsNothing(SqlReader) And SqlReader.HasRows Then

                If Not IsDBNull(SqlReader.Item("amod_airframe_type_code")) Then
                    sAirframeType = SqlReader.Item("amod_airframe_type_code").ToString.Trim.ToUpper
                End If
                If Not IsDBNull(SqlReader.Item("amod_type_code")) Then
                    sAircraftType = SqlReader.Item("amod_type_code").ToString.Trim.ToUpper
                End If

                htmlOutput += "<tr><td height='5'></td></tr>"

                htmlOutput += "<tr><td colspan='2' class='header_text'>Engine Information</td></tr>"
                htmlOutput += "<tr><td width='2%'>&nbsp;</td><td valign='middle'><font class='small_header_text'>Engine Model: "
                htmlOutput += "</font><font class='text_text'>" + SqlReader.Item("ac_engine_name").ToString.Trim + "&nbsp;</font>"


                If Not IsDBNull(SqlReader.Item("ac_engine_tbo_oc_flag")) Then
                    htmlOutput += "<font class='small_header_text'>, On&nbsp;Condition&nbsp;TBO: "
                    If SqlReader.Item("ac_engine_tbo_oc_flag").ToString.Trim.ToUpper.Contains("Y") Then
                        htmlOutput += "&nbsp;Yes</font></td>"
                    Else
                        htmlOutput += "&nbsp;No</font></td>"
                    End If
                End If

                htmlOutput += "</tr>" + vbCrLf
                htmlOutput += "<tr><td width='2%'>&nbsp;</td><td valign='middle' colspan='2' nowrap><font class='small_header_text'>Engine&nbsp;Maintenance&nbsp;Program:</font> "

                Query = "SELECT emp_name, emp_provider_name, emp_program_name FROM Engine_Maintenance_Program WITH(NOLOCK)"
                Query = Query & " WHERE emp_id = " + SqlReader.Item("ac_engine_maintenance_prog_EMP").ToString.Trim

                SqlConn.ConnectionString = localFunctions.clientConnectStr
                SqlConn.Open()

                SqlCommand.Connection = SqlConn
                SqlCommand.CommandType = CommandType.Text
                SqlCommand.CommandTimeout = 90

                SqlCommand.CommandText = Query
                SqlReader2 = SqlCommand.ExecuteReader()

                If SqlReader2.HasRows Then
                    SqlReader2.Read()
                    htmlOutput += "<font class='text_text'>"
                    htmlOutput += SqlReader2.Item("emp_provider_name").ToString.Trim + "&nbsp;-&nbsp;" + SqlReader2.Item("emp_program_name").ToString.Trim + "&nbsp;</font>"
                End If

                SqlReader2.Close()

                htmlOutput += "</td></tr>"

                htmlOutput += "<tr><td colspan='2'><table border='1' bordercolor='#949494' cellpadding='2' cellspacing='0'><tr>"
                htmlOutput += "<tr><td class='Normal'>&nbsp;</td>"
                htmlOutput += "<td class='text_text' align='center'><font size='-2'>Ser No</font></td>"
                htmlOutput += "<td class='text_text' align='center'><font size='-2'>Total Time<br/>Since New<br/>Hours</font></td>" ' (TTSNEW)
                htmlOutput += "<td class='text_text' align='center'><font size='-2'>Since Overhaul<br/>Hours</font></td>" ' (SOH/SCOR)
                htmlOutput += "<td class='text_text' align='center'><font size='-2'>Since Hot<br/>Inspection<br/>Hours</font></td>" '(SHI/SMPI)
                htmlOutput += "<td class='text_text' align='center'><font size='-2'>Time<br/>Between<br/>Overhaul<br/>Hours</font></td>" '(TBO/TBCI)
                htmlOutput += "<td class='text_text' align='center'><font size='-2'>Total<br/>Cycles<br/>Since New</font></td>"
                htmlOutput += "<td class='text_text' align='center'><font size='-2'>Total<br/>Cycles<br/>Since<br/>Overhaul</font></td>"
                htmlOutput += "<td class='text_text' align='center'><font size='-2'>Total<br/>Cycles<br/>Since Hot</font></td>"
                htmlOutput += "</tr>" + vbCrLf

                If sAirframeType <> "R" Then
                    nloopCount = 4
                Else
                    nloopCount = 3
                End If

                For xLoop = 1 To nloopCount

                    If (Not IsDBNull(SqlReader.Item("ac_engine_" + xLoop.ToString + "_tot_hrs")) Or
                        Not IsDBNull(SqlReader.Item("ac_engine_" + xLoop.ToString + "_soh_hrs")) Or
                        Not IsDBNull(SqlReader.Item("ac_engine_" + xLoop.ToString + "_shi_hrs")) Or
                        Not IsDBNull(SqlReader.Item("ac_engine_" + xLoop.ToString + "_tbo_hrs")) Or
                        Not IsDBNull(SqlReader.Item("ac_engine_" + xLoop.ToString + "_snew_cycles")) Or
                        Not IsDBNull(SqlReader.Item("ac_engine_" + xLoop.ToString + "_soh_cycles")) Or
                        Not IsDBNull(SqlReader.Item("ac_engine_" + xLoop.ToString + "_shs_cycles"))) Then

                        If xLoop = 1 And sAirframeType <> "R" Then
                            htmlOutput += "<tr><td class='text_text' valign='middle' align='right' nowrap><font size='-2'>Eng&nbsp;" + xLoop.ToString + "&nbsp;(L)&nbsp;</td>"
                        ElseIf xLoop = 2 And sAirframeType <> "R" Then
                            htmlOutput += "<tr><td class='text_text' valign='middle' align='right' nowrap><font size='-2'>Eng&nbsp;" + xLoop.ToString + "&nbsp;(R)&nbsp;</td>"
                        ElseIf xLoop = 3 And sAirframeType <> "R" Then
                            htmlOutput += "<tr><td class='text_text' valign='middle' align='right' nowrap><font size='-2'>Eng&nbsp;" + xLoop.ToString + "&nbsp;(L)&nbsp;</td>"
                        ElseIf xLoop = 4 And sAirframeType <> "R" Then
                            htmlOutput += "<tr><td class='text_text' valign='middle' align='right' nowrap><font size='-2'>Eng&nbsp;" + xLoop.ToString + "&nbsp;(R)&nbsp;</td>"
                        Else
                            htmlOutput += "<tr><td class='text_text' valign='middle' align='right' nowrap><font size='-2'>Eng&nbsp;" + xLoop.ToString + "&nbsp;</td>"
                        End If

                        htmlOutput += "<td class='text_text' valign='middle' align='left'><font size='-2'>&nbsp;" + SqlReader.Item("ac_engine_" + xLoop.ToString + "_ser_no").ToString + "</td>"

                        If Not IsDBNull(SqlReader.Item("ac_engine_" + xLoop.ToString + "_tot_hrs")) Then
                            htmlOutput += "<td class='text_text' valign='middle' align='left'><font size='-2'>&nbsp;" + FormatNumber(CDbl(SqlReader.Item("ac_engine_" + xLoop.ToString + "_tot_hrs").ToString), 0, True, False, True) + "</td>"
                        Else
                            htmlOutput += "<td class='text_text' valign='middle' align='left'>&nbsp;</td>"
                        End If

                        If Not IsDBNull(SqlReader.Item("ac_engine_" + xLoop.ToString + "_soh_hrs")) Then
                            htmlOutput += "<td class='text_text' valign='middle' align='left'><font size='-2'>&nbsp;" + FormatNumber(CDbl(SqlReader.Item("ac_engine_" + xLoop.ToString + "_soh_hrs").ToString), 0, True, False, True) + "</td>"
                        Else
                            htmlOutput += "<td class='text_text' valign='middle' align='left'>&nbsp;</td>"
                        End If

                        If Not IsDBNull(SqlReader.Item("ac_engine_" + xLoop.ToString + "_shi_hrs")) Then
                            htmlOutput += "<td class='text_text' valign='middle' align='left'><font size='-2'>&nbsp;" + FormatNumber(CDbl(SqlReader.Item("ac_engine_" + xLoop.ToString + "_shi_hrs").ToString), 0, True, False, True) + "</td>"
                        Else
                            htmlOutput += "<td class='text_text' valign='middle' align='left'>&nbsp;</td>"
                        End If

                        If Not IsDBNull(SqlReader.Item("ac_engine_" + xLoop.ToString + "_tbo_hrs")) Then
                            htmlOutput += "<td class='text_text' valign='middle' align='left'><font size='-2'>&nbsp;" + FormatNumber(CDbl(SqlReader.Item("ac_engine_" + xLoop.ToString + "_tbo_hrs").ToString), 0, True, False, True) + "</td>"
                        Else
                            htmlOutput += "<td class='text_text' valign='middle' align='left'>&nbsp;</td>"
                        End If

                        If Not IsDBNull(SqlReader.Item("ac_engine_" + xLoop.ToString + "_snew_cycles")) Then
                            htmlOutput += "<td class='text_text' valign='middle' align='left'><font size='-2'>&nbsp;" + FormatNumber(CDbl(SqlReader.Item("ac_engine_" + xLoop.ToString + "_snew_cycles").ToString), 0, True, False, True) + "</td>"
                        Else
                            htmlOutput += "<td class='text_text' valign='middle' align='left'>&nbsp;</td>"
                        End If

                        If Not IsDBNull(SqlReader.Item("ac_engine_" + xLoop.ToString + "_soh_cycles")) Then
                            htmlOutput += "<td class='text_text' valign='middle' align='left'><font size='-2'>&nbsp;" + FormatNumber(CDbl(SqlReader.Item("ac_engine_" + xLoop.ToString + "_soh_cycles").ToString), 0, True, False, True) + "</td>"
                        Else
                            htmlOutput += "<td class='text_text' valign='middle' align='left'>&nbsp;</td>"
                        End If

                        If Not IsDBNull(SqlReader.Item("ac_engine_" + xLoop.ToString + "_shs_cycles")) Then
                            htmlOutput += "<td class='text_text' valign='middle' align='left'><font size='-2'>&nbsp;" + FormatNumber(CDbl(SqlReader.Item("ac_engine_" + xLoop.ToString + "_shs_cycles").ToString), 0, True, False, True) + "</td>"
                        Else
                            htmlOutput += "<td class='text_text' valign='middle' align='left'>&nbsp;</td>"
                        End If

                        htmlOutput += "</tr>" + vbCrLf

                    End If

                Next ' xLoop

                htmlOutput += "</table>" + vbCrLf
                htmlOutput += "</td></tr>"

            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_engine_info " + ex.Message
        Finally

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOutput

    End Function

    Public Function build_full_spec_heli_details(ByVal nAircraftID As Long, ByVal nAircraftJournalID As Long)

        Dim Query As String = ""
        Dim htmlOutput As String = ""
        Dim bHasMainBlades As Boolean = False
        Dim bHasTailBlades As Boolean = False
        Dim sLabel As String = ""

        Dim SqlReader As SqlClient.SqlDataReader = Nothing
        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing

        Try

            Query = "SELECT * FROM Helicopter_Detail_Times WITH(NOLOCK) WHERE heldt_ac_id = " + nAircraftID.ToString
            Query = Query & " AND heldt_journ_id = " + nAircraftJournalID.ToString

            SqlConn.ConnectionString = localFunctions.clientConnectStr
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = Query
            SqlReader = SqlCommand.ExecuteReader()

            If SqlReader.HasRows Then

                htmlOutput = "<table>"
                htmlOutput += "<tr><td>&nbsp;</td></tr>"
                htmlOutput += "<tr><td width='2%'>&nbsp;</td>"
                htmlOutput += "<td valign='top'>"

                htmlOutput += "<table border='1' bordercolor='#949494' cellpadding='2' cellspacing='0'><tr>"
                htmlOutput += "<tr><th class='text_text' colspan='8'><strong>GEARBOX/ROTOR BLADE INFORMATION</strong></td></tr>"
                htmlOutput += "<tr><td class='Normal'>&nbsp;</td><td class='Normal'>&nbsp;</td>"
                htmlOutput += "<th class='text_text' align='center'><font size='-2'>Serial Number</font></td>"
                htmlOutput += "<th class='text_text' align='center'><b>TTSN:</b></td>"
                htmlOutput += "<th class='text_text' align='center'><b>Time Remaining:</b></td>"
                htmlOutput += "<th class='text_text' align='center'><b>TSOH:</b></td></tr>"

                Do While SqlReader.Read

                    If Not IsDBNull(SqlReader.Item("heldt_category_type")) And Not String.IsNullOrEmpty(SqlReader.Item("heldt_category_type").ToString.Trim) Then
                        Select Case SqlReader.Item("heldt_category_type").ToString.ToUpper.Trim
                            Case "INTERMEDIATE GEARBOX"
                                bHasMainBlades = False
                                bHasTailBlades = False
                                sLabel = "Intermediate&nbsp;Gearbox"
                            Case "MAIN ROTOR #1 BLADES", "MAIN ROTOR #2 BLADES"
                                ' Check for number of blades
                                sLabel = "Main&nbsp;Blade&nbsp;"
                                bHasMainBlades = True
                                bHasTailBlades = False
                                ' OK Get the Blade Number 1-10
                                sLabel = sLabel & Right(Trim(SqlReader.Item("heldt_subcat_type").ToString), 2)
                            Case "MAIN ROTOR HUB #1", "MAIN ROTOR HUB #2"
                                bHasMainBlades = False
                                bHasTailBlades = False
                                sLabel = "Main&nbsp;Rotor&nbsp;Hub"
                            Case "MAIN TRANSMISSION #1", "MAIN TRANSMISSION #2"
                                bHasMainBlades = False
                                bHasTailBlades = False
                                sLabel = "Main&nbsp;Transmission"
                            Case "TAIL ROTOR BLADES"
                                ' Check for number of blades
                                sLabel = "Tail&nbsp;Blade&nbsp;"
                                bHasMainBlades = False
                                bHasTailBlades = True
                                ' OK Get the Blade Number 1-10
                                sLabel = sLabel & Right(Trim(SqlReader.Item("heldt_subcat_type").ToString), 2)
                            Case "TAIL ROTOR GEARBOX"
                                bHasMainBlades = False
                                bHasTailBlades = False
                                sLabel = "Tail&nbsp;Rotor&nbsp;Gearbox"
                            Case "TAIL ROTOR HUB"
                                bHasMainBlades = False
                                bHasTailBlades = False
                                sLabel = "Tail&nbsp;Rotor&nbsp;Hub"
                        End Select
                    End If

                    If Not IsDBNull(SqlReader.Item("heldt_ttsn")) Or Not IsDBNull(SqlReader.Item("heldt_remaining_hours")) Or Not IsDBNull(SqlReader.Item("heldt_soh")) Then
                        htmlOutput += "<tr id='TR_Prop_Info'>" ' TR_Prop_Info
                        htmlOutput += "<td nowrap>&nbsp;</td>"
                        htmlOutput += "<th class='small_header_text'>&nbsp;" + sLabel + "&nbsp;&nbsp;</td>"

                        If Not IsDBNull(SqlReader("heldt_ser_no_full")) Then
                            htmlOutput += "<td align='center' class='text_text'>" + SqlReader.Item("heldt_ser_no_full").ToString + "</td>"
                        Else
                            htmlOutput += "<td>&nbsp;</td>"
                        End If

                        If Not IsDBNull(SqlReader("heldt_ttsn")) Then
                            htmlOutput += "<td align='center' class='text_text'>" + FormatNumber(CDbl(SqlReader.Item("heldt_ttsn").ToString), 0, True, False, True) + "</td>"
                        Else
                            htmlOutput += "<td>&nbsp;</td>"
                        End If
                        If Not IsDBNull(SqlReader("heldt_remaining_hours")) Then
                            htmlOutput += "<td align='center' class='text_text'>" + FormatNumber(CDbl(SqlReader.Item("heldt_remaining_hours").ToString), 0, True, False, True) + "</td>"
                        Else
                            htmlOutput += "<td>&nbsp;</td>"
                        End If
                        If Not IsDBNull(SqlReader("heldt_soh")) And (Not bHasMainBlades Or Not bHasTailBlades) Then
                            htmlOutput += "<td align='center' class='text_text'>" + FormatNumber(CDbl(SqlReader.Item("heldt_soh").ToString), 0, True, False, True) + "</td></tr>"
                        Else
                            htmlOutput += "<td>&nbsp;</td>"
                        End If
                        htmlOutput += "</tr>"
                    End If

                Loop
                htmlOutput += "</table>" ' Prop_Information_Mini_Table

            End If

            SqlReader.Close()

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_heli_details " + ex.Message
        Finally

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOutput

    End Function

    Public Function build_full_spec_company_contact_phone(ByVal comp_id As Long, ByVal contact_id As Long) As String

        Dim htmlOutput As String = ""
        Dim sQuery = New StringBuilder()

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader = Nothing
        Dim SqlException As SqlClient.SqlException = Nothing

        Try

            sQuery.Append("SELECT DISTINCT pnum_type, pnum_number_full FROM Phone_Numbers WHERE pnum_contact_id = " + contact_id.ToString + " AND pnum_comp_id = " + comp_id.ToString + "AND pnum_journ_id = 0 AND pnum_hide_customer = 'N'")
            sQuery.Append(" ORDER BY pnum_type desc")

            SqlConn.ConnectionString = localFunctions.clientConnectStr
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString
            SqlReader = SqlCommand.ExecuteReader()

            If SqlReader.HasRows Then
                Do While SqlReader.Read
                    htmlOutput += SqlReader.Item("pnum_type").ToString.Trim + " : " + SqlReader.Item("pnum_number_full").ToString.Trim + "<br />"
                Loop
            End If

            SqlReader.Close()

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in ac_phone_company_contact_info()" + ex.Message
        Finally

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing


            SqlReader = Nothing
        End Try

        Return htmlOutput

    End Function

    Public Function build_full_spec_airport_information(ByRef SQLReader As SqlClient.SqlDataReader) As String

        Dim htmlOutput As String = ""

        Try

            If chkIncludeBaseLocation.Checked Then

                If Not IsNothing(SQLReader) And SQLReader.HasRows Then

                    htmlOutput += "<br /><table width='70%' cellspacing='0' cellpadding='4'><tr><td valign='middle' align='left' class='white_feat_header_text'>Airport Information</td></tr>"
                    htmlOutput += "<tr><td class='white_feat_text'>"

                    If Not IsDBNull(SQLReader.Item("ac_aport_iata_code")) Then
                        htmlOutput += SQLReader.Item("ac_aport_iata_code").ToString.Trim
                    End If

                    If Not IsDBNull(SQLReader.Item("ac_aport_icao_code")) Then
                        htmlOutput += " - " + SQLReader.Item("ac_aport_icao_code").ToString.Trim
                    End If

                    If Not IsDBNull(SQLReader.Item("ac_aport_name")) Then
                        htmlOutput += " - " + SQLReader.Item("ac_aport_name").ToString.Trim
                    End If

                    If Not IsDBNull(SQLReader.Item("ac_aport_city")) Then
                        htmlOutput += "<br />" + SQLReader.Item("ac_aport_city").ToString.Trim
                    End If

                    If Not IsDBNull(SQLReader.Item("ac_aport_state")) Then
                        htmlOutput += " - " + SQLReader.Item("ac_aport_state").ToString.Trim
                    End If

                    If Not IsDBNull(SQLReader.Item("ac_aport_country")) Then
                        htmlOutput += " - " + SQLReader.Item("ac_aport_country").ToString.Trim
                    End If
                    htmlOutput += "</td></tr></table>"

                End If
            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_airport_information()" + ex.Message
        End Try

        Return htmlOutput

    End Function

    Public Function build_full_spec_aircraft_features(ByVal nAircraftID As Long, ByRef SqlCommand As SqlClient.SqlCommand, ByRef SQLReader As SqlClient.SqlDataReader, ByVal from_report As Long) As String

        Dim htmlOutput As New StringBuilder()
        Dim type_damage As String = ""
        Dim counter As Integer = 0
        Dim sQuery As New StringBuilder()
        Dim atemptable As New DataTable

        Try

            sQuery.Append("SELECT ")
            sQuery.Append(" Aircraft_Key_Feature.afeat_status_flag, Key_Feature.kfeat_name FROM Aircraft_Key_Feature INNER JOIN Key_Feature ON Aircraft_Key_Feature.afeat_feature_code = Key_Feature.kfeat_code ")
            sQuery.Append("WHERE (Aircraft_Key_Feature.afeat_ac_id = " + nAircraftID.ToString + ") AND (Aircraft_Key_Feature.afeat_journ_id = " & nAircraftJournalID_Full & ") ")

            If from_report = 54 Then
                sQuery.Append(" and Aircraft_Key_Feature.afeat_status_flag = 'Y' ")
            End If
            sQuery.Append(" ORDER BY Aircraft_Key_Feature.afeat_seq_no")

            SqlCommand.CommandText = sQuery.ToString
            SQLReader = SqlCommand.ExecuteReader()

            Try
                atemptable.Load(SQLReader)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
            End Try

            If atemptable.Rows.Count > 0 Then

                If from_report = 53 Then
                    htmlOutput.Append("<table width='70%' align='center' cellspacing='0' cellpadding='4'>")
                    htmlOutput.Append("<tr><td valign='middle' align='left' class='white_feat_header_text' colspan='2'>Key Features</td></tr>")
                End If

                Session("Damage_History") = ""
                If from_report = 54 Then
                    htmlOutput.Append("<tr>")
                End If

                'Do While SQLReader.Read
                For Each r As DataRow In atemptable.Rows

                    'ADDED MSW - 3/15/16 - 

                    If from_report = 54 Then
                        If counter = 2 And atemptable.Rows.Count > 10 Then
                            counter = 0
                            htmlOutput.Append("</tr><tr>")
                        ElseIf atemptable.Rows.Count < 11 Then
                            htmlOutput.Append("</tr><tr>")
                        End If


                        If r("afeat_status_flag").ToString = "Y" Then
                            counter += 1
                            htmlOutput.Append("<td width=""50%"">" + r("kfeat_name").ToString.Trim & "</td>")
                        End If
                    Else
                        If r("afeat_status_flag").ToString = "Y" Then
                            If r("kfeat_name").ToString = "Damage History" Then
                                Session("Damage_History") = "<tr><td width='2%'>&nbsp;</td><td><font class='small_header_text2'>Damage History: </font><font class='text_text2'>Y</font></td></tr>"
                            Else
                                htmlOutput.Append("<tr><td class='white_feat_text' valign='middle' align='left' width='2%'>&#10003;</td>")
                                htmlOutput.Append("<td class='white_feat_text' valign='middle' align='left'>" + r("kfeat_name").ToString.Trim + type_damage + "</td></tr>")
                            End If
                        End If
                    End If

                Next

                If from_report = 53 Then
                    htmlOutput.Append("</table>")
                End If

            End If
            atemptable.Dispose()
            SQLReader.Close()

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_aircraft_features()" + ex.Message
        End Try

        Return htmlOutput.ToString

    End Function

    Public Function build_full_spec_transactions_page(ByVal nAircraftID As Long, ByVal nYachtID As Long) As String

        Dim sQuery = New StringBuilder()
        Dim outString As New StringBuilder()
        Dim something_shown As Boolean = False

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader = Nothing
        Dim SqlException As SqlClient.SqlException = Nothing
        Dim SqlDatatable As New DataTable

        Dim toggleRowColor As Boolean = False
        Dim sRowColor As String = ""
        Dim excludeONOFFmarket As String = ""

        Try

            If nAircraftID > 0 And nYachtID = 0 Then

                'ac history
                sQuery.Append("SELECT journ_id, journ_ac_id, journ_date, journ_subject, jcat_subcategory_name, jcat_auto_subject_flag, journ_subcategory_code, journ_customer_note")
                sQuery.Append(" FROM Journal WITH(NOLOCK) INNER JOIN Journal_Category WITH(NOLOCK) ON journ_subcategory_code = jcat_subcategory_code")
                sQuery.Append(" WHERE jcat_category_code = 'AH' AND RIGHT(journ_subcategory_code, 4) <> 'CORR'")

                If bAerodexFlag Then excludeONOFFmarket = ",'OM','MA'"

                sQuery.Append(" AND journ_subcategory_code NOT IN ('IN','DM','EXOFF','EXON'" + excludeONOFFmarket + ")")
                sQuery.Append(" AND journ_ac_id = " + nAircraftID.ToString)

                If nAircraftJournalID_Full > 0 Then
                    sQuery.Append(" AND journ_id = " + nAircraftJournalID_Full.ToString)
                End If

                sQuery.Append(" ORDER BY journ_date DESC, journ_id DESC")

            ElseIf nAircraftID = 0 And nYachtID > 0 Then

                ' yacht history
                sQuery.Append("SELECT journ_id, journ_ac_id, journ_date, journ_subject, jcat_subcategory_name, jcat_auto_subject_flag, journ_subcategory_code, journ_customer_note")
                sQuery.Append(" FROM Journal WITH(NOLOCK) INNER JOIN Journal_Category WITH(NOLOCK) ON journ_subcategory_code = jcat_subcategory_code")
                sQuery.Append(" WHERE jcat_category_code = 'AH' AND RIGHT(journ_subcategory_code, 4) <> 'CORR'")
                sQuery.Append(" and journ_id = " & yacht_journal_id & " ")


                If bAerodexFlag Then excludeONOFFmarket = ",'OM','MA'"

                sQuery.Append(" AND journ_subcategory_code NOT IN ('IN','DM','EXOFF','EXON'" + excludeONOFFmarket + ")")
                sQuery.Append(" AND journ_yt_id = " + nYachtID.ToString)

                sQuery.Append(" ORDER BY journ_date DESC, journ_id DESC")

            End If

            SqlConn.ConnectionString = localFunctions.clientConnectStr
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString
            SqlReader = SqlCommand.ExecuteReader()

            Try
                SqlDatatable.Load(SqlReader)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = SqlDatatable.GetErrors()
            End Try

            outString.Append("<br /><table width='100%' cellspacing='0' cellpadding='4' border='0'>")
            outString.Append("<tr><td align='center' class='header_text'>Transaction Date</td><td align='center' class='header_text'>Type</td><td align='center' class='header_text'>Description</td></tr>")

            If Not IsNothing(SqlDatatable) Then

                If SqlDatatable.Rows.Count > 0 Then

                    For Each Row As DataRow In SqlDatatable.Rows

                        If Not toggleRowColor Then
                            sRowColor = "<tr bgcolor='#E6E6E6'>"
                            toggleRowColor = True
                        Else
                            sRowColor = "<tr bgcolor='white'>"
                            toggleRowColor = False
                        End If

                        outString.Append(sRowColor)
                        outString.Append("<td align='left' valign='middle'><font class='text_text'>" + FormatDateTime(Row.Item("journ_date").ToString, DateFormat.ShortDate) + "</font></td>")
                        outString.Append("<td align='left' valign='middle'><font class='text_text'>" + Row.Item("jcat_subcategory_name").ToString.Trim + "</font></td>")

                        If Row.Item("jcat_auto_subject_flag").ToString.ToUpper.Contains("Y") Then
                            outString.Append("<td align='left' valign='middle'><font class='text_text'>" + Row.Item("jcat_subcategory_name").ToString.Trim)

                            If Row.Item("jcat_subcategory_name").ToString.ToLower.Contains("fractional sale") Then
                                Dim sFractionPercent As String = ""
                                Dim sFractionExpiresDate As String = ""

                                localFunctions.get_fraction_percent_and_expire_date(CLng(Row.Item("journ_id").ToString), True, sFractionPercent, sFractionExpiresDate)
                                outString.Append(Constants.cSingleSpace + sFractionPercent)

                            End If

                            outString.Append(" - " + Server.HtmlEncode(Row.Item("journ_subject").ToString.Trim) + "</font></td></tr>")
                        Else
                            outString.Append("<td align='left' valign='middle'><font class='text_text'>" + Server.HtmlEncode(Row.Item("journ_subject").ToString.Trim) + "</font></td></tr>")
                        End If

                        If Not IsDBNull(Row.Item("journ_customer_note")) Then
                            If Not String.IsNullOrEmpty(Row.Item("journ_customer_note").ToString.Trim) Then
                                outString.Append(sRowColor)
                                outString.Append("<td align='right' valign='middle' colspan='2'>&nbsp;</td><td align='left' valign='middle'><font class='small_header_text'>Transaction Notes : </font>")
                                outString.Append("<font class='small_header_text'>" + Server.HtmlEncode(Row.Item("journ_customer_note").ToString.Trim) + "</font></td></tr>")
                            End If
                        End If

                    Next

                    something_shown = True

                End If

            End If

            If Not something_shown Then
                outString.Append("<tr><td valign='middle' align='center' class='text_text'> No Transactions Currently Available </td></tr>")
            End If

            outString.Append("</table>")

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_transactions_page()" + ex.Message
        Finally

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

            SqlReader.Close()

            SqlReader = Nothing

        End Try

        Return outString.ToString

        outString = Nothing

    End Function

#End Region

#Region "report_42_functions"

    Public Function create_report_42_export_current_yacht_events_list(ByRef record_count As Long) As String

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim report_42_datatable As New DataTable

        Dim adoRS_42 As System.Data.SqlClient.SqlDataReader : adoRS_42 = Nothing

        Dim htmlOut = New StringBuilder()
        Dim sQuery As New StringBuilder()

        Try

            SqlConn.ConnectionString = localFunctions.clientConnectStr

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text     '
            SqlCommand.CommandTimeout = 90

            sQuery.Append("SELECT * FROM Yacht_Priority_Events WITH(NOLOCK)")
            sQuery.Append(" INNER JOIN Yacht_Priority_Events_Category WITH(NOLOCK) ON ype_category_code = ypec_category_code")

            'If PreviousName Then
            '  Query = Query & " left outer join Yacht_Previous_Names WITH(NOLOCK) "
            '  Query = Query & " on ypn_yt_id = yt_id"
            'End If

            sQuery.Append(" LEFT OUTER JOIN Yacht WITH(NOLOCK) ON (ype_yt_id = yt_id and yt_journ_id = 0)")
            sQuery.Append(" LEFT OUTER JOIN Yacht_Model WITH(NOLOCK) ON (yt_model_id = ym_model_id)")
            sQuery.Append(" " + HttpContext.Current.Session.Item("MasterYachtEventsWhere").ToString.Trim)
            sQuery.Append(" ORDER BY ym_brand_name, ym_motor_type, ym_category_size, ym_model_id, ym_model_name, yt_hull_mfr_nbr")

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />Create_Report_42_Export_Current_Yacht_Events_List()<br />" + sQuery.ToString

            If bHtmlReport Then
                htmlOut.Append("<!DOCTYPE html>")
                htmlOut.Append("<html lang='en'>")
                htmlOut.Append("<head>")
                htmlOut.Append("<meta http-equiv='Content-Language' content='en-us' />")
                htmlOut.Append("<meta http-equiv='Content-Type' content='text/html; charset=windows-1252' />")
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='common/jetnet.css' />")
                htmlOut.Append("<title>YACHTSPOT - Export of Current Events List</title>")
                htmlOut.Append("</head>")
                htmlOut.Append("<body style='background: white; margin-top:10px; margin-left:10px;'>")
                htmlOut.Append("<div style='text-align:center;'>")
            End If

            If bExcelReport Then
                htmlOut.Append("<table border='1' cellpadding='2' cellspacing='0'>")
            ElseIf bHtmlReport Then
                htmlOut.Append("<table class='centerTable' border='0' cellpadding='2' cellspacing='0' width='100%'>")
            End If

            SqlCommand.CommandText = sQuery.ToString
            adoRS_42 = SqlCommand.ExecuteReader()

            Try
                report_42_datatable.Load(adoRS_42)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = report_42_datatable.GetErrors()
            End Try

            record_count = report_42_datatable.Rows.Count

            adoRS_42.Close()
            adoRS_42 = Nothing

            If report_42_datatable.Rows.Count > 0 Then

                If chkShowReportHeader.Checked Then

                    If bExcelReport Or bHtmlReport Then

                        htmlOut.Append("<tr bgcolor='#CCCCCC'>")

                        htmlOut.Append("<td>BRAND</td>")
                        htmlOut.Append("<td>MODEL</td>")
                        htmlOut.Append("<td>NAME</td>")
                        htmlOut.Append("<td>CALLSIGN</td>")
                        htmlOut.Append("<td>HULLNBR</td>")
                        htmlOut.Append("<td>EVENT DATE/TIME</td>")
                        htmlOut.Append("<td align='center'>DESCRIPTION</td>")

                        htmlOut.Append("</tr>")

                    ElseIf bTextCommaReport Then

                        htmlOut.Append(Constants.QUOTE + "BRAND" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "MODEL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "NAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "CALLSIGN" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "HULLNBR" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "EVENT DATE/TIME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "DESCRIPTION" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(vbCrLf)

                    ElseIf bTextTabReport Then

                        htmlOut.Append("MAKE" + vbTab)
                        htmlOut.Append("BRAND" + vbTab)
                        htmlOut.Append("NAME" + vbTab)
                        htmlOut.Append("CALLSIGN" + vbTab)
                        htmlOut.Append("HULLNBR" + vbTab)
                        htmlOut.Append("EVENT DATE/TIME" + vbTab)
                        htmlOut.Append("DESCRIPTION" + vbTab)

                        htmlOut.Append(vbCrLf)

                    End If

                End If ' chkShowReportHeader.Checked Then

                For Each Row As DataRow In report_42_datatable.Rows

                    If bHtmlReport Or bExcelReport Then

                        htmlOut.Append("<tr>")

                        If Not IsDBNull(Row.Item("ype_yt_id")) Then
                            If IsNumeric(Row.Item("ype_yt_id").ToString) Then
                                If CLng(Row.Item("ype_yt_id").ToString) > 0 Then

                                    htmlOut.Append("<td align='left' valign='middle'>" + Row.Item("ym_brand_name").ToString.Trim + "</td>")
                                    htmlOut.Append("<td align='left' valign='middle'>" + Row.Item("ym_model_name").ToString.Trim + "</td>")

                                    If Not (IsDBNull(Row.Item("yt_yacht_name"))) Then
                                        htmlOut.Append("<td align='left' valign='middle' class='textformat'>" + Row.Item("yt_yacht_name").ToString.Trim + "</td>")
                                    Else
                                        htmlOut.Append("<td align='left' valign='middle'></td>")
                                    End If

                                    If Not (IsDBNull(Row.Item("yt_radio_call_sign"))) Then
                                        htmlOut.Append("<td align='left' valign='middle' class='textformat'>" + Row.Item("yt_radio_call_sign").ToString.Trim + "</td>")
                                    Else
                                        htmlOut.Append("<td align='left' valign='middle'></td>")
                                    End If

                                    If Not (IsDBNull(Row.Item("yt_hull_mfr_nbr"))) Then
                                        htmlOut.Append("<td align='left' valign='middle' class='textformat'>" + Row.Item("yt_hull_mfr_nbr").ToString.Trim + "</td>")
                                    Else
                                        htmlOut.Append("<td align='left' valign='middle'></td>")
                                    End If

                                End If
                            End If
                        End If

                        If Not IsDBNull(Row.Item("ype_yt_id")) Then
                            If IsNumeric(Row.Item("ype_yt_id").ToString) Then
                                If CLng(Row.Item("ype_yt_id").ToString) = 0 Then
                                    htmlOut.Append("<td align='center' valign='middle' colspan='5' style='color: red;'>** Not Applicable **</td>")
                                End If
                            End If
                        End If

                        If Not (IsDBNull(Row.Item("ype_entered_date"))) Then
                            htmlOut.Append("<td align='left' valign='middle'>" + FormatDateTime(Row.Item("ype_entered_date").ToString, DateFormat.GeneralDate).Trim + "</td>")
                        Else
                            htmlOut.Append("<td align='left' valign='middle'></td>")
                        End If

                        If Not (IsDBNull(Row.Item("ype_subject"))) Then
                            htmlOut.Append("<td align='left' valign='middle'>" + Row.Item("ype_subject").ToString.Trim + "&nbsp;" + Row.Item("ype_description").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td align='left' valign='middle'></td>")
                        End If

                        htmlOut.Append("</tr>")

                    ElseIf bTextCommaReport Then

                        If Not IsDBNull(Row.Item("ype_yt_id")) Then
                            If IsNumeric(Row.Item("ype_yt_id").ToString) Then
                                If CLng(Row.Item("ype_yt_id").ToString) > 0 Then

                                    htmlOut.Append(Constants.QUOTE + Row.Item("ym_brand_name").ToString.Trim + Constants.QUOTE & Constants.cCommaDelim)
                                    htmlOut.Append(Constants.QUOTE + Row.Item("ym_model_name").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)

                                    If Not (IsDBNull(Row.Item("yt_yacht_name"))) Then
                                        htmlOut.Append(Constants.QUOTE + Row.Item("yt_yacht_name").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                                    Else
                                        htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                    End If

                                    If Not (IsDBNull(Row.Item("yt_radio_call_sign"))) Then
                                        htmlOut.Append(Constants.QUOTE + Row.Item("yt_radio_call_sign").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                                    Else
                                        htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                    End If

                                    If Not (IsDBNull(Row.Item("yt_hull_mfr_nbr"))) Then
                                        htmlOut.Append(Constants.QUOTE + Row.Item("yt_hull_mfr_nbr").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim)
                                    Else
                                        htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                    End If

                                End If
                            End If
                        End If

                        If Not IsDBNull(Row.Item("ype_yt_id")) Then
                            If IsNumeric(Row.Item("ype_yt_id").ToString) Then
                                If CLng(Row.Item("ype_yt_id").ToString) = 0 Then
                                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim +
                                 Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim +
                                 Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim +
                                 Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim +
                                 Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                                End If
                            End If
                        End If

                        If Not (IsDBNull(Row.Item("ype_entered_date"))) Then
                            htmlOut.Append(Constants.QUOTE + FormatDateTime(Row.Item("ype_entered_date").ToString, DateFormat.ShortDate).Trim + Constants.QUOTE + Constants.cCommaDelim)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        If Not (IsDBNull(Row.Item("ype_subject"))) Then
                            htmlOut.Append(Constants.QUOTE + Row.Item("ype_subject").ToString.Trim + " " + Row.Item("ype_description").ToString.Trim + Constants.QUOTE)
                        Else
                            htmlOut.Append(Constants.QUOTE + Constants.QUOTE)
                        End If

                        htmlOut.Append(vbCrLf)

                    ElseIf bTextTabReport Then

                        If Not IsDBNull(Row.Item("ype_yt_id")) Then
                            If IsNumeric(Row.Item("ype_yt_id").ToString) Then
                                If CLng(Row.Item("ype_yt_id").ToString) > 0 Then

                                    htmlOut.Append(Row.Item("ym_brand_name").ToString.Trim + vbTab)
                                    htmlOut.Append(Row.Item("ym_model_name").ToString.Trim + vbTab)

                                    If Not (IsDBNull(Row.Item("yt_yacht_name"))) Then
                                        htmlOut.Append(Row.Item("yt_yacht_name").ToString.Trim + vbTab)
                                    Else
                                        htmlOut.Append(vbTab)
                                    End If

                                    If Not (IsDBNull(Row.Item("yt_radio_call_sign"))) Then
                                        htmlOut.Append(Row.Item("yt_radio_call_sign").ToString.Trim + vbTab)
                                    Else
                                        htmlOut.Append(vbTab)
                                    End If

                                    If Not (IsDBNull(Row.Item("yt_hull_mfr_nbr"))) Then
                                        htmlOut.Append(Row.Item("yt_hull_mfr_nbr").ToString.Trim + vbTab)
                                    Else
                                        htmlOut.Append(vbTab)
                                    End If

                                End If
                            End If
                        End If

                        If IsDBNull(Row.Item("ype_yt_id")) Then
                            If IsNumeric(Row.Item("ype_yt_id").ToString) Then
                                If CLng(Row.Item("ype_yt_id").ToString) = 0 Then
                                    htmlOut.Append(vbTab + vbTab + vbTab + vbTab + vbTab)
                                End If
                            End If
                        End If

                        If Not (IsDBNull(Row.Item("ype_entered_date"))) Then
                            htmlOut.Append(FormatDateTime(Row.Item("ype_entered_date").ToString, DateFormat.GeneralDate).Trim + vbTab)
                        Else
                            htmlOut.Append(vbTab)
                        End If

                        If Not (IsDBNull(Row.Item("ype_subject"))) Then
                            htmlOut.Append(Row.Item("ype_subject").ToString.Trim + " " + Row.Item("ype_description").ToString.Trim)
                        End If

                        htmlOut.Append(vbCrLf)

                    End If

                Next

            End If

            If bHtmlReport Or bExcelReport Then
                htmlOut.Append("</table>")
            End If

            If bHtmlReport Then
                htmlOut.Append("</div>")
                htmlOut.Append("</body>")
                htmlOut.Append("</html>")
            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Create_Report_42_Export_Current_Yacht_Events_List()" + ex.Message
        Finally

            report_42_datatable = Nothing

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOut.ToString

    End Function

#End Region

#Region "report_43_functions"

    Public Function create_yacht_full_spec_sheet(ByVal item_string As Array, ByRef record_count As Long) As String

        Dim htmlOut = New StringBuilder()

        Try

            htmlOut.Append("<html><head><title>Yacht Full Spec Sheet</title>" + build_style_page_full_spec() + "</head>")

            htmlOut.Append("<body style='background: white; margin-top:10px; margin-left:10px;'>")
            htmlOut.Append("<div style='text-align:center;'>")

            For i As Integer = 0 To UBound(item_string)

                record_count = UBound(item_string)


                htmlOut.Append(build_full_spec_coverpage_yacht(CLng(item_string(i))))

                If chkSP_std.Checked Then
                    htmlOut.Append("<table width='100%' align='center' class='break'><tr><td>&nbsp;</td></tr></table>")
                    htmlOut.Append(build_full_spec_second_page_yacht(CLng(item_string(i))))
                End If

                If Not chkBlindReport.Checked Then
                    If chkTP_std.Checked Then
                        htmlOut.Append("<table width='100%' align='center' class='break'><tr><td>&nbsp;</td></tr></table>")
                        htmlOut.Append(build_full_spec_third_page_yacht(CLng(item_string(i))))
                    End If
                End If

                If chkIncludeHistory_std.Checked Then
                    htmlOut.Append("<table width='100%' align='center' class='break'><tr><td>&nbsp;</td></tr></table>")
                    htmlOut.Append(build_full_spec_fourth_page_yacht(CLng(item_string(i))))
                End If

                If chkIncludeNotes_std.Checked Then
                    htmlOut.Append("<table width='100%' align='center' class='break'><tr><td>&nbsp;</td></tr></table>")
                    htmlOut.Append(build_full_spec_notes_page_yacht(CLng(item_string(i))))
                End If

                'If chkIncludeHistory.Checked Then
                '  htmlOut.Append("<table width='100%' align='center' class='break'><tr><td>&nbsp;</td></tr></table>")
                '  htmlOut.Append(build_full_spec_transactions_page_yacht(CLng(item_string(i))))
                'End If

                If chkPP.Checked Then
                    htmlOut.Append("<table width='100%' align='center' class='break'><tr><td>&nbsp;</td></tr></table>")
                    htmlOut.Append(build_full_spec_pictures_page_yacht(CLng(item_string(i))))
                End If

                If UBound(item_string) > 0 Then
                    htmlOut.Append("<table width='100%' align='center' class='break'><tr><td>&nbsp;</td></tr></table>")
                End If

            Next

            htmlOut.Append("</div></body></html>")

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Create_Full_Spec_Sheet(ByVal number_ac As Integer, ByVal item_string As Array) As String" + ex.Message
        End Try

        Return htmlOut.ToString

        htmlOut = Nothing

    End Function

    Public Function build_full_spec_coverpage_yacht(ByVal nYachtID As Long) As String

        Dim refitted_by As String = ""

        Dim interior_redone As String = ""
        Dim exterior_redone As String = ""

        Dim list_date As String = ""
        Dim ac_status As String = ""
        Dim asking_type As String = ""
        Dim asking_price As String = ""

        Dim address_info As String = ""
        Dim logo_link As String = ""

        Dim confidential As String = ""
        Dim days_on_market As String = ""
        Dim font_size_for_address As String = ""

        Dim htmlOutput As New StringBuilder
        Dim sQuery As New StringBuilder

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader = Nothing
        Dim SqlException As SqlClient.SqlException = Nothing

        Try
            'SECTION 1 - COMPANY INFO ----------------------------------------------------------------------------------------------------------------------------------- 

            sQuery.Append("SELECT TOP 1 * FROM Company INNER JOIN Subscription ON comp_id = sub_comp_id AND comp_journ_id = 0")
            sQuery.Append(" WHERE sub_id = " + Session.Item("localUser").crmSubSubID.ToString)

            SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            SqlConn.Open()
            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString
            SqlReader = SqlCommand.ExecuteReader()

            If SqlReader.HasRows Then

                SqlReader.Read()

                If Not IsDBNull(SqlReader.Item("comp_address1")) And Not IsDBNull(SqlReader.Item("comp_address2")) Then
                    If (SqlReader.Item("comp_address1").ToString.Length + SqlReader.Item("comp_address2").ToString.Length) > 50 Then
                        font_size_for_address = "-2"
                    Else
                        font_size_for_address = "-1"
                    End If
                Else

                End If

                If Not IsDBNull(SqlReader.Item("comp_address1")) Then
                    If bWordReport Then
                        address_info = "<tr valign='top'><td class='white_feat_header_text'><font color='white' size='" + font_size_for_address + "'>" + SqlReader.Item("comp_address1").ToString
                    Else
                        address_info = "<tr valign='top'><td class='CompInfo'><font color='white'>" + SqlReader.Item("comp_address1").ToString + "</font>"
                    End If
                Else
                    If bWordReport Then
                        address_info = "<tr valign='top'><td class='white_feat_header_text'><font color='white' size='-1'>"
                    Else
                        address_info = "<tr valign='top'><td class='CompInfo'>"
                    End If

                End If

                If Not IsDBNull(SqlReader.Item("comp_logo_flag")) And logo_check.Checked Then
                    If SqlReader.Item("comp_logo_flag").ToString.ToUpper.Contains("Y") And logo_check.Checked Then

                        If HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then

                            If Not Application.Item("crmClientSiteData").crmClientHostName.ToString.ToUpper.Contains("NEWEVONET") Then
                                logo_link = "https://www.testjetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                            Else
                                logo_link = "http://www.jetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                            End If

                        Else
                            logo_link = Application.Item("crmClientSiteData").ClientFullHostName.ToString.Trim + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                        End If

                        logo_link = "<img src='" + logo_link + "/" + SqlReader.Item("comp_id").ToString + ".jpg' width='150'>"
                    ElseIf logo_check.Checked = True And invisible_label_parent_image.Text <> "" Then

                        If HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then

                            If Not Application.Item("crmClientSiteData").crmClientHostName.ToString.ToUpper.Contains("NEWEVONET") Then
                                logo_link = "https://www.testjetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                            Else
                                logo_link = "http://www.jetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                            End If

                        Else
                            logo_link = Application.Item("crmClientSiteData").ClientFullHostName.ToString.Trim + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                        End If

                        logo_link = "<img src='" + logo_link + "/" + invisible_label_parent_image.Text + ".jpg' width='150'>"
                    End If
                ElseIf logo_check.Checked = True And invisible_label_parent_image.Text <> "" Then

                    If HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then

                        If Not Application.Item("crmClientSiteData").crmClientHostName.ToString.ToUpper.Contains("NEWEVONET") Then
                            logo_link = "https://www.testjetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                        Else
                            logo_link = "http://www.jetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                        End If

                    Else
                        logo_link = Application.Item("crmClientSiteData").ClientFullHostName.ToString.Trim + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                    End If

                    logo_link = "<img src='" + logo_link + "/" + invisible_label_parent_image.Text + ".jpg' width='150'>"
                End If

                If Not IsDBNull(SqlReader.Item("comp_address2")) Then
                    address_info += "<font color='white'> . " + SqlReader.Item("comp_address2").ToString + "</font>"
                End If

                If font_size_for_address = "-2" Or Not String.IsNullOrEmpty(logo_link) Then
                    address_info += "<br />"
                End If

                If Not IsDBNull(SqlReader.Item("comp_city")) Then
                    address_info += "<font color='white'> " + SqlReader.Item("comp_city").ToString + "</font>"
                End If

                If Not IsDBNull(SqlReader.Item("comp_state")) Then
                    address_info += "<font color='white'>, " + SqlReader.Item("comp_state").ToString + "</font>"
                End If

                If Not IsDBNull(SqlReader.Item("comp_zip_code")) Then
                    address_info += "<font color='white'> " + SqlReader.Item("comp_zip_code").ToString + "</font>"
                End If

                address_info += "</td></tr>"

                address_info += build_phone_info_full_spec(CLng(Session.Item("localUser").crmSubSubID.ToString), "white")

                If Not IsDBNull(SqlReader.Item("comp_web_address")) Then
                    address_info += "<tr><td style='color: white;'> &#8226; "

                    If SqlReader.Item("comp_web_address").ToString.Trim.ToLower.Contains("www") Then
                        address_info += "<a href='http://" + SqlReader.Item("comp_web_address").ToString.Trim + "' target='new' style='color: white;'>" + SqlReader.Item("comp_web_address").ToString.Trim + "</a>"
                    Else
                        address_info += "<a href='" + SqlReader.Item("comp_web_address").ToString.Trim + "' target='new' style='color: white;'>" + SqlReader.Item("comp_web_address").ToString.Trim + "</a>"
                    End If

                    address_info += "</td></tr>"

                Else
                    address_info += "<tr><td>&nbsp;</td></tr>"
                End If

            End If

            SqlReader.Close()

            htmlOutput.Append(build_full_spec_yacht_header(nYachtID, "Yacht Information", address_info, logo_link))

            'SECTION 2  - Yacht INFO  -----------------------------------------------------------------------------------------------------------------------------------

            htmlOutput.Append("<tr><td height='5'></td></tr>")

            sQuery = New StringBuilder()

            sQuery.Append("SELECT *, (select yp_port_name from yacht_port where yp_id = yt_port_registered_id) as reg_port")
            sQuery.Append(" , (select yp_port_name from yacht_port where yp_id = yt_lying_port_id) as ly_port")
            sQuery.Append(" , (select yp_port_name from yacht_port where yp_id = yt_home_port_id) as home_port")
            sQuery.Append(" FROM Yacht WITH(NOLOCK) INNER JOIN Yacht_Model WITH(NOLOCK) ON ym_model_id = yt_model_id")
            sQuery.Append(" INNER JOIN yacht_category_size WITH(NOLOCK) ON (ycs_motor_type = ym_motor_type and ycs_category_size = ym_category_size)")
            sQuery.Append(" INNER JOIN yacht_classification_society_types WITH(NOLOCK) ON ycst_code = yt_class_id")

            If yacht_journal_id > 0 Then
                sQuery.Append("  inner join  journal  on  journ_yacht_id  = yt_id and journ_id = yt_journ_id  ")
            End If

            sQuery.Append(" WHERE yt_journ_id = " & yacht_journal_id & " AND yt_id = " + nYachtID.ToString)

            SqlCommand.CommandText = sQuery.ToString
            SqlReader = SqlCommand.ExecuteReader()

            If SqlReader.HasRows Then

                SqlReader.Read()

                htmlOutput.Append("<tr><td colspan='2' class='header_text'>Yacht Identification</b></font></td></tr>")

                htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='small_header_text'>Brand/Model&nbsp;:&nbsp;</font>")
                htmlOutput.Append("<font class='text_text'>")

                ' make
                If Not IsDBNull(SqlReader.Item("ym_brand_name")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("ym_brand_name").ToString.Trim) Then
                        htmlOutput.Append(SqlReader.Item("ym_brand_name").ToString.Trim)
                    End If
                End If

                ' model
                If Not IsDBNull(SqlReader.Item("ym_model_name")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("ym_model_name").ToString.Trim) Then
                        htmlOutput.Append("&nbsp;" + SqlReader.Item("ym_model_name").ToString.Trim)
                    End If
                End If

                htmlOutput.Append("</font></td></tr>")

                If Not IsDBNull(SqlReader.Item("yt_yacht_name")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_yacht_name").ToString.Trim) Then
                        htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='small_header_text'>Name&nbsp;:&nbsp;</font>")
                        htmlOutput.Append("<font class='text_text'>" + SqlReader.Item("yt_yacht_name").ToString + "</font></td></tr>")
                    End If
                End If

                ' year of manufacture
                If Not IsDBNull(SqlReader.Item("yt_year_mfr")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_year_mfr").ToString.Trim) Then
                        htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='small_header_text'>Year of Manufacture&nbsp;:&nbsp;</font>")
                        htmlOutput.Append("<font class='text_text'>" + SqlReader.Item("yt_year_mfr").ToString + "</font>")
                    End If

                    If Not IsDBNull(SqlReader.Item("yt_year_dlv")) Then
                        If Not String.IsNullOrEmpty(SqlReader.Item("yt_year_dlv").ToString.Trim) Then
                            htmlOutput.Append("<font class='small_header_text'>, Delivery&nbsp;:&nbsp;</font><font class='text_text'>" + SqlReader.Item("yt_year_dlv").ToString + "</font></td></tr>")
                        End If
                    End If

                    htmlOutput.Append("</td></tr>")
                Else

                    If Not IsDBNull(SqlReader.Item("yt_year_dlv")) Then
                        If Not String.IsNullOrEmpty(SqlReader.Item("yt_year_dlv").ToString.Trim) Then
                            htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='small_header_text'>Year Delivered&nbsp;:&nbsp;</font>")
                            htmlOutput.Append("<font class='text_text'>" + SqlReader.Item("yt_year_dlv").ToString + "</font></td></tr>")
                        End If
                    End If

                End If

                If Not IsDBNull(SqlReader.Item("yt_launch_date")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_launch_date").ToString.Trim) Then
                        If Year(SqlReader.Item("yt_launch_date").ToString) <> 1900 Then
                            htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='small_header_text'>Year Launched&nbsp;:&nbsp;</font>")
                            htmlOutput.Append("<font class='text_text'>" + Year(SqlReader.Item("yt_launch_date")).ToString + "</font></td></tr>")
                        End If
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("yt_hull_mfr_nbr")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_hull_mfr_nbr").ToString.Trim) Then
                        htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='small_header_text'>Hull #&nbsp;:&nbsp;</font>")
                        htmlOutput.Append("<font class='text_text'>" + SqlReader.Item("yt_hull_mfr_nbr").ToString + "</font></td></tr>")
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("yt_imo_nbr")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_imo_nbr").ToString.Trim) Then
                        htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='small_header_text'>IMO #&nbsp;:&nbsp;</font>")
                        htmlOutput.Append("<font class='text_text'>" + SqlReader.Item("yt_imo_nbr").ToString + "</font></td></tr>")
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("yt_hull_id_nbr")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_hull_id_nbr").ToString.Trim) Then
                        htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='small_header_text'>Hull ID #&nbsp;:&nbsp;</font>")
                        htmlOutput.Append("<font class='text_text'>" + SqlReader.Item("yt_hull_id_nbr").ToString + "</font></td></tr>")
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("yt_official_nbr")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_official_nbr").ToString.Trim) Then
                        htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='small_header_text'>Official #&nbsp;:&nbsp;</font>")
                        htmlOutput.Append("<font class='text_text'>" + SqlReader.Item("yt_official_nbr").ToString + "</font></td></tr>")
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("yt_mmsi_mobile_nbr")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_mmsi_mobile_nbr").ToString.Trim) Then
                        htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='small_header_text'>MMSI #&nbsp;:&nbsp;</font>")
                        htmlOutput.Append("<font class='text_text'>" + SqlReader.Item("yt_mmsi_mobile_nbr").ToString + "</font></td></tr>")
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("yt_radio_call_sign")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_radio_call_sign").ToString.Trim) Then
                        htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='small_header_text'>Call Sign&nbsp;:&nbsp;</font>")
                        htmlOutput.Append("<font class='text_text'>" + SqlReader.Item("yt_radio_call_sign").ToString + "</font></td></tr>")
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("yt_submotor_type")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_submotor_type").ToString.Trim) Then
                        htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='small_header_text'>Sub Type&nbsp;:&nbsp;</font>")
                        htmlOutput.Append("<font class='text_text'>" + SqlReader.Item("yt_submotor_type").ToString + "</font></td></tr>")
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("ycst_society_name")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("ycst_society_name").ToString.Trim) Then
                        htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='small_header_text'>Class&nbsp;:&nbsp;</font>")
                        htmlOutput.Append("<font class='text_text'>" + SqlReader.Item("ycst_society_name").ToString + "</font></td></tr>")
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("yt_registered_country_flag")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_registered_country_flag").ToString.Trim) Then
                        htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='small_header_text'>Flag State&nbsp;:&nbsp;</font>")
                        htmlOutput.Append("<font class='text_text'>" + SqlReader.Item("yt_registered_country_flag").ToString + "</font></td></tr>")
                    End If
                End If

                If Not bAerodexFlag Then

                    If Not IsDBNull(SqlReader.Item("yt_purchased_date")) Then
                        If Not String.IsNullOrEmpty(SqlReader.Item("yt_purchased_date").ToString.Trim) Then
                            htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='small_header_text'>Purchase Date&nbsp;:&nbsp;</font>")
                            htmlOutput.Append("<font class='text_text'>" + FormatDateTime(SqlReader.Item("yt_purchased_date"), DateFormat.ShortDate) + "</font>")
                        End If
                    End If

                End If

                If Not IsDBNull(SqlReader.Item("yt_vat_status")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_vat_status").ToString.Trim) Then
                        htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='small_header_text'>VAT&nbsp;:&nbsp;</font>")
                        htmlOutput.Append("<font class='text_text'>" + FormatDateTime(SqlReader.Item("yt_vat_status"), DateFormat.ShortDate) + "</font>")
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("yt_central_agent_flag")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_central_agent_flag").ToString.Trim) Then
                        If SqlReader.Item("yt_central_agent_flag").ToString.Trim.ToUpper.Contains("Y") Then
                            Select Case SqlReader.Item("yt_central_agent_flag").ToString.ToLower
                                Case "y"
                                    htmlOutput.Append("<tr><td width='2%'>&nbsp;</td>")
                                    htmlOutput.Append("<td nowrap='nowrap'><font class='small_header_text'>Central Agent?&nbsp;:&nbsp;</font><font class='text_text'>Yes</font></td></tr>")
                                Case "n"
                                    htmlOutput.Append("<tr><td width='2%'>&nbsp;</td>")
                                    htmlOutput.Append("<td nowrap='nowrap'><font class='small_header_text'>Central Agent?&nbsp;:&nbsp;</font><font class='text_text'>No</font></td></tr>")
                            End Select
                        End If
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("yt_not_in_usa_water")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_not_in_usa_water").ToString.Trim) Then
                        If SqlReader.Item("yt_not_in_usa_water").ToString.ToUpper.Contains("Y") Then
                            htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='small_header_text'>")
                            htmlOutput.Append("&#8226; Not available for sale or charter to US residents while in US waters")
                            htmlOutput.Append("</font></td></tr>")
                        End If
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("yt_lifecycle_id")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_lifecycle_id").ToString.Trim) Then 'yt_lifecycle_status

                        htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='small_header_text'>Life Cycle&nbsp;:&nbsp;</font>")

                        Select Case CInt(SqlReader.Item("yt_lifecycle_id").ToString.Trim)
                            Case 1
                                htmlOutput.Append("<font class='text_text'>In Production" + IIf(Not String.IsNullOrEmpty(SqlReader.Item("yt_lifecycle_status").ToString), ", " + SqlReader.Item("yt_lifecycle_status").ToString, "") + "</font>")
                            Case 2
                                htmlOutput.Append("<font class='text_text'>New Wtih Manufacturer" + IIf(Not String.IsNullOrEmpty(SqlReader.Item("yt_lifecycle_status").ToString), ", " + SqlReader.Item("yt_lifecycle_status").ToString, "") + "</font>")
                            Case 3
                                htmlOutput.Append("<font class='text_text'>In Operation" + IIf(Not String.IsNullOrEmpty(SqlReader.Item("yt_lifecycle_status").ToString), ", " + SqlReader.Item("yt_lifecycle_status").ToString, "") + "</font>")
                            Case 4
                                htmlOutput.Append("<font class='text_text'>Retired" + IIf(Not String.IsNullOrEmpty(SqlReader.Item("yt_lifecycle_status").ToString), ", " + SqlReader.Item("yt_lifecycle_status").ToString, "") + "</font>")
                        End Select

                        htmlOutput.Append("</td></tr>")

                    End If
                End If

                If Not IsDBNull(SqlReader.Item("yt_ownership_type")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_ownership_type").ToString.Trim) Then

                        htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='small_header_text'>Ownership&nbsp;:&nbsp;</font>")

                        Select Case SqlReader.Item("yt_ownership_type").ToString.ToLower
                            Case "w"
                                htmlOutput.Append("<font class='text_text'>Wholly Owned</font>")
                            Case "f"
                                htmlOutput.Append("<font class='text_text'>Fractional Ownership</font>")
                            Case "s"
                                htmlOutput.Append("<font class='text_text'>Shared Ownership</font>")
                        End Select

                        htmlOutput.Append("</td></tr>")

                    End If
                End If

                If Not bAerodexFlag Then

                    If Not IsDBNull(SqlReader.Item("yt_foreign_asking_price")) Then
                        If Not String.IsNullOrEmpty(SqlReader.Item("yt_foreign_asking_price").ToString.Trim) Then
                            If CLng(SqlReader.Item("yt_foreign_asking_price").ToString) > 0 Then

                                asking_price = "<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'>"
                                asking_price += "<font class='small_header_text'>Asking Amt ( " + SqlReader.Item("yt_foreign_currency_name").ToString
                                asking_price += " )&nbsp;:&nbsp;</font><font class='text_text'>" + FormatNumber(SqlReader.Item("yt_foreign_asking_price"), 0) + "</font></td></tr>"

                            End If
                        End If
                    End If

                    If Not IsDBNull(SqlReader.Item("yt_asking_price")) Then
                        If Not String.IsNullOrEmpty(SqlReader.Item("yt_asking_price").ToString.Trim) Then
                            If CLng(SqlReader.Item("yt_asking_price").ToString) > 0 Then
                                asking_price += "<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'>"
                                asking_price += "<font class='small_header_text'>Asking Amt&nbsp;:&nbsp;</font><font class='text_text'>$" + FormatNumber(SqlReader.Item("yt_asking_price"), 0) + "</font></td></tr>"
                            End If
                        End If
                    End If

                    If Not IsDBNull(SqlReader.Item("yt_forsale_status")) Then
                        If Not String.IsNullOrEmpty(SqlReader.Item("yt_forsale_status").ToString.Trim) Then

                            If SqlReader.Item("yt_forsale_flag").ToString.ToUpper.Contains("Y") And
                               SqlReader.Item("yt_for_lease_flag").ToString.ToUpper.Contains("Y") And
                               SqlReader.Item("yt_for_charter_flag").ToString.ToUpper.Contains("Y") Then
                                ac_status = "<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'>"
                                ac_status += "<font class='small_header_text'>Status&nbsp;:&nbsp;</font><font class='text_text'>For Sale/Lease/Charter</font></td></tr>"
                            ElseIf SqlReader.Item("yt_forsale_flag").ToString.ToUpper.Contains("Y") And
                                   SqlReader.Item("yt_for_lease_flag").ToString.ToUpper.Contains("Y") And
                                   SqlReader.Item("yt_for_charter_flag").ToString.ToUpper.Contains("N") Then
                                ac_status = "<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'>"
                                ac_status += "<font class='small_header_text'>Status&nbsp;:&nbsp;</font><font class='text_text'>For Sale/Lease</font></td></tr>"
                            ElseIf SqlReader.Item("yt_forsale_flag").ToString.ToUpper.Contains("Y") And
                                   SqlReader.Item("yt_for_lease_flag").ToString.ToUpper.Contains("N") And
                                   SqlReader.Item("yt_for_charter_flag").ToString.ToUpper.Contains("Y") Then
                                ac_status = "<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'>"
                                ac_status += "<font class='small_header_text'>Status&nbsp;:&nbsp;</font><font class='text_text'>For Sale/Charter</font></td></tr>"
                            ElseIf SqlReader.Item("yt_forsale_flag").ToString.ToUpper.Contains("N") And
                                   SqlReader.Item("yt_for_lease_flag").ToString.ToUpper.Contains("Y") And
                                   SqlReader.Item("yt_for_charter_flag").ToString.ToUpper.Contains("Y") Then
                                ac_status = "<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'>"
                                ac_status = "For Lease/Charter</font></td></tr>"
                            ElseIf SqlReader.Item("yt_forsale_flag").ToString.ToUpper.Contains("Y") Then
                                ac_status = "<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'>"
                                ac_status += "<font class='small_header_text'>Status&nbsp;:&nbsp;</font><font class='text_text'>For Sale</font></td></tr>"
                            ElseIf SqlReader.Item("yt_for_lease_flag").ToString.ToUpper.Contains("Y") Then
                                ac_status = "<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'>"
                                ac_status += "<font class='small_header_text'>Status&nbsp;:&nbsp;</font><font class='text_text'>For Lease</font></td></tr>"
                            ElseIf SqlReader.Item("yt_for_charter_flag").ToString.ToUpper.Contains("Y") Then
                                ac_status = "<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'>"
                                ac_status += "<font class='small_header_text'>Status&nbsp;:&nbsp;</font><font class='text_text'>For Charter</font></td></tr>"
                            End If

                        End If
                    End If


                    If Not IsDBNull(SqlReader.Item("yt_forsale_list_date")) And Not String.IsNullOrEmpty(SqlReader.Item("yt_forsale_list_date").ToString) Then
                        ac_status &= "<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'>"
                        ac_status &= "<font class='small_header_text'>Date Listed/Days on Market:&nbsp;</font><font class='text_text'>" & FormatDateTime(SqlReader.Item("yt_forsale_list_date").ToString, DateFormat.ShortDate) & "&nbsp;/&nbsp;" & DateDiff(DateInterval.Day, CDate(SqlReader.Item("yt_forsale_list_date").ToString), Date.Now()) & "</font></td></tr>"
                    End If




                    If Not IsDBNull(SqlReader.Item("yt_forsale_status")) Then
                        If Not String.IsNullOrEmpty(SqlReader.Item("yt_forsale_status").ToString.Trim) Then

                            If SqlReader.Item("yt_forsale_status").ToString.ToLower.Contains("for sale") Then
                                If Not IsDBNull(SqlReader.Item("yt_forsale_list_date")) Then
                                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_forsale_list_date").ToString.Trim) And Year(SqlReader.Item("yt_forsale_list_date").ToString) <> 1900 Then
                                        list_date = " ( Date Listed : " + FormatDateTime(SqlReader.Item("yt_forsale_list_date").ToString, DateFormat.ShortDate) + ")"
                                        days_on_market = DateDiff("d", CDate(SqlReader.Item("yt_forsale_list_date").ToString), Now()).ToString
                                    End If
                                End If
                            Else
                                asking_type = "<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'>"
                                asking_type += "<font class='small_header_text'>Asking Status&nbsp;:&nbsp;</font><font class='text_text'>" + SqlReader.Item("yt_forsale_status").ToString + "</font></td></tr>"
                            End If

                        End If
                    End If

                    If Not IsDBNull(SqlReader.Item("yt_confidential_notes")) Then
                        If Not String.IsNullOrEmpty(SqlReader.Item("yt_confidential_notes").ToString.Trim) Then
                            confidential = "<tr><td width='2%'>&nbsp;</td><td><font class='small_header_text'>Notes&nbsp;:&nbsp;</font>"
                            confidential += "<font class='text_text'>" + SqlReader.Item("yt_confidential_notes").ToString.Trim + "</td></tr>"
                        End If
                    End If

                End If ' not aerodex

                If Not IsDBNull(SqlReader.Item("yt_refitted_by_company")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_refitted_by_company").ToString.Trim) Then
                        refitted_by = "<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='small_header_text2'>Refitted By&nbsp;:&nbsp;</font><font class='text_text'>" + SqlReader.Item("yt_refitted_by_company").ToString + "</font></td></tr>"
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("yt_year_refitted")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_year_refitted").ToString.Trim) And CLng(SqlReader.Item("yt_year_refitted").ToString) > 0 Then
                        refitted_by += "<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='small_header_text2'>Year&nbsp;:&nbsp;</font><font class='text_text'>" + SqlReader.Item("yt_year_refitted").ToString + "</font></td></tr>"
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("yt_nbr_guests")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_nbr_guests").ToString.Trim) Then
                        refitted_by += "<tr><td width='2%'>&nbsp;</td><td><font class='small_header_text2'>Number of Guests&nbsp;:&nbsp;</font><font class='text_text'>" + SqlReader.Item("yt_nbr_guests").ToString + "</font></td></tr>"
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("yt_nbr_crew")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_nbr_crew").ToString.Trim) Then
                        refitted_by += "<tr><td width='2%'>&nbsp;</td><td><font class='small_header_text2'>Number of Crew&nbsp;:&nbsp;</font><font class='text_text'>" + SqlReader.Item("yt_nbr_crew").ToString + "</font></td></tr>"
                    End If
                End If

                Dim sTmpYear As String = ""
                Dim stmpMonth As String = ""

                If Not IsDBNull(SqlReader.Item("yt_interior_redone_year")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_interior_redone_year").ToString.Trim) Then
                        If IsNumeric(SqlReader.Item("yt_interior_redone_year").ToString.Trim) And CInt(SqlReader.Item("yt_interior_redone_year").ToString.Trim) > 0 Then
                            sTmpYear = SqlReader.Item("yt_interior_redone_year").ToString.Trim
                        End If
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("yt_interior_redone_month")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_interior_redone_month").ToString.Trim) Then
                        If IsNumeric(SqlReader.Item("yt_interior_redone_month").ToString.Trim) And CInt(SqlReader.Item("yt_interior_redone_month").ToString.Trim) > 0 Then
                            stmpMonth = SqlReader.Item("yt_interior_redone_month").ToString.Trim
                        End If
                    End If
                End If

                If Not String.IsNullOrEmpty(sTmpYear.Trim) Then

                    interior_redone = " (<font class='small_header_text'>Interior Redone " + IIf(Not String.IsNullOrEmpty(stmpMonth.Trim), "Month/Year", "Year") + "&nbsp;:&nbsp;</font><font class='text_text'> "

                    If Not String.IsNullOrEmpty(stmpMonth.Trim) Then
                        interior_redone += stmpMonth.Trim + " / "
                    End If

                    interior_redone += sTmpYear.Trim + "</font>)"

                End If

                sTmpYear = ""
                stmpMonth = ""

                If Not IsDBNull(SqlReader.Item("yt_exterior_redone_year")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_exterior_redone_year").ToString.Trim) Then
                        If IsNumeric(SqlReader.Item("yt_exterior_redone_year").ToString.Trim) And CInt(SqlReader.Item("yt_exterior_redone_year").ToString.Trim) > 0 Then
                            sTmpYear = SqlReader.Item("yt_exterior_redone_year").ToString.Trim
                        End If
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("yt_exterior_redone_month")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_exterior_redone_month").ToString.Trim) Then
                        If IsNumeric(SqlReader.Item("yt_exterior_redone_month").ToString.Trim) And CInt(SqlReader.Item("yt_exterior_redone_month").ToString.Trim) > 0 Then
                            stmpMonth = SqlReader.Item("yt_exterior_redone_month").ToString.Trim
                        End If
                    End If
                End If

                If Not String.IsNullOrEmpty(sTmpYear.Trim) Then

                    exterior_redone = " (<font class='small_header_text'>Exterior Redone " + IIf(Not String.IsNullOrEmpty(stmpMonth.Trim), "Month/Year", "Year") + "&nbsp;:&nbsp;</font><font class='text_text'> "

                    If Not String.IsNullOrEmpty(stmpMonth.Trim) Then
                        exterior_redone += stmpMonth.Trim + " / "
                    End If

                    exterior_redone += sTmpYear.Trim + "</font>)"

                End If

                If Not bAerodexFlag Then

                    If SqlReader.Item("yt_forsale_flag").ToString.ToUpper.Contains("Y") Or SqlReader.Item("yt_for_lease_flag").ToString.ToUpper.Contains("Y") Or SqlReader.Item("yt_for_charter_flag").ToString.ToUpper.Contains("Y") Then
                        htmlOutput.Append("<tr><td height='5'></td></tr>")
                        If SqlReader.Item("yt_forsale_flag").ToString.ToUpper.Contains("Y") Then
                            htmlOutput.Append("<tr><td colspan='2' width='100%' class='header_text'>For Sale Information" + list_date + "</font>&nbsp;</td></tr>")
                        ElseIf SqlReader.Item("yt_for_lease_flag").ToString.ToUpper.Contains("Y") Then
                            htmlOutput.Append("<tr><td colspan='2' width='100%' class='header_text'>Lease Information" + list_date + "</font>&nbsp;</td></tr>")
                        ElseIf SqlReader.Item("yt_for_charter_flag").ToString.ToUpper.Contains("Y") Then
                            htmlOutput.Append("<tr><td colspan='2' width='100%' class='header_text'>Charter Information" + list_date + "</font>&nbsp;</td></tr>")
                        End If

                        htmlOutput.Append(ac_status)
                        htmlOutput.Append(asking_type)
                        htmlOutput.Append(asking_price)
                        htmlOutput.Append(confidential)

                        'added MSW 2/26/2013 - upon jason's customer request
                        If Not String.IsNullOrEmpty(days_on_market) Then
                            htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td><font class='small_header_text'>Days on Market: </font><font class='text_text'>" + days_on_market + "</font></td></tr>")
                        End If

                    End If

                End If

                htmlOutput.Append("<tr><td height='5'></td></tr>")
                htmlOutput.Append("<tr><td colspan='2' width='100%' class='header_text'>Dimensions and Size</font>&nbsp;</td></tr>")

                If Not IsDBNull(SqlReader.Item("yt_length_overall_meters")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_length_overall_meters").ToString.Trim) And CLng(SqlReader.Item("yt_length_overall_meters").ToString) > 0 Then
                        htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'>")
                        htmlOutput.Append("<font class='small_header_text'>LOA (m)&nbsp;:&nbsp;</font>")
                        htmlOutput.Append("<font class='text_text'>" + FormatNumber(SqlReader.Item("yt_length_overall_meters").ToString, 0, TriState.False, TriState.False, TriState.False).ToString + "</font>&nbsp;&nbsp;")
                        htmlOutput.Append("<font class='small_header_text'>LOA (ft)&nbsp;:&nbsp;</font>")
                        htmlOutput.Append("<font class='text_text'>" + FormatNumber(ConversionFunctions.ConvertMeterToFeet(CDbl(SqlReader.Item("yt_length_overall_meters").ToString)), 0, TriState.False, TriState.False, TriState.False).ToString + "</font>")
                        htmlOutput.Append("</td></tr>")
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("yt_beam_water_line_meters")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_beam_water_line_meters").ToString.Trim) And CLng(SqlReader.Item("yt_beam_water_line_meters").ToString) > 0 Then
                        htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'>")
                        htmlOutput.Append("<font class='small_header_text'>Beam (m)&nbsp;:&nbsp;</font>")
                        htmlOutput.Append("<font class='text_text'>" + FormatNumber(SqlReader.Item("yt_beam_water_line_meters").ToString, 0, TriState.False, TriState.False, TriState.False).ToString + "</font>&nbsp;&nbsp;")
                        htmlOutput.Append("<font class='small_header_text'>Beam (ft)&nbsp;:&nbsp;</font>")
                        htmlOutput.Append("<font class='text_text'>" + FormatNumber(ConversionFunctions.ConvertMeterToFeet(CDbl(SqlReader.Item("yt_beam_water_line_meters").ToString)), 0, TriState.False, TriState.False, TriState.False).ToString + "</font>")
                        htmlOutput.Append("</td></tr>")
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("yt_length_water_line_meters")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_length_water_line_meters").ToString.Trim) And CLng(SqlReader.Item("yt_length_water_line_meters").ToString) > 0 Then
                        htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'>")
                        htmlOutput.Append("<font class='small_header_text'>LWL (m)&nbsp;:&nbsp;</font>")
                        htmlOutput.Append("<font class='text_text'>" + FormatNumber(SqlReader.Item("yt_length_water_line_meters").ToString, 0, TriState.False, TriState.False, TriState.False).ToString + "</font>&nbsp;&nbsp;")
                        htmlOutput.Append("<font class='small_header_text'>LWL (ft)&nbsp;:&nbsp;</font>")
                        htmlOutput.Append("<font class='text_text'>" + FormatNumber(ConversionFunctions.ConvertMeterToFeet(CDbl(SqlReader.Item("yt_length_water_line_meters").ToString)), 0, TriState.False, TriState.False, TriState.False).ToString + "</font>")
                        htmlOutput.Append("</td></tr>")
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("yt_draft_water_line_meters")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_draft_water_line_meters").ToString.Trim) And CLng(SqlReader.Item("yt_draft_water_line_meters").ToString) > 0 Then
                        htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'>")
                        htmlOutput.Append("<font class='small_header_text'>Draft (m)&nbsp;:&nbsp;</font>")
                        htmlOutput.Append("<font class='text_text'>" + FormatNumber(SqlReader.Item("yt_draft_water_line_meters").ToString, 0, TriState.False, TriState.False, TriState.False).ToString + "</font>&nbsp;&nbsp;")
                        htmlOutput.Append("<font class='small_header_text'>Draft (ft)&nbsp;:&nbsp;</font>")
                        htmlOutput.Append("<font class='text_text'>" + FormatNumber(ConversionFunctions.ConvertMeterToFeet(CDbl(SqlReader.Item("yt_draft_water_line_meters").ToString)), 0, TriState.False, TriState.False, TriState.False).ToString + "</font>")
                        htmlOutput.Append("</td></tr>")
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("yt_gross_tons")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_gross_tons").ToString.Trim) And CLng(SqlReader.Item("yt_gross_tons").ToString) > 0 Then
                        htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='small_header_text'>Gross Tons&nbsp;:&nbsp;</font>")
                        htmlOutput.Append("<font class='text_text'>" + FormatNumber(SqlReader.Item("yt_gross_tons").ToString, 0, TriState.False, TriState.False, TriState.False).ToString + "</font></td></tr>")
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("yt_displacement_tons")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_displacement_tons").ToString.Trim) And CLng(SqlReader.Item("yt_displacement_tons").ToString) > 0 Then
                        htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='small_header_text'>Displacement Tons&nbsp;:&nbsp;</font>")
                        htmlOutput.Append("<font class='text_text'>" + FormatNumber(SqlReader.Item("yt_displacement_tons").ToString, 0, TriState.False, TriState.False, TriState.False).ToString + "</font></td></tr>")
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("yt_nbr_decks")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_nbr_decks").ToString.Trim) And CLng(SqlReader.Item("yt_nbr_decks").ToString) > 0 Then
                        htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='small_header_text'>Number Of Decks&nbsp;:&nbsp;</font>")
                        htmlOutput.Append("<font class='text_text'>" + SqlReader.Item("yt_nbr_decks").ToString + "</font></td></tr>")
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("yt_hull_material")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_hull_material").ToString.Trim) Then
                        htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='small_header_text'>Hull Material&nbsp;:&nbsp;</font>")
                        htmlOutput.Append("<font class='text_text'>" + SqlReader.Item("yt_hull_material").ToString + "</font></td></tr>")
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("yt_superstructure_material")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_superstructure_material").ToString.Trim) Then
                        htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='small_header_text'>Superstructure Material&nbsp;:&nbsp;</font>")
                        htmlOutput.Append("<font class='text_text'>" + SqlReader.Item("yt_superstructure_material").ToString + "</font></td></tr>")
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("yt_nbr_staterooms")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_nbr_staterooms").ToString.Trim) Then
                        htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='small_header_text'>Number of Staterooms/Cabins&nbsp;:&nbsp;</font>")
                        htmlOutput.Append("<font class='text_text'>" + SqlReader.Item("yt_nbr_staterooms").ToString + "</font></td></tr>")
                    End If
                End If

            End If

            Dim portInfo = build_full_spec_yacht_port_information(SqlReader)

            SqlReader.Close()

            htmlOutput.Append(build_full_spec_yacht_details(nYachtID, 0, "Interior", interior_redone, refitted_by))
            htmlOutput.Append(build_full_spec_yacht_details(nYachtID, 0, "Exterior", exterior_redone, ""))

            htmlOutput.Append(build_format_full_spec())
            htmlOutput.Append(build_full_spec_first_yacht_picture(nYachtID, SqlCommand, SqlReader))
            htmlOutput.Append(build_full_spec_yacht_compliance_certs(nYachtID, SqlCommand, SqlReader))
            htmlOutput.Append(portInfo)
            htmlOutput.Append("</td></tr></table></td></tr></table>")

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_coverpage_yacht()" + ex.Message
        End Try

        Return htmlOutput.ToString

    End Function

    Public Function build_full_spec_second_page_yacht(ByVal nYachtID As Long) As String

        Dim htmlOutput As New StringBuilder

        Dim engine_info As String = ""
        Dim config_info As String = ""

        Dim sQuery = New StringBuilder()

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader = Nothing
        Dim SqlException As SqlClient.SqlException = Nothing

        Try

            htmlOutput.Append(build_full_spec_yacht_header(nYachtID, "Yacht Specifications", "", ""))

            sQuery.Append("SELECT * FROM Yacht WITH(NOLOCK) INNER JOIN Yacht_Model WITH(NOLOCK) ON yt_model_id = ym_model_id")
            sQuery.Append(" INNER JOIN yacht_category_size WITH(NOLOCK) ON (ycs_motor_type = ym_motor_type AND ycs_category_size = ym_category_size)")
            sQuery.Append(" INNER JOIN yacht_motor_type WITH(NOLOCK) ON (ymt_motor_type = ym_motor_type)")
            sQuery.Append(" WHERE yt_id = " + nYachtID.ToString + " AND yt_journ_id = " + yacht_journal_id.ToString)

            SqlConn.ConnectionString = localFunctions.clientConnectStr
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString
            SqlReader = SqlCommand.ExecuteReader()

            If SqlReader.HasRows Then

                SqlReader.Read()

                htmlOutput.Append(build_full_spec_yacht_previous_names(nYachtID, yacht_journal_id))

                htmlOutput.Append("<tr><td height='5'></td></tr>")
                htmlOutput.Append("<tr><td colspan='2' width='100%' class='header_text'>Performance and Capabilities</font>&nbsp;</td></tr>")

                If Not IsDBNull(SqlReader.Item("yt_cruise_speed_knots")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_cruise_speed_knots").ToString.Trim) And CDbl(SqlReader.Item("yt_cruise_speed_knots").ToString) > 0 Then
                        htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='small_header_text'>Cruise Speed (kn)&nbsp;:&nbsp;</font>")
                        htmlOutput.Append("<font class='text_text'>" + SqlReader.Item("yt_cruise_speed_knots").ToString + "</font></td></tr>")
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("yt_max_speed_knots")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_cruise_speed_knots").ToString.Trim) And CDbl(SqlReader.Item("yt_max_speed_knots").ToString) > 0 Then
                        htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='small_header_text'>Max Speed (kn)&nbsp;:&nbsp;</font>")
                        htmlOutput.Append("<font class='text_text'>" + SqlReader.Item("yt_max_speed_knots").ToString + "</font></td></tr>")
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("yt_range_miles")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_range_miles").ToString.Trim) And CDbl(SqlReader.Item("yt_range_miles").ToString) > 0 Then
                        htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='small_header_text'>Range (nm)&nbsp;:&nbsp;</font>")
                        htmlOutput.Append("<font class='text_text'>" + SqlReader.Item("yt_nbr_staterooms").ToString + "</font></td></tr>")
                    End If
                End If

                htmlOutput.Append("<tr><td height='5'></td></tr>")
                htmlOutput.Append("<tr><td colspan='2' width='100%' class='header_text'>Configuration and Type</font>&nbsp;</td></tr>")

                If Not IsDBNull(SqlReader.Item("ym_motor_type")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("ym_motor_type").ToString.Trim) Then
                        htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td><font class='small_header_text'>Type : </font>")
                        htmlOutput.Append("<font class='text_text'>" + SqlReader.Item("ymt_description").ToString.Trim + "</font></td></tr>")
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("ym_nbr_hulls")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("ym_nbr_hulls").ToString.Trim) Then
                        htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td><font class='small_header_text'>Number of Hulls : </font>")
                        htmlOutput.Append("<font class='text_text'>" + SqlReader.Item("ym_nbr_hulls").ToString.Trim + "</font></td></tr>")
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("ym_category_size")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("ym_category_size").ToString.Trim) Then
                        htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td><font class='small_header_text'>Size : </font>")
                        htmlOutput.Append("<font class='text_text'>" + SqlReader.Item("ycs_description").ToString.Trim + "</font></td></tr>")
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("ym_hull_configuration")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("ym_hull_configuration").ToString.Trim) Then
                        htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td><font class='small_header_text'>Hull Configuration : </font>")
                        htmlOutput.Append("<font class='text_text'>" + SqlReader.Item("ym_hull_configuration").ToString.Trim + "</font></td></tr>")
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("ym_mfr_comp_id")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("ym_mfr_comp_id").ToString.Trim) And CLng(SqlReader.Item("ym_mfr_comp_id").ToString) > 0 Then
                        htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td><font class='small_header_text'>Manufacturer : </font>")
                        htmlOutput.Append("<font class='text_text'>" + Server.HtmlEncode(commonEvo.get_company_name_fromID(CLng(SqlReader.Item("ym_mfr_comp_id").ToString), 0, False, False, "")) + "</font></td></tr>")
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("yt_nbr_engines")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_nbr_engines").ToString.Trim) And CLng(SqlReader.Item("yt_nbr_engines").ToString) > 0 Then
                        engine_info += "<tr><td width='2%'>&nbsp;</td><td><font class='small_header_text2'>Number of Engines : </font>"
                        engine_info += "<font class='text_text2'>" + FormatNumber(SqlReader.Item("yt_nbr_engines").ToString, 0) + "</font></td></tr>"
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("yt_engine_fuel_type")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_engine_fuel_type").ToString.Trim) Then
                        engine_info += "<tr><td width='2%'>&nbsp;</td><td><font class='small_header_text2'>Fuel Type : </font>"
                        engine_info += "<font class='text_text2'>" + SqlReader.Item("yt_engine_fuel_type").ToString.Trim + "</font></td></tr>"
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("yt_engine_fuel_capacity_gals")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_engine_fuel_capacity_gals").ToString.Trim) And CLng(SqlReader.Item("yt_engine_fuel_capacity_gals").ToString) > 0 Then
                        engine_info += "<tr><td width='2%'>&nbsp;</td><td><font class='small_header_text2'>Fuel Capacity/Gal : </font>"
                        engine_info += "<font class='text_text2'>" + FormatNumber(SqlReader.Item("yt_engine_fuel_capacity_gals").ToString, 0) + "</font></td></tr>"
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("yt_engine_emp")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_engine_emp").ToString.Trim) Then
                        engine_info += "<tr><td width='2%'>&nbsp;</td><td><font class='small_header_text2'>Engine Maintenance Program : </font>"
                        engine_info += "<font class='text_text2'>" + SqlReader.Item("yt_engine_emp").ToString.Trim + "</font></td></tr>"
                    End If
                End If

                htmlOutput.Append("<tr><td height='5'></td></tr>")
                htmlOutput.Append("<tr><td colspan='2' width='100%' class='header_text'>Helipad / Hangar</font>&nbsp;</td></tr>")

                If Not IsDBNull(SqlReader.Item("yt_helipad")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_helipad").ToString.Trim) Then

                        Select Case SqlReader.Item("yt_helipad").ToString.ToLower
                            Case "y"

                                htmlOutput.Append("<tr><td width='2%'>&nbsp;</td>")
                                htmlOutput.Append("<td nowrap='nowrap'><font class='small_header_text'>Helipad?&nbsp;:&nbsp;</font><font class='text_text'>Yes</font>")

                                If Not IsDBNull(SqlReader.Item("yt_helipad_approved_for_lbs")) Then
                                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_helipad_approved_for_lbs").ToString) And CDbl(SqlReader.Item("yt_helipad_approved_for_lbs").ToString) > 0 Then
                                        htmlOutput.Append("&nbsp;&nbsp;<font class='small_header_text'>Approved Lbs : </font>")
                                        htmlOutput.Append("<font class='text_text'>" + SqlReader.Item("yt_helipad_approved_for_lbs").ToString.Trim + "</font>")
                                    End If
                                End If

                                If Not IsDBNull(SqlReader.Item("yt_helipad_radius")) Then
                                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_helipad_radius").ToString) And CDbl(SqlReader.Item("yt_helipad_radius").ToString) > 0 Then
                                        htmlOutput.Append("&nbsp;&nbsp;<font class='small_header_text'>Radius : </font>")
                                        htmlOutput.Append("<font class='text_text'>" + SqlReader.Item("yt_helipad_radius").ToString.Trim + "</font>")
                                    End If
                                End If

                                htmlOutput.Append("</td></tr>")

                            Case "n"
                                htmlOutput.Append("<tr><td width='2%'>&nbsp;</td>")
                                htmlOutput.Append("<td nowrap='nowrap'><font class='small_header_text'>Helipad?&nbsp;:&nbsp;</font><font class='text_text'>Unknown</font></td></tr>")
                        End Select

                    End If
                End If

                If Not IsDBNull(SqlReader.Item("yt_helipad_hangar")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("yt_helipad_hangar").ToString.Trim) Then

                        Select Case SqlReader.Item("yt_helipad_hangar").ToString.ToLower
                            Case "y"

                                htmlOutput.Append("<tr><td width='2%'>&nbsp;</td>")
                                htmlOutput.Append("<td nowrap='nowrap'><font class='small_header_text'>Helipad Hangar?&nbsp;:&nbsp;</font><font class='text_text'>Yes</font>")
                                htmlOutput.Append("</td></tr>")

                            Case "n"
                                htmlOutput.Append("<tr><td width='2%'>&nbsp;</td>")
                                htmlOutput.Append("<td nowrap='nowrap'><font class='small_header_text'>Helipad Hangar?&nbsp;:&nbsp;</font><font class='text_text'>Unknown</font>")
                                htmlOutput.Append("</td></tr>")
                        End Select

                    End If
                End If

            End If

            htmlOutput.Append(build_full_spec_yacht_engine_info(nYachtID, 0, engine_info))

            htmlOutput.Append(build_full_spec_yacht_details(nYachtID, yacht_journal_id, "Power", "", ""))
            htmlOutput.Append(build_full_spec_yacht_details(nYachtID, yacht_journal_id, "Maintenance", "", ""))
            htmlOutput.Append(build_full_spec_yacht_details(nYachtID, yacht_journal_id, "Bridge", "", ""))
            htmlOutput.Append(build_full_spec_yacht_details(nYachtID, yacht_journal_id, "Systems", "", ""))
            htmlOutput.Append(build_full_spec_yacht_details(nYachtID, yacht_journal_id, "Equipment", "", ""))

            htmlOutput.Append(build_format_full_spec())
            htmlOutput.Append(build_full_spec_yacht_next_pictures(nYachtID))
            htmlOutput.Append("</td></tr></table></td></tr></table>")

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_second_page_yacht()" + ex.Message
        Finally

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

            SqlReader.Close()


        End Try

        Return htmlOutput.ToString

    End Function

    Public Function build_full_spec_transactions_page_yacht(ByVal nYachtID As Long) As String  '

        Dim htmlOutput As New StringBuilder()

        Try

            htmlOutput.Append(build_full_spec_page_header(nYachtID, "Yacht Transactions", "", "", 0))
            htmlOutput.Append(build_full_spec_transactions_page(0, nYachtID))
            htmlOutput.Append("</td></tr></table></td></tr></table>")

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_transactions_page_yacht()" + ex.Message
        End Try

        Return htmlOutput.ToString

        htmlOutput = Nothing

    End Function

    Public Function build_full_spec_notes_page_yacht(ByVal nYachtID As Long) As String

        Dim htmlOutput As New StringBuilder()

        Try

            htmlOutput.Append(build_full_spec_yacht_header(nYachtID, "Yacht Notes", "", ""))
            htmlOutput.Append(build_full_spec_notes_page(0, nYachtID))
            htmlOutput.Append("</td></tr></table></td></tr></table>")

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_notes_page_yacht()" + ex.Message
        End Try

        Return htmlOutput.ToString

        htmlOutput = Nothing

    End Function

    Public Function build_full_spec_fourth_page_yacht(ByVal nYachtID As Long) As String

        Dim htmlOutput As New StringBuilder()

        Try

            htmlOutput.Append(build_full_spec_yacht_header(nYachtID, "Yacht History", "", ""))
            htmlOutput.Append(Get_Yacht_History(nYachtID, yacht_journal_id))
            htmlOutput.Append("</td></tr></table></td></tr></table>")

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_fourth_page_yacht()" + ex.Message
        End Try

        Return htmlOutput.ToString

        htmlOutput = Nothing

    End Function

    Public Function build_full_spec_third_page_yacht(ByVal nYachtID As Long) As String

        Dim htmlOutput As New StringBuilder()

        Try

            htmlOutput.Append(build_full_spec_yacht_header(nYachtID, "Yacht Company / Contacts", "", ""))
            htmlOutput.Append(build_full_spec_yacht_contacts(nYachtID))
            htmlOutput.Append("</td></tr></table></td></tr></table>")

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_third_page_yacht()" + ex.Message
        End Try

        Return htmlOutput.ToString

        htmlOutput = Nothing

    End Function

    Public Function build_full_spec_pictures_page_yacht(ByVal nYachtID As Long) As String

        Dim htmlOutput As New StringBuilder()

        Try

            htmlOutput.Append(build_full_spec_yacht_header(nYachtID, "Additional Yacht Pictures", "", ""))
            htmlOutput.Append(build_full_spec_yacht_pictures_page(nYachtID))
            htmlOutput.Append("</td></tr></table></td></tr></table>")

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_pictures_page_yacht()" + ex.Message
        End Try

        Return htmlOutput.ToString

        htmlOutput = Nothing

    End Function

    Public Function build_full_spec_yacht_header(ByVal nYachtID As Long, ByVal Title As String, ByVal address_info As String, ByVal image_ref As String) As String

        Dim company_name As String = ""

        Dim sQuery = New StringBuilder()
        Dim sOutString As StringBuilder = New StringBuilder()

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing

        Try

            sQuery.Append("SELECT TOP 1 Company.comp_name, Company.comp_web_address, Company.comp_email_address FROM Company")
            sQuery.Append(" INNER JOIN Subscription ON sub_comp_id = comp_id AND comp_journ_id = 0")
            sQuery.Append(" WHERE Subscription.sub_id = " + Session.Item("localUser").crmSubSubID.ToString)

            SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            SqlConn.Open()
            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString
            SqlReader = SqlCommand.ExecuteReader()

            If SqlReader.HasRows Then
                SqlReader.Read()
                company_name = SqlReader.Item("comp_name").ToString.Trim
            End If

            SqlReader.Close()

            If bWordReport Then
                sOutString.Append("<table cellspacing='0' cellpadding='0' width='650'><tr bgcolor='#736F6E'><td colspan='3' cellpadding='0' cellspacing='0'>")
                sOutString.Append("<table border='1' cellspacing='0' cellpadding='4' bordercolor='black' width='100%' height='50'><tr><td>")
                sOutString.Append("<table width='650'><tr>")

                If Not String.IsNullOrEmpty(image_ref.Trim) Then
                    sOutString.Append("<td width='150'>" + image_ref.Trim + "</td><td width='500' valign='top' class='white_feat_header_text'><font color='white' size='-1'>")
                Else
                    sOutString.Append("<td width='650' valign='top' class='white_feat_header_text'><font color='white' size='-1'>")
                End If

            Else
                sOutString.Append("<table cellspacing='0' cellpadding='0' width='95%'><tr bgcolor='#736F6E'><td colspan='3' cellpadding='0' cellspacing='0'>")
                sOutString.Append("<table border='1' cellspacing='0' cellpadding='4' bordercolor='black' width='100%' height='50'><tr><td>")
                sOutString.Append("<table width='100%'><tr>")

                If Not String.IsNullOrEmpty(image_ref.Trim) Then
                    sOutString.Append("<td width='150'>" + image_ref.Trim + "</td><td width='500'><font color='white' size='+1'>")
                Else
                    sOutString.Append("<td width='650'><font color='white' size='+1'>")
                End If

            End If

            sOutString.Append(company_name + "</font><br>")

            If Not String.IsNullOrEmpty(address_info.Trim) Then
                sOutString.Append("<table>" + address_info.Trim + "</table>")
            End If

            If bWordReport Then
                sOutString.Append("</td><td width='40%' cellpadding='5' valign='top' class='white_feat_header_text'><font color='white' size='-1'>")
            Else
                sOutString.Append("</td><td width='40%' cellpadding='5' valign='top'><font color='white'>")
            End If

            Dim ytInfoArray() As String = Split(commonEvo.GetYachtInfo(nYachtID, False), Constants.cSvrDataSeperator)

            If Not String.IsNullOrEmpty(ytInfoArray(0).ToString) Then
                sOutString.Append(ytInfoArray(0).ToString & " ")
            End If

            If Not String.IsNullOrEmpty(ytInfoArray(1).ToString) Then
                sOutString.Append(ytInfoArray(1).ToString)
            End If

            If Not chkBlindReport.Checked Then
                If Not String.IsNullOrEmpty(ytInfoArray(2).ToString) Then
                    sOutString.Append(" - " + Server.HtmlEncode(commonEvo.get_company_name_fromID(CLng(ytInfoArray(2).ToString), 0, False, False, "")))
                End If
            End If

            sOutString.Append("</font>")

            sOutString.Append("<table align='left' valign='bottom'>")

            sOutString.Append("<tr><td align='center'>&nbsp;</td></tr>")

            If bWordReport Then
                sOutString.Append("<tr><td align='center' class='white_feat_header_text'><font color='white' size='-1'><i>" + Title.Trim + "</i></font></td></tr></table>")
            Else
                sOutString.Append("<tr><td align='center'><font color='white'><i>" + Title.Trim + "</i></font></td></tr></table>")
            End If

            If bWordReport Then
                sOutString.Append("</td></tr></table></td></tr></table></td></tr><tr valign='top'><td width='400' valign='top' height='500' cellpadding='0' cellspacing='0'><table valign='top' cellpadding='0' cellspacing='0'>")
            Else
                sOutString.Append("</td></tr></table></td></tr></table></td></tr><tr valign='top'><td width='60%' height='900' valign='top' cellpadding='0' cellspacing='0'><table valign='top' cellpadding='0' cellspacing='0'>")
            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_yacht_header " + ex.Message
        Finally
            SqlReader = Nothing

            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing
        End Try

        Return (sOutString.ToString)

    End Function

    Public Function build_full_spec_first_yacht_picture(ByVal nYachtID As Long, ByRef SqlCommand As SqlClient.SqlCommand, ByRef adoRSAircraft As SqlClient.SqlDataReader) As String

        ' This is right side column, should start with an open table already in td
        Dim fAcpic_image_type As String = ""
        Dim fAcpic_id As Integer = 0
        Dim pic_seq_num As Integer = 0
        Dim something_shown As Boolean = False
        Dim pic_size As Integer = 310

        Dim fApicSubject As String = ""

        Dim imgDisplayFolder As String = ""

        If HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then

            If Not Application.Item("crmClientSiteData").crmClientHostName.ToString.ToUpper.Contains("NEWEVONET") Then
                imgDisplayFolder = "https://www.testjetnetevolution.com/" + HttpContext.Current.Session.Item("YachtPicturesFolderVirtualPath")
            Else
                imgDisplayFolder = "http://www.jetnetevolution.com/" + HttpContext.Current.Session.Item("YachtPicturesFolderVirtualPath")
            End If

        Else
            imgDisplayFolder = Application.Item("crmClientSiteData").ClientFullHostName.ToString.Trim + HttpContext.Current.Session.Item("YachtPicturesFolderVirtualPath")
        End If

        Dim imgFileName As String = ""

        Dim sQuery = New StringBuilder()
        Dim outString As String = ""

        Try

            ' start AC_Pic
            sQuery.Append("SELECT TOP 1 * FROM Yacht_Pictures WITH(NOLOCK)")
            sQuery.Append(" WHERE ytpic_yt_id = " + nYachtID.ToString)
            sQuery.Append(" AND ytpic_journ_id = 0")
            sQuery.Append(" AND ytpic_seq_no > 0")
            sQuery.Append(" AND ytpic_hide_flag = 'N'")
            sQuery.Append(" ORDER BY ytpic_seq_no ASC")

            SqlCommand.CommandText = sQuery.ToString

            adoRSAircraft = SqlCommand.ExecuteReader()

            If adoRSAircraft.HasRows Then

                adoRSAircraft.Read()

                pic_seq_num = CInt(adoRSAircraft.Item("ytpic_seq_no").ToString)

                If Not IsDBNull(adoRSAircraft("ytpic_image_type")) Then
                    fAcpic_image_type = adoRSAircraft.Item("ytpic_image_type").ToString.ToLower.Trim
                End If

                If Not IsDBNull(adoRSAircraft("ytpic_id")) Then
                    fAcpic_id = adoRSAircraft.Item("ytpic_id").ToString.Trim
                End If

                If Not (IsDBNull(adoRSAircraft("ytpic_subject"))) Then
                    fApicSubject = adoRSAircraft.Item("ytpic_subject").ToString.Trim
                End If

                imgFileName = nYachtID.ToString + Constants.cHyphen + "0" + Constants.cHyphen + fAcpic_id.ToString + Constants.cDot + fAcpic_image_type.ToLower.Trim

                ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
                ' setup the path for the pictures based on which site is running
                ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
                If bWordReport Then
                    pic_size = 250
                End If

                outString += "<img Title='" + fApicSubject.Trim + "' alt='" + fApicSubject.Trim + "' src='" + imgDisplayFolder.Trim + "/" + imgFileName.Trim + "' width='" & pic_size & "' /><br />&nbsp;<br />"
                something_shown = True

            End If

            adoRSAircraft.Close()

            If Not something_shown Then
                outString = "No Pictures Available"
            End If

        Catch ex As Exception
            '  aCommonEvo.DisplayAlert("Error in Build_PDF_Header: " & ex.Message)
        End Try

        Return outString

    End Function

    Public Function build_full_spec_yacht_next_pictures(ByVal nYachtID As Long) As String

        Dim outString As String = ""

        ' This is right side column, should start with an open table already in td
        Dim imgDisplayFolder As String = ""

        If HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then

            If Not Application.Item("crmClientSiteData").crmClientHostName.ToString.ToUpper.Contains("NEWEVONET") Then
                imgDisplayFolder = "https://www.testjetnetevolution.com/" + HttpContext.Current.Session.Item("YachtPicturesFolderVirtualPath")
            Else
                imgDisplayFolder = "http://www.jetnetevolution.com/" + HttpContext.Current.Session.Item("YachtPicturesFolderVirtualPath")
            End If

        Else
            imgDisplayFolder = Application.Item("crmClientSiteData").ClientFullHostName.ToString.Trim + HttpContext.Current.Session.Item("YachtPicturesFolderVirtualPath")
        End If

        Dim imgFileName As String = ""
        Dim fApicSubject As String = ""

        Dim fAcpic_image_type As String = ""
        Dim fAcpic_id As Integer = 0
        Dim pic_seq_num As Integer = 0
        Dim pic_size As Integer = 310

        Dim something_shown As Boolean = False
        Dim nCount As Integer = 0

        Dim sQuery = New StringBuilder()

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader = Nothing
        Dim SqlException As SqlClient.SqlException = Nothing

        Try

            ' start AC_Pic
            sQuery.Append("SELECT TOP 2 * FROM Yacht_Pictures WITH(NOLOCK)")
            sQuery.Append(" WHERE ytpic_yt_id = " + nYachtID.ToString)
            sQuery.Append(" AND ytpic_journ_id = " + yacht_journal_id.ToString)
            sQuery.Append(" AND ytpic_seq_no > 0")
            sQuery.Append(" AND ytpic_hide_flag = 'N'")
            sQuery.Append(" ORDER BY ytpic_seq_no ASC")

            SqlConn.ConnectionString = localFunctions.clientConnectStr
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString
            SqlReader = SqlCommand.ExecuteReader()

            If SqlReader.HasRows Then
                Do While SqlReader.Read()

                    If nCount > 0 Then

                        pic_seq_num = CInt(SqlReader.Item("ytpic_seq_no").ToString)

                        If Not IsDBNull(SqlReader("ytpic_image_type")) Then
                            fAcpic_image_type = SqlReader.Item("ytpic_image_type").ToString.ToLower.Trim
                        End If

                        If Not IsDBNull(SqlReader("ytpic_id")) Then
                            fAcpic_id = SqlReader.Item("ytpic_id").ToString.Trim
                        End If

                        If Not (IsDBNull(SqlReader("ytpic_subject"))) Then
                            fApicSubject = SqlReader.Item("ytpic_subject").ToString.Trim
                        End If

                        imgFileName = nYachtID.ToString + Constants.cHyphen + "0" + Constants.cHyphen + fAcpic_id.ToString + Constants.cDot + fAcpic_image_type.ToLower.Trim

                        If bWordReport Then
                            pic_size = 250
                        End If

                        outString += "<img Title='" + fApicSubject.Trim + "' alt='" + fApicSubject.Trim + "' src='" + imgDisplayFolder.Trim + "/" + imgFileName.Trim + "' width='" & pic_size & "' /><br /><br />"
                        something_shown = True

                    End If

                    nCount += 1

                Loop

            End If

            If Not something_shown Then
                outString = " No Pictures Available "
            End If

            SqlReader.Close()

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_yacht_next_pictures()" + ex.Message
        Finally

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

            SqlReader.Close()


        End Try

        Return outString

    End Function

    Public Function build_full_spec_yacht_pictures_page(ByVal nYachtID As Long) As String

        Dim outString As String = ""

        Dim imgDisplayFolder As String = ""

        If HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then

            If Not Application.Item("crmClientSiteData").crmClientHostName.ToString.ToUpper.Contains("NEWEVONET") Then
                imgDisplayFolder = "https://www.testjetnetevolution.com/" + HttpContext.Current.Session.Item("YachtPicturesFolderVirtualPath")
            Else
                imgDisplayFolder = "http://www.jetnetevolution.com/" + HttpContext.Current.Session.Item("YachtPicturesFolderVirtualPath")
            End If

        Else
            imgDisplayFolder = Application.Item("crmClientSiteData").ClientFullHostName.ToString.Trim + HttpContext.Current.Session.Item("YachtPicturesFolderVirtualPath")
        End If

        Dim imgFileName As String = ""

        ' This is right side column, should start with an open table already in td

        Dim fApicSubject As String = ""
        Dim fAcpic_image_type As String = ""
        Dim fAcpic_id As Integer = 0
        Dim pic_seq_num As Integer = 0
        Dim row_color As String = "gray"
        Dim pic_counter As Integer = 0
        Dim pic_size As Integer = 250
        Dim nCount As Integer = 0
        Dim something_shown As Boolean = False

        Dim sQuery = New StringBuilder()

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader = Nothing
        Dim SqlException As SqlClient.SqlException = Nothing

        Dim ac_image_file As String = ""
        Dim temp_height As Integer = 0
        Dim temp_width As Integer = 0
        Dim zimage2 As System.Drawing.Image
        Dim desired_width As Integer = 255
        Dim temp_percent1 As Double = 0.0
        Dim temp_percent2 As Double = 0.0

        Dim picture_page_height As Integer = 650
        Dim current_page_height As Integer = 0
        Dim highest_row_height As Integer = 0

        Try

            sQuery.Append("SELECT * FROM Yacht_Pictures WITH(NOLOCK)")   ' 1 on title - 3 on next - 6 on this
            sQuery.Append(" WHERE ytpic_yt_id = " + nYachtID.ToString)
            sQuery.Append(" AND ytpic_journ_id = " + yacht_journal_id.ToString)
            sQuery.Append(" AND ytpic_seq_no > 0")
            sQuery.Append(" AND ytpic_hide_flag = 'N'")
            sQuery.Append(" ORDER BY ytpic_seq_no ASC")

            SqlConn.ConnectionString = localFunctions.clientConnectStr
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString
            SqlReader = SqlCommand.ExecuteReader()

            outString = "<table width='100%' align='center' cellspacing='0' cellpadding='4'>"

            If SqlReader.HasRows Then

                Do While SqlReader.Read

                    If current_page_height >= picture_page_height Then
                        outString += "</td></tr></table></td></tr></table>"
                        outString += "<table width='100%' align='center' class='break'><tr><td>&nbsp;</td></tr></table>"
                        outString += build_full_spec_yacht_header(nYachtID, "Additional Yacht Pictures", "", "")
                        outString += "<table width='100%' align='center' cellspacing='0' cellpadding='4'>"
                        current_page_height = 0
                    End If

                    If nCount > 1 Then

                        pic_seq_num = CInt(SqlReader.Item("ytpic_seq_no").ToString)

                        If Not IsDBNull(SqlReader("ytpic_image_type")) Then
                            fAcpic_image_type = SqlReader.Item("ytpic_image_type").ToString.ToLower.Trim
                        End If

                        If Not IsDBNull(SqlReader("ytpic_id")) Then
                            fAcpic_id = SqlReader.Item("ytpic_id").ToString.Trim
                        End If

                        If Not (IsDBNull(SqlReader("ytpic_subject"))) Then
                            fApicSubject = SqlReader.Item("ytpic_subject").ToString.Trim
                        End If

                        imgFileName = nYachtID.ToString + Constants.cHyphen + "0" + Constants.cHyphen + fAcpic_id.ToString + Constants.cDot + fAcpic_image_type.ToLower.Trim

                        If bWordReport Then
                            outString += "<tr bgcolor='#F1F1F1'><td valign='middle' align='center' class='text_text'>"
                        Else
                            If pic_counter = 0 Then
                                If row_color = "white" Then
                                    outString += "<tr bgcolor='#F1F1F1'><td width='33%' valign='middle' align='center' class='text_text'>"
                                    row_color = "gray"
                                Else
                                    outString += "<tr bgcolor='#D0D0D0'><td width='33%' valign='middle' align='center' class='text_text'>"
                                    row_color = "white"
                                End If
                            End If
                        End If

                        Try

                            ac_image_file = HttpContext.Current.Server.MapPath("pictures\yacht\") & imgFileName
                            zimage2 = System.Drawing.Image.FromFile(ac_image_file)
                            temp_width = zimage2.Width
                            temp_height = zimage2.Height

                            ' if the image is wider then the desired image width, then shirnk down to size.
                            If temp_width > desired_width Then
                                temp_percent1 = CDbl(CDbl(desired_width) / CDbl(temp_width))
                                temp_width = CDbl(CDbl(temp_width) * CDbl(temp_percent1))
                                temp_height = CDbl(CDbl(temp_height) * CDbl(temp_percent1))
                            End If

                            'assuming generally that a square is fine
                            If temp_height > temp_width Then
                                temp_percent1 = CDbl(CDbl(temp_width) / CDbl(temp_height))
                                temp_width = CDbl(CDbl(temp_width) * CDbl(temp_percent1))
                                temp_height = CDbl(CDbl(temp_height) * CDbl(temp_percent1))
                            End If


                            If temp_height > highest_row_height Then
                                highest_row_height = temp_height
                            End If


                            If bWordReport Then
                                outString += "<img title='" + fApicSubject.Trim + "' alt='" + fApicSubject.Trim + "' src='" + imgDisplayFolder.Trim + "/" + imgFileName.Trim + "' width='" + temp_width.ToString + "' height='" + temp_height.ToString + "' /><br /><br />"
                            Else
                                outString += "<img title='" + fApicSubject.Trim + "' alt='" + fApicSubject.Trim + "' src='" + imgDisplayFolder.Trim + "/" + imgFileName.Trim + "' width='" + temp_width.ToString + "' /><br /><br />"
                            End If
                        Catch ex As Exception
                            outString += "<img title='" + fApicSubject.Trim + "' alt='" + fApicSubject.Trim + "' src='" + imgDisplayFolder.Trim + "/" + imgFileName.Trim + "' width='" + pic_size.ToString + "' /><br /><br />"
                        End Try


                        something_shown = True

                        If bWordReport Then
                            outString += "</td></tr>"
                        Else

                            If pic_counter < 2 Then
                                outString += "</td><td width='33%' valign='middle' align='center' class='text_text'>"
                                pic_counter += 1
                            Else
                                outString += "</td></tr>"
                                pic_counter = 0
                                current_page_height = current_page_height + temp_height ' add height of each row after its added
                                highest_row_height = 0
                            End If
                        End If

                    End If

                    nCount += 1

                Loop

                If pic_counter = 0 Then
                    outString += "</td>"
                    outString += "<td width='33%' valign='middle' align='center' class='text_text'></td></tr>"
                ElseIf pic_counter = 1 Then
                    outString += "<td width='33%' valign='middle' align='center' class='text_text'></td></tr>"
                End If

            End If

            If Not something_shown Then
                outString += "<tr><td valign='middle' align='center' class='text_text'> No Additional Pictures Currently Available </td></tr>"
            End If

            outString += "</table>"


        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_yacht_full_spec_pictures_page()" + ex.Message
        Finally

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

            SqlReader.Close()


        End Try

        Return outString

    End Function

    Public Function build_full_spec_yacht_contacts(ByVal nYachtID As Long) As String

        Dim ac_maintained As String = ""
        Dim column_color As String = "white"
        Dim contact_counter As Integer = 1
        Dim sub_counter As Integer = 1

        Dim sQuery = New StringBuilder()
        Dim outString As String = ""

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader = Nothing
        Dim SqlException As SqlClient.SqlException = Nothing

        Dim page_break_count As Integer = 0
        Dim page_break_limit As Integer = 9

        Try

            sQuery.Append("SELECT comp_id, yct_name, yr_owner_percent, contact_id, contact_sirname, contact_first_name, contact_middle_initial, contact_last_name, contact_suffix, contact_title, contact_email_address")
            sQuery.Append(" FROM Yacht_Reference WITH(NOLOCK) INNER JOIN company WITH(NOLOCK) ON yr_comp_id = comp_id AND yr_journ_id = comp_journ_id")
            sQuery.Append(" INNER JOIN yacht_contact_Type WITH(NOLOCK) ON (yr_contact_type = yct_code)")
            sQuery.Append(" LEFT OUTER JOIN contact WITH(NOLOCK) ON yr_contact_id = contact_id AND yr_journ_id = contact_journ_id AND contact_hide_flag = 'N'")
            sQuery.Append(" WHERE (yr_yt_id = " + nYachtID.ToString + " AND yr_journ_id = " + yacht_journal_id.ToString)
            sQuery.Append(" AND yr_contact_type NOT IN ('71') AND comp_active_flag = 'Y' AND comp_hide_flag = 'N')")
            sQuery.Append(" ORDER BY yct_seq_no, yr_seq_no, yr_contact_type, comp_name")

            SqlConn.ConnectionString = localFunctions.clientConnectStr
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString
            SqlReader = SqlCommand.ExecuteReader()

            outString = "<table width='100%' align='center' cellspacing='0' cellpadding='4'>"

            If SqlReader.HasRows Then

                Do While SqlReader.Read


                    page_break_count = page_break_count + 1

                    If page_break_count = page_break_limit Then
                        outString += "</td></tr></table></td></tr></table>"
                        outString += "<table width='100%' align='center' class='break'><tr><td>&nbsp;</td></tr></table>"
                        outString += build_full_spec_yacht_header(nYachtID, "Yacht Company / Contacts", "", "")
                        outString += "<table width='100%' align='center' cellspacing='0' cellpadding='4'>"
                        page_break_count = 1
                    End If


                    If (column_color = "white") Then
                        If bWordReport Then
                            outString += "<tr valign='top'><td width='60%' height='700' bgcolor='white' valign='top' class='text_text'><b>"
                        Else
                            outString += "<tr valign='top'><td width='60%' bgcolor='white' valign='top' class='text_text'><b>"
                        End If
                    Else
                        If bWordReport Then
                            outString += "<tr valign='top' height='70'><td width='60%' height='700' bgcolor='#E6E6E6' class='text_text'><b>"
                        Else
                            outString += "<tr valign='top'><td width='60%' bgcolor='#E6E6E6' class='text_text'><b>"
                        End If
                    End If

                    If Not IsDBNull(SqlReader.Item("yct_name")) Then
                        outString += SqlReader.Item("yct_name").ToString.Trim + " "
                    End If

                    If Not IsDBNull(SqlReader.Item("yr_owner_percent")) Then
                        If CLng(SqlReader.Item("yr_owner_percent").ToString) > 0 And CLng(SqlReader.Item("yr_owner_percent").ToString) < 100 Then
                            outString += " [" + SqlReader.Item("yr_owner_percent").ToString.Trim + "] "
                        End If
                    End If

                    outString += " - " + commonEvo.get_company_info_fromID(CLng(SqlReader.Item("comp_id").ToString), 0, True, False, "", "")

                    If (column_color = "white") Then
                        If bWordReport Then
                            outString += "&nbsp;</td><td width='40%' bgcolor='#E6E6E6' valign='top' height='70' class='text_text'><b>"
                        Else
                            outString += "&nbsp;</td><td width='40%' bgcolor='#E6E6E6' valign='top' class='text_text'><b>"
                        End If

                        column_color = "other"
                    Else
                        If bWordReport Then
                            outString += "&nbsp;</td><td width='40%' bgcolor='white' height='70' valign='top' class='text_text'><b>"
                        Else
                            outString += "&nbsp;</td><td width='40%' bgcolor='white' valign='top' class='text_text'><b>"
                        End If
                        column_color = "white"
                    End If

                    If Not IsDBNull(SqlReader.Item("contact_sirname")) Then
                        outString += SqlReader.Item("contact_sirname").ToString.Trim + " "
                    End If

                    If Not IsDBNull(SqlReader.Item("contact_first_name")) Then
                        outString += SqlReader.Item("contact_first_name").ToString.Trim + " "
                    End If

                    If Not IsDBNull(SqlReader.Item("contact_middle_initial")) Then
                        outString += SqlReader.Item("contact_middle_initial").ToString.Trim + ". "
                    End If

                    If Not IsDBNull(SqlReader.Item("contact_last_name")) Then
                        outString += SqlReader.Item("contact_last_name").ToString.Trim + "</b> "
                    End If

                    If Not IsDBNull(SqlReader.Item("contact_suffix")) Then
                        outString += "<b>" + SqlReader.Item("contact_suffix").ToString.Trim + "</b>"
                    End If

                    If Not IsDBNull(SqlReader.Item("contact_title")) Then
                        outString += "<br />" + SqlReader.Item("contact_title").ToString.Trim + "<br />"
                    End If

                    If Not IsDBNull(SqlReader.Item("contact_email_address")) Then
                        outString += SqlReader.Item("contact_email_address").ToString.Trim + "<br />"
                    End If

                    If Not IsDBNull(SqlReader.Item("comp_id")) And Not IsDBNull(SqlReader.Item("contact_id")) Then
                        outString += build_full_spec_company_contact_phone(CLng(SqlReader.Item("comp_id").ToString), SqlReader.Item("contact_id"))
                    End If

                    outString += "</td></tr>"

                    contact_counter = contact_counter + 1
                Loop

            End If

            If bWordReport Then
                If contact_counter < 10 Then
                    sub_counter = 10 - contact_counter
                    Do While sub_counter > 0
                        outString += "<tr><td height='70'>&nbsp;</td></tr>"
                        sub_counter = sub_counter - 1
                    Loop
                End If
            End If

            outString += "</table>"

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_yacht_contacts()" + ex.Message
        Finally

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

            SqlReader.Close()


        End Try

        Return outString

    End Function

    Public Function build_full_spec_yacht_port_information(ByRef SQLReader As SqlClient.SqlDataReader) As String

        Dim htmlOutput As String = ""

        Dim bHadPort As Boolean = False

        Try

            If Not IsNothing(SQLReader) And SQLReader.HasRows Then

                htmlOutput += "<br /><table width='70%' cellspacing='0' cellpadding='4'><tr><td valign='middle' align='left' class='white_feat_header_text'>Port(s) Information</td></tr>"
                htmlOutput += "<tr><td class='white_feat_text'>"

                If Not IsDBNull(SQLReader.Item("reg_port")) Then
                    htmlOutput += "Registered : " + SQLReader.Item("reg_port").ToString.Trim
                    bHadPort = True
                Else
                    htmlOutput += "Registered : Unknown"

                End If

                If Not IsDBNull(SQLReader.Item("ly_port")) Then
                    htmlOutput += "<br />Lying : " + SQLReader.Item("ly_port").ToString.Trim
                    bHadPort = True
                Else
                    htmlOutput += "<br />Lying : Unknown"
                End If

                If Not IsDBNull(SQLReader.Item("home_port")) Then
                    htmlOutput += "<br />Home : " + SQLReader.Item("home_port").ToString.Trim
                    bHadPort = True
                Else
                    htmlOutput += "<br />Home : Unknown"
                End If

                htmlOutput += "</td></tr></table>"

            End If

            SQLReader.Close()

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_yacht_port_information()" + ex.Message
        End Try

        If Not bHadPort Then
            htmlOutput = ""
        End If

        Return htmlOutput

    End Function

    Public Function build_full_spec_yacht_details(ByVal nYachtID As Long, ByVal nYachtJournalID As Long, ByVal detail_type As String, ByVal update_date As String, ByVal done_by As String) As String

        Dim last_detail_type As String = ""
        Dim sQuery As New StringBuilder()
        Dim outString As New StringBuilder()

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader = Nothing
        Dim SqlException As SqlClient.SqlException = Nothing

        Try

            sQuery.Append("SELECT * FROM Yacht_Details WITH(NOLOCK)")
            sQuery.Append(" INNER JOIN Yacht_Details_Category WITH(NOLOCK) ON (ydc_name = yd_name AND ydc_type = yd_type)")
            sQuery.Append(" WHERE yd_yt_id = " + nYachtID.ToString + " AND yd_journ_id = " + nYachtJournalID.ToString)
            sQuery.Append(" AND lower(yd_type) = '" + detail_type.ToLower.Trim + "' AND yd_description <> ''")
            sQuery.Append(" ORDER BY ydc_seq_no ASC, yd_name ASC, yd_description, yd_id DESC")

            SqlConn.ConnectionString = localFunctions.clientConnectStr
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString
            SqlReader = SqlCommand.ExecuteReader()

            If SqlReader.HasRows Then

                outString.Append("<tr><td height='5'></td></tr>")

                outString.Append("<tr><td colspan='2' width='100%' class='header_text'>" + detail_type + " Details " + update_date + "</font>&nbsp;</td></tr>")
                outString.Append(done_by)
                outString.Append("<tr><td width='2%'>&nbsp;</td><td>")

                Do While SqlReader.Read

                    If Not IsDBNull(SqlReader.Item("yd_name")) Then

                        If last_detail_type.ToLower.Trim = SqlReader.Item("yd_name").ToString.ToLower.Trim Then
                            outString.Append("<font class='text_text2'> " + Server.HtmlEncode(SqlReader.Item("yd_description").ToString.Trim) + "; </font>")
                        Else
                            outString.Append("<font class='small_header_text2'>" + SqlReader.Item("yd_name").ToString.Trim + "</font><font class='text_text2'>: " + Server.HtmlEncode(SqlReader.Item("yd_description").ToString.Trim) + "; </font>")
                        End If

                        last_detail_type = SqlReader.Item("yd_name").ToString.Trim

                    End If


                Loop

                outString.Append("</td></tr>")

            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_yacht_details()" + ex.Message
        Finally

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

            SqlReader.Close()


        End Try

        Return outString.ToString

        outString = Nothing

    End Function

    Public Function build_full_spec_yacht_compliance_certs(ByVal nYachtID As Long, ByRef SqlCommand As SqlClient.SqlCommand, ByRef SQLReader As SqlClient.SqlDataReader) As String

        Dim htmlOutput As New StringBuilder()
        Dim type_damage As String = ""

        Dim sQuery As New StringBuilder()

        Try

            sQuery.Append("SELECT * FROM yacht_compliance WITH(NOLOCK) INNER JOIN yacht_compliance_types WITH(NOLOCK) ON yct_id = yc_cert_id")
            sQuery.Append(" WHERE yc_yt_id = " + nYachtID.ToString)
            sQuery.Append(" and yc_journ_id = " & yacht_journal_id & " ")


            SqlCommand.CommandText = sQuery.ToString
            SQLReader = SqlCommand.ExecuteReader()

            If SQLReader.HasRows Then

                htmlOutput.Append("<table width='70%' cellspacing='0' cellpadding='4'>")
                htmlOutput.Append("<tr><td valign='middle' align='left' class='white_feat_header_text' colspan='2'>Compliance and Certifications</td></tr>")

                Do While SQLReader.Read

                    htmlOutput.Append("<tr><td class='white_feat_text' valign='middle' align='left' width='2%' >&#10003;</td>")
                    htmlOutput.Append("<td class='white_feat_text' valign='middle' align='left'>")

                    If Not IsDBNull(SQLReader.Item("yc_cert_date")) And Not String.IsNullOrEmpty(SQLReader.Item("yc_cert_date").ToString) Then
                        If Year(SQLReader.Item("yc_cert_date")) > 1900 Then
                            htmlOutput.Append(FormatDateTime(SQLReader.Item("yc_cert_date").ToString, DateFormat.ShortDate) + ": ")
                        End If
                    End If

                    If Not IsDBNull(SQLReader.Item("yct_type")) And Not String.IsNullOrEmpty(SQLReader.Item("yct_type").ToString) Then
                        htmlOutput.Append(SQLReader.Item("yct_type").ToString)
                    End If

                    If Not IsDBNull(SQLReader.Item("yc_cert_note")) And Not String.IsNullOrEmpty(SQLReader.Item("yc_cert_note").ToString) Then
                        htmlOutput.Append(", " + SQLReader.Item("yc_cert_note").ToString)
                    End If

                    htmlOutput.Append("</td></tr>")

                Loop

                htmlOutput.Append("</table>")

            End If

            SQLReader.Close()

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_aircraft_features()" + ex.Message
        End Try

        Return htmlOutput.ToString

    End Function

    Public Function build_full_spec_yacht_engine_info(ByVal nYachtID As Long, ByVal nYachtJournalID As Long, ByVal engine_start As String) As String

        Dim sQuery As New StringBuilder()
        Dim outString As New StringBuilder()

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader = Nothing
        Dim SqlException As SqlClient.SqlException = Nothing

        Dim counter As Integer = 0

        Try

            sQuery.Append("SELECT DISTINCT ye_engine_sernbr, ye_engine_ttsn, yem_engine_model, ye_id, yc_engine_location, ye_engine_maintenance, yem_engine_mfr_comp_id")
            sQuery.Append(" FROM yacht_engines WITH(NOLOCK) INNER JOIN yacht_engine_models WITH(NOLOCK) ON yem_engine_model_id = ye_engine_model_id")
            sQuery.Append(" WHERE ye_yt_id = " + nYachtID.ToString)
            sQuery.Append(" and ye_journ_id = " & yacht_journal_id & " ")
            sQuery.Append(" ORDER BY ye_engine_sernbr, ye_engine_ttsn, yem_engine_model DESC")

            SqlConn.ConnectionString = localFunctions.clientConnectStr
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString
            SqlReader = SqlCommand.ExecuteReader()

            If SqlReader.HasRows Then

                outString.Append("<tr><td height='5'></td></tr>")

                outString.Append("<tr><td colspan='2' class='header_text'>Engine Information</td></tr>")
                outString.Append(engine_start)
                outString.Append("<tr><td width='2%'>&nbsp;</td><td>")

                outString.Append("<tr><td colspan='2'><table border='1' bordercolor='#949494' cellpadding='2' cellspacing='0'><tr>")
                outString.Append("<td class='text_text' align='center'><font size='-2'>Model Name</font></td>")
                'outString.Append("<td class='text_text' align='center'><font size='-2'>Horsepower</font></td>")
                outString.Append("<td class='text_text' align='center'><font size='-2'>MFR Name</font></td>")
                outString.Append("<td class='text_text' align='center'><font size='-2'>Location</font></td>")
                outString.Append("<td class='text_text' align='center'><font size='-2'>Total Time</font></td>")
                outString.Append("<td class='text_text' align='center'><font size='-2'>Serial Nbr</font></td>")
                outString.Append("<td class='text_text' align='center'><font size='-2'>Notes</font></td>")
                outString.Append("</tr>" + vbCrLf)

                Do While SqlReader.Read()

                    outString.Append("<tr><td class='text_text' valign='middle' align='left'>")

                    If Not IsDBNull(SqlReader.Item("yem_engine_model")) Then
                        If Not String.IsNullOrEmpty(SqlReader.Item("yem_engine_model").ToString) Then
                            outString.Append(SqlReader.Item("yem_engine_model").ToString)
                        End If
                    End If

                    outString.Append("</td>")

                    ' outString.Append("<td class='text_text' valign='middle' align='left'>")

                    'If Not IsDBNull(SqlReader.Item("yem_engine_horsepower")) Then
                    '  If Not String.IsNullOrEmpty(SqlReader.Item("yem_engine_horsepower").ToString) Then
                    '    If CLng(SqlReader.Item("yem_engine_horsepower")) > 0 Then
                    '      outString.Append(SqlReader.Item("yem_engine_horsepower").ToString)
                    '    End If
                    '  End If
                    'End If

                    'outString.Append("</td>")

                    outString.Append("<td class='text_text' valign='middle' align='left'>")

                    If Not IsDBNull(SqlReader.Item("yem_engine_mfr_comp_id")) Then
                        If Not String.IsNullOrEmpty(SqlReader.Item("yem_engine_mfr_comp_id").ToString) Then
                            outString.Append(Server.HtmlEncode(commonEvo.get_company_name_fromID(CLng(SqlReader.Item("yem_engine_mfr_comp_id").ToString), 0, False, False, "")))
                        End If
                    End If

                    outString.Append("</td>")

                    outString.Append("<td class='text_text' valign='middle' align='left'>")

                    If Not IsDBNull(SqlReader.Item("yc_engine_location")) Then
                        If Not String.IsNullOrEmpty(SqlReader.Item("yc_engine_location").ToString) Then
                            outString.Append(SqlReader.Item("yc_engine_location").ToString)
                        End If
                    End If

                    outString.Append("</td>")
                    outString.Append("<td class='text_text' valign='middle' align='left'>")

                    If Not IsDBNull(SqlReader.Item("ye_engine_ttsn")) Then
                        If Not String.IsNullOrEmpty(SqlReader.Item("ye_engine_ttsn").ToString) Then
                            If CLng(SqlReader.Item("ye_engine_ttsn")) > 0 Then
                                outString.Append(SqlReader.Item("ye_engine_ttsn").ToString)
                            End If
                        End If
                    End If

                    outString.Append("</td>")
                    outString.Append("<td class='text_text' valign='middle' align='left'>")

                    If Not IsDBNull(SqlReader.Item("ye_engine_sernbr")) Then
                        If Not String.IsNullOrEmpty(SqlReader.Item("ye_engine_sernbr").ToString) Then
                            outString.Append(SqlReader.Item("ye_engine_sernbr").ToString)
                        End If
                    End If

                    outString.Append("</td>")
                    outString.Append("<td class='text_text' valign='middle' align='left'>")

                    If Not IsDBNull(SqlReader.Item("ye_engine_maintenance")) Then
                        If Not String.IsNullOrEmpty(SqlReader.Item("ye_engine_maintenance").ToString) Then
                            outString.Append(SqlReader.Item("ye_engine_maintenance").ToString)
                        End If
                    End If

                    outString.Append("</td></tr>")

                Loop

                outString.Append("</table></td></tr>")

            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_yacht_engine_info(ByVal nYachtID As Long, ByVal nYachtJournalID As Long, ByVal engine_start As String) As String" + ex.Message
        Finally

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

            SqlReader.Close()

            SqlReader = Nothing

        End Try

        Return outString.ToString

        outString = Nothing

    End Function

    Public Function build_full_spec_yacht_previous_names(ByVal nYachtID As Long, ByVal nYachtJournalID As Long) As String

        Dim sQuery As New StringBuilder()
        Dim outString As New StringBuilder()

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader = Nothing
        Dim SqlException As SqlClient.SqlException = Nothing

        Dim counter As Integer = 0

        Try

            sQuery.Append("SELECT * FROM Yacht_Previous_Names WITH(NOLOCK)")
            sQuery.Append(" WHERE ypn_yt_id = " + nYachtID.ToString)
            If nYachtJournalID > 0 Then
                sQuery.Append(" and (ypn_date_name_changed <= '" & CDate(yacht_journal_date) & "' or ypn_date_name_changed is null)")
            End If
            sQuery.Append(" ORDER BY ypn_date_name_changed DESC")

            SqlConn.ConnectionString = localFunctions.clientConnectStr
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString
            SqlReader = SqlCommand.ExecuteReader()

            If SqlReader.HasRows Then

                outString.Append("<tr><td height='5'></td></tr>")
                outString.Append("<tr><td colspan='2' class='header_text'>Previous Names</td></tr>")

                Do While SqlReader.Read()

                    outString.Append("<tr><td width='2%'>&nbsp;</td><td>")

                    If Not IsDBNull(SqlReader.Item("ypn_previous_name")) Then
                        If Not String.IsNullOrEmpty(SqlReader.Item("ypn_previous_name").ToString) Then
                            outString.Append("<font class='small_header_text'>Previous Name : </font>")
                            outString.Append("<font class='text_text'>" + SqlReader.Item("ypn_previous_name").ToString.Trim + "</font>")
                        End If
                    End If

                    If Not IsDBNull(SqlReader.Item("ypn_date_name_changed")) Then
                        If Not String.IsNullOrEmpty(SqlReader.Item("ypn_date_name_changed").ToString) Then
                            outString.Append("<font class='text_text'>, changed in " + Year(SqlReader.Item("ypn_date_name_changed").ToString).ToString.Trim + "</font>")
                        End If
                    End If

                    outString.Append("</td></tr>")

                Loop

            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_yacht_previous_names(ByVal nYachtID As Long, ByVal nYachtJournalID As Long) As String" + ex.Message
        Finally

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

            SqlReader.Close()

            SqlReader = Nothing

        End Try

        Return outString.ToString

        outString = Nothing


    End Function

    Public Function build_full_spec_notes_page(ByVal nAircraftID As Long, ByVal nYachtID As Long) As String

        Dim sQuery = New StringBuilder()
        Dim outString As New StringBuilder()
        Dim something_shown As Boolean = False

        Dim notes_datatable As DataTable = Nothing
        Dim toggleRowColor As Boolean = False

        Try

            outString.Append("<table width='100%' cellspacing='0' cellpadding='4' border='0'>")

            If bHasServerNotes And (nAircraftID > 0) Then 'If they're plus + notes users. 
                notes_datatable = localFunctions.get_all_server_notes(nAircraftID, nYachtID)
            ElseIf bHasStandardCloudNotes Then 'if they're standard cloud users
                notes_datatable = localFunctions.get_all_cloud_notes(nAircraftID, nYachtID)
            End If

            If Not IsNothing(notes_datatable) Then

                If notes_datatable.Rows.Count > 0 Then

                    For Each Row As DataRow In notes_datatable.Rows

                        If Not toggleRowColor Then
                            outString.Append("<tr class='alt_row'>")
                            toggleRowColor = True
                        Else
                            outString.Append("<tr bgcolor='white'>")
                            toggleRowColor = False
                        End If

                        outString.Append("<td valign='middle' align='center'><font class='small_header_text2'>")

                        If Not IsDBNull(Row.Item("lnote_entry_date")) Then
                            If Not String.IsNullOrEmpty(Row.Item("lnote_entry_date").ToString.Trim) Then
                                outString.Append(FormatDateTime(Row.Item("lnote_entry_date").ToString, DateFormat.ShortDate))
                            End If
                        End If


                        If Not (IsDBNull(Row.Item("lnote_user_name"))) Then
                            If Not String.IsNullOrEmpty(Row.Item("lnote_user_name").ToString.Trim) Then
                                outString.Append(" - " + Row.Item("lnote_user_name").ToString.Trim)
                            End If
                        End If

                        outString.Append("</font>")

                        If Not IsDBNull(Row.Item("lnote_note")) Then
                            If Not String.IsNullOrEmpty(Row.Item("lnote_note").ToString.Trim) Then
                                outString.Append(" - <font class='text_text2'>" + Row.Item("lnote_note").ToString.Trim + "</font>")
                            End If
                        End If

                        outString.Append("</td></tr>")

                    Next

                    something_shown = True

                End If

            End If

            If Not something_shown Then
                outString.Append("<tr><td valign='middle' align='center' class='text_text'> No Notes Currently Available </td></tr>")
            End If

            outString.Append("</table>")


        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_notes_page()" + ex.Message

        End Try

        Return outString.ToString

        outString = Nothing

    End Function

    Public Function Get_Yacht_History(ByVal yt_id As Long, ByVal in_JournalID As Long) As String

        Get_Yacht_History = ""

        Dim out_HistoricalRs As New DataTable
        Dim htmlOut As StringBuilder = New StringBuilder()
        Dim SqlReader As System.Data.SqlClient.SqlDataReader = Nothing
        Dim sQuery As String = ""

        Dim BGColor As String = ""
        Dim fJourn_date As String = ""
        Dim fJcat_subcategory_name As String = ""
        Dim fJourn_id As Long = 0
        Dim fJourn_subject As String = ""
        Dim fJourn_customer_note As String = ""
        Dim fJcat_auto_subject_flag As String = ""
        Dim isFromJFWAFW As Boolean = False
        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlException As SqlClient.SqlException = Nothing




        Try

            sQuery = "SELECT journ_id, journ_yacht_id, journ_date, journ_subject, jcat_subcategory_name, "
            sQuery = sQuery & " jcat_auto_subject_flag, journ_subcategory_code, journ_customer_note, yt_id"
            sQuery = sQuery & " FROM Journal WITH(NOLOCK) INNER JOIN Journal_Category WITH(NOLOCK) ON journ_subcategory_code = jcat_subcategory_code "
            sQuery = sQuery & " inner join yacht on journ_yacht_id = yt_id and journ_id = yt_journ_id "
            sQuery = sQuery & " WHERE jcat_category_code = 'YH' "
            sQuery = sQuery & " AND RIGHT(journ_subcategory_code, 4) <> 'CORR' "
            sQuery = sQuery & " AND journ_yacht_id = " & yacht_id
            If Trim(yacht_journal_date) <> "" Then
                sQuery = sQuery & " AND journ_date <= '" & yacht_journal_date & "' "
            End If
            sQuery = sQuery & " ORDER BY journ_date DESC, journ_id DESC"

            SqlConn.ConnectionString = localFunctions.clientConnectStr
            SqlConn.Open()
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90
            SqlCommand.CommandText = sQuery
            SqlCommand.Connection = SqlConn

            SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


            Try
                out_HistoricalRs.Load(SqlReader)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = out_HistoricalRs.GetErrors()
            End Try



            If Not IsNothing(out_HistoricalRs) Then

                If out_HistoricalRs.Rows.Count > 0 Then
                    htmlOut.Append("<table class='engine_tab' cellpadding='2' cellspacing='0' width='100%'>")

                    For Each r As DataRow In out_HistoricalRs.Rows

                        If BGColor = "engine_6" Then
                            BGColor = "engine_5"
                        Else
                            BGColor = "engine_6"
                        End If

                        If Not IsDBNull(r("journ_date")) And Not String.IsNullOrEmpty(r("journ_date").ToString) Then
                            fJourn_date = FormatDateTime(r("journ_date").ToString.Trim, DateFormat.ShortDate)
                        End If

                        If Not IsDBNull(r("jcat_subcategory_name")) And Not String.IsNullOrEmpty(r("jcat_subcategory_name").ToString) Then
                            fJcat_subcategory_name = r("jcat_subcategory_name").ToString.Trim
                        End If

                        If Not IsDBNull(r("journ_id")) And Not String.IsNullOrEmpty(r("journ_id").ToString) Then
                            fJourn_id = CLng(r("journ_id").ToString)
                        End If

                        If Not IsDBNull(r("journ_subject")) And Not String.IsNullOrEmpty(r("journ_subject").ToString) Then
                            fJourn_subject = r("journ_subject").ToString.Trim
                        End If

                        If Not IsDBNull(r("journ_customer_note")) And Not String.IsNullOrEmpty(r("journ_customer_note").ToString) Then
                            fJourn_customer_note = r("journ_customer_note").ToString.Trim
                        End If

                        If Not IsDBNull(r("jcat_auto_subject_flag")) And Not String.IsNullOrEmpty(r("jcat_auto_subject_flag").ToString) Then
                            fJcat_auto_subject_flag = r("jcat_auto_subject_flag").ToString.ToUpper.Trim
                        End If


                        htmlOut.Append("<tr><td valign='top' align='left' class='" & BGColor & " date_block'>")
                        htmlOut.Append("<span>")

                        htmlOut.Append("<span ")

                        htmlOut.Append(">" + fJourn_date)

                        htmlOut.Append("</span></span></td>")


                        htmlOut.Append("<td valign='top' align='left' class='" & BGColor & "'><span class='url_link'>")


                        htmlOut.Append("<span")

                        htmlOut.Append(">")

                        If fJcat_auto_subject_flag = "Y" Then

                            htmlOut.Append(Constants.cSingleSpace + fJcat_subcategory_name)

                            htmlOut.Append(" - " + fJourn_subject)

                        Else
                            htmlOut.Append(Constants.cSingleSpace + fJourn_subject)
                        End If

                        htmlOut.Append("</a>")

                        htmlOut.Append("</span>")
                        htmlOut.Append("<br />")


                        htmlOut.Append("</td></tr>")



                    Next

                    htmlOut.Append("</table>")
                End If

            End If


            Get_Yacht_History = htmlOut.ToString

        Catch ex As Exception
        Finally
            SqlConn.Close()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing
        End Try
    End Function

    Public Function Insert_Page_Break_PDF() As String
        Insert_Page_Break_PDF = ""
        Try


            If reportType.SelectedValue = "Word" Then
                Insert_Page_Break_PDF = "<br style='page-break-before: always'>"
            Else
                Insert_Page_Break_PDF = "</td></tr></table></td></tr></table></td></tr></table></td></tr></table>"
                Insert_Page_Break_PDF &= "<table width='100%' align='center' class='break'><tr><td>&nbsp;</td></tr></table>"
            End If

        Catch ex As Exception
            ' Response.Write("Error " & ex.Message & " in Insert_Page_Break() As String")
            'clsGeneral.clsGeneral.LogError("Error " & ex.Message & " in Insert_Page_Break() As String", aclsData_Temp)
        End Try
    End Function

#End Region

#Region "report_44_functions"

#End Region

#Region "report_45_functions"
    ' Document View Report
    Public Function create_report_45_documents_list_with_aircraft_information(ByRef record_count As Long) As String

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim report_45_datatable As New DataTable

        Dim adoRS_45 As System.Data.SqlClient.SqlDataReader : adoRS_45 = Nothing

        Dim htmlOut = New StringBuilder()
        Dim sQuery As New StringBuilder()

        Try
            SqlConn.ConnectionString = localFunctions.clientConnectStr

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 90

            If Not IsNothing(HttpContext.Current.Session.Item("documentsDataTable")) Then
                report_45_datatable = CType(HttpContext.Current.Session.Item("documentsDataTable"), DataTable)
            Else
                Return ""
            End If

            If bHtmlReport Then
                htmlOut.Append("<!DOCTYPE html>")
                htmlOut.Append("<html lang='en'>")
                htmlOut.Append("<head>")
                htmlOut.Append("<meta http-equiv='Content-Language' content='en-us' />")
                htmlOut.Append("<meta http-equiv='Content-Type' content='text/html; charset=windows-1252' />")
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='common/jetnet.css' />")
                htmlOut.Append("<title>JETNET - Export of Current Document List with Company and Aircraft Info</title>")
                htmlOut.Append("</head>")
                htmlOut.Append("<body style='background: white; margin-top:10px; margin-left:10px;'>")
                htmlOut.Append("<div style='text-align:center;'>")
            End If

            If bExcelReport Then
                htmlOut.Append(localFunctions.include_excel_report_style() + vbCrLf)
                htmlOut.Append("<table border='1' cellpadding='2' cellspacing='0'>")
            ElseIf bHtmlReport Then
                htmlOut.Append("<table class='centerTable' border='0' cellpadding='2' cellspacing='0' width='100%'>")
            End If

            record_count = report_45_datatable.Rows.Count

            If report_45_datatable.Rows.Count > 0 Then

                If chkShowReportHeader.Checked Then

                    If bExcelReport Or bHtmlReport Then

                        htmlOut.Append("<tr bgcolor='#CCCCCC'>")

                        htmlOut.Append("<td>DOCDATE</td>")
                        htmlOut.Append("<td>DOCTYPE</td>")

                        htmlOut.Append("<td>COMPANY</td>")
                        htmlOut.Append("<td>COMPALTNAME</td>")
                        htmlOut.Append("<td>COMPEMAIL</td>")
                        htmlOut.Append("<td>COMPWEBADDRESS</td>")
                        htmlOut.Append("<td>COMPADDRESS1</td>")
                        htmlOut.Append("<td>COMPADDRESS2</td>")
                        htmlOut.Append("<td>COMPCITY</td>")
                        htmlOut.Append("<td>COMPSTATE</td>")
                        htmlOut.Append("<td>COMPSTATEABBR</td>")
                        htmlOut.Append("<td>COMPPOSTALCODE</td>")
                        htmlOut.Append("<td>COMPCOUNTRY</td>")
                        htmlOut.Append("<td>COMPOFFICE</td>")
                        htmlOut.Append("<td>COMPFAX</td>")
                        htmlOut.Append("<td>COMPMOBILE</td>")

                        htmlOut.Append("<td>MAKE</td>")
                        htmlOut.Append("<td>MODEL</td>")
                        htmlOut.Append("<td>SERIALNBR</td>")
                        htmlOut.Append("<td>REGNBR</td>")

                        htmlOut.Append("<td>TRANSACTIONDESCRIPTION</td>")
                        htmlOut.Append("<td>TRANSACTIONDATE</td>")

                        htmlOut.Append("</tr>" + vbCrLf)

                    ElseIf bTextCommaReport Then

                        htmlOut.Append(Constants.QUOTE + "DOCDATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "DOCTYPE" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "COMPANY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPALTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPEMAIL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPWEBADDRESS" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPADDRESS1" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPADDRESS2" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPCITY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPSTATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPSTATEABBR" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPPOSTALCODE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPCOUNTRY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPOFFICEE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPFAX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "COMPMOBILE" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "MAKE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "MODEL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SERIALNBR" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "REGNBR" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "TRANSACTIONDESCRIPTION" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "TRANSACTIONDATE" + Constants.QUOTE)

                        htmlOut.Append(vbCrLf)

                    ElseIf bTextTabReport Then

                        htmlOut.Append("DOCDATE" + vbTab)
                        htmlOut.Append("DOCTYPE" + vbTab)

                        htmlOut.Append("COMPANY" + vbTab)
                        htmlOut.Append("COMPALTNAME" + vbTab)
                        htmlOut.Append("COMPEMAIL" + vbTab)
                        htmlOut.Append("COMPWEBADDRESS" + vbTab)
                        htmlOut.Append("COMPADDRESS1" + vbTab)
                        htmlOut.Append("COMPADDRESS2" + vbTab)
                        htmlOut.Append("COMPCITY" + vbTab)
                        htmlOut.Append("COMPSTATE" + vbTab)
                        htmlOut.Append("COMPSTATEABBR" + vbTab)
                        htmlOut.Append("COMPPOSTALCODE" + vbTab)
                        htmlOut.Append("COMPCOUNTRY" + vbTab)
                        htmlOut.Append("COMPOFFICE" + vbTab)
                        htmlOut.Append("COMPFAX" + vbTab)
                        htmlOut.Append("COMPMOBILE" + vbTab)

                        htmlOut.Append("MAKE" + vbTab)
                        htmlOut.Append("MODEL" + vbTab)
                        htmlOut.Append("SERIALNBR" + vbTab)
                        htmlOut.Append("REGNBR" + vbTab)

                        htmlOut.Append("TRANSACTIONDESCRIPTION" + vbTab)
                        htmlOut.Append("TRANSACTIONDATE")

                        htmlOut.Append(vbCrLf)

                    End If 'vbTab

                End If ' chkShowReportHeader.Checked Then

                For Each Row As DataRow In report_45_datatable.Rows

                    htmlOut.Append(get_references_45(Row))

                Next

                If bHtmlReport Or bExcelReport Then
                    htmlOut.Append("</table>")
                End If

                If bHtmlReport Then
                    htmlOut.Append("</div>")
                    htmlOut.Append("</body>")
                    htmlOut.Append("</html>")
                End If

            End If


        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Create_Report_45_Docuemnt_list_With_Aircraft_Information() As String" + ex.Message
        Finally

            adoRS_45 = Nothing
            report_45_datatable = Nothing

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOut.ToString

    End Function

    Public Function get_references_45(ByRef currentRow As DataRow) As String

        Dim CompInfo As String = ""
        Dim CompPhoneInfo As String = ""
        Dim ContactInfo As String = ""
        Dim ContactPhoneInfo As String = ""

        Dim returnInfo As String = ""
        Dim htmlOut = New StringBuilder()

        Try

            If bHtmlReport Or bExcelReport Then

                htmlOut.Append("<tr>")

                If Not IsDBNull(currentRow("adoc_doc_date")) Then
                    htmlOut.Append("<td valign='middle' align='left' nowrap='nowrap'>" + FormatDateTime(currentRow.Item("adoc_doc_date").ToString, DateFormat.ShortDate).ToString + "</td>")
                Else
                    htmlOut.Append("<td></td>")
                End If

                If Not IsDBNull(currentRow("adoc_doc_type")) Then
                    htmlOut.Append("<td valign='middle' align='left' nowrap='nowrap'>" + currentRow.Item("adoc_doc_type").ToString + "</td>")
                Else
                    htmlOut.Append("<td></td>")
                End If

            ElseIf bTextCommaReport Then

                If Not IsDBNull(currentRow("adoc_doc_date")) Then
                    htmlOut.Append(Constants.QUOTE + FormatDateTime(currentRow.Item("adoc_doc_date").ToString, DateFormat.ShortDate).ToString + Constants.QUOTE + Constants.cCommaDelim)
                Else
                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                End If

                If Not IsDBNull(currentRow("adoc_doc_type")) Then
                    htmlOut.Append(Constants.QUOTE + currentRow.Item("adoc_doc_type").ToString + Constants.QUOTE + Constants.cCommaDelim)
                Else
                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                End If

            ElseIf bTextTabReport Then

                If Not IsDBNull(currentRow("adoc_doc_date")) Then
                    htmlOut.Append(FormatDateTime(currentRow.Item("adoc_doc_date").ToString, DateFormat.ShortDate).ToString + vbTab)
                Else
                    htmlOut.Append(vbTab)
                End If

                If Not IsDBNull(currentRow("adoc_doc_type")) Then
                    htmlOut.Append(currentRow.Item("adoc_doc_type").ToString + vbTab)
                Else
                    htmlOut.Append(vbTab)
                End If

            End If

            ReturnCompanyInformation_Report(CLng(currentRow.Item("comp_id").ToString), 0, currentRow, CompPhoneInfo, CompInfo, chkIncludeContacts.Checked)

            If bHtmlReport Or bExcelReport Then
                htmlOut.Append(CompInfo + CompPhoneInfo)
            ElseIf bTextCommaReport Then
                htmlOut.Append(CompInfo + CompPhoneInfo + Constants.cCommaDelim)
            ElseIf bTextTabReport Then
                htmlOut.Append(CompInfo + CompPhoneInfo + vbTab)
            End If

            If bHtmlReport Or bExcelReport Then
                If Not IsDBNull(currentRow("amod_make_name")) Then
                    htmlOut.Append("<td valign='middle' align='left' nowrap='nowrap'>" + currentRow.Item("amod_make_name").ToString + "</td>")
                Else
                    htmlOut.Append("<td></td>")
                End If

                If Not IsDBNull(currentRow("amod_model_name")) Then
                    htmlOut.Append("<td valign='middle' align='left' nowrap='nowrap'>" + currentRow.Item("amod_model_name").ToString + "</td>")
                Else
                    htmlOut.Append("<td></td>")
                End If

                If Not IsDBNull(currentRow("ac_ser_no_full")) Then
                    htmlOut.Append("<td valign='middle' align='left' nowrap='nowrap' class='textformat'>" + currentRow.Item("ac_ser_no_full").ToString + "</td>")
                Else
                    htmlOut.Append("<td></td>")
                End If

                If Not IsDBNull(currentRow("ac_reg_no")) Then
                    htmlOut.Append("<td valign='middle' align='left' nowrap='nowrap' class='textformat'>" + currentRow.Item("ac_reg_no").ToString + "</td>")
                Else
                    htmlOut.Append("<td></td>")
                End If

                If Not IsDBNull(currentRow("journ_subject")) Then
                    htmlOut.Append("<td valign='middle' align='left' nowrap='nowrap'>" + currentRow.Item("journ_subject").ToString + "</td>")
                Else
                    htmlOut.Append("<td></td>")
                End If

                If Not IsDBNull(currentRow("journ_date")) Then
                    htmlOut.Append("<td valign='middle' align='left' nowrap='nowrap'>" + FormatDateTime(currentRow.Item("journ_date").ToString, DateFormat.ShortDate).ToString + "</td>")
                Else
                    htmlOut.Append("<td></td>")
                End If

                htmlOut.Append("</tr>" + vbCrLf)

            ElseIf bTextCommaReport Then

                If Not IsDBNull(currentRow("amod_make_name")) Then
                    htmlOut.Append(Constants.QUOTE + currentRow.Item("amod_make_name").ToString + Constants.QUOTE + Constants.cCommaDelim)
                Else
                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                End If

                If Not IsDBNull(currentRow("amod_model_name")) Then
                    htmlOut.Append(Constants.QUOTE + currentRow.Item("amod_model_name").ToString + Constants.QUOTE + Constants.cCommaDelim)
                Else
                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                End If

                If Not IsDBNull(currentRow("ac_ser_no_full")) Then
                    htmlOut.Append(Constants.QUOTE + currentRow.Item("ac_ser_no_full").ToString + Constants.QUOTE + Constants.cCommaDelim)
                Else
                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                End If

                If Not IsDBNull(currentRow("ac_reg_no")) Then
                    htmlOut.Append(Constants.QUOTE + currentRow.Item("ac_reg_no").ToString + Constants.QUOTE + Constants.cCommaDelim)
                Else
                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                End If

                If Not IsDBNull(currentRow("journ_subject")) Then
                    htmlOut.Append(Constants.QUOTE + currentRow.Item("journ_subject").ToString + Constants.QUOTE + Constants.cCommaDelim)
                Else
                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                End If

                If Not IsDBNull(currentRow("journ_date")) Then
                    htmlOut.Append(Constants.QUOTE + FormatDateTime(currentRow.Item("journ_date").ToString, DateFormat.ShortDate).ToString + Constants.QUOTE)
                Else
                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE)
                End If

                htmlOut.Append(vbCrLf)

            ElseIf bTextTabReport Then

                If Not IsDBNull(currentRow("amod_make_name")) Then
                    htmlOut.Append(currentRow.Item("amod_make_name").ToString + vbTab)
                Else
                    htmlOut.Append(vbTab)
                End If

                If Not IsDBNull(currentRow("amod_model_name")) Then
                    htmlOut.Append(currentRow.Item("amod_model_name").ToString + vbTab)
                Else
                    htmlOut.Append(vbTab)
                End If

                If Not IsDBNull(currentRow("ac_ser_no_full")) Then
                    htmlOut.Append(currentRow.Item("ac_ser_no_full").ToString + vbTab)
                Else
                    htmlOut.Append(vbTab)
                End If

                If Not IsDBNull(currentRow("ac_reg_no")) Then
                    htmlOut.Append(currentRow.Item("ac_reg_no").ToString + vbTab)
                Else
                    htmlOut.Append(vbTab)
                End If

                If Not IsDBNull(currentRow("journ_subject")) Then
                    htmlOut.Append(currentRow.Item("journ_subject").ToString + vbTab)
                Else
                    htmlOut.Append(vbTab)
                End If

                If Not IsDBNull(currentRow("journ_date")) Then
                    htmlOut.Append(FormatDateTime(currentRow.Item("journ_date").ToString, DateFormat.ShortDate).ToString)
                End If

                htmlOut.Append(vbCrLf)
            End If

        Catch ex As Exception

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in get_references_45(ByVal currentRow As DataRow) As String" + ex.Message

        End Try

        Return htmlOut.ToString

        htmlOut = Nothing

    End Function

#End Region

#Region "report_46_functions"

    Public Function create_report_46_export_current_yacht_list(ByRef record_count As Long) As String

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim report_46_datatable As New DataTable

        Dim adoRS_46 As System.Data.SqlClient.SqlDataReader : adoRS_46 = Nothing

        Dim htmlOut = New StringBuilder()
        Dim sQuery As New StringBuilder()

        Try

            SqlConn.ConnectionString = localFunctions.clientConnectStr

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 90



            sQuery.Append(" " + HttpContext.Current.Session.Item("MasterYachtSelect").ToString.Trim)
            sQuery.Append(",yt_asking_price, yt_foreign_currency_name, yt_foreign_asking_price, yt_ownership_type, ym_mfr_comp_id, yt_registered_country_flag, yt_displacement_tons, ym_nbr_hulls, yct_name,")
            sQuery.Append(" comp_name, comp_address1, comp_address2, comp_city, comp_state, comp_zip_code, comp_country, comp_email_address, comp_web_address,")
            sQuery.Append(" (select top 1 pnum_number_full from Phone_Numbers where comp_id = pnum_comp_id and comp_journ_id = pnum_journ_id and pnum_contact_id=0 and pnum_type='Office' and pnum_hide_customer='N') as officephone,")
            sQuery.Append(" (select top 1 pnum_number_full from Phone_Numbers where comp_id = pnum_comp_id and comp_journ_id = pnum_journ_id and pnum_contact_id=0 and pnum_type='Fax' and pnum_hide_customer='N') as faxphone")

            sQuery.Append(" " + HttpContext.Current.Session.Item("MasterYachtFrom").ToString.Trim)
            sQuery.Append(" " + HttpContext.Current.Session.Item("MasterYachtWhere").ToString.Trim)
            sQuery.Append(" ORDER BY ym_brand_name, ym_motor_type, ym_category_size, ym_model_name, yt_hull_mfr_nbr")

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />create_report_46_export_current_yacht_list()<br />" + sQuery.ToString

            If bHtmlReport Then
                htmlOut.Append("<!DOCTYPE html>")
                htmlOut.Append("<html lang='en'>")
                htmlOut.Append("<head>")
                htmlOut.Append("<meta http-equiv='Content-Language' content='en-us' />")
                htmlOut.Append("<meta http-equiv='Content-Type' content='text/html; charset=windows-1252' />")
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='common/jetnet.css' />")
                htmlOut.Append("<title>JETNET - Export of Current Yacht List</title>")
                htmlOut.Append("</head>")
                htmlOut.Append("<body style='background: white; margin-top:10px; margin-left:10px;'>")
                htmlOut.Append("<div style='text-align:center;'>")
            End If

            If bExcelReport Then
                htmlOut.Append("<table border='1' cellpadding='2' cellspacing='0'>")
            ElseIf bHtmlReport Then
                htmlOut.Append("<table class='centerTable' border='0' cellpadding='2' cellspacing='0' width='100%'>")
            End If

            SqlCommand.CommandText = sQuery.ToString
            adoRS_46 = SqlCommand.ExecuteReader()

            Try
                report_46_datatable.Load(adoRS_46)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = report_46_datatable.GetErrors()
            End Try

            adoRS_46.Close()
            adoRS_46 = Nothing

            record_count = report_46_datatable.Rows.Count

            If report_46_datatable.Rows.Count > 0 Then

                If chkShowReportHeader.Checked Then

                    htmlOut.Append("<tr bgcolor='#CCCCCC'>")

                    htmlOut.Append("<td align='left'>TYPE</td>")
                    htmlOut.Append("<td align='left'>SIZE</td>")
                    htmlOut.Append("<td align='left'>BRAND</td>")
                    htmlOut.Append("<td align='left'>MODEL</td>")
                    htmlOut.Append("<td align='left'>NAME</td>")
                    htmlOut.Append("<td align='left'>YEAR&nbsp;MFG</td>")
                    htmlOut.Append("<td align='left'>HULLTYPE</td>")
                    htmlOut.Append("<td align='left'>HULLNBR</td>")
                    htmlOut.Append("<td align='left'>LENGTH&nbsp;(ft)</td>")
                    htmlOut.Append("<td align='left'>DISPLACEMENT</td>")
                    htmlOut.Append("<td align='left'>MANUFACTURER</td>")
                    htmlOut.Append("<td align='left'>FLAG</td>")

                    If Not bAerodexFlag Then
                        htmlOut.Append("<td align='left'>FORSALESTATUS</td>")
                        htmlOut.Append("<td align='left'>ASKING</td>")
                        htmlOut.Append("<td align='left'>FOREIGNASKING</td>")
                        htmlOut.Append("<td align='left'>FOREIGNCURRENCY</td>")
                    End If

                    htmlOut.Append("<td align='left'>OWNERSHIP</td>")
                    htmlOut.Append("<td align='left'>RELATIONSHIP</td>")
                    htmlOut.Append("<td align='left'>COMPANY</td>")
                    htmlOut.Append("<td align='left'>ADDRESS1</td>")
                    htmlOut.Append("<td align='left'>ADDRESS2</td>")
                    htmlOut.Append("<td align='left'>CITY</td>")
                    htmlOut.Append("<td align='left'>STATE</td>")
                    htmlOut.Append("<td align='left'>ZIP</td>")
                    htmlOut.Append("<td align='left'>COUNTRY</td>")
                    htmlOut.Append("<td align='left'>EMAIL</td>")
                    htmlOut.Append("<td align='left'>WEB ADDRESS</td>")
                    htmlOut.Append("<td align='left'>OFFICE</td>")
                    htmlOut.Append("<td align='left'>FAX</td>")

                    htmlOut.Append("</tr>")

                    For Each Row As DataRow In report_46_datatable.Rows

                        htmlOut.Append("<tr>")

                        htmlOut.Append("<td align='left' valign='center' nowrap='nowrap'>")

                        If Not String.IsNullOrEmpty(Row.Item("ym_motor_type").ToString.Trim) Then

                            Select Case (Row.Item("ym_motor_type").ToString.ToUpper.Trim)
                                Case Constants.YMOD_MOTOR_HULL
                                    htmlOut.Append("Motor")
                                Case Constants.YMOD_SAIL_HULL
                                    htmlOut.Append("Sail")
                            End Select

                        End If

                        htmlOut.Append("</td>")

                        htmlOut.Append("<td align='left' valign='center' nowrap='nowrap'>")

                        If Not String.IsNullOrEmpty(Row.Item("ym_category_size").ToString.Trim) Then

                            Select Case (Row.Item("ym_category_size").ToString.ToUpper.Trim)
                                Case Constants.YMOD_TYPE_GIGA
                                    htmlOut.Append("Giga")
                                Case Constants.YMOD_TYPE_MEGA
                                    htmlOut.Append("Mega")
                                Case Constants.YMOD_TYPE_SUPER
                                    htmlOut.Append("Super")
                                Case Constants.YMOD_TYPE_LUXURY
                                    htmlOut.Append("Luxury")
                            End Select

                        End If

                        htmlOut.Append("</td>")

                        htmlOut.Append("<td align='left' valign='center' nowrap='nowrap'>" + Server.HtmlEncode(Row.Item("ym_brand_name").ToString.Trim) + "</td>")
                        htmlOut.Append("<td align='left' valign='center' nowrap='nowrap'>" + Row.Item("ym_model_name").ToString.Trim + "</td>")

                        If Not (IsDBNull(Row.Item("yt_yacht_name"))) Then
                            htmlOut.Append("<td align='left' valign='center' nowrap='nowrap'>" + Row.Item("yt_yacht_name").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td align='left' valign='center'></td>")
                        End If

                        If Not IsDBNull(Row.Item("yt_year_mfr")) Then
                            htmlOut.Append("<td align='left' valign='center'>" + Row.Item("yt_year_mfr").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td align='left' valign='center'></td>")
                        End If

                        If Not IsDBNull(Row.Item("ym_nbr_hulls")) Then
                            htmlOut.Append("<td align='left' valign='center'>" + Row.Item("ym_nbr_hulls").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td align='left' valign='center'></td>")
                        End If

                        If Not IsDBNull(Row.Item("yt_hull_mfr_nbr")) Then
                            htmlOut.Append("<td align='left' valign='center' class='textformat'>" + Row.Item("yt_hull_mfr_nbr").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td align='left' valign='center'></td>")
                        End If

                        htmlOut.Append("<td align='left' valign='center'>")

                        If Not IsDBNull(Row.Item("yt_length_overall_meters")) Then

                            Dim tmpLength As Double = 0.0

                            If Not String.IsNullOrEmpty(Row.Item("yt_length_overall_meters").ToString.Trim) Then
                                If IsNumeric(Row.Item("yt_length_overall_meters").ToString) Then
                                    tmpLength = ConversionFunctions.ConvertMeterToFeet(CDbl(Row.Item("yt_length_overall_meters").ToString))
                                    htmlOut.Append(FormatNumber(tmpLength, 2, False, False, False))
                                End If
                            End If
                        End If
                        htmlOut.Append("</td>")

                        If Not IsDBNull(Row.Item("yt_displacement_tons")) Then
                            If CLng(Row.Item("yt_displacement_tons").ToString) > 0 Then
                                htmlOut.Append("<td align='left' valign='center'>" + Row.Item("yt_displacement_tons").ToString.Trim + "</td>")
                            Else
                                htmlOut.Append("<td align='left' valign='center'></td>")
                            End If
                        Else
                            htmlOut.Append("<td align='left' valign='center'></td>")
                        End If

                        If Not IsDBNull(Row.Item("ym_mfr_comp_id")) Then
                            htmlOut.Append("<td align='left' valign='center' nowrap='nowrap'>" + Server.HtmlEncode(commonEvo.get_company_name_fromID(CLng(Row.Item("ym_mfr_comp_id").ToString), 0, False, False, "")) + "</td>")
                        Else
                            htmlOut.Append("<td align='left' valign='center'></td>")
                        End If

                        If Not IsDBNull(Row.Item("yt_registered_country_flag")) Then
                            htmlOut.Append("<td align='left' valign='center' nowrap='nowrap'>" + Row.Item("yt_registered_country_flag").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td align='left' valign='center'></td>")
                        End If

                        ' Aerodex users don't get this column at all
                        If Not bAerodexFlag Then

                            If Not IsDBNull(Row.Item("yt_forsale_flag")) Then

                                If Row.Item("yt_forsale_flag").ToString.Trim.ToUpper.Contains("Y") Then
                                    htmlOut.Append("<td align='left' valign='center' nowrap='nowrap'>" + Row.Item("yt_forsale_status").ToString.Trim + "</td>")
                                Else
                                    htmlOut.Append("<td align='left' valign='center'></td>")
                                End If
                            Else
                                htmlOut.Append("<td align='left' valign='center'></td>")
                            End If

                            htmlOut.Append("<td align='left' valign='center'>")

                            If Not IsDBNull(Row.Item("yt_asking_price")) Then
                                If Not String.IsNullOrEmpty(Row.Item("yt_asking_price").ToString.Trim) Then
                                    If IsNumeric(Row.Item("yt_asking_price").ToString) Then
                                        If CInt(Row.Item("yt_asking_price").ToString) > 0 Then
                                            htmlOut.Append("$" + FormatNumber(Row.Item("yt_asking_price").ToString, 0, False, False, True))
                                        End If
                                    End If
                                End If
                            End If

                            htmlOut.Append("</td>")

                            If Not IsDBNull(Row.Item("yt_foreign_asking_price")) Then
                                htmlOut.Append("<td align='left' valign='center' nowrap='nowrap'>" + FormatNumber(Row.Item("yt_foreign_asking_price").ToString, 0, False, False, True) + "</td>")
                            Else
                                htmlOut.Append("<td align='left' valign='center'></td>")
                            End If

                            If Not IsDBNull(Row.Item("yt_foreign_currency_name")) Then
                                htmlOut.Append("<td align='left' valign='center' nowrap='nowrap'>" + Row.Item("yt_foreign_currency_name").ToString.Trim + "</td>")
                            Else
                                htmlOut.Append("<td align='left' valign='center'></td>")
                            End If

                        End If

                        htmlOut.Append("<td align='left' valign='center'>")

                        If Not IsDBNull(Row.Item("yt_ownership_type")) Then
                            If Not String.IsNullOrEmpty(Row.Item("yt_ownership_type").ToString.Trim) Then

                                Select Case (Row.Item("yt_ownership_type").ToString.ToUpper.Trim)
                                    Case "W"
                                        htmlOut.Append("Whole")
                                    Case "S"
                                        htmlOut.Append("Shared")
                                End Select

                            End If
                        End If

                        htmlOut.Append("</td>")

                        htmlOut.Append("<td align='left' valign='center'>")
                        If Not IsDBNull(Row.Item("yct_name")) Then
                            If Not String.IsNullOrEmpty(Row.Item("yct_name").ToString.Trim) Then
                                htmlOut.Append(Row.Item("yct_name"))
                            End If
                        End If
                        htmlOut.Append("&nbsp;</td>")

                        htmlOut.Append("<td align='left' valign='center'>")
                        If Not IsDBNull(Row.Item("comp_name")) Then
                            If Not String.IsNullOrEmpty(Row.Item("comp_name").ToString.Trim) Then
                                htmlOut.Append(Row.Item("comp_name"))
                            End If
                        End If
                        htmlOut.Append("</td>")

                        htmlOut.Append("<td align='left' valign='center'>")
                        If Not IsDBNull(Row.Item("comp_address1")) Then
                            If Not String.IsNullOrEmpty(Row.Item("comp_address1").ToString.Trim) Then
                                htmlOut.Append(Row.Item("comp_address1"))
                            End If
                        End If
                        htmlOut.Append("</td>")

                        htmlOut.Append("<td align='left' valign='center'>")
                        If Not IsDBNull(Row.Item("comp_address2")) Then
                            If Not String.IsNullOrEmpty(Row.Item("comp_address2").ToString.Trim) Then
                                htmlOut.Append(Row.Item("comp_address2"))
                            End If
                        End If
                        htmlOut.Append("</td>")

                        htmlOut.Append("<td align='left' valign='center'>")
                        If Not IsDBNull(Row.Item("comp_city")) Then
                            If Not String.IsNullOrEmpty(Row.Item("comp_city").ToString.Trim) Then
                                htmlOut.Append(Row.Item("comp_city"))
                            End If
                        End If
                        htmlOut.Append("</td>")

                        htmlOut.Append("<td align='left' valign='center'>")
                        If Not IsDBNull(Row.Item("comp_state")) Then
                            If Not String.IsNullOrEmpty(Row.Item("comp_state").ToString.Trim) Then
                                htmlOut.Append(Row.Item("comp_state"))
                            End If
                        End If
                        htmlOut.Append("</td>")

                        htmlOut.Append("<td align='left' valign='center'>")
                        If Not IsDBNull(Row.Item("comp_zip_code")) Then
                            If Not String.IsNullOrEmpty(Row.Item("comp_zip_code").ToString.Trim) Then
                                htmlOut.Append(Row.Item("comp_zip_code"))
                            End If
                        End If
                        htmlOut.Append("</td>")

                        htmlOut.Append("<td align='left' valign='center'>")
                        If Not IsDBNull(Row.Item("comp_country")) Then
                            If Not String.IsNullOrEmpty(Row.Item("comp_country").ToString.Trim) Then
                                htmlOut.Append(Row.Item("comp_country"))
                            End If
                        End If
                        htmlOut.Append("</td>")

                        htmlOut.Append("<td align='left' valign='center'>")
                        If Not IsDBNull(Row.Item("comp_email_address")) Then
                            If Not String.IsNullOrEmpty(Row.Item("comp_email_address").ToString.Trim) Then
                                htmlOut.Append(Row.Item("comp_email_address"))
                            End If
                        End If
                        htmlOut.Append("</td>")


                        htmlOut.Append("<td align='left' valign='center'>")
                        If Not IsDBNull(Row.Item("comp_web_address")) Then
                            If Not String.IsNullOrEmpty(Row.Item("comp_web_address").ToString.Trim) Then
                                htmlOut.Append(Row.Item("comp_web_address"))
                            End If
                        End If
                        htmlOut.Append("</td>")

                        htmlOut.Append("<td align='left' valign='center' nowrap='nowrap'>")
                        If Not IsDBNull(Row.Item("officephone")) Then
                            If Not String.IsNullOrEmpty(Row.Item("officephone").ToString.Trim) Then
                                htmlOut.Append(Row.Item("officephone"))
                            End If
                        End If
                        htmlOut.Append("</td>")

                        htmlOut.Append("<td align='left' valign='center' nowrap='nowrap'>")
                        If Not IsDBNull(Row.Item("faxphone")) Then
                            If Not String.IsNullOrEmpty(Row.Item("faxphone").ToString.Trim) Then
                                htmlOut.Append(Row.Item("faxphone"))
                            End If
                        End If

                        htmlOut.Append("</td>")
                        htmlOut.Append("</tr>")

                        htmlOut.Append(IIf(bHtmlReport, "<tr><td colspan='" + IIf(bAerodexFlag, "25", "29") + "'><hr height='1'></td></tr>", ""))

                    Next

                End If
            End If

            htmlOut.Append("</tr>")

            htmlOut.Append("</table>")

            htmlOut.Append("</div>")
            htmlOut.Append("</body>")
            htmlOut.Append("</html>")


        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in create_report_46_export_current_yacht_list()" + ex.Message
        Finally

            report_46_datatable = Nothing

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOut.ToString

    End Function

#End Region

#Region "report_999_functions"

    Public Function create_report_999_export_company_sold_transactions(ByRef record_count As Long) As String

        Dim starter_string As String = ""
        Dim ac_header As String = ""
        Dim AircraftTable As New DataTable
        Dim bgcolor As String = ""
        Dim ac_table As String = ""
        Dim temp_status As String = ""
        Dim temp_counter As Integer = 0

        Try


            AircraftTable = Master.aclsData_Temp.GetJETNET_OnlyTransactionsByCompany(Trim(Request("comp_id")), 0, "Y")

            starter_string &= "<html><head><title>Aircraft Full Spec Sheet</title>" + build_style_page_full_spec() + "</head>"

            starter_string &= "<body style='background: white; margin-top:10px; margin-left:10px;'>"
            starter_string &= "<div style='text-align:center;'>"



            If Not IsNothing(AircraftTable) Then

                record_count = AircraftTable.Rows.Count

                ac_header &= "<table valign='top' cellpadding='0' cellspacing='0'>"
                ac_header &= "<tr><td colspan='10'><font class='small_header_text'>"
                ac_header &= "&nbsp;"
                ac_header &= "</font></td></tr>"

                ac_header &= "</td></tr><tr><td colspan='10'>"
                ac_header &= "<font class='header_text'><b>Transaction Records (" & AircraftTable.Rows.Count & ")</b></font>"
                ac_header &= "</td></tr><tr><td>"

                If AircraftTable.Rows.Count > 0 Then

                    ac_header &= "<table cellspacing='0' cellpadding='4' class='data_aircraft_grid' border='1'>"
                    ac_header &= "<tr>"
                    ac_header &= "<td><font class='small_header_text'><b>Make</b>&nbsp;</font></td>"
                    ac_header &= "<td><font class='small_header_text'><b>Model</b>&nbsp;</font></td>"
                    ac_header &= "<td><font class='small_header_text'><b>Year</b>&nbsp;</font></td>"
                    ac_header &= "<td><font class='small_header_text'><b>Ser No</b>&nbsp;</font></td>"
                    ac_header &= "<td><font class='small_header_text'><b>Reg Nbr</b>&nbsp;</font></td>"
                    ac_header &= "<td><font class='small_header_text'><b>Date</b>&nbsp;</font></td>"
                    ac_header &= "<td><font class='small_header_text'><b>Description</b>&nbsp;</font></td>"
                    ac_header &= "<td><font class='small_header_text'><b>Relationship</b>&nbsp;</font></td>"
                    ac_header &= "<td><font class='small_header_text'><b>Sale Price</b>&nbsp;</font></td>"
                    ac_header &= "</tr>"

                    ac_table &= ac_header


                    For Each r As DataRow In AircraftTable.Rows

                        If bgcolor = "" Then
                            bgcolor = "#f0f0f0"
                        Else
                            bgcolor = ""
                        End If

                        ac_table &= "<tr bgcolor='" & bgcolor & "'>"
                        ac_table &= "<td><font class='small_header_text'>"
                        ac_table &= r("amod_make_name")
                        ac_table &= "&nbsp;</font></td>"

                        ac_table &= "<td><font class='small_header_text'>"
                        ac_table &= r("amod_model_name")
                        ac_table &= "&nbsp;</font></td>"

                        ac_table &= "<td><font class='small_header_text'>"
                        ac_table &= r("ac_year")
                        ac_table &= "&nbsp;</font></td>"

                        ac_table &= "<td><font class='small_header_text'>"
                        ac_table &= r("ac_ser_no_full")
                        ac_table &= "&nbsp;</font></td>"

                        ac_table &= "<td><font class='small_header_text'>"
                        ac_table &= r("ac_reg_no")
                        ac_table &= "&nbsp;</font></td>"


                        ac_table &= "<td><font class='small_header_text'>"
                        ac_table &= r("journ_date")
                        ac_table &= "&nbsp;</font></td>"

                        ac_table &= "<td><font class='small_header_text'>"
                        ac_table &= r("journ_subject")
                        ac_table &= "&nbsp;</font></td>"


                        ac_table &= "<td><font class='small_header_text'>"
                        ac_table &= r("actype_name")
                        ac_table &= "&nbsp;</font></td>"

                        ' leave blank for sold prices
                        ac_table &= "<td><font class='small_header_text'>&nbsp;</font></td>"


                        ac_table &= "</tr>"

                        temp_counter = temp_counter + 1
                    Next
                Else
                    ac_header &= "<tr><td><font class='small_header_text'><b>No Aircraft Records Found</font></td></tr>"

                    ac_table &= ac_header
                End If
            End If

            ac_table &= "</table>"
            ac_table &= "</html>"


        Catch ex As Exception

        End Try

        Return ac_table

    End Function

#End Region

#Region "report_47_functions"



    Public Function create_report_47_export_company_details(ByRef record_count As Long) As String

        Dim bgcolor As String = ""
        Dim CompanyID As Long = 0
        Dim JournalID As Long = 0
        Dim ContactTable As New DataTable
        Dim AircraftTable As New DataTable
        Dim ac_table As String = ""
        Dim yacht_Table As String = ""
        Dim YachtTable As New DataTable
        Dim cycles As String = ""
        Dim asking_price As String = ""
        Dim company_name As String = ""
        Dim last_updated As String = ""
        Dim exclusive_flag As String = ""
        Dim list_date As String = ""
        Dim tmp_list_date As String = ""
        Dim asking_type As String = ""
        Dim ex_date As String = ""
        Dim times_date As String = ""
        Dim ac_maintained As String = ""
        Dim ac_status As String = ""
        Dim prev_owned As String = ""
        Dim address_info As String = ""
        Dim confidential As String = ""
        Dim days_on_market As String = ""
        Dim font_size_for_address As String = ""

        Dim htmlOutput As New StringBuilder

        Dim logo_link As String = ""
        Dim logo_text As String = ""
        Dim sQuery = New StringBuilder()
        Dim yt_header As String = ""
        Dim ac_header As String = ""
        Dim page_ac_header As String = ""
        Dim page_yacht_header As String = ""

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader = Nothing
        Dim SqlException As SqlClient.SqlException = Nothing
        Dim temp_counter As Integer = 0
        Dim starter_string As String = ""
        Dim has_desription As Boolean = False
        Dim email_string As String = ""
        Dim temp_email_string As String = ""
        Dim length_long_rel As Integer = 0
        Dim length_long_status As Integer = 0
        Dim ac_page_break As Integer = 28
        Dim temp_status As String = ""
        Dim word_width As Integer = 640
        Dim has_airport As Boolean = False

        Dim temp_business_type As String = ""
        Dim temp_cert As String = ""


        create_report_47_export_company_details = ""

        Try




            starter_string &= "<html><head><title>Aircraft Full Spec Sheet</title>" + build_style_page_full_spec() + "</head>"

            starter_string &= "<body style='background: white; margin-top:10px; margin-left:10px;'>"
            starter_string &= "<div style='text-align:center;'>"


            create_report_47_export_company_details &= starter_string

            'SECTION 1 - COMPANY INFO ----------------------------------------------------------------------------------------------------------------------------------- 

            sQuery.Append("SELECT TOP 1 * FROM Company INNER JOIN Subscription ON comp_id = sub_comp_id AND comp_journ_id = 0")
            sQuery.Append(" WHERE sub_id = " + Session.Item("localUser").crmSubSubID.ToString)

            SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString
            SqlReader = SqlCommand.ExecuteReader()



            If SqlReader.HasRows Then

                SqlReader.Read()

                If Not IsDBNull(SqlReader.Item("comp_address1")) And Not IsDBNull(SqlReader.Item("comp_address2")) Then
                    If (SqlReader.Item("comp_address1").ToString.Length + SqlReader.Item("comp_address2").ToString.Length) > 50 Then
                        font_size_for_address = "-2"
                    Else
                        font_size_for_address = "-1"
                    End If
                Else

                End If

                If Not IsDBNull(SqlReader.Item("comp_address1")) Then
                    If bWordReport Then
                        address_info = "<tr valign='top'><td class='white_feat_header_text'><font size='" + font_size_for_address + "'>" + SqlReader.Item("comp_address1").ToString
                    Else
                        address_info = "<tr valign='top'><td class='CompInfo'><font>" + SqlReader.Item("comp_address1").ToString + "</font>"
                    End If
                Else
                    If bWordReport Then
                        address_info = "<tr valign='top'><td class='white_feat_header_text'><font size='-1'>"
                    Else
                        address_info = "<tr valign='top'><td class='CompInfo'>"
                    End If

                End If

                If Not IsDBNull(SqlReader.Item("comp_logo_flag")) And logo_check.Checked Then
                    If SqlReader.Item("comp_logo_flag").ToString.ToUpper.Contains("Y") And logo_check.Checked Then

                        If HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then

                            If Not Application.Item("crmClientSiteData").crmClientHostName.ToString.ToUpper.Contains("NEWEVONET") Then
                                logo_link = "https://www.testjetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                            Else
                                logo_link = "http://www.jetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                            End If

                        Else
                            logo_link = Application.Item("crmClientSiteData").ClientFullHostName.ToString.Trim + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                        End If

                        logo_link = "<img src='" + logo_link + "/" + SqlReader.Item("comp_id").ToString + ".jpg' width='150'>"
                    ElseIf logo_check.Checked = True And invisible_label_parent_image.Text <> "" Then

                        If HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then

                            If Not Application.Item("crmClientSiteData").crmClientHostName.ToString.ToUpper.Contains("NEWEVONET") Then
                                logo_link = "https://www.testjetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                            Else
                                logo_link = "http://www.jetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                            End If

                        Else
                            logo_link = Application.Item("crmClientSiteData").ClientFullHostName.ToString.Trim + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                        End If

                        logo_link = "<img src='" + logo_link + "/" + invisible_label_parent_image.Text + ".jpg' width='150'>"
                    End If
                ElseIf logo_check.Checked = True And invisible_label_parent_image.Text <> "" Then

                    If HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then

                        If Not Application.Item("crmClientSiteData").crmClientHostName.ToString.ToUpper.Contains("NEWEVONET") Then
                            logo_link = "https://www.testjetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                        Else
                            logo_link = "http://www.jetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                        End If

                    Else
                        logo_link = Application.Item("crmClientSiteData").ClientFullHostName.ToString.Trim + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                    End If

                    logo_link = "<img src='" + logo_link + "/" + invisible_label_parent_image.Text + ".jpg' width='150'>"
                End If

                If Not IsDBNull(SqlReader.Item("comp_address2")) Then
                    address_info += "<font> . " + SqlReader.Item("comp_address2").ToString + "</font>"
                End If

                If font_size_for_address = "-2" Or Not String.IsNullOrEmpty(logo_link) Then
                    address_info += "<br />"
                End If

                If Not IsDBNull(SqlReader.Item("comp_city")) Then
                    address_info += "<font> " + SqlReader.Item("comp_city").ToString + "</font>"
                End If

                If Not IsDBNull(SqlReader.Item("comp_state")) Then
                    address_info += "<font>, " + SqlReader.Item("comp_state").ToString + "</font>"
                End If

                If Not IsDBNull(SqlReader.Item("comp_zip_code")) Then
                    address_info += "<font> " + SqlReader.Item("comp_zip_code").ToString + "</font>"
                End If

                address_info += "</td></tr>"

                address_info += build_phone_info_full_spec(CLng(Session.Item("localUser").crmSubSubID.ToString), "black")

                If Not IsDBNull(SqlReader.Item("comp_web_address")) Then
                    address_info += "<tr><td> &#8226; "

                    If SqlReader.Item("comp_web_address").ToString.Trim.ToLower.Contains("www") Then
                        address_info += "<a href='http://" + SqlReader.Item("comp_web_address").ToString.Trim + "' target='new'>" + SqlReader.Item("comp_web_address").ToString.Trim + "</a>"
                    Else
                        address_info += "<a href='" + SqlReader.Item("comp_web_address").ToString.Trim + "' target='new'>" + SqlReader.Item("comp_web_address").ToString.Trim + "</a>"
                    End If

                    address_info += "</td></tr>"

                Else
                    address_info += "<tr><td>&nbsp;</td></tr>"
                End If

            End If

            SqlReader.Close()

            create_report_47_export_company_details &= build_full_spec_page_header(0, "Company Information", address_info, logo_link, word_width)


            '<font class='small_header_text2'>
            '<font class='small_header_text'>
            '<font class='text_text'>
            '<font class='header_text'>  

            create_report_47_export_company_details &= "<table cellspacing='0' cellpadding='0' width='100%'>"

            If Trim(Request("comp_id")) <> "" Then
                CompanyID = Trim(Request("comp_id"))
            End If


            create_report_47_export_company_details &= "<tr><td colspan='10'><font class='small_header_text'>"
            create_report_47_export_company_details &= "&nbsp;"
            create_report_47_export_company_details &= "</font></td></tr>"


            '------------- FILL COMPANY INFORMATION------------- 
            'crmWebClient.CompanyFunctions.Fill_Information_Tab(invisible_panel, invisible_label3, Master, CompanyID, JournalID, "", invisible_label4, invisible_containor, invisible_label2, invisible_label, False)

            Call get_current_company_info(CompanyID, JournalID, temp_email_string, logo_text, has_desription, "old", record_count)
            email_string = temp_email_string
            create_report_47_export_company_details &= email_string

            '    create_report_47_export_company_details &= "</table></table>"

            '--------------- FILL COMPANY INFORMATION------------------

            'If Trim(Request("blank")) = "Y" Then   ' WORKING CORRECTLY -------------------
            '  create_report_47_export_company_details &= ("</td></tr></table></td></tr></table>")
            '  create_report_47_export_company_details &= Insert_Page_Break_PDF()
            '  page_ac_header = build_full_spec_page_header(0, "Contact Information", address_info, logo_link)
            '  create_report_47_export_company_details &= Replace(page_ac_header, "900", "800")
            'ElseIf Trim(Request("blank2")) = "Y" Then ' WORKING CORRECTLY -------------------
            '  create_report_47_export_company_details &= ("</td></tr></table></td></tr></table>")
            '  create_report_47_export_company_details &= Insert_Page_Break_PDF()
            '  page_ac_header = build_full_spec_page_header(0, "Contact Information", address_info, logo_link)
            '  create_report_47_export_company_details &= Replace(page_ac_header, "900", "800")
            '  create_report_47_export_company_details &= "<tr><td>Test Page</td></tr>"
            'ElseIf Trim(Request("blank3")) = "Y" Then ' WORKING CORRECTLY -------------------
            '  create_report_47_export_company_details &= ("</td></tr></table></td></tr></table>")
            '  create_report_47_export_company_details &= Insert_Page_Break_PDF()
            '  page_ac_header = build_full_spec_page_header(0, "Contact Information", address_info, logo_link)
            '  create_report_47_export_company_details &= Replace(page_ac_header, "900", "800")
            '  create_report_47_export_company_details &= ("<table><tr><td>Test Page</td></tr></table>")
            'ElseIf Trim(Request("blank4")) = "Y" Then ' NOT WORKING
            '  create_report_47_export_company_details &= ("</td></tr></table></td></tr></table>")
            '  create_report_47_export_company_details &= Insert_Page_Break_PDF()
            '  page_ac_header = build_full_spec_page_header(0, "Contact Information", address_info, logo_link)
            '  create_report_47_export_company_details &= page_ac_header    ' TRY original blank without replace to see if works   
            'ElseIf Trim(Request("blank5")) = "Y" Then ' WORKING CORRECTLY -------------------
            '  create_report_47_export_company_details &= ("</td></tr></table></td></tr></table>")
            '  create_report_47_export_company_details &= Insert_Page_Break_PDF()
            '  page_ac_header = build_full_spec_page_header(0, "Contact Information", address_info, logo_link)
            '  create_report_47_export_company_details &= Replace(page_ac_header, "900", "800")
            '  create_report_47_export_company_details &= "<table cellspacing='0' cellpadding='0' width='100%'>"
            '  create_report_47_export_company_details &= "<tr><td>Test Page BLANK 5</td></tr>"
            '  create_report_47_export_company_details &= ("</td></tr></table></td></tr></table>")
            '  create_report_47_export_company_details &= Insert_Page_Break_PDF()
            '  create_report_47_export_company_details &= ("<table><tr><td>Test Page BLANK 52</td></tr></table>")
            'ElseIf Trim(Request("blank6")) = "Y" Then ' WORKING CORRECTLY -------------------
            '  create_report_47_export_company_details &= ("</td></tr></table></td></tr></table>")
            '  create_report_47_export_company_details &= Insert_Page_Break_PDF()
            '  create_report_47_export_company_details &= ("blank6 TEST PAGE")
            '  create_report_47_export_company_details &= Insert_Page_Break_PDF()
            '  create_report_47_export_company_details &= ("blank6 TEST PAGE - 2 ")

            'ElseIf Trim(Request("blank7")) = "Y" Then ' WORKING CORRECTLY -------------------
            '  create_report_47_export_company_details &= ("</td></tr></table></td></tr></table>")
            '  create_report_47_export_company_details &= Insert_Page_Break_PDF()
            '  page_ac_header = build_full_spec_page_header(0, "Contact Information", address_info, logo_link)
            '  create_report_47_export_company_details &= Replace(page_ac_header, "900", "800")


            '  create_report_47_export_company_details &= "<table cellspacing='0' cellpadding='0' width='100%'>"
            '  create_report_47_export_company_details &= "<tr><td colspan='10'><font class='small_header_text'>"
            '  create_report_47_export_company_details &= "&nbsp;"
            '  create_report_47_export_company_details &= "</font></td></tr>"
            '  create_report_47_export_company_details &= "<tr><td>Test7"
            '  create_report_47_export_company_details &= ("</td></tr></table></td></tr></table>")
            '  create_report_47_export_company_details &= Insert_Page_Break_PDF()
            '  create_report_47_export_company_details &= Replace(page_ac_header, "900", "800")
            'End If

            If bWordReport = True Then
                create_report_47_export_company_details &= "</table>"
            End If

            If has_desription = True Then ' then use page break, otherwise, dont  
                create_report_47_export_company_details &= ("</td></tr></table></td></tr></table>")
                create_report_47_export_company_details &= Insert_Page_Break_PDF()
                page_ac_header = build_full_spec_page_header(0, "Contact Information", address_info, logo_link, word_width)
                create_report_47_export_company_details &= Replace(page_ac_header, "900", "800")
            Else

            End If



            If chkIncludeContacts.Checked = True Then
                '--------------- FILL CONTACT INFORMATION------------------ 

                temp_email_string = ""
                temp_email_string &= "<tr><td colspan='10'><font class='small_header_text'>"
                temp_email_string &= "&nbsp;"
                temp_email_string &= "</font></td></tr>"

                temp_email_string &= "<tr><td colspan='10' align='left'>"
                temp_email_string &= "<font class='header_text'><b>Contact Details</b></font>"
                temp_email_string &= "</td></tr>"
                temp_email_string &= "<tr><td>"


                If HttpContext.Current.Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.YACHT Then
                    ContactTable = Master.aclsData_Temp.GetContacts(CompanyID, "JETNET", "Y", JournalID, True)
                Else
                    ContactTable = Master.aclsData_Temp.GetContacts(CompanyID, "JETNET", "Y", JournalID)
                End If

                Call Display_Contact_Details_PDF(ContactTable, temp_email_string, CompanyID, JournalID, Master, True, False, Trim(Request("homebase")), 47)
                ContactTable = Nothing

                create_report_47_export_company_details &= temp_email_string
                email_string &= temp_email_string & "<br>"
                '--------------- FILL CONTACT INFORMATION------------------ 
            End If


            If chk_related_comp.Checked = True Then
                create_report_47_export_company_details &= ("</td></tr></table></td></tr></table>")
                create_report_47_export_company_details &= Insert_Page_Break_PDF()
                page_ac_header = build_full_spec_page_header(0, "Related Companies", address_info, logo_link, word_width)
                page_ac_header = Replace(page_ac_header, "900", "800")

                create_report_47_export_company_details &= page_ac_header

                temp_email_string = Fill_Relationship_Tab(CompanyID, JournalID, False)

                create_report_47_export_company_details &= temp_email_string
                email_string &= temp_email_string & "<br>"
            End If

            If chk_comp_wanteds.Checked = True Then
                create_report_47_export_company_details &= ("</td></tr></table></td></tr></table>")
                create_report_47_export_company_details &= Insert_Page_Break_PDF()
                page_ac_header = build_full_spec_page_header(0, "Company Wanteds", address_info, logo_link, word_width)
                page_ac_header = Replace(page_ac_header, "900", "800")

                create_report_47_export_company_details &= page_ac_header

                temp_email_string = ""
                Call Fill_Wanteds_Tab(CompanyID, JournalID, temp_email_string, 47)

                create_report_47_export_company_details &= temp_email_string
                email_string &= temp_email_string & "<br>"
            End If


            ' ----------- NEW CERTIFICATIONS AND BUSINESS TYPES - MSW as requested 7/1/19
            temp_cert = ""
            temp_business_type = ""
            Call Fill_Business_Type_Tab(temp_business_type, CompanyID)
            email_string &= temp_business_type

            Call Fill_Certifications_Tab(temp_cert, CompanyID)
            email_string &= temp_cert
            ' ----------- NEW CERTIFICATIONS AND BUSINESS TYPES - MSW as requested 7/1/19



            If chkIncludeCompAC.Checked = True Then
                '--------------- FILL AC INFORMATION------------------  

                create_report_47_export_company_details &= ("</td></tr></table></td></tr></table>")
                create_report_47_export_company_details &= Insert_Page_Break_PDF()
                page_ac_header = build_full_spec_page_header(0, "Related Aircraft", address_info, logo_link, word_width)
                'create_report_47_export_company_details &= starter_string & page_ac_header
                page_ac_header = Replace(page_ac_header, "900", "800")

                create_report_47_export_company_details &= page_ac_header

                If Trim(Request("test")) = "Y" Then

                ElseIf Trim(Request("test2")) = "Y" Then
                    create_report_47_export_company_details &= "<table><tr><td colspan='10' align='left'>"
                    create_report_47_export_company_details &= "<font class='header_text'><b>Aircraft Records Details</b></font>"
                    create_report_47_export_company_details &= "</td></tr></table>"
                Else
                    invisible_label.Text = ""
                    invisible_label2.Text = ""
                    invisible_label3.Text = ""
                    invisible_label4.Text = ""
                    If IsNothing(ViewState("CompanyAircraft")) Then
                        AircraftTable = Master.aclsData_Temp.GetAircraft_Listing_compid(CompanyID, Session.Item("localSubscription").crmHelicopter_Flag, Session.Item("localSubscription").crmBusiness_Flag, Session.Item("localSubscription").crmCommercial_Flag, Session.Item("localSubscription").crmJets_Flag, Session.Item("localSubscription").crmExecutive_Flag, Session.Item("localSubscription").crmTurboprops, JournalID, Session.Item("localSubscription").crmAerodexFlag)
                        AircraftTable = FixAircraftTableRemoveDuplicates(AircraftTable)
                    Else
                        AircraftTable = ViewState("CompanyAircraft")
                    End If


                    If Not IsNothing(AircraftTable) Then

                        If Trim(Request("homebase")) = "Y" And AircraftTable.Rows.Count = 0 Then
                        Else
                            ac_header = "<tr><td colspan='10'><font class='small_header_text'>"
                            ac_header &= "&nbsp;"
                            ac_header &= "</font></td></tr>"

                            ac_header &= "</td></tr><tr><td colspan='10'>"
                            ac_header &= "<font class='header_text'><b>Aircraft Records (" & AircraftTable.Rows.Count & ")</b></font>"
                            ac_header &= "</td></tr><tr><td>"
                        End If

                        If AircraftTable.Rows.Count > 0 Then

                            ac_header &= "<table cellspacing='0' cellpadding='4' class='data_aircraft_grid' border='1'>"
                            ac_header &= "<tr>"
                            ac_header &= "<td><font class='small_header_text'><b>Make</b>&nbsp;</font></td>"
                            ac_header &= "<td><font class='small_header_text'><b>Model</b>&nbsp;</font></td>"
                            ac_header &= "<td><font class='small_header_text'><b>Year MFR/DLV</b>&nbsp;</font></td>"
                            ac_header &= "<td><font class='small_header_text'><b>Ser No</b>&nbsp;</font></td>"
                            ac_header &= "<td><font class='small_header_text'><b>Reg Nbr</b>&nbsp;</font></td>"
                            ac_header &= "<td><font class='small_header_text'><b>Status</b>&nbsp;</font></td>"
                            ac_header &= "<td><font class='small_header_text'><b>Airport</b>&nbsp;</font></td>"
                            ac_header &= "<td><font class='small_header_text'><b>Relationship</b>&nbsp;</font></td>"
                            ac_header &= "<td><font class='small_header_text'><b>Contact Name</b>&nbsp;</font></td>"
                            ac_header &= "</tr>"

                            ac_table &= ac_header


                            For Each r As DataRow In AircraftTable.Rows

                                ' the <> is so you dont break in the middle of one ac with multiple relationships
                                If Trim(Request("homebase")) = "Y" Then ' dont do paging stuff
                                Else
                                    If temp_counter > ac_page_break And Trim(r("amod_make_name")) <> "" Then
                                        ac_table &= ("</td></tr></table></td></tr></table>")
                                        ac_table &= Insert_Page_Break_PDF()
                                        ac_table &= Replace(page_ac_header, "Related Aircraft", "Related Aircraft (Continued)")

                                        ac_table &= ac_header
                                        temp_counter = 0
                                    End If
                                End If

                                If bgcolor = "" Then
                                    bgcolor = "#f0f0f0"
                                Else
                                    bgcolor = ""
                                End If

                                ac_table &= "<tr bgcolor='" & bgcolor & "'>"
                                ac_table &= "<td><font class='small_header_text'>"
                                ac_table &= r("amod_make_name")
                                ac_table &= "&nbsp;</font></td>"

                                ac_table &= "<td><font class='small_header_text'>"
                                ac_table &= r("amod_model_name")
                                ac_table &= "&nbsp;</font></td>"

                                ac_table &= "<td><font class='small_header_text'>"
                                If Not IsDBNull(r("ac_year_mfr")) Then
                                    If Trim(r("ac_year_mfr")) <> "" Then
                                        ac_table &= r("ac_year_mfr")
                                    End If
                                End If
                                If Not IsDBNull(r("ac_year_mfr")) Or Not IsDBNull(r("ac_year")) Then
                                    If Trim(r("ac_year_mfr")) <> "" Or Trim(r("ac_year")) <> "" Then
                                        ac_table &= " / "
                                    End If
                                End If
                                If Not IsDBNull(r("ac_year")) Then
                                    If Trim(r("ac_year")) <> "" Then
                                        ac_table &= r("ac_year")
                                    End If
                                End If
                                ac_table &= "&nbsp;</font></td>"

                                ac_table &= "<td><font class='small_header_text'>"
                                ac_table &= r("ac_ser_no_full")
                                ac_table &= "&nbsp;</font></td>"

                                ac_table &= "<td><font class='small_header_text'>"
                                ac_table &= r("ac_reg_nbr")
                                ac_table &= "&nbsp;</font></td>"

                                ac_table &= "<td><font class='small_header_text'>"

                                If Trim(Request("homebase")) = "Y" Then
                                    temp_status = crmWebClient.clsGeneral.clsGeneral.DisplayStatusListingDateEvoACListing(r("ac_forsale_flag"), r("ac_status"), r("ac_delivery"), r("ac_asking_price"), r("ac_date_listed"), r("ac_asking_wordage"), True, Now(), "Y")
                                Else
                                    temp_status = crmWebClient.clsGeneral.clsGeneral.DisplayStatusListingDateEvoACListing(r("ac_forsale_flag"), r("ac_status"), r("ac_delivery"), r("ac_asking_price"), r("ac_date_listed"), r("ac_asking_wordage"), True, Now(), "N")
                                End If

                                ' if the length is this long, it is probably taking up 2 lines
                                If Len(Trim(temp_status)) > 40 Then
                                    If ac_page_break > 18 Then
                                        ac_page_break = ac_page_break - 1
                                    End If
                                End If
                                ac_table &= temp_status

                                ac_table &= "&nbsp;</td>"

                                ac_table &= "<td><font class='small_header_text'>"

                                If Not IsDBNull(r("aport_name")) Then


                                End If

                                has_airport = False
                                'if you have any airport data
                                If Not IsDBNull(r("aport_name")) Or Not IsDBNull(r("aport_city")) Or Not IsDBNull(r("aport_state")) Or Not IsDBNull(r("aport_country")) Then
                                    If Trim(r("aport_name")) <> "" Then
                                        ac_table &= r("aport_name") & " "
                                        has_airport = True
                                    End If

                                    If Not IsDBNull(r("aport_city")) Or Not IsDBNull(r("aport_state")) Or Not IsDBNull(r("aport_country")) Then
                                        If Trim(r("aport_city")) <> "" Or Trim(r("aport_state")) <> "" Or Trim(r("aport_country")) <> "" Then
                                            ac_table &= " ("
                                            has_airport = True
                                        End If
                                    End If

                                    If Not IsDBNull(r("aport_city")) Then
                                        If Trim(r("aport_city")) <> "" Then
                                            ac_table &= r("aport_city") & ", "
                                            has_airport = True
                                        End If
                                    End If

                                    If Not IsDBNull(r("aport_state")) Then
                                        If Trim(r("aport_state")) <> "" Then
                                            ac_table &= r("aport_state") & " "
                                            has_airport = True
                                        End If
                                    End If

                                    If Not IsDBNull(r("aport_country")) Then
                                        If Trim(r("aport_country")) <> "" Then
                                            ac_table &= r("aport_country")
                                            has_airport = True
                                        End If
                                    End If

                                    If Not IsDBNull(r("aport_city")) Or Not IsDBNull(r("aport_state")) Or Not IsDBNull(r("aport_country")) Then
                                        If Trim(r("aport_city")) <> "" Or Trim(r("aport_state")) <> "" Or Trim(r("aport_country")) <> "" Then
                                            ac_table &= ")"
                                            has_airport = True
                                        End If
                                    End If
                                End If


                                If has_airport = False Then
                                    If Not IsDBNull(r("ac_aport_name")) Then
                                        ac_table &= r("ac_aport_name") & " "
                                    End If

                                    If Not IsDBNull(r("ac_aport_city")) Or Not IsDBNull(r("ac_aport_state")) Or Not IsDBNull(r("ac_aport_country")) Then
                                        If Trim(r("ac_aport_city")) <> "" Or Trim(r("ac_aport_state")) <> "" Or Trim(r("ac_aport_country")) <> "" Then
                                            ac_table &= " ("
                                        End If
                                    End If

                                    If Not IsDBNull(r("ac_aport_city")) Then
                                        If Trim(r("ac_aport_city")) <> "" Then
                                            ac_table &= r("ac_aport_city") & ", "
                                        End If
                                    End If

                                    If Not IsDBNull(r("ac_aport_state")) Then
                                        If Trim(r("ac_aport_state")) <> "" Then
                                            ac_table &= r("ac_aport_state") & " "
                                        End If
                                    End If

                                    If Not IsDBNull(r("ac_aport_country")) Then
                                        If Trim(r("ac_aport_country")) <> "" Then
                                            ac_table &= r("ac_aport_country")
                                        End If
                                    End If

                                    If Not IsDBNull(r("ac_aport_city")) Or Not IsDBNull(r("ac_aport_state")) Or Not IsDBNull(r("ac_aport_country")) Then
                                        If Trim(r("ac_aport_city")) <> "" Or Trim(r("ac_aport_state")) <> "" Or Trim(r("ac_aport_country")) <> "" Then
                                            ac_table &= ")"
                                        End If
                                    End If
                                End If


                                ac_table &= "&nbsp;</font></td>"

                                ac_table &= "<td><font class='small_header_text'>"
                                ac_table &= r("act_name")
                                ac_table &= "&nbsp;</font></td>"

                                ac_table &= "<td><font class='small_header_text'>"


                                If Not IsDBNull(r("contact_first_name")) And Not IsDBNull(r("contact_last_name")) Then
                                    If Trim(r("contact_first_name")) <> "" Or Trim(r("contact_last_name")) <> "" Then
                                        ac_table &= r("contact_first_name") & " " & r("contact_last_name")
                                    Else
                                        If Not IsDBNull(r("contact_title")) Then
                                            ac_table &= r("contact_title") & " "
                                        End If
                                    End If
                                Else
                                    If Not IsDBNull(r("contact_title")) Then
                                        ac_table &= r("contact_title") & " "
                                    Else

                                    End If
                                End If

                                ac_table &= "&nbsp;</font></td>"

                                ac_table &= "</tr>"

                                temp_counter = temp_counter + 1
                            Next
                        Else
                            ac_header &= "<tr><td><font class='small_header_text'><b>No Aircraft Records Found</font></td></tr>"

                            ac_table &= ac_header
                        End If
                    End If

                    ac_table &= "</table>"


                    create_report_47_export_company_details &= ac_table
                    email_string &= ac_table
                End If

                '--------------- FILL AC INFORMATION------------------ 
            End If



            '--------------- FILL YACHT INFORMATION------------------ 
            If (Session.Item("localSubscription").crmYacht_Flag = True And chkincludeCompYacht.Checked = True) Or Trim(Request("homebase")) = "Y" Then
                create_report_47_export_company_details &= Insert_Page_Break_PDF()
                page_yacht_header = build_full_spec_page_header(0, "Related Yachts", address_info, logo_link, 0)
                'create_report_47_export_company_details &= starter_string & page_yacht_header 
                page_yacht_header = Replace(page_yacht_header, "900", "800")
                create_report_47_export_company_details &= page_yacht_header


                YachtTable = Master.aclsData_Temp.DisplayYachtForGivenCompanyByCompanyID(CompanyID, "", JournalID, "")
                YachtTable = FixYachtTableRemoveDuplicates(YachtTable)

                If Trim(Request("test")) = "Y" Then

                ElseIf Trim(Request("test2")) = "Y" Then
                    create_report_47_export_company_details &= "<table><tr><td colspan='10' align='left'>"
                    create_report_47_export_company_details &= "<font class='header_text'><b>Yacht Details</b></font>"
                    create_report_47_export_company_details &= "</td></tr></table>"
                Else

                    If Not IsNothing(YachtTable) Then

                        If Trim(Request("homebase")) = "Y" And YachtTable.Rows.Count = 0 Then

                        Else
                            yt_header = "<tr><td colspan='10'><font class='small_header_text'>"
                            yt_header &= "&nbsp;"
                            yt_header &= "</font></td></tr>"

                            yt_header &= "<tr><td colspan='10'>"
                            yt_header &= "<font class='header_text'><b>Yacht Records (" & YachtTable.Rows.Count & ")</b></font>"
                            yt_header &= "</td></tr>"
                            yt_header &= "<tr><td colspan='10'>"
                        End If

                        If YachtTable.Rows.Count > 0 Then


                            yt_header &= "<table cellspacing='0' cellpadding='0' class='data_aircraft_grid' border='1'>"
                            yt_header &= "<tr>"
                            yt_header &= "<td><font class='small_header_text'><b>Brand</b>&nbsp;</font></td>"
                            yt_header &= "<td><font class='small_header_text'><b>Yacht Name</b>&nbsp;</font></td>"
                            yt_header &= "<td><font class='small_header_text'><b>Year</b>&nbsp;</font></td>"
                            yt_header &= "<td><font class='small_header_text'><b>Hull</b>&nbsp;</font></td>"
                            yt_header &= "<td><font class='small_header_text'><b>For Sale?</b>&nbsp;</font></td>"
                            yt_header &= "<td><font class='small_header_text'><b>For Lease?</b>&nbsp;</font></td>"
                            yt_header &= "<td><font class='small_header_text'><b>Status</b>&nbsp;</font></td>"
                            yt_header &= "<td><font class='small_header_text'><b>Relationship</b>&nbsp;</font></td>"
                            yt_header &= "</tr>"


                            yacht_Table &= yt_header

                            For Each y As DataRow In YachtTable.Rows


                                ' the <> is so you dont break in the middle of one yacht with multiple relationships
                                If temp_counter > 28 And Trim(y("ym_brand_name")) <> "" Then
                                    yacht_Table &= ("</td></tr></table></td></tr></table>")
                                    yacht_Table &= Insert_Page_Break_PDF()
                                    yacht_Table &= Replace(page_yacht_header, "Related Yachts", "Related Yachts (Cont.)")
                                    yacht_Table &= yt_header
                                    temp_counter = 0
                                End If

                                If bgcolor = "" Then
                                    bgcolor = "#f0f0f0"
                                Else
                                    bgcolor = ""
                                End If

                                yacht_Table &= "<tr bgcolor='" & bgcolor & "'>"
                                yacht_Table &= "<td><font class='small_header_text'>"
                                yacht_Table &= y("ym_brand_name")
                                yacht_Table &= "&nbsp;</font></td>"

                                yacht_Table &= "<td><font class='small_header_text'>"
                                yacht_Table &= y("yt_yacht_name")
                                yacht_Table &= "&nbsp;</font></td>"

                                yacht_Table &= "<td><font class='small_header_text'>"
                                yacht_Table &= y("yt_year_mfr")
                                yacht_Table &= "&nbsp;</font></td>"

                                yacht_Table &= "<td><font class='small_header_text'>"
                                yacht_Table &= y("yt_hull_mfr_nbr")
                                yacht_Table &= "&nbsp;</font></td>"

                                yacht_Table &= "<td><font class='small_header_text'>"
                                yacht_Table &= y("yt_forsale_flag")
                                yacht_Table &= "&nbsp;</font></td>"

                                yacht_Table &= "<td><font class='small_header_text'>"
                                yacht_Table &= y("yt_for_lease_flag")
                                yacht_Table &= "&nbsp;</font></td>"

                                yacht_Table &= "<td><font class='small_header_text'>"
                                yacht_Table &= y("yt_forsale_status")
                                yacht_Table &= "&nbsp;</font></td>"

                                yacht_Table &= "<td><font class='small_header_text'>"
                                yacht_Table &= y("yct_name")
                                yacht_Table &= "&nbsp;</font></td>"

                                yacht_Table &= "</tr>"

                                temp_counter = temp_counter + 1

                            Next
                        Else
                            yt_header &= "<font class='small_header_text'><b>No Yacht Records Found</b></font></td></tr>"

                            yacht_Table &= yt_header
                        End If
                    End If

                    yacht_Table &= "</table>"
                    yacht_Table &= "</td></tr>"
                End If


                create_report_47_export_company_details &= yacht_Table

                If Trim(Request("homebase")) = "Y" And YachtTable.Rows.Count = 0 Then
                Else
                    email_string &= yacht_Table
                End If


            End If
            '--------------- FILL YACHT INFORMATION------------------ 


            If Trim(Request("test")) = "Y" Then

            ElseIf Trim(Request("test2")) = "Y" Then
            Else
                create_report_47_export_company_details &= "</td></tr></table>"
                create_report_47_export_company_details &= "</td></tr></table></html>"
            End If

            If Trim(Request("homebase")) = "Y" Then
                create_report_47_export_company_details = email_string
            End If


        Catch ex As Exception
        Finally
            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing
        End Try

    End Function

    Public Sub get_current_company_info(ByVal CompanyID As Long, ByVal JournalID As Long, ByRef string_to_add_to As String, ByRef logo_text As String, ByRef has_desrip As Boolean, ByVal from_spot As String, Optional ByRef record_count As Long = 0)


        Dim InfoTable As New DataTable
        Dim PhoneTable As New DataTable
        Dim Email As String = ""
        Dim Website As String = ""
        Dim LogoFlag As Boolean = False
        Dim MainLocationID As Long = 0
        Dim PerformExtraLookupMainLocation As Boolean = True
        Dim MainLocationDataTable As New DataTable
        Dim comp_desc As String = ""
        Dim bHasImage As Boolean = False

        string_to_add_to &= "<tr valign='top'><td colspan='5' width='50%' valign='top'>"
        string_to_add_to &= "<table width='100%' cellpadding='0' cellspacing='0'>"

        ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
        'Main Company Query.
        If Trim(JETNET_OR_CLIENT) = "CLIENT" Then
            InfoTable = Master.aclsData_Temp.GetCompanyInfo_ID(client_comp_id, JETNET_OR_CLIENT, JournalID)
        Else
            InfoTable = Master.aclsData_Temp.GetCompanyInfo_ID(CompanyID, JETNET_OR_CLIENT, JournalID)
        End If

        record_count = InfoTable.Rows.Count

        If Not IsNothing(InfoTable) Then
            If InfoTable.Rows.Count > 0 Then
                'If Not IsDBNull(InfoTable.Rows(0).Item("comp_alternate_name")) Then
                '  DoingBusinessAs = IIf(Not IsDBNull(InfoTable.Rows(0).Item("comp_alternate_name_type")), InfoTable.Rows(0).Item("comp_alternate_name_type").ToString, "") & ":" & IIf(Not IsDBNull(InfoTable.Rows(0).Item("comp_alternate_name")), InfoTable.Rows(0).Item("comp_alternate_name").ToString, "")
                'End If
                'Set the Tab Header

                If Trim(from_spot) = "new" Then
                    string_to_add_to &= "<tr><td align='left' colspan='2'>&nbsp;</td></tr>"
                    string_to_add_to &= "<tr class='" & Session("ROW_CLASS_BOTTOM") & "' valign='top'><td align='left'>"

                    If Not IsDBNull(InfoTable.Rows(0).Item("comp_logo_flag")) Then
                        If InfoTable.Rows(0).Item("comp_logo_flag") = "Y" Then
                            LogoFlag = True
                            PerformExtraLookupMainLocation = False
                        Else
                            LogoFlag = False
                        End If
                    End If

                    ' information_label.Text += "<td align='left' valign='top' width='40%'>"
                    If LogoFlag Then
                        bHasImage = display_company_logo_check("Y", CompanyID, logo_text, "")
                    End If
                    ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''


                    If Not IsDBNull(InfoTable.Rows(0).Item("comp_name")) Then
                        string_to_add_to &= "<font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER_NOALIGN") & "'>" & InfoTable.Rows(0).Item("comp_name")
                        string_to_add_to &= "</font>"
                        ' string_to_add_to &= comp_functions.create_value_with_label("Company Details", InfoTable.Rows(0).Item("comp_name"), False, False) & "<br/>"
                    End If

                    If Not IsDBNull(InfoTable.Rows(0).Item("comp_address1")) Then
                        If Trim(InfoTable.Rows(0).Item("comp_address1")) <> "" Then
                            string_to_add_to &= comp_functions.create_value_with_label("", InfoTable.Rows(0).Item("comp_address1"), False, False, Counter_For_PDF, spacer_width) & "<br/>"
                        End If
                    End If

                    If Not IsDBNull(InfoTable.Rows(0).Item("comp_address2")) Then
                        If Trim(InfoTable.Rows(0).Item("comp_address2")) <> "" Then
                            string_to_add_to &= comp_functions.create_value_with_label("", InfoTable.Rows(0).Item("comp_address2"), False, False, Counter_For_PDF, spacer_width) & "<br/>"
                        End If
                    End If

                    If Not IsDBNull(InfoTable.Rows(0).Item("comp_city")) Then
                        If Trim(InfoTable.Rows(0).Item("comp_city")) <> "" Then
                            string_to_add_to &= comp_functions.create_value_with_label("", InfoTable.Rows(0).Item("comp_city"), False, False, Counter_For_PDF, spacer_width)
                        End If
                    End If

                    If Not IsDBNull(InfoTable.Rows(0).Item("comp_state")) Then
                        If Trim(InfoTable.Rows(0).Item("comp_state")) <> "" Then
                            string_to_add_to &= ", " & comp_functions.create_value_with_label("", InfoTable.Rows(0).Item("comp_state"), False, False, Counter_For_PDF, spacer_width)
                        End If
                    End If


                    If Not IsDBNull(InfoTable.Rows(0).Item("comp_country")) Then
                        If Trim(InfoTable.Rows(0).Item("comp_country")) <> "" Then
                            string_to_add_to &= " " & comp_functions.create_value_with_label("", InfoTable.Rows(0).Item("comp_country"), False, False, Counter_For_PDF, spacer_width)
                        End If
                    End If

                    If Not IsDBNull(InfoTable.Rows(0).Item("comp_zip_code")) Then
                        If Trim(InfoTable.Rows(0).Item("comp_zip_code")) <> "" Then
                            string_to_add_to &= " " & comp_functions.create_value_with_label("", InfoTable.Rows(0).Item("comp_zip_code"), False, False, Counter_For_PDF, spacer_width) & "<br/>"
                        End If
                    End If


                    If Not IsDBNull(InfoTable.Rows(0).Item("comp_web_address")) Then
                        If Trim(InfoTable.Rows(0).Item("comp_web_address")) <> "" Then
                            string_to_add_to &= comp_functions.create_value_with_label("", "<a href='http://www." & Replace(InfoTable.Rows(0).Item("comp_web_address"), "www.", "") & "' target='new'>" & InfoTable.Rows(0).Item("comp_web_address") & "</a>", False, False, Counter_For_PDF, spacer_width) & "<br/>"
                        End If
                    End If

                    If Not IsDBNull(InfoTable.Rows(0).Item("comp_email_address")) Then
                        If Trim(InfoTable.Rows(0).Item("comp_email_address")) <> "" Then
                            string_to_add_to &= comp_functions.create_value_with_label("", "<a href='mailto:" & InfoTable.Rows(0).Item("comp_email_address") & "'>" & InfoTable.Rows(0).Item("comp_email_address") & "</a>", False, False, Counter_For_PDF, spacer_width) & "<br/>"
                        End If
                    End If



                    'Phone Company Query
                    PhoneTable = Master.aclsData_Temp.GetPhoneNumbers(CompanyID, 0, "JETNET", JournalID)
                    If Not IsNothing(PhoneTable) Then
                        If PhoneTable.Rows.Count > 0 Then
                            '  information_label.Text += "<td align='left' valign='top' width='40%'>"
                            For Each r As DataRow In PhoneTable.Rows
                                If Not IsDBNull(r("pnum_type")) Then
                                    If Not IsDBNull(r("pnum_number")) Then
                                        If Trim(r("pnum_type")) = "Fax" Then
                                            string_to_add_to &= comp_functions.create_value_with_label(r("pnum_type") & "", r("pnum_number"), False, False, Counter_For_PDF, spacer_width) & "<br/>"
                                        Else
                                            string_to_add_to &= comp_functions.create_value_with_label(r("pnum_type") & " Phone", r("pnum_number"), False, False, Counter_For_PDF, spacer_width) & "<br/>"
                                        End If
                                    End If
                                Else
                                    If Not IsDBNull(r("pnum_number")) Then
                                        string_to_add_to &= comp_functions.create_value_with_label("Phone", r("pnum_number"), False, False, Counter_For_PDF, spacer_width) & "<br/>"
                                    End If
                                End If
                            Next
                        End If
                    End If
                    PhoneTable = Nothing

                    string_to_add_to &= "</td><td align='left'>"

                    If bHasImage = True Then
                        If Trim(logo_text) <> "" Then
                            string_to_add_to &= logo_text
                            'string_to_add_to &= "<tr><td colspan='10' align='center'>" & logo_text & "</td></tr>"
                            ' string_to_add_to &= "<tr><td colspan='10' align='center'>&nbsp;</td></tr>"
                        End If
                    End If

                    string_to_add_to &= "</td></tr>"

                    If Not IsDBNull(InfoTable.Rows(0).Item("clicomp_description")) Then
                        If Trim(InfoTable.Rows(0).Item("clicomp_description")) <> "" Then
                            string_to_add_to &= "<tr class='" & Session("ROW_CLASS_BOTTOM") & "' valign='top'>"
                            string_to_add_to &= "<td align='left' width='" & spacer_width & "' colspan='2'>"
                            string_to_add_to &= "<br/><font class='" & Session("FONT_CLASS_TEXT") & "'>" & InfoTable.Rows(0).Item("clicomp_description")
                            string_to_add_to &= "&nbsp;</font>"
                            string_to_add_to &= "</td></tr>"
                        End If
                    End If


                    If Not IsDBNull(InfoTable.Rows(0).Item("clicomp_description")) Then
                        If Trim(InfoTable.Rows(0).Item("clicomp_description")) <> "" Then
                            string_to_add_to &= "<tr valign='top'>"
                            string_to_add_to &= "<td align='left' width='" & spacer_width & "' colspan='2'>"
                            string_to_add_to &= Fill_Certifications_Tab(CompanyID)
                            string_to_add_to &= "&nbsp;</font>"
                            string_to_add_to &= "</td></tr>"
                        End If
                    End If




                Else
                    string_to_add_to &= "<tr><td><font class='header_text'><b>" & (IIf(Not IsDBNull(InfoTable.Rows(0).Item("comp_name")), InfoTable.Rows(0).Item("comp_name").ToString & "", " Company Details")) & ""

                    If Not IsDBNull(InfoTable.Rows(0).Item("comp_alternate_name_type")) Then
                        string_to_add_to &= "<br>" & InfoTable.Rows(0).Item("comp_alternate_name_type") & ": "
                        If Not IsDBNull(InfoTable.Rows(0).Item("comp_alternate_name")) Then
                            string_to_add_to &= " " & InfoTable.Rows(0).Item("comp_alternate_name")
                        End If
                    ElseIf Not IsDBNull(InfoTable.Rows(0).Item("comp_alternate_name")) Then
                        string_to_add_to &= "<br>" & InfoTable.Rows(0).Item("comp_alternate_name")
                    End If

                    string_to_add_to &= "</b></font></td></tr>"


                    string_to_add_to &= IIf(Not IsDBNull(InfoTable.Rows(0).Item("comp_address1")), "<tr><td><font class='small_header_text'>" & InfoTable.Rows(0).Item("comp_address1").ToString & "</font></td></tr>", "")
                    string_to_add_to &= IIf(Not IsDBNull(InfoTable.Rows(0).Item("comp_address2")), "<tr><td><font class='small_header_text'>" & InfoTable.Rows(0).Item("comp_address2").ToString & "</font></td></tr>", "")



                    string_to_add_to &= "<tr><td><font class='small_header_text'>"
                    string_to_add_to &= IIf(Not IsDBNull(InfoTable.Rows(0).Item("comp_city")), InfoTable.Rows(0).Item("comp_city").ToString & ", ", "")
                    string_to_add_to &= IIf(Not IsDBNull(InfoTable.Rows(0).Item("comp_state")), InfoTable.Rows(0).Item("comp_state").ToString & " ", "")
                    string_to_add_to &= IIf(Not IsDBNull(InfoTable.Rows(0).Item("comp_country")), InfoTable.Rows(0).Item("comp_country").ToString & " ", "")
                    string_to_add_to &= IIf(Not IsDBNull(InfoTable.Rows(0).Item("comp_zip_code")), InfoTable.Rows(0).Item("comp_zip_code").ToString & " ", "")
                    string_to_add_to &= "</font></td></tr>"


                    Website = IIf(Not IsDBNull(InfoTable.Rows(0).Item("comp_web_address")), InfoTable.Rows(0).Item("comp_web_address").ToString, "")
                    Email = IIf(Not IsDBNull(InfoTable.Rows(0).Item("comp_email_address")), InfoTable.Rows(0).Item("comp_email_address").ToString, "")

                    Website = Replace(Website, "http://", "")
                    'Website = Replace(Website, "www.", "")
                    If Not IsDBNull(InfoTable.Rows(0).Item("comp_logo_flag")) Then
                        If InfoTable.Rows(0).Item("comp_logo_flag") = "Y" Then
                            LogoFlag = True
                            PerformExtraLookupMainLocation = False
                        Else
                            LogoFlag = False
                        End If
                    End If

                    'Display Email Information.
                    If Email <> "" Then
                        string_to_add_to &= "<tr><td><font class='small_header_text'>Email: <a href='mailto:" & Email & "'>" & Email & "</a></font></td></tr>"
                    End If
                    'Display Website Information.
                    If Website <> "" Then
                        string_to_add_to &= "<tr><td><font class='small_header_text'><a href='http://www." & Replace(Website, "www.", "") & "' target='new'>" & Website & "</a></font></td></tr>"
                    End If

                    If Not IsDBNull(InfoTable.Rows(0).Item("clicomp_description")) Then
                        If InfoTable.Rows(0).Item("clicomp_description").ToString <> "" Then
                            has_desrip = True
                            comp_desc &= "<tr valign='top'><td colspan='10' valign='top'><font class='small_header_text'>"
                            comp_desc &= "&nbsp;"
                            comp_desc &= "</font></td></tr>"
                            comp_desc &= "<tr valign='top'><td colspan='10' valign='top'><font class='small_header_text'>"
                            comp_desc &= InfoTable.Rows(0).Item("clicomp_description").ToString
                            comp_desc &= "</font></td></tr>"
                        End If
                    End If

                    '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''' 

                    ' information_label.Text += "<td align='left' valign='top' width='40%'>"
                    If LogoFlag Then
                        bHasImage = display_company_logo_check("Y", CompanyID, logo_text, "")
                    End If
                    ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

                    'Phone Company Query
                    PhoneTable = Master.aclsData_Temp.GetPhoneNumbers(CompanyID, 0, "JETNET", JournalID)
                    If Not IsNothing(PhoneTable) Then
                        If PhoneTable.Rows.Count > 0 Then
                            '  information_label.Text += "<td align='left' valign='top' width='40%'>"
                            For Each r As DataRow In PhoneTable.Rows
                                string_to_add_to &= "<tr><td><font class='small_header_text'>" & IIf(Not IsDBNull(r("pnum_type")), r("pnum_type"), "") & ":&nbsp;</font><font class='small_header_text2'>" & IIf(Not IsDBNull(r("pnum_number")), r("pnum_number"), "") & "</font></td></tr>"
                            Next
                            'information_label.Text += "</td>"
                        End If
                    End If
                    PhoneTable = Nothing


                    string_to_add_to &= "</table>"

                    string_to_add_to &= "</td><td width='50%' valign='top'>"
                    string_to_add_to &= logo_text
                    string_to_add_to &= "</td></tr>"

                    If has_desrip = True Then
                        string_to_add_to &= comp_desc
                    End If


                End If
            End If
        End If
        InfoTable = Nothing


        ' added MSW - 1/24/18
        string_to_add_to &= "</td></tr></table>"



    End Sub
    Public Function Fill_Certifications_Tab(ByVal CompanyID As Long) As String
        Fill_Certifications_Tab = ""
        Dim CertifactionsTable As New DataTable
        Dim count As Integer = 0
        CertifactionsTable = Master.aclsData_Temp.Return_Certifications(CompanyID, 0)
        If Not IsNothing(CertifactionsTable) Then
            If (CertifactionsTable.Rows.Count > 0) Then
                'certifications_label.Text = "<div class=""padding row"">"

                '  Fill_Certifications_Tab &= "<table cellspacing='0' cellpadding='0' border='0' align='center'>"

                Fill_Certifications_Tab &= "<tr><td colspan='5'><font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER") & "'>Operating Certification(s)</font></td></tr>"

                Fill_Certifications_Tab &= "<tr>"

                For Each q As DataRow In CertifactionsTable.Rows
                    If count = 4 Then
                        '  certifications_label.Text += "</div><div class=""padding row"">"
                        '  count = 0
                        Fill_Certifications_Tab &= "</tr><tr>"
                    End If
                    Fill_Certifications_Tab &= "<td align='center'>&nbsp;<img src=""" & clsData_Manager_SQL.get_site_name & "/images/" & q("ccerttype_logo_image").ToString & """ alt=""" & q("ccerttype_type").ToString & """ height='90' />&nbsp;<br /><font class='" & Session("FONT_CLASS_TEXT") & "'>" & q("ccerttype_type").ToString & "</font></td>"

                    count = count + 1
                Next

                Fill_Certifications_Tab &= "</tr>"
                Fill_Certifications_Tab &= "</table>"
                'certifications_label.Text += "</div>"
            Else
                ' certifications.Visible = False
            End If
            'Response.Write(certifications_label.Text)
        Else
            If Master.aclsData_Temp.class_error <> "" Then
                Master.LogError("CompanyTabs.ascx.vb -Fill_Certifications() - " & Master.aclsData_Temp.class_error)
            End If
        End If
    End Function
    Public Shared Sub Display_Contact_Details_PDF(ByVal contactTable As DataTable, ByRef string_to_add_to As String, ByVal CompanyID As Long, ByVal JournalID As Long, ByRef Master As Object, ByVal UseClass As Boolean, ByVal DisplayLink As Boolean, ByVal is_homebase As String, ByVal spec_id As Long)
        Dim PhoneTable As New DataTable
        Dim cssString As String = ""
        Dim x As Integer = 0
        Dim row_num As Integer = 0
        Dim contact_string As String = ""



        If Not IsNothing(contactTable) Then

            Try


                If contactTable.Rows.Count > 0 Then

                    If spec_id = 54 Then
                    Else
                        contact_string &= "<table width='100%' cellspacing='0' cellpadding='3' class='data_aircraft_grid'>"
                        ' this is my way of saying that it is called to display a single contact details 
                        If contactTable.Rows.Count = 1 And DisplayLink = False Then
                        Else
                            contact_string &= "<tr><td align='left' valign='top' width='33%'></td><td align='left' valign='top' width='33%'></td><td align='left' valign='top' width='33%'></td></tr>"
                        End If
                    End If

                    If spec_id = 54 Then
                        contact_string &= "<tr class='" & HttpContext.Current.Session("ROW_CLASS_BOTTOM") & "' valign='top'>"
                    Else
                        contact_string &= "<tr>"
                    End If


                    For Each r As DataRow In contactTable.Rows


                        If spec_id = 54 Then

                            If x = 3 Then

                                If spec_id = 54 Then
                                    contact_string &= "</tr><tr class='" & HttpContext.Current.Session("ROW_CLASS_BOTTOM") & "' valign='top'>"
                                Else
                                    contact_string &= "</tr><tr>"
                                End If

                                x = 0
                                If row_num = 1 Then
                                    row_num = 0
                                Else
                                    row_num = 1
                                End If
                            End If

                            contact_string &= "<td align='left' valign='top' class='" & cssString & "' width='250'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>"
                            contact_string &= IIf(Not IsDBNull(r("contact_sirname")), r("contact_sirname").ToString & " ", "")
                            contact_string &= IIf(Not IsDBNull(r("contact_first_name")), r("contact_first_name").ToString & " ", "")
                            contact_string &= IIf(Not IsDBNull(r("contact_middle_initial")), r("contact_middle_initial").ToString & " ", "")
                            If Not IsDBNull(r("contact_middle_initial")) Then
                                If Trim(r("contact_middle_initial")) <> "" Then
                                    contact_string &= ". "
                                Else
                                    contact_string &= " "
                                End If
                            Else
                                contact_string &= " "
                            End If

                            contact_string &= IIf(Not IsDBNull(r("contact_last_name")), r("contact_last_name").ToString & " ", "")

                            contact_string &= IIf(DisplayLink = True, "</a>", "") & "</b>"

                            If contactTable.Rows.Count > 1 Then

                                contact_string &= "<table align='right'><tr><td align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"

                                If Not IsDBNull(r("conpic_contact_id")) Then
                                    contact_string &= "&nbsp;&nbsp;" & IIf(DisplayLink = True, "<a " & DisplayFunctions.WriteDetailsLink(0, CompanyID, r("contact_id"), 0, False, "", "", "") & ">", "") & "<img src='/images/camera.png' width='12' title='" & r("contact_first_name") & " Has a Photo' border='0' />" & IIf(DisplayLink = True, "</a>", "")
                                End If

                                contact_string &= "</font></td></tr></table>"

                            End If

                            contact_string &= "</font></font><br>"
                            contact_string &= IIf(Not IsDBNull(r("contact_title")), "<font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & r("contact_title").ToString & "", "")
                            contact_string &= "</font></font>"
                            contact_string &= "<br>"
                            If DisplayLink = False Then
                                contact_string &= IIf(Not IsDBNull(r("contact_email_address")), "<font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" + r("contact_email_address").ToString + "</span>", "")
                            Else
                                contact_string &= IIf(Not IsDBNull(r("contact_email_address")), "<font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><a href='mailto:" & r("contact_email_address").ToString & "'>" + r("contact_email_address").ToString + "</a></span>", "")
                            End If

                            contact_string &= "</font></font>"


                            ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
                            'Phone Company Query
                            PhoneTable = Master.aclsData_Temp.GetPhoneNumbers(CompanyID, r("contact_id"), "JETNET", JournalID)
                            If Not IsNothing(PhoneTable) Then
                                If PhoneTable.Rows.Count > 0 Then
                                    For Each m As DataRow In PhoneTable.Rows
                                        contact_string &= "<br><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>" & IIf(Not IsDBNull(m("pnum_type")), m("pnum_type"), "") & ":&nbsp;</font><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & IIf(Not IsDBNull(m("pnum_number")), m("pnum_number"), "") & "</font>"
                                    Next
                                End If
                            End If
                            PhoneTable = Nothing

                            x += 1

                        Else

                            ' If x Mod 2 = 0 Then
                            If x = 3 Then
                                contact_string &= "</tr><tr>"
                                x = 0
                                If row_num = 1 Then
                                    row_num = 0
                                Else
                                    row_num = 1
                                End If
                            End If


                            If Trim(is_homebase) = "Y" Then
                                If UseClass = True Then
                                    If row_num = 0 Then
                                        If x = 0 Then
                                            cssString = ""
                                        ElseIf x = 1 Then
                                            cssString = "' bgcolor='#f0f0f0"
                                        Else
                                            cssString = ""
                                        End If
                                    Else
                                        If x = 0 Then
                                            cssString = "' bgcolor='#f0f0f0"
                                        ElseIf x = 1 Then
                                            cssString = ""
                                        Else
                                            cssString = "' bgcolor='#f0f0f0"
                                        End If
                                    End If
                                End If
                            Else
                                If UseClass = True Then
                                    If row_num = 0 Then
                                        If x = 0 Then
                                            cssString = ""
                                        ElseIf x = 1 Then
                                            cssString = "alt_row"
                                        Else
                                            cssString = ""
                                        End If
                                    Else
                                        If x = 0 Then
                                            cssString = "alt_row"
                                        ElseIf x = 1 Then
                                            cssString = ""
                                        Else
                                            cssString = "alt_row"
                                        End If
                                    End If
                                End If
                            End If


                            contact_string &= "<td align='left' valign='top' class='" & cssString & "' width='250'><font class='small_header_text'>" & IIf(UseClass = True, "<div class='padding'>", "")
                            contact_string &= "" & IIf(UseClass = True, "<div class='header_row  padding'>", "<span class='li_no_bullet'>") & "<b class='title'>" & IIf(DisplayLink = True, "<a " & DisplayFunctions.WriteDetailsLink(0, CompanyID, r("contact_id"), 0, False, "", "", "") & ">", "")
                            contact_string &= IIf(Not IsDBNull(r("contact_sirname")), r("contact_sirname").ToString & " ", "")
                            contact_string &= IIf(Not IsDBNull(r("contact_first_name")), r("contact_first_name").ToString & " ", "")
                            contact_string &= IIf(Not IsDBNull(r("contact_middle_initial")), r("contact_middle_initial").ToString & " ", "")
                            If Not IsDBNull(r("contact_middle_initial")) Then
                                If Trim(r("contact_middle_initial")) <> "" Then
                                    contact_string &= ". "
                                Else
                                    contact_string &= " "
                                End If
                            Else
                                contact_string &= " "
                            End If

                            contact_string &= IIf(Not IsDBNull(r("contact_last_name")), r("contact_last_name").ToString & " ", "")

                            contact_string &= IIf(Not IsDBNull(r("contact_suffix")), r("contact_suffix").ToString & " ", "")

                            contact_string &= IIf(DisplayLink = True, "</a>", "") & "</b>"

                            If contactTable.Rows.Count > 1 Then

                                contact_string &= "<table align='right'><tr><td align='right'><font class='small_header_text'>"

                                If Not IsDBNull(r("conpic_contact_id")) Then
                                    contact_string &= "&nbsp;&nbsp;" & IIf(DisplayLink = True, "<a " & DisplayFunctions.WriteDetailsLink(0, CompanyID, r("contact_id"), 0, False, "", "", "") & ">", "")
                                    If Trim(is_homebase) = "Y" And spec_id = 47 Then ' dont show an image - added MSW 5/9/18
                                    Else
                                        contact_string &= "<img src='/images/camera.png' width='12' title='" & r("contact_first_name") & " Has a Photo' border='0' />"
                                    End If
                                    contact_string &= IIf(DisplayLink = True, "</a>", "")
                                End If

                                contact_string &= "</font></td></tr></table>"

                            End If

                            contact_string &= "</font></font><br>"
                            contact_string &= IIf(Not IsDBNull(r("contact_title")), "<font class='small_header_text'>" & r("contact_title").ToString & "", "")
                            contact_string &= "</font></font>"
                            contact_string &= "<br>"
                            If DisplayLink = False Then
                                contact_string &= IIf(Not IsDBNull(r("contact_email_address")), "<font class='small_header_text'>" + r("contact_email_address").ToString + "</span>", "")
                            Else
                                contact_string &= IIf(Not IsDBNull(r("contact_email_address")), "<font class='small_header_text'><a href='mailto:" & r("contact_email_address").ToString & "'>" + r("contact_email_address").ToString + "</a></span>", "")
                            End If

                            contact_string &= "</font></font>"


                            ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
                            'Phone Company Query
                            PhoneTable = Master.aclsData_Temp.GetPhoneNumbers(CompanyID, r("contact_id"), "JETNET", JournalID)
                            If Not IsNothing(PhoneTable) Then
                                If PhoneTable.Rows.Count > 0 Then
                                    For Each m As DataRow In PhoneTable.Rows
                                        contact_string &= "<br><font class='small_header_text2'>" & IIf(Not IsDBNull(m("pnum_type")), m("pnum_type"), "") & ":&nbsp;</font><font class='small_header_text'>" & IIf(Not IsDBNull(m("pnum_number")), m("pnum_number"), "") & "</font>"
                                    Next
                                End If
                            End If
                            PhoneTable = Nothing

                            contact_string &= IIf(UseClass = True, "</div>", "")

                            contact_string &= "</div></font>"
                            contact_string &= "</td>"

                            x += 1

                        End If

                    Next

                    contact_string &= "</tr>"

                    If spec_id = 54 Then
                    Else
                        contact_string &= "</table>"
                    End If






                Else
                    contact_string &= "<p align='center'>No Contacts Found.</p>"
                End If


                string_to_add_to = string_to_add_to & contact_string

            Catch ex As Exception
            Finally
            End Try

        End If
    End Sub

    Private Function FixAircraftTableRemoveDuplicates(ByVal AircraftTable As DataTable) As DataTable
        Dim oldACID As Long = 0
        Dim ACCounter As Integer = 0
        Dim NewAircraftTable As New DataTable

        NewAircraftTable = AircraftTable.Clone

        For Each r As DataRow In AircraftTable.Rows
            Dim newRow As DataRow = NewAircraftTable.NewRow()

            If oldACID = r("ac_id") Then
                newRow("amod_make_name") = ""
                newRow("amod_make_type") = ""
                newRow("ac_id") = 0
                newRow("ac_amod_id") = 0
                newRow("ac_ser_nbr") = ""
                newRow("ac_reg_nbr") = ""
                newRow("ac_airframe_total_hours") = 0
                newRow("ac_year") = ""
                newRow("amod_model_name") = ""
                newRow("ac_status") = ""
                newRow("ac_year_mfr") = ""
                newRow("ac_forsale_flag") = ""
                newRow("ac_exclusive_flag") = ""
                newRow("ac_asking_wordage") = ""
                newRow("ac_asking_price") = 0
                newRow("ac_asking_wordage") = ""
                newRow("ac_ser_no_full") = ""
                'newRow("ac_date_listed") = ""
                newRow("ac_product_business_flag") = ""
                newRow("ac_product_helicopter_flag") = ""
                newRow("ac_product_commercial_flag") = ""
                newRow("ac_delivery") = ""
                newRow("aport_name") = ""
                newRow("aport_city") = ""
                newRow("aport_state") = ""
                newRow("aport_country") = ""
                newRow("ac_aport_name") = ""
                newRow("ac_aport_state") = ""
                newRow("ac_aport_country") = ""
                newRow("ac_aport_city") = ""
            Else
                ACCounter += 1
                newRow("amod_make_name") = r("amod_make_name").ToString
                newRow("amod_make_type") = r("amod_make_Type").ToString
                newRow("ac_id") = r("ac_id")
                newRow("ac_amod_id") = r("ac_amod_id")
                newRow("ac_ser_nbr") = r("ac_ser_nbr").ToString
                newRow("ac_reg_nbr") = r("ac_reg_nbr").ToString
                newRow("ac_airframe_total_hours") = r("ac_airframe_total_hours")
                newRow("ac_year") = r("ac_year").ToString
                newRow("amod_model_name") = r("amod_model_name").ToString
                newRow("ac_status") = r("ac_status").ToString
                newRow("ac_year_mfr") = r("ac_year_mfr").ToString
                newRow("ac_forsale_flag") = r("ac_forsale_flag").ToString
                newRow("ac_exclusive_flag") = r("ac_exclusive_flag").ToString
                newRow("ac_asking_wordage") = r("ac_asking_wordage").ToString
                newRow("ac_asking_price") = r("ac_asking_price")
                newRow("ac_asking_wordage") = r("ac_asking_wordage").ToString
                newRow("ac_ser_no_full") = r("ac_ser_no_full").ToString
                newRow("ac_date_listed") = r("ac_date_listed")
                newRow("ac_product_business_flag") = r("ac_product_business_flag").ToString
                newRow("ac_product_helicopter_flag") = r("ac_product_helicopter_flag").ToString
                newRow("ac_product_commercial_flag") = r("ac_product_commercial_flag").ToString
                newRow("ac_delivery") = ""

                newRow("aport_name") = r("aport_name").ToString
                newRow("aport_city") = r("aport_city").ToString
                newRow("aport_state") = r("aport_state").ToString
                newRow("aport_country") = r("aport_country").ToString

                newRow("ac_aport_name") = r("ac_aport_name").ToString
                newRow("ac_aport_state") = r("ac_aport_state").ToString
                newRow("ac_aport_country") = r("ac_aport_country").ToString
                newRow("ac_aport_city") = r("ac_aport_city").ToString
            End If

            newRow("comp_name") = r("comp_name").ToString
            newRow("comp_country") = r("comp_country").ToString
            newRow("comp_state") = r("comp_state").ToString
            newRow("comp_city") = r("comp_city").ToString

            newRow("contact_title") = r("contact_title").ToString
            newRow("contact_sirname") = r("contact_sirname").ToString
            newRow("contact_first_name") = r("contact_first_name").ToString
            newRow("contact_middle_initial") = r("contact_middle_initial").ToString
            newRow("contact_last_name") = r("contact_last_name").ToString
            newRow("contact_suffix") = r("contact_suffix").ToString
            newRow("act_name") = r("act_name").ToString

            newRow("cref_transmit_seq_no") = r("cref_transmit_seq_no")

            newRow("comp_id") = r("comp_id")
            newRow("contact_id") = r("contact_id")
            newRow("source") = r("source").ToString

            newRow("acref_owner_percentage") = r("acref_owner_percentage")

            NewAircraftTable.Rows.Add(newRow)
            NewAircraftTable.AcceptChanges()
            oldACID = r("ac_id")

        Next

        Return NewAircraftTable
    End Function

    Private Function FixYachtTableRemoveDuplicates(ByVal YachtTable As DataTable) As DataTable
        Dim oldYTID As Long = 0
        Dim YTCounter As Integer = 0
        Dim NewAircraftTable As New DataTable

        NewAircraftTable = YachtTable.Clone

        ' Sql = "select ym_brand_name, ym_model_name, yt_yacht_name, yct_name,  yt_year_mfr, yt_hull_mfr_nbr, yt_forsale_flag, "
        ' Sql += " yt_forsale_status, yt_asking_price, yt_central_agent_flag, yr_contact_type, yt_id"

        For Each r As DataRow In YachtTable.Rows
            Dim newRow As DataRow = NewAircraftTable.NewRow()

            If oldYTID = r("yt_id") Then
                newRow("ym_brand_name") = ""
                newRow("ym_model_name") = ""
                newRow("yt_yacht_name") = ""
                newRow("yct_name") = r("yct_name").ToString
                newRow("yt_year_mfr") = 1900
                newRow("yt_hull_mfr_nbr") = ""
                newRow("yt_forsale_flag") = ""
                newRow("yt_for_lease_flag") = ""
                newRow("yt_for_charter_flag") = ""
                newRow("yt_forsale_status") = ""
                newRow("yt_asking_price") = 0
                newRow("yt_central_agent_flag") = ""
                newRow("yr_contact_type") = ""
                newRow("yt_id") = 0
            Else
                YTCounter += 1
                newRow("ym_brand_name") = r("ym_brand_name").ToString
                newRow("ym_model_name") = r("ym_model_name").ToString
                newRow("yt_yacht_name") = r("yt_yacht_name").ToString
                newRow("yct_name") = r("yct_name").ToString
                newRow("yt_year_mfr") = r("yt_year_mfr").ToString
                newRow("yt_hull_mfr_nbr") = r("yt_hull_mfr_nbr").ToString
                newRow("yt_forsale_flag") = r("yt_forsale_flag").ToString
                newRow("yt_for_lease_flag") = r("yt_for_lease_flag").ToString
                newRow("yt_for_charter_flag") = r("yt_for_charter_flag").ToString
                newRow("yt_forsale_status") = r("yt_forsale_status").ToString
                newRow("yt_asking_price") = r("yt_asking_price").ToString
                newRow("yt_central_agent_flag") = r("yt_central_agent_flag").ToString
                newRow("yr_contact_type") = r("yr_contact_type").ToString
                newRow("yt_id") = r("yt_id").ToString
            End If


            NewAircraftTable.Rows.Add(newRow)
            NewAircraftTable.AcceptChanges()
            oldYTID = r("yt_id")
        Next

        '  company_amount_of_ac.Text = YTCounter
        Return NewAircraftTable
    End Function
    Public Function CompanyDetailsRelationships(ByVal compID As Long)
        Dim sql As String = ""
        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing
        Dim atemptable As New DataTable
        Try
            If Not String.IsNullOrEmpty(Session.Item("jetnetClientDatabase")) Then
                sql = "select * from ReturnCompanyRelationshipsByCompId(" & compID & ") order by Relsort, Relationship "

                HttpContext.Current.Session.Item("localUser").crmUser_DebugText = HttpContext.Current.Session.Item("localUser").crmUser_DebugText & "<br /><br /><b>Get_Company_Relationships(ByVal compID As Integer)</b><br />" & sql


                SqlConn.ConnectionString = Session.Item("jetnetClientDatabase")
                SqlConn.Open()
                SqlCommand.Connection = SqlConn

                SqlCommand.CommandText = sql
                SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
                SqlCommand.CommandType = CommandType.Text
                SqlCommand.CommandTimeout = 60

                Try
                    atemptable.Load(SqlReader)
                Catch constrExc As System.Data.ConstraintException
                    Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
                End Try
            End If

            Return atemptable
        Catch ex As Exception
            CompanyDetailsRelationships = Nothing
            'class_error = "Error in Get_Company_Relationships(ByVal comp_id As Integer): SQL VERSION " & ex.Message
        Finally
            SqlReader = Nothing

            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing
        End Try

    End Function
    Public Function Fill_Relationship_Tab(ByVal CompanyID As Long, ByVal JournalID As Long, ByVal is_new_spec As Boolean) As String
        Dim RelationshipTable As New DataTable
        Dim tempComp As New clsClient_Company
        Dim tempData As New DataTable
        Dim tempContact As New DataTable
        Dim bgcolor As String = ""
        Dim temp_text As String = ""
        Dim DoingBusinessAs As String = ""
        Dim row_start As Integer = 1

        RelationshipTable = Master.aclsData_Temp.Get_Company_Relationships(CompanyID, JournalID)
        'RelationshipTable = CompanyDetailsRelationships(CompanyID)
        If Not IsNothing(RelationshipTable) Then
            If RelationshipTable.Rows.Count > 0 Then
                'Setting up the relationship table because there are rows.

                If is_new_spec = True Then
                Else
                    temp_text = "<div class='data_aircraft_grid'>"
                    temp_text += "<div class='header_row row padding remove_margin'>"
                    temp_text += "<div><b class='title'>Company Relationships</b></div><div class='columns three'>"
                End If

                ' temp_text += "<b class='title'></b></div></div>"

                temp_text += "<table cellspacing='0' cellpadding='0' width='100%' border='0'>"

                For Each r As DataRow In RelationshipTable.Rows
                    'Declaring the local variables within the loop
                    Dim Contact_Class_Array As New ArrayList
                    Dim company_one As Integer = 0
                    Dim contact_one As Integer = 0
                    Dim contact_display As String = ""
                    Dim company_two As Integer = 0
                    Dim contact_two As Integer = 0
                    'making sure to set this to nothing
                    tempContact = New DataTable

                    'Setting up Company IDs
                    company_one = IIf(Not IsDBNull(r("compref_rel_comp_id")), r("compref_rel_comp_id"), 0)
                    contact_one = IIf(Not IsDBNull(r("compref_rel_contact_id")), r("compref_rel_contact_id"), 0)

                    company_two = IIf(Not IsDBNull(r("compref_comp_id")), r("compref_comp_id"), 0)
                    If company_one = CompanyID Then
                        contact_one = IIf(Not IsDBNull(r("compref_contact_id")), r("compref_contact_id"), 0)
                    End If


                    If row_start = 1 Or row_start = 7 Then
                        temp_text += "<tr valign='top'><td bgcolor=''><div class='row padding'>"
                    ElseIf row_start = 2 Then
                        temp_text += "<td bgcolor='#f0f0f0'>"
                    ElseIf row_start = 3 Then
                        temp_text += "<td bgcolor=''>"
                    ElseIf row_start = 4 Then
                        temp_text += "<tr valign='top'><td bgcolor='#f0f0f0'>"
                    ElseIf row_start = 5 Then
                        temp_text += "<td bgcolor=''>"
                    ElseIf row_start = 6 Then
                        temp_text += "<td bgcolor='#f0f0f0'>"
                        row_start = 0
                    End If

                    row_start = row_start + 1


                    'Get the contact information if we have it.
                    If contact_one <> 0 Then
                        tempContact = Master.aclsData_Temp.GetContacts_Details(contact_one, "JETNET")
                        If Not IsNothing(tempContact) Then
                            If tempContact.Rows.Count > 0 Then
                                Contact_Class_Array = clsGeneral.clsGeneral.Create_Array_Contact_Class(tempContact)
                                For Each Con As clsClient_Contact In Contact_Class_Array
                                    contact_display = clsGeneral.clsGeneral.Show_Contact_Display(Con)
                                Next
                            End If
                        Else
                            If Master.aclsData_Temp.class_error <> "" Then
                                Master.LogError("DisplayCompanyDetail - GetContacts_Details(" & contact_one & ", JETNET') - " & Master.aclsData_Temp.class_error)
                            End If
                        End If
                    End If

                    'Show the Company Information 
                    If company_one <> CompanyID Then
                        tempData = Master.aclsData_Temp.GetCompanyInfo_ID(company_one, "JETNET", JournalID)
                        If Not IsNothing(tempData) Then
                            If tempData.Rows.Count > 0 Then
                                tempComp = clsGeneral.clsGeneral.Create_Company_Class(tempData, "JETNET", Nothing)
                                If Not IsDBNull(r("actype_compref_name2")) Then
                                    If UCase(r("actype_compref_name2").ToString) = "DOING BUSINESS AS" Then
                                        DoingBusinessAs = "<a class='blue_text' " & tempComp.clicomp_name
                                    End If
                                    temp_text += "<div class='remove_margin'><b class='title'>" & r("actype_compref_name2") & "</b></div><div class='columns three'><b>" & tempComp.clicomp_name & "</b><br />" & clsGeneral.clsGeneral.Show_Company_Display(tempComp, False) & "<br />" & contact_display & "</div>"
                                End If
                            End If
                        End If
                    Else
                        tempData = Master.aclsData_Temp.GetCompanyInfo_ID(company_two, "JETNET", JournalID)
                        If Not IsNothing(tempData) Then
                            If tempData.Rows.Count > 0 Then
                                tempComp = clsGeneral.clsGeneral.Create_Company_Class(tempData, "JETNET", Nothing)
                                If Not IsDBNull(r("actype_name")) Then
                                    If UCase(r("actype_name").ToString) = "DOING BUSINESS AS" Then
                                        DoingBusinessAs = tempComp.clicomp_name
                                    End If
                                    temp_text += "<div class='remove_margin'><b class='title'>" & r("actype_name") & "</b></div><div class='columns three'><b>" & tempComp.clicomp_name & "</b><br />" & clsGeneral.clsGeneral.Show_Company_Display(tempComp, False) & "<br />" & contact_display & "</div>"
                                End If

                            End If
                        End If
                    End If
                    temp_text += "</div>"

                    temp_text += "</td>"

                    If row_start = 1 Or row_start = 7 Then
                        temp_text += "</tr>"
                    ElseIf row_start = 4 Then
                        temp_text += "</tr>"
                    End If

                    Contact_Class_Array = Nothing
                Next
                temp_text += "</div>"
            Else

            End If

            temp_text += "</table>"
        Else
            temp_text = "<table cellspacing='0' cellpadding='0' width='100%' border='0'>"
            temp_text += "<tr><td>No Company Relationships Found</td></tr>"
            temp_text += "</table>"
        End If



        Fill_Relationship_Tab = temp_text

        RelationshipTable = Nothing
        tempContact = Nothing
        tempComp = Nothing
        '  Response.Write(relationships_label.Text)
    End Function
    Public Sub Fill_Operations_Tab(ByVal CompanyID As Long, ByVal JournalID As Long, ByRef string_to_add As String, ByVal spec_id As Long)

        Dim this_section_string As String = ""
        Dim made_first_page_op As Boolean = False
        Dim string_header As String = ""


        string_header = comp_functions.NEW_Insert_Page_Break_PDF(Counter_For_PDF, reportType.SelectedValue)
        string_header &= comp_functions.NEW_build_full_spec_page_header(NEW_AC_ID, "", comp_address, comp_logo, 0, NEW_COMP_ID, bWordReport, word_width, pdf_html_width, check_prepared_for, chkBlindReport, prepared_for)


        If bWordReport = True Then
            string_header &= "<table width='" & word_width & "' align='center'>"
        Else
            string_header &= "<table width='" & pdf_html_width & "' align='center'>"
        End If



        If use_insight_roll = True Then
            If op_locations.Checked = True Then
                Call Fill_Locations_Tab(NEW_COMP_ID, JournalID, this_section_string, 54)
                string_to_add &= this_section_string & "<br/><br/>"
            End If
        End If


        If op_certs.Checked = True Then
            string_to_add &= Fill_Certifications_Tab(CompanyID)
            made_first_page_op = True
        End If

        If op_models.Checked = True Then
            If made_first_page_op = True Then
                string_to_add &= string_header
            End If
            util_functions.get_flight_activity_by_model_top_function(searchCriteria, this_section_string, "", "pdf")
            made_first_page = True
            string_to_add &= this_section_string
        End If

        ' relationships_tab.HeaderText = "Aircraft Utilization Summary"
        If op_util_chart.Checked = True Then
            If made_first_page_op = True Then
                string_to_add &= string_header
            End If
            Call util_functions.get_flight_profile_top_function(searchCriteria, this_section_string, "Month", "", "", "pdf", AVG_PRICE_MONTH)
            string_to_add &= this_section_string
            made_first_page = True
        End If

        'DisplayFunctions.load_google_chart(relationships_tab, this_section_string, "Operator # Flts", "", "chart_div_tab1_all", 465, 285, "POINTS", 1, String_to_return, Page, relationships_udpate_panel, False, False, True, False, False, False, False, True, False, False, 0, "bottom")
        'Call load_google_chart_all(relationships_tab, String_to_return)
        ' news_tab.HeaderText = "Airport Utilization (Last Year)"

        If op_airport.Checked = True Then
            If made_first_page_op = True Then
                string_to_add &= string_header
            End If
            Call util_functions.util_get_operator_airports_top_function(searchCriteria, this_section_string, 0, "", 0, "", "pdf", False, string_header)
            string_to_add &= this_section_string
            made_first_page = True
        End If


    End Sub

    Public Sub Fill_Owner_Tab(ByVal CompanyID As Long, ByVal JournalID As Long, ByRef string_to_add As String, ByVal spec_id As Long)

        Dim this_section_string As String = ""
        Dim made_first_page_op As Boolean = False
        Dim string_header As String = ""

        string_header = comp_functions.NEW_Insert_Page_Break_PDF(Counter_For_PDF, reportType.SelectedValue)
        string_header &= comp_functions.NEW_build_full_spec_page_header(NEW_AC_ID, "", comp_address, comp_logo, 0, NEW_COMP_ID, bWordReport, word_width, pdf_html_width, check_prepared_for, chkBlindReport, prepared_for)


        If bWordReport = True Then
            string_header &= "<table width='" & word_width & "' align='center'>"
        Else
            string_header &= "<table width='" & pdf_html_width & "' align='center'>"
        End If


        If use_insight_roll = True Then
            If own_locations.Checked = True Then
                this_section_string = ""
                Call Fill_Locations_Tab(NEW_COMP_ID, JournalID, this_section_string, 54)
                string_to_add &= this_section_string
                made_first_page_op = True
            End If
        End If

        If own_history.Checked = True Then
            this_section_string = ""
            util_functions.get_company_ownership_top_function(searchCriteria, this_section_string, "", "pdf", string_header)
            If made_first_page_op = True Then
                string_to_add &= string_header
            End If
            string_to_add &= this_section_string
            made_first_page_op = True
        End If

        If own_purchase_chart.Checked = True Then
            this_section_string = ""
            If made_first_page_op = True Then
                string_to_add &= string_header
            End If
            If use_insight_roll = True Then
                Call util_functions.get_company_purchase_history_top_function(searchCriteria, this_section_string, "Y", "pdf", AVG_PRICE_MONTH)
            Else
                Call util_functions.get_company_purchase_history_top_function(searchCriteria, this_section_string, "N", "pdf", AVG_PRICE_MONTH)
            End If
            string_to_add &= this_section_string
            made_first_page_op = True
        End If





    End Sub
    Public Sub Fill_Dealer_Tab(ByVal CompanyID As Long, ByVal JournalID As Long, ByRef string_to_add As String, ByVal spec_id As Long)

        Dim this_section_string As String = ""
        Dim made_first_page_op As Boolean = False
        Dim string_header As String = ""
        Dim HoldTable As New DataTable
        Dim TotalCount As Long = 0
        Dim toggleRowColor As Boolean = False
        Dim bgcolor As String = ""
        Dim high_number As Long = 0
        Dim low_number As Long = 100000
        Dim starting_point As Integer = 0
        Dim interval_point As Integer = 1
        Dim ending_point As Integer = 0


        Try

            string_header = comp_functions.NEW_Insert_Page_Break_PDF(Counter_For_PDF, reportType.SelectedValue)
            string_header &= comp_functions.NEW_build_full_spec_page_header(NEW_AC_ID, "", comp_address, comp_logo, 0, NEW_COMP_ID, bWordReport, word_width, pdf_html_width, check_prepared_for, chkBlindReport, prepared_for)


            If bWordReport = True Then
                string_header &= "<table width='" & word_width & "' align='center'>"
            Else
                string_header &= "<table width='" & pdf_html_width & "' align='center'>"
            End If


            If dealer_models.Checked = True Then
                If made_first_page_op = True Then
                    string_to_add &= string_header
                End If
                HoldTable = acdealer_view_function.ac_dealer_get_models_for_main_comp_id(CompanyID, "", searchCriteria.ViewCriteriaAmodID, searchCriteria, util_functions.rollup_text, "company")
                this_section_string = ""

                Call models_operated(HoldTable, this_section_string, CompanyID, searchCriteria.ViewCriteriaAmodID, searchCriteria)
                string_to_add &= this_section_string
                HoldTable.Rows.Clear()
                made_first_page_op = True
            End If
            'aircraft_model_label.Text = "<div class=""tab_container_div"">" & aircraft_model_label.Text & "</div>"


            If dealer_sales.Checked = True Then
                If made_first_page_op = True Then
                    string_to_add &= string_header
                End If
                HoldTable = acdealer_view_function.ac_dealer_get_sales_by_year_main_comp_id(CompanyID, "", searchCriteria.ViewCriteriaAmodID, searchCriteria, util_functions.rollup_text, "company")

                If Not IsNothing(HoldTable) Then
                    AVG_PRICE_MONTH.Series.Clear()
                    AVG_PRICE_MONTH.Series.Add("AVG_PRICE").ChartType = UI.DataVisualization.Charting.SeriesChartType.Spline
                    AVG_PRICE_MONTH.Series("AVG_PRICE").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32
                    AVG_PRICE_MONTH.Series("AVG_PRICE").LabelForeColor = Drawing.Color.Blue
                    AVG_PRICE_MONTH.ChartAreas("ChartArea1").AxisY.Title = "Dealer Sales Per Year"
                    AVG_PRICE_MONTH.Series("AVG_PRICE").Color = Drawing.Color.Blue
                    AVG_PRICE_MONTH.Series("AVG_PRICE").BorderWidth = 2
                    AVG_PRICE_MONTH.Series("AVG_PRICE").MarkerSize = 6
                    AVG_PRICE_MONTH.Series("AVG_PRICE").MarkerStyle = UI.DataVisualization.Charting.MarkerStyle.Circle
                    '  AVG_PRICE_MONTH.BorderlineWidth = 10
                    AVG_PRICE_MONTH.Series("AVG_PRICE").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32
                    'AVG_PRICE_MONTH.Series("AVG_PRICE").SmartLabelStyle.Enabled = False
                    'AVG_PRICE_MONTH.Series("AVG_PRICE").LabelAngle = 45
                    ' If WD.SelectedValue = "Word" or WD.SelectedValue = "WordX" Then
                    AVG_PRICE_MONTH.Width = 500
                    AVG_PRICE_MONTH.Height = 500
                    '  End If

                    If HoldTable.Rows.Count > 0 Then
                        ' this_section_string = " ['Year', 'Dealer Sales Per Year']"
                        For Each r As DataRow In HoldTable.Rows
                            'this_section_string &= ", ['" & r("TYEAR") & "', " & r("numtrans") & "]"
                            AVG_PRICE_MONTH.Series("AVG_PRICE").Points.AddXY(r("TYEAR"), r("numtrans"))

                            If CDbl(r("numtrans").ToString) > high_number Then
                                high_number = CDbl(r("numtrans").ToString)
                            End If
                            If CDbl(r("numtrans").ToString) < low_number Then
                                low_number = CDbl(r("numtrans").ToString)
                            End If
                        Next


                        commonEvo.set_ranges_for_vsCharts(low_number, high_number, interval_point, starting_point, ending_point)

                        AVG_PRICE_MONTH.ChartAreas("ChartArea1").AxisY.Maximum = ending_point
                        AVG_PRICE_MONTH.ChartAreas("ChartArea1").AxisY.Minimum = IIf(starting_point > 0, starting_point, 0)
                        AVG_PRICE_MONTH.ChartAreas("ChartArea1").AxisY.Interval = interval_point
                    End If
                End If
                HoldTable.Rows.Clear()
                AVG_PRICE_MONTH.Titles.Clear()
                AVG_PRICE_MONTH.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                AVG_PRICE_MONTH.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + CompanyID.ToString + "_DEAL_GRAPH1.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
                string_to_add &= "<table width='80%' align='center'>"
                string_to_add &= "<tr class='" & Session("ROW_CLASS_BOTTOM") & "'><td colspan='2' align='center'><font class='" & Session("FONT_CLASS_HEADER") & "'>Dealer Sales Per Year</font></td></tr>"
                string_to_add &= "<tr><td align='center'><img src='" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + CompanyID.ToString + "_DEAL_GRAPH1.jpg'><br></td></tr>"
                string_to_add &= "</table>"


                made_first_page_op = True
            End If


            If dealer_roles.Checked = True Then
                this_section_string = ""
                If made_first_page_op = True Then
                    string_to_add &= string_header
                End If
                If use_insight_roll = True Then
                    HoldTable = acdealer_view_function.ac_dealer_get_relationship_sales_main_comp_id(CompanyID, "", 0, searchCriteria, util_functions.rollup_text)
                Else
                    HoldTable = acdealer_view_function.ac_dealer_get_relationship_sales_main_comp_id(CompanyID, "", 0, searchCriteria, "")
                End If


                If Not IsNothing(HoldTable) Then
                    AVG_PRICE_MONTH.Series.Clear()
                    AVG_PRICE_MONTH.Series.Add("AVG_PRICE").ChartType = UI.DataVisualization.Charting.SeriesChartType.Pie
                    AVG_PRICE_MONTH.Series("AVG_PRICE").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32
                    AVG_PRICE_MONTH.Series("AVG_PRICE").LabelForeColor = Drawing.Color.Blue
                    AVG_PRICE_MONTH.ChartAreas("ChartArea1").AxisY.Title = "Dealer Roles"
                    AVG_PRICE_MONTH.Series("AVG_PRICE").Color = Drawing.Color.Blue
                    AVG_PRICE_MONTH.Series("AVG_PRICE").BorderWidth = 2
                    AVG_PRICE_MONTH.Series("AVG_PRICE").MarkerSize = 6
                    AVG_PRICE_MONTH.Series("AVG_PRICE").MarkerStyle = UI.DataVisualization.Charting.MarkerStyle.Circle
                    '  AVG_PRICE_MONTH.BorderlineWidth = 10
                    AVG_PRICE_MONTH.Series("AVG_PRICE").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32
                    'AVG_PRICE_MONTH.Series("AVG_PRICE").SmartLabelStyle.Enabled = False
                    'AVG_PRICE_MONTH.Series("AVG_PRICE").LabelAngle = 45
                    ' If WD.SelectedValue = "Word" or WD.SelectedValue = "WordX" Then
                    AVG_PRICE_MONTH.Width = 500
                    AVG_PRICE_MONTH.Height = 500
                    '  End If

                    If HoldTable.Rows.Count > 0 Then
                        ' this_section_string = " ['Year', 'Dealer Sales Per Year']"
                        For Each r As DataRow In HoldTable.Rows
                            'this_section_string &= ", ['" & r("TYEAR") & "', " & r("numtrans") & "]"
                            AVG_PRICE_MONTH.Series("AVG_PRICE").Points.AddXY(r("RELTYPE"), r("numtrans"))

                            If CDbl(r("numtrans").ToString) > high_number Then
                                high_number = CDbl(r("numtrans").ToString)
                            End If
                            If CDbl(r("numtrans").ToString) < low_number Then
                                low_number = CDbl(r("numtrans").ToString)
                            End If
                        Next


                        commonEvo.set_ranges_for_vsCharts(low_number, high_number, interval_point, starting_point, ending_point)

                        AVG_PRICE_MONTH.ChartAreas("ChartArea1").AxisY.Maximum = ending_point
                        AVG_PRICE_MONTH.ChartAreas("ChartArea1").AxisY.Minimum = IIf(starting_point > 0, starting_point, 0)
                        AVG_PRICE_MONTH.ChartAreas("ChartArea1").AxisY.Interval = interval_point
                    End If
                End If
                HoldTable.Rows.Clear()
                AVG_PRICE_MONTH.Titles.Clear()
                AVG_PRICE_MONTH.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                AVG_PRICE_MONTH.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + CompanyID.ToString + "_DEAL_GRAPH2.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
                string_to_add &= "<table width='80%' align='center'>"
                string_to_add &= "<tr class='" & Session("ROW_CLASS_BOTTOM") & "'><td colspan='2' align='center'><font class='" & Session("FONT_CLASS_HEADER") & "'>Dealer Roles Since " & (Year(Now()) - 1) & "</font></td></tr>"
                string_to_add &= "<tr><td align='center'><img src='" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + CompanyID.ToString + "_DEAL_GRAPH2.jpg'><br></td></tr>"
                string_to_add &= "</table>"
                string_to_add &= this_section_string
            End If


            If dealer_sales_by_model.Checked = True Then
                If made_first_page_op = True Then
                    string_to_add &= string_header
                End If
                HoldTable = acdealer_view_function.ac_dealer_sales_by_model(CompanyID, "", 0, searchCriteria, util_functions.rollup_text)
                this_section_string = ""
                If Not IsNothing(HoldTable) Then

                    ' this_section_string += "<table width=""100%"" cellpadding=""3"" cellspacing=""0"" class=""data_aircraft_grid"">"

                    this_section_string += "<tr class='" & HttpContext.Current.Session.Item("ROW_CLASS_BOTTOM") & "'><td colspan='12'><font class='" & HttpContext.Current.Session.Item("FONT_CLASS_HEADER") & "'>DEALER SALES BY MODEL SINCE " & (Year(Now()) - 1) & "</font></td></tr>"
                    this_section_string += "<tr class=""header_row"">"
                    this_section_string += "<td align=""left"" valign=""top"" nowrap='nowrap' width='250'><strong><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>MAKE/MODEL</font></strong></td>"
                    this_section_string += "<td align=""right"" valign=""top"" width='100'><strong><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>TOTAL</font></strong></td>"
                    this_section_string += "</tr>"

                    If HoldTable.Rows.Count > 0 Then
                        For Each r As DataRow In HoldTable.Rows

                            If Not toggleRowColor Then
                                toggleRowColor = True
                                bgcolor = ""
                            Else
                                toggleRowColor = False
                                bgcolor = "#f0f0f0"
                            End If
                            this_section_string += "<tr  bgcolor='" & bgcolor & "'>"

                            this_section_string += "<td align='left'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                            this_section_string += Trim(r("amod_make_name")) & " " & r("amod_model_name")
                            this_section_string += "</font></td>"
                            If Not IsDBNull(r("TCOUNT")) Then
                                this_section_string += "<td align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & r("TCOUNT") & "</font></td>"
                                TotalCount += r("TCOUNT")
                            Else
                                this_section_string += "<td align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>0</font></td>"
                            End If
                            this_section_string += "</tr>"

                        Next

                        If Not toggleRowColor Then
                            toggleRowColor = True
                            bgcolor = ""
                        Else
                            toggleRowColor = False
                            bgcolor = "#f0f0f0"
                        End If
                        this_section_string += "<tr  bgcolor='" & bgcolor & "'>"
                        this_section_string += "<td align=""left"" valign=""top""><strong><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>TOTAL</font></strong></td><td align=""right"" valign=""top""><strong><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>" & TotalCount.ToString & "</font></strong></td></tr>"
                        'this_section_string += "</table>"
                        string_to_add &= this_section_string
                    End If
                End If
            End If

            '  DisplayFunctions.load_google_chart(viewTabPanel, google_map_string, "", "", "chart_div_top_all", 480, 230, "ARRAY", 1, charting_string, Page, bottom_tab_update_panel, False, True, True, False, False, True, False)
            '  DisplayFunctions.load_google_chart(relationships_tab, this_section_string, "Dealer Sales Per Year", "", "chart_div_tab1_all", 465, 285, "ARRAY", 1, String_to_return, Page, relationships_udpate_panel, False, True, True, False, False, False, False, False, False, False, 0, "bottom")

            ' BuildRestOfDealerCharts(CompanyID, searchCriteria, String_to_return, util_functions.rollup_text)

            ' Call load_google_chart_all(relationships_tab, String_to_return)

        Catch ex As Exception

        End Try

    End Sub
    Public Sub models_operated(ByVal holdtable As DataTable, ByRef string_return As String, ByVal main_comp_id As Long, ByVal amod_id As Long, ByVal localCriteria As viewSelectionCriteriaClass)
        Dim htmlOut_Make As New StringBuilder
        Dim toggleRowColor As Boolean = False
        Dim bgcolor As String = ""

        'htmlOut_Make.Append("<table id='modelForsaleViewOuterTable3' width=""100%"" cellpadding=""0"" cellspacing=""0""   class='data_aircraft_grid'>")
        htmlOut_Make.Append("<tr class='header_row'>")

        If Not IsNothing(holdtable) Then
            If holdtable.Rows.Count > 0 Then

                htmlOut_Make.Append("<th align='left' width='323'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>MODELS REPRESENTED</font>")
                htmlOut_Make.Append("</th>")
                If main_comp_id > 0 And amod_id > 0 Then
                    'htmlOut_Make.Append("<th class=""text_align_center"" nowrap='nowrap'>&nbsp;</th>")
                Else
                    htmlOut_Make.Append("<th align='right' nowrap='nowrap'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>#AC</font></th>")
                End If

                htmlOut_Make.Append("</tr>")
                ' htmlOut_Make.Append("</thead>")

                ' ac_rank = 0
                For Each r As DataRow In holdtable.Rows

                    If Not toggleRowColor Then
                        toggleRowColor = True
                        bgcolor = ""
                    Else
                        toggleRowColor = False
                        bgcolor = "#f0f0f0"
                    End If
                    htmlOut_Make.Append("<tr class='header_row' bgcolor='" & bgcolor & "'>")


                    htmlOut_Make.Append("<td class=""text_align_left"" nowrap='nowrap' width='323'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>")

                    '  If amod_id = 0 Then
                    '    htmlOut_Make.Append(temp_link & "&amod_id=" & Trim(r("amod_id")) & "&main_comp_id=" & main_comp_id & "&country_name=" & country_name & "&type_drop=" & localCriteria.ViewCriteriaAircraftType & "'>")
                    '  End If


                    'ac_id, ac_ser_no_full, amod_make_name, amod_model_name, amod_id
                    If main_comp_id > 0 And amod_id > 0 Then

                        If Not IsDBNull(r("amod_make_name")) And Not IsDBNull(r("amod_model_name")) Then
                            htmlOut_Make.Append(Trim(r("amod_make_name")) & " " & Trim(r("amod_model_name")) & "")
                        Else
                            htmlOut_Make.Append("&nbsp;")
                        End If

                        If Not IsDBNull(r("ac_ser_no_full")) Then
                            htmlOut_Make.Append(" Ser No: ")
                            htmlOut_Make.Append(DisplayFunctions.WriteDetailsLink(r("ac_id"), 0, 0, 0, True, Trim(r("ac_ser_no_full")), "date_text", ""))
                        End If

                        If amod_id = 0 Then
                            htmlOut_Make.Append("</a>")
                        End If

                        htmlOut_Make.Append("<font></td>")

                        ' htmlOut_Make.Append("<td class=""text_align_right"" nowrap='nowrap'>&nbsp;</td>")

                    Else

                        ' ac_rank = ac_rank + 1
                        ' htmlOut_Make.Append("<td class=""text_align_right"" nowrap='nowrap'>" & ac_rank & "</td>") 

                        ' htmlOut_Make.Append("<a href='DisplayCompanyDetail.aspx?compid=" & main_comp_id & "&amod_id=" & r("amod_id") & "&use_insight_dealer=Y&use_insight_roll=" & Trim(Request("use_insight_roll")) & "'>")

                        If Not IsDBNull(r("amod_make_name")) And Not IsDBNull(r("amod_model_name")) Then
                            htmlOut_Make.Append(Trim(r("amod_make_name")) & " " & Trim(r("amod_model_name")) & "")
                        Else
                            htmlOut_Make.Append("&nbsp;")
                        End If

                        ' If amod_id = 0 Then
                        htmlOut_Make.Append("</a>")
                        'End If

                        htmlOut_Make.Append("</font></td>")

                        If Not IsDBNull(r("num_ac")) Then
                            htmlOut_Make.Append("<td align='right' nowrap='nowrap'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & r("num_ac") & "</font></td>")
                        Else
                            htmlOut_Make.Append("<td align='right' nowrap='nowrap'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>0</font></td>")
                        End If

                        'htmlOut.Append("<td class=""text_align_center"" nowrap='nowrap'>&nbsp;</td>") 
                    End If
                    htmlOut_Make.Append("</tr>")

                Next


                ' htmlOut_Make.Append("</table>")


            End If

        End If


        '  htmlOut_Make.Append("<div id=""forSaleInnerTable3"" style=""width: 445px;""></div>")
        ' htmlOut_Make.Append("</td></tr>")
        htmlOut_Make.Append("</table>")

        string_return = htmlOut_Make.ToString
    End Sub
    Public Sub Fill_Manu_Tab(ByVal CompanyID As Long, ByVal JournalID As Long, ByRef string_to_add As String, ByVal spec_id As Long)

        Dim made_first_page_op As Boolean = False
        Dim string_header As String = ""
        Dim HoldTable As New DataTable
        Dim htmlOut As New StringBuilder
        Dim sHtmlManufacturerCompanies As String = ""
        Dim sHtmlManufacturerModels As String = ""
        Dim sHtmlManufacturerModelPieChart As String = ""
        Dim sHtmlManufacturerModelPic As String = ""
        Dim sHtmlManufacturerAircraftSummary As String = ""
        Dim sHtmlManufacturerAircraftBarChart As String = ""
        Dim sHtmlManufacturerAircraft As String = ""
        Dim this_section_string As String = ""
        Dim String_to_return As String = ""

        Dim high_number As Long = 0
        Dim low_number As Long = 100000
        Dim starting_point As Integer = 0
        Dim interval_point As Integer = 1
        Dim ending_point As Integer = 0



        string_header = comp_functions.NEW_Insert_Page_Break_PDF(Counter_For_PDF, reportType.SelectedValue)
        string_header &= comp_functions.NEW_build_full_spec_page_header(NEW_AC_ID, "", comp_address, comp_logo, 0, NEW_COMP_ID, bWordReport, word_width, pdf_html_width, check_prepared_for, chkBlindReport, prepared_for)


        If bWordReport = True Then
            string_header &= "<table width='" & word_width & "' align='center'>"
        Else
            string_header &= "<table width='" & pdf_html_width & "' align='center'>"
        End If


        If manu_summary.Checked = True Then
            If made_first_page_op = True Then
                string_to_add &= string_header
            End If
            ' first column left side
            this_section_string = ""
            If use_insight_roll = True Then
                manufacturer_functions.views_display_manufacturer_companies(searchCriteria, this_section_string, False, "pdf", "Y")
            Else
                manufacturer_functions.views_display_manufacturer_companies(searchCriteria, this_section_string, False, "pdf")
            End If


            string_to_add &= this_section_string
            made_first_page_op = True
        End If

        If manu_models.Checked = True Then
            If made_first_page_op = True Then
                string_to_add &= string_header
            End If
            this_section_string = ""
            If use_insight_roll = True Then
                manufacturer_functions.views_display_manufacturer_aircraft_models(searchCriteria, this_section_string, False, "pdf", "Y")
            Else
                manufacturer_functions.views_display_manufacturer_aircraft_models(searchCriteria, this_section_string, False, "pdf", "N")
            End If
            string_to_add &= this_section_string
            made_first_page_op = True

        End If



        If manu_in_operation.Checked = True Then
            If made_first_page_op = True Then
                string_to_add &= string_header
            End If

            If use_insight_roll = True Then
                HoldTable = manufacturer_functions.get_manufacturer_by_year(searchCriteria.ViewCriteriaCompanyID, searchCriteria.ViewCriteriaAmodID, "3", searchCriteria, "Y")
            Else
                HoldTable = manufacturer_functions.get_manufacturer_by_year(searchCriteria.ViewCriteriaCompanyID, searchCriteria.ViewCriteriaAmodID, "3", searchCriteria, "N")
            End If

            If Not IsNothing(HoldTable) Then
                AVG_PRICE_MONTH.Series.Clear()
                AVG_PRICE_MONTH.Series.Add("AVG_PRICE").ChartType = UI.DataVisualization.Charting.SeriesChartType.Spline
                AVG_PRICE_MONTH.Series("AVG_PRICE").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32
                AVG_PRICE_MONTH.Series("AVG_PRICE").LabelForeColor = Drawing.Color.Blue
                AVG_PRICE_MONTH.ChartAreas("ChartArea1").AxisY.Title = "Manufactured"
                AVG_PRICE_MONTH.Series("AVG_PRICE").Color = Drawing.Color.Blue
                AVG_PRICE_MONTH.Series("AVG_PRICE").BorderWidth = 2
                AVG_PRICE_MONTH.Series("AVG_PRICE").MarkerSize = 6
                AVG_PRICE_MONTH.Series("AVG_PRICE").MarkerStyle = UI.DataVisualization.Charting.MarkerStyle.Circle
                '  AVG_PRICE_MONTH.BorderlineWidth = 10
                AVG_PRICE_MONTH.Series("AVG_PRICE").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32
                'AVG_PRICE_MONTH.Series("AVG_PRICE").SmartLabelStyle.Enabled = False
                'AVG_PRICE_MONTH.Series("AVG_PRICE").LabelAngle = 45
                '  If WD.SelectedValue = "Word" Or WD.SelectedValue = "WordX" Then
                AVG_PRICE_MONTH.Width = 500
                AVG_PRICE_MONTH.Height = 500
                'End If


                If HoldTable.Rows.Count > 0 Then
                    ' this_section_string = " ['Mfr Year', '# Aircraft']"
                    For Each r As DataRow In HoldTable.Rows
                        ' this_section_string &= ", ['" & r("ac_mfr_year") & "', " & r("tcount") & "]"
                        AVG_PRICE_MONTH.Series("AVG_PRICE").Points.AddXY(r("ac_mfr_year"), r("tcount"))


                        If CDbl(r("tcount").ToString) > high_number Then
                            high_number = CDbl(r("tcount").ToString)
                        End If
                        If CDbl(r("tcount").ToString) < low_number Then
                            low_number = CDbl(r("tcount").ToString)
                        End If
                    Next
                End If


                commonEvo.set_ranges_for_vsCharts(low_number, high_number, interval_point, starting_point, ending_point)

                AVG_PRICE_MONTH.ChartAreas("ChartArea1").AxisY.Maximum = ending_point
                AVG_PRICE_MONTH.ChartAreas("ChartArea1").AxisY.Minimum = IIf(starting_point > 0, starting_point, 0)
                AVG_PRICE_MONTH.ChartAreas("ChartArea1").AxisY.Interval = interval_point
                AVG_PRICE_MONTH.ChartAreas("ChartArea1").AxisX.Interval = 5

            End If

            AVG_PRICE_MONTH.Titles.Clear()
            AVG_PRICE_MONTH.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
            AVG_PRICE_MONTH.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + CompanyID.ToString + "_MFR_GRAPH1.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
            string_to_add &= "<table width='80%' align='center'>"
            string_to_add &= "<tr class='" & Session("ROW_CLASS_BOTTOM") & "'><td colspan='2' align='center'><font class='" & Session("FONT_CLASS_HEADER") & "'>In Operation - Manufactured By Year</font></td></tr>"
            string_to_add &= "<tr><td align='center'><img src='" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + CompanyID.ToString + "_MFR_GRAPH1.jpg'><br></td></tr>"
            string_to_add &= "</table>"

            HoldTable.Rows.Clear()
            made_first_page_op = True
        End If



        If manu_in_production.Checked = True Then
            If made_first_page_op = True Then
                string_to_add &= string_header
            End If
            this_section_string = ""

            If use_insight_roll = True Then
                HoldTable = manufacturer_functions.get_manufacturer_by_year(searchCriteria.ViewCriteriaCompanyID, searchCriteria.ViewCriteriaAmodID, "1", searchCriteria, "Y")
            Else
                HoldTable = manufacturer_functions.get_manufacturer_by_year(searchCriteria.ViewCriteriaCompanyID, searchCriteria.ViewCriteriaAmodID, "1", searchCriteria, "N")
            End If





            If Not IsNothing(HoldTable) Then
                high_number = 0
                low_number = 100000
                starting_point = 0
                interval_point = 1
                ending_point = 0
                AVG_PRICE_MONTH.Series.Clear()
                AVG_PRICE_MONTH.Series.Add("AVG_PRICE").ChartType = UI.DataVisualization.Charting.SeriesChartType.Spline
                AVG_PRICE_MONTH.Series("AVG_PRICE").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32
                AVG_PRICE_MONTH.Series("AVG_PRICE").LabelForeColor = Drawing.Color.Blue
                AVG_PRICE_MONTH.ChartAreas("ChartArea1").AxisY.Title = "Manufactured"
                AVG_PRICE_MONTH.Series("AVG_PRICE").Color = Drawing.Color.Blue
                AVG_PRICE_MONTH.Series("AVG_PRICE").BorderWidth = 2
                AVG_PRICE_MONTH.Series("AVG_PRICE").MarkerSize = 6
                AVG_PRICE_MONTH.Series("AVG_PRICE").MarkerStyle = UI.DataVisualization.Charting.MarkerStyle.Circle
                '  AVG_PRICE_MONTH.BorderlineWidth = 10
                AVG_PRICE_MONTH.Series("AVG_PRICE").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32
                'AVG_PRICE_MONTH.Series("AVG_PRICE").SmartLabelStyle.Enabled = False
                'AVG_PRICE_MONTH.Series("AVG_PRICE").LabelAngle = 45
                '  If WD.SelectedValue = "Word" Or WD.SelectedValue = "WordX" Then
                AVG_PRICE_MONTH.Width = 500
                AVG_PRICE_MONTH.Height = 500
                'End If


                If HoldTable.Rows.Count > 0 Then
                    ' this_section_string = " ['Mfr Year', '# Aircraft']"
                    For Each r As DataRow In HoldTable.Rows
                        ' this_section_string &= ", ['" & r("ac_mfr_year") & "', " & r("tcount") & "]"
                        AVG_PRICE_MONTH.Series("AVG_PRICE").Points.AddXY(r("ac_mfr_year"), r("tcount"))

                        If CDbl(r("tcount").ToString) > high_number Then
                            high_number = CDbl(r("tcount").ToString)
                        End If
                        If CDbl(r("tcount").ToString) < low_number Then
                            low_number = CDbl(r("tcount").ToString)
                        End If
                    Next
                End If
                commonEvo.set_ranges_for_vsCharts(low_number, high_number, interval_point, starting_point, ending_point)

                AVG_PRICE_MONTH.ChartAreas("ChartArea1").AxisY.Maximum = ending_point
                AVG_PRICE_MONTH.ChartAreas("ChartArea1").AxisY.Minimum = IIf(starting_point > 0, starting_point, 0)
                AVG_PRICE_MONTH.ChartAreas("ChartArea1").AxisY.Interval = interval_point
                AVG_PRICE_MONTH.ChartAreas("ChartArea1").AxisX.Interval = 5


            End If

            AVG_PRICE_MONTH.Titles.Clear()
            AVG_PRICE_MONTH.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
            AVG_PRICE_MONTH.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + CompanyID.ToString + "_MFR_GRAPH2.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
            string_to_add &= "<table width='80%' align='center'>"
            string_to_add &= "<tr class='" & Session("ROW_CLASS_BOTTOM") & "'><td colspan='2' align='center'><font class='" & Session("FONT_CLASS_HEADER") & "'>In Production - Manufactured By Year</font></td></tr>"
            string_to_add &= "<tr><td align='center'><img src='" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + CompanyID.ToString + "_MFR_GRAPH2.jpg'><br></td></tr>"
            string_to_add &= "</table>"
            string_to_add &= this_section_string
            HoldTable.Rows.Clear()
            made_first_page_op = True
        End If



        ' temp_string = htmlOut.ToString

    End Sub
    Public Sub Fill_Finance_Tab(ByVal CompanyID As Long, ByVal JournalID As Long, ByRef string_to_add As String, ByVal spec_id As Long)

        Dim this_section_string As String = ""
        Dim made_first_page_op As Boolean = False
        Dim string_header As String = ""
        Dim HoldTable As New DataTable

        string_header = comp_functions.NEW_Insert_Page_Break_PDF(Counter_For_PDF, reportType.SelectedValue)
        string_header &= comp_functions.NEW_build_full_spec_page_header(NEW_AC_ID, "", comp_address, comp_logo, 0, NEW_COMP_ID, bWordReport, word_width, pdf_html_width, check_prepared_for, chkBlindReport, prepared_for)


        If bWordReport = True Then
            string_header &= "<table width='" & word_width & "' align='center'>"
        Else
            string_header &= "<table width='" & pdf_html_width & "' align='center'>"
        End If

        If fin_related.Checked = True Then
            If use_insight_roll Then
                If made_first_page_op = True Then
                    string_to_add &= string_header
                End If

                string_to_add &= Build_Related_Financing_Companies_Documents()

                made_first_page_op = True
            End If
        End If

        If fin_models.Checked = True Then
            If made_first_page_op = True Then
                string_to_add &= string_header
            End If
            string_to_add &= Build_Model_Financial_Documents(string_header)
            made_first_page_op = True
        End If

        If fin_documents_chart.Checked = True Then
            If made_first_page_op = True Then
                string_to_add &= string_header
            End If

            Call Build_Financial_Documents_By_Month()

            AVG_PRICE_MONTH.Titles.Clear()
            AVG_PRICE_MONTH.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
            AVG_PRICE_MONTH.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + CompanyID.ToString + "_FIN_GRAPH1.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
            string_to_add &= "<table width='80%' align='center'>"
            string_to_add &= "<tr class='" & Session("ROW_CLASS_BOTTOM") & "'><td colspan='2' align='center'><font class='" & Session("FONT_CLASS_HEADER") & "'>Financial Documents</font></td></tr>"
            string_to_add &= "<tr><td align='center'><img src='" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + CompanyID.ToString + "_FIN_GRAPH1.jpg'><br></td></tr>"
            string_to_add &= "</table>"

            made_first_page_op = True
        End If


        If fin_types.Checked = True Then
            If made_first_page_op = True Then
                string_to_add &= string_header
            End If
            string_to_add &= Build_Types_Financial_Documents()
            made_first_page_op = True
        End If








    End Sub

    Public Sub Fill_Lease_Tab(ByVal CompanyID As Long, ByVal JournalID As Long, ByRef string_to_add As String, ByVal spec_id As Long)

        Dim this_section_string As String = ""
        Dim made_first_page_op As Boolean = False
        Dim string_header As String = ""
        Dim HoldTable As New DataTable
        Dim high_number As Long = 0
        Dim low_number As Long = 100000
        Dim starting_point As Integer = 0
        Dim interval_point As Integer = 1
        Dim ending_point As Integer = 0

        If searchCriteria.ViewCriteriaTimeSpan < 1 Then
            searchCriteria.ViewCriteriaTimeSpan = 6
        End If

        string_header = comp_functions.NEW_Insert_Page_Break_PDF(Counter_For_PDF, reportType.SelectedValue)
        string_header &= comp_functions.NEW_build_full_spec_page_header(NEW_AC_ID, "", comp_address, comp_logo, 0, NEW_COMP_ID, bWordReport, word_width, pdf_html_width, check_prepared_for, chkBlindReport, prepared_for)


        If bWordReport = True Then
            string_header &= "<table width='" & word_width & "' align='center'>"
        Else
            string_header &= "<table width='" & pdf_html_width & "' align='center'>"
        End If


        If lease_locations.Checked = True Then
            If use_insight_roll = True Then
                If made_first_page_op = True Then
                    string_to_add &= string_header
                End If
                this_section_string = ""
                lease_functions.views_display_top_lessors(searchCriteria, this_section_string, "pdf", "Y")
                string_to_add &= this_section_string
                made_first_page_op = True
            End If
        End If

        If lease_models.Checked = True Then
            this_section_string = ""
            If made_first_page_op = True Then
                string_to_add &= string_header
            End If
            If use_insight_roll = True Then
                lease_functions.views_display_models_leased_list(searchCriteria, this_section_string, "pdf", "Y")
            Else
                lease_functions.views_display_models_leased_list(searchCriteria, this_section_string, "pdf", "N")
            End If

            string_to_add &= this_section_string
            made_first_page_op = True
        End If

        If lease_per_month_chart.Checked = True Then
            If made_first_page_op = True Then
                string_to_add &= string_header
            End If
            If use_insight_roll = True Then
                HoldTable = lease_functions.get_leases_by_month(searchCriteria, "Y")
            Else
                HoldTable = lease_functions.get_leases_by_month(searchCriteria, "N")
            End If


            If Not IsNothing(HoldTable) Then

                AVG_PRICE_MONTH.Series.Clear()
                AVG_PRICE_MONTH.Series.Add("AVG_PRICE").ChartType = UI.DataVisualization.Charting.SeriesChartType.Spline
                AVG_PRICE_MONTH.Series("AVG_PRICE").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32
                AVG_PRICE_MONTH.Series("AVG_PRICE").LabelForeColor = Drawing.Color.Blue
                AVG_PRICE_MONTH.ChartAreas("ChartArea1").AxisY.Title = "Leases Per Month"
                AVG_PRICE_MONTH.Series("AVG_PRICE").Color = Drawing.Color.Blue
                AVG_PRICE_MONTH.Series("AVG_PRICE").BorderWidth = 2
                AVG_PRICE_MONTH.Series("AVG_PRICE").MarkerSize = 6
                AVG_PRICE_MONTH.Series("AVG_PRICE").MarkerStyle = UI.DataVisualization.Charting.MarkerStyle.Circle
                '  AVG_PRICE_MONTH.BorderlineWidth = 10
                AVG_PRICE_MONTH.Series("AVG_PRICE").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32
                'AVG_PRICE_MONTH.Series("AVG_PRICE").SmartLabelStyle.Enabled = False
                'AVG_PRICE_MONTH.Series("AVG_PRICE").LabelAngle = 45
                ' If WD.SelectedValue = "Word" or WD.SelectedValue = "WordX" Then
                AVG_PRICE_MONTH.Width = 500
                AVG_PRICE_MONTH.Height = 500
                '  End If

                If HoldTable.Rows.Count > 0 Then
                    this_section_string = " ['Lease Month/Year', '# Aircraft']"
                    For Each r As DataRow In HoldTable.Rows
                        AVG_PRICE_MONTH.Series("AVG_PRICE").Points.AddXY((r("tmonth") & "-" & r("tyear")), r("tCount"))
                        If CDbl(r("tcount").ToString) > high_number Then
                            high_number = CDbl(r("tcount").ToString)
                        End If
                        If CDbl(r("tcount").ToString) < low_number Then
                            low_number = CDbl(r("tcount").ToString)
                        End If
                    Next

                    commonEvo.set_ranges_for_vsCharts(low_number, high_number, interval_point, starting_point, ending_point)

                    AVG_PRICE_MONTH.ChartAreas("ChartArea1").AxisY.Maximum = ending_point
                    AVG_PRICE_MONTH.ChartAreas("ChartArea1").AxisY.Minimum = IIf(starting_point > 0, starting_point, 0)
                    AVG_PRICE_MONTH.ChartAreas("ChartArea1").AxisY.Interval = interval_point

                End If
            End If


            AVG_PRICE_MONTH.Titles.Clear()
            AVG_PRICE_MONTH.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
            AVG_PRICE_MONTH.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + CompanyID.ToString + "_LEASE_GRAPH1.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
            string_to_add &= "<table width='80%' align='center'>"
            string_to_add &= "<tr class='" & Session("ROW_CLASS_BOTTOM") & "'><td colspan='2' align='center'><font class='" & Session("FONT_CLASS_HEADER") & "'>Leases Per Month</font></td></tr>"
            string_to_add &= "<tr><td align='center'><img src='" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + CompanyID.ToString + "_LEASE_GRAPH1.jpg'><br></td></tr>"
            string_to_add &= "</table>"
            HoldTable.Rows.Clear()
            made_first_page_op = True
        End If


        If lease_summary.Checked = True Then
            If made_first_page_op = True Then
                string_to_add &= string_header
            End If
            string_to_add &= BuildLeaseSummaryTab(searchCriteria, string_header)
        End If



    End Sub
    Private Function BuildLeaseSummaryTab(ByRef searchCriteria As viewSelectionCriteriaClass, ByVal page_break_text As String)
        BuildLeaseSummaryTab = ""
        Dim LeaseTable As New DataTable
        Dim DisplayText As String = ""
        Dim totalCount As Long = 0
        Dim Css As String = ""
        Dim bgcolor As String = ""
        Dim font_text_title As String = ""
        Dim font_text_start As String = ""
        Dim font_text_end As String = ""
        Dim temp_dir As String = "right"
        Dim toggleRowColor As Boolean = False
        Dim row_count As Integer = 0
        Dim DisplayText_header As String = ""


        Try


            font_text_start = "<font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
            font_text_title = "<font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>"
            font_text_end = "</font>"
            temp_dir = "left"




            LeaseTable = lease_functions.LeaseSummary(searchCriteria)

            If Not IsNothing(LeaseTable) Then
                If LeaseTable.Rows.Count > 0 Then
                    ' DisplayText = "<table width=""100%"" cellpadding=""3"" cellspacing=""0"" class=""data_aircraft_grid"">"
                    DisplayText_header += "<tr class='" & Session("ROW_CLASS_BOTTOM") & "'><td colspan='2'><font class='" & Session("FONT_CLASS_HEADER") & "'>Summary of Leases</font></td></tr>"
                    DisplayText_header += "<tr class=""header_row"">"
                    DisplayText_header += "<td align=""left"" valign=""top""><b>" & font_text_title & "Company" & font_text_end & "</b></td>"
                    DisplayText_header += "<td align=""right"" valign=""top""><b>" & font_text_title & "#" & font_text_end & "</b></td>"
                    DisplayText_header += "</tr>"
                    DisplayText += DisplayText_header

                    For Each r As DataRow In LeaseTable.Rows


                        If row_count > 50 Then
                            DisplayText += "</table>"
                            DisplayText += page_break_text
                            DisplayText += DisplayText_header
                            row_count = 0
                        End If
                        row_count = row_count + 1

                        If Not toggleRowColor Then
                            toggleRowColor = True
                            bgcolor = ""
                        Else
                            toggleRowColor = False
                            bgcolor = "#f0f0f0"
                        End If
                        DisplayText += "<tr  bgcolor='" & bgcolor & "'>"

                        DisplayText += "<td align=""left"" valign=""top"">" & font_text_start & ""

                        DisplayText += WriteCompAdd(r)
                        DisplayText += "" & font_text_end & "</td>"
                        DisplayText += "<td align=""right"" valign=""top"">" & font_text_start & "" & r("tcount").ToString & "" & font_text_end & "</td>"
                        If IsNumeric(r("tcount")) Then
                            totalCount += r("tcount")
                        End If

                        DisplayText += "</tr>"
                        If Css <> "" Then
                            Css = ""
                        Else
                            Css = "alt_row"
                        End If
                    Next
                    DisplayText += "<tr class=""" & Css & """><td align=""left"" valign=""top""><strong>" & font_text_title & "Total" & font_text_end & "</strong></td><td align=""right"" valign=""top""><strong>" & font_text_title & "" & totalCount.ToString & "" & font_text_end & "</strong></td></tr>"
                    DisplayText += "</table>"
                    BuildLeaseSummaryTab = DisplayText
                End If
            End If

        Catch ex As Exception

        End Try
    End Function
    Public Function WriteCompAdd(ByVal r As DataRow) As String
        Dim City As String = ""
        Dim State As String = ""
        Dim Country As String = ""
        Dim DisplayText As String = ""
        If Not IsDBNull(r("comp_name")) Then
            '  DisplayText += DisplayFunctions.WriteDetailsLink(0, r("comp_id"), 0, 0, True, r("comp_name"), "", "")
            DisplayText &= r("comp_name")
            'DisplayText += "<br />"
            DisplayText += " - "
        End If
        If Not IsDBNull(r("comp_city")) Then
            City = r("comp_city")
        End If
        If Not IsDBNull(r("comp_state")) Then
            If City <> "" Then
                City += ", "
            End If
            State += r("comp_state")
        End If
        If Not IsDBNull(r("comp_country")) Then
            If City = "" Then
                If State <> "" Then
                    State += ", "
                End If
            Else
                Country = " "
            End If
            Country += r("comp_country")
        End If
        DisplayText += City & State & Country
        Return DisplayText
    End Function
    Public Sub Fill_Locations_Tab(ByVal CompanyID As Long, ByVal JournalID As Long, ByRef string_to_add As String, ByVal spec_id As Long)
        Dim bgcolor As String = ""

        ' in case we need counts
        'Call util_functions.get_company_profile_top_function(searchCriteria, "company", count_current_ownser, count_past_owner, count_operator, count_manu, count_dealer, count_locations, "Y")

        Call util_functions.util_get_operators_rollup_top_function(searchCriteria, string_to_add, 0, "", 0, "pdf")

        ' Response.Write(wanteds_label.Text)
    End Sub
    Public Sub Fill_Wanteds_Tab(ByVal CompanyID As Long, ByVal JournalID As Long, ByRef string_to_add As String, ByVal spec_id As Long)
        Dim bgcolor As String = ""
        Dim WantedTable As New DataTable

        WantedTable = Master.aclsData_Temp.Return_Wanted(CompanyID, "JETNET", 0, "", "", "", "", "J", JournalID)
        If Not IsNothing(WantedTable) Then
            If WantedTable.Rows.Count > 0 Then

                If spec_id = 54 Then
                    'string_to_add = "<table width='100%' cellspacing='3' cellpadding='3' class='data_aircraft_grid'>"
                    string_to_add &= "<tr class='" & Session("ROW_CLASS_BOTTOM") & "' valign='top'><td valign='top' align='center' colspan='5'><font class='" & Session("FONT_CLASS_HEADER") & "'>Wanteds</font></td></tr>"
                    string_to_add &= "<tr class='" & Session("ROW_CLASS_BOTTOM") & "' valign='top'>"
                    string_to_add &= "<td align='left' valign='top' width='70'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>DATE LISTED</font></td>"
                    string_to_add &= "<td align='left' valign='top' width='150'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>MAKE/MODEL</font></td>"
                    string_to_add &= "<td align='left' valign='top'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>NOTES</font></td>"
                    string_to_add &= "</tr>"
                Else
                    string_to_add = "<table width='100%' cellspacing='3' cellpadding='3' class='data_aircraft_grid'>"
                    string_to_add &= "<tr class='header_row'>"
                    string_to_add &= "<td align='left' valign='top' width='70'><b class='title'>DATE LISTED</b></td>"
                    string_to_add &= "<td align='left' valign='top' width='150'><b class='title'>MAKE/MODEL</b></td>"
                    string_to_add &= "<td align='left' valign='top'><b class='title'>NOTES</b></td>"
                    string_to_add &= "</tr>"
                End If




                For Each r As DataRow In WantedTable.Rows
                    'toggling css on/off
                    If bgcolor = "" Then
                        bgcolor = "alt_row"
                    Else
                        bgcolor = ""
                    End If

                    If spec_id = 54 Then
                        string_to_add &= "<tr class='" & Session("ROW_CLASS_BOTTOM") & "' valign='top'>"
                        string_to_add &= "<td align='left' valign='top'>"
                        string_to_add &= "<font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                        If Not IsDBNull(r("amwant_listed_date")) Then
                            string_to_add &= FormatDateTime(r("amwant_listed_date"), DateFormat.ShortDate)
                        End If
                        string_to_add &= "</font></td>"
                        string_to_add &= "<td align='left' valign='top'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & r("amod_make_name").ToString & " " & r("amod_model_name") & "</font></td>"
                        string_to_add &= "<td align='left' valign='top'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & r("amwant_notes").ToString & "</font></td>"
                    Else
                        string_to_add &= "<tr class='" & bgcolor & "'>"
                        string_to_add &= "<td align='left' valign='top'>"
                        If Not IsDBNull(r("amwant_listed_date")) Then
                            string_to_add &= FormatDateTime(r("amwant_listed_date"), DateFormat.ShortDate)
                        End If
                        string_to_add &= "</td>"
                        string_to_add &= "<td align='left' valign='top'>" & r("amod_make_name").ToString & " " & r("amod_model_name") & "</td>"
                        string_to_add &= "<td align='left' valign='top'>" & r("amwant_notes").ToString & "</td>"
                    End If




                    string_to_add &= "</tr>"
                Next



                string_to_add &= "</table>"

            Else
                If spec_id = 54 Then
                    ' string_to_add = "<table width='100%' cellspacing='3' cellpadding='3' class='data_aircraft_grid'>"
                    string_to_add &= "<tr class='" & Session("ROW_CLASS_BOTTOM") & "' valign='top'><td valign='top' align='center' colspan='5'><font class='" & Session("FONT_CLASS_HEADER") & "'>Wanteds</font></td></tr>"
                    string_to_add &= "<tr class='" & Session("ROW_CLASS_BOTTOM") & "' valign='top'>"
                    string_to_add &= "<td align='left' valign='top' width='70'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>No Wanteds Found</font></td>"
                    string_to_add &= "</tr>"
                    'string_to_add &= "</table>"
                End If
            End If

        Else

        End If
        ' Response.Write(wanteds_label.Text)
    End Sub


    Public Sub Fill_Business_Type_Tab(ByRef business_label As String, ByVal comp_id As Long, Optional ByVal from_spot As String = "")
        Dim BusinessType As New DataTable
        Dim DividedNumber As Integer = 0
        Dim Count As Integer = 0
        BusinessType = Master.aclsData_Temp.Return_Business_Type(comp_id, 0)



        If Not IsNothing(BusinessType) Then
            If BusinessType.Rows.Count > 0 Then

                If Trim(from_spot) = "newpdf" Then

                Else
                    business_label = "<div class=""Box"">"
                    business_label &= "<div class=""subHeader"">Business Type(s)</div><br /><table class=""formatTable blue"" cellpadding=""0"" cellspacing=""0"">"
                End If

                'If BusinessType.Rows.Count > 2 Then
                '  DividedNumber = Math.Round(BusinessType.Rows.Count / 2)
                'Else
                '  DividedNumber = 1
                'End If
                For Each z As DataRow In BusinessType.Rows

                    If Trim(from_spot) = "newpdf" Then
                        If Trim(business_label) <> "" Then
                            business_label &= ", "
                        Else
                            business_label &= "<font class='sub_text'>Business Type(s): "
                        End If
                        business_label &= "" & IIf(Not IsDBNull(z("cbus_name")), " " & z("cbus_name") & "", "") & ""
                    Else
                        If Count = 2 Then
                            business_label &= "</tr>"
                            business_label &= "<tr>"
                            Count = 0
                        End If
                        business_label &= "<td>" & IIf(Not IsDBNull(z("cbus_name")), " " & z("cbus_name") & "", "") & "</td>"
                    End If




                    Count = Count + 1
                Next

                If Trim(from_spot) = "newpdf" Then
                    business_label &= "</font>"
                Else
                    business_label &= "</tr></table>"
                End If

            End If
        Else
            If Master.aclsData_Temp.class_error <> "" Then
                Master.LogError("DisplayCompanyDetail.aspx.vb - Fill_Business_Type_Tab() - " & Master.aclsData_Temp.class_error)
            End If
        End If
        BusinessType.Dispose()

        If Trim(from_spot) = "newpdf" Then
        Else
            business_label &= "</div>"
        End If

    End Sub


    Public Sub Fill_Certifications_Tab(ByRef cert_text As String, ByVal comp_id As Long)
        Dim CertifactionsTable As New DataTable
        Dim count As Integer = 0

        CertifactionsTable = Master.aclsData_Temp.Return_Certifications(comp_id, 0)
        If Not IsNothing(CertifactionsTable) Then
            If (CertifactionsTable.Rows.Count > 0) Then
                cert_text = "<br/><div class=""Box""><div class=""subHeader"">Operating Certification(s): "

                cert_text &= "<table cellpadding='1'><tr>"

                For Each q As DataRow In CertifactionsTable.Rows

                    cert_text &= "<td><img src=""/images/" & q("ccerttype_logo_image").ToString & """ alt=""" & q("ccerttype_type").ToString & """ height='90' /><br />" & q("ccerttype_type").ToString & "</td>"
                    count = count + 1
                Next

                cert_text &= "</tr></table>"
                cert_text &= "<div class=""clearfix""></div></div>"
            Else

            End If
        Else
            If Master.aclsData_Temp.class_error <> "" Then
                Master.LogError("CompanyTabs.ascx.vb -Fill_Certifications() - " & Master.aclsData_Temp.class_error)
            End If
        End If
    End Sub





#End Region

#Region "report_48_functions"

    Public Function create_report_48_unique_company_contact_email(ByRef record_count As Long) As String

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand

        Dim report_48_datatable As New DataTable
        Dim adoRS_48 As System.Data.SqlClient.SqlDataReader : adoRS_48 = Nothing

        Dim report_48_ref_datatable As New DataTable
        Dim adoRS_48_ref As System.Data.SqlClient.SqlDataReader : adoRS_48_ref = Nothing


        Dim htmlOut = New StringBuilder()
        Dim sQuery As New StringBuilder()

        Dim nEmailCounter As Long = 0
        Dim email_addresses() As String = Nothing

        Dim strContactTitleGroup As String = ""
        Dim strBusinessType As String = ""

        Try

            SqlConn.ConnectionString = localFunctions.clientConnectStr
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 90

            sQuery.Append(HttpContext.Current.Session.Item("MasterCompany").ToString)

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />Create_Report_48_Unique_Company_Contact_Email() As String<br />" + sQuery.ToString

            SqlCommand.CommandText = sQuery.ToString
            adoRS_48 = SqlCommand.ExecuteReader()

            Try
                report_48_datatable.Load(adoRS_48)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = report_48_datatable.GetErrors()
            End Try

            adoRS_48.Close()
            adoRS_48 = Nothing

            record_count = report_48_datatable.Rows.Count

            If report_48_datatable.Rows.Count > 0 Then

                For Each company_row As DataRow In report_48_datatable.Rows

                    sQuery = New StringBuilder()

                    sQuery.Append("SELECT comp_email_address FROM Company WITH (NOLOCK) ")
                    sQuery.Append("WHERE (comp_id = " + company_row.Item("comp_id").ToString + ") ")
                    sQuery.Append("AND (comp_journ_id = 0) ")
                    sQuery.Append("AND (comp_email_address IS NOT NULL) ")
                    sQuery.Append("AND (comp_email_address <> '') ")

                    SqlCommand.CommandText = sQuery.ToString
                    adoRS_48_ref = SqlCommand.ExecuteReader()

                    Try
                        report_48_ref_datatable.Load(adoRS_48_ref)
                    Catch constrExc As System.Data.ConstraintException
                        Dim rowsErr As System.Data.DataRow() = report_48_ref_datatable.GetErrors()
                    End Try

                    adoRS_48_ref.Close()
                    adoRS_48_ref = Nothing

                    If report_48_ref_datatable.Rows.Count > 0 Then

                        For Each company_email_row As DataRow In report_48_ref_datatable.Rows

                            If Not IsDBNull(company_email_row.Item("comp_email_address")) Then
                                If Not String.IsNullOrEmpty(company_email_row.Item("comp_email_address").ToString.Trim) Then

                                    If Not commonEvo.inMyArray(email_addresses, company_email_row.Item("comp_email_address").ToString.Trim) Then

                                        If Not IsArray(email_addresses) And IsNothing(email_addresses) Then
                                            ReDim email_addresses(nEmailCounter)
                                        Else
                                            ReDim Preserve email_addresses(nEmailCounter)
                                        End If

                                        ' Add email address To Array
                                        email_addresses(nEmailCounter) = company_email_row.Item("comp_email_address").ToString.Trim
                                        nEmailCounter += 1

                                    End If

                                End If
                            End If

                        Next

                    End If

                    If chkIncludeContacts.Checked Then

                        report_48_ref_datatable = New DataTable

                        sQuery = New StringBuilder()

                        sQuery.Append("SELECT contact_email_address FROM Contact WITH (NOLOCK) ")
                        sQuery.Append("WHERE (contact_comp_id = " + company_row.Item("comp_id").ToString + ") ")
                        sQuery.Append("AND (contact_journ_id = 0) ")
                        sQuery.Append("AND (contact_email_address IS NOT NULL) ")
                        sQuery.Append("AND (contact_email_address <> '') ")
                        sQuery.Append("AND (contact_hide_flag = 'N') ")
                        sQuery.Append("AND (contact_active_flag = 'Y') ")

                        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />Create_Report_48_Unique_Company_Contact_Email() As String<br />" + sQuery.ToString

                        SqlCommand.CommandText = sQuery.ToString
                        adoRS_48_ref = SqlCommand.ExecuteReader()

                        Try
                            report_48_ref_datatable.Load(adoRS_48_ref)
                        Catch constrExc As System.Data.ConstraintException
                            Dim rowsErr As System.Data.DataRow() = report_48_ref_datatable.GetErrors()
                        End Try

                        adoRS_48_ref.Close()
                        adoRS_48_ref = Nothing

                        If report_48_ref_datatable.Rows.Count > 0 Then

                            For Each contact_email_row As DataRow In report_48_ref_datatable.Rows

                                If Not IsDBNull(contact_email_row.Item("contact_email_address")) Then
                                    If Not String.IsNullOrEmpty(contact_email_row.Item("contact_email_address").ToString.Trim) Then

                                        ' if contact email is not in array then add it to array
                                        If Not commonEvo.inMyArray(email_addresses, contact_email_row.Item("contact_email_address").ToString) Then

                                            If Not IsArray(email_addresses) And IsNothing(email_addresses) Then
                                                ReDim email_addresses(nEmailCounter)
                                            Else
                                                ReDim Preserve email_addresses(nEmailCounter)
                                            End If

                                            ' Add email address To Array
                                            email_addresses(nEmailCounter) = contact_email_row.Item("contact_email_address").ToString.Trim
                                            nEmailCounter += 1

                                        End If

                                    End If
                                End If

                            Next ' contact_email_row

                        End If

                    End If ' if include contacts

                Next ' company_row

            End If

            If bHtmlReport Then
                htmlOut.Append("<!DOCTYPE html>")
                htmlOut.Append("<html lang='en'>")
                htmlOut.Append("<head>")
                htmlOut.Append("<meta http-equiv='Content-Language' content='en-us' />")
                htmlOut.Append("<meta http-equiv='Content-Type' content='text/html; charset=windows-1252' />")
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='common/jetnet.css' />")
                htmlOut.Append("<title>JETNET - Unique Company/Contact Email</title>")
                htmlOut.Append("</head>")
                htmlOut.Append("<body style='background: white; margin-top:10px; margin-left:10px;'>")
                htmlOut.Append("<div style='text-align:center;'>")
            End If

            If bExcelReport Then
                htmlOut.Append("<table border='1' cellpadding='2' cellspacing='0'>")
            ElseIf bHtmlReport Then
                htmlOut.Append("<table class='centerTable' border='0' cellpadding='2' cellspacing='0' width='100%'>")
            End If

            If bHtmlReport Or bExcelReport Then
                htmlOut.Append("<tr bgcolor='#CCCCCC'><td><b>EMAILADDRESS</b></td></tr>")

                For Each email As String In email_addresses
                    If Not String.IsNullOrEmpty(email.Trim) Then
                        htmlOut.Append("<tr><td>" + email.Trim + "</td></tr>")
                    End If
                Next

                htmlOut.Append("</table>")

            ElseIf bTextCommaReport Then

                For Each email As String In email_addresses
                    If Not String.IsNullOrEmpty(email.Trim) Then
                        htmlOut.Append(Constants.QUOTE + email.Trim + Constants.QUOTE + vbCrLf)
                    End If
                Next

            ElseIf bTextTabReport Then

                For Each email As String In email_addresses
                    If Not String.IsNullOrEmpty(email.Trim) Then
                        htmlOut.Append(email.Trim + vbCrLf)
                    End If
                Next

            End If

            If bHtmlReport Then
                htmlOut.Append("</div>")
                htmlOut.Append("</body>")
                htmlOut.Append("</html>")
            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Create_Report_48_Unique_Company_Contact_Email() As String" + ex.Message
        Finally

            adoRS_48 = Nothing

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOut.ToString

        sQuery = Nothing

    End Function

#End Region

#Region "report_49_functions"

    Public Function create_report_49_yacht_seller_purchaser_history(ByRef record_count As Long) As String

        Dim ytInfo1 As String = ""

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand

        Dim report_49_datatable As New DataTable
        Dim adoRS_49 As System.Data.SqlClient.SqlDataReader : adoRS_49 = Nothing

        Dim sQuery As New StringBuilder()
        Dim htmlOut = New StringBuilder()

        Dim nRememberJournID As Long = 0

        Try

            SqlConn.ConnectionString = localFunctions.clientConnectStr

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 90

            sQuery.Append("SELECT * FROM Journal WITH(NOLOCK) INNER JOIN Journal_Category WITH(NOLOCK) ON journ_subcategory_code = jcat_subcategory_code")
            sQuery.Append(" INNER JOIN yacht WITH(NOLOCK) ON journ_yacht_id = yt_id and journ_id = yt_journ_id")
            sQuery.Append(" LEFT OUTER JOIN Yacht_Model WITH(NOLOCK) ON (yt_model_id = ym_model_id)")

            sQuery.Append(" " + HttpContext.Current.Session.Item("MasterYachtWhere").ToString.Trim)

            sQuery.Append(Constants.cAndClause + "jcat_category_code = 'YH' AND RIGHT(journ_subcategory_code, 4) <> 'CORR' ")
            sQuery.Append(" ORDER BY ym_brand_name, ym_motor_type, ym_category_size, ym_model_name, yt_hull_mfr_nbr, journ_date DESC, journ_id DESC")

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />Create_Report_49_Yacht_Seller_Purchaser_History()<br />" + sQuery.ToString

            If bHtmlReport Then
                htmlOut.Append("<!DOCTYPE html>")
                htmlOut.Append("<html lang='en'>")
                htmlOut.Append("<head>")
                htmlOut.Append("<meta http-equiv='Content-Language' content='en-us' />")
                htmlOut.Append("<meta http-equiv='Content-Type' content='text/html; charset=windows-1252' />")
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='common/jetnet.css' />")
                htmlOut.Append("<title>JETNET - Yacht Seller/Purchaser Report</title>")
                htmlOut.Append("</head>")
                htmlOut.Append("<body style='background: white; margin-top:10px; margin-left:10px;'>")
                htmlOut.Append("<div style='text-align:center;'>")
            End If

            If bExcelReport Then
                htmlOut.Append(localFunctions.include_excel_report_style() + vbCrLf)
                htmlOut.Append("<table border='1' cellpadding='2' cellspacing='0'>")
            ElseIf bHtmlReport Then
                htmlOut.Append("<table class='centerTable' border='0' cellpadding='2' cellspacing='0' width='100%'>")
            End If

            SqlCommand.CommandText = sQuery.ToString
            adoRS_49 = SqlCommand.ExecuteReader()

            Try
                report_49_datatable.Load(adoRS_49)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = report_49_datatable.GetErrors()
            End Try

            adoRS_49.Close()

            record_count = report_49_datatable.Rows.Count

            If report_49_datatable.Rows.Count > 0 Then

                If chkShowReportHeader.Checked Then

                    If bExcelReport Or bHtmlReport Then

                        htmlOut.Append("<tr bgcolor='#CCCCCC'>")

                        htmlOut.Append("<td>BRAND</td>")
                        htmlOut.Append("<td>MODEL</td>")
                        htmlOut.Append("<td>NAME</td>")
                        htmlOut.Append("<td>HULLNBR</td>")

                        htmlOut.Append("<td>SELLERCOMPANY</td>")
                        htmlOut.Append("<td>SELLERCOMPALTNAME</td>")
                        htmlOut.Append("<td>SELLERCOMPEMAIL</td>")
                        htmlOut.Append("<td>SELLERCOMPWEBADDRESS</td>")
                        htmlOut.Append("<td>SELLERCOMPADDRESS1</td>")
                        htmlOut.Append("<td>SELLERCOMPADDRESS2</td>")
                        htmlOut.Append("<td>SELLERCOMPCITY</td>")
                        htmlOut.Append("<td>SELLERCOMPSTATE</td>")
                        htmlOut.Append("<td>SELLERCOMPSTATEABBR</td>")
                        htmlOut.Append("<td>SELLERCOMPPOSTALCODE</td>")
                        htmlOut.Append("<td>SELLERCOMPCOUNTRY</td>")
                        htmlOut.Append("<td>SELLERCOMPOFFICE</td>")
                        htmlOut.Append("<td>SELLERCOMPFAX</td>")
                        htmlOut.Append("<td>SELLERCOMPMOBILE</td>")
                        htmlOut.Append("<td>SELLERCONTACTPREFIX</td>")
                        htmlOut.Append("<td>SELLERCONTACTFIRSTNAME</td>")
                        htmlOut.Append("<td>SELLERCONTACTMI</td>")
                        htmlOut.Append("<td>SELLERCONTACTLASTNAME</td>")
                        htmlOut.Append("<td>SELLERCONTACTSUFFIX</td>")
                        htmlOut.Append("<td>SELLERCONTACTTITLE</td>")
                        htmlOut.Append("<td>SELLERCONTACTEMAIL</td>")
                        htmlOut.Append("<td>SELLERCONTACTOFFICE</td>")
                        htmlOut.Append("<td>SELLERCONTACTFAX</td>")
                        htmlOut.Append("<td>SELLERCONTACTMOBILE</td>")

                        htmlOut.Append("<td>PURCHASERCOMPANY</td>")
                        htmlOut.Append("<td>PURCHASERCOMPALTNAME</td>")
                        htmlOut.Append("<td>PURCHASERCOMPEMAIL</td>")
                        htmlOut.Append("<td>PURCHASERCOMPWEBADDRESS</td>")
                        htmlOut.Append("<td>PURCHASERCOMPADDRESS1</td>")
                        htmlOut.Append("<td>PURCHASERCOMPADDRESS2</td>")
                        htmlOut.Append("<td>PURCHASERCOMPCITY</td>")
                        htmlOut.Append("<td>PURCHASERCOMPSTATE</td>")
                        htmlOut.Append("<td>PURCHASERCOMPSTATEABBR</td>")
                        htmlOut.Append("<td>PURCHASERCOMPPOSTALCODE</td>")
                        htmlOut.Append("<td>PURCHASERCOMPCOUNTRY</td>")
                        htmlOut.Append("<td>PURCHASERCOMPOFFICE</td>")
                        htmlOut.Append("<td>PURCHASERCOMPFAX</td>")
                        htmlOut.Append("<td>PURCHASERCOMPMOBILE</td>")
                        htmlOut.Append("<td>PURCHASERCONTACTPREFIX</td>")
                        htmlOut.Append("<td>PURCHASERCONTACTFIRSTNAME</td>")
                        htmlOut.Append("<td>PURCHASERCONTACTMI</td>")
                        htmlOut.Append("<td>PURCHASERCONTACTLASTNAME</td>")
                        htmlOut.Append("<td>PURCHASERCONTACTSUFFIX</td>")
                        htmlOut.Append("<td>PURCHASERCONTACTTITLE</td>")
                        htmlOut.Append("<td>PURCHASERCONTACTEMAIL</td>")
                        htmlOut.Append("<td>PURCHASERCONTACTOFFICE</td>")
                        htmlOut.Append("<td>PURCHASERCONTACTFAX</td>")
                        htmlOut.Append("<td>PURCHASERCONTACTMOBILE</td>")

                        htmlOut.Append("<td>YEARMFG</td>")
                        htmlOut.Append("<td>TYPE</td>")
                        htmlOut.Append("<td>SIZE</td>")
                        htmlOut.Append("<td>HULLTYPE</td>")
                        htmlOut.Append("<td>LENGTH</td>")
                        htmlOut.Append("<td>DISPLACEMENT</td>")
                        htmlOut.Append("<td>MANUFACTURER</td>")
                        htmlOut.Append("<td>FLAG</td>")
                        htmlOut.Append("<td>OWNERSHIP</td>")

                        htmlOut.Append("<td>TRANSACTIONDATE</td>")
                        htmlOut.Append("<td>TRANSACTIONDESCRIPTION</td>")
                        htmlOut.Append("<td>TRANSACTIONCODE</td>")
                        htmlOut.Append("<td>SCHEDULEDLEASEEXPIRATION</td>")
                        htmlOut.Append("<td>DATELEASEEXPIRED</td>")

                        htmlOut.Append("<td>ASKING</td>")
                        htmlOut.Append("<td>ASKINGAMT</td>")
                        htmlOut.Append("<td>DATELISTED</td>")

                        htmlOut.Append("<td>INFAVOROF</td>")
                        htmlOut.Append("<td>DOCDATE</td>")
                        htmlOut.Append("<td>DOCTYPE</td>")
                        htmlOut.Append("<td>DOCAMOUNT</td>")

                        htmlOut.Append("<td>TRANSACTIONNOTE</td>")

                        htmlOut.Append("</tr>" + vbCrLf)

                    ElseIf bTextCommaReport Then

                        htmlOut.Append(Constants.QUOTE + "BRAND" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "MODEL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "NAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "HULLNBR" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPANY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPALTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPEMAIL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPWEBADDRESS" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPADDRESS1" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPADDRESS2" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPCITY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPSTATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPSTATEABBR" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPPOSTALCODE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPCOUNTRY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPOFFICE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPFAX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPMOBILE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCONTACTPREFIX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCONTACTFIRSTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCONTACTMI" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCONTACTLASTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCONTACTSUFFIX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCONTACTTITLE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCONTACTEMAIL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCONTACTOFFICE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCONTACTFAX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCONTACTMOBILE" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPANY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPALTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPEMAIL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPWEBADDRESS" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPADDRESS1" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPADDRESS2" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPCITY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPSTATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPSTATEABBR" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPPOSTALCODE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPCOUNTRY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPOFFICE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPFAX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPMOBILE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCONTACTPREFIX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCONTACTFIRSTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCONTACTMI" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCONTACTLASTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCONTACTSUFFIX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCONTACTTITLE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCONTACTEMAIL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCONTACTOFFICE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCONTACTFAX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCONTACTMOBILE" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "YEARMFG" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "TYPE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SIZE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "HULLTYPE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "LENGTH" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "DISPLACEMENT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "MANUFACTURER" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "FLAG" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "OWNERSHIP" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "TRANSACTIONDATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "TRANSACTIONDESCRIPTION" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "TRANSACTIONCODE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SCHEDULEDLEASEEXPIRATION" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "DATELEASEEXPIRED" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "ASKING" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "ASKINGAMT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "DATELISTED" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "INFAVOROF" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "DOCDATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "DOCTYPE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "DOCAMOUNT" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "TRANSACTIONNOTE" + Constants.QUOTE)

                        htmlOut.Append(vbCrLf)

                    ElseIf bTextTabReport Then

                        htmlOut.Append("BRAND" + vbTab)
                        htmlOut.Append("MODEL" + vbTab)
                        htmlOut.Append("NAME" + vbTab)
                        htmlOut.Append("HULLNBR" + vbTab)

                        htmlOut.Append("SELLERCOMPANY" + vbTab)
                        htmlOut.Append("SELLERCOMPALTNAME" + vbTab)
                        htmlOut.Append("SELLERCOMPEMAIL" + vbTab)
                        htmlOut.Append("SELLERCOMPWEBADDRESS" + vbTab)
                        htmlOut.Append("SELLERCOMPADDRESS1" + vbTab)
                        htmlOut.Append("SELLERCOMPADDRESS2" + vbTab)
                        htmlOut.Append("SELLERCOMPCITY" + vbTab)
                        htmlOut.Append("SELLERCOMPSTATE" + vbTab)
                        htmlOut.Append("SELLERCOMPSTATEABBR" + vbTab)
                        htmlOut.Append("SELLERCOMPPOSTALCODE" + vbTab)
                        htmlOut.Append("SELLERCOMPCOUNTRY" + vbTab)
                        htmlOut.Append("SELLERCOMPOFFICE" + vbTab)
                        htmlOut.Append("SELLERCOMPFAX" + vbTab)
                        htmlOut.Append("SELLERCOMPMOBILE" + vbTab)
                        htmlOut.Append("SELLERCONTACTPREFIX" + vbTab)
                        htmlOut.Append("SELLERCONTACTFIRSTNAME" + vbTab)
                        htmlOut.Append("SELLERCONTACTMI" + vbTab)
                        htmlOut.Append("SELLERCONTACTLASTNAME" + vbTab)
                        htmlOut.Append("SELLERCONTACTSUFFIX" + vbTab)
                        htmlOut.Append("SELLERCONTACTTITLE" + vbTab)
                        htmlOut.Append("SELLERCONTACTEMAIL" + vbTab)
                        htmlOut.Append("SELLERCONTACTOFFICE" + vbTab)
                        htmlOut.Append("SELLERCONTACTFAX" + vbTab)
                        htmlOut.Append("SELLERCONTACTMOBILE" + vbTab)

                        htmlOut.Append("PURCHASERCOMPANY" + vbTab)
                        htmlOut.Append("PURCHASERCOMPALTNAME" + vbTab)
                        htmlOut.Append("PURCHASERCOMPEMAIL" + vbTab)
                        htmlOut.Append("PURCHASERCOMPWEBADDRESS" + vbTab)
                        htmlOut.Append("PURCHASERCOMPADDRESS1" + vbTab)
                        htmlOut.Append("PURCHASERCOMPADDRESS2" + vbTab)
                        htmlOut.Append("PURCHASERCOMPCITY" + vbTab)
                        htmlOut.Append("PURCHASERCOMPSTATE" + vbTab)
                        htmlOut.Append("PURCHASERCOMPSTATEABBR" + vbTab)
                        htmlOut.Append("PURCHASERCOMPPOSTALCODE" + vbTab)
                        htmlOut.Append("PURCHASERCOMPCOUNTRY" + vbTab)
                        htmlOut.Append("PURCHASERCOMPOFFICE" + vbTab)
                        htmlOut.Append("PURCHASERCOMPFAX" + vbTab)
                        htmlOut.Append("PURCHASERCOMPMOBILE" + vbTab)
                        htmlOut.Append("PURCHASERCONTACTPREFIX" + vbTab)
                        htmlOut.Append("PURCHASERCONTACTFIRSTNAME" + vbTab)
                        htmlOut.Append("PURCHASERCONTACTMI" + vbTab)
                        htmlOut.Append("PURCHASERCONTACTLASTNAME" + vbTab)
                        htmlOut.Append("PURCHASERCONTACTSUFFIX" + vbTab)
                        htmlOut.Append("PURCHASERCONTACTTITLE" + vbTab)
                        htmlOut.Append("PURCHASERCONTACTEMAIL" + vbTab)
                        htmlOut.Append("PURCHASERCONTACTOFFICE" + vbTab)
                        htmlOut.Append("PURCHASERCONTACTFAX" + vbTab)
                        htmlOut.Append("PURCHASERCONTACTMOBILE" + vbTab)

                        htmlOut.Append("YEARMFG" + vbTab)
                        htmlOut.Append("TYPE" + vbTab)
                        htmlOut.Append("SIZE" + vbTab)
                        htmlOut.Append("HULLTYPE" + vbTab)
                        htmlOut.Append("LENGTH" + vbTab)
                        htmlOut.Append("DISPLACEMENT" + vbTab)
                        htmlOut.Append("MANUFACTURER" + vbTab)
                        htmlOut.Append("FLAG" + vbTab)
                        htmlOut.Append("OWNERSHIP" + vbTab)

                        htmlOut.Append("TRANSACTIONDATE" + vbTab)
                        htmlOut.Append("TRANSACTIONDESCRIPTION" + vbTab)
                        htmlOut.Append("TRANSACTIONCODE" + vbTab)
                        htmlOut.Append("SCHEDULEDLEASEEXPIRATION" + vbTab)
                        htmlOut.Append("DATELEASEEXPIRED" + vbTab)

                        htmlOut.Append("ASKING" + vbTab)
                        htmlOut.Append("ASKINGAMT" + vbTab)
                        htmlOut.Append("DATELISTED" + vbTab)

                        htmlOut.Append("INFAVOROF" + vbTab)
                        htmlOut.Append("DOCDATE" + vbTab)
                        htmlOut.Append("DOCTYPE" + vbTab)
                        htmlOut.Append("DOCAMOUNT" + vbTab)
                        htmlOut.Append("TRANSACTIONNOTE")

                        htmlOut.Append(vbCrLf)

                    End If

                End If ' chkShowReportHeader.Checked Then

                For Each Row As DataRow In report_49_datatable.Rows

                    If CLng(Row.Item("journ_id").ToString) <> nRememberJournID Then

                        nRememberJournID = CLng(Row.Item("journ_id").ToString)

                        ytInfo1 = ""

                        If Not IsDBNull(Row.Item("yt_id")) And Not IsDBNull(Row.Item("journ_id")) Then

                            If bHtmlReport Or bExcelReport Then

                                ytInfo1 = "<tr><td>" + Server.HtmlEncode(Row.Item("ym_brand_name").ToString.Trim) + "</td>"
                                ytInfo1 += "<td>" + Row.Item("ym_model_name").ToString.Trim + "</td>"
                                ytInfo1 += "<td class='textformat'>" + Row.Item("yt_yacht_name").ToString.Trim + "</td>"
                                ytInfo1 += "<td class='textformat'>" + Row.Item("yt_hull_mfr_nbr").ToString.Trim + "</td>"

                            ElseIf bTextCommaReport Then
                                ytInfo1 = Constants.QUOTE + Row.Item("ym_brand_name").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim
                                ytInfo1 += Constants.QUOTE + Row.Item("ym_model_name").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim
                                ytInfo1 += Constants.QUOTE + Row.Item("yt_yacht_name").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim
                                ytInfo1 += Constants.QUOTE + Row.Item("yt_hull_mfr_nbr").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim

                            ElseIf bTextTabReport Then
                                ytInfo1 = Row.Item("ym_brand_name").ToString.Trim + vbTab
                                ytInfo1 += Row.Item("ym_model_name").ToString.Trim + vbTab
                                ytInfo1 += Row.Item("yt_yacht_name").ToString.Trim + vbTab
                                ytInfo1 += Row.Item("yt_hull_mfr_nbr").ToString.Trim + vbTab

                            End If

                            htmlOut.Append(get_references_seller_purchaser_49(CLng(Row.Item("yt_id").ToString), CLng(Row.Item("journ_id").ToString), ytInfo1, True, Row))

                        End If

                    End If

                Next

            End If

            If bHtmlReport Or bExcelReport Then
                htmlOut.Append("</table>")
            End If

            If bHtmlReport Then
                htmlOut.Append("</div>")
                htmlOut.Append("</body>")
                htmlOut.Append("</html>")
            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Create_Report_49_Aircraft_Seller_Purchaser()" + ex.Message
        Finally

            adoRS_49 = Nothing

            report_49_datatable = Nothing

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOut.ToString

    End Function

    Public Function get_references_seller_purchaser_49(ByVal inYTID As Long, ByVal inJournalID As Long, ByVal ytInfo1 As String, ByVal isHistorical As Boolean, ByRef currentRow As DataRow) As String

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim SqlReader As System.Data.SqlClient.SqlDataReader : SqlReader = Nothing

        Dim sSellerLine As String = ""
        Dim sPurchaserLine As String = ""

        Dim CompInfo As String = ""
        Dim CompPhoneInfo As String = ""
        Dim ContactInfo As String = ""
        Dim ContactPhoneInfo As String = ""
        Dim ytInfo2 As String = ""

        Dim lHoldCompId As Long = 0
        Dim lHoldContactId As Long = 0
        Dim lCompId As Long = 0
        Dim lContactId As Long = 0

        Dim strInFavorOf As String = ""
        Dim txNote As String = ""

        Dim sQuery = New StringBuilder()
        Dim htmlOut = New StringBuilder()

        Dim bIsPurchaser As Boolean = False

        Dim ref_49datatable As New DataTable

        Try

            If Not IsDBNull(currentRow.Item("journ_customer_note")) Then
                If bExcelReport Or bHtmlReport Then
                    txNote = "<td>" + currentRow.Item("journ_customer_note").ToString.Trim + "</td></tr>" + vbCrLf
                ElseIf bTextCommaReport Then
                    txNote = Constants.QUOTE + currentRow.Item("journ_customer_note").ToString.Trim + Constants.QUOTE + vbCrLf
                ElseIf bTextTabReport Then
                    txNote = currentRow.Item("journ_customer_note").ToString.Trim + vbCrLf
                End If
            Else
                If bExcelReport Or bHtmlReport Then
                    txNote = "<td></td></tr>" + vbCrLf
                ElseIf bTextCommaReport Then
                    txNote = Constants.QUOTE + Constants.QUOTE + vbCrLf
                ElseIf bTextTabReport Then
                    txNote = "" + vbCrLf
                End If
            End If

            sQuery.Append("SELECT DISTINCT TOP 2 yr_contact_type, yr_contact_id, comp_id, yr_journ_id, yr_comp_id, yr_seq_no,")
            sQuery.Append(" comp_name, comp_name_alt_type, comp_name_alt, comp_city, comp_state, comp_zip_code, yct_name,")
            sQuery.Append(" comp_email_address, comp_web_address, comp_address1, comp_address2, comp_country, state_name")
            sQuery.Append(" FROM Yacht_Reference WITH (NOLOCK) ")
            sQuery.Append(" INNER JOIN Company WITH (NOLOCK) ON yr_comp_id = comp_id AND yr_journ_id = comp_journ_id")
            sQuery.Append(" INNER JOIN Yacht_Contact_Type WITH (NOLOCK) ON yr_contact_type = yct_code")
            sQuery.Append(" LEFT OUTER JOIN State WITH (NOLOCK) ON (comp_state = state_code AND comp_country = state_country)")
            sQuery.Append(" WHERE ((yr_yt_id = " + inYTID.ToString + ") AND (yr_journ_id = " + inJournalID.ToString + ")")

            ' 02 = Additional Company/Contact
            ' 71 = Research Only
            ' 38 = Sales Company/Contact
            ' 2P = Buyers Broker
            ' 98 = Yacht Broker

            sQuery.Append(" AND (yr_contact_type NOT IN ('02','71','38','2P','98'))")
            sQuery.Append(" AND (yr_seq_no IN (1,10))")
            sQuery.Append(" AND (comp_hide_flag = 'N'))")
            sQuery.Append(" ORDER BY yr_seq_no")

            Try

                SqlConn.ConnectionString = localFunctions.clientConnectStr
                SqlConn.Open()

                SqlCommand.Connection = SqlConn
                SqlCommand.CommandType = System.Data.CommandType.Text
                SqlCommand.CommandTimeout = 90

                SqlCommand.CommandText = sQuery.ToString
                SqlReader = SqlCommand.ExecuteReader()

                Try
                    ref_49datatable.Load(SqlReader)
                Catch constrExc As System.Data.ConstraintException
                    Dim rowsErr As System.Data.DataRow() = ref_49datatable.GetErrors()
                End Try

                SqlReader.Close()

                If ref_49datatable.Rows.Count > 0 Then

                    CompInfo = ""
                    CompPhoneInfo = ""
                    ContactInfo = ""
                    ContactPhoneInfo = ""
                    strInFavorOf = ""
                    ytInfo2 = ""

                    lHoldCompId = -1
                    lHoldContactId = -1

                    For Each Row As DataRow In ref_49datatable.Rows

                        lCompId = CLng(Row.Item("yr_comp_id").ToString)
                        lContactId = CLng(Row.Item("yr_contact_id").ToString)

                        If lHoldCompId <> lCompId Then

                            ReturnCompanyInformation_Report(lCompId, inJournalID, Row, CompPhoneInfo, CompInfo, True)
                            lHoldCompId = lCompId

                        End If   ' if we have a company id

                        If lHoldContactId <> lContactId Then

                            ReturnContactInformation_Report(lCompId, lContactId, inJournalID, ContactInfo, ContactPhoneInfo)
                            lHoldContactId = lContactId

                        End If

                        If ref_49datatable.Rows.Count = 1 Then ' we only have a "seller"

                            sSellerLine = ytInfo1 + CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo

                            ytInfo2 = finish_yacht_info_seller_purchaser_49(isHistorical, currentRow)

                            strInFavorOf = ReturnInFavorOfInformation(inYTID, lCompId, False)

                            ReturnCompanyInformation_Report(0, 0, Nothing, CompPhoneInfo, CompInfo, True)
                            ReturnContactInformation_Report(0, 0, 0, ContactInfo, ContactPhoneInfo)

                            If bHtmlReport Or bExcelReport Then

                                sPurchaserLine = CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo + ytInfo2 + strInFavorOf + txNote

                            ElseIf bTextCommaReport Then

                                sPurchaserLine = Constants.cCommaDelim + CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo + Constants.cCommaDelim + ytInfo2 + strInFavorOf + Constants.cCommaDelim + txNote

                            ElseIf bTextTabReport Then

                                sPurchaserLine = vbTab + CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo + vbTab + ytInfo2 + strInFavorOf + vbTab + txNote

                            End If

                            htmlOut.Append(sSellerLine + sPurchaserLine)

                        Else

                            If Not bIsPurchaser Then

                                sSellerLine = ytInfo1 + CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo
                                bIsPurchaser = True

                            Else

                                ytInfo2 = finish_yacht_info_seller_purchaser_49(isHistorical, currentRow)

                                strInFavorOf = ReturnInFavorOfInformation(inYTID, lCompId, False)

                                If bHtmlReport Or bExcelReport Then

                                    sPurchaserLine = CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo + ytInfo2 + strInFavorOf + txNote

                                ElseIf bTextCommaReport Then

                                    sPurchaserLine = Constants.cCommaDelim + CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo + Constants.cCommaDelim + ytInfo2 + strInFavorOf + Constants.cCommaDelim + txNote

                                ElseIf bTextTabReport Then

                                    sPurchaserLine = vbTab + CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo + vbTab + ytInfo2 + strInFavorOf + vbTab + txNote

                                End If

                                htmlOut.Append(sSellerLine + sPurchaserLine)

                            End If

                        End If

                    Next

                Else

                    ReturnCompanyInformation_Report(0, 0, Nothing, CompPhoneInfo, CompInfo, True)
                    ReturnContactInformation_Report(0, 0, 0, ContactInfo, ContactPhoneInfo)

                    sSellerLine = ytInfo1 + CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo

                    ytInfo2 = finish_yacht_info_seller_purchaser_49(isHistorical, currentRow)

                    strInFavorOf = ReturnInFavorOfInformation(inYTID, 0, False)

                    ReturnCompanyInformation_Report(0, 0, Nothing, CompPhoneInfo, CompInfo, True)
                    ReturnContactInformation_Report(0, 0, 0, ContactInfo, ContactPhoneInfo)

                    If bHtmlReport Or bExcelReport Then

                        sPurchaserLine = CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo + ytInfo2 + strInFavorOf + txNote

                    ElseIf bTextCommaReport Then

                        sPurchaserLine = Constants.cCommaDelim + CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo + Constants.cCommaDelim + ytInfo2 + strInFavorOf + Constants.cCommaDelim + txNote

                    ElseIf bTextTabReport Then

                        sPurchaserLine = vbTab + CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo + vbTab + ytInfo2 + strInFavorOf + vbTab + txNote

                    End If

                    htmlOut.Append(sSellerLine + sPurchaserLine)

                End If

            Catch SqlException

                HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in GetReferences_SellerPurchaser(ByVal inACID As Long, ByVal inJournalID As Long, ByVal ACInfo1 As String, ByVal isHistorical As Boolean) As String" + SqlException.Message

            Finally


                SqlReader = Nothing

                SqlConn.Dispose()
                SqlConn.Close()
                SqlConn = Nothing

                SqlCommand.Dispose()
                SqlCommand = Nothing
            End Try

        Catch ex As Exception

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in GetReferences_SellerPurchaser(ByVal inACID As Long, ByVal inJournalID As Long, ByVal ACInfo1 As String, ByVal isHistorical As Boolean) As String" + ex.Message

        End Try

        Return htmlOut.ToString

    End Function

    Public Function finish_yacht_info_seller_purchaser_49(ByVal isHistorical As Boolean, ByRef currentRow As DataRow) As String

        Dim yt_mfr_year As String = ""
        Dim yt_type As String = ""
        Dim yt_size As String = ""
        Dim yt_hulltype As String = ""
        Dim yt_length As String = ""
        Dim yt_displacement As String = ""
        Dim yt_manufacturer As String = ""
        Dim yt_flag As String = ""

        Dim yt_ownership As String = ""

        Dim yt_asking As String = ""
        Dim yt_asking_price As String = "0.0"
        Dim yt_list_date As String = ""

        Dim journ_date As String = ""
        Dim journ_subject As String = ""
        Dim journ_subcategory_code As String = ""
        Dim journ_id As String = ""

        Dim priorev_entry_date As String = ""
        Dim priorev_subject As String = ""
        Dim priorev_description As String = ""

        Dim sLeaseExpireDate As String = ""
        Dim sLeaseExpConfirmDate As String = ""

        Dim htmlOut = New StringBuilder()

        Try

            If Not (IsDBNull(currentRow.Item("yt_year_mfr"))) Then
                yt_mfr_year = currentRow.Item("yt_year_mfr").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("ym_motor_type"))) Then
                If Not String.IsNullOrEmpty(currentRow.Item("ym_motor_type").ToString.Trim) Then

                    Select Case (currentRow.Item("ym_motor_type").ToString.ToUpper.Trim)
                        Case Constants.YMOD_MOTOR_HULL
                            yt_type = "Motor"
                        Case Constants.YMOD_SAIL_HULL
                            yt_type = "Sail"
                    End Select

                End If
            End If

            If Not (IsDBNull(currentRow.Item("ym_category_size"))) Then
                If Not String.IsNullOrEmpty(currentRow.Item("ym_category_size").ToString.Trim) Then

                    Select Case (currentRow.Item("ym_category_size").ToString.ToUpper.Trim)
                        Case Constants.YMOD_TYPE_GIGA
                            yt_size = "Giga"
                        Case Constants.YMOD_TYPE_MEGA
                            yt_size = "Mega"
                        Case Constants.YMOD_TYPE_SUPER
                            yt_size = "Super"
                        Case Constants.YMOD_TYPE_LUXURY
                            yt_size = "Luxury"
                    End Select

                End If
            End If

            If Not (IsDBNull(currentRow.Item("ym_nbr_hulls"))) Then
                yt_hulltype = currentRow.Item("ym_nbr_hulls").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("yt_length_overall_meters"))) Then
                yt_length = currentRow.Item("yt_length_overall_meters").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("yt_displacement_tons"))) Then
                yt_displacement = currentRow.Item("yt_displacement_tons").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("ym_mfr_comp_id"))) Then
                yt_manufacturer = commonEvo.get_company_name_fromID(CLng(currentRow.Item("ym_mfr_comp_id").ToString), 0, False, False, "")
            End If

            If Not (IsDBNull(currentRow.Item("yt_registered_country_flag"))) Then
                yt_flag = currentRow.Item("yt_registered_country_flag").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("yt_asking_price_wordage"))) Then
                yt_asking = currentRow.Item("yt_asking_price_wordage").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("yt_asking_price"))) Then
                yt_asking_price = currentRow.Item("yt_asking_price").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("yt_forsale_list_date"))) Then
                yt_list_date = FormatDateTime(currentRow.Item("yt_forsale_list_date").ToString, DateFormat.ShortDate).Trim
            End If

            If Not (IsDBNull(currentRow.Item("yt_ownership_type"))) Then
                If Not String.IsNullOrEmpty(currentRow.Item("yt_ownership_type").ToString.Trim) Then

                    Select Case (currentRow.Item("yt_ownership_type").ToString.ToUpper.Trim)
                        Case "W"
                            yt_ownership = "Whole"
                        Case "S"
                            yt_ownership = "Shared"
                    End Select

                End If
            End If

            If Not (IsDBNull(currentRow.Item("journ_date"))) Then
                journ_date = FormatDateTime(currentRow.Item("journ_date").ToString, DateFormat.ShortDate).Trim
            End If

            If Not (IsDBNull(currentRow.Item("journ_subject"))) Then
                journ_subject = currentRow.Item("journ_subject").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("journ_subcategory_code"))) Then
                journ_subcategory_code = currentRow.Item("journ_subcategory_code").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("journ_id"))) Then
                journ_id = currentRow.Item("journ_id").ToString.Trim
            End If

            If Not isHistorical Then

                If Not (IsDBNull(currentRow.Item("priorev_entry_date"))) Then
                    priorev_entry_date = FormatDateTime(currentRow.Item("priorev_entry_date").ToString, DateFormat.ShortDate).Trim
                End If

                If Not (IsDBNull(currentRow.Item("priorev_subject"))) Then
                    priorev_subject = currentRow.Item("priorev_subject").ToString.Trim
                End If

                If Not (IsDBNull(currentRow.Item("priorev_description"))) Then
                    priorev_description = currentRow.Item("priorev_description").ToString.Trim
                End If

            End If

            If bExcelReport Or bHtmlReport Then

                If Not String.IsNullOrEmpty(yt_mfr_year.Trim) Then
                    htmlOut.Append("<td>" + yt_mfr_year + "</td>")
                Else
                    htmlOut.Append("<td></td>")
                End If

                htmlOut.Append("<td>" + yt_type + "</td>")
                htmlOut.Append("<td>" + yt_size + "</td>")
                htmlOut.Append("<td>" + yt_hulltype + "</td>")
                htmlOut.Append("<td>" + yt_length + "</td>")
                htmlOut.Append("<td>" + yt_displacement + "</td>")
                htmlOut.Append("<td>" + Server.HtmlEncode(yt_manufacturer) + "</td>")
                htmlOut.Append("<td>" + yt_flag + "</td>")
                htmlOut.Append("<td>" + yt_ownership + "</td>")

                htmlOut.Append("<td>" + journ_date + "</td>")
                htmlOut.Append("<td>" + journ_subject + "</td>")
                htmlOut.Append("<td>" + journ_subcategory_code + "</td>")

                If Not isHistorical Then
                    htmlOut.Append("<td>" + priorev_entry_date + "</td>")
                    htmlOut.Append("<td>" + priorev_subject)

                    If Not String.IsNullOrEmpty(priorev_description) Then
                        htmlOut.Append(" - " + priorev_description + "</td>")
                    Else
                        htmlOut.Append("</td>")
                    End If
                End If

                localFunctions.get_lease_expire_and_confirm_date(journ_id, True, sLeaseExpireDate, sLeaseExpConfirmDate)

                htmlOut.Append("<td>" + sLeaseExpireDate + "</td>")
                htmlOut.Append("<td>" + sLeaseExpConfirmDate + "</td>")

                htmlOut.Append("<td>" + yt_asking + "</td>")
                If CDbl(yt_asking_price) > 0 Then
                    htmlOut.Append("<td>$" + FormatNumber(yt_asking_price, 0, False, False, True) + "</td>")
                Else
                    htmlOut.Append("<td>&nbsp;</td>")
                End If

                htmlOut.Append("<td class='dateformat'>" + yt_list_date + "</td>")

            ElseIf bTextCommaReport Then

                htmlOut.Append(Constants.QUOTE + yt_mfr_year + Constants.QUOTE + Constants.cCommaDelim)

                htmlOut.Append(Constants.QUOTE + yt_type + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + yt_size + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + yt_hulltype + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + yt_length + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + yt_displacement + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + yt_manufacturer + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + yt_flag + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + yt_ownership + Constants.QUOTE + Constants.cCommaDelim)

                htmlOut.Append(Constants.QUOTE + journ_date + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + journ_subject + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + journ_subcategory_code + Constants.QUOTE + Constants.cCommaDelim)

                If Not isHistorical Then

                    htmlOut.Append(Constants.QUOTE + priorev_entry_date + Constants.QUOTE + Constants.cCommaDelim)
                    htmlOut.Append(Constants.QUOTE + priorev_subject)

                    If Not String.IsNullOrEmpty(priorev_description) Then
                        htmlOut.Append(" - " + priorev_description + Constants.QUOTE + Constants.cCommaDelim)
                    Else
                        htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                    End If

                End If

                localFunctions.get_lease_expire_and_confirm_date(journ_id, True, sLeaseExpireDate, sLeaseExpConfirmDate)

                htmlOut.Append(Constants.QUOTE + sLeaseExpireDate + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + sLeaseExpConfirmDate + Constants.QUOTE + Constants.cCommaDelim)

                htmlOut.Append(Constants.QUOTE + yt_asking + Constants.QUOTE + Constants.cCommaDelim)
                If CDbl(yt_asking_price) > 0 Then
                    htmlOut.Append(Constants.QUOTE + "$" + FormatNumber(yt_asking_price, 0, False, False, True) + Constants.QUOTE + Constants.cCommaDelim)
                Else
                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                End If

                htmlOut.Append(Constants.QUOTE + yt_list_date + Constants.QUOTE + Constants.cCommaDelim)

            ElseIf bTextTabReport Then

                htmlOut.Append(yt_mfr_year + vbTab)
                htmlOut.Append(yt_type + vbTab)
                htmlOut.Append(yt_size + vbTab)
                htmlOut.Append(yt_hulltype + vbTab)
                htmlOut.Append(yt_length + vbTab)
                htmlOut.Append(yt_displacement + vbTab)
                htmlOut.Append(yt_manufacturer + vbTab)
                htmlOut.Append(yt_flag + vbTab)
                htmlOut.Append(yt_ownership + vbTab)

                htmlOut.Append(journ_date + vbTab)
                htmlOut.Append(journ_subject + vbTab)
                htmlOut.Append(journ_subcategory_code + vbTab)

                If Not isHistorical Then

                    htmlOut.Append(priorev_entry_date + vbTab)
                    htmlOut.Append(priorev_subject)

                    If Not String.IsNullOrEmpty(priorev_description) Then
                        htmlOut.Append(" - " + priorev_description + vbTab)
                    Else
                        htmlOut.Append(vbTab)
                    End If

                End If

                localFunctions.get_lease_expire_and_confirm_date(journ_id, True, sLeaseExpireDate, sLeaseExpConfirmDate)

                htmlOut.Append(sLeaseExpireDate + vbTab)
                htmlOut.Append(sLeaseExpConfirmDate + vbTab)

                htmlOut.Append(yt_asking + vbTab)
                If CDbl(yt_asking_price) > 0 Then
                    htmlOut.Append("$" + FormatNumber(yt_asking_price, 0, False, False, True) + vbTab)
                Else
                    htmlOut.Append(vbTab)
                End If

                htmlOut.Append(yt_list_date + vbTab)

            End If

        Catch ex As Exception

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in finish_yacht_info_seller_purchaser(ByVal isHistorical As Boolean, ByRef currentRow As DataRow) As String" + ex.Message

        End Try

        Return htmlOut.ToString

    End Function

#End Region

#Region "report_50_functions"

    Public Function create_report_50_condensed_spec_jfw_format(ByRef record_count As Long) As String

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim report_50_datatable As New DataTable

        Dim adoRS_50 As System.Data.SqlClient.SqlDataReader : adoRS_50 = Nothing

        Dim htmlOut = New StringBuilder()

        Dim sQuery As New StringBuilder()

        Try

            SqlConn.ConnectionString = localFunctions.clientConnectStr

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 90

            If HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("comp_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("contact_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("state_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("country_") Then
                sQuery.Append("SELECT DISTINCT ac_id, ac_journ_id, amod_id, amod_airframe_type_code, amod_type_code, amod_make_name, amod_model_name, ac_ser_no_full, ac_ser_no_sort, ac_reg_no, ac_status,")
                sQuery.Append(" ac_asking, ac_asking_price, ac_list_date, ac_purchase_date, ac_upd_date, ac_mfr_year, ac_year, ac_apu_model_name,")
                sQuery.Append(" ac_aport_iata_code, ac_aport_icao_code, ac_aport_name, ac_aport_city, ac_aport_state, ac_aport_country, ac_apu_tot_hrs,")
                sQuery.Append(" ac_airframe_tot_hrs, ac_airframe_tot_landings, ac_engine_maint_prog_name, ac_passenger_count, ac_engine_name, ac_apu_soh_hrs,")
                sQuery.Append(" ac_engine_1_ser_no, ac_engine_2_ser_no, ac_engine_3_ser_no, ac_engine_4_ser_no, ac_damage_history_notes,")
                sQuery.Append(" ac_engine_1_tot_hrs, ac_engine_2_tot_hrs, ac_engine_3_tot_hrs, ac_engine_4_tot_hrs,")
                sQuery.Append(" ac_engine_1_soh_hrs, ac_engine_2_soh_hrs, ac_engine_3_soh_hrs, ac_engine_4_soh_hrs,")
                sQuery.Append(" ac_maint_eoh_by_name, ac_engine_1_shi_hrs, ac_engine_2_shi_hrs, ac_engine_3_shi_hrs, ac_engine_4_shi_hrs,")
                sQuery.Append(" ac_maint_hots_by_name, ac_engine_1_tbo_hrs, ac_engine_2_tbo_hrs, ac_engine_3_tbo_hrs, ac_engine_4_tbo_hrs,")
                'sQuery.Append(" ac_engine_1_soh_cycles, ac_engine_2_soh_cycles, ac_engine_3_soh_cycles, ac_engine_4_soh_cycles,")
                sQuery.Append(" ac_maintained, ac_times_as_of_date, ac_exterior_moyear, ac_interior_moyear, ac_lifecycle_stage,")
                sQuery.Append(" amp_provider_name, amp_program_name, emp_provider_name, emp_program_name")
                sQuery.Append(" FROM View_Aircraft_Company_Flat WITH(NOLOCK) ")
            Else
                sQuery.Append("SELECT DISTINCT ac_id, ac_journ_id, amod_id, amod_airframe_type_code, amod_type_code, amod_make_name, amod_model_name, ac_ser_no_full, ac_ser_no_sort, ac_reg_no, ac_status,")
                sQuery.Append(" ac_asking, ac_asking_price, ac_list_date, ac_purchase_date, ac_upd_date, ac_mfr_year, ac_year, ac_apu_model_name,")
                sQuery.Append(" ac_aport_iata_code, ac_aport_icao_code, ac_aport_name, ac_aport_city, ac_aport_state, ac_aport_country, ac_apu_tot_hrs,")
                sQuery.Append(" ac_airframe_tot_hrs, ac_airframe_tot_landings, ac_engine_maint_prog_name, ac_passenger_count, ac_engine_name, ac_apu_soh_hrs,")
                sQuery.Append(" ac_engine_1_ser_no, ac_engine_2_ser_no, ac_engine_3_ser_no, ac_engine_4_ser_no, ac_damage_history_notes,")
                sQuery.Append(" ac_engine_1_tot_hrs, ac_engine_2_tot_hrs, ac_engine_3_tot_hrs, ac_engine_4_tot_hrs,")
                sQuery.Append(" ac_engine_1_soh_hrs, ac_engine_2_soh_hrs, ac_engine_3_soh_hrs, ac_engine_4_soh_hrs,")
                sQuery.Append(" ac_maint_eoh_by_name, ac_engine_1_shi_hrs, ac_engine_2_shi_hrs, ac_engine_3_shi_hrs, ac_engine_4_shi_hrs,")
                sQuery.Append(" ac_maint_hots_by_name, ac_engine_1_tbo_hrs, ac_engine_2_tbo_hrs, ac_engine_3_tbo_hrs, ac_engine_4_tbo_hrs,")
                'sQuery.Append(" ac_engine_1_soh_cycles, ac_engine_2_soh_cycles, ac_engine_3_soh_cycles, ac_engine_4_soh_cycles,")
                sQuery.Append(" ac_maintained, ac_times_as_of_date, ac_exterior_moyear, ac_interior_moyear, ac_lifecycle_stage,")
                sQuery.Append(" amp_provider_name, amp_program_name, emp_provider_name, emp_program_name")
                sQuery.Append(" FROM View_Aircraft_Flat WITH(NOLOCK) ")
            End If

            sQuery.Append(HttpContext.Current.Session.Item("MasterAircraftWhere").ToString)

            sQuery.Append(" ORDER BY amod_make_name, amod_airframe_type_code, amod_type_code, amod_id, amod_model_name, ac_ser_no_sort")

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />create_report_50_condensed_spec_jfw_format()<br />" + sQuery.ToString

            If bHtmlReport Then
                htmlOut.Append("<!DOCTYPE html>")
                htmlOut.Append("<html lang='en'>")
                htmlOut.Append("<head>")
                htmlOut.Append("<meta http-equiv='Content-Language' content='en-us' />")
                htmlOut.Append("<meta http-equiv='Content-Type' content='text/html; charset=windows-1252' />")
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='common/jetnet.css' />")
                htmlOut.Append("<title>JETNET - Condensed Spec - JFW Format</title>")
                htmlOut.Append("</head>")
                htmlOut.Append("<body style='background: white; margin-top:10px; margin-left:10px; font-size: 11px;'>")
                htmlOut.Append("<div style='text-align:center;'>")
            End If

            If bExcelReport Then
                htmlOut.Append(localFunctions.include_excel_report_style() + vbCrLf)
                htmlOut.Append("<table border='1' cellpadding='2' cellspacing='0'>")
            ElseIf bHtmlReport Then
                htmlOut.Append("<table class='centerTable' border='0' cellpadding='2' cellspacing='0' width='100%'>")
            End If

            SqlCommand.CommandText = sQuery.ToString
            adoRS_50 = SqlCommand.ExecuteReader()

            Try
                report_50_datatable.Load(adoRS_50)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = report_50_datatable.GetErrors()
            End Try

            adoRS_50.Close()
            adoRS_50 = Nothing

            record_count = report_50_datatable.Rows.Count

            If report_50_datatable.Rows.Count > 0 Then

                Dim tstCount As Long = 0

                For Each Row As DataRow In report_50_datatable.Rows

                    tstCount += 1

                    If bExcelReport Or bHtmlReport Then

                        htmlOut.Append("<tr><td valign='top' align='left' nowrap='nowrap'><b>MAKE:</b>&nbsp;" + Row.Item("amod_make_name").ToString.Trim + "</td>")
                        htmlOut.Append("<td valign='top' align='left' width='20%' nowrap='nowrap'><b>MODEL:</b>&nbsp;" + Row.Item("amod_model_name").ToString.Trim + "</td>")
                        htmlOut.Append("<td valign='top' align='left' nowrap='nowrap'><b>YR DLV/MFT:</b>&nbsp;" + Row.Item("ac_year").ToString.Trim + Constants.cHyphen + Row.Item("ac_mfr_year").ToString.Trim + "</td>")
                        htmlOut.Append("<td valign='top' align='left' nowrap='nowrap'><b>MAINTAINED:</b>&nbsp;" + Row.Item("ac_maintained").ToString.Trim + "<br />")
                        htmlOut.Append("<b>ASKING:</b>&nbsp;")

                        If Not bAerodexFlag Then
                            If Not IsDBNull(Row.Item("ac_asking_price")) Then
                                If Row.Item("ac_asking").ToString.ToLower.Contains("price") Then
                                    If Not IsDBNull(Row.Item("ac_asking_price")) Then
                                        If CDbl(Row.Item("ac_asking_price").ToString) > 0 Then
                                            htmlOut.Append("$" + FormatNumber(CDbl(Row.Item("ac_asking_price").ToString), 0, False, False, True).ToString)
                                        End If
                                    End If
                                Else
                                    If Not IsDBNull(Row.Item("ac_asking")) Then
                                        htmlOut.Append(Row.Item("ac_asking").ToString.Trim)
                                    End If
                                End If
                            Else
                                If Not IsDBNull(Row.Item("ac_asking")) Then
                                    htmlOut.Append(Row.Item("ac_asking").ToString.Trim)
                                End If
                            End If
                        End If

                        htmlOut.Append("</td></tr>")
                        htmlOut.Append(IIf(bHtmlReport, "<tr><td><hr height='1'></td>", "<tr><td></td>"))
                        If Not IsDBNull(Row.Item("ac_times_as_of_date")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_times_as_of_date").ToString.Trim) Then
                                htmlOut.Append("<td valign='top' align='center'><b>Times Current:</b>&nbsp;" + FormatDateTime(Row.Item("ac_times_as_of_date").ToString, DateFormat.ShortDate) + "</td>")
                            Else
                                htmlOut.Append("<td></td>")
                            End If
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        htmlOut.Append(IIf(bHtmlReport, "<td colspan='2'><hr height='1'></td></tr>", "<td colspan='2'></td></tr>"))

                        htmlOut.Append("<tr><td colspan='4' valign='top' align='left'>")

                        htmlOut.Append("<table" + IIf(bHtmlReport, " class='centerTable' width='100%'", "") + " border='0' cellpadding='2' cellspacing='0'>") '  times current table

                        htmlOut.Append("<tr><td width='10%' valign='top' align='left'><b>ENG TT:</b></td>")

                        htmlOut.Append("<td width='8%' valign='top' align='left'>" + Row.Item("ac_engine_1_tot_hrs").ToString.Trim + "</td>")
                        htmlOut.Append("<td width='8%' valign='top' align='left'>" + Row.Item("ac_engine_2_tot_hrs").ToString.Trim + "</td>")
                        htmlOut.Append("<td width='8%' valign='top' align='left'>" + Row.Item("ac_engine_3_tot_hrs").ToString.Trim + "</td>")
                        htmlOut.Append("<td width='8%' valign='top' align='left'>" + Row.Item("ac_engine_4_tot_hrs").ToString.Trim + "</td>")

                        If Not IsDBNull(Row.Item("ac_airframe_tot_hrs")) Then
                            htmlOut.Append("<td valign='top' align='left' nowrap='nowrap'><b>AIRFRM&nbsp;TT:</b>&nbsp;" + Row.Item("ac_airframe_tot_hrs").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td valign='top' align='left' nowrap='nowrap'><b>AIRFRM&nbsp;TT:</b></td>")
                        End If

                        If Not IsDBNull(Row.Item("ac_airframe_tot_landings")) Then
                            htmlOut.Append("<td valign='top' align='left' nowrap='nowrap'><b>LANDINGS:</b>&nbsp;" + Row.Item("ac_airframe_tot_landings").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td valign='top' align='left' nowrap='nowrap'><b>LANDINGS:</b></td>")
                        End If

                        htmlOut.Append("</tr><tr><td valign='top' align='left'><b>SMOH/CORE:</b></td>")

                        htmlOut.Append("<td valign='top' align='left'>" + Row.Item("ac_engine_1_soh_hrs").ToString.Trim + "</td>")
                        htmlOut.Append("<td valign='top' align='left'>" + Row.Item("ac_engine_2_soh_hrs").ToString.Trim + "</td>")
                        htmlOut.Append("<td valign='top' align='left'>" + Row.Item("ac_engine_3_soh_hrs").ToString.Trim + "</td>")
                        htmlOut.Append("<td valign='top' align='left'>" + Row.Item("ac_engine_4_soh_hrs").ToString.Trim + "</td>")

                        If Not IsDBNull(Row.Item("ac_engine_name")) Then
                            htmlOut.Append("<td valign='top' align='left' colspan='2'><b>ENG MODEL:</b>&nbsp;" + Row.Item("ac_engine_name").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td valign='top' align='left' colspan='2'><b>ENG MODEL:</b></td>")
                        End If

                        htmlOut.Append("</tr><tr><td valign='top' align='left'><b>SHOT/MPI:</b></td>")

                        htmlOut.Append("<td valign='top' align='left'>" + Row.Item("ac_engine_1_shi_hrs").ToString.Trim + "</td>")
                        htmlOut.Append("<td valign='top' align='left'>" + Row.Item("ac_engine_2_shi_hrs").ToString.Trim + "</td>")
                        htmlOut.Append("<td valign='top' align='left'>" + Row.Item("ac_engine_3_shi_hrs").ToString.Trim + "</td>")
                        htmlOut.Append("<td valign='top' align='left'>" + Row.Item("ac_engine_4_shi_hrs").ToString.Trim + "</td>")
                        htmlOut.Append("<td valign='top' align='left' colspan='2' width='35%'><b>FEATURES:</b>")

                        Dim sAcFeatureCodes As String = ""
                        localFunctions.get_all_ac_feature_codes(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id").ToString), sAcFeatureCodes, True)
                        htmlOut.Append(sAcFeatureCodes)

                        htmlOut.Append("</td></tr>")
                        htmlOut.Append("<tr><td valign='top' align='left'><b>TBO:</b></td>")

                        htmlOut.Append("<td valign='top' align='left'>" + Row.Item("ac_engine_1_tbo_hrs").ToString.Trim + "</td>")
                        htmlOut.Append("<td valign='top' align='left'>" + Row.Item("ac_engine_2_tbo_hrs").ToString.Trim + "</td>")
                        htmlOut.Append("<td valign='top' align='left'>" + Row.Item("ac_engine_3_tbo_hrs").ToString.Trim + "</td>")
                        htmlOut.Append("<td valign='top' align='left'>" + Row.Item("ac_engine_4_tbo_hrs").ToString.Trim + "</td>")
                        htmlOut.Append("<td colspan='2'></td>")

                        htmlOut.Append("</tr><tr><td valign='top' align='left'><b>SPOH:</b></td>")

                        'htmlOut.Append("<td valign='top' align='left'>" + Row.Item("ac_engine_1_soh_cycles").ToString.Trim + "</td>")
                        'htmlOut.Append("<td valign='top' align='left'>" + Row.Item("ac_engine_2_soh_cycles").ToString.Trim + "</td>")
                        'htmlOut.Append("<td valign='top' align='left'>" + Row.Item("ac_engine_3_soh_cycles").ToString.Trim + "</td>")
                        'htmlOut.Append("<td valign='top' align='left'>" + Row.Item("ac_engine_4_soh_cycles").ToString.Trim + "</td>")
                        'htmlOut.Append("<td colspan='2'></td>")

                        htmlOut.Append("<td colspan='5'></td>")

                        htmlOut.Append("</tr><tr><td valign='top' align='left' colspan='2'><b>APU:</b>")

                        If Not IsDBNull(Row.Item("ac_apu_model_name")) And Not String.IsNullOrEmpty(Row.Item("ac_apu_model_name").ToString) Then
                            htmlOut.Append(Row.Item("ac_apu_model_name").ToString)
                        End If

                        htmlOut.Append("</td><td valign='top' align='left' colspan='5'></td>")

                        htmlOut.Append("</tr><tr><td valign='top' align='left' colspan='2'><b>APU TTSN:</b>")

                        If Not IsDBNull(Row.Item("ac_apu_tot_hrs")) And Not String.IsNullOrEmpty(Row.Item("ac_apu_tot_hrs").ToString) Then
                            htmlOut.Append(FormatNumber(CDbl(Row.Item("ac_apu_tot_hrs").ToString), 0, True, False, True))
                        End If

                        htmlOut.Append("</td><td valign='top' align='left' colspan='2'><b>APU SOH:</b>")

                        If Not IsDBNull(Row.Item("ac_apu_soh_hrs")) And Not String.IsNullOrEmpty(Row.Item("ac_apu_soh_hrs").ToString) Then
                            htmlOut.Append(FormatNumber(CDbl(Row.Item("ac_apu_soh_hrs").ToString), 0, True, False, True))
                        End If

                        htmlOut.Append("</td><td valign='top' align='left' colspan='3'></td>")

                        htmlOut.Append("</tr><tr><td valign='top' align='left' colspan='3'><b>MX PROG:</b>")

                        If Not IsDBNull(Row.Item("amp_provider_name")) Then
                            htmlOut.Append(Row.Item("amp_provider_name").ToString.Trim)
                        End If

                        If Not IsDBNull(Row.Item("amp_program_name")) Then
                            If Not IsDBNull(Row.Item("amp_provider_name")) Then htmlOut.Append(" ")

                            htmlOut.Append(Row.Item("amp_program_name").ToString.Trim)
                        End If

                        htmlOut.Append("</td>")

                        If Not IsDBNull(Row.Item("ac_maint_eoh_by_name")) Then
                            htmlOut.Append("<td valign='top' align='left' colspan='2'><b>ENG OH:</b>" + Row.Item("ac_maint_eoh_by_name").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td valign='top' align='left' colspan='2'><b>ENG OH:</b></td>")
                        End If

                        If Not IsDBNull(Row.Item("ac_maint_hots_by_name")) Then
                            htmlOut.Append("<td valign='top' align='left' colspan='2'><b>HOTS:</b>" + Row.Item("ac_maint_hots_by_name").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td valign='top' align='left' colspan='2'><b>HOTS:</b></td>")
                        End If


                        htmlOut.Append("</tr>")

                        htmlOut.Append("</table>") ' times current table 
                        htmlOut.Append("</tr>")

                        htmlOut.Append(IIf(bHtmlReport, "<tr><td colspan='4'><hr height='1'></td></tr>", "<tr><td colspan='4'></td></tr>"))

                        htmlOut.Append("<tr><td colspan='4' valign='top' align='left'>")

                        htmlOut.Append(localFunctions.display_maintenance_details_report(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id").ToString)))

                        htmlOut.Append("</td></tr>")

                        htmlOut.Append("<tr><td colspan='4' valign='top' align='left'><b>Damage History:</b>&nbsp;")

                        If Not IsDBNull(Row.Item("ac_damage_history_notes")) And Not String.IsNullOrEmpty(Row.Item("ac_damage_history_notes").ToString) Then
                            htmlOut.Append(Row.Item("ac_damage_history_notes").ToString.Trim)
                        End If

                        htmlOut.Append("</td></tr>")

                        htmlOut.Append("<tr><td colspan='4' valign='top' align='left'><b>Define:</b>&nbsp;</td></tr>")
                        htmlOut.Append("<tr><td colspan='4' valign='top' align='left'>")
                        htmlOut.Append("<b>EXT:</b>&nbsp;")

                        If Not IsDBNull(Row.Item("ac_exterior_moyear")) Then
                            If Row.Item("ac_exterior_moyear").ToString.Trim.Length > 4 Then
                                htmlOut.Append(Left(Row.Item("ac_exterior_moyear").ToString.Trim, 2) + "/")
                                htmlOut.Append(Right(Row.Item("ac_exterior_moyear").ToString.Trim, 4))
                            ElseIf Row.Item("ac_exterior_moyear").ToString.Trim.Length <= 2 Then
                                htmlOut.Append(Left(Row.Item("ac_exterior_moyear"), 2))
                            ElseIf Row.Item("ac_exterior_moyear").ToString.Trim.Length = 4 Then
                                htmlOut.Append(Right(Row.Item("ac_exterior_moyear"), 4))
                            End If
                        End If

                        htmlOut.Append("</td></tr>")
                        htmlOut.Append("<tr><td colspan='4' valign='top' align='left'>")

                        htmlOut.Append(localFunctions.display_exterior_details_report(Row, CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id").ToString)))

                        htmlOut.Append("</td></tr>")
                        htmlOut.Append("<tr><td colspan='4' valign='top' align='left'>")
                        htmlOut.Append("<b>INT:</b>&nbsp;")

                        If Not IsDBNull(Row.Item("ac_interior_moyear")) Then
                            If Row.Item("ac_interior_moyear").ToString.Trim.Length > 4 Then
                                htmlOut.Append(Left(Row.Item("ac_interior_moyear").ToString.Trim, 2) + "/")
                                htmlOut.Append(Right(Row.Item("ac_interior_moyear").ToString.Trim, 4))
                            ElseIf Row.Item("ac_interior_moyear").ToString.Trim.Length <= 2 Then
                                htmlOut.Append(Left(Row.Item("ac_interior_moyear"), 2))
                            ElseIf Row.Item("ac_interior_moyear").ToString.Trim.Length = 4 Then
                                htmlOut.Append(Right(Row.Item("ac_interior_moyear"), 4))
                            End If
                        End If

                        If Not IsDBNull(Row.Item("ac_passenger_count")) Then
                            htmlOut.Append("&nbsp;&nbsp;&nbsp;<b>PASGR:</b>&nbsp;" + Row.Item("ac_passenger_count").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("&nbsp;&nbsp;&nbsp;<b>PASGR:</b></td>")
                        End If

                        htmlOut.Append("</td></tr>")
                        htmlOut.Append("<tr><td colspan='4' valign='top' align='left'>")

                        htmlOut.Append(localFunctions.display_interior_details_report(Row, CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id").ToString)))

                        htmlOut.Append("<br />")

                        htmlOut.Append(localFunctions.display_equipment_details_report(Row, CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id").ToString)))

                        htmlOut.Append("</td></tr>")

                        htmlOut.Append(IIf(bHtmlReport, "<tr><td colspan='4'><hr height='1'></td></tr>", "<tr><td colspan='4'></td></tr>"))

                        htmlOut.Append("<tr><td colspan='4' valign='top' align='left'>")

                        htmlOut.Append(localFunctions.display_avionics_details_report(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id").ToString)))

                        htmlOut.Append("<br />")

                        htmlOut.Append(localFunctions.display_cockpit_details_report(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id").ToString)))

                        htmlOut.Append("</td></tr>")

                        htmlOut.Append(IIf(bHtmlReport, "<tr><td colspan='4'><br /><br /></td></tr>", "<tr><td colspan='4'></td></tr>"))

                    End If

                Next

                If bHtmlReport Or bExcelReport Then
                    htmlOut.Append("</table>")
                End If

                If bHtmlReport Then
                    htmlOut.Append("</div>")
                    htmlOut.Append("</body>")
                    htmlOut.Append("</html>")
                End If

            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in create_report_50_condensed_spec_jfw_format()" + ex.Message

        Finally
            adoRS_50 = Nothing

            report_50_datatable = Nothing

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOut.ToString

    End Function

#End Region

#Region "report_51_functions"

    Public Function create_report_51_detailed_spec_jfw_format(ByRef record_count As Long) As String

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim report_51_datatable As New DataTable

        Dim adoRS_51 As System.Data.SqlClient.SqlDataReader : adoRS_51 = Nothing

        Dim htmlOut = New StringBuilder()

        Dim sQuery As New StringBuilder()

        Dim lCompOwrId As Long = 0
        Dim lCompSalesId As Long = 0
        Dim lCompChpId As Long = 0
        Dim lCompExcId As Long = 0

        Dim lContactOwrId As Long = 0
        Dim lContactSalesId As Long = 0
        Dim lContactChpId As Long = 0
        Dim lContactExcId As Long = 0

        Try

            SqlConn.ConnectionString = localFunctions.clientConnectStr

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 90

            If HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("comp_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("contact_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("state_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("country_") Then
                sQuery.Append("SELECT DISTINCT ac_id, ac_journ_id, amod_id, amod_airframe_type_code, amod_type_code, amod_make_name, amod_model_name, ac_ser_no_full, ac_ser_no_sort, ac_reg_no, ac_status,")
                sQuery.Append(" ac_asking, ac_asking_price, ac_list_date, ac_purchase_date, ac_upd_date, ac_mfr_year, ac_year, ac_apu_model_name, ac_forsale_flag,")
                sQuery.Append(" ac_aport_iata_code, ac_aport_icao_code, ac_aport_name, ac_aport_city, ac_aport_state, ac_aport_country, ac_apu_tot_hrs,")
                sQuery.Append(" ac_airframe_tot_hrs, ac_airframe_tot_landings, ac_engine_maint_prog_name, ac_passenger_count, ac_engine_name, ac_apu_soh_hrs,")
                sQuery.Append(" ac_engine_1_ser_no, ac_engine_2_ser_no, ac_engine_3_ser_no, ac_engine_4_ser_no, ac_damage_history_notes,")
                sQuery.Append(" ac_engine_1_tot_hrs, ac_engine_2_tot_hrs, ac_engine_3_tot_hrs, ac_engine_4_tot_hrs,ac_apu_ser_no,")
                sQuery.Append(" ac_engine_1_soh_hrs, ac_engine_2_soh_hrs, ac_engine_3_soh_hrs, ac_engine_4_soh_hrs,")
                sQuery.Append(" ac_maint_eoh_by_name, ac_engine_1_shi_hrs, ac_engine_2_shi_hrs, ac_engine_3_shi_hrs, ac_engine_4_shi_hrs,")
                sQuery.Append(" ac_maint_hots_by_name, ac_engine_1_tbo_hrs, ac_engine_2_tbo_hrs, ac_engine_3_tbo_hrs, ac_engine_4_tbo_hrs,")
                sQuery.Append(" ac_engine_1_ser_no, ac_engine_2_ser_no, ac_engine_3_ser_no, ac_engine_4_ser_no,")
                sQuery.Append(" ac_prop_1_ser_no, ac_prop_2_ser_no, ac_prop_3_ser_no, ac_prop_4_ser_no,")
                'sQuery.Append(" ac_engine_1_soh_cycles, ac_engine_2_soh_cycles, ac_engine_3_soh_cycles, ac_engine_4_soh_cycles,")
                sQuery.Append(" ac_maintained, ac_times_as_of_date, ac_exterior_moyear, ac_interior_moyear, ac_lifecycle_stage,")
                sQuery.Append(" amp_provider_name, amp_program_name, emp_provider_name, emp_program_name")
                sQuery.Append(" FROM View_Aircraft_Company_Flat WITH(NOLOCK) ")
            Else
                sQuery.Append("SELECT DISTINCT ac_id, ac_journ_id, amod_id, amod_airframe_type_code, amod_type_code, amod_make_name, amod_model_name, ac_ser_no_full, ac_ser_no_sort, ac_reg_no, ac_status,")
                sQuery.Append(" ac_asking, ac_asking_price, ac_list_date, ac_purchase_date, ac_upd_date, ac_mfr_year, ac_year, ac_apu_model_name, ac_forsale_flag,")
                sQuery.Append(" ac_aport_iata_code, ac_aport_icao_code, ac_aport_name, ac_aport_city, ac_aport_state, ac_aport_country, ac_apu_tot_hrs,")
                sQuery.Append(" ac_airframe_tot_hrs, ac_airframe_tot_landings, ac_engine_maint_prog_name, ac_passenger_count, ac_engine_name, ac_apu_soh_hrs,")
                sQuery.Append(" ac_engine_1_ser_no, ac_engine_2_ser_no, ac_engine_3_ser_no, ac_engine_4_ser_no, ac_damage_history_notes,")
                sQuery.Append(" ac_engine_1_tot_hrs, ac_engine_2_tot_hrs, ac_engine_3_tot_hrs, ac_engine_4_tot_hrs,ac_apu_ser_no,")
                sQuery.Append(" ac_engine_1_soh_hrs, ac_engine_2_soh_hrs, ac_engine_3_soh_hrs, ac_engine_4_soh_hrs,")
                sQuery.Append(" ac_maint_eoh_by_name, ac_engine_1_shi_hrs, ac_engine_2_shi_hrs, ac_engine_3_shi_hrs, ac_engine_4_shi_hrs,")
                sQuery.Append(" ac_maint_hots_by_name, ac_engine_1_tbo_hrs, ac_engine_2_tbo_hrs, ac_engine_3_tbo_hrs, ac_engine_4_tbo_hrs,")
                sQuery.Append(" ac_engine_1_ser_no, ac_engine_2_ser_no, ac_engine_3_ser_no, ac_engine_4_ser_no,")
                sQuery.Append(" ac_prop_1_ser_no, ac_prop_2_ser_no, ac_prop_3_ser_no, ac_prop_4_ser_no,")
                'sQuery.Append(" ac_engine_1_soh_cycles, ac_engine_2_soh_cycles, ac_engine_3_soh_cycles, ac_engine_4_soh_cycles,")
                sQuery.Append(" ac_maintained, ac_times_as_of_date, ac_exterior_moyear, ac_interior_moyear, ac_lifecycle_stage,")
                sQuery.Append(" amp_provider_name, amp_program_name, emp_provider_name, emp_program_name")
                sQuery.Append(" FROM View_Aircraft_Flat WITH(NOLOCK) ")
            End If

            sQuery.Append(HttpContext.Current.Session.Item("MasterAircraftWhere").ToString)

            sQuery.Append(" ORDER BY amod_make_name, amod_airframe_type_code, amod_type_code, amod_id, amod_model_name, ac_ser_no_sort")

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />create_report_50_condensed_spec_jfw_format()<br />" + sQuery.ToString

            If bHtmlReport Then
                htmlOut.Append("<!DOCTYPE html>")
                htmlOut.Append("<html lang='en'>")
                htmlOut.Append("<head>")
                htmlOut.Append("<meta http-equiv='Content-Language' content='en-us' />")
                htmlOut.Append("<meta http-equiv='Content-Type' content='text/html; charset=windows-1252' />")
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='common/jetnet.css' />")
                htmlOut.Append("<title>JETNET - Detailed Spec - JFW Format</title>")
                htmlOut.Append("</head>")
                htmlOut.Append("<body style='background: white; margin-top:10px; margin-left:10px; font-size: 11px;'>")
                htmlOut.Append("<div style='text-align:center;'>")
            End If

            If bExcelReport Then
                htmlOut.Append(localFunctions.include_excel_report_style() + vbCrLf)
                htmlOut.Append("<table border='1' cellpadding='2' cellspacing='0'>")
            ElseIf bHtmlReport Then
                htmlOut.Append("<table class='centerTable' border='0' cellpadding='2' cellspacing='0' width='100%'>")
            End If

            SqlCommand.CommandText = sQuery.ToString
            adoRS_51 = SqlCommand.ExecuteReader()

            Try
                report_51_datatable.Load(adoRS_51)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = report_51_datatable.GetErrors()
            End Try

            adoRS_51.Close()
            adoRS_51 = Nothing

            record_count = report_51_datatable.Rows.Count

            If report_51_datatable.Rows.Count > 0 Then

                Dim tstCount As Long = 0
                Dim rememberExcelReport As Boolean = False

                For Each Row As DataRow In report_51_datatable.Rows

                    tstCount += 1

                    If bExcelReport Or bHtmlReport Then

                        htmlOut.Append("<tr><td valign='top' align='left' nowrap='nowrap' colspan='2'><b>MAKE:</b>&nbsp;" + Row.Item("amod_make_name").ToString.Trim + "</td>") ' first row
                        htmlOut.Append("<td valign='top' align='left' width='20%' nowrap='nowrap'><b>ASKING AMT(USD):</b>&nbsp;")

                        If Not bAerodexFlag Then
                            If Not IsDBNull(Row.Item("ac_asking_price")) Then
                                If Row.Item("ac_asking").ToString.ToLower.Contains("price") Then
                                    If Not IsDBNull(Row.Item("ac_asking_price")) Then
                                        If CDbl(Row.Item("ac_asking_price").ToString) > 0 Then
                                            htmlOut.Append("$" + FormatNumber(CDbl(Row.Item("ac_asking_price").ToString), 0, False, False, True).ToString)
                                        End If
                                    End If
                                Else
                                    If Not IsDBNull(Row.Item("ac_asking")) Then
                                        htmlOut.Append(Row.Item("ac_asking").ToString.Trim)
                                    End If
                                End If
                            Else
                                If Not IsDBNull(Row.Item("ac_asking")) Then
                                    htmlOut.Append(Row.Item("ac_asking").ToString.Trim)
                                End If
                            End If
                        End If

                        htmlOut.Append("</td>")

                        htmlOut.Append("<td valign='top' align='left' nowrap='nowrap'><b>REP PURCHSD:</b>&nbsp;")

                        If Not IsDBNull(Row.Item("ac_purchase_date")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_purchase_date").ToString.Trim) Then
                                If IsDate(Row.Item("ac_purchase_date").ToString) Then
                                    htmlOut.Append(FormatDateTime(Row.Item("ac_purchase_date").ToString, DateFormat.ShortDate).Trim)
                                Else
                                    htmlOut.Append(Row.Item("ac_purchase_date").ToString.Trim)
                                End If
                            End If
                        End If

                        htmlOut.Append("</td>")

                        htmlOut.Append("</tr><tr>") ' second row  

                        htmlOut.Append("<td valign='top' align='left' width='20%' nowrap='nowrap'><b>MODEL:</b>&nbsp;" + Row.Item("amod_model_name").ToString.Trim + "</td>")
                        htmlOut.Append("<td valign='top' align='left' width='25%' nowrap='nowrap'><b>YR DLV:</b>&nbsp;" + Row.Item("ac_year").ToString.Trim + "</td>")

                        htmlOut.Append("<td valign='top' align='left' nowrap='nowrap'><b>STATUS:</b>&nbsp;")

                        If Not bAerodexFlag Then
                            If Not IsDBNull(Row.Item("ac_status")) Then
                                If Not String.IsNullOrEmpty(Row.Item("ac_status").ToString.Trim) Then
                                    htmlOut.Append(Row.Item("ac_status").ToString.Trim)
                                End If
                            End If
                        End If

                        htmlOut.Append("</td><td valign='top' align='left' nowrap='nowrap'><b>DATE EDITED:</b>&nbsp;" + FormatDateTime(Row.Item("ac_upd_date").ToString, DateFormat.ShortDate).Trim + "</td>")

                        htmlOut.Append("</tr><tr>") ' third 
                        htmlOut.Append("<td valign='top' align='left' nowrap='nowrap'><b>SER #:</b>&nbsp;" + Row.Item("ac_ser_no_full").ToString.Trim + "</td>")
                        htmlOut.Append("<td valign='top' align='left' nowrap='nowrap'><b>YR MFT:</b>&nbsp;" + Row.Item("ac_mfr_year").ToString.Trim + "</td>")
                        htmlOut.Append("<td valign='top' align='left' nowrap='nowrap'><b>FOR SALE(Y/N):</b>&nbsp;" + Row.Item("ac_forsale_flag").ToString.ToUpper.Trim + "</td>")
                        htmlOut.Append("<td valign='top' align='left' nowrap='nowrap'><b>DATE LISTED:</b>&nbsp;")

                        If Not IsDBNull(Row.Item("ac_list_date")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_list_date").ToString.Trim) Then
                                If IsDate(Row.Item("ac_list_date").ToString.Trim) Then
                                    htmlOut.Append(FormatDateTime(Row.Item("ac_list_date").ToString, DateFormat.ShortDate).Trim)
                                End If
                            End If
                        End If

                        htmlOut.Append("</td></tr><tr>") ' fourth row
                        htmlOut.Append("<td valign='top' align='left' nowrap='nowrap' colspan='2'><b>REG #:</b>&nbsp;" + Row.Item("ac_reg_no").ToString.Trim + "</td>") ' first row  IIf(Not String.IsNullOrEmpty(Row.Item("ac_list_date").ToString.Trim), FormatDateTime(Row.Item("ac_list_date").ToString, DateFormat.ShortDate).Trim, "")
                        htmlOut.Append("<td valign='top' align='left' nowrap='nowrap'><b>MAINTAINED:</b>&nbsp;" + Row.Item("ac_maintained").ToString.Trim + "</td>")
                        htmlOut.Append("<td valign='top' align='left' nowrap='nowrap'><b>FOLLOW UP:</b>&nbsp;N/A</td>")

                        htmlOut.Append("</tr>")
                        htmlOut.Append(IIf(bHtmlReport, "<tr><td colspan='4'><hr height='1'></td></tr>", "<tr><td colspan='4'></td></tr>"))

                        lCompOwrId = 0
                        lCompSalesId = 0
                        lCompChpId = 0
                        lCompExcId = 0

                        lContactOwrId = 0
                        lContactSalesId = 0
                        lContactChpId = 0
                        lContactExcId = 0

                        Dim report_51_ref_datatable As DataTable = Nothing

                        If bExcelReport Then
                            rememberExcelReport = bExcelReport
                            bExcelReport = False
                            bHtmlReport = True
                        End If

                        ' owner IIf(bHtmlReport, "<tr><td colspan='4'><hr height='1'></td></tr>", "<tr><td colspan='4'></td></tr>")
                        htmlOut.Append("<tr><td valign='top' align='left' nowrap='nowrap' colspan='2' width='50%'><b>REG AS/</b>")
                        htmlOut.Append(get_company_contact_info_report_8(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id")), "OWR", report_51_ref_datatable, lCompOwrId, lContactOwrId))

                        ' sales
                        htmlOut.Append("</td><td valign='top' align='left' nowrap='nowrap' colspan='2'><b>SALES COMPANY/CONTACT:</b><br />")
                        htmlOut.Append(get_company_contact_info_report_8(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id")), "SLS", report_51_ref_datatable, lCompSalesId, lContactSalesId))

                        ' acbase
                        htmlOut.Append("</td></tr><tr><td valign='top' align='left' nowrap='nowrap' colspan='2'><b>AC BASE:</b><br />")
                        Dim sSeparator As String = ""

                        If Not IsDBNull(Row.Item("ac_aport_iata_code")) And Not String.IsNullOrEmpty(Row.Item("ac_aport_iata_code").ToString.Trim) Then
                            htmlOut.Append(Row.Item("ac_aport_iata_code").ToString.Trim)
                            sSeparator = " - "
                        End If

                        If Not IsDBNull(Row.Item("ac_aport_icao_code")) And Not String.IsNullOrEmpty(Row.Item("ac_aport_icao_code").ToString.Trim) Then
                            htmlOut.Append(sSeparator + Row.Item("ac_aport_icao_code").ToString.Trim)
                            sSeparator = " - "
                        End If

                        If Not IsDBNull(Row.Item("ac_aport_name")) And Not String.IsNullOrEmpty(Row.Item("ac_aport_name").ToString.Trim) Then
                            htmlOut.Append(sSeparator + Row.Item("ac_aport_name").ToString.Trim)
                        End If

                        If Not String.IsNullOrEmpty(sSeparator) Then
                            htmlOut.Append("<br />")
                        End If

                        If Not IsDBNull(Row.Item("ac_aport_city")) And Not String.IsNullOrEmpty(Row.Item("ac_aport_city").ToString.Trim) Then
                            htmlOut.Append(Row.Item("ac_aport_city").ToString.Trim)
                            sSeparator = ", "
                        End If

                        If Not IsDBNull(Row.Item("ac_aport_state")) And Not String.IsNullOrEmpty(Row.Item("ac_aport_state").ToString.Trim) Then
                            htmlOut.Append(sSeparator + Row.Item("ac_aport_state").ToString.Trim)
                            sSeparator = Constants.cSingleSpace
                        End If

                        If Not IsDBNull(Row.Item("ac_aport_country")) And Not String.IsNullOrEmpty(Row.Item("ac_aport_country").ToString.Trim) Then
                            htmlOut.Append(sSeparator + Row.Item("ac_aport_country").ToString.Trim)
                        End If

                        ' CHIEF PILOT
                        htmlOut.Append("</td><td valign='top' align='left' nowrap='nowrap' colspan='2'><b>CHIEF PILOT:</b><br />")
                        htmlOut.Append(get_company_contact_info_report_8(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id")), "CHP", report_51_ref_datatable, lCompChpId, lContactChpId))

                        ' broker 1
                        htmlOut.Append("</td></tr><tr><td valign='top' align='left' nowrap='nowrap' colspan='2'><b>EXCLUSIVE BROKER:</b><br />")
                        If Not bAerodexFlag Then
                            htmlOut.Append(get_company_contact_info_report_8(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id")), "EXC", report_51_ref_datatable, lCompExcId, lContactExcId))
                        End If

                        ' broker 2
                        htmlOut.Append("</td><td valign='top' align='left' nowrap='nowrap' colspan='2'><b>EXCLUSIVE BROKER:</b><br />")

                        If Not bAerodexFlag Then
                            htmlOut.Append(get_company_contact_info_report_8(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id")), "EXC", report_51_ref_datatable, lCompExcId, lContactExcId, True))
                        End If

                        htmlOut.Append("</td></tr>")

                        report_51_ref_datatable = Nothing

                        If rememberExcelReport Then
                            bExcelReport = rememberExcelReport
                            bHtmlReport = False
                        End If

                        htmlOut.Append(IIf(bHtmlReport, "<tr><td><hr height='1'></td>", "<tr><td></td>"))

                        If Not IsDBNull(Row.Item("ac_times_as_of_date")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_times_as_of_date").ToString.Trim) Then
                                htmlOut.Append("<td valign='top' align='center'><b>Times Current:</b>&nbsp;" + FormatDateTime(Row.Item("ac_times_as_of_date").ToString, DateFormat.ShortDate) + "</td>")
                            Else
                                htmlOut.Append("<td></td>")
                            End If
                        Else
                            htmlOut.Append("<td></td>")
                        End If

                        htmlOut.Append(IIf(bHtmlReport, "<td colspan='2'><hr height='1'></td></tr>", "<td colspan='2'></td></tr>"))

                        htmlOut.Append("<tr><td colspan='4' valign='top' align='left'>")

                        htmlOut.Append("<table" + IIf(bHtmlReport, " class='centerTable' width='100%'", "") + " border='0' cellpadding='2' cellspacing='0'>") '  times current table

                        htmlOut.Append("<tr><td width='10%' valign='top' align='left'><b>ENG TT:</b></td>")

                        htmlOut.Append("<td width='8%' valign='top' align='left'>" + Row.Item("ac_engine_1_tot_hrs").ToString.Trim + "</td>")
                        htmlOut.Append("<td width='8%' valign='top' align='left'>" + Row.Item("ac_engine_2_tot_hrs").ToString.Trim + "</td>")
                        htmlOut.Append("<td width='8%' valign='top' align='left'>" + Row.Item("ac_engine_3_tot_hrs").ToString.Trim + "</td>")
                        htmlOut.Append("<td width='8%' valign='top' align='left'>" + Row.Item("ac_engine_4_tot_hrs").ToString.Trim + "</td>")

                        If Not IsDBNull(Row.Item("ac_airframe_tot_hrs")) Then
                            htmlOut.Append("<td valign='top' align='left' nowrap='nowrap'><b>AIRFRM&nbsp;TT:</b>&nbsp;" + Row.Item("ac_airframe_tot_hrs").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td valign='top' align='left' nowrap='nowrap'><b>AIRFRM&nbsp;TT:</b></td>")
                        End If

                        If Not IsDBNull(Row.Item("ac_airframe_tot_landings")) Then
                            htmlOut.Append("<td valign='top' align='left' nowrap='nowrap'><b>LANDINGS:</b>&nbsp;" + Row.Item("ac_airframe_tot_landings").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td valign='top' align='left' nowrap='nowrap'><b>LANDINGS:</b></td>")
                        End If

                        htmlOut.Append("</tr><tr><td valign='top' align='left'><b>SMOH/CORE:</b></td>")

                        htmlOut.Append("<td valign='top' align='left'>" + Row.Item("ac_engine_1_soh_hrs").ToString.Trim + "</td>")
                        htmlOut.Append("<td valign='top' align='left'>" + Row.Item("ac_engine_2_soh_hrs").ToString.Trim + "</td>")
                        htmlOut.Append("<td valign='top' align='left'>" + Row.Item("ac_engine_3_soh_hrs").ToString.Trim + "</td>")
                        htmlOut.Append("<td valign='top' align='left'>" + Row.Item("ac_engine_4_soh_hrs").ToString.Trim + "</td>")

                        If Not IsDBNull(Row.Item("ac_engine_name")) Then
                            htmlOut.Append("<td valign='top' align='left' colspan='2'><b>ENG MODEL:</b>&nbsp;" + Row.Item("ac_engine_name").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td valign='top' align='left' colspan='2'><b>ENG MODEL:</b></td>")
                        End If

                        htmlOut.Append("</tr><tr><td valign='top' align='left'><b>SHOT/MPI:</b></td>")

                        htmlOut.Append("<td valign='top' align='left'>" + Row.Item("ac_engine_1_shi_hrs").ToString.Trim + "</td>")
                        htmlOut.Append("<td valign='top' align='left'>" + Row.Item("ac_engine_2_shi_hrs").ToString.Trim + "</td>")
                        htmlOut.Append("<td valign='top' align='left'>" + Row.Item("ac_engine_3_shi_hrs").ToString.Trim + "</td>")
                        htmlOut.Append("<td valign='top' align='left'>" + Row.Item("ac_engine_4_shi_hrs").ToString.Trim + "</td>")
                        htmlOut.Append("<td valign='top' align='left' colspan='2'></td></tr>")

                        htmlOut.Append("<tr><td valign='top' align='left'><b>TBO:</b></td>")
                        htmlOut.Append("<td valign='top' align='left'>" + Row.Item("ac_engine_1_tbo_hrs").ToString.Trim + "</td>")
                        htmlOut.Append("<td valign='top' align='left'>" + Row.Item("ac_engine_2_tbo_hrs").ToString.Trim + "</td>")
                        htmlOut.Append("<td valign='top' align='left'>" + Row.Item("ac_engine_3_tbo_hrs").ToString.Trim + "</td>")
                        htmlOut.Append("<td valign='top' align='left'>" + Row.Item("ac_engine_4_tbo_hrs").ToString.Trim + "</td>")
                        htmlOut.Append("<td colspan='2'><b>ENG SER#:</b>")
                        htmlOut.Append(IIf(Not String.IsNullOrEmpty(Row.Item("ac_engine_1_ser_no").ToString.Trim), Row.Item("ac_engine_1_ser_no").ToString.Trim + "&nbsp;", ""))
                        htmlOut.Append(IIf(Not String.IsNullOrEmpty(Row.Item("ac_engine_2_ser_no").ToString.Trim), Row.Item("ac_engine_2_ser_no").ToString.Trim + "&nbsp;", ""))
                        htmlOut.Append(IIf(Not String.IsNullOrEmpty(Row.Item("ac_engine_3_ser_no").ToString.Trim), Row.Item("ac_engine_3_ser_no").ToString.Trim + "&nbsp;", ""))
                        htmlOut.Append(IIf(Not String.IsNullOrEmpty(Row.Item("ac_engine_4_ser_no").ToString.Trim), Row.Item("ac_engine_4_ser_no").ToString.Trim, ""))
                        htmlOut.Append("</td>")

                        htmlOut.Append("</tr><tr><td valign='top' align='left'><b>SPOH:</b></td>")

                        htmlOut.Append("<td valign='top' align='left'></td>") ' + Row.Item("ac_engine_1_soh_cycles").ToString.Trim + "</td>")
                        htmlOut.Append("<td valign='top' align='left'></td>") ' + Row.Item("ac_engine_2_soh_cycles").ToString.Trim + "</td>")
                        htmlOut.Append("<td valign='top' align='left'></td>") ' + Row.Item("ac_engine_3_soh_cycles").ToString.Trim + "</td>")
                        htmlOut.Append("<td valign='top' align='left'></td>") ' + Row.Item("ac_engine_4_soh_cycles").ToString.Trim + "</td>")
                        htmlOut.Append("<td colspan='2'><b>PROPSER#:</b>")
                        htmlOut.Append(IIf(Not String.IsNullOrEmpty(Row.Item("ac_prop_1_ser_no").ToString.Trim), Row.Item("ac_prop_1_ser_no").ToString.Trim + "&nbsp;", ""))
                        htmlOut.Append(IIf(Not String.IsNullOrEmpty(Row.Item("ac_prop_2_ser_no").ToString.Trim), Row.Item("ac_prop_2_ser_no").ToString.Trim + "&nbsp;", ""))
                        htmlOut.Append(IIf(Not String.IsNullOrEmpty(Row.Item("ac_prop_3_ser_no").ToString.Trim), Row.Item("ac_prop_3_ser_no").ToString.Trim + "&nbsp;", ""))
                        htmlOut.Append(IIf(Not String.IsNullOrEmpty(Row.Item("ac_prop_4_ser_no").ToString.Trim), Row.Item("ac_prop_4_ser_no").ToString.Trim, ""))
                        htmlOut.Append("</td>")

                        htmlOut.Append("</tr><tr><td valign='top' align='left' colspan='2'><b>APU/APUS#:</b>")

                        Dim bHasAPUModelName As Boolean = False

                        If Not IsDBNull(Row.Item("ac_apu_model_name")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_apu_model_name").ToString) Then
                                htmlOut.Append(Row.Item("ac_apu_model_name").ToString)
                                bHasAPUModelName = True
                            End If
                        End If

                        If Not IsDBNull(Row.Item("ac_apu_ser_no")) Then
                            If Not String.IsNullOrEmpty(Row.Item("ac_apu_ser_no").ToString) Then
                                htmlOut.Append(IIf(bHasAPUModelName, Constants.cSingleForwardSlash, "") + Row.Item("ac_apu_ser_no").ToString)
                            End If
                        End If

                        htmlOut.Append("</td><td valign='top' align='left' colspan='3'></td>")
                        htmlOut.Append("<td valign='top' align='left' colspan='2' width='35%'><b>FEATURES:</b>")

                        Dim sAcFeatureCodes As String = ""
                        localFunctions.get_all_ac_feature_codes(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id").ToString), sAcFeatureCodes, True)
                        htmlOut.Append(sAcFeatureCodes)

                        htmlOut.Append("</td></tr><tr><td valign='top' align='left' colspan='2'><b>APU TTSN:</b>")

                        If Not IsDBNull(Row.Item("ac_apu_tot_hrs")) And Not String.IsNullOrEmpty(Row.Item("ac_apu_tot_hrs").ToString) Then
                            htmlOut.Append(FormatNumber(CDbl(Row.Item("ac_apu_tot_hrs").ToString), 0, True, False, True))
                        End If

                        htmlOut.Append("</td><td valign='top' align='left' colspan='2'><b>APU SOH:</b>")

                        If Not IsDBNull(Row.Item("ac_apu_soh_hrs")) And Not String.IsNullOrEmpty(Row.Item("ac_apu_soh_hrs").ToString) Then
                            htmlOut.Append(FormatNumber(CDbl(Row.Item("ac_apu_soh_hrs").ToString), 0, True, False, True))
                        End If

                        htmlOut.Append("</td><td valign='top' align='left' colspan='3'></td>")

                        htmlOut.Append("</tr><tr><td valign='top' align='left' colspan='3'><b>MX PROG:</b>")

                        If Not IsDBNull(Row.Item("amp_provider_name")) Then
                            htmlOut.Append(Row.Item("amp_provider_name").ToString.Trim)
                        End If

                        If Not IsDBNull(Row.Item("amp_program_name")) Then
                            If Not IsDBNull(Row.Item("amp_provider_name")) Then htmlOut.Append(" ")

                            htmlOut.Append(Row.Item("amp_program_name").ToString.Trim)
                        End If

                        htmlOut.Append("</td>")

                        If Not IsDBNull(Row.Item("ac_maint_eoh_by_name")) Then
                            htmlOut.Append("<td valign='top' align='left' colspan='2'><b>ENG OH:</b>" + Row.Item("ac_maint_eoh_by_name").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td valign='top' align='left' colspan='2'><b>ENG OH:</b></td>")
                        End If

                        If Not IsDBNull(Row.Item("ac_maint_hots_by_name")) Then
                            htmlOut.Append("<td valign='top' align='left' colspan='2'><b>HOTS:</b>" + Row.Item("ac_maint_hots_by_name").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("<td valign='top' align='left' colspan='2'><b>HOTS:</b></td>")
                        End If


                        htmlOut.Append("</tr>")

                        htmlOut.Append("</table>") ' times current table 
                        htmlOut.Append("</tr>")

                        htmlOut.Append(IIf(bHtmlReport, "<tr><td colspan='4'><hr height='1'></td></tr>", "<tr><td colspan='4'></td></tr>"))

                        htmlOut.Append("<tr><td colspan='4' valign='top' align='left'>")

                        htmlOut.Append(localFunctions.display_maintenance_details_report(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id").ToString)))

                        htmlOut.Append("</td></tr>")

                        htmlOut.Append("<tr><td colspan='4' valign='top' align='left'><b>Damage History:</b>&nbsp;")

                        If Not IsDBNull(Row.Item("ac_damage_history_notes")) And Not String.IsNullOrEmpty(Row.Item("ac_damage_history_notes").ToString) Then
                            htmlOut.Append(Row.Item("ac_damage_history_notes").ToString.Trim)
                        End If

                        htmlOut.Append("</td></tr>")

                        htmlOut.Append("<tr><td colspan='4' valign='top' align='left'><b>Define:</b>&nbsp;</td></tr>")
                        htmlOut.Append("<tr><td colspan='4' valign='top' align='left'>")
                        htmlOut.Append("<b>EXT:</b>&nbsp;")

                        If Not IsDBNull(Row.Item("ac_exterior_moyear")) Then
                            If Row.Item("ac_exterior_moyear").ToString.Trim.Length > 4 Then
                                htmlOut.Append(Left(Row.Item("ac_exterior_moyear").ToString.Trim, 2) + "/")
                                htmlOut.Append(Right(Row.Item("ac_exterior_moyear").ToString.Trim, 4))
                            ElseIf Row.Item("ac_exterior_moyear").ToString.Trim.Length <= 2 Then
                                htmlOut.Append(Left(Row.Item("ac_exterior_moyear"), 2))
                            ElseIf Row.Item("ac_exterior_moyear").ToString.Trim.Length = 4 Then
                                htmlOut.Append(Right(Row.Item("ac_exterior_moyear"), 4))
                            End If
                        End If

                        htmlOut.Append("</td></tr>")
                        htmlOut.Append("<tr><td colspan='4' valign='top' align='left'>")

                        htmlOut.Append(localFunctions.display_exterior_details_report(Row, CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id").ToString)))

                        htmlOut.Append("</td></tr>")
                        htmlOut.Append("<tr><td colspan='4' valign='top' align='left'>")
                        htmlOut.Append("<b>INT:</b>&nbsp;")

                        If Not IsDBNull(Row.Item("ac_interior_moyear")) Then
                            If Row.Item("ac_interior_moyear").ToString.Trim.Length > 4 Then
                                htmlOut.Append(Left(Row.Item("ac_interior_moyear").ToString.Trim, 2) + "/")
                                htmlOut.Append(Right(Row.Item("ac_interior_moyear").ToString.Trim, 4))
                            ElseIf Row.Item("ac_interior_moyear").ToString.Trim.Length <= 2 Then
                                htmlOut.Append(Left(Row.Item("ac_interior_moyear"), 2))
                            ElseIf Row.Item("ac_interior_moyear").ToString.Trim.Length = 4 Then
                                htmlOut.Append(Right(Row.Item("ac_interior_moyear"), 4))
                            End If
                        End If

                        If Not IsDBNull(Row.Item("ac_passenger_count")) Then
                            htmlOut.Append("&nbsp;&nbsp;&nbsp;<b>PASGR:</b>&nbsp;" + Row.Item("ac_passenger_count").ToString.Trim + "</td>")
                        Else
                            htmlOut.Append("&nbsp;&nbsp;&nbsp;<b>PASGR:</b></td>")
                        End If

                        htmlOut.Append("</td></tr>")
                        htmlOut.Append("<tr><td colspan='4' valign='top' align='left'>")

                        htmlOut.Append(localFunctions.display_interior_details_report(Row, CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id").ToString)))

                        htmlOut.Append("<br />")

                        htmlOut.Append(localFunctions.display_equipment_details_report(Row, CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id").ToString)))

                        htmlOut.Append("</td></tr>")

                        htmlOut.Append(IIf(bHtmlReport, "<tr><td colspan='4'><hr height='1'></td></tr>", "<tr><td colspan='4'></td></tr>"))

                        htmlOut.Append("<tr><td colspan='4' valign='top' align='left'>")

                        htmlOut.Append(localFunctions.display_avionics_details_report(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id").ToString)))

                        htmlOut.Append("<br />")

                        htmlOut.Append(localFunctions.display_cockpit_details_report(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("ac_journ_id").ToString)))

                        htmlOut.Append("</td></tr>")

                        htmlOut.Append(IIf(bHtmlReport, "<tr><td colspan='4'><br /><br /></td></tr>", "<tr><td colspan='4'></td></tr>"))

                    End If

                Next

                If bHtmlReport Or bExcelReport Then
                    htmlOut.Append("</table>")
                End If

                If bHtmlReport Then
                    htmlOut.Append("</div>")
                    htmlOut.Append("</body>")
                    htmlOut.Append("</html>")
                End If

            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in create_report_51_detailed_spec_jfw_format()" + ex.Message

        Finally
            adoRS_51 = Nothing

            report_51_datatable = Nothing

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOut.ToString

    End Function

#End Region

#Region "report_52_functions"

    Public Function create_report_52_aircraft_seller_purchaser_history_with_fractional(ByRef record_count As Long) As String

        Dim ACInfo1 As String = ""

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand

        Dim report_52_datatable As New DataTable
        Dim adoRS_52 As System.Data.SqlClient.SqlDataReader : adoRS_52 = Nothing

        Dim sQuery As New StringBuilder()
        Dim htmlOut = New StringBuilder()

        Dim nRememberJournID As Long = 0

        Try

            SqlConn.ConnectionString = localFunctions.clientConnectStr

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 90

            If HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("comp_") Or
       HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("contact_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("state_") Or
         HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.ToLower.Contains("country_") Then
                sQuery.Append("SELECT DISTINCT * FROM View_Aircraft_Company_History_Flat WITH(NOLOCK) ")
            Else
                sQuery.Append("SELECT DISTINCT * FROM View_Aircraft_History_Flat WITH(NOLOCK) ")
            End If

            sQuery.Append(" " + HttpContext.Current.Session.Item("MasterAircraftWhere").ToString.Trim)
            sQuery.Append(" ORDER BY ac_ser_no_sort, journ_date DESC, journ_id DESC")

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />create_report_52_aircraft_seller_purchaser_history_with_fractional()<br />" + sQuery.ToString

            If bHtmlReport Then
                htmlOut.Append("<!DOCTYPE html>")
                htmlOut.Append("<html lang='en'>")
                htmlOut.Append("<head>")
                htmlOut.Append("<meta http-equiv='Content-Language' content='en-us' />")
                htmlOut.Append("<meta http-equiv='Content-Type' content='text/html; charset=windows-1252' />")
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='common/jetnet.css' />")
                htmlOut.Append("<title>JETNET - Seller/Purchaser Report</title>")
                htmlOut.Append("</head>")
                htmlOut.Append("<body style='background: white; margin-top:10px; margin-left:10px;'>")
                htmlOut.Append("<div style='text-align:center;'>")
            End If

            If bExcelReport Then
                htmlOut.Append(localFunctions.include_excel_report_style() + vbCrLf)
                htmlOut.Append("<table border='1' cellpadding='2' cellspacing='0'>")
            ElseIf bHtmlReport Then
                htmlOut.Append("<table class='centerTable' border='0' cellpadding='2' cellspacing='0' width='100%'>")
            End If

            SqlCommand.CommandText = sQuery.ToString
            adoRS_52 = SqlCommand.ExecuteReader()

            Try
                report_52_datatable.Load(adoRS_52)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = report_52_datatable.GetErrors()
            End Try

            adoRS_52.Close()

            record_count = report_52_datatable.Rows.Count

            If report_52_datatable.Rows.Count > 0 Then

                If chkShowReportHeader.Checked Then

                    If bExcelReport Or bHtmlReport Then

                        htmlOut.Append("<tr bgcolor='#CCCCCC'>")

                        htmlOut.Append("<td>MAKE</td>")
                        htmlOut.Append("<td>MODEL</td>")
                        htmlOut.Append("<td>SERIALNBR</td>")
                        htmlOut.Append("<td>REGNBR</td>")

                        htmlOut.Append("<td>SELLERCOMPANY</td>")
                        htmlOut.Append("<td>SELLERCOMPALTNAME</td>")
                        htmlOut.Append("<td>SELLERCOMPBUSTYPE</td>")
                        htmlOut.Append("<td>SELLERCOMPEMAIL</td>")
                        htmlOut.Append("<td>SELLERCOMPWEBADDRESS</td>")
                        htmlOut.Append("<td>SELLERCOMPADDRESS1</td>")
                        htmlOut.Append("<td>SELLERCOMPADDRESS2</td>")
                        htmlOut.Append("<td>SELLERCOMPCITY</td>")
                        htmlOut.Append("<td>SELLERCOMPSTATE</td>")
                        htmlOut.Append("<td>SELLERCOMPSTATEABBR</td>")
                        htmlOut.Append("<td>SELLERCOMPPOSTALCODE</td>")
                        htmlOut.Append("<td>SELLERCOMPCOUNTRY</td>")
                        htmlOut.Append("<td>SELLERCOMPOFFICE</td>")
                        htmlOut.Append("<td>SELLERCOMPFAX</td>")
                        htmlOut.Append("<td>SELLERCOMPMOBILE</td>")
                        htmlOut.Append("<td>SELLERCONTACTPREFIX</td>")
                        htmlOut.Append("<td>SELLERCONTACTFIRSTNAME</td>")
                        htmlOut.Append("<td>SELLERCONTACTMI</td>")
                        htmlOut.Append("<td>SELLERCONTACTLASTNAME</td>")
                        htmlOut.Append("<td>SELLERCONTACTSUFFIX</td>")
                        htmlOut.Append("<td>SELLERCONTACTTITLE</td>")
                        htmlOut.Append("<td>SELLERCONTACTEMAIL</td>")
                        htmlOut.Append("<td>SELLERCONTACTOFFICE</td>")
                        htmlOut.Append("<td>SELLERCONTACTFAX</td>")
                        htmlOut.Append("<td>SELLERCONTACTMOBILE</td>")

                        htmlOut.Append("<td>PURCHASERCOMPANY</td>")
                        htmlOut.Append("<td>PURCHASERCOMPALTNAME</td>")
                        htmlOut.Append("<td>PURCHASERCOMPBUSTYPE</td>")
                        htmlOut.Append("<td>PURCHASERCOMPEMAIL</td>")
                        htmlOut.Append("<td>PURCHASERCOMPWEBADDRESS</td>")
                        htmlOut.Append("<td>PURCHASERCOMPADDRESS1</td>")
                        htmlOut.Append("<td>PURCHASERCOMPADDRESS2</td>")
                        htmlOut.Append("<td>PURCHASERCOMPCITY</td>")
                        htmlOut.Append("<td>PURCHASERCOMPSTATE</td>")
                        htmlOut.Append("<td>PURCHASERCOMPSTATEABBR</td>")
                        htmlOut.Append("<td>PURCHASERCOMPPOSTALCODE</td>")
                        htmlOut.Append("<td>PURCHASERCOMPCOUNTRY</td>")
                        htmlOut.Append("<td>PURCHASERCOMPOFFICE</td>")
                        htmlOut.Append("<td>PURCHASERCOMPFAX</td>")
                        htmlOut.Append("<td>PURCHASERCOMPMOBILE</td>")
                        htmlOut.Append("<td>PURCHASERCONTACTPREFIX</td>")
                        htmlOut.Append("<td>PURCHASERCONTACTFIRSTNAME</td>")
                        htmlOut.Append("<td>PURCHASERCONTACTMI</td>")
                        htmlOut.Append("<td>PURCHASERCONTACTLASTNAME</td>")
                        htmlOut.Append("<td>PURCHASERCONTACTSUFFIX</td>")
                        htmlOut.Append("<td>PURCHASERCONTACTTITLE</td>")
                        htmlOut.Append("<td>PURCHASERCONTACTEMAIL</td>")
                        htmlOut.Append("<td>PURCHASERCONTACTOFFICE</td>")
                        htmlOut.Append("<td>PURCHASERCONTACTFAX</td>")
                        htmlOut.Append("<td>PURCHASERCONTACTMOBILE</td>")

                        htmlOut.Append("<td>YEARMFG</td>")
                        htmlOut.Append("<td>YEARDLV</td>")
                        htmlOut.Append("<td>BASEIATA</td>")
                        htmlOut.Append("<td>BASEICAO</td>")
                        htmlOut.Append("<td>BASENAME</td>")
                        htmlOut.Append("<td>BASECITY</td>")
                        htmlOut.Append("<td>BASESTATE</td>")
                        htmlOut.Append("<td>BASESTATEABBR</td>")
                        htmlOut.Append("<td>BASECOUNTRY</td>")

                        htmlOut.Append("<td>AFTT</td>")
                        htmlOut.Append("<td>ENG1TT</td>")
                        htmlOut.Append("<td>ENG2TT</td>")
                        htmlOut.Append("<td>ENG3TT</td>")
                        htmlOut.Append("<td>ENG4TT</td>")
                        htmlOut.Append("<td>SMOH1</td>")
                        htmlOut.Append("<td>SMOH2</td>")
                        htmlOut.Append("<td>SMOH3</td>")
                        htmlOut.Append("<td>SMOH4</td>")
                        htmlOut.Append("<td>TRANSACTIONDATE</td>")
                        htmlOut.Append("<td>TRANSACTIONDESCRIPTION</td>")
                        htmlOut.Append("<td>TRANSACTIONCODE</td>")

                        htmlOut.Append("<td>FRACTIONPERCENT</td>")
                        htmlOut.Append("<td>FRACTIONEXPIRES</td>")
                        htmlOut.Append("<td>SCHEDULEDLEASEEXPIRATION</td>")
                        htmlOut.Append("<td>DATELEASEEXPIRED</td>")

                        If Session.Item("localPreferences").AerodexFlag = False Then
                            htmlOut.Append("<td>ASKING</td>")
                            htmlOut.Append("<td>ASKINGAMT</td>")
                            htmlOut.Append("<td>DATELISTED</td>")
                        End If

                        htmlOut.Append("<td>INFAVOROF</td>")
                        htmlOut.Append("<td>DOCDATE</td>")
                        htmlOut.Append("<td>DOCTYPE</td>")
                        htmlOut.Append("<td>DOCAMOUNT</td>")

                        htmlOut.Append("<td>TRANSACTIONNOTE</td>")

                        htmlOut.Append("<td>LESSORCOMPANY</td>")
                        htmlOut.Append("<td>LESSORCITY</td>")
                        htmlOut.Append("<td>LESSORSTATE</td>")
                        htmlOut.Append("<td>LESSORCOUNTRY</td>")

                        htmlOut.Append("<td>LESSEECOMPANY</td>")
                        htmlOut.Append("<td>LESSEECITY</td>")
                        htmlOut.Append("<td>LESSEESTATE</td>")
                        htmlOut.Append("<td>LESEECOUNTRY</td>")

                        htmlOut.Append("<td>SUBLESSEECOMPANY</td>")
                        htmlOut.Append("<td>SUBLESSEECITY</td>")
                        htmlOut.Append("<td>SUBLESSEESTATE</td>")
                        htmlOut.Append("<td>SUBLESSEECOUNTRY</td>")

                        htmlOut.Append("<td>NEWACFLAG</td>")
                        htmlOut.Append("<td>LEASEDATE</td>")

                        htmlOut.Append("<td>FRACTIONPURCHASEDATE</td>")
                        htmlOut.Append("<td>FRACTIONPERCENTOWNED</td>")
                        htmlOut.Append("<td>FRACTIONEXPIRESDATE</td>")
                        htmlOut.Append("<td>PROGRAMMANAGER</td>")
                        htmlOut.Append("<td>PROGRAMHOLDER</td>")

                        htmlOut.Append("</tr>" + vbCrLf)

                    ElseIf bTextCommaReport Then

                        htmlOut.Append(Constants.QUOTE + "MAKE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "MODEL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SERIALNBR" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "REGNBR" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPANY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPALTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPBUSTYPE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPEMAIL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPWEBADDRESS" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPADDRESS1" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPADDRESS2" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPCITY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPSTATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPSTATEABBR" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPPOSTALCODE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPCOUNTRY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPOFFICE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPFAX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCOMPMOBILE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCONTACTPREFIX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCONTACTFIRSTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCONTACTMI" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCONTACTLASTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCONTACTSUFFIX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCONTACTTITLE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCONTACTEMAIL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCONTACTOFFICE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCONTACTFAX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SELLERCONTACTMOBILE" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPANY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPALTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPBUSTYPE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPEMAIL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPWEBADDRESS" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPADDRESS1" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPADDRESS2" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPCITY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPSTATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPSTATEABBR" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPPOSTALCODE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPCOUNTRY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPOFFICE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPFAX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCOMPMOBILE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCONTACTPREFIX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCONTACTFIRSTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCONTACTMI" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCONTACTLASTNAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCONTACTSUFFIX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCONTACTTITLE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCONTACTEMAIL" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCONTACTOFFICE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCONTACTFAX" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PURCHASERCONTACTMOBILE" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "YEARMFG" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "YEARDLV" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BASEIATA" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BASEICAO" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BASENAME" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BASECITY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BASESTATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BASESTATEABBR" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "BASECOUNTRY" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "AFTT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "ENG1TT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "ENG2TT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "ENG3TT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "ENG4TT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SMOH1" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SMOH2" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SMOH3" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SMOH4" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "TRANSACTIONDATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "TRANSACTIONDESCRIPTION" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "TRANSACTIONCODE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "FRACTIONPERCENT" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "FRACTIONEXPIRES" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SCHEDULEDLEASEEXPIRATION" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "DATELEASEEXPIRED" + Constants.QUOTE + Constants.cCommaDelim)

                        If Session.Item("localPreferences").AerodexFlag = False Then
                            htmlOut.Append(Constants.QUOTE + "ASKING" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "ASKINGAMT" + Constants.QUOTE + Constants.cCommaDelim)
                            htmlOut.Append(Constants.QUOTE + "DATELISTED" + Constants.QUOTE + Constants.cCommaDelim)
                        End If

                        htmlOut.Append(Constants.QUOTE + "INFAVOROF" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "DOCDATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "DOCTYPE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "DOCAMOUNT" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "TRANSACTIONNOTE" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "LESSORCOMPANY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "LESSORCITY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "LESSORSTATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "LESSORCOUNTRY" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "LESSEECOMPANY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "LESSEECITY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "LESSEESTATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "LESEECOUNTRY" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "SUBLESSEECOMPANY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SUBLESSEECITY" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SUBLESSEESTATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "SUBLESSEECOUNTRY" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "NEWACFLAG" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "LEASEDATE" + Constants.QUOTE + Constants.cCommaDelim)

                        htmlOut.Append(Constants.QUOTE + "FRACTIONPURCHASEDATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "FRACTIONPERCENTOWNED" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "FRACTIONEXPIRESDATE" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PROGRAMMANAGER" + Constants.QUOTE + Constants.cCommaDelim)
                        htmlOut.Append(Constants.QUOTE + "PROGRAMHOLDER" + Constants.QUOTE)

                        htmlOut.Append(vbCrLf)

                    ElseIf bTextTabReport Then

                        htmlOut.Append("MAKE" + vbTab)
                        htmlOut.Append("MODEL" + vbTab)
                        htmlOut.Append("SERIALNBR" + vbTab)
                        htmlOut.Append("REGNBR" + vbTab)

                        htmlOut.Append("SELLERCOMPANY" + vbTab)
                        htmlOut.Append("SELLERCOMPALTNAME" + vbTab)
                        htmlOut.Append("SELLERCOMPBUSTYPE" + vbTab)
                        htmlOut.Append("SELLERCOMPEMAIL" + vbTab)
                        htmlOut.Append("SELLERCOMPWEBADDRESS" + vbTab)
                        htmlOut.Append("SELLERCOMPADDRESS1" + vbTab)
                        htmlOut.Append("SELLERCOMPADDRESS2" + vbTab)
                        htmlOut.Append("SELLERCOMPCITY" + vbTab)
                        htmlOut.Append("SELLERCOMPSTATE" + vbTab)
                        htmlOut.Append("SELLERCOMPSTATEABBR" + vbTab)
                        htmlOut.Append("SELLERCOMPPOSTALCODE" + vbTab)
                        htmlOut.Append("SELLERCOMPCOUNTRY" + vbTab)
                        htmlOut.Append("SELLERCOMPOFFICE" + vbTab)
                        htmlOut.Append("SELLERCOMPFAX" + vbTab)
                        htmlOut.Append("SELLERCOMPMOBILE" + vbTab)
                        htmlOut.Append("SELLERCONTACTPREFIX" + vbTab)
                        htmlOut.Append("SELLERCONTACTFIRSTNAME" + vbTab)
                        htmlOut.Append("SELLERCONTACTMI" + vbTab)
                        htmlOut.Append("SELLERCONTACTLASTNAME" + vbTab)
                        htmlOut.Append("SELLERCONTACTSUFFIX" + vbTab)
                        htmlOut.Append("SELLERCONTACTTITLE" + vbTab)
                        htmlOut.Append("SELLERCONTACTEMAIL" + vbTab)
                        htmlOut.Append("SELLERCONTACTOFFICE" + vbTab)
                        htmlOut.Append("SELLERCONTACTFAX" + vbTab)
                        htmlOut.Append("SELLERCONTACTMOBILE" + vbTab)

                        htmlOut.Append("PURCHASERCOMPANY" + vbTab)
                        htmlOut.Append("PURCHASERCOMPALTNAME" + vbTab)
                        htmlOut.Append("PURCHASERCOMPBUSTYPE" + vbTab)
                        htmlOut.Append("PURCHASERCOMPEMAIL" + vbTab)
                        htmlOut.Append("PURCHASERCOMPWEBADDRESS" + vbTab)
                        htmlOut.Append("PURCHASERCOMPADDRESS1" + vbTab)
                        htmlOut.Append("PURCHASERCOMPADDRESS2" + vbTab)
                        htmlOut.Append("PURCHASERCOMPCITY" + vbTab)
                        htmlOut.Append("PURCHASERCOMPSTATE" + vbTab)
                        htmlOut.Append("PURCHASERCOMPSTATEABBR" + vbTab)
                        htmlOut.Append("PURCHASERCOMPPOSTALCODE" + vbTab)
                        htmlOut.Append("PURCHASERCOMPCOUNTRY" + vbTab)
                        htmlOut.Append("PURCHASERCOMPOFFICE" + vbTab)
                        htmlOut.Append("PURCHASERCOMPFAX" + vbTab)
                        htmlOut.Append("PURCHASERCOMPMOBILE" + vbTab)
                        htmlOut.Append("PURCHASERCONTACTPREFIX" + vbTab)
                        htmlOut.Append("PURCHASERCONTACTFIRSTNAME" + vbTab)
                        htmlOut.Append("PURCHASERCONTACTMI" + vbTab)
                        htmlOut.Append("PURCHASERCONTACTLASTNAME" + vbTab)
                        htmlOut.Append("PURCHASERCONTACTSUFFIX" + vbTab)
                        htmlOut.Append("PURCHASERCONTACTTITLE" + vbTab)
                        htmlOut.Append("PURCHASERCONTACTEMAIL" + vbTab)
                        htmlOut.Append("PURCHASERCONTACTOFFICE" + vbTab)
                        htmlOut.Append("PURCHASERCONTACTFAX" + vbTab)
                        htmlOut.Append("PURCHASERCONTACTMOBILE" + vbTab)

                        htmlOut.Append("YEARMFG" + vbTab)
                        htmlOut.Append("YEARDLV" + vbTab)
                        htmlOut.Append("BASEIATA" + vbTab)
                        htmlOut.Append("BASEICAO" + vbTab)
                        htmlOut.Append("BASENAME" + vbTab)
                        htmlOut.Append("BASECITY" + vbTab)
                        htmlOut.Append("BASESTATE" + vbTab)
                        htmlOut.Append("BASESTATEABBR" + vbTab)
                        htmlOut.Append("BASECOUNTRY" + vbTab)

                        htmlOut.Append("AFTT" + vbTab)
                        htmlOut.Append("ENG1TT" + vbTab)
                        htmlOut.Append("ENG2TT" + vbTab)
                        htmlOut.Append("ENG3TT" + vbTab)
                        htmlOut.Append("ENG4TT" + vbTab)
                        htmlOut.Append("SMOH1" + vbTab)
                        htmlOut.Append("SMOH2" + vbTab)
                        htmlOut.Append("SMOH3" + vbTab)
                        htmlOut.Append("SMOH4" + vbTab)

                        htmlOut.Append("TRANSACTIONDATE" + vbTab)
                        htmlOut.Append("TRANSACTIONDESCRIPTION" + vbTab)
                        htmlOut.Append("TRANSACTIONCODE" + vbTab)
                        htmlOut.Append("FRACTIONPERCENT" + vbTab)
                        htmlOut.Append("FRACTIONEXPIRES" + vbTab)
                        htmlOut.Append("SCHEDULEDLEASEEXPIRATION" + vbTab)
                        htmlOut.Append("DATELEASEEXPIRED" + vbTab)

                        If Session.Item("localPreferences").AerodexFlag = False Then
                            htmlOut.Append("ASKING" + vbTab)
                            htmlOut.Append("ASKINGAMT" + vbTab)
                            htmlOut.Append("DATELISTED" + vbTab)
                        End If

                        htmlOut.Append("INFAVOROF" + vbTab)

                        htmlOut.Append("DOCDATE" + vbTab)
                        htmlOut.Append("DOCTYPE" + vbTab)
                        htmlOut.Append("DOCAMOUNT" + vbTab)
                        htmlOut.Append("TRANSACTIONNOTE" + vbTab)

                        htmlOut.Append("LESSORCOMPANY" + vbTab)
                        htmlOut.Append("LESSORCITY" + vbTab)
                        htmlOut.Append("LESSORSTATE" + vbTab)
                        htmlOut.Append("LESSORCOUNTRY" + vbTab)

                        htmlOut.Append("LESSEECOMPANY" + vbTab)
                        htmlOut.Append("LESSEECITY" + vbTab)
                        htmlOut.Append("LESSEESTATE" + vbTab)
                        htmlOut.Append("LESEECOUNTRY" + vbTab)

                        htmlOut.Append("SUBLESSEECOMPANY" + vbTab)
                        htmlOut.Append("SUBLESSEECITY" + vbTab)
                        htmlOut.Append("SUBLESSEESTATE" + vbTab)
                        htmlOut.Append("SUBLESSEECOUNTRY" + vbTab)

                        htmlOut.Append("NEWACFLAG" + vbTab)
                        htmlOut.Append("LEASEDATE" + vbTab)

                        htmlOut.Append("FRACTIONPURCHASEDATE" + vbTab)
                        htmlOut.Append("FRACTIONPERCENTOWNED" + vbTab)
                        htmlOut.Append("FRACTIONEXPIRESDATE" + vbTab)
                        htmlOut.Append("PROGRAMMANAGER" + vbTab)
                        htmlOut.Append("PROGRAMHOLDER")

                        htmlOut.Append(vbCrLf)

                    End If

                End If ' chkShowReportHeader.Checked Then

                For Each Row As DataRow In report_52_datatable.Rows

                    If CLng(Row.Item("journ_id").ToString) <> nRememberJournID Then

                        nRememberJournID = CLng(Row.Item("journ_id").ToString)

                        ACInfo1 = ""

                        If Not IsDBNull(Row.Item("ac_id")) And Not IsDBNull(Row.Item("journ_id")) Then

                            If bHtmlReport Or bExcelReport Then

                                ACInfo1 = "<tr><td>" + Row.Item("amod_make_name").ToString.Trim + "</td>"
                                ACInfo1 += "<td>" + Row.Item("amod_model_name").ToString.Trim + "</td>"
                                ACInfo1 += "<td class='textformat'>" + Row.Item("ac_ser_no_full").ToString.Trim + "</td>"
                                ACInfo1 += "<td class='textformat'>" + Row.Item("ac_reg_no").ToString.Trim + "</td>"

                            ElseIf bTextCommaReport Then
                                ACInfo1 = Constants.QUOTE + Row.Item("amod_make_name").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim
                                ACInfo1 += Constants.QUOTE + Row.Item("amod_model_name").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim
                                ACInfo1 += Constants.QUOTE + Row.Item("ac_ser_no_full").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim
                                ACInfo1 += Constants.QUOTE + Row.Item("ac_reg_no").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim

                            ElseIf bTextTabReport Then
                                ACInfo1 = Row.Item("amod_make_name").ToString.Trim + vbTab
                                ACInfo1 += Row.Item("amod_model_name").ToString.Trim + vbTab
                                ACInfo1 += Row.Item("ac_ser_no_full").ToString.Trim + vbTab
                                ACInfo1 += Row.Item("ac_reg_no").ToString.Trim + vbTab

                            End If

                            htmlOut.Append(get_references_seller_purchaser_with_fractional_52(CLng(Row.Item("ac_id").ToString), CLng(Row.Item("journ_id").ToString), ACInfo1, True, Row))

                        End If

                    End If

                Next

            End If

            If bHtmlReport Or bExcelReport Then
                htmlOut.Append("</table>")
            End If

            If bHtmlReport Then
                htmlOut.Append("</div>")
                htmlOut.Append("</body>")
                htmlOut.Append("</html>")
            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in create_report_52_aircraft_seller_purchaser_with_fractional()" + ex.Message
        Finally

            adoRS_52 = Nothing

            report_52_datatable = Nothing

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOut.ToString

    End Function

    Public Function get_references_seller_purchaser_with_fractional_52(ByVal inACID As Long, ByVal inJournalID As Long, ByVal ACInfo1 As String, ByVal isHistorical As Boolean, ByRef currentRow As DataRow) As String

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim SqlReader As System.Data.SqlClient.SqlDataReader : SqlReader = Nothing

        Dim sSellerLine As String = ""
        Dim sPurchaserLine As String = ""

        Dim CompInfo As String = ""
        Dim CompPhoneInfo As String = ""
        Dim ContactInfo As String = ""
        Dim ContactPhoneInfo As String = ""
        Dim ACInfo2 As String = ""
        Dim strFractionalInfo As String = ""

        Dim lHoldCompId As Long = 0
        Dim lHoldContactId As Long = 0
        Dim lCompId As Long = 0
        Dim lContactId As Long = 0

        Dim strInFavorOf As String = ""
        Dim txNote As String = ""

        Dim strBusinessType As String = ""

        Dim nFractionPercentOwned As Double = 0.0
        Dim strFractionExpiresDate As String = ""

        Dim sTmpCompanyName As String = ""
        Dim strProgramManagerName As String = ""
        Dim strProgramHolderName As String = ""
        Dim LastFractionPurchaseDate As String = ""
        Dim OriginalFractionPurchaseDate As String = ""

        Dim txLessor As String = ""
        Dim txLessee As String = ""
        Dim txSublessee As String = ""

        Dim acNewUsed As String = ""
        Dim acLeaseDate As String = ""

        Dim sQuery = New StringBuilder()
        Dim htmlOut = New StringBuilder()

        Dim bIsPurchaser As Boolean = False

        Dim ref_52_datatable As New DataTable

        Try

            If Not IsNothing(HttpContext.Current.Session.Item("searchCriteria").SearchCriteriaCompanyBusinessType) Then
                If Not String.IsNullOrEmpty(HttpContext.Current.Session.Item("searchCriteria").SearchCriteriaCompanyBusinessType.ToString.Trim) Then
                    strBusinessType = HttpContext.Current.Session.Item("searchCriteria").SearchCriteriaCompanyBusinessType.ToString.Trim
                End If
            End If

            If Not IsNothing(HttpContext.Current.Session.Item("Advanced-cref_business_type")) Then
                If Not String.IsNullOrEmpty(HttpContext.Current.Session.Item("Advanced-cref_business_type").ToString.Trim) Then
                    strBusinessType = HttpContext.Current.Session.Item("Advanced-cref_business_type").ToString.Trim
                End If
            End If

            'If Not String.IsNullOrEmpty(strBusinessType.Trim) Then
            '  sQuery.Append(" AND cref_business_type IN ('" + Replace(strBusinessType.Trim, Constants.cDymDataSeperator, Constants.cValueSeperator) + "')")
            'End If

            If Not IsDBNull(currentRow.Item("journ_customer_note")) Then
                If bExcelReport Or bHtmlReport Then
                    txNote = "<td>" + currentRow.Item("journ_customer_note").ToString.Trim + "</td>"
                ElseIf bTextCommaReport Then
                    txNote = Constants.QUOTE + currentRow.Item("journ_customer_note").ToString.Trim + Constants.QUOTE + Constants.cCommaDelim
                ElseIf bTextTabReport Then
                    txNote = currentRow.Item("journ_customer_note").ToString.Trim + vbTab
                End If
            Else
                If bExcelReport Or bHtmlReport Then
                    txNote = "<td></td>"
                ElseIf bTextCommaReport Then
                    txNote = Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim
                ElseIf bTextTabReport Then
                    txNote = "" + vbTab
                End If
            End If

            If Not IsDBNull(currentRow.Item("journ_newac_flag")) Then
                If Not String.IsNullOrEmpty(currentRow.Item("journ_newac_flag").ToString.Trim) Then
                    acNewUsed = IIf(currentRow.Item("journ_newac_flag").ToString.Trim.ToUpper.Contains("Y"), "Yes", "No")
                End If
            End If

            If currentRow.Item("jcat_subcategory_transtype").ToString.Trim.ToUpper.Contains("LEASE") Then
                If Not IsDBNull(currentRow.Item("journ_date")) Then
                    acLeaseDate = FormatDateTime(currentRow.Item("journ_date").ToString, DateFormat.ShortDate)
                End If
            End If

            If bExcelReport Or bHtmlReport Then
                acNewUsed = "<td>" + acNewUsed.Trim + "</td>"
                acLeaseDate = "<td>" + acLeaseDate.Trim + "</td>"
            ElseIf bTextCommaReport Then
                acNewUsed = Constants.QUOTE + acNewUsed.Trim + Constants.QUOTE + Constants.cCommaDelim
                acLeaseDate = Constants.QUOTE + acLeaseDate.Trim + Constants.QUOTE + Constants.cCommaDelim
            ElseIf bTextTabReport Then
                acNewUsed = acNewUsed.Trim + vbTab
                acLeaseDate = acLeaseDate.Trim + vbTab
            End If

            sQuery.Append("SELECT DISTINCT TOP 2 cref_contact_type, cref_comp_id, cref_contact_id, cref_owner_percent, cref_fraction_expires_date, cref_business_type, cref_transmit_seq_no,")
            sQuery.Append(" comp_name, comp_id, comp_journ_id, comp_name_alt_type, comp_name_alt, comp_city, comp_state, comp_zip_code,")
            sQuery.Append(" (SELECT DISTINCT cbus_name FROM Company_Business_Type WITH (NOLOCK) WHERE comp_business_type = cbus_type) AS comp_cbus_name, actype_name,")
            sQuery.Append(" comp_email_address, comp_web_address, comp_address1, comp_address2, comp_country, state_name,")

            sQuery.Append(" (SELECT TOP 1 journ_date FROM Aircraft_Reference WITH(NOLOCK)")
            sQuery.Append(" INNER JOIN Journal WITH(NOLOCK) ON (cref_journ_id = journ_id AND cref_ac_id = journ_ac_id)")
            sQuery.Append(" WHERE ((cref_contact_type = '70')")                 ' Purchaser
            sQuery.Append(" AND (cref_ac_id = " + currentRow.Item("ac_id").ToString + ") AND (cref_comp_id = acr.cref_comp_id)")
            sQuery.Append(" AND (cref_owner_percent = acr.cref_owner_percent) AND (cref_journ_id <> 0)) ORDER BY journ_date DESC) AS fraction_purchase_date")

            sQuery.Append(" FROM Aircraft_Reference AS acr WITH (NOLOCK)")
            sQuery.Append(" INNER JOIN Company WITH(NOLOCK) ON (cref_comp_id = comp_id AND cref_journ_id = comp_journ_id)")
            sQuery.Append(" LEFT OUTER JOIN State WITH(NOLOCK) ON (comp_state = state_code AND comp_country = state_country)")
            sQuery.Append(" INNER JOIN Aircraft_Contact_Type WITH(NOLOCK) ON (cref_contact_type = actype_code)")

            If Not String.IsNullOrEmpty(strBusinessType.Trim) Then
                sQuery.Append(" LEFT OUTER JOIN Business_Type_Reference WITH(NOLOCK) ON (bustypref_comp_id = comp_id AND bustypref_journ_id = comp_journ_id)")
            End If

            sQuery.Append(" WHERE ((cref_ac_id = " + inACID.ToString + ") AND (cref_journ_id = " + inJournalID.ToString + ")")

            ' 02 = Additional Company/Contact
            ' 66,67,68 = Additional Contact 1,2,3
            ' 71 = Research Only
            ' 93 = Exclusive Representative
            ' 97 = Dealer Broker
            ' 99 = Exclusive Broker

            sQuery.Append(" AND (cref_contact_type NOT IN ('02','66','67','68','71','93','99'))")
            sQuery.Append(" AND (cref_transmit_seq_no IN (1,10))")
            sQuery.Append(" AND (comp_hide_flag = 'N'))")
            sQuery.Append(" ORDER BY cref_transmit_seq_no")

            Try

                SqlConn.ConnectionString = localFunctions.clientConnectStr
                SqlConn.Open()

                SqlCommand.Connection = SqlConn
                SqlCommand.CommandType = System.Data.CommandType.Text
                SqlCommand.CommandTimeout = 90

                SqlCommand.CommandText = sQuery.ToString
                SqlReader = SqlCommand.ExecuteReader()

                Try
                    ref_52_datatable.Load(SqlReader)
                Catch constrExc As System.Data.ConstraintException
                    Dim rowsErr As System.Data.DataRow() = ref_52_datatable.GetErrors()
                End Try

                SqlReader.Close()

                If ref_52_datatable.Rows.Count > 0 Then

                    CompInfo = ""
                    CompPhoneInfo = ""
                    ContactInfo = ""
                    ContactPhoneInfo = ""
                    strFractionalInfo = ""
                    strInFavorOf = ""
                    ACInfo2 = ""

                    lHoldCompId = -1
                    lHoldContactId = -1

                    For Each tmpRow As DataRow In ref_52_datatable.Rows

                        If Not IsDBNull(tmpRow.Item("comp_name")) Then
                            If Not String.IsNullOrEmpty(tmpRow.Item("comp_name").ToString.Trim) Then
                                sTmpCompanyName = tmpRow.Item("comp_name").ToString
                            End If
                        End If

                        ' ramble through the data set and get the program manager company name
                        If ((tmpRow.Item("cref_contact_type").ToString = "18" Or tmpRow.Item("cref_contact_type").ToString = "36") And tmpRow.Item("cref_business_type").ToString = "PM") Then
                            strProgramManagerName = sTmpCompanyName
                        End If

                        ' ramble through the data set and get the program holder company name
                        If (tmpRow.Item("cref_contact_type").ToString = "17" Or tmpRow.Item("cref_business_type").ToString = "PH") Then
                            strProgramHolderName = sTmpCompanyName
                        End If

                    Next

                    For Each Row As DataRow In ref_52_datatable.Rows

                        lCompId = CLng(Row.Item("cref_comp_id").ToString)
                        lContactId = CLng(Row.Item("cref_contact_id").ToString)

                        If Not IsDBNull(Row.Item("cref_owner_percent")) Then
                            If Not String.IsNullOrEmpty(Row.Item("cref_owner_percent").ToString.Trim) Then
                                nFractionPercentOwned = CDbl(Row.Item("cref_owner_percent").ToString)
                            End If
                        End If

                        If Not IsDBNull(Row.Item("cref_fraction_expires_date")) Then
                            If Not String.IsNullOrEmpty(Row.Item("cref_fraction_expires_date").ToString.Trim) Then
                                strFractionExpiresDate = Row.Item("cref_fraction_expires_date").ToString
                            End If
                        End If

                        LastFractionPurchaseDate = ""
                        If Not IsDBNull(Row.Item("fraction_purchase_date")) Then
                            If Not String.IsNullOrEmpty(Row.Item("fraction_purchase_date").ToString.Trim) Then
                                LastFractionPurchaseDate = Row.Item("fraction_purchase_date").ToString
                            End If
                        End If



                        If (strBusinessType.ToUpper <> "PM") And (strBusinessType.ToUpper <> "PH") And (strBusinessType.ToUpper <> "PN") Then
                            strFractionalInfo = display_aircraft_fractional_information32(strProgramManagerName, strProgramHolderName, "skip", LastFractionPurchaseDate, nFractionPercentOwned, strFractionExpiresDate)
                        Else
                            strFractionalInfo = display_aircraft_fractional_information32(strProgramManagerName, strProgramHolderName, "skip", "", nFractionPercentOwned, strFractionExpiresDate)
                        End If


                        If lHoldCompId <> lCompId Then

                            ReturnCompanyInformation_Report(lCompId, inJournalID, Row, CompPhoneInfo, CompInfo, True)
                            lHoldCompId = lCompId

                        End If   ' if we have a company id

                        If lHoldContactId <> lContactId Then

                            ReturnContactInformation_Report(lCompId, lContactId, inJournalID, ContactInfo, ContactPhoneInfo)
                            lHoldContactId = lContactId

                        End If

                        ' add Contact Type – 13 – Lessor, 12 or 57 - Lessee, 39 - Sublessee
                        Dim companyInfo(3) As String

                        localFunctions.get_company_info_by_reference(inACID, inJournalID, "'13'", companyInfo)

                        If bExcelReport Or bHtmlReport Then
                            txLessor = "<td>" + companyInfo(0).Trim + "</td>"
                            txLessor += "<td>" + companyInfo(1).Trim + "</td>"
                            txLessor += "<td>" + companyInfo(2).Trim + "</td>"
                            txLessor += "<td>" + companyInfo(3).Trim + "</td>"
                        ElseIf bTextCommaReport Then
                            txLessor = Constants.QUOTE + companyInfo(0).Trim + Constants.QUOTE + Constants.cCommaDelim
                            txLessor += Constants.QUOTE + companyInfo(2).Trim + Constants.QUOTE + Constants.cCommaDelim
                            txLessor += Constants.QUOTE + companyInfo(3).Trim + Constants.QUOTE + Constants.cCommaDelim
                            txLessor += Constants.QUOTE + companyInfo(4).Trim + Constants.QUOTE + Constants.cCommaDelim
                        ElseIf bTextTabReport Then
                            txLessor = companyInfo(0).Trim + vbTab
                            txLessor += companyInfo(2).Trim + vbTab
                            txLessor += companyInfo(3).Trim + vbTab
                            txLessor += companyInfo(4).Trim + vbTab
                        End If

                        localFunctions.get_company_info_by_reference(inACID, inJournalID, "'12','57'", companyInfo)

                        If bExcelReport Or bHtmlReport Then
                            txLessee = "<td>" + companyInfo(0).Trim + "</td>"
                            txLessee += "<td>" + companyInfo(1).Trim + "</td>"
                            txLessee += "<td>" + companyInfo(2).Trim + "</td>"
                            txLessee += "<td>" + companyInfo(3).Trim + "</td>"
                        ElseIf bTextCommaReport Then
                            txLessee = Constants.QUOTE + companyInfo(0).Trim + Constants.QUOTE + Constants.cCommaDelim
                            txLessee += Constants.QUOTE + companyInfo(2).Trim + Constants.QUOTE + Constants.cCommaDelim
                            txLessee += Constants.QUOTE + companyInfo(3).Trim + Constants.QUOTE + Constants.cCommaDelim
                            txLessee += Constants.QUOTE + companyInfo(4).Trim + Constants.QUOTE + Constants.cCommaDelim
                        ElseIf bTextTabReport Then
                            txLessee = companyInfo(0).Trim + vbTab
                            txLessee += companyInfo(2).Trim + vbTab
                            txLessee += companyInfo(3).Trim + vbTab
                            txLessee += companyInfo(4).Trim + vbTab
                        End If

                        localFunctions.get_company_info_by_reference(inACID, inJournalID, "'39'", companyInfo)

                        If bExcelReport Or bHtmlReport Then
                            txSublessee = "<td>" + companyInfo(0).Trim + "</td>"
                            txSublessee += "<td>" + companyInfo(1).Trim + "</td>"
                            txSublessee += "<td>" + companyInfo(2).Trim + "</td>"
                            txSublessee += "<td>" + companyInfo(3).Trim + "</td>"
                        ElseIf bTextCommaReport Then
                            txSublessee = Constants.QUOTE + companyInfo(0).Trim + Constants.QUOTE + Constants.cCommaDelim
                            txSublessee += Constants.QUOTE + companyInfo(2).Trim + Constants.QUOTE + Constants.cCommaDelim
                            txSublessee += Constants.QUOTE + companyInfo(3).Trim + Constants.QUOTE + Constants.cCommaDelim
                            txSublessee += Constants.QUOTE + companyInfo(4).Trim + Constants.QUOTE + Constants.cCommaDelim
                        ElseIf bTextTabReport Then
                            txSublessee = companyInfo(0).Trim + vbTab
                            txSublessee += companyInfo(2).Trim + vbTab
                            txSublessee += companyInfo(3).Trim + vbTab
                            txSublessee += companyInfo(4).Trim + vbTab
                        End If

                        If ref_52_datatable.Rows.Count = 1 Then ' we only have a "seller"

                            sSellerLine = ACInfo1 + CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo

                            ACInfo2 = finish_aircraft_info_seller_purchaser_30_31(isHistorical, currentRow)

                            strInFavorOf = ReturnInFavorOfInformation(inACID, lCompId, False)

                            ReturnCompanyInformation_Report(0, 0, Nothing, CompPhoneInfo, CompInfo, True)
                            ReturnContactInformation_Report(0, 0, 0, ContactInfo, ContactPhoneInfo)

                            If bHtmlReport Or bExcelReport Then

                                sPurchaserLine = CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo + ACInfo2 + strInFavorOf + txNote + txLessor + txLessee + txSublessee + acNewUsed + acLeaseDate + strFractionalInfo + "</tr>" + vbCrLf

                            ElseIf bTextCommaReport Then

                                sPurchaserLine = Constants.cCommaDelim + CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo + Constants.cCommaDelim + ACInfo2 + strInFavorOf + Constants.cCommaDelim + txNote + txLessor + txLessee + txSublessee + acNewUsed + acLeaseDate + strFractionalInfo

                            ElseIf bTextTabReport Then

                                sPurchaserLine = vbTab + CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo + vbTab + ACInfo2 + strInFavorOf + vbTab + txNote + txLessor + txLessee + txSublessee + acNewUsed + acLeaseDate + strFractionalInfo

                            End If

                            htmlOut.Append(sSellerLine + sPurchaserLine)

                        Else

                            If Not bIsPurchaser Then

                                sSellerLine = ACInfo1 + CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo
                                bIsPurchaser = True

                            Else

                                ACInfo2 = finish_aircraft_info_seller_purchaser_30_31(isHistorical, currentRow)

                                strInFavorOf = ReturnInFavorOfInformation(inACID, lCompId, False)

                                If bHtmlReport Or bExcelReport Then

                                    sPurchaserLine = CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo + ACInfo2 + strInFavorOf + txNote + txLessor + txLessee + txSublessee + acNewUsed + acLeaseDate + strFractionalInfo + "</tr>" + vbCrLf

                                ElseIf bTextCommaReport Then

                                    sPurchaserLine = Constants.cCommaDelim + CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo + Constants.cCommaDelim + ACInfo2 + strInFavorOf + Constants.cCommaDelim + txNote + txLessor + txLessee + txSublessee + acNewUsed + acLeaseDate + strFractionalInfo + vbCrLf

                                ElseIf bTextTabReport Then

                                    sPurchaserLine = vbTab + CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo + vbTab + ACInfo2 + strInFavorOf + vbTab + txNote + txLessor + txLessee + txSublessee + acNewUsed + acLeaseDate + strFractionalInfo + vbCrLf

                                End If

                                htmlOut.Append(sSellerLine + sPurchaserLine)

                            End If

                        End If

                    Next

                Else

                    ReturnCompanyInformation_Report(0, 0, Nothing, CompPhoneInfo, CompInfo, True)
                    ReturnContactInformation_Report(0, 0, 0, ContactInfo, ContactPhoneInfo)

                    sSellerLine = ACInfo1 + CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo

                    ACInfo2 = finish_aircraft_info_seller_purchaser_52(isHistorical, currentRow)

                    strInFavorOf = ReturnInFavorOfInformation(inACID, 0, False)

                    ReturnCompanyInformation_Report(0, 0, Nothing, CompPhoneInfo, CompInfo, True)
                    ReturnContactInformation_Report(0, 0, 0, ContactInfo, ContactPhoneInfo)

                    strFractionalInfo = display_aircraft_fractional_information32("", "", "skip", "", 0, "")

                    If bHtmlReport Or bExcelReport Then

                        sPurchaserLine = CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo + ACInfo2 + strInFavorOf + txNote + txLessor + txLessee + txSublessee + acNewUsed + acLeaseDate + strFractionalInfo + "</tr>" + vbCrLf

                    ElseIf bTextCommaReport Then

                        sPurchaserLine = Constants.cCommaDelim + CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo + Constants.cCommaDelim + ACInfo2 + strInFavorOf + Constants.cCommaDelim + txNote + txLessor + txLessee + txSublessee + acNewUsed + acLeaseDate + strFractionalInfo + vbCrLf

                    ElseIf bTextTabReport Then

                        sPurchaserLine = vbTab + CompInfo + CompPhoneInfo + ContactInfo + ContactPhoneInfo + vbTab + ACInfo2 + strInFavorOf + vbTab + txNote + txLessor + txLessee + txSublessee + acNewUsed + acLeaseDate + strFractionalInfo + vbCrLf

                    End If

                    htmlOut.Append(sSellerLine + sPurchaserLine)

                End If

            Catch SqlException

                HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in get_references_seller_purchaser_with_fractional_52(ByVal inACID As Long, ByVal inJournalID As Long, ByVal ACInfo1 As String, ByVal isHistorical As Boolean) As String" + SqlException.Message

            Finally


                SqlReader = Nothing

                SqlConn.Dispose()
                SqlConn.Close()
                SqlConn = Nothing

                SqlCommand.Dispose()
                SqlCommand = Nothing
            End Try

        Catch ex As Exception

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in get_references_seller_purchaser_with_fractional_52(ByVal inACID As Long, ByVal inJournalID As Long, ByVal ACInfo1 As String, ByVal isHistorical As Boolean) As String" + ex.Message

        End Try

        Return htmlOut.ToString

    End Function

    Public Function finish_aircraft_info_seller_purchaser_52(ByVal isHistorical As Boolean, ByRef currentRow As DataRow) As String

        Dim ac_year As String = ""
        Dim ac_mfr_year As String = ""
        Dim ac_aport_iata_code As String = ""
        Dim ac_aport_icao_code As String = ""
        Dim ac_aport_name As String = ""
        Dim ac_aport_city As String = ""
        Dim ac_aport_state As String = ""
        Dim ac_aport_country As String = ""
        Dim ac_airframe_tot_hrs As String = ""
        Dim ac_asking As String = ""
        Dim ac_asking_price As String = "0.0"
        Dim ac_list_date As String = ""
        Dim ac_engine_1_tot_hrs As String = ""
        Dim ac_engine_2_tot_hrs As String = ""
        Dim ac_engine_3_tot_hrs As String = ""
        Dim ac_engine_4_tot_hrs As String = ""
        Dim ac_engine_1_soh_hrs As String = ""
        Dim ac_engine_2_soh_hrs As String = ""
        Dim ac_engine_3_soh_hrs As String = ""
        Dim ac_engine_4_soh_hrs As String = ""

        Dim journ_date As String = ""
        Dim journ_subject As String = ""
        Dim journ_subcategory_code As String = ""
        Dim journ_id As String = ""

        Dim priorev_entry_date As String = ""
        Dim priorev_subject As String = ""
        Dim priorev_description As String = ""

        Dim sFractionPercent As String = ""
        Dim sFractionExpiresDate As String = ""

        Dim sLeaseExpireDate As String = ""
        Dim sLeaseExpConfirmDate As String = ""

        Dim htmlOut = New StringBuilder()

        Try


            If Not (IsDBNull(currentRow.Item("ac_mfr_year"))) Then
                ac_mfr_year = currentRow.Item("ac_mfr_year").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("ac_year"))) Then
                ac_year = currentRow.Item("ac_year").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("ac_aport_iata_code"))) Then
                ac_aport_iata_code = currentRow.Item("ac_aport_iata_code").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("ac_aport_icao_code"))) Then
                ac_aport_icao_code = currentRow.Item("ac_aport_icao_code").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("ac_aport_name"))) Then
                ac_aport_name = currentRow.Item("ac_aport_name").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("ac_aport_city"))) Then
                ac_aport_city = currentRow.Item("ac_aport_city").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("ac_aport_state"))) Then
                ac_aport_state = currentRow.Item("ac_aport_state").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("ac_aport_country"))) Then
                ac_aport_country = currentRow.Item("ac_aport_country").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("ac_airframe_tot_hrs"))) Then
                ac_airframe_tot_hrs = currentRow.Item("ac_airframe_tot_hrs").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("ac_engine_1_tot_hrs"))) Then
                ac_engine_1_tot_hrs = currentRow.Item("ac_engine_1_tot_hrs").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("ac_engine_2_tot_hrs"))) Then
                ac_engine_2_tot_hrs = currentRow.Item("ac_engine_2_tot_hrs").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("ac_engine_3_tot_hrs"))) Then
                ac_engine_3_tot_hrs = currentRow.Item("ac_engine_3_tot_hrs").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("ac_engine_4_tot_hrs"))) Then
                ac_engine_4_tot_hrs = currentRow.Item("ac_engine_4_tot_hrs").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("ac_engine_1_soh_hrs"))) Then
                ac_engine_1_soh_hrs = currentRow.Item("ac_engine_1_soh_hrs").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("ac_engine_2_soh_hrs"))) Then
                ac_engine_2_soh_hrs = currentRow.Item("ac_engine_2_soh_hrs").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("ac_engine_3_soh_hrs"))) Then
                ac_engine_3_soh_hrs = currentRow.Item("ac_engine_3_soh_hrs").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("ac_engine_4_soh_hrs"))) Then
                ac_engine_4_soh_hrs = currentRow.Item("ac_engine_4_soh_hrs").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("ac_asking"))) Then
                ac_asking = currentRow.Item("ac_asking").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("ac_asking_price"))) Then
                ac_asking_price = currentRow.Item("ac_asking_price").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("ac_list_date"))) Then
                ac_list_date = FormatDateTime(currentRow.Item("ac_list_date").ToString, DateFormat.ShortDate).Trim
            End If

            If Not (IsDBNull(currentRow.Item("journ_date"))) Then
                journ_date = FormatDateTime(currentRow.Item("journ_date").ToString, DateFormat.ShortDate).Trim
            End If

            If Not (IsDBNull(currentRow.Item("journ_subject"))) Then
                journ_subject = currentRow.Item("journ_subject").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("journ_subcategory_code"))) Then
                journ_subcategory_code = currentRow.Item("journ_subcategory_code").ToString.Trim
            End If

            If Not (IsDBNull(currentRow.Item("journ_id"))) Then
                journ_id = currentRow.Item("journ_id").ToString.Trim
            End If

            If Not isHistorical Then

                If Not (IsDBNull(currentRow.Item("priorev_entry_date"))) Then
                    priorev_entry_date = FormatDateTime(currentRow.Item("priorev_entry_date").ToString, DateFormat.ShortDate).Trim
                End If

                If Not (IsDBNull(currentRow.Item("priorev_subject"))) Then
                    priorev_subject = currentRow.Item("priorev_subject").ToString.Trim
                End If

                If Not (IsDBNull(currentRow.Item("priorev_description"))) Then
                    priorev_description = currentRow.Item("priorev_description").ToString.Trim
                End If

            End If

            If bExcelReport Or bHtmlReport Then

                If Not String.IsNullOrEmpty(ac_mfr_year.Trim) Then
                    htmlOut.Append("<td>" + ac_mfr_year + "</td>")
                Else
                    htmlOut.Append("<td></td>")
                End If

                htmlOut.Append("<td>" + ac_year + "</td>")
                htmlOut.Append("<td>" + ac_aport_iata_code + "</td>")
                htmlOut.Append("<td>" + ac_aport_icao_code + "</td>")
                htmlOut.Append("<td>" + ac_aport_name + "</td>")
                htmlOut.Append("<td>" + ac_aport_city + "</td>")
                htmlOut.Append("<td>" + localFunctions.get_state_name_report(ac_aport_state, ac_aport_country) + "</td>")
                htmlOut.Append("<td>" + ac_aport_state + "</td>")
                htmlOut.Append("<td>" + ac_aport_country + "</td>")
                htmlOut.Append("<td>" + ac_airframe_tot_hrs + "</td>")
                htmlOut.Append("<td>" + ac_engine_1_tot_hrs + "</td>")
                htmlOut.Append("<td>" + ac_engine_2_tot_hrs + "</td>")
                htmlOut.Append("<td>" + ac_engine_3_tot_hrs + "</td>")
                htmlOut.Append("<td>" + ac_engine_4_tot_hrs + "</td>")
                htmlOut.Append("<td>" + ac_engine_1_soh_hrs + "</td>")
                htmlOut.Append("<td>" + ac_engine_2_soh_hrs + "</td>")
                htmlOut.Append("<td>" + ac_engine_3_soh_hrs + "</td>")
                htmlOut.Append("<td>" + ac_engine_4_soh_hrs + "</td>")

                htmlOut.Append("<td>" + journ_date + "</td>")
                htmlOut.Append("<td>" + journ_subject + "</td>")
                htmlOut.Append("<td>" + journ_subcategory_code + "</td>")

                If Not isHistorical Then
                    htmlOut.Append("<td>" + priorev_entry_date + "</td>")
                    htmlOut.Append("<td>" + priorev_subject)

                    If Not String.IsNullOrEmpty(priorev_description) Then
                        htmlOut.Append(" - " + priorev_description + "</td>")
                    Else
                        htmlOut.Append("</td>")
                    End If
                End If

                localFunctions.get_fraction_percent_and_expire_date(journ_id, True, sFractionPercent, sFractionExpiresDate)
                localFunctions.get_lease_expire_and_confirm_date(journ_id, True, sLeaseExpireDate, sLeaseExpConfirmDate)

                htmlOut.Append("<td>" + sFractionPercent + "</td>")
                htmlOut.Append("<td>" + sFractionExpiresDate + "</td>")
                htmlOut.Append("<td>" + sLeaseExpireDate + "</td>")
                htmlOut.Append("<td>" + sLeaseExpConfirmDate + "</td>")

                htmlOut.Append("<td>" + ac_asking + "</td>")
                If CDbl(ac_asking_price) > 0 Then
                    htmlOut.Append("<td>$" + FormatNumber(ac_asking_price, 0, False, False, True) + "</td>")
                Else
                    htmlOut.Append("<td>&nbsp;</td>")
                End If

                htmlOut.Append("<td class='dateformat'>" + ac_list_date + "</td>")

            ElseIf bTextCommaReport Then

                htmlOut.Append(Constants.QUOTE + ac_mfr_year + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + ac_year + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + ac_aport_iata_code + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + ac_aport_icao_code + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + ac_aport_name + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + ac_aport_city + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + localFunctions.get_state_name_report(ac_aport_state, ac_aport_country) + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + ac_aport_state + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + ac_aport_country + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + ac_airframe_tot_hrs + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + ac_engine_1_tot_hrs + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + ac_engine_2_tot_hrs + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + ac_engine_3_tot_hrs + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + ac_engine_4_tot_hrs + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + ac_engine_1_soh_hrs + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + ac_engine_2_soh_hrs + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + ac_engine_3_soh_hrs + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + ac_engine_4_soh_hrs + Constants.QUOTE + Constants.cCommaDelim)

                htmlOut.Append(Constants.QUOTE + journ_date + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + journ_subject + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + journ_subcategory_code + Constants.QUOTE + Constants.cCommaDelim)

                If Not isHistorical Then

                    htmlOut.Append(Constants.QUOTE + priorev_entry_date + Constants.QUOTE + Constants.cCommaDelim)
                    htmlOut.Append(Constants.QUOTE + priorev_subject)

                    If Not String.IsNullOrEmpty(priorev_description) Then
                        htmlOut.Append(" - " + priorev_description + Constants.QUOTE + Constants.cCommaDelim)
                    Else
                        htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                    End If

                End If

                localFunctions.get_fraction_percent_and_expire_date(journ_id, True, sFractionPercent, sFractionExpiresDate)
                localFunctions.get_lease_expire_and_confirm_date(journ_id, True, sLeaseExpireDate, sLeaseExpConfirmDate)

                htmlOut.Append(Constants.QUOTE + sFractionPercent + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + sFractionExpiresDate + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + sLeaseExpireDate + Constants.QUOTE + Constants.cCommaDelim)
                htmlOut.Append(Constants.QUOTE + sLeaseExpConfirmDate + Constants.QUOTE + Constants.cCommaDelim)

                htmlOut.Append(Constants.QUOTE + ac_asking + Constants.QUOTE + Constants.cCommaDelim)
                If CDbl(ac_asking_price) > 0 Then
                    htmlOut.Append(Constants.QUOTE + "$" + FormatNumber(ac_asking_price, 0, False, False, True) + Constants.QUOTE + Constants.cCommaDelim)
                Else
                    htmlOut.Append(Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim)
                End If

                htmlOut.Append(Constants.QUOTE + ac_list_date + Constants.QUOTE + Constants.cCommaDelim)

            ElseIf bTextTabReport Then

                htmlOut.Append(ac_mfr_year + vbTab)
                htmlOut.Append(ac_year + vbTab)
                htmlOut.Append(ac_aport_iata_code + vbTab)
                htmlOut.Append(ac_aport_icao_code + vbTab)
                htmlOut.Append(ac_aport_name + vbTab)
                htmlOut.Append(ac_aport_city + vbTab)
                htmlOut.Append(localFunctions.get_state_name_report(ac_aport_state, ac_aport_country) + vbTab)
                htmlOut.Append(ac_aport_state + vbTab)
                htmlOut.Append(ac_aport_country + vbTab)
                htmlOut.Append(ac_airframe_tot_hrs + vbTab)
                htmlOut.Append(ac_engine_1_tot_hrs + vbTab)
                htmlOut.Append(ac_engine_2_tot_hrs + vbTab)
                htmlOut.Append(ac_engine_3_tot_hrs + vbTab)
                htmlOut.Append(ac_engine_4_tot_hrs + vbTab)
                htmlOut.Append(ac_engine_1_soh_hrs + vbTab)
                htmlOut.Append(ac_engine_2_soh_hrs + vbTab)
                htmlOut.Append(ac_engine_3_soh_hrs + vbTab)
                htmlOut.Append(ac_engine_4_soh_hrs + vbTab)

                htmlOut.Append(journ_date + vbTab)
                htmlOut.Append(journ_subject + vbTab)
                htmlOut.Append(journ_subcategory_code + vbTab)

                If Not isHistorical Then

                    htmlOut.Append(priorev_entry_date + vbTab)
                    htmlOut.Append(priorev_subject)

                    If Not String.IsNullOrEmpty(priorev_description) Then
                        htmlOut.Append(" - " + priorev_description + vbTab)
                    Else
                        htmlOut.Append(vbTab)
                    End If

                End If

                localFunctions.get_fraction_percent_and_expire_date(journ_id, True, sFractionPercent, sFractionExpiresDate)
                localFunctions.get_lease_expire_and_confirm_date(journ_id, True, sLeaseExpireDate, sLeaseExpConfirmDate)

                htmlOut.Append(sFractionPercent + vbTab)
                htmlOut.Append(sFractionExpiresDate + vbTab)
                htmlOut.Append(sLeaseExpireDate + vbTab)
                htmlOut.Append(sLeaseExpConfirmDate + vbTab)

                htmlOut.Append(ac_asking + vbTab)
                If CDbl(ac_asking_price) > 0 Then
                    htmlOut.Append("$" + FormatNumber(ac_asking_price, 0, False, False, True) + vbTab)
                Else
                    htmlOut.Append(vbTab)
                End If

                htmlOut.Append(ac_list_date + vbTab)

            End If

        Catch ex As Exception

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in finish_aircraft_info_seller_purchaser_52(ByVal isHistorical As Boolean, ByRef currentRow As DataRow) As String" + ex.Message

        End Try

        Return htmlOut.ToString

    End Function

#End Region

#Region "helper_functions"

    Public Function ReturnCompanyPhoneInformation_Report(ByVal inCompanyId As Long, ByVal inJournalId As Long, ByVal b_IncludeContacts As Boolean) As String

        Dim strOffice As String = ""
        Dim strFax As String = ""
        Dim strMobile As String = ""
        Dim strType As String = ""
        Dim strResults As String = ""
        Dim strPhone As String = ""

        Dim sQuery = New StringBuilder()
        Dim atemptable As New DataTable

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader = Nothing
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing

        Try

            If (inCompanyId > 0) And (inJournalId >= 0) Then

                sQuery.Append("SELECT pnum_type, pnum_number_full FROM Phone_Numbers WITH(NOLOCK)  INNER JOIN Phone_Type WITH(NOLOCK) ON pnum_type = ptype_name")
                sQuery.Append(" WHERE (pnum_comp_id = " + inCompanyId.ToString + ")  AND (pnum_contact_id = 0)")
                sQuery.Append(" AND (pnum_journ_id = " + inJournalId.ToString + ")  AND (pnum_hide_customer = 'N')")
                sQuery.Append(" AND (pnum_type IN ('Office', 'Hangar', 'Residence', 'Fax', 'Hangar Fax', 'Residential Fax', 'Mobile'))")
                sQuery.Append(" ORDER BY ptype_seq_no")

                'HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />ReturnCompanyPhoneInformation_Report(ByVal inCompanyId As Long, ByVal inJournalId As Long, ByVal b_IncludeContacts As Boolean) As String<br />" + sQuery.ToString

                SqlConn.ConnectionString = localFunctions.clientConnectStr
                SqlConn.Open()
                SqlCommand.Connection = SqlConn
                SqlCommand.CommandType = CommandType.Text
                SqlCommand.CommandTimeout = 90

                SqlCommand.CommandText = sQuery.ToString
                SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

                Try
                    atemptable.Load(SqlReader)
                Catch constrExc As System.Data.ConstraintException
                    Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
                    HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in ReturnCompanyPhoneInformation_Report load datatable" + constrExc.Message
                End Try

                SqlReader.Close()


                If Not IsNothing(atemptable) Then
                    If atemptable.Rows.Count > 0 Then

                        For Each Row As DataRow In atemptable.Rows

                            If Not IsDBNull(Row("pnum_type")) Then
                                strType = Row.Item("pnum_type").ToString.Trim
                            Else
                                strType = ""
                            End If

                            If Not IsDBNull(Row("pnum_number_full")) Then
                                strPhone = Row.Item("pnum_number_full").ToString.Trim
                            Else
                                strPhone = ""
                            End If

                            Select Case strType.ToLower
                                Case "office", "hangar", "residence"
                                    strOffice = strPhone
                                Case "fax", "hangar fax", "residential fax"
                                    strFax = strPhone
                                Case "mobile"
                                    strMobile = strPhone
                            End Select

                        Next

                    End If

                End If

            End If

            If bExcelReport Or bHtmlReport Then

                strResults = ("<td align='left' valign='middle' nowrap='nowrap'>" + strOffice.Trim + "</td><td align='left' valign='middle' nowrap='nowrap'>" + strFax.Trim + "</td><td align='left' valign='middle' nowrap='nowrap'>" + strMobile.Trim + "</td>")

            ElseIf bTextCommaReport Then

                strResults = Constants.QUOTE + strOffice.Trim + Constants.QUOTE + Constants.cCommaDelim
                strResults += Constants.QUOTE + strFax.Trim + Constants.QUOTE + Constants.cCommaDelim
                strResults += Constants.QUOTE + strMobile.Trim + Constants.QUOTE

                If b_IncludeContacts Then
                    strResults += Constants.cCommaDelim
                End If

            ElseIf bTextTabReport Then

                strResults = strOffice.Trim + vbTab
                strResults += strFax.Trim + vbTab
                strResults += strMobile.Trim

                If b_IncludeContacts Then
                    strResults += vbTab
                End If

            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in ReturnCompanyPhoneInformation_Report(ByVal inCompanyId As Long, ByVal inJournalId As Long, ByVal b_IncludeContacts As Boolean) As String" + ex.Message
        Finally
            SqlReader = Nothing

            atemptable = Nothing

            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return strResults

    End Function

    Public Function ReturnContactPhoneInformation_Report(ByVal inCompanyId As Long, ByVal inJournalId As Long, ByVal inContactId As Long) As String

        Dim strOffice As String = ""
        Dim strFax As String = ""
        Dim strMobile As String = ""
        Dim strType As String = ""
        Dim strPhone As String = ""

        Dim strResults As String = ""

        Dim sQuery = New StringBuilder()
        Dim atemptable As New DataTable

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader = Nothing
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing

        Try

            If (inCompanyId > 0) And (inContactId > 0) And (inJournalId >= 0) Then

                ' mark this one to use for other phone number functions
                sQuery.Append("SELECT pnum_type, pnum_number_full FROM Phone_Numbers WITH(NOLOCK)")
                sQuery.Append(" INNER JOIN Phone_Type WITH(NOLOCK) ON pnum_type = ptype_name")
                sQuery.Append(" WHERE (pnum_comp_id = " + inCompanyId.ToString + ")")
                sQuery.Append(" AND (pnum_contact_id = " + inContactId.ToString + ")")
                sQuery.Append(" AND (pnum_journ_id = " + inJournalId.ToString + ")")
                sQuery.Append(" AND (pnum_hide_customer = 'N')")
                sQuery.Append(" AND (pnum_type IN ('Office', 'Hangar', 'Residence', 'Fax', 'Hangar Fax', 'Residential Fax', 'Mobile'))")
                sQuery.Append(" ORDER BY ptype_seq_no")

                'HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />ReturnContactPhoneInformation_Report(ByVal inCompanyId As Long, ByVal inJournalId As Long, ByVal inContactId As Long) As String<br />" + sQuery.ToString

                SqlConn.ConnectionString = localFunctions.clientConnectStr
                SqlConn.Open()
                SqlCommand.Connection = SqlConn
                SqlCommand.CommandType = CommandType.Text
                SqlCommand.CommandTimeout = 90

                SqlCommand.CommandText = sQuery.ToString
                SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

                Try
                    atemptable.Load(SqlReader)
                Catch constrExc As System.Data.ConstraintException
                    Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
                    HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in ReturnContactPhoneInformation_Report load datatable" + constrExc.Message
                End Try

                SqlReader.Close()


                If Not IsNothing(atemptable) Then
                    If atemptable.Rows.Count > 0 Then

                        For Each Row As DataRow In atemptable.Rows

                            If Not IsDBNull(Row("pnum_type")) Then
                                strType = Row.Item("pnum_type").ToString.Trim
                            Else
                                strType = ""
                            End If

                            If Not IsDBNull(Row("pnum_number_full")) Then
                                strPhone = Row.Item("pnum_number_full").ToString.Trim
                            Else
                                strPhone = ""
                            End If

                            Select Case strType.ToLower
                                Case "office", "hangar", "residence"
                                    strOffice = strPhone
                                Case "fax", "hangar fax", "residential fax"
                                    strFax = strPhone
                                Case "mobile"
                                    strMobile = strPhone
                            End Select

                        Next

                    End If

                End If

            End If

            ' Create The Return String Value
            If bExcelReport Or bHtmlReport Then

                strResults = "<td align='left' valign='middle' nowrap='nowrap'>" + strOffice.Trim + "</td>"
                strResults += "<td align='left' valign='middle' nowrap='nowrap'>" + strFax.Trim + "</td>"
                strResults += "<td align='left' valign='middle' nowrap='nowrap'>" + strMobile.Trim + "</td>"

            ElseIf bTextCommaReport Then

                strResults = Constants.QUOTE + strOffice.Trim + Constants.QUOTE + Constants.cCommaDelim
                strResults += Constants.QUOTE + strFax.Trim + Constants.QUOTE + Constants.cCommaDelim
                strResults += Constants.QUOTE + strMobile.Trim + Constants.QUOTE

            ElseIf bTextTabReport Then

                strResults = strOffice.Trim + vbTab
                strResults += strFax.Trim + vbTab
                strResults += strMobile.Trim

            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in ReturnContactPhoneInformation_Report(ByVal inCompanyId As Long, ByVal inJournalId As Long, ByVal inContactId As Long) As String" + ex.Message
        Finally
            SqlReader = Nothing

            atemptable = Nothing

            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing
        End Try

        Return strResults

    End Function

    Public Sub ReturnContactInformation_Report(ByVal lCompID As Long, ByVal lContactID As Long, ByVal lJournID As Long, ByRef strContactInfo As String, ByRef strContactPhoneInfo As String)

        Dim strSirName As String = ""
        Dim strFName As String = ""
        Dim strMiddle As String = ""
        Dim strLName As String = ""
        Dim strSuffix As String = ""
        Dim strTitle As String = ""
        Dim strEMail As String = ""

        Dim sQuery = New StringBuilder()
        Dim atemptable As New DataTable

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing

        Try

            strContactInfo = ""
            strContactPhoneInfo = ""

            If (lCompID > 0) And (lContactID > 0) Then

                sQuery.Append("SELECT contact_sirname, contact_first_name, contact_middle_initial, contact_last_name,")
                sQuery.Append("contact_suffix, contact_title, contact_email_address FROM Contact WITH(NOLOCK)")
                sQuery.Append(" WHERE (contact_hide_flag = 'N')")
                sQuery.Append(" AND (contact_active_flag = 'Y')")
                sQuery.Append(" AND (contact_comp_id = " + lCompID.ToString + ")")
                sQuery.Append(" AND (contact_id = " + lContactID.ToString + ")")
                sQuery.Append(" AND (contact_journ_id = " + lJournID.ToString + ")")

                'HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />ReturnContactInformation_Report(ByVal lCompID As Long, ByVal lContactID As Long, ByVal lJournID As Long, ByRef strContactInfo As String, ByRef strContactPhoneInfo As String) As String<br />" + sQuery.ToString

                SqlConn.ConnectionString = localFunctions.clientConnectStr
                SqlConn.Open()
                SqlCommand.Connection = SqlConn
                SqlCommand.CommandType = CommandType.Text
                SqlCommand.CommandTimeout = 90

                SqlCommand.CommandText = sQuery.ToString

                SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

                Try
                    atemptable.Load(SqlReader)
                Catch constrExc As System.Data.ConstraintException
                    Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
                    HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in ReturnContactInformation_Report load datatable" + constrExc.Message
                End Try

                SqlReader.Close()


                If Not IsNothing(atemptable) Then
                    If atemptable.Rows.Count > 0 Then

                        For Each Row As DataRow In atemptable.Rows

                            If Not IsDBNull(Row("contact_sirname")) Then
                                If Not String.IsNullOrEmpty(Row.Item("contact_sirname").ToString.Trim) Then
                                    strSirName = Row.Item("contact_sirname").ToString.Trim
                                End If
                            End If

                            If Not IsDBNull(Row("contact_first_name")) Then
                                If Not String.IsNullOrEmpty(Row.Item("contact_first_name").ToString.Trim) Then
                                    strFName = Row.Item("contact_first_name").ToString.Trim
                                End If
                            End If

                            If Not IsDBNull(Row("contact_middle_initial")) Then
                                If Not String.IsNullOrEmpty(Row.Item("contact_middle_initial").ToString.Trim) Then
                                    strMiddle = Row.Item("contact_middle_initial").ToString.Trim + Constants.cDot
                                End If
                            End If

                            If Not IsDBNull(Row("contact_last_name")) Then
                                If Not String.IsNullOrEmpty(Row.Item("contact_last_name").ToString.Trim) Then
                                    strLName = Row.Item("contact_last_name").ToString.Trim
                                End If
                            End If

                            If Not IsDBNull(Row("contact_suffix")) Then
                                If Not String.IsNullOrEmpty(Row.Item("contact_suffix").ToString.Trim) Then
                                    strSuffix = Row.Item("contact_suffix").ToString.Trim
                                End If
                            End If

                            If Not IsDBNull(Row("contact_title")) Then
                                If Not String.IsNullOrEmpty(Row.Item("contact_title").ToString.Trim) Then
                                    strTitle = Row.Item("contact_title").ToString.Trim
                                End If
                            End If

                            If Not IsDBNull(Row("contact_email_address")) Then
                                If Not String.IsNullOrEmpty(Row.Item("contact_email_address").ToString.Trim) Then
                                    strEMail = Row.Item("contact_email_address").ToString.Trim
                                End If
                            End If

                        Next

                    End If

                End If

            End If

            If bExcelReport Or bHtmlReport Then

                strContactInfo = "<td align='left' valign='middle' nowrap='nowrap'>" + strSirName + "</td>"
                strContactInfo += "<td align='left' valign='middle' nowrap='nowrap'>" + strFName + "</td>"
                strContactInfo += "<td align='left' valign='middle' nowrap='nowrap'>" + strMiddle + "</td>"
                strContactInfo += "<td align='left' valign='middle' nowrap='nowrap'>" + strLName + "</td>"
                strContactInfo += "<td align='left' valign='middle' nowrap='nowrap'>" + strSuffix + "</td>"
                strContactInfo += "<td align='left' valign='middle' nowrap='nowrap'>" + strTitle + "</td>"
                strContactInfo += "<td align='left' valign='middle' nowrap='nowrap'>" + strEMail + "</td>"

            ElseIf bTextCommaReport Then

                strContactInfo = Constants.QUOTE + strSirName + Constants.QUOTE + Constants.cCommaDelim
                strContactInfo += Constants.QUOTE + strFName + Constants.QUOTE + Constants.cCommaDelim
                strContactInfo += Constants.QUOTE + strMiddle + Constants.QUOTE + Constants.cCommaDelim
                strContactInfo += Constants.QUOTE + strLName + Constants.QUOTE + Constants.cCommaDelim
                strContactInfo += Constants.QUOTE + strSuffix + Constants.QUOTE + Constants.cCommaDelim
                strContactInfo += Constants.QUOTE + strTitle + Constants.QUOTE + Constants.cCommaDelim
                strContactInfo += Constants.QUOTE + strEMail + Constants.QUOTE + Constants.cCommaDelim

            ElseIf bTextTabReport Then

                strContactInfo = strSirName + vbTab
                strContactInfo += strFName + vbTab
                strContactInfo += strMiddle + vbTab
                strContactInfo += strLName + vbTab
                strContactInfo += strSuffix + vbTab
                strContactInfo += strTitle + vbTab
                strContactInfo += strEMail + vbTab

            End If

            strContactPhoneInfo = ReturnContactPhoneInformation_Report(lCompID, lJournID, lContactID)

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in ReturnContactInformation_Report(ByVal lCompID As Long, ByVal lContactID As Long, ByVal lJournID As Long, ByRef strContactInfo As String, ByRef strContactPhoneInfo As String) As String" + ex.Message
        Finally
            SqlReader = Nothing

            atemptable = Nothing

            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing
        End Try

    End Sub

    Public Function ReturnInFavorOfInformation(ByVal lACId As Long, ByVal lCompId As Long, ByVal bLastField As Boolean) As String

        Dim strInFavorOfName As String = ""
        Dim strDocDate As String = ""
        Dim strDocType As String = ""
        Dim strDocAmount As String = ""
        Dim strResults As String = ""

        Try

            If (lACId > 0) And (lCompId > 0) Then
                localFunctions.get_in_favor_of_info(lACId, lCompId, strInFavorOfName, strDocDate, strDocType, strDocAmount)
            End If ' If (lACId > 0) And (lCompId > 0) Then

            If bExcelReport Or bHtmlReport Then

                strResults = "<td>" + strInFavorOfName + "</td>"
                strResults += "<td>" + strDocDate + "</td>"
                strResults += "<td>" + strDocType + "</td>"
                strResults += "<td>" + strDocAmount + "</td>"

                If bLastField Then
                    strResults += "</tr>" + vbCrLf
                End If

            ElseIf bTextCommaReport Then

                strResults = Constants.QUOTE + strInFavorOfName + Constants.QUOTE + Constants.cCommaDelim
                strResults += Constants.QUOTE + strDocDate + Constants.QUOTE + Constants.cCommaDelim
                strResults += Constants.QUOTE + strDocType + Constants.QUOTE + Constants.cCommaDelim
                strResults += Constants.QUOTE + strDocAmount + Constants.QUOTE

                If bLastField Then
                    strResults += vbCrLf
                End If

            ElseIf bTextTabReport Then

                strResults = strInFavorOfName + vbTab
                strResults += strDocDate + vbTab
                strResults += strDocType + vbTab
                strResults += strDocAmount

                If bLastField Then
                    strResults += vbCrLf
                End If

            End If ' ElseIf strFormat = "TAB" Then

        Catch ex As Exception

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in ReturnInFavorOfInformation(ByVal lACId As Long, ByVal lJournId As Long, ByVal lCompId As Long, ByVal bLastField As Boolean) As String" + ex.Message

        End Try

        Return strResults

    End Function

    Public Sub ReturnCompanyInformation_Report(ByVal inCompanyID As Long, ByVal inJournalID As Long, ByRef currentrow As DataRow, ByRef outCompPhoneInfo As String, ByRef outCompInfo As String, ByVal b_IncludeContacts As Boolean)

        Dim strCompName As String = ""
        Dim strBusTypeName As String = ""
        Dim strAltCompType As String = ""
        Dim strAltCompName As String = ""
        Dim strEMail As String = ""
        Dim strWebAddress As String = ""
        Dim strAddress1 As String = ""
        Dim strAddress2 As String = ""
        Dim strCity As String = ""
        Dim strStateName As String = ""
        Dim strState As String = ""
        Dim strZipCode As String = ""
        Dim strCountry As String = ""
        Dim optFormat As String = ""

        Try

            If Not IsNothing(currentrow) Then

                If Not IsDBNull(currentrow.Item("comp_name")) Then
                    strCompName = currentrow.Item("comp_name").ToString.Trim
                End If

                If currentrow.Table.Columns.Contains("comp_cbus_name") Then

                    If Not IsDBNull(currentrow.Item("comp_cbus_name")) Then
                        strBusTypeName = currentrow.Item("comp_cbus_name").ToString.Trim
                    End If

                End If

                If Not IsDBNull(currentrow.Item("comp_name_alt_type")) Then
                    strAltCompType = currentrow.Item("comp_name_alt_type").ToString.Trim
                End If

                If Not IsDBNull(currentrow.Item("comp_name_alt")) Then
                    If Not String.IsNullOrEmpty(strAltCompType) Then
                        strAltCompName = strAltCompType + " " + currentrow.Item("comp_name_alt").ToString.Trim
                    Else
                        strAltCompName = currentrow.Item("comp_name_alt").ToString.Trim
                    End If
                End If

                If Not IsDBNull(currentrow.Item("comp_email_address")) Then
                    If Not String.IsNullOrEmpty(currentrow.Item("comp_email_address").ToString.Trim) Then
                        strEMail = currentrow.Item("comp_email_address").ToString.Trim
                    Else
                        strEMail = localFunctions.get_first_contact_email_address_report(inCompanyID, inJournalID).Trim
                    End If
                Else
                    strEMail = localFunctions.get_first_contact_email_address_report(inCompanyID, inJournalID).Trim
                End If

                If Not IsDBNull(currentrow.Item("comp_web_address")) Then
                    strWebAddress = currentrow.Item("comp_web_address").ToString.Trim
                End If

                If Not IsDBNull(currentrow.Item("comp_address1")) Then
                    strAddress1 = currentrow.Item("comp_address1").ToString.Trim
                End If

                If Not IsDBNull(currentrow.Item("comp_address2")) Then
                    strAddress2 = currentrow.Item("comp_address2").ToString.Trim
                End If

                If Not IsDBNull(currentrow.Item("comp_city")) Then
                    strCity = currentrow.Item("comp_city").ToString.Trim
                End If

                If Not IsDBNull(currentrow.Item("comp_state")) Then
                    strState = currentrow.Item("comp_state").ToString.Trim
                End If

                If Not IsDBNull(currentrow.Item("comp_country")) Then
                    strCountry = currentrow.Item("comp_country").ToString.Trim
                End If

                If currentrow.Table.Columns.Contains("state_name") Then
                    If Not IsDBNull(currentrow.Item("state_name")) Then
                        strStateName = currentrow.Item("state_name").ToString.Trim
                    End If
                Else
                    If Not String.IsNullOrEmpty(strState.Trim) And Not String.IsNullOrEmpty(strCountry.Trim) Then
                        strStateName = localFunctions.get_state_name_report(strState, strCountry)
                    End If
                End If

                If Not IsDBNull(currentrow.Item("comp_zip_code")) Then
                    If Not String.IsNullOrEmpty(currentrow.Item("comp_zip_code").ToString.Trim) Then
                        strZipCode = currentrow.Item("comp_zip_code").ToString.Trim
                    End If
                End If

                If bExcelReport Or bHtmlReport Then

                    outCompInfo = ("<td align='left' valign='middle' nowrap='nowrap'>" + strCompName + "</td><td align='left' valign='middle' nowrap='nowrap'>" + strAltCompName + "</td>")

                    If currentrow.Table.Columns.Contains("comp_cbus_name") Then
                        outCompInfo += "<td align='left' valign='middle' nowrap='nowrap'>" + strBusTypeName + "</td>"
                    End If

                    outCompInfo += ("<td align='left' valign='middle' nowrap='nowrap'>" + strEMail + "</td><td align='left' valign='middle' nowrap='nowrap'>" + strWebAddress + "</td><td align='left' valign='middle' nowrap='nowrap'>" + strAddress1 + "</td><td align='left' valign='middle' nowrap='nowrap'>" + strAddress2 + "</td><td align='left' valign='middle' nowrap='nowrap'>" + strCity + "</td><td align='left' valign='middle' nowrap='nowrap'>" + strStateName + "</td><td align='left' valign='middle' nowrap='nowrap'>" + strState + "</td><td align='left' valign='middle' nowrap='nowrap' class='textformat'>" + strZipCode + "</td><td align='left' valign='middle' nowrap='nowrap'>" + strCountry + "</td>")

                ElseIf bTextCommaReport Then

                    outCompInfo = (Constants.QUOTE + strCompName + Constants.QUOTE + Constants.cCommaDelim + Constants.QUOTE + strAltCompName + Constants.QUOTE + Constants.cCommaDelim)
                    If currentrow.Table.Columns.Contains("comp_cbus_name") Then
                        outCompInfo += Constants.QUOTE + strBusTypeName + Constants.QUOTE + Constants.cCommaDelim
                    End If
                    outCompInfo += (Constants.QUOTE + strEMail + Constants.QUOTE + Constants.cCommaDelim + Constants.QUOTE + strWebAddress + Constants.QUOTE + Constants.cCommaDelim + Constants.QUOTE + strAddress1 + Constants.QUOTE + Constants.cCommaDelim + Constants.QUOTE + strAddress2 + Constants.QUOTE + Constants.cCommaDelim + Constants.QUOTE + strCity + Constants.QUOTE + Constants.cCommaDelim + Constants.QUOTE + strStateName + Constants.QUOTE + Constants.cCommaDelim + Constants.QUOTE + strState + Constants.QUOTE + Constants.cCommaDelim + Constants.QUOTE + strZipCode + Constants.QUOTE + Constants.cCommaDelim + Constants.QUOTE + strCountry + Constants.QUOTE + Constants.cCommaDelim)

                ElseIf bTextTabReport Then

                    outCompInfo = strCompName + vbTab
                    outCompInfo += strAltCompName + vbTab
                    If currentrow.Table.Columns.Contains("comp_cbus_name") Then
                        outCompInfo += strBusTypeName + vbTab
                    End If
                    outCompInfo += (strEMail + vbTab + strWebAddress + vbTab + strAddress1 + vbTab + strAddress2 + vbTab + strCity + vbTab + strStateName + vbTab + strState + vbTab + strZipCode + vbTab + strCountry + vbTab)

                End If

            Else

                If bExcelReport Or bHtmlReport Then

                    outCompInfo = "<td></td><td></td>"

                    If Not IsNothing(currentrow) Then
                        If currentrow.Table.Columns.Contains("comp_cbus_name") Then
                            outCompInfo += "<td></td>"
                        End If
                    End If

                    outCompInfo += "<td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>"

                ElseIf bTextCommaReport Then

                    outCompInfo = Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim
                    outCompInfo += Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim

                    If Not IsNothing(currentrow) Then
                        If currentrow.Table.Columns.Contains("comp_cbus_name") Then
                            outCompInfo += Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim
                        End If
                    End If

                    outCompInfo += Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim
                    outCompInfo += Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim
                    outCompInfo += Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim
                    outCompInfo += Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim
                    outCompInfo += Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim
                    outCompInfo += Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim
                    outCompInfo += Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim
                    outCompInfo += Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim
                    outCompInfo += Constants.QUOTE + Constants.QUOTE + Constants.cCommaDelim

                ElseIf bTextTabReport Then

                    outCompInfo = vbTab
                    outCompInfo += vbTab

                    If Not IsNothing(currentrow) Then
                        If currentrow.Table.Columns.Contains("comp_cbus_name") Then
                            outCompInfo += vbTab
                        End If
                    End If

                    outCompInfo += (vbTab + vbTab + vbTab + vbTab + vbTab + vbTab + vbTab + vbTab + vbTab)

                End If

            End If

            outCompPhoneInfo = ReturnCompanyPhoneInformation_Report(inCompanyID, inJournalID, b_IncludeContacts)

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in ReturnCompanyInformation_Report(ByVal inCompanyID As Long, ByVal inJournalID As Long, ByRef currentrow As DataRow, ByRef outCompPhoneInfo As String, ByRef outCompInfo As String, ByVal b_IncludeContacts As Boolean)" + ex.Message
        End Try

    End Sub

    Public Function ReturnAircraftReferenceCompanyInformation_Report(ByVal nAircraftID As Long, ByVal nAircraftJournalID As Long, ByVal bShowPhoneNumbers As Boolean) As String

        Dim sQuery As New StringBuilder()
        Dim htmlOut As New StringBuilder()
        Dim atemptable As New DataTable

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader = Nothing
        Dim SqlException As SqlClient.SqlException = Nothing

        Dim bLocalContactInfo As Boolean = False

        Dim strContactTitleGroup As String = ""
        Dim strContactFirstName As String = ""
        Dim strContactLastName As String = ""

        Dim nCompCounter As Long = 0
        Dim comp_ids() As String = Nothing

        Try

            If Not IsNothing(HttpContext.Current.Session.Item("searchCriteria").SearchCriteriaCompanyContactTitle) Then
                strContactTitleGroup = HttpContext.Current.Session.Item("searchCriteria").SearchCriteriaCompanyContactTitle.ToString
            End If

            If Not IsNothing(HttpContext.Current.Session.Item("searchCriteria").SearchCriteriaCompanyContactFirstName) Then
                strContactFirstName = HttpContext.Current.Session.Item("searchCriteria").SearchCriteriaCompanyContactFirstName.ToString
            End If

            If Not IsNothing(HttpContext.Current.Session.Item("searchCriteria").SearchCriteriaCompanyContactLastName) Then
                strContactLastName = HttpContext.Current.Session.Item("searchCriteria").SearchCriteriaCompanyContactLastName.ToString
            End If

            If Not String.IsNullOrEmpty(strContactTitleGroup.Trim) Or
                Not String.IsNullOrEmpty(strContactTitleGroup.Trim) Or
                Not String.IsNullOrEmpty(strContactTitleGroup.Trim) Then
                bLocalContactInfo = True
            End If

            sQuery.Append("SELECT Aircraft_Reference.*, Company.*, actype_name FROM Aircraft_Reference WITH(NOLOCK)")
            sQuery.Append(" INNER JOIN Company WITH(NOLOCK) ON (cref_comp_id = comp_id And cref_journ_id = comp_journ_id)")

            If bLocalContactInfo Then
                sQuery.Append(" INNER JOIN Contact WITH(NOLOCK) ON (contact_comp_id = comp_id And contact_journ_id = comp_journ_id)")
            End If

            sQuery.Append(" INNER JOIN Business_Type_Reference WITH(NOLOCK) ON (cref_comp_id = bustypref_comp_id And cref_journ_id = bustypref_journ_id)")
            sQuery.Append(" INNER JOIN Aircraft_Contact_Type WITH(NOLOCK) ON (cref_contact_type = actype_code)")

            sQuery.Append(" WHERE (cref_ac_id = " + nAircraftID.ToString + " And cref_journ_id = " + nAircraftJournalID.ToString)

            ' Hide Exclusive Brokers and Representatives and Dealers from Aerodex users
            If bAerodexFlag Then
                sQuery.Append(" And cref_contact_type Not IN ('93','98','99','71','44')")
            Else
                sQuery.Append(" AND cref_contact_type NOT IN ('71','44')")
            End If

            If nAircraftJournalID = 0 Then
                sQuery.Append(" AND comp_active_flag = 'Y'")
            End If

            sQuery.Append(" AND comp_hide_flag = 'N')")
            sQuery.Append(" " + commonEvo.MakeCompanyProductCodeClause(HttpContext.Current.Session.Item("localPreferences"), False))
            sQuery.Append(" ORDER BY cref_transmit_seq_no, comp_name")

            SqlConn.ConnectionString = localFunctions.clientConnectStr
            SqlConn.Open()
            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString

            SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

            Try
                atemptable.Load(SqlReader)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
                HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in ReturnAircraftReferenceCompanyInformation_Report load datatable" + constrExc.Message
            End Try

            SqlReader.Close()


            If Not IsNothing(atemptable) Then

                If atemptable.Rows.Count > 0 Then

                    If bExcelReport Or bHtmlReport Then
                        htmlOut.Append("<table border='0' cellpadding='2' cellspacing='0' width='100%'>")
                    End If

                    ' get unique array of cref_company ids (because result set is sorted by cref_transmit_seq_no)
                    ' cant just ramble through dataset checking previous comp_id <> current comp_id

                    ' IE  cref_id = 1124    cref_id=84 cref_comp_id = 114 cref_transmit_seq_no 1
                    ' IE  cref_id = 2970244 cref_id=84 cref_comp_id = 308681 cref_transmit_seq_no 2
                    ' IE  cref_id = 2970244 cref_id=84 cref_comp_id = 308681 cref_transmit_seq_no 2
                    ' IE  cref_id = 3574391 cref_id=84 cref_comp_id = 15588 cref_transmit_seq_no 4
                    ' IE  cref_id = 2970243 cref_id=84 cref_comp_id = 114 cref_transmit_seq_no 99

                    For Each Row As DataRow In atemptable.Rows

                        If Not commonEvo.inMyArray(comp_ids, Row.Item("cref_comp_id").ToString.Trim) Then

                            If Not IsArray(comp_ids) And IsNothing(comp_ids) Then
                                ReDim comp_ids(nCompCounter)
                            Else
                                ReDim Preserve comp_ids(nCompCounter)
                            End If

                            If bExcelReport Or bHtmlReport Then
                                htmlOut.Append("<tr><td valign='top' align='left' width='98%'><b>")
                            End If

                            htmlOut.Append(Contact_ProcessingAircraftReferenceCompany_Report(atemptable.Select("cref_comp_id = " + Row.Item("cref_comp_id").ToString)) + "</b>")

                            If bExcelReport Or bHtmlReport Then
                                htmlOut.Append(commonEvo.get_company_info_from_datarow(Row, nAircraftJournalID, bShowPhoneNumbers, False, "", ""))
                            Else
                                ' clean out any html "tags"
                                htmlOut.Append(Replace(commonEvo.get_company_info_from_datarow(Row, nAircraftJournalID, bShowPhoneNumbers, False, "", ""), "<br />", " "))
                            End If

                            If bExcelReport Or bHtmlReport Then
                                htmlOut.Append("</td></tr>")
                            End If

                            ' Add comp_ids To Array
                            comp_ids(nCompCounter) = Row.Item("cref_comp_id").ToString.Trim
                            nCompCounter += 1

                        End If

                    Next

                    If bExcelReport Or bHtmlReport Then
                        htmlOut.Append("</table>")
                    End If

                End If

            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in ReturnAircraftReferenceCompanyInformation_Report(ByVal nAircraftID As Long, ByVal nAircraftJournalID As Long) As String" + ex.Message
        Finally

            SqlReader = Nothing

            atemptable = Nothing

            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing
        End Try

        Return htmlOut.ToString

        htmlOut = Nothing
        sQuery = Nothing

    End Function

    Public Function Contact_ProcessingAircraftReferenceCompany_Report(ByVal currentRows() As DataRow) As String

        Dim htmlOut As New StringBuilder()

        Dim strContactTypeName As String = ""
        Dim tmpContactTypeName As String = ""

        Try

            If Not IsNothing(currentRows) Then

                If currentRows.Count > 0 Then

                    For Each Row As DataRow In currentRows

                        tmpContactTypeName = ""

                        Select Case (Row.Item("cref_contact_type").ToString)

                            Case "66", "67", "68"
                                If strContactTypeName.ToUpper.Contains("ADDITIONAL COMPANY") Then
                                    tmpContactTypeName = "Additional Company"
                                End If
                            Case Else

                                If commonEvo.DoesCompanyHaveShareRelationships(CLng(Row.Item("cref_id").ToString)) Then
                                    'tmpContactTypeName = "<a class='underline' onclick='javascript:openSmallWindowJS(" & QUOTE & "DisplayShareRelationships.asp?inCrefID=" & adoRs("cref_id").value & "&inCompID=" & inCompID & "&inContactID=" & adoRs("cref_contact_id").value & "&inACID=" & adoRs("cref_ac_id").value & QUOTE & ");' title='Display Share Relationships'>" & Replace(CleanUserData(Trim(adoRs("actype_name").value), cSingleSpace, cHTMLnbsp, False), "/Contact", "") & "&nbsp;[" & adoRs("cref_owner_percent").value & "%]</a>"
                                Else

                                    If Not strContactTypeName.ToUpper.Contains(Row.Item("actype_name").ToString.Replace("/Contact", "").ToUpper) Then
                                        tmpContactTypeName = Row.Item("actype_name").ToString.Replace("/Contact", "")
                                    End If

                                    If Not IsDBNull(Row.Item("cref_owner_percent")) Then
                                        If Not String.IsNullOrEmpty(Row.Item("cref_owner_percent").ToString) Then
                                            If CDbl(Row.Item("cref_owner_percent").ToString) > 0 And CDbl(Row.Item("cref_owner_percent").ToString) < 100 Then
                                                tmpContactTypeName += " [" + Row.Item("cref_owner_percent").ToString + "%]"
                                            End If
                                        End If
                                    End If

                                    If Not IsDBNull(Row.Item("cref_fraction_expires_date")) Then
                                        If Not String.IsNullOrEmpty(Row.Item("cref_fraction_expires_date").ToString) Then
                                            tmpContactTypeName += " [Expires : " + Row.Item("cref_fraction_expires_date").ToString + "]"
                                        End If
                                    End If
                                End If

                        End Select

                        If Not String.IsNullOrEmpty(strContactTypeName) Then
                            If Not strContactTypeName.ToUpper.Contains(Row.Item("actype_name").ToString.Replace("/Contact", "").ToUpper) Then
                                strContactTypeName += Constants.cCommaDelim + tmpContactTypeName
                            End If
                        Else
                            strContactTypeName = tmpContactTypeName
                        End If

                    Next

                    If Not String.IsNullOrEmpty(strContactTypeName) Then
                        htmlOut.Append(strContactTypeName.Replace(Constants.cCommaDelim, Constants.cSingleForwardSlash))
                    End If

                    If bExcelReport Or bHtmlReport Then
                        htmlOut.Append("&nbsp;-&nbsp;")
                    Else
                        htmlOut.Append(" - ")
                    End If

                End If

            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Contact_ProcessingAircraftReferenceCompany_Report(ByVal currentRows() As DataRow, ByVal inCompanyID As Long, ByVal inCompanyTypeNbr As String) As String" + ex.Message
        End Try

        Return htmlOut.ToString

        htmlOut = Nothing

    End Function

    Public Function ReturnYachtReferenceCompanyInformation_Report(ByVal nYachtID As Long, ByVal nYachtJournalID As Long, ByVal bShowPhoneNumbers As Boolean) As String

        Dim sQuery As New StringBuilder()
        Dim htmlOut As New StringBuilder()
        Dim atemptable As New DataTable

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader = Nothing
        Dim SqlException As SqlClient.SqlException = Nothing

        Dim bLocalContactInfo As Boolean = False

        Dim strContactTitleGroup As String = ""
        Dim strContactFirstName As String = ""
        Dim strContactLastName As String = ""

        Dim nCompCounter As Long = 0
        Dim comp_ids() As String = Nothing
        Dim comp_count As Integer = 1

        Try

            If Not IsNothing(HttpContext.Current.Session.Item("searchCriteria").SearchCriteriaCompanyContactTitle) Then
                strContactTitleGroup = HttpContext.Current.Session.Item("searchCriteria").SearchCriteriaCompanyContactTitle.ToString
            End If

            If Not IsNothing(HttpContext.Current.Session.Item("searchCriteria").SearchCriteriaCompanyContactFirstName) Then
                strContactFirstName = HttpContext.Current.Session.Item("searchCriteria").SearchCriteriaCompanyContactFirstName.ToString
            End If

            If Not IsNothing(HttpContext.Current.Session.Item("searchCriteria").SearchCriteriaCompanyContactLastName) Then
                strContactLastName = HttpContext.Current.Session.Item("searchCriteria").SearchCriteriaCompanyContactLastName.ToString
            End If

            If Not String.IsNullOrEmpty(strContactTitleGroup.Trim) Or
                Not String.IsNullOrEmpty(strContactTitleGroup.Trim) Or
                Not String.IsNullOrEmpty(strContactTitleGroup.Trim) Then
                bLocalContactInfo = True
            End If

            sQuery.Append("SELECT Yacht_Reference.*, Company.*, yct_name")

            If bLocalContactInfo Then
                sQuery.Append(",contact_id, contact_sirname, contact_first_name, contact_middle_initial, contact_last_name, contact_suffix, contact_title, contact_email_address")
            End If

            sQuery.Append(" FROM Yacht_Reference WITH(NOLOCK) INNER JOIN company WITH(NOLOCK) ON yr_comp_id = comp_id AND yr_journ_id = comp_journ_id")
            sQuery.Append(" INNER JOIN yacht_contact_Type WITH(NOLOCK) ON (yr_contact_type = yct_code)")

            If bLocalContactInfo Then
                sQuery.Append(" LEFT OUTER JOIN contact WITH(NOLOCK) ON yr_contact_id = contact_id AND yr_journ_id = contact_journ_id AND contact_hide_flag = 'N'")
            End If

            sQuery.Append(" WHERE (yr_yt_id = " + nYachtID.ToString + " AND yr_journ_id = " + nYachtJournalID.ToString)

            sQuery.Append(" AND yr_contact_type NOT IN ('71')")

            ' Hide Exclusive Brokers and Representatives and Dealers from Aerodex users
            If bAerodexFlag Then
                sQuery.Append(" AND yr_contact_type NOT IN ('93','98','99','71')")
            Else
                sQuery.Append(" AND yr_contact_type NOT IN ('71')")
            End If

            If nYachtJournalID = 0 Then
                sQuery.Append(" AND comp_active_flag = 'Y'")
            End If

            sQuery.Append(" AND comp_hide_flag = 'N')")

            sQuery.Append(" ORDER BY yct_seq_no, yr_seq_no, yr_contact_type, comp_name")

            SqlConn.ConnectionString = localFunctions.clientConnectStr
            SqlConn.Open()
            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString

            SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

            Try
                atemptable.Load(SqlReader)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
                HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in ReturnYachtReferenceCompanyInformation_Report load datatable" + constrExc.Message
            End Try

            SqlReader.Close()


            If Not IsNothing(atemptable) Then

                If atemptable.Rows.Count > 0 Then

                    If bExcelReport Or bHtmlReport Then
                        htmlOut.Append("<table border='0' cellpadding='2' cellspacing='0' width='100%'>")
                    End If

                    ' get unique array of cref_company ids (because result set is sorted by cref_transmit_seq_no)
                    ' cant just ramble through dataset checking previous comp_id <> current comp_id

                    ' IE  yr_id = 1124    yr_id=84 yr_comp_id = 114 yr_transmit_seq_no 1
                    ' IE  yr_id = 2970244 yr_id=84 yr_comp_id = 308681 yr_transmit_seq_no 2
                    ' IE  yr_id = 2970244 yr_id=84 yr_comp_id = 308681 yr_transmit_seq_no 2
                    ' IE  yr_id = 3574391 yr_id=84 yr_comp_id = 15588 yr_transmit_seq_no 4
                    ' IE  yr_id = 2970243 yr_id=84 yr_comp_id = 114 yr_transmit_seq_no 99

                    For Each Row As DataRow In atemptable.Rows

                        If Not commonEvo.inMyArray(comp_ids, Row.Item("yr_comp_id").ToString.Trim) Then

                            If Not IsArray(comp_ids) And IsNothing(comp_ids) Then
                                ReDim comp_ids(nCompCounter)
                            Else
                                ReDim Preserve comp_ids(nCompCounter)
                            End If

                            If bExcelReport Or bHtmlReport Then
                                htmlOut.Append("<tr><td valign='top' align='left'>COMPANY" + (nCompCounter + 1).ToString + " <b>")
                            End If

                            htmlOut.Append(Contact_ProcessingYachtReferenceCompany_Report(atemptable.Select("yr_comp_id = " + Row.Item("yr_comp_id").ToString)) + "</b>")

                            If bExcelReport Or bHtmlReport Then
                                htmlOut.Append(commonEvo.get_company_info_from_datarow(Row, nYachtJournalID, bShowPhoneNumbers, False, "", ""))
                            Else
                                ' clean out any html "tags"
                                htmlOut.Append(Replace(commonEvo.get_company_info_from_datarow(Row, nYachtJournalID, bShowPhoneNumbers, False, "", ""), "<br />", " "))
                            End If

                            If bExcelReport Or bHtmlReport Then
                                htmlOut.Append("</td></tr>")
                            End If

                            ' Add comp_ids To Array
                            comp_ids(nCompCounter) = Row.Item("yr_comp_id").ToString.Trim
                            nCompCounter += 1

                        End If

                    Next

                    If bExcelReport Or bHtmlReport Then
                        htmlOut.Append("</table>")
                    End If

                End If

            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in ReturnYachtReferenceCompanyInformation_Report(ByVal nYachtID As Long, ByVal nYachtJournalID As Long, ByVal bShowPhoneNumbers As Boolean) As String" + ex.Message
        Finally

            SqlReader = Nothing

            atemptable = Nothing

            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing
        End Try

        Return htmlOut.ToString

        htmlOut = Nothing
        sQuery = Nothing

    End Function

    Public Function Contact_ProcessingYachtReferenceCompany_Report(ByVal currentRows() As DataRow) As String

        Dim htmlOut As New StringBuilder()

        Dim strContactTypeName As String = ""
        Dim tmpContactTypeName As String = ""

        Try

            If Not IsNothing(currentRows) Then

                If currentRows.Count > 0 Then

                    For Each Row As DataRow In currentRows

                        tmpContactTypeName = ""

                        Select Case (Row.Item("yr_contact_type").ToString)

                            Case "66", "67", "68"
                                If strContactTypeName.ToUpper.Contains("ADDITIONAL COMPANY") Then
                                    tmpContactTypeName = "Additional Company"
                                End If
                            Case Else

                                If commonEvo.DoesCompanyHaveShareRelationships(CLng(Row.Item("yr_id").ToString)) Then
                                    'tmpContactTypeName = "<a class='underline' onclick='javascript:openSmallWindowJS(" & QUOTE & "DisplayShareRelationships.asp?inCrefID=" & adoRs("cref_id").value & "&inCompID=" & inCompID & "&inContactID=" & adoRs("cref_contact_id").value & "&inACID=" & adoRs("cref_ac_id").value & QUOTE & ");' title='Display Share Relationships'>" & Replace(CleanUserData(Trim(adoRs("actype_name").value), cSingleSpace, cHTMLnbsp, False), "/Contact", "") & "&nbsp;[" & adoRs("cref_owner_percent").value & "%]</a>"
                                Else

                                    If Not strContactTypeName.ToUpper.Contains(Row.Item("yct_name").ToString.Replace("/Contact", "").ToUpper) Then
                                        tmpContactTypeName = Row.Item("yct_name").ToString.Replace("/Contact", "")
                                    End If

                                    If Not IsDBNull(Row.Item("yr_owner_percent")) Then
                                        If Not String.IsNullOrEmpty(Row.Item("yr_owner_percent").ToString) Then
                                            If CDbl(Row.Item("yr_owner_percent").ToString) > 0 And CDbl(Row.Item("yr_owner_percent").ToString) < 100 Then
                                                tmpContactTypeName += " [" + Row.Item("yr_owner_percent").ToString + "%]"
                                            End If
                                        End If
                                    End If

                                End If

                        End Select

                        If Not String.IsNullOrEmpty(strContactTypeName) Then
                            If Not strContactTypeName.ToUpper.Contains(Row.Item("yct_name").ToString.Replace("/Contact", "").ToUpper) Then
                                strContactTypeName += Constants.cCommaDelim + tmpContactTypeName
                            End If
                        Else
                            strContactTypeName = tmpContactTypeName
                        End If

                    Next

                    If Not String.IsNullOrEmpty(strContactTypeName) Then
                        htmlOut.Append(strContactTypeName.Replace(Constants.cCommaDelim, Constants.cSingleForwardSlash))
                    End If

                    If bExcelReport Or bHtmlReport Then
                        htmlOut.Append("&nbsp;-&nbsp;")
                    Else
                        htmlOut.Append(" - ")
                    End If

                End If

            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Contact_ProcessingYachtReferenceCompany_Report(ByVal currentRows() As DataRow, ByVal inCompanyID As Long, ByVal inCompanyTypeNbr As String) As String" + ex.Message
        End Try

        Return htmlOut.ToString

        htmlOut = Nothing

    End Function

    Public Function Display_AircraftHistoryBlock_Report(ByRef currentrow As DataRow) As String

        ' History Status Block
        Dim htmlOut As StringBuilder = New StringBuilder()

        Try

            If Not IsNothing(currentrow) Then

                htmlOut.Append("<table border='1' cellpadding='2' cellspacing='0' width='100%'><tr bgcolor='#CCCCCC'>")
                htmlOut.Append("<td colspan='3' align='center' valign='middle'><strong>HISTORY INFORMATION AS OF : " + FormatDateTime(currentrow("journ_date").ToString, DateFormat.ShortDate) + "</strong></td></tr>")

                htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='center' valign='middle'><strong>Transaction Date</strong></td><td align='left' valign='middle'><strong>Type</strong></td><td align='left' valign='middle'><strong>Description</strong></td></tr>")

                htmlOut.Append("<tr><td align='center' valign='middle'>" + FormatDateTime(currentrow("journ_date").ToString, DateFormat.ShortDate) + "</td>")
                htmlOut.Append("<td align='left' valign='middle'>" + currentrow("jcat_subcategory_name").ToString.Trim + "</td>")

                If currentrow("jcat_auto_subject_flag").ToString.ToUpper = "Y" Then
                    htmlOut.Append("<td align='left' valign='middle'>" + currentrow.Item("jcat_subcategory_name").ToString.Trim)

                    If currentrow.Item("jcat_subcategory_name").ToString.ToLower.Contains("fractional sale") Then

                        Dim sFractionPercent As String = ""
                        Dim sFractionExpiresDate As String = ""

                        localFunctions.get_fraction_percent_and_expire_date(CLng(currentrow.Item("journ_id").ToString), True, sFractionPercent, sFractionExpiresDate)
                        htmlOut.Append(sFractionPercent + IIf(Not String.IsNullOrEmpty(sFractionExpiresDate.Trim), " [Expires : " + FormatDateTime(sFractionExpiresDate.Trim, DateFormat.ShortDate) + "]", ""))

                    End If

                    htmlOut.Append(" - " + currentrow.Item("journ_subject").ToString.Trim + "</td></tr>")
                Else
                    htmlOut.Append("<td align='left' valign='middle'>" + currentrow.Item("journ_subject").ToString.Trim + "</td></tr>")
                End If

                If Not IsDBNull(currentrow.Item("journ_customer_note")) And Not String.IsNullOrEmpty(currentrow.Item("journ_customer_note").ToString) Then
                    htmlOut.Append("<tr><td colspan='3' align='left' valign='middle'>Transaction Notes :<br />" + currentrow.Item("journ_customer_note").ToString.Trim + "</td></tr>")
                End If


                If HttpContext.Current.Session.Item("localSubscription").crmSalesPriceIndex_Flag = True Then
                    If Not IsDBNull(currentrow.Item("ac_sale_price")) Then
                        If currentrow.Item("ac_sale_price") > 0 Then
                            htmlOut.Append("<tr><td align='left' valign='middle' colspan='3'>Sale Price: $" + FormatNumber(currentrow.Item("ac_sale_price").ToString.Trim, 0) + "</td></tr>")
                        End If
                    End If
                End If

                htmlOut.Append("</table><br />")


            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Display_AircraftHistoryBlock_Report(ByRef currentrow As DataRow) As String" + ex.Message
        End Try

        Return htmlOut.ToString.Trim

        htmlOut = Nothing

    End Function

    Public Function Display_AircraftDetailsBlock_Report(ByRef in_AircraftRow As DataRow, ByRef in_JournalRow As DataRow, ByVal bShowSerial As Boolean, ByVal isConfidential As Boolean) As String

        Dim sSeparator As String = ""
        Dim htmlOut As StringBuilder = New StringBuilder()

        ' standard aircraft details block
        Try

            If Not IsNothing(in_AircraftRow) Then

                htmlOut.Append(Display_AircraftHistoryBlock_Report(in_JournalRow))

                htmlOut.Append("<table border='1' cellpadding='2' cellspacing='0' width='100%'><tr bgcolor='#CCCCCC'>")
                htmlOut.Append("<td valign='middle' align='center' colspan='10'><strong> AIRCRAFT IDENTIFICATION / STATUS ")

                If bShowSerial Then
                    htmlOut.Append(": [ Serial Number: <em>" + in_AircraftRow.Item("ac_ser_no_full").ToString.ToUpper.Trim + "</em>&nbsp;")
                    htmlOut.Append("&nbsp;&nbsp;&nbsp;Reg Number: <em>" + in_AircraftRow.Item("ac_reg_no").ToString.ToUpper.Trim + "</em>&nbsp;]<strong></td>")
                Else
                    htmlOut.Append(": [&nbsp;ID:&nbsp;<em>" + in_AircraftRow.Item("ac_id").ToString + "</em>&nbsp;]<strong></td>")
                End If

                htmlOut.Append("</tr>")

                ' first table row
                htmlOut.Append("<tr><td valign='middle' align='right'><strong>Make:&nbsp;</strong></td>")
                htmlOut.Append("<td valign='middle' align='left'>" + in_AircraftRow.Item("amod_make_name").ToString + "&nbsp;</td>")
                htmlOut.Append("<td valign='middle' align='right'><strong>Year&nbsp;of&nbsp;Delivery:&nbsp;</strong></td>")

                If Not IsDBNull(in_AircraftRow.Item("ac_year")) Then
                    If Not String.IsNullOrEmpty(in_AircraftRow.Item("ac_year").ToString.Trim) Then
                        htmlOut.Append("<td valign='middle' align='left'>" + in_AircraftRow.Item("ac_year").ToString + "&nbsp;</td>")
                    Else
                        htmlOut.Append("<td valign='middle' align='left'>&nbsp;</td>")
                    End If
                Else
                    htmlOut.Append("<td valign='middle' align='left'>&nbsp;</td>")
                End If

                If chkIncludeBaseLocation.Checked Then

                    htmlOut.Append("<td valign='middle' align='right'><strong>Airport:&nbsp;</strong></td>")
                    htmlOut.Append("<td valign='middle' align='left' colspan='3'>")

                    If Not IsDBNull(in_AircraftRow.Item("ac_aport_iata_code").ToString) Then
                        If Not String.IsNullOrEmpty(in_AircraftRow.Item("ac_aport_iata_code").ToString.Trim) Then
                            htmlOut.Append(in_AircraftRow.Item("ac_aport_iata_code").ToString.Trim)
                            sSeparator = " - "
                        End If
                    End If

                    If Not IsDBNull(in_AircraftRow.Item("ac_aport_icao_code").ToString) Then
                        If Not String.IsNullOrEmpty(in_AircraftRow.Item("ac_aport_icao_code").ToString.Trim) Then
                            htmlOut.Append(sSeparator + in_AircraftRow.Item("ac_aport_icao_code").ToString.Trim)
                            sSeparator = " - "
                        End If
                    End If

                    If Not IsDBNull(in_AircraftRow.Item("ac_aport_name").ToString) Then
                        If Not String.IsNullOrEmpty(in_AircraftRow.Item("ac_aport_name").ToString.Trim) Then
                            htmlOut.Append(sSeparator + in_AircraftRow.Item("ac_aport_name").ToString.Trim)
                        End If
                    End If

                    If Not String.IsNullOrEmpty(sSeparator.Trim) Then
                        sSeparator = "<br />"
                    End If

                    If Not IsDBNull(in_AircraftRow.Item("ac_aport_city").ToString) Then
                        If Not String.IsNullOrEmpty(in_AircraftRow.Item("ac_aport_city").ToString.Trim) Then
                            htmlOut.Append(in_AircraftRow.Item("ac_aport_city").ToString.Trim)
                            sSeparator = " - "
                        End If
                    End If

                    If Not IsDBNull(in_AircraftRow.Item("ac_aport_state").ToString) Then
                        If Not String.IsNullOrEmpty(in_AircraftRow.Item("ac_aport_state").ToString.Trim) Then
                            htmlOut.Append(in_AircraftRow.Item("ac_aport_state").ToString.Trim)
                            sSeparator = " - "
                        End If
                    End If

                    If Not IsDBNull(in_AircraftRow.Item("ac_aport_country").ToString) Then
                        If Not String.IsNullOrEmpty(in_AircraftRow.Item("ac_aport_country").ToString.Trim) Then
                            htmlOut.Append(sSeparator + in_AircraftRow.Item("ac_aport_country").ToString.Trim)
                        End If
                    End If

                    If String.IsNullOrEmpty(sSeparator.Trim) Then
                        htmlOut.Append("&nbsp;")
                    End If

                    htmlOut.Append("</td>")

                Else
                    htmlOut.Append("<td valign='middle' align='right'><strong>Airport:&nbsp;</strong></td>")
                    htmlOut.Append("<td valign='middle' align='left' colspan='3'>&nbsp;</td>")
                End If

                htmlOut.Append("</tr>")

                ' second table row
                htmlOut.Append("<tr><td valign='middle' align='right'><strong>Model:&nbsp;</strong></td>")
                htmlOut.Append("<td valign='middle' align='left' nowrap='nowrap'>" + in_AircraftRow.Item("amod_model_name").ToString.Trim + "&nbsp;</td>")

                htmlOut.Append("<td valign='middle' align='right'><strong>Year&nbsp;of&nbsp;Mfr:&nbsp;</strong></td>")
                If Not IsDBNull(in_AircraftRow.Item("ac_mfr_year")) Then
                    If Not String.IsNullOrEmpty(in_AircraftRow.Item("ac_mfr_year").ToString.Trim) Then
                        htmlOut.Append("<td valign='middle' align='left'>" + in_AircraftRow.Item("ac_mfr_year").ToString + "&nbsp;</td>")
                    Else
                        htmlOut.Append("<td valign='middle' align='left'>&nbsp;</td>")
                    End If
                Else
                    htmlOut.Append("<td valign='middle' align='left'>&nbsp;</td>")
                End If

                htmlOut.Append("<td valign='middle' align='right'><strong>Serial&nbsp;Number:&nbsp;</strong></td>")
                If Not IsDBNull(in_AircraftRow.Item("ac_ser_no_full")) Then
                    If Not String.IsNullOrEmpty(in_AircraftRow.Item("ac_ser_no_full").ToString.Trim) Then
                        htmlOut.Append("<td valign='middle' align='left'>" + in_AircraftRow.Item("ac_ser_no_full").ToString + "&nbsp;</td>")
                    Else
                        htmlOut.Append("<td valign='middle' align='left'>&nbsp;</td>")
                    End If
                Else
                    htmlOut.Append("<td valign='middle' align='left'>&nbsp;</td>")
                End If

                htmlOut.Append("<td valign='middle' align='right'><strong>Alt&nbsp;Serial&nbsp;Number:&nbsp;</strong></td>")

                If Not IsDBNull(in_AircraftRow.Item("ac_alt_ser_no_full")) Then
                    If Not String.IsNullOrEmpty(in_AircraftRow.Item("ac_alt_ser_no_full").ToString.Trim) Then
                        htmlOut.Append("<td valign='middle' align='left'>" + in_AircraftRow.Item("ac_alt_ser_no_full").ToString + "&nbsp;</td>")
                    Else
                        htmlOut.Append("<td valign='middle' align='left'>&nbsp;</td>")
                    End If
                Else
                    htmlOut.Append("<td valign='middle' align='left'>&nbsp;</td>")
                End If

                htmlOut.Append("</tr><tr>")

                ' third table row
                htmlOut.Append("<tr><td valign='middle' align='right'><strong>Reg&nbsp;Number:" + localFunctions.get_reg_expire_date(in_AircraftRow.Item("ac_id"), in_AircraftRow.Item("ac_journ_id")) + "</strong></td>")

                If Not IsDBNull(in_AircraftRow.Item("ac_reg_no")) Then
                    If Not String.IsNullOrEmpty(in_AircraftRow.Item("ac_reg_no").ToString.Trim) Then
                        htmlOut.Append("<td valign='middle' align='left'>" + in_AircraftRow.Item("ac_reg_no").ToString + "&nbsp;</td>")
                    Else
                        htmlOut.Append("<td valign='middle' align='left'>&nbsp;</td>")
                    End If
                Else
                    htmlOut.Append("<td valign='middle' align='left'>&nbsp;</td>")
                End If

                htmlOut.Append("<td valign='middle' align='right'><strong>Prev&nbsp;Reg&nbsp;Number:&nbsp;</strong></td>")
                If Not IsDBNull(in_AircraftRow.Item("ac_prev_reg_no")) Then
                    If Not String.IsNullOrEmpty(in_AircraftRow.Item("ac_prev_reg_no").ToString.Trim) Then
                        htmlOut.Append("<td valign='middle' align='left'>" + in_AircraftRow.Item("ac_prev_reg_no").ToString + "&nbsp;</td>")
                    Else
                        htmlOut.Append("<td valign='middle' align='left'>&nbsp;</td>")
                    End If
                Else
                    htmlOut.Append("<td valign='middle' align='left'>&nbsp;</td>")
                End If

                ' Don't show status for Aerodex Users
                If bAerodexFlag And CLng(in_AircraftRow.Item("ac_journ_id").ToString) = 0 Then
                    htmlOut.Append("<td colspan='2' valign='middle' align='right'>&nbsp;</td>")
                Else

                    Dim strTemp As String = ""

                    If Not IsDBNull(in_AircraftRow.Item("ac_status")) Then
                        If Not String.IsNullOrEmpty(in_AircraftRow.Item("ac_status").ToString.Trim) Then
                            strTemp = in_AircraftRow.Item("ac_status").ToString.Trim
                        End If
                    End If

                    If isConfidential Then

                        If strTemp.ToUpper.Contains("CONFIDENTIAL") Then

                            If in_AircraftRow.Item("ac_forsale_flag").ToString.ToUpper.Contains("Y") Then
                                strTemp = "For&nbsp;Sale"
                            Else
                                strTemp = "Not&nbsp;For&nbsp;Sale"
                            End If

                        End If

                    End If

                    htmlOut.Append("<td valign='middle' align='right'><strong>Status:&nbsp;</strong></td>")
                    htmlOut.Append("<td valign='middle' align='left'>" + strTemp + "&nbsp;</td>")

                End If

                If CLng(in_AircraftRow.Item("ac_journ_id").ToString) > 0 Then
                    htmlOut.Append("<td valign='middle' align='right'><strong>Date&nbsp;Seller&nbsp;Purchased:&nbsp;</strong></td>")
                Else
                    htmlOut.Append("<td valign='middle' align='right'><strong>Purchase&nbsp;Date:&nbsp;</strong></td>")
                End If

                If Not IsDBNull(in_AircraftRow.Item("ac_purchase_date")) Then
                    If IsDate(in_AircraftRow.Item("ac_purchase_date").ToString) Then
                        htmlOut.Append("<td valign='middle' align='left'>" + FormatDateTime(in_AircraftRow.Item("ac_purchase_date").ToString, DateFormat.ShortDate) + "&nbsp;</td>")
                    Else
                        htmlOut.Append("<td valign='middle' align='left'>&nbsp;</td>")
                    End If
                Else
                    htmlOut.Append("<td valign='middle' align='left'>&nbsp;</td>")
                End If

                htmlOut.Append("</tr>")

                ' forth table row
                htmlOut.Append("<tr><td valign='middle' align='right'><strong>Life&nbsp;Cycle:&nbsp;</strong></td>")

                If Not IsDBNull(in_AircraftRow.Item("ac_lifecycle_stage")) Then
                    htmlOut.Append("<td valign='middle' align='left'>" + localFunctions.get_lifecycle_stage_report(CInt(in_AircraftRow.Item("ac_lifecycle_stage").ToString), True) + "&nbsp;</td>")
                Else
                    htmlOut.Append("<td valign='middle' align='left'>&nbsp;</td>")
                End If

                htmlOut.Append("<td valign='middle' align='right'><strong>Previously&nbsp;Owned:&nbsp;</strong></td>")

                If Not IsDBNull(in_AircraftRow.Item("ac_previously_owned_flag")) Then
                    If Not String.IsNullOrEmpty(in_AircraftRow.Item("ac_previously_owned_flag").ToString.Trim) Then
                        If in_AircraftRow.Item("ac_previously_owned_flag").ToString.ToUpper.Contains("Y") Then
                            htmlOut.Append("<td valign='middle' align='left'>Yes</td>")
                        Else
                            htmlOut.Append("<td valign='middle' align='left'>No</td>")
                        End If
                    Else
                        htmlOut.Append("<td valign='middle' align='left'></td>")
                    End If
                Else
                    htmlOut.Append("<td valign='middle' align='left'></td>")
                End If

                htmlOut.Append("<td valign='middle' align='right'><strong>Ownership&nbsp;Type:&nbsp;</strong></td>")
                If Not IsDBNull(in_AircraftRow.Item("ac_ownership_type")) Then
                    htmlOut.Append("<td colspan='3' valign='middle' align='left'>" + localFunctions.get_ownership_type_report(in_AircraftRow.Item("ac_ownership_type").ToString) + "&nbsp;</td></tr>")
                Else
                    htmlOut.Append("<td colspan='3' valign='middle' align='left'>&nbsp;</td></tr>")
                End If

                ' fifth table row
                ' do not show asking or for sale for Aerodex users
                If (Not bAerodexFlag) Or CLng(in_AircraftRow.Item("ac_journ_id").ToString) > 0 Then

                    If in_AircraftRow.Item("ac_forsale_flag").ToString.ToUpper.Contains("Y") Or CLng(in_AircraftRow.Item("ac_journ_id").ToString) > 0 Then

                        If CLng(in_AircraftRow.Item("ac_journ_id").ToString) = 0 Then
                            htmlOut.Append("<tr bgcolor='LightGreen'>")
                        Else
                            htmlOut.Append("<tr>")
                        End If

                        htmlOut.Append("<td valign='middle' align='right'><strong>For&nbsp;Sale:</strong></td>")

                        If Not IsDBNull(in_AircraftRow.Item("ac_delivery")) Then

                            If Not String.IsNullOrEmpty(in_AircraftRow.Item("ac_delivery").ToString.Trim) Then

                                If in_AircraftRow.Item("ac_delivery").ToString.ToLower.Contains("date") Then

                                    If Not IsDBNull(in_AircraftRow.Item("ac_delivery_date")) Then
                                        If Not String.IsNullOrEmpty(in_AircraftRow.Item("ac_delivery_date").ToString.Trim) Then
                                            If IsDate(in_AircraftRow.Item("ac_delivery_date")) Then
                                                htmlOut.Append("<td valign='middle' align='left'>" + FormatDateTime(in_AircraftRow.Item("ac_delivery_date").ToString, DateFormat.ShortDate) + "&nbsp;</td>")
                                            Else
                                                htmlOut.Append("<td valign='middle' align='left'>&nbsp;</td>")
                                            End If
                                        Else
                                            htmlOut.Append("<td valign='middle' align='left'>&nbsp;</td>")
                                        End If
                                    Else
                                        htmlOut.Append("<td valign='middle' align='left'>&nbsp;</td>")
                                    End If

                                Else
                                    htmlOut.Append("<td valign='middle' align='left'>" + in_AircraftRow.Item("ac_delivery").ToString.Trim + "&nbsp;</td>")
                                End If

                            Else
                                htmlOut.Append("<td valign='middle' align='left'>&nbsp;</td>")
                            End If

                        Else
                            htmlOut.Append("<td valign='middle' align='left'>&nbsp;</td>")
                        End If

                        If in_AircraftRow.Item("ac_forsale_flag").ToString.ToUpper.Contains("Y") Or CLng(in_AircraftRow.Item("ac_journ_id").ToString) > 0 Then
                            If CLng(in_AircraftRow.Item("ac_journ_id")) = 0 Then
                                If IsDate(in_AircraftRow.Item("ac_list_date").ToString) Then
                                    htmlOut.Append("<td valign='middle' align='right'><strong>Days&nbsp;On&nbsp;Market:&nbsp;" + DateDiff("d", in_AircraftRow.Item("ac_list_date").ToString, Now()).ToString + "</strong>&nbsp;</td>")
                                Else
                                    htmlOut.Append("<td valign='middle' align='right'><strong>Days&nbsp;On&nbsp;Market:&nbsp;&lt;Unknown&gt;</strong></td>")
                                End If
                            Else
                                If Not IsDBNull(in_JournalRow.Item("journ_date")) And Not IsDBNull(in_AircraftRow.Item("ac_list_date")) Then
                                    If IsDate(in_JournalRow.Item("journ_date").ToString) And IsDate(in_AircraftRow.Item("ac_list_date").ToString) Then
                                        htmlOut.Append("<td valign='middle' align='center'><strong>Days&nbsp;On&nbsp;Market:&nbsp;" + DateDiff("d", in_AircraftRow.Item("ac_list_date").ToString, in_JournalRow.Item("journ_date").ToString).ToString + "</strong>&nbsp;</td>")
                                    Else
                                        htmlOut.Append("<td valign='middle' align='center'><strong>Days&nbsp;On&nbsp;Market:&nbsp;&lt;Unknown&gt;</strong></td>")
                                    End If
                                Else
                                    htmlOut.Append("<td valign='middle' align='center'><strong>Days&nbsp;On&nbsp;Market:&nbsp;&lt;Unknown&gt;</strong></td>")
                                End If
                            End If

                        End If

                        If in_AircraftRow.Item("ac_asking").ToString.ToLower.Contains("price") Then

                            htmlOut.Append("<td valign='middle' align='right'>")

                            If Not IsDBNull(in_AircraftRow.Item("ac_foreign_currency_name")) Then
                                If Not String.IsNullOrEmpty(in_AircraftRow.Item("ac_delivery_date").ToString.Trim) Then
                                    htmlOut.Append("<strong>Asking&nbsp;Amt&nbsp;(" + in_AircraftRow.Item("ac_foreign_currency_name").ToString.Trim + ")&nbsp;:&nbsp</strong><br />")
                                End If
                            End If

                            htmlOut.Append("<strong>Asking&nbsp;Amt&nbsp;(USD)&nbsp;:&nbsp</strong></td>")
                            htmlOut.Append("<td valign='middle' align='left'>")

                            If Not IsDBNull(in_AircraftRow.Item("ac_foreign_currency_price")) Then
                                If Not String.IsNullOrEmpty(in_AircraftRow.Item("ac_foreign_currency_price").ToString.Trim) Then
                                    htmlOut.Append(FormatNumber(in_AircraftRow.Item("ac_foreign_currency_price"), 0, True, False, True) + "<br />")
                                End If
                            End If

                            If Not IsDBNull(in_AircraftRow.Item("ac_asking_price")) Then
                                If Not String.IsNullOrEmpty(in_AircraftRow.Item("ac_asking_price").ToString.Trim) Then
                                    htmlOut.Append("$" + FormatNumber(in_AircraftRow.Item("ac_asking_price"), 0, True, False, True))
                                End If
                            End If

                            If Not IsDBNull(in_AircraftRow.Item("ac_asking_price")) And Not IsDBNull(in_AircraftRow.Item("ac_foreign_currency_price")) Then
                                If String.IsNullOrEmpty(in_AircraftRow.Item("ac_asking_price").ToString.Trim) And String.IsNullOrEmpty(in_AircraftRow.Item("ac_foreign_currency_price").ToString.Trim) Then
                                    htmlOut.Append("&nbsp;")
                                End If
                            End If

                            htmlOut.Append("</td>")

                        Else

                            htmlOut.Append("<td valign='middle' align='right'>")

                            If Not IsDBNull(in_AircraftRow.Item("ac_foreign_currency_name")) Then
                                If Not String.IsNullOrEmpty(in_AircraftRow.Item("ac_delivery_date").ToString.Trim) Then
                                    htmlOut.Append("<strong>(" + in_AircraftRow.Item("ac_foreign_currency_name").ToString.Trim + ")&nbsp;:&nbsp;</strong><br />")
                                End If
                            End If

                            htmlOut.Append("<strong>Asking:&nbsp</strong></td>")
                            htmlOut.Append("<td valign='middle' align='left'>")


                            If Not IsDBNull(in_AircraftRow.Item("ac_foreign_currency_price")) Then
                                If Not String.IsNullOrEmpty(in_AircraftRow.Item("ac_foreign_currency_price").ToString.Trim) Then
                                    htmlOut.Append(FormatNumber(in_AircraftRow.Item("ac_foreign_currency_price"), 0, True, False, True) + "<br />")
                                End If
                            End If

                            If Not IsDBNull(in_AircraftRow.Item("ac_asking_price")) Then
                                If Not String.IsNullOrEmpty(in_AircraftRow.Item("ac_asking_price").ToString.Trim) Then
                                    htmlOut.Append("$" + FormatNumber(in_AircraftRow.Item("ac_asking_price"), 0, True, False, True))
                                End If
                            End If

                            If Not IsDBNull(in_AircraftRow.Item("ac_asking_price")) And Not IsDBNull(in_AircraftRow.Item("ac_foreign_currency_price")) Then
                                If String.IsNullOrEmpty(in_AircraftRow.Item("ac_asking_price").ToString.Trim) And String.IsNullOrEmpty(in_AircraftRow.Item("ac_foreign_currency_price").ToString.Trim) Then
                                    htmlOut.Append("&nbsp;")
                                End If
                            End If

                            htmlOut.Append("</td>")

                        End If ' in_AircraftRow.Item("ac_asking").ToString.ToLower.Contains("price") 

                        htmlOut.Append("<td colspan='2' valign='middle' align='right'><strong>Date&nbsp;Listed:</strong></td>")

                        If Not IsDBNull(in_AircraftRow.Item("ac_list_date")) Then
                            If IsDate(in_AircraftRow.Item("ac_list_date").ToString) Then
                                htmlOut.Append("<td valign='middle' align='left'>" + FormatDateTime(in_AircraftRow.Item("ac_list_date"), DateFormat.ShortDate) + "&nbsp;</td></tr>")
                            Else
                                htmlOut.Append("<td valign='middle' align='left'>&nbsp;</td></tr>")
                            End If
                        Else
                            htmlOut.Append("<td valign='middle' align='left'>&nbsp;</td></tr>")
                        End If

                    End If

                End If 'If (Not bAerodexFlag) Or CLng(in_AircraftRow.Item("ac_journ_id").ToString) > 0 Then

                Dim ac_exclusive_expiration_flag As String = localFunctions.get_exclusive_expiration_flag(CLng(in_AircraftRow.Item("ac_id").ToString), CLng(in_AircraftRow.Item("ac_journ_id").ToString))

                ' sixth table row
                ' Don't show exclusive info to Aerodex users
                If (Not bAerodexFlag) Or CLng(in_AircraftRow.Item("ac_journ_id").ToString) > 0 Then

                    If in_AircraftRow.Item("ac_exclusive_flag").ToString.ToUpper.Contains("Y") Then

                        If CLng(in_AircraftRow.Item("ac_journ_id").ToString) = 0 Then
                            htmlOut.Append("<tr><td valign='middle' align='right' bgcolor='#BF8CEA'><strong>")
                        Else
                            htmlOut.Append("<tr><td valign='middle' align='right'><strong>")
                        End If


                        Dim d_exclusiveDate As String = localFunctions.get_exclusive_date_report(CLng(in_AircraftRow.Item("ac_id").ToString), CLng(in_AircraftRow.Item("ac_journ_id").ToString))

                        If Not String.IsNullOrEmpty(d_exclusiveDate.Trim) Then
                            htmlOut.Append("On Exclusive With<br /><em>" + commonEvo.GetExclusiveBrokerCompany(CLng(in_AircraftRow.Item("ac_id").ToString), CLng(in_AircraftRow.Item("ac_journ_id").ToString)) + "</em> as of " + d_exclusiveDate + "</strong></td>")
                        Else
                            htmlOut.Append("On Exclusive With<br /><em>" + commonEvo.GetExclusiveBrokerCompany(CLng(in_AircraftRow.Item("ac_id").ToString), CLng(in_AircraftRow.Item("ac_journ_id").ToString)) + "</em></strong></td>")
                        End If



                        If Not String.IsNullOrEmpty(ac_exclusive_expiration_flag) Then
                            If ac_exclusive_expiration_flag.ToUpper.Contains("Y") Then

                                htmlOut.Append("<td valign='middle' align='right'><strong>Expiration&nbsp;Date:&nbsp;</strong></td>")

                                If Not IsDBNull(in_AircraftRow.Item("ac_exclusive_date")) Then
                                    If IsDate(in_AircraftRow.Item("ac_exclusive_date").ToString) Then
                                        htmlOut.Append("<td valign='middle' align='left'>" + FormatDateTime(in_AircraftRow.Item("ac_exclusive_date"), DateFormat.ShortDate) + "&nbsp;</td>")
                                    Else
                                        htmlOut.Append("<td valign='middle' align='left'>&nbsp;</td>")
                                    End If
                                Else
                                    htmlOut.Append("<td valign='middle' align='left'>&nbsp;</td>")
                                End If
                            Else
                                htmlOut.Append("<td valign='middle' align='left'>&nbsp;</td>")
                            End If
                        Else
                            htmlOut.Append("<td valign='middle' align='left'>&nbsp;</td>")
                        End If

                    End If

                End If ' (Not bAerodexFlag) Or CLng(in_AircraftRow.Item("ac_journ_id").ToString) > 0 

                If Not IsDBNull(in_AircraftRow.Item("ac_lease_flag")) Then
                    If in_AircraftRow.Item("ac_lease_flag").ToString.ToUpper.Contains("Y") Then

                        If CLng(in_AircraftRow.Item("ac_journ_id").ToString) = 0 Then
                            htmlOut.Append("<td valign='middle' align='center' bgcolor = 'Orange'><strong>")
                        Else
                            htmlOut.Append("<td valign='middle' align='center'><strong>")
                        End If

                        htmlOut.Append("Currently&nbsp;On&nbsp;Lease</strong></td>")
                    Else
                        htmlOut.Append("<td valign='middle' align='right'>&nbsp;</td>")
                    End If
                Else
                    htmlOut.Append("<td valign='middle' align='right'>&nbsp;</td>")
                End If

                htmlOut.Append("<td valign='middle' align='right'><strong>Last&nbsp;Change:</strong></td>")

                Dim nColSpan As Integer = 0

                If ac_exclusive_expiration_flag.ToUpper.Contains("Y") And Not bAerodexFlag Then
                    If ac_exclusive_expiration_flag.ToUpper.Contains("Y") Then
                        If in_AircraftRow.Item("ac_lease_flag").ToString.ToUpper.Contains("Y") Then
                            nColSpan = 4
                        Else
                            nColSpan = 5
                        End If
                    Else
                        If in_AircraftRow.Item("ac_lease_flag").ToString.ToUpper.Contains("Y") Then
                            nColSpan = 5
                        Else
                            nColSpan = 6
                        End If
                    End If
                Else
                    If in_AircraftRow.Item("ac_lease_flag").ToString.ToUpper.Contains("Y") Then
                        nColSpan = 6
                    Else
                        nColSpan = 7
                    End If
                End If

                If Not IsDBNull(in_AircraftRow.Item("ac_upd_date")) Then
                    If IsDate(in_AircraftRow.Item("ac_upd_date").ToString) Then
                        htmlOut.Append("<td valign='middle' align='left' colspan='" + nColSpan.ToString + "'>" + FormatDateTime(in_AircraftRow.Item("ac_upd_date").ToString, DateFormat.ShortDate) + "&nbsp;</td></tr>")
                    Else
                        htmlOut.Append("<td valign='middle' align='left' colspan='" + nColSpan.ToString + "'>&nbsp;</td></tr>")
                    End If
                Else
                    htmlOut.Append("<td valign='middle' align='left' colspan='" + nColSpan.ToString + "'>&nbsp;</td></tr>")
                End If


                If isConfidential Then

                    If Not bAerodexFlag Then

                        If Not IsDBNull(in_AircraftRow.Item("ac_confidential_notes")) Then
                            If Not String.IsNullOrEmpty(in_AircraftRow.Item("ac_confidential_notes").ToString.Trim) Then
                                htmlOut.Append("<tr><td colspan='10' align='left' valign='middle'>Note : " + in_AircraftRow.Item("ac_confidential_notes").ToString.Trim + "</td></tr>")
                            End If
                        End If

                    End If

                End If

                htmlOut.Append("</table>")

            Else
                htmlOut.Append("<table border='1' bordercolor='#949494' cellpadding='2' cellspacing='0'><tr>")
                htmlOut.Append("<td valign='middle' align='center' colspan='10' bgcolor='#CCCCCC'> AIRCRAFT IDENTIFICATION / STATUS ")

                htmlOut.Append(": [&nbsp;ID:&nbsp;<b>THERE WAS AN ERROR WITH SHOWING THIS AIRCRAFT</b>&nbsp;]</td>")

                htmlOut.Append("</tr>")
                htmlOut.Append("</table>")
            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in DisplayAircraft_HistoryBlock_Report(ByRef currentrow As DataRow) As String" + ex.Message
        End Try

        Return htmlOut.ToString.Trim

        htmlOut = Nothing

    End Function

    Public Function GetCompanies_DisplayAircraftDetails_Report(ByVal nAircraftID As Long, ByVal nAircraftJournalID As Long, ByVal isDisplay As Boolean) As String

        Dim sQuery As New StringBuilder()
        Dim htmlOut As New StringBuilder()

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlException As SqlClient.SqlException = Nothing
        Dim SqlDataAdapter As New SqlClient.SqlDataAdapter

        ' create a DataSet to hold the aircraft contacts
        Dim dsAircraftCompanies As New DataSet

        Dim strCompanyTypeNbr As String = ""
        Dim strCompanyTypeName As String = ""

        Dim fCompany_name As String = ""
        Dim fAirRef_contact_type As String = ""
        Dim fAirContactType_name As String = ""
        Dim fAirRef_fraction_expires_date As String = ""

        Dim nContactCount As Long = 0

        Dim fAirRef_company_id As Long = 0
        Dim fAirRef_old_company_id As Long = 0
        Dim fAirRef_company_journ_id As Long = 0
        Dim fAirRef_contact_id As Long = 0
        Dim fAirRef_ac_id As Long = 0
        Dim fAirRef_id As Long = 0
        Dim fAirRef_transmit_seq_no As Integer = 0
        Dim fAirRef_owner_percent As Integer = 0

        Try

            sQuery.Append("SELECT Aircraft_Reference.*, Company.*, actype_name FROM Aircraft_Reference WITH(NOLOCK)")
            sQuery.Append(" INNER JOIN Company WITH(NOLOCK) ON (cref_comp_id = comp_id AND cref_journ_id = comp_journ_id)")

            sQuery.Append(" INNER JOIN Aircraft_Contact_Type WITH(NOLOCK) ON (cref_contact_type = actype_code)")
            sQuery.Append(" WHERE (cref_ac_id = " + nAircraftID.ToString + " AND cref_journ_id = " + nAircraftJournalID.ToString)

            If nAircraftJournalID = 0 Then
                sQuery.Append(" AND comp_active_flag = 'Y'")
            End If

            ' Hide Exclusive Brokers and Representatives and Dealers from Aerodex users
            If bAerodexFlag Then
                sQuery.Append(" AND cref_contact_type NOT IN ('93','98','99','71')")
            Else
                sQuery.Append(" AND cref_contact_type NOT IN ('71')")
            End If

            sQuery.Append(" AND comp_hide_flag = 'N')")

            sQuery.Append(" ORDER BY cref_transmit_seq_no, comp_name")

            SqlConn.ConnectionString = localFunctions.clientConnectStr
            SqlConn.Open()
            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString

            ' set the Select Command to the Adapter
            SqlDataAdapter.SelectCommand = SqlCommand

            SqlDataAdapter.Fill(dsAircraftCompanies, "tblSQL")

            htmlOut.Append("<br /><table border='1' cellpadding='2' cellspacing='0' width='100%'><tr bgcolor='#CCCCCC'>")
            htmlOut.Append("<td colspan='2' align='center' valign='middle'><strong> COMPANY/CONTACT </strong></td></tr>")
            htmlOut.Append("<tr bgcolor='#CCCCCC'><td align='left' valign='middle'><strong>Company</strong></td><td align='left' valign='middle'><strong>Contact</strong></td></tr>")

            If Not IsNothing(dsAircraftCompanies) Then

                If dsAircraftCompanies.Tables(0).Rows.Count > 0 Then

                    Dim tmpCompanyArray() As String = Split(Get_ReferenceCompanyIDs_Report(dsAircraftCompanies), Constants.cCommaDelim)

                    For x As Integer = 0 To UBound(tmpCompanyArray)

                        fAirRef_company_id = CLng(tmpCompanyArray(x).ToString)

                        ' filter datatable rows for this one company
                        ' create an array datarows for extraction
                        ' create a datarow object 
                        Dim afileterd As DataRow()
                        afileterd = dsAircraftCompanies.Tables(0).Select("cref_comp_id IN (" + fAirRef_company_id.ToString + ")", "cref_transmit_seq_no")
                        ' a single data row for importing to the dalTable
                        Dim atmpDataRow As DataRow
                        Dim dalTable As DataTable = dsAircraftCompanies.Tables(0).Clone
                        Dim tempDS As New DataSet

                        ' extract and import
                        dalTable.Clear()
                        dalTable.Rows.Clear()
                        tempDS.Tables.Clear()
                        For Each atmpDataRow In afileterd
                            dalTable.ImportRow(atmpDataRow)
                        Next
                        tempDS.Tables.Add(dalTable)

                        If tempDS.Tables(0).Rows.Count > 0 Then

                            ' Clear These
                            strCompanyTypeNbr = ""
                            strCompanyTypeName = ""

                            If Not IsDBNull(tempDS.Tables(0).Rows(0).Item("comp_name")) Then
                                If Not String.IsNullOrEmpty(tempDS.Tables(0).Rows(0).Item("comp_name").ToString.Trim) Then
                                    fCompany_name = tempDS.Tables(0).Rows(0).Item("comp_name").ToString.Trim
                                Else
                                    fCompany_name = ""
                                End If
                            Else
                                fCompany_name = ""
                            End If

                            For Each Row As DataRow In tempDS.Tables(0).Rows

                                If Not IsDBNull(Row.Item("cref_transmit_seq_no")) Then
                                    If Not String.IsNullOrEmpty(Row.Item("cref_transmit_seq_no").ToString.Trim) Then
                                        fAirRef_transmit_seq_no = CInt(Row.Item("cref_transmit_seq_no").ToString)
                                    Else
                                        fAirRef_transmit_seq_no = 0
                                    End If
                                Else
                                    fAirRef_transmit_seq_no = 0
                                End If

                                If Not IsDBNull(Row.Item("cref_contact_type")) Then
                                    If Not String.IsNullOrEmpty(Row.Item("cref_contact_type").ToString.Trim) Then
                                        fAirRef_contact_type = Row.Item("cref_contact_type").ToString.Trim
                                    Else
                                        fAirRef_contact_type = ""
                                    End If
                                Else
                                    fAirRef_contact_type = ""
                                End If

                                If Not IsDBNull(Row.Item("cref_id")) Then
                                    If Not String.IsNullOrEmpty(Row.Item("cref_id").ToString.Trim) Then
                                        fAirRef_id = CInt(Row.Item("cref_id").ToString)
                                    Else
                                        fAirRef_id = 0
                                    End If
                                Else
                                    fAirRef_id = 0
                                End If

                                If Not IsDBNull(Row.Item("cref_contact_id")) Then
                                    If Not String.IsNullOrEmpty(Row.Item("cref_contact_id").ToString.Trim) Then
                                        fAirRef_contact_id = CInt(Row.Item("cref_contact_id").ToString)
                                    Else
                                        fAirRef_contact_id = 0
                                    End If
                                Else
                                    fAirRef_contact_id = 0
                                End If

                                If Not IsDBNull(Row.Item("cref_ac_id")) Then
                                    If Not String.IsNullOrEmpty(Row.Item("cref_ac_id").ToString.Trim) Then
                                        fAirRef_ac_id = CInt(Row.Item("cref_ac_id").ToString)
                                    Else
                                        fAirRef_ac_id = 0
                                    End If
                                Else
                                    fAirRef_ac_id = 0
                                End If

                                If Not IsDBNull(Row.Item("cref_owner_percent")) Then
                                    If Not String.IsNullOrEmpty(Row.Item("cref_owner_percent").ToString.Trim) Then
                                        fAirRef_owner_percent = CInt(Row.Item("cref_owner_percent").ToString)
                                    Else
                                        fAirRef_owner_percent = 0
                                    End If
                                Else
                                    fAirRef_owner_percent = 0
                                End If

                                If Not IsDBNull(Row.Item("cref_fraction_expires_date")) Then
                                    If Not String.IsNullOrEmpty(Row.Item("cref_fraction_expires_date").ToString.Trim) Then
                                        fAirRef_fraction_expires_date = Row.Item("cref_fraction_expires_date").ToString.Trim
                                    Else
                                        fAirRef_fraction_expires_date = ""
                                    End If
                                Else
                                    fAirRef_fraction_expires_date = ""
                                End If

                                If Not IsDBNull(Row.Item("actype_name")) Then
                                    If Not String.IsNullOrEmpty(Row.Item("actype_name").ToString.Trim) Then
                                        fAirContactType_name = Row.Item("actype_name").ToString.Trim
                                    Else
                                        fAirContactType_name = ""
                                    End If
                                Else
                                    fAirContactType_name = ""
                                End If

                                If Not IsDBNull(Row.Item("comp_journ_id")) Then
                                    If Not String.IsNullOrEmpty(Row.Item("comp_journ_id").ToString.Trim) Then
                                        fAirRef_company_journ_id = CInt(Row.Item("comp_journ_id").ToString)
                                    Else
                                        fAirRef_company_journ_id = 0
                                    End If
                                Else
                                    fAirRef_company_journ_id = 0
                                End If

                                If String.IsNullOrEmpty(strCompanyTypeNbr) Then
                                    strCompanyTypeNbr = Constants.cSingleQuote + fAirRef_contact_type.Trim + Constants.cSingleQuote
                                Else
                                    strCompanyTypeNbr += Constants.cCommaDelim + Constants.cSingleQuote + fAirRef_contact_type.Trim + Constants.cSingleQuote
                                End If

                                If Not fAirRef_contact_type.Contains("02") And Not fAirRef_contact_type.Contains("66") And Not fAirRef_contact_type.Contains("67") _
                                   And Not fAirRef_contact_type.Contains("68") And Not fAirRef_contact_type.Contains("44") Then

                                    If fAirRef_contact_type.Contains("97") Or fAirRef_contact_type.Contains("17") Then

                                        If commonEvo.DoesCompanyHaveShareRelationships(fAirRef_id) Then

                                            If isDisplay Then
                                                '  strCompanyTypeName += "<a class='underline' onclick='javascript:openSmallWindowJS('DisplayShareRelationships.asp?inCrefID=" + fAirRef_id.ToString + "&inCompID=" + fAirRef_company_id.ToString + "&inContactID=" + fAirRef_contact_id.ToString + "&inACID=" + fAirRef_ac_id.ToString + "');' title='Display Share Relationships'>" + fAirContactType_name + strCompanyTypeName + " [" + fAirRef_owner_percent.ToString + "%]</a>&nbsp;" + Constants.cCommaDelim
                                            Else
                                                strCompanyTypeName += fAirContactType_name + strCompanyTypeName + " [" + fAirRef_owner_percent + "%]&nbsp;" + Constants.cCommaDelim
                                            End If

                                        Else

                                            strCompanyTypeName += fAirContactType_name

                                            If fAirRef_owner_percent > 0 Then
                                                strCompanyTypeName += " [" + fAirRef_owner_percent.ToString.Trim + "%]&nbsp;"
                                            End If

                                            strCompanyTypeName += Constants.cCommaDelim

                                        End If

                                    ElseIf fAirRef_contact_type.Contains("08") Then

                                        strCompanyTypeName += fAirContactType_name

                                        If fAirRef_owner_percent > 0 Then
                                            strCompanyTypeName += " [" + fAirRef_owner_percent.ToString.Trim + "%]&nbsp;"
                                        End If

                                        strCompanyTypeName += Constants.cCommaDelim

                                    Else

                                        If fAirRef_contact_type.Contains("66") Or fAirRef_contact_type.Contains("67") Or fAirRef_contact_type.Contains("68") Then
                                            fAirContactType_name = "Additional Company/Contact"
                                        End If

                                        If Not strCompanyTypeName.Contains(fAirContactType_name) Then
                                            strCompanyTypeName += fAirContactType_name + Constants.cCommaDelim
                                        End If

                                    End If

                                Else

                                    If fAirRef_contact_type.Contains("66") Or fAirRef_contact_type.Contains("67") Or fAirRef_contact_type.Contains("68") Then
                                        fAirContactType_name = "Additional Company/Contact"
                                    End If

                                    If Not strCompanyTypeName.Contains(fAirContactType_name) Then
                                        strCompanyTypeName += fAirContactType_name + Constants.cCommaDelim
                                    End If

                                End If

                                If Not strCompanyTypeName.Contains(fAirRef_fraction_expires_date) Then
                                    strCompanyTypeName += " [Expires &nbsp;:&nbsp;" + fAirRef_fraction_expires_date + "]&nbsp;" + Constants.cCommaDelim
                                End If

                            Next ' For Each Row As DataRow In tempDS.Tables(0).Rows

                            If Not String.IsNullOrEmpty(strCompanyTypeName) Then
                                strCompanyTypeName = strCompanyTypeName.Substring(0, strCompanyTypeName.Length - 1) ' strips off the last comma
                            Else
                                strCompanyTypeName = "Additional Company"
                            End If

                            If Not String.IsNullOrEmpty(strCompanyTypeName) Then
                                strCompanyTypeName = strCompanyTypeName.Replace("Additional Contact1", "/Additional Company")
                                strCompanyTypeName = strCompanyTypeName.Replace(Constants.cCommaDelim, Constants.cSingleForwardSlash)
                            End If

                            nContactCount = localFunctions.get_contact_count_report(fAirRef_company_id, nAircraftID, nAircraftJournalID, strCompanyTypeNbr)

                            ' we have to span at least one row (even if zero contacts are found)
                            If nContactCount = 0 Then
                                htmlOut.Append("<tr><td valign='top' align='left' rowspan='1'>")
                            Else
                                htmlOut.Append("<tr><td valign='top' align='left' rowspan='" + nContactCount.ToString + "'>")
                            End If

                            htmlOut.Append(strCompanyTypeName + " - " + commonEvo.get_company_info_from_datarow(tempDS.Tables(0).Rows(0), nAircraftJournalID, True, False, "", ""))

                            If nContactCount > 0 Then
                                htmlOut.Append(GetContacts_DisplayAircraftDetails_Report(fAirRef_company_id, nAircraftID, nAircraftJournalID, strCompanyTypeNbr))
                            Else
                                htmlOut.Append("</td><td valign='top'>&nbsp;</td></tr>")
                            End If

                        End If ' tempDS.Tables(0).Rows.Count > 0 Then

                    Next 'For x As Integer = 0 To UBound(tmpCompanyArray)

                Else
                    htmlOut.Append("<tr><td valign='middle' align='center' colspan='2'> No Company or Contact Listed for Aircraft </td></tr>")
                End If ' dsAircraftCompanies.Tables(0).Rows.Count > 0 Then

            Else
                htmlOut.Append("<tr><td valign='middle' align='center' colspan='2'> No Company or Contact Listed for Aircraft </td></tr>")
            End If '  Not IsNothing(dsAircraftCompanies) Then

            htmlOut.Append("</table>")

            SqlDataAdapter = Nothing

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in GetCompanies_DisplayAircraftDetails_Report(ByVal nAircraftID As Long, ByVal nJournalID As Long, ByVal isDisplay As Boolean, ByVal showFullContact As Boolean) As String" + ex.Message
        Finally

            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing
            SqlDataAdapter = Nothing

        End Try

        Return htmlOut.ToString.Trim

    End Function
    Public Function GetDetailsEquipmentLength(ByVal AC_ID As Integer) As Integer

        Dim sQuery As New StringBuilder()
        Dim returnAnswer As Integer = 0
        Dim atemptable As New DataTable

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader = Nothing
        Dim SqlException As SqlClient.SqlException = Nothing

        Dim tmpID As String = ""


        sQuery.Append("SELECT distinct aircraft.ac_id,len(STUFF((select adet_data_description from aircraft_details a2 ")
        sQuery.Append(" where a2.adet_ac_id = aircraft.ac_id AND (a2.adet_data_type in ('Addl Cockpit Equipment','Equipment')) and a2.adet_journ_id = aircraft.ac_journ_id FOR XML PATH('')),1,1,'')) as equiplength ")
        sQuery.Append(" FROM aircraft WITH(NOLOCK) ")
        sQuery.Append(" WHERE(AC_ID = " & AC_ID.ToString & ")")
        sQuery.Append(" AND ac_journ_id = 0 ")

        Try

            SqlConn.ConnectionString = localFunctions.clientConnectStr
            SqlConn.Open()
            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString

            SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

            Try
                atemptable.Load(SqlReader)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
                HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in GetDetailsEquipmentLength(ByVal AC_ID As Integer) As Long load datatable" + constrExc.Message
            End Try

            SqlReader.Close()


            If Not IsNothing(atemptable) Then
                If atemptable.Rows.Count > 0 Then
                    returnAnswer = atemptable.Rows(0).Item("equiplength")
                End If
            End If
            Return returnAnswer
        Catch ex As Exception
            Return 0
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in GetDetailsEquipmentLength(ByVal AC_ID As Integer) As Long " + ex.Message
        Finally

            SqlReader = Nothing

            atemptable = Nothing

            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing
        End Try
        sQuery = Nothing

    End Function
    Public Function GetDetailsLimit(ByVal DetailType As String, ByVal AC_ID As Integer) As Long

        Dim sQuery As New StringBuilder()
        Dim returnAnswer As Long = 0
        Dim atemptable As New DataTable

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader = Nothing
        Dim SqlException As SqlClient.SqlException = Nothing

        Dim tmpID As String = ""

        sQuery.Append("SELECT COUNT(distinct adet_data_description) as tcount ")
        sQuery.Append(" FROM aircraft_details WITH(NOLOCK) ")
        sQuery.Append(" WHERE (aircraft_details.adet_journ_id = 0) ")
        sQuery.Append(" AND (aircraft_details.adet_data_type = '" & DetailType & "') ")
        sQuery.Append(" AND adet_ac_id = " & AC_ID.ToString)

        Try

            SqlConn.ConnectionString = localFunctions.clientConnectStr
            SqlConn.Open()
            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString

            SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

            Try
                atemptable.Load(SqlReader)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
                HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in GetDetailsLimit(ByVal DetailType As String, ByVal AC_ID As Integer) As Long load datatable" + constrExc.Message
            End Try

            SqlReader.Close()


            If Not IsNothing(atemptable) Then
                If atemptable.Rows.Count > 0 Then
                    returnAnswer = atemptable.Rows(0).Item("tcount")
                End If
            End If
            Return returnAnswer
        Catch ex As Exception
            Return 0
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in GetDetailsLimit() As Long" + ex.Message
        Finally

            SqlReader = Nothing

            atemptable = Nothing

            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing
        End Try
        sQuery = Nothing

    End Function
    Public Function GetContacts_DisplayAircraftDetails_Report(ByVal nCompanyID As Long, ByVal nAircraftID As Long, ByVal nAircraftJournalID As Long, ByVal inStrCompanyTypeNbr As String) As String

        Dim sQuery As New StringBuilder()
        Dim htmlOut As New StringBuilder()
        Dim atemptable As New DataTable

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader = Nothing
        Dim SqlException As SqlClient.SqlException = Nothing

        Dim tmpID As String = ""

        sQuery.Append("SELECT DISTINCT cref_contact_id, cref_transmit_seq_no FROM Aircraft_Reference WITH(NOLOCK)")
        sQuery.Append(" WHERE cref_ac_id = " + nAircraftID.ToString)
        sQuery.Append(" AND cref_journ_id = " + nAircraftJournalID.ToString)
        sQuery.Append(" AND cref_comp_id = " + nCompanyID.ToString)
        sQuery.Append(" AND cref_contact_type IN (" + inStrCompanyTypeNbr + ")")

        ' Hide Exclusive Brokers and Representatives and Dealers from Aerodex users
        If bAerodexFlag Then
            sQuery.Append(" AND cref_contact_type NOT IN ('93','98','99','71')")
        Else
            sQuery.Append(" AND cref_contact_type NOT IN ('71')")
        End If

        sQuery.Append(" ORDER BY cref_transmit_seq_no")

        Try

            SqlConn.ConnectionString = localFunctions.clientConnectStr
            SqlConn.Open()
            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString

            SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

            Try
                atemptable.Load(SqlReader)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
                HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in GetContacts_DisplayAircraftDetails_Report load datatable" + constrExc.Message
            End Try

            SqlReader.Close()


            If Not IsNothing(atemptable) Then

                If atemptable.Rows.Count > 0 Then

                    For Each Row As DataRow In atemptable.Rows
                        If Not tmpID.Contains(Row.Item("cref_contact_id").ToString.Trim) Then

                            htmlOut.Append("</td><td valign='top' align='left'>")

                            If commonEvo.isChiefPilot(CLng(Row.Item("cref_contact_id").ToString), nAircraftID, nAircraftJournalID) Then
                                htmlOut.Append(commonEvo.get_contact_info_fromID(nCompanyID, CLng(Row.Item("cref_contact_id").ToString), nAircraftJournalID, True, False, True, ""))
                            Else
                                htmlOut.Append(commonEvo.get_contact_info_fromID(nCompanyID, CLng(Row.Item("cref_contact_id").ToString), nAircraftJournalID, True, False, False, ""))
                            End If

                            htmlOut.Append("</td></tr>")

                        ElseIf CLng(Row.Item("cref_contact_id").ToString) > 0 Then
                            ' this contact id is in our list but we already processed it
                            htmlOut.Append("</td><td valign='top'>&nbsp;</td></tr>")
                        ElseIf CLng(Row.Item("cref_contact_id").ToString) = 0 Or String.IsNullOrEmpty(Row.Item("cref_contact_id").ToString) Then
                            ' this contact id is zero or blank add a filler table item
                            htmlOut.Append("</td><td valign='top'>&nbsp;</td></tr>")
                        End If

                        If String.IsNullOrEmpty(tmpID) Then
                            tmpID = Row.Item("cref_contact_id").ToString.Trim
                        Else
                            tmpID += Constants.cCommaDelim + Row.Item("cref_contact_id").ToString.Trim
                        End If

                    Next

                Else
                    htmlOut.Append("</td><td valign='top'>&nbsp;</td></tr>")
                End If
            Else
                htmlOut.Append("</td><td valign='top'>&nbsp;</td></tr>")
            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in GetContacts_DisplayAircraftDetails_Report(ByVal nAircraftID As Long, ByVal nAircraftJournalID As Long, ByVal nCompanyID As Long, ByVal inStrCompanyTypeNbr As String) As String" + ex.Message
        Finally

            SqlReader = Nothing

            atemptable = Nothing

            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing
        End Try

        Return htmlOut.ToString

        htmlOut = Nothing
        sQuery = Nothing

    End Function

    Public Function Get_ReferenceCompanyIDs_Report(ByVal inDataset As DataSet) As String

        Dim oldCompanyID As String = ""
        Dim newCompanyID As String = ""
        Dim tString As String = ""

        Try

            If Not IsNothing(inDataset) Then

                If inDataset.Tables(0).Rows.Count > 0 Then
                    ' build the compID's
                    For Each Row As DataRow In inDataset.Tables(0).Rows

                        newCompanyID = Row.Item("cref_comp_id").ToString

                        If newCompanyID.Trim <> oldCompanyID.Trim Then

                            If String.IsNullOrEmpty(tString) Then
                                tString += Row.Item("cref_comp_id").ToString
                            Else
                                If Not tString.Contains(Row.Item("cref_comp_id").ToString) Then
                                    tString += Constants.cCommaDelim + Row.Item("cref_comp_id").ToString
                                End If
                            End If

                            oldCompanyID = Row.Item("cref_comp_id").ToString
                        End If

                    Next

                Else
                    Return tString = ""
                End If
            Else
                Return tString = ""
            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Get_ReferenceCompanyIDs_Report(ByVal inDataset As DataSet) As String" + ex.Message
            Return tString = ""
        End Try

        Return tString

    End Function

#End Region

#Region "Report_54_New_Company"
    Public Function create_report_54_company_full_spec(ByRef record_count As Long) As String


        Session("FONT_CLASS_TEXT") = ""
        Session("FONT_CLASS_TEXT_TITLE") = ""
        Session("FONT_CLASS_HEADER") = ""
        Session("FONT_CLASS_HEADER_BIG") = ""

        Dim htmlOut = New StringBuilder()
        Dim ts As String = ""

        record_count = 1

        Try


            If Trim(Request("homebase")) = "Y" Then
                Master.aclsData_Temp.JETNET_DB = Session.Item("jetnetAdminDatabase")
                Session.Item("localSubscription").crmBusiness_Flag = True
                Session.Item("localSubscription").crmHelicopter_Flag = True
                Session.Item("localSubscription").crmCommercial_Flag = True
                Session.Item("localSubscription").crmJets_Flag = True
                Session.Item("localSubscription").crmExecutive_Flag = True
                Session.Item("localSubscription").crmTurboprops = True

                localFunctions.clientConnectStr = Session.Item("jetnetAdminDatabase")
            End If


            If Not IsNothing(Request.Item("word_width")) Then
                If Not String.IsNullOrEmpty(Request.Item("word_width").ToString.Trim) Then
                    word_width = Request.Item("word_width").ToString.ToUpper.Contains("Y")
                End If
            End If

            If Not IsNothing(Request.Item("pdf_html_width")) Then
                If Not String.IsNullOrEmpty(Request.Item("pdf_html_width").ToString.Trim) Then
                    pdf_html_width = Request.Item("pdf_html_width").ToString.ToUpper.Contains("Y")
                End If
            End If


            If Not IsNothing(Request("use_insight_op")) Then
                If Trim(Request("use_insight_op")) = "Y" Then
                    use_insight_op = True
                End If
            End If

            If Not IsNothing(Request("use_insight_own")) Then
                If Trim(Request("use_insight_own")) = "Y" Then
                    use_insight_own = True
                End If
            End If

            If Not IsNothing(Request("use_insight_roll")) Then
                If Trim(Request("use_insight_roll")) = "Y" Then
                    use_insight_roll = True
                End If
            End If

            If Not IsNothing(Request("IS_CLIENT")) Then
                If Trim(Request("IS_CLIENT")) = "CLIENT" Then
                    JETNET_OR_CLIENT = "CLIENT"
                End If
            End If


            If Not IsNothing(Request("use_insight_manu")) Then
                If Trim(Request("use_insight_manu")) = "Y" Then
                    use_insight_manu = True
                    manufacturer_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
                    manufacturer_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
                    manufacturer_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
                    manufacturer_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
                    manufacturer_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

                    market_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
                    market_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
                    market_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
                    market_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
                    market_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim
                End If
            End If

            If Not IsNothing(Request("use_insight_dealer")) Then
                If Trim(Request("use_insight_dealer")) = "Y" Then
                    use_insight_dealer = True

                    acdealer_view_function.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
                    acdealer_view_function.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
                    acdealer_view_function.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
                    acdealer_view_function.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
                    acdealer_view_function.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim
                End If
            End If

            If Not IsNothing(Request("use_insight_lease")) Then
                If Trim(Request("use_insight_lease")) = "Y" Then
                    use_insight_lease = True

                    lease_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
                    lease_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
                    lease_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
                    lease_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
                    lease_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

                End If
            End If

            If Not IsNothing(Request("use_insight_finance")) Then
                If Trim(Request("use_insight_finance")) = "Y" Then
                    use_insight_finance = True
                End If
            End If


            If Trim(Request("journ_id")) <> "" Then
                nAircraftJournalID_Full = CLng(Trim(Request("journ_id")))
            End If




            '   For i = 0 To 0

            'NEW_COMP_ID = NEW_COMP_ID

            htmlOut.Append("<html><body>")
            htmlOut.Append(comp_functions.NEW_build_style_page_full_spec())
            Call comp_functions.NEW_Header_Comp_Info(ac_id, "", comp_address, comp_logo, invisible_label_parent_image, logo_check, bWordReport, "", "PDF")


            ' For i As Integer = 0 To UBound(item_string)

            '  acdet.length = 0
            engine_info = ""
            apu_data = ""
            int_section = ""
            int_moyear = ""
            ext_section = ""
            ext_moyear = ""
            first_ac_pic = ""
            ac_features = ""

            NEW_COMP_ID = CLng(Trim(Request("comp_id")))

            util_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            util_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            util_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            util_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            util_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim
            searchCriteria.ViewCriteriaCompanyID = NEW_COMP_ID

            ts = htmlOut.ToString

            If use_insight_roll = True Then
                util_functions.rollup_text = " and comp_id in (select distinct RelCompID from ReturnAllCompanyLocationsByCompId(" & NEW_COMP_ID & ")) "
            Else
                util_functions.rollup_text = ""
            End If

            If check_cover.Checked = True Then
                Call CREATE_NEW_COMPANY_DETAILS_SPEC("cover", htmlOut)
            End If

            If chkIncludeContacts.Checked = True Then
                Call CREATE_NEW_COMPANY_DETAILS_SPEC("contacts", htmlOut)
            End If

            If chkIncludeCompAC.Checked = True Then
                Call CREATE_NEW_COMPANY_DETAILS_SPEC("ac", htmlOut)
            End If

            If (Session.Item("localSubscription").crmYacht_Flag = True And chkincludeCompYacht.Checked = True) Or Trim(Request("homebase")) = "Y" Then
                Call CREATE_NEW_COMPANY_DETAILS_SPEC("yachts", htmlOut)
            End If

            If chk_related_comp.Checked = True Then
                Call CREATE_NEW_COMPANY_DETAILS_SPEC("related", htmlOut)
            End If

            If chk_comp_wanteds.Checked = True Then
                Call CREATE_NEW_COMPANY_DETAILS_SPEC("wanteds", htmlOut)
            End If

            ' If chkCompanyLocations.Checked = True Then
            '   Call CREATE_NEW_COMPANY_DETAILS_SPEC("locations", htmlOut)
            'End If

            If use_insight_op = True Then
                Call CREATE_NEW_COMPANY_DETAILS_SPEC("operations", htmlOut)
            End If

            If use_insight_own = True Then
                Call CREATE_NEW_COMPANY_DETAILS_SPEC("ownership", htmlOut)
            End If

            If use_insight_lease = True Then
                Call CREATE_NEW_COMPANY_DETAILS_SPEC("lease", htmlOut)
            End If

            If use_insight_dealer = True Then
                Call CREATE_NEW_COMPANY_DETAILS_SPEC("dealer", htmlOut)
            End If

            If use_insight_manu = True Then
                Call CREATE_NEW_COMPANY_DETAILS_SPEC("manu", htmlOut)
            End If

            If use_insight_finance = True Then
                Call CREATE_NEW_COMPANY_DETAILS_SPEC("finance", htmlOut)
            End If

            '  Next

            ' Next

            htmlOut.Append("</body></html>")

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in create_aircraft_full_spec_sheet(ByVal item_string As Array) As String" + ex.Message
        End Try

        Return htmlOut.ToString

        htmlOut = Nothing

    End Function

    Public Sub CREATE_NEW_COMPANY_DETAILS_SPEC(ByVal page_num As String, ByRef htmlOut As StringBuilder)

        Dim temp_string As String = ""
        Dim address_info As String = ""
        Dim JournalID As Long = 0
        Dim temp_business_type As String = ""

        If made_first_page = False Then
        Else
            htmlOut.Append(comp_functions.NEW_Insert_Page_Break_PDF(Counter_For_PDF, reportType.SelectedValue))
        End If

        made_first_page = True


        If Trim(JETNET_OR_CLIENT) = "CLIENT" Then  ' make sure u passs in the real compid not the client comp id 
            htmlOut.Append(comp_functions.NEW_build_full_spec_page_header(NEW_AC_ID, "", comp_address, comp_logo, 0, comp_id, bWordReport, word_width, pdf_html_width, check_prepared_for, chkBlindReport, prepared_for))
        Else
            htmlOut.Append(comp_functions.NEW_build_full_spec_page_header(NEW_AC_ID, "", comp_address, comp_logo, 0, NEW_COMP_ID, bWordReport, word_width, pdf_html_width, check_prepared_for, chkBlindReport, prepared_for))
        End If


        If bWordReport = True Then
            htmlOut.Append("<table width='" & word_width & "' align='center'>")
        Else
            htmlOut.Append("<table width='" & pdf_html_width & "' align='center'>")
        End If


        If page_num = "cover" Then

            Call get_current_company_info(NEW_COMP_ID, 0, temp_string, "", has_desription_spec, "new")   'JETNET_OR_CLIENT
            htmlOut.Append(temp_string)

            If has_desription_spec = False Then
                htmlOut.Append(get_cotnact_info_spec()) 'JETNET_OR_CLIENT
            End If

            ' ----------- BUSINESS TYPES - MSW as requested 8/25/19 
            temp_business_type = ""
            Call Fill_Business_Type_Tab(temp_business_type, NEW_COMP_ID, "newpdf")
            htmlOut.Append(temp_business_type)
            ' ----------- 
        End If

        If page_num = "contacts" Then
            If has_desription_spec = True Then
                htmlOut.Append(get_cotnact_info_spec())
            End If
        End If

        If page_num = "ac" Then
            temp_string = ""
            Call fill_ac_related_spec(temp_string)  'JETNET_OR_CLIENT
            If Trim(temp_string) <> "" Then
                htmlOut.Append("<table cellspacing='0' cellpadding='0'>") ' needs an extra, since it ends with an end table 
                htmlOut.Append(temp_string)
                ' comes with its own end table 
            End If
        End If

        '--------------- FILL YACHT INFORMATION------------------ 
        If page_num = "yachts" Then
            Call fill_yacht_related_spec(temp_string)
            htmlOut.Append(temp_string)
        End If
        '--------------- FILL YACHT INFORMATION------------------ 


        If page_num = "related" Then
            temp_string = ""
            'temp_string = Fill_Relationship_Tab(NEW_COMP_ID, JournalID, True)
            temp_string = NEW_build_full_spec_aircraft_contacts(0, NEW_COMP_ID)

            htmlOut.Append(temp_string)
        End If


        If page_num = "wanteds" Then
            temp_string = ""
            Call Fill_Wanteds_Tab(NEW_COMP_ID, JournalID, temp_string, 54)
            htmlOut.Append(temp_string)
        End If

        'If page_num = "locations" Then
        '  temp_string = ""
        '  Call Fill_Locations_Tab(NEW_COMP_ID, JournalID, temp_string, 54)
        '  htmlOut.Append(temp_string)
        'End If

        If page_num = "operations" Then
            temp_string = ""
            Call Fill_Operations_Tab(NEW_COMP_ID, JournalID, temp_string, 54)
            htmlOut.Append(temp_string)
        End If

        If page_num = "ownership" Then
            temp_string = ""
            Call Fill_Owner_Tab(NEW_COMP_ID, JournalID, temp_string, 54)
            htmlOut.Append(temp_string)
        End If


        If page_num = "lease" Then
            temp_string = ""
            Call Fill_Lease_Tab(NEW_COMP_ID, JournalID, temp_string, 54)
            htmlOut.Append(temp_string)
        End If


        If page_num = "dealer" Then
            temp_string = ""
            Call Fill_Dealer_Tab(NEW_COMP_ID, JournalID, temp_string, 54)
            htmlOut.Append(temp_string)
        End If



        If page_num = "manu" Then
            temp_string = ""
            Call Fill_Manu_Tab(NEW_COMP_ID, JournalID, temp_string, 54)
            htmlOut.Append(temp_string)
        End If



        If page_num = "finance" Then
            temp_string = ""
            Call Fill_Finance_Tab(NEW_COMP_ID, JournalID, temp_string, 54)
            htmlOut.Append(temp_string)
        End If





        htmlOut.Append("</table>")

        '  If page_num = "notes" Then
        '    htmlOut.Append(NEW_build_full_spec_notes_page(NEW_AC_ID, 0))
        '  End If


    End Sub

    Public Sub fill_yacht_related_spec(ByRef temp_string As String)
        Dim temp_counter As Integer = 0
        Dim temp_status As String = ""
        Dim bgcolor As String = ""
        Dim yacht_Table As String = ""
        Dim yt_header As String = ""
        Dim YachtTable As New DataTable
        Dim JournalID As Long = 0

        YachtTable = Master.aclsData_Temp.DisplayYachtForGivenCompanyByCompanyID(NEW_COMP_ID, "", JournalID, "")
        YachtTable = FixYachtTableRemoveDuplicates(YachtTable)


        If Not IsNothing(YachtTable) Then

            If Trim(Request("homebase")) = "Y" And YachtTable.Rows.Count = 0 Then

            Else
                yt_header = "<tr><td colspan='10'><font class='small_header_text'>"
                yt_header &= "&nbsp;"
                yt_header &= "</font></td></tr>"

                yt_header &= "<tr class='" & Session("ROW_CLASS_BOTTOM") & "'><td colspan='10' align='center'>"
                yt_header &= "<font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER") & "'>Yacht Records (" & YachtTable.Rows.Count & ")</font>"
                yt_header &= "</td></tr>"
                yt_header &= "<tr><td colspan='10'>"
            End If

            If YachtTable.Rows.Count > 0 Then


                yt_header &= "<table cellspacing='0' cellpadding='4' class='data_aircraft_grid' border='1'>"
                yt_header &= "<tr class='" & Session("ROW_CLASS_BOTTOM") & "' valign='top'>"
                yt_header &= "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Brand&nbsp;</font></td>"
                yt_header &= "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Yacht Name&nbsp;</font></td>"
                yt_header &= "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Year&nbsp;</font></td>"
                yt_header &= "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Hull&nbsp;</font></td>"
                yt_header &= "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>For Sale?&nbsp;</font></td>"
                yt_header &= "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>For Lease?&nbsp;</font></td>"
                yt_header &= "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Status&nbsp;</font></td>"
                yt_header &= "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Relationship&nbsp;</font></td>"
                yt_header &= "</tr>"


                yacht_Table &= yt_header

                For Each y As DataRow In YachtTable.Rows


                    '' the <> is so you dont break in the middle of one yacht with multiple relationships
                    'If temp_counter > 28 And Trim(y("ym_brand_name")) <> "" Then
                    '  yacht_Table &= ("</td></tr></table></td></tr></table>")
                    '  yacht_Table &= Insert_Page_Break_PDF()
                    '  'yacht_Table &= Replace(page_yacht_header, "Related Yachts", "Related Yachts (Cont.)")
                    '  yacht_Table &= yt_header
                    '  temp_counter = 0
                    'End If
                    If temp_counter > 18 And Trim(y("ym_brand_name")) <> "" Then
                        yacht_Table &= ("</table></td></tr></table>")
                        yacht_Table &= (comp_functions.NEW_Insert_Page_Break_PDF(Counter_For_PDF, reportType.SelectedValue))
                        yacht_Table &= (comp_functions.NEW_build_full_spec_page_header(NEW_AC_ID, "", comp_address, comp_logo, 0, NEW_COMP_ID, bWordReport, word_width, pdf_html_width, check_prepared_for, chkBlindReport, prepared_for))
                        yacht_Table &= yt_header
                        temp_counter = 0
                    End If


                    If bgcolor = "" Then
                        bgcolor = "#f0f0f0"
                    Else
                        bgcolor = ""
                    End If

                    yacht_Table &= "<tr bgcolor='" & bgcolor & "' class='" & Session("ROW_CLASS_BOTTOM") & "'>"
                    yacht_Table &= "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                    yacht_Table &= y("ym_brand_name")
                    yacht_Table &= "&nbsp;</font></td>"

                    yacht_Table &= "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                    yacht_Table &= y("yt_yacht_name")
                    yacht_Table &= "&nbsp;</font></td>"

                    yacht_Table &= "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                    yacht_Table &= y("yt_year_mfr")
                    yacht_Table &= "&nbsp;</font></td>"

                    yacht_Table &= "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                    yacht_Table &= y("yt_hull_mfr_nbr")
                    yacht_Table &= "&nbsp;</font></td>"

                    yacht_Table &= "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                    yacht_Table &= y("yt_forsale_flag")
                    yacht_Table &= "&nbsp;</font></td>"

                    yacht_Table &= "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                    yacht_Table &= y("yt_for_lease_flag")
                    yacht_Table &= "&nbsp;</font></td>"

                    yacht_Table &= "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                    yacht_Table &= y("yt_forsale_status")
                    yacht_Table &= "&nbsp;</font></td>"

                    yacht_Table &= "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                    yacht_Table &= y("yct_name")
                    yacht_Table &= "&nbsp;</font></td>"

                    yacht_Table &= "</tr>"

                    temp_counter = temp_counter + 1

                Next
            Else
                yt_header &= "<font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>No Yacht Records Found</font></td></tr>"

                yacht_Table &= yt_header
            End If
        End If

        yacht_Table &= "</table>"
        yacht_Table &= "</td></tr>"

        temp_string = yacht_Table

    End Sub
    Public Sub fill_ac_related_spec(ByRef temp_string As String)

        Dim AircraftTable As New DataTable
        Dim ac_table As String = ""
        Dim ac_header As String = ""
        Dim temp_counter As Integer = 0
        Dim ac_page_break As Integer = 18
        Dim temp_status As String = ""
        Dim bgcolor As String = ""
        Dim has_airport As Boolean = False
        Dim JournalID As Long = 0


        '--------------- FILL AC INFORMATION------------------     

        If Trim(JETNET_OR_CLIENT) = "CLIENT" Then
            AircraftTable = Master.aclsData_Temp.Get_Client_JETNET_AC(client_comp_id, "ac_id ASC", Session.Item("localSubscription").crmHelicopter_Flag, Session.Item("localSubscription").crmBusiness_Flag, Session.Item("localSubscription").crmCommercial_Flag, Session.Item("localSubscription").crmJets_Flag, Session.Item("localSubscription").crmExecutive_Flag, Session.Item("localSubscription").crmTurboprops)
        ElseIf IsNothing(ViewState("CompanyAircraft")) Then
            AircraftTable = Master.aclsData_Temp.GetAircraft_Listing_compid(NEW_COMP_ID, Session.Item("localSubscription").crmHelicopter_Flag, Session.Item("localSubscription").crmBusiness_Flag, Session.Item("localSubscription").crmCommercial_Flag, Session.Item("localSubscription").crmJets_Flag, Session.Item("localSubscription").crmExecutive_Flag, Session.Item("localSubscription").crmTurboprops, JournalID, Session.Item("localSubscription").crmAerodexFlag)
            AircraftTable = FixAircraftTableRemoveDuplicates(AircraftTable)
        Else
            AircraftTable = ViewState("CompanyAircraft")
        End If



        If Not IsNothing(AircraftTable) Then


            ac_header = "<tr><td colspan='10'><font class='small_header_text'>"
            ac_header &= "&nbsp;"
            ac_header &= "</font></td></tr>"

            ac_header &= "<tr class='" & Session("ROW_CLASS_BOTTOM") & "' valign='top'><td colspan='10' align='center'>"
            ac_header &= "<font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER") & "'>Aircraft Relationships</font>"
            ac_header &= "</td></tr><tr><td colspan='10'>"

            If AircraftTable.Rows.Count > 0 Then

                ac_header &= "<table cellspacing='0' cellpadding='4' class='data_aircraft_grid' border='1'>"
                ac_header &= "<tr class='" & Session("ROW_CLASS_BOTTOM") & "' valign='top'>"
                ac_header &= "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Make&nbsp;</font></td>"
                ac_header &= "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Model&nbsp;</font></td>"
                ac_header &= "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Year&nbsp;</font></td>"
                ac_header &= "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Ser No&nbsp;</font></td>"
                ac_header &= "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Reg Nbr&nbsp;</font></td>"
                ac_header &= "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Status&nbsp;</font></td>"
                If Trim(JETNET_OR_CLIENT) <> "CLIENT" Then
                    ac_header &= "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Airport&nbsp;</font></td>"
                End If
                ac_header &= "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Relationship&nbsp;</font></td>"
                ac_header &= "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Contact Name&nbsp;</font></td>"
                ac_header &= "</tr>"

                ac_table &= ac_header


                For Each r As DataRow In AircraftTable.Rows

                    ' the <> is so you dont break in the middle of one ac with multiple relationships
                    If Trim(Request("homebase")) = "Y" Then ' dont do paging stuff
                    Else
                        If temp_counter > ac_page_break And Trim(r("amod_make_name")) <> "" Then
                            ac_table &= ("</table></td></tr></table>")
                            ac_table &= (comp_functions.NEW_Insert_Page_Break_PDF(Counter_For_PDF, reportType.SelectedValue))
                            ac_table &= (comp_functions.NEW_build_full_spec_page_header(NEW_AC_ID, "", comp_address, comp_logo, 0, NEW_COMP_ID, bWordReport, word_width, pdf_html_width, check_prepared_for, chkBlindReport, prepared_for))
                            ac_table &= "<table cellspacing='0' cellpadding='0'>"
                            ac_table &= ac_header
                            temp_counter = 0
                        End If
                    End If

                    If bgcolor = "" Then
                        bgcolor = "#f0f0f0"
                    Else
                        bgcolor = ""
                    End If

                    ac_table &= "<tr bgcolor='" & bgcolor & "' class='" & Session("ROW_CLASS_BOTTOM") & "' valign='top'>"
                    ac_table &= "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                    ac_table &= r("amod_make_name")
                    ac_table &= "&nbsp;</font></td>"

                    ac_table &= "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                    ac_table &= r("amod_model_name")
                    ac_table &= "&nbsp;</font></td>"

                    ac_table &= "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                    ac_table &= r("ac_year")
                    ac_table &= "&nbsp;</font></td>"

                    ac_table &= "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                    ac_table &= r("ac_ser_no_full")
                    ac_table &= "&nbsp;</font></td>"

                    ac_table &= "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                    ac_table &= r("ac_reg_nbr")
                    ac_table &= "&nbsp;</font></td>"

                    ac_table &= "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"

                    If Trim(Request("homebase")) = "Y" Then
                        temp_status = crmWebClient.clsGeneral.clsGeneral.DisplayStatusListingDateEvoACListing(r("ac_forsale_flag"), r("ac_status"), r("ac_delivery"), r("ac_asking_price"), r("ac_date_listed"), r("ac_asking_wordage"), True, Now(), "Y")
                    Else
                        temp_status = crmWebClient.clsGeneral.clsGeneral.DisplayStatusListingDateEvoACListing(r("ac_forsale_flag"), r("ac_status"), r("ac_delivery"), r("ac_asking_price"), r("ac_date_listed"), r("ac_asking_wordage"), True, Now(), "N")
                    End If

                    ' if the length is this long, it is probably taking up 2 lines
                    If Len(Trim(temp_status)) > 40 Then
                        If ac_page_break > 18 Then
                            ac_page_break = ac_page_break - 1
                        End If
                    End If
                    ac_table &= temp_status

                    ac_table &= "&nbsp;</td>"

                    If Trim(JETNET_OR_CLIENT) <> "CLIENT" Then


                        ac_table &= "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"

                        If Not IsDBNull(r("aport_name")) Then


                        End If

                        has_airport = False
                        'if you have any airport data
                        If Not IsDBNull(r("aport_name")) Or Not IsDBNull(r("aport_city")) Or Not IsDBNull(r("aport_state")) Or Not IsDBNull(r("aport_country")) Then
                            If Trim(r("aport_name")) <> "" Then
                                ac_table &= r("aport_name") & " "
                                has_airport = True
                            End If

                            If Not IsDBNull(r("aport_city")) Or Not IsDBNull(r("aport_state")) Or Not IsDBNull(r("aport_country")) Then
                                If Trim(r("aport_city")) <> "" Or Trim(r("aport_state")) <> "" Or Trim(r("aport_country")) <> "" Then
                                    ac_table &= " ("
                                    has_airport = True
                                End If
                            End If

                            If Not IsDBNull(r("aport_city")) Then
                                If Trim(r("aport_city")) <> "" Then
                                    ac_table &= r("aport_city") & ", "
                                    has_airport = True
                                End If
                            End If

                            If Not IsDBNull(r("aport_state")) Then
                                If Trim(r("aport_state")) <> "" Then
                                    ac_table &= r("aport_state") & " "
                                    has_airport = True
                                End If
                            End If

                            If Not IsDBNull(r("aport_country")) Then
                                If Trim(r("aport_country")) <> "" Then
                                    ac_table &= r("aport_country")
                                    has_airport = True
                                End If
                            End If

                            If Not IsDBNull(r("aport_city")) Or Not IsDBNull(r("aport_state")) Or Not IsDBNull(r("aport_country")) Then
                                If Trim(r("aport_city")) <> "" Or Trim(r("aport_state")) <> "" Or Trim(r("aport_country")) <> "" Then
                                    ac_table &= ")"
                                    has_airport = True
                                End If
                            End If
                        End If


                        If has_airport = False Then
                            If Not IsDBNull(r("ac_aport_name")) Then
                                ac_table &= r("ac_aport_name") & " "
                            End If

                            If Not IsDBNull(r("ac_aport_city")) Or Not IsDBNull(r("ac_aport_state")) Or Not IsDBNull(r("ac_aport_country")) Then
                                If Trim(r("ac_aport_city")) <> "" Or Trim(r("ac_aport_state")) <> "" Or Trim(r("ac_aport_country")) <> "" Then
                                    ac_table &= " ("
                                End If
                            End If

                            If Not IsDBNull(r("ac_aport_city")) Then
                                If Trim(r("ac_aport_city")) <> "" Then
                                    ac_table &= r("ac_aport_city") & ", "
                                End If
                            End If

                            If Not IsDBNull(r("ac_aport_state")) Then
                                If Trim(r("ac_aport_state")) <> "" Then
                                    ac_table &= r("ac_aport_state") & " "
                                End If
                            End If

                            If Not IsDBNull(r("ac_aport_country")) Then
                                If Trim(r("ac_aport_country")) <> "" Then
                                    ac_table &= r("ac_aport_country")
                                End If
                            End If

                            If Not IsDBNull(r("ac_aport_city")) Or Not IsDBNull(r("ac_aport_state")) Or Not IsDBNull(r("ac_aport_country")) Then
                                If Trim(r("ac_aport_city")) <> "" Or Trim(r("ac_aport_state")) <> "" Or Trim(r("ac_aport_country")) <> "" Then
                                    ac_table &= ")"
                                End If
                            End If
                        End If


                        ac_table &= "&nbsp;</font></td>"
                    End If

                    ac_table &= "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                    ac_table &= r("act_name")
                    ac_table &= "&nbsp;</font></td>"

                    ac_table &= "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"


                    If Not IsDBNull(r("contact_first_name")) And Not IsDBNull(r("contact_last_name")) Then
                        If Trim(r("contact_first_name")) <> "" Or Trim(r("contact_last_name")) <> "" Then
                            ac_table &= r("contact_first_name") & " " & r("contact_last_name")
                        Else
                            If Not IsDBNull(r("contact_title")) Then
                                ac_table &= r("contact_title") & " "
                            End If
                        End If
                    Else
                        If Not IsDBNull(r("contact_title")) Then
                            ac_table &= r("contact_title") & " "
                        Else

                        End If
                    End If

                    ac_table &= "&nbsp;</font></td>"

                    ac_table &= "</tr>"

                    temp_counter = temp_counter + 1
                Next
            Else
                ac_header &= "<tr class='" & Session("ROW_CLASS_BOTTOM") & "' valign='top'><td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><b>No Aircraft Records Found</font></td></tr>"

                ac_table &= ac_header
            End If
        End If

        ac_table &= "</table>"

        temp_string = ac_table

        '--------------- FILL AC INFORMATION------------------ 
    End Sub
    Public Function get_cotnact_info_spec() As String
        get_cotnact_info_spec = ""
        Dim ContactTable As New DataTable
        Dim temp_email_string As String = ""

        Try
            If chkIncludeContacts.Checked = True Then

                '--------------- FILL CONTACT INFORMATION------------------  
                temp_email_string = ""
                temp_email_string &= "<tr><td colspan='10'><font class='small_header_text'>"
                temp_email_string &= "&nbsp;"
                temp_email_string &= "</font></td></tr>"

                temp_email_string &= "<tr class='" & Session("ROW_CLASS_BOTTOM") & "'><td colspan='10' align='center'>"
                temp_email_string &= "<font class='" & Session("FONT_CLASS_HEADER") & "'><b>Contact(s)</b></font>"
                temp_email_string &= "</td></tr>"


                If Trim(JETNET_OR_CLIENT) = "CLIENT" Then
                    ContactTable = Master.aclsData_Temp.GetContacts(client_comp_id, JETNET_OR_CLIENT, "Y", 0)
                Else
                    If HttpContext.Current.Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.YACHT Then
                        ContactTable = Master.aclsData_Temp.GetContacts(NEW_COMP_ID, "JETNET", "Y", 0, True)
                    Else
                        ContactTable = Master.aclsData_Temp.GetContacts(NEW_COMP_ID, JETNET_OR_CLIENT, "Y", 0)
                    End If
                End If

                Call Display_Contact_Details_PDF(ContactTable, temp_email_string, NEW_COMP_ID, 0, Master, True, True, Trim(Request("homebase")), 54)
                ContactTable = Nothing


                get_cotnact_info_spec = temp_email_string
                'email_string &= temp_email_string & "<br>"
            End If
            '--------------- FILL CONTACT INFORMATION------------------ 
        Catch ex As Exception

        End Try
    End Function


#End Region

#Region "Model Values Report"


    'Public Function create_report_998_model_values_full_spec_sheet() As String


    '  Session("FONT_CLASS_TEXT") = ""
    '  Session("FONT_CLASS_TEXT_TITLE") = ""
    '  Session("FONT_CLASS_HEADER") = ""
    '  Session("FONT_CLASS_HEADER_BIG") = ""

    '  Dim htmlOut = New StringBuilder()


    '  Try

    '    If Not IsNothing(Request.Item("word_width")) Then
    '      If Not String.IsNullOrEmpty(Request.Item("word_width").ToString.Trim) Then
    '        word_width = Request.Item("word_width").ToString.ToUpper.Contains("Y")
    '      End If
    '    End If

    '    If Not IsNothing(Request.Item("pdf_html_width")) Then
    '      If Not String.IsNullOrEmpty(Request.Item("pdf_html_width").ToString.Trim) Then
    '        pdf_html_width = Request.Item("pdf_html_width").ToString.ToUpper.Contains("Y")
    '      End If
    '    End If


    '    If Trim(Request("journ_id")) <> "" Then
    '      nAircraftJournalID_Full = CLng(Trim(Request("journ_id")))
    '    End If

    '    htmlOut.Append("<html><body>")
    '    htmlOut.Append(comp_functions.NEW_build_style_page_full_spec())
    '    Call comp_functions.NEW_Header_Comp_Info(ac_id, "", comp_address, comp_logo, invisible_label_parent_image, logo_check, bWordReport)


    '    '  For i As Integer = 0 To UBound(item_string)

    '    acdet.length = 0
    '    engine_info = ""
    '    apu_data = ""
    '    int_section = ""
    '    int_moyear = ""
    '    ext_section = ""
    '    ext_moyear = ""
    '    first_ac_pic = ""
    '    ac_features = ""

    '    NEW_AMOD_ID = 272

    '    If check_cover.Checked = True Then
    '      Call NEW_VALUES_SPEC_PAGE("cover", htmlOut)
    '    End If



    '    '  Next

    '    htmlOut.Append("</body></html>")

    '  Catch ex As Exception
    '    HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in create_aircraft_full_spec_sheet(ByVal item_string As Array) As String" + ex.Message
    '  End Try

    '  Return htmlOut.ToString

    '  htmlOut = Nothing

    'End Function

    'Public Sub NEW_VALUES_SPEC_PAGE(ByVal page_num As String, ByRef htmlOut As StringBuilder)

    '  If made_first_page = False Then
    '  Else
    '    htmlOut.Append(comp_functions.NEW_Insert_Page_Break_PDF(Counter_For_PDF, reportType.SelectedValue))
    '  End If

    '  made_first_page = True


    '  htmlOut.Append(comp_functions.NEW_build_full_spec_page_header(NEW_AC_ID, "", comp_address, comp_logo, 0, NEW_COMP_ID, bWordReport, word_width, pdf_html_width, check_prepared_for, chkBlindReport, prepared_for))




    'End Sub

#End Region

#Region "Report_77_New_PDF"

    Public Function create_report_53_aircraft_full_spec_sheet(ByVal item_string As Array, ByRef record_count As Long) As String
        ShowNewTemplate = True


        Session("FONT_CLASS_TEXT") = ""
        Session("FONT_CLASS_TEXT_TITLE") = ""
        Session("FONT_CLASS_HEADER") = ""
        Session("FONT_CLASS_HEADER_BIG") = ""

        Dim htmlOut = New StringBuilder()
        Dim temp_pdf_header As String = ""
        Dim AircraftTable As New DataTable
        Dim crmSource As String = ""
        Dim crmView As Boolean = False
        Dim otherID As Long = 0
        Dim activeFolder As String = ""
        word_width = 760
        If bWordReport Then
            spacer_width = 200
        End If
        Try

            If Not IsNothing(Request.Item("word_width")) Then
                If Not String.IsNullOrEmpty(Request.Item("word_width").ToString.Trim) Then
                    word_width = Request.Item("word_width").ToString.ToUpper.Contains("Y")
                End If
            End If

            If Not IsNothing(Request.Item("pdf_html_width")) Then
                If Not String.IsNullOrEmpty(Request.Item("pdf_html_width").ToString.Trim) Then
                    pdf_html_width = Request.Item("pdf_html_width").ToString.ToUpper.Contains("Y")
                End If
            End If

            If clsGeneral.clsGeneral.isCrmDisplayMode() Then
                crmView = True
                If Not IsNothing(Trim(Request("source"))) Then
                    If Not String.IsNullOrEmpty(Trim(Request("source"))) Then
                        crmSource = Trim(Request("source"))
                        If Not IsNothing(Trim(Request("otherID"))) Then
                            If IsNumeric(Trim(Request("otherID"))) Then
                                otherID = Trim(Request("otherID"))
                            End If
                        End If
                    End If
                End If
            End If


            If Trim(Request("journ_id")) <> "" Then
                nAircraftJournalID_Full = CLng(Trim(Request("journ_id")))
            End If

            If check_cover.Checked = True Then
                htmlOut.Append("<html><body class=""removeMargins"">")
            Else
                htmlOut.Append("<html><head>")
            End If


            htmlOut.Append(comp_functions.NEW_build_style_page_full_spec())
            If bWordReport Then
                htmlOut.Append("<style type='text/css'>body {face = 'sans-serif';font-family: 'Maax Standard','Avenir Next','Helvetica','sans-serif'; font-size: 14px; color: rgb(39, 44, 50); }</style>")
            End If

            If check_cover.Checked = False Then
                htmlOut.Append("</head><body class=""withoutCover"">")
            End If

            Session("ROW_CLASS_BOTTOM") = ""


            For i As Integer = 0 To UBound(item_string)

                record_count = UBound(item_string)

                AircraftTable = New DataTable
                AirframeString = ""
                SerNoHeader = ""
                ac_ser = ""
                ac_reg = ""
                ac_make = ""
                ac_model = ""

                acdet.length = 0
                engine_info = ""
                apu_data = ""
                int_section = ""
                int_moyear = ""
                ext_section = ""
                ext_moyear = ""
                first_ac_pic = ""
                ac_features = ""
                temp_pdf_header = ""

                NEW_AC_ID = CLng(item_string(i))

                If otherID = 0 Or UBound(item_string) > 0 Then
                    otherID = NEW_AC_ID
                End If

                If ShowNewTemplate Then
                    CreateACHeader(otherID)
                    AircraftTable = CommonAircraftFunctions.BuildReusableTable(NEW_AC_ID, 0, crmSource, "", Master.aclsData_Temp, crmView, 0, "")
                End If

                ' if we are doing a blind company report, then make sure you also make the logo invisible if there is one - msw - 6/2/20 
                If check_blind_company.Checked = True Then
                    logo_check.Checked = False
                End If


                'If ShowNewTemplate = False Then
                '  Call comp_functions.NEW_Header_Comp_Info(NEW_AC_ID, "", comp_address, comp_logo, invisible_label_parent_image, logo_check, bWordReport)
                'Else
                Call comp_functions.CompanyInformationHeaderWithPNG(otherID, "", comp_address, comp_logo, invisible_label_parent_image, logo_check, bWordReport, "", "PDF", Me.name_alt_check.Checked)
                'End If

                If chkBlindReport.Checked = True And check_blind_company.Checked = True Then
                    temp_pdf_header = "<div class=""" & IIf(bWordReport, "word", "valueSpec viewValueExport Simplistic aircraftSpec ") & """><br/>" & IIf(bWordReport, "<hr />", "")
                ElseIf check_blind_company.Checked = True Then
                    temp_pdf_header = "<div class=""" & IIf(bWordReport, "word", "valueSpec viewValueExport Simplistic aircraftSpec ") & """>" & comp_functions.NEW_build_full_spec_page_header(otherID, "", comp_address, comp_logo, 0, NEW_COMP_ID, bWordReport, word_width, pdf_html_width, check_prepared_for, chkBlindReport, prepared_for, Header_Company_Name, False, False) & IIf(bWordReport, "<hr />", "")
                Else
                    temp_pdf_header = "<div class=""" & IIf(bWordReport, "word", "valueSpec viewValueExport Simplistic aircraftSpec ") & """>" & comp_functions.NEW_build_full_spec_page_header(otherID, "", comp_address, comp_logo, 0, NEW_COMP_ID, bWordReport, word_width, pdf_html_width, check_prepared_for, chkBlindReport, prepared_for, Header_Company_Name, False) & IIf(bWordReport, "<hr />", "")
                End If

                ' ADDED IN MSW 
                searchCriteria.ViewCriteriaAircraftID = NEW_AC_ID
                searchCriteria.ViewCriteriaAmodID = NEW_AMOD_ID


                If check_cover.Checked = True Then
                    Call NEW_CREATE_SPEC_PAGE("cover", htmlOut, temp_pdf_header, AircraftTable, crmSource, otherID, crmView)
                End If


                If check_airframe.Checked = True Then
                    Call NEW_CREATE_SPEC_PAGE("airframe", htmlOut, temp_pdf_header, AircraftTable, crmSource, otherID, crmView)
                End If

                If check_engineAPU.Checked = True Then
                    Call NEW_CREATE_SPEC_PAGE("engineAPU", htmlOut, temp_pdf_header, AircraftTable, crmSource, otherID, crmView)
                End If

                '   Call NEW_CREATE_SPEC_PAGE("pic", htmlOut)
                If check_avionics.Checked = True Then
                    Call NEW_CREATE_SPEC_PAGE("avionics", htmlOut, temp_pdf_header, AircraftTable, crmSource, otherID, crmView)
                End If

                If check_int_ext.Checked = True Then
                    Call NEW_CREATE_SPEC_PAGE("intext", htmlOut, temp_pdf_header, AircraftTable, crmSource, otherID, crmView)
                End If

                If check_maint.Checked = True Then
                    Call NEW_CREATE_SPEC_PAGE("maintadd", htmlOut, temp_pdf_header, AircraftTable, crmSource, otherID, crmView)
                End If

                If chkIncludeNotes_53.Checked = True Then
                    Call NEW_CREATE_SPEC_PAGE("notes", htmlOut, temp_pdf_header, AircraftTable, crmSource, otherID, crmView)
                End If

                If chkTP_53.Checked = True Then
                    Call NEW_CREATE_SPEC_PAGE("compcontacts", htmlOut, temp_pdf_header, AircraftTable, crmSource, otherID, crmView)
                End If

                If chkIncludeHistory_53.Checked = True Then
                    Call NEW_CREATE_SPEC_PAGE("history", htmlOut, temp_pdf_header, AircraftTable, crmSource, otherID, crmView)
                End If

                If chkPP.Checked = True Then
                    Call NEW_CREATE_SPEC_PAGE("pics", htmlOut, temp_pdf_header, AircraftTable, crmSource, otherID, crmView)
                End If

                If chkFA.Checked = True Then
                    Call NEW_CREATE_SPEC_PAGE("flightdata", htmlOut, temp_pdf_header, AircraftTable, crmSource, otherID, crmView)
                End If

                If clsGeneral.clsGeneral.isEValuesAvailable() = True And clsGeneral.clsGeneral.isShowingEvalues() = True Then
                    If chk_include_evalues.Checked = True And chk_include_evalues.Visible = True Then
                        Call NEW_CREATE_SPEC_PAGE("evalues_charts", htmlOut, temp_pdf_header, AircraftTable, crmSource, otherID, crmView)
                    End If
                End If


                If check_cover.Checked = False Then

                    If HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then

                        If Not Application.Item("crmClientSiteData").crmClientHostName.ToString.ToUpper.Contains("NEWEVONET") Then
                            activeFolder = "https://www.testjetnetevolution.com/"
                        Else
                            activeFolder = "http://www.jetnetevolution.com/"
                        End If

                    Else
                        activeFolder = Application.Item("crmClientSiteData").ClientFullHostName.ToString.Trim
                    End If

                    htmlOut.Append("<link rel='stylesheet' type='text/css' href='" & activeFolder & "EvoStyles/stylesheets/tableThemes.css' />")
                    ' htmlOut.Append("<table width='" & IIf(reportType.SelectedValue = "Word", word_width, "100%") & "' height='0' align=""center"" cellpadding=""0"" cellspacing=""0"" style=""background-color:#d4d4d4;background-size:100% 0px;background-image:url('" & activeFolder & "images/background/wordBackground.jpg');""><tr><td valign=""bottom"">")
                    ' htmlOut.Append("</td></tr></table>")
                    '  htmlOut.Append("</table>")
                End If

            Next

            htmlOut.Append("</body></html>")

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in create_aircraft_full_spec_sheet(ByVal item_string As Array) As String" + ex.Message
        End Try

        Return htmlOut.ToString

        htmlOut = Nothing

    End Function

    Public Sub CreateACHeader(ByVal acIdPass As Long)
        Dim acInfoArray() As String = Split(commonEvo.GetAircraftInfo(acIdPass, False), Constants.cSvrDataSeperator)
        SerNoHeader += "<h2 class='" & Session("FONT_CLASS_HEADER") & "  mainHeading' " & IIf(bWordReport, "style='font-size:27px'", "") & ">"

        If UBound(acInfoArray) = 3 Then
            SerNoHeader += "<strong>"
            If Not String.IsNullOrEmpty(acInfoArray(0).ToString) Then
                ac_make = acInfoArray(0).ToString
                SerNoHeader += acInfoArray(0).ToString & " "
            End If

            If Not String.IsNullOrEmpty(acInfoArray(1).ToString) Then
                ac_model = acInfoArray(1).ToString
                SerNoHeader += acInfoArray(1).ToString
            End If
            SerNoHeader += "</strong> "
            If Not chkBlindReport.Checked Then
                If Not String.IsNullOrEmpty(acInfoArray(2).ToString) Then
                    ac_ser = acInfoArray(2).ToString
                    SerNoHeader += " SN #" + acInfoArray(2).ToString
                End If
            End If
            If Not chkBlindReport.Checked Then
                If Not String.IsNullOrEmpty(acInfoArray(3).ToString) Then
                    ac_reg = acInfoArray(3).ToString
                End If
            End If
        End If
        SerNoHeader += "</h2>"
    End Sub

    Public Sub NEW_CREATE_SPEC_PAGE_OldTemplate(ByVal page_num As String, ByRef htmlOut As StringBuilder)
        Dim bHasNoBlankAcFieldsCookie As Boolean = False
        Dim bShowBlankAcFields As Boolean = commonEvo.getUserShowBlankACFields(Session.Item("ShowCondensedAcFormat"), bHasNoBlankAcFieldsCookie)
        ShowNewTemplate = False
        If made_first_page = True Then
            htmlOut.Append(comp_functions.NEW_Insert_Page_Break_PDF(Counter_For_PDF, reportType.SelectedValue))
        End If

        made_first_page = True

        htmlOut.Append(comp_functions.NEW_build_full_spec_page_header(NEW_AC_ID, "", comp_address, comp_logo, 0, NEW_COMP_ID, bWordReport, word_width, pdf_html_width, check_prepared_for, chkBlindReport, prepared_for, Header_Company_Name, False))

        If page_num = "cover" Then

            If Trim(ac_features) = "" Or Trim(first_ac_pic) = "" Then
                Call NEW_build_aircraft_basic_block(NEW_AC_ID, nAircraftJournalID_Full, acdet, first_ac_pic, ac_features, int_section, ext_section, int_moyear, ext_moyear, AirframeString)
            End If

            htmlOut.Append(CreateStartingTable())
            htmlOut.Append("<tr>")
            htmlOut.Append("<td align=""left"" valign=""top""><div class=""Box"">")
            htmlOut.Append(ac_features.ToString)
            htmlOut.Append("</div></td>")
            htmlOut.Append("</tr>")

            htmlOut.Append("</table>")

        End If

        If page_num = "airframe" Then

            If Trim(acdet.ToString) = "" Then
                Call NEW_build_aircraft_basic_block(NEW_AC_ID, nAircraftJournalID_Full, acdet, first_ac_pic, ac_features, int_section, ext_section, int_moyear, ext_moyear, AirframeString)
            End If
            ' IF Moved will have to seperate count for apu and engine
            Call NEW_Build_Additional_Data(NEW_AC_ID, engine_info, apu_data, "", False)
            htmlOut.Append(acdet.ToString)
            htmlOut.Append(NEW_Build_Spacer_Row())
            htmlOut.Append(engine_info.ToString)
            htmlOut.Append(NEW_Build_Spacer_Row())
            htmlOut.Append(apu_data.ToString)
        End If

        If page_num = "avionics" Then
            htmlOut.Append(NEW_build_full_spec_aircraft_avionics(NEW_AC_ID, nAircraftJournalID_Full, 0))
            htmlOut.Append(NEW_build_full_spec_aircraft_details(NEW_AC_ID, nAircraftJournalID_Full, "Addl Cockpit Equipment','Equipment", "", ""))
        End If

        If page_num = "notes" Then
            htmlOut.Append(NEW_build_full_spec_notes_page(NEW_AC_ID, 0))
        End If

        If page_num = "intext" Then
            If Trim(int_section) = "" Or Trim(ext_section) = "" Then
                int_section = ""
                ext_section = ""
                Call NEW_build_aircraft_basic_block(NEW_AC_ID, nAircraftJournalID_Full, acdet, first_ac_pic, ac_features, int_section, ext_section, int_moyear, ext_moyear, AirframeString)
            End If
            htmlOut.Append(NEW_build_full_spec_aircraft_details(NEW_AC_ID, nAircraftJournalID_Full, "Interior", int_moyear, int_section))
            htmlOut.Append(NEW_build_full_spec_aircraft_details(NEW_AC_ID, nAircraftJournalID_Full, "Exterior", ext_moyear, ext_section))
        End If

        If page_num = "maintadd" Then
            htmlOut.Append(NEW_build_full_spec_aircraft_details(NEW_AC_ID, nAircraftJournalID_Full, "Maintenance", "", NEW_Build_Additional_Data(ac_id, "", "", add_data, True)))
            htmlOut.Append(NEW_Make_MaintDetails())
        End If

        If page_num = "compcontacts" Then
            htmlOut.Append(NEW_build_full_spec_aircraft_contacts(NEW_AC_ID, 0))
        End If

        If page_num = "history" Then
            htmlOut.Append(NEW_build_full_spec_transactions_page(NEW_AC_ID, 0))
        End If

        If page_num = "pics" Then
            'If Chk_ALLPIC.Checked = True Then
            '  htmlOut.Append(NEW_build_full_spec_next_pictures(NEW_AC_ID))
            'End If

            htmlOut.Append(NEW_build_full_spec_pictures_page(NEW_AC_ID, ""))
        End If




        '' check to see if this ac is an helicopter
        'Dim makeModelProduct As String = ""
        'commonEvo.Get_Aircraft_Model_Info(CLng(commonEvo.GetAircraftInfo(AC_ID, True)), False, makeModelProduct)

        'If CInt(makeModelProduct.Trim) = Constants.PRODUCT_CODE_HELICOPTERS Then
        '  htmlOut.Append(NEW_build_full_spec_heli_details(AC_ID, 0))
        'End If

    End Sub
    Public Sub NEW_CREATE_SPEC_PAGE(ByVal page_num As String, ByRef htmlOut As StringBuilder, ByVal temp_header As String, ByVal AircraftReusableTable As DataTable, ByVal crmSource As String, ByVal otherID As Long, ByVal crmVIEW As Boolean)
        Dim TemporaryPDFHeader As String = ""
        Dim bHasNoBlankAcFieldsCookie As Boolean = False
        Dim bShowBlankAcFields As Boolean = commonEvo.getUserShowBlankACFields(Session.Item("ShowCondensedAcFormat"), bHasNoBlankAcFieldsCookie)
        Dim temp_status As String = ""
        Dim temp_maint As String = ""
        Dim temp_avionics As String = ""
        Dim values_label As String = ""



        pdf_html_width = "100%"

        If bWordReport Then
            word_width = "760"
        Else
            spacer_width = ""
        End If


        If made_first_page = True Then
            TemporaryPDFHeader = "</div>"
        End If

        '
        '  If made_first_page = False And page_num <> "cover" Then  
        '    temp_header = Replace(temp_header, "viewValueExport ", "viewValueExport withoutCover ")
        '  End If
        made_first_page = True
        '


        If page_num = "maintadd" And int_ext_count < 13 Then
            ' dont do page break and header 
            TemporaryPDFHeader = "" ' get rid of the end div 
        ElseIf page_num = "avionics" And apu_count <= 10 Then
            ' dont do page break and header 
            TemporaryPDFHeader = "" ' get rid of the end div 
        Else
            TemporaryPDFHeader += temp_header
        End If

        ' If ShowNewTemplate = False Then

        'End If

        If page_num = "cover" Then

            If Chk_ALLPIC.Checked = True Then
                first_ac_pic = (NEW_build_full_spec_first_picture(otherID))
            End If


            htmlOut.Append(DisplayCloudPDFHeader(Replace(first_ac_pic.ToString, "No Pictures Available", ""), comp_logo, Header_Company_Name, comp_address, ac_year_display & " " & ac_make & " " & ac_model, IIf(chkBlindReport.Checked, "", "Ser #: " & ac_ser & ", Reg#: " & ac_reg)))

        Else
            htmlOut.Append(TemporaryPDFHeader)
        End If


        If page_num = "airframe" Then

            htmlOut.Append(CreateStartingTable())
            'Identification Block.
            htmlOut.Append("<tr>")
            htmlOut.Append("<td align=""left"" valign=""top"">")
            htmlOut.Append(CommonAircraftFunctions.Build_Identification_Block(TableColor, bWordReport, spacer_width, word_width, pdf_html_width, Counter_For_PDF, AircraftReusableTable, crmSource, nAircraftJournalID_Full, NEW_AC_ID, Master.aclsData_Temp, chkBlindReport, chkIncludeBaseLocation, HttpContext.Current.Session.Item("localPreferences").AerodexFlag, 0, False))
            htmlOut.Append("<br /></td></tr>")
            'Status Block
            htmlOut.Append("<tr>")


            htmlOut.Append("<td align=""left"" valign=""top"">")

            temp_status = CommonAircraftFunctions.Build_Status_Block(NEW_AC_ID, nAircraftJournalID_Full, New DataTable, AircraftReusableTable, bWordReport, HttpContext.Current.Session.Item("localPreferences").AerodexFlag, Counter_For_PDF, word_width, pdf_html_width, TableColor, spacer_width, Master.aclsData_Temp, addToAsking, chkShowAsking, chkBlindReport, chkEB, crmSource, "", New TextBox, False, False, False, "")


            If clsGeneral.clsGeneral.isEValuesAvailable() = True And clsGeneral.clsGeneral.isShowingEvalues() = True Then
                If chk_include_evalues.Checked = True And chk_include_evalues.Visible = True Then
                    ' ------- ADDED MSW - TO INCLUDE EVALUES INTO  SPEC ------------------ 
                    temp_ac_dlv_year = Get_AC_DLV_YEAR(NEW_AC_ID)

                    Dim utilization_functions1 As New utilization_view_functions
                    utilization_functions1.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
                    utilization_functions1.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
                    utilization_functions1.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
                    utilization_functions1.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
                    utilization_functions1.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim
                    Call utilization_functions1.views_display_evalues_in_status_block(searchCriteria, nAircraftJournalID_Full, Nothing, temp_status, Nothing, temp_ac_dlv_year, ac_make & " " & ac_model, searchCriteria.ViewCriteriaAmodID, NEW_AC_ID, 0)
                    ' -------
                End If
            End If


            htmlOut.Append(temp_status)
            htmlOut.Append("<br /></td></tr>")

            'Airframe Block
            htmlOut.Append("<tr>")
            htmlOut.Append("<td align=""left"" valign=""top"">")
            htmlOut.Append(CommonAircraftFunctions.Build_AirframeBlock(TableColor, bWordReport, spacer_width, word_width, pdf_html_width, AircraftReusableTable, crmSource, NEW_AC_ID, crmVIEW, False))
            htmlOut.Append("</td></tr>")
            htmlOut.Append("<tr>")
            'Features
            htmlOut.Append("<td align=""left"" valign=""top"">")
            If customFeatureList.Checked = True Then
                htmlOut.Append(BuildOnlyFeaturesIfChecked())
            Else
                Dim teststr As String = CommonAircraftFunctions.DisplayKeyFeatures(Master.aclsData_Temp, Session, AircraftReusableTable, crmSource, "", commonEvo.getUserShowBlankACFields(Session.Item("ShowCondensedAcFormat"), False), TableColor, NEW_AC_ID, False, 0, otherID, spacer_width)
                htmlOut.Append(teststr)
            End If
            htmlOut.Append("</td>")
            htmlOut.Append("</tr>")

            htmlOut.Append("</table>")
        End If

        If page_num = "engineAPU" Then

            apu_count = Counter_For_PDF
            htmlOut.Append(CreateStartingTable())
            'Engine Block

            htmlOut.Append("<tr><td align=""left"" valign=""top"">")
            htmlOut.Append(CommonAircraftFunctions.Build_Engine_Block(NEW_AC_ID, AircraftReusableTable, bWordReport, Counter_For_PDF, word_width, pdf_html_width, TableColor, spacer_width, crmSource, False, Session, bShowBlankAcFields, "pdf"))
            htmlOut.Append("<br /></td></tr><tr>")

            ' ADDED IN MSW 
            htmlOut.Append("<tr><td align=""left"" valign=""top"">")
            htmlOut.Append(CommonAircraftFunctions.DisplayPropRotorInfo_Vertical(Session, AircraftReusableTable, Nothing, Master.aclsData_Temp, bShowBlankAcFields))
            htmlOut.Append("<br /></td></tr><tr>")

            'Apu block
            htmlOut.Append("<td align=""left"" valign=""top"">")
            htmlOut.Append(CommonAircraftFunctions.Build_APU_Block(AircraftReusableTable, bWordReport, Counter_For_PDF, word_width, pdf_html_width, TableColor, spacer_width, crmSource, NEW_AC_ID, False, Master.aclsData_Temp))
            htmlOut.Append("<br /></td>")
            htmlOut.Append("</tr>")

            apu_count = (Counter_For_PDF - apu_count)

            'then break no matter what  
            htmlOut.Append("</table>")
        End If

        If page_num = "avionics" Then
            avionics_count = Counter_For_PDF
            Dim detText As String = ""
            Dim avionicsCount As Integer = 0
            Dim equipmentLength As Integer = 0
            equipmentLength = GetDetailsEquipmentLength(otherID)

            temp_avionics = ""
            temp_avionics &= ("<tr>")
            temp_avionics &= ("<td align=""left"" valign=""top"">")
            'Avionics
            temp_avionics &= (CommonAircraftFunctions.Build_Avionics_Block(NEW_AC_ID, 0, avionicsCount, spacer_width, AircraftReusableTable, Master.aclsData_Temp, crmSource, bWordReport, Counter_For_PDF, word_width, pdf_html_width, TableColor, False, otherID))
            temp_avionics &= ("<br /></td></tr>")
            'Let's check to see if we need a new page.
            If (((avionicsCount) + 4) + (equipmentLength / 100)) > 34 Then
                'We need a new page.
                temp_avionics &= ("</div></td></tr></table></div><div class=""valueSpec viewValueExport Simplistic aircraftSpec"">")
                temp_avionics &= (comp_functions.NEW_build_full_spec_page_header(otherID, "", comp_address, comp_logo, 0, NEW_COMP_ID, bWordReport, word_width, pdf_html_width, check_prepared_for, chkBlindReport, prepared_for))
                temp_avionics &= (CreateStartingTable())
            End If

            temp_avionics &= ("<tr>")

            'Equipment

            temp_avionics &= ("<td align=""left"" valign=""top"">")
            temp_avionics &= (CommonAircraftFunctions.Build_Details_Block("Addl Cockpit Equipment','Equipment", AircraftReusableTable, "", "", crmSource, bWordReport, Counter_For_PDF, word_width, pdf_html_width, TableColor, spacer_width, Master.aclsData_Temp, NEW_AC_ID, crmVIEW, False, 0, otherID))
            temp_avionics &= ("<br /></td>")
            temp_avionics &= ("</tr></table>")


            avionics_count = (Counter_For_PDF - avionics_count)

            If apu_count > 10 Then  ' then we already used a page break, if apu_count <= 10 then we have not yet possibly made page break
                htmlOut.Append(CreateStartingTable())
                htmlOut.Append(temp_avionics)
            ElseIf avionics_count + apu_count > 11 Then     ' then we need the page break ebfore we put the avionics in, otherwise.. 
                htmlOut.Append(temp_header)
                htmlOut.Append(CreateStartingTable())
                htmlOut.Append(temp_avionics)
            Else
                'otherwise, if we are not doing a page break
                If bWordReport = True Then
                    htmlOut.Append("<table width='" & word_width & "' align='center'>")
                Else
                    htmlOut.Append("<table width='95%' align='center' class=""containingTable"">")
                End If
                htmlOut.Append(temp_avionics)
            End If



        End If

        ' If crmVIEW = False Then
        If page_num = "notes" Then
            htmlOut.Append(CreateStartingTable())
            htmlOut.Append("<tr>")
            htmlOut.Append("<td align=""left"" valign=""top""><div class=""Box removeTopPadding"">")
            'notes
            htmlOut.Append(NEW_build_full_spec_notes_page(otherID, 0))
            htmlOut.Append("</div></td>")
            htmlOut.Append("</tr></table>")
        End If
        'End If

        If page_num = "intext" Then
            Dim newPage As Long = GetDetailsLimit("interior", NEW_AC_ID)

            int_ext_count = Counter_For_PDF
            htmlOut.Append(CreateStartingTable())
            htmlOut.Append("<tr>")
            htmlOut.Append("<td align=""left"" valign=""top"">")
            'interior
            htmlOut.Append(CommonAircraftFunctions.Build_Details_Block("interior", AircraftReusableTable, "", "", crmSource, bWordReport, Counter_For_PDF, word_width, pdf_html_width, TableColor, spacer_width, Master.aclsData_Temp, NEW_AC_ID, crmVIEW, False, 0, otherID))
            htmlOut.Append("<br /></td></tr>")

            If newPage >= 20 Then
                htmlOut.Append("</div></td></tr></table></div><div class=""valueSpec viewValueExport Simplistic aircraftSpec"">")
                htmlOut.Append(comp_functions.NEW_build_full_spec_page_header(NEW_AC_ID, "", comp_address, comp_logo, 0, NEW_COMP_ID, bWordReport, word_width, pdf_html_width, check_prepared_for, chkBlindReport, prepared_for))
                htmlOut.Append(CreateStartingTable())
            End If
            htmlOut.Append("<tr>")
            htmlOut.Append("<td align=""left"" valign=""top"">")
            'exterior
            htmlOut.Append(CommonAircraftFunctions.Build_Details_Block("exterior", AircraftReusableTable, "", "", crmSource, bWordReport, Counter_For_PDF, word_width, pdf_html_width, TableColor, spacer_width, Master.aclsData_Temp, NEW_AC_ID, crmVIEW, False, 0, otherID))
            htmlOut.Append("<br /></td>")
            htmlOut.Append("</tr></table>")

            ' make it = to the difference, so you now know how many were added to int/ext 
            int_ext_count = (Counter_For_PDF - int_ext_count)
        End If

        If page_num = "maintadd" Then

            maint_count = Counter_For_PDF
            temp_maint = ("<tr>")
            temp_maint &= ("<td align=""left"" valign=""top"">")
            'maintenance
            temp_maint &= (CommonAircraftFunctions.Build_Details_Block("maintenance", AircraftReusableTable, "", "", crmSource, bWordReport, Counter_For_PDF, word_width, pdf_html_width, TableColor, spacer_width, Master.aclsData_Temp, NEW_AC_ID, crmVIEW, False, 0, otherID))
            temp_maint &= ("</div></td>")
            temp_maint &= ("</tr></table>")

            'will get you number of maint items
            maint_count = (Counter_For_PDF - maint_count)
            If int_ext_count < 13 And ((maint_count + int_ext_count) > 19) Then  '  then we still ened to break, otherwise, no break 
                htmlOut.Append("</div>")
                htmlOut.Append(temp_header)
                htmlOut.Append(CreateStartingTable())
            Else
                If bWordReport = True Then
                    htmlOut.Append("<table width='" & word_width & "' align='center'>")
                Else
                    htmlOut.Append("<table width='95%' align='center' class=""containingTable"">")
                End If
            End If

            htmlOut.Append(temp_maint)
        End If

        If page_num = "compcontacts" Then
            htmlOut.Append(CreateStartingTable())
            htmlOut.Append("<tr>")
            htmlOut.Append("<td align=""left"" valign=""top"" class=""aircraftSpec"">")
            'htmlOut.Append(NEW_build_full_spec_aircraft_contacts(NEW_AC_ID, 0))
            htmlOut.Append(CommonAircraftFunctions.GetCompanies_DisplayAircraftDetails(Session, AircraftReusableTable, IIf(crmSource <> "CLIENT", True, False), False, False, Master.aclsData_Temp, crmSource, 0, otherID, NEW_AC_ID, chkEB.Checked))

            htmlOut.Append("</td></tr></table>")
        End If

        If page_num = "history" Then

            htmlOut.Append(CreateStartingTable())
            htmlOut.Append("<tr>")
            htmlOut.Append("<td align=""left"" valign=""top""><div class=""Box removeTopPadding"">")
            htmlOut.Append(NEW_build_full_spec_transactions_page(otherID, 0))
            htmlOut.Append("</div></td></tr></table>")


        End If

        If page_num = "pics" Then
            htmlOut.Append(CreateStartingTable())
            htmlOut.Append("<tr><td align=""left"" valign=""top""><div class=""Box removeTopPadding"">")
            htmlOut.Append(NEW_build_full_spec_pictures_page(otherID, TemporaryPDFHeader))
            htmlOut.Append("</div></td></tr></table>")

            htmlOut.Append("</div>")
        End If

        If page_num = "flightdata" Then
            Dim flight_data_temp As New flightDataFunctions
            Dim temp_string As String = ""
            Dim google_string As String = ""
            Dim charting_string As String = ""
            flight_data_temp.serverConnectStr = Session.Item("jetnetClientDatabase")
            flight_data_temp.clientConnectStr = Session.Item("jetnetServerNotesDatabase")

            Call flight_data_temp.make_ac_flights_comparisons(otherID, temp_string, Nothing, Nothing, NEW_AMOD_ID, start_date, end_date, start_date.Text, ac_reg, 0, 0, False, "", "", 0, Page, check_update, Report_Panel, google_string) '  chart_panel, map_panel)

            htmlOut.Append(CreateStartingTable())
            htmlOut.Append("<tr><td colspan='2' align='left'><font class='" & Session("FONT_CLASS_HEADER") & " subHeader'>Utilization&nbsp;</font></td></tr>")

            If bWordReport = False Then
                htmlOut.Append("<tr><td align=""center"" valign=""top""><div class=""Box removeTopPadding"">")
                htmlOut.Append("<table align='center' width='100%'><tr><td align='center'><img src='" & valueGraphText13.Text & "'  width=""94%"" /></td></tr></table></div></td></tr>")
            End If
            htmlOut.Append("<tr><td align=""left"" valign=""top""><div class=""Box removeTopPadding"">")


            temp_string = Replace(temp_string, "<td align='right'>", "<td align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER_NOCOLOR") & "'>")

            temp_string = Replace(temp_string, "&nbsp;</td>", "&nbsp;</font></td>")


            '   temp_string = Replace(temp_string, "&nbsp;</td>", "</font><font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER") & " subHeader'>&nbsp;</font></td>")

            '   temp_string = Replace(temp_string, "<th>", "<th><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>")
            '  temp_string = Replace(temp_string, "</th>", "</font></th>")

            temp_string = Replace(temp_string, "<strong>", "<strong><font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER") & " subHeader'>")
            temp_string = Replace(temp_string, "</strong>", "</font></strong>")


            htmlOut.Append(temp_string)
            htmlOut.Append("</div></td></tr></table></div>")
        End If


        If page_num = "evalues_charts" Then
            htmlOut.Append(CreateStartingTable())
            htmlOut.Append("<tr>")
            htmlOut.Append("<td align=""left"" valign=""top""><div class=""Box removeTopPadding"">")

            If temp_ac_dlv_year = 0 Then
                temp_ac_dlv_year = Get_AC_DLV_YEAR(NEW_AC_ID)
            End If


            htmlOut.Append("<tr><td align=""center"" valign=""top""><div class=""Box removeTopPadding"">")
            htmlOut.Append("<table align='center' width='90%'><tr><td align='center'><img src='" & valueGraphTextVal1.Text & "'  width=""100%"" /></td></tr></table></div></td></tr>")

            values_label = CommonAircraftFunctions.Build_ValuesBlock(localDatalayer, Nothing, NEW_AC_ID, 0, Page, valuesUpdatePanel, crmSource, NEW_AMOD_ID, Page, temp_ac_dlv_year, "", "pdf")

            htmlOut.Append("<tr><td align=""center"" valign=""top""><div class=""Box removeTopPadding"">")
            htmlOut.Append(values_label)

            htmlOut.Append("<br/><table align='center' width='90%'><tr><td align='center'><img src='" & valueGraphTextVal2.Text & "'  width=""100%"" /></td></tr></table></div></td></tr>")
            htmlOut.Append("</div></td></tr>")


            htmlOut.Append("</div></td>")
            htmlOut.Append("</tr></table>")
        End If



        If bWordReport And page_num <> "flightdata" Then

            htmlOut.Append(Insert_Page_Break_PDF)

        End If
    End Sub
    Public Sub load_google_chart_all(ByVal string_from_charts As String)
        Dim GoogleChart1TabScript As StringBuilder = New StringBuilder()

        Dim temp_string As String = ""
        Dim label_script As New Label
        Dim chart_label As New Label



        temp_string &= "google.charts.setOnLoadCallback(function() {"
        temp_string &= "drawCharts();"


        temp_string &= "function drawCharts() {"

        temp_string &= string_from_charts

        temp_string &= " } "
        temp_string &= "});"
        'temp_string &= "alert(document.getElementById('" & div_name & "'));"



        label_script.ID = "label_script"
        label_script.Text = temp_string


        'tab_to_add_to.Controls.AddAt(0, label_script)


        If Not Page.ClientScript.IsClientScriptBlockRegistered("GoogleChart1Tab") Then
            GoogleChart1TabScript.Append(temp_string)

            System.Web.UI.ScriptManager.RegisterStartupScript(select_report_panel, Me.GetType(), "GoogleChart1Tab", GoogleChart1TabScript.ToString, True)
        End If


    End Sub
    Public Sub SetUpJavascriptOnClickGoogleGraph()
        Dim jScript As String = ""
        jScript = ""
        jScript = "$(""#" & btnRunReport.ClientID & """).click(function() {"

        jScript += "$(""#" & valueGraphText13.ClientID & """).val($('#" & png13.ClientID & " img').prop('src'));"

        jScript += "$(""#" & valueGraphTextVal1.ClientID & """).val($('#" & pngVal1.ClientID & " img').prop('src'));"

        jScript += "$(""#" & valueGraphTextVal2.ClientID & """).val($('#" & pngVal2.ClientID & " img').prop('src'));"

        jScript += "});"

        System.Web.UI.ScriptManager.RegisterStartupScript(Me, Me.GetType(), "btnReportOnClickEvent", jScript.ToString, True)
    End Sub
    'Public Sub NEW_CREATE_SPEC_PAGE(ByVal page_num As String, ByRef htmlOut As StringBuilder)
    '  Dim TemporaryPDFHeader As String = ""


    '  If made_first_page = False Then
    '  ElseIf ShowNewTemplate = False Then
    '    htmlOut.Append(comp_functions.NEW_Insert_Page_Break_PDF(Counter_For_PDF, reportType.SelectedValue))
    '  End If


    '  If ShowNewTemplate Then
    '    pdf_html_width = "100%"
    '    spacer_width = ""
    '    If made_first_page = True Then
    '      TemporaryPDFHeader = "</div>"
    '    End If
    '    TemporaryPDFHeader += "<div class=""valueSpec viewValueExport Simplistic aircraftSpec"">"
    '  End If

    '  made_first_page = True

    '  TemporaryPDFHeader += comp_functions.NEW_build_full_spec_page_header(NEW_AC_ID, "", comp_address, comp_logo, 0, NEW_COMP_ID, bWordReport, word_width, pdf_html_width, check_prepared_for, chkBlindReport, prepared_for, Header_Company_Name, False)

    '  ' If ShowNewTemplate = False Then
    '  htmlOut.Append(TemporaryPDFHeader)
    '  'End If

    '  If page_num = "cover" Then

    '    If Trim(ac_features) = "" Or Trim(first_ac_pic) = "" Then
    '      Call NEW_build_aircraft_basic_block(NEW_AC_ID, nAircraftJournalID_Full, acdet, first_ac_pic, ac_features, int_section, ext_section, int_moyear, ext_moyear)
    '    End If

    '    If ShowNewTemplate Then
    '      htmlOut = New StringBuilder
    '      htmlOut.Append("<html><body class=""removeMargins"">")
    '      htmlOut.Append(DisplayCloudPDFHeader(Replace(first_ac_pic.ToString, "No Pictures Available", ""), comp_logo, Header_Company_Name, comp_address, ac_year_display & " " & ac_make & " " & ac_model, IIf(chkBlindReport.Checked, "", "Ser #: " & ac_ser & ", Reg#: " & ac_reg)))
    '      htmlOut.Append(TemporaryPDFHeader)
    '    End If


    '    If ShowNewTemplate = False Then
    '      If bWordReport = True Then
    '        htmlOut.Append("<table width='" & word_width & "' align='center'>")
    '      Else
    '        htmlOut.Append("<table width='" & pdf_html_width & "' align='center'>")
    '      End If
    '      htmlOut.Append("<tr><td align='center'>")
    '      htmlOut.Append(first_ac_pic.ToString)
    '      htmlOut.Append("</td></tr>")
    '    Else
    '      htmlOut.Append(CreateStartingTable())
    '    End If

    '    htmlOut.Append("<tr>")

    '    If ShowNewTemplate = True Then
    '      htmlOut.Append("<td align=""left"" valign=""top""><div class=""Box removeTopPadding"">")
    '      htmlOut.Append(acdet.ToString)
    '      htmlOut.Append("</div><br /></td></tr><tr>")
    '    End If
    '    htmlOut.Append("<td align=""left"" valign=""top""><div class=""Box"">")
    '    htmlOut.Append(ac_features.ToString)
    '    htmlOut.Append("</div></td>")
    '    htmlOut.Append("</tr>")

    '    htmlOut.Append("</table>")

    '  End If

    '  If page_num = "airframe" Then

    '    If Trim(acdet.ToString) = "" Then
    '      Call NEW_build_aircraft_basic_block(NEW_AC_ID, nAircraftJournalID_Full, acdet, first_ac_pic, ac_features, int_section, ext_section, int_moyear, ext_moyear)
    '    End If
    '    If ShowNewTemplate Then
    '      htmlOut.Append(CreateStartingTable())
    '      htmlOut.Append("<tr class=""noBorder""><td align=""left"" valign=""top"" colspan=""3"">&nbsp;</td></tr>")
    '      Call NEW_Build_Additional_Data(NEW_AC_ID, engine_info, apu_data, "", False)
    '      htmlOut.Append("<tr><td align=""left"" valign=""top"">")
    '      If Not String.IsNullOrEmpty(engine_info) Then
    '        htmlOut.Append("<div class=""Box removeTopPadding"">" & engine_info.ToString & "</div><br />")
    '      End If
    '      htmlOut.Append("</td></tr><tr>")

    '      htmlOut.Append("<td align=""left"" valign=""top""><br />")
    '      If Not String.IsNullOrEmpty(apu_data) Then
    '        htmlOut.Append(apu_data.ToString)
    '      End If
    '      htmlOut.Append("</td>")
    '      htmlOut.Append("</tr></table>")
    '    Else
    '      ' IF Moved will have to seperate count for apu and engine
    '      Call NEW_Build_Additional_Data(NEW_AC_ID, engine_info, apu_data, "", False)
    '      htmlOut.Append(acdet.ToString)
    '      htmlOut.Append(NEW_Build_Spacer_Row())
    '      htmlOut.Append(engine_info.ToString)
    '      htmlOut.Append(NEW_Build_Spacer_Row())
    '      htmlOut.Append(apu_data.ToString)
    '    End If
    '  End If

    '    If page_num = "pic" Then

    '    End If

    '    If page_num = "avionics" Then
    '      If ShowNewTemplate Then
    '        Dim detText As String = ""
    '        htmlOut.Append(CreateStartingTable())
    '        htmlOut.Append("<tr>")
    '      htmlOut.Append("<td align=""left"" valign=""top"">")
    '        detText = NEW_build_full_spec_aircraft_avionics(NEW_AC_ID, nAircraftJournalID_Full)

    '        If Not String.IsNullOrEmpty(detText) Then
    '        htmlOut.Append("<div class=""Box  removeTopPadding"">" & detText & "</div><br />")
    '        End If
    '        detText = ""
    '      htmlOut.Append("</td></tr><tr>")
    '      htmlOut.Append("<td align=""left"" valign=""top"">")
    '        detText = NEW_build_full_spec_aircraft_details(NEW_AC_ID, nAircraftJournalID_Full, "Addl Cockpit Equipment','Equipment", "", "")
    '        If Not String.IsNullOrEmpty(detText) Then
    '          htmlOut.Append("<div class=""Box"">" & detText & "</div>")
    '        End If
    '        detText = ""
    '        htmlOut.Append("</div></td>")
    '        htmlOut.Append("</tr></table>")

    '      Else
    '        htmlOut.Append(NEW_build_full_spec_aircraft_avionics(NEW_AC_ID, nAircraftJournalID_Full))
    '        htmlOut.Append(NEW_build_full_spec_aircraft_details(NEW_AC_ID, nAircraftJournalID_Full, "Addl Cockpit Equipment','Equipment", "", ""))
    '      End If
    '    End If

    '  If page_num = "notes" Then
    '    If ShowNewTemplate Then
    '      htmlOut.Append(CreateStartingTable())
    '      htmlOut.Append("<tr>")
    '      htmlOut.Append("<td align=""left"" valign=""top""><div class=""Box removeTopPadding"">")
    '      htmlOut.Append(NEW_build_full_spec_notes_page(NEW_AC_ID, 0))
    '      htmlOut.Append("</div></td>")
    '      htmlOut.Append("</tr></table>")
    '    Else
    '      htmlOut.Append(NEW_build_full_spec_notes_page(NEW_AC_ID, 0))
    '    End If

    '  End If

    '  If page_num = "intext" Then
    '    If Trim(int_section) = "" Or Trim(ext_section) = "" Then
    '      int_section = ""
    '      ext_section = ""
    '      Call NEW_build_aircraft_basic_block(NEW_AC_ID, nAircraftJournalID_Full, acdet, first_ac_pic, ac_features, int_section, ext_section, int_moyear, ext_moyear)
    '    End If

    '    If ShowNewTemplate Then
    '      Dim newPage As Long = GetDetailsLimit("interior", NEW_AC_ID)


    '      htmlOut.Append(CreateStartingTable())
    '      htmlOut.Append("<tr>")
    '      htmlOut.Append("<td align=""left"" valign=""top""><div class=""Box removeTopPadding"">")
    '      htmlOut.Append(NEW_build_full_spec_aircraft_details(NEW_AC_ID, nAircraftJournalID_Full, "Interior", int_moyear, int_section))
    '      htmlOut.Append("</div><br /><br /></td></tr>")

    '      If newPage >= 20 Then
    '        htmlOut.Append("</div></td></tr></table></div><div class=""valueSpec viewValueExport Simplistic aircraftSpec"">")
    '        htmlOut.Append(comp_functions.NEW_build_full_spec_page_header(NEW_AC_ID, "", comp_address, comp_logo, 0, NEW_COMP_ID, bWordReport, word_width, pdf_html_width, check_prepared_for, chkBlindReport, prepared_for))
    '        htmlOut.Append(CreateStartingTable())
    '      End If
    '      htmlOut.Append("<tr>")
    '      htmlOut.Append("<td align=""left"" valign=""top""><div class=""Box"">")
    '      htmlOut.Append(NEW_build_full_spec_aircraft_details(NEW_AC_ID, nAircraftJournalID_Full, "Exterior", ext_moyear, ext_section))
    '      htmlOut.Append("</div></td>")
    '      htmlOut.Append("</tr></table>")
    '    Else
    '      htmlOut.Append(NEW_build_full_spec_aircraft_details(NEW_AC_ID, nAircraftJournalID_Full, "Interior", int_moyear, int_section))
    '      htmlOut.Append(NEW_build_full_spec_aircraft_details(NEW_AC_ID, nAircraftJournalID_Full, "Exterior", ext_moyear, ext_section))

    '    End If
    '  End If

    '  If page_num = "maintadd" Then
    '    If ShowNewTemplate = True Then
    '      htmlOut.Append(CreateStartingTable())
    '      htmlOut.Append("<tr>")
    '      htmlOut.Append("<td align=""left"" valign=""top"" width=""49%""><div class=""Box  removeTopPadding"">")
    '      htmlOut.Append(NEW_build_full_spec_aircraft_details(NEW_AC_ID, nAircraftJournalID_Full, "Maintenance", "", NEW_Build_Additional_Data(ac_id, "", "", add_data, True)))
    '      htmlOut.Append("</div></td></tr><tr>")
    '      htmlOut.Append("<td align=""left"" valign=""top"" width=""49%""><div class=""Box"">")
    '      htmlOut.Append(NEW_Make_MaintDetails())
    '      htmlOut.Append("</div></td>")
    '      htmlOut.Append("</tr></table>")
    '    Else
    '      htmlOut.Append(NEW_build_full_spec_aircraft_details(NEW_AC_ID, nAircraftJournalID_Full, "Maintenance", "", NEW_Build_Additional_Data(ac_id, "", "", add_data, True)))
    '      htmlOut.Append(NEW_Make_MaintDetails())
    '    End If
    '  End If

    '  If page_num = "compcontacts" Then
    '    If ShowNewTemplate = True Then
    '      htmlOut.Append(CreateStartingTable())
    '      htmlOut.Append("<tr>")
    '      htmlOut.Append("<td align=""left"" valign=""top""><div class=""Box removeTopPadding"">")
    '      htmlOut.Append(NEW_build_full_spec_aircraft_contacts(NEW_AC_ID, 0))
    '      htmlOut.Append("</div></td></tr></table>")
    '    Else
    '      htmlOut.Append(NEW_build_full_spec_aircraft_contacts(NEW_AC_ID, 0))
    '    End If

    '  End If

    '  If page_num = "history" Then
    '    If ShowNewTemplate = True Then
    '      htmlOut.Append(CreateStartingTable())
    '      htmlOut.Append("<tr>")
    '      htmlOut.Append("<td align=""left"" valign=""top""><div class=""Box removeTopPadding"">")
    '      htmlOut.Append(NEW_build_full_spec_transactions_page(NEW_AC_ID, 0))
    '      htmlOut.Append("</div></td></tr></table>")
    '    Else
    '      htmlOut.Append(NEW_build_full_spec_transactions_page(NEW_AC_ID, 0))
    '    End If

    '  End If

    '  If page_num = "pics" Then
    '    'If Chk_ALLPIC.Checked = True Then
    '    '  htmlOut.Append(NEW_build_full_spec_next_pictures(NEW_AC_ID))
    '    'End If
    '    If ShowNewTemplate = True Then
    '      htmlOut.Append(CreateStartingTable())
    '      htmlOut.Append("<tr><td align=""left"" valign=""top""><div class=""Box removeTopPadding"">")
    '      htmlOut.Append(NEW_build_full_spec_pictures_page(NEW_AC_ID, TemporaryPDFHeader))
    '      htmlOut.Append("</td></tr>")
    '    Else
    '      htmlOut.Append(NEW_build_full_spec_pictures_page(NEW_AC_ID, TemporaryPDFHeader))
    '    End If

    '  End If




    '  '' check to see if this ac is an helicopter
    '  'Dim makeModelProduct As String = ""
    '  'commonEvo.Get_Aircraft_Model_Info(CLng(commonEvo.GetAircraftInfo(AC_ID, True)), False, makeModelProduct)

    '  'If CInt(makeModelProduct.Trim) = Constants.PRODUCT_CODE_HELICOPTERS Then
    '  '  htmlOut.Append(NEW_build_full_spec_heli_details(AC_ID, 0))
    '  'End If

    'End Sub
    Public Function CreateStartingTable() As String
        Dim returnString As String = ""

        If bWordReport = True Then
            returnString = "<table width='" & word_width & "' align='center'>"
        Else
            returnString = "<table width='95%' align='center' class=""containingTable"">"
        End If
        returnString += "<tr class=""noBorder""><td align=""left"" valign=""top"">" & SerNoHeader & "</td></tr>"
        Return returnString
    End Function
    Public Function DisplayCloudPDFHeader(ByVal imageTag As String, ByVal logoImage As String, ByVal LogoName As String, ByVal logoAddress As String, ByVal ReportMainTitle As String, ByVal reportSubTitle As String) As String
        Dim returnString As String = ""
        Dim activeFolder As String = ""

        If HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then

            If Not Application.Item("crmClientSiteData").crmClientHostName.ToString.ToUpper.Contains("NEWEVONET") Then
                activeFolder = "https://www.testjetnetevolution.com/"
            Else
                activeFolder = "http://www.jetnetevolution.com/"
            End If

        Else
            activeFolder = Application.Item("crmClientSiteData").ClientFullHostName.ToString.Trim
        End If


        If bWordReport = False Then
            returnString += "<link rel='stylesheet' type='text/css' href='" & activeFolder & "EvoStyles/stylesheets/tableThemes.css' />"
            returnString += "<table width='" & IIf(reportType.SelectedValue = "Word", word_width, "100%") & "' height='" & IIf(reportType.SelectedValue = "Word", "1148", "1448") & "' align=""center"" cellpadding=""0"" cellspacing=""0"" style=""background-color:#d4d4d4;background-size:100% 1448px;background-image:url('" & activeFolder & "images/background/wordBackground.jpg');""><tr><td valign=""bottom"">"
        Else
            returnString += "<table width='" & IIf(reportType.SelectedValue = "Word", word_width, "100%") & "' height='" & IIf(reportType.SelectedValue = "Word", "1148", "1448") & "' align=""center"" cellpadding=""0"" cellspacing=""0"" style=""background-color:#d4d4d4;background-size:100% 1148;background-image:url('" & activeFolder & "images/background/wordBackground.jpg');""><tr><td valign=""bottom"">"
        End If

        returnString += "<table cellspacing='0' cellpadding='0' border='0'  width='" & IIf(reportType.SelectedValue = "Word", word_width, "100%") & "' cellpadding=""0"" cellspacing=""0"" class=""viewValueExport"">"

        returnString += "<tr><td nowrap='nowrap'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td " & IIf(reportType.SelectedValue = "Word", "height='600' valign=""middle"" align='center' ", "align='left' width='45%' height='1100'") & "'><table align='right' width='100%' cellpadding=""0"" cellspacing=""0""><tr><td style='border-bottom-style:solid; border-bottom-width:2px; border-color:#fff' valign='middle' align='left'><font face='arial' style='padding-bottom:15px;display:inline-block;" & IIf(bWordReport, "font-size:36px;color:#000;", "font-size:36px;color:#e1e1e1;") & "'><strong>" & ReportMainTitle & "</strong></td></tr><tr><td align='left'><font color='#fff' face='arial' class=""makeModel"">" & reportSubTitle & "</font><br />"
        returnString += "<font face='arial' color='#fff' class=""dateName"">" & MonthName(Month(Now())) & " " & Day(Now()) & ", " & Year(Now()) & "</font>"

        If check_prepared_for.Checked = True Then
            If prepared_for.Text <> "" Then
                returnString += "<tr><td><table class='FontSize' cellspacing='0' cellpadding='0'><tr><td nowrap='nowrap'><font face='arial' color='#fff' class=""dateName""><b>Prepared For: </b>" & Trim(prepared_for.Text) & "</font></td></tr></table></td></tr>"
            End If
        End If

        returnString += "</td></tr></table>" & IIf(bWordReport, "<br /><br /><br /><br />", "</td><td align='right' width='50%' class=""resizeMax450"">") & "" & imageTag.ToString & "</td><td nowrap='nowrap'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>"
        returnString += "<tr valign='middle'><td height='200' valign=""bottom"" " & IIf(bWordReport, "colspan=""3""", " colspan=""4""") & "><table align='center'  width='" & IIf(reportType.SelectedValue = "Word", word_width - 20, "100%") & "'  " & IIf(bWordReport, "style='padding-bottom:10px;'", "") & " cellpadding=""0"" cellspacing=""0"" class=""overlaySep"">"

        If chkBlindReport.Checked = True And check_blind_company.Checked = True Then
            returnString += "<tr><td align='left' valign=""bottom""><span class=""companyName""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='+2' color='black'><br/>&nbsp;</font></font></td><td rowspan=""2"" align=""right""><br/>&nbsp;</td></tr>"
            returnString += "<tr><td align='left' valign=""top""><Table align='left' cellpadding=""0"" cellspacing=""0"" style=""font-family:Arial !important;font-size:18px !important;color:#737373 !important""><br/>&nbsp;</table></td></tr></table></font></td></tr>"
        ElseIf check_blind_company.Checked = True Then
            returnString += "<tr><td align='left' valign=""bottom""><span class=""companyName""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='+2' color='black'><br/>&nbsp;</font></font></td><td rowspan=""2"" align=""right""><br/>&nbsp;</td></tr>"
            returnString += "<tr><td align='left' valign=""top""><Table align='left' cellpadding=""0"" cellspacing=""0"" style=""font-family:Arial !important;font-size:18px !important;color:#737373 !important""><br/>&nbsp;</table></td></tr></table></font></td></tr>"

        Else
            returnString += "<tr><td align='left' valign=""bottom""><span class=""companyName""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='+2' color='black'>" & LogoName & "</font></font></td><td rowspan=""2"" align=""right"">" & logoImage & "</td></tr>"
            returnString += "<tr><td align='left' valign=""top""><Table align='left' cellpadding=""0"" cellspacing=""0"" style=""font-family:Arial !important;font-size:18px !important;color:#737373 !important"">" & logoAddress & "</table></td></tr></table></font></td></tr>"
        End If




        returnString += "</table></td></tr></table>"


        Return returnString
    End Function
    Public Function NEW_build_full_spec_aircraft_details(ByVal nAircraftID As Long, ByVal nAircraftJournalID As Long, ByVal detail_type As String, ByVal update_date As String, ByVal done_by As String) As String

        Dim last_detail_type As String = ""
        Dim sQuery = New StringBuilder()
        Dim outString As String = ""

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader = Nothing
        Dim SqlException As SqlClient.SqlException = Nothing
        Dim last_detail_section As String = ""
        Dim CountDetail As Integer = 0

        Try



            If bWordReport = True Then
                outString = ("<table width='" & word_width & "' align='center'>")
            Else
                outString = ("<table width='" & pdf_html_width & "' align='center' class=""formatTable " & TableColor & " subtextNoMargin large noBoldUpper"">")
            End If


            sQuery.Append("SELECT * FROM Aircraft_Details WITH(NOLOCK) ")
            sQuery.Append(" inner join Aircraft_Data_Type WITH(NOLOCK) on adet_data_type=adt_data_type and adet_data_name=adt_data_name")
            sQuery.Append(" WHERE adet_ac_id = " + nAircraftID.ToString + "")
            sQuery.Append(" AND adet_journ_id = " + nAircraftJournalID.ToString + " AND lower(adet_data_type) in ('" + detail_type.ToLower.Trim + "')")
            sQuery.Append(" ORDER BY adt_seq_no")

            If Trim(detail_type) = "Addl Cockpit Equipment','Equipment" Then
                detail_type = "Additional Equipment"
            End If

            SqlConn.ConnectionString = localFunctions.clientConnectStr
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString
            SqlReader = SqlCommand.ExecuteReader()

            ' If SqlReader.HasRows Or Trim(done_by) <> "" Then
            'outString &= NEW_Build_Spacer_Row()
            outString &= "<tr class=""noBorder""><td colspan='2' align='center'><font class='" & Session("FONT_CLASS_HEADER") & " subHeader'>" & detail_type & "&nbsp; " & IIf(ShowNewTemplate = True And done_by <> "", done_by & " ", "") & "</font></td></tr>"
            If ShowNewTemplate = False Then
                If Trim(done_by) <> "" Then
                    outString &= done_by
                ElseIf Trim(update_date) <> "" Then
                    outString &= comp_functions.create_value_with_label("Last Done", update_date, True, True, Counter_For_PDF, spacer_width)
                End If
            End If

            ' End If


            If SqlReader.HasRows Then

                Do While SqlReader.Read


                    If Not IsDBNull(SqlReader.Item("adet_data_name")) Then

                        If ShowNewTemplate Then
                            If LCase(detail_type) = "interior" Then
                                CountDetail += 1
                                If CountDetail = 22 Then
                                    CountDetail = 0
                                    outString += "</td></tr></table></td></tr></table></div><div class=""valueSpec viewValueExport Simplistic aircraftSpec"">"
                                    outString += comp_functions.NEW_build_full_spec_page_header(NEW_AC_ID, "", comp_address, comp_logo, 0, NEW_COMP_ID, bWordReport, word_width, pdf_html_width, check_prepared_for, chkBlindReport, prepared_for, Header_Company_Name, False)
                                    outString += CreateStartingTable()
                                    outString &= "<tr><td colspan='2' align='center'><font class='" & Session("FONT_CLASS_HEADER") & " subHeader'>" & detail_type & "&nbsp;</font></td></tr>"
                                    outString += "<tr><td align=""left"" valign=""top"" colspan=""2""><div class=""Box""><table width='" & pdf_html_width & "' align='center' class=""formatTable " & TableColor & " subtextNoMargin large noBoldUpper"">"
                                    last_detail_type = ""
                                    'outString += "<tr valign='top' class='" & Session("ROW_CLASS_BOTTOM") & "'><td>"
                                End If
                            End If
                        End If

                        If (last_detail_type.ToLower.Trim = SqlReader.Item("adet_data_name").ToString.ToLower.Trim) And (last_detail_section.ToLower.Trim = SqlReader.Item("adet_data_type").ToString.ToLower.Trim) Then
                            outString += "<font class='" & Session("FONT_CLASS_TEXT") & "'>;  " + Server.HtmlEncode(SqlReader.Item("adet_data_description").ToString.Trim) + "</font>"
                        Else
                            If Trim(last_detail_type) <> "" Then
                                outString += "</td></tr>"
                            End If
                            Counter_For_PDF = Counter_For_PDF + 1
                            outString += "<tr valign='top' class='" & Session("ROW_CLASS_BOTTOM") & "'><td " & IIf(ShowNewTemplate, "", "width='" & spacer_width & "'") & ">"

                            If Trim(detail_type) = "Additional Equipment" And SqlReader.Item("adet_data_name").ToString.Trim = "General" And SqlReader.Item("adet_data_type").ToString.Trim = "Addl Cockpit Equipment" Then
                                outString += "<font class='" & Session("FONT_CLASS_TEXT_TITLE") & "'>Cockpit: </font>"
                            ElseIf Trim(detail_type) = "Additional Equipment" And SqlReader.Item("adet_data_name").ToString.Trim = "General" And SqlReader.Item("adet_data_type").ToString.Trim = "Equipment" Then
                                outString += "<font class='" & Session("FONT_CLASS_TEXT_TITLE") & "'>Equipment: </font>"
                            ElseIf Trim(detail_type) = "Interior" And SqlReader.Item("adet_data_name").ToString.Trim = "Refreshment Equipment" Then
                                outString += "<font class='" & Session("FONT_CLASS_TEXT_TITLE") & "'>Refreshment: </font>"
                            ElseIf Trim(detail_type) = "Interior" And SqlReader.Item("adet_data_name").ToString.Trim = "Entertainment Equipment" Then
                                outString += "<font class='" & Session("FONT_CLASS_TEXT_TITLE") & "'>Entertainment: </font>"
                            Else
                                outString += "<font class='" & Session("FONT_CLASS_TEXT_TITLE") & "'>" & Replace(Replace(Replace(Replace(SqlReader.Item("adet_data_name").ToString.Trim, "Inspection", "Notes"), "Equip ", ""), "Equipment", ""), "Woodwork", "Wood") & ": </font>"
                            End If

                            outString += "</td><td>"
                            outString += "<font class='" & Session("FONT_CLASS_TEXT") & "'>" + Server.HtmlEncode(SqlReader.Item("adet_data_description").ToString.Trim) + "</font>"
                        End If

                        last_detail_type = SqlReader.Item("adet_data_name").ToString.Trim
                        If Not IsDBNull(SqlReader.Item("adet_data_type")) Then
                            last_detail_section = SqlReader.Item("adet_data_type").ToString.Trim
                        Else
                            last_detail_section = ""
                        End If

                    End If



                Loop

                outString &= "</td></tr>"
            ElseIf (LCase(detail_type) <> "maintenance") Or (LCase(detail_type) = "maintenance" And update_date = "" And done_by = "") Then
                outString &= "<tr><td colspan='2' align=""left""><font class='" & Session("FONT_CLASS_TEXT") & "'>No Details Reported.&nbsp;</font></td></tr>"
            End If


            outString &= "</table>"



        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_aircraft_details()" + ex.Message
        Finally

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

            SqlReader.Close()


        End Try

        Return outString

    End Function

    Public Function NEW_build_aircraft_basic_block(ByVal nAircraftID As Long, ByVal nAircraftJournalID As Long, ByRef htmlOutput As StringBuilder, ByRef ac_image1 As String, ByRef features_ac As String, ByRef in_done_by_and_rating As String, ByRef ex_done_by_and_rating As String, ByRef temp_moyear As String, ByRef temp_ex_moyear As String, ByRef AirframeStringAppend As String) As String

        Dim last_detail_type As String = ""
        Dim sQuery = New StringBuilder()
        Dim outString As String = ""

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader = Nothing
        Dim SqlException As SqlClient.SqlException = Nothing

        ' TEMP HOLD MSW - THESE FIELDS CURRENTLY SET VALUES BUT WONT DISPLAY
        Dim confidential As String = ""
        Dim times_date As String = ""
        Dim ex_date As String = ""
        Dim exclusive_flag As String = ""
        Dim airfram_tot_time As String = ""
        Dim asking_price As String = ""
        Dim asking_type As String = ""
        Dim ac_status As String = ""
        Dim deliveryAC As String = ""
        Dim cycles As String = ""
        Dim last_updated As String = ""
        Dim days_on_market As String = ""
        Dim list_date As String = ""
        Dim prev_owned As String = ""
        Dim damage_history As String = ""
        Dim airportInfo As String = ""
        Dim ac_status_text As String = ""
        Dim dom_info As String = ""
        Dim temp_feat As String = ""
        Dim arrStdFeatCodes(,) As String = Nothing
        Dim iMaxFCodes As Integer = 0
        Dim strDamageYN As String = ""
        Dim temp_amod As Long = 0
        Dim tcomp As String = ""
        Dim passengerCount As Long = 0
        Dim configName As String = ""
        'Dim appendAirframeTable As String = ""


        Try



            sQuery.Append("SELECT * FROM Aircraft WITH(NOLOCK) INNER JOIN Aircraft_Model WITH(NOLOCK) ON ac_amod_id = amod_id left outer join Aircraft_Useage on ac_use_code = acuse_code ")
            If nAircraftJournalID_Full > 0 Then
                sQuery.Append(" inner join journal on journ_id = ac_journ_id ")
            End If
            sQuery.Append(" WHERE ac_journ_id = " & nAircraftJournalID_Full & " AND ac_id = " + nAircraftID.ToString)

            SqlConn.ConnectionString = localFunctions.clientConnectStr
            SqlConn.Open()
            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString
            SqlReader = SqlCommand.ExecuteReader()

            If SqlReader.HasRows Then

                SqlReader.Read()


                If bWordReport = True Then
                    htmlOutput.Append("<table width='" & word_width & "' align='center'>")
                Else
                    htmlOutput.Append("<table width='" & pdf_html_width & "' align='center' class=""formatTable large " & TableColor & " subtextNoMargin"">")
                End If

                If Not IsDBNull(SqlReader.Item("ac_mfr_year")) Then
                    temp_amod = SqlReader.Item("ac_amod_id")
                End If



                Counter_For_PDF = Counter_For_PDF + 1
                htmlOutput.Append("<tr class=""noBorder""><td colspan='2'><font class='" & Session("FONT_CLASS_HEADER") & " subHeader'>Identification</font></td></tr>")

                If Not IsDBNull(SqlReader.Item("ac_confidential_notes")) Then
                    If Not String.IsNullOrEmpty(SqlReader.Item("ac_confidential_notes").ToString.Trim) Then
                        confidential &= comp_functions.create_value_with_label("Note", SqlReader.Item("ac_confidential_notes").ToString.Trim, True, True, Counter_For_PDF, spacer_width)
                    End If
                End If

                '' make
                'If Not IsDBNull(SqlReader.Item("amod_make_name")) Then
                '  htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='" & Session("FONT_CLASS_TEXT_TITLE") & "'>Model: </font><font class='" & Session("FONT_CLASS_TEXT") & "'>")
                '  htmlOutput.Append(SqlReader.Item("amod_make_name").ToString + "&nbsp;")
                'End If

                '' model
                'If Not IsDBNull(SqlReader.Item("amod_model_name")) Then
                '  htmlOutput.Append(SqlReader.Item("amod_model_name") + "</font></td></tr>")
                'ElseIf Not IsDBNull(SqlReader.Item("amod_make_name")) Then
                '  htmlOutput.Append("</td></tr>")
                'End If

                ' year of manufacture
                If Not IsDBNull(SqlReader.Item("ac_mfr_year")) And Not IsDBNull(SqlReader.Item("ac_year")) Then
                    ac_year_display = SqlReader.Item("ac_year")
                    htmlOutput.Append(comp_functions.create_value_with_label("Year Mfr/Dlv", SqlReader.Item("ac_mfr_year").ToString & " / " + SqlReader.Item("ac_year").ToString, True, True, Counter_For_PDF, spacer_width))
                ElseIf Not IsDBNull(SqlReader.Item("ac_mfr_year")) Then
                    htmlOutput.Append(comp_functions.create_value_with_label("Year Mfr", SqlReader.Item("ac_mfr_year").ToString, True, True, Counter_For_PDF, spacer_width))
                ElseIf Not IsDBNull(SqlReader.Item("ac_year")) Then
                    ac_year_display = SqlReader.Item("ac_year")
                    htmlOutput.Append(comp_functions.create_value_with_label("Year Dlv", SqlReader.Item("ac_year").ToString, True, True, Counter_For_PDF, spacer_width))
                End If



                If Not chkBlindReport.Checked Then
                    '' serial number
                    'If Not IsDBNull(SqlReader.Item("ac_ser_no_full")) Then
                    '  htmlOutput.Append("<tr><td width='2%'>&nbsp;</td><td nowrap='nowrap'><font class='" & Session("FONT_CLASS_TEXT_TITLE") & "'>Serial #: </font><font class='" & Session("FONT_CLASS_TEXT") & "'>" + SqlReader.Item("ac_ser_no_full").ToString + "</font></td></tr>")
                    'End If

                    ' reg number
                    If Not IsDBNull(SqlReader.Item("ac_reg_no")) Then

                        If Not IsDBNull(SqlReader.Item("ac_reg_no_expiration_date")) Then
                            htmlOutput.Append(comp_functions.create_value_with_label("Registration #", SqlReader.Item("ac_reg_no").ToString & ", Expires: " + SqlReader.Item("ac_reg_no_expiration_date") & IIf(Not IsDBNull(SqlReader.Item("ac_prev_reg_no")), ". Previous Registration #" & SqlReader.Item("ac_prev_reg_no"), ""), True, True, Counter_For_PDF, spacer_width))
                        Else
                            htmlOutput.Append(comp_functions.create_value_with_label("Registration #", SqlReader.Item("ac_reg_no").ToString & IIf(Not IsDBNull(SqlReader.Item("ac_prev_reg_no")), ". Previous Registration #" & SqlReader.Item("ac_prev_reg_no"), ""), True, True, Counter_For_PDF, spacer_width))
                        End If
                    End If

                    If Not bAerodexFlag Then
                        ' airframe total time
                        If Not IsDBNull(SqlReader.Item("ac_purchase_date")) Then
                            htmlOutput.Append(comp_functions.create_value_with_label("Purchase Date", FormatDateTime(SqlReader.Item("ac_purchase_date"), DateFormat.ShortDate), True, True, Counter_For_PDF, spacer_width))
                        End If
                    End If
                Else
                    htmlOutput.Append(comp_functions.create_value_with_label("Aircraft ID", SqlReader.Item("ac_id").ToString, True, True, Counter_For_PDF, spacer_width))
                End If

                If Not IsDBNull(SqlReader.Item("ac_airframe_tot_hrs")) Then
                    airfram_tot_time = comp_functions.create_value_with_label("", FormatNumber(SqlReader.Item("ac_airframe_tot_hrs"), 0), False, False, Counter_For_PDF, spacer_width)
                End If
                ' landing cycles
                If Not IsDBNull(SqlReader.Item("ac_airframe_tot_landings")) Then
                    cycles = comp_functions.create_value_with_label("Landings/Cycles", FormatNumber(SqlReader.Item("ac_airframe_tot_landings"), 0), True, True, Counter_For_PDF, spacer_width)
                End If

                Dim faa_temp_table As New DataTable
                Dim flight_data_temp As New flightDataFunctions
                flight_data_temp.serverConnectStr = Session.Item("jetnetClientDatabase")
                flight_data_temp.clientConnectStr = Session.Item("jetnetServerNotesDatabase")

                faa_temp_table = flight_data_temp.getAllFAAFlightData(SqlReader.Item("ac_reg_no").ToString, SqlReader.Item("ac_id").ToString, SqlReader.Item("ac_times_as_of_date").ToString)

                AirframeStringAppend += "<table width='" & pdf_html_width & "' align='center' class=""formatTable large " & TableColor & " subtextNoMargin"">"
                AirframeStringAppend += "<tr class=""noBorder""><td colspan=""2"" class=""airframeTable"">" & Replace(flight_data_temp.displayAirframeTimesData(faa_temp_table, SqlReader.Item("ac_times_as_of_date").ToString, SqlReader.Item("ac_airframe_tot_hrs").ToString, SqlReader.Item("ac_airframe_tot_landings").ToString, True, SqlReader.Item("ac_previously_owned_flag").ToString.ToUpper, IIf(Not IsDBNull(SqlReader.Item("ac_purchase_date")), SqlReader.Item("ac_purchase_date"), ""), IIf(Not IsDBNull(SqlReader.Item("ac_year")), IIf(IsNumeric(SqlReader.Item("ac_year")), SqlReader.Item("ac_year"), 0), 0), True), "border=""1""", "border=""0""") & "</td></tr></table>"



                If Not bAerodexFlag Then
                    If chkShowAsking.Checked = True Then

                        If Not IsDBNull(SqlReader.Item("ac_foreign_currency_price")) Then

                            asking_price = comp_functions.create_value_with_label("Asking Amt (" + SqlReader.Item("ac_foreign_currency_name").ToString & "):", FormatCurrency(CDbl(SqlReader.Item("ac_foreign_currency_price").ToString), 0), True, True, Counter_For_PDF, spacer_width)

                        End If

                        If Not IsDBNull(SqlReader.Item("ac_status")) Then
                            ac_status = SqlReader.Item("ac_status").ToString.ToUpper
                            If ac_status.ToUpper.Contains("FOR SALE/TRADE") And SqlReader.Item("ac_asking").ToString.ToUpper.Contains("SALE/TRADE") Then
                                ac_status = ""
                            Else
                                ac_status = "<font class='" & Session("FONT_CLASS_TEXT_TITLE") & "'>Status: </font>"
                                ac_status_text = UCase(SqlReader.Item("ac_status").ToString)
                            End If
                        End If

                        If Not IsDBNull(SqlReader.Item("ac_delivery")) And Not String.IsNullOrEmpty(SqlReader.Item("ac_delivery").ToString) Then
                            If SqlReader.Item("ac_delivery").ToString.ToLower.Contains("date") Then
                                If Not IsDBNull(SqlReader.Item("ac_delivery_date")) And Not String.IsNullOrEmpty(SqlReader.Item("ac_delivery_date").ToString) Then
                                    deliveryAC = " " & FormatDateTime(SqlReader.Item("ac_delivery_date").ToString, DateFormat.ShortDate)
                                End If
                            Else
                                deliveryAC = " " & UCase(SqlReader.Item("ac_delivery").ToString)
                            End If
                        End If

                        If Not IsDBNull(SqlReader.Item("ac_asking")) Then

                            asking_type = ""
                            asking_type += UCase(SqlReader.Item("ac_asking").ToString)

                            If (SqlReader.Item("ac_asking").ToString.ToUpper.Contains("PRICE")) Then

                                If Not IsDBNull(SqlReader.Item("ac_asking_price")) Then
                                    asking_price = Trim(asking_price)

                                    asking_price += ", ASKING: "
                                    If Not String.IsNullOrEmpty(addToAsking.Text) And IsNumeric(addToAsking.Text) Then
                                        asking_price += FormatCurrency(((CDbl(SqlReader.Item("ac_asking_price").ToString) + CDbl(addToAsking.Text)) / 1000), 0) & "k"
                                    Else
                                        asking_price += FormatCurrency((CDbl(SqlReader.Item("ac_asking_price").ToString) / 1000), 0) & "k"
                                    End If
                                End If

                                asking_type = ""
                            End If

                        Else

                            If Not IsDBNull(SqlReader.Item("ac_asking_price")) Then
                                asking_price += Trim(asking_price)
                                asking_price += ", ASKING: "
                                If Not String.IsNullOrEmpty(addToAsking.Text) And IsNumeric(addToAsking.Text) Then
                                    asking_price += FormatCurrency(((CDbl(SqlReader.Item("ac_asking_price").ToString) + CDbl(addToAsking.Text)) / 1000), 0) & "k"
                                Else
                                    asking_price += FormatCurrency((CDbl(SqlReader.Item("ac_asking_price").ToString) / 1000), 0) & "k"
                                End If
                            End If

                        End If
                    End If
                End If


                'If Not IsDBNull(SqlReader.Item("ac_list_date")) And Not String.IsNullOrEmpty(SqlReader.Item("ac_list_date").ToString) Then
                '  dom_info = comp_functions.create_value_with_label("Days On Market", DateDiff("d", CDate(SqlReader.Item("ac_list_date").ToString.Trim), Today()).ToString, True, True)
                'End If


                ' THIS IS FOR INTERIOR SECTION ------ 
                If Not IsDBNull(SqlReader.Item("ac_interior_moyear")) Then
                    If SqlReader.Item("ac_interior_moyear").ToString.Trim.Length > 0 Then
                        If SqlReader.Item("ac_interior_moyear").ToString.Length > 4 Then
                            temp_moyear = SqlReader.Item("ac_interior_moyear").ToString
                            If temp_moyear.ToString.Length = 5 Then
                                temp_moyear = Left(temp_moyear, 1) + "/" + Right(temp_moyear, 4)
                            Else
                                If temp_moyear.ToString.Length = 6 Then
                                    temp_moyear = Left(temp_moyear, 2) + "/" + Right(temp_moyear, 4)
                                End If
                            End If

                            If Left(Trim(temp_moyear), 1) = "/" Then
                                temp_moyear = Right(Trim(temp_moyear), Len(Trim(temp_moyear)) - 1)
                            End If


                            last_updated = " (" & comp_functions.create_value_with_label("Updated", temp_moyear, False, False, Counter_For_PDF, spacer_width) & ")"
                        Else
                            last_updated = " (" & comp_functions.create_value_with_label("Updated", SqlReader.Item("ac_interior_moyear").ToString, False, False, Counter_For_PDF, spacer_width) & ")"
                        End If
                    End If
                End If



                If Not IsDBNull(SqlReader.Item("ac_interior_doneby_name")) Then
                    If Trim(temp_moyear) <> "" Then
                        If ShowNewTemplate Then
                            in_done_by_and_rating = "<strong>BY " & SqlReader.Item("ac_interior_doneby_name").ToString & " on " & Trim(temp_moyear) & "</strong>"
                        Else
                            in_done_by_and_rating = in_done_by_and_rating & comp_functions.create_value_with_label("Last Done", SqlReader.Item("ac_interior_doneby_name").ToString & " on " & Trim(temp_moyear), True, True, Counter_For_PDF, spacer_width)
                        End If
                    Else
                        If ShowNewTemplate Then
                            in_done_by_and_rating = "<strong>BY " & SqlReader.Item("ac_interior_doneby_name").ToString & "</strong>"
                        Else
                            in_done_by_and_rating = in_done_by_and_rating & comp_functions.create_value_with_label("Last Done", SqlReader.Item("ac_interior_doneby_name").ToString, True, True, Counter_For_PDF, spacer_width)
                        End If
                    End If

                ElseIf Trim(temp_moyear) <> "" Then
                    If ShowNewTemplate Then
                        in_done_by_and_rating = "<strong>DONE ON " & Trim(temp_moyear) & "</strong>"
                    Else
                        in_done_by_and_rating = in_done_by_and_rating & comp_functions.create_value_with_label("Last Done", Trim(temp_moyear), True, True, Counter_For_PDF, spacer_width)
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("ac_interior_rating")) Then
                    in_done_by_and_rating = in_done_by_and_rating & comp_functions.create_value_with_label("Rating", SqlReader.Item("ac_interior_rating").ToString, True, True, Counter_For_PDF, spacer_width)
                End If
                If Not IsDBNull(SqlReader.Item("ac_passenger_count")) Then
                    passengerCount = SqlReader.Item("ac_passenger_count")
                End If

                If Not IsDBNull(SqlReader.Item("ac_interior_config_name")) And Not String.IsNullOrEmpty(SqlReader.Item("ac_interior_config_name").ToString) Then
                    configName = SqlReader.Item("ac_interior_config_name")
                    'in_done_by_and_rating = in_done_by_and_rating & comp_functions.create_value_with_label("Configuration", SqlReader.Item("ac_interior_config_name").ToString.Trim, True, True, Counter_For_PDF, spacer_width)
                End If

                If passengerCount > 0 Or configName <> "" Then
                    If (configName <> "" And passengerCount > 0) Then
                        in_done_by_and_rating = in_done_by_and_rating & comp_functions.create_value_with_label("Configuration/PAX", configName & "/" & passengerCount.ToString & " passengers", True, True, Counter_For_PDF, spacer_width)
                    ElseIf configName <> "" Then
                        in_done_by_and_rating = in_done_by_and_rating & comp_functions.create_value_with_label("Configuration", configName, True, True, Counter_For_PDF, spacer_width)
                    ElseIf passengerCount > 0 Then
                        in_done_by_and_rating = in_done_by_and_rating & comp_functions.create_value_with_label("PAX", passengerCount.ToString & " passengers", True, True, Counter_For_PDF, spacer_width)
                    End If
                End If





                ' THIS IS FOR INTERIOR SECTION ------ TP.Checked Or PP.Checked Or SP.Checked

                If Not bAerodexFlag Then
                    If chkBlindReport.Checked Or chkEB.Checked Then 'if its blind, or exlcue broker then dont show
                    Else
                        If Not IsDBNull(SqlReader.Item("ac_exclusive_flag")) Then
                            If (SqlReader.Item("ac_exclusive_flag").ToString.ToUpper = "Y") Then
                                tcomp = ""
                                tcomp = commonEvo.GetExclusiveBrokerCompany(nAircraftID, 0)
                                If Trim(tcomp) <> "" Then
                                    exclusive_flag = comp_functions.create_value_with_label("On Exclusive", "With " & tcomp, True, True, Counter_For_PDF, spacer_width)
                                Else
                                    exclusive_flag = comp_functions.create_value_with_label("On Exclusive", "", True, True, Counter_For_PDF, spacer_width)
                                End If
                            End If
                        End If
                    End If
                End If


                'AclsData_Temp = New clsData_Manager_SQL
                'AclsData_Temp.JETNET_DB = Session.Item("jetnetClientDatabase")
                'AclsData_Temp.client_DB = Session.Item("jetnetServerNotesDatabase")

                tcomp = ""
                tcomp = CommonAircraftFunctions.GetExclusive(nAircraftID, CLng(SqlReader.Item("ac_journ_id").ToString), Master.aclsData_Temp, "JETNET", False)
                If Trim(tcomp) <> "" Then
                    Dim d_exclusiveDate As String = CommonAircraftFunctions.GetExclusiveDate(CLng(nAircraftID), CLng(SqlReader.Item("ac_journ_id").ToString), Master.aclsData_Temp)
                    If chkBlindReport.Checked Or chkEB.Checked Then
                    Else
                        If Not String.IsNullOrEmpty(d_exclusiveDate) Then
                            exclusive_flag = comp_functions.create_value_with_label("On Exclusive", CommonAircraftFunctions.GetExclusive(nAircraftID, CLng(SqlReader.Item("ac_journ_id").ToString), Master.aclsData_Temp, "JETNET", False) + "</em> as of " & d_exclusiveDate, True, True, Counter_For_PDF, spacer_width)
                        Else
                            exclusive_flag = comp_functions.create_value_with_label("On Exclusive", "With " & tcomp, True, True, Counter_For_PDF, spacer_width)
                        End If
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("ac_list_date")) Then

                    days_on_market = ""
                    If nAircraftJournalID_Full > 0 Then
                        days_on_market = DateDiff("d", CDate(SqlReader.Item("ac_list_date").ToString), SqlReader.Item("journ_date").ToString).ToString
                    Else
                        days_on_market = DateDiff("d", CDate(SqlReader.Item("ac_list_date").ToString), Now()).ToString
                    End If

                    If Trim(days_on_market) <> "" Then
                        list_date = comp_functions.create_value_with_label("Listed On", FormatDateTime(SqlReader.Item("ac_list_date").ToString, DateFormat.ShortDate) & " Days on Market (" & days_on_market & ")", True, True, Counter_For_PDF, spacer_width)
                    Else
                        list_date = comp_functions.create_value_with_label("Listed On", FormatDateTime(SqlReader.Item("ac_list_date").ToString, DateFormat.ShortDate) & " Days on Market (" & days_on_market & ")", True, True, Counter_For_PDF, spacer_width)
                    End If

                End If


                If Not IsDBNull(SqlReader.Item("ac_exterior_moyear")) Then
                    If SqlReader.Item("ac_exterior_moyear").ToString.Trim.Length > 0 Then
                        'If SqlReader.Item("ac_exterior_moyear").ToString.Trim.Length > 4 Then
                        temp_ex_moyear = SqlReader.Item("ac_exterior_moyear").ToString
                        If temp_ex_moyear.Trim.Length = 5 Then
                            temp_ex_moyear = Left(temp_ex_moyear, 1) + "/" + Right(temp_ex_moyear, 4)
                        Else
                            If temp_ex_moyear.Trim.Length = 6 Then
                                temp_ex_moyear = Left(temp_ex_moyear, 2) + "/" + Right(temp_ex_moyear, 4)
                            End If
                        End If

                        If Left(Trim(temp_ex_moyear), 1) = "/" Then
                            temp_ex_moyear = Right(Trim(temp_ex_moyear), Len(Trim(temp_ex_moyear)) - 1)
                        End If

                        ' ex_date = " (" & comp_functions.create_value_with_label("Updated", temp_ex_moyear, False, False) & ")</td>"
                        'Else
                        '   temp_ex_moyear = " (" & comp_functions.create_value_with_label("Updated", SqlReader.Item("ac_exterior_moyear").ToString, False, False) & ""
                        ' End If
                    End If
                End If



                If Not IsDBNull(SqlReader.Item("ac_exterior_doneby_name")) Then
                    If Trim(temp_ex_moyear) <> "" Then
                        If ShowNewTemplate Then
                            ex_done_by_and_rating = " <strong>BY " & SqlReader.Item("ac_exterior_doneby_name").ToString & " on " & Trim(temp_ex_moyear) & "</strong>"
                        Else
                            ex_done_by_and_rating = ex_done_by_and_rating & comp_functions.create_value_with_label("Last Done", SqlReader.Item("ac_exterior_doneby_name").ToString & " on " & Trim(temp_ex_moyear), True, True, Counter_For_PDF, spacer_width)
                        End If
                    Else
                        If ShowNewTemplate Then
                            ex_done_by_and_rating = " <strong>BY " & SqlReader.Item("ac_exterior_doneby_name").ToString & "</strong>"
                        Else
                            ex_done_by_and_rating = ex_done_by_and_rating & comp_functions.create_value_with_label("Last Done", SqlReader.Item("ac_exterior_doneby_name").ToString, True, True, Counter_For_PDF, spacer_width)
                        End If
                    End If
                ElseIf Trim(temp_ex_moyear) <> "" Then
                    If ShowNewTemplate Then
                        ex_done_by_and_rating = "<strong>DONE ON " & Trim(temp_ex_moyear) & "</strong>"
                    Else
                        ex_done_by_and_rating = ex_done_by_and_rating & comp_functions.create_value_with_label("Last Done", Trim(temp_ex_moyear), True, True, Counter_For_PDF, spacer_width)
                    End If

                End If




                If Not IsDBNull(SqlReader.Item("ac_exterior_rating")) Then
                    ex_done_by_and_rating = ex_done_by_and_rating & comp_functions.create_value_with_label("Rating", SqlReader.Item("ac_exterior_rating").ToString, True, True, Counter_For_PDF, spacer_width)
                End If


                If Not IsDBNull(SqlReader.Item("ac_previously_owned_flag")) Then
                    If Trim(SqlReader.Item("ac_previously_owned_flag")) = "Y" Then
                        prev_owned = comp_functions.create_value_with_label("New/Used", "Previously Owned", True, True, Counter_For_PDF, spacer_width)
                    ElseIf Trim(SqlReader.Item("ac_previously_owned_flag")) = "N" Then
                        prev_owned = comp_functions.create_value_with_label("New/Used", "Not Previously Owned", True, True, Counter_For_PDF, spacer_width)
                    End If
                End If

                If Not IsDBNull(SqlReader.Item("ac_times_as_of_date")) Then
                    times_date = "<font class='" & Session("FONT_CLASS_TEXT") & "'>(As of " + FormatDateTime(SqlReader.Item("ac_times_as_of_date").ToString, DateFormat.ShortDate).ToString + ")</font>"
                End If

                'SECTION 2  - AIRCRAFT INFO  -----------------------------------------------------------------------------------------------------------------------------------
                Try
                    airportInfo = NEW_build_full_spec_airport_information(SqlReader)
                Catch ex As Exception

                End Try

                If Trim(airportInfo) <> "" Then
                    Counter_For_PDF = Counter_For_PDF + 1
                    htmlOutput.Append(airportInfo)
                End If

                Counter_For_PDF = Counter_For_PDF
                If Not bAerodexFlag Then

                    '  If (SqlReader.Item("ac_forsale_flag").ToString.ToUpper = "Y") Then
                    Counter_For_PDF = Counter_For_PDF + 2

                    If bWordReport = True Then
                        htmlOutput.Append("</table></div><div class=""Box""><table width='" & word_width & "' align='center'>")
                    Else
                        htmlOutput.Append("</table></div><div class=""Box""><table width='" & pdf_html_width & "' align='center' class=""formatTable large " & TableColor & " subtextNoMargin"">")
                    End If
                    htmlOutput.Append("<tr class=""noBorder""><td colspan='2'><font class='" & Session("FONT_CLASS_HEADER") & " subHeader'>STATUS  <strong class=""" & IIf(SqlReader.Item("ac_forsale_flag").ToString.ToUpper = "Y", "greenText", "") & """>" & ac_status_text & " " & asking_type & asking_price & deliveryAC & "</strong></font></td></tr>")

                    'htmlOutput.Append("<tr valign='top' class=""" & Session("ROW_CLASS_BOTTOM") & """><td align='left'>")
                    'htmlOutput.Append("</td><td align='left'>")
                    If Not IsDBNull(SqlReader.Item("ac_ownership_type")) Then
                        htmlOutput.Append(comp_functions.create_value_with_label("Ownership", CommonAircraftFunctions.GetOwnershipType(SqlReader.Item("ac_ownership_type"), Master.aclsData_Temp) & IIf(SqlReader.Item("ac_previously_owned_flag").ToString.ToUpper = "Y", " / Previously Owned", " / Not Previously Owned"), True, False, Counter_For_PDF, spacer_width))
                    Else
                        htmlOutput.Append(comp_functions.create_value_with_label("Ownership", IIf(SqlReader.Item("ac_previously_owned_flag").ToString.ToUpper = "Y", " / Previously Owned", " / Not Previously Owned"), True, False, Counter_For_PDF, spacer_width))
                    End If
                    If Not IsDBNull(SqlReader.Item("ac_lifecycle_stage")) Then
                        htmlOutput.Append(comp_functions.create_value_with_label("Lifecycle/Use", CommonAircraftFunctions.GetLifeCycleStage(SqlReader.Item("ac_lifecycle_stage"), Master.aclsData_Temp) & IIf(Not IsDBNull(SqlReader.Item("acuse_name")), " / " & SqlReader.Item("acuse_name"), ""), True, False, Counter_For_PDF, spacer_width))
                    End If
                    ' htmlOutput.Append(ac_status & " ")
                    'htmlOutput.Append(asking_type)
                    'htmlOutput.Append(asking_price)
                    'htmlOutput.Append("</td></tr>")

                    htmlOutput.Append(list_date)
                    'htmlOutput.Append(dom_info)

                    If Trim(confidential) <> "" Then
                        htmlOutput.Append(confidential)
                        Counter_For_PDF = Counter_For_PDF + 1
                    End If

                    If Trim(exclusive_flag) <> "" Then
                        htmlOutput.Append(exclusive_flag)
                        Counter_For_PDF = Counter_For_PDF + 1
                    End If
                    'htmlOutput.Append("</table>")

                    'End If
                End If

                'If (Not String.IsNullOrEmpty(airfram_tot_time) Or Not String.IsNullOrEmpty(cycles)) Then
                '  '  htmlOutput.Append("<tr><td height='5'></td></tr>")
                '  '  htmlOutput.Append("<tr><td colspan='2' width='100%' class='" & Session("FONT_CLASS_TEXT_TITLE") & "'>Usage</font>&nbsp;</td></tr>")
                '  Counter_For_PDF = Counter_For_PDF + 1
                '  htmlOutput.Append("<tr valign='top' class='" & Session("ROW_CLASS_BOTTOM") & "'><td align='left'><font class='" & Session("FONT_CLASS_TEXT_TITLE") & "'>Airframe Time:</font></td><td>")
                '  htmlOutput.Append(airfram_tot_time & "<font class='" & Session("FONT_CLASS_TEXT") & "'>hrs ")
                '  htmlOutput.Append(times_date)
                '  htmlOutput.Append("</font></td></tr>")


                '  If Trim(cycles) <> "" Then
                '    htmlOutput.Append(cycles)
                '    Counter_For_PDF = Counter_For_PDF + 1
                '  End If


                '  If Trim(prev_owned) <> "" Then
                '    htmlOutput.Append(prev_owned)
                '    Counter_For_PDF = Counter_For_PDF + 1
                '  End If
                'End If

            End If



            SqlReader.Close()



            'If appendAirframeTable <> "" Then
            '  htmlOutput.Append(appendAirframeTable)
            'End If

            If chkIncludeKeyFeatures.Checked = True Then
                ' features_ac = (NEW_build_full_spec_aircraft_features(nAircraftID, SqlCommand, SqlReader, damage_history))
                Dim featureString As String = ""
                Dim featureCounter As Integer = 0
                temp_feat = Trim(features_text.Text)
                Dim featArray As ArrayList = New ArrayList()
                featArray.AddRange(Split(temp_feat, vbLf))

                For Each i As String In featArray
                    If i <> "" Then
                        If featureCounter = 2 And featArray.Count > 9 Then
                            featureCounter = 0
                            featureString += "</tr><tr>"
                        ElseIf featArray.Count < 10 Then
                            featureString += "</tr><tr>"
                        End If
                        featureCounter += 1
                        featureString += "<td width=""50%"">" + i & "</td>"
                    End If
                Next

                temp_feat = featureString
                'if it is invisisle, we have multiple ac, so must go get  

                If Trim(temp_feat) = "" And features_text.Visible = False And chkIncludeKeyFeatures.Checked = True Then
                    temp_feat = (build_full_spec_aircraft_features(nAircraftID, SqlCommand, SqlReader, 54))
                End If


                If Trim(temp_feat) <> "" Then
                    If check_cover.Checked = True Then
                        If ShowNewTemplate = True Then
                            temp_feat = temp_feat
                        Else
                            temp_feat = Replace(temp_feat, vbLf, "<br />" + vbCrLf)
                        End If

                        If bWordReport = True Then
                            features_ac &= ("<div class=""Box""><table width='" & word_width & "' align='center'>")
                        Else
                            features_ac &= ("<div class=""Box""><table width='" & pdf_html_width & "' align='center' class=""formatTable large " & TableColor & " subtextNoMargin"">")
                        End If


                        features_ac &= ("<tr class=""noBorder""><td valign='middle' align='center' colspan='2' class=""left""><font class='" & Session("FONT_CLASS_HEADER") & " subHeader'>Features/Highlights</font></td></tr>")
                        If ShowNewTemplate Then
                            features_ac += temp_feat
                        Else
                            features_ac &= ("<tr>")
                            features_ac &= ("<td valign='middle' align='center' class=""left""><font class='" & Session("FONT_CLASS_TEXT") & "'>" & temp_feat & "</font></td></tr>")
                        End If



                        features_ac &= ("</table></div>")
                    Else
                        temp_feat = Replace(temp_feat, vbLf, "; ") '
                        If Right(Trim(temp_feat), 1) = ";" Then
                            temp_feat = Left(Trim(temp_feat), Len(Trim(temp_feat)) - 1)
                        End If
                        features_ac = comp_functions.create_value_with_label("Features/Highlights", temp_feat, True, True, Counter_For_PDF, spacer_width)
                    End If
                End If
            End If

            If check_cover.Checked = False Then ' if no cover with pictures, then show the features
                htmlOutput.Append(features_ac)
            End If

            htmlOutput.Append("</table>")

            Counter_For_PDF = Counter_For_PDF

            If Chk_ALLPIC.Checked = True Then
                ac_image1 = (NEW_build_full_spec_first_picture(nAircraftID)) ', SqlCommand, SqlReader))
            End If




        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in NEW_build_aircraft_basic_block()" + ex.Message
        Finally

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

            SqlReader.Close()


        End Try

        Return outString

    End Function



    Public Function BuildOnlyFeaturesIfChecked() As String
        Dim features_ac As String = ""
        If chkIncludeKeyFeatures.Checked = True Then
            Dim temp_feat As String = ""
            Dim featureString As String = ""
            Dim featureCounter As Integer = 0
            temp_feat = Trim(features_text.Text)
            Dim featArray As ArrayList = New ArrayList()
            featArray.AddRange(Split(temp_feat, vbLf))

            For Each i As String In featArray
                If i <> "" Then
                    If featureCounter = 2 And featArray.Count > 9 Then
                        featureCounter = 0
                        featureString += "</tr><tr>"
                    ElseIf featArray.Count < 10 Then
                        featureString += "</tr><tr>"
                    End If
                    featureCounter += 1
                    featureString += "<td width=""50%"">" + i & "</td>"
                End If
            Next

            temp_feat = featureString


            If Trim(temp_feat) <> "" Then
                If check_cover.Checked = True Then
                    If ShowNewTemplate = True Then
                        temp_feat = temp_feat
                    Else
                        temp_feat = Replace(temp_feat, vbLf, "<br />" + vbCrLf)
                    End If

                    If bWordReport = True Then
                        features_ac &= ("<div class=""Box""><table width='" & word_width & "' align='center'>")
                    Else
                        features_ac &= ("<div class=""Box""><table width='" & pdf_html_width & "' align='center' class=""formatTable large " & TableColor & " subtextNoMargin"">")
                    End If


                    features_ac &= ("<tr class=""noBorder""><td valign='middle' align='center' colspan='2' class=""left""><font class='" & Session("FONT_CLASS_HEADER") & " subHeader'>Features/Highlights</font></td></tr>")
                    If ShowNewTemplate Then
                        features_ac += temp_feat
                    Else
                        features_ac &= ("<tr>")
                        features_ac &= ("<td valign='middle' align='center' class=""left""><font class='" & Session("FONT_CLASS_TEXT") & "'>" & temp_feat & "</font></td></tr>")
                    End If



                    features_ac &= ("</table></div>")
                Else
                    temp_feat = Replace(temp_feat, vbLf, "; ") '
                    If Right(Trim(temp_feat), 1) = ";" Then
                        temp_feat = Left(Trim(temp_feat), Len(Trim(temp_feat)) - 1)
                    End If
                    features_ac = comp_functions.create_value_with_label("Features/Highlights", temp_feat, True, True, Counter_For_PDF, spacer_width)
                End If
            End If
        End If
        Return features_ac
    End Function
    Public Function NEW_build_full_spec_aircraft_avionics(ByVal nAircraftID As Long, ByVal nAircraftJournalID As Long, ByRef avionicsCount As Integer) As String

        Dim sQuery = New StringBuilder()
        Dim outString As String = ""

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader = Nothing
        Dim SqlException As SqlClient.SqlException = Nothing
        Dim last_detail_type As String = ""

        Try

            ' Start Avionics    
            sQuery.Append("SELECT * FROM Aircraft_Avionics WITH(NOLOCK) WHERE av_ac_id = " + nAircraftID.ToString + " AND av_ac_journ_id = " + nAircraftJournalID.ToString)
            SqlConn.ConnectionString = localFunctions.clientConnectStr
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString
            SqlReader = SqlCommand.ExecuteReader()


            If bWordReport = True Then
                outString = ("<table width='" & word_width & "' align='center'>")
            Else
                outString = ("<table width='" & pdf_html_width & "' align='center' class=""formatTable large " & TableColor & " subtextNoMargin"">")
            End If

            outString += NEW_Build_Spacer_Row()
            outString += "<tr class=""noBorder""><td colspan='2'><font class='" & Session("FONT_CLASS_HEADER") & " subHeader'>Avionics</font></td></tr>"


            If SqlReader.HasRows Then

                Do While SqlReader.Read
                    ' outString += comp_functions.create_value_with_label(SqlReader.Item("av_name").ToString.Trim, SqlReader.Item("av_description").ToString.Trim, True, True)
                    avionicsCount += 1

                    If Not IsDBNull(SqlReader.Item("av_name")) Then



                        If last_detail_type.ToLower.Trim = SqlReader.Item("av_name").ToString.ToLower.Trim Then
                            outString += "<font class='" & Session("FONT_CLASS_TEXT") & "'>;  " + Server.HtmlEncode(SqlReader.Item("av_description").ToString.Trim) + "</font>"
                        Else
                            If Trim(last_detail_type) <> "" Then
                                outString += "</td></tr>"
                            End If
                            Counter_For_PDF = Counter_For_PDF + 1
                            outString += "<tr valign='top' class='" & Session("ROW_CLASS_BOTTOM") & "'><td " & IIf(spacer_width = "", "nowrap", "width='" & spacer_width & "'") & ">"

                            outString += "<font class='" & Session("FONT_CLASS_TEXT_TITLE") & "'>" + SqlReader.Item("av_name").ToString.Trim + ": </font>"

                            outString += "</td><td>"
                            outString += "<font class='" & Session("FONT_CLASS_TEXT") & "'>" + Server.HtmlEncode(SqlReader.Item("av_description").ToString.Trim) + "</font>"
                        End If

                        last_detail_type = SqlReader.Item("av_name").ToString.Trim

                    End If
                Loop
            Else
                outString += "<tr><td colspan='2'><font class='" & Session("FONT_CLASS_TEXT") & "'>No Details Reported.</font></td></tr>"
            End If

            outString += "</table>"

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_aircraft_avionics()" + ex.Message
        Finally

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

            SqlReader.Close()


        End Try

        Return outString

    End Function

    Public Function NEW_build_full_spec_aircraft_features(ByVal nAircraftID As Long, ByRef SqlCommand As SqlClient.SqlCommand, ByRef SQLReader As SqlClient.SqlDataReader, ByRef damage_history As String) As String

        Dim htmlOutput As New StringBuilder()
        Dim type_damage As String = ""

        Dim sQuery As New StringBuilder()

        Try

            sQuery.Append("SELECT Aircraft_Key_Feature.afeat_status_flag, Key_Feature.kfeat_name FROM Aircraft_Key_Feature INNER JOIN Key_Feature ON Aircraft_Key_Feature.afeat_feature_code = Key_Feature.kfeat_code ")
            sQuery.Append("WHERE (Aircraft_Key_Feature.afeat_ac_id = " + nAircraftID.ToString + ") AND (Aircraft_Key_Feature.afeat_journ_id = " & nAircraftJournalID_Full & ") ")
            sQuery.Append(" ORDER BY Aircraft_Key_Feature.afeat_seq_no")

            SqlCommand.CommandText = sQuery.ToString
            SQLReader = SqlCommand.ExecuteReader()

            If SQLReader.HasRows Then


                If bWordReport = True Then
                    htmlOutput.Append("<table width='" & word_width & "' align='center'>")
                Else
                    htmlOutput.Append("<table width='" & pdf_html_width & "' align='center'>")
                End If

                htmlOutput.Append("<tr><td valign='middle' align='center' colspan='2'><font class='" & Session("FONT_CLASS_HEADER") & "'>Features/Highlights</font></td></tr>")
                damage_history = ""

                Do While SQLReader.Read
                    'ADDED MSW - 3/15/16 - 
                    If SQLReader.Item("afeat_status_flag").ToString = "Y" Then
                        If SQLReader.Item("kfeat_name").ToString = "Damage History" Then
                            damage_history = comp_functions.create_value_with_label("Damage History", "Y", True, True, Counter_For_PDF, spacer_width)
                        Else
                            htmlOutput.Append("<tr>") ' <td valign='middle' align='left' width='2%'>&#10003;</td>
                            htmlOutput.Append("<td valign='middle' align='center'><font class='" & Session("FONT_CLASS_TEXT") & "'>" & SQLReader.Item("kfeat_name").ToString.Trim & type_damage & "</font></td></tr>")
                            feat_string &= SQLReader.Item("kfeat_name").ToString.Trim & vbCrLf
                        End If
                    End If
                Loop

                htmlOutput.Append("</table>")

            End If

            SQLReader.Close()

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_aircraft_features()" + ex.Message
        End Try

        Return htmlOutput.ToString

    End Function


    Public Function NEW_build_full_spec_airport_information(ByRef SQLReader As SqlClient.SqlDataReader) As String

        Dim htmlOutput As String = ""
        Dim temp_string As String = ""

        Try

            If chkIncludeBaseLocation.Checked Then

                If Not IsNothing(SQLReader) And SQLReader.HasRows Then

                    If Not IsDBNull(SQLReader.Item("ac_aport_iata_code")) Then
                        temp_string += SQLReader.Item("ac_aport_iata_code").ToString.Trim
                    End If

                    If Not IsDBNull(SQLReader.Item("ac_aport_icao_code")) Then
                        If temp_string <> "" Then
                            temp_string += " - "
                        End If
                        temp_string += SQLReader.Item("ac_aport_icao_code").ToString.Trim
                    End If

                    If Not IsDBNull(SQLReader.Item("ac_aport_name")) Then
                        If temp_string <> "" Then
                            temp_string += " - "
                        End If
                        temp_string += SQLReader.Item("ac_aport_name").ToString.Trim
                    End If

                    If Not IsDBNull(SQLReader.Item("ac_aport_city")) Then
                        If temp_string <> "" Then
                            temp_string += ", "
                        End If
                        temp_string += SQLReader.Item("ac_aport_city").ToString.Trim
                    End If

                    If Not IsDBNull(SQLReader.Item("ac_aport_state")) Then
                        If temp_string <> "" Then
                            temp_string += " - "
                        End If
                        temp_string += SQLReader.Item("ac_aport_state").ToString.Trim
                    End If

                    If Not IsDBNull(SQLReader.Item("ac_aport_country")) Then
                        If temp_string <> "" Then
                            temp_string += " - "
                        End If
                        temp_string += SQLReader.Item("ac_aport_country").ToString.Trim
                    End If

                    htmlOutput = comp_functions.create_value_with_label("Location", temp_string, True, True, Counter_For_PDF, spacer_width)


                End If
            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_airport_information()" + ex.Message
        End Try

        Return htmlOutput

    End Function

    Public Function NEW_build_full_spec_first_picture(ByVal nAircraftID As Long) ', ByRef SqlCommand As SqlClient.SqlCommand, ByRef adoRSAircraft As SqlClient.SqlDataReader) As String
        'LAST SECTION  IN COL 1- PICTURE -----------------------------------------------------------------------------------------------------------------------------------
        Dim outString As String = ""
        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim adoRSAircraft As SqlClient.SqlDataReader = Nothing

        ' This is right side column, should start with an open table already in td
        Dim fAcpic_image_type As String = ""
        Dim fAcpic_id As Integer = 0
        Dim pic_seq_num As Integer = 0
        Dim something_shown As Boolean = False

        Dim full_image_path As String = ""

        Dim fApicSubject As String = ""
        Dim pic_size As Integer = 310
        Dim pic_height_size As Integer = 850 ' was 310
        Dim pic_width As Integer = 610
        Dim desired_width As Integer = 950

        If bWordReport Then
            desired_width = word_width - 200
        End If

        Dim imgDisplayFolder As String = ""

        If HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then

            If Not Application.Item("crmClientSiteData").crmClientHostName.ToString.ToUpper.Contains("NEWEVONET") Then
                imgDisplayFolder = "https://www.testjetnetevolution.com/" + HttpContext.Current.Session.Item("AircraftPicturesFolderVirtualPath")
            Else
                imgDisplayFolder = "http://www.jetnetevolution.com/" + HttpContext.Current.Session.Item("AircraftPicturesFolderVirtualPath")
            End If

        Else
            imgDisplayFolder = Application.Item("crmClientSiteData").ClientFullHostName.ToString.Trim + HttpContext.Current.Session.Item("AircraftPicturesFolderVirtualPath")
        End If

        Dim imgFileName As String = ""
        Dim htmlOutput As String = ""
        Dim div_by As Double = 0
        Dim Query As String : Query = ""

        Dim ac_image_file As String = ""
        Dim temp_height As Integer = 0
        Dim temp_width As Integer = 0
        Dim zimage2 As System.Drawing.Image

        Dim temp_percent1 As Double = 0.0
        Dim temp_percent2 As Double = 0.0


        Try

            ' start AC_Pic
            Query = "SELECT TOP 1 * FROM Aircraft_Pictures WITH(NOLOCK)"
            Query += " WHERE acpic_ac_id = " + nAircraftID.ToString
            Query += " AND acpic_journ_id = " & nAircraftJournalID_Full
            Query += " AND acpic_seq_no > 0"
            Query += " AND acpic_image_type = 'JPG'"
            Query += " AND acpic_hide_flag = 'N'"
            Query += " ORDER BY acpic_seq_no"


            SqlConn.ConnectionString = localFunctions.clientConnectStr
            SqlConn.Open()
            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = Query
            adoRSAircraft = SqlCommand.ExecuteReader()

            If adoRSAircraft.HasRows Then

                adoRSAircraft.Read()

                pic_seq_num = CInt(adoRSAircraft.Item("acpic_seq_no").ToString)

                If Not IsDBNull(adoRSAircraft("acpic_image_type")) Then
                    fAcpic_image_type = adoRSAircraft.Item("acpic_image_type").ToString.ToLower.Trim
                End If

                If Not IsDBNull(adoRSAircraft("acpic_id")) Then
                    fAcpic_id = adoRSAircraft.Item("acpic_id").ToString.Trim
                End If

                If Not (IsDBNull(adoRSAircraft("acpic_subject"))) Then
                    fApicSubject = adoRSAircraft.Item("acpic_subject").ToString.Trim
                End If

                imgFileName = nAircraftID.ToString + Constants.cHyphen + "0" + Constants.cHyphen + fAcpic_id.ToString + Constants.cDot + fAcpic_image_type.ToLower.Trim

                full_image_path = imgDisplayFolder.Trim + "/" + imgFileName.Trim

                ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
                ' setup the path for the pictures based on which site is running
                ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

                Try


                    ac_image_file = HttpContext.Current.Server.MapPath("pictures\aircraft\") & imgFileName
                    zimage2 = System.Drawing.Image.FromFile(ac_image_file)
                    temp_width = zimage2.Width
                    temp_height = zimage2.Height

                    ' if the image is wider then the desired image width, then shirnk down to size.
                    'if width > height, then shrink the width down 
                    If temp_width > temp_height Then
                        If temp_width > desired_width Then
                            temp_percent1 = CDbl(CDbl(desired_width) / CDbl(temp_width))
                            temp_width = CDbl(CDbl(temp_width) * CDbl(temp_percent1))
                            temp_height = CDbl(CDbl(temp_height) * CDbl(temp_percent1))
                        End If
                    ElseIf temp_height > temp_width Then
                        ' if taller than it is wide, then as long as not too wide, its ok till height check
                        If temp_width > desired_width Then
                            temp_percent1 = CDbl(CDbl(desired_width) / CDbl(temp_width))
                            temp_width = CDbl(CDbl(temp_width) * CDbl(temp_percent1))
                            temp_height = CDbl(CDbl(temp_height) * CDbl(temp_percent1))
                        End If
                    End If

                    ' make sure not too tall for a given page size
                    If temp_height > pic_height_size Then
                        temp_percent1 = CDbl(CDbl(pic_height_size) / CDbl(temp_height))
                        temp_width = CDbl(CDbl(temp_width) * CDbl(temp_percent1))
                        temp_height = CDbl(CDbl(temp_height) * CDbl(temp_percent1))
                    End If

                    If bWordReport Then
                        'If temp_width > 250 Then
                        '  temp_height = temp_height
                        '  temp_width = 250
                        'End If
                        outString += "<img Title='" + fApicSubject.Trim + "' alt='" + fApicSubject.Trim + "' src='" + full_image_path + "' width='" + temp_width.ToString + "' height='" + temp_height.ToString + "' /><br /><br />"
                    Else
                        outString += "<img Title='" + fApicSubject.Trim + "' alt='" + fApicSubject.Trim + "' src='" + full_image_path + "' width='" + temp_width.ToString + "'  /><br /><br />"
                    End If
                Catch ex As Exception

                    If bWordReport Then
                        pic_width = 250
                        pic_height_size = 250
                    End If

                    outString += "<img Title='" + fApicSubject.Trim + "' alt='" + fApicSubject.Trim + "' src='" + full_image_path + "' width='" + pic_width.ToString + "'  " & IIf(bWordReport, "height='" + pic_height_size.ToString + "'", "") & "  /><br /><br />"
                End Try

                something_shown = True

            End If



            If Not something_shown Then
                outString = "No Pictures Available"
            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_first_picture()" + ex.Message
        Finally
            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

            adoRSAircraft.Close()
        End Try

        Return outString

    End Function




    Public Function NEW_build_full_spec_next_pictures(ByVal nAircraftID As Long) As String
        'LAST SECTION  IN COL 1- PICTURE -----------------------------------------------------------------------------------------------------------------------------------
        Dim outString As String = ""

        ' This is right side column, should start with an open table already in td
        Dim imgDisplayFolder As String = ""

        If HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then

            If Not Application.Item("crmClientSiteData").crmClientHostName.ToString.ToUpper.Contains("NEWEVONET") Then
                imgDisplayFolder = "https://www.testjetnetevolution.com/" + HttpContext.Current.Session.Item("AircraftPicturesFolderVirtualPath")
            Else
                imgDisplayFolder = "http://www.jetnetevolution.com/" + HttpContext.Current.Session.Item("AircraftPicturesFolderVirtualPath")
            End If

        Else
            imgDisplayFolder = Application.Item("crmClientSiteData").ClientFullHostName.ToString.Trim + HttpContext.Current.Session.Item("AircraftPicturesFolderVirtualPath")
        End If

        Dim imgFileName As String = ""
        Dim fApicSubject As String = ""

        Dim fAcpic_image_type As String = ""
        Dim fAcpic_id As Integer = 0
        Dim pic_seq_num As Integer = 0
        Dim pic_size As Integer = 310

        Dim something_shown As Boolean = False
        Dim nCount As Integer = 0

        Dim sQuery = New StringBuilder()

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader = Nothing
        Dim SqlException As SqlClient.SqlException = Nothing

        Dim ac_image_file As String = ""
        Dim temp_height As Integer = 0
        Dim temp_width As Integer = 0
        Dim zimage2 As System.Drawing.Image
        Dim desired_width As Integer = 310
        Dim temp_percent1 As Double = 0.0
        Dim temp_percent2 As Double = 0.0

        Try

            ' start AC_Pic
            sQuery.Append("SELECT TOP 2 * FROM Aircraft_Pictures WITH(NOLOCK)")
            sQuery.Append(" WHERE acpic_ac_id = " + nAircraftID.ToString)
            sQuery.Append(" AND acpic_journ_id = 0")
            sQuery.Append(" AND acpic_seq_no > 0")
            sQuery.Append(" AND acpic_image_type = 'JPG'")
            sQuery.Append(" AND acpic_hide_flag = 'N'")
            sQuery.Append(" ORDER BY acpic_seq_no")

            SqlConn.ConnectionString = localFunctions.clientConnectStr
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString
            SqlReader = SqlCommand.ExecuteReader()

            If SqlReader.HasRows Then
                Do While SqlReader.Read()

                    If nCount > 0 Then

                        pic_seq_num = CInt(SqlReader.Item("acpic_seq_no").ToString)

                        If Not IsDBNull(SqlReader("acpic_image_type")) Then
                            fAcpic_image_type = SqlReader.Item("acpic_image_type").ToString.ToLower.Trim
                        End If

                        If Not IsDBNull(SqlReader("acpic_id")) Then
                            fAcpic_id = SqlReader.Item("acpic_id").ToString.Trim
                        End If

                        If Not (IsDBNull(SqlReader("acpic_subject"))) Then
                            fApicSubject = SqlReader.Item("acpic_subject").ToString.Trim
                        End If

                        imgFileName = nAircraftID.ToString + Constants.cHyphen + "0" + Constants.cHyphen + fAcpic_id.ToString + Constants.cDot + fAcpic_image_type.ToLower.Trim

                        If bWordReport Then
                            pic_size = 250
                        End If



                        Try

                            ac_image_file = HttpContext.Current.Server.MapPath("pictures\aircraft\") & imgFileName
                            zimage2 = System.Drawing.Image.FromFile(ac_image_file)
                            temp_width = zimage2.Width
                            temp_height = zimage2.Height

                            ' if the image is wider then the desired image width, then shirnk down to size.
                            If temp_width > desired_width Then
                                temp_percent1 = CDbl(CDbl(desired_width) / CDbl(temp_width))
                                temp_width = CDbl(CDbl(temp_width) * CDbl(temp_percent1))
                                temp_height = CDbl(CDbl(temp_height) * CDbl(temp_percent1))
                            End If

                            'assuming generally that a square is fine
                            If temp_height > temp_width Then
                                temp_percent1 = CDbl(CDbl(temp_width) / CDbl(temp_height))
                                temp_width = CDbl(CDbl(temp_width) * CDbl(temp_percent1))
                                temp_height = CDbl(CDbl(temp_height) * CDbl(temp_percent1))
                            End If

                            If bWordReport Then
                                outString += "<img Title='" + fApicSubject.Trim + "' alt='" + fApicSubject.Trim + "' src='" + imgDisplayFolder.Trim + "/" + imgFileName.Trim + "' width='" + temp_width.ToString + "' height='" + temp_height.ToString + "'  /><br /><br />"
                            Else
                                outString += "<img Title='" + fApicSubject.Trim + "' alt='" + fApicSubject.Trim + "' src='" + imgDisplayFolder.Trim + "/" + imgFileName.Trim + "' width='" + temp_width.ToString + "' /><br /><br />"
                            End If
                        Catch ex As Exception

                            outString += "<img Title='" + fApicSubject.Trim + "' alt='" + fApicSubject.Trim + "' src='" + imgDisplayFolder.Trim + "/" + imgFileName.Trim + "' width='" + pic_size.ToString + "' /><br /><br />"
                        End Try


                        something_shown = True

                    End If

                    nCount += 1

                Loop

            End If

            If Not something_shown Then
                outString = " No Pictures Available "
            End If

            SqlReader.Close()

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_next_pictures()" + ex.Message
        Finally

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

            SqlReader.Close()


        End Try

        Return outString

    End Function

    Public Function NEW_Build_Additional_Data(ByVal nAircraftID As Long, ByRef engine_info As String, ByRef apu_data As String, ByRef add_data As String, ByRef run_maint As Boolean) As String

        Dim htmlOutput As New StringBuilder

        Dim ac_maintained As String = ""
        Dim ac_airframe_maint_tracking_prog_AMTP As String = ""
        Dim ac_airframe_maintenance_prog_AMP As String = ""
        Dim cert_information As String = ""
        Dim en_overhaul As String = ""
        Dim hot_inspec As String = ""
        Dim dam_history As String = ""

        Dim sQuery = New StringBuilder()

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader = Nothing
        Dim SqlException As SqlClient.SqlException = Nothing
        Dim temp_maint As String = ""
        Dim temp_cert As String = ""

        Try

            sQuery.Append("SELECT * ")
            sQuery.Append(", (select top 1 emp_name from Engine_Maintenance_Program where ac_apu_maint_prog = emp_code)as ac_apu_maintance_program ")
            sQuery.Append(", replace(replace(replace(STUFF((select accert_name + ', ' as cc  FROM Aircraft_Certified WITH(NOLOCK) WHERE accert_ac_id = aircraft.ac_id and accert_ac_journ_id = aircraft.ac_journ_id FOR XML PATH('')),1,1,''), '<cc>', ''), '</cc>', ''), 'cc>', '')  as certifications ")
            sQuery.Append(" FROM aircraft INNER JOIN Aircraft_Model WITH(NOLOCK) ON ac_amod_id = amod_id ")
            sQuery.Append(" INNER JOIN Airframe_Maintenance_Program WITH(NOLOCK) ON ac_airframe_maintenance_prog_AMP = amp_id")
            sQuery.Append(" INNER JOIN Airframe_Maintenance_Tracking_Program WITH(NOLOCK) ON ac_airframe_maint_tracking_prog_AMTP = amtp_id")
            sQuery.Append(" LEFT OUTER JOIN Aircraft_Certified WITH(NOLOCK) ON accert_ac_id = " + nAircraftID.ToString + " AND accert_ac_journ_id = 0")
            sQuery.Append(" WHERE ac_id = " + nAircraftID.ToString + " AND ac_journ_id = " & nAircraftJournalID_Full & "")

            SqlConn.ConnectionString = localFunctions.clientConnectStr
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90



            SqlCommand.CommandText = sQuery.ToString
            SqlReader = SqlCommand.ExecuteReader()



            If SqlReader.HasRows Then

                SqlReader.Read()

                If run_maint = True Then

                    If Not IsDBNull(SqlReader.Item("ac_maintained")) Then
                        ac_maintained = ac_maintained & comp_functions.create_value_with_label("Maintained", SqlReader.Item("ac_maintained").ToString.Trim, True, True, Counter_For_PDF, spacer_width)
                    End If

                    If Not IsDBNull(SqlReader.Item("amp_program_name")) Then
                        ac_airframe_maintenance_prog_AMP = comp_functions.create_value_with_label("Airframe Maint Program", SqlReader.Item("amp_program_name").ToString.Trim, True, True, Counter_For_PDF, spacer_width)
                    End If

                    If Not IsDBNull(SqlReader.Item("amtp_program_name")) Then
                        ac_airframe_maint_tracking_prog_AMTP = comp_functions.create_value_with_label("Airframe Tracking Program", SqlReader.Item("amtp_program_name").ToString.Trim, True, True, Counter_For_PDF, spacer_width)
                    End If

                    If Not IsDBNull(SqlReader.Item("certifications")) Then
                        temp_cert = Left(Trim(SqlReader.Item("certifications").ToString.Trim), Len(Trim(SqlReader.Item("certifications").ToString.Trim)) - 1) ' get rid of last comma
                        cert_information = comp_functions.create_value_with_label("Certification(s)", temp_cert, True, True, Counter_For_PDF, spacer_width)
                    End If

                    If Not IsDBNull(SqlReader.Item("ac_maint_hots_by_name")) Then
                        hot_inspec = comp_functions.create_value_with_label("Hot Inspection By", SqlReader.Item("ac_maint_hots_by_name").ToString.Trim, True, True, Counter_For_PDF, spacer_width)
                    End If

                    If Not IsDBNull(SqlReader.Item("ac_maint_eoh_by_name")) Then
                        en_overhaul = comp_functions.create_value_with_label("Engine Overhaul By", SqlReader.Item("ac_maint_eoh_by_name").ToString.Trim, True, True, Counter_For_PDF, spacer_width)
                    End If

                    If Not IsDBNull(SqlReader.Item("ac_damage_history_notes")) Then
                        dam_history = comp_functions.create_value_with_label("Dam History Notes", SqlReader.Item("ac_damage_history_notes").ToString.Trim, True, True, Counter_For_PDF, spacer_width)
                    End If


                    '  htmlOutput.Append("<table>")
                    htmlOutput.Append(ac_maintained)
                    htmlOutput.Append(ac_airframe_maintenance_prog_AMP)
                    htmlOutput.Append(ac_airframe_maint_tracking_prog_AMTP)
                    htmlOutput.Append(cert_information)
                    htmlOutput.Append(hot_inspec)
                    htmlOutput.Append(en_overhaul)
                    htmlOutput.Append(dam_history)
                    '  htmlOutput.Append("</table>")
                End If
            End If

            If run_maint = True Then
                add_data = htmlOutput.ToString
            Else
                engine_info = NEW_build_full_spec_engine_info(SqlReader)
                apu_data = NEW_build_full_spec_aircraft_apu(SqlReader)
            End If


        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_second_page()" + ex.Message
        Finally

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

            SqlReader.Close()


        End Try

        Return htmlOutput.ToString

    End Function

    Public Function NEW_build_full_spec_engine_info(ByRef SqlReader As SqlClient.SqlDataReader) As String

        Dim xLoop As Integer = 0
        Dim nloopCount As Integer = 0

        Dim sAircraftType As String = ""
        Dim sAirframeType As String = ""
        Dim htmlOutput As String = ""
        Dim type_damage As String = ""

        Dim Query As String : Query = ""

        Dim SqlReader2 As SqlClient.SqlDataReader = Nothing
        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing
        Dim temp_ser_string As String = ""
        Dim temp_ttsn_string As String = ""
        Dim temp_since_over_string As String = ""
        Dim temp_since_hot_string As String = ""
        Dim temp_time_between_string As String = ""
        Dim temp_tot_cycles_string As String = ""
        Dim temp_tot_cycles_over_string As String = ""
        Dim temp_tot_cycles_since_hot_string As String = ""
        Dim temp_start As String = ""

        Try

            If bWordReport = True Then
                htmlOutput += ("<table width='" & word_width & "' align='center'>")
            Else
                htmlOutput += ("<table width='" & pdf_html_width & "' cellpadding=""0"" cellspacing=""0"" align='center' class=""formatTable large " & TableColor & " subtextNoMargin"">")
            End If

            htmlOutput &= NEW_Build_Spacer_Row()
            Counter_For_PDF = Counter_For_PDF + 1
            htmlOutput += "<tr class=""noBorder""><td colspan='2'><font class='" & Session("FONT_CLASS_HEADER") & "  subHeader'>Engine(s)</font></td></tr>"

            If Not IsNothing(SqlReader) And SqlReader.HasRows Then

                If Not IsDBNull(SqlReader.Item("amod_airframe_type_code")) Then
                    sAirframeType = SqlReader.Item("amod_airframe_type_code").ToString.Trim.ToUpper
                End If
                If Not IsDBNull(SqlReader.Item("amod_type_code")) Then
                    sAircraftType = SqlReader.Item("amod_type_code").ToString.Trim.ToUpper
                End If

                Counter_For_PDF = Counter_For_PDF + 1


                htmlOutput = Replace(htmlOutput, "Engine(s)</font>", "Engine(s) MODEL: " & SqlReader.Item("ac_engine_name").ToString.Trim & "</font>")
                ' htmlOutput += comp_functions.create_value_with_label("Model", SqlReader.Item("ac_engine_name").ToString.Trim, True, True, Counter_For_PDF, spacer_width)

                If Not IsDBNull(SqlReader.Item("ac_engine_tbo_oc_flag")) Then
                    If SqlReader.Item("ac_engine_tbo_oc_flag").ToString.Trim.ToUpper.Contains("Y") Then
                        htmlOutput += comp_functions.create_value_with_label("On&nbsp;Condition&nbsp;TBO", "Yes", True, True, Counter_For_PDF, spacer_width)
                    Else
                        htmlOutput += comp_functions.create_value_with_label("On&nbsp;Condition&nbsp;TBO", "No", True, True, Counter_For_PDF, spacer_width)
                    End If
                End If

                Query = "SELECT emp_name, emp_provider_name, emp_program_name FROM Engine_Maintenance_Program WITH(NOLOCK)"
                Query = Query & " WHERE emp_id = " + SqlReader.Item("ac_engine_maintenance_prog_EMP").ToString.Trim

                SqlConn.ConnectionString = localFunctions.clientConnectStr
                SqlConn.Open()

                SqlCommand.Connection = SqlConn
                SqlCommand.CommandType = CommandType.Text
                SqlCommand.CommandTimeout = 90

                SqlCommand.CommandText = Query
                SqlReader2 = SqlCommand.ExecuteReader()

                If SqlReader2.HasRows Then
                    SqlReader2.Read()
                    htmlOutput += comp_functions.create_value_with_label("Maintenance&nbsp;Program", SqlReader2.Item("emp_provider_name").ToString.Trim + "&nbsp;-&nbsp;" + SqlReader2.Item("emp_program_name").ToString.Trim + "&nbsp;", True, True, Counter_For_PDF, spacer_width)
                End If

                SqlReader2.Close()


                If sAirframeType <> "R" Then
                    nloopCount = 4
                Else
                    nloopCount = 3
                End If

                For xLoop = 1 To nloopCount

                    Counter_For_PDF = Counter_For_PDF + 1

                    If (Not IsDBNull(SqlReader.Item("ac_engine_" + xLoop.ToString + "_tot_hrs")) Or
                        Not IsDBNull(SqlReader.Item("ac_engine_" + xLoop.ToString + "_soh_hrs")) Or
                        Not IsDBNull(SqlReader.Item("ac_engine_" + xLoop.ToString + "_shi_hrs")) Or
                        Not IsDBNull(SqlReader.Item("ac_engine_" + xLoop.ToString + "_tbo_hrs")) Or
                        Not IsDBNull(SqlReader.Item("ac_engine_" + xLoop.ToString + "_snew_cycles")) Or
                        Not IsDBNull(SqlReader.Item("ac_engine_" + xLoop.ToString + "_soh_cycles")) Or
                        Not IsDBNull(SqlReader.Item("ac_engine_" + xLoop.ToString + "_shs_cycles"))) Then



                        If xLoop = 1 And sAirframeType <> "R" Then
                            temp_start = "Eng&nbsp;" + xLoop.ToString + "&nbsp;(L):&nbsp;"
                        ElseIf xLoop = 2 And sAirframeType <> "R" Then
                            temp_start = "Eng&nbsp;" + xLoop.ToString + "&nbsp;(R):&nbsp;"
                        ElseIf xLoop = 3 And sAirframeType <> "R" Then
                            temp_start = "Eng&nbsp;" + xLoop.ToString + "&nbsp;(L):&nbsp;"
                        ElseIf xLoop = 4 And sAirframeType <> "R" Then
                            temp_start = "Eng&nbsp;" + xLoop.ToString + "&nbsp;(R):&nbsp;"
                        Else
                            temp_start = "Eng&nbsp;" + xLoop.ToString + ":&nbsp;"
                        End If


                        If Trim(temp_ser_string) <> "" Then
                            temp_ser_string &= " / "
                        End If
                        If Trim(SqlReader.Item("ac_engine_" + xLoop.ToString + "_ser_no").ToString) <> "" Then
                            temp_ser_string &= temp_start & "&nbsp;" + SqlReader.Item("ac_engine_" + xLoop.ToString + "_ser_no").ToString + ""
                        End If

                        If Trim(temp_ttsn_string) <> "" Then
                            temp_ttsn_string &= " / "
                        End If
                        If Not IsDBNull(SqlReader.Item("ac_engine_" + xLoop.ToString + "_tot_hrs")) Then
                            temp_ttsn_string &= temp_start & "" + FormatNumber(CDbl(SqlReader.Item("ac_engine_" + xLoop.ToString + "_tot_hrs").ToString), 0, True, False, True) + " hrs"
                        End If

                        If Trim(temp_since_over_string) <> "" Then
                            temp_since_over_string &= " / "
                        End If
                        If Not IsDBNull(SqlReader.Item("ac_engine_" + xLoop.ToString + "_soh_hrs")) Then
                            temp_since_over_string &= temp_start & "" + FormatNumber(CDbl(SqlReader.Item("ac_engine_" + xLoop.ToString + "_soh_hrs").ToString), 0, True, False, True) + " hrs"
                        End If

                        If Trim(temp_since_hot_string) <> "" Then
                            temp_since_hot_string &= " / "
                        End If
                        If Not IsDBNull(SqlReader.Item("ac_engine_" + xLoop.ToString + "_shi_hrs")) Then
                            temp_since_hot_string &= temp_start & "" + FormatNumber(CDbl(SqlReader.Item("ac_engine_" + xLoop.ToString + "_shi_hrs").ToString), 0, True, False, True) + " hrs"
                        End If

                        If Trim(temp_time_between_string) <> "" Then
                            temp_time_between_string &= " / "
                        End If
                        If Not IsDBNull(SqlReader.Item("ac_engine_" + xLoop.ToString + "_tbo_hrs")) Then
                            temp_time_between_string &= temp_start & "" + FormatNumber(CDbl(SqlReader.Item("ac_engine_" + xLoop.ToString + "_tbo_hrs").ToString), 0, True, False, True) + " hrs"
                        End If

                        If Trim(temp_tot_cycles_string) <> "" Then
                            temp_tot_cycles_string &= " / "
                        End If
                        If Not IsDBNull(SqlReader.Item("ac_engine_" + xLoop.ToString + "_snew_cycles")) Then
                            temp_tot_cycles_string &= temp_start & "" + FormatNumber(CDbl(SqlReader.Item("ac_engine_" + xLoop.ToString + "_snew_cycles").ToString), 0, True, False, True) + " hrs"
                        End If

                        If Trim(temp_tot_cycles_over_string) <> "" Then
                            temp_tot_cycles_over_string &= " / "
                        End If
                        If Not IsDBNull(SqlReader.Item("ac_engine_" + xLoop.ToString + "_soh_cycles")) Then
                            temp_tot_cycles_over_string &= temp_start & "" + FormatNumber(CDbl(SqlReader.Item("ac_engine_" + xLoop.ToString + "_soh_cycles").ToString), 0, True, False, True) + " hrs"
                        End If

                        If Trim(temp_tot_cycles_since_hot_string) <> "" Then
                            temp_tot_cycles_since_hot_string &= " / "
                        End If
                        If Not IsDBNull(SqlReader.Item("ac_engine_" + xLoop.ToString + "_shs_cycles")) Then
                            temp_tot_cycles_since_hot_string &= temp_start & "" + FormatNumber(CDbl(SqlReader.Item("ac_engine_" + xLoop.ToString + "_shs_cycles").ToString), 0, True, False, True) + " hrs"
                        End If

                    End If

                Next ' xLoop







                If Trim(temp_ser_string) <> "" Then
                    htmlOutput &= comp_functions.create_value_with_label("Ser No", temp_ser_string, True, True, Counter_For_PDF, spacer_width)
                End If

                If Trim(temp_ttsn_string) <> "" Then
                    htmlOutput &= comp_functions.create_value_with_label("Time Since New", temp_ttsn_string, True, True, Counter_For_PDF, spacer_width)
                End If

                If Trim(temp_since_over_string) <> "" Then
                    htmlOutput &= comp_functions.create_value_with_label("Since Overhaul", temp_since_over_string, True, True, Counter_For_PDF, spacer_width)
                End If

                If Trim(temp_since_hot_string) <> "" Then
                    htmlOutput &= comp_functions.create_value_with_label("Since Hot Inspection", temp_since_hot_string, True, True, Counter_For_PDF, spacer_width)
                End If

                If Trim(temp_time_between_string) <> "" Then
                    htmlOutput &= comp_functions.create_value_with_label("Time Between Overhaul", temp_time_between_string, True, True, Counter_For_PDF, spacer_width)
                End If

                If Trim(temp_tot_cycles_string) <> "" Then
                    htmlOutput &= comp_functions.create_value_with_label("Cycles Since New", temp_tot_cycles_string, True, True, Counter_For_PDF, spacer_width)
                End If

                If Trim(temp_tot_cycles_over_string) <> "" Then
                    htmlOutput &= comp_functions.create_value_with_label("Cycles Since Overhaul", temp_tot_cycles_over_string, True, True, Counter_For_PDF, spacer_width)
                End If

                If Trim(temp_tot_cycles_since_hot_string) <> "" Then
                    htmlOutput &= comp_functions.create_value_with_label("Cycles Since Hot", temp_tot_cycles_since_hot_string, True, True, Counter_For_PDF, spacer_width)
                End If

            Else


                htmlOutput += "<tr><td colspan='2' align=""left""><font class='" & Session("FONT_CLASS_TEXT") & "'>No Details Reported.</font></td></tr>" + vbCrLf
            End If
            htmlOutput += "</table>" + vbCrLf
        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_engine_info " + ex.Message
        Finally

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOutput

    End Function


    Public Function NEW_build_full_spec_aircraft_apu(ByRef SqlReader As SqlClient.SqlDataReader) As String

        Dim ac_apu_model_name As String = ""
        Dim ac_apu_tot_hrs As Integer
        Dim ac_apu_ser_no As String = ""
        Dim ac_apu_maintance_program As String = ""
        Dim showAPUTable As Boolean = False

        Dim outString As String = ""

        Try
            If bWordReport = True Then
                outString = ("<table width='" & word_width & "' align='center'>")
            Else
                outString = ("<table width='" & pdf_html_width & "' align='center' class=""formatTable large " & TableColor & " subtextNoMargin"">")
            End If

            outString &= NEW_Build_Spacer_Row()
            outString += "<tr class=""noBorder""><td colspan='2'><font class='" & Session("FONT_CLASS_HEADER") & " subHeader'>Auxiliary Power Unit (APU)</font></td></tr>"
            Counter_For_PDF = Counter_For_PDF + 1
            If Not IsNothing(SqlReader) And SqlReader.HasRows Then

                If Not IsDBNull(SqlReader.Item("ac_apu_model_name")) Then
                    ac_apu_model_name = SqlReader.Item("ac_apu_model_name").ToString.Trim
                    outString = Replace(outString, "(APU)</font>", "(APU) MODEL: " & SqlReader.Item("ac_apu_model_name").ToString.Trim & "</font>")
                Else
                    ac_apu_model_name = ""
                End If

                If Not IsDBNull(SqlReader.Item("ac_apu_tot_hrs")) Then
                    ac_apu_tot_hrs = CLng(SqlReader.Item("ac_apu_tot_hrs").ToString)
                Else
                    ac_apu_tot_hrs = 0
                End If

                If Not IsDBNull(SqlReader.Item("ac_apu_ser_no")) Then
                    ac_apu_ser_no = SqlReader.Item("ac_apu_ser_no").ToString.Trim
                Else
                    ac_apu_ser_no = ""
                End If

                If Not IsDBNull(SqlReader.Item("ac_apu_maintance_program")) Then
                    ac_apu_maintance_program = SqlReader.Item("ac_apu_maintance_program").ToString.Trim
                Else
                    ac_apu_maintance_program = ""
                End If



                If Not String.IsNullOrEmpty(ac_apu_model_name) Or ac_apu_tot_hrs > 0 Or Not String.IsNullOrEmpty(ac_apu_ser_no) Then


                    'If Not String.IsNullOrEmpty(ac_apu_model_name) Then
                    '  outString += comp_functions.create_value_with_label("Model", ac_apu_model_name, True, True, Counter_For_PDF, spacer_width)
                    '  showAPUTable = True
                    'End If

                    If Not String.IsNullOrEmpty(ac_apu_ser_no) Then
                        outString += comp_functions.create_value_with_label("Serial #", ac_apu_ser_no.Trim, True, True, Counter_For_PDF, spacer_width)
                        showAPUTable = True
                    End If

                    If Not String.IsNullOrEmpty(ac_apu_model_name) Then
                        If ac_apu_tot_hrs > 0 Then
                            outString += comp_functions.create_value_with_label("Time Since New", FormatNumber(ac_apu_tot_hrs, 0, True, False, True) & " hrs", True, True, Counter_For_PDF, spacer_width)
                            showAPUTable = True
                        End If
                    End If

                    If Not String.IsNullOrEmpty(ac_apu_model_name) Then
                        If Trim(ac_apu_maintance_program) <> "" Then
                            outString += comp_functions.create_value_with_label("Maintenance Plan", ac_apu_maintance_program, True, True, Counter_For_PDF, spacer_width)
                            showAPUTable = True
                        End If
                    End If


                End If

                If Not IsDBNull(SqlReader.Item("ac_apu_soh_hrs")) Then
                    outString += comp_functions.create_value_with_label("Since Overhaul (SOH)", FormatNumber(CDbl(SqlReader.Item("ac_apu_soh_hrs").ToString), 0, True, False, True) & " hrs", True, True, Counter_For_PDF, spacer_width)
                    showAPUTable = True
                End If


                If Not IsDBNull(SqlReader.Item("ac_apu_shi_hrs")) Then
                    outString += comp_functions.create_value_with_label("Since Hot Inspection (SHI)", FormatNumber(CDbl(SqlReader.Item("ac_apu_shi_hrs").ToString), 0, True, False, True) & " hrs", True, True, Counter_For_PDF, spacer_width)
                    showAPUTable = True
                End If
            End If
            If showAPUTable = False Then
                outString += "<tr><td colspan=""2"" align=""left""><font class='" & Session("FONT_CLASS_TEXT") & "'>No Details Reported.</font></td></tr>" + vbCrLf
            End If

            outString += "</table>"

            'If showAPUTable = True And ShowNewTemplate = True Then
            outString = "<div class=""Box"">" & outString & "</div>"
            'ElseIf showAPUTable = False And ShowNewTemplate = True Then
            '  outString = ""
            'End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_aircraft_apu()" + ex.Message
        End Try

        Return outString

    End Function


    Public Function NEW_build_full_spec_heli_details(ByVal nAircraftID As Long, ByVal nAircraftJournalID As Long)

        Dim Query As String = ""
        Dim htmlOutput As String = ""
        Dim bHasMainBlades As Boolean = False
        Dim bHasTailBlades As Boolean = False
        Dim sLabel As String = ""

        Dim SqlReader As SqlClient.SqlDataReader = Nothing
        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing

        Try

            Query = "SELECT * FROM Helicopter_Detail_Times WITH(NOLOCK) WHERE heldt_ac_id = " + nAircraftID.ToString
            Query = Query & " AND heldt_journ_id = " + nAircraftJournalID.ToString

            SqlConn.ConnectionString = localFunctions.clientConnectStr
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = Query
            SqlReader = SqlCommand.ExecuteReader()

            If SqlReader.HasRows Then

                If bWordReport = True Then
                    htmlOutput += ("<table width='" & word_width & "' align='center'>")
                Else
                    htmlOutput += ("<table width='" & pdf_html_width & "' align='center'>")
                End If

                htmlOutput += "<tr><td>&nbsp;</td></tr>"
                htmlOutput += "<tr>"
                htmlOutput += "<td valign='top'>"

                htmlOutput += "<table border='1' bordercolor='#949494' cellpadding='2' cellspacing='0' width=""100%""><tr>"
                htmlOutput += "<tr><th colspan='8'><font class='" & Session("FONT_CLASS_TEXT_TITLE") & "'>GEARBOX/ROTOR BLADE INFORMATION</font></td></tr>"
                htmlOutput += "<tr><td class='Normal'>&nbsp;</td><td class='Normal'>&nbsp;</td>"
                htmlOutput += "<th align='center'><font class='" & Session("FONT_CLASS_TEXT_TITLE") & "'>Serial Number</font></td>"
                htmlOutput += "<th align='center'><font class='" & Session("FONT_CLASS_TEXT_TITLE") & "'>TTSN:</font></td>"
                htmlOutput += "<th align='center'><font class='" & Session("FONT_CLASS_TEXT_TITLE") & "'>Time Remaining:</font></td>"
                htmlOutput += "<th align='center'><font class='" & Session("FONT_CLASS_TEXT_TITLE") & "'>TSOH:</font></td></tr>"

                Do While SqlReader.Read

                    If Not IsDBNull(SqlReader.Item("heldt_category_type")) And Not String.IsNullOrEmpty(SqlReader.Item("heldt_category_type").ToString.Trim) Then
                        Select Case SqlReader.Item("heldt_category_type").ToString.ToUpper.Trim
                            Case "INTERMEDIATE GEARBOX"
                                bHasMainBlades = False
                                bHasTailBlades = False
                                sLabel = "Intermediate&nbsp;Gearbox"
                            Case "MAIN ROTOR #1 BLADES", "MAIN ROTOR #2 BLADES"
                                ' Check for number of blades
                                sLabel = "Main&nbsp;Blade&nbsp;"
                                bHasMainBlades = True
                                bHasTailBlades = False
                                ' OK Get the Blade Number 1-10
                                sLabel = sLabel & Right(Trim(SqlReader.Item("heldt_subcat_type").ToString), 2)
                            Case "MAIN ROTOR HUB #1", "MAIN ROTOR HUB #2"
                                bHasMainBlades = False
                                bHasTailBlades = False
                                sLabel = "Main&nbsp;Rotor&nbsp;Hub"
                            Case "MAIN TRANSMISSION #1", "MAIN TRANSMISSION #2"
                                bHasMainBlades = False
                                bHasTailBlades = False
                                sLabel = "Main&nbsp;Transmission"
                            Case "TAIL ROTOR BLADES"
                                ' Check for number of blades
                                sLabel = "Tail&nbsp;Blade&nbsp;"
                                bHasMainBlades = False
                                bHasTailBlades = True
                                ' OK Get the Blade Number 1-10
                                sLabel = sLabel & Right(Trim(SqlReader.Item("heldt_subcat_type").ToString), 2)
                            Case "TAIL ROTOR GEARBOX"
                                bHasMainBlades = False
                                bHasTailBlades = False
                                sLabel = "Tail&nbsp;Rotor&nbsp;Gearbox"
                            Case "TAIL ROTOR HUB"
                                bHasMainBlades = False
                                bHasTailBlades = False
                                sLabel = "Tail&nbsp;Rotor&nbsp;Hub"
                        End Select
                    End If

                    If Not IsDBNull(SqlReader.Item("heldt_ttsn")) Or Not IsDBNull(SqlReader.Item("heldt_remaining_hours")) Or Not IsDBNull(SqlReader.Item("heldt_soh")) Then
                        htmlOutput += "<tr id='TR_Prop_Info'>" ' TR_Prop_Info
                        htmlOutput += "<td>&nbsp;</td>"
                        htmlOutput += "<th><font class='" & Session("FONT_CLASS_TEXT_TITLE") & "'>&nbsp;" + sLabel + "&nbsp;&nbsp;</td>"

                        If Not IsDBNull(SqlReader("heldt_ser_no_full")) Then
                            htmlOutput += "<td align='center' class='text_text'>" + SqlReader.Item("heldt_ser_no_full").ToString + "</td>"
                        Else
                            htmlOutput += "<td>&nbsp;</td>"
                        End If

                        If Not IsDBNull(SqlReader("heldt_ttsn")) Then
                            htmlOutput += "<td align='center' class='text_text'>" + FormatNumber(CDbl(SqlReader.Item("heldt_ttsn").ToString), 0, True, False, True) + "</td>"
                        Else
                            htmlOutput += "<td>&nbsp;</td>"
                        End If
                        If Not IsDBNull(SqlReader("heldt_remaining_hours")) Then
                            htmlOutput += "<td align='center' class='text_text'>" + FormatNumber(CDbl(SqlReader.Item("heldt_remaining_hours").ToString), 0, True, False, True) + "</td>"
                        Else
                            htmlOutput += "<td>&nbsp;</td>"
                        End If
                        If Not IsDBNull(SqlReader("heldt_soh")) And (Not bHasMainBlades Or Not bHasTailBlades) Then
                            htmlOutput += "<td align='center' class='text_text'>" + FormatNumber(CDbl(SqlReader.Item("heldt_soh").ToString), 0, True, False, True) + "</td></tr>"
                        Else
                            htmlOutput += "<td>&nbsp;</td>"
                        End If
                        htmlOutput += "</tr>"
                    End If

                Loop
                htmlOutput += "</table>" ' Prop_Information_Mini_Table

            End If

            SqlReader.Close()

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_heli_details " + ex.Message
        Finally

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

        Return htmlOutput

    End Function


    Public Function NEW_build_full_spec_aircraft_contacts(ByVal nAircraftID As Long, ByVal compID As Long) As String

        Dim ac_maintained As String = ""
        Dim column_color As String = "white"
        Dim contact_counter As Integer = 1
        Dim sub_counter As Integer = 1

        Dim sQuery = New StringBuilder()
        Dim outStringB As New StringBuilder

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader = Nothing
        Dim SqlException As SqlClient.SqlException = Nothing
        Dim Sql As String = ""
        Dim journalID As Long = 0
        Dim tempData As New DataTable
        Dim tempComp As New clsClient_Company
        Dim Contact_Class_Array As New ArrayList
        Dim company_one As Integer = 0
        Dim contact_one As Integer = 0
        Dim contact_display As String = ""
        Dim company_two As Integer = 0
        Dim contact_two As Integer = 0
        Dim tempContact As New DataTable
        Dim break_counter As Integer = 0
        Dim comp_out_header As String = ""

        Try

            If nAircraftID > 0 Then
                sQuery.Append("SELECT comp_id, actype_name, cref_owner_percent, contact_id, contact_sirname, contact_first_name, contact_middle_initial, contact_last_name, contact_suffix, contact_title, contact_email_address")
                sQuery.Append(" FROM aircraft_reference INNER JOIN company WITH(NOLOCK) ON cref_comp_id = comp_id and cref_journ_id = comp_journ_id")
                sQuery.Append(" INNER JOIN aircraft_contact_type WITH(NOLOCK) ON cref_contact_type = actype_code")
                sQuery.Append(" LEFT OUTER JOIN contact WITH(NOLOCK) ON cref_contact_id = contact_id AND cref_journ_id = contact_journ_id AND contact_hide_flag = 'N'")
                sQuery.Append(" WHERE cref_ac_id = " + nAircraftID.ToString + " and cref_journ_id = " & nAircraftJournalID_Full & " ")

                If bAerodexFlag Then
                    ' then dont include exclusive broker
                    sQuery.Append(" AND cref_contact_type <> '99'")
                Else
                    ' if eb isnt checked, dont include eb
                    If chkEB.Checked Then
                        sQuery.Append(" AND cref_contact_type <> '99'")
                    End If
                End If

                sQuery.Append(" AND cref_contact_type <> '71'")
                sQuery.Append(" ORDER BY cref_transmit_seq_no")
            ElseIf compID > 0 Then
                Sql = Sql & " SELECT DISTINCT Company_Reference.*, actype_name, actype_compref_internal_flag, actype_compref_twoway_flag, actype_compref_name2, compref_comp_id as comp_id, "
                ' Sql = Sql & " contact.*,  "

                '-- GET NUMBER OF AIRCRAFT FOR THIS COMPANY
                Sql = Sql & " case compref_rel_comp_id"
                Sql = Sql & " when " & compID & " then "
                Sql = Sql & " (select cac_fullsale_owner from Company_Aircraft_Count with (NOLOCK) "
                Sql = Sql & " where cac_comp_id = compref_comp_id and cac_product_type = 'B'"
                Sql = Sql & " and cac_journ_id = 0 )"
                Sql = Sql & " else "
                Sql = Sql & " (select cac_fullsale_owner from Company_Aircraft_Count with (NOLOCK) "
                Sql = Sql & " where cac_comp_id = compref_rel_comp_id and cac_product_type = 'B'"
                Sql = Sql & " and cac_journ_id = 0 )"
                Sql = Sql & " end as ac_count, "

                '-- GET NUMBER OF AIRCRAFT FOR THIS COMPANY
                Sql = Sql & " case compref_rel_comp_id"
                Sql = Sql & " when  " & compID & "  then "
                Sql = Sql & " (select cac_fullsale_owner from Company_Aircraft_Count with (NOLOCK) "
                Sql = Sql & " where cac_comp_id = compref_comp_id and cac_product_type = 'H'"
                Sql = Sql & " and cac_journ_id = " & journalID & " )"
                Sql = Sql & " else "
                Sql = Sql & " (select cac_fullsale_owner from Company_Aircraft_Count with (NOLOCK) "
                Sql = Sql & " where cac_comp_id = compref_rel_comp_id and cac_product_type = 'H'"
                Sql = Sql & " and cac_journ_id =  " & journalID & " )"
                Sql = Sql & " end as heli_count,"
                '-- GET NUMBER OF YACHTS FOR THIS COMPANY
                Sql = Sql & " case compref_rel_comp_id"
                Sql = Sql & " when  " & compID & "  then "
                Sql = Sql & " (select COUNT(*) from Yacht_Reference with (NOLOCK) where yr_comp_id = compref_comp_id"
                Sql = Sql & " and yr_journ_id =  " & journalID & " and yr_contact_type in ('00','08','97')) "
                Sql = Sql & " else "
                Sql = Sql & " (select COUNT(*) from Yacht_Reference with (NOLOCK) where yr_comp_id = compref_rel_comp_id"
                Sql = Sql & " and yr_journ_id =  " & journalID & " and yr_contact_type in ('00','08','97')) "
                Sql = Sql & " end as ytcount"


                Sql = Sql & " FROM Company_Reference WITH(NOLOCK)"
                Sql = Sql & " inner join Aircraft_Contact_Type WITH(NOLOCK) on actype_code = compref_contact_type"
                Sql = Sql & " Left Outer Join Aircraft_Reference WITH(NOLOCK) ON (compref_comp_id = cref_comp_id AND compref_journ_id = cref_journ_id) "
                'Sql = Sql & " LEFT OUTER JOIN contact WITH(NOLOCK) ON cref_contact_id = contact_id AND cref_journ_id = contact_journ_id AND contact_hide_flag = 'N'"
                Sql = Sql & " WHERE compref_journ_id = " & journalID
                Sql = Sql & " AND (compref_comp_id = " & compID & " OR compref_rel_comp_id = " & compID & " ) "
                Sql = Sql & " and compref_hide_flag = 'N' "
                Sql = Sql & " ORDER BY actype_compref_name2"
            End If


            SqlConn.ConnectionString = localFunctions.clientConnectStr
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            If nAircraftID > 0 Then
                SqlCommand.CommandText = sQuery.ToString
            ElseIf compID > 0 Then
                SqlCommand.CommandText = Sql
            End If

            SqlReader = SqlCommand.ExecuteReader()



            If nAircraftID > 0 Then
                If bWordReport = True Then
                    outStringB.Append("<table width='" & word_width & "' align='center'>")
                Else
                    outStringB.Append("<table width='" & pdf_html_width & "' align='center' class=""formatTable subtextNoMargin " & TableColor & " large contactTable"">")
                End If

                outStringB.Append("<tr class='" & Session("ROW_CLASS_BOTTOM") & "'><td colspan='2'><font class='" & Session("FONT_CLASS_HEADER") & " subHeader'>Company/Contacts</font></td></tr>")
            ElseIf compID > 0 Then
                If bWordReport = True Then
                    comp_out_header = ("<table width='" & word_width_new & "' align='center'>")
                Else
                    comp_out_header = ("<table width='" & pdf_html_width & "' align='center'>")
                End If
                comp_out_header += "<tr class='" & Session("ROW_CLASS_BOTTOM") & "'><td colspan='3'><font class='" & Session("FONT_CLASS_HEADER") & "'>Related Company/Contacts</font></td></tr>"
            End If



            If SqlReader.HasRows Then

                If compID > 0 Then
                    comp_out_header &= ("<tr valign='top' class='" & Session("ROW_CLASS_BOTTOM") & "'>")
                    comp_out_header &= ("<td width='20%' bgcolor='white' valign='top' align='left'><font class='" & Session("FONT_CLASS_TEXT_TITLE") & "'>Relationship</font></td>")
                    comp_out_header &= ("<td width='40%' bgcolor='white' valign='top' align='left'><font class='" & Session("FONT_CLASS_TEXT_TITLE") & "'>Company</font></td>")
                    comp_out_header &= ("<td width='40%' bgcolor='white' valign='top' align='left'><font class='" & Session("FONT_CLASS_TEXT_TITLE") & "'>Contact</font></td>")
                    comp_out_header &= ("</tr>")
                    outStringB.Append(comp_out_header)
                End If

                Do While SqlReader.Read

                    If compID > 0 Then

                        break_counter = break_counter + 1

                        ' do page break items 
                        If break_counter = 11 Then
                            outStringB.Append("</table></td></tr></table>")
                            outStringB.Append(comp_functions.NEW_Insert_Page_Break_PDF(Counter_For_PDF, reportType.SelectedValue))
                            outStringB.Append(comp_functions.NEW_build_full_spec_page_header(NEW_AC_ID, "", comp_address, comp_logo, 0, NEW_COMP_ID, bWordReport, word_width, pdf_html_width, check_prepared_for, chkBlindReport, prepared_for))
                            outStringB.Append(comp_out_header)
                            break_counter = 0
                        End If



                        If bWordReport Then
                            outStringB.Append("<tr valign='top' class='" & Session("ROW_CLASS_BOTTOM") & "'><td width='20%' height='700' bgcolor='white' valign='top'>")
                        Else
                            outStringB.Append("<tr valign='top' class='" & Session("ROW_CLASS_BOTTOM") & "'><td width='20%' bgcolor='white' valign='top'>")
                        End If


                        company_one = IIf(Not IsDBNull(SqlReader.Item("compref_rel_comp_id")), SqlReader.Item("compref_rel_comp_id"), 0)
                        contact_one = IIf(Not IsDBNull(SqlReader.Item("compref_rel_contact_id")), SqlReader.Item("compref_rel_contact_id"), 0)

                        company_two = IIf(Not IsDBNull(SqlReader.Item("compref_comp_id")), SqlReader.Item("compref_comp_id"), 0)

                        If company_one = compID Then
                            contact_one = IIf(Not IsDBNull(SqlReader.Item("compref_contact_id")), SqlReader.Item("compref_contact_id"), 0)
                        End If

                        contact_display = ""
                        If contact_one <> 0 Then
                            tempContact = Master.aclsData_Temp.GetContacts_Details(contact_one, "JETNET")
                            If Not IsNothing(tempContact) Then
                                If tempContact.Rows.Count > 0 Then
                                    Contact_Class_Array = clsGeneral.clsGeneral.Create_Array_Contact_Class(tempContact)
                                    For Each Con As clsClient_Contact In Contact_Class_Array
                                        contact_display = clsGeneral.clsGeneral.Show_Contact_Display(Con)
                                        contact_display = Replace(contact_display, "<br />", "</font><br /><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>")
                                    Next
                                End If
                            End If
                        End If

                        If company_one <> compID Then
                            tempData = Master.aclsData_Temp.GetCompanyInfo_ID(company_one, "JETNET", 0)
                            tempComp = clsGeneral.clsGeneral.Create_Company_Class(tempData, "JETNET", Nothing)
                            outStringB.Append("<font class='" & Session("FONT_CLASS_TEXT_TITLE") & "'>")
                            If Not IsDBNull(SqlReader.Item("actype_compref_name2")) Then
                                outStringB.Append(SqlReader.Item("actype_compref_name2").ToString.Trim & "<br />")
                            End If
                            outStringB.Append("&nbsp;</font></td><td width='40%' bgcolor='white' height='70' valign='top'>")
                            outStringB.Append("<font class='" & Session("FONT_CLASS_TEXT_TITLE") & "'>")
                            outStringB.Append(tempComp.clicomp_name)
                            outStringB.Append("<br /></font><font class='" & Session("FONT_CLASS_TEXT") & "'>")
                            outStringB.Append(clsGeneral.clsGeneral.Show_Company_Display(tempComp, False))

                        Else
                            tempData = Master.aclsData_Temp.GetCompanyInfo_ID(company_two, "JETNET", 0)
                            tempComp = clsGeneral.clsGeneral.Create_Company_Class(tempData, "JETNET", Nothing)
                            outStringB.Append("<font class='" & Session("FONT_CLASS_TEXT_TITLE") & "'>")
                            If Not IsDBNull(SqlReader.Item("actype_name")) Then
                                outStringB.Append(SqlReader.Item("actype_name").ToString.Trim & "<br />")
                            End If
                            outStringB.Append("&nbsp;</font></td><td width='40%' bgcolor='white' height='70' valign='top'>")
                            outStringB.Append("<font class='" & Session("FONT_CLASS_TEXT_TITLE") & "'>")

                            outStringB.Append(tempComp.clicomp_name)
                            outStringB.Append("<br /></font><font class='" & Session("FONT_CLASS_TEXT") & "'>")
                            outStringB.Append(clsGeneral.clsGeneral.Show_Company_Display(tempComp, False))
                            'return_string = return_string & "<td align='left' valign='top'><b>" & SqlReader.Item("actype_name") & "</b></td><td align='left' valign='top'><b><a href='details.aspx?comp_ID=" & company_two & "&source=JETNET&type=1'>"
                            'tempComp.clicomp_name & "</a></b><br />" &

                            'contact_display & "</td>"

                        End If


                        outStringB.Append("&nbsp;</font></td><td width='40%' bgcolor='white' height='70' valign='top'>")


                        outStringB.Append("<font class='" & Session("FONT_CLASS_TEXT_TITLE") & "'>")

                        If Trim(contact_display) <> "" Then
                            outStringB.Append(contact_display)
                        End If

                    End If


                    If nAircraftID > 0 Then

                        break_counter = break_counter + 1
                        If break_counter = 7 Then
                            outStringB.Append("</td></tr></table></td></tr></table></div><div class=""valueSpec viewValueExport Simplistic aircraftSpec"">")
                            outStringB.Append(comp_functions.NEW_build_full_spec_page_header(NEW_AC_ID, "", comp_address, comp_logo, 0, NEW_COMP_ID, bWordReport, word_width, pdf_html_width, check_prepared_for, chkBlindReport, prepared_for, Header_Company_Name, False))
                            outStringB.Append(CreateStartingTable())
                            outStringB.Append("<tr><td align=""left"" valign=""top""><div class=""Box"">")
                            If bWordReport = True Then
                                outStringB.Append("<table width='" & word_width & "' align='center'>")
                            Else
                                outStringB.Append("<table width='" & pdf_html_width & "' align='center' class=""formatTable subtextNoMargin " & TableColor & " large contactTable"">")
                            End If

                            break_counter = 0
                        End If

                        If (column_color = "white") Then
                            If bWordReport Then
                                outStringB.Append("<tr valign='top' class='" & Session("ROW_CLASS_BOTTOM") & "'><td width='50%' height='700' bgcolor='white' valign='top' style=""white-space: normal""><font class='" & Session("FONT_CLASS_TEXT_TITLE") & "'>")
                            Else
                                outStringB.Append("<tr valign='top' class='" & Session("ROW_CLASS_BOTTOM") & "'><td width='50%' bgcolor='white' valign='top' style=""white-space: normal""><font class='" & Session("FONT_CLASS_TEXT_TITLE") & "'><strong>")
                            End If
                        Else
                            If bWordReport Then
                                outStringB.Append("<tr valign='top' height='70' class='" & Session("ROW_CLASS_BOTTOM") & "'><td width='50%' height='700' style=""white-space: normal""><font class='" & Session("FONT_CLASS_TEXT_TITLE") & "'>")  'bgcolor='#E6E6E6'
                            Else
                                outStringB.Append("<tr valign='top' class='" & Session("ROW_CLASS_BOTTOM") & "'><td width='50%' style=""white-space: normal""><font class='" & Session("FONT_CLASS_TEXT_TITLE") & "'><strong>")  '  bgcolor='#E6E6E6'
                            End If
                        End If


                        If Not IsDBNull(SqlReader.Item("actype_name")) Then
                            outStringB.Append(SqlReader.Item("actype_name").ToString.Trim + " ")
                        End If


                        If Not IsDBNull(SqlReader.Item("cref_owner_percent")) Then
                            If CLng(SqlReader.Item("cref_owner_percent").ToString) > 0 And CLng(SqlReader.Item("cref_owner_percent").ToString) < 100 Then
                                outStringB.Append(" " + SqlReader.Item("cref_owner_percent").ToString.Trim + "% ")
                            End If
                        End If


                        outStringB.Append(" - " + Replace(commonEvo.get_company_info_fromID(CLng(SqlReader.Item("comp_id").ToString), nAircraftJournalID_Full, True, False, "", ""), "&nbsp;<br />", "</strong></font></font><br /><font class='" & Session("FONT_CLASS_TEXT") & "'>"))

                        If (column_color = "white") Then
                            If bWordReport Then
                                outStringB.Append("&nbsp;</font></td><td width='50%'valign='top' height='70'>") '  bgcolor='#E6E6E6' 
                            Else
                                outStringB.Append("&nbsp;</font></td><td width='50%'valign='top'>") '  bgcolor='#E6E6E6' 
                            End If

                            column_color = "other"
                        Else
                            If bWordReport Then
                                outStringB.Append("&nbsp;</font></td><td width='40%' bgcolor='white' height='70' valign='top'>")
                            Else
                                outStringB.Append("&nbsp;</font></td><td width='40%' bgcolor='white' valign='top'>")
                            End If
                            column_color = "white"
                        End If

                        outStringB.Append("<font class='" & Session("FONT_CLASS_TEXT_TITLE") & "'><strong>")

                        If Not IsDBNull(SqlReader.Item("contact_sirname")) Then
                            outStringB.Append(SqlReader.Item("contact_sirname").ToString.Trim + " ")
                        End If

                        If Not IsDBNull(SqlReader.Item("contact_first_name")) Then
                            outStringB.Append(SqlReader.Item("contact_first_name").ToString.Trim + " ")
                        End If

                        If Not IsDBNull(SqlReader.Item("contact_middle_initial")) Then
                            If Trim(SqlReader.Item("contact_middle_initial")) <> "" Then
                                outStringB.Append(SqlReader.Item("contact_middle_initial").ToString.Trim + ". ")
                            End If
                        End If

                        If Not IsDBNull(SqlReader.Item("contact_last_name")) Then
                            outStringB.Append(SqlReader.Item("contact_last_name").ToString.Trim + " ")
                        End If


                        If Not IsDBNull(SqlReader.Item("contact_suffix")) Then
                            outStringB.Append("" + SqlReader.Item("contact_suffix").ToString.Trim + "")
                        End If

                        outStringB.Append("</strong></font><font class='" & Session("FONT_CLASS_TEXT") & "'>")

                        If Not IsDBNull(SqlReader.Item("contact_title")) Then
                            outStringB.Append("<br />" + SqlReader.Item("contact_title").ToString.Trim + "<br />")
                        End If

                        If Not IsDBNull(SqlReader.Item("contact_email_address")) Then
                            outStringB.Append(SqlReader.Item("contact_email_address").ToString.Trim + "<br />")
                        End If

                        If Not IsDBNull(SqlReader.Item("comp_id")) And Not IsDBNull(SqlReader.Item("contact_id")) Then
                            outStringB.Append(build_full_spec_company_contact_phone(CLng(SqlReader.Item("comp_id").ToString), SqlReader.Item("contact_id")))
                        End If
                    End If



                    outStringB.Append("</font></td></tr>")

                    contact_counter = contact_counter + 1
                Loop

            End If

            'If bWordReport Then
            '  If contact_counter < 10 Then
            '    sub_counter = 10 - contact_counter
            '    Do While sub_counter > 0
            '      outString += "<tr><td height='70'>&nbsp;</td></tr>"
            '      sub_counter = sub_counter - 1
            '    Loop
            '  End If
            'End If

            outStringB.Append("</table>")

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in NEW_build_full_spec_aircraft_contacts()" + ex.Message
        Finally

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

            SqlReader.Close()


        End Try

        Return outStringB.ToString

    End Function


    Public Function NEW_build_full_spec_notes_page(ByVal nAircraftID As Long, ByVal nYachtID As Long) As String

        Dim sQuery = New StringBuilder()
        Dim outString As New StringBuilder()
        Dim something_shown As Boolean = False

        Dim notes_datatable As DataTable = Nothing
        Dim toggleRowColor As Boolean = False

        Try



            If bHasServerNotes And (nAircraftID > 0) Then 'If they're plus + notes users. 
                notes_datatable = localFunctions.get_all_server_notes(nAircraftID, nYachtID)
            ElseIf bHasStandardCloudNotes Then 'if they're standard cloud users
                notes_datatable = localFunctions.get_all_cloud_notes(nAircraftID, nYachtID)
            End If



            If bWordReport = True Then
                outString.Append("<table width='" & word_width & "' align='center'>")
            Else
                outString.Append("<table width='" & pdf_html_width & "' align='center' class=""formatTable large " & TableColor & " subtextNoMargin"">")
            End If


            If Not IsNothing(notes_datatable) Then

                If notes_datatable.Rows.Count > 0 Then

                    outString.Append("<tr class=""noBorder""><td colspan='2'><font class='" & Session("FONT_CLASS_HEADER") & " subHeader'>Notes</font></td></tr>")

                    For Each Row As DataRow In notes_datatable.Rows


                        outString.Append("<tr class='" & Session("ROW_CLASS_BOTTOM") & "' valign='top'><td width='2%'>&nbsp;</td>")

                        outString.Append("<td align='left' width='98%'><font class='" & Session("FONT_CLASS_TEXT") & "'>")

                        If Not IsDBNull(Row.Item("lnote_entry_date")) Then
                            If Not String.IsNullOrEmpty(Row.Item("lnote_entry_date").ToString.Trim) Then
                                outString.Append(FormatDateTime(Row.Item("lnote_entry_date").ToString, DateFormat.ShortDate))
                            End If
                        End If


                        If Not (IsDBNull(Row.Item("lnote_user_name"))) Then
                            If Not String.IsNullOrEmpty(Row.Item("lnote_user_name").ToString.Trim) Then
                                outString.Append(" - " + Row.Item("lnote_user_name").ToString.Trim)
                            End If
                        End If

                        outString.Append("</font>")

                        If Not IsDBNull(Row.Item("lnote_note")) Then
                            If Not String.IsNullOrEmpty(Row.Item("lnote_note").ToString.Trim) Then
                                outString.Append(" - <font class='" & Session("FONT_CLASS_TEXT") & "'>" + Row.Item("lnote_note").ToString.Trim + "</font>")
                            End If
                        End If

                        outString.Append("</td></tr>")

                    Next

                    something_shown = True

                End If

            End If

            If Not something_shown Then
                outString.Append("<tr><td valign='middle' align='center'><font  class='" & Session("FONT_CLASS_TEXT") & "'>No Notes Currently Available</font></td></tr>")
            End If

            outString.Append("</table>")


        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_notes_page()" + ex.Message

        End Try

        Return outString.ToString

        outString = Nothing

    End Function
    Public Function NEW_build_full_spec_transactions_page(ByVal nAircraftID As Long, ByVal nYachtID As Long) As String

        Dim sQuery = New StringBuilder()
        Dim outString As New StringBuilder()
        Dim something_shown As Boolean = False

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader = Nothing
        Dim SqlException As SqlClient.SqlException = Nothing
        Dim SqlDatatable As New DataTable

        Dim toggleRowColor As Boolean = False
        Dim sRowColor As String = ""
        Dim excludeONOFFmarket As String = ""
        Dim page_start As String = ""
        Dim page_break As Integer = 24
        Dim increment As Integer = 0
        Try

            If bWordReport = True Then
                page_break = 19
            Else
                page_break = 42
            End If

            If ShowNewTemplate = True Then
                page_break = 20
            End If
            If nAircraftID > 0 And nYachtID = 0 Then

                'ac history
                sQuery.Append("SELECT journ_id, journ_ac_id, journ_date, journ_subject, jcat_subcategory_name, jcat_auto_subject_flag, journ_subcategory_code, journ_customer_note")
                sQuery.Append(" FROM Journal WITH(NOLOCK) INNER JOIN Journal_Category WITH(NOLOCK) ON journ_subcategory_code = jcat_subcategory_code")
                sQuery.Append(" WHERE jcat_category_code = 'AH' AND RIGHT(journ_subcategory_code, 4) <> 'CORR'")

                If bAerodexFlag Then excludeONOFFmarket = ",'OM','MA'"

                sQuery.Append(" AND journ_subcategory_code NOT IN ('IN','DM','EXOFF','EXON'" + excludeONOFFmarket + ")")
                sQuery.Append(" AND journ_ac_id = " + nAircraftID.ToString)

                If nAircraftJournalID_Full > 0 Then
                    sQuery.Append(" AND journ_id = " + nAircraftJournalID_Full.ToString)
                End If

                sQuery.Append(" ORDER BY journ_date DESC, journ_id DESC")

            ElseIf nAircraftID = 0 And nYachtID > 0 Then

                ' yacht history
                sQuery.Append("SELECT journ_id, journ_ac_id, journ_date, journ_subject, jcat_subcategory_name, jcat_auto_subject_flag, journ_subcategory_code, journ_customer_note")
                sQuery.Append(" FROM Journal WITH(NOLOCK) INNER JOIN Journal_Category WITH(NOLOCK) ON journ_subcategory_code = jcat_subcategory_code")
                sQuery.Append(" WHERE jcat_category_code = 'AH' AND RIGHT(journ_subcategory_code, 4) <> 'CORR'")
                sQuery.Append(" and journ_id = " & yacht_journal_id & " ")


                If bAerodexFlag Then excludeONOFFmarket = ",'OM','MA'"

                sQuery.Append(" AND journ_subcategory_code NOT IN ('IN','DM','EXOFF','EXON'" + excludeONOFFmarket + ")")
                sQuery.Append(" AND journ_yt_id = " + nYachtID.ToString)

                sQuery.Append(" ORDER BY journ_date DESC, journ_id DESC")

            End If

            SqlConn.ConnectionString = localFunctions.clientConnectStr
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString
            SqlReader = SqlCommand.ExecuteReader()

            Try
                SqlDatatable.Load(SqlReader)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = SqlDatatable.GetErrors()
            End Try


            If bWordReport = True Then
                page_start = page_start & ("<table width='" & word_width & "' align='center' cellpadding='2'>")
            Else
                page_start = page_start & ("<table width='" & pdf_html_width & "' align='center' cellpadding='2' class=""formatTable large " & TableColor & " subtextNoMargin historyTable"">")
            End If


            page_start = page_start & ("<tr class=""noBorder""><td colspan='2' align='center'><font class='" & Session("FONT_CLASS_HEADER") & " subHeader'>History</font></td></tr>")
            page_start = page_start & ("<tr class='" & Session("ROW_CLASS_BOTTOM") & " '><td align='left' width=""120""><font class='" & Session("FONT_CLASS_TEXT_TITLE") & " subHeader'>DATE</td><td align='left'><font class='" & Session("FONT_CLASS_TEXT_TITLE") & " subHeader''>DESCRIPTION</font></td></tr>")
            '<td align='center'><font class='" & Session("FONT_CLASS_TEXT_TITLE") & "'>Type</font></td>

            outString.Append(page_start)
            Counter_For_PDF = Counter_For_PDF + 1

            If Not IsNothing(SqlDatatable) Then

                If SqlDatatable.Rows.Count > 0 Then

                    For Each Row As DataRow In SqlDatatable.Rows

                        Counter_For_PDF = Counter_For_PDF + 1
                        increment += 1
                        If (Counter_For_PDF > page_break And ShowNewTemplate = False) Or (increment > page_break And ShowNewTemplate = True) Then
                            outString.Append("</table>")
                            If ShowNewTemplate = True Then
                                outString.Append("</div></td></tr></table></div><div class=""valueSpec viewValueExport Simplistic aircraftSpec"">")
                                outString.Append(comp_functions.NEW_build_full_spec_page_header(NEW_AC_ID, "", comp_address, comp_logo, 0, NEW_COMP_ID, bWordReport, word_width, pdf_html_width, check_prepared_for, chkBlindReport, prepared_for))
                                outString.Append(CreateStartingTable())
                                outString.Append("<tr><td align=""left"" valign=""top""><div class=""Box"">")
                            Else
                                outString.Append(comp_functions.NEW_Insert_Page_Break_PDF(Counter_For_PDF, reportType.SelectedValue))
                                outString.Append(comp_functions.NEW_build_full_spec_page_header(NEW_AC_ID, "", comp_address, comp_logo, 0, NEW_COMP_ID, bWordReport, word_width, pdf_html_width, check_prepared_for, chkBlindReport, prepared_for))
                            End If


                            Counter_For_PDF = Counter_For_PDF + 2
                            increment = 0
                            outString.Append(page_start)
                        End If

                        If Not toggleRowColor Then
                            sRowColor = "<tr valign='top' class='" & Session("ROW_CLASS_BOTTOM") & "' valign='top'>"  '  bgcolor='#E6E6E6'
                            toggleRowColor = True
                        Else
                            sRowColor = "<tr bgcolor='white' valign='top' class='" & Session("ROW_CLASS_BOTTOM") & "' valign='top'>"
                            toggleRowColor = False
                        End If

                        outString.Append(sRowColor)
                        outString.Append("<td align='left'><font class='" & Session("FONT_CLASS_TEXT_SMALL") & "'>" + FormatDateTime(Row.Item("journ_date").ToString, DateFormat.ShortDate) + "</font></td>")
                        'outString.Append("<td align='left'><font class='" & Session("FONT_CLASS_TEXT_SMALL") & "'>" + Row.Item("jcat_subcategory_name").ToString.Trim + "</font></td>")

                        If Row.Item("jcat_auto_subject_flag").ToString.ToUpper.Contains("Y") Then
                            outString.Append("<td align='left'><font class='" & Session("FONT_CLASS_TEXT_SMALL") & "'>" + Row.Item("jcat_subcategory_name").ToString.Trim)

                            If Row.Item("jcat_subcategory_name").ToString.ToLower.Contains("fractional sale") Then
                                Dim sFractionPercent As String = ""
                                Dim sFractionExpiresDate As String = ""

                                localFunctions.get_fraction_percent_and_expire_date(CLng(Row.Item("journ_id").ToString), True, sFractionPercent, sFractionExpiresDate)
                                outString.Append(Constants.cSingleSpace + sFractionPercent)

                            End If

                            outString.Append(" - " + Server.HtmlEncode(Row.Item("journ_subject").ToString.Trim) + "")
                        Else
                            outString.Append("<td align='left'><font class='" & Session("FONT_CLASS_TEXT_SMALL") & "'>" + Server.HtmlEncode(Row.Item("journ_subject").ToString.Trim) + "")
                        End If

                        If Not IsDBNull(Row.Item("journ_customer_note")) Then
                            If Not String.IsNullOrEmpty(Row.Item("journ_customer_note").ToString.Trim) Then
                                outString.Append(" Transaction Notes: " & Server.HtmlEncode(Row.Item("journ_customer_note").ToString.Trim) & "")
                            End If
                        End If

                        outString.Append("</font></td></tr>")

                    Next

                    something_shown = True

                End If

            End If

            If Not something_shown Then
                outString.Append("<tr><td valign='middle' align='center'><font class='" & Session("FONT_CLASS_TEXT") & "'> No Transactions Currently Available</font></td></tr>")
            End If

            outString.Append("</table>")

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_transactions_page()" + ex.Message
        Finally

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

            SqlReader.Close()

            SqlReader = Nothing

        End Try

        Return outString.ToString

        outString = Nothing

    End Function


    Public Function NEW_build_full_spec_pictures_page(ByVal nAircraftID As Long, Optional ByVal NewPDFTemplateHeader As String = "") As String

        'LAST SECTION  IN COL 1- PICTURE -----------------------------------------------------------------------------------------------------------------------------------
        Dim imgDisplayFolder As String = ""


        If HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then

            If Not Application.Item("crmClientSiteData").crmClientHostName.ToString.ToUpper.Contains("NEWEVONET") Then
                imgDisplayFolder = "https://www.testjetnetevolution.com/" + HttpContext.Current.Session.Item("AircraftPicturesFolderVirtualPath")
            Else
                imgDisplayFolder = "http://www.jetnetevolution.com/" + HttpContext.Current.Session.Item("AircraftPicturesFolderVirtualPath")
            End If

        Else
            imgDisplayFolder = Application.Item("crmClientSiteData").ClientFullHostName.ToString.Trim + HttpContext.Current.Session.Item("AircraftPicturesFolderVirtualPath")
        End If


        Dim imgFileName As String = ""
        Dim outStringB As New StringBuilder
        Dim ts As String = ""
        ' This is right side column, should start with an open table already in td

        Dim fApicSubject As String = ""
        Dim fAcpic_image_type As String = ""
        Dim fAcpic_id As Integer = 0
        Dim pic_seq_num As Integer = 0
        Dim row_color As String = "gray"
        Dim pic_counter As Integer = 0
        Dim pic_size As Integer = 250
        Dim pic_height_size As Integer = 200
        Dim nCount As Integer = 0
        Dim something_shown As Boolean = False

        Dim sQuery = New StringBuilder()

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader = Nothing
        Dim SqlException As SqlClient.SqlException = Nothing

        Dim ac_image_file As String = ""
        Dim temp_height As Integer = 0
        Dim temp_width As Integer = 0
        Dim zimage2 As System.Drawing.Image
        Dim desired_width As Integer = 250
        Dim temp_percent1 As Double = 0.0
        Dim temp_percent2 As Double = 0.0
        Dim add_pic As String = "N"
        Dim height_size_total As Integer = 1200
        Dim total_height As Integer = 0
        Dim numPages As Integer = 1

        Dim picSplitPage As Integer = 0

        Try

            sQuery.Append("SELECT * FROM Aircraft_Pictures WITH(NOLOCK)")   ' 1 on title - 3 on next - 6 on this
            sQuery.Append(" WHERE acpic_ac_id = " + nAircraftID.ToString)
            sQuery.Append(" AND acpic_journ_id = 0")
            sQuery.Append(" AND acpic_seq_no > 0")
            sQuery.Append(" AND acpic_image_type = 'JPG'")
            sQuery.Append(" AND acpic_hide_flag = 'N'")
            sQuery.Append(" ORDER BY acpic_seq_no")

            SqlConn.ConnectionString = localFunctions.clientConnectStr
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 90

            SqlCommand.CommandText = sQuery.ToString
            SqlReader = SqlCommand.ExecuteReader()



            If SqlReader.HasRows Then
                If bWordReport = True Then
                    outStringB.Append("<table width='" & word_width & "' align='center' cellpadding='3'>")
                Else
                    outStringB.Append("<table width='" & pdf_html_width & "' align='center' cellpadding='3'  class=""formatTable " & TableColor & """>")
                End If

                Do While SqlReader.Read

                    'If ShowNewTemplate = True Then
                    '  If picSplitPage = 12 Then
                    '    picSplitPage = 0
                    '    outString += "</td></tr></table></div></td></tr></table></div><div class=""valueSpec viewValueExport Simplistic aircraftSpec"">"
                    '    outString += comp_functions.NEW_build_full_spec_page_header(NEW_AC_ID, "", comp_address, comp_logo, 0, NEW_COMP_ID, bWordReport, word_width, pdf_html_width, check_prepared_for, chkBlindReport, prepared_for)
                    '    outString += CreateStartingTable()
                    '    outString += "<tr><td align=""left"" valign=""top""><div class=""Box""><table width='" & pdf_html_width & "' align='center' cellpadding='3' class=""formatTable " & TableColor & """>"

                    '  End If
                    'End If

                    'then do one per page
                    If chkPP_Large.Checked = True And chkPP_Large.Visible = True And nCount > 1 Or (picSplitPage = 12 And bWordReport = False) Or (picSplitPage = 6 And bWordReport = True) Then

                        If (picSplitPage = 12 And bWordReport = False) Or (picSplitPage = 6 And bWordReport = True) Then
                            picSplitPage = 0
                            numPages += 1
                        Else
                            outStringB.Append("</table>")
                        End If


                        If ShowNewTemplate = True Then
                            outStringB.Append("</td></tr></table></div></td></tr></table></div>")
                            If bWordReport Then
                                outStringB.Append(Insert_Page_Break_PDF)
                                outStringB.Append("<div>")
                            Else
                                outStringB.Append("<div class=""valueSpec viewValueExport Simplistic aircraftSpec"">")
                            End If

                            outStringB.Append(comp_functions.NEW_build_full_spec_page_header(NEW_AC_ID, "", comp_address, comp_logo, 0, NEW_COMP_ID, bWordReport, word_width, pdf_html_width, check_prepared_for, chkBlindReport, prepared_for, Header_Company_Name, False))
                            outStringB.Append(CreateStartingTable())
                            outStringB.Append("<tr><td align=""left"" valign=""top"" colspan=""2""><div class=""Box"">")
                        Else
                            outStringB.Append(comp_functions.NEW_Insert_Page_Break_PDF(Counter_For_PDF, reportType.SelectedValue))
                            outStringB.Append(comp_functions.NEW_build_full_spec_page_header(NEW_AC_ID, "", comp_address, comp_logo, 0, NEW_COMP_ID, bWordReport, word_width, pdf_html_width, check_prepared_for, chkBlindReport, prepared_for))
                        End If

                        If bWordReport = True Then
                            outStringB.Append("<table width='" & word_width & "' align='center' cellpadding='3'>")
                        Else
                            outStringB.Append("<table width='" & pdf_html_width & "' align='center' cellpadding='3' class=""formatTable " & TableColor & """>")
                        End If
                    End If

                    If nCount > 0 Then ' changed to > 0, to only skip the first picture instead of > 1 to skip the first two

                        pic_seq_num = CInt(SqlReader.Item("acpic_seq_no").ToString)

                        If Not IsDBNull(SqlReader("acpic_image_type")) Then
                            fAcpic_image_type = SqlReader.Item("acpic_image_type").ToString.ToLower.Trim
                        End If

                        If Not IsDBNull(SqlReader("acpic_id")) Then
                            fAcpic_id = SqlReader.Item("acpic_id").ToString.Trim
                        End If

                        If Not (IsDBNull(SqlReader("acpic_subject"))) Then
                            fApicSubject = SqlReader.Item("acpic_subject").ToString.Trim
                        End If

                        imgFileName = nAircraftID.ToString + Constants.cHyphen + "0" + Constants.cHyphen + fAcpic_id.ToString + Constants.cDot + fAcpic_image_type.ToLower.Trim

                        If chkPP_Large.Checked = True And chkPP_Large.Visible = True Then
                            desired_width = 950
                        Else
                            desired_width = 250
                        End If

                        If chkPP_Large.Checked = True And chkPP_Large.Visible = True Then

                            If bWordReport Then
                                'outString += "<tr bgcolor='#F1F1F1'><td valign='middle' align='center' class='text_text'>"
                                If pic_counter = 0 Then
                                    If row_color = "white" Then
                                        outStringB.Append("<tr><td width='90%' valign='middle' align='center'>") '  bgcolor='#F1F1F1'
                                        row_color = "gray"
                                    Else
                                        outStringB.Append("<tr><td width='90%' valign='middle' align='center'>")  'bgcolor='#D0D0D0'
                                        row_color = "white"
                                    End If
                                End If
                            Else
                                If pic_counter = 0 Then
                                    If row_color = "white" Then
                                        outStringB.Append("<tr class=""noBorder""><td width='90%' valign='middle' align='center'>") ' tr  bgcolor='#F1F1F1'
                                        row_color = "gray"
                                    Else
                                        outStringB.Append("<tr class=""noBorder""><td width='90%' valign='middle' align='center'>") '  bgcolor='#D0D0D0'
                                        row_color = "white"
                                    End If
                                End If
                            End If

                        Else

                            If bWordReport Then
                                'outString += "<tr bgcolor='#F1F1F1'><td valign='middle' align='center'>"
                                If pic_counter = 0 Then
                                    If row_color = "white" Then
                                        outStringB.Append("<tr><td width='50%' valign='middle' align='center'>") ' tr  bgcolor='#F1F1F1'
                                        row_color = "gray"
                                    Else
                                        outStringB.Append("<tr><td width='50%' valign='middle' align='center'>") '  bgcolor='#D0D0D0'
                                        row_color = "white"
                                    End If
                                End If
                            Else
                                If pic_counter = 0 Then
                                    If row_color = "white" Then
                                        outStringB.Append("<tr class=""noBorder""><td width='33%' valign='middle' align='center'>") '  bgcolor='#F1F1F1'
                                        row_color = "gray"
                                    Else
                                        outStringB.Append("<tr class=""noBorder""><td width='33%' valign='middle' align='center'>") '  bgcolor='#D0D0D0'
                                        row_color = "white"
                                    End If
                                End If
                            End If

                        End If



                        Try


                            ac_image_file = HttpContext.Current.Server.MapPath("pictures\aircraft\") & imgFileName
                            zimage2 = System.Drawing.Image.FromFile(ac_image_file)
                            temp_width = zimage2.Width
                            temp_height = zimage2.Height

                            If chkPP_Large.Checked = True And chkPP_Large.Visible = True Then

                                'if width > height, then shrink the width down 
                                If temp_width > temp_height Then
                                    If temp_width > desired_width Then
                                        temp_percent1 = CDbl(CDbl(desired_width) / CDbl(temp_width))
                                        temp_width = CDbl(CDbl(temp_width) * CDbl(temp_percent1))
                                        temp_height = CDbl(CDbl(temp_height) * CDbl(temp_percent1))
                                    End If
                                ElseIf temp_height > temp_width Then
                                    ' if taller than it is wide, then as long as not too wide, its ok till height check
                                    If temp_width > desired_width Then
                                        temp_percent1 = CDbl(CDbl(desired_width) / CDbl(temp_width))
                                        temp_width = CDbl(CDbl(temp_width) * CDbl(temp_percent1))
                                        temp_height = CDbl(CDbl(temp_height) * CDbl(temp_percent1))
                                    End If
                                End If

                                ' make sure not too tall for a given page size
                                If temp_height > height_size_total Then
                                    temp_percent1 = CDbl(CDbl(height_size_total) / CDbl(temp_height))
                                    temp_width = CDbl(CDbl(temp_width) * CDbl(temp_percent1))
                                    temp_height = CDbl(CDbl(temp_height) * CDbl(temp_percent1))
                                End If



                            Else
                                ' if the image is wider then the desired image width, then shirnk down to size.
                                If temp_width > desired_width Then
                                    temp_percent1 = CDbl(CDbl(desired_width) / CDbl(temp_width))
                                    temp_width = CDbl(CDbl(temp_width) * CDbl(temp_percent1))
                                    temp_height = CDbl(CDbl(temp_height) * CDbl(temp_percent1))
                                End If

                                'assuming generally that a square is fine
                                If temp_height > temp_width Then
                                    temp_percent1 = CDbl(CDbl(temp_width) / CDbl(temp_height))
                                    temp_width = CDbl(CDbl(temp_width) * CDbl(temp_percent1))
                                    temp_height = CDbl(CDbl(temp_height) * CDbl(temp_percent1))
                                End If
                            End If


                            ' Call CommonAircraftFunctions.find_image_resize_to_fit(temp_width, temp_height, desired_width, desired_height, javascript_slideshow_begining, r, image_folder_display, fAcpic_id, fAcpic_image_type, fAcpic_subject, "Yacht", yacht_id, journalID)

                            If Trim(Request("pic_test")) = "Y" Then
                                If chkPP_Large.Checked = True And chkPP_Large.Visible = True Then
                                    total_height = total_height + temp_height

                                    add_pic = "Y"
                                    If total_height > height_size_total Then
                                        add_pic = "N"
                                    End If

                                    If add_pic = "N" Then
                                        outStringB.Append("</td></tr>")
                                        outStringB.Append(Insert_Page_Break_PDF())
                                        total_height = 0
                                    End If
                                End If
                            End If


                            If bWordReport Then
                                outStringB.Append("<img title='" + fApicSubject.Trim + "' alt='" + fApicSubject.Trim + "' src='" + imgDisplayFolder.Trim + "/" + imgFileName.Trim + "' width='" + temp_width.ToString + "'  height='" + temp_height.ToString + "'/><br /><br />")
                            Else
                                outStringB.Append("<img title='" + fApicSubject.Trim + "' alt='" + fApicSubject.Trim + "' src='" + imgDisplayFolder.Trim + "/" + imgFileName.Trim + "' width='" + temp_width.ToString + "' /><br /><br />")
                            End If


                        Catch ex As Exception

                            If bWordReport Then
                                outStringB.Append("<img title='" + fApicSubject.Trim + "' alt='" + fApicSubject.Trim + "' src='" + imgDisplayFolder.Trim + "/" + imgFileName.Trim + "' width='" + desired_width.ToString + "'  height='" + pic_height_size.ToString + "'/><br /><br />")
                            Else
                                outStringB.Append("<img title='" + fApicSubject.Trim + "' alt='" + fApicSubject.Trim + "' src='" + imgDisplayFolder.Trim + "/" + imgFileName.Trim + "' width='" + desired_width.ToString + "' /><br /><br />")
                            End If
                        End Try

                        picSplitPage += 1


                        If chkPP_Large.Checked = True And chkPP_Large.Visible = True Then

                            outStringB.Append("</td></tr>")
                            something_shown = True

                        Else


                            something_shown = True

                            'If bWordReport Then
                            '  If pic_counter < 1 Then
                            '    outStringB.Append("</td><td width='33%' valign='middle' align='center'>")
                            '    pic_counter += 1
                            '  Else
                            '    outStringB.Append("</td></tr>")
                            '    pic_counter = 0
                            '  End If
                            'Else
                            If pic_counter < 2 Then
                                outStringB.Append("</td><td width='33%' valign='middle' align='center'>")
                                pic_counter += 1
                            Else
                                outStringB.Append("</td></tr>")
                                pic_counter = 0
                            End If
                            'End If

                        End If




                    End If

                    nCount += 1


                Loop

                'If ShowNewTemplate = True And numPages > 1 Then
                '  outString += "</td></tr></table></div>"
                'End If

                ts = outStringB.ToString

                If pic_counter = 0 Then
                    ' outString += "</td>"
                    'outString += "<td width='33%' valign='middle' align='center' class='text_text'>&nbsp;</td></tr>"
                ElseIf pic_counter = 1 Then
                    ts &= ("</td><td width='33%' valign='middle' align='center'>&nbsp;</td></tr>")
                End If


                If Right(Trim(ts), "8") = "center'>" Then
                    ts &= ("&nbsp;</td></tr>")
                End If

            End If

            If Not something_shown Then
                If bWordReport = True Then
                    ts &= ("<table width='" & word_width & "' align='center' cellpadding='3'>")
                Else
                    ts &= ("<table width='" & pdf_html_width & "' align='center' cellpadding='3' class=""formatTable large"">")
                End If

                ts &= ("<tr><td valign='middle' align='left' class='sub_section_text'> No Additional Pictures Currently Available </td></tr>")
            End If

            If Right(Trim(ts), 5) <> "</tr>" Then
                ts &= ("</tr>")
            End If

            outStringB.Length = 0
            outStringB.Append(ts)
            outStringB.Append("</table>")


        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_pictures_page_pics()" + ex.Message
        Finally

            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

            SqlReader.Close()


        End Try

        Return outStringB.ToString

    End Function

    Public Function NEW_Build_Spacer_Row() As String

        Dim tmpStr As String = ""

        If ShowNewTemplate = False Then
            tmpStr = "<tr class=""noBorder""><td height='5' width='" + spacer_width + "'>"
            tmpStr += "<table width='" + spacer_width + "'><tr><td width='" + spacer_width + "'></td></tr></table>"
            tmpStr += "</td></tr>"
        End If

        Return tmpStr

    End Function

    Public Function NEW_Make_MaintDetails()

        Dim ResultsTable As New DataTable
        Dim temp_date As String = ""
        Dim htmlOut As New StringBuilder
        Dim htmlOut_start As New StringBuilder
        Dim temp_count As Integer = 0
        Dim dateFormatted As String = ""
        Dim rowCounter As Integer = 0
        Dim has_cw As Boolean = False
        Dim has_cw_hours As Boolean = False
        Dim has_due As Boolean = False
        Dim has_due_hours As Boolean = False
        Dim has_notes As Boolean = False
        Dim temp_label As String = ""

        Try

            '   If (HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Or HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.TEST) Then
            '   If HttpContext.Current.Session.Item("localUser").crmLocalUserEmailAddress.ToString.ToLower.Contains("@jetnet.com") Or HttpContext.Current.Session.Item("localUser").crmLocalUserEmailAddress.ToString.ToLower.Contains("@mvintech.com") Then

            ResultsTable = Master.aclsData_Temp.GetJETNET_Aircraft_Maintenance_BY_ACID(NEW_AC_ID, 0)

            If Not IsNothing(ResultsTable) Then

                If ResultsTable.Rows.Count > 0 Then

                    Try

                        For Each r As DataRow In ResultsTable.Rows

                            temp_count = temp_count + 1


                            'If Not IsDBNull(r("acmaint_name")) And Not String.IsNullOrEmpty(r("acmaint_name").ToString) Then
                            '  htmlOut.Append("" + r("acmaint_name").ToString.Trim + " ")
                            ' End If 

                            If Not IsDBNull(r("acmaint_date_type")) And Not String.IsNullOrEmpty(r("acmaint_date_type")) Then
                                Select Case UCase(r("acmaint_date_type"))
                                    Case "D"
                                        dateFormatted = "MM/dd/yy"
                                    Case "M"
                                        dateFormatted = "MM/yy"
                                    Case "Y"
                                        dateFormatted = "yyyy"
                                End Select
                            End If

                            temp_label = ""
                            If Not IsDBNull(r("acmaint_complied_date")) And Not String.IsNullOrEmpty(r("acmaint_complied_date").ToString) Then
                                'temp_date = FormatDateTime(r("acmaint_complied_date").ToString.Trim, DateFormat.ShortDate)
                                ' temp_date = Month(temp_date) & "/" & Day(temp_date) & "/" & Right(Year(Trim(temp_date)), 2)
                                temp_date = Format(r("acmaint_complied_date"), dateFormatted)
                                temp_label &= ("<td align='left' width='100'><font class='" & Session("FONT_CLASS_TEXT") & "'>" & temp_date & "</font></td>")
                            Else
                                temp_label &= ("<td align='left' width='100'>&nbsp;</td>")
                            End If

                            If Not IsDBNull(r("acmaint_complied_hrs")) And Not String.IsNullOrEmpty(r("acmaint_complied_hrs").ToString) Then
                                If IsNumeric(r("acmaint_complied_hrs")) Then
                                    If r("acmaint_complied_hrs") > 0 Then
                                        temp_label &= ("<td align='left' width='100'><font class='" & Session("FONT_CLASS_TEXT") & "'>" + r("acmaint_complied_hrs").ToString.Trim & "</font></td>")
                                    Else
                                        temp_label &= ("<td align='left' width='100'>&nbsp;</td>")
                                    End If
                                Else
                                    temp_label &= ("<td align='left' width='100'>&nbsp;</td>")
                                End If
                            Else
                                temp_label &= ("<td align='left' width='100'>&nbsp;</td>")
                            End If


                            If Not IsDBNull(r("acmaint_due_date")) And Not String.IsNullOrEmpty(r("acmaint_due_date").ToString) Then
                                'temp_date = FormatDateTime(r("acmaint_due_date").ToString.Trim, DateFormat.ShortDate)
                                'temp_date = Month(temp_date) & "/" & Day(temp_date) & "/" & Right(Year(Trim(temp_date)), 2)
                                temp_date = Format(r("acmaint_due_date"), dateFormatted)
                                temp_label &= ("<td align='left' width='100'><font class='" & Session("FONT_CLASS_TEXT") & "'>" & temp_date & "</font></td>")
                            Else
                                temp_label &= ("<td align='left' width='100'>&nbsp;</td>")
                            End If

                            If Not IsDBNull(r("acmaint_due_hrs")) And Not String.IsNullOrEmpty(r("acmaint_due_hrs").ToString) Then
                                If IsNumeric(r("acmaint_due_hrs")) Then
                                    If r("acmaint_due_hrs") > 0 Then
                                        temp_label &= ("<td align='left' width='100'><font class='" & Session("FONT_CLASS_TEXT") & "'>" + r("acmaint_due_hrs").ToString.Trim & "</font></td>")
                                    Else
                                        temp_label &= ("<td align='left' width='100'>&nbsp;</td>")
                                    End If
                                Else
                                    temp_label &= ("<td align='left' width='100'>&nbsp;</td>")
                                End If
                            Else
                                temp_label &= ("<td align='left' width='100'>&nbsp;</td>")
                            End If


                            If Not IsDBNull(r("acmaint_notes")) And Not String.IsNullOrEmpty(r("acmaint_notes").ToString) Then
                                If InStr(Trim(r("acmaint_notes").ToString), "as reported") > 0 Then
                                    temp_label &= ("<td align='left' width='250'><font class='" & Session("FONT_CLASS_TEXT") & "'>" & Replace(r("acmaint_notes").ToString.Trim, "as reported", "Date(s) as reported/not actual.") & "</font></td>")
                                Else
                                    temp_label &= ("<td align='left' width='250'><font class='" & Session("FONT_CLASS_TEXT") & "'>" & r("acmaint_notes").ToString.Trim & "</font></td>")
                                End If
                            Else
                                temp_label &= ("<td align='left' width='250'><font class='" & Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>")
                            End If



                            htmlOut.Append("<tr class='" & Session("ROW_CLASS_BOTTOM") & "' valign='top'>")
                            htmlOut.Append("<td align='left' width='" & spacer_width & "'>")

                            temp_label = "</td>" & temp_label
                            ' this way it adds in style, but we make all of the columns 
                            htmlOut.Append(comp_functions.create_value_with_label(r("acmaint_name").ToString.Trim, temp_label, False, False, Counter_For_PDF, spacer_width))
                            htmlOut.Append("</tr>")
                            rowCounter += 1


                        Next

                    Catch ex As Exception
                    Finally

                    End Try


                    If bWordReport = True Then
                        htmlOut_start.Append("<table width='" & word_width & "' align='center' cellpadding='3'>")
                    Else
                        htmlOut_start.Append("<table width='" & pdf_html_width & "' align='center' cellpadding='3' class=""formatTable maintenanceTable " & TableColor & " subtextNoMargin "">")
                    End If

                    htmlOut_start.Append(NEW_Build_Spacer_Row())
                    'htmlOut_start.Append("<tr><td valign='top' align='center' colspan='6'><font class='" & Session("FONT_CLASS_HEADER") & " subHeader'>Maintenance Items</font></td></tr>")
                    htmlOut_start.Append("<tr><td><font class='" & Session("FONT_CLASS_TEXT_TITLE") & " subHeader' width=""150"">Maintenance Items</font></td>")
                    htmlOut_start.Append("<td><font class='" & Session("FONT_CLASS_TEXT_TITLE") & " subHeader'>C/W&nbsp;</font></td>")
                    htmlOut_start.Append("<td><font class='" & Session("FONT_CLASS_TEXT_TITLE") & " subHeader'>C/W&nbsp;HRS&nbsp;</font></td>")
                    htmlOut_start.Append("<td><font class='" & Session("FONT_CLASS_TEXT_TITLE") & " subHeader'>DUE&nbsp;</font></td>")
                    htmlOut_start.Append("<td><font class='" & Session("FONT_CLASS_TEXT_TITLE") & " subHeader'>DUE&nbsp;HRS&nbsp;</font></td>")
                    htmlOut_start.Append("<td><font class='" & Session("FONT_CLASS_TEXT_TITLE") & " subHeader'>NOTES&nbsp;</font></td>")
                    htmlOut_start.Append("</tr>")

                    'htmlOut_start.Append("<td valign='top' align='center' class=""header_row maxwidth_date""><b class=""text_underline help_cursor"" title=""Complied With or Completed"" alt=""Complied with or Completed"">C/W</b></td>")

                    'htmlOut_start.Append("<td valign='top' align='center' class=""header_row""><b><span class=""text_underline help_cursor"" title=""Complied With or Completed"" alt=""Complied with or Completed"">C/W</span> Hrs</b></td>")

                    'htmlOut_start.Append("<td valign='top' align='center' class=""header_row maxwidth_date""><b>Due</b></td>")

                    'htmlOut_start.Append("<td valign='top' align='center' class=""header_row""><b>Due Hrs</b></td>")

                    'htmlOut_start.Append("<td valign='top' align='left' class=""header_row""><b>Notes</b></td>")

                    'htmlOut_start.Append("</tr>")

                End If


            End If

            ResultsTable = New DataTable
            '  End If
            ' End If


        Catch ex As Exception

        End Try

        Return htmlOut_start.ToString + htmlOut.ToString + "</table>"

    End Function
    Public Function Get_AC_DLV_YEAR(ByVal ac_id As Integer) As String
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlDataReader As System.Data.SqlClient.SqlDataReader : SqlDataReader = Nothing

        Dim tmpStr As String : tmpStr = "0"

        Dim Query As String : Query = ""
        Query = "SELECT DISTINCT ac_year FROM Aircraft WITH(NOLOCK) WHERE ac_journ_id = 0 and ac_id = " + ac_id.ToString

        Try

            'Select Case Application.Item("webHostObject").evoWebHostType
            'Case eWebSiteTypes.LOCAL
            'SqlConn.ConnectionString = My.Settings.DEFAULT_LOCAL_MSSQL
            '  Case Else
            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            'End Select

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandTimeout = 1000
            SqlCommand.CommandText = Query.ToString

            SqlDataReader = SqlCommand.ExecuteReader()

            If SqlDataReader.HasRows Then
                SqlDataReader.Read()
                If Not (IsDBNull(SqlDataReader("ac_year"))) Then
                    tmpStr = SqlDataReader("ac_year").ToString
                End If
            End If
            SqlDataReader.Close()
            SqlDataReader = Nothing
        Catch SqlException

            SqlConn.Dispose()
            SqlCommand.Dispose()

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Get_AC_MFR_YEAR: " & SqlException.Message

        Finally

            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()

        End Try

        Return tmpStr

    End Function

#End Region

#Region "New_Financial_Docs_Section"


    Public Function Build_Financial_Documents_By_Month()
        Build_Financial_Documents_By_Month = ""
        Dim DisplayString As String = ""
        Dim InnerString As String = ""
        Dim DocTable As New DataTable
        Dim css As String = ""
        Dim MonthDisplay As String = ""
        Dim high_number As Long = 0
        Dim low_number As Long = 100000
        Dim starting_point As Integer = 0
        Dim interval_point As Integer = 1
        Dim ending_point As Integer = 0
        DocTable = financial_documents_functions.GetDocsByMonth(searchCriteria, use_insight_roll)

        If Not IsNothing(DocTable) Then
            If DocTable.Rows.Count > 0 Then


                AVG_PRICE_MONTH.Series.Clear()
                AVG_PRICE_MONTH.Series.Add("AVG_PRICE")
                AVG_PRICE_MONTH.Series("AVG_PRICE").ChartType = UI.DataVisualization.Charting.SeriesChartType.Column
                AVG_PRICE_MONTH.Series("AVG_PRICE").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32
                AVG_PRICE_MONTH.Series("AVG_PRICE").LabelForeColor = Drawing.Color.Blue
                AVG_PRICE_MONTH.ChartAreas("ChartArea1").AxisY.Title = "Documents"
                AVG_PRICE_MONTH.Series("AVG_PRICE").Color = Drawing.Color.Blue
                AVG_PRICE_MONTH.Series("AVG_PRICE").BorderWidth = 2
                AVG_PRICE_MONTH.Series("AVG_PRICE").MarkerSize = 6
                AVG_PRICE_MONTH.Series("AVG_PRICE").MarkerStyle = UI.DataVisualization.Charting.MarkerStyle.Circle
                '  AVG_PRICE_MONTH.BorderlineWidth = 10
                AVG_PRICE_MONTH.Series("AVG_PRICE").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32
                'AVG_PRICE_MONTH.Series("AVG_PRICE").SmartLabelStyle.Enabled = False
                'AVG_PRICE_MONTH.Series("AVG_PRICE").LabelAngle = 45
                '  If WD.SelectedValue = "Word" Or WD.SelectedValue = "WordX" Then
                AVG_PRICE_MONTH.Width = 500
                AVG_PRICE_MONTH.Height = 500
                '   End If


                For Each r As DataRow In DocTable.Rows
                    MonthDisplay = ""
                    ' If InnerString <> "" Then
                    'InnerString += ","
                    '  End If
                    If Not IsDBNull(r("tmonth")) Then
                        MonthDisplay = r("tmonth").ToString
                    End If
                    If Not IsDBNull(r("tyear")) Then
                        If MonthDisplay <> "" Then
                            MonthDisplay += "/"
                        End If
                        MonthDisplay += Right(r("tyear").ToString, 2)
                    End If

                    If CDbl(r("tcount").ToString) > high_number Then
                        high_number = CDbl(r("tcount").ToString)
                    End If
                    If CDbl(r("tcount").ToString) < low_number Then
                        low_number = CDbl(r("tcount").ToString)
                    End If


                    ' InnerString += "['" & MonthDisplay & "', " & r("tcount").ToString & "]"

                    AVG_PRICE_MONTH.Series("AVG_PRICE").Points.AddXY(MonthDisplay.ToString, CLng(r("tcount")))

                Next

            End If
        End If
        DocTable.Dispose()


        commonEvo.set_ranges_for_vsCharts(low_number, high_number, interval_point, starting_point, ending_point)

        AVG_PRICE_MONTH.ChartAreas("ChartArea1").AxisY.Maximum = ending_point
        AVG_PRICE_MONTH.ChartAreas("ChartArea1").AxisY.Minimum = IIf(starting_point > 0, starting_point, 0)
        AVG_PRICE_MONTH.ChartAreas("ChartArea1").AxisY.Interval = interval_point


        Build_Financial_Documents_By_Month = DisplayString
    End Function
    Public Function Build_Related_Financing_Companies_Documents()
        Build_Related_Financing_Companies_Documents = ""
        Dim DisplayString As String = ""
        Dim DocTable As New DataTable
        Dim toggleRowColor As Boolean = False
        Dim bgcolor As String = ""
        DocTable = financial_documents_functions.GetRelatedDocs(searchCriteria, use_insight_roll)

        If Not IsNothing(DocTable) Then
            If DocTable.Rows.Count > 0 Then
                DisplayString += "<tr class='" & HttpContext.Current.Session.Item("ROW_CLASS_BOTTOM") & "'><td colspan='12'><font class='" & HttpContext.Current.Session.Item("FONT_CLASS_HEADER") & "'>Related Financing Companies Financial Documents </font></td></tr>"
                DisplayString += "<tr class=""header_row""><td align=""left"" valign=""top""><b><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Company</b></td><td align=""right"" valign=""top""><b><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'># of Docs</b></td></tr>"

                For Each r As DataRow In DocTable.Rows

                    If Not toggleRowColor Then
                        toggleRowColor = True
                        bgcolor = ""
                    Else
                        toggleRowColor = False
                        bgcolor = "#f0f0f0"
                    End If
                    DisplayString += "<tr bgcolor='" & bgcolor & "'>"

                    DisplayString += "<td align=""left"" valign=""top""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"

                    'Company
                    DisplayString += WriteCompAdd(r)
                    DisplayString += "</td>"

                    DisplayString += "<td align=""right"" valign=""top""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                    '# of documents.
                    If Not IsDBNull(r("tcount")) Then
                        DisplayString += r("tcount").ToString
                    End If
                    DisplayString += "</td>"
                    DisplayString += "</tr>"
                Next

                DisplayString += "</table>"
            End If
        End If
        DocTable.Dispose()

        Build_Related_Financing_Companies_Documents = DisplayString

    End Function
    Public Function Build_Types_Financial_Documents()
        Build_Types_Financial_Documents = ""
        Dim DisplayString As String = ""
        Dim DocTable As New DataTable
        Dim toggleRowColor As Boolean = False
        Dim bgcolor As String = ""
        DocTable = financial_documents_functions.GetTypeDocs(searchCriteria, use_insight_roll)

        If Not IsNothing(DocTable) Then
            If DocTable.Rows.Count > 0 Then
                DisplayString += "<tr class='" & HttpContext.Current.Session.Item("ROW_CLASS_BOTTOM") & "'><td colspan='12'><font class='" & HttpContext.Current.Session.Item("FONT_CLASS_HEADER") & "'>Type of Financial Documents</font></td></tr>"
                DisplayString += "<tr class=""header_row""><td align=""left"" valign=""top""><b><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Type</b></td><td align=""right"" valign=""top""><b><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'># of Docs</b></td></tr>"

                For Each r As DataRow In DocTable.Rows

                    If Not toggleRowColor Then
                        toggleRowColor = True
                        bgcolor = ""
                    Else
                        toggleRowColor = False
                        bgcolor = "#f0f0f0"
                    End If
                    DisplayString += "<tr bgcolor='" & bgcolor & "'>"

                    DisplayString += "<td align=""left"" valign=""top""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                    'Type
                    If Not IsDBNull(r("adoc_doc_type")) Then
                        DisplayString += r("adoc_doc_type").ToString
                    End If
                    DisplayString += "</td>"

                    DisplayString += "<td align=""right"" valign=""top""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                    '# of documents.
                    If Not IsDBNull(r("tcount")) Then
                        DisplayString += r("tcount").ToString
                    End If
                    DisplayString += "</td>"
                    DisplayString += "</tr>"
                Next

                DisplayString += "</table>"
            End If
        End If
        DocTable.Dispose()
        Build_Types_Financial_Documents = DisplayString
    End Function
    Public Function Build_Model_Financial_Documents(ByVal page_break_text As String)
        Build_Model_Financial_Documents = ""
        Dim DisplayString As String = ""
        Dim ModTable As New DataTable
        Dim toggleRowColor As Boolean = False
        Dim bgcolor As String = ""
        Dim count1 As Integer = 0
        Dim DisplayString_header As String = ""
        ModTable = financial_documents_functions.GetModelDocuments(searchCriteria, use_insight_roll)

        If Not IsNothing(ModTable) Then
            If ModTable.Rows.Count > 0 Then
                DisplayString_header += "<tr class='" & HttpContext.Current.Session.Item("ROW_CLASS_BOTTOM") & "'><td colspan='12'><font class='" & HttpContext.Current.Session.Item("FONT_CLASS_HEADER") & "'>Aircraft Models Financed</font></td></tr>"
                DisplayString_header += "<tr class=""header_row""><td align=""left"" valign=""top""><b><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Make/Model</font></b></td><td align=""right"" valign=""top""><b><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'># of Docs</font></b></td></tr>"
                DisplayString += DisplayString_header


                For Each r As DataRow In ModTable.Rows

                    If count1 > 50 Then
                        DisplayString += "</table>"
                        DisplayString += page_break_text
                        DisplayString += DisplayString_header
                        count1 = 0
                    End If

                    count1 = count1 + 1

                    If Not toggleRowColor Then
                        toggleRowColor = True
                        bgcolor = ""
                    Else
                        toggleRowColor = False
                        bgcolor = "#f0f0f0"
                    End If
                    DisplayString += "<tr bgcolor='" & bgcolor & "'>"

                    DisplayString += "<td align=""left"" valign=""top""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                    'Model / Make Link
                    If Not IsDBNull(r("amod_make_name")) And Not IsDBNull(r("amod_make_name")) Then
                        DisplayString += r("amod_make_name") & " / " & r("amod_model_name")
                    End If
                    DisplayString += "</font></td>"

                    DisplayString += "<td align=""right"" valign=""top""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                    '# of documents.
                    If Not IsDBNull(r("tcount")) Then
                        DisplayString += r("tcount").ToString
                    End If
                    DisplayString += "</font></td>"
                    DisplayString += "</tr>"
                Next

                DisplayString += "</table>"
            End If
        End If
        ModTable.Dispose()
        Build_Model_Financial_Documents = DisplayString
    End Function
#End Region

End Class