' ********************************************************************************
' Copyright 2004-11. JETNET,LLC. All rights reserved.
'
'$$Archive: /commonWebProject/controls/View_Master.ascx.vb $
'$$Author: Amanda $
'$$Date: 7/01/20 4:18p $
'$$Modtime: 7/01/20 4:15p $ 
'$$Revision: 94 $ 


'$$Workfile: View_Master.ascx.vb $ 
'
' ********************************************************************************


Partial Public Class View_Master

    Inherits System.Web.UI.UserControl

    Public CRMViewActive As Boolean = False 'This gets set only when you're in the CRM. I could have checked - if Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CRM - but this is simple/easier to read
    Public JetnetSourceText As String = "" 'The following two variables are initialized along with the one above only in the CRM.
    'Public JetnetClientSourceText As String = "" 'Otherwise, they are blank.
    Public ClientIDSToExclude As String = "" 'This variable holds the jetnet ac IDs of the client acs in the database
    Public aclsData_Temp_aspx As New clsData_Manager_SQL

    Public View_Name As String = ""

    Dim sStandalonePageLink As String = ""
    Public View_ID As Long = 0
    Public bHasMaster As Boolean = True
    Public bClickedRange As Boolean = False

    Public sLocationTabScript As String = ""
    Public sLocationTabScriptID As String = ""

    Public sRangeTabScript As String = ""
    Public sRangeTabScriptID As String = ""

    Dim bFromStarTab As Boolean = False
    Dim bFromLocationTab As Boolean = False
    Dim bFromUtilizationTab As Boolean = False

    Public GetMarketStatus As String = ""
    Public Build_FleetMarketSummary_text As String = ""
    Public Amod_model_ac_range As Double = 0.0
    Dim make_model_name As String = ""
    Public displayEValues As Boolean = False

    ' page variables for description tab
    Dim Amod_weight_class_name As String = ""
    Dim Amod_manufacturer As String = ""
    Dim Amod_description As String = ""
    Dim Amod_start_end_years As String = ""
    Dim Amod_ser_nbr_range As String = ""
    Dim Amod_type_name As String = ""
    Dim Amod_price_range As String = ""
    Dim Amod_body_config As String = ""

    Dim sHtmlNewDeliveriesLineChartScript As String = ""
    Dim sHtmlNewDeliveriesBarChartScript As String = ""
    Dim sHtmlNewDeliveriesOperationsScript As String = ""

    ''These are constants for the three colors for the differences on the range tab for each model
    Public Const First_Color = "#FF0000"
    Public Const First_Color_RGB = "rgba(255, 0, 0, .2)"
    Public Const Second_Color = "#00CD00"
    Public Const Second_Color_RGB = "rgba(0, 205, 0, .2)"
    Public Const Third_Color = "#0276FD"
    Public Const Third_Color_RGB = "rgba(2, 118, 253, .2)"

    Public bEnableTelTags As Boolean = False

    Private localDatalayer As viewsDataLayer
    Private localCriteria As New viewSelectionCriteriaClass

    Private sTypeMakeModelCtrlBaseName As String = "AircraftView"

    Public productCodeCount As Integer = 0
    Public isHeliOnlyProduct As Boolean = False

    Private bHasHelicopterFilter As Boolean = False
    Private bHasBusinessFilter As Boolean = False
    Private bHasCommercialFilter As Boolean = False
    Private bHasRegionalFilter As Boolean = False
    Private bHasYachtFilter As Boolean = False

    Private bClearView As Boolean = False
    Private bIsReport As Boolean = False
    Private bIsMfrModel As Boolean = False

    Private bUseLoggedInUser As Boolean = True

    Private nMaxWidth As Long = 0
    Private cAndClause As String = " and "

    Dim COMPLETED_OR_OPEN As String = "O"
    Dim LAST_SAVE_DATE As String = ""

    Dim sReportOutputFilename As String = ""
    Dim sReportFrom As String = ""
    Dim RunModelOnValueOnly As Boolean = False
    Public Shared foundChild As New DropDownList

    Public Shared search_alt_comp_name As Boolean = False 'this is a special case in which we have to look and see if the alt name has been set to true. This sets as it iterates to true if checked so 

    'we can use it later on the comp name textbox
    Public Shared DoNotIncludeOverdue As Boolean = False 'this is yet another special case where we look to see if Do Not Include Overdue has been checked

    Public Shared DoNotIncludeRelationships As Boolean = False
    Public SharedModelTable As New DataTable
    Dim sliderDateString As New StringBuilder
    Dim minTransDate As Date = DateAdd(DateInterval.Year, -20, Now())
    Dim sSelectedProductCode As String = ""
    Dim values_dom As Long = 0
    Dim values_for_sale As Long = 0
    Dim values_for_sale_exclusive As Long = 0

    Dim values_avg_asking As Double = 0
    Dim values_avg_asking_display As Double = 0
    Dim values_avg_asking_graph As Double = 0
    Dim values_forsale_avg_low As Double = 0
    Dim values_forsale_avg_high As Double = 0

    Dim values_mfr_avg_low As Integer = 0
    Dim values_mfr_avg_high As Integer = 0
    Dim values_mfr_avg As Integer = 0

    Dim values_days_low As Double = 0
    Dim values_days_high As Double = 0
    Dim values_days_avg As Double = 0

    Dim values_aftt_low As Double = 0
    Dim values_aftt_high As Double = 0
    Dim values_aftt_avg As Double = 0


    Dim landings_low As Double = 0
    Dim landings_high As Double = 0
    Dim landings_avg As Double = 0
    Dim landings_sum As Double = 0
    Dim landings_count As Integer = 0


    Dim values_lease As Long = 0
    Dim values_abs_rate As Double = 0.0
    Dim values_in_op As Double = 0
    Dim values_total_inop As Long = 0
    Dim values_per1 As Double = 0.0
    Dim values_per2 As Double = 0.0
    Dim values_per3 As Double = 0.0
    Dim evalues_low As Double = 0.0
    Dim evalues_avg As Double = 0.0
    Dim evalues_high As Double = 0.0
    Dim limited_routes As Long = 0
    Dim Selection_Count As Long = 0


    Dim sSelectedProductCode_to_Pass As String = ""
    Public airport_direction As String = "D"
    Public distance_string As String = ""


#Region "build_tab_functions"

    Private Function Build_Analytics_Charts_Legend(ByVal type_of As String) As String

        Dim tmpstr As String = ""

        tmpstr = "<table border='1' cellspacing='0' cellpadding='3'>"
        tmpstr += "<tr valign='top'><td><font color='Blue'>Blue</font></td><td><font color='Blue'>Asking $</font></td></tr>"
        tmpstr += "<tr valign='top'><td><font color='Red'>Red</font></td><td><font color='Red'>Take $</font></td></tr>"
        tmpstr += "<tr valign='top'><td><font color='Green'>Green</font></td><td><font color='Green'>Est Value/Sold $</font></td></tr>"
        tmpstr += "</table>"

        Return tmpstr

    End Function

    Public Sub run_market_checked(ByVal sender As Object, ByVal e As System.EventArgs) Handles market_check.CheckedChanged
        Dim chart_htmlString As String = ""
        Dim rest_of_ac_string As String = ""
        Dim make_name As String = ""
        Dim model_name As String = ""
        Dim temp_amod_id As Long = 0
        Dim real_ac_id As Long = 0

        If View_ID = 19 Then
            Call run_compare_view_items("", 0, False, Trim(Request("noteID")), real_ac_id, make_name, model_name, temp_amod_id, rest_of_ac_string, chart_htmlString, 0, True)
        End If


    End Sub

    Private Sub Build_Analytics_Charts(ByRef searchCriteria As viewSelectionCriteriaClass, ByRef out_htmlString As String, ByVal note_id As Long, ByVal report_to_do As String, ByRef extra_table_to_add As DataTable, ByVal add_legend As Boolean, ByVal avg_asking As Long, ByVal avg_take As Long, ByVal avg_sold As Long, Optional ByVal is_graph_only_page As Boolean = False)
        Dim htmlUpDown As String = ""
        Dim htmlOut As New StringBuilder
        Dim current_market_chart As String = ""
        Dim aircraft_history_string As String = ""
        Dim google_map_array_list As String = ""
        Dim charting_string As String = ""
        Dim charting_test As String = ""
        Dim show_only_estimated As Boolean = False
        Dim show_only_asking As Boolean = False
        Dim show_only_take As Boolean = False
        Dim save_image As Boolean = True

        Dim ANALYTICS_HISTORY_imageName As String = ""
        Dim ANALYTICS_CURRENT_MARKET_imageName As String = ""
        Dim ANALYTICS_SOLD_COMPARABLES_imageName As String = ""
        Dim ANALYTICS_MARKET_STATUS_imageName As String = ""
        Dim ANALYTICS_MARKET_SURVEY_imageName As String = ""
        Dim ANALYTICS_RECENT_SALES_imageName As String = ""

        Dim imgCnt As Integer = 0

        Dim sImageMapPath As String = ""
        Dim sImageSrc As String = ""
        Dim sImageName As String = ""

        Dim subscriptionInfo As String = Session.Item("localUser").crmSubSubID.ToString + "_" + Session.Item("localUser").crmUserLogin.ToString.Trim + "_" + Session.Item("localUser").crmSubSeqNo.ToString + "_"
        Dim displayFolder As String = HttpContext.Current.Application.Item("crmClientSiteData").ClientFullHostName + HttpContext.Current.Session.Item("MarketSummaryFolderVirtualPath")

        Try

            ' if we r in the crm, and we r in a comparable view, then you dont need to save jpg images in most cases
            If CRMViewActive = True And note_id > 0 Then
                save_image = False
            End If

            Me.show_asking.Visible = False
            Me.show_take.Visible = False
            Me.show_estimated.Visible = False
            Me.show_my.Visible = False

            If Trim(report_to_do) = "Market Trends" Then
                If is_graph_only_page = True Then
                    DisplayFunctions.load_google_chart(graph_panel, out_htmlString, "", "Average Asking Price ($k)", "large_graph_div", 950, 550, "POINTS", 1, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False)
                Else
                    DisplayFunctions.load_google_chart(trends_tab, out_htmlString, "", "Average Asking Price ($k)", "chart_div_survey", 500, 250, "POINTS", 1, charting_string, Me.Page, Me.bottom_tab_update_panel, False, True, True, False)
                End If
            End If




            If Trim(report_to_do) = "Value History" Or Trim(report_to_do) = "All" Then
                ' set the title and load the data into the chart control 
                If save_image = True Then
                    ANALYTICS_HISTORY.Titles.Clear()
                    ANALYTICS_HISTORY.Titles.Add("My Aircraft Value History")
                    localDatalayer.views_analytics_graph_1(Session.Item("CLIENT_AC_ID"), Me.ANALYTICS_HISTORY, aircraft_history_string, Session("JETNET_AC_ID"), google_map_array_list, COMPLETED_OR_OPEN, note_id, False, Me.estimated_value_label.Text, Me.market_check.Checked)
                    ANALYTICS_HISTORY.ImageType = DataVisualization.Charting.ChartImageType.Jpeg

                    imgCnt += 1
                    sImageName = subscriptionInfo + commonEvo.GenerateFileName("image_" + imgCnt.ToString, ".jpg", False)
                    sImageMapPath = Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath")) + "\" + sImageName
                    sImageSrc = displayFolder + "/" + sImageName

                    ANALYTICS_HISTORY_imageName = sImageSrc
                    ANALYTICS_HISTORY.SaveImage(sImageMapPath, DataVisualization.Charting.ChartImageFormat.Jpeg)
                Else
                    localDatalayer.views_analytics_graph_1(Session.Item("CLIENT_AC_ID"), Me.ANALYTICS_HISTORY, aircraft_history_string, Session("JETNET_AC_ID"), google_map_array_list, COMPLETED_OR_OPEN, note_id, False, Me.estimated_value_label.Text, Me.market_check.Checked)
                End If

                If is_graph_only_page = True Then
                    DisplayFunctions.load_google_chart(graph_panel, google_map_array_list, "", "Aircraft Value ($k)", "large_graph_div", 950, 550, "POINTS", 1, charting_string, Me.Page, Me.graph_update_panel, False, False, True)
                ElseIf Trim(report_to_do) = "Value History" Then
                    DisplayFunctions.load_google_chart(trends_tab, google_map_array_list, "", "Aircraft Value ($k)", "chart_div_survey", 500, 250, "POINTS", 1, charting_string, Me.Page, Me.bottom_tab_update_panel, False, False, True)
                ElseIf Trim(report_to_do) = "All" Then
                    DisplayFunctions.load_google_chart(charter_tab, google_map_array_list, "Value History", "Aircraft Value ($k)", "chart_div_value_history_all", 500, 250, "POINTS", 1, charting_string, Me.Page, Me.bottom_tab_update_panel, False, False, True)
                    Me.view_history_chart.Text = aircraft_history_string
                End If


            End If



            If Trim(report_to_do) = "Current Market" Or Trim(report_to_do) = "All" Then

                If save_image = True Then
                    ANALYTICS_CURRENT_MARKET.Titles.Clear()
                    ANALYTICS_CURRENT_MARKET.Titles.Add("Current Market Comparables")
                    current_market_chart = localDatalayer.views_analytics_graph_completed_current(Session.Item("CLIENT_AC_ID"), Me.ANALYTICS_CURRENT_MARKET, note_id, searchCriteria, COMPLETED_OR_OPEN, google_map_array_list)
                    ANALYTICS_CURRENT_MARKET.ImageType = DataVisualization.Charting.ChartImageType.Jpeg

                    imgCnt += 1
                    sImageName = subscriptionInfo + commonEvo.GenerateFileName("image_" + imgCnt.ToString, ".jpg", False)
                    sImageMapPath = Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath")) + "\" + sImageName
                    sImageSrc = displayFolder + "/" + sImageName

                    ANALYTICS_CURRENT_MARKET_imageName = sImageSrc
                    ANALYTICS_CURRENT_MARKET.SaveImage(sImageMapPath, DataVisualization.Charting.ChartImageFormat.Jpeg)
                Else
                    current_market_chart = localDatalayer.views_analytics_graph_completed_current(Session.Item("CLIENT_AC_ID"), Me.ANALYTICS_CURRENT_MARKET, note_id, searchCriteria, COMPLETED_OR_OPEN, google_map_array_list)
                End If


                If is_graph_only_page = True Then
                    DisplayFunctions.load_google_chart(graph_panel, google_map_array_list, "", "Aircraft Value ($k)", "large_graph_div", 950, 550, "POINTS", 2, charting_string, Me.Page, Me.graph_update_panel, False, False)
                ElseIf Trim(report_to_do) = "Current Market" Then
                    DisplayFunctions.load_google_chart(model_reports_tab, google_map_array_list, "", "Aircraft Value ($k)", "chart_div_survey", 500, 250, "POINTS", 2, charting_string, Me.Page, Me.bottom_tab_update_panel, False, False)
                ElseIf Trim(report_to_do) = "All" Then
                    DisplayFunctions.load_google_chart(charter_tab, google_map_array_list, "Market Comparables", "Aircraft Value ($k)", "chart_div_current_all", 500, 250, "POINTS", 2, charting_string, Me.Page, Me.bottom_tab_update_panel, False, False)
                    Me.current_market_chart.Text = current_market_chart
                End If

            End If



            If Trim(report_to_do) = "Sold Comparables" Or Trim(report_to_do) = "All" Then

                If save_image = True Then
                    ANALYTICS_SOLD_COMPARABLES.Titles.Clear()
                    ANALYTICS_SOLD_COMPARABLES.Titles.Add("Sold Comparables")
                    localDatalayer.views_analytics_graph_2(Session.Item("CLIENT_AC_ID"), Me.ANALYTICS_SOLD_COMPARABLES, note_id, searchCriteria, "TRANS", Nothing, google_map_array_list, COMPLETED_OR_OPEN)
                    ANALYTICS_SOLD_COMPARABLES.ImageType = DataVisualization.Charting.ChartImageType.Jpeg

                    imgCnt += 1
                    sImageName = subscriptionInfo + commonEvo.GenerateFileName("image_" + imgCnt.ToString, ".jpg", False)
                    sImageMapPath = Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath")) + "\" + sImageName
                    sImageSrc = displayFolder + "/" + sImageName

                    ANALYTICS_SOLD_COMPARABLES_imageName = sImageSrc
                    ANALYTICS_SOLD_COMPARABLES.SaveImage(sImageMapPath, DataVisualization.Charting.ChartImageFormat.Jpeg)
                Else
                    localDatalayer.views_analytics_graph_2(Session.Item("CLIENT_AC_ID"), Me.ANALYTICS_SOLD_COMPARABLES, note_id, searchCriteria, "TRANS", Nothing, google_map_array_list, COMPLETED_OR_OPEN)
                End If

                If is_graph_only_page = True Then
                    DisplayFunctions.load_google_chart(graph_panel, google_map_array_list, "", "Aircraft Value ($k)", "large_graph_div", 950, 550, "POINTS", 3, charting_string, Me.Page, Me.graph_update_panel, False, False)

                ElseIf Trim(report_to_do) = "Sold Comparables" Then
                    DisplayFunctions.load_google_chart(model_reports_tab, google_map_array_list, "", "Aircraft Value ($k)", "chart_div_survey", 500, 230, "POINTS", 3, charting_string, Me.Page, Me.bottom_tab_update_panel, False, False)
                ElseIf Trim(report_to_do) = "All" Then
                    DisplayFunctions.load_google_chart(charter_tab, google_map_array_list, "Sold Comparables", "Aircraft Value ($k)", "chart_div_sold_all", 500, 230, "POINTS", 3, charting_string, Me.Page, Me.bottom_tab_update_panel, False, False)
                End If


            End If

            If Trim(COMPLETED_OR_OPEN) <> "C" Then

                If Trim(report_to_do) = "Market Status" Or Trim(report_to_do) = "All" Then

                    If save_image = True Then
                        ' set the title and load the data into the chart control 
                        ANALYTICS_MARKET_STATUS.Titles.Clear()
                        ANALYTICS_MARKET_STATUS.Titles.Add("Market Status")
                        localDatalayer.views_analytics_graph_market_status(Session.Item("CLIENT_AC_ID"), Me.ANALYTICS_MARKET_STATUS, avg_asking, avg_take, avg_sold, google_map_array_list, COMPLETED_OR_OPEN)
                        ANALYTICS_MARKET_STATUS.ImageType = DataVisualization.Charting.ChartImageType.Jpeg

                        imgCnt += 1
                        sImageName = subscriptionInfo + commonEvo.GenerateFileName("image_" + imgCnt.ToString, ".jpg", False)
                        sImageMapPath = Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath")) + "\" + sImageName
                        sImageSrc = displayFolder + "/" + sImageName

                        ANALYTICS_MARKET_STATUS_imageName = sImageSrc
                        ANALYTICS_MARKET_STATUS.SaveImage(sImageMapPath, DataVisualization.Charting.ChartImageFormat.Jpeg)
                    Else
                        localDatalayer.views_analytics_graph_market_status(Session.Item("CLIENT_AC_ID"), Me.ANALYTICS_MARKET_STATUS, avg_asking, avg_take, avg_sold, google_map_array_list, COMPLETED_OR_OPEN)
                    End If


                    If is_graph_only_page = True Then
                        DisplayFunctions.load_google_chart(graph_panel, google_map_array_list, "", "Aircraft Value ($k)", "large_graph_div", 950, 550, "POINTS", 4, charting_string, Me.Page, Me.graph_update_panel, False, False)
                    ElseIf Trim(report_to_do) = "Market Status" Then
                        DisplayFunctions.load_google_chart(model_reports_tab, google_map_array_list, "", "Aircraft Value ($k)", "chart_div_survey", 400, 230, "POINTS", 4, charting_string, Me.Page, Me.bottom_tab_update_panel, False, False)
                    ElseIf Trim(report_to_do) = "All" Then
                        DisplayFunctions.load_google_chart(charter_tab, google_map_array_list, "Market Status", "Aircraft Value ($k)", "chart_div_status_all", 400, 230, "POINTS", 4, charting_string, Me.Page, Me.bottom_tab_update_panel, False, False)
                    End If
                End If


                If Trim(report_to_do) = "Market Survey" Or Trim(report_to_do) = "All" Then
                    ' set the title and load the data into the chart control 
                    ANALYTICS_MARKET_SURVEY.Titles.Clear()
                    ANALYTICS_MARKET_SURVEY.Titles.Add("Market Survey")


                    If Trim(Request("show_my")) = "Y" Or Trim(Request("show_my")) = "" Then
                        Me.show_estimated.Checked = True
                        show_only_estimated = True
                    Else
                        Me.show_estimated.Checked = False
                    End If

                    Me.show_my.Visible = False       ' for now 


                    If is_graph_only_page = True And out_htmlString = "GRAPH_RE_RUN" Then
                        ' no need to re-run  -- unless my ac has changed
                    Else
                        localDatalayer.views_analytics_graph_2_Survey(Session.Item("CLIENT_AC_ID"), Me.ANALYTICS_MARKET_SURVEY, note_id, searchCriteria, ClientIDSToExclude, google_map_array_list, COMPLETED_OR_OPEN, RunModelOnValueOnly)
                    End If


                    If save_image = True Then
                        If Trim(report_to_do) = "Market Survey" Then
                            ANALYTICS_MARKET_SURVEY.Width = 500
                            ANALYTICS_MARKET_SURVEY.ImageType = DataVisualization.Charting.ChartImageType.Jpeg

                            imgCnt += 1
                            sImageName = subscriptionInfo + commonEvo.GenerateFileName("image_" + imgCnt.ToString, ".jpg", False)
                            sImageMapPath = Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath")) + "\" + sImageName
                            sImageSrc = displayFolder + "/" + sImageName

                            ANALYTICS_MARKET_SURVEY_imageName = sImageSrc
                            ANALYTICS_MARKET_SURVEY.SaveImage(sImageMapPath, DataVisualization.Charting.ChartImageFormat.Jpeg)
                        End If
                        ANALYTICS_MARKET_SURVEY.Width = 300
                        ANALYTICS_MARKET_SURVEY.ImageType = DataVisualization.Charting.ChartImageType.Jpeg

                        imgCnt += 1
                        sImageName = subscriptionInfo + commonEvo.GenerateFileName("image_" + imgCnt.ToString, ".jpg", False)
                        sImageMapPath = Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath")) + "\" + sImageName
                        sImageSrc = displayFolder + "/" + sImageName

                        ANALYTICS_MARKET_SURVEY_imageName = sImageSrc
                        ANALYTICS_MARKET_SURVEY.SaveImage(sImageMapPath, DataVisualization.Charting.ChartImageFormat.Jpeg)
                    End If



                    If is_graph_only_page = True Then

                        If Not IsPostBack Then
                            If Trim(Request("show_asking")) = "Y" Or Trim(Request("show_asking")) = "" Then
                                Me.show_asking.Checked = True
                                show_only_asking = True
                            Else
                                Me.show_asking.Checked = False
                            End If

                            If Trim(Request("show_take")) = "Y" Or Trim(Request("show_take")) = "" Then
                                Me.show_take.Checked = True
                                show_only_take = True
                            Else
                                Me.show_take.Checked = False
                            End If

                            If Trim(Request("show_estimated")) = "Y" Or Trim(Request("show_estimated")) = "" Then
                                Me.show_estimated.Checked = True
                                show_only_estimated = True
                            Else
                                Me.show_estimated.Checked = False
                            End If

                            Me.show_asking.Visible = True
                            Me.show_take.Visible = True
                            Me.show_estimated.Visible = True

                        End If


                        If Not IsNothing(Session("charting_string")) And Trim(google_map_array_list) = "" Then
                            google_map_array_list = Session("charting_string")
                        End If

                        DisplayFunctions.load_google_chart(graph_panel, google_map_array_list, "", "Aircraft Value ($k)", "large_graph_div", 950, 550, "POINTS", 5, charting_string, Me.Page, Me.graph_update_panel, False, show_only_asking, False, show_only_estimated, False, False, False, show_only_take, True)

                        Session("charting_string") = google_map_array_list
                    ElseIf Trim(report_to_do) = "Market Survey" Then
                        DisplayFunctions.load_google_chart(model_reports_tab, google_map_array_list, "", "Aircraft Value ($k)", "chart_div_survey", 560, 230, "POINTS", 5, charting_string, Me.Page, Me.bottom_tab_update_panel, True, False)
                    ElseIf Trim(report_to_do) = "All" Then
                        DisplayFunctions.load_google_chart(charter_tab, google_map_array_list, "Market Survey", "Aircraft Value ($k)", "chart_div_survey_all", 560, 230, "POINTS", 5, charting_string, Me.Page, Me.bottom_tab_update_panel, True, False)
                    End If

                End If

            End If


            If Trim(report_to_do) = "Recent Sales" Or Trim(report_to_do) = "All" Then

                If save_image = True Then
                    ANALYTICS_RECENT_SALES.Titles.Clear()
                    ANALYTICS_RECENT_SALES.Titles.Add("Recent Sales - Comparables")
                    localDatalayer.views_analytics_graph_2(Session.Item("CLIENT_AC_ID"), Me.ANALYTICS_RECENT_SALES, note_id, searchCriteria, "RECENT", extra_table_to_add, google_map_array_list, COMPLETED_OR_OPEN)
                    If Trim(report_to_do) = "Recent Sales" Then  ' change width
                        Me.ANALYTICS_RECENT_SALES.Width = 500
                        ANALYTICS_RECENT_SALES.ImageType = DataVisualization.Charting.ChartImageType.Jpeg

                        imgCnt += 1
                        sImageName = subscriptionInfo + commonEvo.GenerateFileName("image_" + imgCnt.ToString, ".jpg", False)
                        sImageMapPath = Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath")) + "\" + sImageName
                        sImageSrc = displayFolder + "/" + sImageName

                        ANALYTICS_RECENT_SALES_imageName = sImageSrc
                        ANALYTICS_RECENT_SALES.SaveImage(sImageMapPath, DataVisualization.Charting.ChartImageFormat.Jpeg)
                    End If

                    ANALYTICS_RECENT_SALES.ImageType = DataVisualization.Charting.ChartImageType.Jpeg

                    imgCnt += 1
                    sImageName = subscriptionInfo + commonEvo.GenerateFileName("image_" + imgCnt.ToString, ".jpg", False)
                    sImageMapPath = Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath")) + "\" + sImageName
                    sImageSrc = displayFolder + "/" + sImageName

                    ANALYTICS_RECENT_SALES_imageName = sImageSrc
                    ANALYTICS_RECENT_SALES.SaveImage(sImageMapPath, DataVisualization.Charting.ChartImageFormat.Jpeg)
                Else
                    localDatalayer.views_analytics_graph_2(Session.Item("CLIENT_AC_ID"), Me.ANALYTICS_RECENT_SALES, note_id, searchCriteria, "RECENT", extra_table_to_add, google_map_array_list, COMPLETED_OR_OPEN, False, RunModelOnValueOnly)
                End If

                If is_graph_only_page = True Then
                    DisplayFunctions.load_google_chart(graph_panel, google_map_array_list, "", "Aircraft Value ($k)", "large_graph_div", 950, 550, "POINTS", 6, charting_string, Me.Page, Me.graph_update_panel, False, False)
                ElseIf Trim(report_to_do) = "Recent Sales" Then
                    DisplayFunctions.load_google_chart(model_reports_tab, google_map_array_list, "", "Aircraft Value ($k)", "chart_div_survey", 560, 230, "POINTS", 6, charting_string, Me.Page, Me.bottom_tab_update_panel, True, False)
                ElseIf Trim(report_to_do) = "All" Then
                    DisplayFunctions.load_google_chart(charter_tab, google_map_array_list, "Sold Survey", "Aircraft Value ($k)", "chart_div_recent_all", 560, 230, "POINTS", 6, charting_string, Me.Page, Me.bottom_tab_update_panel, True, False)
                End If

            End If

            '  charting_test = charting_string

            If Trim(report_to_do) = "All" Then
                Call load_google_chart_all(operators_tab, charting_string)
                Me.all_google_charts.Visible = True
            End If



            If Trim(report_to_do) = "All" Then
                htmlOut.Append("<div style='height:370px; width:970px; overflow: auto;'>")
            End If

            htmlOut.Append("<table width='100%' border='0' cellpadding='2' cellspacing='9'>")
            htmlOut.Append("<tr valign='top'><td align='left' valign='top'>")
            htmlOut.Append("<table border='0' cellpadding='2' cellspacing='9'>")


            htmlOut.Append("<tr valign='top'><td valign='top' align='left'>")

            If Trim(report_to_do) = "Value History" Or Trim(report_to_do) = "All" Then
                htmlOut.Append("<table border='0' cellspacing='0' cellpadding='0'><tr valign='top'><td>")

                If Trim(report_to_do) = "All" Then
                    htmlOut.Append("<img src=""" + ANALYTICS_HISTORY_imageName + """ width=""280"" height=""280"" style=""height:280px; width:280px;"">")
                End If
                If Trim(report_to_do) = "Value History" Then
                    htmlOut.Append("</td><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td>" & aircraft_history_string)
                Else
                    htmlOut.Append("</td></tr><tr><td colspan='2'>" & aircraft_history_string)
                End If

                htmlOut.Append("</td></tr></table>")
            End If

            If Trim(report_to_do) = "All" Then
                htmlOut.Append("</td><td><div style='width:2px;height:500px;background-color:#D8D8D8;'>&nbsp;</div></td><td valign='top' align='left'>")
            End If

            If Trim(report_to_do) = "Current Market" Or Trim(report_to_do) = "All" Then

                htmlOut.Append("<table border='0' cellspacing='0' cellpadding='0'><tr valign='top'><td>")

                If Trim(report_to_do) = "All" Then
                    htmlOut.Append("<img src=""" + ANALYTICS_CURRENT_MARKET_imageName + """ width=""280"" height=""280"" style=""height:280px; width:280px;"">")
                End If

                If Trim(report_to_do) = "Current Market" Then
                Else
                    htmlOut.Append("</td></tr><tr><td>" & current_market_chart)
                End If

                htmlOut.Append("</td></tr></table>")
            End If

            If Trim(report_to_do) = "All" Then
                htmlOut.Append("</td><td><div style='width:2px;height:500px;background-color:#D8D8D8;'>&nbsp;</div></td><td valign='top' align='left'>")
            End If

            If Trim(report_to_do) = "Sold Comparables" Or Trim(report_to_do) = "All" Then


                htmlOut.Append("<table border='0' cellspacing='0' cellpadding='0'><tr valign='top'><td>")

                If Trim(report_to_do) = "All" Then
                    htmlOut.Append("<img src=""" + ANALYTICS_SOLD_COMPARABLES_imageName + """ width=""280"" height=""280"" style=""height:280px; width:280px;"">")
                End If

                htmlOut.Append("</td></tr></table>")

            End If

            If Trim(report_to_do) = "All" Then
                htmlOut.Append("</td><td><div style='width:2px;height:500px;background-color:#D8D8D8;'>&nbsp;</div></td><td valign='top' align='left'>")
            End If

            If Trim(report_to_do) = "Market Status" Or Trim(report_to_do) = "All" Then

                If Trim(report_to_do) = "All" Then
                    htmlOut.Append("<img src=""" + ANALYTICS_MARKET_STATUS_imageName + """ width=""280"" height=""280"" style=""height:280px; width:280px;"">")
                End If

            End If


            If Trim(report_to_do) = "All" Then
                htmlOut.Append("</td><td><div style='width:2px;height:500px;background-color:#D8D8D8;'>&nbsp;</div></td><td valign='top' align='left'>")
            End If

            If Trim(report_to_do) = "Market Survey" Or Trim(report_to_do) = "All" Then
                htmlOut.Append("<img src=""" + ANALYTICS_MARKET_SURVEY_imageName + """ width=""280"" height=""280"" style=""height:280px; width:280px;"">")
            End If

            If Trim(report_to_do) = "All" Then
                htmlOut.Append("</td><td><div style='width:2px;height:500px;background-color:#D8D8D8;'>&nbsp;</div></td><td valign='top' align='left'>")
            End If

            If Trim(report_to_do) = "Recent Sales" Or Trim(report_to_do) = "All" Then

                htmlOut.Append("<img src=""" + ANALYTICS_RECENT_SALES_imageName + """ width=""280"" height=""280"" style=""height:280px; width:280px;"">")

            End If

            htmlOut.Append("</td></tr></table>")
            htmlOut.Append("</td></tr></table>")

            If Trim(report_to_do) = "All" Then
                htmlOut.Append("</div>")
            End If

        Catch ex As Exception

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [Build_Market_trends_tab] : " + ex.Message

        Finally

        End Try

        out_htmlString = htmlOut.ToString

        htmlOut = Nothing

    End Sub

    Private Sub Build_Description_tab()

        Dim tempStr As String = ""

        Try

            '  tempStr = "<div style='height:240px; width:650px; overflow: auto;'>"
            tempStr = "<div class=""valueSpec aircraftListing Simplistic aircraftSpec gray_background viewBoxMargin"">"

            If CRMViewActive Then
                tempStr += JetnetSourceText
            End If


            tempStr += "<table width=""100%"" cellpadding=""0"" cellspacing=""0"" class='formatTable blue datagrid'><tr><td align=""center"" valign=""top""><div class=""Box"">"
            tempStr += "<table width=""95%"" cellspacing=""0"" cellpadding=""2"" class=""descriptionMobile"">"
            tempStr += "<tr class=""subHeader noBorder""><td colspan=""4""><div class=""subHeader"">DESCRIPTION</div></td></tr>"
            tempStr += "<tr><td><b>MANUFACTURER&nbsp;:&nbsp;</b></td><td>" + Amod_manufacturer.Trim + "</td>"
            tempStr += "<td><b>YEARS BUILT&nbsp;:&nbsp;</b></td><td>" + Amod_start_end_years.Trim + "</td></tr>"
            tempStr += "<tr><td><b>SER # RANGE&nbsp;:&nbsp;</b></td><td>" + Amod_ser_nbr_range.Trim + "</td>"
            tempStr += "<td><b>TYPE&nbsp;:&nbsp;</b></td><td>" + Amod_type_name.Trim + "</td></tr>"

            If String.IsNullOrEmpty(Amod_body_config.Trim) Then
                tempStr += "<tr><td><b>WEIGHT CLASS&nbsp;:&nbsp;</b></td><td>" + Amod_weight_class_name.Trim + "</td>"
                tempStr += "<td><b>General Market Price Range:&nbsp;</b></td><td>" + Amod_price_range.Trim + "</td></tr>"
            Else
                tempStr += "<tr><td><b>WEIGHT CLASS&nbsp;:&nbsp;</b></td><td>" + Amod_weight_class_name.Trim + "</td>"
                tempStr += "<td><b>BODY CONFIGURATION&nbsp;:&nbsp;</b></td><td>" + Amod_body_config.Trim + "</td></tr>"

                tempStr += "<tr><td>&nbsp;</td><td>&nbsp;</td><td><b>General Market Price Range:&nbsp;</b></td><td>" + Amod_price_range.Trim + "</td></tr>"
            End If



            ' tempStr += "<tr><td colspan=""4"" width=""100%"" height=""1"" bgcolor=""#67A0D9""></td></tr>"
            tempStr += "<tr><td colspan=""4"" align=""left"" valign=""top""><br>" + Amod_description.Trim + "</td></tr></table></div>"
            tempStr += "</td></tr></table></div>"
            '  tempStr += "</div>"

            view_description_label.Text = tempStr
        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [Build_Description_tab] : " + ex.Message
        End Try

    End Sub

    Private Sub Build_Charter_tab(ByRef searchCriteria As viewSelectionCriteriaClass, ByRef out_htmlString As String)

        Dim htmlOut As New StringBuilder

        Dim sCharterAircraftOwnershipHtml As String = ""
        Dim sCharterAircraftAboutHtml As String = ""
        Dim sCharterModelPicHtml As String = ""

        Dim sCharterCompaniesHtml As String = ""
        Dim sCharterCertificationsHtml As String = ""
        Dim sCharterLocationHtml As String = ""

        Dim sCharterAirframeHtml As String = ""
        Dim sCharterModelHtml As String = ""
        Dim sCharterFleetHtml As String = ""

        Dim sCharterCompanyInfo As String = ""

        Dim charter_functions As New charter_view_functions
        Dim market_functions As New market_model_functions

        Try

            charter_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            charter_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            charter_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            charter_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            charter_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

            If CRMViewActive Then
                htmlOut.Append(JetnetSourceText)
            End If

            htmlOut.Append("<table id=""charterViewOuterTable"" width=""100%"" cellpadding=""2"" cellspacing=""0"" class=""module"">")
            htmlOut.Append("<tr><td align=""left"" valign=""top"">")
            'htmlOut.Append(vbCrLf + "<script type='text/javascript' src='https://www.google.com/jsapi'></script>" + vbCrLf)

            htmlOut.Append("<table id=""charterViewLeftSideTable"" width=""100%"" cellpadding=""2"" cellspacing=""0""><tr>")

            If searchCriteria.ViewCriteriaAmodID = -1 And searchCriteria.ViewCriteriaCompanyID = 0 Then

                charter_functions.views_display_charter_companies(searchCriteria, sCharterCompaniesHtml)
                htmlOut.Append("<td align=""left"" valign=""top"">" + sCharterCompaniesHtml.Trim)

                charter_functions.views_display_charter_airframeType(searchCriteria, sCharterAirframeHtml)
                htmlOut.Append("</td><td align=""left"" valign=""top""><br />" + sCharterAirframeHtml.Trim)

                charter_functions.views_display_charter_location_table(searchCriteria, sCharterLocationHtml)
                htmlOut.Append("<br />" + sCharterLocationHtml.Trim)

                htmlOut.Append("</td></tr></table>") ' charterViewLeftSideTable
                htmlOut.Append("</td>")
                htmlOut.Append("<td align=""left"" valign=""top"" width=""33%"" style=""width: 33%;"">")

                htmlOut.Append("<table id=""charterViewRightSideTable"" width=""100%"" cellpadding=""2"" cellspacing=""0"">")

                charter_functions.views_display_charter_model(searchCriteria, sCharterModelHtml)
                htmlOut.Append("<tr><td align=""left"" valign=""top"">" + sCharterModelHtml.Trim + "</td></tr>")

                htmlOut.Append("</table>") ' charterViewRightSideTable

                htmlOut.Append("</td></tr></table>") ' charterViewOuterTable

            ElseIf searchCriteria.ViewCriteriaAmodID > -1 And searchCriteria.ViewCriteriaCompanyID > 0 Then

                htmlOut.Append("<td align=""left"" valign=""top"">")
                htmlOut.Append("<table id=""charterViewPicAndAboutTable"" width=""100%"" cellpadding=""2"" cellspacing=""0""><tr><td align=""center"" valign=""top"">")

                If ((View_ID > 2) And Not View_ID = 11) Then

                    localDatalayer.views_display_model_pic(searchCriteria, sCharterModelPicHtml)
                    htmlOut.Append(sCharterModelPicHtml)

                End If


                If searchCriteria.ViewID = 1 Then   ' addd MSw - 8/29/18
                Else

                    market_functions.views_display_fleet_market_summary(searchCriteria, sCharterAircraftOwnershipHtml, "")
                    If Not String.IsNullOrEmpty(sCharterAircraftOwnershipHtml) Then
                        htmlOut.Append("<div class=""valueSpec aircraftListing Simplistic gray_background viewBoxMargin smallSpaceText"">")
                        htmlOut.Append(sCharterAircraftOwnershipHtml)
                        htmlOut.Append("</div>")
                    End If


                    htmlOut.Append("</td>")

                    htmlOut.Append("<td align=""left"" valign=""top"">")

                    charter_functions.views_display_about_charter_model(searchCriteria, sCharterAircraftAboutHtml, isHeliOnlyProduct)
                    htmlOut.Append(sCharterAircraftAboutHtml.Trim)
                End If

                htmlOut.Append("</td></tr></table>") ' charterViewPicAndAboutTable

                htmlOut.Append("</td></tr>")
                htmlOut.Append("<tr><td align=""left"" valign=""top"">")
                htmlOut.Append("<table id=""charterViewDetailCompanyTable"" width=""100%"" cellpadding=""2"" cellspacing=""0"">")

                charter_functions.views_display_charter_companies(searchCriteria, sCharterCompaniesHtml)

                htmlOut.Append("<tr><td align=""left"" valign=""top"">" + sCharterCompaniesHtml.Trim + " - <a href=""help/helpexamples/Operator-Certifications.pdf"" target=""_blank"" title=""Operator Certification Descriptions"">Certification Descriptions</a></td></tr>")

                charter_functions.display_charter_certification_images(searchCriteria, sCharterCertificationsHtml)

                htmlOut.Append("<tr><td align=""left"" valign=""top"">" + sCharterCertificationsHtml.Trim + "</td></tr>")

                htmlOut.Append("<tr><td align=""left"" valign=""middle""><a href=""help/helpexamples/Operator-Certifications.pdf"" target=""_blank"" title=""Operator Certification Descriptions"">Operator Certification Descriptions</a></td></tr>")
                htmlOut.Append("</table>") ' charterViewDetailCompanyTable
                htmlOut.Append("</td></tr></table>") ' charterViewLeftSideTable
                htmlOut.Append("</td>")

                htmlOut.Append("<td align=""left"" valign=""top"" width=""30%"" style=""width: 30%;"">")
                htmlOut.Append("<table id=""charterViewRightSideTable"" width=""100%"" cellpadding=""2"" cellspacing=""0"">")

                charter_functions.views_display_charter_fleet(searchCriteria, sCharterFleetHtml)
                htmlOut.Append("<tr><td align=""left"" valign=""top"">" + sCharterFleetHtml.Trim + "</td></tr>")

                htmlOut.Append("</table>") ' charterViewRightSideTable

                htmlOut.Append("</td></tr></table>") ' charterViewOuterTable

            ElseIf searchCriteria.ViewCriteriaAmodID > -1 Then

                htmlOut.Append("<td align=""left"" valign=""top"">")
                htmlOut.Append("<table id=""charterViewModelSummaryTable"" width=""100%"" cellpadding=""2"" cellspacing=""0"" class=""module""><tr><td align=""left"" valign=""top"">")
                htmlOut.Append("<table id=""charterViewPicAndAboutTable"" width=""100%"" cellpadding=""2"" cellspacing=""0""><tr>")

                If ((View_ID > 2) And Not View_ID = 11) Then

                    localDatalayer.views_display_model_pic(searchCriteria, sCharterModelPicHtml)
                    htmlOut.Append("<td align=""center"" valign=""middle"">" + sCharterModelPicHtml + "</td>")

                End If

                If searchCriteria.ViewID = 1 Then
                Else
                    htmlOut.Append("<td align=""left"" valign=""top"">")

                    charter_functions.views_display_about_charter_model(searchCriteria, sCharterAircraftAboutHtml, isHeliOnlyProduct)

                    htmlOut.Append("<br />" + sCharterAircraftAboutHtml.Trim)

                    htmlOut.Append("</td></tr></table>") ' charterViewPicAndAboutTable
                End If

                If searchCriteria.ViewID = 1 Then
                Else
                    market_functions.views_display_fleet_market_summary(searchCriteria, sCharterAircraftOwnershipHtml, "")
                    If Not String.IsNullOrEmpty(sCharterAircraftOwnershipHtml) Then
                        htmlOut.Append("<div class=""valueSpec aircraftListing Simplistic gray_background viewBoxMargin smallSpaceText"">")
                        htmlOut.Append(sCharterAircraftOwnershipHtml)
                        htmlOut.Append("</div>")
                    End If
                End If


                htmlOut.Append("</td><td align=""left"" valign=""top"">")

                charter_functions.views_display_charter_location_table(searchCriteria, sCharterLocationHtml)
                htmlOut.Append("<br />" + sCharterLocationHtml.Trim)

                htmlOut.Append("</td></tr></table>") ' charterViewModelSummaryTable

                htmlOut.Append("</td></tr>")

                charter_functions.views_display_charter_companies(searchCriteria, sCharterCompaniesHtml)
                htmlOut.Append("<tr><td align=""left"" valign=""top"">" + sCharterCompaniesHtml.Trim + "</td></tr>")

                htmlOut.Append("</table>")  ' charterViewLeftSideTable
                htmlOut.Append("</td>")

                htmlOut.Append("<td align=""left"" valign=""top"" width=""30%"" style=""width: 30%;"">")
                htmlOut.Append("<table id=""charterViewRightSideTable"" width=""100%"" cellpadding=""2"" cellspacing=""0"" class=""module"">")

                charter_functions.views_display_charter_fleet(searchCriteria, sCharterFleetHtml)
                htmlOut.Append("<tr><td align=""left"" valign=""top"">" + sCharterFleetHtml.Trim + "</td></tr>")

                htmlOut.Append("</table>") ' charterViewRightSideTable

                htmlOut.Append("</td></tr></table>") ' charterViewOuterTable

            ElseIf searchCriteria.ViewCriteriaCompanyID > 0 Then

                htmlOut.Append("<tr><td align=""left"" valign=""top"" width=""34%"">")
                htmlOut.Append("<table id=""charterViewDetailCompanyTable"" width=""100%"" cellpadding=""2"" cellspacing=""0"">")

                charter_functions.views_display_charter_companies(searchCriteria, sCharterCompaniesHtml)

                htmlOut.Append("<tr><td align=""left"" valign=""top""><br />" + sCharterCompaniesHtml.Trim & " - <a href=""help/helpexamples/Operator-Certifications.pdf"" target=""_blank"" title=""Operator Certification Descriptions"">Certification Descriptions</a></td></tr>")

                charter_functions.display_charter_certification_images(searchCriteria, sCharterCertificationsHtml)

                htmlOut.Append("<tr><td align=""left"" valign=""top""><br />" + sCharterCertificationsHtml.Trim + "</td></tr>")

                '   htmlOut.Append("<tr><td align=""left"" valign=""middle""></td></tr>")

                charter_functions.views_display_charter_airframeType(searchCriteria, sCharterAirframeHtml)
                htmlOut.Append("<tr><td align=""left"" valign=""top""><br />" + sCharterAirframeHtml.Trim + "</td></tr>")

                htmlOut.Append("</table>") ' charterViewDetailCompanyTable

                htmlOut.Append("</table>") ' charterViewLeftSideTable
                htmlOut.Append("</td>")
                htmlOut.Append("<td align=""left"" valign=""top"" width=""34%"">")
                htmlOut.Append("<table id=""charterViewRightSideTable"" width=""100%"" cellpadding=""2"" cellspacing=""0"">")

                charter_functions.views_display_charter_model(searchCriteria, sCharterModelHtml)
                htmlOut.Append("<tr><td align=""left"" valign=""top""><br />" + sCharterModelHtml.Trim + "</td></tr>")

                htmlOut.Append("</table>") ' charterViewRightSideTable
                htmlOut.Append("</td><td align=""left"" valign=""top"" width=""34%"">")
                htmlOut.Append("<table id=""charterViewRightSideTable2"" width=""100%"" cellpadding=""2"" cellspacing=""0"">")

                charter_functions.views_display_charter_fleet(searchCriteria, sCharterFleetHtml)
                htmlOut.Append("<tr><td align=""left"" valign=""top"">" + sCharterFleetHtml.Trim + "</td></tr>")

                htmlOut.Append("</table>") ' charterViewRightSideTable2

                htmlOut.Append("</td></tr></table>") ' outter charter view table

            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [Build_Charter_tab2] : " + ex.Message
        End Try

        out_htmlString = htmlOut.ToString()
        htmlOut = Nothing

    End Sub

    Private Sub Build_Deliveries_tab(ByRef searchCriteria As viewSelectionCriteriaClass, ByRef out_htmlString As String)

        Dim htmlOut As New StringBuilder
        Dim sHtmlNewDeliveriesLineChart As String = ""
        Dim sHtmlNewDeliveriesBarChart As String = ""

        Dim sHtmlTop50NewDeliveriesModels As String = ""
        Dim sHtmlLatestDeliveries As String = ""
        Dim sHtmlNewDeliveriesByType As String = ""
        Dim sHtmlDeliveriesInOperation As String = ""

        Dim sHtmlHistoryLink As String = ""

        Dim deliveries_functions As New deliveries_view_functions

        Try

            deliveries_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            deliveries_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            deliveries_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            deliveries_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            deliveries_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

            deliveries_functions.includeLeases = deliveryViewIncludeLeases.Checked

            htmlOut.Append("<table id='deliveriesViewOuterTable' width=""100%"" cellpadding=""0"" cellspacing=""0"" class='module'><tr><td align=""left"" valign=""top"">")

            htmlOut.Append("<div class="" valueSpec aircraftListing Simplistic gray_background viewBoxMargin smallSpaceText"">")

            htmlOut.Append("<div style=""text-align: right; padding-right: 16px; padding-bottom: 6px;"">")

            sHtmlHistoryLink = deliveries_functions.build_deliveries_history_link(searchCriteria)

            htmlOut.Append(sHtmlHistoryLink)

            htmlOut.Append("</div>")

            htmlOut.Append("<table id='deliveriesInnerTable' width=""100%"" cellpadding=""2"" cellspacing=""2"" border=""0""><tr><td align=""left"" valign=""top"" width=""50%"">")

            'htmlOut.Append(vbCrLf + "<script type='text/javascript' src='https://www.google.com/jsapi'></script>" + vbCrLf)

            ' first column left side
            deliveries_functions.views_display_deliveries_line_chart(searchCriteria, sHtmlNewDeliveriesLineChartScript, sHtmlNewDeliveriesLineChart, 1)
            htmlOut.Append(sHtmlNewDeliveriesLineChart)

            htmlOut.Append("</td><td align=""left"" valign=""top"">")

            ' second column right side
            deliveries_functions.views_display_deliveries_bar_chart(searchCriteria, sHtmlNewDeliveriesBarChartScript, sHtmlNewDeliveriesBarChart, 2)
            htmlOut.Append(sHtmlNewDeliveriesBarChart)

            htmlOut.Append("</td></tr>")
            htmlOut.Append("<tr><td align =""left"" valign=""top"" colspan=""2"">")

            htmlOut.Append("<table id='deliveriesOtherTable' width=""100%"" cellpadding=""2"" cellspacing=""0"" border=""0"">")

            If localCriteria.ViewCriteriaAmodID = -1 Then  ' adjust to show operations graph and latest deliveries when 


                htmlOut.Append("<tr><td align=""left"" valign=""top"" width=""33%"">")

                deliveries_functions.views_display_top_deliveries_models(searchCriteria, sHtmlTop50NewDeliveriesModels, bHasMaster)
                htmlOut.Append(sHtmlTop50NewDeliveriesModels)

                htmlOut.Append("</td><td align=""left"" valign=""top"" width=""45%"">")

                deliveries_functions.views_display_latest_deliveries(searchCriteria, sHtmlLatestDeliveries)
                htmlOut.Append(sHtmlLatestDeliveries)

                htmlOut.Append("</td><td align=""left"" valign=""top"">")

                deliveries_functions.views_display_deliveries_by_type(searchCriteria, sHtmlNewDeliveriesByType)
                htmlOut.Append(sHtmlNewDeliveriesByType)
            Else
                htmlOut.Append("<tr><td align=""left"" valign=""top"" width=""50%"">")

                deliveries_functions.views_display_latest_deliveries(searchCriteria, sHtmlLatestDeliveries)
                htmlOut.Append(sHtmlLatestDeliveries)

                htmlOut.Append("</td><td align=""left"" valign=""top"">")

                deliveries_functions.views_display_deliveries_operational_trends_graph(searchCriteria, sHtmlNewDeliveriesOperationsScript, sHtmlDeliveriesInOperation, 3)
                htmlOut.Append(sHtmlDeliveriesInOperation)

            End If

            htmlOut.Append("</td></tr></table>") ' other view table 

            htmlOut.Append("</td></tr></table>") ' inner view table

            htmlOut.Append("</div>") ' div
            htmlOut.Append("</td></tr></table>") ' outter view table

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [Build_Deliveries_tab] : " + ex.Message
        Finally

        End Try

        out_htmlString = htmlOut.ToString()
        htmlOut = Nothing
        deliveries_functions = Nothing

    End Sub

    Private Sub Build_Financial_Documents_tab(ByRef searchCriteria As viewSelectionCriteriaClass, ByRef out_htmlString As String)

        Dim htmlOut As New StringBuilder

        Dim htmlOutTab1 As New StringBuilder
        Dim htmlOutTab2 As New StringBuilder
        Dim htmlOutTab3 As New StringBuilder
        Dim htmlOutTab4 As New StringBuilder

        Dim doc_view_header As String = ""

        Dim dtStart_date As String = ""
        Dim dtEnd_Date As String = ""

        Dim sHtmlTopfinancial As String = ""
        Dim sHtmlTopModels As String = ""
        Dim sHtmlDocumentsByMonth As String = ""
        Dim sHtmlDocumentsByType As String = ""
        Dim sHtmlGetMarketStatus As String = ""

        Dim sHtmlLeasesPerMonthChart As String = ""
        Dim sHtmlLeasesDueToExpire As String = ""
        Dim sHtmlLeasesExpired As String = ""
        Dim sHtmlLeasesPerMonthTx As String = ""

        Dim htmlModelDocuments As String = ""

        Dim clear_company_link As String = ""
        Dim clear_model_link As String = ""

        Dim financial_documents_functions As New financial_view_functions
        Dim lease_functions As New lease_view_functions
        Dim market_functions As New market_model_functions

        Try

            financial_documents_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            financial_documents_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            financial_documents_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            financial_documents_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            financial_documents_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

            lease_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            lease_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            lease_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            lease_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            lease_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

            market_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            market_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            market_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            market_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            market_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

            clear_company_link = "<a href='View_Template.aspx?ViewID=" + searchCriteria.ViewID.ToString + "&ViewName=" + searchCriteria.ViewName + "&viewCompany=0&viewCity=" + searchCriteria.ViewCriteriaCity + "&viewCountry=" + searchCriteria.ViewCriteriaCountry + "&viewAirframe=" + searchCriteria.ViewCriteriaAirframeTypeStr + "&amod_id=" + searchCriteria.ViewCriteriaAmodID.ToString + "'>Clear Institution</a>"
            clear_model_link = "<a href='View_Template.aspx?ViewID=" + searchCriteria.ViewID.ToString + "&ViewName=" + searchCriteria.ViewName + "&viewCompany=" + searchCriteria.ViewCriteriaCompanyID.ToString + "&viewCity=" + searchCriteria.ViewCriteriaCity + "&viewCountry=" + searchCriteria.ViewCriteriaCountry + "&viewAirframe=" + searchCriteria.ViewCriteriaAirframeTypeStr + "&amod_id=-1'>Clear Model</a>"

            If View_ID = 4 Then

                docHeaderLabel1.Text = "By Financial Institution"
                docHeaderLabel2.Text = "By Model"
                docHeaderLabel3.Text = "Lease Summary"
                docHeaderLabel4.Text = "Documents"

                Select Case docTabContainer.ActiveTabIndex
                    Case 0
                        htmlOutTab1.Append("<table id=""docTabTable1"" width=""100%"" cellpadding=""1"" cellspacing=""0"">")

                        financial_documents_functions.views_display_top_financial_institutions(searchCriteria, sHtmlTopfinancial)
                        htmlOutTab1.Append("<tr><td align=""center"" valign=""top"" rowspan=""3"" width=""50%"">" + IIf(searchCriteria.ViewCriteriaCompanyID > 0, " <div align=""right"" valign=""top"">" + clear_company_link + "</div><br/>", "") + IIf(searchCriteria.ViewCriteriaAmodID > 0, " <div align=""right"" valign=""top"">" + clear_model_link + "</div><br/>", "") + sHtmlTopfinancial + "</td></tr>")

                        financial_documents_functions.views_display_documents_by_month(searchCriteria, sHtmlDocumentsByMonth, Me.DOCS_BY_MONTH_GRAPH)
                        'financial_documents_functions.views_display_documents_by_month_pie_chart(searchCriteria, sHtmlDocumentsByMonth, 1)
                        htmlOutTab1.Append("<tr><td align=""center"" valign=""top"">" + sHtmlDocumentsByMonth + "</td></tr>")

                        financial_documents_functions.views_display_top_document_types(searchCriteria, sHtmlDocumentsByType)
                        htmlOutTab1.Append("<tr><td align=""center"" valign=""top"">" + sHtmlDocumentsByType + "</td></tr>")

                        htmlOutTab1.Append("</table>")

                        docContentLabel1.Text = htmlOutTab1.ToString
                    Case 1
                        htmlOutTab2.Append("<table id=""docTabTable2"" width=""100%"" cellpadding=""1"" cellspacing=""0"">")

                        financial_documents_functions.views_display_top_document_models(searchCriteria, sHtmlTopModels)
                        htmlOutTab2.Append("<tr><td align=""center"" valign=""top"" rowspan=""3"" width=""50%"">" + IIf(searchCriteria.ViewCriteriaCompanyID > 0, " <div align=""right"" valign=""top"">" + clear_company_link + "</div><br/>", "") + IIf(searchCriteria.ViewCriteriaAmodID > 0, " <div align=""right"" valign=""top"">" + clear_model_link + "</div><br/>", "") + sHtmlTopModels + "</td></tr>")

                        financial_documents_functions.views_display_documents_by_month(searchCriteria, sHtmlDocumentsByMonth, Me.DOCS_BY_MONTH_GRAPH)
                        'financial_documents_functions.views_display_documents_by_month_pie_chart(searchCriteria, sHtmlDocumentsByMonth, 2)
                        htmlOutTab2.Append("<tr><td align=""center"" valign=""top"">" + sHtmlDocumentsByMonth + "</td></tr>")

                        financial_documents_functions.views_display_top_document_types(searchCriteria, sHtmlDocumentsByType)
                        htmlOutTab2.Append("<tr><td align=""center"" valign=""top"">" + sHtmlDocumentsByType + "</td></tr>")

                        htmlOutTab2.Append("</table>")

                        docContentLabel2.Text = htmlOutTab2.ToString
                    Case 2
                        htmlOutTab3.Append("<table id=""docTabTable3"" width=""100%"" cellpadding=""1"" cellspacing=""0"">")

                        lease_functions.views_display_leases_by_month_chart(searchCriteria, sHtmlLeasesPerMonthChart, Me.LEASES_SOLD_PER_MONTH)
                        htmlOutTab3.Append("<tr><td align=""center"" valign=""top"" rowspan=""3"" width=""50%"">" + sHtmlLeasesPerMonthChart + "</td></tr>")

                        lease_functions.views_display_leases_due_to_expire(searchCriteria, False, sHtmlLeasesDueToExpire)

                        If sHtmlLeasesDueToExpire.ToUpper.Trim.Contains("NO LEASES") Then
                            lease_functions.views_display_leases_due_to_expire(searchCriteria, True, sHtmlLeasesDueToExpire)
                            htmlOutTab3.Append("<tr><td align=""center"" valign=""top"">" + sHtmlLeasesDueToExpire + "</td></tr>")
                        Else
                            htmlOutTab3.Append("<tr><td align=""center"" valign=""top"">" + sHtmlLeasesDueToExpire + "</td></tr>")
                        End If

                        lease_functions.views_display_leases_expired(searchCriteria, False, sHtmlLeasesExpired)

                        If sHtmlLeasesExpired.ToUpper.Trim.Contains("NO LEASES") Then
                            lease_functions.views_display_leases_expired(searchCriteria, True, sHtmlLeasesExpired)
                            htmlOutTab3.Append("<tr><td align=""center"" valign=""top"">" + sHtmlLeasesExpired + "</td></tr>")
                        Else
                            htmlOutTab3.Append("<tr><td align=""center"" valign=""top"">" + sHtmlLeasesExpired + "</td></tr>")
                        End If

                        htmlOutTab3.Append("</table>")

                        docContentLabel3.Text = htmlOutTab3.ToString
                    Case 3
                        htmlOutTab4.Append("<table id=""docTabTable4"" width=""100%"" cellpadding=""1"" cellspacing=""0"">")

                        financial_documents_functions.views_display_transaction_documents(searchCriteria, htmlModelDocuments)
                        htmlOutTab4.Append("<tr><td align=""center"" valign=""top"">" + htmlModelDocuments + "</td></tr>")

                        htmlOutTab4.Append("</table>")

                        docContentLabel4.Text = htmlOutTab4.ToString

                End Select




            Else

                'doc_view_header = financial_documents_functions.views_build_documents_header(searchCriteria)

                If (View_ID < 2) Or View_ID = 11 Then
                    htmlOut.Append("<div style='height:370px; width:100%; overflow: auto;'>")
                End If

                If CRMViewActive Then
                    htmlOut.Append(JetnetSourceText)
                End If

                htmlOut.Append("<table id='financialDocsViewOuterTable' width=""100%"" cellpadding=""0"" cellspacing=""0"" class='module'><tr><td align=""left"" valign=""top"">")
                htmlOut.Append("<table id='financialDocsViewInnerTable' width=""100%"" cellpadding=""0"" cellspacing=""0"">")
                htmlOut.Append("<tr><td width=""33%"" align=""left"" valign=""top"">")

                htmlOut.Append("<table id='financialDocsViewLeftSideTable' width='100%' cellpadding='1' cellspacing='0'>")

                financial_documents_functions.views_display_top_financial_institutions(searchCriteria, sHtmlTopfinancial)
                htmlOut.Append("<tr><td align=""center"" valign=""top"">" + sHtmlTopfinancial + "</td></tr>")

                If searchCriteria.ViewCriteriaCompanyID > 0 Then
                    htmlOut.Append("<tr><td align=""right"" valign=""top"">" + clear_company_link + "</td></tr>")
                End If

                financial_documents_functions.views_display_top_document_models(searchCriteria, sHtmlTopModels)
                htmlOut.Append("<tr><td align=""center"" valign=""top"">" + sHtmlTopModels + "</td></tr>")

                If searchCriteria.ViewCriteriaAmodID > 0 Then
                    htmlOut.Append("<tr><td align=""right"" valign=""top"">" + clear_model_link + "</td></tr>")
                End If

                htmlOut.Append("</table>")

                htmlOut.Append("</td><td width=""33%"" align=""left"" valign=""top"">")

                htmlOut.Append("<table id='financialDocsViewMiddleTable' width='100%' cellpadding='1' cellspacing='0'>")

                financial_documents_functions.views_display_documents_by_month_pie_chart(searchCriteria, sHtmlDocumentsByMonth, 1)
                htmlOut.Append("<tr><td align=""center"" valign=""top"">" + sHtmlDocumentsByMonth + "</td></tr>")

                financial_documents_functions.views_display_top_document_types(searchCriteria, sHtmlDocumentsByType)
                htmlOut.Append("<tr><td align=""center"" valign=""top"">" + sHtmlDocumentsByType + "</td></tr>")

                If searchCriteria.ViewCriteriaCompanyID = 0 Then

                    lease_functions.views_display_leases_by_month_chart(searchCriteria, sHtmlLeasesPerMonthChart, Me.LEASES_SOLD_PER_MONTH)
                    htmlOut.Append("<tr><td align=""center"" valign=""top"">" + sHtmlLeasesPerMonthChart + "</td></tr>")

                    lease_functions.views_display_leases_due_to_expire(searchCriteria, False, sHtmlLeasesDueToExpire)

                    If sHtmlLeasesDueToExpire.ToUpper.Trim.Contains("NO LEASES") Then
                        lease_functions.views_display_leases_due_to_expire(searchCriteria, True, sHtmlLeasesDueToExpire)
                        htmlOut.Append("<tr><td align=""center"" valign=""top"">" + sHtmlLeasesDueToExpire + "</td></tr>")
                    Else
                        htmlOut.Append("<tr><td align=""center"" valign=""top"">" + sHtmlLeasesDueToExpire + "</td></tr>")
                    End If

                    lease_functions.views_display_leases_expired(searchCriteria, False, sHtmlLeasesExpired)

                    If sHtmlLeasesExpired.ToUpper.Trim.Contains("NO LEASES") Then
                        lease_functions.views_display_leases_expired(searchCriteria, True, sHtmlLeasesExpired)
                        htmlOut.Append("<tr><td align=""center"" valign=""top"">" + sHtmlLeasesExpired + "</td></tr>")
                    Else
                        htmlOut.Append("<tr><td align=""center"" valign=""top"">" + sHtmlLeasesExpired + "</td></tr>")
                    End If

                End If

                htmlOut.Append("</table>")

                htmlOut.Append("</td><td width=""33%"" align=""left"" valign=""top"">")
                htmlOut.Append("<table id='financialDocsViewRightTable' width='100%' cellpadding='1' cellspacing='0'>")

                financial_documents_functions.views_display_transaction_documents(searchCriteria, htmlModelDocuments)
                htmlOut.Append("<tr><td align=""center"" valign=""top"">" + htmlModelDocuments + "</td></tr>")

                htmlOut.Append("</table>")

                htmlOut.Append("</td></tr></table>") ' inner view table
                htmlOut.Append("</td></tr></table>") ' outter view table

                If (View_ID < 2) Or View_ID = 11 Then
                    htmlOut.Append("</div>")
                End If

            End If

            out_htmlString = htmlOut.ToString()
            htmlOut = Nothing
            financial_documents_functions = Nothing
            lease_functions = Nothing
            market_functions = Nothing

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [Build_Documents_tab] : " + ex.Message
        Finally

        End Try

    End Sub

    Private Sub Build_Financial_Market_tab(ByRef searchCriteria As viewSelectionCriteriaClass, ByRef out_htmlString As String)

        Dim htmlOut As New StringBuilder
        Dim sHtmlModelDocuments As String = ""
        Dim sHtmlLeasesDueToExpire As String = ""
        Dim sHtmlLeasesExpired As String = ""
        Dim sHtmlLeasesPerMonthTx As String = ""
        Dim sHtmlUpDown As String = ""
        Dim sHtmlForSaleGraph As String = ""
        Dim sHtmlNewUsedPieChart As String = ""
        Dim sHtmlTopfinancial As String = ""
        Dim sHtmlModelPic As String = ""
        Dim get_market_status As String = ""
        Dim get_fleet_market_status As String = ""

        Dim imgCnt As Integer = 0

        Dim sImageMapPath As String = ""
        Dim sImageSrc As String = ""
        Dim sImageName As String = ""

        Dim subscriptionInfo As String = Session.Item("localUser").crmSubSubID.ToString + "_" + Session.Item("localUser").crmUserLogin.ToString.Trim + "_" + Session.Item("localUser").crmSubSeqNo.ToString + "_"
        Dim displayFolder As String = HttpContext.Current.Application.Item("crmClientSiteData").ClientFullHostName + HttpContext.Current.Session.Item("MarketSummaryFolderVirtualPath")

        Dim financial_documents_functions As New financial_view_functions
        Dim lease_functions As New lease_view_functions
        Dim market_functions As New market_model_functions

        Try

            lease_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            lease_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            lease_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            lease_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            lease_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

            financial_documents_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            financial_documents_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            financial_documents_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            financial_documents_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            financial_documents_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

            market_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            market_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            market_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            market_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            market_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

            htmlOut.Append("<table id='financialMarketViewOuterTable' width=""100%"" cellpadding=""0"" cellspacing=""0"" class='module'><tr><td align=""left"" valign=""top"">")
            htmlOut.Append("<table id='financialMarketViewInnerTable' width=""100%"" cellpadding=""0"" cellspacing=""0""><tr><td align=""left"" valign=""top"" colspan='3'>")

            'htmlOut.Append(vbCrLf + "<script type='text/javascript' src='https://www.google.com/jsapi'></script>" + vbCrLf)

            htmlOut.Append("</tr></td>")

            htmlOut.Append("<tr><td align='left' valign='top' colspan='3'>")
            htmlOut.Append("<table id='Column_2_Middle' width='100%' cellpadding='1' cellspacing='0' class='module'>")

            If searchCriteria.ViewCriteriaAmodID > -1 Then
                htmlOut.Append("<tr><td align='center' valign='top' width='33%'>")
                market_functions.views_display_market_up_down_one_model(searchCriteria, sHtmlUpDown)
                htmlOut.Append(sHtmlUpDown)

                localDatalayer.views_display_model_pic(searchCriteria, sHtmlModelPic)
                htmlOut.Append("<br /><br />" + sHtmlModelPic)

                market_functions.views_display_fleet_market_summary(searchCriteria, get_fleet_market_status, get_market_status)
                htmlOut.Append("<br /><br />" + get_fleet_market_status)
                htmlOut.Append("</td><td align='left' valign='top' width='33%'>")

                htmlOut.Append("<table callspacing='0' cellpadding='0'><tr><td>")
                htmlOut.Append(get_market_status)
                htmlOut.Append("</td></tr><tr>")

                PER_MONTH.Titles.Clear()
                PER_MONTH.Titles.Add("Sold Per Month (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
                market_functions.views_display_sold_per_month_graph(searchCriteria, True, Me.PER_MONTH)
                PER_MONTH.ImageType = DataVisualization.Charting.ChartImageType.Jpeg

                imgCnt += 1
                sImageName = subscriptionInfo + commonEvo.GenerateFileName("image_" + imgCnt.ToString, ".jpg", False)
                sImageMapPath = Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath")) + "\" + sImageName
                sImageSrc = displayFolder + "/" + sImageName

                PER_MONTH.SaveImage(sImageMapPath, DataVisualization.Charting.ChartImageFormat.Jpeg)

                htmlOut.Append("<td valign='top' align='center'>")
                htmlOut.Append("<img src=""" + sImageSrc + """ width=""260"" height=""260"" style=""height:260px; width:260px;"">")
                htmlOut.Append("</td></tr></table>")

            Else
                htmlOut.Append("<tr><td align='center' valign='top' width='55%'>")
                market_functions.views_display_market_up_down(searchCriteria, sHtmlUpDown)
                htmlOut.Append(sHtmlUpDown)
            End If

            If searchCriteria.ViewCriteriaAmodID > -1 Then
                htmlOut.Append("</td><td align='left' valign='top' width='33%'>")
                market_functions.views_display_for_sale_graphs(searchCriteria, sHtmlForSaleGraph, 1)
                htmlOut.Append(sHtmlForSaleGraph)
            Else
                htmlOut.Append("</td><td align='left' valign='top'>")
                market_functions.views_display_for_sale_graphs(searchCriteria, sHtmlForSaleGraph, 1)
                htmlOut.Append(sHtmlForSaleGraph)
            End If

            htmlOut.Append("</td></tr>")

            htmlOut.Append("</table></td></tr>")
            htmlOut.Append("<tr><td align='left' valign='top' width='33%'>")

            If searchCriteria.ViewCriteriaAmodID > -1 Then
                htmlOut.Append("<table width='100%' cellpadding='1' cellspacing='0' class='module'>")
                htmlOut.Append("<tr>")

                market_functions.views_display_leased_per_month_transactions(searchCriteria, sHtmlLeasesPerMonthTx, 4)
                htmlOut.Append("<td valign='top' align='center'>" + sHtmlLeasesPerMonthTx + "</td>")

                htmlOut.Append("</tr><tr>")

                lease_functions.views_display_leases_due_to_expire(searchCriteria, False, sHtmlLeasesDueToExpire)

                If sHtmlLeasesDueToExpire.ToUpper.Trim.Contains("NO LEASES") Then
                    lease_functions.views_display_leases_due_to_expire(searchCriteria, True, sHtmlLeasesDueToExpire)
                    htmlOut.Append("<td valign='top' align='center'>" + sHtmlLeasesDueToExpire + "</td>")
                Else
                    htmlOut.Append("<td valign='top' align='center'>" + sHtmlLeasesDueToExpire + "</td>")
                End If

                htmlOut.Append("</tr><tr>")

                lease_functions.views_display_leases_expired(searchCriteria, False, sHtmlLeasesExpired)

                If sHtmlLeasesExpired.ToUpper.Trim.Contains("NO LEASES") Then
                    lease_functions.views_display_leases_expired(searchCriteria, True, sHtmlLeasesExpired)
                    htmlOut.Append("<td valign='top' align='center'>" + sHtmlLeasesExpired + "</td>")
                Else
                    htmlOut.Append("<td valign='top' align='center'>" + sHtmlLeasesExpired + "</td>")
                End If

                htmlOut.Append("</tr>")
                htmlOut.Append("</table></td><td align='left' valign='top' width='33%'>")
                htmlOut.Append("<table width='100%' cellpadding='1' cellspacing='0' class='module'>")
                htmlOut.Append("<tr>")

                market_functions.views_display_new_vs_used_piechart(searchCriteria, sHtmlNewUsedPieChart, 5)
                htmlOut.Append("<td valign='top' align='center'>" + sHtmlNewUsedPieChart + "</td>")

                htmlOut.Append("</tr>")
                htmlOut.Append("<tr>")

                financial_documents_functions.views_display_top_financial_institutions(searchCriteria, sHtmlTopfinancial)
                htmlOut.Append("<td valign='top' align='center'>" + sHtmlTopfinancial + "</td>")

                htmlOut.Append("</tr>")
                htmlOut.Append("</table>")
                htmlOut.Append("</td><td align='left' valign='top' width='33%'>")
                htmlOut.Append("<table width='100%' cellpadding='1' cellspacing='0' class='module'>")

                financial_documents_functions.views_display_transaction_documents(searchCriteria, sHtmlModelDocuments)
                htmlOut.Append(sHtmlModelDocuments)

                htmlOut.Append("</tr></td>")
                htmlOut.Append("</table>")

            Else

                htmlOut.Append("<table width='100%' cellpadding='1' cellspacing='0' class='module'>")
                htmlOut.Append("<tr>")

                PER_MONTH.Titles.Clear()
                PER_MONTH.Titles.Add("Sold Per Month (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
                market_functions.views_display_sold_per_month_graph(searchCriteria, True, Me.PER_MONTH)
                PER_MONTH.ImageType = DataVisualization.Charting.ChartImageType.Jpeg

                imgCnt += 1
                sImageName = subscriptionInfo + commonEvo.GenerateFileName("image_" + imgCnt.ToString, ".jpg", False)
                sImageMapPath = Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath")) + "\" + sImageName
                sImageSrc = displayFolder + "/" + sImageName

                PER_MONTH.SaveImage(sImageMapPath, DataVisualization.Charting.ChartImageFormat.Jpeg)

                htmlOut.Append("<td valign='top' align='center'>")
                htmlOut.Append("<img src=""" + sImageSrc + """ width=""260"" height=""260"" style=""height:260px; width:260px;"">")
                htmlOut.Append("</td></tr><tr>")

                financial_documents_functions.views_display_top_financial_institutions(searchCriteria, sHtmlTopfinancial)
                htmlOut.Append("<td valign='top' align='center'>" + sHtmlTopfinancial + "</td>")

                htmlOut.Append("</tr>")
                htmlOut.Append("</table>")
                htmlOut.Append("</td><td align='left' valign='top' width='33%'>")
                htmlOut.Append("<table width='100%' cellpadding='1' cellspacing='0' class='module'>")
                htmlOut.Append("<tr>")

                market_functions.views_display_leased_per_month_transactions(searchCriteria, sHtmlLeasesPerMonthTx, 4)
                htmlOut.Append("<td valign='top' align='center'>" + sHtmlLeasesPerMonthTx + "</td>")

                htmlOut.Append("</tr><tr>")

                lease_functions.views_display_leases_due_to_expire(searchCriteria, False, sHtmlLeasesDueToExpire)

                If sHtmlLeasesDueToExpire.ToUpper.Trim.Contains("NO LEASES") Then
                    lease_functions.views_display_leases_due_to_expire(searchCriteria, True, sHtmlLeasesDueToExpire)
                    htmlOut.Append("<td valign='top' align='center'>" + sHtmlLeasesDueToExpire + "</td>")
                Else
                    htmlOut.Append("<td valign='top' align='center'>" + sHtmlLeasesDueToExpire + "</td>")
                End If

                htmlOut.Append("</tr><tr>")

                lease_functions.views_display_leases_expired(searchCriteria, False, sHtmlLeasesExpired)

                If sHtmlLeasesExpired.ToUpper.Trim.Contains("NO LEASES") Then
                    lease_functions.views_display_leases_expired(searchCriteria, True, sHtmlLeasesExpired)
                    htmlOut.Append("<td valign='top' align='center'>" + sHtmlLeasesExpired + "</td>")
                Else
                    htmlOut.Append("<td valign='top' align='center'>" + sHtmlLeasesExpired + "</td>")
                End If

                htmlOut.Append("</tr>")
                htmlOut.Append("</table></td>")
                htmlOut.Append("<td align='left' valign='top' width='33%'>")
                htmlOut.Append("<table width='100%' cellpadding='1' cellspacing='0' class='module'>")
                htmlOut.Append("<tr>")

                market_functions.views_display_new_vs_used_piechart(searchCriteria, sHtmlNewUsedPieChart, 5)
                htmlOut.Append("<td valign='top' align='center'>" + sHtmlNewUsedPieChart + "</td>")

                htmlOut.Append("<tr>")

                financial_documents_functions.views_display_transaction_documents(searchCriteria, sHtmlModelDocuments)
                htmlOut.Append(sHtmlModelDocuments)

                htmlOut.Append("</tr></td>")
                htmlOut.Append("</table>")
            End If

            htmlOut.Append("</td></tr></table>") ' inner view table
            htmlOut.Append("</td></tr></table>") ' outter view table

            out_htmlString = htmlOut.ToString()
            htmlOut = Nothing

            financial_documents_functions = Nothing
            lease_functions = Nothing
            market_functions = Nothing

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [Build_Financial_Market_tab] : " + ex.Message
        Finally

        End Try

    End Sub

    Private Sub Build_Fleet_tab()

        Dim tempStr As String = ""

        Try

            'tempStr = "<div style='height:240px; width:650px; overflow: auto;'>"
            'If CRMViewActive Then
            '  tempStr += JetnetClientSourceText
            'End If
            tempStr += "<table width=""100%"" cellpadding=""0"" cellspacing=""0""><tr><td align=""left"" valign=""top""><div class=""valueSpec aircraftListing Simplistic aircraftSpec gray_background"">"
            tempStr += Build_FleetMarketSummary_text
            tempStr += "</div></td></tr></table>"
            'tempStr += "</div>"

            view_fleet_label.Text = tempStr

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [Build_Fleet_tab] : " + ex.Message
        End Try

    End Sub

    Private Sub Build_Flight_tab(ByRef searchCriteria As viewSelectionCriteriaClass)

        Dim htmlOut As New StringBuilder
        Dim use_faa_data As Boolean = False

        Dim utilization_functions As New utilization_view_functions
        Dim graphID As Integer = 1

        Dim sTimeSpan As String = ""

        Try

            utilization_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            utilization_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            utilization_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            utilization_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            utilization_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

            Dim htmlFlightActivity As String = ""
            Dim htmlFlightUtilizationGraph As String = ""
            Dim htmlFlightUtilizationGraphScript As String = ""
            Dim htmlFlightUtilizationFunctionScript As String = ""
            Dim htmlFlightUtilization As String = ""
            flightActivityContainer.Visible = True

            If View_ID = 1 Then
                utilizationGraphControls.Visible = True 'this means we have the dropdown control for the graph.
            End If
            If Trim(Session.Item("useFAAFlightData")) <> "" And Trim(Session.Item("useFAAFlightData")) <> "ARGUS" Then
                use_faa_data = True
            End If

            If bFromUtilizationTab Then
                If Not IsNothing(HttpContext.Current.Request.Item("utilizationGraphRange")) Then
                    If Not String.IsNullOrEmpty(HttpContext.Current.Request.Item("utilizationGraphRange").ToString.Trim) Then
                        sTimeSpan = CInt(HttpContext.Current.Request.Item("utilizationGraphRange").ToString.Trim)
                    End If
                End If
            End If

            If String.IsNullOrEmpty(sTimeSpan.Trim) Then
                sTimeSpan = "2"
                If View_ID = 1 And Page.IsPostBack Then 'Just in case a search of model occurs when the graph dropdown is changed.
                    sTimeSpan = FlightUtilizationGraphDropdown.SelectedValue
                End If
            End If

            utilization_functions.views_display_flight_activity(searchCriteria, htmlFlightActivity, use_faa_data, Session.Item("localSubscription").crmSubinst_FAA_data_date)

            'htmlOut.Append("<table width=""100%"" cellpadding=""0"" cellspacing=""0"" class=""module""><tr><td align=""left"" valign=""top"" width=""30%"">")
            'htmlOut.Append(vbCrLf + "<script type='text/javascript' src='https://www.google.com/jsapi'></script>" + vbCrLf)
            flightActivityTable.Text = htmlFlightActivity
            'htmlOut.Append("</td><td align=""left"" valign=""top"">")

            'htmlOut.Append("Calendar Years&nbsp;:&nbsp;<select size=""1"" name=""utilizationGraphRange"" id=""utilizationGraphRangeID"" title=""Calendar Years"" onchange='javacript:function displayRange(url) {  $(""#DivLoadingMessage"").css(""display"", ""block"");window.location = url; } displayRange(this.value);'>")
            'htmlOut.Append("<option " + IIf(sTimeSpan.Contains("2"), "selected=""selected""", "") + "value=""view_template.aspx?ViewID=" + searchCriteria.ViewID.ToString + "&ViewName=" + searchCriteria.ViewName + "&onUtilizationTab=" + IIf(localCriteria.ViewID < 2, "true", "false") + "&utilizationGraphRange=2&amod_id=" + searchCriteria.ViewCriteriaAmodID.ToString + """>2 Years</option>")
            'htmlOut.Append("<option " + IIf(sTimeSpan.Contains("3"), "selected=""selected""", "") + "value=""view_template.aspx?ViewID=" + searchCriteria.ViewID.ToString + "&ViewName=" + searchCriteria.ViewName + "&onUtilizationTab=" + IIf(localCriteria.ViewID < 2, "true", "false") + "&utilizationGraphRange=3&amod_id=" + searchCriteria.ViewCriteriaAmodID.ToString + """>3 Years</option>")
            'htmlOut.Append("<option " + IIf(sTimeSpan.Contains("4"), "selected=""selected""", "") + "value=""view_template.aspx?ViewID=" + searchCriteria.ViewID.ToString + "&ViewName=" + searchCriteria.ViewName + "&onUtilizationTab=" + IIf(localCriteria.ViewID < 2, "true", "false") + "&utilizationGraphRange=4&amod_id=" + searchCriteria.ViewCriteriaAmodID.ToString + """>4 Years</option>")
            'htmlOut.Append("<option " + IIf(sTimeSpan.Contains("5"), "selected=""selected""", "") + "value=""view_template.aspx?ViewID=" + searchCriteria.ViewID.ToString + "&ViewName=" + searchCriteria.ViewName + "&onUtilizationTab=" + IIf(localCriteria.ViewID < 2, "true", "false") + "&utilizationGraphRange=5&amod_id=" + searchCriteria.ViewCriteriaAmodID.ToString + """>5 Years</option>")
            'htmlOut.Append("</select><br /><br />")

            utilization_functions.views_display_flight_utilization_graph(searchCriteria, htmlFlightUtilizationFunctionScript, htmlFlightUtilizationGraph, graphID, "", bFromUtilizationTab, False, IIf(View_ID = 1 And Page.IsPostBack, sTimeSpan, ""))

            htmlFlightUtilizationGraphScript = vbCrLf + "<script type=""text/javascript"">" + vbCrLf
            htmlFlightUtilizationGraphScript += "$(document).ready(function(){" + vbCrLf
            htmlFlightUtilizationGraphScript += " google.setOnLoadCallback(drawVisualization" + graphID.ToString + ");" + vbCrLf
            htmlFlightUtilizationGraphScript += "});" + vbCrLf
            htmlFlightUtilizationGraphScript += htmlFlightUtilizationFunctionScript.Trim
            htmlFlightUtilizationGraphScript += "</script>" + vbCrLf

            System.Web.UI.ScriptManager.RegisterStartupScript(bottom_tab_update_panel, Me.GetType(), "showUtilizationGraph" + graphID.ToString, htmlFlightUtilizationGraphScript, False)

            utilization_graph.Text = (htmlFlightUtilizationGraph)
            'htmlOut.Append("</td></tr></table>")

            utilization_functions.views_display_flight_utilization(searchCriteria, htmlFlightUtilization)

            UtilizationJSCheck()

            htmlOut.Append("<table width=""100%"" cellpadding=""0"" cellspacing=""0"" class=""module""><tr><td align=""left"" valign=""top"">")
            htmlOut.Append(htmlFlightUtilization)
            htmlOut.Append("</td></tr></table>")

            utilization_label.Text = htmlOut.ToString()

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [Build_Flight_tab] : " + ex.Message
        End Try

        utilization_functions = Nothing
        htmlOut = Nothing

    End Sub

    Private Sub FlightUtilizationGraphDropdown_SelectedIndexChanged(sender As Object, e As EventArgs) Handles FlightUtilizationGraphDropdown.SelectedIndexChanged
        Dim graphID As Integer = 1

        Dim utilization_functions As New utilization_view_functions
        Dim htmlFlightUtilizationGraphScript As String = ""
        Dim htmlFlightUtilizationGraph As String = ""
        Dim htmlFlightUtilizationFunctionScript As String = ""

        utilization_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
        utilization_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
        utilization_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
        utilization_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
        utilization_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim


        localCriteria.ViewCriteriaTimeSpan = FlightUtilizationGraphDropdown.SelectedValue
        utilization_functions.views_display_flight_utilization_graph(localCriteria, htmlFlightUtilizationFunctionScript, htmlFlightUtilizationGraph, graphID, "", bFromUtilizationTab, False, FlightUtilizationGraphDropdown.SelectedValue)

        htmlFlightUtilizationGraphScript = vbCrLf + "<script type=""text/javascript"">" + vbCrLf
        'htmlFlightUtilizationGraphScript += "$(document).ready(function(){" + vbCrLf
        htmlFlightUtilizationGraphScript += " google.setOnLoadCallback(function() {drawVisualization" + graphID.ToString + "();});" + vbCrLf
        ' htmlFlightUtilizationGraphScript += "});" + vbCrLf
        htmlFlightUtilizationGraphScript += htmlFlightUtilizationFunctionScript.Trim
        htmlFlightUtilizationGraphScript += "</script>" + vbCrLf

        System.Web.UI.ScriptManager.RegisterStartupScript(utilizationGraphUpdate, Me.GetType(), "showUtilizationGraphPost" + graphID.ToString, htmlFlightUtilizationGraphScript, False)

        utilization_graph.Text = (htmlFlightUtilizationGraph)
        utilizationGraphUpdate.Update()
    End Sub

    Private Sub Build_Fractional_tab(ByRef searchCriteria As viewSelectionCriteriaClass, ByRef out_htmlString As String)

        Dim htmlOut As New StringBuilder

        Dim htmlFractionalFleet_model As String = ""
        Dim htmlSoldFromProvider As String = ""
        Dim htmlSoldToProvider As String = ""
        Dim htmlFractionalPrograms As String = ""
        Dim htmlFractionalShares As String = ""
        Dim htmlFractionalShareHolders As String = ""
        Dim htmlFractionalModelShares As String = ""
        Dim htmlFractionsToExpire As String = ""
        Dim htmlFractionsExpired As String = ""

        Dim fractional_functions As New fractional_view_functions

        Try

            fractional_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            fractional_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            fractional_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            fractional_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            fractional_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

            If (View_ID < 2) Or View_ID = 11 Then
                htmlOut.Append("<div style='height:370px; width:100%; overflow: auto;'>")
            End If

            If CRMViewActive Then
                htmlOut.Append(JetnetSourceText)
            End If

            htmlOut.Append("<table id='fractionalViewOuterTable' width=""100%"" cellpadding=""2"" cellspacing=""0"" class='module'><tr><td align=""left"" valign=""top"">")
            htmlOut.Append("<table id='fractionalViewTopTable' width=""100%"" cellpadding=""1"" cellspacing=""0""><tr><td align=""center"" valign=""top"" width=""65%"">")

            htmlOut.Append("<table id='fractionalViewLeftSideTable' width='100%' cellpadding='1' cellspacing='0' class='module'><tr><td colspan='2'></td></tr><tr><td align=""left"" valign=""top"">")

            fractional_functions.views_display_fractional_programs(searchCriteria, htmlFractionalPrograms)
            htmlOut.Append(htmlFractionalPrograms + "</td><td align=""left"" valign=""top"">")

            fractional_functions.views_display_fractional_shares(searchCriteria, htmlFractionalShares)
            htmlOut.Append(htmlFractionalShares)

            htmlOut.Append("</td></tr>") ' end first row

            If searchCriteria.ViewCriteriaFractionalProgramID > 0 Or searchCriteria.ViewCriteriaAmodID > -1 Then

                htmlOut.Append("<tr><td align=""left"" valign=""top"">") ' start second row

                fractional_functions.views_display_fractional_shareholders(searchCriteria, htmlFractionalShareHolders)
                htmlOut.Append(htmlFractionalShareHolders)

                htmlOut.Append("</td><td align=""left"" valign=""top"">")

                fractional_functions.views_display_fractional_model_shares_inuse(searchCriteria, htmlFractionalModelShares)
                htmlOut.Append(htmlFractionalModelShares)

                htmlOut.Append("</td></tr>") ' end second row

                If searchCriteria.ViewCriteriaFractionalProgramID > 0 Or (searchCriteria.ViewCriteriaFractionalProgramID > 0 And searchCriteria.ViewCriteriaAmodID > -1) Then
                    htmlOut.Append("<tr><td colspan='2'>") ' start third row
                    htmlOut.Append("<table id='fractionsExpireTable' width='100%' cellpadding='1' cellspacing='0' class='module'>")
                    htmlOut.Append("<tr><td  colspan=""2"" class=""header"" align=""center"" valign=""middle"">EXPIRED/EXPIRING FRACTIONS</td></tr>") ' third and fourth rows
                    htmlOut.Append("<tr><td align=""left"" valign=""top"">")

                    fractional_functions.views_display_fractions_expired(searchCriteria, htmlFractionsExpired)
                    htmlOut.Append(htmlFractionsExpired + "</td><td align=""left"" valign=""top"">")

                    fractional_functions.views_display_fractions_to_expire(searchCriteria, htmlFractionsToExpire)
                    htmlOut.Append(htmlFractionsToExpire)

                    htmlOut.Append("</td></tr>")
                    htmlOut.Append("</table>")
                    htmlOut.Append("</td></tr>") ' end third row
                End If

            End If

            htmlOut.Append("<tr><td colspan=""2"" class=""header"" align=""center"" valign=""middle"">TRANSACTIONS</td></tr>") ' (third and fourth) or (forth and fifth) rows
            htmlOut.Append("<tr><td align=""left"" valign=""top"">")
            fractional_functions.views_display_fractional_latest_sales_graph_sold_from_provider(searchCriteria, htmlSoldFromProvider, Me.SOLD_FROM_PROVIDER)
            htmlOut.Append(htmlSoldFromProvider)
            htmlOut.Append("</td><td align=""left"" valign=""top"">")
            fractional_functions.views_display_fractional_latest_sales_graph_sold_to_provider(searchCriteria, htmlSoldToProvider, Me.SOLD_TO_PROVIDER)
            htmlOut.Append(htmlSoldToProvider)
            htmlOut.Append("</td></tr>")
            htmlOut.Append("</table>")
            htmlOut.Append("</td>")

            htmlOut.Append("<td align='left' valign='top' width='35%'>")
            htmlOut.Append("<table id='fractionalViewRightSideTable' width='100%' cellpadding='1' cellspacing='0' class='module'><tr>")


            If searchCriteria.ViewCriteriaFractionalProgramID > 0 Or searchCriteria.ViewCriteriaAmodID > -1 Then
                fractional_functions.views_display_fractional_fleet(searchCriteria, htmlFractionalFleet_model)
            Else
                fractional_functions.views_display_fractional_models(searchCriteria, htmlFractionalFleet_model)
            End If

            htmlOut.Append(htmlFractionalFleet_model)

            htmlOut.Append("</tr>")
            htmlOut.Append("</table>") ' fractional view table

            htmlOut.Append("</td></tr></table>") ' inner view table
            htmlOut.Append("</td></tr></table>") ' outter view table

            If (View_ID < 2) Or View_ID = 11 Then
                htmlOut.Append("</div>")
            End If

        Catch ex As Exception

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [Build_Fractional_tab] : " + ex.Message

        Finally

        End Try

        out_htmlString = htmlOut.ToString()
        htmlOut = Nothing

    End Sub

    Private Sub Build_Events_tab(ByRef searchCriteria As viewSelectionCriteriaClass)

        Try
            Dim ApplicableLiteral As New Literal
            ApplicableLiteral = view_events_label

            If CRMViewActive Then
                ApplicableLiteral = view_spi_label
            End If

            ApplicableLiteral.Text = "<div style='height:370px; width:100%; overflow: auto;'>"

            If CRMViewActive Then
                ApplicableLiteral.Text += (JetnetSourceText)
            End If

            ApplicableLiteral.Text += "<table width=""100%"" cellpadding=""0"" cellspacing=""0"" class='module'><tr><td align=""left"" valign=""top"">"

            Dim sMakeEvents As String = ""


            localDatalayer.views_display_model_events(searchCriteria, sMakeEvents, CRMViewActive, returnEvent("category"), returnEvent("date"), returnEvent("header"))

            ApplicableLiteral.Text += vbCrLf + sMakeEvents + vbCrLf
            ApplicableLiteral.Text += "</td></tr></table>"
            ApplicableLiteral.Text += "</div>"


        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [Build_Events_tab] : " + ex.Message
        End Try

    End Sub

    Private Function returnEvent(ByVal eventType As String) As String
        Dim eventDate As String = ""
        Dim eventCategory As String = ""
        Dim eventNumberOfDays As Integer = 0
        Dim headerString As String = ""

        If CRMViewActive Then

            headerString = crm_event_category1.SelectedItem.Text & " Events for the last "
            Select Case crm_event_time1.SelectedValue
                Case "30"
                    eventNumberOfDays = -30
                    headerString += " Month"
                Case "90"
                    eventNumberOfDays = -90
                    headerString += " Three Months"
                Case "1"
                    eventNumberOfDays = -1
                    headerString += " Day"
                Case Else
                    eventNumberOfDays = -7
                    headerString += " Week"
            End Select
            eventCategory = crm_event_category1.SelectedValue

        Else
            headerString = crm_event_category2.SelectedItem.Text & " Events for the last "
            Select Case crm_event_time2.SelectedValue
                Case "30"
                    eventNumberOfDays = -30
                    headerString += " Month"
                Case "90"
                    eventNumberOfDays = -90
                    headerString += " Three Months"
                Case "1"
                    eventNumberOfDays = -1
                    headerString += " Day"
                Case Else
                    eventNumberOfDays = -7
                    headerString += " Week"
            End Select
            eventCategory = crm_event_category2.SelectedValue
        End If

        eventDate = Month(DateAdd(DateInterval.Day, eventNumberOfDays, Now())) & "/" & Day(DateAdd(DateInterval.Day, eventNumberOfDays, Now())) & "/" & Year(DateAdd(DateInterval.Day, eventNumberOfDays, Now()))

        If eventType = "category" Then
            Return eventCategory
        ElseIf eventType = "date" Then
            Return eventDate
        Else
            Return headerString
        End If

    End Function

    Private Sub Build_Lease_tab(ByRef searchCriteria As viewSelectionCriteriaClass, ByRef out_htmlString As String)

        Dim htmlOut As New StringBuilder

        Dim sHtmlLeaseModelPic As String = ""
        Dim sHtmlLeases As String = ""
        Dim sHtmlLeasesDueToExpire As String = ""
        Dim sHtmlLeasesExpired As String = ""

        Dim sHtmlTopLessors As String = ""
        Dim sHtmlModelsLeasedList As String = ""
        Dim sHtmlLeasesPerMonthChart As String = ""

        Dim sHtmlMarketStatusBlock As String = ""
        Dim sHtmlMostRecentLeaseTrans As String = ""

        Dim lease_functions As New lease_view_functions

        Try

            lease_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            lease_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            lease_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            lease_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            lease_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

            If (View_ID < 2) Or View_ID = 11 Then
                htmlOut.Append("<div style='height:370px; width:100%; overflow: auto;'>")
            End If


            If CRMViewActive Then
                htmlOut.Append(JetnetSourceText)
            End If


            htmlOut.Append("<table id='leaseViewOuterTable' width=""100%"" cellpadding=""0"" cellspacing=""0"" class='module'><tr><td align=""left"" valign=""top"">")
            htmlOut.Append("<table id='leaseViewTopTable' width=""100%"" cellpadding=""2"" cellspacing=""0"">")
            htmlOut.Append("<tr><td width=""50%"" align=""center"" valign=""top"">") ' first row

            htmlOut.Append("<table id='leaseViewDataTable' width='100%' cellpadding='2' cellspacing='0' border='0'>")
            htmlOut.Append("<tr><td valign='top' align='center' width='33%'>") ' left column 
            htmlOut.Append("<table id='leaseViewLeftTable' width='100%' cellpadding='2' cellspacing='0' class='module'>")

            If searchCriteria.ViewCriteriaAmodID > -1 Then

                If ((View_ID > 2) And Not View_ID = 11) Then
                    htmlOut.Append("<tr><td valign='top' align='center'>")
                    localDatalayer.views_display_model_pic(searchCriteria, sHtmlLeaseModelPic)
                    htmlOut.Append(sHtmlLeaseModelPic)
                    htmlOut.Append("</td></tr>")

                    htmlOut.Append("<tr><td valign='top' align='right'>")

                    If searchCriteria.ViewCriteriaCompanyID > 0 Then
                        htmlOut.Append("<a href='view_template.aspx?ViewID=" + searchCriteria.ViewID.ToString + "&ViewName=" + searchCriteria.ViewName + "&viewCompany=0&amod_id=" + searchCriteria.ViewCriteriaAmodID.ToString + "'><strong> Clear Company </strong></a>&nbsp;")
                    End If

                    If searchCriteria.ViewCriteriaAmodID > -1 Then
                        htmlOut.Append("&nbsp;<a href='view_template.aspx?ViewID=" + searchCriteria.ViewID.ToString + "&ViewName=" + searchCriteria.ViewName + "&amod_id=-1&viewCompany=" + searchCriteria.ViewCriteriaCompanyID.ToString + "'><strong> Clear Model </strong></a>&nbsp;")
                    End If

                    htmlOut.Append("</td></tr>")

                End If

                lease_functions.views_display_top_lessors(searchCriteria, sHtmlTopLessors)
                htmlOut.Append("<tr><td valign='top' align='center'>" + sHtmlTopLessors + "</td></tr>")

            Else

                If ((View_ID > 2) And Not View_ID = 11) Then

                    htmlOut.Append("<tr><td valign='top' align='right'>")

                    If searchCriteria.ViewCriteriaCompanyID > 0 Then
                        htmlOut.Append("<a href='view_template.aspx?ViewID=" + searchCriteria.ViewID.ToString + "&ViewName=" + searchCriteria.ViewName + "&viewCompany=0&amod_id=" + searchCriteria.ViewCriteriaAmodID.ToString + "'><strong> Clear Company </strong></a>&nbsp;")
                    End If

                    If searchCriteria.ViewCriteriaAmodID > -1 Then
                        htmlOut.Append("&nbsp;<a href='view_template.aspx?ViewID=" + searchCriteria.ViewID.ToString + "&ViewName=" + searchCriteria.ViewName + "&amod_id=-1&viewCompany=" + searchCriteria.ViewCriteriaCompanyID.ToString + "'><strong> Clear Model </strong></a>&nbsp;")
                    End If

                    htmlOut.Append("</td></tr>")

                End If

                lease_functions.views_display_top_lessors(searchCriteria, sHtmlTopLessors)
                htmlOut.Append("<tr><td valign='top' align='center'>" + sHtmlTopLessors + "</td></tr>")

                lease_functions.views_display_models_leased_list(searchCriteria, sHtmlModelsLeasedList)
                htmlOut.Append("<tr><td valign='top' align='center'>" + sHtmlModelsLeasedList + "</td></tr>")

            End If

            htmlOut.Append("</table>")

            htmlOut.Append("</td><td valign='top' align='center' width='33%'>") ' middle column

            htmlOut.Append("<table id='leaseViewMiddleTable' width='100%' cellpadding='2' cellspacing='0' class='module'>")

            lease_functions.views_display_leases_by_month_chart(searchCriteria, sHtmlLeasesPerMonthChart, Me.LEASES_SOLD_PER_MONTH)
            htmlOut.Append("<tr><td valign='top' align='center'>" + sHtmlLeasesPerMonthChart + "</td></tr>")

            lease_functions.views_display_leases_expired(searchCriteria, False, sHtmlLeasesExpired)

            If sHtmlLeasesExpired.ToUpper.Trim.Contains("NO LEASES") Then
                lease_functions.views_display_leases_expired(searchCriteria, True, sHtmlLeasesExpired)
                htmlOut.Append("<tr><td valign='top' align='center'>" + sHtmlLeasesExpired + "</td></tr>")
            Else
                htmlOut.Append("<tr><td valign='top' align='center'>" + sHtmlLeasesExpired + "</td></tr>")
            End If

            lease_functions.views_display_leases_due_to_expire(searchCriteria, False, sHtmlLeasesDueToExpire)

            If sHtmlLeasesDueToExpire.ToUpper.Trim.Contains("NO LEASES") Then
                lease_functions.views_display_leases_due_to_expire(searchCriteria, True, sHtmlLeasesDueToExpire)
                htmlOut.Append("<tr><td valign='top' align='center'>" + sHtmlLeasesDueToExpire + "</td></tr>")
            Else
                htmlOut.Append("<tr><td valign='top' align='center'>" + sHtmlLeasesDueToExpire + "</td></tr>")
            End If

            htmlOut.Append("</table>")

            htmlOut.Append("</td><td valign='top' align='center' width='33%'>") ' right column   

            htmlOut.Append("<table id='leaseViewRightTable' width='100%' cellpadding='2' cellspacing='0' class='module'>")

            lease_functions.views_display_lease_market_status_block(searchCriteria, sHtmlMarketStatusBlock)
            htmlOut.Append("<tr><td valign='top' align='center'>" + sHtmlMarketStatusBlock + "</td></tr>")

            If searchCriteria.ViewCriteriaAmodID > -1 Or searchCriteria.ViewCriteriaCompanyID > 0 Then
                lease_functions.views_display_leased_aircraft(searchCriteria, sHtmlLeases)
                htmlOut.Append("<tr><td valign='top' align='center'>" + sHtmlLeases + "</td></tr>")
            End If

            lease_functions.views_display_most_recent_lease_trans(searchCriteria, sHtmlMostRecentLeaseTrans)
            htmlOut.Append("<tr><td valign='top' align='center'>" + sHtmlMostRecentLeaseTrans + "</td></tr>")

            htmlOut.Append("</table>")

            htmlOut.Append("</td></tr></table>") ' leaseViewDataTable

            htmlOut.Append("</td></tr></table>") ' inner view table
            htmlOut.Append("</td></tr></table>") ' outter view table

            If (View_ID < 2) Or View_ID = 11 Then
                htmlOut.Append("</div>")
            End If

            lease_functions = Nothing

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [Build_Lease_tab] : " + ex.Message
        End Try

        out_htmlString = htmlOut.ToString()
        htmlOut = Nothing

    End Sub

    Private Sub Build_Location_Tab(ByRef searchCriteria As viewSelectionCriteriaClass, ByRef out_htmlString As String)

        Dim htmlOut As New StringBuilder
        Dim htmlLocation As String = ""

        Try

            If String.IsNullOrEmpty(searchCriteria.ViewCriteriaCountry.Trim) Then

                If String.IsNullOrEmpty(searchCriteria.ViewCriteriaCity.Trim) Or
                   String.IsNullOrEmpty(searchCriteria.ViewCriteriaState.Trim) Or
                   String.IsNullOrEmpty(searchCriteria.ViewCriteriaContinent.Trim) Then

                    If Not IsNothing(Request.Item("viewCountry")) Then
                        If Not String.IsNullOrEmpty(Request.Item("viewCountry").ToString.Trim) Then
                            If Not Request.Item("viewCountry").ToString.ToLower.Contains("clear") Then
                                searchCriteria.ViewCriteriaCountry = "United States"
                            Else
                                searchCriteria.ViewCriteriaCountry = ""
                            End If
                        End If
                    Else
                        searchCriteria.ViewCriteriaCountry = "United States"
                    End If

                End If

            End If

            If searchCriteria.ViewCriteriaCountry.ToString.Trim.ToLower.Contains("united states") Or
               searchCriteria.ViewCriteriaCountry.ToString.Trim.ToLower.Contains("brazil") Or
               searchCriteria.ViewCriteriaCountry.ToString.Trim.ToLower.Contains("canada") Then
                searchCriteria.ViewCriteriaCountryHasStates = True
            End If

            If View_ID = 8 Then ' standalone location view

                build_location_standalone(searchCriteria, htmlLocation)
                htmlOut.Append(htmlLocation)

            Else ' location tab on model market view

                build_location_markettab(searchCriteria, htmlLocation)
                htmlOut.Append(htmlLocation)

            End If

        Catch ex As Exception

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [Build_Location_tab] : " + ex.Message

        Finally

        End Try

        out_htmlString = htmlOut.ToString()
        htmlOut = Nothing

    End Sub

    Private Sub Build_Manufacturer_tab(ByRef searchCriteria As viewSelectionCriteriaClass, ByRef out_htmlString As String)

        Dim htmlOut As New StringBuilder
        Dim sHtmlManufacturerCompanies As String = ""
        Dim sHtmlManufacturerModels As String = ""
        Dim sHtmlManufacturerModelPieChart As String = ""
        Dim sHtmlManufacturerAircraftBarChart As String = ""
        Dim sHtmlManufacturerAircraftSummary As String = ""
        Dim sHtmlManufacturerAircraft As String = ""
        Dim sHtmlManufacturerModelPic As String = ""

        Dim manufacturer_functions As New manufacturer_view_functions
        Dim market_functions As New market_model_functions

        Dim sManufactureReportFileName As String = ""
        Dim sManufactureReportString As String = ""
        Dim sReportTitle As String = ""

        Dim bRememberWasReport As Boolean = searchCriteria.ViewCriteriaIsReport

        Dim subscriptionInfo As String = Session.Item("localUser").crmSubSubID.ToString + "_" + Session.Item("localUser").crmUserLogin.ToString.Trim + "_" + Session.Item("localUser").crmSubSeqNo.ToString + "_"

        Dim reportDisplayFolder As String = HttpContext.Current.Application.Item("crmClientSiteData").ClientFullHostName + HttpContext.Current.Session.Item("MarketSummaryFolderVirtualPath")

        Try

            market_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            market_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            market_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            market_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            market_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

            manufacturer_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            manufacturer_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            manufacturer_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            manufacturer_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            manufacturer_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

            htmlOut.Append("<table id='manufacturerViewOuterTable' width=""100%"" cellpadding=""0"" cellspacing=""0"" class='module'><tr><td align=""left"" valign=""top"">")
            htmlOut.Append("<table id='manufacturerViewTopTable' width=""100%"" cellpadding=""4"" cellspacing=""0""><tr><td align=""center"" valign=""top"">")

            htmlOut.Append("<table id='manufacturerInnerTable' width='100%' cellpadding='2' cellspacing='0' border='0'><tr><td align=""center"" valign='top' width='50%'>")

            ' htmlOut.Append(vbCrLf + "<script type='text/javascript' src='https://www.google.com/jsapi'></script>" + vbCrLf)

            If searchCriteria.ViewCriteriaCompanyID > 0 Then

                If searchCriteria.ViewCriteriaAmodID = -1 Then

                    ' first column left side
                    manufacturer_functions.views_display_manufacturer_companies(searchCriteria, sHtmlManufacturerCompanies)
                    htmlOut.Append(sHtmlManufacturerCompanies)

                    htmlOut.Append("<br />")

                    manufacturer_functions.views_display_manufacturer_aircraft_models(searchCriteria, sHtmlManufacturerModels)
                    htmlOut.Append(sHtmlManufacturerModels)

                    htmlOut.Append("</td><td align='left' valign='top'>")

                    ' second column right side
                    manufacturer_functions.views_display_manufacturer_model_pie_chart(searchCriteria, sHtmlManufacturerModelPieChart, 1)
                    htmlOut.Append(sHtmlManufacturerModelPieChart)

                    htmlOut.Append("</td></tr></table>")

                Else

                    ' first column left side
                    manufacturer_functions.views_display_manufacturer_companies(searchCriteria, sHtmlManufacturerCompanies)
                    htmlOut.Append(sHtmlManufacturerCompanies)

                    If searchCriteria.ViewCriteriaAmodID > -1 Then

                        localDatalayer.views_display_model_pic(searchCriteria, sHtmlManufacturerModelPic)
                        htmlOut.Append("<br />" + sHtmlManufacturerModelPic + "<br />")

                    End If

                    market_functions.views_display_fleet_market_summary(searchCriteria, sHtmlManufacturerAircraftSummary, "")
                    htmlOut.Append(sHtmlManufacturerAircraftSummary)

                    htmlOut.Append("</td><td align='left' valign='top'>")

                    ' second column right side
                    manufacturer_functions.views_display_manufacturer_aircraft_bar_chart(searchCriteria, sHtmlManufacturerAircraftBarChart, 1)
                    htmlOut.Append(sHtmlManufacturerAircraftBarChart)

                    htmlOut.Append("<br />")

                    manufacturer_functions.views_display_manufacturer_aircraft(searchCriteria, sHtmlManufacturerAircraft)
                    htmlOut.Append(sHtmlManufacturerAircraft)

                    htmlOut.Append("</td></tr></table>")
                End If

            Else

                If searchCriteria.ViewCriteriaAmodID = -1 Then

                    If searchCriteria.ViewCriteriaIsReport Then

                        If Not bIsMfrModel Then
                            sReportTitle = subscriptionInfo + "manufacturerReport_top250_companies"
                            sReportFrom = "manufacturerTop250Companies"

                            sManufactureReportFileName = commonEvo.GenerateFileName(sReportTitle, ".xls", False)

                            manufacturer_functions.views_display_manufacturer_companies(searchCriteria, sManufactureReportString, bHasMaster)

                            If manufacturer_functions.write_manufacturerReport_string_to_file(sManufactureReportString, sManufactureReportFileName) Then
                                sReportOutputFilename = reportDisplayFolder + "/" + sManufactureReportFileName.Trim
                            Else
                                HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in sending string to file"
                            End If

                            searchCriteria.ViewCriteriaIsReport = False ' set report flag to "false" so "listing shows"

                            ' first column left side
                            manufacturer_functions.views_display_manufacturer_companies(searchCriteria, sHtmlManufacturerCompanies, bHasMaster)
                            htmlOut.Append(sHtmlManufacturerCompanies)

                            htmlOut.Append("</td><td align='left' valign='top'>")

                            ' second column right side
                            manufacturer_functions.views_display_manufacturer_aircraft_models(searchCriteria, sHtmlManufacturerModels, bHasMaster)
                            htmlOut.Append(sHtmlManufacturerModels)

                        Else

                            sReportTitle = subscriptionInfo + "manufacturerReport_top250_models"
                            sReportFrom = "manufacturerTop250Models"

                            sManufactureReportFileName = commonEvo.GenerateFileName(sReportTitle, ".xls", False)

                            manufacturer_functions.views_display_manufacturer_aircraft_models(searchCriteria, sManufactureReportString, bHasMaster)

                            If manufacturer_functions.write_manufacturerReport_string_to_file(sManufactureReportString, sManufactureReportFileName) Then
                                sReportOutputFilename = reportDisplayFolder + "/" + sManufactureReportFileName.Trim
                            Else
                                HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in sending string to file"
                            End If

                            searchCriteria.ViewCriteriaIsReport = False ' set report flag to "false" so "listing shows"

                            ' first column left side
                            manufacturer_functions.views_display_manufacturer_companies(searchCriteria, sHtmlManufacturerCompanies, bHasMaster)
                            htmlOut.Append(sHtmlManufacturerCompanies)

                            htmlOut.Append("</td><td align='left' valign='top'>")

                            ' second column right side
                            manufacturer_functions.views_display_manufacturer_aircraft_models(searchCriteria, sHtmlManufacturerModels, bHasMaster)
                            htmlOut.Append(sHtmlManufacturerModels)

                        End If

                    Else

                        ' first column left side
                        manufacturer_functions.views_display_manufacturer_companies(searchCriteria, sHtmlManufacturerCompanies, bHasMaster)
                        htmlOut.Append(sHtmlManufacturerCompanies)

                        htmlOut.Append("</td><td align='left' valign='top'>")

                        ' second column right side
                        manufacturer_functions.views_display_manufacturer_aircraft_models(searchCriteria, sHtmlManufacturerModels, bHasMaster)
                        htmlOut.Append(sHtmlManufacturerModels)

                    End If

                    searchCriteria.ViewCriteriaIsReport = bRememberWasReport

                    htmlOut.Append("</td></tr></table>")

                Else

                    ' first column left side
                    manufacturer_functions.views_display_manufacturer_companies(searchCriteria, sHtmlManufacturerCompanies)
                    htmlOut.Append(sHtmlManufacturerCompanies)

                    If searchCriteria.ViewCriteriaAmodID > -1 Then

                        localDatalayer.views_display_model_pic(searchCriteria, sHtmlManufacturerModelPic)
                        htmlOut.Append("<br />" + sHtmlManufacturerModelPic + "<br />")

                    End If

                    market_functions.views_display_fleet_market_summary(searchCriteria, sHtmlManufacturerAircraftSummary, "")
                    htmlOut.Append(sHtmlManufacturerAircraftSummary)

                    htmlOut.Append("</td><td align='left' valign='top'>")

                    ' second column right side
                    manufacturer_functions.views_display_manufacturer_aircraft_bar_chart(searchCriteria, sHtmlManufacturerAircraftBarChart, 1)
                    htmlOut.Append(sHtmlManufacturerAircraftBarChart)

                    htmlOut.Append("<br />")

                    manufacturer_functions.views_display_manufacturer_aircraft(searchCriteria, sHtmlManufacturerAircraft)
                    htmlOut.Append(sHtmlManufacturerAircraft)

                    htmlOut.Append("</td></tr></table>")
                End If

            End If

            htmlOut.Append("</td></tr></table>") ' inner view table
            htmlOut.Append("</td></tr></table>") ' outter view table

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [Build_Manufacturer_tab] : " + ex.Message
        Finally

        End Try

        out_htmlString = htmlOut.ToString()
        htmlOut = Nothing
        market_functions = Nothing
        manufacturer_functions = Nothing

    End Sub

    Private Sub BuildStandardPDFScript()
        Dim popString As New StringBuilder
        popString.Append("function openStandardPDF() {")


        popString.Append("my_form = document.createElement('FORM');")
        popString.Append("my_form.name = 'myForm';")
        popString.Append("my_form.method = 'GET';")

        popString.Append("my_form.target = '_blank';")
        popString.Append("my_form.action = 'viewtopdf.aspx';")

        popString.Append("my_tb = document.createElement('INPUT');")
        popString.Append("my_tb.type = 'HIDDEN';")
        popString.Append("my_tb.name = 'amod_id';")
        popString.Append("my_tb.value = '" & localCriteria.ViewCriteriaAmodID.ToString & "';")
        popString.Append("my_form.appendChild(my_tb);")

        popString.Append("my_tb = document.createElement('INPUT');")
        popString.Append("my_tb.type = 'HIDDEN';")
        popString.Append("my_tb.name = 'viewID';")
        popString.Append("my_tb.value = '" & localCriteria.ViewID.ToString & "';")
        popString.Append("my_form.appendChild(my_tb);")

        popString.Append("my_tb = document.createElement('INPUT');")
        popString.Append("my_tb.type = 'HIDDEN';")
        popString.Append("my_tb.name = 'sub_id';")
        popString.Append("my_tb.value = '" & Session.Item("localSubscription").crmSubscriptionID.ToString & "';")
        popString.Append("my_form.appendChild(my_tb);")

        popString.Append("my_tb = document.createElement('INPUT');")
        popString.Append("my_tb.type = 'HIDDEN';")
        popString.Append("my_tb.name = 'pc';")
        popString.Append("my_tb.value = '" & sSelectedProductCode.ToString & "';")
        popString.Append("my_form.appendChild(my_tb);")

        popString.Append("my_tb = document.createElement('INPUT');")
        popString.Append("my_tb.type = 'HIDDEN';")
        popString.Append("my_tb.name = 'new_PDF';")
        popString.Append("my_tb.value = 'Y';")
        popString.Append("my_form.appendChild(my_tb);")

        popString.Append("my_tb = document.createElement('INPUT');")
        popString.Append("my_tb.type = 'HIDDEN';")
        popString.Append("my_tb.name = 'months';")
        popString.Append("my_tb.value = '" & localCriteria.ViewCriteriaTimeSpan.ToString & "';")
        popString.Append("my_form.appendChild(my_tb);")

        popString.Append("my_tb = document.createElement('INPUT');")
        popString.Append("my_tb.type = 'HIDDEN';")
        popString.Append("my_tb.name = 'ac_id_list';")


        popString.Append("my_tb.value = $(""#" & fullSaleCurrentIDs.ClientID & """).val();")
        popString.Append("my_form.appendChild(my_tb);")

        popString.Append("my_tb = document.createElement('INPUT');")
        popString.Append("my_tb.type = 'HIDDEN';")
        popString.Append("my_tb.name = 'journ_id_list';")
        popString.Append("my_tb.value = $(""#" & EvoRetailSalesIDsCurrent.ClientID & """).val();")
        popString.Append("my_form.appendChild(my_tb);")


        popString.Append("document.body.appendChild(my_form);")
        popString.Append("my_form.submit();")     ' alert('NEW WINDOW');
        popString.Append("};")
        ScriptManager.RegisterStartupScript(Me, Me.GetType(), "newWindowLink", popString.ToString, True)

        standard_pdf_button.OnClientClick = "openStandardPDF();return false;"
    End Sub

    Private Sub Build_Market_trends_tab(ByRef searchCriteria As viewSelectionCriteriaClass, ByRef out_htmlString As String, ByRef html_for_google_graph As String, ByVal hide_sold_trend_charts As Boolean, ByRef excel_table As String)

        Dim htmlUpDown As String = ""
        Dim htmlOut As New StringBuilder
        Dim excel_string As New StringBuilder

        Dim imgCnt As Integer = 0
        Dim sImageMapPath As String = ""
        Dim sImageSrc As String = ""
        Dim sImageName As String = ""
        Dim charting_string As String = ""

        Dim months_string As String = ""
        Dim for_sale_string As String = ""
        Dim ask_price_string As String = ""


        Dim Graph15 As String = ""
        Dim Graph16 As String = ""
        Dim Graph18 As String = ""
        Dim Graph100 As String = ""
        Dim months_array As Array = Nothing
        Dim for_sale_array As Array = Nothing
        Dim asking_price_array As Array = Nothing
        Dim i As Integer = 0


        Dim subscriptionInfo As String = Session.Item("localUser").crmSubSubID.ToString + "_" + Session.Item("localUser").crmUserLogin.ToString.Trim + "_" + Session.Item("localUser").crmSubSeqNo.ToString + "_"
        Dim displayFolder As String = HttpContext.Current.Application.Item("crmClientSiteData").ClientFullHostName + HttpContext.Current.Session.Item("MarketSummaryFolderVirtualPath")

        Dim market_functions As New market_model_functions
        Dim skip_graphs As Boolean = False


        Try
            If IsPostBack Then
                If searchCriteria.ViewCriteriaAFTTStart <> Me.hidden_aftt_start.Text Or searchCriteria.ViewCriteriaAFTTEnd <> Me.hidden_aftt_end.Text Or searchCriteria.ViewCriteriaYearStart <> Me.hidden_year_start.Text Or searchCriteria.ViewCriteriaYearEnd > Me.hidden_year_end.Text Then
                    skip_graphs = True
                End If
            End If

            market_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            market_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            market_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            market_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            market_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim


            If CRMViewActive = True And Trim(Request("noteID")) <> "" Then
                If CDbl(Trim(Request("noteID"))) > 0 Then
                    searchCriteria.ViewCriteriaTimeSpan = Me.year_month_settings.SelectedValue
                End If
            End If



            If hide_sold_trend_charts Then
                '   htmlOut.Append("<div style='height:370px; width:970px; overflow: auto;'>")
            End If

            If CRMViewActive Then
                htmlOut.Append(JetnetSourceText)
            End If

            htmlOut.Append("<table width='100%' cellpadding='0' cellspacing='0'>")




            htmlOut.Append("<tr><td align='left' valign='top'>")
            htmlOut.Append("<table cellpadding='0' cellspacing='0'>")

            If skip_graphs = True Then
            Else
                If Not Session.Item("localPreferences").AerodexFlag Then

                    htmlOut.Append("<tr><td align='left' valign='top' colspan=""4""><div class=""Box"" style=""text-align:center;position:relative;"">")

                    If values_for_sale = 0 Then
                        If CRMViewActive Then
                            crmViewDataLayer.Combined_views_display_fleet_market_summary(searchCriteria, Build_FleetMarketSummary_text, GetMarketStatus, localDatalayer, ClientIDSToExclude, CRMViewActive, True, values_avg_asking, 0, 0, values_for_sale, values_dom, values_in_op, values_total_inop, values_for_sale_exclusive, values_lease, values_abs_rate)
                        Else
                            market_functions.views_display_fleet_market_summary(searchCriteria, Build_FleetMarketSummary_text, GetMarketStatus, "", searchCriteria.ViewCriteriaTimeSpan, values_for_sale, values_dom, values_avg_asking, values_in_op, values_total_inop, values_for_sale_exclusive, values_lease, values_abs_rate)

                            If values_avg_asking > 0 Then
                                values_avg_asking = (values_avg_asking / 1000)
                            End If
                        End If
                    End If

                    htmlOut.Append(DisplayFunctions.make_MTREND_CHANGE_TICKERS(searchCriteria.ViewCriteriaAmodID, searchCriteria.ViewCriteriaTimeSpan, aclsData_Temp_aspx, values_for_sale, values_dom, values_avg_asking, values_in_op, values_total_inop))

                    'htmlOut.Append(DisplayFunctions.make_ticker_box("For Sale (" & searchCriteria.ViewCriteriaTimeSpan & " Months)", -7, 33, 26 & " FOR SALE", False))

                    'htmlOut.Append(DisplayFunctions.make_ticker_box("Avg Asking (" & searchCriteria.ViewCriteriaTimeSpan & " Months)", 800000, 11, " 150 DAYS", True))

                    'htmlOut.Append(DisplayFunctions.make_ticker_box("Days On Market (" & searchCriteria.ViewCriteriaTimeSpan & " Months)", 0, 2.9, 263 & " DAYS", False))

                    ''htmlOut.Append(make_ticker_box("Days On Market (" & searchCriteria.ViewCriteriaTimeSpan & " Months)", 0, 0, 0 & "FOR SALE", False))

                    htmlOut.Append("</div></td></tr>")

                    ''Moved this to the trends tab on 4/24/2014
                    htmlOut.Append("<tr><td align='left' valign='top' colspan='4'><table width='100%' cellpadding='0' cellspacing='0' height='1' bgcolor='LightGray'><tr><td valign='top' align='left'>")
                    '   market_functions.views_display_market_up_down_one_model(searchCriteria, htmlUpDown)
                    '   htmlOut.Append(htmlUpDown)

                    htmlOut.Append("</td></tr></table></td></tr>")
                End If
            End If

            '  htmlOut.Append("<tr><td valign='top' align='left'>") ' need to append user_sub_seq to filename so it gets deleted when user logs in next time

            If Not hide_sold_trend_charts Then



                If skip_graphs = True Then
                Else
                    If Not Session.Item("localPreferences").AerodexFlag Then

                        imgCnt += 1
                        sImageName = subscriptionInfo + commonEvo.GenerateFileName("image_" + imgCnt.ToString, ".jpg", False)
                        sImageMapPath = Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath")) + "\" + sImageName
                        sImageSrc = displayFolder + "/" + sImageName

                        FOR_SALE.Titles.Clear()
                        FOR_SALE.Titles.Add("For Sale By Month (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
                        market_functions.views_display_for_sale_by_month_graph(searchCriteria, Me.FOR_SALE, False, Graph16, values_for_sale, months_string, for_sale_string)
                        FOR_SALE.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                        FOR_SALE.SaveImage(sImageMapPath, DataVisualization.Charting.ChartImageFormat.Jpeg)
                        ' htmlOut.Append("<img src=""" + sImageSrc + """ width=""240"" height=""240"" style=""height:240px; width:240px;"">")
                    End If


                    '  htmlOut.Append("</td><td valign='top' align='left'>")

                    imgCnt += 1
                    sImageName = subscriptionInfo + commonEvo.GenerateFileName("image_" + imgCnt.ToString, ".jpg", False)
                    sImageMapPath = Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath")) + "\" + sImageName
                    sImageSrc = displayFolder + "/" + sImageName

                    AVG_PRICE_MONTH.Titles.Clear()
                    AVG_PRICE_MONTH.Titles.Add("Avg Price By Month (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
                    market_functions.views_display_avg_price_by_month_graph(searchCriteria, Me.AVG_PRICE_MONTH, Graph15, hide_sold_trend_charts, values_avg_asking, ask_price_string)
                    Graph15 = Replace(Graph15, "data1", "data15")
                    AVG_PRICE_MONTH.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                    AVG_PRICE_MONTH.SaveImage(sImageMapPath, DataVisualization.Charting.ChartImageFormat.Jpeg)
                    '  htmlOut.Append("<img src=""" + sImageSrc + """ width=""240"" height=""240"" style=""height:240px; width:240px;"">")
                    '  htmlOut.Append("</td><td valign='top' align='left'>")
                End If


                imgCnt += 1
                sImageName = subscriptionInfo + commonEvo.GenerateFileName("image_" + imgCnt.ToString, ".jpg", False)
                sImageMapPath = Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath")) + "\" + sImageName
                sImageSrc = displayFolder + "/" + sImageName

                PER_MONTH.Titles.Clear()
                PER_MONTH.Titles.Add("Retail Sales Per Month (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
                market_functions.views_display_sold_per_month_graph(searchCriteria, True, Me.PER_MONTH, Graph18)
                PER_MONTH.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                PER_MONTH.SaveImage(sImageMapPath, DataVisualization.Charting.ChartImageFormat.Jpeg)
                '  htmlOut.Append("<img src=""" + sImageSrc + """ width=""240"" height=""240"" style=""height:240px; width:240px;"">")
                '  htmlOut.Append("</td><td valign='top' align='left'>")

                imgCnt += 1
                sImageName = subscriptionInfo + commonEvo.GenerateFileName("image_" + imgCnt.ToString, ".jpg", False)
                sImageMapPath = Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath")) + "\" + sImageName
                sImageSrc = displayFolder + "/" + sImageName

                AVG_DAYS_ON.Titles.Clear()
                AVG_DAYS_ON.Titles.Add("Avg Days On Market (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
                market_functions.views_display_average_days_on_market_graph(searchCriteria, Me.AVG_DAYS_ON, True, Graph100)
                AVG_DAYS_ON.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                AVG_DAYS_ON.SaveImage(sImageMapPath, DataVisualization.Charting.ChartImageFormat.Jpeg)
                ' htmlOut.Append("<img src=""" + sImageSrc + """ width=""240"" height=""240"" style=""height:240px; width:240px;"">")

                If IsNothing(HttpContext.Current.Session.Item("graph_color")) Then
                    HttpContext.Current.Session.Item("graph_color") = "blue"
                End If
                If Not Session.Item("localPreferences").AerodexFlag Then
                    'Avg Asking Price By Month
                    DisplayFunctions.load_google_chart(graph_panel, Graph15, "AVG PRICE BY MONTH", "", "chart_div_tab15_all", 241, 240, "POINTS", 15, charting_string, Me.Page, Me.graph_update_panel, True, True, True, False, False, True, False, False, False, False, 0, "", "", True) ' png15.ClientID

                    'For Sale By Month 
                    DisplayFunctions.load_google_chart(graph_panel, Graph16, "FOR SALE BY MONTH", "", "chart_div_tab16_all", 241, 240, "POINTS", 16, charting_string, Me.Page, Me.graph_update_panel, True, True, True, False, False, True, False, False, False, False, 0, "", "", True) ' png16.ClientID

                    'Sold Per Month
                    DisplayFunctions.load_google_chart(graph_panel, Graph18, "RETAIL SALES PER MONTH", "", "chart_div_tab18_all", 241, 240, "POINTS", 18, charting_string, Me.Page, Me.graph_update_panel, True, True, True, False, False, True, False, False, False, False, 0, "", "", True) ' png18.ClientID

                    'AVG DAYS ON 
                    DisplayFunctions.load_google_chart(graph_panel, Graph100, "AVG DAYS ON MARKET", "", "chart_div_tab100_all", 241, 240, "POINTS", 100, charting_string, Me.Page, Me.graph_update_panel, True, True, True, False, False, True, False, False, False, False, 0, "", "", True) ' png100.ClientID


                    Call DisplayFunctions.load_google_chart_all(charting_string, Me.Page, Me.graph_update_panel)
                End If

            Else

                'If Not Session.Item("localPreferences").AerodexFlag Then

                '  imgCnt += 1
                '  sImageName = subscriptionInfo + commonEvo.GenerateFileName("image_" + imgCnt.ToString, ".jpg", False)
                '  sImageMapPath = Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath")) + "\" + sImageName
                '  sImageSrc = displayFolder + "/" + sImageName

                '  FOR_SALE.Titles.Clear()
                '  FOR_SALE.Titles.Add("For Sale By Month (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
                '  market_functions.views_display_for_sale_by_month_graph(searchCriteria, Me.FOR_SALE, hide_sold_trend_charts)
                '  FOR_SALE.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                '  FOR_SALE.SaveImage(sImageMapPath, DataVisualization.Charting.ChartImageFormat.Jpeg)
                '  htmlOut.Append("<img src=""" + sImageSrc + """ width=""350"" height=""300"" style=""height:300px; width:350px;"">")
                'End If

                'imgCnt += 1
                'sImageName = subscriptionInfo + commonEvo.GenerateFileName("image_" + imgCnt.ToString, ".jpg", False)
                'sImageMapPath = Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath")) + "\" + sImageName
                'sImageSrc = displayFolder + "/" + sImageName

                'AVG_PRICE_MONTH.Titles.Clear()
                'AVG_PRICE_MONTH.Titles.Add("Avg Price By Month (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
                'market_functions.views_display_avg_price_by_month_graph(searchCriteria, Me.AVG_PRICE_MONTH, html_for_google_graph, hide_sold_trend_charts)
                'AVG_PRICE_MONTH.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                'AVG_PRICE_MONTH.SaveImage(sImageMapPath, DataVisualization.Charting.ChartImageFormat.Jpeg)

                'htmlOut.Append("</td><td valign='top' align='left'>")
                'htmlOut.Append("<img src=""" + sImageSrc + """ width=""350"" height=""300"" style=""height:300px; width:350px;"">")


                If Not Session.Item("localPreferences").AerodexFlag Then

                    imgCnt += 1
                    sImageName = subscriptionInfo + commonEvo.GenerateFileName("image_" + imgCnt.ToString, ".jpg", False)
                    sImageMapPath = Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath")) + "\" + sImageName
                    sImageSrc = displayFolder + "/" + sImageName

                    FOR_SALE.Titles.Clear()
                    FOR_SALE.Titles.Add("For Sale By Month (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
                    market_functions.views_display_for_sale_by_month_graph(searchCriteria, Me.FOR_SALE, False, Graph16, values_for_sale, months_string, for_sale_string)
                    FOR_SALE.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                    FOR_SALE.SaveImage(sImageMapPath, DataVisualization.Charting.ChartImageFormat.Jpeg)
                    ' htmlOut.Append("<img src=""" + sImageSrc + """ width=""240"" height=""240"" style=""height:240px; width:240px;"">")
                End If


                '  htmlOut.Append("</td><td valign='top' align='left'>")

                imgCnt += 1
                sImageName = subscriptionInfo + commonEvo.GenerateFileName("image_" + imgCnt.ToString, ".jpg", False)
                sImageMapPath = Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath")) + "\" + sImageName
                sImageSrc = displayFolder + "/" + sImageName

                AVG_PRICE_MONTH.Titles.Clear()
                AVG_PRICE_MONTH.Titles.Add("Avg Price By Month (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
                market_functions.views_display_avg_price_by_month_graph(searchCriteria, Me.AVG_PRICE_MONTH, Graph15, hide_sold_trend_charts, values_avg_asking, ask_price_string)
                Graph15 = Replace(Graph15, "data1", "data15")
                AVG_PRICE_MONTH.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                AVG_PRICE_MONTH.SaveImage(sImageMapPath, DataVisualization.Charting.ChartImageFormat.Jpeg)
                '  htmlOut.Append("<img src=""" + sImageSrc + """ width=""240"" height=""240"" style=""height:240px; width:240px;"">")
                '  htmlOut.Append("</td><td valign='top' align='left'>")


                imgCnt += 1
                sImageName = subscriptionInfo + commonEvo.GenerateFileName("image_" + imgCnt.ToString, ".jpg", False)
                sImageMapPath = Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath")) + "\" + sImageName
                sImageSrc = displayFolder + "/" + sImageName

                ' if the activetab isnt 0, then dont make the graphs so that we are better off and can make other graphs
                If TabContainer1.ActiveTabIndex = 0 Then
                    If IsNothing(HttpContext.Current.Session.Item("graph_color")) Then
                        HttpContext.Current.Session.Item("graph_color") = "blue"
                    End If
                    If Not Session.Item("localPreferences").AerodexFlag Then
                        DisplayFunctions.load_google_chart(graph_panel, Graph15, "AVG PRICE BY MONTH", "", "chart_div_tab15_all", 470, 290, "POINTS", 15, charting_string, Me.Page, Me.graph_update_panel, True, True, True, False, False, True, False, False, False, False, 0, "", "", True) ' png15.ClientID

                        DisplayFunctions.load_google_chart(graph_panel, Graph16, "FOR SALE BY MONTH", "", "chart_div_tab16_all", 470, 290, "POINTS", 16, charting_string, Me.Page, Me.graph_update_panel, True, True, True, False, False, True, False, False, False, False, 0, "", "", True) ' png16.ClientID
                    End If

                    Call DisplayFunctions.load_google_chart_all(charting_string, Me.Page, Me.graph_update_panel)
                End If
            End If


            If Trim(months_string) <> "" Then
                months_array = Split(months_string, ",")
                for_sale_array = Split(for_sale_string, ",")
                asking_price_array = Split(ask_price_string, ",")

                excel_string.Append("<table cellspacing='0' cellpadding='4' border='1'>")
                excel_string.Append("<tr><td align='center' colspan='3'><b>Market Summary for " & make_model_name & "</b></td></tr>")
                excel_string.Append("<tr><td align='left'><b>Month</b></td><td><b>Aircraft for Sale</b></td><td><b>Average Asking Price</b></td></tr>")

                For i = 0 To UBound(months_array)
                    If UBound(asking_price_array) >= i And UBound(for_sale_array) >= i Then
                        If Trim(months_array(i)) = "" Or Trim(for_sale_array(i)) = "" Or Trim(asking_price_array(i)) = "" Then
                            i = i
                        Else
                            excel_string.Append("<tr>")
                            excel_string.Append("<td align='right'>")
                            excel_string.Append(Trim(months_array(i)))
                            excel_string.Append("</td>")
                            excel_string.Append("<td align='right'>" & Trim(for_sale_array(i)) & "</td>")
                            excel_string.Append("<td align='right'>$" & Trim(FormatNumber(asking_price_array(i), 0)) & "</td>")
                            excel_string.Append("</tr>")
                        End If
                    End If
                Next
                excel_string.Append("</table>")

                'excel_table = excel_string.ToString.Trim
                CommonAircraftFunctions.Build_String_To_HTML(excel_string.ToString.Trim, HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix & searchCriteria.ViewCriteriaAmodID & "_model_asking_sold_export.xls")
                excel_table = "<a href='/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix & searchCriteria.ViewCriteriaAmodID & "_model_asking_sold_export.xls' target='_blank'>Export Model Asking Price Report To Excel</a>"
            End If


            'htmlOut.Append("</td></tr>")
            htmlOut.Append("</table>")
            htmlOut.Append("</td></tr></table>")
            If hide_sold_trend_charts Then
                '   htmlOut.Append("</div>")
            End If


        Catch ex As Exception

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [Build_Market_trends_tab] : " + ex.Message

        Finally

        End Try

        out_htmlString = htmlOut.ToString
        htmlOut = Nothing
        market_functions = Nothing

    End Sub

    Private Sub Build_Market_summary_tab(ByRef searchCriteria As viewSelectionCriteriaClass, ByRef out_htmlString As String, ByVal modelImage As String)

        Dim htmlOut As New StringBuilder
        Dim htmlUpDown As String = ""

        Dim tmpWtCls As String = ""
        Dim tmpTitle As String = ""

        Dim imgCnt As Integer = 0

        Dim sImageMapPath As String = ""
        Dim sImageSrc As String = ""
        Dim sImageName As String = ""
        Dim skip_graphs As Boolean = False

        Dim subscriptionInfo As String = Session.Item("localUser").crmSubSubID.ToString + "_" + Session.Item("localUser").crmUserLogin.ToString.Trim + "_" + Session.Item("localUser").crmSubSeqNo.ToString + "_"
        Dim displayFolder As String = HttpContext.Current.Application.Item("crmClientSiteData").ClientFullHostName + HttpContext.Current.Session.Item("MarketSummaryFolderVirtualPath")

        Dim market_functions As New market_model_functions

        values_for_sale = 0
        values_dom = 0
        values_in_op = 0
        values_total_inop = 0
        values_for_sale_exclusive = 0
        values_lease = 0
        values_abs_rate = 0
        values_per1 = 0
        values_per2 = 0
        values_per3 = 0

        values_avg_asking = 0
        values_avg_asking_display = 0
        values_forsale_avg_low = 0
        values_forsale_avg_high = 0

        values_mfr_avg_low = 0
        values_mfr_avg_high = 0
        values_mfr_avg = 0

        values_days_low = 0
        values_days_high = 0
        values_days_avg = 0

        values_aftt_low = 0
        values_aftt_high = 0
        values_aftt_avg = 0
        values_avg_asking_graph = 0

        landings_low = 0
        landings_high = 0
        landings_avg = 0
        landings_sum = 0
        landings_count = 0

        evalues_low = 0
        evalues_avg = 0
        evalues_high = 0


        Try

            market_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            market_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            market_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            market_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            market_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim



            If displayEValues Then
                'Look up these three variables - evalues_low, evalues_high, evalues_avg
                Dim CurrentTable As New DataTable
                Dim utilization_Vfunctions As New utilization_view_functions
                utilization_Vfunctions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
                utilization_Vfunctions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
                utilization_Vfunctions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
                utilization_Vfunctions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
                utilization_Vfunctions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

                CurrentTable = utilization_Vfunctions.get_current_month_assett_summary(searchCriteria)
                If Not IsNothing(CurrentTable) Then
                    If CurrentTable.Rows.Count > 0 Then
                        If Not IsDBNull(CurrentTable.Rows(0).Item("AVGVALUE")) Then
                            evalues_avg = CurrentTable.Rows(0).Item("AVGVALUE")
                        End If
                        If Not IsDBNull(CurrentTable.Rows(0).Item("HIGHVALUE")) Then
                            evalues_high = CurrentTable.Rows(0).Item("HIGHVALUE")
                        End If
                        If Not IsDBNull(CurrentTable.Rows(0).Item("AVGVALUE")) Then
                            evalues_low = CurrentTable.Rows(0).Item("LOWVALUE")
                        End If

                    End If
                End If

            End If





            If CRMViewActive Then
                crmViewDataLayer.Combined_views_display_fleet_market_summary(searchCriteria, Build_FleetMarketSummary_text, GetMarketStatus, localDatalayer, ClientIDSToExclude, CRMViewActive, True, 0, 0, 0, values_for_sale, values_dom, values_in_op, values_total_inop, values_for_sale_exclusive, values_lease, values_abs_rate, values_per1, values_per2, values_per3, values_forsale_avg_high, values_forsale_avg_low, values_mfr_avg_low, values_mfr_avg_high, values_mfr_avg, values_days_low, values_days_high, values_days_avg, values_aftt_low, values_aftt_high, values_aftt_avg, values_avg_asking_display, modelImage, landings_high, landings_low, landings_avg, landings_sum, landings_count)
            Else
                market_functions.views_display_fleet_market_summary(searchCriteria, Build_FleetMarketSummary_text, GetMarketStatus, "", searchCriteria.ViewCriteriaTimeSpan, values_for_sale, values_dom, values_avg_asking, values_in_op, values_total_inop, values_for_sale_exclusive, values_lease, values_abs_rate, values_per1, values_per2, values_per3, values_forsale_avg_high, values_forsale_avg_low, values_mfr_avg_low, values_mfr_avg_high, values_mfr_avg, values_days_low, values_days_high, values_days_avg, values_aftt_low, values_aftt_high, values_aftt_avg, values_avg_asking_display, modelImage, Nothing, Nothing, 0, landings_high, landings_low, landings_avg, landings_sum, landings_count)
            End If


            If View_ID = 16 Then

                Select Case searchCriteria.ViewCriteriaWeightClass.ToUpper
                    Case "V"
                        tmpWtCls = " - WtCls : Very Light Jet"
                    Case "L"
                        tmpWtCls = " - WtCls : Light"
                    Case "M"
                        tmpWtCls = " - WtCls : Medium"
                    Case "H"
                        tmpWtCls = " - WtCls : Heavy"
                End Select

                If searchCriteria.ViewCriteriaAmodID > -1 Or Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaAircraftMake) Then
                    tmpWtCls = ""
                End If

                Dim ForSaleTitle As String = ""
                Dim AvgPriceTitle As String = ""
                Dim PerMonthTitle As String = ""

                If searchCriteria.ViewCriteriaAmodID = -1 And String.IsNullOrEmpty(searchCriteria.ViewCriteriaAircraftMake) Then
                    viewHeaderLabel.Text = "Industry at a Glance" + tmpWtCls

                    'FOR_SALE.Titles.Clear()
                    'FOR_SALE.Titles.Add("For Sale By Month (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
                    ForSaleTitle = "For Sale By Month<br /><span class=""tiny "">past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months</span>"

                    ' AVG_PRICE_MONTH.Titles.Clear()
                    ' AVG_PRICE_MONTH.Titles.Add("Avg Price By Month (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
                    AvgPriceTitle = "Avg Price By Month<br /><span class=""tiny"">past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months</span>"

                    ' PER_MONTH.Titles.Clear()
                    ' PER_MONTH.Titles.Add("Sold Per Month (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
                    PerMonthTitle = "Sold Per Month<br /><span class=""tiny"">past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months</span>"
                Else
                    If Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaAircraftMake) And Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaAircraftModel) Then

                        ' multiple makes
                        If Not IsNothing(searchCriteria.ViewCriteriaMakeIDArray) Then
                            tmpTitle = "_make_" + searchCriteria.ViewCriteriaMakeIDArray.Length.ToString
                        Else
                            tmpTitle = "_" + searchCriteria.ViewCriteriaAircraftMake
                        End If

                        ' multiple models
                        If Not IsNothing(searchCriteria.ViewCriteriaAmodIDArray) Then
                            tmpTitle = "_model_" + searchCriteria.ViewCriteriaAmodIDArray.Length.ToString
                        Else
                            tmpTitle = "_" + searchCriteria.ViewCriteriaAircraftModel
                        End If

                        'FOR_SALE.Titles.Clear()
                        'FOR_SALE.Titles.Add("Selected Makes/Models For Sale By Month (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
                        ForSaleTitle = "Selected Makes/Models For Sale By Month<br /><span class=""tiny"">past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months</span>"

                        ' AVG_PRICE_MONTH.Titles.Clear()
                        ' AVG_PRICE_MONTH.Titles.Add("Selected Makes/Models Avg Price By Month (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
                        AvgPriceTitle = "Selected Makes/Models Avg Price By Month<br /><span class=""tiny"">past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months</span>"

                        ' PER_MONTH.Titles.Clear()
                        ' PER_MONTH.Titles.Add("Selected Makes/Models  Sold Per Month (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
                        PerMonthTitle = "Selected Makes/Models  Sold Per Month<br /><span class=""tiny"">past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months</span>"

                        tmpTitle = "_" + searchCriteria.ViewCriteriaAircraftMake + "_" + searchCriteria.ViewCriteriaAmodID.ToString
                    ElseIf Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaAircraftMake) Then

                        ' multiple makes
                        If Not IsNothing(searchCriteria.ViewCriteriaMakeIDArray) Then
                            tmpTitle = "_make_" + searchCriteria.ViewCriteriaMakeIDArray.Length.ToString
                            'FOR_SALE.Titles.Clear()
                            'FOR_SALE.Titles.Add("Selected Makes For Sale By Month (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
                            ForSaleTitle = "Selected Makes For Sale By Month<br /><span class=""tiny"">past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months</span>"


                            'AVG_PRICE_MONTH.Titles.Clear()
                            'AVG_PRICE_MONTH.Titles.Add("Selected Makes Avg Price By Month (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
                            AvgPriceTitle = "Selected Makes Avg Price By Month<br /><span class=""tiny"">past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months</span>"

                            'PER_MONTH.Titles.Clear()
                            'PER_MONTH.Titles.Add("Selected Makes Sold Per Month (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
                            PerMonthTitle = "Selected Makes Sold Per Month<br /><span class=""tiny"">past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months</span>"

                        Else
                            tmpTitle = "_" + searchCriteria.ViewCriteriaAircraftMake
                            'FOR_SALE.Titles.Clear()
                            'FOR_SALE.Titles.Add(searchCriteria.ViewCriteriaAircraftMake + " For Sale By Month (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
                            ForSaleTitle = searchCriteria.ViewCriteriaAircraftMake + " For Sale By Month<br /><span class=""tiny"">past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months</span>"

                            'AVG_PRICE_MONTH.Titles.Clear()
                            'AVG_PRICE_MONTH.Titles.Add(searchCriteria.ViewCriteriaAircraftMake + " Avg Price By Month (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
                            AvgPriceTitle = searchCriteria.ViewCriteriaAircraftMake + " Avg Price By Month<br /><span class=""tiny"">past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months</span>"

                            'PER_MONTH.Titles.Clear()
                            'PER_MONTH.Titles.Add(searchCriteria.ViewCriteriaAircraftMake + " Sold Per Month (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
                            PerMonthTitle = searchCriteria.ViewCriteriaAircraftMake + " Sold Per Month<br /><span class=""tiny"">past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months</span>"

                        End If

                    ElseIf Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaAircraftModel) Then

                        ' multiple models
                        If Not IsNothing(searchCriteria.ViewCriteriaAmodIDArray) Then
                            tmpTitle = "_model_" + searchCriteria.ViewCriteriaAmodIDArray.Length.ToString
                            'FOR_SALE.Titles.Clear()
                            'FOR_SALE.Titles.Add("Selected Models For Sale By Month (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
                            ForSaleTitle = "Selected Models For Sale By Month<br /><span class=""tiny"">past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months</span>"

                            'AVG_PRICE_MONTH.Titles.Clear()
                            ' AVG_PRICE_MONTH.Titles.Add("Selected Models Avg Price By Month (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months</span>")
                            AvgPriceTitle = "Selected Models Avg Price By Month<br /><span class=""tiny"">past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months</span>"

                            ' PER_MONTH.Titles.Clear()
                            'PER_MONTH.Titles.Add("Selected Models Sold Per Month (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
                            PerMonthTitle = "Selected Models Sold Per Month<br /><span class=""tiny"">past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months</span>"
                        Else
                            tmpTitle = "_" + searchCriteria.ViewCriteriaAircraftModel
                            'FOR_SALE.Titles.Clear()
                            ' FOR_SALE.Titles.Add(searchCriteria.ViewCriteriaAircraftModel + " For Sale By Month (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
                            ForSaleTitle = searchCriteria.ViewCriteriaAircraftModel + " For Sale By Month<br /><span class=""tiny"">past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months</span>"

                            'AVG_PRICE_MONTH.Titles.Clear()
                            ' AVG_PRICE_MONTH.Titles.Add(searchCriteria.ViewCriteriaAircraftModel + " Avg Price By Month (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
                            AvgPriceTitle = searchCriteria.ViewCriteriaAircraftModel + " Avg Price By Month<br /><span class=""tiny"">past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months</span>"

                            ' PER_MONTH.Titles.Clear()
                            'PER_MONTH.Titles.Add(searchCriteria.ViewCriteriaAircraftModel + " Sold Per Month (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
                            PerMonthTitle = searchCriteria.ViewCriteriaAircraftModel + " Sold Per Month<br /><span class=""tiny"">past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months</span>)"
                        End If

                    End If
                End If


                htmlOut.Append("<div Class="" valueSpec aircraftListing Simplistic gray_background viewBoxMargin smallSpaceText"">")

                htmlOut.Append(Build_FleetMarketSummary_text)

                market_functions.views_display_avg_price_by_month_graph(searchCriteria, Me.AVG_PRICE_MONTH)
                AVG_PRICE_MONTH.ImageType = DataVisualization.Charting.ChartImageType.Jpeg

                imgCnt += 1
                sImageName = subscriptionInfo + commonEvo.GenerateFileName("image_" + imgCnt.ToString, ".jpg", False)

                sImageMapPath = Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath")) + "\" + sImageName
                sImageSrc = displayFolder + "/" + sImageName

                AVG_PRICE_MONTH.SaveImage(sImageMapPath, DataVisualization.Charting.ChartImageFormat.Jpeg)

                htmlOut.Append("<div class=""row""><div class=""four columns enableMarginColumn""><div class=""Box""><strong class=""subHeader"">" & AvgPriceTitle & "</strong><img src=""" + sImageSrc + """ /></div></div>")



                market_functions.views_display_sold_per_month_graph(searchCriteria, True, Me.PER_MONTH)
                PER_MONTH.ImageType = DataVisualization.Charting.ChartImageType.Jpeg

                imgCnt += 1
                sImageName = subscriptionInfo + commonEvo.GenerateFileName("image_" + imgCnt.ToString, ".jpg", False)
                sImageMapPath = Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath")) + "\" + sImageName
                sImageSrc = displayFolder + "/" + sImageName

                PER_MONTH.SaveImage(sImageMapPath, DataVisualization.Charting.ChartImageFormat.Jpeg)
                htmlOut.Append("<div class=""four columns enableMarginColumn""><div class=""Box""><strong class=""subHeader"">" & PerMonthTitle & "</strong><img src=""" + sImageSrc + """ /></div></div>")

                market_functions.views_display_for_sale_by_month_graph(searchCriteria, Me.FOR_SALE)
                FOR_SALE.ImageType = DataVisualization.Charting.ChartImageType.Jpeg

                imgCnt += 1
                sImageName = subscriptionInfo + commonEvo.GenerateFileName("image_" + imgCnt.ToString, ".jpg", False)
                sImageMapPath = Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath")) + "\" + sImageName
                sImageSrc = displayFolder + "/" + sImageName

                FOR_SALE.SaveImage(sImageMapPath, DataVisualization.Charting.ChartImageFormat.Jpeg)

                htmlOut.Append("<div class=""four columns enableMarginColumn""><div class=""Box""><strong class=""subHeader"">" & ForSaleTitle & "</strong><img src=""" + sImageSrc + """ />")
                htmlOut.Append("</div></div></div>")

                If Not String.IsNullOrEmpty(GetMarketStatus) Then
                    htmlOut.Append("<div class=""row"" style=""margin-right:2% !important;""><div class=""eight columns enableMarginColumn"" style=""width:64.6% !important""><div class=""Box"">")
                    market_functions.views_display_market_up_down_one_model(searchCriteria, htmlUpDown)
                    htmlOut.Append(htmlUpDown + "</div></div>")
                    htmlOut.Append("<div class=""four columns enableMarginColumn"" style=""width:31.4% !important""><div class=""Box noAlt"">" & GetMarketStatus & "</div></div>")
                Else
                    htmlOut.Append("<div class=""row"" style=""margin-right:4% !important;""><div class=""twelve columns enableMarginColumn""><div class=""Box"">")
                    market_functions.views_display_market_up_down_one_model(searchCriteria, htmlUpDown)
                    htmlOut.Append(htmlUpDown + "</div></div>")
                    htmlOut.Append("<div class=""four columns enableMarginColumn""><div class=""Box noAlt"">" & GetMarketStatus & "</div></div>")
                End If

                htmlOut.Append("</div>")


            Else

                If Not Session.Item("localPreferences").AerodexFlag Then

                    htmlOut.Append("<div Class="" valueSpec aircraftListing Simplistic gray_background viewBoxMargin smallSpaceText"">")

                    'If CRMViewActive Then
                    '  htmlOut.Append(JetnetClientSourceText)
                    'End If

                    htmlOut.Append(GetMarketStatus)
                    htmlOut.Append("</div>")

                    htmlOut.Append("</div>")

                End If

            End If

        Catch ex As Exception

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [Build_Market_summary_tab] : " + ex.Message

        Finally

        End Try

        out_htmlString = htmlOut.ToString()
        htmlOut = Nothing
        market_functions = Nothing

    End Sub

    Private Sub Build_Model_Compare_tab(ByRef searchCriteria As viewSelectionCriteriaClass, ByRef out_htmlString As String)

        Dim htmlOut As New StringBuilder

        Dim sHtmlCompareAircraftSummary As String = ""
        Dim sHtmlCompareMarketStatus As String = ""
        Dim sHtmlCompareModelPic As String = ""

        Dim imgCnt As Integer = 0

        Dim sImageMapPath As String = ""
        Dim sImageSrc As String = ""
        Dim sImageName As String = ""

        Dim tmpCriteria As viewSelectionCriteriaClass = New viewSelectionCriteriaClass

        Dim subscriptionInfo As String = Session.Item("localUser").crmSubSubID.ToString + "_" + Session.Item("localUser").crmUserLogin.ToString.Trim + "_" + Session.Item("localUser").crmSubSeqNo.ToString + "_"
        Dim displayFolder As String = HttpContext.Current.Application.Item("crmClientSiteData").ClientFullHostName + HttpContext.Current.Session.Item("MarketSummaryFolderVirtualPath")

        Dim market_functions As New market_model_functions

        Dim bAerodexFlag As Boolean = HttpContext.Current.Session.Item("localPreferences").AerodexFlag.ToString.ToLower()

        Try

            market_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            market_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            market_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            market_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            market_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

            htmlOut.Append("<table id='modelCompareViewOuterTable' width='100%' cellpadding='0' cellspacing='0' class='module'>")
            htmlOut.Append("<tr><td align='left' valign='bottom'>")

            htmlOut.Append("<table id='modelCompareViewInnerTable' width='100%' cellpadding='4' cellspacing='0'>")

            If Not String.IsNullOrEmpty(compare_amod_id_c.SelectedValue) Then
                htmlOut.Append("<tr><td align='center' valign='top' width='33%'>")
            Else
                htmlOut.Append("<tr><td align='center' valign='top' width='50%'>")
            End If

            tmpCriteria = searchCriteria

            ' set first make/model
            tmpCriteria.ViewCriteriaAmodID = CLng(compare_amod_id_a.SelectedValue)
            tmpCriteria.ViewCriteriaTimeSpan = 6
            tmpCriteria.ViewCriteriaSecondAmodID = -1
            tmpCriteria.ViewCriteriaThirdAmodID = -1
            tmpCriteria.ViewID = 2

            htmlOut.Append("<br /><strong>First Model : " + commonEvo.Get_Aircraft_Model_Info(tmpCriteria.ViewCriteriaAmodID, False, "") + "</strong><br />")

            ' matt this is the correct way of createing "back links to the view" you have to URLENCODE the "VIEW NAME"
            htmlOut.Append("<a href='view_template.aspx?ViewID=1&ViewName=" + Server.UrlEncode("Model Market Summary") + "&amod_id=" + tmpCriteria.ViewCriteriaAmodID.ToString + "'>Click for Model Market Summary</a><br />")

            If searchCriteria.ViewCriteriaAmodID > -1 Then

                localDatalayer.views_display_model_pic(tmpCriteria, sHtmlCompareModelPic)
                htmlOut.Append(sHtmlCompareModelPic + "<br /><br />")

            End If

            market_functions.views_display_fleet_market_summary(tmpCriteria, sHtmlCompareAircraftSummary, sHtmlCompareMarketStatus)

            htmlOut.Append(sHtmlCompareAircraftSummary)

            htmlOut.Append("<br />")

            If Not bAerodexFlag Then 'Changed this if to include the trends graphs down below so they're shut off for Aero
                htmlOut.Append(sHtmlCompareMarketStatus)

                If Not Session.Item("localPreferences").isCommercialOnlyProduct Then
                    htmlOut.Append("<br /><br />")

                    imgCnt += 1
                    sImageName = subscriptionInfo + commonEvo.GenerateFileName("image_" + imgCnt.ToString, ".jpg", False)
                    sImageMapPath = Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath")) + "\" + sImageName
                    sImageSrc = displayFolder + "/" + sImageName

                    AVG_PRICE_MONTH.Titles.Clear()
                    AVG_PRICE_MONTH.Titles.Add("Avg Price By Month (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
                    AVG_PRICE_MONTH.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                    market_functions.views_display_avg_price_by_month_graph(tmpCriteria, Me.AVG_PRICE_MONTH)
                    AVG_PRICE_MONTH.SaveImage(sImageMapPath, DataVisualization.Charting.ChartImageFormat.Jpeg)
                    htmlOut.Append("<img src=""" + sImageSrc + """ width=""260"" height=""260"" style=""height:260px; width:260px;"">")

                    htmlOut.Append("<br /><br />")

                    imgCnt += 1
                    sImageName = subscriptionInfo + commonEvo.GenerateFileName("image_" + imgCnt.ToString, ".jpg", False)
                    sImageMapPath = Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath")) + "\" + sImageName
                    sImageSrc = displayFolder + "/" + sImageName

                    FOR_SALE.Titles.Clear()
                    FOR_SALE.Titles.Add("For Sale By Month (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
                    market_functions.views_display_for_sale_by_month_graph(tmpCriteria, Me.FOR_SALE)
                    FOR_SALE.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                    FOR_SALE.SaveImage(sImageMapPath, DataVisualization.Charting.ChartImageFormat.Jpeg)
                    htmlOut.Append("<img src=""" + sImageSrc + """ width=""260"" height=""260"" style=""height:260px; width:260px;"">")
                End If

                htmlOut.Append("<br /><br />")

                imgCnt += 1
                sImageName = subscriptionInfo + commonEvo.GenerateFileName("image_" + imgCnt.ToString, ".jpg", False)
                sImageMapPath = Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath")) + "\" + sImageName
                sImageSrc = displayFolder + "/" + sImageName

                PER_MONTH.Titles.Clear()
                PER_MONTH.Titles.Add("Sold Per Month (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
                market_functions.views_display_sold_per_month_graph(tmpCriteria, True, Me.PER_MONTH)
                PER_MONTH.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                PER_MONTH.SaveImage(sImageMapPath, DataVisualization.Charting.ChartImageFormat.Jpeg)
                htmlOut.Append("<img src=""" + sImageSrc + """ width=""260"" height=""260"" style=""height:260px; width:260px;"">")

                If Not Session.Item("localPreferences").isCommercialOnlyProduct Then
                    htmlOut.Append("<br /><br />")

                    imgCnt += 1
                    sImageName = subscriptionInfo + commonEvo.GenerateFileName("image_" + imgCnt.ToString, ".jpg", False)
                    sImageMapPath = Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath")) + "\" + sImageName
                    sImageSrc = displayFolder + "/" + sImageName

                    AVG_DAYS_ON.Titles.Clear()
                    AVG_DAYS_ON.Titles.Add("Avg Days on Market (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
                    market_functions.views_display_average_days_on_market_graph(tmpCriteria, Me.AVG_DAYS_ON)
                    AVG_DAYS_ON.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                    AVG_DAYS_ON.SaveImage(sImageMapPath, DataVisualization.Charting.ChartImageFormat.Jpeg)
                    htmlOut.Append("<img src=""" + sImageSrc + """ width=""260"" height=""260"" style=""height:260px; width:260px;"">")
                End If
            End If

            If Not String.IsNullOrEmpty(compare_amod_id_c.SelectedValue) Then
                htmlOut.Append("</td><td align='center' valign='top' width='33%'>")
            Else
                htmlOut.Append("</td><td align='center' valign='top' width='50%'>")
            End If

            ' set second make/model
            tmpCriteria.ViewCriteriaAmodID = -1
            tmpCriteria.ViewCriteriaSecondAmodID = CLng(compare_amod_id_b.SelectedValue)
            tmpCriteria.ViewCriteriaTimeSpan = 6
            tmpCriteria.ViewCriteriaThirdAmodID = -1
            tmpCriteria.ViewID = 2

            htmlOut.Append("<br /><strong>Second Model : " + commonEvo.Get_Aircraft_Model_Info(tmpCriteria.ViewCriteriaSecondAmodID, False, "") + "</strong><br />")

            ' matt this is the correct way of createing "back links to the view" you have to URLENCODE the "VIEW NAME"
            htmlOut.Append("<a href='view_template.aspx?ViewID=1&ViewName=" + Server.UrlEncode("Model Market Summary") + "&amod_id=" + tmpCriteria.ViewCriteriaSecondAmodID.ToString + "'>Click for Model Market Summary</a><br />")

            If searchCriteria.ViewCriteriaSecondAmodID > -1 Then

                localDatalayer.views_display_model_pic(tmpCriteria, sHtmlCompareModelPic)
                htmlOut.Append(sHtmlCompareModelPic + "<br /><br />")

            End If

            market_functions.views_display_fleet_market_summary(tmpCriteria, sHtmlCompareAircraftSummary, sHtmlCompareMarketStatus)

            htmlOut.Append(sHtmlCompareAircraftSummary)

            htmlOut.Append("<br />")

            If Not bAerodexFlag Then 'Changed this if to include the trends graphs down below so they're shut off for Aero
                htmlOut.Append(sHtmlCompareMarketStatus)

                If Not Session.Item("localPreferences").isCommercialOnlyProduct Then
                    htmlOut.Append("<br /><br />")

                    imgCnt += 1
                    sImageName = subscriptionInfo + commonEvo.GenerateFileName("image_" + imgCnt.ToString, ".jpg", False)
                    sImageMapPath = Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath")) + "\" + sImageName
                    sImageSrc = displayFolder + "/" + sImageName

                    AVG_PRICE_MONTH.Titles.Clear()
                    AVG_PRICE_MONTH.Titles.Add("Avg Price By Month (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
                    AVG_PRICE_MONTH.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                    market_functions.views_display_avg_price_by_month_graph(tmpCriteria, Me.AVG_PRICE_MONTH)
                    AVG_PRICE_MONTH.SaveImage(sImageMapPath, DataVisualization.Charting.ChartImageFormat.Jpeg)
                    htmlOut.Append("<img src=""" + sImageSrc + """ width=""260"" height=""260"" style=""height:260px; width:260px;"">")

                    htmlOut.Append("<br /><br />")

                    imgCnt += 1
                    sImageName = subscriptionInfo + commonEvo.GenerateFileName("image_" + imgCnt.ToString, ".jpg", False)
                    sImageMapPath = Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath")) + "\" + sImageName
                    sImageSrc = displayFolder + "/" + sImageName

                    FOR_SALE.Titles.Clear()
                    FOR_SALE.Titles.Add("For Sale By Month (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
                    FOR_SALE.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                    market_functions.views_display_for_sale_by_month_graph(tmpCriteria, Me.FOR_SALE)
                    FOR_SALE.SaveImage(sImageMapPath, DataVisualization.Charting.ChartImageFormat.Jpeg)
                    htmlOut.Append("<img src=""" + sImageSrc + """ width=""260"" height=""260"" style=""height:260px; width:260px;"">")
                End If

                htmlOut.Append("<br /><br />")

                imgCnt += 1
                sImageName = subscriptionInfo + commonEvo.GenerateFileName("image_" + imgCnt.ToString, ".jpg", False)
                sImageMapPath = Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath")) + "\" + sImageName
                sImageSrc = displayFolder + "/" + sImageName

                PER_MONTH.Titles.Clear()
                PER_MONTH.Titles.Add("Sold Per Month (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
                market_functions.views_display_sold_per_month_graph(tmpCriteria, True, Me.PER_MONTH)
                PER_MONTH.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                PER_MONTH.SaveImage(sImageMapPath, DataVisualization.Charting.ChartImageFormat.Jpeg)
                htmlOut.Append("<img src=""" + sImageSrc + """ width=""260"" height=""260"" style=""height:260px; width:260px;"">")

                If Not Session.Item("localPreferences").isCommercialOnlyProduct Then
                    htmlOut.Append("<br /><br />")

                    imgCnt += 1
                    sImageName = subscriptionInfo + commonEvo.GenerateFileName("image_" + imgCnt.ToString, ".jpg", False)
                    sImageMapPath = Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath")) + "\" + sImageName
                    sImageSrc = displayFolder + "/" + sImageName

                    AVG_DAYS_ON.Titles.Clear()
                    AVG_DAYS_ON.Titles.Add("Avg Days on Market (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
                    market_functions.views_display_average_days_on_market_graph(tmpCriteria, Me.AVG_DAYS_ON)
                    AVG_DAYS_ON.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                    AVG_DAYS_ON.SaveImage(sImageMapPath, DataVisualization.Charting.ChartImageFormat.Jpeg)
                    htmlOut.Append("<img src=""" + sImageSrc + """ width=""260"" height=""260"" style=""height:260px; width:260px;"">")
                End If
            End If

            If Not String.IsNullOrEmpty(compare_amod_id_c.SelectedValue) Then
                htmlOut.Append("</td><td align='center' valign='top' width='33%'>")

                ' set third make/model
                tmpCriteria.ViewCriteriaAmodID = -1
                tmpCriteria.ViewCriteriaSecondAmodID = -1
                tmpCriteria.ViewCriteriaThirdAmodID = CLng(compare_amod_id_c.SelectedValue)
                tmpCriteria.ViewCriteriaTimeSpan = 6
                tmpCriteria.ViewID = 2

                htmlOut.Append("<br /><strong>Third Model : " + commonEvo.Get_Aircraft_Model_Info(tmpCriteria.ViewCriteriaThirdAmodID, False, "") + "</strong><br />")
                ' matt this is the correct way of createing "back links to the view" you have to URLENCODE the "VIEW NAME"
                htmlOut.Append("<a href='view_template.aspx?ViewID=1&ViewName=" + Server.UrlEncode("Model Market Summary") + "&amod_id=" + tmpCriteria.ViewCriteriaThirdAmodID.ToString + "'>Click for Model Market Summary</a><br />")

                If searchCriteria.ViewCriteriaThirdAmodID > -1 Then

                    localDatalayer.views_display_model_pic(tmpCriteria, sHtmlCompareModelPic)
                    htmlOut.Append(sHtmlCompareModelPic + "<br /><br />")

                End If

                market_functions.views_display_fleet_market_summary(tmpCriteria, sHtmlCompareAircraftSummary, sHtmlCompareMarketStatus)

                htmlOut.Append(sHtmlCompareAircraftSummary)

                htmlOut.Append("<br />")

                If Not bAerodexFlag Then
                    htmlOut.Append(sHtmlCompareMarketStatus)

                    If Not Session.Item("localPreferences").isCommercialOnlyProduct Then
                        htmlOut.Append("<br /><br />")

                        imgCnt += 1
                        sImageName = subscriptionInfo + commonEvo.GenerateFileName("image_" + imgCnt.ToString, ".jpg", False)
                        sImageMapPath = Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath")) + "\" + sImageName
                        sImageSrc = displayFolder + "/" + sImageName

                        AVG_PRICE_MONTH.Titles.Clear()
                        AVG_PRICE_MONTH.Titles.Add("Avg Price By Month (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
                        AVG_PRICE_MONTH.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                        market_functions.views_display_avg_price_by_month_graph(tmpCriteria, Me.AVG_PRICE_MONTH)
                        AVG_PRICE_MONTH.SaveImage(sImageMapPath, DataVisualization.Charting.ChartImageFormat.Jpeg)
                        htmlOut.Append("<img src=""" + sImageSrc + """ width=""260"" height=""260"" style=""height:260px; width:260px;"">")

                        htmlOut.Append("<br /><br />")

                        imgCnt += 1
                        sImageName = subscriptionInfo + commonEvo.GenerateFileName("image_" + imgCnt.ToString, ".jpg", False)
                        sImageMapPath = Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath")) + "\" + sImageName
                        sImageSrc = displayFolder + "/" + sImageName

                        FOR_SALE.Titles.Clear()
                        FOR_SALE.Titles.Add("For Sale By Month (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
                        market_functions.views_display_for_sale_by_month_graph(tmpCriteria, Me.FOR_SALE)
                        FOR_SALE.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                        FOR_SALE.SaveImage(sImageMapPath, DataVisualization.Charting.ChartImageFormat.Jpeg)
                        htmlOut.Append("<img src=""" + sImageSrc + """ width=""260"" height=""260"" style=""height:260px; width:260px;"">")
                    End If
                    htmlOut.Append("<br /><br />")

                    imgCnt += 1
                    sImageName = subscriptionInfo + commonEvo.GenerateFileName("image_" + imgCnt.ToString, ".jpg", False)
                    sImageMapPath = Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath")) + "\" + sImageName
                    sImageSrc = displayFolder + "/" + sImageName

                    PER_MONTH.Titles.Clear()
                    PER_MONTH.Titles.Add("Sold Per Month (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
                    market_functions.views_display_sold_per_month_graph(tmpCriteria, True, Me.PER_MONTH)
                    PER_MONTH.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                    PER_MONTH.SaveImage(sImageMapPath, DataVisualization.Charting.ChartImageFormat.Jpeg)
                    htmlOut.Append("<img src=""" + sImageSrc + """ width=""260"" height=""260"" style=""height:260px; width:260px;"">")

                    If Not Session.Item("localPreferences").isCommercialOnlyProduct Then
                        htmlOut.Append("<br /><br />")

                        imgCnt += 1
                        sImageName = subscriptionInfo + commonEvo.GenerateFileName("image_" + imgCnt.ToString, ".jpg", False)
                        sImageMapPath = Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath")) + "\" + sImageName
                        sImageSrc = displayFolder + "/" + sImageName

                        AVG_DAYS_ON.Titles.Clear()
                        AVG_DAYS_ON.Titles.Add("Avg Days on Market (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
                        market_functions.views_display_average_days_on_market_graph(tmpCriteria, Me.AVG_DAYS_ON)
                        AVG_DAYS_ON.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                        AVG_DAYS_ON.SaveImage(sImageMapPath, DataVisualization.Charting.ChartImageFormat.Jpeg)
                        htmlOut.Append("<img src=""" + sImageSrc + """ width=""260"" height=""260"" style=""height:260px; width:260px;"">")
                    End If
                End If

            End If

            htmlOut.Append("</td></tr></table>") ' inner view table
            htmlOut.Append("</td></tr></table>") ' outter view table

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [Build_ModelCompare_tab] : " + ex.Message
        End Try

        out_htmlString = htmlOut.ToString()
        htmlOut = Nothing
        market_functions = Nothing

    End Sub

    Private Sub Build_News_tab(ByRef searchCriteria As viewSelectionCriteriaClass)

        Try

            view_news_label1.Text = "<div style='height:370px; width:100%; overflow: auto;'>"

            If CRMViewActive Then
                view_news_label1.Text += JetnetSourceText
            End If

            view_news_label1.Text += "<table width=""100%"" cellpadding=""0"" cellspacing=""0"" class=""module""><tr><td align=""left"" valign=""top"">"

            Dim sMakeModelNews As String = ""
            localDatalayer.views_display_make_model_news(searchCriteria, sMakeModelNews, CRMViewActive)

            view_news_label1.Text += vbCrLf + sMakeModelNews + vbCrLf
            view_news_label1.Text += "</td></tr></table>"
            view_news_label1.Text += "</div>"

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [Build_News_tab] : " + ex.Message
        End Try

    End Sub

    Private Sub Build_Notes_tab(ByRef searchCriteria As viewSelectionCriteriaClass, ByRef out_htmlString As String)

        Dim htmlOut As New StringBuilder

        Dim sHtmlNotesList As String = ""
        Dim sHtmlSummaryList As String = ""

        Dim notes_functions As New notes_view_functions

        Dim bAdminFlag As Boolean = HttpContext.Current.Session.Item("localPreferences").UserAdminFlag
        Dim bHasStandardCloudNotes As Boolean = HttpContext.Current.Session.Item("localPreferences").HasCloudNotes
        Dim bHasServerNotes As Boolean = HttpContext.Current.Session.Item("localPreferences").HasServerNotes

        Dim sNotesReportFileName As String = ""
        Dim sNotesReportString As String = ""
        Dim sReportTitle As String = ""

        Dim subscriptionInfo As String = Session.Item("localUser").crmSubSubID.ToString + "_" + Session.Item("localUser").crmUserLogin.ToString.Trim + "_" + Session.Item("localUser").crmSubSeqNo.ToString + "_"

        Dim reportDisplayFolder As String = HttpContext.Current.Application.Item("crmClientSiteData").ClientFullHostName + HttpContext.Current.Session.Item("MarketSummaryFolderVirtualPath")
        Dim temp_count As Integer = 0

        Try

            notes_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            notes_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            notes_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            notes_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            notes_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

            htmlOut.Append("<table id=""notesViewOuterTable"" width=""100%"" height=""70%"" cellpadding=""4"" cellspacing=""0"" class=""module"">")
            htmlOut.Append("<tr><td align=""left"" valign=""top"">")

            If searchCriteria.ViewCriteriaIsReport Then

                If bHasServerNotes Then 'If they're plus + notes users. 
                    sReportTitle = subscriptionInfo + "notesReport_cloudPlus"
                    sReportFrom = "cloudPlus"
                ElseIf bHasStandardCloudNotes Then 'if they're standard cloud users     
                    sReportTitle = subscriptionInfo + "notesReport_standardCloud"
                    sReportFrom = "standardCloud"
                End If

                sNotesReportFileName = commonEvo.GenerateFileName(sReportTitle, ".xls", False)

                notes_functions.display_notes_view_listTable(bHasMaster, bAdminFlag, searchCriteria, sNotesReportString)

                If notes_functions.write_notesReport_string_to_file(sNotesReportString, sNotesReportFileName) Then
                    sReportOutputFilename = reportDisplayFolder + "/" + sNotesReportFileName.Trim
                Else
                    HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in sending string to file"
                End If

                searchCriteria.ViewCriteriaIsReport = False ' set report flag to "false" so "listing shows"

                notes_functions.display_notes_view_listTable(bHasMaster, bAdminFlag, searchCriteria, sHtmlNotesList, Nothing, temp_count)
                htmlOut.Append(sHtmlNotesList)

                searchCriteria.ViewCriteriaIsReport = True

            Else

                notes_functions.display_notes_view_listTable(bHasMaster, bAdminFlag, searchCriteria, sHtmlNotesList, Nothing, temp_count)
                htmlOut.Append(sHtmlNotesList)

            End If


            If bIsReport Then
                Call commonLogFunctions.Log_User_Event_Data("UserStatistics", "Exported Notes to Excel: " & temp_count, Nothing, 28, 0, 0, 0, 0, 0, 0)
            End If

            'If bAdminFlag Then

            '  htmlOut.Append("</td></tr><tr><td align=""left"" valign=""top"" width=""100%"" height=""30%"">")

            '  notes_functions.display_notes_view_summaryTable(searchCriteria, sHtmlSummaryList)
            '  htmlOut.Append(sHtmlSummaryList)

            'End If

            htmlOut.Append("</td></tr></table>") ' outer view table

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [Build_Notes_tab] : " + ex.Message
        End Try

        out_htmlString = htmlOut.ToString()
        htmlOut = Nothing
        notes_functions = Nothing

    End Sub

    Private Sub Build_OpCosts_tab(ByRef searchCriteria As viewSelectionCriteriaClass)

        Dim htmlModelOpCosts As String = ""
        Dim htmlOut As New StringBuilder

        Try

            ' htmlOut.Append("<div style='height:240px; width:650px; overflow: auto;'>")
            htmlOut.Append("<div class=""valueSpec aircraftListing Simplistic aircraftSpec gray_background viewBoxMargin"">")
            If CRMViewActive Then
                htmlOut.Append(JetnetSourceText)
            End If

            htmlOut.Append("<table id=""outerCoststab"" width=""100%"" cellpadding=""0"" cellspacing=""0"" class='formatTable blue datagrid'>")
            htmlOut.Append("<tr><td valign=""top"" align=""left""><div class=""Box"">")
            htmlOut.Append("<table id=""outerCostsTbl"" width=""100%"" cellpadding=""0"" cellspacing=""0"" border=""0""  class=""subHeaderBoldTable"">")
            htmlOut.Append("<tr>")

            searchCriteria.ViewCriteriaUseMetricValues = False
            HttpContext.Current.Session.Item("localPreferences").DefaultCurrency = 9 'us dollar
            HttpContext.Current.Session.Item("localPreferences").CurrencyExchangeRate = 0

            localDatalayer.views_display_operating_costs(searchCriteria, True, htmlModelOpCosts, SharedModelTable)
            htmlOut.Append(htmlModelOpCosts)

            localDatalayer.views_display_operating_costs(searchCriteria, False, htmlModelOpCosts, SharedModelTable)
            htmlOut.Append(htmlModelOpCosts)

            searchCriteria.ViewCriteriaUseMetricValues = True
            HttpContext.Current.Session.Item("localPreferences").DefaultCurrency = 14 'euro
            HttpContext.Current.Session.Item("localPreferences").CurrencyExchangeRate = 0

            localDatalayer.views_display_operating_costs(searchCriteria, True, htmlModelOpCosts, SharedModelTable)
            htmlOut.Append(htmlModelOpCosts)

            localDatalayer.views_display_operating_costs(searchCriteria, False, htmlModelOpCosts, SharedModelTable)
            htmlOut.Append(htmlModelOpCosts)

            htmlOut.Append("</tr></table></td></div></tr></table>")
            htmlOut.Append("</div>")

            view_operating_costs_label.Text = htmlOut.ToString()

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [Build_OpCosts_tab] : " + ex.Message
        End Try

        htmlOut = Nothing

    End Sub

    Private Sub Build_Operators_tab(ByRef searchCriteria As viewSelectionCriteriaClass, ByRef out_htmlString As String)

        Dim htmlOut As New StringBuilder

        Dim sHtmlOperatorCompanies As String = ""
        Dim sHtmlOperatorModelPic As String = ""
        Dim sHtmlOperatorModels As String = ""
        Dim sHtmlOperatorEngineHtml As String = ""
        Dim sHtmlOperatorAircraft As String = ""
        Dim sOperatorCertHtml As String = ""
        Dim sHtmlOperatorPieChart As String = ""

        Dim operator_functions As New operator_view_functions

        Try

            operator_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            operator_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            operator_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            operator_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            operator_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

            If (View_ID < 2) Or View_ID = 11 Then
                htmlOut.Append("<div style='height:370px; width:100%; overflow: auto;'>")
            End If

            If CRMViewActive Then
                htmlOut.Append(JetnetSourceText)
            End If

            htmlOut.Append("<table id='operatorsViewOuterTable' width=""100%"" cellpadding=""0"" cellspacing=""0"" class=""module""><tr><td align=""left"" valign=""top"">")
            htmlOut.Append("<table id='operatorsViewInnerTable' width=""100%"" cellpadding=""4"" cellspacing=""0""><tr><td align=""left"" valign=""top"" width=""50%"">")
            'htmlOut.Append(vbCrLf + "<script type='text/javascript' src='https://www.google.com/jsapi'></script>" + vbCrLf)

            If searchCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_BUSINESS Or searchCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_HELICOPTERS Then
                searchCriteria.ViewCriteriaEngineName = ""
            End If

            If searchCriteria.ViewCriteriaEngineName.ToLower.Contains("all") Then

                htmlOut.Append("<table width='100%' cellspacing='0' cellpadding='0'>")

                operator_functions.views_display_operator_companies(searchCriteria, sHtmlOperatorCompanies)
                htmlOut.Append("<tr><td align='left' valign='top'>" + sHtmlOperatorCompanies + "</td></tr>")

                If searchCriteria.ViewCriteriaAmodID > -1 Then

                    If ((View_ID > 2) And Not View_ID = 11) Then
                        localDatalayer.views_display_model_pic(searchCriteria, sHtmlOperatorModelPic)
                        htmlOut.Append("<tr><td align='center' valign='middle'>" + sHtmlOperatorModelPic + "</td></tr>")
                    End If

                End If

                htmlOut.Append("</table>")

                operator_functions.display_operator_engine_info(searchCriteria, sHtmlOperatorEngineHtml)
                htmlOut.Append("</td><td align='left' valign='top'>" + sHtmlOperatorEngineHtml + "</td></tr>")

            ElseIf Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaEngineName.Trim) Then

                htmlOut.Append("<table cellspacing='0' cellpadding='2' width='100%'>")

                operator_functions.views_display_operator_companies(searchCriteria, sHtmlOperatorCompanies)
                htmlOut.Append("<tr><td align='left' valign='top'>" + sHtmlOperatorCompanies + "</td></tr>")

                If searchCriteria.ViewCriteriaAmodID > -1 Then

                    If ((View_ID > 2) And Not View_ID = 11) Then
                        localDatalayer.views_display_model_pic(searchCriteria, sHtmlOperatorModelPic)
                        htmlOut.Append("<tr><td align='center' valign='middle'>" + sHtmlOperatorModelPic + "</td></tr>")
                    End If

                Else

                    operator_functions.views_display_operator_all_models(searchCriteria, sHtmlOperatorModels, "View")
                    htmlOut.Append("<tr><td align='left' valign='top'>" + sHtmlOperatorModels + "</td></tr>")

                End If

                htmlOut.Append("</table>")
                htmlOut.Append("</td><td align='left' valign='top'>")
                htmlOut.Append("<table width='100%' cellspacing='0' cellpadding='0'>")

                operator_functions.display_operator_engine_info(searchCriteria, sHtmlOperatorEngineHtml)
                htmlOut.Append("<tr><td align='left' valign='top'>" + sHtmlOperatorEngineHtml + "</td></tr>")

                operator_functions.views_display_operator_aircraft(searchCriteria, sHtmlOperatorAircraft)
                htmlOut.Append("<tr><td align='left' valign='top'><br />" + sHtmlOperatorAircraft + "</td></tr>")
                htmlOut.Append("</table>")

            Else

                If searchCriteria.ViewCriteriaProductType <> Constants.PRODUCT_CODE_COMMERCIAL Then

                    If searchCriteria.ViewCriteriaCompanyID > 0 Then

                        If searchCriteria.ViewCriteriaAmodID = -1 Then

                            htmlOut.Append("<table width='100%' cellspacing='0' cellpadding='0'>")

                            operator_functions.views_display_operator_companies(searchCriteria, sHtmlOperatorCompanies)
                            htmlOut.Append("<tr><td align='left' valign='top'>" + sHtmlOperatorCompanies + "</td></tr>")

                            operator_functions.display_operator_certification_images(searchCriteria, sOperatorCertHtml)
                            htmlOut.Append("<tr><td align=""left"" valign=""top"">" + sOperatorCertHtml + "</td></tr>")
                            ' htmlOut.Append("<tr><td align=""left"" valign=""middle""></td></tr>")


                            operator_functions.views_display_operator_all_models(searchCriteria, sHtmlOperatorModels, "View")
                            htmlOut.Append("<tr><td align='left' valign='top'>" + sHtmlOperatorModels + "</td></tr>")
                            htmlOut.Append("</table>")

                            operator_functions.views_display_operator_aircraft(searchCriteria, sHtmlOperatorAircraft)
                            htmlOut.Append("</td><td align='left' valign='top'>" + sHtmlOperatorAircraft + "</td></tr>")

                        Else

                            htmlOut.Append("<table width='100%' cellspacing='0' cellpadding='0'>")

                            operator_functions.views_display_operator_companies(searchCriteria, sHtmlOperatorCompanies)
                            htmlOut.Append("<tr><td align='left' valign='top'>" + sHtmlOperatorCompanies + "</td></tr>")

                            If ((View_ID > 2) And Not View_ID = 11) Then
                                localDatalayer.views_display_model_pic(searchCriteria, sHtmlOperatorModelPic)
                                htmlOut.Append("<tr><td align='center' valign='middle'>" + sHtmlOperatorModelPic + "</td></tr>")
                            End If

                            htmlOut.Append("</table>")

                            operator_functions.views_display_operator_aircraft(searchCriteria, sHtmlOperatorAircraft)
                            htmlOut.Append("</td><td align='left' valign='top'>" + sHtmlOperatorAircraft + "</td></tr>")

                        End If

                    Else

                        If searchCriteria.ViewCriteriaAmodID = -1 Then

                            htmlOut.Append("<table width='100%' cellspacing='0' cellpadding='0'>")

                            operator_functions.views_display_operator_companies(searchCriteria, sHtmlOperatorCompanies)
                            htmlOut.Append("<tr><td align='left' valign='top'>" + sHtmlOperatorCompanies + "</td></tr>")
                            htmlOut.Append("</table>")

                            operator_functions.views_display_operator_all_models(searchCriteria, sHtmlOperatorModels, "View")
                            htmlOut.Append("</td><td align='left' valign='top'>" + sHtmlOperatorModels + "</td></tr>")

                        Else

                            htmlOut.Append("<table width='100%' cellspacing='0' cellpadding='0'>")

                            operator_functions.views_display_operator_companies(searchCriteria, sHtmlOperatorCompanies)
                            htmlOut.Append("<tr><td align='left' valign='top'>" + sHtmlOperatorCompanies + "</td></tr>")

                            If ((View_ID > 2) And Not View_ID = 11) Then
                                localDatalayer.views_display_model_pic(searchCriteria, sHtmlOperatorModelPic)
                                htmlOut.Append("<tr><td align='center' valign='middle'>" + sHtmlOperatorModelPic + "</td></tr>")
                            End If

                            htmlOut.Append("</table>")
                            htmlOut.Append("</td><td align='left' valign='top'>")

                            htmlOut.Append("<table width='100%' cellspacing='0' cellpadding='0'>")
                            htmlOut.Append("<tr><td align='left' valign='top'>")
                            Dim charting_string As String = ""
                            Dim temp_string As String = ""
                            Dim postbackString As String = ScriptManager.GetCurrent(Page).AsyncPostBackSourceElementID

                            operator_functions.views_display_operator_piechart(searchCriteria, sHtmlOperatorPieChart, 1, Me.Page, IIf(postbackString = "ctl00$ContentPlaceHolder1$View_Master1$TabContainer1", Me.bottom_tab_update_panel, Nothing), charting_string)

                            DisplayFunctions.load_google_chart(operators_tab, "", temp_string, "", "22chart_div_survey_sell_all", 480, 230, "POINTS", 1, charting_string, Me.Page, Me.bottom_tab_update_panel, False, True, False, True, True, False, False, False, False, False, 0)

                            Call load_google_chart_all(operators_tab, charting_string)

                            htmlOut.Append(sHtmlOperatorPieChart)

                            htmlOut.Append("</td></tr>")

                            operator_functions.views_display_operator_aircraft(searchCriteria, sHtmlOperatorAircraft)
                            htmlOut.Append("<tr><td align='left' valign='top'><br />" + sHtmlOperatorAircraft + "</td></tr>")
                            htmlOut.Append("</table>")

                        End If

                    End If ' searchCriteria.ViewCriteriaCompanyID > 0

                ElseIf searchCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_COMMERCIAL Then

                    If searchCriteria.ViewCriteriaCompanyID > 0 Then

                        If searchCriteria.ViewCriteriaAmodID = -1 Then

                            htmlOut.Append("<table width='100%' cellspacing='0' cellpadding='0'>")

                            operator_functions.views_display_operator_companies(searchCriteria, sHtmlOperatorCompanies)
                            htmlOut.Append("<tr><td align='left' valign='top'>" + sHtmlOperatorCompanies + "</td></tr>")

                            operator_functions.views_display_operator_all_models(searchCriteria, sHtmlOperatorModels, "View")
                            htmlOut.Append("<tr><td align='left' valign='top'>" + sHtmlOperatorModels + "</td></tr>")
                            htmlOut.Append("</table>")
                            htmlOut.Append("</td><td align='left' valign='top'>")
                            htmlOut.Append("<table width='100%' cellspacing='0' cellpadding='0'>")

                            operator_functions.display_operator_engine_info(searchCriteria, sHtmlOperatorEngineHtml)
                            htmlOut.Append("<tr><td align='left' valign='top'>" + sHtmlOperatorEngineHtml + "</td></tr>")

                            operator_functions.views_display_operator_aircraft(searchCriteria, sHtmlOperatorAircraft)
                            htmlOut.Append("<tr><td align='left' valign='top'><br />" + sHtmlOperatorAircraft + "</td></tr>")
                            htmlOut.Append("</table>")

                        Else

                            htmlOut.Append("<table width='100%' cellspacing='0' cellpadding='0'>")

                            operator_functions.views_display_operator_companies(searchCriteria, sHtmlOperatorCompanies)
                            htmlOut.Append("<tr><td align='left' valign='top'>" + sHtmlOperatorCompanies + "</td></tr>")

                            If ((View_ID > 2) And Not View_ID = 11) Then
                                localDatalayer.views_display_model_pic(searchCriteria, sHtmlOperatorModelPic)
                                htmlOut.Append("<tr><td align='center' valign='middle'>" + sHtmlOperatorModelPic + "</td></tr>")
                            End If

                            htmlOut.Append("</table>")
                            htmlOut.Append("</td><td align='left' valign='top'>")
                            htmlOut.Append("<table width='100%' cellspacing='0' cellpadding='0'>")

                            operator_functions.display_operator_engine_info(searchCriteria, sHtmlOperatorEngineHtml)
                            htmlOut.Append("<tr><td align='left' valign='top'>" + sHtmlOperatorEngineHtml + "</td></tr>")

                            operator_functions.views_display_operator_aircraft(searchCriteria, sHtmlOperatorAircraft)
                            htmlOut.Append("<tr><td align='left' valign='top'><br />" + sHtmlOperatorAircraft + "</td></tr>")
                            htmlOut.Append("</table>")

                        End If

                    Else

                        If searchCriteria.ViewCriteriaAmodID = -1 Then

                            htmlOut.Append("<table width='100%' cellspacing='0' cellpadding='0'>")

                            operator_functions.views_display_operator_companies(searchCriteria, sHtmlOperatorCompanies)
                            htmlOut.Append("<tr><td align='left' valign='top'>" + sHtmlOperatorCompanies + "</td></tr>")
                            htmlOut.Append("</table>")

                            operator_functions.views_display_operator_all_models(searchCriteria, sHtmlOperatorModels, "View")
                            htmlOut.Append("</td><td align='left' valign='top'>" + sHtmlOperatorModels + "</td></tr>")

                        Else

                            htmlOut.Append("<table width='100%' cellspacing='0' cellpadding='0'>")

                            operator_functions.views_display_operator_companies(searchCriteria, sHtmlOperatorCompanies)
                            htmlOut.Append("<tr><td align='left' valign='top'>" + sHtmlOperatorCompanies + "</td></tr>")

                            If ((View_ID > 2) And Not View_ID = 11) Then
                                localDatalayer.views_display_model_pic(searchCriteria, sHtmlOperatorModelPic)
                                htmlOut.Append("<tr><td align='center' valign='middle'>" + sHtmlOperatorModelPic + "</td></tr>")
                            End If

                            htmlOut.Append("</table>")
                            htmlOut.Append("</td><td align='left' valign='top'>")
                            htmlOut.Append("<table width='100%' cellspacing='0' cellpadding='0'>")

                            operator_functions.display_operator_engine_info(searchCriteria, sHtmlOperatorEngineHtml)
                            htmlOut.Append("<tr><td align='left' valign='top'>" + sHtmlOperatorEngineHtml + "</td></tr>")

                            operator_functions.views_display_operator_aircraft(searchCriteria, sHtmlOperatorAircraft)
                            htmlOut.Append("<tr><td align='left' valign='top'><br />" + sHtmlOperatorAircraft + "</td></tr>")
                            htmlOut.Append("</table>")

                        End If

                    End If ' searchCriteria.ViewCriteriaCompanyID > 0

                End If

            End If   ' for engine data

            htmlOut.Append("</td></tr></table>") ' inner view table
            htmlOut.Append("</td></tr></table>") ' outter view table

            If (View_ID < 2) Or View_ID = 11 Then
                htmlOut.Append("</div>")
            End If



        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [Build_Operators_tab] : " + ex.Message
        End Try

        out_htmlString = htmlOut.ToString()
        htmlOut = Nothing

    End Sub

    Private Sub Build_Performance_tab(ByRef searchCriteria As viewSelectionCriteriaClass)

        Dim htmlModelPerformance As String = ""
        Dim htmlOut As New StringBuilder

        Try
            htmlOut.Append("<div class=""valueSpec aircraftListing Simplistic aircraftSpec gray_background viewBoxMargin"">")
            'htmlOut.Append("<div style='height:240px; width:650px; overflow: auto;'>")

            If CRMViewActive Then
                htmlOut.Append(JetnetSourceText)
            End If


            htmlOut.Append("<table id=""outerPerformanceTab"" width=""100%"" cellpadding=""0"" cellspacing=""0"" class='formatTable blue large datagrid'>")
            htmlOut.Append("<tr><td valign=""top"" align=""left""><div class=""Box"">")
            htmlOut.Append("<table id=""outerPerformanceTable"" width=""100%"" cellpadding=""0"" cellspacing=""0"" class=""subHeaderBoldTable""><tr>")

            searchCriteria.ViewCriteriaUseMetricValues = False
            localDatalayer.views_display_performance_specs(False, "HTML", True, False, searchCriteria, htmlModelPerformance, SharedModelTable)
            htmlOut.Append(htmlModelPerformance)
            htmlModelPerformance = ""
            searchCriteria.ViewCriteriaUseMetricValues = False
            localDatalayer.views_display_performance_specs(False, "HTML", False, False, searchCriteria, htmlModelPerformance, SharedModelTable)
            htmlOut.Append(htmlModelPerformance)

            searchCriteria.ViewCriteriaUseMetricValues = True
            localDatalayer.views_display_performance_specs(False, "HTML", False, False, searchCriteria, htmlModelPerformance, SharedModelTable)
            htmlOut.Append(htmlModelPerformance)

            htmlOut.Append("</tr></table></div>")
            htmlOut.Append("</td></tr></table>")
            'htmlOut.Append("</div>")
            htmlOut.Append("</div>")
            view_performance_label.Text = htmlOut.ToString()

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [Build_Performance_tab] : " + ex.Message
        End Try

        htmlOut = Nothing

    End Sub

    Private Sub Build_Range_tab(ByRef searchCriteria As viewSelectionCriteriaClass)

        Try


            'will need to add range of each model to value amod_id|{range}
            If String.IsNullOrEmpty(first_model.SelectedValue) Then
                fillRangeDropDowns(first_model, nMaxWidth, "", False)
            Else
                Dim selectedmodelid As String() = first_model.SelectedValue.Split("|")
                fillRangeDropDowns(first_model, nMaxWidth, selectedmodelid(0).ToString, False)
            End If

            If String.IsNullOrEmpty(second_model.SelectedValue) Then
                fillRangeDropDowns(second_model, nMaxWidth, "", False)
            Else
                Dim selectedmodelid As String() = second_model.SelectedValue.Split("|")
                fillRangeDropDowns(second_model, nMaxWidth, selectedmodelid(0).ToString, False)
            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [Build_Range_tab] : " + ex.Message
        End Try

    End Sub

    Private Sub Build_Model_Resources_Tab(ByVal amod_id As Integer)
        Dim ResourcesDataT As New DataTable
        Dim aclsData_Temp As New clsData_Manager_SQL
        Dim css_string As String = ""
        Try


            aclsData_Temp.JETNET_DB = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            aclsData_Temp.client_DB = Application.Item("crmClientDatabase") 'HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim

            ResourcesDataT = aclsData_Temp.HelpData("ML", "", 0, False, amod_id)

            If Not IsNothing(ResourcesDataT) Then
                If ResourcesDataT.Rows.Count > 0 Then

                    Me.model_reports_tab.HeaderText = "Resources"
                    Me.model_reports_tab.Visible = True
                    Me.crm_view_view_all.Visible = False
                    Me.view_reports_label.Text = ""
                    Me.view_reports_label.Text += "<table width='100%' cellpadding='0' cellspacing='0'>"


                    For Each r As DataRow In ResourcesDataT.Rows


                        Me.view_reports_label.Text += "<tr valign='top'><td align='left' valign='top' " & IIf(css_string <> "", "class='" & css_string & "'", "") & "><span class='help_indent'><span class='help_subtitle'>"

                        If Not IsDBNull(r.Item("evonot_doc_link")) Then

                            If Not String.IsNullOrEmpty(r.Item("evonot_doc_link").ToString.Trim) Then

                                Me.view_reports_label.Text += "<a href='"

                                If Not r.Item("evonot_doc_link").ToString.ToLower.Contains("http") And r.Item("evonot_doc_link").ToString.ToLower.Contains(".com") Then
                                    Me.view_reports_label.Text += "http://"
                                End If

                                Me.view_reports_label.Text += r.Item("evonot_doc_link").ToString.Trim
                                Me.view_reports_label.Text += "' target='_blank'>"

                            End If
                        End If

                        Me.view_reports_label.Text += r("evonot_title") & "</a></span>- " & Replace(Replace(r("evonot_announcement"), "<p>", ""), "</p>", "") & "</span>"
                        If Not IsDBNull(r("evonot_video")) Then
                            If Trim(r("evonot_video")) <> "" Then
                                Me.view_reports_label.Text += "</td></tr><tr><td valign='middle' " & IIf(css_string <> "", "class='" & css_string & "'", "") & "><a href='Help.aspx?id=" & r("evonot_id") & "'  class='video_reel_link' id='" & r("evonot_id") & "_text'>Click Here To View This Video</a>"
                            End If
                        End If
                        'help_label.Text += "<div id='" & r("evonot_id") & "' class='display_none'><p align='center'>" & r("evonot_video").ToString & "</p></div><div class='clear'>&nbsp;</div>"

                        Me.view_reports_label.Text += "</td></tr>"
                        If css_string = "" Then
                            css_string = "alt_row"
                        Else
                            css_string = ""
                        End If
                    Next
                    Me.view_reports_label.Text += "</table>"
                Else
                    Me.model_reports_tab.HeaderText = ""
                    Me.model_reports_tab.Visible = False
                    Me.crm_view_view_all.Visible = True
                End If
            End If
            ResourcesDataT = New DataTable

        Catch ex As Exception

        End Try

    End Sub

    Private Sub Build_Reports_tab()

        Dim tempStr As String = ""

        Try

            tempStr = "<div style='height:240px; width:650px; overflow: auto;'><p>"
            tempStr += "<table width='100%' cellpadding='0' cellspacing='0' class='module'><tr><td align='left' valign='top'>"
            tempStr += "<table width='100%' cellpadding='4' cellspacing='0'>"
            tempStr += "<tr class='aircraft_list'><td colspan='3'>WORD/PDF</td></tr>"
            tempStr += "<tr class='alt_row'><td>&nbsp;</td><td>CHARTER INTELLIGENCE</td><td><a href=''>Example</a></td></tr>"
            tempStr += "<tr bgcolor='white'><td>&nbsp;</td><td>LEASED AIRCRAFT</td><td><a href=''>Example</a></td></tr>"
            tempStr += "<tr class='alt_row'><td>&nbsp;</td><td>OPERATOR/AIRCRAFT SUMMARY</td><td><a href=''>Example</a></td></tr>"
            tempStr += "<tr bgcolor='white'><td>&nbsp;</td><td>MODEL MARKET SUMMARY VIEW</td><td><a href=''>Example</a></td></tr>"
            tempStr += "<tr class='alt_row'><td>&nbsp;</td><td>SALES PRICE INDEX (SPI)</td><td><a href=''>Example</a></td></tr>"
            tempStr += "<tr bgcolor='white'><td>&nbsp;</td><td>FINANCIAL/MARKET LIST</td><td><a href=''>Example</a></td></tr>"
            tempStr += "<tr class='aircraft_list'><td colspan='3'>EXCEL</td></tr>"
            tempStr += "<tr bgcolor='alt_row'><td>&nbsp;</td><td>MODEL MARKET LIST</td><td><a href=''>Example</a></td></tr>"
            tempStr += "</table>"
            tempStr += "</td></tr></table>"
            tempStr += "</p></div>" + vbCrLf

            view_reports_label.Text = tempStr

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [Build_Reports_tab] : " + ex.Message
        End Try

    End Sub

    Public Sub run_recent_sales()

        Dim chart_htmlString As String = ""
        Dim NOTE_ID As Long = 0
        Dim temp_table As New DataTable
        Dim column As New DataColumn 'Column to Add Source to jetnet data.
        Dim column2 As New DataColumn 'Column to Add id to jetnet data. To match client side datatable 
        Dim column3 As New DataColumn 'Column to add take price to jetnet data (null)
        Dim column4 As New DataColumn
        Dim column5 As New DataColumn
        Dim real_ac_id As Long = 0
        Dim make_name As String = ""
        Dim model_name As String = ""
        Dim temp_amod_id As Long = 0
        Dim rest_of_ac_string As String = ""

        Try
            column.DataType = System.Type.GetType("System.Double")
            column.DefaultValue = 0
            column.Unique = False
            column.ColumnName = "asking_price"
            temp_table.Columns.Add(column)

            column2.DataType = System.Type.GetType("System.Double")
            column2.DefaultValue = 0
            column2.Unique = False
            column2.ColumnName = "take_price"
            temp_table.Columns.Add(column2)

            column3.DataType = System.Type.GetType("System.Double")
            column3.DefaultValue = 0
            column3.AllowDBNull = True
            column3.Unique = False
            column3.ColumnName = "sold_price"
            temp_table.Columns.Add(column3)


            column4.DataType = System.Type.GetType("System.DateTime")
            column4.AllowDBNull = True
            column4.Unique = False
            column4.ColumnName = "date_of"
            temp_table.Columns.Add(column4)

            column5.DataType = System.Type.GetType("System.String")
            column5.AllowDBNull = True
            column5.Unique = False
            column5.ColumnName = "ac_details"
            temp_table.Columns.Add(column5)


            If Trim(Request("note_id")) <> "" Then
                NOTE_ID = Trim(Request("note_id"))
            Else
                If Trim(Request("noteID")) <> "" Then
                    NOTE_ID = Trim(Request("noteID"))
                Else
                    NOTE_ID = 0
                End If
            End If

            If NOTE_ID <> 0 Then

                HttpContext.Current.Session.Item("jetnetServerNotesDatabase") = Application.Item("crmClientDatabase")

                Session.Item("localSubscription").crmServerSideNotes_Flag = True

                localDatalayer.run_view_19_actions(NOTE_ID, real_ac_id, make_name, model_name, temp_amod_id, rest_of_ac_string, chart_htmlString, Session.Item("CLIENT_AC_ID"), Me.model_reports_tab.HeaderText, COMPLETED_OR_OPEN, localCriteria, make_model_name_label.Text, Me.breadcrumbs.Text, TabContainer1, Me.label_behind_pic.Text, Me.Page.Title, Me.LAST_SAVE_DATE, Session.Item("JETNET_AC_ID"), Me.edit_label_click.Text, Me.year_month_settings, Me.estimated_value, Me.years_of, Me.sales_within, Me.use_jetnet_data, Me.Page, Me.used_of_used, Me.year_of_current.Text, Me.aftt_of_current.Text, RunModelOnValueOnly)

                Me.view_reports_label.Text = "Displays a list of all aircraft sold in the last year for the model of aircraft being evaluated based on a combination of JETNET data and aircraft tailored by edits within my Marketplace Manager. The graph below shows my current aircraft value(s) with respect to the asking, take, and sold prices."
                Me.view_reports_label.Text &= "Graph Values are shown as <font color='blue' size='+1'>&#8226;</font> asking, <font color='red' size='+1'>&#8226;</font> take, and  <font color='green' size='+1'>&#8226;</font> sold/estimated value."

                If CRMViewActive Then
                    Build_Retail_sales_tab(localCriteria, Me.view_wanteds_label1, temp_table, Me.check_include_internals, Me.check_retail_sales, NOTE_ID)
                Else
                    Build_Retail_sales_tab(localCriteria, Me.view_documents_label1, temp_table, Me.check_include_internals, Me.check_retail_sales, NOTE_ID)
                End If

                Call Build_Analytics_Charts(localCriteria, chart_htmlString, NOTE_ID, "Recent Sales", temp_table, False, 0, 0, 0)
                Me.view_reports_label.Text &= chart_htmlString

                Call turn_on_off_tabs_compare_view(NOTE_ID)
            Else    ' is for model market view 
                Build_Retail_sales_tab(localCriteria, Me.view_documents_label1, temp_table, Me.check_include_internals, Me.check_retail_sales, NOTE_ID)
            End If
        Catch ex As Exception

        End Try
    End Sub

    Private Sub Build_Retail_sales_tab(ByRef searchCriteria As viewSelectionCriteriaClass,
                                      ByRef label_temp As Label, ByRef temp_table As DataTable,
                                      ByRef check_internal As CheckBox, ByRef check_retail As CheckBox,
                                      ByVal NOTE_ID As Long, Optional ByRef rep_id As Long = 0,
                                      Optional ByVal aclsData_Temp As clsData_Manager_SQL = Nothing,
                                      Optional ByVal activetab As Integer = 0, Optional ByRef PassBackTable As DataTable = Nothing)

        Dim internal As String = "N"
        Dim retail As String = "N"
        Dim label_to_export As String = ""
        Dim sRetailSales As String = ""
        Dim temp_timeframe_string As String = ""
        Dim jetnet_fields_from_custom As String = ""
        Dim client_fields_from_custom As String = ""
        Dim aTempTable As New DataTable
        Dim aTempTable2 As New DataTable
        Dim temp_string As String = ""
        Dim fields_string As String = ""
        Dim type_string As String = ""
        Dim spot1 As Integer = 0
        Dim order_by_string As String = ""
        Dim abrevs_count As Integer = 0
        Dim abrevs As String = ""
        Dim size_string As String = ""
        Dim sRetailSales_export As String = ""
        Dim sRetailSales_export_estimates As String = ""
        Dim label_to_export_estimates As String = ""
        Dim temp_label As String = ""
        Dim used_only_text As String = ""

        Dim helpURL As String = "help/helpexamples/454.pdf"
        Dim ActiveInternalCheckbox As New CheckBox
        Dim ActiveRetailCheckbox As New CheckBox
        Try

            If CRMViewActive Then
                helpURL = clsData_Manager_SQL.get_site_name & "/help/helpexamples/454.pdf"
            End If

            If searchCriteria.ViewID = 1 Then
                check_include_internals2.Visible = True
                check_retail_sales2.Visible = True
                ActiveRetailCheckbox = check_retail_sales2
                ActiveInternalCheckbox = check_include_internals2
                check_retail_sales2_label.Visible = True
                check_retail_sales2_label.Text = "<a href=""#"" class=""help_cursor"" title=""What are Retail Transactions? Click to Learn More"" onClick=""javascript:load('" & helpURL & "','','scrollbars=yes,menubar=no,height=900,width=1050,resizable=yes,toolbar=no,location=no,status=no');"">Retail Sales Only</a>"
            Else
                ActiveRetailCheckbox = check_retail_sales
                ActiveInternalCheckbox = check_include_internals

                check_include_internals.Visible = True
                check_retail_sales.Visible = True
                check_retail_sales_label.Visible = True
                check_retail_sales_label.Text = "<a href=""#"" class=""help_cursor"" title=""What are Retail Transactions? Click to Learn More"" onClick=""javascript:load('" & helpURL & "','','scrollbars=yes,menubar=no,height=900,width=1050,resizable=yes,toolbar=no,location=no,status=no');"">Retail Sales Only</a>"

            End If


            label_temp.Text = "<div class=""viewSearchClass""><div class=""searchCriteria slideoutToolTip""><p title='Information' class='blue'><span class='label'>"


            temp_timeframe_string = ""

            If Me.years_of.SelectedValue <> 0 Then
                temp_timeframe_string &= " that were manufactured within " & Me.years_of.SelectedValue.ToString & " Year(s) "
            End If

            If Me.sales_within.SelectedValue <> 0 Then
                If Me.years_of.SelectedValue <> 0 Then
                    temp_timeframe_string &= " and "
                End If
                temp_timeframe_string &= " whose AFTT were within " & Me.sales_within.SelectedValue.ToString & " Hour(s) "
            End If

            If Me.sales_within.SelectedValue <> 0 Or Me.years_of.SelectedValue <> 0 Then
                temp_timeframe_string &= " of my AC "
            End If


            If Trim(COMPLETED_OR_OPEN) <> "C" And Trim(Request("ViewID")) <> "19" Then
                temp_timeframe_string &= " that sold during the past " & searchCriteria.ViewCriteriaTimeSpan.ToString & " Months. To Change TimeFrame, Go to 'New Search' and edit 'Time Span for View'."
            ElseIf Trim(COMPLETED_OR_OPEN) <> "C" Then
                temp_timeframe_string &= " that sold during the past " & Me.year_month_settings.SelectedValue.ToString & " Months. To Change TimeFrame, Go to 'New Search' and edit 'Time Span for View'."
            Else
                temp_timeframe_string &= " that sold in the year prior to the analysis being closed."
            End If

            If Me.used_of_used.Checked = True Then
                used_only_text = " Used "
            Else
                used_only_text = " "
            End If

            If ActiveInternalCheckbox.Checked And ActiveRetailCheckbox.Checked Then
                internal = "Y"
                retail = "Y"

                label_temp.Text += "The information below contains all " & used_only_text & " Whole Retail Sales transactions, including internals, " & temp_timeframe_string
                temp_label &= "The information below contains all " & used_only_text & " Whole Retail Sales transactions, including internals, " & temp_timeframe_string
            ElseIf ActiveInternalCheckbox.Checked Then
                internal = "Y"
                label_temp.Text += "The information below contains all " & used_only_text & " Whole Sale transactions, including internals, " & temp_timeframe_string
                temp_label &= "The information below contains all " & used_only_text & " Whole Sale transactions, including internals, " & temp_timeframe_string
            ElseIf ActiveRetailCheckbox.Checked Then
                retail = "Y"
                label_temp.Text += "The information below contains all " & used_only_text & " Whole Retail Sales transactions " & temp_timeframe_string
                temp_label &= "The information below contains all " & used_only_text & " Whole Retail Sales transactions " & temp_timeframe_string
            Else
                label_temp.Text += "The information below contains all " & used_only_text & " Whole Sale transactions " & temp_timeframe_string
                temp_label &= "The information below contains all " & used_only_text & " Whole Sale transactions " & temp_timeframe_string
            End If

            If CRMViewActive Then
                If RunModelOnValueOnly = False Then
                    If View_ID = 19 Then
                        label_temp.Text += "<br /><br />Click on the green (+) and ($) icons to add and remove current market comparables from the current market value analysis."
                        label_temp.Text += "<br /><br />Click on the pencil icon to edit transactions."
                    End If
                End If
                If Not Page.ClientScript.IsClientScriptBlockRegistered("runTooltip") Then
                    If Page.IsPostBack Then
                        Dim strJs As String = "SetUpSlider();"
                        System.Web.UI.ScriptManager.RegisterClientScriptBlock(Me.bottom_tab_update_panel, Me.GetType, "runTooltip", strJs, True)
                    End If
                End If
            End If

            label_temp.Text += "<br /><br />Client/Edited records are displayed with pink/red background.</span></p></div></div><div>"

            '--------------------------------------- FOR THE VIEW --------------------------------
            label_to_export = "<table width=""100%"" cellpadding=""0"" cellspacing=""0"" class='module'><tr><td align=""left"" valign=""top"">"

            Me.view_operators_label.Text = ""
            Me.hidden_spi_graph_text.Text = ""
            Me.hidden_spi_graph_text2.Text = ""
            Me.hidden_spi_graph_text3.Text = ""
            Me.hidden_spi_graph_text4.Text = ""
            Me.hidden_spi_graph_text5.Text = ""
            Me.hidden_spi_graph_text6.Text = ""
            Me.hidden_spi_graph_text7.Text = ""

            If rep_id = 0 Or CDbl(rep_id) = -1 Or (rep_id > 0 And (Trim(activetab) <> "5" And Trim(activetab) <> "2")) Then

                If CRMViewActive And searchCriteria.ViewID = 1 Then
                    crmViewDataLayer.Combined_views_display_recent_retail_sales(searchCriteria, sRetailSales, localDatalayer,
                                                                                CRMViewActive, True, temp_table, internal, retail, False,
                                                                                NOTE_ID, Session.Item("CLIENT_AC_ID"), LAST_SAVE_DATE, TabContainer1.ActiveTabIndex, 0, "",
                                                                                True, "", "", "", "", "", "", "", "", Me.estimated_value_label2.Text, localCriteria.ViewCriteriaTimeSpan,
                                                                                sRetailSales_export, Me.years_of.SelectedValue, Me.sales_within.SelectedValue, Me.year_of_current.Text,
                                                                                Me.aftt_of_current.Text, sRetailSales_export_estimates, Me.view_operators_label.Text,
                                                                                Me.hidden_spi_graph_text.Text, Me.hidden_spi_graph_text2.Text, Me.hidden_spi_graph_text3.Text,
                                                                                Me.hidden_spi_graph_text4.Text, Me.hidden_spi_graph_text5.Text, Me.hidden_spi_graph_text6.Text,
                                                                                Me.hidden_spi_graph_text7.Text, Me.used_of_used.Checked, Me.use_jetnet_data.Checked, "", "", False, "",
                                                                                SoldSurveyCurrentID.Text, RunModelOnValueOnly, PassBackTable)
                ElseIf CRMViewActive Then
                    crmViewDataLayer.Combined_views_display_recent_retail_sales(searchCriteria, sRetailSales, localDatalayer,
                                                                                CRMViewActive, True, temp_table, internal, retail, False,
                                                                                NOTE_ID, Session.Item("CLIENT_AC_ID"), LAST_SAVE_DATE, TabContainer1.ActiveTabIndex, 0, "",
                                                                                True, "", "", "", "", "", "", "", "", Me.estimated_value_label2.Text, Me.year_month_settings.SelectedValue,
                                                                                sRetailSales_export, Me.years_of.SelectedValue, Me.sales_within.SelectedValue, Me.year_of_current.Text,
                                                                                Me.aftt_of_current.Text, sRetailSales_export_estimates, Me.view_operators_label.Text,
                                                                                Me.hidden_spi_graph_text.Text, Me.hidden_spi_graph_text2.Text, Me.hidden_spi_graph_text3.Text,
                                                                                Me.hidden_spi_graph_text4.Text, Me.hidden_spi_graph_text5.Text, Me.hidden_spi_graph_text6.Text,
                                                                                Me.hidden_spi_graph_text7.Text, Me.used_of_used.Checked, Me.use_jetnet_data.Checked, "", "", False, "",
                                                                                SoldSurveyCurrentID.Text, RunModelOnValueOnly)
                Else
                    localDatalayer.views_display_recent_retail_sales(searchCriteria, sRetailSales, internal, retail, preownedSales_Only.Checked)
                End If

                RetailSalesJSCheck()

            Else

                '-------------------------------------FOR A PROJECT--------------------------------- --------------------------------------
                ' run this to get the spots for the graph
                crmViewDataLayer.Combined_views_display_recent_retail_sales(searchCriteria, sRetailSales, localDatalayer, CRMViewActive, True, temp_table, internal, retail, False,
                                                                            NOTE_ID, Session.Item("CLIENT_AC_ID"), LAST_SAVE_DATE, TabContainer1.ActiveTabIndex, 0, "",
                                                                            True, "", "", "", "", "", "", "", "", Me.estimated_value_label2.Text, Me.year_month_settings.SelectedValue,
                                                                            sRetailSales_export, Me.years_of.SelectedValue, Me.sales_within.SelectedValue, Me.year_of_current.Text,
                                                                            Me.aftt_of_current.Text, sRetailSales_export_estimates, Me.view_operators_label.Text,
                                                                            Me.hidden_spi_graph_text.Text, Me.hidden_spi_graph_text2.Text, Me.hidden_spi_graph_text3.Text,
                                                                            Me.hidden_spi_graph_text4.Text, Me.hidden_spi_graph_text5.Text, Me.hidden_spi_graph_text6.Text,
                                                                            Me.hidden_spi_graph_text7.Text, Me.used_of_used.Checked, Me.use_jetnet_data.Checked)

                If Not IsNothing(aclsData_Temp) Then
                    jetnet_fields_from_custom = ""
                    client_fields_from_custom = ""


                    aTempTable = aclsData_Temp.Client_Project_Reference_Details_By_Project_ID(rep_id)
                    If Not IsNothing(aTempTable) Then
                        If aTempTable.Rows.Count > 0 Then
                            For Each q As DataRow In aTempTable.Rows
                                'Response.Write(q("clipref_exp_id") & "<br />")


                                If Trim(q("clipref_source")) = "JETNET" Then
                                    aTempTable2 = aclsData_Temp.Build_Export_byID(q("clipref_exp_id"))
                                Else
                                    aTempTable2 = aclsData_Temp.Build_Custom_Export_byID(q("clipref_exp_id"))
                                End If



                                If Not IsNothing(aTempTable2) Then
                                    If aTempTable2.Rows.Count > 0 Then
                                        For Each r As DataRow In aTempTable2.Rows


                                            If Not IsDBNull(r("cliexp_field_length")) Then
                                                temp_string = Trim(r("cliexp_field_length"))
                                            Else
                                                temp_string = " "
                                            End If

                                            If Trim(size_string) <> "" Then
                                                size_string = size_string & ", '" & temp_string & "' "
                                            Else
                                                size_string = size_string & "'" & temp_string & "' "
                                            End If


                                            If Not IsDBNull(r("cliexp_field_type")) Then
                                                temp_string = Trim(r("cliexp_field_type"))
                                            Else
                                                temp_string = " "
                                            End If

                                            If Trim(type_string) <> "" Then
                                                type_string = type_string & ", '" & Trim(temp_string) & "' "
                                            Else
                                                type_string = type_string & "'" & Trim(temp_string) & "' "
                                            End If




                                            temp_string = Trim(r("cliexp_client_db_name"))

                                            If InStr(Trim(temp_string), " as ") > 0 Then
                                                spot1 = InStr(Trim(temp_string), " as ")
                                                temp_string = Left(Trim(temp_string), spot1)
                                            End If

                                            If Trim(fields_string) <> "" Then
                                                fields_string = fields_string & ", '" & Trim(temp_string) & "' "
                                            Else
                                                fields_string = fields_string & "'" & Trim(temp_string) & "' "
                                            End If


                                            If Not IsDBNull(r("cliexp_header_field_name")) Then
                                                If Trim(client_fields_from_custom) <> "" Then
                                                    client_fields_from_custom = client_fields_from_custom & ", " & Trim(temp_string) & " as '" & Trim(r("cliexp_header_field_name")) & "' "
                                                Else
                                                    client_fields_from_custom = client_fields_from_custom & Trim(temp_string) & " as '" & Trim(r("cliexp_header_field_name")) & "' "
                                                End If
                                            Else
                                                If Trim(client_fields_from_custom) <> "" Then
                                                    client_fields_from_custom = client_fields_from_custom & ", " & Trim(temp_string) & " as '" & Trim(r("cliexp_display")) & "' "
                                                Else
                                                    client_fields_from_custom = client_fields_from_custom & Trim(temp_string) & " as '" & Trim(r("cliexp_display")) & "' "
                                                End If
                                            End If

                                            temp_string = Trim(r("cliexp_jetnet_db_name"))

                                            If InStr(Trim(temp_string), " as ") > 0 Then
                                                spot1 = InStr(Trim(temp_string), " as ")
                                                temp_string = Left(Trim(temp_string), spot1)
                                            End If


                                            If Not IsDBNull(r("cliexp_header_field_name")) Then
                                                If Trim(jetnet_fields_from_custom) <> "" Then
                                                    jetnet_fields_from_custom = jetnet_fields_from_custom & ", " & temp_string & " as '" & Trim(r("cliexp_header_field_name")) & "' "
                                                Else
                                                    jetnet_fields_from_custom = jetnet_fields_from_custom & temp_string & " as '" & Trim(r("cliexp_header_field_name")) & "' "
                                                End If


                                                If abrevs_count = 0 Then
                                                    abrevs &= ("<tr bgcolor='white'>")
                                                    abrevs_count = 1
                                                Else
                                                    abrevs &= ("<tr class='alt_row'>")
                                                    abrevs_count = 0
                                                End If

                                                abrevs &= ("<td align='left' valign='middle' class='seperator'>")
                                                abrevs &= (r("cliexp_header_field_name"))
                                                abrevs &= ("</td><td align='left' valign='middle' class='seperator'>")
                                                abrevs &= (r("cliexp_display"))
                                                abrevs &= ("</td></tr>")

                                            Else
                                                If Trim(jetnet_fields_from_custom) <> "" Then
                                                    jetnet_fields_from_custom = jetnet_fields_from_custom & ", " & Trim(temp_string) & " as '" & Trim(r("cliexp_display")) & "' "
                                                Else
                                                    jetnet_fields_from_custom = jetnet_fields_from_custom & Trim(temp_string) & " as '" & Trim(r("cliexp_display")) & "' "
                                                End If
                                            End If


                                            If Not IsDBNull(r("cliexp_header_field_name")) Then
                                                If Trim(order_by_string) <> "" Then
                                                    order_by_string = order_by_string & ", '" & Trim(r("cliexp_header_field_name")) & "' "
                                                Else
                                                    order_by_string = order_by_string & "'" & Trim(r("cliexp_header_field_name")) & "' "
                                                End If
                                            Else
                                                If Trim(order_by_string) <> "" Then
                                                    order_by_string = order_by_string & ", '" & Trim(r("cliexp_display")) & "' "
                                                Else
                                                    order_by_string = order_by_string & "'" & Trim(r("cliexp_display")) & "' "
                                                End If
                                            End If

                                        Next
                                    End If
                                End If
                            Next
                        End If
                    End If
                End If


                crmViewDataLayer.Combined_views_display_recent_retail_sales(searchCriteria, sRetailSales, localDatalayer, CRMViewActive, True, temp_table, internal, retail, False,
                                                                            NOTE_ID, Session.Item("CLIENT_AC_ID"), LAST_SAVE_DATE, TabContainer1.ActiveTabIndex, 0, "", True, "",
                                                                            jetnet_fields_from_custom, client_fields_from_custom, order_by_string, fields_string, type_string, size_string, "",
                                                                            Me.estimated_value_label2.Text, Me.year_month_settings.SelectedValue, sRetailSales_export)


                ' If CRMViewActive Then
                RetailSalesJSCheck()
                'End If

            End If




            label_to_export += sRetailSales
            label_to_export += "</td></tr></table>"


            label_temp.Text += label_to_export.ToString
            label_temp.Text += "</div>"
            '--------------------------------------- FOR THE VIEW --------------------------------




            ''--------------------------------------- FOR THE EXPORT -------------------------------- 
            label_to_export = "<table width=""100%"" cellpadding=""0"" cellspacing=""0"" class='module'><tr><td align=""left"" valign=""top"">"


            label_to_export += sRetailSales_export
            label_to_export += "</td></tr></table>"

            label_to_export_estimates = "<table width=""100%"" cellpadding=""0"" cellspacing=""0"" class='module'><tr><td align=""left"" valign=""top"">"
            label_to_export_estimates += sRetailSales_export_estimates
            label_to_export_estimates += "</td></tr></table>"


            If NOTE_ID > 0 Then
                CommonAircraftFunctions.Build_String_To_HTML(label_to_export, Session.Item("localUser").crmUserTemporaryFilePrefix & NOTE_ID.ToString & "_retail_sales.xls")
                CommonAircraftFunctions.Build_String_To_HTML(label_to_export_estimates, Session.Item("localUser").crmUserTemporaryFilePrefix & NOTE_ID.ToString & "_estimates.xls")
            Else
                CommonAircraftFunctions.Build_String_To_HTML(label_to_export, Session.Item("localUser").crmUserTemporaryFilePrefix & NOTE_ID.ToString & "_retail_sales.xls")
            End If


            ''--------------------------------------- FOR THE EXPORT --------------------------------



            ' commented out MSW - 12/18/18
            ' If Trim(Me.estimated_value_label2.Text) <> "" Then
            '    Me.estimated_value_label2.Text &= "<Table cellspacing='0' cellpadding='0' border='0' width='240'><tr><td><font size='-3'>For additional detail regarding estimates click&nbsp;<A href='http://www.jetnetcrm.com/support/PriceEstimates.pdf' target='_blank'>here</a>.</font></td></tr></table>"
            '  End If

            Me.view_operators_label.Text = temp_label


        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [Build_Retail_sales_tab] : " + ex.Message
        End Try

    End Sub

    Private Sub build_spi_tab(ByRef searchCriteria As viewSelectionCriteriaClass, ByRef out_htmlString As String, ByRef google_string As String, ByVal from_where As String, ByVal is_graph_only As Boolean)

        Dim htmlOut As New StringBuilder
        Dim temp_table As New DataTable
        Dim temp_string As String = ""
        Dim google_avg_asking As String = ""
        Dim google_avg_sold As String = ""
        Dim google_percent As String = ""
        Dim google_variance As String = ""
        Dim temp_graph As String = ""
        Dim charting_string As String = ""
        Dim column As New DataColumn 'Column to Add Source to jetnet data.
        Dim column2 As New DataColumn 'Column to Add id to jetnet data. To match client side datatable 
        Dim column3 As New DataColumn 'Column to add take price to jetnet data (null)
        Dim column4 As New DataColumn
        Dim column5 As New DataColumn
        Dim sHtmlSPIReport_bottom As String = ""
        Dim spi_month_title As String = ""
        Dim sales_string As String = ""
        Dim spi_avg_line_chart As String = ""
        Dim spi_sales_chart As String = ""
        Dim BeginningNameChart As String = "" ' This is blank for Evo, but starts with CRM for CRM. To call the correct graphs.
        Dim MiddleLabel As Label = spi_middle
        Dim sales_prices As String = ""
        Dim fleet_sales As String = ""

        Try

            spi_month_title = "LAST " & searchCriteria.ViewCriteriaTimeSpan.ToString & " MONTHS"

            If (View_ID < 2) Or View_ID = 11 Then
                htmlOut.Append("<div style='height:370px; width:100%; overflow: auto;'>")
            End If


            If CRMViewActive Then
                CRM_MODEL_MARKET_SPI_GRAPH_PANEL.Visible = True
                htmlOut.Append(JetnetSourceText)
                'If Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.EVO Then
                ' added MSW - 1/29/19 - if this is evo, we r showing the other items so we will not be needing to rename the div name with the pre-"CRM" naming that it does in crm
                'Else
                If View_ID = 12 Then
                Else

                    BeginningNameChart = "CRM"
                End If
                'End If


                MiddleLabel = CRM_spiMiddle
                searchCriteria.ViewCriteriaSPIYearSld1 = Year(DateAdd(DateInterval.Month, -searchCriteria.ViewCriteriaTimeSpan, Now()))
            End If

            ToggleOffForSPI.Visible = False
            htmlOut.Append("<table id='spiViewOuterTable' width=""100%"" cellpadding=""0"" cellspacing=""0""><tr><td align=""left"" valign=""top"">")
            htmlOut.Append("<table id='spiViewTopTable' width=""100%"" cellpadding=""4"" cellspacing=""0""><tr><td width=""100%"" valign=""top"">")


            sales_string = CreateSalesHistoryChartandTable(searchCriteria, spi_avg_line_chart, spi_sales_chart)
            fleet_sales = sales_string

            If Trim(from_where) = "COMPARE_VIEW" Then
                DisplayFunctions.load_google_chart(operators_tab, spi_avg_line_chart, "", "", "22chart_div_survey_ask_vs_sell_all", 480, 230, "POINTS", 6, charting_string, Me.Page, Me.bottom_tab_update_panel, False, True, True, True, False, False, False, True, False, False, 0)
                DisplayFunctions.load_google_chart(operators_tab, spi_sales_chart, "", "", "22chart_div_survey_sell_all", 480, 230, "POINTS", 7, charting_string, Me.Page, Me.bottom_tab_update_panel, False, True, False, True, True, False, False, False, False, False, 0)
                Me.google_sold_trends_graphs3.Visible = True
            Else
                DisplayFunctions.load_google_chart(spi_tab, spi_avg_line_chart, "", "", BeginningNameChart & "2chart_div_survey_ask_vs_sell_all", 490, 250, "POINTS", 6, charting_string, Me.Page, Me.bottom_tab_update_panel, False, True, True, True, False, False, False, True, False, False, 0)
                DisplayFunctions.load_google_chart(spi_tab, spi_sales_chart, "", "", BeginningNameChart & "2chart_div_survey_sell_all", 490, 250, "POINTS", 7, charting_string, Me.Page, Me.bottom_tab_update_panel, False, True, False, True, True, False, False, False, False, False, 0)
            End If



            Dim sHtmlSPIReport As String = ""


            If Trim(from_where) = "COMPARE_VIEW" Then
                localDatalayer.views_spi_display_report(searchCriteria, sHtmlSPIReport, Me.SPI_QUARTER, google_string, Trim(Request("spi_graph")), sHtmlSPIReport_bottom, sales_string, Me.spi_middle_label.Text, sales_prices)
            Else
                localDatalayer.views_spi_display_report(searchCriteria, sHtmlSPIReport, Me.SPI_QUARTER, google_string, Trim(Request("spi_graph")), sHtmlSPIReport_bottom, sales_string, MiddleLabel.Text, sales_prices)
            End If


            ' If Trim(Request("spi_graph")) = "Y" Then

            column.DataType = System.Type.GetType("System.Double")
            column.DefaultValue = 0
            column.Unique = False
            column.ColumnName = "asking_price"
            temp_table.Columns.Add(column)

            column2.DataType = System.Type.GetType("System.Double")
            column2.DefaultValue = 0
            column2.Unique = False
            column2.ColumnName = "take_price"
            temp_table.Columns.Add(column2)

            column3.DataType = System.Type.GetType("System.Double")
            column3.DefaultValue = 0
            column3.AllowDBNull = True
            column3.Unique = False
            column3.ColumnName = "sold_price"
            temp_table.Columns.Add(column3)


            column4.DataType = System.Type.GetType("System.DateTime")
            column4.AllowDBNull = True
            column4.Unique = False
            column4.ColumnName = "date_of"
            temp_table.Columns.Add(column4)

            column5.DataType = System.Type.GetType("System.String")
            column5.AllowDBNull = True
            column5.Unique = False
            column5.ColumnName = "ac_details"
            temp_table.Columns.Add(column5)


            'THIS MAKES SURE U NEED BOTH ASKING AND SELLING 
            Me.hidden_spi_graph_text8.Text = "Y"

            ' re-use the code from the sold trends tab on the crm $ view



            If Trim(from_where) = "COMPARE_VIEW" Then
                crmViewDataLayer.Combined_views_display_recent_retail_sales(searchCriteria, temp_string, localDatalayer, CRMViewActive, True, temp_table, "N", "N", False, 0, Session.Item("CLIENT_AC_ID"), LAST_SAVE_DATE, TabContainer1.ActiveTabIndex, 0, "", True, "", "", "", "", "", "", "", "", Me.estimated_value_label2.Text, searchCriteria.ViewCriteriaTimeSpan, "", Me.years_of.SelectedValue, Me.sales_within.SelectedValue, Me.year_of_current.Text, Me.aftt_of_current.Text, "", Me.view_operators_label.Text, Me.hidden_spi_graph_text.Text, Me.hidden_spi_graph_text2.Text, Me.hidden_spi_graph_text3.Text, Me.hidden_spi_graph_text4.Text, Me.hidden_spi_graph_text5.Text, Me.hidden_spi_graph_text6.Text, Me.hidden_spi_graph_text7.Text, Me.used_of_used.Checked, True, "", "", False, Me.hidden_spi_graph_text8.Text)

                ' THIS GRAPH WILL GET THE LEFT GRAPH, WHERE IS ONLY BOTH ASKING AND SOLD
                'Avg Asking vs Selling Price ($k)
                temp_graph = Me.hidden_spi_graph_text8.Text ' make sure it doesnt double-do the item

                If Trim(temp_graph) = "" Then
                    Me.ask_v_selling_label2.Text = "<b>Avg Asking vs Selling Price ($k) - (For Asking with Sold)</b><br><table height='240' width='450'><Tr valign='center'><Td align='center'>No Records Found</td></tr></table>"
                Else
                    DisplayFunctions.load_google_chart(operators_tab, temp_graph, "", "", "orig_chart_div_survey_all", 490, 250, "POINTS", 1, charting_string, Me.Page, Me.bottom_tab_update_panel, False, True, True, True, False, False, False, False, False, False, 0)
                End If
            Else
                crmViewDataLayer.Combined_views_display_recent_retail_sales(searchCriteria, temp_string, localDatalayer, CRMViewActive, True, temp_table, "N", "N", False, 0, Session.Item("CLIENT_AC_ID"), LAST_SAVE_DATE, TabContainer1.ActiveTabIndex, 0, "", True, "", "", "", "", "", "", "", "", Me.estimated_value_label2.Text, searchCriteria.ViewCriteriaTimeSpan, "", Me.years_of.SelectedValue, Me.sales_within.SelectedValue, Me.year_of_current.Text, Me.aftt_of_current.Text, "", Me.view_operators_label.Text, Me.hidden_spi_graph_text.Text, Me.hidden_spi_graph_text2.Text, Me.hidden_spi_graph_text3.Text, Me.hidden_spi_graph_text4.Text, Me.hidden_spi_graph_text5.Text, Me.hidden_spi_graph_text6.Text, Me.hidden_spi_graph_text7.Text, Me.used_of_used.Checked, True, "", "", True, Me.hidden_spi_graph_text8.Text)

                ' THIS GRAPH WILL GET THE LEFT GRAPH, WHERE IS ONLY BOTH ASKING AND SOLD
                'Avg Asking vs Selling Price ($k)
                temp_graph = Me.hidden_spi_graph_text8.Text ' make sure it doesnt double-do the item

                If Trim(temp_graph) = "" Then
                    Me.ask_v_selling_label.Text = "<b>Avg Asking vs Selling Price ($k) - (For Asking with Sold)</b><br><table height='240' width='450'><Tr valign='center'><Td align='center'>No Records Found</td></tr></table>"
                Else
                    DisplayFunctions.load_google_chart(spi_tab, temp_graph, "", "", BeginningNameChart & "2chart_div_survey", 490, 250, "POINTS", 1, "", Me.Page, Me.bottom_tab_update_panel, False, True, True, True, False, False, False, False, False, False, 0)
                End If
            End If



            Me.hidden_spi_graph_text.Text = ""
            Me.hidden_spi_graph_text2.Text = ""
            Me.hidden_spi_graph_text3.Text = ""
            Me.hidden_spi_graph_text4.Text = ""
            Me.hidden_spi_graph_text5.Text = ""
            Me.hidden_spi_graph_text6.Text = ""
            Me.hidden_spi_graph_text7.Text = ""

            If Trim(from_where) = "COMPARE_VIEW" Then
                crmViewDataLayer.Combined_views_display_recent_retail_sales(searchCriteria, temp_string, localDatalayer, CRMViewActive, True, temp_table, "N", "N", False, 0, Session.Item("CLIENT_AC_ID"), LAST_SAVE_DATE, TabContainer1.ActiveTabIndex, 0, "", True, "", "", "", "", "", "", "", "", Me.estimated_value_label2.Text, searchCriteria.ViewCriteriaTimeSpan, "", Me.years_of.SelectedValue, Me.sales_within.SelectedValue, Me.year_of_current.Text, Me.aftt_of_current.Text, "", Me.view_operators_label.Text, Me.hidden_spi_graph_text.Text, Me.hidden_spi_graph_text2.Text, Me.hidden_spi_graph_text3.Text, Me.hidden_spi_graph_text4.Text, Me.hidden_spi_graph_text5.Text, Me.hidden_spi_graph_text6.Text, Me.hidden_spi_graph_text7.Text, Me.used_of_used.Checked, True, "", "", False, Me.hidden_spi_graph_text8.Text)
            Else
                ' THIS GRAPH WILL GET THE RIGHT GRAPH, WHERE IS HAS EITHER ASKING OR SOLD OR BOTH, and RE-USE THE DATA
                ' re-use the code from the sold trends tab on the crm $ view
                crmViewDataLayer.Combined_views_display_recent_retail_sales(searchCriteria, temp_string, localDatalayer, CRMViewActive, True, temp_table, "N", "N", False, 0, Session.Item("CLIENT_AC_ID"), LAST_SAVE_DATE, TabContainer1.ActiveTabIndex, 0, "", True, "", "", "", "", "", "", "", "", Me.estimated_value_label2.Text, searchCriteria.ViewCriteriaTimeSpan, "", Me.years_of.SelectedValue, Me.sales_within.SelectedValue, Me.year_of_current.Text, Me.aftt_of_current.Text, "", Me.view_operators_label.Text, Me.hidden_spi_graph_text.Text, Me.hidden_spi_graph_text2.Text, Me.hidden_spi_graph_text3.Text, Me.hidden_spi_graph_text4.Text, Me.hidden_spi_graph_text5.Text, Me.hidden_spi_graph_text6.Text, Me.hidden_spi_graph_text7.Text, Me.used_of_used.Checked, True, "", "", True, Me.hidden_spi_graph_text8.Text)
            End If


            'Avg Asking vs Selling Price ($k)"
            temp_graph = Me.hidden_spi_graph_text.Text ' make sure it doesnt double-do the item

            If Trim(from_where) = "COMPARE_VIEW" Then
                If is_graph_only = True Then
                    DisplayFunctions.load_google_chart(graph_panel, temp_graph, "Avg Asking vs Selling Price ($k)", "Avg Asking vs Selling Price ($k)", "large_graph_div", 950, 550, "POINTS", 1, "", Me.Page, Me.bottom_tab_update_panel, False, False, True, False, False, False, True)
                Else
                    DisplayFunctions.load_google_chart(model_reports_tab, temp_graph, "Avg Asking vs Selling Price ($k)", "Avg Asking vs Selling Price ($k)", "chart_div_survey", 500, 250, "POINTS", 1, "", Me.Page, Me.bottom_tab_update_panel, False, False, True, False, False, False, True)
                End If
            Else
                DisplayFunctions.load_google_chart(spi_tab, temp_graph, "", "", BeginningNameChart & "2chart_div_survey_2_all", 490, 250, "POINTS", 1, charting_string, Me.Page, Me.bottom_tab_update_panel, False, True, True, True, False, False, False, False, False, False, 0)
            End If





            google_avg_asking = Me.hidden_spi_graph_text2.Text ' make sure it doesnt double-do the item 
            google_percent = Me.hidden_spi_graph_text4.Text ' make sure it doesnt double-do the item
            google_avg_sold = Me.hidden_spi_graph_text3.Text ' make sure it doesnt double-do the item
            google_variance = Me.hidden_spi_graph_text5.Text ' make sure it doesnt double-do the item


            If Trim(from_where) = "COMPARE_VIEW" Then
                'Avg Asking Price ($k)
                DisplayFunctions.load_google_chart(operators_tab, google_avg_asking, "", "", "chart_div_sold_avg_asking_all", 480, 230, "POINTS", 2, charting_string, Me.Page, Me.bottom_tab_update_panel, False, True, False, False, True, True, False)

                'Avg. Sold Price % of Asking Price
                DisplayFunctions.load_google_chart(operators_tab, google_percent, "", "", "chart_div_percent_asking_all", 480, 230, "POINTS", 4, charting_string, Me.Page, Me.bottom_tab_update_panel, False, True, False, False, True, True, False)

                'Avg Sold Price ($k)
                DisplayFunctions.load_google_chart(operators_tab, google_avg_sold, "", "", "chart_div_sold_avg_sold_all", 480, 230, "POINTS", 3, charting_string, Me.Page, Me.bottom_tab_update_panel, False, True, False, False, True, True, False, False, False, False, 0)

                'Variance of Sold Price from Asking Price
                DisplayFunctions.load_google_chart(operators_tab, google_variance, "", "", "chart_div_variance_all", 480, 230, "POINTS", 5, charting_string, Me.Page, Me.bottom_tab_update_panel, False, True, False, False, True, True, False, False, False, False, 0)

            Else
                'Avg Asking Price ($k)
                DisplayFunctions.load_google_chart(spi_tab, google_avg_asking, "", "", BeginningNameChart & "2chart_div_sold_avg_asking_all", 480, 230, "POINTS", 2, charting_string, Me.Page, Me.bottom_tab_update_panel, False, True, False, False, True, True, False)

                'Avg. Sold Price % of Asking Price
                DisplayFunctions.load_google_chart(spi_tab, google_percent, "", "", BeginningNameChart & "2chart_div_percent_asking_all", 480, 230, "POINTS", 4, charting_string, Me.Page, Me.bottom_tab_update_panel, False, True, False, False, True, True, False)

                'Avg Sold Price ($k)
                DisplayFunctions.load_google_chart(spi_tab, google_avg_sold, "", "", BeginningNameChart & "2chart_div_sold_avg_sold_all", 480, 230, "POINTS", 3, charting_string, Me.Page, Me.bottom_tab_update_panel, False, True, False, False, True, True, False, False, False, False, 0)

                'Variance of Sold Price from Asking Price
                DisplayFunctions.load_google_chart(spi_tab, google_variance, "", "", BeginningNameChart & "2chart_div_variance_all", 480, 230, "POINTS", 5, charting_string, Me.Page, Me.bottom_tab_update_panel, False, True, False, False, True, True, False, False, False, False, 0)
            End If




            ' google_variance = Me.hidden_spi_graph_text6.Text ' make sure it doesnt double-do the item
            ' DisplayFunctions.load_google_chart(operators_tab, google_variance, "Average Days on Market", "Average Days on Market", "chart_div_dom_all", 480, 230, "POINTS", 5, charting_string, Me.Page, Me.bottom_tab_update_panel, False, True, False, False, True, True, False)

            ' google_variance = Me.hidden_spi_graph_text7.Text ' make sure it doesnt double-do the item
            ' DisplayFunctions.load_google_chart(operators_tab, google_variance, "Average Airframe Total Time", "Average Airframe Total Time", "chart_div_aftt_all", 480, 230, "POINTS", 5, charting_string, Me.Page, Me.bottom_tab_update_panel, False, True, False, False, True, True, False)

            If Trim(from_where) = "COMPARE_VIEW" Then
                Call load_google_chart_all(operators_tab, charting_string)
            Else
                Call load_google_chart_all(spi_tab, charting_string)
            End If






            google_sold_trends_graphs2.Visible = True

            'Me.new_row_spi.Visible = True
            ' Me.new_row_spi.Visible = True


            ToggleOffForSPI.Visible = False

            htmlOut.Append(sHtmlSPIReport)
            htmlOut.Append("</td></tr></table>")
            htmlOut.Append("</td></tr></table>")

            If (View_ID < 2) Or View_ID = 11 Then
                htmlOut.Append("</div>")
            End If

            Me.spi_bottom.Visible = True
            Me.spi_bottom.Text = "<br><table id='quarterlyModelDataTable' cellpadding='0' cellspacing='0' width='100%' class=""salesPriceTable"">"
            Me.spi_bottom.Text &= "<tr><td align='center' class='headerLine'>ADDITIONAL " & searchCriteria.ViewCriteriaAircraftMake.ToString & "&nbsp;/&nbsp;" & searchCriteria.ViewCriteriaAircraftModel.ToString & " SALE PRICE COMPARISONS (LAST " & searchCriteria.ViewCriteriaTimeSpan.ToString & " MONTHS)</td></tr>"
            Me.spi_bottom.Text &= "<tr><td>"
            Me.spi_bottom.Text &= sHtmlSPIReport_bottom & "</td></tr>"
            Me.spi_bottom.Text &= "</table>"

            Me.spi_middle.Visible = True
            Me.google_sold_trends_graphs1.Visible = True

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [Build_SPI_tab] : " + ex.Message
        End Try


        If Trim(sales_prices) <> "" Then
            Session("SPI_Sale_Prices") = sales_prices
        End If

        If Trim(fleet_sales) <> "" Then
            Session("SPI_Fleet_Sales") = fleet_sales
        End If

        out_htmlString = htmlOut.ToString()


        htmlOut = Nothing

    End Sub

    Public Function CreateSalesHistoryChartandTable(ByRef searchCriteria As viewSelectionCriteriaClass, ByRef sales_vs_ask_line_graph As String, ByRef sales_bar_chart As String) As String
        Dim temp_fleet_sum_table As New DataTable
        Dim strHTMLData1 As String = ""
        Dim cssClass As String = ""
        Dim low_asking As String = ""
        Dim high_asking As String = ""
        Dim low_sale As String = ""
        Dim high_sale As String = ""
        Dim avg_asking As String = ""
        Dim avg_sale As String = ""

        Try

            temp_fleet_sum_table = localDatalayer.Create_Run_Price_History_SPI(searchCriteria)

            strHTMLData1 = "<table width=""100%"" cellpadding=""3"" cellspacing=""0"" class=""salesPriceTable"" border=""1"">"
            strHTMLData1 = strHTMLData1 & "<tr><td align='center' colspan='9'  class=""headerLine"">" & searchCriteria.ViewCriteriaAircraftMake.ToString & "&nbsp;/&nbsp;" & searchCriteria.ViewCriteriaAircraftModel.ToString & " FLEET SALES SUMMARY (LAST " & searchCriteria.ViewCriteriaTimeSpan.ToString & " MONTHS)</td></tr>"

            strHTMLData1 = strHTMLData1 & "<tr class=""fieldHeader"">"
            strHTMLData1 = strHTMLData1 & "<td align='right'>&nbsp;<br/>YEAR</td>"
            strHTMLData1 = strHTMLData1 & "<td align='right'>IN OP<br/>FLEET</td>"
            strHTMLData1 = strHTMLData1 & "<td align='right'>TOTAL<br/>RETAIL SALES</td>"
            strHTMLData1 = strHTMLData1 & "<td align='right'>LOW<br/>ASKING ($k)</td>"
            strHTMLData1 = strHTMLData1 & "<td align='right'>AVG<br/>ASKING ($k)</td>"
            strHTMLData1 = strHTMLData1 & "<td align='right'>HIGH<br/>ASKING ($k)</td>"
            strHTMLData1 = strHTMLData1 & "<td align='right'>LOW<br/>SALE ($k)</td>"
            strHTMLData1 = strHTMLData1 & "<td align='right'>AVG<br/>SALE ($k)</td>"
            strHTMLData1 = strHTMLData1 & "<td align='right'>HIGH<br/>SALE ($k)</td>"
            strHTMLData1 = strHTMLData1 & "</tr>"

            If Not IsNothing(temp_fleet_sum_table) Then
                If temp_fleet_sum_table.Rows.Count > 0 Then


                    For Each r As DataRow In temp_fleet_sum_table.Rows

                        avg_asking = "null"
                        avg_sale = "null"

                        strHTMLData1 &= "<tr class=""" & cssClass & """>"


                        If cssClass = "" Then
                            cssClass = "alt_row"
                        Else
                            cssClass = ""
                        End If
                        strHTMLData1 &= "<td align='right'>"
                        strHTMLData1 &= r("ac_year")
                        strHTMLData1 &= "&nbsp;</td>"

                        strHTMLData1 &= "<td align='right'>"
                        strHTMLData1 &= r("INOP")
                        strHTMLData1 &= "&nbsp;</td>"


                        strHTMLData1 &= "<td align='right'>"
                        If Not IsDBNull(r("TOTALRETAILSALES")) Then
                            strHTMLData1 &= r("TOTALRETAILSALES")
                        Else
                            strHTMLData1 &= "0"
                        End If
                        strHTMLData1 &= "&nbsp;</td>"


                        strHTMLData1 &= "<td align='right'>"
                        If Not IsDBNull(r("LOWASKINGPRICE")) Then
                            low_asking = r("LOWASKINGPRICE")
                            low_asking = (low_asking / 1000)
                            strHTMLData1 &= "$" & FormatNumber(low_asking, 0) & ""
                        Else
                            strHTMLData1 &= ""
                            low_asking = "null"
                        End If
                        strHTMLData1 &= "&nbsp;</td>"

                        strHTMLData1 &= "<td align='right'>"
                        If Not IsDBNull(r("AVGASKINGPRICE")) Then
                            avg_asking = r("AVGASKINGPRICE")
                            avg_asking = (avg_asking / 1000)
                            strHTMLData1 &= "$" & FormatNumber(avg_asking, 0) & ""
                        Else
                            strHTMLData1 &= ""
                            avg_asking = "null"
                        End If
                        strHTMLData1 &= "&nbsp;</td>"


                        strHTMLData1 &= "<td align='right'>"
                        If Not IsDBNull(r("HIGHASKINGPRICE")) Then
                            high_asking = r("HIGHASKINGPRICE")
                            high_asking = (high_asking / 1000)
                            strHTMLData1 &= "$" & FormatNumber(high_asking, 0) & ""
                        Else
                            strHTMLData1 &= ""
                            high_asking = "null"
                        End If
                        strHTMLData1 &= "&nbsp;</td>"


                        strHTMLData1 &= "<td align='right'>"
                        If Not IsDBNull(r("LOWSALEPRICE")) Then
                            low_sale = r("LOWSALEPRICE")
                            low_sale = (low_sale / 1000)
                            strHTMLData1 &= "$" & FormatNumber(low_sale, 0) & ""
                        Else
                            strHTMLData1 &= ""
                        End If
                        strHTMLData1 &= "&nbsp;</td>"

                        strHTMLData1 &= "<td align='right'>"
                        If Not IsDBNull(r("AVGSALEPRICE")) Then
                            avg_sale = r("AVGSALEPRICE")
                            avg_sale = (avg_sale / 1000)
                            strHTMLData1 &= "$" & FormatNumber(avg_sale, 0) & ""
                        Else
                            strHTMLData1 &= ""
                        End If
                        strHTMLData1 &= "&nbsp;</td>"


                        strHTMLData1 &= "<td align='right'>"
                        If Not IsDBNull(r("HIGHSALEPRICE")) Then
                            high_sale = r("HIGHSALEPRICE")
                            high_sale = (high_sale / 1000)
                            strHTMLData1 &= "$" & FormatNumber(high_sale, 0) & ""
                        Else
                            strHTMLData1 &= ""
                        End If
                        strHTMLData1 &= "&nbsp;</td>"


                        strHTMLData1 &= "</tr>"




                        If Trim(sales_bar_chart) = "" Then
                            sales_vs_ask_line_graph &= "['" & r("ac_year") & "', " & avg_asking & ", " & avg_sale & "]"
                        Else
                            sales_vs_ask_line_graph &= ",['" & r("ac_year") & "', " & avg_asking & ", " & avg_sale & "]"
                        End If

                        If Trim(sales_bar_chart) = "" Then
                            sales_bar_chart &= "['" & r("ac_year") & "', " & avg_sale & "]"
                        Else
                            sales_bar_chart &= ",['" & r("ac_year") & "', " & avg_sale & "]"
                        End If

                    Next

                    strHTMLData1 &= "</table>"



                    sales_vs_ask_line_graph = " data6.addColumn('string', 'AC Year');  data6.addColumn('number', 'Avg Asking Price ($k)');   data6.addColumn('number', 'Avg Sale Price ($k)'); data6.addRows([" & sales_vs_ask_line_graph

                    sales_bar_chart = " data7.addColumn('string', 'AC Year');   data7.addColumn('number', 'Avg Sale Price ($k)');  data7.addRows([" & sales_bar_chart

                End If
            End If


        Catch ex As Exception

        End Try

        CreateSalesHistoryChartandTable = strHTMLData1

    End Function

    Public Sub Build_star_links(ByRef searchCriteria As viewSelectionCriteriaClass, ByRef out_htmlString As String)
        Dim htmlOut As New StringBuilder
        Dim bAerodexFlag As Boolean = False
        If Not IsNothing(HttpContext.Current.Session.Item("localPreferences").AerodexFlag) Then
            bAerodexFlag = HttpContext.Current.Session.Item("localPreferences").AerodexFlag.ToString.ToLower()
        End If

        Try

            If CRMViewActive Then
                htmlOut.Append(JetnetSourceText)
            End If

            htmlOut.Append("<table width=""100%"" cellpadding='2' cellspacing='0'>")
            htmlOut.Append("<tr><td valign='top' align='center' colspan='2' class='header'>STATISTICAL (STAR) REPORTS</td></tr>")

            If searchCriteria.ViewCriteriaAmodID > -1 Then
                htmlOut.Append("<tr class='alt_row'><td valign=""top"" align=""left"" width=""5%""><img src='images/ch_red.jpg' alt='tabStarReportID:0(ALL)' title='tabStarReportID:0(ALL)' /></td>")
                htmlOut.Append("<td valign='top' align='left'>")
                htmlOut.Append("<a href='view_template.aspx?ViewID=" + searchCriteria.ViewID.ToString + "&ViewName=" + searchCriteria.ViewName + "&tabStarReportID=0&amod_id=" + searchCriteria.ViewCriteriaAmodID.ToString + "' title='All Aircraft Reports'>All Aircraft Reports</a>")
                htmlOut.Append("</td></tr>")
            Else
                htmlOut.Append("<tr class='alt_row'><td valign=""top"" align=""left"" width=""5%""><img src='images/ch_red.jpg' alt='tabStarReportID:0(ALL)' title='tabStarReportID:0(ALL)' /></td>")
                htmlOut.Append("<td valign='top' align='left'>All Aircraft Reports</a></td></tr>")
            End If

            If searchCriteria.ViewCriteriaAmodID > -1 Then
                htmlOut.Append("<tr><td valign=""top"" align=""left"" width=""5%""><img src='images/ch_red.jpg' alt='tabStarReportID:1' title='tabStarReportID:1' /></td>")
                htmlOut.Append("<td valign='top' align='left'>")
                htmlOut.Append("<a href='view_template.aspx?ViewID=" + searchCriteria.ViewID.ToString + "&ViewName=" + searchCriteria.ViewName + "&tabStarReportID=1&amod_id=" + searchCriteria.ViewCriteriaAmodID.ToString + "' title='Aircraft Lifecycle'>Aircraft Lifecycle</a>")
                htmlOut.Append("</td></tr>")
            Else
                htmlOut.Append("<tr><td valign=""top"" align=""left"" width=""5%""><img src='images/ch_red.jpg' alt='tabStarReportID:1' title='tabStarReportID:1' /></td>")
                htmlOut.Append("<td valign='top' align='left'>Aircraft Lifecycle</a></td></tr>")
            End If

            If bAerodexFlag = False Then
                If searchCriteria.ViewCriteriaAmodID > -1 Then
                    htmlOut.Append("<tr class='alt_row'><td valign=""top"" align=""left"" width=""5%""><img src='images/ch_red.jpg' alt='tabStarReportID:2' title='tabStarReportID:2' /></td>")
                    htmlOut.Append("<td valign='top' align='left'>")
                    htmlOut.Append("<a href='view_template.aspx?ViewID=" + searchCriteria.ViewID.ToString + "&ViewName=" + searchCriteria.ViewName + "&tabStarReportID=2&amod_id=" + searchCriteria.ViewCriteriaAmodID.ToString + "' title='% of Fleet For Sale'>% of Fleet For Sale</a>")
                    htmlOut.Append("</td></tr>")
                Else
                    htmlOut.Append("<tr class='alt_row'><td valign=""top"" align=""left"" width=""5%""><img src='images/ch_red.jpg' alt='tabStarReportID:2' title='tabStarReportID:2' /></td>")
                    htmlOut.Append("<td valign='top' align='left'>% of Fleet For Sale</a></td></tr>")
                End If
            End If

            If bAerodexFlag = False Then
                If searchCriteria.ViewCriteriaAmodID > -1 Then
                    htmlOut.Append("<tr><td valign=""top"" align=""left"" width=""5%""><img src='images/ch_red.jpg' alt='tabStarReportID:3' title='tabStarReportID:3' /></td>")
                    htmlOut.Append("<td valign='top' align='left'>")
                    htmlOut.Append("<a href='view_template.aspx?ViewID=" + searchCriteria.ViewID.ToString + "&ViewName=" + searchCriteria.ViewName + "&tabStarReportID=3&amod_id=" + searchCriteria.ViewCriteriaAmodID.ToString + "' title='% of Fleet For Sale With Transactions'>% of Fleet For Sale With Transactions</a>")
                    htmlOut.Append("</td></tr>")
                Else
                    htmlOut.Append("<tr><td valign=""top"" align=""left"" width=""5%""><img src='images/ch_red.jpg' alt='tabStarReportID:3' title='tabStarReportID:3' /></td>")
                    htmlOut.Append("<td valign='top' align='left'>% of Fleet For Sale With Transactions</a></td></tr>")
                End If
            End If

            If searchCriteria.ViewCriteriaAmodID > -1 Then
                htmlOut.Append("<tr class='alt_row'><td valign=""top"" align=""left"" width=""5%""><img src='images/ch_red.jpg' alt='tabStarReportID:4' title='tabStarReportID:4' /></td>")
                htmlOut.Append("<td valign='top' align='left'>")
                htmlOut.Append("<a href='view_template.aspx?ViewID=" + searchCriteria.ViewID.ToString + "&ViewName=" + searchCriteria.ViewName + "&tabStarReportID=4&amod_id=" + searchCriteria.ViewCriteriaAmodID.ToString + "' title='Length of Ownership'>Length of Ownership</a>")
                htmlOut.Append("</td></tr>")
            Else
                htmlOut.Append("<tr class='alt_row'><td valign=""top"" align=""left"" width=""5%""><img src='images/ch_red.jpg' alt='tabStarReportID:4' title='tabStarReportID:4' /></td>")
                htmlOut.Append("<td valign='top' align='left'>Length of Ownership</a></td></tr>")
            End If

            If bAerodexFlag = False Then
                If searchCriteria.ViewCriteriaAmodID > -1 Then
                    htmlOut.Append("<tr><td valign=""top"" align=""left"" width=""5%""><img src='images/ch_red.jpg' alt='tabStarReportID:5' title='tabStarReportID:5' /></td>")
                    htmlOut.Append("<td valign='top' align='left'>")
                    htmlOut.Append("<a href='view_template.aspx?ViewID=" + searchCriteria.ViewID.ToString + "&ViewName=" + searchCriteria.ViewName + "&tabStarReportID=5&amod_id=" + searchCriteria.ViewCriteriaAmodID.ToString + "' title='Upgrade To Path'>Upgrade To Path</a>")
                    htmlOut.Append("</td></tr>")
                Else
                    htmlOut.Append("<tr><td valign=""top"" align=""left"" width=""5%""><img src='images/ch_red.jpg' alt='tabStarReportID:5' title='tabStarReportID:5' /></td>")
                    htmlOut.Append("<td valign='top' align='left'>Upgrade To Path</a></td></tr>")
                End If
            End If

            If bAerodexFlag = False Then
                If searchCriteria.ViewCriteriaAmodID > -1 Then
                    htmlOut.Append("<tr class='alt_row'><td valign=""top"" align=""left"" width=""5%""><img src='images/ch_red.jpg' alt='tabStarReportID:12' title='tabStarReportID:12' /></td>")
                    htmlOut.Append("<td valign='top' align='left'>")
                    htmlOut.Append("<a href='view_template.aspx?ViewID=" + searchCriteria.ViewID.ToString + "&ViewName=" + searchCriteria.ViewName + "&tabStarReportID=12&amod_id=" + searchCriteria.ViewCriteriaAmodID.ToString + "' title='Upgrade From Path'>Upgrade From Path</a>")
                    htmlOut.Append("</td></tr>")
                Else
                    htmlOut.Append("<tr class='alt_row'><td valign=""top"" align=""left"" width=""5%""><img src='images/ch_red.jpg' alt='tabStarReportID:12' title='tabStarReportID:12' /></td>")
                    htmlOut.Append("<td valign='top' align='left'>Upgrade From Path</a></td></tr>")
                End If
            End If


            If searchCriteria.ViewCriteriaAmodID > -1 Then
                htmlOut.Append("<tr><td valign=""top"" align=""left"" width=""5%""><img src='images/ch_red.jpg' alt='tabStarReportID:6' title='tabStarReportID:6' /></td>")
                htmlOut.Append("<td valign='top' align='left'>")
                htmlOut.Append("<a href='view_template.aspx?ViewID=" + searchCriteria.ViewID.ToString + "&ViewName=" + searchCriteria.ViewName + "&tabStarReportID=6&amod_id=" + searchCriteria.ViewCriteriaAmodID.ToString + "' title='Location by Continent'>Location by Continent</a>")
                htmlOut.Append("</td></tr>")
            Else
                htmlOut.Append("<tr><td valign=""top"" align=""left"" width=""5%""><img src='images/ch_red.jpg' alt='tabStarReportID:6' title='tabStarReportID:6' /></td>")
                htmlOut.Append("<td valign='top' align='left'>Location by Continent</a></td></tr>")
            End If

            If searchCriteria.ViewCriteriaAmodID > -1 Then
                htmlOut.Append("<tr class='alt_row'><td valign=""top"" align=""left"" width=""5%""><img src='images/ch_red.jpg' alt='tabStarReportID:8' title='tabStarReportID:8' /></td>")
                htmlOut.Append("<td valign='top' align='left'>")
                htmlOut.Append("<a href='view_template.aspx?ViewID=" + searchCriteria.ViewID.ToString + "&ViewName=" + searchCriteria.ViewName + "&tabStarReportID=8&amod_id=" + searchCriteria.ViewCriteriaAmodID.ToString + "' title='Average Age of New Fleet'>Average Age of New Fleet</a>")
                htmlOut.Append("</td></tr>")
            Else
                htmlOut.Append("<tr class='alt_row'><td valign=""top"" align=""left"" width=""5%""><img src='images/ch_red.jpg' alt='tabStarReportID:8' title='tabStarReportID:8' /></td>")
                htmlOut.Append("<td valign='top' align='left'>Average Age of New Fleet</a></td></tr>")
            End If

            If searchCriteria.ViewCriteriaAmodID > -1 Then
                htmlOut.Append("<tr><td valign=""top"" align=""left"" width=""5%""><img src='images/ch_red.jpg' alt='tabStarReportID:9' title='tabStarReportID:9' /></td>")
                htmlOut.Append("<td valign='top' align='left'>")
                htmlOut.Append("<a href='view_template.aspx?ViewID=" + searchCriteria.ViewID.ToString + "&ViewName=" + searchCriteria.ViewName + "&tabStarReportID=9&amod_id=" + searchCriteria.ViewCriteriaAmodID.ToString + "' title='Average Age of Used Fleet'>Average Age of Used Fleet</a>")
                htmlOut.Append("</td></tr>")
            Else
                htmlOut.Append("<tr><td valign=""top"" align=""left"" width=""5%""><img src='images/ch_red.jpg' alt='tabStarReportID:9' title='tabStarReportID:9' /></td>")
                htmlOut.Append("<td valign='top' align='left'>Average Age of Used Fleet</a></td></tr>")
            End If

            If searchCriteria.ViewCriteriaAmodID > -1 Then
                htmlOut.Append("<tr class='alt_row'><td valign=""top"" align=""left"" width=""5%""><img src='images/ch_red.jpg' alt='tabStarReportID:10' title='tabStarReportID:10' /></td>")
                htmlOut.Append("<td valign='top' align='left'>")
                htmlOut.Append("<a href='view_template.aspx?ViewID=" + searchCriteria.ViewID.ToString + "&ViewName=" + searchCriteria.ViewName + "&tabStarReportID=10&amod_id=" + searchCriteria.ViewCriteriaAmodID.ToString + "' title='Aircraft Owner Usage Report'>Aircraft Owner Usage Report</a>")
                htmlOut.Append("</td></tr>")
            Else
                htmlOut.Append("<tr class='alt_row'><td valign=""top"" align=""left"" width=""5%""><img src='images/ch_red.jpg' alt='tabStarReportID:10' title='tabStarReportID:10' /></td>")
                htmlOut.Append("<td valign='top' align='left'>Aircraft Owner Usage Report</a></td></tr>")
            End If

            If bAerodexFlag = False Then
                If searchCriteria.ViewCriteriaAmodID > -1 Then
                    htmlOut.Append("<tr><td valign=""top"" align=""left"" width=""5%""><img src='images/ch_red.jpg' alt='tabStarReportID:13' title='tabStarReportID:13' /></td>")
                    htmlOut.Append("<td valign='top' align='left'>")
                    htmlOut.Append("<a href='view_template.aspx?ViewID=" + searchCriteria.ViewID.ToString + "&ViewName=" + searchCriteria.ViewName + "&tabStarReportID=13&amod_id=" + searchCriteria.ViewCriteriaAmodID.ToString + "' title='Aircraft For Sale Statistics'>Aircraft For Sale Statistics</a>")
                    htmlOut.Append("</td></tr>")
                Else
                    htmlOut.Append("<tr><td valign=""top"" align=""left"" width=""5%""><img src='images/ch_red.jpg' alt='tabStarReportID:13' title='tabStarReportID:13' /></td>")
                    htmlOut.Append("<td valign='top' align='left'>Aircraft For Sale Statistics</a></td></tr>")
                End If
            End If

            htmlOut.Append("</table>")

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [Build_star_links] : " + ex.Message
        End Try

        out_htmlString = htmlOut.ToString
        htmlOut = Nothing

    End Sub



    Public Sub Build_star_report_Prospector(ByRef searchCriteria As viewSelectionCriteriaClass, ByRef out_htmlString As String)

        Dim htmlOut As New StringBuilder
        Dim starHtmlOut As String = ""
        Dim aMaxDate As String = ""
        Dim results_table As New DataTable

        Dim star_functions As New star_view_functions

        Try

            star_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            star_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            star_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            star_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            star_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

            results_table = star_functions.get_max_star_report_date(searchCriteria)

            If Not IsNothing(results_table) Then
                If results_table.Rows.Count > 0 Then
                    For Each r As DataRow In results_table.Rows

                        If Not IsDBNull(r.Item("ac1_start_date")) Then
                            If Not String.IsNullOrEmpty(r.Item("ac1_start_date").ToString.Trim) Then
                                aMaxDate = FormatDateTime(r.Item("ac1_start_date").ToString, vbShortDate)
                                searchCriteria.ViewCriteriaStarReportDate = CDate(r.Item("ac1_start_date").ToString)
                            Else
                                aMaxDate = "that timeframe"
                            End If
                        End If

                    Next
                Else
                    aMaxDate = "that timeframe"
                End If
            Else
                aMaxDate = "that timeframe"
            End If

            'htmlOut.Append("<table width=""100%"" border='0' cellpadding='0' cellspacing='0'><tr><td align='center' valign='top'>") 'start  outer model star table

            'htmlOut.Append("<table width=""100%"" cellpadding='2' cellspacing='0'>")
            'htmlOut.Append("<tr><td align='center' valign='middle'><img src='images/Star_Report_img.jpg' alt='starReportID:" + searchCriteria.ViewCriteriaStarReportID.ToString + "' border='1'/></td></tr>")
            'htmlOut.Append("<tr><td align='center' valign='middle'><i> Note that all <strong>STAR</strong> reports are compiled at the end of each month and therefore represent a snapshot of data</i></td></tr>")
            'htmlOut.Append("<tr><td align='center' valign='middle'><i> as of " + aMaxDate.Trim + " resulting in data that may not be a direct match to live data summaries.</i></td></tr>")
            'htmlOut.Append("<tr><td align='center' valign='middle'><br/><em>Click <strong><a href='view_template.aspx?ViewID=" + searchCriteria.ViewID.ToString + "&ViewName=" + searchCriteria.ViewName + "&onStarReportTab=true&tabStarReportID=0&amod_id=" + searchCriteria.ViewCriteriaAmodID.ToString + "'>HERE</a></strong> to clear CURRENT STAR Report and select another</em><br/></td></tr>")
            'htmlOut.Append("</table>")

            '   htmlOut.Append("<br />")

            Select Case searchCriteria.ViewCriteriaStarReportID

                Case 1
                    star_functions.views_display_star_aircraft_1(searchCriteria, starHtmlOut)
                    htmlOut.Append(starHtmlOut)

                Case 2
                    star_functions.views_display_star_aircraft_2(searchCriteria, starHtmlOut)
                    htmlOut.Append(starHtmlOut)

                Case 3
                    star_functions.views_display_star_aircraft_3(searchCriteria, starHtmlOut)
                    htmlOut.Append(starHtmlOut)

                Case 4
                    star_functions.views_display_star_aircraft_4(searchCriteria, starHtmlOut)
                    htmlOut.Append(starHtmlOut)

                Case 5
                    star_functions.views_display_star_aircraft_5(searchCriteria, starHtmlOut)
                    htmlOut.Append(starHtmlOut)

                Case 6

                    star_functions.views_display_star_aircraft_6a(searchCriteria, starHtmlOut)
                    htmlOut.Append(starHtmlOut + "<br />")

                    star_functions.views_display_star_aircraft_6(searchCriteria, starHtmlOut)
                    htmlOut.Append(starHtmlOut)

                Case 7
                    star_functions.views_display_star_aircraft_7(searchCriteria, starHtmlOut)
                    htmlOut.Append(starHtmlOut)

                Case 8
                    star_functions.views_display_star_aircraft_8(searchCriteria, starHtmlOut)
                    htmlOut.Append(starHtmlOut)

                Case 9
                    star_functions.views_display_star_aircraft_9(searchCriteria, starHtmlOut)
                    htmlOut.Append(starHtmlOut)

                Case 10
                    star_functions.views_display_star_aircraft_10(searchCriteria, starHtmlOut)
                    htmlOut.Append(starHtmlOut)

                Case 12
                    views_display_star_aircraft_12_modified(searchCriteria, starHtmlOut, False, star_functions)
                    htmlOut.Append(starHtmlOut)

                Case 13
                    star_functions.views_display_star_aircraft_13(searchCriteria, starHtmlOut)
                    htmlOut.Append(starHtmlOut)

                Case Else

                    If searchCriteria.ViewCriteriaStarReportID > -1 Then

                        star_functions.views_display_star_aircraft_1(searchCriteria, starHtmlOut)
                        htmlOut.Append(starHtmlOut + "<br />")

                        star_functions.views_display_star_aircraft_2(searchCriteria, starHtmlOut)
                        htmlOut.Append(starHtmlOut + "<br />")

                        star_functions.views_display_star_aircraft_3(searchCriteria, starHtmlOut)
                        htmlOut.Append(starHtmlOut + "<br />")

                        star_functions.views_display_star_aircraft_4(searchCriteria, starHtmlOut)
                        htmlOut.Append(starHtmlOut + "<br />")

                        star_functions.views_display_star_aircraft_6a(searchCriteria, starHtmlOut)
                        htmlOut.Append(starHtmlOut + "<br />")

                        star_functions.views_display_star_aircraft_7(searchCriteria, starHtmlOut)
                        htmlOut.Append(starHtmlOut + "<br />")

                        star_functions.views_display_star_aircraft_6(searchCriteria, starHtmlOut)
                        htmlOut.Append(starHtmlOut + "<br />")

                        star_functions.views_display_star_aircraft_8(searchCriteria, starHtmlOut)
                        htmlOut.Append(starHtmlOut + "<br />")

                        star_functions.views_display_star_aircraft_9(searchCriteria, starHtmlOut)
                        htmlOut.Append(starHtmlOut + "<br />")

                        star_functions.views_display_star_aircraft_10(searchCriteria, starHtmlOut)
                        htmlOut.Append(starHtmlOut + "<br />")

                        star_functions.views_display_star_aircraft_13(searchCriteria, starHtmlOut)
                        htmlOut.Append(starHtmlOut + "<br />")

                        star_functions.views_display_star_aircraft_5(searchCriteria, starHtmlOut)
                        htmlOut.Append(starHtmlOut + "<br />")

                        star_functions.views_display_star_aircraft_12(searchCriteria, starHtmlOut)
                        htmlOut.Append(starHtmlOut + "<br />")

                    End If

            End Select

            'htmlOut.Append("</td></tr></table>") 'end outer model star table

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [Build_star_report] : " + ex.Message
        End Try

        out_htmlString = Replace(htmlOut.ToString, "border=""1"" width=""800""", "class=""formatTable blue datagrid""")
        htmlOut = Nothing

    End Sub
    Public Sub views_display_star_aircraft_12_modified(ByRef searchCriteria As viewSelectionCriteriaClass, ByRef out_htmlString As String, Optional ByVal bFromMarketSummary As Boolean = False, Optional ByVal star_functions As star_view_functions = Nothing)

        Dim results_table As New DataTable
        Dim htmlOut As New StringBuilder

        Dim bFirstTime As Boolean = False

        Try

            results_table = star_functions.get_star_aircraft_12_info(searchCriteria, bFromMarketSummary)
            htmlOut.Append("<table cellpadding=""2"" cellspacing=""0"" border=""1"" width=""800"">") 'start inner model star table

            If Not IsNothing(results_table) Then

                Dim ac12_make As String = ""
                Dim ac12_model As String = ""

                If results_table.Rows.Count > 0 Then

                    For Each r As DataRow In results_table.Rows

                        If (Not ac12_make.Trim.ToLower.Contains(r.Item("ac12_upgrade_to_make").ToString.Trim.ToLower)) Or
               (Not ac12_model.Trim.ToLower.Contains(r.Item("ac12_upgrade_to_model").ToString.Trim.ToLower)) Then

                            ac12_make = r.Item("ac12_upgrade_to_make").ToString.Trim
                            ac12_model = r.Item("ac12_upgrade_to_model").ToString.Trim

                            htmlOut.Append("<tr>")
                            htmlOut.Append("<th nowrap='nowrap' align='left'>MAKE/MODEL</th>")
                            htmlOut.Append("<th class=""text_align_right"" nowrap='nowrap' align='right'>" & ac12_model & " PURCHASES</th>")
                            htmlOut.Append("<th class=""text_align_right"" nowrap='nowrap' align='right'>%</th>")
                            htmlOut.Append("</tr>")

                            '' table header
                            ''   htmlOut.Append("<tr><th class='th_title' align='center' colspan='10'>Upgrade From Path by Model")
                            ''   htmlOut.Append("<br />Based on End User Transactions")
                            ''  htmlOut.Append("<br />" + ac12_make + " " + ac12_model + "</th></tr>")
                            'htmlOut.Append("<tr><th class='beige' align='center' colspan='5'>OWNER(S) OF</th>")
                            ''  htmlOut.Append("<th class='beige' align='center' colspan='5'>WILL MOST LIKELY BUY</th></tr>")
                            ''   htmlOut.Append("<th class='th_title_details' nowrap='nowrap' align='center' colSpan='2'>STARTED WITH</th>")
                            ''  htmlOut.Append("<th class='th_title_details' nowrap='nowrap' align='center' rowSpan='2'>TOTAL<br />UPGRADES</th>")
                            ''  htmlOut.Append("<th class='th_title_details' nowrap='nowrap' align='center' rowSpan='2'>TOTAL<br />UPGRADES<br />TO MODEL</th>")

                            ''  htmlOut.Append("<th class='th_title_details' nowrap='nowrap' align='center' colSpan='2'>UPGRADED TO</th>")
                            ''  htmlOut.Append("<th class='th_title_details' nowrap='nowrap' align='center' rowSpan='2'>TOTAL<br />UPGRADES<br />TO</th>")
                            ''  htmlOut.Append("<th class='th_title_details' nowrap='nowrap' align='center' colSpan='2'>FOR SALE</th></tr>")

                            '' column headers

                            ''   htmlOut.Append("<th class='th_title_details' nowrap='nowrap' align='center'>MAKE</th>")
                            ''   htmlOut.Append("<th class='th_title_details' nowrap='nowrap' align='center'>MODEL</th>")
                            ''   htmlOut.Append("<th class='th_title_details' nowrap='nowrap' align='center'>TOTAL</th>")
                            ''  htmlOut.Append("<th class='th_title_details' nowrap='nowrap' align='center'>PERCENT</th>")
                            'htmlOut.Append("</tr>")

                            '' column data
                            htmlOut.Append("<tr>")

                            bFirstTime = False

                        End If

                        If CLng(r.Item("ac12_started_with_total_upgrades").ToString) = 0 Then

                            htmlOut.Append("<td title='" + ac12_make + " " + ac12_model + " No Aircraft Upgrades Found' align='center' colSpan='10'>No Aircraft Upgrades Found</td></tr>")

                            If Not bFromMarketSummary Then
                                Exit For
                            End If

                        Else

                            '  If Not bFirstTime Then
                            '    bFirstTime = True


                            htmlOut.Append("<td title='" + r.Item("ac12_started_with_make").ToString + " " + r.Item("ac12_started_with_model").ToString + " - Started With Make'>" + r.Item("ac12_started_with_make").ToString + " " + r.Item("ac12_started_with_model").ToString + "</td>")

                            htmlOut.Append("<td class=""text_align_right"" title='" + r.Item("ac12_started_with_make").ToString + " " + r.Item("ac12_started_with_model").ToString + " - Total Aircraft Upgrades Found'>")

                            htmlOut.Append(r.Item("ac12_started_with_total_upgrades_to_model").ToString)
                            htmlOut.Append(" of ")
                            htmlOut.Append(r.Item("ac12_started_with_total_upgrades").ToString)

                            htmlOut.Append("</td>")

                            '   htmlOut.Append("<td class='beige3' title='" + r.Item("ac12_started_with_make").ToString + " " + r.Item("ac12_started_with_model").ToString + " - Total Aircraft Upgrades To Model Found' align='right'>" + r.Item("ac12_started_with_total_upgrades_to_model").ToString + "</td>")
                            htmlOut.Append("<td class=""text_align_right"" title='" + r.Item("ac12_started_with_make").ToString + " " + r.Item("ac12_started_with_model").ToString + " - Percentange Of Upgrades To Model'>" + r.Item("ac12_started_with_percentage_with_upgrade").ToString + "%</td>")
                            '
                            ' htmlOut.ToString.Replace("XXX", r.Item("ac12_started_with_make").ToString + " " + r.Item("ac12_started_with_model").ToString)


                            '  htmlOut.Append("<th class='lightcyan' title='" + ac12_make + " " + ac12_model + " - Make Upgraded To' align='center'>" + ac12_make + "</th>")
                            '  htmlOut.Append("<th class='beige2' title='" + ac12_make + " " + ac12_model + " - Model Upgraded To' align='center'>" + ac12_model + "</th>")
                            '  htmlOut.Append("<td class='beige2' title='" + ac12_make + " " + ac12_model + " - Total Upgrades To Found' align='center'>" + r.Item("ac12_upgrade_to_total_upgrades").ToString + "</td>")
                            '  htmlOut.Append("<td class='beige2' title='" + ac12_make + " " + ac12_model + " - Total Active Fleet For Sale' align='center'>" + r.Item("ac12_upgrade_to_aircraft_for_sale").ToString + "</td>")
                            '  htmlOut.Append("<td class='beige2' title='" + ac12_make + " " + ac12_model + " - Percentange Of Active Fleet For Sale' align='center'>" + r.Item("ac12_upgrade_to_percentage_for_sale").ToString + "%</td>")

                            'Else


                            '    htmlOut.Append("<td class='lightcyan' title='" + r.Item("ac12_started_with_make").ToString + " " + r.Item("ac12_started_with_model").ToString + " - Started With Make' align='center'>" + r.Item("ac12_started_with_make").ToString + "</td>")
                            '    htmlOut.Append("<td class='beige2' title='" + r.Item("ac12_started_with_make").ToString + " " + r.Item("ac12_started_with_model").ToString + " - Started With Model' align='center'>" + r.Item("ac12_started_with_model").ToString + "</td>")
                            '    htmlOut.Append("<td class='beige3' title='" + r.Item("ac12_started_with_make").ToString + " " + r.Item("ac12_started_with_model").ToString + " - Total Aircraft Upgrades Found' align='right'>" + r.Item("ac12_started_with_total_upgrades").ToString + "</td>")
                            '    htmlOut.Append("<td class='beige3' title='" + r.Item("ac12_started_with_make").ToString + " " + r.Item("ac12_started_with_model").ToString + " - Total Aircraft Upgrades To Model Found' align='right'>" + r.Item("ac12_started_with_total_upgrades_to_model").ToString + "</td>")
                            '    htmlOut.Append("<td class='beige4' title='" + r.Item("ac12_started_with_make").ToString + " " + r.Item("ac12_started_with_model").ToString + " - Percentange Of Upgrades To Model' align='right'>" + r.Item("ac12_started_with_percentage_with_upgrade").ToString + "%</td>")
                            '    htmlOut.Append("<td class='beige4' colSpan='5'>&nbsp;</td>")

                            'End If

                            htmlOut.Append("</tr>")

                        End If

                    Next
                Else
                    htmlOut.Append("<tr><td align='center' valign='middle'><br />No data available for the model you have selected</td></tr>")
                End If
            Else
                htmlOut.Append("<tr><td align='center' valign='middle'><br />No data available for the model you have selected</td></tr>")
            End If

            htmlOut.Append("</table>") 'end inner model star table

        Catch ex As Exception

            '   aError = "Error in views_display_star_aircraft_12(ByRef searchCriteria As viewSelectionCriteriaClass, ByRef out_htmlString As String) " + ex.Message

        Finally

        End Try

        'return resulting html string
        out_htmlString = htmlOut.ToString
        htmlOut = Nothing
        results_table = Nothing

    End Sub

    Public Sub Build_star_report(ByRef searchCriteria As viewSelectionCriteriaClass, ByRef out_htmlString As String)

        Dim htmlOut As New StringBuilder
        Dim starHtmlOut As String = ""
        Dim aMaxDate As String = ""
        Dim results_table As New DataTable

        Dim star_functions As New star_view_functions

        Try

            star_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            star_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            star_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            star_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            star_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

            results_table = star_functions.get_max_star_report_date(searchCriteria)

            If Not IsNothing(results_table) Then
                If results_table.Rows.Count > 0 Then
                    For Each r As DataRow In results_table.Rows

                        If Not IsDBNull(r.Item("ac1_start_date")) Then
                            If Not String.IsNullOrEmpty(r.Item("ac1_start_date").ToString.Trim) Then
                                aMaxDate = FormatDateTime(r.Item("ac1_start_date").ToString, vbShortDate)
                                searchCriteria.ViewCriteriaStarReportDate = CDate(r.Item("ac1_start_date").ToString)
                            Else
                                aMaxDate = "that timeframe"
                            End If
                        End If

                    Next
                Else
                    aMaxDate = "that timeframe"
                End If
            Else
                aMaxDate = "that timeframe"
            End If

            htmlOut.Append("<table width=""100%"" border='0' cellpadding='0' cellspacing='0'><tr><td align='center' valign='top'>") 'start  outer model star table

            htmlOut.Append("<table width=""100%"" cellpadding='2' cellspacing='0'>")
            htmlOut.Append("<tr><td align='center' valign='middle'><img src='images/Star_Report_img.jpg' alt='starReportID:" + searchCriteria.ViewCriteriaStarReportID.ToString + "' border='1'/></td></tr>")
            htmlOut.Append("<tr><td align='center' valign='middle'><i> Note that all <strong>STAR</strong> reports are compiled at the end of each month and therefore represent a snapshot of data</i></td></tr>")
            htmlOut.Append("<tr><td align='center' valign='middle'><i> as of " + aMaxDate.Trim + " resulting in data that may not be a direct match to live data summaries.</i></td></tr>")
            htmlOut.Append("<tr><td align='center' valign='middle'><br/><em>Click <strong><a href='view_template.aspx?ViewID=" + searchCriteria.ViewID.ToString + "&ViewName=" + searchCriteria.ViewName + "&onStarReportTab=true&tabStarReportID=0&amod_id=" + searchCriteria.ViewCriteriaAmodID.ToString + "'>HERE</a></strong> to clear CURRENT STAR Report and select another</em><br/></td></tr>")
            htmlOut.Append("</table>")

            htmlOut.Append("<br />")

            Select Case searchCriteria.ViewCriteriaStarReportID

                Case 1
                    star_functions.views_display_star_aircraft_1(searchCriteria, starHtmlOut)
                    htmlOut.Append(starHtmlOut)

                Case 2
                    star_functions.views_display_star_aircraft_2(searchCriteria, starHtmlOut)
                    htmlOut.Append(starHtmlOut)

                Case 3
                    star_functions.views_display_star_aircraft_3(searchCriteria, starHtmlOut)
                    htmlOut.Append(starHtmlOut)

                Case 4
                    star_functions.views_display_star_aircraft_4(searchCriteria, starHtmlOut)
                    htmlOut.Append(starHtmlOut)

                Case 5
                    star_functions.views_display_star_aircraft_5(searchCriteria, starHtmlOut)
                    htmlOut.Append(starHtmlOut)

                Case 6

                    star_functions.views_display_star_aircraft_6a(searchCriteria, starHtmlOut)
                    htmlOut.Append(starHtmlOut + "<br />")

                    star_functions.views_display_star_aircraft_6(searchCriteria, starHtmlOut)
                    htmlOut.Append(starHtmlOut)

                Case 7
                    star_functions.views_display_star_aircraft_7(searchCriteria, starHtmlOut)
                    htmlOut.Append(starHtmlOut)

                Case 8
                    star_functions.views_display_star_aircraft_8(searchCriteria, starHtmlOut)
                    htmlOut.Append(starHtmlOut)

                Case 9
                    star_functions.views_display_star_aircraft_9(searchCriteria, starHtmlOut)
                    htmlOut.Append(starHtmlOut)

                Case 10
                    star_functions.views_display_star_aircraft_10(searchCriteria, starHtmlOut)
                    htmlOut.Append(starHtmlOut)

                Case 12
                    star_functions.views_display_star_aircraft_12(searchCriteria, starHtmlOut)
                    htmlOut.Append(starHtmlOut)

                Case 13
                    star_functions.views_display_star_aircraft_13(searchCriteria, starHtmlOut)
                    htmlOut.Append(starHtmlOut)

                Case Else

                    If searchCriteria.ViewCriteriaStarReportID > -1 Then

                        star_functions.views_display_star_aircraft_1(searchCriteria, starHtmlOut)
                        htmlOut.Append(starHtmlOut + "<br />")

                        star_functions.views_display_star_aircraft_2(searchCriteria, starHtmlOut)
                        htmlOut.Append(starHtmlOut + "<br />")

                        star_functions.views_display_star_aircraft_3(searchCriteria, starHtmlOut)
                        htmlOut.Append(starHtmlOut + "<br />")

                        star_functions.views_display_star_aircraft_4(searchCriteria, starHtmlOut)
                        htmlOut.Append(starHtmlOut + "<br />")

                        star_functions.views_display_star_aircraft_6a(searchCriteria, starHtmlOut)
                        htmlOut.Append(starHtmlOut + "<br />")

                        star_functions.views_display_star_aircraft_7(searchCriteria, starHtmlOut)
                        htmlOut.Append(starHtmlOut + "<br />")

                        star_functions.views_display_star_aircraft_6(searchCriteria, starHtmlOut)
                        htmlOut.Append(starHtmlOut + "<br />")

                        star_functions.views_display_star_aircraft_8(searchCriteria, starHtmlOut)
                        htmlOut.Append(starHtmlOut + "<br />")

                        star_functions.views_display_star_aircraft_9(searchCriteria, starHtmlOut)
                        htmlOut.Append(starHtmlOut + "<br />")

                        star_functions.views_display_star_aircraft_10(searchCriteria, starHtmlOut)
                        htmlOut.Append(starHtmlOut + "<br />")

                        star_functions.views_display_star_aircraft_13(searchCriteria, starHtmlOut)
                        htmlOut.Append(starHtmlOut + "<br />")

                        star_functions.views_display_star_aircraft_5(searchCriteria, starHtmlOut)
                        htmlOut.Append(starHtmlOut + "<br />")

                        star_functions.views_display_star_aircraft_12(searchCriteria, starHtmlOut)
                        htmlOut.Append(starHtmlOut + "<br />")

                    End If

            End Select

            htmlOut.Append("</td></tr></table>") 'end outer model star table

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [Build_star_report] : " + ex.Message
        End Try

        out_htmlString = htmlOut.ToString
        htmlOut = Nothing

    End Sub

    Private Sub Build_StarModel_tab(ByRef searchCriteria As viewSelectionCriteriaClass)

        Dim htmlOut As New StringBuilder
        Dim htmlStarReportLinks As String = ""
        Dim htmlStarReport As String = ""

        Try

            If searchCriteria.ViewCriteriaStarReportID > -1 Then
                htmlOut.Append("<div style='height:370px; width:970px; overflow: auto;'><p>")
            End If

            htmlOut.Append("<table width=""100%"" cellpadding=""0"" cellspacing=""0"" class='module'><tr><td align=""left"" valign=""top"">")
            htmlOut.Append("<table width=""100%"" cellpadding=""4"" cellspacing=""0""><tr><td align=""left"" valign=""top"">")

            If searchCriteria.ViewCriteriaStarReportID = 0 Then
                ' this is for clearing the selection
                Build_star_links(searchCriteria, htmlStarReportLinks)
                htmlOut.Append(htmlStarReportLinks)

            ElseIf searchCriteria.ViewCriteriaStarReportID > -1 Then
                If Session.Item("isMobile") Then
                    mobilePopLink.Visible = True
                    PopUpPanelJavascript()
                End If
                Build_star_report(searchCriteria, htmlStarReport)
                htmlOut.Append(htmlStarReport)

            Else

                Build_star_links(searchCriteria, htmlStarReportLinks)
                htmlOut.Append(htmlStarReportLinks)

            End If

            htmlOut.Append("</td></tr></table>") ' inner view table
            htmlOut.Append("</td></tr></table>") ' outter view table

            If searchCriteria.ViewCriteriaStarReportID > -1 Then
                htmlOut.Append("</p></div>")
            End If

            view_star_reports_label.Text = htmlOut.ToString()

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [Build_StarModel_tab] : " + ex.Message
        End Try

        htmlOut = Nothing

    End Sub

    Public Sub PopUpPanelJavascript()
        If Not Page.ClientScript.IsClientScriptBlockRegistered("popupLink") Then
            Dim popString As New StringBuilder

            popString.Append("function PopUpPanel() {")
            popString.Append("var panel = document.getElementById(""" & starReportPanel.ClientID & """);")
            popString.Append("var printWindow = window.open('', '', 'menubar=yes, resizable=yes, titlebar=yes, height=760,width=800');")
            popString.Append("printWindow.document.write('<html><head><title>StarReport</title>');")
            popString.Append("printWindow.document.write('<link rel=""stylesheet"" href=""/EvoStyles/stylesheets/additional_styles.css"" /><link rel=""stylesheet"" href=""/EvoStyles/stylesheets/additional_mobile_styles.css"" /><link rel=""stylesheet"" href=""/common/aircraft_model.css"" /><style>body div {height:auto !important;width:auto !important;}</style></head><body >');")
            popString.Append("printWindow.document.write(panel.innerHTML);")
            popString.Append("printWindow.document.write('</body></html>');")
            popString.Append("printWindow.document.close();")
            popString.Append("return false;")
            popString.Append("}")
            System.Web.UI.ScriptManager.RegisterClientScriptBlock(Me, Me.GetType(), "popupLink", popString.ToString, True)
        End If
    End Sub

    Private Sub Build_StarReports_tab(ByRef searchCriteria As viewSelectionCriteriaClass, ByRef out_htmlString As String)

        Dim htmlOut As New StringBuilder
        Dim results_table As New DataTable
        Dim results_table2 As New DataTable
        Dim toggleRowColor As Boolean = False

        Dim outString As String = ""
        Dim star_selected As String = ""
        Dim star_title As String = ""
        Dim star_cat As String = ""
        Dim star_desc As String = ""
        Dim star_typedtitle As String = ""
        Dim star_sample_url As String = ""
        Dim star_source_path As String = ""
        Dim star_temp_path As String = ""

        Dim htmlStarReportSampleLink As String = ""
        Dim htmlStarReportSelections As String = ""
        Dim htmlStarReportTypes As String = ""
        Dim htmlStarReportDates As String = ""

        Dim star_functions As New star_view_functions

        Try

            star_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            star_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            star_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            star_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            star_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

            htmlOut.Append("<table id='starReportViewOuterTable' width='100%' cellpadding='2' cellspacing='0' class='module'>")
            htmlOut.Append("<tr><td align='left' valign='bottom'>")

            htmlOut.Append("<table id='starReportViewInnerTable' width='100%' cellpadding='1' cellspacing='0' border='0'>")
            htmlOut.Append("<tr><td align='left' valign='top'>")

            htmlOut.Append("<table id='starReportHeaderTable' width='100%' cellpadding='1' cellspacing='0' class='module'>")
            htmlOut.Append("<tr><td colspan='2' align='left' valign='middle' class='header' style='padding-left:3px;'>STAR REPORTS</td></tr>")
            htmlOut.Append("<tr><td colspan='2' align='right' valign='middle' class=""starReportSelections"">")

            htmlOut.Append(vbCrLf + "<script type='text/javascript' language='JavaScript'>")
            htmlOut.Append(vbCrLf + "  function displayElements(url) {")
            htmlOut.Append(vbCrLf + "    window.location = url;")
            htmlOut.Append(vbCrLf + "  }")
            htmlOut.Append(vbCrLf + "</script>" + vbCrLf)

            star_functions.views_display_star_star_report_selections(searchCriteria, htmlStarReportSelections)
            htmlOut.Append(htmlStarReportSelections)

            htmlOut.Append("&nbsp;&nbsp;</td></tr>")

            '' Start table1 under Header -->	
            htmlOut.Append("<tr><td align='left' valign='top' width='70%'>")
            htmlOut.Append("<table width='100%' cellpadding='1' cellspacing='0' class='module'>")

            results_table = star_functions.get_star_reports_info(searchCriteria)

            If Not IsNothing(results_table) Then

                If results_table.Rows.Count > 0 Then

                    For Each r As DataRow In results_table.Rows

                        star_sample_url = ""

                        If Not toggleRowColor Then
                            htmlOut.Append("<tr class='alt_row'>")
                            toggleRowColor = True
                        Else
                            htmlOut.Append("<tr bgcolor='white'>")
                            toggleRowColor = False
                        End If

                        If Not IsDBNull(r.Item("starrep_category")) Then
                            If Not String.IsNullOrEmpty(r.Item("starrep_category").ToString.Trim) Then
                                star_cat = r.Item("starrep_category").ToString.Trim
                            End If
                        End If

                        If InStr(star_selected, star_cat) = 0 Then
                            star_selected += "<option value=""view_template.aspx?ViewID=" + searchCriteria.ViewID.ToString + "&ViewName=" + searchCriteria.ViewName + "&reportYear=" + searchCriteria.ViewCriteriaStarReportYear + "&reportID=" + searchCriteria.ViewCriteriaStarReportID.ToString + "&reportType=" + searchCriteria.ViewCriteriaStarReportType + "&reportDate=" + searchCriteria.ViewCriteriaStarReportDate.ToString + "&reportPrefix=" + r.Item("starrep_file_prefix").ToString + "&reportSuffix=" + searchCriteria.ViewCriteriaStarReportSuffix + "&reportCatagory=" + star_cat + """>" + star_cat + "</option>"
                        End If

                        If results_table.Rows.Count > 0 And searchCriteria.ViewCriteriaStarReportID = -1 Then
                            outString += vbCrLf + "<td align='left' valign='middle' class='papers' colspan='2'><a href=""view_template.aspx?ViewID=" + searchCriteria.ViewID.ToString + "&ViewName=" + searchCriteria.ViewName + "&reportYear=" + searchCriteria.ViewCriteriaStarReportYear + "&reportID=" + r.Item("starrep_id").ToString + "&reportType=" + searchCriteria.ViewCriteriaStarReportType + "&reportDate=" + searchCriteria.ViewCriteriaStarReportDate.ToString + "&reportPrefix=" + r.Item("starrep_file_prefix").ToString + "&reportSuffix=" + searchCriteria.ViewCriteriaStarReportSuffix + "&reportCatagory="">" + r.Item("starrep_title").ToString.Trim + "</a></td></tr>"
                        Else
                            outString += vbCrLf + "<td align='left' valign='middle' colspan='2'><img src='images/papers.jpg' class='bullet' alt='' /><strong><em>" + r.Item("starrep_title").ToString.Trim + "</em></strong></td></tr>"
                        End If

                        If Not IsDBNull(r.Item("starrep_description")) Then
                            If Not String.IsNullOrEmpty(r.Item("starrep_description").ToString.Trim) Then
                                star_desc = Replace(r.Item("starrep_description").ToString.Trim, Chr(10), "<br /><br />")
                            End If
                        End If

                        If Not IsDBNull(r.Item("starrep_title")) Then
                            If Not String.IsNullOrEmpty(r.Item("starrep_title").ToString.Trim) Then
                                star_title = r.Item("starrep_title").ToString.Trim
                            End If
                        End If

                        If Not IsDBNull(r.Item("starrep_sample_address")) Then
                            If Not String.IsNullOrEmpty(r.Item("starrep_sample_address").ToString.Trim) Then
                                star_sample_url = r.Item("starrep_sample_address").ToString.Trim
                            End If
                        End If

                    Next

                    ' add all reports to slection string
                    star_selected += "<option value=""view_template.aspx?ViewID=" + searchCriteria.ViewID.ToString + "&ViewName=" + searchCriteria.ViewName + "&reportYear=&reportID=&reportType=&reportDate=&reportPrefix=&reportSuffix=&reportCatagory="" selected=""selected"">All Categories</option>"

                Else
                    outString = "<tr><td align='left' valign='middle'>No Report Types</td></tr>"
                End If

            Else
                outString = "<tr><td align='left' valign='middle'>No Report Types</td></tr>"
            End If

            '' add to report List/Display Table Header 
            If searchCriteria.ViewCriteriaStarReportID > -1 Then
                htmlOut.Append("<tr><td align='center' valign='middle' class='header' style='height:24px;'>STAR REPORT SELECTED</td>")
                htmlOut.Append("<td align='right' valign='middle' class='header' style='height:24px;'>")
                htmlOut.Append("<a href=""view_template.aspx?ViewID=" + searchCriteria.ViewID.ToString + "&ViewName=" + searchCriteria.ViewName + "&reportYear=" + searchCriteria.ViewCriteriaStarReportYear + "&reportID=-1&reportType=" + searchCriteria.ViewCriteriaStarReportType + "&reportDate=" + searchCriteria.ViewCriteriaStarReportDate.ToString + "&reportPrefix=" + searchCriteria.ViewCriteriaStarReportPrefix + "&reportSuffix=" + searchCriteria.ViewCriteriaStarReportSuffix + "&reportCatagory="" style='color:white;' class='tiny'>All Report Names</a>&nbsp;</td></tr>")
            ElseIf Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaStarReportCatagory) And Not searchCriteria.ViewCriteriaStarReportCatagory.ToLower.Trim.Contains("name") Then
                htmlOut.Append("<tr><td align='center' valign='middle' class='header' style=' height:24px;'>" + searchCriteria.ViewCriteriaStarReportCatagory.ToUpper + " STAR REPORT(S)</td>")
                htmlOut.Append("<td align='right' valign='middle' class='header' style='height:24px;'>")
                htmlOut.Append("<a href=""view_template.aspx?ViewID=" + searchCriteria.ViewID.ToString + "&ViewName=" + searchCriteria.ViewName + "&reportYear=" + searchCriteria.ViewCriteriaStarReportYear + "&reportID=-1&reportType=" + searchCriteria.ViewCriteriaStarReportType + "&reportDate=" + searchCriteria.ViewCriteriaStarReportDate.ToString + "&reportPrefix=" + searchCriteria.ViewCriteriaStarReportPrefix + "&reportSuffix=" + searchCriteria.ViewCriteriaStarReportSuffix + "&reportCatagory=name"" style='color:white;' class='tiny'>All Report Categories</a>&nbsp;</td></tr>")
            Else
                htmlOut.Append("<tr><td align='center' valign='middle' class='header' style='height:24px;'>REPORT NAMES</td>")
                htmlOut.Append("<td align='right' valign='middle' class='header' style='height:24px; color:white;' class='tiny'>")
                htmlOut.Append("<font style='color:white;' class='tiny'>Browse&nbsp;By&nbsp;Category</font>&nbsp;<select name='reportCatagory' id='reportCatagoryID' onchange='JavaScript:displayElements(this.value);'>" + star_selected.Trim + "</select>")
                htmlOut.Append("&nbsp;</td></tr>")
            End If

            If Not IsNothing(results_table) Then

                If results_table.Rows.Count > 0 Then

                    htmlOut.Append(outString)
                    htmlOut.Append("<tr><td align='left' valign='top' colspan='2'>")
                    htmlOut.Append("<table id='starReportBodyTable' width='100%' cellpadding='1' cellspacing='0' class='module'><tr>")

                    If searchCriteria.ViewCriteriaStarReportID > 0 Then

                        htmlOut.Append("<td align='left' valign='top'>" + star_desc + "</td>")

                        If searchCriteria.ViewCriteriaStarReportID > 0 And Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaStarReportType.Trim) Then

                            results_table2 = star_functions.get_star_report_title_info(searchCriteria)

                            If Not IsNothing(results_table2) Then
                                If results_table2.Rows.Count > 0 Then
                                    For Each r2 As DataRow In results_table2.Rows

                                        If Not IsDBNull(r2.Item("startype_title")) Then
                                            If Not String.IsNullOrEmpty(r2.Item("startype_title").ToString.Trim) Then
                                                star_typedtitle = r2.Item("startype_title").ToString.Trim
                                            End If
                                        End If

                                    Next
                                End If
                            End If

                        End If

                        htmlOut.Append("<td align='right' valign='top'>")
                        htmlOut.Append("<table width='100%' align='right' class='cover' cellpadding='2' cellspacing='0'>")
                        htmlOut.Append("<tr><td><img src='images/spacer.gif' width='10' height='20' />&nbsp;</td></tr>")
                        htmlOut.Append("<tr><td valign='top' align='right' class='toptitle' height='60'>" + star_title + "&nbsp;</td></tr>")
                        htmlOut.Append("<tr><td><img src='images/spacer.gif' width='10' height='25' />&nbsp;</td></tr>")
                        htmlOut.Append("<tr><td valign='top' align='right' class='title'>" + star_typedtitle + "&nbsp;<br />")

                        If Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaStarReportDate) Then

                            htmlOut.Append(MonthName(CInt(searchCriteria.ViewCriteriaStarReportDate.Substring(4, 2).Trim)) + " ")

                            If CInt(searchCriteria.ViewCriteriaStarReportDate.Substring(6, 2)) = 1 Then
                                htmlOut.Append("1st, ")
                            Else
                                htmlOut.Append(CInt(searchCriteria.ViewCriteriaStarReportDate.Substring(6, 2)).ToString + " ")
                            End If

                            htmlOut.Append(searchCriteria.ViewCriteriaStarReportDate.Substring(0, 4).Trim + "&nbsp;<br />")

                        End If ' Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaStarReportDate) Then

                        If searchCriteria.ViewCriteriaStarReportID > 0 And Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaStarReportDate.ToString) And Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaStarReportType) Then

                            star_source_path = Server.MapPath("StarReports") + "\staticreports\" + searchCriteria.ViewCriteriaStarReportDate.ToString + "\sample\" + searchCriteria.ViewCriteriaStarReportPrefix + searchCriteria.ViewCriteriaStarReportSuffix

                            star_temp_path = Session.Item("localUser").crmSubSubID.ToString + "_" + Session.Item("localUser").crmUserLogin.trim + "_" + Session.Item("localUser").crmSubSeqNo.ToString + "_StarReport"
                            star_temp_path = commonEvo.GenerateFileName(star_temp_path, "", False)
                            star_temp_path += "_" + searchCriteria.ViewCriteriaStarReportPrefix + searchCriteria.ViewCriteriaStarReportSuffix

                            Try

                                If HttpContext.Current.Session.Item("localUser").crmDemoUserFlag = True Then
                                Else
                                    System.IO.File.Copy(star_source_path, Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath")) + "\" + star_temp_path, True)
                                    htmlOut.Append("<div style='padding-top:5px;'><input type='button' value='Open Report' onClick='JavaScript:openStarWindowJS(""" + Application.Item("crmClientSiteData").ClientFullHostName + "tempFiles/" + star_temp_path + """,""StarReport"");' /></div>")
                                End If
                            Catch ex As Exception
                                htmlOut.Append("<div style='padding-top:5px;'><input type='button' value='Error Retrieving Report'/></div>")
                            End Try

                        Else
                            htmlOut.Append("<div style='padding-top:5px;'>&nbsp;</div>")
                        End If

                        htmlOut.Append("</td></tr></table></td></tr>")

                    End If ' searchCriteria.ViewCriteriaStarReportID > 0 then

                    htmlOut.Append("</table></td></tr>")

                Else
                    htmlOut.Append(outString)
                End If

            Else
                htmlOut.Append(outString)
            End If

            htmlOut.Append("</table>") ' end table 1

            htmlOut.Append("</td>") ' End Table Header 

            htmlOut.Append("<td align='left' valign='top'>") ' column 2 for side tables

            '' Start left table1 for Report Types
            htmlOut.Append("<table id='starReportAirframeTable' width='100%' cellpadding='2' cellspacing='0' class='module'>")

            If Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaStarReportType) Then
                htmlOut.Append("<tr><td align='center' valign='middle' class='header'>AIRFRAME TYPES SELECTED - <a href=""view_template.aspx?ViewID=" + searchCriteria.ViewID.ToString + "&ViewName=" + searchCriteria.ViewName + "&reportYear=" + searchCriteria.ViewCriteriaStarReportYear + "&reportID=" + searchCriteria.ViewCriteriaStarReportID.ToString + "&reportType=&reportDate=" + searchCriteria.ViewCriteriaStarReportDate.ToString + "&reportPrefix=" + searchCriteria.ViewCriteriaStarReportPrefix + "&reportSuffix=" + searchCriteria.ViewCriteriaStarReportSuffix + """ style='color:white' class='tiny'>All Report Types</a></td>")
            Else
                htmlOut.Append("<tr><td align='center' valign='middle' class='header'>AIRFRAME TYPES - <font class='tiny'>No selection made</font></td></tr>")
            End If

            star_functions.views_display_star_report_airframe_types(searchCriteria, htmlStarReportTypes)
            htmlOut.Append(htmlStarReportTypes)

            htmlOut.Append("</table><br />")
            '' end left Table1 

            '' Start left Table2 to hold the report dates
            htmlOut.Append("<table id='starReportDateTable' width='100%' cellpadding='2' cellspacing='0' class='module'>")

            If Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaStarReportDate) Then
                htmlOut.Append("<tr><td align='center' valign='middle' class='header'>REPORT DATE SELECTED - <a href=""view_template.aspx?ViewID=" + searchCriteria.ViewID.ToString + "&ViewName=" + searchCriteria.ViewName + "&reportID=" + searchCriteria.ViewCriteriaStarReportID.ToString + "&reportType=" + searchCriteria.ViewCriteriaStarReportType + "&reportDate=&reportCatagory=" + searchCriteria.ViewCriteriaStarReportCatagory + "&reportPrefix=" + searchCriteria.ViewCriteriaStarReportPrefix + "&reportSuffix=" + searchCriteria.ViewCriteriaStarReportSuffix + """ style='color:white' class='tiny'>All Report Dates</a></td></tr>")
            ElseIf Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaStarReportYear) Then
                htmlOut.Append("<tr><td align='center' valign='middle' class='header'>REPORT YEAR SELECTED - <a href=""view_template.aspx?ViewID=" + searchCriteria.ViewID.ToString + "&ViewName=" + searchCriteria.ViewName + "&reportID=" + searchCriteria.ViewCriteriaStarReportID.ToString + "&reportType=" + searchCriteria.ViewCriteriaStarReportType + "&reportDate=&reportCatagory=" + searchCriteria.ViewCriteriaStarReportCatagory + "&reportPrefix=" + searchCriteria.ViewCriteriaStarReportPrefix + "&reportSuffix=" + searchCriteria.ViewCriteriaStarReportSuffix + "&reportYear="" style='color:white' class='tiny'>All Report Years</a></td></tr>")
            Else
                htmlOut.Append("<tr><td align='center' valign='middle' class='header'>REPORT DATES<font class='tiny'> - No selection made</font></td></tr>")
            End If

            star_functions.views_display_star_report_dates_available(searchCriteria, htmlStarReportDates)
            htmlOut.Append(htmlStarReportDates)

            htmlOut.Append("</table>") ' end left Table2 

            htmlOut.Append("</td></tr></table>")

            If Application.Item("crmClientSiteData").crmClientHostName.ToString.ToUpper.Contains("LOCALHOST") Or Application.Item("crmClientSiteData").crmClientHostName.ToString.ToUpper.Contains("NEWEVONET") Then
                star_sample_url = Application.Item("crmClientSiteData").ClientFullHostName + "StarReports/" + star_sample_url
            Else
                star_sample_url = Application.Item("crmClientSiteData").ClientFullHostName + star_sample_url
            End If

            star_functions.views_display_star_report_sample_frame(star_sample_url, searchCriteria, htmlStarReportSampleLink)
            htmlOut.Append(htmlStarReportSampleLink)

            htmlOut.Append("</td></tr></table>") ' inner star view table
            htmlOut.Append("</td></tr></table>") ' outter star view table

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [Build_StarReports_tab] : " + ex.Message
        End Try

        out_htmlString = htmlOut.ToString()
        htmlOut = Nothing

    End Sub

    Private Sub Build_Wanteds_tab(ByRef searchCriteria As viewSelectionCriteriaClass)

        Try


            view_wanteds_label1.Text = "<div style='height:370px; width:100%; overflow: auto;'>"

            'If CRMViewActive Then
            '  view_wanteds_label1.Text += JetnetClientSourceText
            'End If

            view_wanteds_label1.Text += "<table width=""100%"" cellpadding=""0"" cellspacing=""0"" class='module'><tr><td align=""left"" valign=""top"">"

            Dim htmlModelWanteds As String = ""

            If CRMViewActive Then
                crmViewDataLayer.Combined_views_display_model_wanteds(searchCriteria, htmlModelWanteds, localDatalayer, True, CRMViewActive)
            Else
                localDatalayer.views_display_model_wanteds(searchCriteria, htmlModelWanteds, CRMViewActive)
            End If

            view_wanteds_label1.Text += htmlModelWanteds
            view_wanteds_label1.Text += "</td></tr></table>"
            view_wanteds_label1.Text += "</div>"

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [Build_Wanteds_tab] : " + ex.Message
        End Try

    End Sub

    Public Sub Build_Aircraft_Dealer_Broker_View(ByRef searchCriteria As viewSelectionCriteriaClass, ByRef out_htmlString As String)

        Dim acdealer_view_function As New aircraft_dealer_functions
        Dim aclsData_Temp As New clsData_Manager_SQL
        Dim HoldTable As New DataTable
        Dim htmlOut As StringBuilder = New StringBuilder()
        Dim comp_link As String = ""
        Dim ac_rank As Integer = 0
        Dim temp_link As String = "<A href='view_template.aspx?ViewID=26&ViewName=Aircraft Dealer/Broker View"
        Dim temp_link_clear As String = "<A href='view_template.aspx?ViewID=26&ViewName=Aircraft Dealer/Broker View"
        Dim main_comp_id As Long = 0
        Dim country_name As String = ""
        Dim add_comma As Boolean = False
        Dim has_location As Boolean = False
        Dim google_map_string As String = ""
        Dim charting_string As String = ""
        Dim amod_id As Long = 0
        Dim model_name As String = ""
        Dim make_name As String = ""
        Dim tstring As String = ""
        Dim viewAirframe As String = ""


        Dim htmlOut_Dealers_AC As StringBuilder = New StringBuilder()
        Dim htmlOut_Dealers_Trans As StringBuilder = New StringBuilder()
        Dim htmlOut_Make As StringBuilder = New StringBuilder()
        Dim htmlOut_Country As StringBuilder = New StringBuilder()
        Dim htmlOut_Make_Model As StringBuilder = New StringBuilder()

        Try


            acdealer_view_function.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            acdealer_view_function.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            acdealer_view_function.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            acdealer_view_function.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            acdealer_view_function.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim


            aclsData_Temp.JETNET_DB = Application.Item("crmClientSiteData").AdminDatabaseConn
            aclsData_Temp.JETNET_DB = Application.Item("crmJetnetDatabase")
            aclsData_Temp.client_DB = Application.Item("crmClientDatabase")


            If Trim(Request("main_comp_id")) <> "" Then
                main_comp_id = CInt(Trim(Request("main_comp_id")))
                '  temp_link_clear &= "&main_comp_id=" & main_comp_id 
            End If

            '  If Trim(Session.Item("viewAircraftType")) <> "" Then 
            'localCriteria.ViewCriteriaAircraftType = Trim(Session.Item("viewAircraftType"))
            '  Else
            '   localCriteria.ViewCriteriaAircraftType = "'J'"
            '   End If 

            If Trim(localCriteria.ViewCriteriaAircraftType) = "" And Trim(Request("type_drop")) <> "" Then
                localCriteria.ViewCriteriaAircraftType = Trim(Request("type_drop"))
            Else
                localCriteria.ViewCriteriaAircraftType = localCriteria.ViewCriteriaAircraftType
            End If


            If Trim(Request("country_name")) <> "" Then
                country_name = Trim(Request("country_name"))
                '  temp_link_clear &= "&country_name=" & country_name
            End If

            If Trim(Request("amod_id")) <> "" Then
                amod_id = Trim(Request("amod_id"))
            ElseIf localCriteria.ViewCriteriaAmodID > 0 Then
                amod_id = localCriteria.ViewCriteriaAmodID
            ElseIf Trim(localCriteria.ViewCriteriaAircraftMake) <> "" Then
                make_name = localCriteria.ViewCriteriaAircraftMake
            End If

            If main_comp_id > 0 Then
                Me.right_side_graph_panel.Visible = True
                Me.right_side_bottom_panel.Visible = True
            Else
                Me.right_side_graph_panel.Visible = False
                Me.right_side_bottom_panel.Visible = False
            End If


            Me.cellTimeSpan.Visible = False
            Me.cellTimeSpanView.Visible = False


            If main_comp_id > 0 Then
                HoldTable.Clear()
                HoldTable = acdealer_view_function.ac_dealer_get_models_for_main_comp_id(main_comp_id, make_name, amod_id, localCriteria)


                htmlOut_Make.Append("<table id='modelForsaleViewOuterTable3' width=""100%"" cellpadding=""0"" cellspacing=""0"" class=""module"">")
                htmlOut_Make.Append("<tr><td align=""left"" valign=""top"">")

                If Not IsNothing(HoldTable) Then
                    If HoldTable.Rows.Count > 0 Then


                        htmlOut_Make.Append("<table id='tableCopy3' cellpadding='0' cellspacing='0' border='0'><thead>")
                        ' htmlOut.Append("<th class=""text_align_center""><span class=""help_cursor"" title=""Used to select and remove aircraft from the list"">SEL</span></th>")
                        '  htmlOut_Make.Append("<th class=""text_align_left"" nowrap='nowrap'>RANK</th>") 
                        htmlOut_Make.Append("<th class=""text_align_left"" width='323'>MODELS REPRESENTED")

                        If Trim(make_name) <> "" Then
                            htmlOut_Make.Append(" - " & make_name)
                        End If

                        If amod_id > 0 Then
                            If Trim(localCriteria.ViewCriteriaAircraftModel) <> "" Then
                                htmlOut_Make.Append(" - " & localCriteria.ViewCriteriaAircraftMake & " / " & localCriteria.ViewCriteriaAircraftModel)

                                htmlOut_Make.Append("&nbsp;&nbsp;&nbsp;&nbsp;(" & temp_link & "&country_name=" & country_name & "&main_comp_id=" & main_comp_id & "&amod_id=0&type_drop=" & localCriteria.ViewCriteriaAircraftType & "'>Clear")
                                htmlOut_Make.Append("</a>)")
                            End If
                        End If


                        htmlOut_Make.Append("</th>")
                        If main_comp_id > 0 And amod_id > 0 Then
                            'htmlOut_Make.Append("<th class=""text_align_center"" nowrap='nowrap'>&nbsp;</th>")
                        Else
                            htmlOut_Make.Append("<th class=""text_align_center"" nowrap='nowrap'>AC</th>")
                        End If


                        htmlOut_Make.Append("</thead>")

                        ac_rank = 0
                        For Each r As DataRow In HoldTable.Rows

                            htmlOut_Make.Append("<td class=""text_align_left"" nowrap='nowrap' width='323'>")

                            If amod_id = 0 Then
                                htmlOut_Make.Append(temp_link & "&amod_id=" & Trim(r("amod_id")) & "&main_comp_id=" & main_comp_id & "&country_name=" & country_name & "&type_drop=" & localCriteria.ViewCriteriaAircraftType & "'>")
                            End If


                            'ac_id, ac_ser_no_full, amod_make_name, amod_model_name, amod_id
                            If main_comp_id > 0 And amod_id > 0 Then


                                If Not IsDBNull(r("amod_make_name")) And Not IsDBNull(r("amod_model_name")) Then
                                    htmlOut_Make.Append(Trim(r("amod_make_name")) & " " & Trim(r("amod_model_name")) & "")
                                Else
                                    htmlOut_Make.Append("&nbsp;")
                                End If

                                If Not IsDBNull(r("ac_ser_no_full")) Then
                                    htmlOut_Make.Append(" Ser No: ")
                                    htmlOut_Make.Append(DisplayFunctions.WriteDetailsLink(r("ac_id"), 0, 0, 0, True, Trim(r("ac_ser_no_full")), "date_text", ""))
                                End If

                                If amod_id = 0 Then
                                    htmlOut_Make.Append("</a>")
                                End If

                                htmlOut_Make.Append("</td>")

                                ' htmlOut_Make.Append("<td class=""text_align_right"" nowrap='nowrap'>&nbsp;</td>")

                            Else

                                ac_rank = ac_rank + 1
                                ' htmlOut_Make.Append("<td class=""text_align_right"" nowrap='nowrap'>" & ac_rank & "</td>") 

                                If Not IsDBNull(r("amod_make_name")) And Not IsDBNull(r("amod_model_name")) Then
                                    htmlOut_Make.Append(Trim(r("amod_make_name")) & " " & Trim(r("amod_model_name")) & "")
                                Else
                                    htmlOut_Make.Append("&nbsp;")
                                End If

                                If amod_id = 0 Then
                                    htmlOut_Make.Append("</a>")
                                End If

                                htmlOut_Make.Append("</td>")

                                If Not IsDBNull(r("num_ac")) Then
                                    htmlOut_Make.Append("<td class=""text_align_right"" nowrap='nowrap'>" & r("num_ac") & "</td>")
                                Else
                                    htmlOut_Make.Append("<td class=""text_align_right"" nowrap='nowrap'>0</td>")
                                End If

                                'htmlOut.Append("<td class=""text_align_center"" nowrap='nowrap'>&nbsp;</td>") 
                            End If
                            htmlOut_Make.Append("</tr>")

                        Next


                        htmlOut_Make.Append("</table>")


                    End If

                End If




                htmlOut_Make.Append("<div id=""forSaleInnerTable3"" style=""width: 445px;""></div>")
                htmlOut_Make.Append("</td></tr>")
                htmlOut_Make.Append("</table>")

            Else
                HoldTable.Clear()
                HoldTable = acdealer_view_function.ac_dealer_function_by_model(amod_id, country_name, make_name, localCriteria)


                If Not IsNothing(HoldTable) Then
                    If HoldTable.Rows.Count > 0 Then


                        htmlOut_Make.Append("<table id='modelForsaleViewOuterTable3' width=""100%"" cellpadding=""0"" cellspacing=""0"" class=""module"">")
                        htmlOut_Make.Append("<tr><td align=""left"" valign=""top"">")

                        htmlOut_Make.Append("<table id='tableCopy3' cellpadding='0' cellspacing='0' border='0'><thead>")
                        ' htmlOut.Append("<th class=""text_align_center""><span class=""help_cursor"" title=""Used to select and remove aircraft from the list"">SEL</span></th>")
                        htmlOut_Make.Append("<th class=""text_align_left"" nowrap='nowrap'>RANK</th>")
                        htmlOut_Make.Append("<th class=""text_align_left"" width='255'>MAKE/MODEL</th>")
                        htmlOut_Make.Append("<th class=""text_align_center"" nowrap='nowrap'>DEALERS</th>")
                        htmlOut_Make.Append("</thead>")

                        ac_rank = 0
                        For Each r As DataRow In HoldTable.Rows

                            If amod_id > 0 Then
                                model_name = Trim(r("amod_make_name")) & " " & Trim(r("amod_model_name"))
                            End If

                            ac_rank = ac_rank + 1
                            htmlOut_Make.Append("<td class=""text_align_right"" nowrap='nowrap'>" & ac_rank & "</td>")

                            If Not IsDBNull(r("amod_make_name")) And Not IsDBNull(r("amod_model_name")) Then
                                htmlOut_Make.Append("<td class=""text_align_left"" nowrap='nowrap' width='255'>")

                                If amod_id > 0 Then

                                ElseIf main_comp_id = 0 Then
                                    htmlOut_Make.Append(temp_link & "&amod_id=" & Trim(r("amod_id")) & "&country_name=" & country_name & "&main_comp_id=" & main_comp_id & "&type_drop=" & localCriteria.ViewCriteriaAircraftType & "'>")
                                End If

                                htmlOut_Make.Append(Trim(r("amod_make_name")) & " " & Trim(r("amod_model_name")) & "")

                                If amod_id > 0 Then
                                    htmlOut_Make.Append("&nbsp;&nbsp;&nbsp;&nbsp;(" & temp_link & "&amod_id=0&country_name=" & country_name & "&main_comp_id=" & main_comp_id & "&type_drop=" & localCriteria.ViewCriteriaAircraftType & "'>Clear")
                                    htmlOut_Make.Append("</a>)")
                                ElseIf main_comp_id = 0 Then
                                    htmlOut_Make.Append("</a>")
                                End If
                                htmlOut_Make.Append("</td>")
                            Else
                                htmlOut_Make.Append("<td class=""text_align_left"" nowrap='nowrap' width='255'>&nbsp;</td>")
                            End If

                            If Not IsDBNull(r("numlocations")) Then
                                htmlOut_Make.Append("<td class=""text_align_right"" nowrap='nowrap'>" & r("numlocations") & "</td>")
                            Else
                                htmlOut_Make.Append("<td class=""text_align_right"" nowrap='nowrap'>0</td>")
                            End If

                            'htmlOut.Append("<td class=""text_align_center"" nowrap='nowrap'>&nbsp;</td>")
                            htmlOut_Make.Append("</tr>")

                        Next
                    End If
                End If


                htmlOut_Make.Append("</table>")
                htmlOut_Make.Append("<div id=""forSaleInnerTable3"" style=""width: 490px;""></div>")
                htmlOut_Make.Append("</td></tr>")
                htmlOut_Make.Append("</table>")


            End If





            HoldTable.Clear()

            If main_comp_id > 0 Then
                HoldTable = acdealer_view_function.ac_dealer_function_ac_count(main_comp_id, 0, "", "", localCriteria) ' then dont include make 
            Else
                HoldTable = acdealer_view_function.ac_dealer_function_ac_count(main_comp_id, amod_id, country_name, make_name, localCriteria)
            End If

            If Not IsNothing(HoldTable) Then
                If HoldTable.Rows.Count > 0 Then

                    htmlOut_Dealers_AC.Append("<table id='modelForsaleViewOuterTable' width=""100%"" valign=""top"" cellpadding=""0"" cellspacing=""0"" class=""module"">")
                    htmlOut_Dealers_AC.Append("<tr valign=""top""><td align=""left"" valign=""top"">")

                    htmlOut_Dealers_AC.Append("<table id='tableCopy' cellpadding='0' cellspacing='0' border='0' valign=""top""><thead>")
                    ' htmlOut.Append("<th class=""text_align_center""><span class=""help_cursor"" title=""Used to select and remove aircraft from the list"">SEL</span></th>")

                    If main_comp_id > 0 Then
                    ElseIf amod_id > 0 Then
                        htmlOut_Dealers_AC.Append("<th class=""text_align_left"" nowrap='nowrap'>RANK</th>")
                        htmlOut_Dealers_AC.Append("<th class=""text_align_left"" width='290'>CURRENT " & Trim(model_name) & " DEALERS</th>")
                        htmlOut_Dealers_AC.Append("<th class=""text_align_center"" nowrap='nowrap'>AC</th>")
                        htmlOut_Dealers_AC.Append("</thead>")
                    Else
                        htmlOut_Dealers_AC.Append("<th class=""text_align_left"" nowrap='nowrap'>RANK</th>")
                        htmlOut_Dealers_AC.Append("<th class=""text_align_left"" width='290'>DEALER NAME</th>")
                        htmlOut_Dealers_AC.Append("<th class=""text_align_center"" nowrap='nowrap'>AC</th>")
                        htmlOut_Dealers_AC.Append("</thead>")
                    End If



                    ac_rank = 0
                    For Each r As DataRow In HoldTable.Rows

                        '  htmlOut.Append("<td></td>")
                        ac_rank = ac_rank + 1

                        If Not IsDBNull(r("comp_name")) Then
                            comp_link = r("comp_name").ToString
                        End If

                        If main_comp_id > 0 Then
                            If ac_rank = 1 Then
                                htmlOut_Dealers_AC.Append("<th class=""text_align_left"" width='395'>" & comp_link & " ")

                                If Not IsDBNull(r("NUMLOCATIONS")) Then
                                    If r("NUMLOCATIONS") > 1 Then
                                        htmlOut_Dealers_AC.Append(" (" & r("NUMLOCATIONS") & " Locations, ")
                                    Else
                                        htmlOut_Dealers_AC.Append(" (1 Location, ")
                                    End If
                                End If

                                If Not IsDBNull(r("ACCOUNT")) Then
                                    htmlOut_Dealers_AC.Append("" & r("ACCOUNT") & "")
                                Else
                                    htmlOut_Dealers_AC.Append("0")
                                End If

                                htmlOut_Dealers_AC.Append(" Aircraft)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (")

                                htmlOut_Dealers_AC.Append(temp_link & "&amod_id=" & amod_id & "&country_name=" & country_name & "&main_comp_id=0&type_drop=" & localCriteria.ViewCriteriaAircraftType & "' onclick=""ChangeTheMouseCursorOnItemParentDocument('cursor_wait')"">Clear</a>)")

                                htmlOut_Dealers_AC.Append("</th>")
                                'htmlOut_Dealers_AC.Append("<th class=""text_align_center"" nowrap='nowrap'>AC</th>")
                                htmlOut_Dealers_AC.Append("</thead>")
                            End If
                        Else
                            htmlOut_Dealers_AC.Append("<td class=""text_align_right"" nowrap='nowrap'>" & ac_rank & "</td>")
                        End If

                        If main_comp_id > 0 Then
                            ' then skip this line completely
                        Else
                            If Trim(comp_link) <> "" Then
                                If Len(Trim(comp_link)) > 72 Then
                                    comp_link = Left(comp_link, 72) & "..."
                                End If


                                If aclsData_Temp.is_aerodex_insight() = True And main_comp_id = 0 Then
                                    comp_link = "<a class='underline' onclick=""javascript:load('DisplayCompanyDetail.aspx?compid=" & r("broker_main_comp_id") & "&journid=0&amod_id=" & amod_id & "&use_insight_dealer=Y&use_insight_roll=Y','','scrollbars=yes,menubar=no,height=900,width=1150,resizable=yes,toolbar=no,location=no,status=no');"">" & comp_link & "</a>"
                                ElseIf main_comp_id > 0 Then
                                    'comp_link = DisplayFunctions.WriteDetailsLink(0, r("broker_main_comp_id"), 0, 0, True, comp_link, "", "")
                                    comp_link = "<b>" & comp_link & "</b>"
                                Else
                                    comp_link = temp_link & "&main_comp_id=" & r("broker_main_comp_id") & "&country_name=" & country_name & "&amod_id=" & amod_id & "&type_drop=" & localCriteria.ViewCriteriaAircraftType & "'>" & comp_link & "</a>"
                                End If


                                htmlOut_Dealers_AC.Append("<td class=""text_align_left"" nowrap='nowrap' width='290'>" & comp_link)

                                If Not IsDBNull(r("NUMLOCATIONS")) Then
                                    If r("NUMLOCATIONS") > 1 Then
                                        htmlOut_Dealers_AC.Append(" (" & r("NUMLOCATIONS") & " Locations)")
                                    Else
                                        htmlOut_Dealers_AC.Append(" (1 Location)")
                                    End If
                                End If
                                htmlOut_Dealers_AC.Append("</td>")
                            Else
                                htmlOut_Dealers_AC.Append("<td class=""text_align_left"" nowrap='nowrap' width='290'>&nbsp;</td>")
                            End If

                            'If Not IsDBNull(r("NUMLOCATIONS")) Then
                            '  htmlOut.Append("<td class=""text_align_right"" nowrap='nowrap'>" & r("NUMLOCATIONS") & "</td>")
                            'Else
                            '  htmlOut.Append("<td class=""text_align_right"" nowrap='nowrap'>0</td>")
                            'End If

                            If Not IsDBNull(r("ACCOUNT")) Then
                                htmlOut_Dealers_AC.Append("<td class=""text_align_right"" nowrap='nowrap'>" & r("ACCOUNT") & "</td>")
                            Else
                                htmlOut_Dealers_AC.Append("<td class=""text_align_right"" nowrap='nowrap'>0</td>")
                            End If


                            'htmlOut.Append("<td class=""text_align_center"" nowrap='nowrap'>&nbsp;</td>")
                            htmlOut_Dealers_AC.Append("</tr>")
                        End If


                    Next
                End If
            End If









            If main_comp_id > 0 Then

                HoldTable.Clear()
                HoldTable = acdealer_view_function.ac_dealer_get_main_comp_id(main_comp_id)

                If Not IsNothing(HoldTable) Then
                    If HoldTable.Rows.Count > 0 Then

                        For Each r As DataRow In HoldTable.Rows

                            '  htmlOut_Dealers_AC.Append("<td class=""text_align_right"" nowrap='nowrap'>&nbsp;</td>")

                            If Not IsDBNull(r("comp_name")) Then
                                comp_link = r("comp_name").ToString

                                If aclsData_Temp.is_aerodex_insight() = True Then
                                    comp_link = ("<a class='underline' onclick=""javascript:load('DisplayCompanyDetail.aspx?compid=" & r("broker_main_comp_id") & "&journid=0&amod_id=" & amod_id & "&use_insight_dealer=Y&use_insight_roll=Y','','scrollbars=yes,menubar=no,height=900,width=1150,resizable=yes,toolbar=no,location=no,status=no');"">")
                                Else
                                    comp_link = DisplayFunctions.WriteDetailsLink(0, r("broker_comp_id"), 0, 0, True, comp_link, "", "")
                                End If
                            End If

                            htmlOut_Dealers_AC.Append("<td class=""text_align_left"" nowrap='nowrap' width='395'>" & comp_link)


                            add_comma = False
                            has_location = False


                            If Not IsDBNull(r("comp_city")) Then
                                If Trim(r("comp_city")) <> "" Then
                                    has_location = True
                                End If
                            End If
                            If Not IsDBNull(r("comp_state")) Then
                                If Trim(r("comp_state")) <> "" Then
                                    has_location = True
                                End If
                            End If
                            If Not IsDBNull(r("comp_country")) Then
                                If Trim(r("comp_country")) <> "" Then
                                    has_location = True
                                End If
                            End If

                            If has_location = True Then
                                htmlOut_Dealers_AC.Append(" (")

                                add_comma = False
                                If Not IsDBNull(r("comp_city")) Then
                                    If Trim(r("comp_city")) <> "" Then
                                        htmlOut_Dealers_AC.Append(r("comp_city"))
                                        add_comma = True
                                    End If
                                End If

                                If Not IsDBNull(r("comp_state")) Then
                                    If Trim(r("comp_state")) <> "" Then
                                        If add_comma = True Then
                                            htmlOut_Dealers_AC.Append(",")
                                        End If
                                        htmlOut_Dealers_AC.Append(r("comp_state"))
                                        add_comma = True
                                    End If
                                End If

                                If Not IsDBNull(r("comp_country")) Then
                                    If Trim(r("comp_country")) <> "" Then
                                        If add_comma = True Then
                                            htmlOut_Dealers_AC.Append(",")
                                        End If
                                        htmlOut_Dealers_AC.Append(r("comp_country"))
                                    End If
                                End If

                                htmlOut_Dealers_AC.Append(") ")
                            End If

                            htmlOut_Dealers_AC.Append("</td>")

                            If main_comp_id > 0 Then
                            Else
                                htmlOut_Dealers_AC.Append("<td class=""text_align_right"" nowrap='nowrap'>&nbsp;</td>")
                            End If



                            'htmlOut.Append("<td class=""text_align_center"" nowrap='nowrap'>&nbsp;</td>")
                            htmlOut_Dealers_AC.Append("</tr>")

                        Next
                    End If
                End If


            End If

            htmlOut_Dealers_AC.Append("</table>")

            If main_comp_id > 0 Then
                htmlOut_Dealers_AC.Append("<div id=""forSaleInnerTable"" style=""width: 445px;""></div>")
            Else
                htmlOut_Dealers_AC.Append("<div id=""forSaleInnerTable"" style=""width: 490px;""></div>")
            End If

            htmlOut_Dealers_AC.Append("</td></tr>")
            htmlOut_Dealers_AC.Append("</table>")











            If main_comp_id = 0 Then
                HoldTable.Clear()
                HoldTable = acdealer_view_function.ac_dealer_function_ac_sales(country_name, amod_id, make_name, localCriteria)


                If Not IsNothing(HoldTable) Then
                    If HoldTable.Rows.Count > 0 Then


                        htmlOut_Dealers_Trans.Append("<table id='modelForsaleViewOuterTable2' valign=""top"" width=""100%"" cellpadding=""0"" cellspacing=""0"" class=""module"">")
                        htmlOut_Dealers_Trans.Append("<tr valign=""top""><td align=""left"" valign=""top"">")

                        htmlOut_Dealers_Trans.Append("<table id='tableCopy2' cellpadding='0' cellspacing='0' border='0'><thead>")
                        ' htmlOut.Append("<th class=""text_align_center""><span class=""help_cursor"" title=""Used to select and remove aircraft from the list"">SEL</span></th>")

                        htmlOut_Dealers_Trans.Append("<th class=""text_align_left"" nowrap='nowrap'>RANK</th>")

                        If amod_id > 0 Then
                            htmlOut_Dealers_Trans.Append("<th class=""text_align_left"" width='270'>" & Trim(model_name) & "  DEALER SALES (" & (Year(Date.Now()) - 1) & ")</th>")
                        Else
                            htmlOut_Dealers_Trans.Append("<th class=""text_align_left"" width='270'>DEALER NAME</th>")
                        End If


                        htmlOut_Dealers_Trans.Append("<th class=""text_align_center"" nowrap='nowrap'>TRANS</th>")
                        htmlOut_Dealers_Trans.Append("</thead>")




                        '  google_map_string = " ['Dealer Name', 'Total Sales']"
                        ac_rank = 0
                        For Each r As DataRow In HoldTable.Rows

                            '  htmlOut.Append("<td></td>")

                            ac_rank = ac_rank + 1
                            htmlOut_Dealers_Trans.Append("<td class=""text_align_right"" nowrap='nowrap'>" & ac_rank & "</td>")


                            If Not IsDBNull(r("comp_name")) Then
                                comp_link = r("comp_name").ToString
                                If Len(Trim(comp_link)) > 70 Then
                                    comp_link = Left(comp_link, 70) & "..."
                                End If


                                If aclsData_Temp.is_aerodex_insight() = True And main_comp_id = 0 Then
                                    comp_link = "<a class='underline' onclick=""javascript:load('DisplayCompanyDetail.aspx?compid=" & r("broker_main_comp_id") & "&journid=0&amod_id=" & amod_id & "&use_insight_dealer=Y&use_insight_roll=Y','','scrollbars=yes,menubar=no,height=900,width=1150,resizable=yes,toolbar=no,location=no,status=no');"">" & comp_link & "</a>"
                                ElseIf main_comp_id > 0 Then
                                    comp_link = DisplayFunctions.WriteDetailsLink(0, r("broker_main_comp_id"), 0, 0, False, comp_link, "", "")
                                Else
                                    comp_link = temp_link & "&main_comp_id=" & r("broker_main_comp_id") & "&type_drop=" & localCriteria.ViewCriteriaAircraftType & "'>" & comp_link & "</a>"
                                End If


                                htmlOut_Dealers_Trans.Append("<td class=""text_align_left"" nowrap='nowrap' width='270'>" & comp_link)
                                htmlOut_Dealers_Trans.Append("</td>")

                            Else
                                htmlOut_Dealers_Trans.Append("<td class=""text_align_left"" nowrap='nowrap' width='270'>&nbsp;</td>")
                            End If


                            'If Not IsDBNull(r("numtrans")) Then
                            '  htmlOut.Append("<td class=""text_align_right"" nowrap='nowrap'>" & r("numtrans") & "</td>")
                            'Else
                            '  htmlOut.Append("<td class=""text_align_right"" nowrap='nowrap'>0</td>")
                            'End If

                            If Not IsDBNull(r("numtrans")) Then
                                htmlOut_Dealers_Trans.Append("<td class=""text_align_right"" nowrap='nowrap'>" & r("numtrans") & "</td>")
                            Else
                                htmlOut_Dealers_Trans.Append("<td class=""text_align_right"" nowrap='nowrap'>0</td>")
                            End If

                            '  google_map_string &= ", ['" & Replace(r("comp_name").ToString, "'", "") & "', " & r("numtrans") & "]"



                            'htmlOut.Append("<td class=""text_align_center"" nowrap='nowrap'>&nbsp;</td>")
                            htmlOut_Dealers_Trans.Append("</tr>")

                        Next
                    End If
                End If


                htmlOut_Dealers_Trans.Append("</table>")
                htmlOut_Dealers_Trans.Append("<div id=""forSaleInnerTable2"" style=""width: 490px;""></div>")
                htmlOut_Dealers_Trans.Append("</td></tr>")
                htmlOut_Dealers_Trans.Append("</table>")

                '  If amod_id > 0 Then
                'DisplayFunctions.load_google_chart(viewTabPanel, google_map_string, "", "", "chart_div_top_all", 480, 230, "ARRAY", 1, charting_string, Me.Page, Me.bottom_tab_update_panel, False, True, False, False, False, False, False, False, False, True, 0)
                '  google_map_string = ""
                '  End If

            End If









            If main_comp_id > 0 Then
            Else


                HoldTable.Clear()
                HoldTable = acdealer_view_function.ac_dealer_function_by_country(amod_id, country_name, make_name, localCriteria)

                If Not IsNothing(HoldTable) Then
                    If HoldTable.Rows.Count > 0 Then


                        htmlOut_Country.Append("<table id='modelForsaleViewOuterTable4' width=""100%"" cellpadding=""0"" cellspacing=""0"" class=""module"">")
                        htmlOut_Country.Append("<tr><td align=""left"" valign=""top"">")

                        htmlOut_Country.Append("<table id='tableCopy4' cellpadding='0' cellspacing='0' border='0'><thead>")
                        ' htmlOut.Append("<th class=""text_align_center""><span class=""help_cursor"" title=""Used to select and remove aircraft from the list"">SEL</span></th>")
                        htmlOut_Country.Append("<th class=""text_align_left"" nowrap='nowrap'>RANK</th>")


                        If amod_id > 0 Then
                            htmlOut_Country.Append("<th class=""text_align_left"" width='255'>" & Trim(model_name) & " DEALERS BY COUNTRY</th>")
                        Else
                            htmlOut_Country.Append("<th class=""text_align_left"" width='255'>COUNTRY</th>")
                        End If

                        htmlOut_Country.Append("<th class=""text_align_center"" nowrap='nowrap'>DEALERS</th>")
                        htmlOut_Country.Append("</thead>")

                        'google_map_string = " ['Country', 'Total Dealers']"

                        ac_rank = 0
                        For Each r As DataRow In HoldTable.Rows

                            ac_rank = ac_rank + 1
                            htmlOut_Country.Append("<td class=""text_align_right"" nowrap='nowrap'>" & ac_rank & "</td>")

                            If Not IsDBNull(r("comp_country")) Then
                                htmlOut_Country.Append("<td class=""text_align_left"" nowrap='nowrap' width='255'>")

                                If main_comp_id = 0 And amod_id = 0 And Trim(country_name) = "" Then
                                    htmlOut_Country.Append(temp_link & "&country_name=" & Trim(r("comp_country")) & "&main_comp_id=" & main_comp_id & "&amod_id=" & amod_id & "&type_drop=" & localCriteria.ViewCriteriaAircraftType & "'>")
                                End If

                                htmlOut_Country.Append(Trim(r("comp_country")))

                                If Trim(country_name) <> "" Then
                                    htmlOut_Country.Append("&nbsp;&nbsp;&nbsp;&nbsp;(" & temp_link & "&comp_country=&main_comp_id=" & main_comp_id & "&amod_id=" & amod_id & "&type_drop=" & localCriteria.ViewCriteriaAircraftType & "'>Clear")
                                End If

                                If main_comp_id = 0 And amod_id = 0 Then
                                    htmlOut_Country.Append("</a>")
                                End If

                                If Trim(country_name) <> "" Then
                                    htmlOut_Country.Append(")")
                                End If

                                htmlOut_Country.Append("</td>")
                            Else
                                htmlOut_Country.Append("<td class=""text_align_left"" nowrap='nowrap' width='255'>&nbsp;</td>")
                            End If

                            If Not IsDBNull(r("numdealers")) Then
                                htmlOut_Country.Append("<td class=""text_align_right"" nowrap='nowrap'>" & r("numdealers") & "</td>")
                            Else
                                htmlOut_Country.Append("<td class=""text_align_right"" nowrap='nowrap'>0</td>")
                            End If

                            htmlOut_Country.Append("</tr>")


                            ' google_map_string &= ", ['" & Replace(Trim(r("comp_country")), "'", "") & "', " & r("numdealers") & "]"


                        Next
                    End If
                End If


                htmlOut_Country.Append("</table>")
                htmlOut_Country.Append("<div id=""forSaleInnerTable4"" style=""width: 490px;""></div>")
                htmlOut_Country.Append("</td></tr>")
                htmlOut_Country.Append("</table>")


                '  If amod_id > 0 Then
                '    DisplayFunctions.load_google_chart(viewTabPanel, google_map_string, "", "", "chart_div_bottom_all", 480, 230, "ARRAY", 1, charting_string, Me.Page, Me.bottom_tab_update_panel, False, True, False, False, False, False, False, False, False, True, 0)
                '    google_map_string = ""
                '  End If

            End If





            ' SALES BY YEAR FOR COMPANY  ----------------------------------------
            If main_comp_id > 0 Then
                HoldTable.Clear()
                HoldTable = acdealer_view_function.ac_dealer_get_sales_by_year_main_comp_id(main_comp_id, make_name, amod_id, localCriteria)


                If Not IsNothing(HoldTable) Then
                    If HoldTable.Rows.Count > 0 Then

                        google_map_string = " ['Year', 'Total Count']"
                        For Each r As DataRow In HoldTable.Rows

                            google_map_string &= ", ['" & r("TYEAR") & "', " & r("numtrans") & "]"

                        Next
                    End If
                End If

                DisplayFunctions.load_google_chart(viewTabPanel, google_map_string, "", "", "chart_div_top_all", 480, 230, "ARRAY", 1, charting_string, Me.Page, Me.bottom_tab_update_panel, False, True, True, False, False, True, False)
                google_map_string = ""

            End If
            ' SALES BY YEAR FOR COMPANY  ----------------------------------------


            If main_comp_id > 0 Then
                HoldTable.Clear()
                HoldTable = acdealer_view_function.ac_dealer_get_relationship_sales_main_comp_id(main_comp_id, make_name, amod_id, localCriteria, "N")


                If Not IsNothing(HoldTable) Then
                    If HoldTable.Rows.Count > 0 Then

                        google_map_string = " ['Rel Type', 'Total Count']"
                        For Each r As DataRow In HoldTable.Rows

                            google_map_string &= ", ['" & r("RELTYPE") & "', " & r("numtrans") & "]"

                        Next
                    End If
                End If

                DisplayFunctions.load_google_chart(viewTabPanel, google_map_string, "", "", "chart_div_bottom_all", 480, 230, "ARRAY", 2, charting_string, Me.Page, Me.bottom_tab_update_panel, False, False, False, False, False, False, False, False, False, True)
                google_map_string = ""
            End If


            Me.sales_sum_year.Text = (Year(Now()) - 1)


            If main_comp_id > 0 Then
                HoldTable.Clear()
                HoldTable = acdealer_view_function.ac_dealer_sales_by_model(main_comp_id, make_name, amod_id, localCriteria, "")


                If Not IsNothing(HoldTable) Then

                    htmlOut_Make_Model.Append("<table id='modelForsaleViewOuterTable2' width=""100%"" cellpadding=""0"" cellspacing=""0"" class=""module"">")
                    htmlOut_Make_Model.Append("<tr><td align=""left"" valign=""top"">")

                    htmlOut_Make_Model.Append("<table id='tableCopy2' cellpadding='0' cellspacing='0' border='0'><thead>")


                    htmlOut_Make_Model.Append("<th class=""text_align_center"" nowrap='nowrap' width='250'>MAKE/MODEL</th>")
                    htmlOut_Make_Model.Append("<th class=""text_align_center"" nowrap='nowrap' width='100'>TOTAL</th>")
                    htmlOut_Make_Model.Append("</thead>")

                    If HoldTable.Rows.Count > 0 Then

                        For Each r As DataRow In HoldTable.Rows

                            htmlOut_Make_Model.Append("<td class=""text_align_left"" nowrap='nowrap' width='250'>")

                            If main_comp_id > 0 And amod_id > 0 Then
                                If Trim(r("year_of")) <> "" Then
                                    htmlOut_Make_Model.Append(Trim(r("year_of")) & " - ")
                                End If
                                Me.sales_sum_year.Text = Trim(r("year_of"))
                                If Trim(Request("trans")) = "Y" Then
                                    Me.sales_sum_year.Text = Me.sales_sum_year.Text & "  (" & temp_link & "&country_name=" & country_name & "&main_comp_id=" & main_comp_id & "&amod_id=" & amod_id & "&type_drop=" & localCriteria.ViewCriteriaAircraftType.ToString & "&trans=N'>Show Totals</a>)"
                                Else
                                    Me.sales_sum_year.Text = Me.sales_sum_year.Text & "  (" & temp_link & "&country_name=" & country_name & "&main_comp_id=" & main_comp_id & "&amod_id=" & amod_id & "&type_drop=" & localCriteria.ViewCriteriaAircraftType.ToString & "&trans=Y'>Show Details</a>)"
                                End If


                                ' will show earliest year
                            End If

                            htmlOut_Make_Model.Append(Trim(r("amod_make_name")) & " " & r("amod_model_name"))

                            htmlOut_Make_Model.Append("</td>")

                            If Not IsDBNull(r("TCOUNT")) Then
                                htmlOut_Make_Model.Append("<td class=""text_align_right"" nowrap='nowrap' width='100'>" & r("TCOUNT") & "</td>")
                            Else
                                htmlOut_Make_Model.Append("<td class=""text_align_right"" nowrap='nowrap' width='100'>0</td>")
                            End If

                            htmlOut_Make_Model.Append("</tr>")

                        Next
                    End If
                End If

            End If




            If main_comp_id > 0 And amod_id > 0 And Trim(Request("trans")) = "Y" Then
                htmlOut_Make_Model.Length = 0
                HoldTable.Clear()
                HoldTable = aclsData_Temp.GetJETNET_OnlyTransactionsByCompany(main_comp_id, amod_id)
                If Not IsNothing(HoldTable) Then

                    htmlOut_Make_Model.Append("<table id='modelForsaleViewOuterTable2' width=""510"" cellpadding=""0"" cellspacing=""0"" class=""module"">")
                    htmlOut_Make_Model.Append("<tr><td align=""left"" valign=""top"">")

                    htmlOut_Make_Model.Append("<table id='tableCopy2' cellpadding='0' cellspacing='0' border='0' width=""510""><thead>")

                    htmlOut_Make_Model.Append("<th class=""text_align_left"" nowrap='nowrap' width='100'>DATE</th>")
                    htmlOut_Make_Model.Append("<th class=""text_align_center"" nowrap='nowrap' width='400'>TRANSACTION DESCRIPTION</th>")
                    htmlOut_Make_Model.Append("<th class=""text_align_center"" nowrap='nowrap' width='100'>RELATIONSHIP</th>")

                    htmlOut_Make_Model.Append("</thead>")


                    If HoldTable.Rows.Count > 0 Then
                        For Each r As DataRow In HoldTable.Rows


                            htmlOut_Make_Model.Append("<td class=""text_align_right"" width='100'>")

                            If Not IsDBNull(r("journ_date")) Then
                                htmlOut_Make_Model.Append(Trim(r("journ_date")))
                            End If

                            htmlOut_Make_Model.Append("</td>")

                            htmlOut_Make_Model.Append("<td class=""text_align_left"" width='300'>")

                            'If Not IsDBNull(r("amod_make_name")) Then
                            '  htmlOut_Make_Model.Append(Trim(r("amod_make_name")) & "&nbsp;")
                            'End If

                            'If Not IsDBNull(r("amod_model_name")) Then
                            '  htmlOut_Make_Model.Append(Trim(r("amod_model_name")) & "&nbsp;")
                            'End If

                            If Not IsDBNull(r("ac_id")) Then
                                htmlOut_Make_Model.Append(" Ser#: " & DisplayFunctions.WriteDetailsLink(r("ac_id"), 0, 0, r("journ_id"), True, r("ac_ser_no_full"), "", ""))
                            End If

                            If Not IsDBNull(r("journ_subject")) Then
                                htmlOut_Make_Model.Append(", " & Trim(r("journ_subject")) & "&nbsp;")
                            End If

                            htmlOut_Make_Model.Append("</td>")

                            htmlOut_Make_Model.Append("<td class=""text_align_left"" nowrap='nowrap' width='100'>")

                            If Not IsDBNull(r("actype_name")) Then
                                htmlOut_Make_Model.Append(Trim(r("actype_name")))
                            End If

                            htmlOut_Make_Model.Append("&nbsp;</td>")

                            htmlOut_Make_Model.Append("</tr>")

                        Next
                    End If

                End If


                htmlOut_Make_Model.Append("</table>")
                htmlOut_Make_Model.Append("<div id=""forSaleInnerTable2"" style=""width: 510px;""></div>")
                htmlOut_Make_Model.Append("</td></tr>")
                htmlOut_Make_Model.Append("</table>")
            Else
                htmlOut_Make_Model.Append("</table>")
                htmlOut_Make_Model.Append("<div id=""forSaleInnerTable2"" style=""width: 460px;""></div>")
                htmlOut_Make_Model.Append("</td></tr>")
                htmlOut_Make_Model.Append("</table>")
            End If











            'OVERALL BIG TABLE
            htmlOut.Append("<table id='modelForsaleViewOuterTable2' valign=""top"" width=""100%"" cellpadding=""0"" cellspacing=""0"" class=""module"">")

            If amod_id > 0 Then
            ElseIf main_comp_id > 0 Then
            ElseIf Trim(country_name) <> "" Then
            Else
                htmlOut.Append("<tr valign=""top""><td align=""center"" valign=""top"" width=""50%""  class='header'>Top 500 Dealers (By Listings)")
                htmlOut.Append("</td><td width=""50%"" valign=""top"" class='header' align='center'>Top 500 Dealers (Last 365 Days)</tr>")
            End If




            htmlOut.Append("<tr valign='top'>")
            If main_comp_id > 0 Then
                htmlOut.Append("<td align=""left"" valign=""top"" width=""50%"" height='230''>")
            Else
                htmlOut.Append("<td align=""left"" valign=""top"" width=""50%"">")
            End If

            '---------------------- TOP LEFT-----------------------------------------------------------------------------------
            If Trim(country_name) <> "" Then
                htmlOut.Append(htmlOut_Country)
                htmlOut.Append("<br/>")
                htmlOut.Append(htmlOut_Dealers_AC)
            ElseIf main_comp_id > 0 Then
                htmlOut.Append(htmlOut_Dealers_AC)
                htmlOut.Append("<br/>")
                htmlOut.Append(htmlOut_Make)
            ElseIf amod_id > 0 Then
                htmlOut.Append(htmlOut_Make)
                htmlOut.Append("<br/>")
                htmlOut.Append(htmlOut_Dealers_AC)
            Else
                htmlOut.Append(htmlOut_Dealers_AC)
            End If
            '---------------------- TOP LEFT-----------------------------------------------------------------------------------

            htmlOut.Append("</td><td width=""50%"" valign=""top"">")

            '---------------------- TOP RIGHT-----------------------------------------------------------------------------------
            If Trim(country_name) <> "" Then
                htmlOut.Append(htmlOut_Dealers_Trans)
                htmlOut.Append("<br/>")
                htmlOut.Append(htmlOut_Make)
            ElseIf main_comp_id > 0 Then
                ' Sales by Year CHART -  
            ElseIf amod_id > 0 Then
                ' Sales by Year CHART - 
                htmlOut.Append(htmlOut_Dealers_Trans)
                htmlOut.Append("<br/>")
                htmlOut.Append(htmlOut_Country)
            Else
                htmlOut.Append(htmlOut_Dealers_Trans)
            End If
            '---------------------- TOP RIGHT-----------------------------------------------------------------------------------
            htmlOut.Append("</td></tr>")
            If Trim(country_name) <> "" Then
                ' htmlOut.Append("<tr valign='top'><td align=""center"" valign=""top"" width=""50%""  class='header'>Top 500 Dealers (By Listings)")
                '  htmlOut.Append("</td><td width=""50%"" valign=""top"" class='header' align='center'>Top 500 MAKE/MODELS (#Locations)</td></tr>")
            ElseIf main_comp_id > 0 Then
            ElseIf amod_id > 0 Then
            Else
                htmlOut.Append("<tr valign='top'><td align=""center"" valign=""top"" width=""50%""  class='header'>Top 500 MAKE/MODELS (#Dealers)")
                htmlOut.Append("</td><td width=""50%"" valign=""top"" class='header' align='center'>Top 500 Countries (#Dealers w/ Aircraft)</td></tr>")
            End If

            htmlOut.Append("<tr valign='top'><td align=""left"" valign=""top"" width=""50%"">")
            '---------------------- BOTTOM LEFT-----------------------------------------------------------------------------------

            If Trim(country_name) <> "" Then
                ' htmlOut.Append(htmlOut_Dealers_AC)
            ElseIf main_comp_id > 0 Then
                'htmlOut.Append(htmlOut_Make)
            ElseIf amod_id > 0 Then
                ' htmlOut.Append(htmlOut_Dealers_AC)
            Else
                htmlOut.Append(htmlOut_Make)
            End If


            '---------------------- BOTTOM LEFT-----------------------------------------------------------------------------------

            htmlOut.Append("</td><td width=""50%"" valign=""top"">")

            '---------------------- BOTTOM RIGHT-----------------------------------------------------------------------------------

            If Trim(country_name) <> "" Then
                'htmlOut.Append(htmlOut_Make)
            ElseIf main_comp_id > 0 Then
                ' Sales Last Year (2015) - 113” …. Based on   
            ElseIf amod_id > 0 Then
                ' Sales by Year CHART - 
                '  htmlOut.Append(htmlOut_Country)
            Else
                htmlOut.Append(htmlOut_Country)
            End If


            '---------------------- BOTTOM RIGHT-----------------------------------------------------------------------------------
            htmlOut.Append("</td></tr></table>") ' END BIG TABLE



            If main_comp_id > 0 Then
                ' make this to the right side panel
                Me.right_side_graph_panel.Visible = True
                Me.ToggleOffForSPI.Visible = True
                ' Me.google_sold_trends_graphs2.Visible = False
                Call load_google_chart_all(viewTabPanel, charting_string)
            End If


            out_htmlString = htmlOut.ToString

            CheckAndJSForDatatable()


            If main_comp_id > 0 Then
                Me.right_side_bottom_panel.Visible = True
                Me.chart_label_right_bottom.Text = htmlOut_Make_Model.ToString
            End If


        Catch ex As Exception

        End Try

    End Sub

    Private Function ConvertDataTableToHTML(ByVal dt As DataTable) As String
        Dim cssClass As String = ""
        Dim html As String = ""
        If Not IsNothing(dt) Then
            If dt.Rows.Count > 0 Then
                html = "<table id=""summary_table"" cellpadding=""3"" cellspacing=""0"" width=""100%"">"
                'add header row
                html += "<thead>"
                html += "<tr>"
                html += "<th>Top 10 Manufacturers</th>"
                html += "<th>Nbr Flights</th>"
                html += "<th>Total Flight Hours</th>"
                html += "<th>Total Est Fuel<br/>Burn (GAL)</th>"
                html += "</tr>"
                html += "</thead>"
                'add rows
                html += "<tbody>"


                For Each r As DataRow In dt.Rows
                    html += "<tr class=""" & cssClass & """>"

                    html += "<td align=""left"">"
                    If Not IsDBNull(r("TOP 10 MANUFACTURERS")) Then
                        html += r("TOP 10 MANUFACTURERS").ToString
                    End If
                    html += "</td>"

                    html += "<td align=""right"">"
                    If Not IsDBNull(r("NBR FLIGHTS")) Then
                        html += FormatNumber(r("NBR FLIGHTS"), 0).ToString
                    End If
                    html += "</td>"

                    html += "<td align=""right"">"
                    If Not IsDBNull(r("TOTAL FLIGHT HOURS")) Then
                        html += FormatNumber(r("TOTAL FLIGHT HOURS"), 1).ToString
                    End If
                    html += "</td>"

                    html += "<td align=""right"">"
                    If Not IsDBNull(r("EST FUEL BURN")) Then
                        html += FormatNumber(r("EST FUEL BURN"), 0).ToString
                    End If
                    html += "</td>"

                    html += "</tr>"
                Next


                If cssClass = "" Then
                    cssClass = "alt_row"
                Else
                    cssClass = ""
                End If

                html += "</tbody>"
                html += "</table>"

            End If
        End If
        Return html
    End Function

    Private Sub UtilizationReportTable()
        'Let's turn this generic table into a js datatable.
        Dim jsScript As String = ""
        Dim excelButton As String = ""
        jsScript = "function createSummaryTable() { "

        jsScript += "var cw = $('.MaxWidthRemove').width() - 20;"
        jsScript += "$("".specialTableContainer"").width(cw);"

        jsScript += "$(window).resize(function() {"
        jsScript += "var cw = $('.MaxWidthRemove').width() - 20;"
        jsScript += "$("".specialTableContainer"").width(cw);"
        jsScript += "});"

        jsScript += "$('#summary_table').DataTable({"
        jsScript += " destroy: true,"
        jsScript += "scrollX: cw,"
        jsScript += "autoWidth: true, "
        jsScript += "scrollY: 430,"
        jsScript += " fixedHeader: true, "
        jsScript += " scrollCollapse: true,"
        jsScript += " stateSave: true,"
        jsScript += "paging: false, "
        jsScript += "dom: 'Bfitrp',"
        jsScript += "order: [[ 0, 'asc' ]],"

        If utilization_summary_type.SelectedValue = "refuel" Then
            jsScript += "columnDefs: ["
            jsScript += " {"
            jsScript += "targets: [ 3,5,8,13 ],"
            jsScript += " width: '100px',"
            jsScript += "},"
            jsScript += " {"
            jsScript += "targets: [ 0,1,2,4,6,7,9,10,11,12 ],"
            jsScript += " width: '54px',"
            jsScript += "}"
            jsScript += "],"
        End If

        jsScript += "buttons: [ "

        If Session.Item("localUser").crmDemoUserFlag = True Then
            'PDF Button
            jsScript += " {extend: 'pdf', enabled: false , orientation: 'landscape', pageSize: 'A2', exportOptions : {columns: ':visible'}}, "
            jsScript += " {extend: 'csv', enabled: false , exportOptions : {columns: ':visible'}}, "
        Else
            'PDF Button
            jsScript += " {extend: 'pdf', orientation: 'landscape', pageSize: 'A2', exportOptions : {columns: ':visible'}}, "
            jsScript += " {extend: 'csv', exportOptions : {columns: ':visible'}}, "
        End If

        'Excel Button
        CreateExcelButton(excelButton, "summaryTable")

        jsScript += excelButton
        jsScript += "]}); "
        jsScript += "$($.fn.dataTable.tables(true)).DataTable().columns.adjust();"
        jsScript += "$($.fn.dataTable.tables(true)).DataTable().scroller.measure();"
        jsScript += "}; createSummaryTable();"

        'Written to page:
        System.Web.UI.ScriptManager.RegisterClientScriptBlock(top_tab_update_panel, Me.GetType(), "CreateUtilDatatableFunction", jsScript.ToString, True)


    End Sub

    Public Sub Utilization_Build_Summaries(ByRef util_functions As utilization_functions, ByVal searchCriteria As viewSelectionCriteriaClass, ByVal product_code_selection As String, ByVal TotalFlights As Long)
        Dim tempTable As New DataTable
        Dim googleText As String = "<p><!--Chart goes here.--></p>"
        utilization_summaries_label.Text = ""
        'Model Report
        Me.techstop_label.Visible = False


        Me.techstop_label.Visible = True
        Me.techstop_label2.Visible = True
        Me.techstop_label3.Visible = True
        Me.percentage_drop.Visible = True
        Me.minutes_drop.Visible = True

        tempTable = util_functions.GetRefuel(searchCriteria, product_code_selection, TotalFlights, percentage_drop.SelectedValue, minutes_drop.SelectedValue)

        'write js to screen
        System.Web.UI.ScriptManager.RegisterClientScriptBlock(top_tab_update_panel, Me.GetType(), "WriteRefuelArray", util_functions.RefuelJSArray(tempTable, searchCriteria), True)

        System.Web.UI.ScriptManager.RegisterClientScriptBlock(top_tab_update_panel, Me.GetType(), "CreateRefuelDT", BuildRefuelOperatorDataTableJS(), True)
        'System.Web.UI.ScriptManager.RegisterClientScriptBlock(top_tab_update_panel, Me.GetType(), "CreateRefuelDT", crea, True)ui

        'utilization_summaries_label.Text = "<div class=""row""><div class=""twelve columns""><div style=""width:940px"">" & ReportRefuel(tempTable, searchCriteria) & "</div></div></div>"


    End Sub

    Public Sub Utilization_Build_Reports(ByRef util_functions As utilization_functions, ByVal searchCriteria As viewSelectionCriteriaClass, ByVal product_code_selection As String, ByVal TotalFlights As Long)
        Dim tempTable As New DataTable
        Dim googleText As String = "<p><!--Chart goes here.--></p>"
        utilization_summaries_label.Text = ""
        'Model Report
        Me.techstop_label.Visible = False


        Select Case reports_drop.SelectedValue
            Case "refuel"
                Me.techstop_label.Visible = True
                Me.techstop_label2.Visible = True
                Me.techstop_label3.Visible = True
                Me.percentage_drop.Visible = True
                Me.minutes_drop.Visible = True

                tempTable = util_functions.GetRefuel(searchCriteria, product_code_selection, TotalFlights, percentage_drop.SelectedValue, minutes_drop.SelectedValue)

                'write js to screen
                System.Web.UI.ScriptManager.RegisterClientScriptBlock(top_tab_update_panel, Me.GetType(), "WriteRefuelArray", util_functions.RefuelJSArray(tempTable, searchCriteria), True)

                System.Web.UI.ScriptManager.RegisterClientScriptBlock(top_tab_update_panel, Me.GetType(), "CreateRefuelDT", BuildRefuelOperatorDataTableJS(), True)
                'System.Web.UI.ScriptManager.RegisterClientScriptBlock(top_tab_update_panel, Me.GetType(), "CreateRefuelDT", crea, True)ui

                'utilization_summaries_label.Text = "<div class=""row""><div class=""twelve columns""><div style=""width:940px"">" & ReportRefuel(tempTable, searchCriteria) & "</div></div></div>"
            Case Else
                tempTable = util_functions.get_flight_activity_by_model(searchCriteria, product_code_selection, "view", TotalFlights, True)
                reports_label.Text = "<div class=""row""><div class=""twelve columns""><div class=""specialTableContainer"">" & ConvertDataTableToHTML(tempTable) & "</div></div></div>"

                UtilizationReportTable()
        End Select

    End Sub

    Private Sub BuildUtilizationUI()
        flightDataLabel.Text = ""
        utilizationAirportMap.Visible = False
        flightDataContainer.Visible = True
        originDataContainer.Visible = True
        utilizationViewAirport.Visible = False
        utilizationViewOperator.Visible = False
        utilizationViewAirportLabel.Text = ""
        utilizationViewOperatorLabel.Text = ""
        utilizationBoxes.Visible = True
        utilizationViewMainBox.Visible = True
        panel_20.Visible = False
        panel_19.Visible = False
        PanelCollapseEx.Collapsed = False
        PanelCollapseEx.ClientState = False
        check_owner_ac.Checked = True

        fboMapScript.Visible = True
        aircraftFolderRow.Visible = True
        utilization_summaries_tab.Visible = True
        reports_tab_panel.Visible = True

        airportAircraftFolderToggleOnOff.Visible = True
        airportAircraftFolderToggleOnOff.Attributes.Add("class", "display_none")

        searchUtilizationBasedOn.Visible = True

        airportDrop.Visible = True
        airportDrop.CssClass = "display_none"

        operator_drop2.Visible = True
        operator_drop2.CssClass = "display_none"

        airportExcludeCheck.Visible = True
        airportExcludeCheck.CssClass = "display_none"

        exclude_check.Visible = True
        exclude_check.CssClass = "display_none"

        searchDateRange.Visible = True
        toggleFlightSummaryPanel.Visible = True

        TabContainer1.Visible = True
        TabContainer2.Visible = False
        tabs_container.Visible = False

        'Toggle the search bar on:
        airportFBOViewSearchCell.Visible = True
        airportSearchToggleOnOff.Attributes.Add("class", "display_none")
        selectAirportsType.Visible = True
        cellTypeMakeModel.CssClass = ""
        cellTypeMakeModel.RowSpan = "5"
        cellTimeSpan.CssClass = ""
        cellTimeSpan.VerticalAlign = VerticalAlign.Top
        cellGoApply.CssClass = "display_none"

        timespanText.Visible = False
        selectViewTimeSpan.CssClass = "display_none"


        ViewTMMDropDowns.setControlName(sTypeMakeModelCtrlBaseName)
        ViewTMMDropDowns.setOverideMultiSelect(True)

        fboViewSearch_textbox.Width = 178
        fboViewSearch_textbox.Attributes.Remove("placeholder")
        fboViewSearch_textbox.Attributes.Add("placeholder", "Search IATA/ICAO/City/Name")

        fboViewSearch_Button.Visible = False
        airportOperatorPanel.Visible = True
        airportsHeaderWidth.Width = 225
        imageSpacer.Visible = False

        resizeTopLeftTab.Attributes.Add("style", "width:auto !important")
        topLeftCSSContainer.CssClass = ""

        ''Setting up Visible Tabs:
        'Me.for_sale_tab.HeaderText = "Routes"      ' tab 2
        'Me.retail_tab.HeaderText = "Aircraft Model"      ' tab 3

        'Me.event_tab.HeaderText = "Aircraft"                  ' tab 4
        'event_tab.Visible = True

        'Me.news_tab.HeaderText = "Flights"                ' tab 5
        'news_tab.Visible = True

        ' changed to the following titles - MSW 
        'Setting up Visible Tabs: 
        Me.retail_tab.HeaderText = "Routes"      ' tab 3

        Me.event_tab.HeaderText = "Flights"                  ' tab 4
        event_tab.Visible = True

        Me.news_tab.HeaderText = "Aircraft"                ' tab 5
        news_tab.Visible = True

        Me.wanted_tab.HeaderText = "Aircraft Model"
        Me.wanted_tab.Visible = True


        Me.model_market_status_tab.HeaderText = "Utilization"
        Me.model_fleet_tab.HeaderText = "Top Origins/Destinations"
        Me.model_performance_tab.HeaderText = "Top Models"
        Me.model_operating_costs_tab.HeaderText = "Top Aircraft"
        Me.model_description_tab.HeaderText = "Nearby Airports"
        Me.model_flight_tab.HeaderText = "Aircraft Lookup"
        Me.model_reports_tab.HeaderText = "MyAirports"




        ' MSW - 11/15/18 - tabs that were previosly off, now left on 

        'Turning off unused tabs
        Me.model_fleet_tab.Visible = False
        Me.model_performance_tab.Visible = False
        Me.model_operating_costs_tab.Visible = False
        Me.model_description_tab.Visible = False
        Me.model_reports_tab.Visible = False
        Me.model_flight_tab.Visible = False
        Me.reg_search_panel.Visible = False
        Me.wanted_tab.Visible = False
        Me.documents_tab.Visible = False
        Me.operators_tab.Visible = False
        Me.charter_tab.Visible = False
        Me.lease_tab.Visible = False
        Me.spi_tab.Visible = False
        Me.location_tab.Visible = False
        Me.star_tab.Visible = False
        Me.range_tab.Visible = False


        'this is all for the graph section on the first tab 
        'Me.right_side_overview.Visible = True
        ' Me.overview_label.Visible = True

        Me.crm_view_view_all.Visible = False
        Me.months_choice.Visible = False
        Me.fractional_tab.Visible = False
        Me.update_sold_panel2.Visible = False
        Me.loaded_visibility.Visible = True
        Me.loaded_visibility1.Visible = False
        divLoading.Visible = False
        loaded_visibility.CssClass = "display_block"
        UpdateProgress1.Visible = True 'Enable the update progress tab loading screen

        Me.evo_view_help.Text = "<a class='underline' onclick='javascript:load(""/help/documents/599.pdf"","""",""scrollbars=yes,menubar=no,height=900,width=1150,resizable=yes,toolbar=no,location=no,status=no"");'>"
        Me.evo_view_help.Text &= "<img src='../images/info_white.png' class='float_left' border='0' alt='Show View Help'"
        Me.evo_view_help.Text &= "title='Show View Help' style='padding-bottom: 2px;' /></a>"


        Me.operator_list_label.Text = ""
        Me.view_market_status_label.Text = ""

        ' Me.airport_overview_type.Visible = True
        Me.my_airports_label.Visible = True
        Me.my_airports_label.Text = "FAA Flight Arrivals Based On "


        If Len(Trim(Me.view_reports_label.Text)) < 65 Then
            Me.view_reports_label.Text = "<tr><td>No Airports Selected</td></tr></table>"
            Me.my_airports_label.Visible = False
            Me.months_choice.Visible = False
            Me.view_reports_label.Text = "<div class=""clearfix margin-bottom padding""></div>" & Me.view_reports_label.Text & "<div class=""clearfix margin-bottom margin-top padding""></div>"
        End If


        ' add the header on it either way 
        If InStr(Me.view_reports_label.Text, "fractionsExpiringOuterTable") = 0 Then
            Me.view_reports_label.Text = "<table id=""fractionsExpiringOuterTable"" width=""100%"" cellpadding=""0"" cellspacing=""0"" class=""module""><tr><td valign=""top"" align=""center"" class=""header"">To modify your airport list below click <A href='Preferences.aspx' target='_blank'>Here</a> and use the 'MyAirports' tab.</td></tr>" & Me.view_reports_label.Text
        End If

    End Sub

    Sub BuildUtilizationJS(ByVal airport_list As String, ByVal aport_id As Long, ByVal orig_lat As Double, ByVal orig_long As Double, ByRef searchCriteria As viewSelectionCriteriaClass, ByRef rollUpCompanies As Boolean, ByRef this_section_string As String, ByRef charting_string As String, ByVal displayFlight As Boolean, ByVal show_report_link As Boolean, Optional ByVal drop_selected As String = "", Optional ByVal afolder_id As Long = 0)
        Dim str As String = ""
        Dim jsStr As String = ""

        clearAirportCriteria.OnClientClick = "createCookie('flightsum', 'true', 365);SetWaitCursor();$(""#divTabLoading2"").css(""display"", ""block"");"

        'Adding jquery 10/26/15.
        'Here is where we actually tell aspx to use the function we're creating.
        tabs_container.OnClientActiveTabChanged = "RunTopTabJqueryFBO"


        System.Web.UI.ScriptManager.RegisterStartupScript(Me.airportsSearchUpdate, Me.GetType, "clientToggleON", "document.getElementById(""" & resizeTopLeftTab.ClientID & """).style.visibility = """";" + vbCrLf, True)

        'Build some javascript
        If Not Page.ClientScript.IsClientScriptBlockRegistered("swapBottomOpDropDowns") Then
            Dim dropDownScr As New StringBuilder
            dropDownScr.Append("function swapTabOperator(id){")
            dropDownScr.Append("var compareItem = $('#' + id).val();")
            dropDownScr.Append("if (compareItem == 'U' || compareItem == 'B')  {")
            dropDownScr.Append("$('#" & airportOperatorType.ClientID & "').val('1');")
            dropDownScr.Append("$('#" & airportOperatorFolderToggleOnOff.ClientID & "').addClass(""display_none"");")
            dropDownScr.Append("$('#" & operator_drop2.ClientID & "').val('' + compareItem + '');")  ' added in msw - so that the util view will also set the operator drop
            dropDownScr.Append("} else {")
            dropDownScr.Append("$('#" & airportOperatorFolderToggleOnOff.ClientID & "').removeClass();")
            dropDownScr.Append("$('#" & airportOperatorType.ClientID & "').val('4');")
            dropDownScr.Append("$('#" & airportOperatorFolder.ClientID & "').val('' + compareItem + '');")
            dropDownScr.Append("$('#" & operator_drop2.ClientID & "').val('' + compareItem + '');")
            dropDownScr.Append("$('#" & utilizationViewDropDown.ClientID & "').val('' + compareItem + '');")
            dropDownScr.Append("}")
            dropDownScr.Append("}")

            utilizationViewDropDown.Attributes.Add("onchange", "swapTabOperator(this.id);")
            operator_drop2.Attributes.Add("onchange", "swapTabOperator(this.id);")
            System.Web.UI.ScriptManager.RegisterClientScriptBlock(Me, Me.GetType(), "swapBottomOpDropDowns", dropDownScr.ToString, True)
        End If

        'This basically runs on the clientActiveTabChanged of the top tab container.
        'It gets sent the sender, which is the tabcontainer. It checks the active tab index, which is 6 for the myAirportsTab
        'If it's six, it triggers a button inside of the tabcontainer's update panel to click, causing a postback for that update panel.
        'All of the code to run the myaiports tab should be located in the aspx event for the button click.
        If Not Page.ClientScript.IsClientScriptBlockRegistered("RunTopTabJqueryFBO") Then
            Dim TopTabJquery As New StringBuilder
            TopTabJquery.Append("function RunTopTabJqueryFBO(sender, args) { ")
            TopTabJquery.Append("if (sender.get_activeTabIndex() == 6) {")

            TopTabJquery.Append(" if ($(""#" & myairportsLabelRan.ClientID & """).text() == '') {") 'If this is filled up, it doesn't get ran. Only running on initial click.
            TopTabJquery.Append("document.body.style.cursor='wait';")
            TopTabJquery.Append(" $(""#" & invisibleAirportFBOButtonToCausePostback.ClientID & """).click();")
            TopTabJquery.Append("}") ' end value of myairportslabran is empty.

            TopTabJquery.Append("}") ' end sender get active tab
            TopTabJquery.Append("}") 'end function
            System.Web.UI.ScriptManager.RegisterStartupScript(Me, Me.GetType(), "RunTopTabJqueryFBO", TopTabJquery.ToString, True)
        End If

        utilizationViewAirportLabel.Visible = False
        utilizationAirportMap.Visible = False
        If airport_list <> "" Then
            System.Web.UI.ScriptManager.RegisterStartupScript(Me.airportsSearchUpdate, Me.GetType, "swapButtonOff", "$(""#" & buttons.ClientID & " .pdf_button"").addClass(""display_none"");" + vbCrLf, True)
        Else
            System.Web.UI.ScriptManager.RegisterStartupScript(Me.airportsSearchUpdate, Me.GetType, "swapButtonOn", "$(""#" & buttons.ClientID & " .pdf_button"").removeClass(""display_none"");" + vbCrLf, True)
            'If aport_id > 1 Then   ' And searchCriteria.ViewCriteriaCompanyID = 0 commented this out - MSW 
            ' utilizationViewAirportLabel.Visible = False
            ' utilizationAirportMap.Visible = False
            ' System.Web.UI.ScriptManager.RegisterStartupScript(Me.airportsSearchUpdate, Me.GetType, "fbo_view_map_script", "initialize_view_mapWithCenter(" + orig_lat.ToString + ", " + orig_long.ToString + ",'" & utilizationAirportMap.ClientID & "');add_location_view_marker('" + Replace(localCriteria.ViewCriteriaAirportName.Trim, "'", "") + "'," + orig_lat.ToString + ", " + orig_long.ToString + ", -1, '', viewMapFBO);" + vbCrLf, True)
            'End If
        End If



        If Page.IsPostBack Then
            If aport_id > 1 Or (searchCriteria.ViewCriteriaCompanyID > 0) Then
                If Me.airport_overview_type.SelectedValue = "Hours" Or Trim(drop_selected) = "Hours" Then
                    DisplayFunctions.load_google_chart(model_market_status_tab, this_section_string, "", "Hours by Month", "utilizationViewGraphall", 470, 255, "POINTS", 1, charting_string, Me.Page, Me.top_tab_update_panel, False, False, True, False, True, True, False, True, False, False, 0, "")
                ElseIf Me.airport_overview_type.SelectedValue = "Month" Then
                    DisplayFunctions.load_google_chart(model_market_status_tab, this_section_string, "", "Flights Per Month", "utilizationViewGraphall", 470, 255, "POINTS", 1, charting_string, Me.Page, Me.top_tab_update_panel, False, False, True, False, True, True, False, True, False, False, 0, "")
                ElseIf Me.airport_overview_type.SelectedValue = "BWeight" Or Me.airport_overview_type.SelectedValue = "TWeight" Or Me.airport_overview_type.SelectedValue = "HWeight" Then
                    DisplayFunctions.load_google_chart(model_market_status_tab, this_section_string, "", "Flights Per Month", "utilizationViewGraphall", 470, 255, "POINTS", 1, charting_string, Me.Page, Me.top_tab_update_panel, False, False, True, False, True, True, False, True, False, False, 0, "")
                ElseIf Me.airport_overview_type.SelectedValue = "Type" Then
                    DisplayFunctions.load_google_chart(model_market_status_tab, this_section_string, "", "Flights Per Month", "utilizationViewGraphall", 470, 255, "POINTS", 1, charting_string, Me.Page, Me.top_tab_update_panel, False, False, True, False, True, True, False, True, False, False, 0, "")
                End If
                System.Web.UI.ScriptManager.RegisterStartupScript(Me.top_tab_update_panel, Me.GetType, "chartString", charting_string + vbCrLf, True)
            Else
                If Me.airport_overview_type.SelectedValue = "Hours" Or Trim(drop_selected) = "Hours" Then
                    DisplayFunctions.load_google_chart(model_market_status_tab, this_section_string, "", "Hours by Month", "utilizationViewGraphall", 470, 255, "POINTS", 1, charting_string, Me.Page, Me.top_tab_update_panel, False, False, True, False, True, True, False, True, False, False, 0, "")
                ElseIf Me.airport_overview_type.SelectedValue = "Month" Then
                    DisplayFunctions.load_google_chart(model_market_status_tab, this_section_string, "", "Flights Per Month", "utilizationViewGraphall", 650, 255, "POINTS", 1, charting_string, Me.Page, Me.top_tab_update_panel, False, False, True, False, True, True, False, True, False, False, 0, "")
                ElseIf Me.airport_overview_type.SelectedValue = "BWeight" Or Me.airport_overview_type.SelectedValue = "TWeight" Or Me.airport_overview_type.SelectedValue = "HWeight" Then
                    DisplayFunctions.load_google_chart(model_market_status_tab, this_section_string, "", "Flights Per Month", "utilizationViewGraphall", 650, 255, "POINTS", 1, charting_string, Me.Page, Me.top_tab_update_panel, False, False, True, False, True, True, False, True, False, False, 0, "")
                ElseIf Me.airport_overview_type.SelectedValue = "Type" Then
                    DisplayFunctions.load_google_chart(model_market_status_tab, this_section_string, "", "Flights Per Month", "utilizationViewGraphall", 650, 255, "POINTS", 1, charting_string, Me.Page, Me.top_tab_update_panel, False, False, True, False, True, True, False, True, False, False, 0, "")
                End If
                System.Web.UI.ScriptManager.RegisterStartupScript(Me.top_tab_update_panel, Me.GetType, "chartString", charting_string + vbCrLf, True)
            End If

            top_tab_update_panel.Update()
        End If

        If Not Page.IsPostBack Then
            Dim jsString As String = " $(function() {"
            jsString += "$(""#" & airportViewStartDate.ClientID & """).datepicker({"
            jsString += " showOn: ""button"", "
            jsString += " buttonImage: ""/images/final.jpg"","
            jsString += " buttonImageOnly: true,"
            jsString += " buttonText: ""Select date"""
            jsString += " });"
            jsString += "$(""#" & airportViewEndDate.ClientID & """).datepicker({"
            jsString += " showOn: ""button"", "
            jsString += " buttonImage: ""/images/final.jpg"","
            jsString += " buttonImageOnly: true,"
            jsString += " buttonText: ""Select date"""
            jsString += " });"
            jsString += " } );"
            System.Web.UI.ScriptManager.RegisterStartupScript(Me, Me.GetType, "dateString", jsString, True)
        End If



        str = "$('#" & toggleFlightSummary.ClientID & "').click(function() {"
        str += " if (this.checked == false) {"
        str += "$('.viewBoxes .Box').hide();"
        str += "createCookie('flightsum', 'false', 365);"
        str += " } else { "
        str += "$('.viewBoxes .Box').show();"
        str += "createCookie('flightsum', 'true', 365);"
        str += "};"
        str += "google.maps.event.trigger(viewMapFBO, 'resize');"
        str += "});"
        System.Web.UI.ScriptManager.RegisterStartupScript(Me, Me.GetType, "toggleAirportSum", str + vbCrLf, True)


        Dim ToggleCookie As HttpCookie = Request.Cookies("flightsum")

        If Not IsNothing(ToggleCookie) Then
            If ToggleCookie.Value = "false" Then
                If displayFlight = False Then
                    str += "$('.viewBoxes .Box').hide();"
                    str += " $('#" & toggleFlightSummary.ClientID & "').prop('checked', false);"
                Else
                    str += " $('#" & toggleFlightSummary.ClientID & "').prop('checked', true);"
                End If
            Else
                str += " $('#" & toggleFlightSummary.ClientID & "').prop('checked', true);"
            End If
        Else
            str += " $('#" & toggleFlightSummary.ClientID & "').prop('checked', true);"
        End If
        System.Web.UI.ScriptManager.RegisterStartupScript(Me.top_tab_update_panel, Me.GetType, "toggleAirportSumA", "setTimeout(function(){ " & str & vbCrLf & "; }, 1000);", True)



        goSearchAirports.Focus()

        ''Okay, we need to deal with the buttons text since we've got update panels. Let's use javascript
        'If aport_id > 1 Then
        '  jsStr = "$('#" & buttons.ClientID & "').html('<a href=""javascript:void(0);"" onclick=""$(&quot;#" & exportUtilization.ClientID.ToString & "&quot;).prop(&quot;checked&quot;, true);$(&quot;.searchResultsLoadingText&quot;).text(&quot;Exporting all flights to Excel. This may take a few minutes. Please wait...&quot;);searchThisForm();"" class=""open_button underline cursor"">Export Flights</a><a target=""_new"" href=""viewtopdf.aspx?amod_id=0&aport_id=" & aport_id.ToString & "&viewID=" + localCriteria.ViewID.ToString + "&sub_id=" + Session.Item("localUser").crmSubSubID.ToString.Trim + "&pc=" + sSelectedProductCode_to_Pass + "&months=12&start_date=" & Me.airportViewStartDate.Text & "&end_date=" & Me.airportViewEndDate.Text & "&percent_flight=" & Me.percentage_drop.Text & "&ground_time=" & Me.minutes_drop.Text & "&origin_or_dest=" & Me.searchBasedOnDropdown.SelectedValue & "&ViewCompany=" & Session.Item("searchCriteria").SearchViewCriteriaOperatorSelected & """ class=""pdf_button underline cursor"">Flight Activity Report</a>"  ' was months = localCriteria.ViewCriteriaTimeSpan.ToString
        'Else
        '  jsStr = "$('#" & buttons.ClientID & "').html('<a href=""javascript:void(0);"" onclick=""$(&quot;#" & exportUtilization.ClientID.ToString & "&quot;).prop(&quot;checked&quot;, true);$(&quot;.searchResultsLoadingText&quot;).text(&quot;Exporting all flights to Excel. This may take a few minutes. Please wait...&quot;);searchThisForm();"" class=""open_button underline cursor"">Export Flights</a>"
        'End If
        'replaced with below - MSW - 5/7/19


        'Okay, we need to deal with the buttons text since we've got update panels. Let's use javascript
        If show_report_link = True Then
            Dim amod_id_string As String = ""
            Dim type_string As String = ""
            Dim make_string As String = ""

            If Not IsNothing(searchCriteria.ViewCriteriaAmodIDArray) Then
                If searchCriteria.ViewCriteriaAmodIDArray.Length > 0 Then
                    For i = 0 To searchCriteria.ViewCriteriaAmodIDArray.Length - 1
                        If Trim(amod_id_string) <> "" Then
                            amod_id_string &= ","
                        End If
                        amod_id_string &= searchCriteria.ViewCriteriaAmodIDArray(i)
                    Next
                End If
            End If

            type_string = ""
            make_string = ""
            If IsNothing(searchCriteria.ViewCriteriaAmodIDArray) And searchCriteria.ViewCriteriaAmodID <= 0 Then ' if we dont have a model then we need the make and type strings
                If Not IsNothing(searchCriteria.ViewCriteriaTypeIDArray) Then
                    If searchCriteria.ViewCriteriaTypeIDArray.Length > 0 Then
                        For i = 0 To searchCriteria.ViewCriteriaTypeIDArray.Length - 1
                            If Trim(type_string) <> "" Then
                                type_string &= ","
                            End If
                            type_string &= searchCriteria.ViewCriteriaTypeIDArray(i)
                        Next
                    End If
                End If


                If Trim(searchCriteria.ViewCriteriaAircraftMake) <> "" Then
                    make_string = Trim(searchCriteria.ViewCriteriaAircraftMake)
                End If

            End If

            If Session.Item("localUser").crmDemoUserFlag = True Then   ' ADDED IN MSW - 3/26/20
                ' DONT ALLOW DEMO TO EXPORT FLIGHTS ONLY ALLOW FLIGHT SUMMARY - NOT EXPORT FLIGHTS OR FLIGHT ACTIVITY EXPORTS
                If Trim(airport_list) <> "" Or afolder_id > 0 Then
                    If amod_id_string <> "" Then
                        jsStr = "$('#" & buttons.ClientID & "').html('<a target=""_new"" href=""viewtopdf.aspx?amod_id=" & amod_id_string & "&aport_id=" & aport_id.ToString & "&viewID=928&sub_id=" + Session.Item("localUser").crmSubSubID.ToString.Trim + "&pc=" + sSelectedProductCode_to_Pass + "&months=12&start_date=" & Me.airportViewStartDate.Text & "&end_date=" & Me.airportViewEndDate.Text & "&percent_flight=" & Me.percentage_drop.Text & "&ground_time=" & Me.minutes_drop.Text & "&origin_or_dest=" & Me.searchBasedOnDropdown.SelectedValue & "&type_string=" & type_string & "&make_string=" & make_string & "&ViewCompany=" & Session.Item("searchCriteria").SearchViewCriteriaOperatorSelected & "&Folder_ID=" & afolder_id & """ class=""pdf_button underline cursor"">Flight Summary Report</a>"  ' was months = localCriteria.ViewCriteriaTimeSpan.ToString
                    ElseIf searchCriteria.ViewCriteriaAmodID > 0 Then
                        jsStr = "$('#" & buttons.ClientID & "').html('<a target=""_new"" href=""viewtopdf.aspx?amod_id=" & searchCriteria.ViewCriteriaAmodID & "&aport_id=" & aport_id.ToString & "&viewID=928&sub_id=" + Session.Item("localUser").crmSubSubID.ToString.Trim + "&pc=" + sSelectedProductCode_to_Pass + "&months=12&start_date=" & Me.airportViewStartDate.Text & "&end_date=" & Me.airportViewEndDate.Text & "&percent_flight=" & Me.percentage_drop.Text & "&ground_time=" & Me.minutes_drop.Text & "&origin_or_dest=" & Me.searchBasedOnDropdown.SelectedValue & "&type_string=" & type_string & "&make_string=" & make_string & "&ViewCompany=" & Session.Item("searchCriteria").SearchViewCriteriaOperatorSelected & "&Folder_ID=" & afolder_id & """ class=""pdf_button underline cursor"">Flight Summary Report</a>"  ' was months = localCriteria.ViewCriteriaTimeSpan.ToString
                    Else
                        jsStr = "$('#" & buttons.ClientID & "').html('<a target=""_new"" href=""viewtopdf.aspx?amod_id=0&aport_id=" & aport_id.ToString & "&viewID=928&sub_id=" + Session.Item("localUser").crmSubSubID.ToString.Trim + "&pc=" + sSelectedProductCode_to_Pass + "&months=12&start_date=" & Me.airportViewStartDate.Text & "&end_date=" & Me.airportViewEndDate.Text & "&percent_flight=" & Me.percentage_drop.Text & "&ground_time=" & Me.minutes_drop.Text & "&origin_or_dest=" & Me.searchBasedOnDropdown.SelectedValue & "&type_string=" & type_string & "&make_string=" & make_string & "&ViewCompany=" & Session.Item("searchCriteria").SearchViewCriteriaOperatorSelected & "&Folder_ID=" & afolder_id & """ class=""pdf_button underline cursor"">Flight Summary Report</a>"  ' was months = localCriteria.ViewCriteriaTimeSpan.ToString
                    End If
                Else
                    jsStr = "$('#" & buttons.ClientID & "').html('"
                End If
            Else
                If Trim(airport_list) <> "" Or afolder_id > 0 Then
                    If amod_id_string <> "" Then
                        jsStr = "$('#" & buttons.ClientID & "').html('<a href=""javascript:void(0);"" onclick=""$(&quot;#" & exportUtilization.ClientID.ToString & "&quot;).prop(&quot;checked&quot;, true);$(&quot;.searchResultsLoadingText&quot;).text(&quot;Exporting all flights to Excel. This may take a few minutes. Please wait...&quot;);searchThisForm();"" class=""open_button underline cursor"">Export Flights</a><a target=""_new"" href=""viewtopdf.aspx?amod_id=" & amod_id_string & "&aport_id=" & aport_id.ToString & "&viewID=928&sub_id=" + Session.Item("localUser").crmSubSubID.ToString.Trim + "&pc=" + sSelectedProductCode_to_Pass + "&months=12&start_date=" & Me.airportViewStartDate.Text & "&end_date=" & Me.airportViewEndDate.Text & "&percent_flight=" & Me.percentage_drop.Text & "&ground_time=" & Me.minutes_drop.Text & "&origin_or_dest=" & Me.searchBasedOnDropdown.SelectedValue & "&type_string=" & type_string & "&make_string=" & make_string & "&ViewCompany=" & Session.Item("searchCriteria").SearchViewCriteriaOperatorSelected & "&Folder_ID=" & afolder_id & """ class=""pdf_button underline cursor"">Flight Summary Report</a>"  ' was months = localCriteria.ViewCriteriaTimeSpan.ToString
                    ElseIf searchCriteria.ViewCriteriaAmodID > 0 Then
                        jsStr = "$('#" & buttons.ClientID & "').html('<a href=""javascript:void(0);"" onclick=""$(&quot;#" & exportUtilization.ClientID.ToString & "&quot;).prop(&quot;checked&quot;, true);$(&quot;.searchResultsLoadingText&quot;).text(&quot;Exporting all flights to Excel. This may take a few minutes. Please wait...&quot;);searchThisForm();"" class=""open_button underline cursor"">Export Flights</a><a target=""_new"" href=""viewtopdf.aspx?amod_id=" & searchCriteria.ViewCriteriaAmodID & "&aport_id=" & aport_id.ToString & "&viewID=928&sub_id=" + Session.Item("localUser").crmSubSubID.ToString.Trim + "&pc=" + sSelectedProductCode_to_Pass + "&months=12&start_date=" & Me.airportViewStartDate.Text & "&end_date=" & Me.airportViewEndDate.Text & "&percent_flight=" & Me.percentage_drop.Text & "&ground_time=" & Me.minutes_drop.Text & "&origin_or_dest=" & Me.searchBasedOnDropdown.SelectedValue & "&type_string=" & type_string & "&make_string=" & make_string & "&ViewCompany=" & Session.Item("searchCriteria").SearchViewCriteriaOperatorSelected & "&Folder_ID=" & afolder_id & """ class=""pdf_button underline cursor"">Flight Summary Report</a>"  ' was months = localCriteria.ViewCriteriaTimeSpan.ToString
                    Else
                        jsStr = "$('#" & buttons.ClientID & "').html('<a href=""javascript:void(0);"" onclick=""$(&quot;#" & exportUtilization.ClientID.ToString & "&quot;).prop(&quot;checked&quot;, true);$(&quot;.searchResultsLoadingText&quot;).text(&quot;Exporting all flights to Excel. This may take a few minutes. Please wait...&quot;);searchThisForm();"" class=""open_button underline cursor"">Export Flights</a><a target=""_new"" href=""viewtopdf.aspx?amod_id=0&aport_id=" & aport_id.ToString & "&viewID=928&sub_id=" + Session.Item("localUser").crmSubSubID.ToString.Trim + "&pc=" + sSelectedProductCode_to_Pass + "&months=12&start_date=" & Me.airportViewStartDate.Text & "&end_date=" & Me.airportViewEndDate.Text & "&percent_flight=" & Me.percentage_drop.Text & "&ground_time=" & Me.minutes_drop.Text & "&origin_or_dest=" & Me.searchBasedOnDropdown.SelectedValue & "&type_string=" & type_string & "&make_string=" & make_string & "&ViewCompany=" & Session.Item("searchCriteria").SearchViewCriteriaOperatorSelected & "&Folder_ID=" & afolder_id & """ class=""pdf_button underline cursor"">Flight Summary Report</a>"  ' was months = localCriteria.ViewCriteriaTimeSpan.ToString
                    End If
                Else
                    If amod_id_string <> "" Then
                        jsStr = "$('#" & buttons.ClientID & "').html('<a href=""javascript:void(0);"" onclick=""$(&quot;#" & exportUtilization.ClientID.ToString & "&quot;).prop(&quot;checked&quot;, true);$(&quot;.searchResultsLoadingText&quot;).text(&quot;Exporting all flights to Excel. This may take a few minutes. Please wait...&quot;);searchThisForm();"" class=""open_button underline cursor"">Export Flights</a><a target=""_new"" href=""viewtopdf.aspx?amod_id=" & amod_id_string & "&aport_id=" & aport_id.ToString & "&viewID=" + localCriteria.ViewID.ToString + "&sub_id=" + Session.Item("localUser").crmSubSubID.ToString.Trim + "&pc=" + sSelectedProductCode_to_Pass + "&months=12&start_date=" & Me.airportViewStartDate.Text & "&end_date=" & Me.airportViewEndDate.Text & "&percent_flight=" & Me.percentage_drop.Text & "&ground_time=" & Me.minutes_drop.Text & "&origin_or_dest=" & Me.searchBasedOnDropdown.SelectedValue & "&type_string=" & type_string & "&make_string=" & make_string & "&ViewCompany=" & Session.Item("searchCriteria").SearchViewCriteriaOperatorSelected & """ class=""pdf_button underline cursor"">Flight Activity Report</a>"  ' was months = localCriteria.ViewCriteriaTimeSpan.ToString
                    ElseIf searchCriteria.ViewCriteriaAmodID > 0 Then
                        jsStr = "$('#" & buttons.ClientID & "').html('<a href=""javascript:void(0);"" onclick=""$(&quot;#" & exportUtilization.ClientID.ToString & "&quot;).prop(&quot;checked&quot;, true);$(&quot;.searchResultsLoadingText&quot;).text(&quot;Exporting all flights to Excel. This may take a few minutes. Please wait...&quot;);searchThisForm();"" class=""open_button underline cursor"">Export Flights</a><a target=""_new"" href=""viewtopdf.aspx?amod_id=" & searchCriteria.ViewCriteriaAmodID & "&aport_id=" & aport_id.ToString & "&viewID=" + localCriteria.ViewID.ToString + "&sub_id=" + Session.Item("localUser").crmSubSubID.ToString.Trim + "&pc=" + sSelectedProductCode_to_Pass + "&months=12&start_date=" & Me.airportViewStartDate.Text & "&end_date=" & Me.airportViewEndDate.Text & "&percent_flight=" & Me.percentage_drop.Text & "&ground_time=" & Me.minutes_drop.Text & "&origin_or_dest=" & Me.searchBasedOnDropdown.SelectedValue & "&type_string=" & type_string & "&make_string=" & make_string & "&ViewCompany=" & Session.Item("searchCriteria").SearchViewCriteriaOperatorSelected & """ class=""pdf_button underline cursor"">Flight Activity Report</a>"  ' was months = localCriteria.ViewCriteriaTimeSpan.ToString
                    Else
                        jsStr = "$('#" & buttons.ClientID & "').html('<a href=""javascript:void(0);"" onclick=""$(&quot;#" & exportUtilization.ClientID.ToString & "&quot;).prop(&quot;checked&quot;, true);$(&quot;.searchResultsLoadingText&quot;).text(&quot;Exporting all flights to Excel. This may take a few minutes. Please wait...&quot;);searchThisForm();"" class=""open_button underline cursor"">Export Flights</a><a target=""_new"" href=""viewtopdf.aspx?amod_id=0&aport_id=" & aport_id.ToString & "&viewID=" + localCriteria.ViewID.ToString + "&sub_id=" + Session.Item("localUser").crmSubSubID.ToString.Trim + "&pc=" + sSelectedProductCode_to_Pass + "&months=12&start_date=" & Me.airportViewStartDate.Text & "&end_date=" & Me.airportViewEndDate.Text & "&percent_flight=" & Me.percentage_drop.Text & "&ground_time=" & Me.minutes_drop.Text & "&origin_or_dest=" & Me.searchBasedOnDropdown.SelectedValue & "&type_string=" & type_string & "&make_string=" & make_string & "&ViewCompany=" & Session.Item("searchCriteria").SearchViewCriteriaOperatorSelected & """ class=""pdf_button underline cursor"">Flight Activity Report</a>"  ' was months = localCriteria.ViewCriteriaTimeSpan.ToString
                    End If
                End If
            End If


        Else
            If Session.Item("localUser").crmDemoUserFlag = True Then
                jsStr = "$('#" & buttons.ClientID & "').html('"
            Else
                jsStr = "$('#" & buttons.ClientID & "').html('<a href=""javascript:void(0);"" onclick=""$(&quot;#" & exportUtilization.ClientID.ToString & "&quot;).prop(&quot;checked&quot;, true);$(&quot;.searchResultsLoadingText&quot;).text(&quot;Exporting all flights to Excel. This may take a few minutes. Please wait...&quot;);searchThisForm();"" class=""open_button underline cursor"">Export Flights</a>"
            End If
        End If




        'If bHasMaster = True Then
        '    jsStr += "<a class=""open_button underline cursor"" onclick=""javascript:load(\'view_template.aspx?noMaster=false&ViewID=" + localCriteria.ViewID.ToString + "&ViewName=" + localCriteria.ViewName + sStandalonePageLink.Trim + "\',\'\',\'scrollbars=yes,menubar=no,height=900,width=1150,resizable=yes,toolbar=no,location=no,status=no\');"">New Window</a>');"
        'Else
        '    jsStr += "<a class=""open_button underline cursor"" onclick=""javascript:window.close();"">Close</a>');"
        'End If
        jsStr += "');"
        If Page.IsPostBack Then
            System.Web.UI.ScriptManager.RegisterStartupScript(Me.top_tab_update_panel, Me.GetType, "buttonText", jsStr + vbCrLf, True)
        Else
            System.Web.UI.ScriptManager.RegisterStartupScript(Me, Me.GetType, "buttonText", jsStr + vbCrLf, True)
        End If

        If TabPanel14.Visible = False And TabContainer2.Visible = False Then
            resizeTopLeftTab.Attributes.Add("style", "display:none;")
            System.Web.UI.ScriptManager.RegisterStartupScript(Me.airportsSearchUpdate, Me.GetType, "hideMargin", "document.getElementById(""" & resizeTopLeftTab.ClientID & """).style.display=""none"" ;" + vbCrLf, True)
        Else
            resizeTopLeftTab.Attributes.Add("style", "display:table-cell;")
            System.Web.UI.ScriptManager.RegisterStartupScript(Me.airportsSearchUpdate, Me.GetType, "bringMargin", "document.getElementById(""" & resizeTopLeftTab.ClientID & """).style.display=""table-cell"" ;" + vbCrLf, True)

        End If

    End Sub

    Private Sub BuildUtilizationLocalCriteria()
        localCriteria.ViewCriteriaTimeSpan = 6


        If Not Page.IsPostBack Then


            airportViewStartDate.Text = FormatDateTime(DateAdd(DateInterval.Month, -3, Now()), DateFormat.ShortDate) 'DateAdd(DateInterval.Month, -3, Now()).ToString("MM/dd/yyyy")

            If Trim(airportViewStartDate.Text) <> "" And IsDate(Trim(airportViewStartDate.Text)) = True Then
                airportViewStartDate.Text = Month(CDate(airportViewStartDate.Text)) & "/1/" & Year(CDate(airportViewStartDate.Text))
            End If

            airportViewEndDate.Text = FormatDateTime(Now(), DateFormat.ShortDate) 'Now().ToString("MM/dd/yyyy")
            localCriteria.ViewCriteriaDocumentsStartDate = FormatDateTime(DateAdd(DateInterval.Month, -3, Now()), DateFormat.ShortDate)
            localCriteria.ViewCriteriaDocumentsEndDate = FormatDateTime(Now(), DateFormat.ShortDate)
            localCriteria.ViewCriteriaHasCommercialFlag = HttpContext.Current.Session.Item("localSubscription").crmHelicopter_Flag
            localCriteria.ViewCriteriaHasBusinessFlag = HttpContext.Current.Session.Item("localSubscription").crmBusiness_Flag
            localCriteria.ViewCriteriaHasHelicopterFlag = HttpContext.Current.Session.Item("localSubscription").crmHelicopter_Flag 'Session.Item("localSubscription").crmHelicopter_Flag

            If HttpContext.Current.Session.Item("chkCommercialFilter") Or HttpContext.Current.Session.Item("chkBusinessFilter") Or HttpContext.Current.Session.Item("chkBusinessFilter") Then
                localCriteria.ViewCriteriaHasCommercialFlag = HttpContext.Current.Session.Item("chkCommercialFilter")
                localCriteria.ViewCriteriaHasBusinessFlag = HttpContext.Current.Session.Item("chkBusinessFilter")
                localCriteria.ViewCriteriaHasHelicopterFlag = HttpContext.Current.Session.Item("chkHelicopterFilter")
            End If
        End If

        If Not IsNothing(localCriteria.ViewCriteriaAmodIDArray) Then
            localCriteria.ViewCriteriaAmodID = -1
        End If

        If Trim(airportViewStartDate.Text) <> "" And Trim(airportViewStartDate.Text) <> "" Then
            localCriteria.ViewCriteriaDocumentsStartDate = airportViewStartDate.Text
            localCriteria.ViewCriteriaDocumentsEndDate = airportViewEndDate.Text
        End If
    End Sub

    Private Sub BuildUtilizationSearchVariables(ByRef temp_distance_company As Integer, ByRef Business_type As String, ByRef BasedAtAirport As Boolean, ByRef rollUpCompanies As Boolean, ByRef operator_list As String, ByVal clearCompany As Boolean, ByVal clearAirport As Boolean, ByRef product_code_selection As String, ByRef product_link As String, ByRef cfolder_id As Integer, ByRef is_located_here As Boolean, ByRef AircraftFolder As Long, ByRef afolder_id As Long, ByRef isAircraftSearch As Boolean, ByRef aport_id As Long, ByRef ranThroughAirport As Boolean, ByRef AircraftFolderActive As Boolean, ByRef Aircraft_List As String, ByRef aclsData_Temp As clsData_Manager_SQL, ByRef util_functions As utilization_functions, ByRef airport_list As String, ByRef IsSearchRan As Boolean, ByRef comp_id As Long)
        Dim Airport_table As New DataTable

        If owner_drop.SelectedValue = "F" Then
            BasedAtAirport = True
        End If
        Business_type = ac_projects_ddl2_19.SelectedValue

        If IsNumeric(company_range_19.SelectedValue) Then
            temp_distance_company = company_range_19.SelectedValue
        End If

        airport_direction = searchBasedOnDropdown.SelectedValue
        sSelectedProductCode_to_Pass = ""
        If localCriteria.ViewCriteriaHasCommercialFlag And localCriteria.ViewCriteriaHasBusinessFlag And localCriteria.ViewCriteriaHasHelicopterFlag Then
            sSelectedProductCode_to_Pass = ""
        Else
            If localCriteria.ViewCriteriaHasBusinessFlag And localCriteria.ViewCriteriaHasCommercialFlag Then
                sSelectedProductCode_to_Pass = "B,C"
            ElseIf localCriteria.ViewCriteriaHasBusinessFlag And localCriteria.ViewCriteriaHasHelicopterFlag Then
                sSelectedProductCode_to_Pass = "B,H"
            ElseIf localCriteria.ViewCriteriaHasHelicopterFlag And localCriteria.ViewCriteriaHasCommercialFlag Then
                sSelectedProductCode_to_Pass = "C,H"
            ElseIf localCriteria.ViewCriteriaHasBusinessFlag Then
                sSelectedProductCode_to_Pass = "B"
            ElseIf localCriteria.ViewCriteriaHasCommercialFlag Then
                sSelectedProductCode_to_Pass = "C"
            ElseIf localCriteria.ViewCriteriaHasHelicopterFlag Then
                sSelectedProductCode_to_Pass = "H"
            End If
        End If



        If localCriteria.ViewCriteriaHasCommercialFlag Then
            Me.check_comm.Checked = True
        Else
            Me.check_comm.Checked = False
        End If
        If localCriteria.ViewCriteriaHasBusinessFlag Then
            Me.check_busj.Checked = True
            Me.check_bust.Checked = True
        Else
            Me.check_busj.Checked = False
            Me.check_bust.Checked = False
        End If
        If localCriteria.ViewCriteriaHasHelicopterFlag Then
            Me.check_heli.Checked = True
        Else
            Me.check_heli.Checked = False
        End If

        Call create_product_checks(product_code_selection, product_link)

        If Me.ac_based.Checked Then
            is_located_here = True
        Else
            is_located_here = False
        End If

        'Operator FOLDER
        If String.IsNullOrEmpty(airportOperatorFolder.SelectedValue) Then
            If (Not Page.IsPostBack) Then ' And String.IsNullOrEmpty(Trim(Request("comp_id")))) Then
                cfolder_id = Session.Item("searchCriteria").SearchViewCriteriaOperatorDropdown2
            ElseIf Page.IsPostBack Then
                If IsNumeric(Trim(Request("comp_id"))) Then
                    If Trim(Request("comp_id")) = 0 Then
                        cfolder_id = Session.Item("searchCriteria").SearchViewCriteriaOperatorDropdown2
                    End If
                End If
            End If
        Else
            cfolder_id = airportOperatorFolder.SelectedValue
        End If

        'Aircraft FOLDER
        If String.IsNullOrEmpty(airportAircraftFolder.SelectedValue) Then
            If (Not Page.IsPostBack) Then
                AircraftFolder = Session.Item("searchCriteria").SearchViewCriteriaAircraftDropdown2
                If AircraftFolder > 0 Then
                    Try
                        airportAircraftFolder.SelectedValue = AircraftFolder
                    Catch ex As Exception
                    End Try
                End If
            End If
        Else
            AircraftFolder = airportAircraftFolder.SelectedValue
        End If

        'Airport FOLDER
        If String.IsNullOrEmpty(searchAirportFolder.SelectedValue) Then
            If (Not Page.IsPostBack) Then 'And String.IsNullOrEmpty(Trim(Request("aport_id")))) Then
                afolder_id = Session.Item("searchCriteria").SearchViewCriteriaAirportDropdown2
                If afolder_id > 0 Then
                    Try
                        airportDrop.SelectedValue = afolder_id
                    Catch ex As Exception
                    End Try
                End If
            ElseIf Page.IsPostBack Then
                'If IsNumeric(Trim(Request("aport_id"))) Then
                '  If Trim(Request("aport_id")) = 0 Or (isAircraftSearch = True And Session.Item("searchCriteria").SearchViewCriteriaAirportDropdown2 > 0) Then
                '    afolder_id = Session.Item("searchCriteria").SearchViewCriteriaAirportDropdown2
                '    If afolder_id > 0 Then
                '      Try
                '        airportDrop.SelectedValue = afolder_id
                '      Catch ex As Exception
                '      End Try
                '    End If
                '  End If
                'ElseIf isAircraftSearch = True Then
                afolder_id = Session.Item("searchCriteria").SearchViewCriteriaAirportDropdown2
                If afolder_id > 0 Then
                    Try
                        airportDrop.SelectedValue = afolder_id
                    Catch ex As Exception
                    End Try
                End If

            End If
            'End If
        Else
            afolder_id = searchAirportFolder.SelectedValue
            airportDrop.SelectedValue = searchAirportFolder.SelectedValue
        End If


        'Airport ID Search

        If IsNumeric(selectAirportID.Text) Then
            If selectAirportsType.SelectedValue <> "4" Then 'select new airport
                aport_id = selectAirportID.Text
                ranThroughAirport = True

                Session("Last_Aport_ID") = aport_id
                Session("Last_FBO_Bottom") = -1
                afolder_id = 0
                If aport_id = 0 Then
                    Session.Item("searchCriteria").SearchViewCriteriaClearAirport = True
                    clearAirport = True
                    Session("Last_Aport_ID") = 0
                    Session.Item("searchCriteria").SearchViewCriteriaAirportSelected = 0
                Else
                    Session.Item("searchCriteria").SearchViewCriteriaClearAirport = False
                    clearAirport = False
                End If
            End If
        End If



        If afolder_id > 0 Then
            Airport_table = util_functions.get_data_from_client_folder(afolder_id, "cfoldind_jetnet_aport_id")
            airport_list = ""
            If Not IsNothing(Airport_table) Then
                If Airport_table.Rows.Count > 0 Then
                    For Each r As DataRow In Airport_table.Rows

                        If Trim(airport_list) = "" Then
                            airport_list = r("cfoldind_jetnet_aport_id")
                        Else
                            airport_list = airport_list & ", " & r("cfoldind_jetnet_aport_id")
                        End If
                    Next
                    Session.Item("searchCriteria").SearchViewCriteriaAirportDropdown = 4
                    Session.Item("searchCriteria").SearchViewCriteriaAirportDropdown2 = afolder_id
                    Session.Item("searchCriteria").SearchViewCriteriaAirportFolderName = searchAirportFolder.Items.FindByValue(afolder_id).Text
                    Session.Item("Airport_Folder_List") = airport_list
                Else
                    System.Web.UI.ScriptManager.RegisterStartupScript(Me.top_tab_update_panel, Me.GetType, "EmptyAirAlert", "alert('Airport Folder is Empty. Default to all Airports.');" + vbCrLf, True)
                End If
            End If

        End If

        Dim InClause As String = ""
        If airportAircraftType.SelectedValue = "5" Then
            InClause = BuildInClause(aircraftRegNumberView.Text)
            If InClause <> "" Then
                Aircraft_List = " select distinct b.ac_id from Aircraft b with (NOLOCK) where b.ac_reg_no_search in (" & Replace(InClause, "-", "") & ") and b.ac_journ_id = 0 "
            End If
        End If
        If selectAirportsType.SelectedValue = "5" Then
            InClause = BuildInClause(UCase(airportIATABoxSearch.Text))
            airport_list = "select distinct b.aport_id from Airport b with (NOLOCK) where (b.aport_icao_code in (" & InClause & ") or b.aport_iata_code in (" & InClause & "))"

            ' ADDED IN SO IF YOU ONLY SO 1 APORT YOU GET THE SAME AS IF YOU PICKED THE AIRPORT
            If Len(Trim(InClause)) <= 6 Then
                Try

                    Dim temp_table As New DataTable
                    temp_table = localDatalayer.get_aport_id(airport_list)

                    If Not IsNothing(temp_table) Then
                        For Each r As DataRow In temp_table.Rows
                            aport_id = r("aport_id").ToString
                        Next
                    End If

                    If aport_id > 0 Then
                        airport_list = ""
                    End If

                Catch ex As Exception

                End Try
            Else

            End If

        End If


        ' ADDED IN MSW 3/10/20 
        If in_operation_drop.SelectedItem.Text = "All" Then
            localCriteria.viewCriteriaInOperation = ""
        ElseIf Trim(in_operation_drop.SelectedItem.Text) = "In-Operation" Then
            localCriteria.viewCriteriaInOperation = "Y"
        ElseIf Trim(in_operation_drop.SelectedItem.Text) = "Out of Operation" Then
            localCriteria.viewCriteriaInOperation = "N"
        Else
            localCriteria.viewCriteriaInOperation = ""
        End If





        If IsPostBack And IsSearchRan = True Then ' ADDED MSW -4/27/18
            If airportOperatorType.SelectedValue = 1 Then 'the person cleared the operator type.
                comp_id = 0
                Session.Item("searchCriteria").SearchViewCriteriaClearCompany = True
            Else 'If airportOperatorType.SelectedValue = 3 Then
                If IsNumeric(viewOperatorHiddenCompanyID.Text) Then
                    comp_id = viewOperatorHiddenCompanyID.Text
                    Session.Item("searchCriteria").SearchViewCriteriaClearCompany = False
                    clearCompany = False
                Else
                    comp_id = 0
                    Session.Item("searchCriteria").SearchViewCriteriaClearCompany = True
                End If
            End If

            localCriteria.ViewCriteriaCompanyID = comp_id
        ElseIf Session.Item("searchCriteria").SearchViewCriteriaOperatorSelected > 0 Then
            If clearCompany Then
                comp_id = 0
                Session.Item("searchCriteria").SearchViewCriteriaClearCompany = True
                localCriteria.ViewCriteriaCompanyID = 0
            Else
                comp_id = Session.Item("searchCriteria").SearchViewCriteriaOperatorSelected
                Session.Item("searchCriteria").SearchViewCriteriaClearCompany = False
                clearCompany = False
                localCriteria.ViewCriteriaCompanyID = comp_id
            End If
        End If


        If viewOperatorRoll.Checked Then
            rollUpCompanies = True
            'we're overriding exclude so we can't do this:
            util_functions.exclude_check = False
            operator_list = " select distinct RelCompID from ReturnAllCompanyLocationsByCompId(" & comp_id & ") "
            util_functions.Operator_IDS_String = operator_list
            comp_id = 0
            Session.Item("searchCriteria").SearchViewCriteriaClearCompany = True
            localCriteria.ViewCriteriaCompanyID = 0
        End If
    End Sub

    Private Function BuildInClause(ByVal StringToWorkWith As String) As String
        Dim RegList As String = ""
        Dim splittableInClause As Boolean = False
        Dim ACArray As Array
        Dim InClause As String = ""

        RegList = StringToWorkWith.Replace(vbCr, "").Replace(vbLf, ",")
        RegList = Replace(RegList, ";", ",")

        RegList = clsGeneral.clsGeneral.CleanUserData(RegList, Constants.cEmptyString, Constants.cCommaDelim, True)

        ACArray = Split(RegList, ",")

        If UBound(ACArray) = 0 Then
            InClause = " '" & RegList & "'"
        Else
            If InStr(RegList, "*") = 0 Then
                InClause = " "
                For x = 0 To UBound(ACArray)
                    If Trim(ACArray(x)) <> "" Then
                        If x > 0 Then
                            InClause += ","
                        End If
                        InClause += "'" & Trim(ACArray(x)) & "'"
                    End If
                Next
            Else
                'This has asterisks
                InClause = " ( "
                For x = 0 To UBound(ACArray)
                    If Trim(ACArray(x)) <> "" Then
                        If x > 0 Then
                            InClause += " or "
                        End If
                        If InStr(Trim(ACArray(x)), "*") = 0 Then
                            ACArray(x) = Trim(ACArray(x)) & "*"
                        End If
                        InClause += "'" & Replace(Trim(ACArray(x)), "*", "%") & "'"

                    End If
                Next

                InClause += " "
            End If
        End If

        Return InClause
    End Function

    Private Sub BuildUtilizationSession(ByRef clearAirportID As Boolean, ByRef clearCompanyID As Boolean)
        If IsNothing(Session("Last_FBO_Bottom")) Or Not IsPostBack Then
            Session("Last_FBO_Bottom") = -1
        End If

        If IsNothing(Session("Last_FBO_Bottom")) Then
            Session("Last_FBO_Bottom_Text") = ""
        End If

        If IsNothing(Session("Last_Airport_Range")) Then
            Session("Last_Airport_Range") = ""
        End If

        If IsNothing(Session("Last_Util_Folder")) Then
            Session("Last_Util_Folder") = 0
        End If

        If Not IsPostBack Then
            Session("Last_FAA_DATE") = Session.Item("localSubscription").crmSubinst_FAA_data_date
        End If

        FillUpAirportSession(clearAirportID, clearCompanyID)

        If IsNothing(Session("Last_Aport_ID")) Then
            Session("Last_Aport_ID") = 0
        ElseIf Session("Last_Aport_ID") = 1 Then
            ' if we arent postback, so page load, and it was one, then set to 0
            If Not IsPostBack Then
                Session("Last_Aport_ID") = 0
            End If
        End If

        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />" & Date.Now & " - FBO View START---<br />"
    End Sub

    Private Sub BuildUtilizationDisplayUIBasedOnCriteria(ByRef FullAirportName As String, ByRef FullCompanyName As String, ByVal isAircraftSearch As Boolean, ByVal isOperatorSwapDown As Boolean, ByVal temp_distance_company As Integer, ByVal aport_id As Long, ByRef originate_date As String, ByVal afolder_id As Long, ByRef util_functions As utilization_functions, ByVal cfolder_id As Long, ByVal comp_id As Long, ByVal airport_list As String, ByRef isSearchRan As Boolean, ByRef AirportData As DataTable, ByRef location_name As String, ByRef orig_lat As Double, ByRef orig_long As Double, ByVal operator_list As String, ByVal airport_direction As String, ByRef reportSwap As Boolean, ByRef searchCriteria As viewSelectionCriteriaClass, ByRef RollUpCompanies As Boolean, ByRef OperatorFolderActive As Boolean, ByVal Aircraft_List As String, ByRef active_Tab As Integer, ByRef NoAirportNoOperator As Boolean)

        ' added in MSW 
        Me.flight_summary_utilization_tab.Visible = True

        utilizationViewMainBox.CssClass = "columns twelve removeMargins"
        utilizationViewMainBoxLabel.CssClass = "columns seven float_right"

        If isAircraftSearch = False Then
            If localCriteria.ViewCriteriaDocumentsStartDate.ToString.Trim <> "" Then
                If localCriteria.ViewCriteriaDocumentsEndDate.ToString.Trim <> "" Then
                    Me.UtilizationViewRightMainBoxDropdownText.Text = "<b>" & localCriteria.ViewCriteriaDocumentsStartDate.ToString.Trim
                    Me.UtilizationViewRightMainBoxDropdownText.Text &= " to " & localCriteria.ViewCriteriaDocumentsEndDate
                Else
                    Me.UtilizationViewRightMainBoxDropdownText.Text = "<b>" & localCriteria.ViewCriteriaDocumentsStartDate.ToString.Trim
                End If
            Else
                Me.UtilizationViewRightMainBoxDropdownText.Text = "<b> For the Last Year "
            End If
        End If


        If airportOperatorType.SelectedValue = "1" Then
            If isOperatorSwapDown = False Then
                operator_drop2.SelectedValue = "U"
                utilizationViewDropDown.SelectedValue = "U" ' added in msw 
            End If
        End If

        'Me.company_range.SelectedValue = temp_distance_company
        'Me.company_range_19.SelectedValue = temp_distance_company


        If aport_id > 1 Then
            Me.Nearby_Airports_18_Panel.Visible = True
        Else
            Me.Nearby_Airports_18_Panel.Visible = False
        End If

        If Trim(airport_direction) = "D" Then
            Me.UtilizationViewLeftMainBoxDropdownText.Text = "<b>Arrivals By </b>"
        ElseIf Trim(airport_direction) = "O" Then
            Me.UtilizationViewLeftMainBoxDropdownText.Text = "<b>Departures By </b>"
        ElseIf Trim(airport_direction) = "X" Then
            Me.UtilizationViewLeftMainBoxDropdownText.Text = "<b>Arrivals/Departures By </b>"
        Else
            Me.UtilizationViewLeftMainBoxDropdownText.Text = "<b>Arrivals By </b>"
        End If


        If Not IsNothing(Session("Last_FAA_DATE")) Then
            If Trim(Session("Last_FAA_DATE")) <> "" Then
                originate_date = DateAdd(DateInterval.Year, -2, Session("Last_FAA_DATE"))
                originate_date = DateAdd(DateInterval.Day, 1, CDate(originate_date))
                breadcrumbs.Text = "<strong>Flight Activity (Operator/Airport) (<a href='/help/documents/589.pdf' target='_blank'>Flight Data as of " & Format(CDate(Trim(Session("Last_FAA_DATE"))), "MM/dd/yyyy hh:mm") & " UTC)</a></strong>"
            Else
                breadcrumbs.Text = "<strong>Flight Activity (Operator/Airport) (<a href='/help/documents/589.pdf' target='_blank'>Flight Data)</a></strong>"
            End If
        Else
            breadcrumbs.Text = "<strong>Flight Activity (Operator/Airport) (<a href='/help/documents/589.pdf' target='_blank'>Flight Data)</a></strong>"
        End If

        If afolder_id > 0 Then 'If we have an airport folder
            operator_list_label.Visible = True
            If Me.excludeAircraftFolders.Checked = True Then
                util_functions.exclude_airport_check = True
                airportExcludeCheck.Checked = True
            Else
                util_functions.exclude_airport_check = False
                airportExcludeCheck.Checked = False
            End If
        End If

        If cfolder_id > 0 Then 'if we have an operator folder.
            Me.exclude_check.CssClass = ""
            operator_drop2.CssClass = ""
            exclude_check.Attributes.Add("onChange", "updateExclude(this)")

            If airportOperatorExclude.Checked = True Then
                util_functions.exclude_check = True
            Else
                util_functions.exclude_check = False
            End If
        End If

        If airportAircraftExclude.Checked = True Then
            util_functions.exclude_Aircraft = True
        Else
            util_functions.exclude_Aircraft = False
        End If

        ' added MSW - 11/16/18
        Me.utilization_Aircraft_Model.Visible = True

        If IsPostBack Then
            If Trim(operator_drop2.SelectedValue) <> "B" And Trim(operator_drop2.SelectedValue) <> "U" Then
                Me.operator_list_label.Visible = True
                Session("Last_Util_Folder") = operator_drop2.SelectedValue.ToString
            End If
        End If



        trends_tab.Visible = True
        If comp_id > 0 Then
            for_sale_tab.HeaderText = "Operator"
        Else
            for_sale_tab.HeaderText = "Operators"
        End If

        If aport_id < 2 Then
            trends_tab.HeaderText = "Airports"
        Else
            trends_tab.HeaderText = "Airport"
        End If


        If RollUpCompanies Then    '  comp_id > 0 Or - dont go in if u have picked a company, we are now showing the section 
            If RollUpCompanies = True Or aport_id > 1 Then
                ' utilizationViewMainBox.CssClass = "columns twelve removeMargins"
                ' trends_tab.Visible = False   ' commented out  - added in - msw -11/15/18 
                trends_tab.HeaderText = "Airport"
                'If operator_list = "" And active_Tab = 0 Then 'If aport_id > 1 Then
                '  active_Tab += 1
                'End If
            ElseIf aport_id < 2 Then
                '  trends_tab.Visible = True
                ' trends_tab.HeaderText = "Airports"
                trends_tab.HeaderText = "Airports"
            End If

            utilizationViewOperator.Visible = True 'Operator True
            SetUpCompanyNameAndJavascript(FullCompanyName, comp_id, RollUpCompanies)

            Dim LocationAmount As Long = 0
            utilizationViewOperatorLabel.Text += "<p><a href=""#""  onclick=""javascript:load('DisplayCompanyDetail.aspx?compID=" & comp_id & "&use_insight_op=Y" & IIf(RollUpCompanies, "&use_insight_roll=Y", "") & "','','scrollbars=yes,menubar=no,height=900,width=1090,resizable=yes,toolbar=no,location=no,status=no');return false;"">View Operator Report</a></p>"

            ' add text below, moved from above, msw 5/9/17
            If aport_id > 1 And comp_id > 0 Then
                utilizationViewOperatorLabel.Text &= "<p><a href='javascript:void(0);' onclick='$(""#" & airportOperatorType.ClientID & """).val(""1"");$(""#" & viewOperatorHiddenCompanyID.ClientID & """).val(""0"");$(""#" & goSearchAirports.ClientID & """).click();'>View All Operators for this Airport</a></p>"
            End If

            If RollUpCompanies = True Then
                utilizationViewOperatorLabel.Text += "<p><a href=""javascript:void(0);"" onclick='$(""#" & viewOperatorRoll.ClientID & """).prop(""checked"", false );$(""#" & goSearchAirports.ClientID & """).click();'><strong>SHOW MY LOCATION ONLY</strong></a></p>"
            Else
                Call util_functions.get_company_profile_top_function(searchCriteria, "company", 0, 0, 0, 0, 0, LocationAmount, 0, 0, "N")
                If LocationAmount > 1 Then

                    utilizationViewOperatorLabel.Text += "<p><a href=""javascript:void(0);"" onclick='$(""#" & viewOperatorRoll.ClientID & """).prop(""checked"", true );$(""#" & goSearchAirports.ClientID & """).click();'><strong>Operator has " & LocationAmount.ToString & " locations. View Activity for All Locations for this Operator</strong></a></p>"
                End If

            End If
        Else 'No Company? We need to make the main tab container larger.
            utilizationViewOperatorLabel.Text = ""
            utilizationViewOperator.Visible = False
            ' utilizationViewMainBox.CssClass = "columns twelve removeMargins"

            '   trends_tab.Visible = True
            '  trends_tab.HeaderText = "Operators"

            ' commented out  - added in - msw -11/15/18 

            If comp_id > 0 Then
                SetUpCompanyNameAndJavascript(FullCompanyName, comp_id, RollUpCompanies)
            End If


        End If

        If aport_id > 1 Then
            Dim TemporaryAirportInfo As String = ""
            utilizationViewAirport.Visible = True
            Call localDatalayer.get_airport_information(AirportData, TemporaryAirportInfo, localCriteria, location_name, orig_lat, orig_long)

            FullAirportName = localCriteria.ViewCriteriaAirportName
            'utilizationViewAirportLabel.Text = "<div class=""subHeader"">" & FullAirportName & "</div>"
            utilizationViewAirportLabel.Text += "<table width=""100%"" cellpadding=""0"" cellspacing=""0""><tr><td>" & TemporaryAirportInfo & "</td></tr></table>"

            ' if we have selected 1 single code, then it should fall in here and skip over the adding and selecting of the airport to the dropdown
            ' ADDED MSW - 2/27/20
            If selectAirportsType.SelectedValue = "5" Then

            Else
                selectAirportsType.Items.Add(New ListItem(localCriteria.ViewCriteriaAirportName, 2))
                selectAirportsType.SelectedValue = 2
                'If isAircraftSearch Then
                Dim str As String = ""
                str = "$(""#" & selectAirportsType.ClientID & " option[value='2']"").remove();$(""#" & selectAirportsType.ClientID & """).append('<option value=""2"">" & FullAirportName & "</option>');$(""#" & selectAirportsType.ClientID & """).val(""2"");"
                System.Web.UI.ScriptManager.RegisterStartupScript(Me.airportsSearchUpdate, Me.GetType(), "updateDropdownAC", str, True)
                'End If 
            End If





            If comp_id > 0 Then
                utilizationViewAirportLabel.Text += "<p><a href='javascript:void(0);' onclick='$(""#" & selectAirportsType.ClientID & """).val(""1"");$(""#" & selectAirportID.ClientID & """).val(""0"");$(""#" & goSearchAirports.ClientID & """).click();'>View All Airports for this Operator</a></p>"
            ElseIf comp_id = 0 And operator_list = "" Then
                owner_drop.Visible = True '
                panel_20.Visible = True
                panel_19.Visible = True
            End If
        Else 'No Airport? We need to make the main tab container larger.
            ' utilizationViewMainBox.CssClass = "columns twelve removeMargins"

            ' added to show even if there isnt an airport selected 
            ' panel_20.Visible = True

        End If



        'This displays no drilled down airport/operator.
        If aport_id < 2 And comp_id = 0 And RollUpCompanies = False Then
            utilizationViewAirport.Visible = False
            utilizationViewAirportLabel.Text = ""
            'This means no airport/company. We need to make the container larger.
            'utilizationViewMainBox.CssClass = "columns twelve removeMargins"
        End If


        'This displays no folders, no operators, no airports
        If (airport_list = "" And aport_id < 2) And (operator_list = "" And comp_id = 0) And Aircraft_List = "" Then


            ' commented out MSW - 11/27/2018 - now showing all of the tabs 
            ''if we are on tab 1 or tab 0 then make it tab 1 - since there should be no tab0 currently 
            'If (active_Tab = 1 And TabContainer1.ActiveTab.UniqueID = "ctl00$ContentPlaceHolder1$View_Master1$TabContainer1$for_sale_tab") Or (active_Tab = 0 And TabContainer1.ActiveTab.UniqueID = "ctl00$ContentPlaceHolder1$View_Master1$TabContainer1$trends_tab") Then
            '  active_Tab = 1 ' if we have picked tab 0 and its not avaialble 
            'ElseIf active_Tab < 2 Then
            '  active_Tab = 2
            'End If

            If searchCriteria.ViewCriteriaAmodID > 0 Or searchCriteria.ViewCriteriaAircraftMake.ToString.Trim <> "" Then
                NoAirportNoOperator = False
                event_tab.Visible = True
                news_tab.Visible = True
                for_sale_tab.Visible = True
                ' trends_tab.Visible = False
            Else
                NoAirportNoOperator = True
                event_tab.Visible = False
                news_tab.Visible = False
                trends_tab.Visible = False
                for_sale_tab.Visible = False '.HeaderText = "Airports"
                ' COMMENTED OUT - MSW - 9/24/18
                'If Aircraft_List = "" Then
                '  active_Tab = 2 'Only 3 tabs show up in this case. 
                'End If
            End If
        End If

        'If there is an airport folder.
        If airport_list <> "" Then
            'airportDrop.CssClass = ""
            'airportExcludeCheck.CssClass = ""
            ' trends_tab.HeaderText = "Airports"
            exclude_check.CssClass = "display_none" 'turn off operators exclude check.
            'airportExcludeCheck.CssClass = "" 'turn on airport exclude check
            operator_drop2.CssClass = "display_none"
            'airportDrop.CssClass = ""

            If afolder_id > 0 Then
                operator_list_label.Text = "<a href=""#"" onclick=""javascript:load('/staticFolderEditor.aspx?folderID=" & afolder_id.ToString & "&airport=true','','scrollbars=yes,menubar=no,height=600,width=1250,resizable=yes,toolbar=no,location=no,status=no');"">Edit " & IIf(isAircraftSearch, Session.Item("searchCriteria").SearchViewCriteriaAirportFolderName, searchAirportFolder.SelectedItem.Text) & "</a>"
            End If

            aircraftViewText.Text = ""
            aircraftViewText.Visible = False
            oper2AirportViewTextToggle.Text = "<p align=""center"">Operator flight summaries include flights since the most recent purchase date of aircraft.</p>"
            oper2AirportViewTextToggle.Visible = True
        End If


        'There is NOT an airport Folder:
        If airport_list = "" Then
            ' If comp_id = 0 Then
            'trends_tab.HeaderText = "Operators"
            ' End If
            If cfolder_id > 0 Then
                If OperatorFolderActive = True Then
                    Me.operator_list_label.Text = ""
                Else
                    If IsNothing(operator_drop2.SelectedItem) Then
                        Me.operator_list_label.Text = ""
                    Else
                        Me.operator_list_label.Text = "<a " & IIf(airport_list <> "", "style=""margin-left:24px""", "") & " target='_blank' href='staticFolderEditor.aspx?folderID=" & operator_drop2.SelectedValue.ToString & "'>Edit " & operator_drop2.SelectedItem.Text.ToString & "</a>"
                    End If
                End If
            End If
            ' oper2AirportViewTextToggle.Text = ""
            ' oper2AirportViewTextToggle.Visible = False
            '  aircraftViewText.Text = "<span class=""margin_4"" style=""padding-left:22px;"">Operator flight summaries include flights since the most recent purchase date of aircraft.</span>"
            ' aircraftViewText.Visible = True
        End If

        'If Aircraft_List <> "" Then
        '  trends_tab.HeaderText = "Airports"
        'End If
        'If Trim(operator_list) <> "" Then
        '  If aport_id < 2 Then
        '    trends_tab.HeaderText = "Airports"
        '  End If
        'End If

        If Not Page.IsPostBack Then
            If Trim(operator_list) <> "" Then
                operator_drop.CssClass = ""
                operator_drop2.Items.Clear()
                operator_drop2.Items.Add(New System.Web.UI.WebControls.ListItem("All Operators", "U"))
                operator_drop2.Items.Add(New System.Web.UI.WebControls.ListItem("All Operators Based at this Airport", "B"))
                utilizationViewDropDown.Items.Clear()
                utilizationViewDropDown.Items.Add(New System.Web.UI.WebControls.ListItem("All Operators", "U"))
                utilizationViewDropDown.Items.Add(New System.Web.UI.WebControls.ListItem("All Operators Based at this Airport", "B"))
            Else
                operator_drop.CssClass = ""
                operator_drop2.Items.Clear()

                operator_drop2.Items.Add(New System.Web.UI.WebControls.ListItem("All Operators Based at this Airport", "B"))
                operator_drop2.Items.Add(New System.Web.UI.WebControls.ListItem("All Operators Utilizing this Airport", "U"))
                utilizationViewDropDown.Items.Clear()

                If aport_id < 2 Then
                    utilizationViewDropDown.Items.Add(New System.Web.UI.WebControls.ListItem("Operators Utilizing Airport", "U"))
                    utilizationViewDropDown.Items.Add(New System.Web.UI.WebControls.ListItem("Operators Based at Airport", "B"))
                    utilizationViewDropDown.Items.Add(New System.Web.UI.WebControls.ListItem("Operators Based at Airports", "N"))
                Else
                    utilizationViewDropDown.Items.Add(New System.Web.UI.WebControls.ListItem("Operators Utilizing Airports", "U"))
                    utilizationViewDropDown.Items.Add(New System.Web.UI.WebControls.ListItem("Operators Based at Airports", "B"))
                    utilizationViewDropDown.Items.Add(New System.Web.UI.WebControls.ListItem("Operators Not-Based at Airports", "N"))
                End If
            End If
        End If


        If (aport_id < 2 And (comp_id = 0 Or RollUpCompanies = True Or operator_list <> "")) Then
            ' wanted_tab.Visible = True
            ' wanted_tab.HeaderText = "Operators"
            utilizationListLabel.Text = ""

            'If cfolder_id > 0 Then
            '  utilizationViewDropDown.SelectedValue = cfolder_id
            'End If
            If utilizationViewDropDown.SelectedValue <> "B" And utilizationViewDropDown.SelectedValue <> "U" Then
                If OperatorFolderActive = True Then
                    utilizationListLabel.Text = ""
                Else
                    If IsNothing(utilizationViewDropDown.SelectedItem) Then
                        Me.utilizationListLabel.Text = ""
                    Else
                    End If
                    utilizationListLabel.Text = "<a target='_blank' href='staticFolderEditor.aspx?folderID=" & utilizationViewDropDown.SelectedValue.ToString & "'>Edit " & utilizationViewDropDown.SelectedItem.Text.ToString & "</a>"
                End If
            End If
            ' utilizationExcludeCheck.Checked = exclude_check.Checked
            utilizationViewToggle.Visible = True
        End If

        If aport_id < 2 And airport_list = "" Then
            utilizationViewDropDown.CssClass = "display_none"
            utilizationExcludeCheck.CssClass = "display_none"
        Else
            utilizationViewDropDown.CssClass = ""
            utilizationExcludeCheck.CssClass = ""
        End If

    End Sub
    Private Sub SetUpCompanyNameAndJavascript(ByRef FullCompanyName As String, ByVal comp_id As Long, ByVal RollUpCompanies As Boolean)
        FullCompanyName = commonEvo.get_company_name_fromID(IIf(RollUpCompanies, IIf(IsNumeric(viewOperatorHiddenCompanyID.Text), viewOperatorHiddenCompanyID.Text, 0), comp_id), 0, False, True, "")
        utilizationViewOperatorLabel.Text += commonEvo.get_company_info_fromID(IIf(RollUpCompanies, IIf(IsNumeric(viewOperatorHiddenCompanyID.Text), viewOperatorHiddenCompanyID.Text, 0), comp_id), 0, True, True, "", "")
        airportOperatorType.Items.Add(New ListItem(FullCompanyName, "3"))
        airportOperatorType.SelectedValue = 3

        Dim str As String = ""
        str = "$(""#" & airportOperatorType.ClientID & " option[value='3']"").remove();$(""#" & airportOperatorType.ClientID & """).append('<option value=""3"">" & FullCompanyName & "</option>');$(""#" & airportOperatorType.ClientID & """).val(""3"");"
        System.Web.UI.ScriptManager.RegisterStartupScript(Me.airportsSearchUpdate, Me.GetType(), "updateDropdown", str, True)
    End Sub
    Private Sub BuildUtilizationActiveFoldersLists(ByRef AircraftFolderActive As Boolean, ByRef Aircraft_List As String, ByRef aircraftFolder As Long, ByRef aclsData_Temp As clsData_Manager_SQL, ByRef util_functions As utilization_functions, ByRef comp_id As Long, ByRef cfolder_id As Long, ByRef Operator_List As String, ByRef OperatorFolderActive As Boolean, ByRef searchCriteria As viewSelectionCriteriaClass)
        Dim Airport_Table As New DataTable
        If aircraftFolder > 0 Then
            Airport_Table = util_functions.get_data_from_client_folder(aircraftFolder, "cfoldind_jetnet_ac_id")
            Aircraft_List = ""
            If Not IsNothing(Airport_Table) Then
                If Airport_Table.Rows.Count > 0 Then
                    For Each r As DataRow In Airport_Table.Rows

                        If Trim(Aircraft_List) <> "" Then
                            Aircraft_List += ","
                        End If
                        Aircraft_List += r("cfoldind_jetnet_ac_id").ToString

                    Next
                Else
                    Airport_Table = aclsData_Temp.GetEvolutionFolderssBySubscription(aircraftFolder, Session.Item("localUser").crmUserLogin, Session.Item("localUser").crmSubSubID, Session.Item("localUser").crmSubSeqNo, "", 0, Nothing, "A")
                    If Not IsNothing(Airport_Table) Then
                        If Airport_Table.Rows.Count > 0 Then
                            If Not IsDBNull(Airport_Table.Rows(0).Item("cfolder_data")) Then
                                Dim FromQuery As String = ""
                                Dim SelectQuery As String = "SELECT ac_id "
                                ' HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />" & airport_table.Rows(0).Item("cfolder_data") & "<br /><br />"
                                Dim cfolderQuery As String() = Split(Airport_Table.Rows(0).Item("cfolder_data"), "THEREALSEARCHQUERY")
                                If UBound(cfolderQuery) >= 1 Then
                                    Dim ToSplitBy As String = "FROM View_Aircraft_Flat WITH (NOLOCK)"
                                    If InStr(UCase(cfolderQuery(1)), UCase("from View_Aircraft_Company_Flat with (NOLOCK)")) > 0 Then
                                        ToSplitBy = "FROM View_Aircraft_Company_Flat with (NOLOCK)"
                                    End If
                                    FromQuery = ToSplitBy
                                    Dim cfolderWhere As String() = Split(UCase(cfolderQuery(1)), UCase(ToSplitBy))
                                    If UBound(cfolderWhere) >= 1 Then
                                        Dim queryToRun As String = SelectQuery & " " & FromQuery & " " & cfolderWhere(1)
                                        queryToRun = Replace(queryToRun, "''", "'")
                                        Dim FolderIDData As DataTable = util_functions.RunActiveFolderCompanyID(queryToRun)
                                        If Not IsNothing(FolderIDData) Then
                                            If FolderIDData.Rows.Count > 0 Then
                                                AircraftFolderActive = True
                                                Aircraft_List = ""
                                                For Each r As DataRow In FolderIDData.Rows
                                                    If Aircraft_List <> "" Then
                                                        Aircraft_List += ","
                                                    End If
                                                    Aircraft_List += r("ac_id").ToString
                                                Next
                                            Else
                                                If Not Page.ClientScript.IsClientScriptBlockRegistered("EmptyOpAlert") Then
                                                    System.Web.UI.ScriptManager.RegisterClientScriptBlock(Me.airportsSearchUpdate, Me.GetType, "EmptyOpAlert", "alert('Aircraft Folder is Empty. Default to all Aircraft.');" + vbCrLf, True)
                                                End If
                                            End If
                                        End If
                                    End If
                                End If

                            End If
                        Else
                            If Not Page.ClientScript.IsClientScriptBlockRegistered("NoFolderOpAlert") Then
                                System.Web.UI.ScriptManager.RegisterClientScriptBlock(Me.airportsSearchUpdate, Me.GetType, "NoFolderOpAlert", "alert('This Aircraft Folder Does Not Exist. Default to all Aircraft.');" + vbCrLf, True)
                            End If
                        End If

                    End If

                End If
            End If
        End If




        'OPERATOR DEFAULT
        If comp_id > 0 And Not IsNumeric(airportOperatorFolder.SelectedValue) Then
            util_functions.Operator_IDS_String = Operator_List
        ElseIf (Trim(operator_drop2.SelectedValue) <> "B" And Trim(operator_drop2.SelectedValue) <> "U" And Trim(operator_drop2.SelectedValue) <> "") Or (airportOperatorType.SelectedValue = "4" And IsNumeric(airportOperatorFolder.SelectedValue)) Then
            If IsNumeric(airportOperatorFolder.SelectedValue) Then
                cfolder_id = CLng(Trim(airportOperatorFolder.SelectedValue))
            Else
                cfolder_id = CLng(Trim(operator_drop2.SelectedValue))
            End If

            Airport_Table = util_functions.get_data_from_client_folder(cfolder_id, "cfoldind_jetnet_comp_id")
            Operator_List = ""
            If Not IsNothing(Airport_Table) Then
                If Airport_Table.Rows.Count > 0 Then
                    For Each r As DataRow In Airport_Table.Rows
                        If Trim(Operator_List) = "" Then
                            Operator_List = r("cfoldind_jetnet_comp_id")
                        Else
                            Operator_List = Operator_List & ", " & r("cfoldind_jetnet_comp_id")
                        End If

                    Next
                Else
                    'This is probably an active folder, let's check:
                    Airport_Table = aclsData_Temp.GetEvolutionFolderssBySubscription(cfolder_id, Session.Item("localUser").crmUserLogin, Session.Item("localUser").crmSubSubID, Session.Item("localUser").crmSubSeqNo, "", 0, Nothing, "A")
                    If Not IsNothing(Airport_Table) Then
                        If Airport_Table.Rows.Count > 0 Then
                            If Not IsDBNull(Airport_Table.Rows(0).Item("cfolder_data")) Then
                                Dim cfolderQuery As String() = Split(Airport_Table.Rows(0).Item("cfolder_data"), "THEREALSEARCHQUERY")
                                If UBound(cfolderQuery) >= 1 Then
                                    Dim ToSplitBy As String = "WHERE  CREF_JOURN_ID = 0"
                                    If InStr(UCase(cfolderQuery(1)), "FROM VIEW_AIRCRAFT_COMPANY_FLAT") = 0 Then
                                        ToSplitBy = "WHERE  COMP_JOURN_ID = 0"
                                    End If

                                    Dim queryToBreak As String() = Split(UCase(cfolderQuery(1)), ToSplitBy)
                                    If UBound(queryToBreak) >= 1 Then
                                        Dim queryToRun As String = ""
                                        Dim queryWhere As String = ""
                                        Dim querySelect As String = "select distinct comp_id "
                                        Dim queryFrom As String = ""
                                        If InStr(queryToBreak(0), "FROM VIEW_AIRCRAFT_COMPANY_FLAT") = 0 Then
                                            queryFrom = "  From Company WITH(NOLOCK) "
                                            queryFrom += " LEFT OUTER JOIN State WITH(NOLOCK) on state_code = comp_state and state_country=comp_country"
                                            queryFrom += " LEFT OUTER JOIN Contact WITH(NOLOCK) ON (comp_id = contact_comp_id AND comp_journ_id = contact_journ_id and contact_hide_flag = 'N' and contact_active_flag = 'Y')"
                                            If InStr(queryToBreak(0), "INNER JOIN COUNTRY") Then
                                                queryFrom += " INNER JOIN Country WITH(NOLOCK) on comp_country = country_name "
                                            End If

                                            If InStr(queryToBreak(0), "INNER JOIN COUNTRY") Then
                                                queryFrom += " INNER JOIN Country WITH(NOLOCK) on comp_country = country_name "
                                            End If

                                            If InStr(queryToBreak(0), "INNER JOIN COUNTRY") Then
                                                queryFrom += " INNER JOIN Country WITH(NOLOCK) on comp_country = country_name "
                                            End If

                                            queryWhere = " WHERE comp_journ_id = 0 "
                                        Else
                                            queryFrom = " From View_Aircraft_Company_Flat "
                                            queryWhere = " WHERE CREF_JOURN_ID = 0"
                                        End If

                                        If InStr(queryToBreak(0), "INNER JOIN COMPANY_AIRCRAFT_COUNT WITH(NOLOCK)") > 0 Then
                                            Dim queryFleetChoice As String() = Split(queryToBreak(0), "INNER JOIN COMPANY_AIRCRAFT_COUNT WITH(NOLOCK)")
                                            If UBound(queryFleetChoice) > 0 Then
                                                queryFrom += " INNER JOIN COMPANY_AIRCRAFT_COUNT WITH(NOLOCK) " + queryFleetChoice(1)
                                            End If
                                        End If


                                        Dim querySplitOrder As String() = Split(UCase(queryToBreak(1)), " ORDER BY ")
                                        If UBound(querySplitOrder) >= 0 Then
                                            queryWhere += Replace(querySplitOrder(0), "''", "'")
                                            queryToRun = querySelect + queryFrom + queryWhere

                                            'We need to run this query.
                                            Dim FolderIDData As DataTable = util_functions.RunActiveFolderCompanyID(queryToRun)
                                            If Not IsNothing(FolderIDData) Then
                                                If FolderIDData.Rows.Count > 0 Then
                                                    OperatorFolderActive = True
                                                    Operator_List = ""
                                                    For Each r As DataRow In FolderIDData.Rows
                                                        If Operator_List <> "" Then
                                                            Operator_List += ","
                                                        End If
                                                        Operator_List += r("comp_id").ToString
                                                    Next
                                                Else
                                                    If Not Page.ClientScript.IsClientScriptBlockRegistered("EmptyOpAlert2") Then
                                                        System.Web.UI.ScriptManager.RegisterClientScriptBlock(Me.airportsSearchUpdate, Me.GetType, "EmptyOpAlert2", "alert('Operator Folder is Empty. Default to all Companies.');" + vbCrLf, True)
                                                    End If
                                                End If
                                            End If
                                        End If
                                    End If
                                End If
                            End If
                        Else
                            If Not Page.ClientScript.IsClientScriptBlockRegistered("NoFolderOpAlert2") Then
                                System.Web.UI.ScriptManager.RegisterClientScriptBlock(Me.airportsSearchUpdate, Me.GetType, "NoFolderOpAlert2", "alert('This Operator Folder Does Not Exist. Default to all Companies.');" + vbCrLf, True)
                            End If
                        End If
                    End If

                End If
            End If
            Airport_Table.Clear()
            searchCriteria.ViewCriteriaCompanyID = 0
            comp_id = 0
        End If
    End Sub

    Private Sub BuildUtilizationDefaultFolders_Force(ByVal clearAirportID As Boolean, ByVal ranThroughAirport As Boolean, ByVal isAircraftSearch As Boolean, ByRef afolder_id As Long, ByRef aport_id As Long, ByRef util_functions As utilization_functions, ByVal searchCriteria As viewSelectionCriteriaClass)

        'Default airport folder if this is blank:
        Dim DefaultFolderSelected As Boolean = False
        If String.IsNullOrEmpty(Trim(Request("aport_id"))) And String.IsNullOrEmpty(Trim(Request("acfolder"))) And String.IsNullOrEmpty(Trim(Request("opfolder"))) Then
            Dim DefaultFolder As DataTable = util_functions.DefaultFolderByType("Airport", HttpContext.Current.Session.Item("localUser").crmSubSubID, HttpContext.Current.Session.Item("localUser").crmUserLogin, HttpContext.Current.Session.Item("localUser").crmSubSeqNo)
            If Not IsNothing(DefaultFolder) Then
                If DefaultFolder.Rows.Count > 0 Then
                    DefaultFolderSelected = True
                    Session.Item("searchCriteria").SearchViewCriteriaDefaultFolder = True
                    defaultFolderSelectedCheckBox.Checked = True
                    afolder_id = DefaultFolder.Rows(0).Item("cfolder_id")
                    airportDrop.Items.Add(New ListItem(IIf(Not IsDBNull(DefaultFolder.Rows(0).Item("cfolder_name")), DefaultFolder.Rows(0).Item("cfolder_name"), ""), DefaultFolder.Rows(0).Item("cfolder_id")))
                    searchAirportFolder.Items.Add(New ListItem(IIf(Not IsDBNull(DefaultFolder.Rows(0).Item("cfolder_name")), DefaultFolder.Rows(0).Item("cfolder_name"), ""), DefaultFolder.Rows(0).Item("cfolder_id")))
                    searchAirportFolder.SelectedValue = DefaultFolder.Rows(0).Item("cfolder_id")
                    airportDrop.SelectedValue = DefaultFolder.Rows(0).Item("cfolder_id")
                    selectAirportsType.SelectedValue = "4"
                    airportFolderToggleOnOff.Attributes.Clear()
                End If
            End If

            DefaultFolder.Dispose()

            If DefaultFolderSelected = False And clearAirportID = False Then
                aport_id = util_functions.get_default_airport_id(searchCriteria, Session.Item("localPreferences").UserCompanyID, "City", 0)
                If aport_id = 0 Then
                    aport_id = util_functions.get_default_airport_id(searchCriteria, Session.Item("localPreferences").UserCompanyID, "Radius", 25)
                End If
                If aport_id = 0 Then
                    aport_id = util_functions.get_default_airport_id(searchCriteria, Session.Item("localPreferences").UserCompanyID, "State", 0)
                End If
                If aport_id = 0 Then
                    aport_id = util_functions.get_default_airport_id(searchCriteria, Session.Item("localPreferences").UserCompanyID, "Country", 0)
                End If
                Session("Last_Aport_ID") = aport_id
                Session.Item("searchCriteria").SearchViewCriteriaAirportSelected = aport_id
                selectAirportID.Text = aport_id
            End If
        End If



    End Sub

    Private Sub BuildUtilizationDefaultFolders(ByVal clearAirportID As Boolean, ByVal ranThroughAirport As Boolean, ByVal isAircraftSearch As Boolean, ByRef afolder_id As Long, ByRef aport_id As Long, ByRef util_functions As utilization_functions, ByVal searchCriteria As viewSelectionCriteriaClass)
        If Not Page.IsPostBack Then
            If Session("Last_Aport_ID") = 0 And Session.Item("searchCriteria").SearchViewCriteriaAirportSelected = 0 And (Session.Item("searchCriteria").SearchViewCriteriaAirportDropdown <> 4 And Session.Item("searchCriteria").SearchViewCriteriaAirportDropdown <> 5 And Session.Item("searchCriteria").SearchViewCriteriaAirportDropdown2 = 0) Then
                'Default airport folder if this is blank:
                Dim DefaultFolderSelected As Boolean = False
                If String.IsNullOrEmpty(Trim(Request("aport_id"))) And String.IsNullOrEmpty(Trim(Request("acfolder"))) And String.IsNullOrEmpty(Trim(Request("opfolder"))) Then
                    Dim DefaultFolder As DataTable = util_functions.DefaultFolderByType("Airport", HttpContext.Current.Session.Item("localUser").crmSubSubID, HttpContext.Current.Session.Item("localUser").crmUserLogin, HttpContext.Current.Session.Item("localUser").crmSubSeqNo)
                    If Not IsNothing(DefaultFolder) Then
                        If DefaultFolder.Rows.Count > 0 Then
                            DefaultFolderSelected = True
                            Session.Item("searchCriteria").SearchViewCriteriaDefaultFolder = True
                            defaultFolderSelectedCheckBox.Checked = True
                            afolder_id = DefaultFolder.Rows(0).Item("cfolder_id")
                            airportDrop.Items.Add(New ListItem(IIf(Not IsDBNull(DefaultFolder.Rows(0).Item("cfolder_name")), DefaultFolder.Rows(0).Item("cfolder_name"), ""), DefaultFolder.Rows(0).Item("cfolder_id")))
                            searchAirportFolder.Items.Add(New ListItem(IIf(Not IsDBNull(DefaultFolder.Rows(0).Item("cfolder_name")), DefaultFolder.Rows(0).Item("cfolder_name"), ""), DefaultFolder.Rows(0).Item("cfolder_id")))
                            searchAirportFolder.SelectedValue = DefaultFolder.Rows(0).Item("cfolder_id")
                            airportDrop.SelectedValue = DefaultFolder.Rows(0).Item("cfolder_id")
                            selectAirportsType.SelectedValue = "4"
                            airportFolderToggleOnOff.Attributes.Clear()
                        End If
                    End If

                    DefaultFolder.Dispose()

                    If DefaultFolderSelected = False And clearAirportID = False Then
                        aport_id = util_functions.get_default_airport_id(searchCriteria, Session.Item("localPreferences").UserCompanyID, "City", 0)
                        If aport_id = 0 Then
                            aport_id = util_functions.get_default_airport_id(searchCriteria, Session.Item("localPreferences").UserCompanyID, "Radius", 25)
                        End If
                        If aport_id = 0 Then
                            aport_id = util_functions.get_default_airport_id(searchCriteria, Session.Item("localPreferences").UserCompanyID, "State", 0)
                        End If
                        If aport_id = 0 Then
                            aport_id = util_functions.get_default_airport_id(searchCriteria, Session.Item("localPreferences").UserCompanyID, "Country", 0)
                        End If
                        Session("Last_Aport_ID") = aport_id
                        Session.Item("searchCriteria").SearchViewCriteriaAirportSelected = aport_id
                        selectAirportID.Text = aport_id
                    End If
                End If
                'ElseIf Session("Last_Aport_ID") > 0 Then
                '  aport_id = Session("Last_Aport_ID")
                'ElseIf Session.Item("searchCriteria").SearchViewCriteriaAirportSelected > 1 And Session.Item("searchCriteria").SearchViewCriteriaAirportDropdown <> 4 Then
                '  aport_id = Session.Item("searchCriteria").SearchViewCriteriaAirportSelected
                'ElseIf Session.Item("searchCriteria").SearchViewCriteriaAirportDropdown = 4 Then
                '  'added in MSW = was erroring out cause it was blank, so put in 0 instead if not numeric
                '  If IsNumeric(searchAirportFolder.SelectedValue) Then
                '    afolder_id = searchAirportFolder.SelectedValue
                '  Else
                '    afolder_id = 0
                '  End If
            End If
        Else
            'If Session.Item("searchCriteria").SearchViewCriteriaAirportSelected > 1 And selectAirportsType.SelectedValue <> 1 Then
            '  aport_id = Session.Item("searchCriteria").SearchViewCriteriaAirportSelected
            'ElseIf selectAirportsType.SelectedValue = 2 Then
            '  'We need to recall this back. This is one of two things. It either comes from the query string or it's the default. Since the aport id is blank if we hit this
            '  'here, it's automatically the default.
            '  aport_id = util_functions.get_default_airport_id(searchCriteria, Session.Item("localPreferences").UserCompanyID, "City", 0)
            '  If aport_id = 0 Then
            '    aport_id = util_functions.get_default_airport_id(searchCriteria, Session.Item("localPreferences").UserCompanyID, "Radius", 25)
            '  End If
            '  If aport_id = 0 Then
            '    aport_id = util_functions.get_default_airport_id(searchCriteria, Session.Item("localPreferences").UserCompanyID, "State", 0)
            '  End If
            'Else
            '  aport_id = 0
            '  Session("Last_Aport_ID") = aport_id
            '  Session.Item("searchCriteria").SearchViewCriteriaAirportSelected = aport_id
            'End If
        End If


    End Sub

    Private Sub BuildUtilizationRequestVariables(ByRef clearCompany As Boolean, ByRef clearAirport As Boolean, ByRef temp_distance As Integer, ByRef recent_flight_months As Integer, ByRef DisplayFlight As Boolean, ByRef comp_id As Long, ByRef RollUpCompanies As Boolean, ByRef util_functions As utilization_functions, ByRef operator_list As String, ByRef SearchCriteria As viewSelectionCriteriaClass, ByRef aport_id As Long, ByRef ranThroughAirport As Boolean, ByRef acfolder_id As Long, ByRef afolder As Long, ByRef compFolder As Long)



        If Not IsNothing(Me.distance_drop) Then
            temp_distance = Me.distance_drop.SelectedValue
        End If


        If Not Page.IsPostBack Then

            ' If Trim(Request("distance")) <> "" Then
            '   temp_distance = Trim(Request("distance"))
            '  Else
            temp_distance = 150
            '  End If 


            'If Trim(Request("cdistance")) <> "" Then
            '  temp_distance_company = Trim(Request("cdistance"))
            'Else
            '  temp_distance_company = 25
            'End If

            If Trim(Request("recent")) <> "" Then
                recent_flight_months = Trim(Request("recent"))
                Me.fbo_months_drop.SelectedValue = recent_flight_months
            Else
                recent_flight_months = 3
            End If

            If Not IsNothing(Trim(Request("display_flight"))) Then
                If Not String.IsNullOrEmpty(Trim(Request("display_flight"))) Then
                    If Trim(Request("display_flight")) = "Y" Then
                        DisplayFlight = True
                        toggleFlightSummary.Checked = True
                    End If
                End If
            End If

            If Trim(Request("comp_id")) <> "" Then
                comp_id = Trim(Request("comp_id"))
                viewOperatorHiddenCompanyID.Text = comp_id
                If comp_id = 0 Then
                    clearCompany = True
                End If
                Session.Item("searchCriteria").SearchViewCriteriaOperatorDropdown2 = 0
                Session.Item("searchCriteria").SearchViewCriteriaOperatorSelected = comp_id
                Session.Item("searchCriteria").SearchViewCriteriaClearCompany = clearCompany
            End If


            'If Trim(Request("amod_id")) <> "" Then
            '  amod_id = Trim(Request("amod_id"))
            '  localCriteria.ViewCriteriaAmodID = amod_id
            'End If

            'If Trim(Request("cfolder")) <> "" Then
            '  cfolder_id = Trim(Request("cfolder"))
            'Else
            '  cfolder_id = 0
            'End If




            'If String.IsNullOrEmpty(searchAirportFolder.SelectedValue) Then
            '  If Trim(Request("afolder")) <> "" Then
            '    afolder_id = Trim(Request("afolder"))
            '  Else
            '    afolder_id = Session.Item("searchCriteria").SearchViewCriteriaAirportDropdown2
            '  End If
            'Else
            '  afolder_id = searchAirportFolder.SelectedValue
            'End If


            If Not String.IsNullOrEmpty(Trim(Request("aport_id"))) Then
                If IsNumeric(Trim(Request("aport_id"))) Then
                    aport_id = Trim(Request("aport_id"))
                    selectAirportID.Text = aport_id
                    If aport_id = 0 Then
                        clearAirport = True
                    End If
                    Session("Last_Aport_ID") = aport_id
                    Session.Item("searchCriteria").SearchViewCriteriaAirportDropdown2 = 0
                    Session.Item("searchCriteria").SearchViewCriteriaAirportSelected = aport_id
                    Session.Item("searchCriteria").SearchViewCriteriaClearAirport = clearAirport
                End If
            End If

            If Trim(Request("acfolder")) <> "" Then
                Session.Item("searchCriteria").SearchViewCriteriaAirportDropdown = 1
                afolder = 0
                acfolder_id = Trim(Request("acfolder"))
                Session.Item("searchCriteria").SearchViewCriteriaAircraftDropdown = 4
                Session.Item("searchCriteria").SearchViewCriteriaAircraftDropdown2 = acfolder_id

                If Trim(Request("acfoldername")) <> "" Then
                    Session.Item("searchCriteria").SearchViewCriteriaAircraftFolderName = Trim(Request("acfoldername"))
                End If
            End If

            If Trim(Request("opfolder")) <> "" Then
                '        Session.Item("searchCriteria").SearchViewCriteriaOperatorDropdown:0
                'Session.Item("searchCriteria").SearchViewCriteriaOperatorSelected:0
                'Session.Item("searchCriteria").SearchViewCriteriaOperatorDropdown2:0
                '        Session.Item("searchCriteria").SearchViewCriteriaOperatorFolderName()


                comp_id = 0
                compFolder = Trim(Request("opfolder"))
                Session.Item("searchCriteria").SearchViewCriteriaOperatorDropdown = 4
                Session.Item("searchCriteria").SearchViewCriteriaOperatorDropdown2 = compFolder

                If Trim(Request("opfoldername")) <> "" Then
                    Session.Item("searchCriteria").SearchViewCriteriaOperatorFolderName = Trim(Request("opfoldername"))
                End If
            End If

            'If Trim(Request("activetab")) <> "" Then
            '  active_tab = CDbl(Trim(Request("activetab")))
            '  TabContainer1.ActiveTabIndex = active_tab
            'End If

            'If Trim(Request("top_active_tab")) <> "" Then
            '  tabs_container.ActiveTabIndex = CInt(Request("top_active_tab"))
            'Else
            '  If tabs_container.ActiveTabIndex <> 0 Then
            '    active_tab_top = tabs_container.ActiveTabIndex
            '  End If
            'End If


        End If
        'If Not IsNothing(Trim(Request("roll"))) Then
        '  If Trim(Request("roll")) = "true" Then
        '    If comp_id > 0 Then

        '  End If
        'End If
    End Sub

    Private Sub FillUtilizationDropdowns(ByRef util_functions As utilization_functions, ByVal operator_list As String)
        If Not Page.IsPostBack Then

            Dim Airport_Table As New DataTable
            'Newly added for Aircraft
            Airport_Table = util_functions.get_all_client_folder("Aircraft")
            If Not IsNothing(Airport_Table) Then
                If Airport_Table.Rows.Count > 0 Then
                    For Each r As DataRow In Airport_Table.Rows
                        airportAircraftFolder.Items.Add(New System.Web.UI.WebControls.ListItem(r("cfolder_name"), r("cfolder_id")))
                    Next
                End If
            End If

            Airport_Table.Clear()
            Airport_Table = util_functions.get_all_client_folder("Company")
            'operator_list = ""
            If Not IsNothing(Airport_Table) Then
                If Airport_Table.Rows.Count > 0 Then
                    For Each r As DataRow In Airport_Table.Rows
                        '   operator_drop2.Items.Add(New System.Web.UI.WebControls.ListItem(r("cfolder_name"), r("cfolder_id")))
                        airportOperatorFolder.Items.Add(New System.Web.UI.WebControls.ListItem(r("cfolder_name"), r("cfolder_id")))
                        ' utilizationViewDropDown.Items.Add(New System.Web.UI.WebControls.ListItem(r("cfolder_name"), r("cfolder_id")))
                    Next
                End If
            End If

            Airport_Table.Clear()

            Airport_Table = util_functions.get_all_client_folder("Airport")
            If Not IsNothing(Airport_Table) Then
                If Airport_Table.Rows.Count > 0 Then
                    airportDrop.Items.Add(New System.Web.UI.WebControls.ListItem("Please Pick One", ""))
                    For Each r As DataRow In Airport_Table.Rows
                        airportDrop.Items.Add(New System.Web.UI.WebControls.ListItem(r("cfolder_name"), r("cfolder_id")))
                        searchAirportFolder.Items.Add(New System.Web.UI.WebControls.ListItem(r("cfolder_name"), r("cfolder_id")))
                    Next
                End If
            End If
            Airport_Table.Clear()

            operator_drop2.SelectedValue = "U"
            utilizationViewDropDown.SelectedValue = "U" ' added MSW - for util view so that it defaults as well 

        Else

            If operator_list <> "" Then
                If Not IsNothing(operator_drop2.Items(1)) And Not IsNothing(operator_drop2.Items(0)) Then
                    If Not IsNothing(utilizationViewDropDown.Items(0)) And Not IsNothing(utilizationViewDropDown.Items(0)) Then
                        If Not IsNothing(selectAirportsType.Items.FindByValue("2")) Then
                            operator_drop2.Items(1).Text = "All Operators utilizing " & selectAirportsType.Items.FindByValue("2").Text
                            utilizationViewDropDown.Items(1).Text = operator_drop2.Items(1).Text
                            operator_drop2.Items(0).Text = "All Operators based at " & selectAirportsType.Items.FindByValue("2").Text
                            utilizationViewDropDown.Items(0).Text = operator_drop2.Items(0).Text
                        End If
                    End If
                End If
            Else
                If Not IsNothing(operator_drop2.Items(1)) And Not IsNothing(operator_drop2.Items(0)) Then
                    If Not IsNothing(utilizationViewDropDown.Items(0)) And Not IsNothing(utilizationViewDropDown.Items(0)) Then

                        If utilizationViewDropDown.Items.Count = 0 Then
                            utilizationViewDropDown.Items.Clear()
                            utilizationViewDropDown.Items.Add(New System.Web.UI.WebControls.ListItem("Operators Utilizing Airport", "U"))
                            utilizationViewDropDown.Items.Add(New System.Web.UI.WebControls.ListItem("Operators Based at Airport", "B"))
                            utilizationViewDropDown.Items.Add(New System.Web.UI.WebControls.ListItem("Operators Not-Based at Airports", "N"))
                        End If
                        operator_drop2.Items(1).Text = "All Operators utilizing this Airport"
                        'utilizationViewDropDown.Items(1).Text = "All Operators utilizing this Airport"
                        operator_drop2.Items(0).Text = "All Operators based at this Airport"
                        '  utilizationViewDropDown.Items(0).Text = "All Operators based at this Airport"
                    End If
                End If
            End If

        End If


        'If IsNumeric(airportOperatorFolder.SelectedValue) Then
        '  operator_drop2.SelectedValue = airportOperatorFolder.SelectedValue
        '  utilizationViewDropDown.SelectedValue = airportOperatorFolder.SelectedValue
        'End If


        'If IsNumeric(searchAirportFolder.SelectedValue) Then
        '  airportDrop.SelectedValue = searchAirportFolder.SelectedValue
        'End If

        If Not Page.IsPostBack Then
            Me.owner_drop.Visible = True
            owner_drop.Items.Clear()
            owner_drop.Items.Add(New System.Web.UI.WebControls.ListItem("Aircraft Based at this Airport", "F"))
            owner_drop.Items.Add(New System.Web.UI.WebControls.ListItem("Aircraft Utilizing this Airport", ""))
            owner_drop.Items.Add(New System.Web.UI.WebControls.ListItem("Transient Aircraft Utilizing this Airport", "T"))
            owner_drop.SelectedValue = ""
        End If

    End Sub

    Public Shared Function BuildTable(ByVal paging As Boolean, ByVal pagingNumber As Integer, ByVal columnList As String) As String
        Dim tableBuild As New StringBuilder
        Dim footerBuild As New StringBuilder
        Dim bottomNumber As Integer = 6
        Dim topNumber As Integer = 8

        footerBuild.Append("""footerCallback"": function ( row, data, start, end, display ) {")
        footerBuild.Append("var api = this.api(), data;")

        '// Remove the formatting to get integer data for summation
        footerBuild.Append("var intVal = function ( i ) {")
        footerBuild.Append("return typeof i === 'string' ?")
        footerBuild.Append("i.replace(/[\$,]/g, '').replace(/<[^>]+>/ig,'')*1 :")
        footerBuild.Append("typeof i === 'number' ?")
        footerBuild.Append("i : 0;")
        footerBuild.Append("};")

        'Let's build the total string:

        '// Total over all pages
        Dim TotalSorting As New StringBuilder

        For x = bottomNumber To topNumber
            TotalSorting.Append("total = api")
            TotalSorting.Append(".column(" & x & ")")
            TotalSorting.Append(".data()")
            TotalSorting.Append(".reduce( function (a, b) {")
            TotalSorting.Append("return intVal(a) + intVal(b);")
            TotalSorting.Append("}, 0 );")

            '// Update footer
            TotalSorting.Append("if (Math.round(total) !== total) {")
            TotalSorting.Append("total = total.toFixed(2);")
            TotalSorting.Append("}")

            TotalSorting.Append("$( api.column(" & x & ").footer() ).html('<span>' + ")
            TotalSorting.Append("total.toLocaleString('en')")

            TotalSorting.Append("+ '</span>');")
        Next

        TotalSorting.Append("$( api.column(" & 0 & ").footer() ).html(")
        TotalSorting.Append("'Totals:'")
        TotalSorting.Append(");")

        footerBuild.Append(TotalSorting.ToString)
        footerBuild.Append("},")

        tableBuild.Append("var cw = $('.MaxWidthRemove').width() - 60;")
        tableBuild.Append("$("".specialTableContainer"").width(cw);")

        tableBuild.Append("$(window).resize(function() {")
        tableBuild.Append("var cw = $('.MaxWidthRemove').width() - 60;")
        tableBuild.Append("$("".specialTableContainer"").width(cw);")
        tableBuild.Append("});")


        tableBuild.Append("var hideFromExport = [12];")


        tableBuild.Append("function buildFlightTable() { var table = $('#flightData').DataTable({destroy:true, ")
        If paging Then
            tableBuild.Append(" paging: true, pageLength: " & pagingNumber.ToString & ",")
        End If
        tableBuild.Append("scroller:true, stateSave: true,")
        tableBuild.Append("deferRender: true, ")
        tableBuild.Append("""drawCallback"": function(settings, json) {")
        tableBuild.Append("setTimeout(function(){")
        tableBuild.Append("setUpLinks('#flightData td a');")
        tableBuild.Append("},100)")
        tableBuild.Append("},")


        tableBuild.Append("data: flightsDataSet, ")
        tableBuild.Append("columns: [ ")
        tableBuild.Append(columnList)
        tableBuild.Append("],")
        tableBuild.Append("dom:        'Bfitrp',")
        tableBuild.Append("scrollY:      500, ")
        tableBuild.Append("scrollX:        cw, ")
        tableBuild.Append("scrollCollapse: false, ")

        tableBuild.Append("""columnDefs"": [ ")
        tableBuild.Append(" {")
        tableBuild.Append("orderable: false,")
        tableBuild.Append("className:  'select-checkbox',")
        tableBuild.Append(" width: '10px',")
        tableBuild.Append("targets:   0")
        tableBuild.Append(" }")
        tableBuild.Append(" ],")
        tableBuild.Append("select: {")
        tableBuild.Append("style:    'multi',")
        tableBuild.Append("selector: 'td:first-child'")
        tableBuild.Append("},")

        ' tableBuild.Append("scroller:       true, ")
        tableBuild.Append(footerBuild)
        tableBuild.Append("buttons: [ ")
        tableBuild.Append(BuildButtonString("buildFlightTable"))
        tableBuild.Append("]")

        'Remove Selected Button:


        tableBuild.Append("});")
        tableBuild.Append("}; buildFlightTable();")
        'tableBuild.Append("$('#flightData').DataTable({destroy:true,")
        'If paging Then
        '  tableBuild.Append(" paging: true, pageLength: " & pagingNumber.ToString & ",")
        'Else
        '  tableBuild.Append(" paging: true,")
        'End If
        'tableBuild.Append("scroller:true,")
        'tableBuild.Append("deferRender: true, ")
        'tableBuild.Append("""drawCallback"": function(settings, json) {")
        'tableBuild.Append("setTimeout(function(){")
        'tableBuild.Append("setUpLinks('#flightData td a');")
        'tableBuild.Append("},100)")
        'tableBuild.Append("},")

        'tableBuild.Append("data: flightsDataSet, ")
        'tableBuild.Append("columns: [ ")
        'tableBuild.Append(columnList)
        'tableBuild.Append("],")
        'tableBuild.Append("""columnDefs"": [ ")
        'tableBuild.Append(" {")
        'tableBuild.Append("orderable: false,")
        'tableBuild.Append("className:  'select-checkbox',")
        'tableBuild.Append(" width: '10px',")
        'tableBuild.Append("targets:   0")
        'tableBuild.Append(" }")
        'tableBuild.Append(" ],")
        'tableBuild.Append("select: {")
        'tableBuild.Append("style:    'multi',")
        'tableBuild.Append("selector: 'td:first-child'")
        'tableBuild.Append("},")

        'tableBuild.Append("dom:        'Bfitrp',")
        'tableBuild.Append("scrollY:        530, ")
        'tableBuild.Append("scrollX:        cw, ")
        'tableBuild.Append("scrollCollapse: true, ")
        '' tableBuild.Append("scroller:       true, ")
        'tableBuild.Append(footerBuild)
        'tableBuild.Append(BuildButtonString("buildFlightTable();"))
        ''Remove Selected Button:
        'tableBuild.Append("});")


        Return tableBuild.ToString
    End Function
    Public Sub Build_Airports_Tab(ByVal headerString As String, ByVal ExportFlights As Boolean, ByVal business_type As String, ByRef recent_flight_months As Long, ByRef airport_fbo_functions As airport_fbo_view_functions, ByRef location_name As String, ByRef product_link As String, ByVal AirportData As DataTable, ByRef temp_distance_company As Long, ByRef orig_lat As Double, ByRef orig_long As Double, ByRef temp_distance As Long, ByVal active_tab As Integer, ByRef searchCriteria As viewSelectionCriteriaClass, ByRef this_section_string As String, ByVal product_code_selection As String, ByRef table_count As Long, ByRef TotalFlights As Long, ByVal cfolder_id As Long, ByVal aport_id As Long, ByVal operator_list As String, ByVal airport_list As String, ByVal isAircraftSearch As Boolean, ByRef util_functions As utilization_functions, ByRef NoAirportNoOperator As Boolean, ByRef is_located_here As Boolean, ByVal basedAtAirport As Boolean)
        If isAircraftSearch = True Then
            this_section_string = Session("Last_FBO_Bottom_Text")
        Else
            Call util_functions.MostCommonOriginsJSArray(searchCriteria, this_section_string, product_code_selection, table_count, True, True, TotalFlights, "", "", "", 0, "Airports")
        End If
        ' Me.operator_drop2.Visible = False
        acStartTableColspan.Attributes.Remove("colspan")
        acStartTableToggleOff.Attributes.Remove("colspan")

        If Trim(airport_direction) = "X" Then
            acStartTableColspan.Attributes.Add("colspan", "11")
            acStartTableToggleOff.Attributes.Add("colspan", "0")

            acStartTableToggleOff.Visible = False
        Else
            acStartTableColspan.Attributes.Add("colspan", "8")
            acStartTableToggleOff.Attributes.Add("colspan", "0")
            acStartTableToggleOff.Visible = False
        End If



        BuildOnLoadJavascript(this_section_string, BuildOperatorDataTableJS(this_section_string, "createOriginTable", "startTableOper", "mostCommonOriginsDataset", 2, False, TotalFlights, IIf(cfolder_id > 0 Or aport_id > 0, True, False), operator_list, airport_list, "", "Airports"))

    End Sub
    Public Sub Build_Operators_Tab(ByVal headerString As String, ByVal ExportFlights As Boolean, ByVal business_type As String, ByRef recent_flight_months As Long, ByRef airport_fbo_functions As airport_fbo_view_functions, ByRef location_name As String, ByRef product_link As String, ByVal AirportData As DataTable, ByRef temp_distance_company As Long, ByRef orig_lat As Double, ByRef orig_long As Double, ByRef temp_distance As Long, ByVal active_tab As Integer, ByRef searchCriteria As viewSelectionCriteriaClass, ByRef this_section_string As String, ByVal product_code_selection As String, ByRef table_count As Long, ByRef TotalFlights As Long, ByVal cfolder_id As Long, ByVal aport_id As Long, ByVal operator_list As String, ByVal airport_list As String, ByVal isAircraftSearch As Boolean, ByRef util_functions As utilization_functions, ByRef NoAirportNoOperator As Boolean, ByRef is_located_here As Boolean, ByVal basedAtAirport As Boolean)
        If isAircraftSearch = True Then
            this_section_string = Session("Last_FBO_Bottom_Text")
        Else
            Call util_functions.Build_Operators_Array(searchCriteria, "view", IIf(Not String.IsNullOrEmpty(airport_list), 0, aport_id), this_section_string, Me.utilizationViewDropDown.SelectedValue, table_count, TotalFlights, "", "")
        End If
        acStartTableColspan.Attributes.Remove("colspan")
        acStartTableColspan.Attributes.Add("colspan", "5")
        acStartTableToggleOff.Visible = True
        BuildOnLoadJavascript(this_section_string, BuildOperatorDataTableJS(this_section_string, "createOperatorTable", "startTableOper3", "currentDataSet", 1, False, TotalFlights, IIf(cfolder_id > 0 Or aport_id > 0, True, False), operator_list, airport_list, "", "Operators"))

    End Sub

    Public Sub Build_Aircraft_Model_Tab(ByVal headerString As String, ByVal ExportFlights As Boolean, ByVal business_type As String, ByRef recent_flight_months As Long, ByRef airport_fbo_functions As airport_fbo_view_functions, ByRef location_name As String, ByRef product_link As String, ByVal AirportData As DataTable, ByRef temp_distance_company As Long, ByRef orig_lat As Double, ByRef orig_long As Double, ByRef temp_distance As Long, ByVal active_tab As Integer, ByRef searchCriteria As viewSelectionCriteriaClass, ByRef this_section_string As String, ByVal product_code_selection As String, ByRef table_count As Long, ByRef TotalFlights As Long, ByVal cfolder_id As Long, ByVal aport_id As Long, ByVal operator_list As String, ByVal airport_list As String, ByVal isAircraftSearch As Boolean, ByRef util_functions As utilization_functions, ByRef NoAirportNoOperator As Boolean, ByRef is_located_here As Boolean, ByVal basedAtAirport As Boolean)

        this_section_string = ""
        If isAircraftSearch = True Then
            this_section_string = Session("Last_FBO_Bottom_Text")
        Else
            Call util_functions.FlightActivityArrayByModel(searchCriteria, this_section_string, product_code_selection, "view", TotalFlights, "", "")
        End If
        BuildOnLoadJavascript(this_section_string, BuildOperatorDataTableJS(this_section_string, "createJsModelTable", "modelData", "modelDataSet", 3, False, TotalFlights, IIf(cfolder_id > 0 Or aport_id > 0, True, False), operator_list, airport_list, "", "Models"))

    End Sub
    Public Sub Build_Routes_Tab(ByVal headerString As String, ByVal ExportFlights As Boolean, ByVal business_type As String, ByRef recent_flight_months As Long, ByRef airport_fbo_functions As airport_fbo_view_functions, ByRef location_name As String, ByRef product_link As String, ByVal AirportData As DataTable, ByRef temp_distance_company As Long, ByRef orig_lat As Double, ByRef orig_long As Double, ByRef temp_distance As Long, ByVal active_tab As Integer, ByRef searchCriteria As viewSelectionCriteriaClass, ByRef this_section_string As String, ByVal product_code_selection As String, ByRef table_count As Long, ByRef TotalFlights As Long, ByVal cfolder_id As Long, ByVal aport_id As Long, ByVal operator_list As String, ByVal airport_list As String, ByVal isAircraftSearch As Boolean, ByRef util_functions As utilization_functions, ByRef NoAirportNoOperator As Boolean, ByRef is_located_here As Boolean, ByVal basedAtAirport As Boolean)
        this_section_string = ""
        Dim only_one As Boolean = False

        'Call util_functions.get_most_common_origins_top_function(searchCriteria, this_section_string, product_code_selection, table_count)
        If isAircraftSearch = True Then
            'this_section_string = Session("Last_FBO_Bottom_Text")
        Else
            util_functions.MostCommonOriginsJSArray(searchCriteria, this_section_string, product_code_selection, table_count, False, False, TotalFlights, "", "", "", limited_routes, "Routes", sSelectedProductCode_to_Pass, Selection_Count, False, only_one)
        End If

        If InStr(this_section_string, """iata"":") > 0 Then
            BuildOnLoadJavascript(this_section_string, BuildOperatorDataTableJS(this_section_string, "createOriginTable", "mostCommonOrigins", "mostCommonOriginsDataset", 2, False, TotalFlights, IIf(cfolder_id > 0 Or aport_id > 0, True, False), operator_list, airport_list, "", "Routes", only_one))
        Else
            originTableColspan.Attributes.Remove("colspan")
            If InStr(this_section_string, """destination"":") > 0 Then
                originTableColspan.Attributes.Add("colspan", "9")
            Else
                originTableColspan.Attributes.Add("colspan", "5")
            End If
            BuildOnLoadJavascript(this_section_string, BuildOperatorDataTableJS(this_section_string, "createOriginTable", IIf(InStr(this_section_string, """destination"":") > 0, "mostCommonOriginsDestinations", "mostCommonOrigins2"), "mostCommonOriginsDataset", 2, True, TotalFlights, IIf(cfolder_id > 0 Or aport_id > 0, True, False), operator_list, airport_list, "", "Routes", only_one))
        End If
    End Sub

    Public Sub Build_Flights_Tab(ByVal headerString As String, ByVal ExportFlights As Boolean, ByVal business_type As String, ByRef recent_flight_months As Long, ByRef airport_fbo_functions As airport_fbo_view_functions, ByRef location_name As String, ByRef product_link As String, ByVal AirportData As DataTable, ByRef temp_distance_company As Long, ByRef orig_lat As Double, ByRef orig_long As Double, ByRef temp_distance As Long, ByVal active_tab As Integer, ByRef searchCriteria As viewSelectionCriteriaClass, ByRef this_section_string As String, ByVal product_code_selection As String, ByRef table_count As Long, ByRef TotalFlights As Long, ByVal cfolder_id As Long, ByVal aport_id As Long, ByVal operator_list As String, ByVal airport_list As String, ByVal isAircraftSearch As Boolean, ByRef util_functions As utilization_functions, ByRef NoAirportNoOperator As Boolean, ByRef is_located_here As Boolean, ByVal basedAtAirport As Boolean)
        Dim columnList As String = ""
        view_news_label1.Text = ""
        view_news_label1.Visible = True
        If NoAirportNoOperator Then
            view_news_label1.Text = "Please pick an operator, airport or folders to run this tab."
        Else
            this_section_string = ""

            If isAircraftSearch = True Then
                this_section_string = Session("Last_FBO_Bottom_Text")
            Else
                Call util_functions.FlightJSArray(searchCriteria, this_section_string, location_name, Trim(Request("export")), Me.compare_view_current_label.Text, Me.compare_view_current_label2.Text, Me.ac_projects_ddl.SelectedValue, recent_flight_months, IIf(String.IsNullOrEmpty(localCriteria.ViewCriteriaDocumentsStartDate), start_date.Text, localCriteria.ViewCriteriaDocumentsStartDate), IIf(String.IsNullOrEmpty(localCriteria.ViewCriteriaDocumentsEndDate), end_date.Text, localCriteria.ViewCriteriaDocumentsEndDate), product_code_selection, product_link, table_count, "view", "", columnList)  ' TONS OF FIELDS
            End If
            ' flightDataLabel.Text = Replace(this_section_string, "class=""formatTable blue""", "class=""refreshable""")
            'BuildOnLoadJavascript(this_section_string, "")

            System.Web.UI.ScriptManager.RegisterClientScriptBlock(Me.bottom_tab_update_panel, Me.GetType(), "flightTableBuild", this_section_string + ";" + BuildTable(False, 0, columnList).ToString, True)
        End If


    End Sub
    Public Sub Build_Refuel_Tab(ByVal headerString As String, ByVal ExportFlights As Boolean, ByVal business_type As String, ByRef recent_flight_months As Long, ByRef airport_fbo_functions As airport_fbo_view_functions, ByRef location_name As String, ByRef product_link As String, ByVal AirportData As DataTable, ByRef temp_distance_company As Long, ByRef orig_lat As Double, ByRef orig_long As Double, ByRef temp_distance As Long, ByVal active_tab As Integer, ByRef searchCriteria As viewSelectionCriteriaClass, ByRef this_section_string As String, ByVal product_code_selection As String, ByRef table_count As Long, ByRef TotalFlights As Long, ByVal cfolder_id As Long, ByVal aport_id As Long, ByVal operator_list As String, ByVal airport_list As String, ByVal isAircraftSearch As Boolean, ByRef util_functions As utilization_functions, ByRef NoAirportNoOperator As Boolean, ByRef is_located_here As Boolean, ByVal basedAtAirport As Boolean)
        Utilization_Build_Summaries(util_functions, searchCriteria, product_code_selection, TotalFlights)
    End Sub
    Public Sub Build_Aircraft_Tab(ByVal headerString As String, ByVal ExportFlights As Boolean, ByVal business_type As String, ByRef recent_flight_months As Long, ByRef airport_fbo_functions As airport_fbo_view_functions, ByRef location_name As String, ByRef product_link As String, ByVal AirportData As DataTable, ByRef temp_distance_company As Long, ByRef orig_lat As Double, ByRef orig_long As Double, ByRef temp_distance As Long, ByVal active_tab As Integer, ByRef searchCriteria As viewSelectionCriteriaClass, ByRef this_section_string As String, ByVal product_code_selection As String, ByRef table_count As Long, ByRef TotalFlights As Long, ByVal cfolder_id As Long, ByVal aport_id As Long, ByVal operator_list As String, ByVal airport_list As String, ByVal isAircraftSearch As Boolean, ByRef util_functions As utilization_functions, ByRef NoAirportNoOperator As Boolean, ByRef is_located_here As Boolean, ByVal basedAtAirport As Boolean)
        view_events_label.Text = ""
        view_events_label.Visible = True
        If NoAirportNoOperator Then
            'This can't run.
            view_events_label.Text = "Please pick an operator, airport or folders to run this tab."
        Else


            If isAircraftSearch = True Then
                this_section_string = Session("Last_FBO_Bottom_Text")
            Else
                If owner_drop.SelectedValue = "T" Then
                    Call util_functions.FlightActivityJSArray(searchCriteria, this_section_string, True, product_code_selection, TotalFlights, "", "", "", basedAtAirport, aport_id, "Y")
                Else
                    Call util_functions.FlightActivityJSArray(searchCriteria, this_section_string, is_located_here, product_code_selection, TotalFlights, "", "", "", basedAtAirport, aport_id, "Y")
                End If

            End If

            'Call util_functions.FlightActivityJSArray(searchCriteria, this_section_string, is_located_here, product_code_selection, TotalFlights)
            'Me.view_events_label.Text = this_section_string

            If basedAtAirport And (aport_id > 1 Or Trim(airport_list) <> "") Then
                BuildOnLoadJavascript(this_section_string, BuildOperatorDataTableJS(this_section_string, "createJsACTable", "acData", "acDataSet", 44, False, TotalFlights, IIf(cfolder_id > 0 Or aport_id > 0, True, False), operator_list, airport_list, "", "Aircraft"))
            Else
                BuildOnLoadJavascript(this_section_string, BuildOperatorDataTableJS(this_section_string, "createJsACTable", "acData", "acDataSet", 4, False, TotalFlights, IIf(cfolder_id > 0 Or aport_id > 0, True, False), operator_list, airport_list, "", "Aircraft"))
            End If


        End If
        Session("Last_FBO_Bottom") = 3
        Session("Last_FBO_Bottom_Text") = this_section_string
    End Sub
    Public Sub Build_Company_Directory_Tab(ByVal headerString As String, ByVal ExportFlights As Boolean, ByVal business_type As String, ByRef recent_flight_months As Long, ByRef airport_fbo_functions As airport_fbo_view_functions, ByRef location_name As String, ByRef product_link As String, ByVal AirportData As DataTable, ByRef temp_distance_company As Long, ByRef orig_lat As Double, ByRef orig_long As Double, ByRef temp_distance As Long, ByVal active_tab As Integer, ByRef searchCriteria As viewSelectionCriteriaClass, ByRef this_section_string As String, ByVal product_code_selection As String, ByRef table_count As Long, ByRef TotalFlights As Long, ByVal cfolder_id As Long, ByVal aport_id As Long, ByVal operator_list As String, ByVal airport_list As String, ByVal isAircraftSearch As Boolean, ByRef util_functions As utilization_functions, ByRef NoAirportNoOperator As Boolean, ByRef is_located_here As Boolean, ByVal basedAtAirport As Boolean)
        '---------------------------------------------------
        '-- ***************  LOWER TAB 3 - COMPANY DIRECTORY ************************
        '-- SELECT A LIST OF COMPANIES LOCATED AT SPECIFIC AIRPORT OR SAME CITY  

        If searchCriteria.ViewCriteriaCountry = "United States" Then
            Me.ac_projects_ddl2_19.Visible = True
            Me.compare_view_sold_label_19.Visible = True
            Me.company_range_19.Visible = True
            Me.compare_view_sold_label2_19.Visible = True
        Else
            Me.ac_projects_ddl2_19.Visible = True  ' BUSINESS TYPE DROPDOWN  - MADE VISIBLE - MSW - 2/27
            Me.compare_view_sold_label_19.Visible = True   ' VIEW IN GRID AND EXPORT COMPANIES LINKS - MADE VISIBLE - MSW - 2/27
            Me.company_range_19.Visible = False
            Me.compare_view_sold_label2_19.Visible = True
        End If

        this_section_string = ""
        Call airport_fbo_functions.get_companies_in_city_top_function(searchCriteria, this_section_string, location_name, business_type, Me.compare_view_sold_label_19.Text, Trim(Request("export")), aport_id, temp_distance_company, orig_lat, orig_long, Me.compare_view_sold_label2_19.Text)

        If searchCriteria.ViewCriteriaCountry <> "United States" Then
            Me.compare_view_sold_label2_19.Text = "Companies Located at " & searchCriteria.ViewCriteriaCity & ", " & searchCriteria.ViewCriteriaCountry
        End If

        Me.panel_19_label.Text = this_section_string
    End Sub
    Public Sub Build_Owners_Tab(ByVal headerString As String, ByVal ExportFlights As Boolean, ByVal business_type As String, ByRef recent_flight_months As Long, ByRef airport_fbo_functions As airport_fbo_view_functions, ByRef location_name As String, ByRef product_link As String, ByVal AirportData As DataTable, ByRef temp_distance_company As Long, ByRef orig_lat As Double, ByRef orig_long As Double, ByRef temp_distance As Long, ByVal active_tab As Integer, ByRef searchCriteria As viewSelectionCriteriaClass, ByRef this_section_string As String, ByVal product_code_selection As String, ByRef table_count As Long, ByRef TotalFlights As Long, ByVal cfolder_id As Long, ByVal aport_id As Long, ByVal operator_list As String, ByVal airport_list As String, ByVal isAircraftSearch As Boolean, ByRef util_functions As utilization_functions, ByRef NoAirportNoOperator As Boolean, ByRef is_located_here As Boolean, ByVal basedAtAirport As Boolean)
        '--------------------------------------------------------------------------
        '-- ***************  LOWER TAB 4 - OWNERS ************************
        '-- SELECT A LIST OF COMPANIES OWNING AIRCRAFT AT SPECIFIC AIRPORT  
        airport_fbo_functions.Airport_ID_OVERALL = aport_id
        this_section_string = ""

        If IsPostBack = False And Trim(Request("export")) <> "" Then
            If Trim(Request("export")) <> "" And Trim(Request("export")) <> "OW" Then
                Call airport_fbo_functions.get_companies_from_airport_top_function(searchCriteria, this_section_string, location_name, "Owner", Trim(Request("export")), aport_id, Me.check_owner_ac.Checked) ' TONS OF FIELDS
            Else
                Call airport_fbo_functions.get_most_recent_flight_activity_companies_top_function(searchCriteria, this_section_string, location_name, Trim(Request("export")), Me.compare_view_current_label.Text, Me.compare_view_current_label2.Text, Me.ac_projects_ddl.SelectedValue, recent_flight_months, "00", Me.check_owner_ac.Checked, start_date.Text, end_date.Text, product_code_selection)  ' TONS OF FIELDS
            End If
        Else

            If searchCriteria.ViewCriteriaGetOperator > 0 Then
                If owner_drop.SelectedValue = "" Then
                    Call airport_fbo_functions.get_companies_from_airport_top_function(searchCriteria, this_section_string, location_name, "Owner", Trim(Request("export")), aport_id, Me.check_owner_ac.Checked) ' TONS OF FIELDS
                Else
                    Call airport_fbo_functions.get_most_recent_flight_activity_companies_top_function(searchCriteria, this_section_string, location_name, Trim(Request("export")), Me.compare_view_current_label.Text, Me.compare_view_current_label2.Text, Me.ac_projects_ddl.SelectedValue, recent_flight_months, "00", Me.check_owner_ac.Checked, start_date.Text, end_date.Text, product_code_selection)  ' TONS OF FIELDS
                End If
            Else
                Call airport_fbo_functions.get_most_recent_flight_activity_companies_top_function(searchCriteria, this_section_string, location_name, Trim(Request("export")), Me.compare_view_current_label.Text, Me.compare_view_current_label2.Text, Me.ac_projects_ddl.SelectedValue, recent_flight_months, "00", Me.check_owner_ac.Checked, start_date.Text, end_date.Text, product_code_selection)  ' TONS OF FIELDS
            End If


        End If

        Me.panel_20_label.Text = this_section_string
        '--------------------------------------------------------------------------
    End Sub
    Public Sub Build_Reports_Tab(ByVal headerString As String, ByVal ExportFlights As Boolean, ByVal business_type As String, ByRef recent_flight_months As Long, ByRef airport_fbo_functions As airport_fbo_view_functions, ByRef location_name As String, ByRef product_link As String, ByVal AirportData As DataTable, ByRef temp_distance_company As Long, ByRef orig_lat As Double, ByRef orig_long As Double, ByRef temp_distance As Long, ByVal active_tab As Integer, ByRef searchCriteria As viewSelectionCriteriaClass, ByRef this_section_string As String, ByVal product_code_selection As String, ByRef table_count As Long, ByRef TotalFlights As Long, ByVal cfolder_id As Long, ByVal aport_id As Long, ByVal operator_list As String, ByVal airport_list As String, ByVal isAircraftSearch As Boolean, ByRef util_functions As utilization_functions, ByRef NoAirportNoOperator As Boolean, ByRef is_located_here As Boolean, ByVal basedAtAirport As Boolean)
        Utilization_Build_Reports(util_functions, searchCriteria, product_code_selection, TotalFlights)
    End Sub
    Public Sub Build_Flight_Summary_Tab(ByVal headerString As String, ByVal ExportFlights As Boolean, ByVal business_type As String, ByRef recent_flight_months As Long, ByRef airport_fbo_functions As airport_fbo_view_functions, ByRef location_name As String, ByRef product_link As String, ByVal AirportData As DataTable, ByRef temp_distance_company As Long, ByRef orig_lat As Double, ByRef orig_long As Double, ByRef temp_distance As Long, ByVal active_tab As Integer, ByRef searchCriteria As viewSelectionCriteriaClass, ByRef this_section_string As String, ByVal product_code_selection As String, ByRef table_count As Long, ByRef TotalFlights As Long, ByVal cfolder_id As Long, ByVal aport_id As Long, ByVal operator_list As String, ByVal airport_list As String, ByVal isAircraftSearch As Boolean, ByRef util_functions As utilization_functions, ByRef NoAirportNoOperator As Boolean, ByRef is_located_here As Boolean, ByVal basedAtAirport As Boolean)
        ' done seperately ?  
    End Sub
    Public Sub Build_Nearby_tab(ByVal headerString As String, ByVal ExportFlights As Boolean, ByVal business_type As String, ByRef recent_flight_months As Long, ByRef airport_fbo_functions As airport_fbo_view_functions, ByRef location_name As String, ByRef product_link As String, ByVal AirportData As DataTable, ByRef temp_distance_company As Long, ByRef orig_lat As Double, ByRef orig_long As Double, ByRef temp_distance As Long, ByVal active_tab As Integer, ByRef searchCriteria As viewSelectionCriteriaClass, ByRef this_section_string As String, ByVal product_code_selection As String, ByRef table_count As Long, ByRef TotalFlights As Long, ByVal cfolder_id As Long, ByVal aport_id As Long, ByVal operator_list As String, ByVal airport_list As String, ByVal isAircraftSearch As Boolean, ByRef util_functions As utilization_functions, ByRef NoAirportNoOperator As Boolean, ByRef is_located_here As Boolean, ByVal basedAtAirport As Boolean)
        System.Web.UI.ScriptManager.RegisterStartupScript(Me.airportsSearchUpdate, Me.GetType(), "fixLinks", "setUpLinks('.rightside #fractionsExpiringDataTable a')", True)

        airport_fbo_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
        airport_fbo_functions.Airport_ID_OVERALL = aport_id

        AirportData = localDatalayer.get_range_airports_by_IATA_or_ICAO(localCriteria, aport_id)
        Call localDatalayer.get_airport_information(AirportData, "", localCriteria, location_name, orig_lat, orig_long)

        this_section_string = ""
        Call airport_fbo_functions.get_nearby_airports_top_function(searchCriteria, this_section_string, temp_distance, orig_lat, orig_long, business_type, aport_id, Me.controlled.Checked, UpdateProgress1, "util_view")
        Me.nearby_airports_label.Text = this_section_string
    End Sub
    Private Sub BuildUtilizationTabs(ByVal headerString As String, ByVal ExportFlights As Boolean, ByVal business_type As String, ByRef recent_flight_months As Long, ByRef airport_fbo_functions As airport_fbo_view_functions, ByRef location_name As String, ByRef product_link As String, ByVal AirportData As DataTable, ByRef temp_distance_company As Long, ByRef orig_lat As Double, ByRef orig_long As Double, ByRef temp_distance As Long, ByVal active_tab As Integer, ByRef searchCriteria As viewSelectionCriteriaClass, ByRef this_section_string As String, ByVal product_code_selection As String, ByRef table_count As Long, ByRef TotalFlights As Long, ByVal cfolder_id As Long, ByVal aport_id As Long, ByVal operator_list As String, ByVal airport_list As String, ByVal isAircraftSearch As Boolean, ByRef util_functions As utilization_functions, ByRef NoAirportNoOperator As Boolean, ByRef is_located_here As Boolean, ByVal basedAtAirport As Boolean)

        Dim temp_new_tabs As Integer = 0
        temp_new_tabs = 1


        If temp_new_tabs = 1 Then

            If active_tab = 0 Then  '      a.	Airport or Airports tab depending on single or multiple 
                Call Build_Airports_Tab(headerString, ExportFlights, business_type, recent_flight_months, airport_fbo_functions, location_name, product_link, AirportData, temp_distance_company, orig_lat, orig_long, temp_distance, active_tab, searchCriteria, this_section_string, product_code_selection, table_count, TotalFlights, cfolder_id, aport_id, operator_list, airport_list, isAircraftSearch, util_functions, NoAirportNoOperator, is_located_here, basedAtAirport)
            ElseIf active_tab = 1 Then   'b.	Operator or Operators tab depending on single or multiple
                If searchCriteria.ViewCriteriaCompanyID > 0 Then
                    Me.utilizationViewDropDown.Visible = False
                    Me.utilizationExcludeCheck.Visible = False
                    Me.utilizationListLabel.Visible = False
                Else
                    Me.utilizationViewDropDown.Visible = True
                    Me.utilizationExcludeCheck.Visible = True
                    Me.utilizationListLabel.Visible = True
                End If
                ' Me.utilizationViewDropDown.Visible = False
                ' Me.utilizationExcludeCheck.Visible = False
                ' Me.oper2AirportViewTextToggle.Visible = False
                'Else 
                Call Build_Operators_Tab(headerString, ExportFlights, business_type, recent_flight_months, airport_fbo_functions, location_name, product_link, AirportData, temp_distance_company, orig_lat, orig_long, temp_distance, active_tab, searchCriteria, this_section_string, product_code_selection, table_count, TotalFlights, cfolder_id, aport_id, operator_list, airport_list, isAircraftSearch, util_functions, NoAirportNoOperator, is_located_here, basedAtAirport)
                'End If
            ElseIf active_tab = 2 Then     '      c.Routes()
                Call Build_Routes_Tab(headerString, ExportFlights, business_type, recent_flight_months, airport_fbo_functions, location_name, product_link, AirportData, temp_distance_company, orig_lat, orig_long, temp_distance, active_tab, searchCriteria, this_section_string, product_code_selection, table_count, TotalFlights, cfolder_id, aport_id, operator_list, airport_list, isAircraftSearch, util_functions, NoAirportNoOperator, is_located_here, basedAtAirport)
            ElseIf active_tab = 3 Then   '      d.Flights()
                Call Build_Flights_Tab(headerString, ExportFlights, business_type, recent_flight_months, airport_fbo_functions, location_name, product_link, AirportData, temp_distance_company, orig_lat, orig_long, temp_distance, active_tab, searchCriteria, this_section_string, product_code_selection, table_count, TotalFlights, cfolder_id, aport_id, operator_list, airport_list, isAircraftSearch, util_functions, NoAirportNoOperator, is_located_here, basedAtAirport)
            ElseIf active_tab = 4 Then   '      e.Aircraft()
                Call Build_Aircraft_Tab(headerString, ExportFlights, business_type, recent_flight_months, airport_fbo_functions, location_name, product_link, AirportData, temp_distance_company, orig_lat, orig_long, temp_distance, active_tab, searchCriteria, this_section_string, product_code_selection, table_count, TotalFlights, cfolder_id, aport_id, operator_list, airport_list, isAircraftSearch, util_functions, NoAirportNoOperator, is_located_here, basedAtAirport)
            ElseIf active_tab = 17 Then    'f.	Refuel/Tech Stops
                Call Build_Refuel_Tab(headerString, ExportFlights, business_type, recent_flight_months, airport_fbo_functions, location_name, product_link, AirportData, temp_distance_company, orig_lat, orig_long, temp_distance, active_tab, searchCriteria, this_section_string, product_code_selection, table_count, TotalFlights, cfolder_id, aport_id, operator_list, airport_list, isAircraftSearch, util_functions, NoAirportNoOperator, is_located_here, basedAtAirport)
            ElseIf active_tab = 18 Then   '      g.Aircraft(Model)
                Call Build_Aircraft_Model_Tab(headerString, ExportFlights, business_type, recent_flight_months, airport_fbo_functions, location_name, product_link, AirportData, temp_distance_company, orig_lat, orig_long, temp_distance, active_tab, searchCriteria, this_section_string, product_code_selection, table_count, TotalFlights, cfolder_id, aport_id, operator_list, airport_list, isAircraftSearch, util_functions, NoAirportNoOperator, is_located_here, basedAtAirport)
            ElseIf active_tab = 19 Then    'h.	Nearby Airports (if single airport selected)
                Call Build_Nearby_tab(headerString, ExportFlights, business_type, recent_flight_months, airport_fbo_functions, location_name, product_link, AirportData, temp_distance_company, orig_lat, orig_long, temp_distance, active_tab, searchCriteria, this_section_string, product_code_selection, table_count, TotalFlights, cfolder_id, aport_id, operator_list, airport_list, isAircraftSearch, util_functions, NoAirportNoOperator, is_located_here, basedAtAirport)
            ElseIf active_tab = 20 Then     'i.	Company Directory (if single airport selected)
                Call Build_Company_Directory_Tab(headerString, ExportFlights, business_type, recent_flight_months, airport_fbo_functions, location_name, product_link, AirportData, temp_distance_company, orig_lat, orig_long, temp_distance, active_tab, searchCriteria, this_section_string, product_code_selection, table_count, TotalFlights, cfolder_id, aport_id, operator_list, airport_list, isAircraftSearch, util_functions, NoAirportNoOperator, is_located_here, basedAtAirport)
            ElseIf active_tab = 21 Then   'j.	Owners (if single airport selected)
                Call Build_Owners_Tab(headerString, ExportFlights, business_type, recent_flight_months, airport_fbo_functions, location_name, product_link, AirportData, temp_distance_company, orig_lat, orig_long, temp_distance, active_tab, searchCriteria, this_section_string, product_code_selection, table_count, TotalFlights, cfolder_id, aport_id, operator_list, airport_list, isAircraftSearch, util_functions, NoAirportNoOperator, is_located_here, basedAtAirport)
            ElseIf active_tab = 22 Then     '      k.Reports()
                Call Build_Reports_Tab(headerString, ExportFlights, business_type, recent_flight_months, airport_fbo_functions, location_name, product_link, AirportData, temp_distance_company, orig_lat, orig_long, temp_distance, active_tab, searchCriteria, this_section_string, product_code_selection, table_count, TotalFlights, cfolder_id, aport_id, operator_list, airport_list, isAircraftSearch, util_functions, NoAirportNoOperator, is_located_here, basedAtAirport)
            ElseIf active_tab = 23 Then   '      l.Summary() 
                'does nothing - dont seperately 
                Call Build_Flight_Summary_Tab(headerString, ExportFlights, business_type, recent_flight_months, airport_fbo_functions, location_name, product_link, AirportData, temp_distance_company, orig_lat, orig_long, temp_distance, active_tab, searchCriteria, this_section_string, product_code_selection, table_count, TotalFlights, cfolder_id, aport_id, operator_list, airport_list, isAircraftSearch, util_functions, NoAirportNoOperator, is_located_here, basedAtAirport)
            End If


            Session("Last_FBO_Bottom") = active_tab
            Session("Last_FBO_Bottom_Text") = this_section_string

        Else




            If active_tab = 0 Then 'And isAircraftSearch = False Then   ' changed from tab 4 
                '----------- OPERATOR SECTION---------------------------------------------------

                this_section_string = ""

                'If a company is picked and an airport ID.
                'If an airport folder isn't picked.
                If (aport_id < 2 Or airport_list <> "") Then
                    If isAircraftSearch = True Then
                        this_section_string = Session("Last_FBO_Bottom_Text")
                    Else
                        Call util_functions.MostCommonOriginsJSArray(searchCriteria, this_section_string, product_code_selection, table_count, True, True, TotalFlights, "", "", "")
                    End If
                    ' Me.operator_drop2.Visible = False
                    acStartTableColspan.Attributes.Remove("colspan")
                    acStartTableColspan.Attributes.Add("colspan", "7")
                    acStartTableToggleOff.Visible = False
                    BuildOnLoadJavascript(this_section_string, BuildOperatorDataTableJS(this_section_string, "createOriginTable", "startTableOper", "mostCommonOriginsDataset", 2, False, TotalFlights, IIf(cfolder_id > 0 Or aport_id > 0, True, False), operator_list, airport_list, "", "Airports"))
                Else
                    If isAircraftSearch = True Then
                        this_section_string = Session("Last_FBO_Bottom_Text")
                    Else
                        Call util_functions.Build_Operators_Array(searchCriteria, "view", IIf(Not String.IsNullOrEmpty(airport_list), 0, aport_id), this_section_string, Me.operator_drop2.SelectedValue, table_count, TotalFlights, "", "")
                    End If
                    acStartTableColspan.Attributes.Remove("colspan")
                    acStartTableColspan.Attributes.Add("colspan", "5")
                    acStartTableToggleOff.Visible = True
                    BuildOnLoadJavascript(this_section_string, BuildOperatorDataTableJS(this_section_string, "createOperatorTable", "startTableOper", "currentDataSet", 1, False, TotalFlights, IIf(cfolder_id > 0 Or aport_id > 0, True, False), operator_list, airport_list, "", "Operators"))
                End If

                Session("Last_FBO_Bottom") = 0
                Session("Last_FBO_Bottom_Text") = this_section_string

            ElseIf active_tab = 1 And isAircraftSearch = False Then

                '-- ***************  UPPER RIGHT TAB 2 - TOP ORIGINS/DESTINATIONS ************************
                '-- # FLIGHT ACTIVITY -MOST COMMON ORIGINS - WE WOULD ALSO DO SAME FOR DESTINATIONS 
                this_section_string = ""
                'Call util_functions.get_most_common_origins_top_function(searchCriteria, this_section_string, product_code_selection, table_count)
                If isAircraftSearch = True Then
                    'this_section_string = Session("Last_FBO_Bottom_Text")
                Else
                    util_functions.MostCommonOriginsJSArray(searchCriteria, this_section_string, product_code_selection, table_count, False, False, TotalFlights, "", "", "", limited_routes, "", sSelectedProductCode_to_Pass, Selection_Count)
                End If

                If InStr(this_section_string, """iata"":") > 0 Then
                    BuildOnLoadJavascript(this_section_string, BuildOperatorDataTableJS(this_section_string, "createOriginTable", "mostCommonOrigins", "mostCommonOriginsDataset", 2, False, TotalFlights, IIf(cfolder_id > 0 Or aport_id > 0, True, False), operator_list, airport_list, "", "Routes"))
                Else
                    originTableColspan.Attributes.Remove("colspan")
                    If InStr(this_section_string, """destination"":") > 0 Then
                        originTableColspan.Attributes.Add("colspan", "9")
                    Else
                        originTableColspan.Attributes.Add("colspan", "5")
                    End If
                    BuildOnLoadJavascript(this_section_string, BuildOperatorDataTableJS(this_section_string, "createOriginTable", IIf(InStr(this_section_string, """destination"":") > 0, "mostCommonOriginsDestinations", "mostCommonOrigins"), "mostCommonOriginsDataset", 2, True, TotalFlights, IIf(cfolder_id > 0 Or aport_id > 0, True, False), operator_list, airport_list, "", "Routes"))
                End If


                Session("Last_FBO_Bottom_Text") = this_section_string

            ElseIf active_tab = 2 And isAircraftSearch = False Then

                this_section_string = ""
                If isAircraftSearch = True Then
                    this_section_string = Session("Last_FBO_Bottom_Text")
                Else
                    Call util_functions.FlightActivityArrayByModel(searchCriteria, this_section_string, product_code_selection, "view", TotalFlights, "", "")
                End If
                BuildOnLoadJavascript(this_section_string, BuildOperatorDataTableJS(this_section_string, "createJsModelTable", "modelData", "modelDataSet", 3, False, TotalFlights, IIf(cfolder_id > 0 Or aport_id > 0, True, False), operator_list, airport_list, "", "Models"))
                Session("Last_FBO_Bottom") = 2

            ElseIf active_tab = 3 And isAircraftSearch = False Then
                view_events_label.Text = ""
                view_events_label.Visible = True
                If NoAirportNoOperator Then
                    'This can't run.
                    view_events_label.Text = "Please pick an operator, airport or folders to run this tab."
                Else


                    If isAircraftSearch = True Then
                        this_section_string = Session("Last_FBO_Bottom_Text")
                    Else
                        If owner_drop.SelectedValue = "T" Then
                            Call util_functions.FlightActivityJSArray(searchCriteria, this_section_string, True, product_code_selection, TotalFlights, "", "", "", basedAtAirport, aport_id)
                        Else
                            Call util_functions.FlightActivityJSArray(searchCriteria, this_section_string, is_located_here, product_code_selection, TotalFlights, "", "", "", basedAtAirport, aport_id)
                        End If

                    End If

                    'Call util_functions.FlightActivityJSArray(searchCriteria, this_section_string, is_located_here, product_code_selection, TotalFlights)
                    'Me.view_events_label.Text = this_section_string
                    BuildOnLoadJavascript(this_section_string, BuildOperatorDataTableJS(this_section_string, "createJsACTable", "acData", "acDataSet", 4, False, TotalFlights, IIf(cfolder_id > 0 Or aport_id > 0, True, False), operator_list, airport_list, "", "Aircraft"))
                End If
                Session("Last_FBO_Bottom") = 3
                Session("Last_FBO_Bottom_Text") = this_section_string
            ElseIf active_tab = 4 And isAircraftSearch = False Then
                Dim columnList As String = ""
                view_news_label1.Text = ""
                view_news_label1.Visible = True
                If NoAirportNoOperator Then
                    view_news_label1.Text = "Please pick an operator, airport or folders to run this tab."
                Else
                    this_section_string = ""

                    If isAircraftSearch = True Then
                        this_section_string = Session("Last_FBO_Bottom_Text")
                    Else
                        Call util_functions.FlightJSArray(searchCriteria, this_section_string, location_name, Trim(Request("export")), Me.compare_view_current_label.Text, Me.compare_view_current_label2.Text, Me.ac_projects_ddl.SelectedValue, recent_flight_months, IIf(String.IsNullOrEmpty(localCriteria.ViewCriteriaDocumentsStartDate), start_date.Text, localCriteria.ViewCriteriaDocumentsStartDate), IIf(String.IsNullOrEmpty(localCriteria.ViewCriteriaDocumentsEndDate), end_date.Text, localCriteria.ViewCriteriaDocumentsEndDate), product_code_selection, product_link, table_count, "view", "", columnList)  ' TONS OF FIELDS
                    End If
                    ' flightDataLabel.Text = Replace(this_section_string, "class=""formatTable blue""", "class=""refreshable""")
                    'BuildOnLoadJavascript(this_section_string, "")

                    System.Web.UI.ScriptManager.RegisterClientScriptBlock(Me.bottom_tab_update_panel, Me.GetType(), "flightTableBuild", this_section_string + ";" + BuildTable(False, 0, columnList).ToString, True)



                    ' BuildOnLoadJavascript(this_section_string, BuildTable(True, 25, columnList).ToString)
                End If

                'hidden_market_value_source_label.Text = ("<a class=""text_underline cursor"" title='View/Export' ' onclick=""javascript:load('WebSource.aspx?viewType=dynamic&display=table&PageTitle=Flights&replace_top=1000','','scrollbars=yes,menubar=no,height=700,width=1250,resizable=yes,toolbar=no,location=no,status=no');"" >VIEW ALL IN GRID</a><br/>")
                'hidden_market_value_source_label.Visible = True

                Session("Last_FBO_Bottom") = 4
                Session("Last_FBO_Bottom_Text") = this_section_string
            ElseIf active_tab = 5 And isAircraftSearch = False Then
                Call util_functions.Build_Operators_Array(searchCriteria, "view", IIf(Not String.IsNullOrEmpty(airport_list), 0, aport_id), this_section_string, Me.operator_drop2.SelectedValue, table_count, TotalFlights, "", "")
                BuildOnLoadJavascript(this_section_string, BuildOperatorDataTableJS(this_section_string, "createOperatorTable", "startTableOper2", "currentDataSet", 1, False, TotalFlights, IIf(cfolder_id > 0 Or aport_id > 0, True, False), operator_list, airport_list, "", "Operators"))
            ElseIf active_tab = 17 And isAircraftSearch = False Then
                Utilization_Build_Summaries(util_functions, searchCriteria, product_code_selection, TotalFlights)
            ElseIf active_tab = 18 And isAircraftSearch = False Then
                System.Web.UI.ScriptManager.RegisterStartupScript(Me.airportsSearchUpdate, Me.GetType(), "fixLinks", "setUpLinks('.rightside #fractionsExpiringDataTable a')", True)

                airport_fbo_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
                airport_fbo_functions.Airport_ID_OVERALL = aport_id

                AirportData = localDatalayer.get_range_airports_by_IATA_or_ICAO(localCriteria, aport_id)
                Call localDatalayer.get_airport_information(AirportData, "", localCriteria, location_name, orig_lat, orig_long)

                this_section_string = ""
                Call airport_fbo_functions.get_nearby_airports_top_function(searchCriteria, this_section_string, temp_distance, orig_lat, orig_long, business_type, aport_id, Me.controlled.Checked, UpdateProgress1, "util_view")
                Me.nearby_airports_label.Text = this_section_string
            ElseIf active_tab = 19 Then
                '---------------------------------------------------
                '-- ***************  LOWER TAB 3 - COMPANY DIRECTORY ************************
                '-- SELECT A LIST OF COMPANIES LOCATED AT SPECIFIC AIRPORT OR SAME CITY  

                If searchCriteria.ViewCriteriaCountry = "United States" Then
                    Me.ac_projects_ddl2_19.Visible = True
                    Me.compare_view_sold_label_19.Visible = True
                    Me.company_range_19.Visible = True
                    Me.compare_view_sold_label2_19.Visible = True
                Else
                    Me.ac_projects_ddl2_19.Visible = False
                    Me.compare_view_sold_label_19.Visible = False
                    Me.company_range_19.Visible = False
                    Me.compare_view_sold_label2_19.Visible = True ' this is the only one that shuld be visible
                End If

                this_section_string = ""
                Call airport_fbo_functions.get_companies_in_city_top_function(searchCriteria, this_section_string, location_name, business_type, Me.compare_view_sold_label_19.Text, Trim(Request("export")), aport_id, temp_distance_company, orig_lat, orig_long, Me.compare_view_sold_label2_19.Text)

                If searchCriteria.ViewCriteriaCountry <> "United States" Then
                    Me.compare_view_sold_label2_19.Text = "Companies Located at " & searchCriteria.ViewCriteriaCity & ", " & searchCriteria.ViewCriteriaCountry
                End If

                Me.panel_19_label.Text = this_section_string
                '--------------------------------------------------------------------------
            ElseIf active_tab = 20 Then
                '--------------------------------------------------------------------------
                '-- ***************  LOWER TAB 4 - OWNERS ************************
                '-- SELECT A LIST OF COMPANIES OWNING AIRCRAFT AT SPECIFIC AIRPORT  
                airport_fbo_functions.Airport_ID_OVERALL = aport_id
                this_section_string = ""

                If IsPostBack = False And Trim(Request("export")) <> "" Then
                    If Trim(Request("export")) <> "" And Trim(Request("export")) <> "OW" Then
                        Call airport_fbo_functions.get_companies_from_airport_top_function(searchCriteria, this_section_string, location_name, "Owner", Trim(Request("export")), aport_id, Me.check_owner_ac.Checked) ' TONS OF FIELDS
                    Else
                        Call airport_fbo_functions.get_most_recent_flight_activity_companies_top_function(searchCriteria, this_section_string, location_name, Trim(Request("export")), Me.compare_view_current_label.Text, Me.compare_view_current_label2.Text, Me.ac_projects_ddl.SelectedValue, recent_flight_months, "00", Me.check_owner_ac.Checked, start_date.Text, end_date.Text, product_code_selection)  ' TONS OF FIELDS
                    End If
                Else
                    If owner_drop.SelectedValue = "" Then
                        Call airport_fbo_functions.get_companies_from_airport_top_function(searchCriteria, this_section_string, location_name, "Owner", Trim(Request("export")), aport_id, Me.check_owner_ac.Checked) ' TONS OF FIELDS
                    Else
                        Call airport_fbo_functions.get_most_recent_flight_activity_companies_top_function(searchCriteria, this_section_string, location_name, Trim(Request("export")), Me.compare_view_current_label.Text, Me.compare_view_current_label2.Text, Me.ac_projects_ddl.SelectedValue, recent_flight_months, "00", Me.check_owner_ac.Checked, start_date.Text, end_date.Text, product_code_selection)  ' TONS OF FIELDS
                    End If
                End If

                Me.panel_20_label.Text = this_section_string
                '--------------------------------------------------------------------------
            ElseIf active_tab = 21 And isAircraftSearch = False Then
                Utilization_Build_Reports(util_functions, searchCriteria, product_code_selection, TotalFlights)
            End If

        End If


        ' moved below the end if , so that it does it with the new tab setup as well 
        If ExportFlights = True Then
            'Just a copy right now
            Dim columnList As String = ""
            view_news_label1.Text = ""
            view_news_label1.Visible = True
            If NoAirportNoOperator Then
                view_news_label1.Text = "Please pick an operator, airport or folders to run this tab."
            Else
                this_section_string = ""
                Dim SaveTable As New DataTable

                SaveTable = util_functions.get_most_recent_flight_activity(searchCriteria, False, "", recent_flight_months, IIf(String.IsNullOrEmpty(localCriteria.ViewCriteriaDocumentsStartDate), start_date.Text, localCriteria.ViewCriteriaDocumentsStartDate), IIf(String.IsNullOrEmpty(localCriteria.ViewCriteriaDocumentsEndDate), end_date.Text, localCriteria.ViewCriteriaDocumentsEndDate), product_code_selection, False)

                If SaveTable.Rows.Count > HttpContext.Current.Session.Item("localPreferences").MaxAllowedCustomExport Then
                    System.Web.UI.ScriptManager.RegisterClientScriptBlock(Me.bottom_tab_update_panel, Me.GetType(), "exportAndUncheck", "$('#" & exportUtilization.ClientID.ToString & "').prop('checked', false);alert('The quantity of flights to export (" & SaveTable.Rows.Count.ToString & ") is over the export limitation of your subscription (" & HttpContext.Current.Session.Item("localPreferences").MaxAllowedCustomExport.ToString & "). Contact customerservice@jetnet.com for more information');", True)
                Else
                    'Flight Activity -Teterboro 2/1/2018-5/20/2018 – 2,246 records
                    'Export log.
                    headerString += " - " & SaveTable.Rows.Count.ToString & " Records."
                    Call commonLogFunctions.Log_User_Event_Data("UserStatistics", Replace(headerString, "'", ""), Nothing, 28, 0, 0, 0, 0, 0, 0)

                    Session("export_info") = DisplayFunctions.ConvertDataTableToNonDynamicTable(SaveTable)
                    System.Web.UI.ScriptManager.RegisterClientScriptBlock(Me.bottom_tab_update_panel, Me.GetType(), "exportAndUncheck", "$('#" & exportUtilization.ClientID.ToString & "').prop('checked', false);window.open('export.aspx','_blank','width=400,height=400,toolbar=no,location=no, directories=no,status=no,menubar=no,scrollbars=no,resizable=no');$('.searchResultsLoadingText').text('Please wait while the Search Results are loading...');", True)
                End If
            End If

        End If


    End Sub

    Private Sub BuildUtilizationMainHeader(ByRef searchCriteria As viewSelectionCriteriaClass, ByRef HeaderString As String, ByVal fullAirportName As String, ByVal fullCompanyName As String, ByVal airport_list As String, ByVal aport_id As Long, ByVal RollUpCompanies As Boolean, ByVal isAircraftSearch As Boolean, ByVal operator_list As String, ByVal comp_id As Long, ByVal Aircraft_List As String)
        utilizationBoxHeader.Text = "<div class=""subHeader padded_left""><strong class=""emphasisColor"">" & searchBasedOnDropdown.SelectedItem.Text & "</strong> <span>"

        If airport_list <> "" Or aport_id > 1 Then
            utilizationBoxHeader.Text += "<strong>"
            If excludeAircraftFolders.Checked = True Then
                utilizationBoxHeader.Text += "Not for "
                HeaderString = "Not for "
            Else
                utilizationBoxHeader.Text += "for "
                HeaderString = "For "
            End If
            utilizationBoxHeader.Text += "</strong>"
            If airport_list <> "" Then
                'changed MSW 4/3/19 - so that it put the folder in if u still had codes in the text box 
                If Not String.IsNullOrEmpty(airportIATABoxSearch.Text) And selectAirportsType.Text = "5" Then   ' 5 should be Airport Code(s)
                    utilizationBoxHeader.Text += airportIATABoxSearch.Text
                    HeaderString += airportIATABoxSearch.Text
                Else
                    utilizationBoxHeader.Text += searchAirportFolder.SelectedItem.Text
                    HeaderString += searchAirportFolder.SelectedItem.Text
                End If
            End If
            If aport_id > 1 Then
                utilizationBoxHeader.Text += fullAirportName
                HeaderString += fullAirportName
            End If

        End If


        If operator_list <> "" Or comp_id > 0 Then
            utilizationBoxHeader.Text += "<strong>"
            If airportOperatorExclude.Checked = True Then
                utilizationBoxHeader.Text += " Not by "
                HeaderString += " Not by "
            Else
                utilizationBoxHeader.Text += " by "
                HeaderString += " By "
            End If

            utilizationBoxHeader.Text += "</strong>"
            If comp_id > 0 Or RollUpCompanies = True Then
                utilizationBoxHeader.Text += fullCompanyName
                If RollUpCompanies = True Then
                    utilizationBoxHeader.Text += " (+ Additional Operator Locations)"
                    HeaderString += " (+ Additional Operator Locations)"
                End If
            ElseIf operator_list <> "" And RollUpCompanies = False Then
                utilizationBoxHeader.Text += airportOperatorFolder.SelectedItem.Text
                HeaderString += airportOperatorFolder.SelectedItem.Text
            End If

        End If

        If Aircraft_List <> "" Then
            utilizationBoxHeader.Text += "<strong>"
            If airportAircraftExclude.Checked = True Then
                utilizationBoxHeader.Text += " Not with "
                HeaderString += " Not with "
            Else
                utilizationBoxHeader.Text += " with "
                HeaderString += " With "
            End If
            utilizationBoxHeader.Text += "</strong>"


            If String.IsNullOrEmpty(aircraftRegNumberView.Text) Then
                utilizationBoxHeader.Text += airportAircraftFolder.SelectedItem.Text
                HeaderString += airportAircraftFolder.SelectedItem.Text
            Else
                utilizationBoxHeader.Text += " R/N " & aircraftRegNumberView.Text
                HeaderString += " R/N " & aircraftRegNumberView.Text
            End If
        End If
        HeaderString &= " " & searchCriteria.ViewCriteriaDocumentsStartDate & " - " & searchCriteria.ViewCriteriaDocumentsEndDate

        utilizationBoxHeader.Text += "</span></div><div class=""clear_fix""></div>"
    End Sub

    Public Sub Build_Utilization_Summary_tab(ByRef searchCriteria As viewSelectionCriteriaClass, ByRef out_htmlString As String)
        Dim sQuery = New StringBuilder()
        Dim results_table As New DataTable
        Dim util_functions As New utilization_functions
        Dim this_section_string As String = ""
        Dim active_tab As Integer = 0
        Dim active_tab_top As Integer = 0
        Dim aclsData_Temp As New clsData_Manager_SQL
        Dim charting_string As String = ""
        Dim AirportData As New DataTable
        Dim last_year_count As Long = 0
        Dim location_name As String = ""
        Dim this_section_string2 As String = ""
        Dim temp_distance As Integer = 0
        Dim orig_lat As Double = 0.0
        Dim orig_long As Double = 0.0
        Dim aport_id As Integer = 1
        Dim amod_id As Integer = 0
        Dim recent_flight_months As Integer = 3
        Dim is_located_here As Boolean = True
        Dim temp_distance_company As Integer = 25
        Dim temp_data As String = ""
        Dim airport_table As New DataTable
        Dim originate_date As String = ""
        Dim fullCompanyName As String = ""
        Dim product_code_selection As String = ""
        Dim product_link As String = ""
        Dim comp_id As Long = 0
        Dim operator_list As String = ""
        Dim airport_list As String = ""
        Dim cfolder_id As Long = 0
        Dim afolder_id As Long = 0
        Dim table_count As Long = 0
        Dim AircraftFolderActive As Boolean = False
        Dim OperatorFolderActive As Boolean = False
        Dim airport_fbo_functions As New airport_fbo_view_functions
        Dim basedatAirport As Boolean = False
        Dim business_type As String = ""
        Dim isAircraftSearch As Boolean = False 'HttpContext.Current.Request.Form(fboViewSearch_Button.UniqueID) IsNot Nothing
        Dim isOperatorSwapDown As Boolean = HttpContext.Current.Request.Form(operator_drop2.UniqueID) IsNot Nothing
        Dim reportSwap As Boolean = HttpContext.Current.Request.Form(utilization_summary_type.UniqueID) IsNot Nothing
        Dim isSearchRan As Boolean = HttpContext.Current.Request.Form(goSearchAirports.UniqueID) IsNot Nothing
        'Dim isGraphtypeRun As Boolean = HttpContext.Current.Request.Form(utilization_summary_type.UniqueID) IsNot Nothing
        Dim GraphSwap As Boolean = False 'HttpContext.Current.Request.Form(utilizationViewMainBoxDropdown.UniqueID) IsNot Nothing
        Dim ExportFlights As Boolean = False
        ExportFlights = exportUtilization.Checked
        If ExportFlights = True Then
            exportUtilization.Checked = False
        End If

        Dim controlPostBack As String = Page.Request.Params.Get("__EVENTTARGET")
        If Not IsNothing(controlPostBack) Then
            If Not String.IsNullOrEmpty(controlPostBack) Then
                If controlPostBack = utilizationViewMainBoxDropdown.UniqueID Then
                    GraphSwap = True
                End If
            End If
        End If
        Dim headerString As String = ""
        Dim RollUpCompanies As Boolean = False
        Dim TotalFlights As Long = 0
        Dim NoAirportNoOperator As Boolean = False
        Dim DisplayFlight As Boolean = False
        Dim Aircraft_List As String = ""
        Dim AircraftFolder As Long = 0
        Dim ranThroughAirport = False
        Dim ranThroughCompany As Boolean = False
        Dim TemporaryTable As New DataTable
        Dim FullAirportName As String = ""
        Dim clearCompany As Boolean = False
        Dim clearAirport As Boolean = False
        Dim SummaryTable As New DataTable
        Dim between_text As String = ""
        Dim table_string As String = ""
        Dim show_report_link As Boolean = True
        Dim show_button_temp As Boolean = False
        Dim skip_due_to_info As Boolean = False

        Try


            'Added MSW - 11/5/18--------------
            If Not IsPostBack Then
                If Trim(Request("activetab")) <> "" Then
                    active_tab = CDbl(Trim(Request("activetab")))
                    TabContainer1.ActiveTabIndex = active_tab
                End If
            End If


            If TabContainer1.ActiveTabIndex <> 0 Then
                active_tab = TabContainer1.ActiveTabIndex
            End If


            If Me.distance_value.Text <> "" Then
                If IsNumeric(Me.distance_value.Text) Then
                    If Me.distance_compare.Text = "Equals" Then
                        distance_string = " and ffd_distance = " & Trim(Me.distance_value.Text) & " "
                    ElseIf Me.distance_compare.Text = "Less Than" Then
                        distance_string = " and ffd_distance <  " & Trim(Me.distance_value.Text) & " "
                    ElseIf Me.distance_compare.Text = "Greater Than" Then
                        distance_string = " and ffd_distance > " & Trim(Me.distance_value.Text) & " "
                    End If
                ElseIf Me.distance_compare.Text = "Between" Then
                    If InStr(Trim(Me.distance_value.Text), ":") > 0 Then
                        between_text = Left(Trim(Me.distance_value.Text), InStr(Trim(Me.distance_value.Text), ":") - 1)

                        distance_string = " and ffd_distance >= " & Trim(between_text) & ""

                        between_text = Right(Trim(Me.distance_value.Text), Len(Trim(Me.distance_value.Text)) - InStr(Trim(Me.distance_value.Text), ":"))

                        distance_string &= " and ffd_distance <= " & Trim(between_text) & " "
                    End If
                End If
            End If

            util_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            util_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            util_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            util_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            util_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

            aclsData_Temp.JETNET_DB = Application.Item("crmClientSiteData").AdminDatabaseConn
            aclsData_Temp.JETNET_DB = Application.Item("crmJetnetDatabase")
            aclsData_Temp.client_DB = Application.Item("crmClientDatabase")

            airport_fbo_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim


            If View_ID = 28 Then

                BuildUtilizationUI() 'Loading the generic UI Elements. Tab Panels, Tab Headers, Containers.

                BuildUtilizationLocalCriteria()

                BuildUtilizationRequestVariables(clearCompany, clearAirport, temp_distance, recent_flight_months, DisplayFlight, comp_id, RollUpCompanies, util_functions, operator_list, searchCriteria, aport_id, ranThroughAirport, AircraftFolder, afolder_id, cfolder_id)

                BuildUtilizationSession(clearAirport, clearCompany)

                If Trim(Request("comp_id")) <> "" And Trim(Request("aport_id")) = "0" And Not IsPostBack Then
                    selectAirportsType.SelectedValue = 1
                Else
                    BuildUtilizationDefaultFolders(clearAirport, ranThroughAirport, isAircraftSearch, afolder_id, aport_id, util_functions, searchCriteria)

                    BuildUtilizationSearchVariables(temp_distance_company, business_type, basedatAirport, RollUpCompanies, operator_list, clearCompany, clearAirport, product_code_selection, product_link, cfolder_id, is_located_here, AircraftFolder, afolder_id, isAircraftSearch, aport_id, ranThroughAirport, AircraftFolderActive, Aircraft_List, aclsData_Temp, util_functions, airport_list, isSearchRan, comp_id)

                    BuildUtilizationActiveFoldersLists(AircraftFolderActive, Aircraft_List, AircraftFolder, aclsData_Temp, util_functions, comp_id, cfolder_id, operator_list, OperatorFolderActive, searchCriteria)
                End If

                AirportData = localDatalayer.get_range_airports_by_IATA_or_ICAO(localCriteria, aport_id)

                fullCompanyName = commonEvo.get_company_name_fromID(comp_id, 0, False, True, "")

                searchCriteria.ViewCriteriaCompanyID = comp_id
                util_functions.Aircraft_IDS_String = Aircraft_List

                util_functions.Airport_ID_OVERALL = aport_id
                util_functions.Airport_IDS_String = airport_list
                util_functions.airport_direction = airport_direction
                util_functions.distance_string = distance_string
                airport_fbo_functions.Airport_ID_OVERALL = aport_id
                util_functions.Operator_IDS_String = operator_list

                skip_due_to_info = False
                If aport_id <= 1 And Trim(airport_list) = "" And Trim(Aircraft_List) = "" And amod_id = 0 And (IsNothing(searchCriteria.ViewCriteriaAircraftModel) Or Trim(searchCriteria.ViewCriteriaAircraftModel) = "") And IsNothing(searchCriteria.ViewCriteriaAmodIDArray) And Trim(operator_list) = "" And comp_id = 0 And afolder_id <= 1 And cfolder_id <= 1 Then
                    aport_id = aport_id ' WE HAVE NOTHING -------------------- 


                    If Trim(Request("comp_id")) <> "" And Trim(Request("aport_id")) = "0" And Not IsPostBack Then
                    Else
                        ' ADDED MSW - TO HELP WITH ISSUE
                        BuildUtilizationDefaultFolders_Force(clearAirport, ranThroughAirport, isAircraftSearch, afolder_id, aport_id, util_functions, searchCriteria)
                    End If

                    BuildUtilizationSearchVariables(temp_distance_company, business_type, basedatAirport, RollUpCompanies, operator_list, clearCompany, clearAirport, product_code_selection, product_link, cfolder_id, is_located_here, AircraftFolder, afolder_id, isAircraftSearch, aport_id, ranThroughAirport, AircraftFolderActive, Aircraft_List, aclsData_Temp, util_functions, airport_list, isSearchRan, comp_id)


                    searchCriteria.ViewCriteriaCompanyID = comp_id
                    util_functions.Aircraft_IDS_String = Aircraft_List

                    util_functions.Airport_ID_OVERALL = aport_id
                    util_functions.Airport_IDS_String = airport_list
                    util_functions.airport_direction = airport_direction
                    util_functions.distance_string = distance_string
                    airport_fbo_functions.Airport_ID_OVERALL = aport_id
                    util_functions.Operator_IDS_String = operator_list

                    If aport_id = 0 And Trim(airport_list) = "" And Trim(Aircraft_List) = "" And amod_id = 0 And (IsNothing(searchCriteria.ViewCriteriaAircraftModel) Or Trim(searchCriteria.ViewCriteriaAircraftModel) = "") And IsNothing(searchCriteria.ViewCriteriaAmodIDArray) And Trim(operator_list) = "" And comp_id = 0 And afolder_id <= 1 Then
                        skip_due_to_info = True
                    End If
                End If

                'added in MSW - in case nothing is searched, make them re-load the view rather than fry their system
                If skip_due_to_info = False Then

                    If aport_id > 1 Or afolder_id > 0 Then
                    Else
                        Me.owner_drop.Visible = False
                    End If

                    If Me.percentage_drop.Text = "" Then
                        Me.percentage_drop.Items.Clear()

                        Dim i As Integer = 0
                        For i = 0 To 100
                            Me.percentage_drop.Items.Add(New ListItem(i, i))

                            If i = 60 Then
                                Me.percentage_drop.SelectedValue = 60
                            End If
                        Next
                    End If

                    selectAirportID.Text = IIf(aport_id = 1, 0, aport_id)
                    selectOperatorID.Text = comp_id
                    Session.Item("searchCriteria").SearchViewCriteriaAirportSelected = aport_id
                    Session.Item("searchCriteria").SearchViewCriteriaOperatorSelected = comp_id

                    BuildUtilizationDisplayUIBasedOnCriteria(FullAirportName, fullCompanyName, isAircraftSearch, isOperatorSwapDown, temp_distance_company, aport_id, originate_date, afolder_id, util_functions, cfolder_id, comp_id, airport_list, isSearchRan, AirportData, location_name, orig_lat, orig_long, operator_list, airport_direction, reportSwap, searchCriteria, RollUpCompanies, OperatorFolderActive, Aircraft_List, active_tab, NoAirportNoOperator)

                    FillUtilizationDropdowns(util_functions, operator_list)

                    SetDefaultClearButton(searchCriteria, util_functions)

                End If

            Else
                Call create_product_checks(product_code_selection, product_link)
            End If

            If skip_due_to_info = False Then
                If Not IsPostBack Then


                    '-- ***************  TAB UNKNOWN - LIST OF BUSINESS TYPES AT AIRPORT ************************
                    '-- SELECT A SUMMARY OF COMPANIES LOCATED AT SPECIFIC AIRPORT OR SAME CITY 
                    Call util_functions.get_bus_type_from_companies_from_airport_top_function(searchCriteria, Me.ac_projects_ddl2, business_type, temp_distance_company, orig_lat, orig_long, Me.ac_projects_ddl2_19)

                    '-- ***********************************************************************
                    '-- BY AIRPORT 
                    '-- # FLIGHT ACTIVITY OVERALL  

                    Call run_airport_functions_top_util(util_functions, searchCriteria, last_year_count, product_code_selection, this_section_string, charting_string, is_located_here, temp_distance, orig_lat, orig_long, aport_id, TotalFlights, SummaryTable, table_string)
                    BuildUtilizationSummaryTable(SummaryTable, table_string)
                Else

                    ' Call run_airport_functions_top(airport_fbo_functions, searchCriteria, last_year_count, product_code_selection, this_section_string, charting_string, is_located_here, temp_distance, orig_lat, orig_long, aport_id)

                    ' If skip_selections = True Then

                    'Else


                    If isSearchRan = True Or GraphSwap = True Then
                        If isSearchRan Then
                            SummaryTable = util_functions.get_flight_activity_overall_top_function(searchCriteria, last_year_count, product_code_selection)
                            TotalFlights = CLng(last_year_count)
                            Call run_airport_functions_top_util(util_functions, searchCriteria, last_year_count, product_code_selection, this_section_string, charting_string, is_located_here, temp_distance, orig_lat, orig_long, aport_id, TotalFlights, SummaryTable, table_string)
                            BuildUtilizationSummaryTable(SummaryTable, table_string)
                        End If
                        this_section_string = ""
                        Call util_functions.get_flight_profile_top_function(searchCriteria, this_section_string, Me.utilizationViewMainBoxDropdown.SelectedValue, Session("Last_FAA_DATE"), product_code_selection)
                        hidden_spi_graph_text.Text = this_section_string
                        Me.last_overview_type.Text = Me.utilizationViewMainBoxDropdown.SelectedValue

                        If GraphSwap = True And isSearchRan = False And Me.utilizationViewMainBoxDropdown.SelectedValue.ToString.Trim = "Hours" Or Me.utilizationViewMainBoxDropdown.SelectedValue.ToString.Trim = "Month" Then
                            Call run_airport_functions_top_util(util_functions, searchCriteria, last_year_count, product_code_selection, this_section_string, charting_string, is_located_here, temp_distance, orig_lat, orig_long, aport_id, TotalFlights, SummaryTable, table_string, Me.utilizationViewMainBoxDropdown.SelectedValue)
                            BuildUtilizationSummaryTable(SummaryTable, table_string)
                        End If


                    Else
                        this_section_string = hidden_spi_graph_text.Text
                    End If

                End If
            End If

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />" & Date.Now & " - FBO View After Post Back - Before Functions<br />"

            show_report_link = True
            show_button_temp = False
            If aport_id = 0 Or Trim(operator_list) <> "" Or cfolder_id > 1 Or AircraftFolder > 0 Or Trim(Aircraft_List) <> "" Then    ' afolder_id > 0  Or Trim(airport_list) <> ""    - taken out for flight summary 
                show_report_link = False
            End If


            ' if we have model or models 
            'If amod_id > 0 Or searchCriteria.ViewCriteriaAmodID > 0 Then  ' if model, then we are displaying 
            'ElseIf Not IsNothing(searchCriteria.ViewCriteriaAmodIDArray) Then ' else if there is a model list 
            'ElseIf Not IsNothing(searchCriteria.ViewCriteriaTypeIDArray) Then ' else if there is a type  list 
            '  show_report_link = False
            'ElseIf Trim(searchCriteria.ViewCriteriaAircraftMake) <> "" Then ' else if there is a make  list 
            '  show_report_link = False
            'End If
            If skip_due_to_info = False Then


                BuildUtilizationJS(airport_list, aport_id, orig_lat, orig_long, searchCriteria, RollUpCompanies, this_section_string, charting_string, DisplayFlight, show_report_link, Me.utilizationViewMainBoxDropdown.SelectedValue, afolder_id)


                If active_tab = 5 And wanted_tab.Visible = False Then
                    active_tab = 0
                    TabContainer1.ActiveTabIndex = 0 'Reset this because this tab went away.
                End If


                'if we are trying to show nearby but dont have an airport id, then we shouldnt show.
                ' so change the active tab to 0 
                If active_tab = 19 And aport_id = 1 And IsPostBack Then
                    active_tab = 0
                    TabContainer1.ActiveTabIndex = 0 'Reset this because this tab went away.
                End If



                If View_ID = 28 Then
                    BuildUtilizationMainHeader(searchCriteria, headerString, FullAirportName, fullCompanyName, airport_list, aport_id, RollUpCompanies, isAircraftSearch, operator_list, comp_id, Aircraft_List)
                End If


                BuildUtilizationTabs(headerString, ExportFlights, business_type, recent_flight_months, airport_fbo_functions, location_name, product_link, AirportData, temp_distance_company, orig_lat, orig_long, temp_distance, active_tab, searchCriteria, this_section_string, product_code_selection, table_count, TotalFlights, cfolder_id, aport_id, operator_list, airport_list, isAircraftSearch, util_functions, NoAirportNoOperator, is_located_here, basedatAirport)
            End If

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />" & Date.Now & " - FBO View After Functions<br />"


        Catch ex As Exception
            clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, "View_Master", ex.Message.ToString)
        End Try


    End Sub

    Public Sub BuildUtilizationSummaryTable(ByVal SummaryTable As DataTable, ByVal table_string As String)

        If Not IsNothing(SummaryTable) Then
            If SummaryTable.Rows.Count > 0 Then

                Dim differenceOfDate As Long = DateDiff(DateInterval.Day, CDate(airportViewStartDate.Text), CDate(airportViewEndDate.Text))
                Dim tflights As Long = 0
                Dim tflightHrs As Long = 0
                Dim tflightBurn As Long = 0
                Dim avgDayFlight As Long = 0
                Dim avgDayHours As Long = 0
                Dim avgDayFuel As Long = 0

                If differenceOfDate > 0 Then
                    If Not IsDBNull(SummaryTable.Rows(0).Item("tflights")) Then
                        If SummaryTable.Rows(0).Item("tflights") > 0 Then
                            avgDayFlight = SummaryTable.Rows(0).Item("tflights") / differenceOfDate
                            tflights = SummaryTable.Rows(0).Item("tflights")
                        End If
                    End If
                    If Not IsDBNull(SummaryTable.Rows(0).Item("TotalFlightTimeHrs")) Then
                        If SummaryTable.Rows(0).Item("TotalFlightTimeHrs") > 0 Then
                            avgDayHours = SummaryTable.Rows(0).Item("TotalFlightTimeHrs") / differenceOfDate
                            tflightHrs = SummaryTable.Rows(0).Item("TotalFlightTimeHrs")
                        End If
                    End If
                    If Not IsDBNull(SummaryTable.Rows(0).Item("TotalFuelBurn")) Then
                        If SummaryTable.Rows(0).Item("TotalFuelBurn") > 0 Then
                            avgDayFuel = SummaryTable.Rows(0).Item("TotalFuelBurn") / differenceOfDate
                            tflightBurn = SummaryTable.Rows(0).Item("TotalFuelBurn")
                        End If
                    End If
                Else
                    If Not IsDBNull(SummaryTable.Rows(0).Item("tflights")) Then
                        avgDayFlight = SummaryTable.Rows(0).Item("tflights")
                    End If
                    If Not IsDBNull(SummaryTable.Rows(0).Item("TotalFlightTimeHrs")) Then
                        avgDayHours = SummaryTable.Rows(0).Item("TotalFlightTimeHrs")
                    End If
                    If Not IsDBNull(SummaryTable.Rows(0).Item("TotalFuelBurn")) Then
                        avgDayFuel = SummaryTable.Rows(0).Item("TotalFuelBurn")
                    End If
                End If

                utilizationViewMainBoxLabel.Text = "<table width=""100%"" cellpadding=""3"" cellspacing=""0"" class=""tiny_text utilizationSummaryTable"">"
                utilizationViewMainBoxLabel.Text += "<thead><tr><th width=""114""></th><th class=""right""><strong>TOTAL</strong></th><th class=""right""><strong>AVG/MO</strong></th><th class=""right""><strong>AVG/DAY</strong></th></tr></thead>"

                utilizationViewMainBoxLabel.Text += "<tbody><tr><td><strong># Flights</strong></td><td class=""right"">" & FormatNumber(tflights, 0).ToString & "</td><td class=""right"">" & FormatNumber((avgDayFlight * 30.5), 0).ToString & "</td><td class=""right"">" & FormatNumber(avgDayFlight, 0).ToString & "</td></tr>"

                utilizationViewMainBoxLabel.Text += "<tr><td><strong>Flight Hours</strong></td><td class=""right"">" & FormatNumber(tflightHrs, 0).ToString & "</td><td class=""right"">" & FormatNumber((avgDayHours * 30.5), 0).ToString & "</td><td class=""right"">" & FormatNumber(avgDayHours, 0).ToString & "</td></tr>"

                utilizationViewMainBoxLabel.Text += "<tr><td><strong>Total Est Fuel (GAL)</strong></td><td class=""right"">" & FormatNumber(tflightBurn, 0).ToString & "</td><td class=""right"">" & FormatNumber((avgDayFuel * 30.5), 0).ToString & "</td><td class=""right"">" & FormatNumber(avgDayFuel, 0).ToString & "</td></tr>"
                utilizationViewMainBoxLabel.Text += "</tbody></table>"


                If Trim(table_string) <> "" Then
                    utilizationViewMainBoxLabel.Text += "<br>" & table_string
                End If


                utilizationViewMainBoxLabel.Text += "<div class=""clearfix""></div>"
            End If
        End If
    End Sub

    Private Sub FillUpAirportSession(ByRef ClearAirportID As Boolean, ByRef ClearCompanyID As Boolean)
        If Not Page.IsPostBack Then
            Dim searchSession As New SearchSelectionCriteria
            If Not IsNothing(HttpContext.Current.Session.Item("searchCriteria")) Then
                searchSession = HttpContext.Current.Session.Item("searchCriteria")
            End If


            If Not IsNothing(Session.Item("searchCriteria").SearchViewCriteriaClearAirport) Then
                If Session.Item("searchCriteria").SearchViewCriteriaClearAirport Then
                    ClearAirportID = True
                Else
                    ClearAirportID = False
                End If

            End If


            If Not IsNothing(Session.Item("searchCriteria").SearchViewCriteriaClearCompany) Then
                If Session.Item("searchCriteria").SearchViewCriteriaClearCompany Then
                    ClearCompanyID = True
                Else
                    ClearCompanyID = False
                End If
            End If


            If Not IsNothing(Session.Item("searchCriteria").SearchViewCriteriaAircraftDropdown) Then
                If IsNumeric(Session.Item("searchCriteria").SearchViewCriteriaAircraftDropdown) Then
                    If (Session.Item("searchCriteria").SearchViewCriteriaAircraftDropdown) > 0 Then
                        airportAircraftType.SelectedValue = Session.Item("searchCriteria").SearchViewCriteriaAircraftDropdown
                        If airportAircraftType.SelectedValue = 4 Then
                            airportAircraftFolderToggleOnOff.Attributes.Remove("class")
                        End If
                        If airportAircraftType.SelectedValue = 5 Then
                            airportAircraftRegNumberToggleOnOff.Attributes.Remove("class")
                        End If
                    End If
                End If
            End If


            If Not IsNothing(Session.Item("searchCriteria").SearchViewCriteriaBasedOn) Then
                If Not String.IsNullOrEmpty(Session.Item("searchCriteria").SearchViewCriteriaBasedOn) Then
                    searchBasedOnDropdown.SelectedValue = Session.Item("searchCriteria").SearchViewCriteriaBasedOn
                End If
            End If

            If Not IsNothing(Session.Item("searchCriteria").SearchViewCriteriaAirportCodes) Then
                If Not String.IsNullOrEmpty(Session.Item("searchCriteria").SearchViewCriteriaAirportCodes) Then
                    airportIATABoxSearch.Text = Session.Item("searchCriteria").SearchViewCriteriaAirportCodes
                End If
            End If
            If Not IsNothing(Session.Item("searchCriteria").SearchViewCriteriaRegList) Then
                If Not String.IsNullOrEmpty(Session.Item("searchCriteria").SearchViewCriteriaRegList) Then
                    aircraftRegNumberView.Text = Session.Item("searchCriteria").SearchViewCriteriaRegList
                End If
            End If

            If Not IsNothing(Session.Item("searchCriteria").SearchViewCriteriaAircraftDropdown2) Then
                If IsNumeric(Session.Item("searchCriteria").SearchViewCriteriaAircraftDropdown2) Then
                    If (Session.Item("searchCriteria").SearchViewCriteriaAircraftDropdown2) > 0 Then
                        airportAircraftFolder.Items.Add(New ListItem(IIf(Not IsDBNull(Session.Item("searchCriteria").SearchViewCriteriaAircraftFolderName), Session.Item("searchCriteria").SearchViewCriteriaAircraftFolderName, ""), Session.Item("searchCriteria").SearchViewCriteriaAircraftDropdown2))
                        airportAircraftFolder.SelectedValue = Session.Item("searchCriteria").SearchViewCriteriaAircraftDropdown2
                    End If
                End If
            End If


            If Not IsNothing(Session.Item("searchCriteria").SearchViewCriteriaOperatorDropdown) Then
                If IsNumeric(Session.Item("searchCriteria").SearchViewCriteriaOperatorDropdown) Then
                    If (Session.Item("searchCriteria").SearchViewCriteriaOperatorDropdown) > 0 Then
                        airportOperatorType.SelectedValue = Session.Item("searchCriteria").SearchViewCriteriaOperatorDropdown
                        ' If String.IsNullOrEmpty(Trim(Request("comp_id"))) Then
                        If airportOperatorType.SelectedValue = 4 Then
                            airportOperatorFolderToggleOnOff.Attributes.Remove("class")
                        End If
                        'Else
                        '  If IsNumeric(Trim(Request("comp_id"))) Then
                        '    If (Trim(Request("comp_id")) = 0 Or Trim(Request("comp_id")) = Session.Item("searchCriteria").SearchViewCriteriaOperatorSelected) Then
                        '      If airportOperatorType.SelectedValue = 4 Then
                        '        airportOperatorFolderToggleOnOff.Attributes.Remove("class")
                        '      End If
                        '    End If
                        ' End If
                    End If

                End If
            End If

            If Not IsNothing(Session.Item("searchCriteria").SearchViewCriteriaOperatorDropdown2) Then
                If IsNumeric(Session.Item("searchCriteria").SearchViewCriteriaOperatorDropdown2) Then
                    If (Session.Item("searchCriteria").SearchViewCriteriaOperatorDropdown2) > 0 Then
                        ' If String.IsNullOrEmpty(Trim(Request("comp_id"))) Then
                        airportOperatorFolder.Items.Add(New ListItem(IIf(Not IsDBNull(Session.Item("searchCriteria").SearchViewCriteriaOperatorFolderName), Session.Item("searchCriteria").SearchViewCriteriaOperatorFolderName, ""), Session.Item("searchCriteria").SearchViewCriteriaOperatorDropdown2))
                        airportOperatorFolder.SelectedValue = Session.Item("searchCriteria").SearchViewCriteriaOperatorDropdown2
                        'Else
                        '  If IsNumeric(Trim(Request("comp_id"))) Then
                        '    If (Trim(Request("comp_id")) = 0 Or Trim(Request("comp_id")) = Session.Item("searchCriteria").SearchViewCriteriaOperatorSelected) Then
                        '      airportOperatorFolder.Items.Add(New ListItem(IIf(Not IsDBNull(Session.Item("searchCriteria").SearchViewCriteriaOperatorFolderName), Session.Item("searchCriteria").SearchViewCriteriaOperatorFolderName, ""), Session.Item("searchCriteria").SearchViewCriteriaOperatorDropdown2))
                        '      airportOperatorFolder.SelectedValue = Session.Item("searchCriteria").SearchViewCriteriaOperatorDropdown2
                        '    End If
                        '  End If
                        ' End If
                    End If
                End If
            End If
            If Not IsNothing(Session.Item("searchCriteria").SearchViewCriteriaOperatorSelected) Then
                If IsNumeric(Session.Item("searchCriteria").SearchViewCriteriaOperatorSelected) Then
                    If (Session.Item("searchCriteria").SearchViewCriteriaOperatorSelected) > 0 Then
                        selectOperatorID.Text = Session.Item("searchCriteria").SearchViewCriteriaOperatorSelected
                        viewOperatorHiddenCompanyID.Text = Session.Item("searchCriteria").SearchViewCriteriaOperatorSelected
                    End If
                End If
            End If
            '
            If Not IsNothing(Session.Item("searchCriteria").SearchViewCriteriaDefaultFolder) Then
                If Not String.IsNullOrEmpty(Session.Item("searchCriteria").SearchViewCriteriaDefaultFolder) Then
                    defaultFolderSelectedCheckBox.Checked = IIf(Session.Item("searchCriteria").SearchViewCriteriaDefaultFolder, True, False)
                End If
            End If
            If Not IsNothing(Session.Item("searchCriteria").SearchViewCriteriaStartDate) Then
                If Not String.IsNullOrEmpty(Session.Item("searchCriteria").SearchViewCriteriaStartDate) Then
                    airportViewStartDate.Text = Session.Item("searchCriteria").SearchViewCriteriaStartDate
                End If
            End If

            If Not IsNothing(Session.Item("searchCriteria").SearchViewCriteriaEndDate) Then
                If Not String.IsNullOrEmpty(Session.Item("searchCriteria").SearchViewCriteriaEndDate) Then
                    airportViewEndDate.Text = Session.Item("searchCriteria").SearchViewCriteriaEndDate
                End If
            End If



            If Not IsNothing(Session.Item("searchCriteria").SearchViewCriteriaAirportSelected) Then
                If IsNumeric(Session.Item("searchCriteria").SearchViewCriteriaAirportSelected) Then
                    If (Session.Item("searchCriteria").SearchViewCriteriaAirportSelected) > 0 Then
                        If ClearAirportID = False Then
                            selectAirportID.Text = Session.Item("searchCriteria").SearchViewCriteriaAirportSelected
                        End If
                    End If
                End If
            End If


            If Not IsNothing(Session.Item("searchCriteria").SearchViewCriteriaAirportExcludeFolder) Then
                excludeAircraftFolders.Checked = Session.Item("searchCriteria").SearchViewCriteriaAirportExcludeFolder
            End If
            If Not IsNothing(Session.Item("searchCriteria").SearchViewCriteriaOperatorExcludeFolder) Then
                airportOperatorExclude.Checked = Session.Item("searchCriteria").SearchViewCriteriaOperatorExcludeFolder
            End If
            If Not IsNothing(Session.Item("searchCriteria").SearchViewCriteriaAircraftExcludeFolder) Then
                airportAircraftExclude.Checked = Session.Item("searchCriteria").SearchViewCriteriaAircraftExcludeFolder
            End If
            If Not IsNothing(Session.Item("searchCriteria").SearchViewCriteriaAirportDropdown) Then
                If IsNumeric(Session.Item("searchCriteria").SearchViewCriteriaAirportDropdown) Then
                    If (Session.Item("searchCriteria").SearchViewCriteriaAirportDropdown) > 0 Then

                        ' If String.IsNullOrEmpty(Trim(Request("aport_id"))) Then
                        selectAirportsType.SelectedValue = Session.Item("searchCriteria").SearchViewCriteriaAirportDropdown
                        If selectAirportsType.SelectedValue = 4 Then
                            airportFolderToggleOnOff.Attributes.Remove("class")
                        End If
                        If selectAirportsType.SelectedValue = 5 Then
                            airportIataToggle.Attributes.Remove("class")
                        End If
                        'ElseIf (Session.Item("searchCriteria").SearchViewCriteriaAirportSelected = Trim(Request("aport_id"))) Then
                        '  selectAirportsType.SelectedValue = Session.Item("searchCriteria").SearchViewCriteriaAirportDropdown
                        '  If selectAirportsType.SelectedValue = 4 Then
                        '    airportFolderToggleOnOff.Attributes.Remove("class")
                        '  End If
                        'End If
                    End If
                End If
            End If



            If Not IsNothing(Session.Item("searchCriteria").SearchViewCriteriaAirportDropdown2) Then
                If IsNumeric(Session.Item("searchCriteria").SearchViewCriteriaAirportDropdown2) Then
                    If (Session.Item("searchCriteria").SearchViewCriteriaAirportDropdown2) > 0 Then
                        ' If String.IsNullOrEmpty(Trim(Request("aport_id"))) Then
                        searchAirportFolder.Items.Add(New ListItem(IIf(Not IsDBNull(Session.Item("searchCriteria").SearchViewCriteriaAirportFolderName), Session.Item("searchCriteria").SearchViewCriteriaAirportFolderName, ""), Session.Item("searchCriteria").SearchViewCriteriaAirportDropdown2))
                        searchAirportFolder.SelectedValue = Session.Item("searchCriteria").SearchViewCriteriaAirportDropdown2
                    End If
                End If
            End If
        End If

    End Sub

    Private Function Build_Selections(ByVal SearchCriteria As viewSelectionCriteriaClass) As String
        Dim returnString As String = ""
        'Not sure how easy it will be to fill in this tab – probably should read a bit like below.
        'Helicopters & Business Aircraft
        'Flights from mm/dd/yyyy to mm/dd/yyyy
        'Make(s): same as aircraft search
        'Model(s):  same as aircraft search

        If SearchCriteria.ViewCriteriaHasBusinessFlag = True Then
            returnString = "Business"
        End If
        If SearchCriteria.ViewCriteriaHasHelicopterFlag = True Then
            If returnString <> "" Then
                If SearchCriteria.ViewCriteriaHasCommercialFlag = True Then
                    returnString += ", "
                Else
                    returnString += " & "
                End If
            End If
            returnString += "Helicopter"
        End If

        If SearchCriteria.ViewCriteriaHasCommercialFlag = True Then
            If returnString <> "" Then
                If SearchCriteria.ViewCriteriaHasHelicopterFlag = True Then
                    returnString += ", "
                Else
                    returnString += " & "
                End If
            End If
            returnString += "Commercial"
        End If
        returnString += " Aircraft<br />"

        If Not String.IsNullOrEmpty(SearchCriteria.ViewCriteriaDocumentsStartDate) Then
            returnString += "Flights from " & SearchCriteria.ViewCriteriaDocumentsStartDate
            If Not String.IsNullOrEmpty(SearchCriteria.ViewCriteriaDocumentsEndDate) Then
                returnString += " to " & SearchCriteria.ViewCriteriaDocumentsEndDate
            End If
            returnString += "<br />"
        End If

        If Not String.IsNullOrEmpty(SearchCriteria.ViewCriteriaAircraftMake) Then
            returnString += Replace(DisplayFunctions.BuildSearchTextDisplay(SearchCriteria.ViewCriteriaAircraftMake, "Make(s)"), ",", ", ")
        End If
        If Not String.IsNullOrEmpty(SearchCriteria.ViewCriteriaAircraftModel) Then
            returnString += Replace(DisplayFunctions.BuildSearchTextDisplay(SearchCriteria.ViewCriteriaAircraftModel, "Model(s)"), ",", ", ")
        End If


        Return returnString
    End Function

    Private Sub SetDefaultClearButton(ByRef searchCriteria As viewSelectionCriteriaClass, ByRef util_functions As utilization_functions)
        Dim DefaultID As Long = 0

        If defaultFolderSelectedCheckBox.Checked = False Then
            DefaultID = util_functions.get_default_airport_id(searchCriteria, Session.Item("localPreferences").UserCompanyID, "City", 0)
            If DefaultID = 0 Then
                DefaultID = util_functions.get_default_airport_id(searchCriteria, Session.Item("localPreferences").UserCompanyID, "Radius", 25)
            End If
            If DefaultID = 0 Then
                DefaultID = util_functions.get_default_airport_id(searchCriteria, Session.Item("localPreferences").UserCompanyID, "State", 0)
            End If
        End If

        clearAirportCriteria.CssClass = DefaultID.ToString
    End Sub

    Private Function BuildOperatorDataTableJS(ByVal scriptArray As String, ByVal jsFunctionName As String, ByVal tableName As String, ByVal jsArrayName As String, ByVal columnSet As Integer, ByVal ToggleDisplay As Boolean, ByVal TotalFlights As Long, ByVal cfolderSearch As Boolean, ByVal operator_List As String, ByVal airportList As String, Optional ByVal ColumnNames As String = "", Optional ByRef StartType As String = "Items", Optional ByVal only_one As Boolean = False) As String
        Dim TableBuild As New StringBuilder
        Dim TotalSorting As New StringBuilder
        Dim TopNumber As Integer = 0
        Dim BottomNumber As Integer = 0
        Dim EntriesText As String = "entries"

        TableBuild.Append("function " & jsFunctionName & "() { setUpAutoComplete();")

        ' If tableName = "mostCommonOriginsDestinations" Then
        TableBuild.Append("var mw = $('.MaxWidthRemove').width() - 60;")
        TableBuild.Append("$("".specialTableContainer"").width(mw);")


        '  End If


        If columnSet = 1 Then
            TableBuild.Append("var hideFromExport = [2];")
        ElseIf columnSet = 4 Then
            TableBuild.Append("var hideFromExport = [9];")
        End If
        TableBuild.Append("jQuery('#" & tableName & "').removeClass('display_none');var table = jQuery('#" & tableName & "').DataTable({destroy:true,dom: 'Bilrtfp', paging: true, pageLength: 100, ")

        If Session.Item("isMobile") = True Then
            TableBuild.Append("responsive:true,")
            TableBuild.Append("  responsive: {")
            TableBuild.Append("details: { ")
            TableBuild.Append("type:  'column', ")
            TableBuild.Append("target: -1 ")
            TableBuild.Append("} ")
            TableBuild.Append("},")
        End If

        TableBuild.Append("data: " & jsArrayName & ", ")
        TableBuild.Append("scrollX:        mw,  stateSave: true,")
        If Trim(StartType) = "Routes" And only_one = True Then

            '  TableBuild.Append("scrollY: 200,")
            ' TableBuild.Append("scrollCollapse:true,")
            ' TableBuild.Append("scroller:true,")
            TableBuild.Append("scrollCollapse:false,")
            TableBuild.Append("scroller:false,")
        ElseIf tableName = "mostCommonOriginsDestinations" Then
            TableBuild.Append("scrollY: 430,")
            TableBuild.Append("scrollCollapse:true,")
            TableBuild.Append("scroller:true,")
        Else
            TableBuild.Append("scrollY: 430, autoWidth: false,")
            TableBuild.Append("scrollCollapse:true,")
            TableBuild.Append("scroller:true,")
        End If

        TableBuild.Append("dom: 'Bfitrp',")


        TableBuild.Append("deferRender: true, ")

        TableBuild.Append("processing: true, ")

        TableBuild.Append(" ""language"": {")


        If columnSet = 1 Or columnSet = 2 Then
            'We need to replace the entries text depending on lots of things:
            'If columnSet = 1 Then
            '  StartType = "Operators"
            'ElseIf columnSet = 2 Then
            '  If ToggleDisplay Then
            '    StartType = "Aircraft"
            '  Else
            '    StartType = "Airports"
            '  End If
            'End If

            '

            '  If TotalFlights > 10000 And operator_List = "" Then
            '    EntriesText = StartType & " with at least 5 flights"
            'ElseIf TotalFlights > 50000 And operator_List = "" Then
            '     EntriesText = StartType & " with at least 5 flights (top 500)"
            ' ElseIf TotalFlights > 1000 And operator_List = "" Then
            '     EntriesText = StartType & " with at least 2 flights"
            '   Else
            '     EntriesText = StartType
            '   End If
        End If


        If Trim(tableName) = "flightData" Then
            TableBuild.Append("""emptyTable"": ""No Flights available for " & IIf(cfolderSearch = False, "these selections.", "these folder selections.") & """,")
            TableBuild.Append("""info"": ""Latest _TOTAL_ " & StartType & """,")
            TableBuild.Append("""infoEmpty"": ""Latest 0 to 0 of 0 " & EntriesText & """")
        ElseIf Trim(jsFunctionName) = "createOriginTable" Then
            If Trim(StartType) = "Routes" And limited_routes > 0 Then
                TableBuild.Append("""emptyTable"": ""No " & StartType & " available for " & IIf(cfolderSearch = False, "these selections.", "these folder selections.") & """,")
                TableBuild.Append("""info"": ""Top " & limited_routes & " " & StartType & " of " & Selection_Count & " Total " & StartType & """,")
                TableBuild.Append("""infoEmpty"": ""0 " & StartType & """")
            Else
                TableBuild.Append("""emptyTable"": ""No " & StartType & " available for " & IIf(cfolderSearch = False, "these selections.", "these folder selections.") & """,")
                TableBuild.Append("""info"": ""_TOTAL_ " & StartType & """,")
                TableBuild.Append("""infoEmpty"": ""0 " & StartType & """")
            End If
        ElseIf Trim(jsFunctionName) = "createJsModelTable" Then
            TableBuild.Append("""emptyTable"": ""No Models available for " & IIf(cfolderSearch = False, "these selections.", "these folder selections.") & """,")
            TableBuild.Append("""info"": ""_TOTAL_ Models"",")
            TableBuild.Append("""infoEmpty"": ""0 Models""")
        ElseIf Trim(jsFunctionName) = "createJsACTable" Then
            TableBuild.Append("""emptyTable"": ""No " & StartType & " available for " & IIf(cfolderSearch = False, "these selections.", "these folder selections.") & """,")
            TableBuild.Append("""info"": ""_TOTAL_ " & StartType & """,")
            TableBuild.Append("""infoEmpty"": ""0 " & StartType & """")
        Else
            TableBuild.Append("""emptyTable"": ""No " & EntriesText & " available for " & IIf(cfolderSearch = False, "these selections.", "these folder selections.") & """,")
            TableBuild.Append("""info"": ""Showing _START_ to _END_ of _TOTAL_ " & EntriesText & """,")
            TableBuild.Append("""infoEmpty"": ""Showing 0 to 0 of 0 " & EntriesText & """")
        End If


        TableBuild.Append("},")

        TableBuild.Append("columns: [ ")


        TableBuild.Append("{ title: ""SEL"", width: ""20px"", data: ""check""}, ")
        If columnSet = 1 Then
            TableBuild.Append("{ title: ""Operator"", data:{_:""operator.1"", sort: ""operator.1""}, width: ""60px"", className: ""display_none"" }, ")
            TableBuild.Append("{ title: ""Operator"", data:{_:""operator.0"", sort: ""operator.1""}, width: ""60px"" }, ")
            TableBuild.Append("{ title: ""Business Type"", width: ""50px"",className: """", data:""cbus_name"" }, ")
            TableBuild.Append("{ title: ""City"", width: ""50px"",className: """", data:""city"" }, ")
            TableBuild.Append("{ title: ""State"", width: ""50px"", className: """",data:""state"" }, ")
            TableBuild.Append("{ title: ""Country"", width: ""50px"", className: """", data:""country"" }, ")
            TableBuild.Append("{ title: ""Continent"", width: ""50px"", className: """", data:""continent"" }, ")
            TableBuild.Append("{ title: ""Nbr Flights"", width: ""50px"", className: ""text_align_right"", data:""flights"" }, ")
            TableBuild.Append("{ title: ""Total Flight Hours"", width: ""50px"", className: ""text_align_right"", data:""hours"" }, ")
            TableBuild.Append("{ title: ""Total Est Fuel<br/>Burn (GAL)"", width: ""100px"",className: ""text_align_right"", data:""fuel"" }, ")
            TableBuild.Append("{ title: ""Avg Distance"", width: ""50px"",className: ""text_align_right"", data:""AvgDistance"" }, ")
            TableBuild.Append("{ title: ""Avg Min<br/>Per Flight"", width: ""50px"",className: ""text_align_right"", data:""AvgMinPerFlights"" }, ")

            TableBuild.Append("{ title: ""Email"", width: ""50px"",className: """", data:{_:""email.0"", sort: ""email.1""} }, ")
            TableBuild.Append("{ title: ""Office Phone"", width: ""60px"",className: """", data:""office"" }, ")
            'TableBuild.Append("{ title: ""First Name"", width: ""50px"",className: """", data:""first_name"" }, ")
            'TableBuild.Append("{ title: ""Last Name"", width: ""50px"",className: """", data:""last_name"" }, ")
            'TableBuild.Append("{ title: ""Title"", width: ""50px"",className: """", data:""title"" }, ")
            'TableBuild.Append("{ title: ""Contact Email"", width: ""50px"",className: """", data:""contact_email"" }, ")
            'TableBuild.Append("{ title: ""Contact Office Number"", width: ""50px"",className: """", data:""contact_off_phone"" }, ")
            'TableBuild.Append("{ title: ""Contact Mobile Number"", width: ""50px"",className: """", data:""contact_mob_phone"" }, ")
            TableBuild.Append("{ title: ""Address"", width: ""100px"",className: """", data:""address"" } ")

            'What needs to be totalled here? Column 5,6,7
            TopNumber = 10
            BottomNumber = 8
        ElseIf columnSet = 2 Then

            If columnSet = 2 And StartType = "Routes" Then

                TableBuild.Append("{ title: ""Nbr Flights"", width: ""50px"", className: ""text_align_right"", data:""flights"" }, ")
                TableBuild.Append("{ title: ""Departure Airport"", width: ""100px"",className: """", data:""origin"" }, ")
                TableBuild.Append("{ title: ""Arrival Airport"", width: ""100px"",className: """", data:""destination"" }, ")

                TableBuild.Append("{ title: ""Route Distance"", width: ""50px"",className: ""text_align_right"", data:""RouteDistance"" }, ")
                TableBuild.Append("{ title: ""Total Flight Hours"", width: ""50px"", className: ""text_align_right"", data:""hours"" }, ")
                TableBuild.Append("{ title: ""Total Est Fuel<br/>Burn (GAL)"", width: ""100px"",className: ""text_align_right"", data:""fuel"" }, ")

                TableBuild.Append("{ title: ""Avg Min<br/>Per Flight"", width: ""50px"",className: ""text_align_right"", data:""AvgMinPerFlights"" }, ")
                TableBuild.Append("{ title: ""Avg Fuel Burn<br/>(GAL) Per Flight"", width: ""80px"",className: ""text_align_right"", data:""TotalFuelBurnPerFlight"" }, ")

                TableBuild.Append("{ title: ""Departure City"", width: ""50px"",className: """", data:""city2"" }, ")
                TableBuild.Append("{ title: ""Departure State"", width: ""50px"",className: """", data:""state2"" }, ")
                TableBuild.Append("{ title: ""Departure Country"", width: ""50px"",className: """", data:""country2"" }, ")
                TableBuild.Append("{ title: ""Departure Continent"", width: ""50px"",className: """", data:""continent2"" }, ")

                TableBuild.Append("{ title: ""Arrival<br/>City"", width: ""60px"",className: """", data:""city"" }, ")
                TableBuild.Append("{ title: ""Arrival<br/>State"", width: ""60px"",className: """", data:""state"" }, ")
                TableBuild.Append("{ title: ""Arrival<br/>Country"", width: ""60px"",className: """", data:""country"" }, ")
                TableBuild.Append("{ title: ""Arrival<br/>Continent"", width: ""60px"",className: """", data:""continent"" } ")

            Else   ' do whatever it was doing 



                If ToggleDisplay Then

                    If InStr(scriptArray, "origin:") > 0 Or InStr(scriptArray, """origin""") > 0 Then
                        TableBuild.Append("{ title: ""Departure Airport"", width: ""150px"",className: """", data:""origin"" }, ")
                    Else
                        TableBuild.Append("{ title: ""Departures"", width: ""150px"",className: ""check"", data: ""destination"" }, ")
                    End If

                    If Trim(airportList) = "" Then
                        TableBuild.Append("{ title: ""Departure City"", width: ""50px"",className: """", data:""city2"" }, ")
                        TableBuild.Append("{ title: ""Departure State"", width: ""50px"",className: """", data:""state2"" }, ")
                        TableBuild.Append("{ title: ""Departure Country"", width: ""50px"",className: """", data:""country2"" }, ")
                        TableBuild.Append("{ title: ""Departure Continent"", width: ""50px"",className: """", data:""continent2"" }, ")
                    End If

                    If InStr(scriptArray, """destination"":") > 0 Or Trim(airport_direction) = "X" Then
                        ' If airportList <> "" Or (operator_List Or comp_ <> "" And Page.IsPostBack) Then

                        If Trim(airportList) = "" Or Trim(airport_direction) = "X" Then
                            TableBuild.Append("{ title: ""Arrival Airport"", width: ""80px"",className: """", data:""destination"" }, ")
                            TableBuild.Append("{ title: ""City"", width: ""50px"",className: """", data:""city"" }, ")
                            TableBuild.Append("{ title: ""State"", width: ""50px"",className: """", data:""state"" }, ")
                            TableBuild.Append("{ title: ""Country"", width: ""50px"",className: """", data:""country"" }, ")
                            TableBuild.Append("{ title: ""Continent"", width: ""50px"",className: """", data:""continent"" }, ")
                        Else
                            TableBuild.Append("{ title: ""Destination"", width: ""150px"",className: """", data:""destination"" }, ")
                        End If

                        If Trim(airport_direction) = "X" Then
                            If Trim(airportList) = "" Then
                                TopNumber = 11
                                BottomNumber = 9
                            Else
                                TopNumber = 5
                                BottomNumber = 3
                            End If
                        Else
                            If Trim(airportList) = "" Then
                                TopNumber = 11
                                BottomNumber = 9
                            Else
                                TopNumber = 5
                                BottomNumber = 3
                            End If
                        End If
                        'What needs to be totalled here? Column 4,5



                    Else
                        'What needs to be totalled here? Column 3,4
                        TopNumber = 7
                        BottomNumber = 5
                    End If

                Else

                    ' ADDED MSW - 11/15/18
                    If Trim(airport_direction) = "X" Then
                        TableBuild.Append("{ title: ""Departure Airport"", width: ""50px"",className: """", data:""origin"" }, ")
                        TableBuild.Append("{ title: ""City"", width: ""50px"",className: """", data:""city2"" }, ")
                        TableBuild.Append("{ title: ""State"", width: ""50px"",className: """", data:""state2"" }, ")
                        TableBuild.Append("{ title: ""Country"", width: ""50px"",className: """", data:""country2"" }, ")

                        TableBuild.Append("{ title: ""Continent"", width: ""50px"",className: """", data:""continent2"" }, ")

                        TableBuild.Append("{ title: ""Arrival Airport"", width: ""50px"",className: """", data:""destination"" }, ")
                        TableBuild.Append("{ title: ""City"", width: ""50px"",className: """", data:""city"" }, ")
                        TableBuild.Append("{ title: ""State"", width: ""50px"",className: """", data:""state"" }, ")
                        TableBuild.Append("{ title: ""Country"", width: ""50px"",className: """", data:""country"" }, ")

                        TableBuild.Append("{ title: ""Continent"", width: ""50px"",className: """", data:""continent"" }, ")

                        'What needs to be totalled here? Column 7,8,9
                        TopNumber = 13
                        BottomNumber = 11
                    ElseIf Trim(airport_direction) = "D" Then
                        TableBuild.Append("{ title: ""IATA"", width: ""50px"",className: """", data:""iata"" }, ")
                        TableBuild.Append("{ title: ""ICAO"", width: ""50px"",className: """", data:""icao"" }, ")
                        TableBuild.Append("{ title: ""Arrival Airport"", width: ""50px"",className: """", data:""airport"" }, ")
                        TableBuild.Append("{ title: ""City"", width: ""50px"",className: """", data:""city"" }, ")
                        TableBuild.Append("{ title: ""State"", width: ""50px"",className: """", data:""state"" }, ")
                        TableBuild.Append("{ title: ""Country"", width: ""50px"",className: """", data:""country"" }, ")
                        TableBuild.Append("{ title: ""Continent"", width: ""50px"",className: """", data:""continent"" }, ")
                        'What needs to be totalled here? Column 7,8,9
                        TopNumber = 10
                        BottomNumber = 8
                    ElseIf Trim(airport_direction) = "O" Then
                        TableBuild.Append("{ title: ""IATA"", width: ""50px"",className: """", data:""iata"" }, ")
                        TableBuild.Append("{ title: ""ICAO"", width: ""50px"",className: """", data:""icao"" }, ")
                        TableBuild.Append("{ title: ""Departure Airport"", width: ""50px"",className: """", data:""airport"" }, ")
                        TableBuild.Append("{ title: ""City"", width: ""50px"",className: """", data:""city"" }, ")
                        TableBuild.Append("{ title: ""State"", width: ""50px"",className: """", data:""state"" }, ")
                        TableBuild.Append("{ title: ""Country"", width: ""50px"",className: """", data:""country"" }, ")
                        TableBuild.Append("{ title: ""Continent"", width: ""50px"",className: """", data:""continent"" }, ")
                        'What needs to be totalled here? Column 7,8,9
                        TopNumber = 10
                        BottomNumber = 8
                    Else
                        TableBuild.Append("{ title: ""IATA"", width: ""50px"",className: """", data:""iata"" }, ")
                        TableBuild.Append("{ title: ""ICAO"", width: ""50px"",className: """", data:""icao"" }, ")
                        TableBuild.Append("{ title: ""Arrival Airport"", width: ""50px"",className: """", data:""airport"" }, ")
                        TableBuild.Append("{ title: ""City"", width: ""50px"",className: """", data:""city"" }, ")
                        TableBuild.Append("{ title: ""State"", width: ""50px"",className: """", data:""state"" }, ")
                        TableBuild.Append("{ title: ""Country"", width: ""50px"",className: """", data:""country"" }, ")
                        TableBuild.Append("{ title: ""Continent"", width: ""50px"",className: """", data:""continent"" }, ")
                        'What needs to be totalled here? Column 7,8,9
                        TopNumber = 10
                        BottomNumber = 8
                    End If




                End If


                If ToggleDisplay Then
                    If Trim(airportList) = "" Then
                        TableBuild.Append("{ title: ""Nbr Flts"", width: ""50px"", className: ""text_align_right"", data:""flights"" }, ")
                        TableBuild.Append("{ title: ""Total Flight Hrs"", width: ""50px"", className: ""text_align_right"", data:""hours"" }, ")
                        TableBuild.Append("{ title: ""Total Est Fuel<br/>Burn (GAL)"", width: ""100px"",className: ""text_align_right"", data:""fuel"" } ")
                    End If
                Else
                    TableBuild.Append("{ title: ""Nbr Flts"", width: ""50px"", className: ""text_align_right"", data:""flights"" }, ")
                    TableBuild.Append("{ title: ""Total Flight Hrs"", width: ""50px"", className: ""text_align_right"", data:""hours"" }, ")
                    TableBuild.Append("{ title: ""Total Est Fuel<br/>Burn (GAL)"", width: ""100px"",className: ""text_align_right"", data:""fuel"" } ")
                End If


                If ToggleDisplay Then
                    ' if there is an airport list then show them down here 
                    If Trim(airportList) <> "" Then
                        If ToggleDisplay Then  ' moved down to here 
                            'make sure the commas is here in front 

                            TableBuild.Append("{ title: ""Nbr Flts"", width: ""115px"", className: ""text_align_right"", data:""flights"" }, ")
                            TableBuild.Append("{ title: ""Total Flight Hrs"", width: ""115px"", className: ""text_align_right"", data:""hours"" }, ")
                            TableBuild.Append("{ title: ""Total Est Fuel<br/>Burn (GAL)"", width: ""115px"",className: ""text_align_right"", data:""fuel"" } ")

                            TableBuild.Append(", { title: ""Departure<br/>City"", width: ""100px"",className: """", data:""city2"" }, ")
                            TableBuild.Append("{ title: ""Departure<br/>State"", width: ""100px"",className: """", data:""state2"" }, ")
                            TableBuild.Append("{ title: ""Departure<br/>Country"", width: ""50px"",className: """", data:""country2"" } ")
                            TableBuild.Append("{ title: ""Departure Continent"", width: ""50px"",className: """", data:""continent2"" }, ")

                            If InStr(scriptArray, """destination"":") > 0 Then
                                'make sure the commas is here in front 
                                TableBuild.Append(", { title: ""Arrival<br/>City"", width: ""60px"",className: """", data:""city"" }, ")
                                TableBuild.Append("{ title: ""Arrival<br/>State"", width: ""60px"",className: """", data:""state"" }, ")
                                TableBuild.Append("{ title: ""Arrival<br/>Country"", width: ""60px"",className: """", data:""country"" }, ")
                                TableBuild.Append("{ title: ""Arrival<br/>Continent"", width: ""50px"",className: """", data:""continent"" } ")
                            End If
                        End If
                    End If
                End If

                If columnSet = 2 And StartType = "Airports" Then
                    TableBuild.Append(", { title: ""Avg Min<br/>Per Flight"", width: ""50px"",className: ""text_align_right"", data:""AvgMinPerFlights"" } ")
                End If
            End If

        ElseIf columnSet = 3 Then
            TableBuild.Append("{ title: ""Model"", width: ""50px"",className: """", data:""model"" }, ")
            TableBuild.Append("{ title: ""Nbr Flts"", width: ""50px"", className: ""text_align_right"", data:""flights"" }, ")
            TableBuild.Append("{ title: ""Total Flight Hrs"", width: ""50px"", className: ""text_align_right"", data:""hours"" }, ")
            TableBuild.Append("{ title: ""Total Est Fuel<br/>Burn (GAL)"", width: ""100px"",className: ""text_align_right"", data:""fuel"" }, ")
            TableBuild.Append("{ title: ""Avg Distance"", width: ""50px"",className: ""text_align_right"", data:""AvgDistance"" }, ")
            TableBuild.Append("{ title: ""Avg Min<br/>Per Flight"", width: ""50px"",className: ""text_align_right"", data:""AvgMinPerFlights"" }, ")
            TableBuild.Append("{ title: ""Size<br/>Category"", width: ""50px"",className: ""text_align_left"", data:""SizeCategory"" } ")

            'What needs to be totalled here? Column 2,3,4
            TopNumber = 4
            BottomNumber = 2
        ElseIf columnSet = 4 Then
            TableBuild.Append("{ title: ""Aircraft"", width: ""50px"",className: """", data:""ac"" }, ")
            TableBuild.Append("{ title: ""Ser#"", width: ""50px"",className: """", data:{  ")
            TableBuild.Append("_:    ""ser.0"",")
            TableBuild.Append("sort: ""ser.1"",")
            TableBuild.Append("} }, ")
            TableBuild.Append("{ title: ""Reg#"", width: ""50px"",className: """", data:""reg"" }, ")
            TableBuild.Append("{ title: ""Nbr Flights"", width: ""50px"", className: ""text_align_right"", data:""flights"" }, ")
            TableBuild.Append("{ title: ""Total Flight Hrs"", width: ""50px"", className: ""text_align_right"", data:""hours"" }, ")
            TableBuild.Append("{ title: ""Total Est Fuel<br/>Burn (GAL)"", width: ""100px"",className: ""text_align_right"", data:""fuel"" }, ")
            TableBuild.Append("{ title: ""Avg Distance"", width: ""50px"",className: ""text_align_right"", data:""AvgDistance"" }, ")
            TableBuild.Append("{ title: ""Avg Min<br/>Per Flight"", width: ""50px"",className: ""text_align_right"", data:""AvgMinPerFlights"" }, ")
            TableBuild.Append("{ title: ""Current Operator"", data:{_:""operator.0"", sort: ""operator.1""}, width: ""60px"" }, ")
            TableBuild.Append("{ title: ""Current Operator"", data:{_:""operator.1"", sort: ""operator.1""}, width: ""60px"", className: ""display_none""  }, ")
            TableBuild.Append("{ title: ""Address"", width: ""100px"",className: """", data:""address"" }, ")
            TableBuild.Append("{ title: ""City"", width: ""50px"",className: """", data:""city"" }, ")
            TableBuild.Append("{ title: ""State"", width: ""50px"", className: """",data:""state"" }, ")
            TableBuild.Append("{ title: ""Country"", width: ""50px"", className: """", data:""country"" }, ")

            TableBuild.Append("{ title: ""Email"", width: ""50px"",className: """", data:{_:""email.0"", sort: ""email.1""} }, ")
            TableBuild.Append("{ title: ""Office Phone"", width: ""60px"",className: """", data:""office"" }, ")
            TableBuild.Append("{ title: ""Size Category"", width: ""60px"",className: """", data:""SizeCategory"" }, ")
            TableBuild.Append("{ title: ""Business Type"", width: ""60px"",className: """", data:""BusinessType"" } ")

            'What needs to be totalled here? Column 4,5,6
            TopNumber = 6
            BottomNumber = 4
        ElseIf columnSet = 44 Then   ' added in for another ac list 
            TableBuild.Append("{ title: ""Aircraft"", width: ""50px"",className: """", data:""ac"" }, ")
            TableBuild.Append("{ title: ""Ser#"", width: ""50px"",className: """", data:{  ")
            TableBuild.Append("_:    ""ser.0"",")
            TableBuild.Append("sort: ""ser.1"",")
            TableBuild.Append("} }, ")
            TableBuild.Append("{ title: ""Reg#"", width: ""50px"",className: """", data:""reg"" }, ")
            TableBuild.Append("{ title: ""Nbr Flights"", width: ""50px"", className: ""text_align_right"", data:""flights"" }, ")
            TableBuild.Append("{ title: ""Total Flight Hrs"", width: ""50px"", className: ""text_align_right"", data:""hours"" }, ")
            TableBuild.Append("{ title: ""Total Est Fuel<br/>Burn (GAL)"", width: ""100px"",className: ""text_align_right"", data:""fuel"" }, ")
            TableBuild.Append("{ title: ""Avg Distance"", width: ""50px"",className: ""text_align_right"", data:""AvgDistance"" }, ")
            TableBuild.Append("{ title: ""Avg Min<br/>Per Flight"", width: ""50px"",className: ""text_align_right"", data:""AvgMinPerFlights"" }, ")
            TableBuild.Append("{ title: ""Current Operator"", data:{_:""operator.0"", sort: ""operator.1""}, width: ""60px"" }, ")
            TableBuild.Append("{ title: ""Address"", width: ""100px"",className: """", data:""address"" }, ")
            TableBuild.Append("{ title: ""City"", width: ""50px"",className: """", data:""city"" }, ")
            TableBuild.Append("{ title: ""State"", width: ""50px"", className: """",data:""state"" }, ")
            TableBuild.Append("{ title: ""Country"", width: ""50px"", className: """", data:""country"" }, ")

            TableBuild.Append("{ title: ""Email"", width: ""50px"",className: """", data:{_:""email.0"", sort: ""email.1""} }, ")
            TableBuild.Append("{ title: ""Office Phone"", width: ""60px"",className: """", data:""office"" }, ")
            TableBuild.Append("{ title: ""Size Category"", width: ""60px"",className: """", data:""SizeCategory"" }, ")
            TableBuild.Append("{ title: ""Business Type"", width: ""60px"",className: """", data:""BusinessType"" } ")


            'What needs to be totalled here? Column 4,5,6
            TopNumber = 6
            BottomNumber = 4
        ElseIf columnSet = 5 Then
            TableBuild.Append("{ title: ""Aircraft"", width: ""50px"",className: """", data:""ac"" }, ")
            TableBuild.Append("{ title: ""Ser#"", width: ""50px"",className: """", data:{  ")
            TableBuild.Append("_:    ""ser.0"",")
            TableBuild.Append("sort: ""ser.1"",")
            TableBuild.Append("} }, ")
            TableBuild.Append("{ title: ""Reg#"", width: ""50px"",className: """", data:""reg"" }, ")
            TableBuild.Append("{ title: ""Date"", width: ""50px"", className: """", data:{  ")
            TableBuild.Append("_:    ""date.0"",")
            TableBuild.Append("sort: ""date.1"",")
            TableBuild.Append("} }, ")

            If Trim(airport_direction) = "D" Then
                TableBuild.Append("{ title: ""Departure Airport"", width: ""50px"", className: """", data:""origin"" }, ")
            ElseIf Trim(airport_direction) = "O" Then
                TableBuild.Append("{ title: ""Arrival Airport"", width: ""50px"", className: """", data:""origin"" }, ")
            Else
                TableBuild.Append("{ title: ""Departure Airport"", width: ""50px"", className: """", data:""origin"" }, ")
            End If






            TableBuild.Append("{ title: ""Flight Time"", width: ""50px"",className: ""text_align_right"", data:""time"" }, ")
            TableBuild.Append("{ title: ""Dist(nm)"", width: ""50px"",className: ""text_align_right"", data:""distance"" }, ")
            TableBuild.Append("{ title: ""Total Est Fuel Burn (GAL)"", width: ""50px"",className: ""text_align_right"", data:""FuelBurn"" } ")

            'What needs to be totalled here? None
            TopNumber = 0
            BottomNumber = 0
        End If

        TableBuild.Append("],")

        '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
        'Building the footer
        If BottomNumber > 0 And TopNumber > 0 Then
            TableBuild.Append("""footerCallback"": function ( row, data, start, end, display ) {")
            TableBuild.Append("var api = this.api(), data;")

            '// Remove the formatting to get integer data for summation
            TableBuild.Append("var intVal = function ( i ) {")
            TableBuild.Append("return typeof i === 'string' ?")
            TableBuild.Append("i.replace(/[\$,]/g, '').replace(/<[^>]+>/ig,'')*1 :")
            TableBuild.Append("typeof i === 'number' ?")
            TableBuild.Append("i : 0;")
            TableBuild.Append("};")

            'Let's build the total string:

            '// Total over all pages
            TotalSorting = New StringBuilder

            For x = BottomNumber To TopNumber
                TotalSorting.Append("total = api")
                TotalSorting.Append(".column(" & x & ")")
                TotalSorting.Append(".data()")
                TotalSorting.Append(".reduce( function (a, b) {")
                TotalSorting.Append("return intVal(a) + intVal(b);")
                TotalSorting.Append("}, 0 );")

                '// Update footer
                TotalSorting.Append("if (Math.round(total) !== total) {")
                TotalSorting.Append("total = total.toFixed(2);")
                TotalSorting.Append("}")

                TotalSorting.Append("$( api.column(" & x & ").footer() ).html('<span>' + ")
                TotalSorting.Append("total.toLocaleString('en')")

                TotalSorting.Append("+ '</span>');")
            Next

            TotalSorting.Append("$( api.column(" & BottomNumber - 1 & ").footer() ).html(")
            TotalSorting.Append("'Totals:'")
            TotalSorting.Append(");")

            TableBuild.Append(TotalSorting.ToString)
            TableBuild.Append("},")
        End If
        '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

        TableBuild.Append("""drawCallback"": function(settings, json) {")
        TableBuild.Append("setTimeout(function(){")
        TableBuild.Append("setUpLinks('#" & tableName & " td a');")
        TableBuild.Append("},100)")
        TableBuild.Append("},")

        TableBuild.Append("""columnDefs"": [ ")
        TableBuild.Append(" {")
        TableBuild.Append("orderable: false,")
        TableBuild.Append("className:  'select-checkbox',")
        TableBuild.Append(" width: '10px',")
        TableBuild.Append("targets:   0")
        TableBuild.Append(" }")
        TableBuild.Append(" ],")
        TableBuild.Append("select: {")
        TableBuild.Append("style:    'multi',")
        TableBuild.Append("selector: 'td:first-child'")
        TableBuild.Append("},")
        TableBuild.Append("buttons: [ ")
        TableBuild.Append(BuildButtonString(jsFunctionName))
        TableBuild.Append("]")
        TableBuild.Append("});};" & jsFunctionName & "();")


        TableBuild.Append("setTimeout(function(){$($.fn.dataTable.tables(true)).DataTable().columns.adjust();")
        TableBuild.Append("$($.fn.dataTable.tables(true)).DataTable().scroller.measure();}, 1000);")
        ' TableBuild.Append("})")


        TableBuild.Append("$(window).resize(function() {")
        TableBuild.Append("var mw = $('.MaxWidthRemove').width() - 60;")
        TableBuild.Append("$("".specialTableContainer"").width(mw);jQuery('#" & tableName & "').empty();" & jsFunctionName & "()")
        TableBuild.Append("});")


        Return TableBuild.ToString
    End Function

    Private Function BuildRefuelOperatorDataTableJS() As String
        Dim TableBuild As New StringBuilder
        Dim TotalSorting As New StringBuilder
        Dim TopNumber As Integer = 0
        Dim BottomNumber As Integer = 0
        Dim EntriesText As String = "entries"
        Dim StartType As String = ""


        TableBuild.Append("function refuelSummaryTable() {" & vbNewLine)

        TableBuild.Append("var cw = $('.MaxWidthRemove').width() - 60;")
        TableBuild.Append("$("".specialTableContainer"").width(cw);")

        TableBuild.Append("$(window).resize(function() {")
        TableBuild.Append("var cw = $('.MaxWidthRemove').width() - 60;")
        TableBuild.Append("$("".specialTableContainer"").width(cw);")
        TableBuild.Append("});")

        TableBuild.Append("jQuery('#refuelSummary').removeClass('display_none');")
        TableBuild.Append("var table = jQuery('#refuelSummary').DataTable({" & vbNewLine)
        TableBuild.Append("destroy:true,dom: 'Bilrtfp', paging: true, pageLength: 100, " & vbNewLine)

        TableBuild.Append("data: refuelDataSet, " & vbNewLine)
        TableBuild.Append("scrollY: 430," & vbNewLine)
        TableBuild.Append("scrollX: cw," & vbNewLine)

        TableBuild.Append("dom: 'Bfitrp', stateSave: true," & vbNewLine)

        TableBuild.Append("scrollCollapse:true," & vbNewLine)
        TableBuild.Append("scroller:true," & vbNewLine)
        TableBuild.Append("deferRender: true, " & vbNewLine)
        TableBuild.Append("fixedColumns: {leftColumns:3} ,")

        TableBuild.Append("processing: true, autoWidth: true," & vbNewLine)

        TableBuild.Append("""columnDefs"": [ ")
        TableBuild.Append(" {")
        TableBuild.Append("orderable: false,")
        TableBuild.Append("className:  'select-checkbox',")
        TableBuild.Append(" width: '10px',")
        TableBuild.Append("targets:   0")
        TableBuild.Append(" }")
        TableBuild.Append(" ],")
        TableBuild.Append("select: {")
        TableBuild.Append("style:    'multi',")
        TableBuild.Append("selector: 'td:first-child'")
        TableBuild.Append("},")

        TableBuild.Append("columns: [ " & vbNewLine)
        TableBuild.Append("{ title: ""SEL"", width: ""20px"", data: ""check""}, ")
        TableBuild.Append("{ title: ""Aircraft"", data: ""ac"", width: ""160px"" }, " & vbNewLine)
        TableBuild.Append("{ title: ""Ser#"", width: ""157px"",className: """", data:{  ")
        TableBuild.Append("_:    ""ser.0"",")
        TableBuild.Append("sort: ""ser.1"",")
        TableBuild.Append("} }, ")
        TableBuild.Append("{ title: ""Reg#"", width: ""50px"", className: """",data:""reg"" }, " & vbNewLine)
        TableBuild.Append("{ title: ""Based at"", width: ""50px"", className: """", data:""based"" }, " & vbNewLine)

        TableBuild.Append("{ title: ""Departed"", width: ""40px"",className: """", data:{  ")
        TableBuild.Append("_:    ""depart1.0"",")
        TableBuild.Append("sort: ""depart1.1"",")
        TableBuild.Append("} }, ")
        TableBuild.Append("{ title: ""From"", width: ""80px"", className: """", data:""departaport1"" }, " & vbNewLine)
        TableBuild.Append("{ title: ""IATA"", width: ""20px"", className: """", data:""originiata"" }, " & vbNewLine)
        TableBuild.Append("{ title: ""ICAO"", width: ""20px"", className: """", data:""originicao"" }, " & vbNewLine)
        TableBuild.Append("{ title: ""City"", width: ""20px"", className: """", data:""city1"" }, " & vbNewLine)
        TableBuild.Append("{ title: ""State"", width: ""20px"", className: """", data:""state1"" }, " & vbNewLine)
        TableBuild.Append("{ title: ""Country"", width: ""20px"", className: """", data:""country1"" }, " & vbNewLine)
        TableBuild.Append("{ title: ""Continent"", width: ""20px"", className: """", data:""continent1"" }, " & vbNewLine)
        TableBuild.Append("{ title: ""Distance (nm)"", width: ""60px"", className: ""text_align_right"", data:""distance1"" }, " & vbNewLine)
        TableBuild.Append("{ title: ""Arrived"", width: ""60px"",className: """", data:{  ")
        TableBuild.Append("_:    ""arrived1.0"",")
        TableBuild.Append("sort: ""arrived1.1"",")
        TableBuild.Append("} }, ")

        TableBuild.Append("{ title: ""To"", width: ""100px"", className: """", data:""arrivedaport1"" }, ")
        TableBuild.Append("{ title: ""IATA"", width: ""20px"", className: """", data:""destiata"" }, " & vbNewLine)
        TableBuild.Append("{ title: ""ICAO"", width: ""20px"", className: """", data:""desticao"" }, " & vbNewLine)
        TableBuild.Append("{ title: ""City"", width: ""20px"", className: """", data:""city2"" }, " & vbNewLine)
        TableBuild.Append("{ title: ""State"", width: ""20px"", className: """", data:""state2"" }, " & vbNewLine)
        TableBuild.Append("{ title: ""Country"", width: ""20px"", className: """", data:""country2"" }, " & vbNewLine)
        TableBuild.Append("{ title: ""Continent"", width: ""20px"", className: """", data:""continent2"" }, " & vbNewLine)
        TableBuild.Append("{ title: ""Minutes On Ground"", width: ""100px"", className: ""text_align_right"", data:""onground"" }, " & vbNewLine)
        TableBuild.Append("{ title: ""Departed"", width: ""100px"",className: """", data:{  ")
        TableBuild.Append("_:    ""departed2.0"",")
        TableBuild.Append("sort: ""departed2.1"",")
        TableBuild.Append("} }, ")


        TableBuild.Append("{ title: ""Distance (nm)"", width: ""100px"", className: ""text_align_right"",  data:""distance2"" }, " & vbNewLine)

        TableBuild.Append("{ title: ""Arrived"", width: ""100px"",className: """", data:{  ")
        TableBuild.Append("_:    ""arrived2.0"",")
        TableBuild.Append("sort: ""arrived2.1"",")
        TableBuild.Append("} }, ")

        TableBuild.Append("{ title: ""To"", width: ""100px"", className: """", data:""arrivedaport2"" }, " & vbNewLine)
        TableBuild.Append("{ title: ""IATA"", width: ""20px"", className: """", data:""arrivediata"" }, " & vbNewLine)
        TableBuild.Append("{ title: ""ICAO"", width: ""20px"", className: """", data:""arrivedicao"" }, " & vbNewLine)
        TableBuild.Append("{ title: ""City"", width: ""20px"", className: """", data:""arrivedcity"" }, " & vbNewLine)
        TableBuild.Append("{ title: ""State"", width: ""20px"", className: """", data:""arrivedstate"" }, " & vbNewLine)
        TableBuild.Append("{ title: ""Country"", width: ""20px"", className: """", data:""arrivedcountry"" } " & vbNewLine)

        TableBuild.Append("]," & vbNewLine)

        TableBuild.Append("buttons: [ " & vbNewLine)

        Dim excelButton As String = ""
        'PDF Button
        If Session.Item("localUser").crmDemoUserFlag = True Then
            TableBuild.Append(" {extend: 'pdf', enabled: false, orientation: 'landscape', pageSize: 'A2', exportOptions : {columns: ':visible'}}, ")
            TableBuild.Append("{extend: 'csv', enabled: false, exportOptions : {columns: ':visible'}}, ")
        Else
            TableBuild.Append(" {extend: 'pdf', orientation: 'landscape', pageSize: 'A2', exportOptions : {columns: ':visible'}}, ")
            TableBuild.Append("{extend: 'csv', exportOptions : {columns: ':visible'}}, ")
        End If


        TableBuild.Append("{")



        TableBuild.Append("extend: 'colvis',")
        TableBuild.Append("collectionLayout:  'fixed two-column',")
        TableBuild.Append("postfixButtons: [ 'colvisRestore', ")

        TableBuild.Append("{ text:'Show All', ")
        TableBuild.Append(" action: function( e, dt, node, config) { table.columns().visible(true);}},")

        TableBuild.Append(" ]")
        TableBuild.Append("},")


        TableBuild.Append("{ text:'Remove Selected', ")
        TableBuild.Append(" action: function( e, dt, node, config) { dt.rows( { selected: true } ).remove().draw( false );}},")
        TableBuild.Append("{ text:'Keep Selected', ")
        TableBuild.Append(" action: function( e, dt, node, config) { dt.rows( { selected: false } ).remove().draw( false );dt.draw();dt.rows('.selected').deselect();}},")

        TableBuild.Append("{ text:'Reload Table', action: function( e, dt, node, config) { $('#startTable').empty();refuelSummaryTable();}},")

        'Excel Button
        CreateExcelButton(excelButton, "refuelSummary")

        TableBuild.Append(excelButton & vbNewLine)
        TableBuild.Append("]")
        TableBuild.Append("});}refuelSummaryTable();")


        TableBuild.Append("setTimeout(function(){$($.fn.dataTable.tables(true)).DataTable().columns.adjust();")
        TableBuild.Append("$($.fn.dataTable.tables(true)).DataTable().scroller.measure();}, 1000);")

        Return TableBuild.ToString
    End Function

    Private Shared Function BuildButtonString(ByRef JSFunctionName As String) As String
        Dim ButtonsString As New StringBuilder
        Dim exportOptions As String = ""
        Dim ExcelButton As String = ""
        exportOptions += "columns: [function ( idx, data, node ) {"
        exportOptions += "var isVisible = table.column( idx ).visible();"
        exportOptions += "if ((typeof hideFromExport === 'undefined') || (hideFromExport === null))"
        exportOptions += " { var isNotForExport = false;} "
        exportOptions += " else {"
        exportOptions += "  var isNotForExport = $.inArray( idx, hideFromExport ) !== -1;"
        exportOptions += " };"
        exportOptions += "return isVisible && !isNotForExport ? true : false; "
        'ExportOptions += "}"
        exportOptions += "}, 'colvis']"

        'CreateExcelButton(excelButton, "refuelSummary")


        If HttpContext.Current.Session.Item("localUser").crmDemoUserFlag = True Then
            ButtonsString.Append("{")
            ButtonsString.Append("extend:  'csv', enabled: false, ")
            ButtonsString.Append("exportOptions: {")
            ButtonsString.Append(exportOptions)
            ButtonsString.Append("}")
            ButtonsString.Append("}, ")
            'Excel Button
            ButtonsString.Append("{extend: 'excel', enabled: false,  messageBottom: null, messageTop: null, title: null,")
            ButtonsString.Append("exportOptions: {")
            ButtonsString.Append(exportOptions)
            ButtonsString.Append("}")
            ButtonsString.Append("},")
            'PDF Button
            ButtonsString.Append(" {extend: 'pdf', enabled: false, orientation: 'landscape', pageSize: 'A2', ")
            ButtonsString.Append("exportOptions: {")
            ButtonsString.Append(exportOptions)
            ButtonsString.Append("}")
            ButtonsString.Append("}, ")
        Else
            ButtonsString.Append("{")
            ButtonsString.Append("extend:  'csv',")
            ButtonsString.Append("exportOptions: {")
            ButtonsString.Append(exportOptions)
            ButtonsString.Append("}")
            ButtonsString.Append("}, ")
            'Excel Button
            ButtonsString.Append("{extend: 'excel',  messageBottom: null, messageTop: null, title: null,")
            ButtonsString.Append("exportOptions: {")
            ButtonsString.Append(exportOptions)
            ButtonsString.Append("}")
            ButtonsString.Append("},")
            'PDF Button
            ButtonsString.Append(" {extend: 'pdf', orientation: 'landscape', pageSize: 'A2', ")
            ButtonsString.Append("exportOptions: {")
            ButtonsString.Append(exportOptions)
            ButtonsString.Append("}")
            ButtonsString.Append("}, ")
        End If

        'CSV Button:

        'Column Visibility Button
        ButtonsString.Append("{")
        ButtonsString.Append("extend: 'colvis', text: 'Columns',")
        ButtonsString.Append("collectionLayout:  'fixed two-column',")
        ButtonsString.Append("postfixButtons: [ 'colvisRestore',")
        ButtonsString.Append("{ text:'Show All', ")
        ButtonsString.Append(" action: function( e, dt, node, config) { table.columns().visible(true);}},")

        ButtonsString.Append(" ]")
        ButtonsString.Append("},")


        'Remove Selected Button:

        ButtonsString.Append("{ text:'Remove Selected', ")
        ButtonsString.Append(" action: function( e, dt, node, config) { dt.rows( { selected: true } ).remove().draw( false );}},")
        ButtonsString.Append("{ text:'Keep Selected', ")
        ButtonsString.Append(" action: function( e, dt, node, config) { dt.rows( { selected: false } ).remove().draw( false );dt.draw();dt.rows('.selected').deselect();}},")

        ButtonsString.Append("{ text:'Reload Table', action: function( e, dt, node, config) { $('#startTable').empty();" & JSFunctionName & "();}}")


        Return ButtonsString.ToString

    End Function

    Private Sub BuildOnLoadJavascript(ByVal currentTableArray As String, ByVal TableBuild As String)
        If currentTableArray = "" Then
            TableBuild = TableBuild
        Else
            TableBuild = "var hideFromExport = [0];" & TableBuild
        End If


        Dim JavascriptPostback As String = ""
        If Page.IsPostBack Then

            JavascriptPostback += currentTableArray.ToString

            JavascriptPostback += TableBuild.ToString

            System.Web.UI.ScriptManager.RegisterClientScriptBlock(Me.bottom_tab_update_panel, Me.GetType(), "resetTable", JavascriptPostback, True)
        Else
            If Not Page.ClientScript.IsClientScriptBlockRegistered("operatorArrayLoad") Then
                Dim JavascriptOnLoad As String = ""
                JavascriptOnLoad = vbCrLf & "if (window.addEventListener) {"
                JavascriptOnLoad += vbCrLf & " window.addEventListener(""load"", "
                JavascriptOnLoad += vbCrLf & "function () {"


                'function goes here.
                JavascriptOnLoad += currentTableArray.ToString
                JavascriptOnLoad += TableBuild.ToString
                JavascriptOnLoad += vbCrLf & ";$(""body"").removeClass(""loading"");}, false); "
                JavascriptOnLoad += vbCrLf & "}" 'Else 
                JavascriptOnLoad += vbCrLf & "else {"

                JavascriptOnLoad += vbCrLf & " window.attachEvent(""load"","
                JavascriptOnLoad += vbCrLf & "function () {"
                JavascriptOnLoad += currentTableArray.ToString
                JavascriptOnLoad += TableBuild.ToString
                JavascriptOnLoad += vbCrLf & ";$(""body"").removeClass(""loading"");});"

                JavascriptOnLoad += vbCrLf & "}" 'End if

                If Not Page.ClientScript.IsClientScriptBlockRegistered("onLoadCode") Then
                    System.Web.UI.ScriptManager.RegisterStartupScript(Me, Me.GetType(), "onLoadCode", JavascriptOnLoad.ToString, True)
                End If
            End If
        End If

    End Sub

    Public Sub re_run_airport_view() Handles submit_date_change.Click
        Dim temp_prod As String = ""
        Dim temp_val As String = ""

        temp_val = ac_projects_ddl.SelectedValue
        If InStr(temp_val, "+") > 0 Then
            temp_val = Right(temp_val, Len(temp_val) - InStr(temp_val, "+"))
            temp_val = Replace(temp_val, "+", "")
        End If


        'Call load_standalone_view()
        Call create_product_checks("", temp_prod)
        Response.Redirect("view_template.aspx?ViewID=24&ViewName=Airport Activity View&activetab=1&start_date=" & Me.start_date.Text & "&end_date=" & Me.end_date.Text & temp_prod & "&flight=" & temp_val & "")

    End Sub

    Public Sub create_product_checks(ByRef product_code_selection As String, ByRef product_link As String)
        ' if anything is checked
        If Me.check_busj.Checked = True Or Me.check_bust.Checked = True Or Me.check_heli.Checked = True Or Me.check_comm.Checked = True Then
            product_code_selection = " and ( "
            If Me.check_busj.Checked = True Then
                product_code_selection &= " ( ac_product_business_flag = 'Y' and amod_type_code in ('E','J') ) "
                product_link &= "&check_busj=Y"
            Else
                product_link &= "&check_busj=N"
            End If

            If Me.check_busj.Checked = True And Me.check_bust.Checked = True Then
                product_code_selection &= "  or ( ac_product_business_flag = 'Y' and amod_type_code in ('T','P') ) "
                product_link &= "&check_bust=Y"
            ElseIf Me.check_bust.Checked = True Then
                product_code_selection &= "  ( ac_product_business_flag = 'Y' and amod_type_code in ('T','P')  ) "
                product_link &= "&check_bust=Y"
            Else
                product_link &= "&check_bust=N"
            End If

            If (Me.check_busj.Checked = True And Me.check_heli.Checked = True) Or (Me.check_bust.Checked = True And Me.check_heli.Checked = True) Then
                product_code_selection &= " or ( ac_product_helicopter_flag = 'Y' ) "
                product_link &= "&check_heli=Y"
            ElseIf Me.check_heli.Checked = True Then
                product_code_selection &= " ( ac_product_helicopter_flag = 'Y' ) "
                product_link &= "&check_heli=Y"
            Else
                product_link &= "&check_heli=N"
            End If

            If (Me.check_busj.Checked = True And Me.check_comm.Checked = True) Or (Me.check_bust.Checked = True And Me.check_comm.Checked = True) Or (Me.check_heli.Checked = True And Me.check_comm.Checked = True) Then
                product_code_selection &= " or ( ac_product_commercial_flag = 'Y' ) "
                product_link &= "&check_comm=Y"
            ElseIf Me.check_comm.Checked = True Then
                product_code_selection &= " ( ac_product_commercial_flag = 'Y' ) "
                product_link &= "&check_comm=Y"
            Else
                product_link &= "&check_comm=N"
            End If

            product_code_selection &= " ) "
        End If

    End Sub

    Public Sub Build_Airport_FBO_Summary_tab(ByRef searchCriteria As viewSelectionCriteriaClass, ByRef out_htmlString As String)
        Dim sQuery = New StringBuilder()
        Dim results_table As New DataTable
        Dim airport_fbo_functions As New airport_fbo_view_functions
        Dim this_section_string As String = ""
        Dim active_tab As Integer = 0
        Dim active_tab_top As Integer = 0
        Dim aclsData_Temp As New clsData_Manager_SQL
        Dim charting_string As String = ""
        Dim AirportData As New DataTable
        Dim last_year_count As Long = 0
        Dim location_name As String = ""
        Dim this_section_string2 As String = ""
        Dim temp_distance As Integer = 0
        Dim orig_lat As Double = 0.0
        Dim orig_long As Double = 0.0
        Dim aport_id As Integer = 0
        Dim amod_id As Integer = 0
        Dim recent_flight_months As Integer = 3
        Dim is_located_here As Boolean = True
        Dim temp_distance_company As Integer = 0
        Dim temp_data As String = ""
        Dim airport_table As New DataTable
        Dim originate_date As String = ""
        Dim product_code_selection As String = ""
        Dim product_link As String = ""

        Try
            'Adding jquery 10/26/15.
            'Here is where we actually tell aspx to use the function we're creating.
            tabs_container.OnClientActiveTabChanged = "RunTopTabJqueryFBO"
            'This basically runs on the clientActiveTabChanged of the top tab container.
            'It gets sent the sender, which is the tabcontainer. It checks the active tab index, which is 6 for the myAirportsTab
            'If it's six, it triggers a button inside of the tabcontainer's update panel to click, causing a postback for that update panel.
            'All of the code to run the myaiports tab should be located in the aspx event for the button click.
            If Not Page.ClientScript.IsClientScriptBlockRegistered("RunTopTabJqueryFBO") Then
                Dim TopTabJquery As New StringBuilder
                TopTabJquery.Append("function RunTopTabJqueryFBO(sender, args) { ")
                TopTabJquery.Append(" if (sender.get_activeTabIndex() == 6) {")

                TopTabJquery.Append(" if ($(""#" & myairportsLabelRan.ClientID & """).text() == '') {") 'If this is filled up, it doesn't get ran. Only running on initial click.
                TopTabJquery.Append("document.body.style.cursor='wait';")
                TopTabJquery.Append(" $(""#" & invisibleAirportFBOButtonToCausePostback.ClientID & """).click();")
                TopTabJquery.Append("}") ' end value of myairportslabran is empty.

                TopTabJquery.Append("}") ' end sender get active tab
                TopTabJquery.Append("}") 'end function
                System.Web.UI.ScriptManager.RegisterStartupScript(Me, Me.GetType(), "RunTopTabJqueryFBO", TopTabJquery.ToString, True)
            End If


            UpdateProgress1.Visible = True 'Enable the update progress tab loading screen
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />" & Date.Now & " - FBO View START---<br />"


            If IsNothing(Session("Last_FBO_Bottom")) Then
                Session("Last_FBO_Bottom") = -1
            End If

            If Not IsPostBack Then
                Session("Last_FBO_Bottom") = -1
            End If


            If Trim(Request("months")) <> "" Then
                localCriteria.ViewCriteriaTimeSpan = CDbl(Trim(Request("months")))
            Else
                localCriteria.ViewCriteriaTimeSpan = 12
            End If

            If Trim(Request("distance")) <> "" Then
                temp_distance = Trim(Request("distance"))
            Else
                temp_distance = 150
            End If

            If Trim(Request("cdistance")) <> "" Then
                temp_distance_company = Trim(Request("cdistance"))
            Else
                temp_distance_company = 25
            End If

            If Not IsPostBack Then
                Me.company_range.SelectedValue = temp_distance_company
            End If

            If Not IsPostBack Then
                If Trim(Request("recent")) <> "" Then
                    recent_flight_months = Trim(Request("recent"))
                    Me.fbo_months_drop.SelectedValue = recent_flight_months
                Else
                    recent_flight_months = 3
                End If
            End If


            If IsNothing(Session("Last_Airport_Range")) Then
                Session("Last_Airport_Range") = ""
            End If


            If Me.ac_based.Checked Then
                is_located_here = True
            Else
                is_located_here = False
            End If


            If Not IsPostBack Then

            End If

            Call create_product_checks(product_code_selection, product_link)

            topLeftCSSContainer.CssClass = ""
            airport_fbo_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            airport_fbo_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            airport_fbo_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            airport_fbo_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            airport_fbo_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim


            aclsData_Temp.JETNET_DB = Application.Item("crmClientSiteData").AdminDatabaseConn
            aclsData_Temp.JETNET_DB = Application.Item("crmJetnetDatabase")
            aclsData_Temp.client_DB = Application.Item("crmClientDatabase")



            If TabContainer1.ActiveTabIndex <> 0 Then
                active_tab = TabContainer1.ActiveTabIndex
            End If




            '------------------------------------------------------------------------ 
            Me.TabContainer1.Visible = True
            Me.tabs_container.Visible = True

            'Toggle the search bar on:
            airportFBOViewSearchCell.Visible = True
            'These are just shut off with CSS for now (on purpose). I'm not sure what type of error
            'may occur if the control can't find the listboxes to fill them, so I'm toggling it off till I can stop
            'the control from loading.
            cellTypeMakeModel.CssClass = "display_none"
            cellTimeSpan.CssClass = "display_none"
            cellGoApply.CssClass = "display_none"

            If Not IsPostBack Then
                Me.view_trends_label.Text = "Please Wait a Moment for Aircraft Based In this Location..."
                Me.view_for_sale_label.Text = "Please Wait a Moment for Flight Activity..."
                Me.view_retail_sales_label1.Text = "Please Wait a Moment for Company Directory..."
                Me.view_events_label.Text = "Please Wait a Moment for Owners..."
                Me.view_news_label1.Text = "Please Wait a Moment for Operators..."
                Me.view_reports_label.Text = "The following represents a list of 'MyAirports' as identified"
            End If


            'Me.view_documents_label1.Text = "Please Wait a Moment for Documents Data..."
            'Me.view_operators_label.Text = "Please Wait a Moment for Operator Data..."
            'Me.view_charter_label1.Text = "Please Wait a Moment for Charter Data..."
            'Me.view_lease_label.Text = "Please Wait a Moment for Lease Data..."
            'Me.view_for_sale_label.Text = "Please Wait a Moment for For Sale Data..."
            'Me.view_location_tab_label.Text = "Please Wait a Moment for Location Data..."
            'Me.view_spi_label.Text = "Please Wait a Moment for SPI Data..."
            'Me.view_star_reports_label.Text = "Please Wait a Moment for Star Report Data..."
            'Me.view_fractional_label.Text = "Please Wait a Moment for Fractional Data..."

            Me.trends_tab.HeaderText = "Aircraft Based Here"    ' tab 1 
            Me.for_sale_tab.HeaderText = "Flight Activity"      ' tab 2
            Me.retail_tab.HeaderText = "Company Directory"      ' tab 3
            Me.event_tab.HeaderText = "Owners"                  ' tab 4
            Me.news_tab.HeaderText = "Operators"                ' tab 5

            '-----------------------------------------------------

            Me.documents_tab.HeaderText = ""
            Me.operators_tab.HeaderText = ""
            Me.charter_tab.HeaderText = ""
            Me.lease_tab.HeaderText = ""
            Me.spi_tab.HeaderText = ""
            Me.location_tab.HeaderText = ""
            Me.star_tab.HeaderText = ""
            Me.range_tab.HeaderText = ""
            Me.fractional_tab.HeaderText = ""

            Me.wanted_tab.Visible = False
            Me.documents_tab.Visible = False
            Me.operators_tab.Visible = False
            Me.charter_tab.Visible = False
            Me.lease_tab.Visible = False
            Me.spi_tab.Visible = False
            Me.location_tab.Visible = False
            Me.star_tab.Visible = False
            Me.range_tab.Visible = False
            Me.fractional_tab.Visible = False
            Me.update_sold_panel2.Visible = False

            this_section_string = ""
            Me.view_market_status_label.Text = ""

            If IsNothing(Session("Last_Aport_ID")) Then
                Session("Last_Aport_ID") = 0
            End If

            If Not IsPostBack Then
                'Replacing the function call to fill this up with the subscription FAA last date. 
                'If IsNothing(Session("Last_FAA_DATE")) Then
                Session("Last_FAA_DATE") = Session.Item("localSubscription").crmSubinst_FAA_data_date
                'Call airport_fbo_functions.get_flight_activity_last_function(searchCriteria, Session("Last_FAA_DATE"))
                'ElseIf Trim(Session("Last_FAA_DATE")) = "" Then
                'Call airport_fbo_functions.get_flight_activity_last_function(searchCriteria, Session("Last_FAA_DATE"))
                'End If
            End If


            If Trim(Request("aport_id")) <> "" Then
                aport_id = Trim(Request("aport_id"))
                Session("Last_Aport_ID") = aport_id
            Else
                If Session("Last_Aport_ID") = 0 Then
                    aport_id = airport_fbo_functions.get_default_airport_id(searchCriteria, Session.Item("localPreferences").UserCompanyID, "City", 0)
                    If aport_id = 0 Then
                        aport_id = airport_fbo_functions.get_default_airport_id(searchCriteria, Session.Item("localPreferences").UserCompanyID, "Radius", 25)
                    End If
                    If aport_id = 0 Then
                        aport_id = airport_fbo_functions.get_default_airport_id(searchCriteria, Session.Item("localPreferences").UserCompanyID, "State", 0)
                    End If
                Else
                    aport_id = Session("Last_Aport_ID")
                End If
            End If


            If Page.IsPostBack Then
                If IsNumeric(selectAirportID.Text) Then
                    aport_id = selectAirportID.Text
                    Session("Last_Aport_ID") = aport_id
                End If
            End If

            Dim isAircraftSearch As Boolean = HttpContext.Current.Request.Form(fboViewSearch_Button.UniqueID) IsNot Nothing
            If isAircraftSearch Then
                Session("Last_FBO_Bottom") = -1
            End If

            airport_fbo_functions.Airport_ID_OVERALL = aport_id

            'clear any model data
            localCriteria.ViewCriteriaAmodID = -1
            localCriteria.ViewCriteriaAircraftMake = ""
            localCriteria.ViewCriteriaAircraftModel = ""

            If Trim(Request("amod_id")) <> "" Then
                amod_id = Trim(Request("amod_id"))
                localCriteria.ViewCriteriaAmodID = amod_id
            End If






            AirportData = localDatalayer.get_range_airports_by_IATA_or_ICAO(localCriteria, aport_id)



            ' If Trim(Request("no_map")) = "Y" Then 
            'Me.airport_map_div.Visible = False
            Me.label_behind_pic.Visible = True
            Me.label_behind_pic.Text = ""
            Call localDatalayer.get_airport_information(AirportData, Me.label_behind_pic.Text, localCriteria, location_name, orig_lat, orig_long)


            ' Me.label_behind_pic.Text &= "<Br><A href='AirportLocationMap.aspx?aportLat=" & orig_lat & "&aportLong=" & orig_long & "&aportTitle=" & localCriteria.ViewCriteriaAirportName & "' target='_blank'>View Airport Location</a>"

            ' Else 
            Me.airport_map_div.Visible = True
            fboMapScript.Visible = True
            ' Call localDatalayer.get_airport_information(AirportData, Me.view_market_status_label.Text, localCriteria, location_name, orig_lat, orig_long)
            System.Web.UI.ScriptManager.RegisterStartupScript(Me.TabContainer1, Me.GetType, "fbo_view_map_script", "setUpAutoComplete();initialize_view_mapWithCenter(" + orig_lat.ToString + ", " + orig_long.ToString + ", 'airport_map_label');add_location_view_marker('" + Replace(localCriteria.ViewCriteriaAirportName.Trim, "'", "") + "'," + orig_lat.ToString + ", " + orig_long.ToString + ", -1, '', viewMapFBO);" + vbCrLf, True)
            ' End If


            Dim TemporaryTable As New DataTable


            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />" & Date.Now & " - FBO View Airport Filter Start---<br />"


            'If Trim(Session.Item("Airport_Filter")) <> "" Then
            ' no need to re-go get
            'Else 

            'Edit 10/29/15: Amanda.
            'I have surrounded this to only run on first page load by checking for postback.
            'Since it appears that the postbacks occurring on the Airport FBO tab view
            'are happening inside of update panels, this only should need to run once to have it 
            'stay on the page for searching purposes. This was done to address a speed issue on the my airports tab.
            If Not Page.IsPostBack Then
                'TemporaryTable = localDatalayer.ListOfActiveAirportsControlled()
                'temp_data = DisplayAirportsForFilter(TemporaryTable)
                '' End If


                ''fboViewSearchResultsJS.Text = "<script type=""text/javascript"">"
                ''fboViewSearchResultsJS.Text += "locations = [" & vbNewLine


                'fboViewSearchResultsJS.Text = "<ul class=""commentlist"" id=""fboViewUL"">"
                'fboViewSearchResultsJS.Text += temp_data
                'fboViewSearchResultsJS.Text += "</ul>"
                'fboViewSearchResultsJS.Text += "]" & vbNewLine
                'fboViewSearchResultsJS.Text += "</script>"
                'fboViewSearchResultsJS.CssClass = "display_none"
            End If

            'fboViewSearch_ResultsLabel.CssClass = "display_none"
            fboViewSearch_ResultsLabel.CssClass = ""

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />" & Date.Now & " - FBO View Airport Filter End---<br />"


            Me.make_model_name_label.Text = localCriteria.ViewCriteriaAirportName
            'Me.label_behind_pic.Text = "MAP HERE"
            '  Me.label_behind_pic.Visible = False
            Me.aircraft_image.Visible = False

            If Not IsNothing(Session("Last_FAA_DATE")) Then
                If Trim(Session("Last_FAA_DATE")) <> "" Then
                    originate_date = DateAdd(DateInterval.Year, -2, Session("Last_FAA_DATE"))
                    originate_date = DateAdd(DateInterval.Day, 1, CDate(originate_date))
                    breadcrumbs.Text = "<strong>" + make_model_name_label.Text.Trim + " " + View_Name.Trim + " (<a href='/help/documents/589.pdf' target='_blank'>Flight Data as of " & Format(CDate(Trim(Session("Last_FAA_DATE"))), "MM/dd/yyyy hh:mm") & " UTC)</a></strong>"
                Else
                    breadcrumbs.Text = "<strong>" + make_model_name_label.Text.Trim + " " + View_Name.Trim + " (<a href='/help/documents/589.pdf' target='_blank'>Flight Data)</a></strong>"
                End If
            Else
                breadcrumbs.Text = "<strong>" + make_model_name_label.Text.Trim + " " + View_Name.Trim + " (<a href='/help/documents/589.pdf' target='_blank'>Flight Data)</a></strong>"
            End If


            Me.loaded_visibility.Visible = True
            Me.loaded_visibility1.Visible = False
            divLoading.Visible = False
            loaded_visibility.CssClass = "display_block"
            PanelCollapseEx.Collapsed = True
            PanelCollapseEx.ClientState = "True"

            Me.evo_view_help.Text = "<a class='underline' onclick='javascript:load(""/help/documents/599.pdf"","""",""scrollbars=yes,menubar=no,height=900,width=1150,resizable=yes,toolbar=no,location=no,status=no"");'>"
            Me.evo_view_help.Text &= "<img src='../images/info_white.png' class='float_left' border='0' alt='Show View Help'"
            Me.evo_view_help.Text &= "title='Show View Help' style='padding-bottom: 2px;' /></a>"


            Me.model_market_status_tab.HeaderText = "Overview"
            Me.model_fleet_tab.HeaderText = "Top Origins/Destinations"
            Me.model_performance_tab.HeaderText = "Top Models"
            Me.model_operating_costs_tab.HeaderText = "Top Aircraft"
            Me.model_description_tab.HeaderText = "Nearby Airports"
            Me.model_flight_tab.HeaderText = "Aircraft Lookup"
            Me.model_reports_tab.HeaderText = "MyAirports"
            Me.model_reports_tab.Visible = True
            Me.model_flight_tab.Visible = True
            Me.reg_search_panel.Visible = True
            Me.crm_view_view_all.Visible = False
            Me.airport_overview_type.Visible = True
            Me.overview_label.Visible = True
            Me.right_side_overview.Visible = True
            Me.right_side_overview.Text = "<b> For the Last Year "
            Me.months_choice.Visible = True
            Me.my_airports_label.Visible = True
            Me.my_airports_label.Text = "FAA Flight Arrivals Based On "
            '------------------------------------------------------------------------

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />" & Date.Now & " - FBO View Before Post Back Functions<br />"



            '
            If Len(Trim(Me.view_reports_label.Text)) < 65 Then
                Me.view_reports_label.Text = "<tr><td>No Airports Selected</td></tr></table>"
                Me.my_airports_label.Visible = False
                Me.months_choice.Visible = False
                Me.view_reports_label.Text = "<div class=""clearfix margin-bottom padding""></div>" & Me.view_reports_label.Text & "<div class=""clearfix margin-bottom margin-top padding""></div>"
            End If


            ' add the header on it either way 
            If InStr(Me.view_reports_label.Text, "fractionsExpiringOuterTable") = 0 Then
                Me.view_reports_label.Text = "<table id=""fractionsExpiringOuterTable"" width=""100%"" cellpadding=""0"" cellspacing=""0"" class=""module""><tr><td valign=""top"" align=""center"" class=""header"">To modify your airport list below click <A href='Preferences.aspx' target='_blank'>Here</a> and use the 'MyAirports' tab.</td></tr>" & Me.view_reports_label.Text
            End If



            If Not IsPostBack Then


                '-- ***************  TAB UNKNOWN - LIST OF BUSINESS TYPES AT AIRPORT ************************
                '-- SELECT A SUMMARY OF COMPANIES LOCATED AT SPECIFIC AIRPORT OR SAME CITY 
                Call airport_fbo_functions.get_bus_type_from_companies_from_airport_top_function(searchCriteria, Me.ac_projects_ddl2, Trim(Request("bus_type")), temp_distance_company, orig_lat, orig_long)

                If Trim(Request("activetab")) <> "" Then
                    active_tab = CDbl(Trim(Request("activetab")))
                    TabContainer1.ActiveTabIndex = active_tab
                End If

                If Trim(Request("top_active_tab")) <> "" Then
                    tabs_container.ActiveTabIndex = CInt(Request("top_active_tab"))
                Else
                    If tabs_container.ActiveTabIndex <> 0 Then
                        active_tab_top = tabs_container.ActiveTabIndex
                    End If
                End If

                '  Call Build_Location_Tab(searchCriteria, airport_fbo_tab_label.Text)
                '  add_ChangeTopActiveTab_Script(tabs_container)

                Me.ac_projects_ddl.Visible = True
                ac_projects_ddl.Items.Clear()
                ac_projects_ddl.Items.Add(New System.Web.UI.WebControls.ListItem("Arrivals", "A"))
                ac_projects_ddl.Items.Add(New System.Web.UI.WebControls.ListItem("Departures", "D"))

                If Trim(Request("flight")) <> "" Then
                    ac_projects_ddl.SelectedValue = Trim(Request("flight"))
                End If

                Me.operator_drop.Visible = True
                operator_drop.Items.Clear()
                operator_drop.Items.Add(New System.Web.UI.WebControls.ListItem("Operators Based at this Airport", ""))
                operator_drop.Items.Add(New System.Web.UI.WebControls.ListItem("Operators Utilizing this Airport", "F"))

                Me.owner_drop.Visible = True
                owner_drop.Items.Clear()
                owner_drop.Items.Add(New System.Web.UI.WebControls.ListItem("Owners Based at this Airport", ""))
                owner_drop.Items.Add(New System.Web.UI.WebControls.ListItem("Owners Utilizing this Airport", "F"))

                Me.owner_drop_19.Visible = True
                owner_drop_19.Items.Clear()
                owner_drop_19.Items.Add(New System.Web.UI.WebControls.ListItem("Owners Based at this Airport", ""))
                owner_drop_19.Items.Add(New System.Web.UI.WebControls.ListItem("Owners Utilizing this Airport", "F"))



                If Trim(Request("operator_drop")) <> "" Then
                    operator_drop.SelectedValue = Trim(Request("flight"))
                End If



                If Trim(Request("activetab")) <> "" And Not IsPostBack Then
                    If CInt(Trim(Request("activetab"))) = 3 Then
                        Me.owner_drop.SelectedValue = "F"
                        Me.check_owner_ac.Checked = False
                    ElseIf CInt(Trim(Request("activetab"))) = 4 Then
                        Me.operator_drop.SelectedValue = "F"
                        Me.check_operator_ac.Checked = False
                    End If
                End If


                '-- ***********************************************************************
                '-- BY AIRPORT 
                '-- # FLIGHT ACTIVITY OVERALL  

                Call run_airport_functions_top(airport_fbo_functions, searchCriteria, last_year_count, product_code_selection, this_section_string, charting_string, is_located_here, temp_distance, orig_lat, orig_long, aport_id)

            Else

                ' Call run_airport_functions_top(airport_fbo_functions, searchCriteria, last_year_count, product_code_selection, this_section_string, charting_string, is_located_here, temp_distance, orig_lat, orig_long, aport_id)

                Call airport_fbo_functions.get_flight_activity_overall_top_function(searchCriteria, last_year_count, product_code_selection)

                ' if its changed, then re-run the graph
                If Me.last_overview_type.Text <> Me.airport_overview_type.SelectedValue Then
                    this_section_string = ""
                    Call airport_fbo_functions.get_flight_profile_top_function(searchCriteria, this_section_string, Me.airport_overview_type.SelectedValue, Session("Last_FAA_DATE"))
                    hidden_spi_graph_text.Text = this_section_string
                    Me.last_overview_type.Text = Me.airport_overview_type.SelectedValue
                Else
                    this_section_string = hidden_spi_graph_text.Text
                End If

                Me.right_side_overview.Text &= "(" & FormatNumber(last_year_count, 0) & ")</b>"

                If Me.airport_overview_type.SelectedValue = "Month" Then
                    DisplayFunctions.load_google_chart(model_market_status_tab, this_section_string, "", "Flights Per Month", "chart_div_tab1", 640, 275, "POINTS", 1, charting_string, Me.Page, Me.top_tab_update_panel, False, True, True, False, False, False, False, True, False)
                ElseIf Me.airport_overview_type.SelectedValue = "BWeight" Or Me.airport_overview_type.SelectedValue = "TWeight" Or Me.airport_overview_type.SelectedValue = "HWeight" Then
                    DisplayFunctions.load_google_chart(model_market_status_tab, this_section_string, "", "Flights Per Month", "chart_div_tab1", 640, 275, "POINTS", 1, charting_string, Me.Page, Me.top_tab_update_panel, False, True, True, False, True, False, False, True, False)
                ElseIf Me.airport_overview_type.SelectedValue = "Type" Then
                    DisplayFunctions.load_google_chart(model_market_status_tab, this_section_string, "", "Flights Per Month", "chart_div_tab1", 640, 275, "POINTS", 1, charting_string, Me.Page, Me.top_tab_update_panel, False, True, True, False, True, False, False, True, False)
                End If

            End If

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />" & Date.Now & " - FBO View After Post Back - Before Functions<br />"


            If active_tab = 0 And Session("Last_FBO_Bottom") <> 0 Then
                '-- ***************  LOWER TAB 1 - AIRCDRAFT BASED ************************
                '-- SAME BASIC LIST AS NORMAL FOR AIRCRAFT AT THAT LOCATION
                this_section_string = ""
                Call airport_fbo_functions.get_normal_ac_for_location_top_function(searchCriteria, this_section_string, aclsData_Temp, location_name, Me.AircraftSearchDataGrid, product_code_selection)    ' TONS OF FIELDS 
                Me.view_trends_label.Text = this_section_string
                Me.view_trends_label.Text &= "<div style=""height: 250px; overflow: auto;"">"
                Me.AircraftSearchDataGrid.Visible = True
                Me.end_div.Visible = True
                Session("Last_FBO_Bottom") = 0
            ElseIf active_tab = 1 Then
                '-- ***************  LOWER TAB 2 - RECENT FLIGHT ACTIVITY ************************
                '-- # FLIGHT ACTIVITY MOST RECENT

                'Me.fbo_months_drop.Visible = True
                Me.compare_view_current_label2.Visible = True

                this_section_string = ""
                Call airport_fbo_functions.get_most_recent_flight_activity_top_function(searchCriteria, this_section_string, location_name, Trim(Request("export")), Me.compare_view_current_label.Text, Me.compare_view_current_label2.Text, Me.ac_projects_ddl.SelectedValue, recent_flight_months, start_date.Text, end_date.Text, product_code_selection, product_link)  ' TONS OF FIELDS
                Me.view_for_sale_label.Text = this_section_string
                Session("Last_FBO_Bottom") = 1

            ElseIf active_tab = 2 And Session("Last_FBO_Bottom") <> 2 Then
                '-- ***************  LOWER TAB 3 - COMPANY DIRECTORY ************************
                '-- SELECT A LIST OF COMPANIES LOCATED AT SPECIFIC AIRPORT OR SAME CITY  


                If searchCriteria.ViewCriteriaCountry = "United States" Then
                    Me.ac_projects_ddl2.Visible = True
                    Me.compare_view_sold_label.Visible = True
                    Me.company_range.Visible = True
                    Me.compare_view_sold_label2.Visible = True
                Else
                    Me.ac_projects_ddl2.Visible = False
                    Me.compare_view_sold_label.Visible = False
                    Me.company_range.Visible = False
                    Me.compare_view_sold_label2.Visible = True ' this is the only one that shuld be visible
                End If




                this_section_string = ""
                Call airport_fbo_functions.get_companies_in_city_top_function(searchCriteria, this_section_string, location_name, Trim(Request("bus_type")), Me.compare_view_sold_label.Text, Trim(Request("export")), aport_id, temp_distance_company, orig_lat, orig_long, Me.compare_view_sold_label2.Text)

                If searchCriteria.ViewCriteriaCountry <> "United States" Then
                    Me.compare_view_sold_label2.Text = "Companies Located at " & searchCriteria.ViewCriteriaCity & ", " & searchCriteria.ViewCriteriaCountry
                End If

                Me.view_retail_sales_label1.Text = this_section_string
                Session("Last_FBO_Bottom") = 2

            ElseIf active_tab = 3 Then
                '-- ***************  LOWER TAB 4 - OWNERS ************************
                '-- SELECT A LIST OF COMPANIES OWNING AIRCRAFT AT SPECIFIC AIRPORT 
                this_section_string = ""

                If IsPostBack = False And Trim(Request("export")) <> "" Then
                    If Trim(Request("export")) <> "" And Trim(Request("export")) <> "OW" Then
                        Call airport_fbo_functions.get_companies_from_airport_top_function(searchCriteria, this_section_string, location_name, "Owner", Trim(Request("export")), aport_id, Me.check_owner_ac.Checked) ' TONS OF FIELDS
                    Else
                        Call airport_fbo_functions.get_most_recent_flight_activity_companies_top_function(searchCriteria, this_section_string, location_name, Trim(Request("export")), Me.compare_view_current_label.Text, Me.compare_view_current_label2.Text, Me.ac_projects_ddl.SelectedValue, recent_flight_months, "00", Me.check_owner_ac.Checked, start_date.Text, end_date.Text, product_code_selection)  ' TONS OF FIELDS
                    End If
                Else
                    If owner_drop.SelectedValue = "" Then
                        Call airport_fbo_functions.get_companies_from_airport_top_function(searchCriteria, this_section_string, location_name, "Owner", Trim(Request("export")), aport_id, Me.check_owner_ac.Checked) ' TONS OF FIELDS
                    Else
                        Call airport_fbo_functions.get_most_recent_flight_activity_companies_top_function(searchCriteria, this_section_string, location_name, Trim(Request("export")), Me.compare_view_current_label.Text, Me.compare_view_current_label2.Text, Me.ac_projects_ddl.SelectedValue, recent_flight_months, "00", Me.check_owner_ac.Checked, start_date.Text, end_date.Text, product_code_selection)  ' TONS OF FIELDS
                    End If
                End If

                Me.view_events_label.Text = this_section_string
                Session("Last_FBO_Bottom") = 3
            ElseIf active_tab = 4 Then
                this_section_string = ""

                If IsPostBack = False And Trim(Request("export")) <> "" Then
                    If Trim(Request("export")) <> "" And Trim(Request("export")) <> "OP" Then
                        Call airport_fbo_functions.get_companies_from_airport_top_function(searchCriteria, this_section_string, location_name, "Operator", Trim(Request("export")), aport_id, Me.check_operator_ac.Checked) ' TONS OF FIELDS
                    Else
                        Call airport_fbo_functions.get_most_recent_flight_activity_companies_top_function(searchCriteria, this_section_string, location_name, Trim(Request("export")), Me.compare_view_current_label.Text, Me.compare_view_current_label2.Text, Me.ac_projects_ddl.SelectedValue, recent_flight_months, "36", Me.check_operator_ac.Checked, start_date.Text, end_date.Text, product_code_selection)  ' TONS OF FIELDS
                    End If
                Else
                    If operator_drop.SelectedValue = "" Then
                        Call airport_fbo_functions.get_companies_from_airport_top_function(searchCriteria, this_section_string, location_name, "Operator", Trim(Request("export")), aport_id, Me.check_operator_ac.Checked) ' TONS OF FIELDS
                    Else
                        Call airport_fbo_functions.get_most_recent_flight_activity_companies_top_function(searchCriteria, this_section_string, location_name, Trim(Request("export")), Me.compare_view_current_label.Text, Me.compare_view_current_label2.Text, Me.ac_projects_ddl.SelectedValue, recent_flight_months, "36", Me.check_operator_ac.Checked, start_date.Text, end_date.Text, product_code_selection)  ' TONS OF FIELDS
                    End If
                End If

                Me.view_news_label1.Text = this_section_string
                Session("Last_FBO_Bottom") = 4
            End If


            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />" & Date.Now & " - FBO View After Functions<br />"

            If Page.IsPostBack Then
                UpdatePanel_top_left.Update()
                top_tab_update_panel.Update()
                bottom_tab_update_panel.Update()
            End If
        Catch ex As Exception

        End Try

    End Sub

    Public Sub run_airport_functions_top(ByVal airport_fbo_functions As airport_fbo_view_functions, ByVal searchCriteria As viewSelectionCriteriaClass, ByVal last_year_count As String, ByVal product_code_selection As String, ByVal this_section_string As String, ByVal charting_string As String, ByVal is_located_here As Boolean, ByVal temp_distance As Integer, ByVal orig_lat As String, ByVal orig_long As String, ByVal aport_id As Integer)


        Call airport_fbo_functions.get_flight_activity_overall_top_function(searchCriteria, last_year_count, product_code_selection)

        '-- *******************  UPPER RIGHT TAB 1 - GENERAL ************************
        '-- AIRPORT FLIGHT PROFILE - DISPLAY THE NUMBER OF FLIGHTS PER MONTH FOR THE AIRPORT
        this_section_string = ""


        Call airport_fbo_functions.get_flight_profile_top_function(searchCriteria, this_section_string, Me.airport_overview_type.SelectedValue, Session("Last_FAA_DATE"), product_code_selection)
        hidden_spi_graph_text.Text = this_section_string

        Me.last_overview_type.Text = Me.airport_overview_type.SelectedValue

        Me.right_side_overview.Text &= "(" & FormatNumber(last_year_count, 0) & ")</b>"

        '     If Trim(Request("no_map")) = "Y" Then
        If Me.airport_overview_type.SelectedValue = "Month" Then
            DisplayFunctions.load_google_chart(model_market_status_tab, this_section_string, "", "Flights Per Month", "chart_div_tab1", 640, 275, "POINTS", 1, charting_string, Me.Page, Me.top_tab_update_panel, False, True, True, False, False, False, False, True, False)
        ElseIf Me.airport_overview_type.SelectedValue = "BWeight" Or Me.airport_overview_type.SelectedValue = "TWeight" Or Me.airport_overview_type.SelectedValue = "HWeight" Then
            DisplayFunctions.load_google_chart(model_market_status_tab, this_section_string, "", "Flights Per Month", "chart_div_tab1", 640, 275, "POINTS", 1, charting_string, Me.Page, Me.top_tab_update_panel, False, True, True, False, True, False, False, True, False)
        ElseIf Me.airport_overview_type.SelectedValue = "Type" Then
            DisplayFunctions.load_google_chart(model_market_status_tab, this_section_string, "", "Flights Per Month", "chart_div_tab1", 640, 275, "POINTS", 1, charting_string, Me.Page, Me.top_tab_update_panel, False, True, True, False, True, False, False, True, False)
        End If

        'Else
        '   DisplayFunctions.load_google_chart(model_market_status_tab, this_section_string, "FLIGHT ACTIVITY SUMMARY FOR LAST YEAR (" & Replace(last_year_count, ",", "") & " Flights)", "Flights Per Month", "chart_div_tab1", 500, 250, "POINTS", 1, charting_string, Me.Page, Me.bottom_tab_update_panel, False, True, True, False, False, True, False, False, False)
        ' End If  


        '  ElseIf active_tab_top = 1 Then
        '-- ***************  UPPER RIGHT TAB 2 - TOP ORIGINS/DESTINATIONS ************************
        '-- # FLIGHT ACTIVITY -MOST COMMON ORIGINS - WE WOULD ALSO DO SAME FOR DESTINATIONS 
        this_section_string = ""
        Call airport_fbo_functions.get_most_common_origins_top_function(searchCriteria, this_section_string, product_code_selection)

        Me.view_fleet_label.Text = ""
        Me.view_fleet_label.Text = "<table cellspacing='0' cellpadding='3' border='1'>"
        Me.view_fleet_label.Text &= "<tr valign='top'><td width='50%'>"
        Me.view_fleet_label.Text &= this_section_string

        this_section_string = ""
        Call airport_fbo_functions.get_most_common_destinations_top_function(searchCriteria, this_section_string, product_code_selection)
        Me.view_fleet_label.Text &= "</td><td width='50%'>"
        Me.view_fleet_label.Text &= this_section_string
        Me.view_fleet_label.Text &= "</td></tr></table>"
        '  ElseIf active_tab_top = 2 Then

        '-- ***************  UPPER RIGHT TAB 3 - TOP MODELS ************************
        '-- # FLIGHT ACTIVITY BY MODEL 
        this_section_string = ""
        Call airport_fbo_functions.get_flight_activity_by_model_top_function(searchCriteria, this_section_string, product_code_selection)
        Me.view_performance_label.Text = this_section_string
        Me.controlled.Visible = True
        '   ElseIf active_tab_top = 3 Then

        this_section_string = ""
        Call airport_fbo_functions.get_flight_activity_by_ac_top_function(searchCriteria, this_section_string, is_located_here, product_code_selection)
        Me.view_operating_costs_label.Text = this_section_string
        Me.ac_based.Visible = True

        '   ElseIf active_tab_top = 4 Then

        this_section_string = ""
        Call airport_fbo_functions.get_nearby_airports_top_function(searchCriteria, this_section_string, temp_distance, orig_lat, orig_long, Trim(Request("bus_type")), aport_id, Me.controlled.Checked, UpdateProgress1)
        Me.view_description_label.Text = this_section_string
        '   End If

    End Sub

    Public Sub run_airport_functions_top_util(ByVal util_functions As utilization_functions, ByVal searchCriteria As viewSelectionCriteriaClass, ByVal last_year_count As String, ByVal product_code_selection As String, ByVal this_section_string As String, ByVal charting_string As String, ByVal is_located_here As Boolean, ByVal temp_distance As Integer, ByVal orig_lat As String, ByVal orig_long As String, ByVal aport_id As Integer, ByRef TotalFlightsCount As Long, ByRef SummaryTable As DataTable, ByRef table_string As String, Optional ByVal drop_spot As String = "")
        Dim Roll As Boolean = False
        Dim chartDiv As String = "chart_div_tab1"
        Dim associatedLabel As Label = right_side_overview
        Dim GraphType As DropDownList = airport_overview_type
        Dim graphWidth As Integer = 470

        If Not IsNothing(Trim(Request("roll"))) Then
            If Not String.IsNullOrEmpty(Trim(Request("roll"))) Then
                Roll = True
            End If
        End If

        If searchCriteria.ViewID = 28 Then
            chartDiv = "utilizationViewGraphall"
            'associatedLabel = UtilizationViewRightMainBoxDropdownText
            GraphType = utilizationViewMainBoxDropdown
        End If

        SummaryTable = util_functions.get_flight_activity_overall_top_function(searchCriteria, last_year_count, product_code_selection)

        '-- *******************  UPPER RIGHT TAB 1 - GENERAL ************************
        '-- AIRPORT FLIGHT PROFILE - DISPLAY THE NUMBER OF FLIGHTS PER MONTH FOR THE AIRPORT
        this_section_string = ""


        Call util_functions.get_flight_profile_top_function(searchCriteria, this_section_string, GraphType.SelectedValue, Session("Last_FAA_DATE"), product_code_selection, "", Nothing, table_string)
        hidden_spi_graph_text.Text = this_section_string


        If HttpContext.Current.Session.Item("localUser").crmDemoUserFlag = True Then  ' ADDED IN MSW - 3/26/20
        ElseIf Trim(table_string) <> "" Then
            Dim temp_file_name As String = ""
            temp_file_name = commonEvo.GenerateFileName("Flight_Summary_Export", ".xls", False)

            CommonAircraftFunctions.Build_String_To_HTML(Replace(table_string, "100%", ""), temp_file_name)
            table_string &= "<br/><a href='/tempfiles/" & temp_file_name & "' target='_blank'>Export Flight Summary to Excel</a>"
        End If

        Me.last_overview_type.Text = Me.airport_overview_type.SelectedValue
        If searchCriteria.ViewID <> 28 Then
            associatedLabel.Text &= " (" & FormatNumber(last_year_count, 0) & " Flights)</b>"
        End If
        TotalFlightsCount = CLng(last_year_count)

        '     If Trim(Request("no_map")) = "Y" Then

        If searchCriteria.ViewID = 28 Then
            graphWidth = 480
        End If

        If aport_id > 1 Or (searchCriteria.ViewCriteriaCompanyID > 0) Then

            If Trim(drop_spot) = "Hours" Then
                DisplayFunctions.load_google_chart(model_market_status_tab, this_section_string, "", "Hours By Month", chartDiv, graphWidth, 255, "POINTS", 1, charting_string, Me.Page, Me.top_tab_update_panel, False, False, True, False, True, True, False, True, False, False, 0, "")
            ElseIf Me.airport_overview_type.SelectedValue = "Month" Then
                DisplayFunctions.load_google_chart(model_market_status_tab, this_section_string, "", "Flights Per Month", chartDiv, graphWidth, 255, "POINTS", 1, charting_string, Me.Page, Me.top_tab_update_panel, False, False, True, False, True, True, False, True, False, False, 0, "")
            ElseIf Me.airport_overview_type.SelectedValue = "BWeight" Or Me.airport_overview_type.SelectedValue = "TWeight" Or Me.airport_overview_type.SelectedValue = "HWeight" Then
                DisplayFunctions.load_google_chart(model_market_status_tab, this_section_string, "", "Flights Per Month", chartDiv, graphWidth, 255, "POINTS", 1, charting_string, Me.Page, Me.top_tab_update_panel, False, False, True, False, True, True, False, True, False, False, 0, "")
            ElseIf Me.airport_overview_type.SelectedValue = "Type" Then
                DisplayFunctions.load_google_chart(model_market_status_tab, this_section_string, "", "Flights Per Month", chartDiv, graphWidth, 255, "POINTS", 1, charting_string, Me.Page, Me.top_tab_update_panel, False, False, True, False, True, True, False, True, False, False, 0, "")
            ElseIf Me.airport_overview_type.SelectedValue = "Hours" Then
                DisplayFunctions.load_google_chart(model_market_status_tab, this_section_string, "", "Hours By Month", chartDiv, graphWidth, 255, "POINTS", 1, charting_string, Me.Page, Me.top_tab_update_panel, False, False, True, False, True, True, False, True, False, False, 0, "")
            End If
        Else
            If searchCriteria.ViewID <> 28 Then
                graphWidth = 630
            Else
                graphWidth = 650
            End If

            If Trim(drop_spot) = "Hours" Then
                DisplayFunctions.load_google_chart(model_market_status_tab, this_section_string, "", "Hours By Month", chartDiv, graphWidth, 255, "POINTS", 1, charting_string, Me.Page, Me.top_tab_update_panel, False, False, True, False, True, True, False, True, False, False, 0, "")
            ElseIf Me.airport_overview_type.SelectedValue = "Month" Then
                ' DisplayFunctions.load_google_chart(model_market_status_tab, this_section_string, "", "Flights Per Month", "chart_div_tab1", 630, 275, "POINTS", 1, charting_string, Me.Page, Me.top_tab_update_panel, False, False, True, False, False, True, False, True, False, False, 0, "", png2.ClientID)
                DisplayFunctions.load_google_chart(model_market_status_tab, this_section_string, "", "Flights Per Month", chartDiv, graphWidth, 275, "POINTS", 1, charting_string, Me.Page, Me.top_tab_update_panel, False, False, True, False, True, True, False, True, False, False, 0, "")
            ElseIf Me.airport_overview_type.SelectedValue = "BWeight" Or Me.airport_overview_type.SelectedValue = "TWeight" Or Me.airport_overview_type.SelectedValue = "HWeight" Then
                DisplayFunctions.load_google_chart(model_market_status_tab, this_section_string, "", "Flights Per Month", chartDiv, graphWidth, 275, "POINTS", 1, charting_string, Me.Page, Me.top_tab_update_panel, False, False, True, False, True, True, False, True, False, False, 0, "")
            ElseIf Me.airport_overview_type.SelectedValue = "Type" Then
                DisplayFunctions.load_google_chart(model_market_status_tab, this_section_string, "", "Flights Per Month", chartDiv, graphWidth, 275, "POINTS", 1, charting_string, Me.Page, Me.top_tab_update_panel, False, False, True, False, True, True, False, True, False, False, 0, "")
            ElseIf Me.airport_overview_type.SelectedValue = "Hours" Then
                DisplayFunctions.load_google_chart(model_market_status_tab, this_section_string, "", "Hours By Month", chartDiv, graphWidth, 275, "POINTS", 1, charting_string, Me.Page, Me.top_tab_update_panel, False, False, True, False, True, True, False, True, False, False, 0, "")
            End If
        End If

        If TabContainer1.ActiveTab.ID = flight_summary_utilization_tab.ID.ToString Then
            If searchCriteria.ViewID = 28 Then
                System.Web.UI.ScriptManager.RegisterStartupScript(Me, Me.GetType, "chartString", charting_string + vbCrLf, True)
            End If
        End If

        'Me.test1.Text = png2.InnerHtml.ToString.Trim

        'Else
        '   DisplayFunctions.load_google_chart(model_market_status_tab, this_section_string, "FLIGHT ACTIVITY SUMMARY FOR LAST YEAR (" & Replace(last_year_count, ",", "") & " Flights)", "Flights Per Month", "chart_div_tab1", 500, 250, "POINTS", 1, charting_string, Me.Page, Me.bottom_tab_update_panel, False, True, True, False, False, True, False, False, False)
        ' End If  


        ''-- ***************  UPPER RIGHT TAB 2 - TOP ORIGINS/DESTINATIONS ************************
        ''-- # FLIGHT ACTIVITY -MOST COMMON ORIGINS - WE WOULD ALSO DO SAME FOR DESTINATIONS 
        'this_section_string = ""
        'Call util_functions.get_most_common_origins_top_function(searchCriteria, this_section_string, product_code_selection)

        'Me.view_fleet_label.Text = ""
        'Me.view_fleet_label.Text = "<table cellspacing='0' cellpadding='3' border='1'>"
        'Me.view_fleet_label.Text &= "<tr valign='top'><td width='50%'>"
        'Me.view_fleet_label.Text &= this_section_string

        'this_section_string = ""
        'Call util_functions.get_most_common_destinations_top_function(searchCriteria, this_section_string, product_code_selection)
        'Me.view_fleet_label.Text &= "</td><td width='50%'>"
        'Me.view_fleet_label.Text &= this_section_string
        'Me.view_fleet_label.Text &= "</td></tr></table>"


        '-- ***************  UPPER RIGHT TAB 3 - TOP MODELS ************************ 
        ' this_section_string = ""
        '  Call util_functions.get_flight_activity_by_model_top_function(searchCriteria, this_section_string, product_code_selection)
        '  Me.view_performance_label.Text = this_section_string
        '  Me.controlled.Visible = True

        ' TOP AC TAB
        this_section_string = ""
        '  Call util_functions.get_flight_activity_by_ac_top_function(searchCriteria, this_section_string, is_located_here, product_code_selection)
        '  Me.view_operating_costs_label.Text = this_section_string
        ' Me.ac_based.Visible = True


        ' NEARBY AIRPORTS TAB
        '   this_section_string = ""
        '    Call util_functions.get_nearby_airports_top_function(searchCriteria, this_section_string, temp_distance, orig_lat, orig_long, Trim(Request("bus_type")), aport_id, Me.controlled.Checked, UpdateProgress1)
        '  Me.view_description_label.Text = this_section_string


    End Sub

#End Region

#Region "page_functions"

    Private Sub Page_Init(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Init
        Session.Item("localUser").crmUser_DebugText = ""

        Dim ScriptBu As String = ""
        Dim repID As Long = 0
        Dim noteID As Long = 0
        Dim viewExtra As Boolean = False
        Dim IsProspector As Boolean = False
        If IsNumeric(Trim(Request("rep_id"))) Then
            repID = Trim(Request("rep_id"))
        End If
        If Not IsNothing(Trim(Request("extra"))) Then
            If Not String.IsNullOrEmpty(Trim(Request("extra"))) Then
                viewExtra = True
            End If
        End If
        If Not IsNothing(Trim(Request("noteID"))) Then
            If Not String.IsNullOrEmpty(Trim(Request("noteID"))) Then
                IsProspector = True
            End If
        End If
        If IsNumeric(Trim(Request("noteID"))) Then
            noteID = Trim(Request("noteID"))
        End If


        'Added 4/23/2014
        'If this app version is set to CRM, this boolean always gets toggled on.
        If Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CRM Then
            CRMViewActive = True
            Session.Item("Listing") = 3
            UpdateProgress1.Visible = True
            'JetnetClientSourceText = "" '<span class='help_cursor' title='Information on this tab includes data customized based on edits made within the Marketplace Manager.'><em>Source: Marketplace Manager</em></span>"
            JetnetSourceText = "<span  class='help_cursor' title='Information on this tab includes data from JETNET Evolution only and is not customized based on edits made within the Marketplace Manager.'><em>Source: JETNET Evolution</em></span>"
            ValueEstimateJavascript()

            'This code only runs on CRM views, only runs when the view is #19 and only runs when a Model ID is passed to that specific view.
            If Not IsNothing(Trim(Request("viewID"))) Then
                If IsNumeric(Trim(Request("viewID"))) Then
                    If Trim(Request("viewID")) = "19" Then
                        year_month_settings.Visible = True

                        If Not IsNothing(Trim(Request("amod_ID"))) Then
                            If IsNumeric(Trim(Request("amod_ID"))) Then
                                RunModelOnValueOnly = True
                                localCriteria.ViewCriteriaAmodID = Trim(Request("amod_ID"))
                            End If
                        End If
                    End If
                End If
            End If

        End If


        If clsGeneral.clsGeneral.isCrmDisplayMode Then
            ValueEstimateJavascript()
        End If

        RetailSalesJavascript(IsProspector)

        UtilJavascript() 'Flight Utilization

        Call make_table_script(ScriptBu, "", repID, IsProspector, viewExtra, noteID)

        If Trim(Request("viewID")) = "26" Then
            Call make_table_script(ScriptBu, "2", repID, IsProspector, viewExtra, noteID)
            Call make_table_script(ScriptBu, "3", repID, IsProspector, viewExtra, noteID)
            Call make_table_script(ScriptBu, "4", repID, IsProspector, viewExtra, noteID)
        End If

        System.Web.UI.ScriptManager.RegisterStartupScript(Me, Me.GetType(), "CreateDatatableFunction", ScriptBu.ToString, True)

        load_view_session_variables()

        run_comparable_insert.OnClientClick = " var respond = confirm(""Are you sure you want to save this market snapshot for " & FormatDateTime(Now(), DateFormat.ShortDate) & "?"");if (respond){document.getElementById(""" & divComparableTab.ClientID & """).className = ""loadingScreenComparable"";document.getElementById(""" & displayDisable.ClientID & """).className = ""fadedBackground"";return true;}{document.getElementById(""" & divComparableTab.ClientID & """).className = ""display_none"";return false;};"

    End Sub

    Public Sub make_table_script(ByRef ScriptBu As String, ByVal number_of_tablecopy As String, ByVal repID As Long, ByVal IsProspector As Boolean, ByVal viewExtra As Boolean, ByVal noteID As Long)
        Dim ExcelButton As String = ""
        Dim main_comp_id As Long = 0
        Dim amod_id As Long = 0
        Dim EveryRowScript As String = ""
        Dim ReloadScript As String = ""
        Dim clearIDScript As String = ""
        Dim crmClearIDScript As String = ""
        Dim exportOptions As String = ""
        If Not IsNothing(Request.Item("main_comp_id")) Then
            If Not String.IsNullOrEmpty(Request.Item("main_comp_id").ToString.Trim) Then
                If IsNumeric(Request.Item("main_comp_id").ToString) And CInt(Request.Item("main_comp_id").ToString) Then
                    main_comp_id = CInt(Request.Item("main_comp_id").ToString)
                End If
            End If
        End If

        If Not IsNothing(Request.Item("amod_id")) Then
            If Not String.IsNullOrEmpty(Request.Item("amod_id").ToString.Trim) Then
                If IsNumeric(Request.Item("amod_id").ToString) And CInt(Request.Item("amod_id").ToString) Then
                    amod_id = CInt(Request.Item("amod_id").ToString)
                End If
            End If
        End If


        If ((CRMViewActive) Or (CRMViewActive = False And Trim(Request("viewID")) <> "26")) Then
            EveryRowScript = "var data = dt.rows().column(1).data();"

            If CRMViewActive = False Then
                EveryRowScript += "var IDsToUse ='';"
            Else
                crmClearIDScript = "$(""#" & fullSaleCurrentIDs.ClientID & """).val('');$(""#" & FullSaleRefresh.ClientID & """).click();"
                EveryRowScript += "var IDsToUse ='0|CLIENT, 0|JETNET';"
            End If

            EveryRowScript += "data.each(function (value, index) {"
            EveryRowScript += " if (IDsToUse.length > 0) {"
            EveryRowScript += " IDsToUse += ', '; "
            EveryRowScript += " }"
            EveryRowScript += "IDsToUse += ' ' + value;"
            EveryRowScript += "});"
            EveryRowScript += "$(""#" & fullSaleCurrentIDs.ClientID & """).val(IDsToUse);"

            'clearIDScript = "$(""#" & fullSaleCurrentIDs.ClientID & """).val('');"
            ReloadScript = "ChangeTheMouseCursorOnItemParentDocument('cursor_wait');$(""#" & fullSaleCurrentIDs.ClientID & """).val('');"
            ReloadScript += "$(""#" & FullSaleRefresh.ClientID & """).click();"

        End If


        ScriptBu += "function RedrawDatatablesOnSys" & Trim(number_of_tablecopy) & "() {"
        ScriptBu += "setTimeout(reRenderThem" & Trim(number_of_tablecopy) & ", 1800);"
        ScriptBu += "}"

        ScriptBu += "function reRenderThem" & Trim(number_of_tablecopy) & "() {"
        ScriptBu += "$($.fn.dataTable.tables(true)).DataTable().columns.adjust();"
        ScriptBu += "$($.fn.dataTable.tables(true)).DataTable().scroller.measure();"
        ScriptBu += "}"


        If Trim(Request("viewID")) = "26" Then
            'This creates an excel button.
            'Which basically creates an excel button normally for most people unless on a mac, and then it runs some different code because the way the datatable
            'plugin does it isn't going to work for a mac.
            'All you need to pass to this function is a string (excelButton) and the #name of the table you're creating.
            '99% of the time, it should run just like it normally did.
            CreateExcelButton(ExcelButton, "MyJqueryTable" & Trim(number_of_tablecopy)) 'Table NAME goes here: MyJqueryTable" & Trim(number_of_tablecopy)

            ScriptBu += "function CreateTheDatatable" & Trim(number_of_tablecopy) & "() { "

            ScriptBu += " if ($.fn.DataTable.isDataTable( '#MyJqueryTable" & Trim(number_of_tablecopy) & "' ) ) {"
            ScriptBu += "$('#forSaleInnerTable" & Trim(number_of_tablecopy) & "').empty();"
            ScriptBu += "};"

            ' ScriptBu += " if ( ! $.fn.DataTable.isDataTable( '#MyJqueryTable" & Trim(number_of_tablecopy) & "' ) ) {"
            ScriptBu += "if ( $(""#tableCopy" & Trim(number_of_tablecopy) & """).length ) {"
            ScriptBu += "jQuery(""#tableCopy" & Trim(number_of_tablecopy) & """).css('display','block');"
            ScriptBu += "var clone = jQuery(""#tableCopy" & Trim(number_of_tablecopy) & """).clone(true);"
            ScriptBu += "jQuery(""#tableCopy" & Trim(number_of_tablecopy) & """).css('display','none');"

            ScriptBu += "clone[0].setAttribute('id', 'MyJqueryTable" & Trim(number_of_tablecopy) & "');"
            ScriptBu += "clone.appendTo(""#forSaleInnerTable" & Trim(number_of_tablecopy) & """);"
        Else
            CreateExcelButton(ExcelButton, "MyJqueryTable")

            ScriptBu += "function CreateTheDatatable() { "

            ' If Trim(Request("viewID")) = "1" Then
            ScriptBu += "var cw =  $('.MaxWidthRemove').width() - 20;"
            ScriptBu += " if (cw <= 0 || isNaN(cw)) {cw = 924;};"

            ScriptBu += "$("".resizeCW"").width(cw); "
            ScriptBu += "$(window).resize(function() {"
            ScriptBu += "var cw = $('.MaxWidthRemove').width() - 20;"
            ScriptBu += "$("".resizeCW"").width(cw);"
            ScriptBu += "});"
            'End If
            If CRMViewActive = False Then
                ScriptBu += clearIDScript
            End If
            'Adding this check to destroy a table if one already exists:
            ScriptBu += " if ($.fn.DataTable.isDataTable( '#MyJqueryTable' ) ) {"
            ScriptBu += "$('#forSaleInnerTable').empty();"
            ScriptBu += "};"

            'ScriptBu += " if ( ! $.fn.DataTable.isDataTable( '#MyJqueryTable' ) ) {"
            'ScriptBu += " alert('test'); "
            ScriptBu += "if ( $(""#tableCopy"").length ) {"
            ScriptBu += "jQuery(""#tableCopy"").css('display','block');"
            ScriptBu += "var clone = jQuery(""#tableCopy"").clone(true);"
            ScriptBu += "jQuery(""#tableCopy"").css('display','none');"

            ScriptBu += "clone[0].setAttribute('id', 'MyJqueryTable');"
            ScriptBu += "clone.appendTo(""#forSaleInnerTable"");"
        End If



        'If CRMViewActive = True Then
        If clsGeneral.clsGeneral.isCrmDisplayMode Then
            ScriptBu += "var hideFromExportMMSTable = [0,1,2,3];"
        Else
            ScriptBu += "var hideFromExportMMSTable = [0,1];"
        End If

        exportOptions = "columns: [function ( idx, data, node ) {"
        exportOptions += "var isVisible = table.column( idx ).visible();"
        exportOptions += "var isNotForExport = $.inArray( idx, hideFromExportMMSTable ) !== -1;"
        exportOptions += "return isVisible && !isNotForExport ? true : false; "
        exportOptions += "}, 'colvis']"
        'Else
        '    ScriptBu += "var hideFromExportMMSTable = [];"
        '    exportOptions = "columns: ':visible'"

        'End If

        ScriptBu += " var table = $('#MyJqueryTable" & Trim(number_of_tablecopy) & "').DataTable({"
        ScriptBu += " destroy: true,"

        If CRMViewActive Then
            ScriptBu += """drawCallback"": function( settings ) {"
            ScriptBu += "var dt = this.api();"
            ScriptBu += "var data = dt.rows().column(1).data();"
            ScriptBu += "var IDsToUse ='';"
            ScriptBu += "data.each(function (value, index) {"
            ScriptBu += " if (IDsToUse.length > 0) {"
            ScriptBu += " IDsToUse += ', '; "
            ScriptBu += " }"
            ScriptBu += "IDsToUse += ' ' + value;"
            ScriptBu += "});"
            ScriptBu += "$(""#" & tabReorder.ClientID & """).val(IDsToUse);"
            ScriptBu += "createCookie('viewSortOrder', IDsToUse, 365);"
            ScriptBu += " },"
        End If

        ScriptBu += """initComplete"": function(settings, json) {"

        'If CRMViewActive Then
        '  ScriptBu += "$(document).ready(function () {" & OpenButtonText("CreateTheDatatable", "openNewWindowContents") & "});"
        'End If
        ScriptBu += "setTimeout(function(){"
        ScriptBu += "$('#MyJqueryTable" & Trim(number_of_tablecopy) & "').DataTable().columns.adjust();"
        ScriptBu += "$('#MyJqueryTable" & Trim(number_of_tablecopy) & "').DataTable().fixedColumns().relayout();"

        ScriptBu += "},1200)"
        ScriptBu += "},"


        'If CRMViewActive Then
        ScriptBu += """infoCallback"": function( settings, start, end, max, total, pre ) {"
        ScriptBu += "return end + "" entries"";"
        ScriptBu += "},"
        'End If



        ScriptBu += "scrollCollapse: true,"
        ScriptBu += " stateSave: true,"
        'ScriptBu += "  stateSaveCallback: function(settings,data) {"
        'ScriptBu += " localStorage.setItem( 'DataTables_' + settings.sInstance, JSON.stringify(data) )"
        'ScriptBu += " },"
        'ScriptBu += " stateLoadCallback: function(settings) {"
        'ScriptBu += "  return JSON.parse( localStorage.getItem( 'DataTables_' + settings.sInstance ) )"
        'ScriptBu += " },"
        ScriptBu += "paging: false,"

        If Session.Item("isMobile") Then
            ScriptBu += "responsive: true, "

        Else
            ScriptBu += " fixedHeader: true, "
            If Trim(Request("viewID")) = "26" Then
                'ScriptBu += "scrollX: 550,"
                ScriptBu += "scrollY: 300,"
            Else
                ' ElseIf Trim(Request("viewID")) = "1" Then
                ScriptBu += "scrollX: cw,"
                ScriptBu += "scrollY: 430,"
                'Else
                '  ScriptBu += "scrollX: 960,"
                '  ScriptBu += "scrollY: 430,"
            End If



            'Standard

            If Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CRM Then
                If (repID = 0 Or repID = 11111) And noteID = 0 Then
                    If IsNumeric(ac_projects_ddl.SelectedValue) Then
                        ScriptBu += "fixedColumns: {leftColumns:5} ,"
                    Else
                        ScriptBu += "fixedColumns: {leftColumns:5} ,"
                    End If
                ElseIf noteID <> 0 Then
                    ScriptBu += "fixedColumns: {leftColumns:5} ,"
                End If
            Else
                If Trim(Request("viewID")) = "26" Then
                Else
                    ScriptBu += "fixedColumns: {leftColumns:3} ,"
                End If
            End If
        End If

        ScriptBu += "columnDefs: [ "
        If Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CRM Then
            If IsProspector And CRMViewActive Then
                ScriptBu += " {"
                ScriptBu += "targets: [ 1 , 2],"
                ScriptBu += "className: 'display_none'"
                ScriptBu += "},"
            ElseIf CRMViewActive Then
                ScriptBu += " {"
                ScriptBu += "targets: [1,2],"
                ScriptBu += "className: 'display_none'"
                ScriptBu += "},"
            End If

            If (repID = 0 Or repID = 11111) Then
                ScriptBu += " {"
                If IsProspector Then
                    If IsNumeric(ac_projects_ddl.SelectedValue) Then
                        ScriptBu += "targets: [10,11],"
                    End If
                Else
                    'If repID = 0 Then
                    '  If IsNumeric(ac_projects_ddl) Then
                    '    ScriptBu += "targets: [8,9],"
                    '  Else
                    '    ScriptBu += "targets: [3],"
                    '  End If
                    'Else
                    '  ScriptBu += "targets: [8,10,12],"
                    'End If
                End If
                ScriptBu += "width: ""150px"""
                ScriptBu += "}, "
            End If

            ScriptBu += " {"
            If repID = 0 Then
                If IsProspector Then
                    '  If RunModelOnValueOnly = True Then
                    ScriptBu += "targets: [3],"
                    'Else
                    ' ScriptBu += "targets: [3,4,5],"
                    'End If
                Else
                    ScriptBu += "targets: [3],"
                End If

            Else
                ScriptBu += "targets: [2],"
            End If
            ScriptBu += "orderable: false"
            ScriptBu += "}, "
        Else

            If Trim(Request("viewID")) = "26" Then
            Else
                ScriptBu += " {"
                ScriptBu += "targets: [1 " & IIf(clsGeneral.clsGeneral.isCrmDisplayMode, ",2", "") & "],"
                ScriptBu += "className: 'display_none'"
                ScriptBu += "},"
            End If


            If viewExtra = True Then
                ScriptBu += " {"
                If repID = 0 Then
                    ScriptBu += "targets: [7,8],"
                Else
                    ScriptBu += "targets: [7,9,11],"
                End If
                ScriptBu += "width: ""150px"""
                ScriptBu += "}, "
                'ScriptBu += " {"
                'ScriptBu += "targets: [25],"
                'ScriptBu += "orderable: false"
                'ScriptBu += "}, "
            ElseIf Trim(Request("viewID")) = "26" Then
                'skip this 
            ElseIf Trim(Request("viewID")) = "1" Or Trim(Request("viewID")) = "11" Then
                If Session.Item("isMobile") Then
                    ScriptBu += " { responsivePriority: 1, targets: 0 },"
                    ScriptBu += " { responsivePriority: 2, targets: 1 },"
                    ScriptBu += " { responsivePriority: 3, targets: 2 },"
                    ScriptBu += " { responsivePriority: 4, targets: 3 },"
                    ScriptBu += " { responsivePriority: 5, targets: 7 },"
                End If
            End If

        End If


        If Trim(Request("viewID")) = "26" Then
            If main_comp_id > 0 And amod_id > 0 And Trim(number_of_tablecopy) = "2" Then
                ScriptBu += " ],"
                ScriptBu += "order: [[ 0, 'desc' ]],"
            ElseIf main_comp_id > 0 And amod_id > 0 And Trim(number_of_tablecopy) = "3" Then
                ScriptBu += " ],"
                ScriptBu += "order: [[ 0, 'desc' ]],"
            ElseIf main_comp_id > 0 And Trim(number_of_tablecopy) = "" Then
                ScriptBu += " ],"
                ScriptBu += "order: [[ 0, 'desc' ]],"
            ElseIf main_comp_id > 0 And Trim(number_of_tablecopy) = "2" Then
                ScriptBu += " ],"
                ScriptBu += "order: [[ 1, 'desc' ]],"
            ElseIf main_comp_id > 0 And Trim(number_of_tablecopy) = "3" Then
                ScriptBu += " ],"
                ScriptBu += "order: [[ 1, 'desc' ]],"
            ElseIf main_comp_id > 0 Then
                ScriptBu += " ],"
                ScriptBu += "order: [[ 1, 'asc' ]],"
            Else
                ScriptBu += " ],"
                ScriptBu += "order: [[ 2, 'desc' ]],"
            End If
        Else
            If Session.Item("isMobile") Then
                ScriptBu += " ],"
            Else
                ScriptBu += " {"
                ScriptBu += "orderable: false,"
                ScriptBu += "className:  'select-checkbox',"
                ScriptBu += " width: '10px',"
                ScriptBu += "targets:   0"
                ScriptBu += " } ],"
                ScriptBu += "select: {"
                ScriptBu += "style:    'multi',"
                ScriptBu += "selector: 'td:first-child'"
                ScriptBu += "},"
            End If
            If Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CRM Then
                If IsProspector Then
                    ScriptBu += "order: [[ 6, 'asc' ]],"
                Else
                    ScriptBu += "order: [[ 5, 'asc' ]],"
                End If
            Else
                ScriptBu += "order: [[ 2, 'asc' ]],"
            End If

        End If


        If Trim(Request("viewID")) = "26" Then
            If amod_id > 0 Then
                ScriptBu += "dom:        'trB',"
            ElseIf main_comp_id > 0 Then
                ScriptBu += "dom:        'trB',"
            Else
                ScriptBu += "dom:        'trBf',"
            End If

        Else
            If Session.Item("isMobile") = False Then
                ScriptBu += "dom:        'Bfitrp',"
            End If
        End If




        If Session.Item("isMobile") Then
        Else
            ScriptBu += "buttons: [ "


            If Session.Item("localUser").crmDemoUserFlag = True Then
                If Trim(Request("viewID")) = "26" Then
                    If main_comp_id > 0 Then
                    ElseIf amod_id > 0 And Trim(number_of_tablecopy) = "1" Then ' so that it has buttons for dealers 
                    ElseIf amod_id > 0 And Trim(number_of_tablecopy) = "3" Then ' so that it has buttons for dealers 
                    Else
                        ScriptBu += " {extend: 'csv', enabled: false , exportOptions : {columns: ':visible'}}, "
                        'Excel Button
                        ScriptBu += ExcelButton
                        'ScriptBu += " {extend: 'excel', exportOptions : {columns: ':visible'}}, "
                        'PDF Button
                        ScriptBu += " {extend: 'pdf', enabled: false , orientation: 'landscape', pageSize: 'A2', exportOptions : {columns: ':visible'}}, "
                    End If
                Else
                    'CSV Button:
                    ScriptBu += " {extend: 'csv', enabled: false , exportOptions : {" & exportOptions & "}}, "
                    'Excel Button
                    ScriptBu += Replace(ExcelButton, "columns: ':visible'", exportOptions)
                    'ScriptBu += " {extend: 'excel', exportOptions : {columns: ':visible'}}, "
                    'PDF Button
                    ScriptBu += " {extend: 'pdf', enabled: false , orientation: 'landscape', pageSize: 'A2', exportOptions : {" & exportOptions & "}}, "
                End If
            Else ' IF ITS NOT A DEMO 
                If Trim(Request("viewID")) = "26" Then
                    If main_comp_id > 0 Then
                    ElseIf amod_id > 0 And Trim(number_of_tablecopy) = "1" Then ' so that it has buttons for dealers 
                    ElseIf amod_id > 0 And Trim(number_of_tablecopy) = "3" Then ' so that it has buttons for dealers 
                    Else
                        ScriptBu += " {extend: 'csv', exportOptions : {columns: ':visible'}}, "
                        'Excel Button
                        ScriptBu += ExcelButton
                        'ScriptBu += " {extend: 'excel', exportOptions : {columns: ':visible'}}, "
                        'PDF Button
                        ScriptBu += " {extend: 'pdf', orientation: 'landscape', pageSize: 'A2', exportOptions : {columns: ':visible'}}, "
                    End If
                Else
                    'CSV Button:
                    ScriptBu += " {extend: 'csv', exportOptions : {" & exportOptions & "}}, "
                    'Excel Button
                    ScriptBu += Replace(ExcelButton, "columns: ':visible'", exportOptions)
                    'ScriptBu += " {extend: 'excel', exportOptions : {columns: ':visible'}}, "
                    'PDF Button
                    ScriptBu += " {extend: 'pdf', orientation: 'landscape', pageSize: 'A2', exportOptions : {" & exportOptions & "}}, "
                End If
            End If

            If Trim(Request("viewID")) = "26" Then
            Else
                'Print Button
                'ScriptBu += " {extend: 'print', exportOptions : {columns: ':visible'}}, "

                'Column Visibility Button
                ScriptBu += "{"
                ScriptBu += "extend: 'colvis',"
                ScriptBu += " text: 'Columns',"
                ScriptBu += "collectionLayout:  'fixed two-column',"
                ScriptBu += "postfixButtons: [ 'colvisRestore' ]"
                ScriptBu += "},"

                'Remove Selected Button:

                ScriptBu += "{ text:'Remove Selected', "
                ScriptBu += " action: function( e, dt, node, config) { dt.rows( { selected: true } ).remove().draw( false );" & IIf(((CRMViewActive = True) Or (CRMViewActive = False And Trim(Request("viewID")) <> "26")), EveryRowScript, "") & "}},"
                ScriptBu += "{ text:'Keep Selected', "
                ScriptBu += " action: function( e, dt, node, config) { dt.rows( { selected: false } ).remove().draw( false );dt.draw();dt.rows('.selected').deselect();" & IIf(((CRMViewActive = True) Or (CRMViewActive = False And Trim(Request("viewID")) <> "26")), EveryRowScript, "") & "}},"

                ScriptBu += "{ text:'Reload Table', action: function( e, dt, node, config) { $('#forSaleInnerTable" & Trim(number_of_tablecopy) & "').empty();CreateTheDatatable" & Trim(number_of_tablecopy) & "();" & IIf(CRMViewActive = True And IsProspector = True, ReloadScript, IIf(CRMViewActive = True And IsProspector = False, crmClearIDScript, "")) & IIf(CRMViewActive = False, clearIDScript, "") & "}}"
                ScriptBu += " "

                If (CRMViewActive And IsProspector = True Or (CRMViewActive = True And (repID = 0 Or repID = 11111))) Then
                    ScriptBu += ","
                    'Remove Selected Button:
                    ScriptBu += "{ text:'Refresh Graph', className:'openButtonVis', "
                    ScriptBu += " action: function( e, dt, node, config) {"
                    ScriptBu += "$(""#" & FullSaleRefresh.ClientID & """).click();ChangeTheMouseCursorOnItemParentDocument('cursor_wait');}}"
                End If

                'test button
                ' If CRMViewActive Then
                Dim OpenButton As String = ""
                OpenButton = CreateOpenButton("CreateTheDatatable", "openNewWindowContents", "sales")
                ScriptBu += OpenButton
                'End If

            End If


            'If Trim(Request("viewID")) = "26" Then
            '  If Trim(Request("main_comp_id")) <> "" Then
            '    If CInt(Trim(Request("main_comp_id"))) > 0 Then
            '    Else
            '      ScriptBu += "]"
            '    End If
            '  Else
            '    ScriptBu += "]"
            '  End If
            'Else


            ScriptBu += "]"
        End If

        ScriptBu += "});"

        ScriptBu += "}; "
        ' ScriptBu += "}"

        ScriptBu += "}; "




        ' AutoExpandButton()


    End Sub

    Private Function CreateOpenButton(ByVal functionNameStr As String, ByVal panelNameStr As String, ByVal openType As String) As String
        Dim TemporaryModelHold As Long = 0
        Dim openButton As String = ""

        If IsNumeric(Trim(Request("amod_ID"))) Then
            TemporaryModelHold = Trim(Request("amod_ID")).ToString
        Else
            If localCriteria.ViewCriteriaAmodID > 0 Then
                TemporaryModelHold = localCriteria.ViewCriteriaAmodID.ToString
            Else
                Try
                    If (CRMViewActive = False And Not String.IsNullOrEmpty(Session.Item("viewAircraftModel")) And (InStr(Session.Item("viewAircraftModel").ToString, ",") = 0)) Then
                        TemporaryModelHold = commonEvo.ReturnAmodIDForItemIndex(CLng(Session.Item("viewAircraftModel").ToString)).ToString()
                    ElseIf (CRMViewActive And Not String.IsNullOrEmpty(Trim(Request("cboAircraftViewModel")))) Then
                        TemporaryModelHold = commonEvo.ReturnAmodIDForItemIndex(CLng(Trim(Request("cboAircraftViewModel")).ToString)).ToString()
                    Else
                        check_and_reset_model()
                        TemporaryModelHold = localCriteria.ViewCriteriaAmodID.ToString
                    End If
                Catch ex As Exception
                    check_and_reset_model()
                    TemporaryModelHold = localCriteria.ViewCriteriaAmodID.ToString
                End Try
            End If
        End If

        If TemporaryModelHold > 0 Then
            openButton = ",{ text:'Expand', className:'openButtonVis', "
            openButton += " action: function( e, dt, node, config) {  "
            openButton += "var URLLink = 'WebSource.aspx?viewType=" & openType & "';"

            openButton += "URLLink += '&amodID=' + $('#cboAircraftViewModelID').val();" '& TemporaryModelHold.ToString
            openButton += "URLLink += '&viewID=" & Trim(Request("viewID"))
            If Not IsNothing(Session.Item("CLIENT_AC_ID")) Then
                If Not String.IsNullOrEmpty(Session.Item("CLIENT_AC_ID")) Then
                    If IsNumeric(Session.Item("CLIENT_AC_ID")) Then
                        openButton += "&acID=" & Session.Item("CLIENT_AC_ID").ToString
                    End If
                End If
            End If




            openButton += "&useModelOnly=" & RunModelOnValueOnly
            openButton += IIf(Not String.IsNullOrEmpty(Trim(Request("noteID"))), "&noteID=" & Trim(Request("noteID")), "") & "';"

            If Not IsNothing(Trim(Request("noMaster"))) Then
                If Not String.IsNullOrEmpty(Trim(Request("noMaster"))) Then
                    openButton += "URLLink += '&noMaster=" & Trim(Request("noMaster")) & "';"
                End If
            End If
            If Trim(Request("viewID")) = "1" Then
                If functionNameStr = "CreateTheDatatable" Then
                Else
                    openButton += "URLLink += '&YearsMonthsSettings=' + $('#" & selectViewTimeSpan.ClientID & "').val();"
                End If
            Else
                If functionNameStr <> "CreateTheDatatable" Then
                    openButton += "URLLink += '&YearsMonthsSettings=' + $('#" & year_month_settings.ClientID & "').val();"
                End If
            End If

            If Trim(Request("viewID")) = "1" Then
                If CRMViewActive Then
                    openButton += "URLLink += '&aftt_end=' + $('#" & aftt_end.ClientID & "').val();"
                    openButton += "URLLink += '&aftt_start=' + $('#" & aftt_start.ClientID & "').val();"
                    openButton += "URLLink += '&year_start=' + $('#" & year_start.ClientID & "').val();"
                    openButton += "URLLink += '&year_end=' + $('#" & year_end.ClientID & "').val();"
                    openButton += "URLLink += '&UseUsed=' + $('#" & preownedSales_Only.ClientID & "').is(':checked');"
                    openButton += "URLLink += '&VAR=' + $('#" & VariantList.ClientID & "').val();"
                End If
            End If

            If functionNameStr <> "CreateTheDatatable" Then
                If Trim(Request("viewID")) = "19" Then
                    openButton += "URLLink += '&repID=' + $('#" & ac_projects_ddl4.ClientID & "').val();"
                    openButton += "URLLink += '&YearsOf=' + $('#" & years_of.ClientID & "').val();"
                    openButton += "URLLink += '&SalesWithin=' + $('#" & sales_within.ClientID & "').val();"
                    openButton += "URLLink += '&UseUsed=' + $('#" & used_of_used.ClientID & "').is(':checked');"
                    openButton += "URLLink += '&UseJetnet=' + $('#" & use_jetnet_data.ClientID & "').is(':checked');"
                    openButton += "URLLink += '&internal=' + $('#" & check_include_internals.ClientID & "').is(':checked');"
                    openButton += "URLLink += '&retail=' + $('#" & check_retail_sales.ClientID & "').is(':checked');"
                Else
                    If CRMViewActive Then
                        openButton += "URLLink += '&internal=' + $('#" & check_include_internals2.ClientID & "').is(':checked');"
                        openButton += "URLLink += '&retail=' + $('#" & check_retail_sales2.ClientID & "').is(':checked');"
                    Else
                        openButton += "URLLink += '&internal=false';"
                        openButton += "URLLink += '&retail=true';"
                    End If
                End If




            Else
                openButton += "URLLink += '&repID=' + $('#" & ac_projects_ddl.ClientID & "').val();"
            End If

            openButton += " var OpenWindow = window.open(URLLink, 'OpenWindow', 'menubar=yes, resizable=yes, titlebar=yes, height=900,width=1200,innerHeight=980,innerWidth=1200,status=yes,toolbar=yes,location=yes');"
            'openButton += "var panel = document.getElementById(""" & panelNameStr & """);"
            'openButton += "clone = panel.cloneNode(true);"
            'openButton += "var OpenWindow = window.open('WebSource.aspx', 'OpenWindow', 'menubar=yes, resizable=yes, titlebar=yes, height=900,width=1200,innerHeight=980,innerWidth=1200,status=yes,toolbar=yes,location=yes');"

            'openButton += "if (OpenWindow.document.readyState === ""complete"") {"
            'openButton += "$.browser.chrome = $.browser.webkit && !!window.chrome;"
            'openButton += "$.browser.safari = $.browser.webkit && !window.chrome;"
            'openButton += "if (($.browser.chrome) || ($.browser.safari) || /Edge/.test(navigator.userAgent)) {"
            'openButton += "OpenWindow.addEventListener('DOMContentLoaded', function () {"
            'openButton += "OpenWindow.init(clone, " & functionNameStr & ".toString());"
            'openButton += "});"
            'openButton += "} else { "
            'openButton += " if (typeof OpenWindow.init == 'function') {"
            'openButton += "OpenWindow.init(clone, " & functionNameStr & ".toString());"
            'openButton += " } else { "
            'openButton += "OpenWindow.addEventListener('DOMContentLoaded', function () {"
            'openButton += "OpenWindow.init(clone, " & functionNameStr & ".toString());"
            'openButton += "});"
            'openButton += "} "
            'openButton += "}"

            'openButton += "} else {setTimeout(function(){ "
            'openButton += "if (typeof OpenWindow.init == 'function') {"
            'openButton += "setTimeout(function(){ OpenWindow.init(clone, " & functionNameStr & ".toString())}, 1000);"
            'openButton += " } else { "
            'openButton += "OpenWindow.addEventListener('DOMContentLoaded', function () {"
            'openButton += "setTimeout(function(){ OpenWindow.init(clone, " & functionNameStr & ".toString())}, 1000);"
            'openButton += "});"
            'openButton += "}}, 800);"
            'openButton += "};"

            openButton += "}}"
        End If
        Return openButton
    End Function

    Private Sub BuildSliderDateJavascript()
        sliderDateString = New StringBuilder
        'sliderDateString.Append("$( function() { ")
        sliderDateString.Append("Sys.Application.add_load(function() {")
        sliderDateString.Append(" $("".datepicker"").datepicker();")
        sliderDateString.Append(" } );")

        If Not Page.ClientScript.IsClientScriptBlockRegistered("datePickerJS") Then
            System.Web.UI.ScriptManager.RegisterClientScriptBlock(Me.bottom_tab_update_panel, Me.GetType(), "datePickerJS", sliderDateString.ToString, True)
        End If
    End Sub

    Public Sub Page_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load

        Dim page_changed As Boolean = False
        Dim temp_label As String = ""
        Dim chart_htmlString As String = ""
        Dim NOTE_ID As Integer = 0
        Dim rest_of_ac_string As String = ""
        Dim make_name As String = ""
        Dim model_name As String = ""
        Dim temp_amod_id As Long = 0
        Dim real_ac_id As Long = 0

        Dim activetab As Integer = 0
        Dim temp_table2 As New DataTable
        Dim google_map_array_list As String = ""
        Dim COMPLETED_OR_OPEN As String = "O"
        Dim selected_changed As Boolean = False
        Dim results_label_to_display As String = ""
        Dim temp_crm_evo_conn As String = ""

        Try

            If Not IsNothing(Request.Item("noteID")) Then
                If Not String.IsNullOrEmpty(Request.Item("noteID").ToString.Trim) Then
                    NOTE_ID = CInt(Request.Item("noteID").ToString)
                Else
                    NOTE_ID = 2
                End If
            End If

            If Not IsNothing(Request.Item("noteID")) Then
                If Not String.IsNullOrEmpty(Request.Item("noteID").ToString.Trim) Then
                    NOTE_ID = CInt(Request.Item("noteID").ToString)
                End If
            End If

            Me.for_sale_tab.HeaderText = "For Sale"
            Me.trends_tab.HeaderText = "Trends"
            Me.retail_tab.HeaderText = "Recent Sales"
            Me.event_tab.HeaderText = "Events"
            Me.news_tab.HeaderText = "News"
            Me.wanted_tab.HeaderText = "Wanteds"
            Me.documents_tab.HeaderText = "Documents"
            Me.operators_tab.HeaderText = "Operators"
            Me.charter_tab.HeaderText = "Charter"
            Me.lease_tab.HeaderText = "Lease"
            Me.spi_tab.HeaderText = "SPI"
            Me.location_tab.HeaderText = "Location"
            Me.star_tab.HeaderText = "STAR"
            Me.range_tab.HeaderText = "Range"
            Me.fractional_tab.HeaderText = "Fractional"


            Me.model_market_status_tab.HeaderText = "Market Status"
            Me.model_fleet_tab.HeaderText = "Fleet"
            Me.model_performance_tab.HeaderText = "Performance"
            Me.model_operating_costs_tab.HeaderText = "Op Costs"
            Me.model_description_tab.HeaderText = "Description"
            Me.model_flight_tab.HeaderText = "Utilization"
            model_flight_tab.Visible = False
            utilization_tab.Visible = False


            If Not IsNothing(Request.Item("ViewName")) Then
                If Not String.IsNullOrEmpty(Request.Item("ViewName").ToString) Then
                    view_name_text.Text = Request.Item("ViewName").ToString.Trim
                    View_Name = view_name_text.Text
                    localCriteria.ViewName = Server.UrlEncode(View_Name)
                End If
            End If

            If Not IsNothing(Request.Item("sortBy")) Then
                If Not String.IsNullOrEmpty(Request.Item("sortBy").ToString) Then
                    localCriteria.ViewCriteriaSortBy = Request.Item("sortBy").ToString.Trim
                End If
            End If

            If Not IsNothing(Request.Item("ViewID")) Then
                If Not String.IsNullOrEmpty(Request.Item("ViewID").ToString) Then
                    view_id_text.Text = Request.Item("ViewID").ToString.Trim
                    View_ID = CInt(view_id_text.Text)
                    localCriteria.ViewID = View_ID


                End If
            End If

            If Not IsNothing(Request.Item("noMaster")) Then
                If Not String.IsNullOrEmpty(Request.Item("noMaster").ToString) Then
                    bHasMaster = CBool(Request.Item("noMaster").ToString.Trim)
                End If
            End If

            'I added in this check
            'It basically turns the master off for the CRM Views (only those).
            If CRMViewActive Then
                bHasMaster = False
            End If


            If clsGeneral.clsGeneral.isCrmDisplayMode() = True Then
                ' we are going to set it = the current server notes connection and pretend its crm
                CRMViewActive = True
                'bHasMaster = True
                temp_crm_evo_conn = Application.Item("crmClientDatabase")
                Application.Item("crmClientDatabase") = HttpContext.Current.Session.Item("localPreferences").ServerNotesDatabaseConn
            End If



            localDatalayer = New viewsDataLayer
            localDatalayer.adminConnectStr = Application.Item("crmClientSiteData").AdminDatabaseConn

            Dim sErrorString As String = ""

            If Not Session.Item("localPreferences").loadUserSession(sErrorString, CLng(Session.Item("localUser").crmSubSubID.ToString), Session.Item("localUser").crmUserLogin.ToString, CLng(Session.Item("localUser").crmSubSeqNo.ToString), CLng(Session.Item("localUser").crmUserContactID.ToString)) Then
                Response.Write("** Error in [View_Master.ascx.vb :  load preferences : " + sErrorString)
            End If

            Dim fSubins_platform_os As String = commonEvo.getBrowserCapabilities(Request.Browser)

            If Not (fSubins_platform_os.Contains("win") Or fSubins_platform_os.Contains("mac") Or fSubins_platform_os.Contains("linux")) Then
                bEnableTelTags = True
            End If

            If Not fSubins_platform_os.Contains("ie") Then
                localCriteria.ViewCriteriaNoLocalNotes = True
            End If

            Session.Item("localPreferences").userBrowserType = fSubins_platform_os

            localDatalayer.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            localDatalayer.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            localDatalayer.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            localDatalayer.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

            ' product code count is only 3 items for evo H,B,C 
            ' if user has product code "Y" for yacht it needs to be ignored for evo since yacht is its own site
            ' might have to play with filtering for yacht site if matt uses type/make/model boxes for displaying yachts

            For nloop As Integer = 0 To UBound(Session.Item("localPreferences").ProductCode)

                Select Case Session.Item("localPreferences").ProductCode(nloop)
                    Case eProductCodeTypes.H
                        productCodeCount += 1
                    Case eProductCodeTypes.B, eProductCodeTypes.S, eProductCodeTypes.I
                        productCodeCount += 1
                    Case eProductCodeTypes.R
                    Case eProductCodeTypes.C
                        productCodeCount += 1
                    Case eProductCodeTypes.P
                    Case eProductCodeTypes.A
                    Case eProductCodeTypes.Y

                End Select

            Next

            isHeliOnlyProduct = HttpContext.Current.Session.Item("localPreferences").isHeliOnlyProduct

            viewApplyID.PostBackUrl = "~/View_Template.aspx?ViewID=" + localCriteria.ViewID.ToString + "&ViewName=" + localCriteria.ViewName
            atGlanceGo.PostBackUrl = "~/View_Template.aspx?" + IIf(Not bHasMaster, "noMaster=false&", "") + "ViewID=" + localCriteria.ViewID.ToString + "&ViewName=" + localCriteria.ViewName
            ViewClearID.PostBackUrl = "~/View_Template.aspx?ViewID=" + localCriteria.ViewID.ToString + "&ViewName=" + localCriteria.ViewName + "&clear=true"
            atGlanceClear.PostBackUrl = "~/View_Template.aspx?" + IIf(Not bHasMaster, "noMaster=false&", "") + "ViewID=" + localCriteria.ViewID.ToString + "&ViewName=" + localCriteria.ViewName + "&clear=true"


            If Trim(Request("ac_type")) = "JETNET" And Trim(Request("created_client")) = "Y" And Not IsPostBack Then

                Call clicked_comparable_or_re_entered(True)

            Else

                If Not IsPostBack Then ' set default timespan to 6 months

                    If View_ID = 12 Then
                        selectMarketTimeSpan.SelectedValue = "24"

                    ElseIf View_ID = 32 Then

                        selectMarketTimeSpan.Items.Clear()
                        selectMarketTimeSpan.Items.Add(New ListItem("2 years", "24"))
                        selectMarketTimeSpan.Items.Add(New ListItem("3 years", "36"))
                        selectMarketTimeSpan.Items.Add(New ListItem("4 years", "48"))
                        selectMarketTimeSpan.Items.Add(New ListItem("5 years", "60"))
                        selectMarketTimeSpan.SelectedValue = "24"

                    Else
                        selectMarketTimeSpan.SelectedValue = "6"
                    End If

                    selectViewTimeSpan.SelectedValue = "6"
                    locationViewTypeID.SelectedValue = "0"

                End If

                ' start page load -> get request variables -> load_page_variables() -> set values for control -> 
                ' control page load -> load_full_model_view() or load_standalone_view() -> end page load -> page pre-render

                'This only runs whenever you're on the mobile site to 
                If Session.Item("isMobile") Then
                    'Load Search Information:
                    If Not Page.IsPostBack Then
                        opcosts_make_model_panel.CssClass = "display_none"
                        MobileSearchVisible.Visible = True
                        DisplayFunctions.SingleModelLookupAndFill(makeModelDynamic, DirectCast(Page.Master, MobileTheme))
                    End If
                End If

                load_page_variables()

                If Not IsPostBack Then

                    If Session.Item("jetnetAppVersion") <> Constants.ApplicationVariable.CRM Then
                        If View_ID <> 6 Then  ' for the star reports view, it will be entered seperately 
                            Call commonLogFunctions.Log_User_Event_Data("UserDisplayView", "User Entered View " & Replace(commonEvo.Get_Default_User_View_Name(View_ID), "&nbsp;", " "), Nothing, View_ID, localCriteria.ViewCriteriaJournalID, 0, localCriteria.ViewCriteriaAircraftID, 0, localCriteria.ViewCriteriaAircraftID, localCriteria.ViewCriteriaAmodID)
                        End If
                    End If

                End If

                Me.settings_tab.Visible = False

                If View_ID = 18 Then    '  Or View_ID = 19 - was re-loading first graph
                    Call run_active_tab_changed(0)
                End If

                If View_ID = 18 Then ' CRM VIEW
                    Call Build_CRM_View(localCriteria.ViewCriteriaAmodID, localCriteria.ViewCriteriaAircraftMake, localCriteria.ViewCriteriaAircraftModel)
                ElseIf View_ID = 19 Then  ' COMPARISON VIEW   


                    Call run_compare_view_items(results_label_to_display, activetab, selected_changed, NOTE_ID, real_ac_id, make_name, model_name, temp_amod_id, rest_of_ac_string, chart_htmlString, 0, False)
                    If Not IsNothing(TabContainer1.ActiveTab) Then
                        model_reports_tab.HeaderText = "Selection: " & TabContainer1.ActiveTab.HeaderText.ToString
                    End If

                Else

                    Me.crm_info.Visible = False

                    If CRMViewActive Then
                        CheckSharedModelTable()
                        'Added this check to search for correct model. Just on the CRM side.
                        Dim returnID As Long = crmViewDataLayer.CheckForCorrectModel(localCriteria, localDatalayer, SharedModelTable)
                        If returnID <> 0 Then
                            Response.Redirect("view_template.aspx?ViewID=" + localCriteria.ViewID.ToString + "&ViewName=" + localCriteria.ViewName + "&amod_id=" + returnID.ToString)
                        End If

                        If localCriteria.ViewCriteriaAmodID = -1 And localCriteria.ViewID = 1 Then
                            Response.Redirect("view_template.aspx?ViewID=1&ViewName=Model Market Summary&amod_id=" + crmViewDataLayer.Return_Correct_Model_Suggestion(localCriteria).ToString)
                        End If
                    End If

                    Dim aclsData_Temp As New clsData_Manager_SQL

                    aclsData_Temp.JETNET_DB = Application.Item("crmClientSiteData").AdminDatabaseConn
                    aclsData_Temp.Insert_Content_Stat(Now(), 0, 0, localCriteria.ViewCriteriaAmodID, 0, 0, 0, localCriteria.ViewID, CLng(Session.Item("localUser").crmSubSubID.ToString), Session.Item("localUser").crmUserLogin.ToString, CLng(Session.Item("localUser").crmSubSeqNo.ToString), CLng(Session.Item("localUser").crmUserContactID.ToString))

                    Session.Item("lastView") = View_ID

                    If (View_ID < 2) Or View_ID = 11 Then

                        ViewTMMDropDowns.setIsView(True)
                        ViewTMMDropDowns.setShowWeightClass(False)
                        ViewTMMDropDowns.setListSize(6)
                        ViewTMMDropDowns.setOverideDefaultModel(True)
                        ViewTMMDropDowns.setOverideMultiSelect(False)
                        ViewTMMDropDowns.setControlName(sTypeMakeModelCtrlBaseName)

                        If View_ID = 1 Then
                            temp_label = "Model Market Summary: "
                        ElseIf View_ID = 11 Then
                            temp_label = "Model Market List: "
                        End If

                        'If Not IsPostBack Then
                        '  Call commonLogFunctions.Log_User_Event_Data("UserDisplayView", temp_label + localCriteria.ViewCriteriaAircraftMake + " " + localCriteria.ViewCriteriaAircraftModel + " (" + localCriteria.ViewCriteriaAmodID.ToString + ") ", Nothing, View_ID, localCriteria.ViewCriteriaJournalID, 0, localCriteria.ViewCriteriaAircraftID, 0, localCriteria.ViewCriteriaAircraftID, localCriteria.ViewCriteriaAmodID)
                        'End If 

                        load_full_model_view()
                        BuildStandardPDFScript()

                    Else

                        ViewTMMDropDowns1.setIsView(True)

                        If View_ID <> 16 And View_ID <> 25 Then
                            ViewTMMDropDowns1.setShowWeightClass(False)
                            ViewTMMDropDowns1.setOverideMultiSelect(False)
                        Else

                            If View_ID = 25 Then
                                ViewTMMDropDowns1.setShowWeightClass(True)
                            Else
                                ViewTMMDropDowns1.setShowWeightClass(False)
                            End If


                            ViewTMMDropDowns1.setOverideMultiSelect(True)

                        End If

                        ViewTMMDropDowns1.setListSize(6)
                        ViewTMMDropDowns1.setOverideDefaultModel(True)
                        ViewTMMDropDowns1.setControlName(sTypeMakeModelCtrlBaseName)


                        viewCCSTDropDowns.setListSize(4)
                        viewCCSTDropDowns.setIsView(True)
                        viewCCSTDropDowns.setIsBase(False)
                        viewCCSTDropDowns.setFirstControl(True)

                        viewCCSTDropDowns1.setListSize(4)
                        viewCCSTDropDowns1.setIsView(False)
                        viewCCSTDropDowns1.setIsBase(True)
                        viewCCSTDropDowns1.setFirstControl(False)

                        ' only show active countries, only show inactive countries in historical searches
                        viewCCSTDropDowns.setShowInactiveCountries(False)
                        viewCCSTDropDowns1.setShowInactiveCountries(False)

                        'This only runs whenever you're on the mobile site to 
                        If Session.Item("isMobile") Then
                            parent_toggle2.CssClass = "display_none"
                            If View_ID = 6 Then
                                viewTabContainer.CssClass += " starReports"
                            End If
                        End If
                        If Not IsPostBack Then
                            docTabContainer.ActiveTabIndex = 0
                        End If

                        load_standalone_view()

                    End If
                End If

                Session.Item("LastViewModel") = localCriteria.ViewCriteriaAmodID
                Session.Item("LastViewMake") = localCriteria.ViewCriteriaAircraftMake

            End If


            If clsGeneral.clsGeneral.isCrmDisplayMode() = True Then
                If Trim(temp_crm_evo_conn) <> "" Then   ' this was causing an issue with the connection dissapearing
                    ' set it back to what it was before so it is contained 
                    Application.Item("crmClientDatabase") = temp_crm_evo_conn
                End If
            End If

            '

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [Page_Load] : " + ex.Message
        Finally

        End Try

        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />" & Date.Now & " - load  - END<br />"

    End Sub

    Private Sub Page_PreRender(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.PreRender


        Try

            Dim masterPage As New Object

            If Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CUSTOMER_CENTER Then
                masterPage = DirectCast(Page.Master, EmptyCustomerAdminTheme)
            ElseIf Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.HOMEBASE Then
                masterPage = DirectCast(Page.Master, EmptyHomebaseTheme)
            ElseIf Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.EVO Then
                masterPage = DirectCast(Page.Master, EmptyEvoTheme)
                If Session.Item("isMobile") Then
                    masterPage = DirectCast(Page.Master, MobileTheme)
                End If
            End If

            If (bHasMaster = False And (View_ID = 18)) Or (bHasMaster = False And (View_ID = 28)) Then
                masterPage.SetContainerClass("container MaxWidthRemove")
            ElseIf (bHasMaster = False And (View_ID = 1)) Or (bHasMaster = False And (View_ID = 16)) Then
                masterPage.SetContainerClass("container MaxWidthRemove")

            ElseIf bHasMaster = False And (View_ID = 8) Then
                masterPage.SetContainerClass("container MaxWidthRemove maxHeight")
                masterPage.SetFormClass("maxHeight")
            End If

            'This deals with the standalone part of the page.
            'The parent toggle does the exact opposite, shows if standalone doesn't
            'masterPage.MenuBarVisibility(bHasMaster)

            Select Case CInt(localCriteria.ViewCriteriaProductType)

                Case Constants.PRODUCT_CODE_BUSINESS
                    sSelectedProductCode = "B"
                Case Constants.PRODUCT_CODE_COMMERCIAL
                    sSelectedProductCode = "C"
                Case Constants.PRODUCT_CODE_HELICOPTERS
                    sSelectedProductCode = "H"

            End Select

            Select Case CInt(localCriteria.ViewCriteriaAirframeType)
                Case Constants.VIEW_HELICOPTERS
                    Amod_model_ac_range = ConversionFunctions.ConvertNauticalMileToMeter(localCriteria.ViewCriteriaHeliRangeTanksFull)
                    'localCriteria.ViewCriteriaHeliRangeSeatsFull
                Case Else
                    Amod_model_ac_range = ConversionFunctions.ConvertNauticalMileToMeter(localCriteria.ViewCriteriaAircraftRange)
            End Select

            If (localCriteria.ViewID < 2 Or localCriteria.ViewID = 11) And TabContainer1.ActiveTabIndex = 13 Then
                If Not bClickedRange Then
                    'Setting up the default options for the map (default to center on united states) 
                    sRangeTabScriptID = "range_tab_init_script"
                    sRangeTabScript = "$(document).ready(function(){initialize_range_map();});"
                    System.Web.UI.ScriptManager.RegisterStartupScript(Me.bottom_tab_update_panel, Me.bottom_tab_update_panel.GetType(), sRangeTabScriptID, sRangeTabScript, True)
                Else
                    System.Web.UI.ScriptManager.RegisterStartupScript(Me.bottom_tab_update_panel, Me.bottom_tab_update_panel.GetType(), sRangeTabScriptID, sRangeTabScript, True)
                End If
            ElseIf (localCriteria.ViewID < 2 Or localCriteria.ViewID = 11) And TabContainer1.ActiveTabIndex = 11 Then
                System.Web.UI.ScriptManager.RegisterStartupScript(Me.bottom_tab_update_panel, Me.bottom_tab_update_panel.GetType(), sLocationTabScriptID, sLocationTabScript, True)
            End If

            If (localCriteria.ViewID = 25) Then
                Dim notesScript As String = "$(document).ready(function(){$(""#" + notesSearch_date.ClientID.Trim + """).daterangepicker();});"

                If localCriteria.ViewCriteriaIsReport Then
                    If Not String.IsNullOrEmpty(sReportOutputFilename.Trim) Then
                        notesScript += vbCrLf + "openNotesWindowJS(""" + sReportOutputFilename.Trim + """,""" + sReportFrom.Trim + """);"
                    End If
                End If

                If String.IsNullOrEmpty(notesSearch_date.Text.Trim) And Not String.IsNullOrEmpty(localCriteria.ViewCriteriaNoteStartDate.Trim) Then
                    notesSearch_date.Text = localCriteria.ViewCriteriaNoteStartDate
                End If

                System.Web.UI.ScriptManager.RegisterStartupScript(Me.bottom_tab_update_panel, Me.bottom_tab_update_panel.GetType(), "notes_view_script", notesScript, True)

            End If

            If (localCriteria.ViewID = 14) Then
                Dim manufacturerScript As String = ""

                If localCriteria.ViewCriteriaIsReport Then
                    If Not String.IsNullOrEmpty(sReportOutputFilename.Trim) Then
                        manufacturerScript += vbCrLf + "openNotesWindowJS(""" + sReportOutputFilename.Trim + """,""" + sReportFrom.Trim + """);"
                    End If
                End If

                System.Web.UI.ScriptManager.RegisterStartupScript(Me.bottom_tab_update_panel, Me.bottom_tab_update_panel.GetType(), "manufacturer_view_script", manufacturerScript, True)

            End If

            If (localCriteria.ViewID = 32) Then
                Dim deliveriesScript As String = ""

                deliveriesScript += "$(document).ready(function(){google.charts.setOnLoadCallback(function() {" + vbCrLf
                deliveriesScript += " drawVisualization1();" + vbCrLf
                deliveriesScript += " drawVisualization2();" + vbCrLf
                If localCriteria.ViewCriteriaAmodID > -1 Then
                    deliveriesScript += " drawVisualization3();" + vbCrLf
                End If
                deliveriesScript += ";});});" + vbCrLf
                deliveriesScript += sHtmlNewDeliveriesLineChartScript.Trim + vbCrLf
                deliveriesScript += sHtmlNewDeliveriesBarChartScript.Trim + vbCrLf
                If localCriteria.ViewCriteriaAmodID > -1 Then
                    deliveriesScript += sHtmlNewDeliveriesOperationsScript.Trim + vbCrLf
                End If
                System.Web.UI.ScriptManager.RegisterStartupScript(Me.bottom_tab_update_panel, Me.bottom_tab_update_panel.GetType(), "deliveries_view_script", deliveriesScript, True)

            End If

            If localCriteria.ViewID = 8 Then ' location 

                Dim clear_continent As String = "~/view_template.aspx?ViewID=" + localCriteria.ViewID.ToString + "&ViewName=" + localCriteria.ViewName.Trim + "&onLocationTab=" + IIf(localCriteria.ViewID < 2, "true", "false") + "&viewCountry=&viewCity=&viewContinent=clear&viewState=&amod_id=" + localCriteria.ViewCriteriaAmodID.ToString & IIf(bHasMaster = False, "&noMaster=false", "")
                Dim clear_country As String = "~/view_template.aspx?ViewID=" + localCriteria.ViewID.ToString + "&ViewName=" + localCriteria.ViewName.Trim + "&onLocationTab=" + IIf(localCriteria.ViewID < 2, "true", "false") + "&viewCountry=clear&viewCity=&viewContinent=" + Server.UrlEncode(localCriteria.ViewCriteriaContinent) + "&viewState=&amod_id=" + localCriteria.ViewCriteriaAmodID.ToString & IIf(bHasMaster = False, "&noMaster=false", "")
                Dim clear_state As String = "~/view_template.aspx?ViewID=" + localCriteria.ViewID.ToString + "&ViewName=" + localCriteria.ViewName.Trim + "&onLocationTab=" + IIf(localCriteria.ViewID < 2, "true", "false") + "&viewCountry=" + Server.UrlEncode(localCriteria.ViewCriteriaCountry.ToString) + "&viewCity=&viewContinent=" + Server.UrlEncode(localCriteria.ViewCriteriaContinent) + "&viewState=clear&amod_id=" + localCriteria.ViewCriteriaAmodID.ToString & IIf(bHasMaster = False, "&noMaster=false", "")
                Dim clear_city As String = "~/view_template.aspx?ViewID=" + localCriteria.ViewID.ToString + "&ViewName=" + localCriteria.ViewName.Trim + "&onLocationTab=" + IIf(localCriteria.ViewID < 2, "true", "false") + "&viewCountry=" + Server.UrlEncode(localCriteria.ViewCriteriaCountry.ToString) + "&viewCity=clear&viewContinent=" + Server.UrlEncode(localCriteria.ViewCriteriaContinent) + "&viewState=&amod_id=" + localCriteria.ViewCriteriaAmodID.ToString & IIf(bHasMaster = False, "&noMaster=false", "")

                Dim bHadSelection As Boolean = False

                lower_actions_submenu_dropdown.Items.Clear()
                view_location_clear_list.Items.Clear()
                view_location_clear_list.Items.Add(New ListItem("", ""))

                If Not String.IsNullOrEmpty(localCriteria.ViewCriteriaContinent.ToString.Trim) Then
                    lower_actions_submenu_dropdown.Items.Add(New ListItem("Clear Continent", clear_continent))
                    view_location_clear_list.Items.Add(New ListItem("Clear Continent", clear_continent))
                    bHadSelection = True
                End If

                If Not String.IsNullOrEmpty(localCriteria.ViewCriteriaCountry.ToString.Trim) Then
                    lower_actions_submenu_dropdown.Items.Add(New ListItem("Clear Country", clear_country))
                    view_location_clear_list.Items.Add(New ListItem("Clear Country", clear_country))
                    bHadSelection = True
                End If

                If Not String.IsNullOrEmpty(localCriteria.ViewCriteriaState.ToString.Trim) Then
                    lower_actions_submenu_dropdown.Items.Add(New ListItem("Clear State", clear_state))
                    view_location_clear_list.Items.Add(New ListItem("Clear State", clear_state))
                    bHadSelection = True
                End If

                If Not String.IsNullOrEmpty(localCriteria.ViewCriteriaCity.ToString.Trim) Then
                    lower_actions_submenu_dropdown.Items.Add(New ListItem("Clear City", clear_city))
                    view_location_clear_list.Items.Add(New ListItem("Clear City", clear_city))
                    bHadSelection = True
                End If

                If bHadSelection Then
                    Dim maxWidth = (CStr("Clear Continent").Length * Constants._STARTCHARWIDTH)
                    view_location_clear_list.Width = (maxWidth)
                Else
                    view_location_clear_list.Visible = False
                End If

                ToggleVisibilityOfActionMenu(lower_actions_dropdown, lower_actions_submenu_dropdown)

            ElseIf localCriteria.ViewID = 4 And docTabContainer.ActiveTabIndex = 3 Then

                lower_actions_submenu_dropdown.Items.Clear()

                lower_actions_submenu_dropdown.Items.Add(New ListItem("JETNET Export/Report", "javascript:SubMenuDrop(5,0,""document"");"))
                If HttpContext.Current.Session.Item("localUser").crmDemoUserFlag = True Then  ' ADDED IN MSW - 3/26/20
                Else
                    lower_actions_submenu_dropdown.Items.Add(New ListItem("Export All Document Records", "javascript:SubMenuDrop(7,0,""document"");"))
                End If

                ToggleVisibilityOfActionMenu(lower_actions_dropdown, lower_actions_submenu_dropdown)

            ElseIf localCriteria.ViewID = 4 And docTabContainer.ActiveTabIndex <> 3 Then

                lower_actions_submenu_dropdown.Items.Clear()
                lower_actions_dropdown.Visible = False

            End If

            ' clear the button text each time
            buttons.Text = ""
            buttons1.Text = ""
            buttons2.Text = ""

            'This code snippet means that the gray bar isn't filled up if there is a parent page. 
            If Not bHasMaster Then

                'masterPage.ToggleWelcomeHeader(False)

                If localCriteria.ViewID <> 7 And localCriteria.ViewID <> 14 And localCriteria.ViewID <> 8 And localCriteria.ViewID <> 18 And localCriteria.ViewID <> 24 And localCriteria.ViewID <> 25 And localCriteria.ViewID <> 28 Then

                    If (localCriteria.ViewCriteriaAmodID > -1 Or localCriteria.ViewID <> 16) Then

                        If localCriteria.ViewID = 11 Then
                            buttons.Text = "<a target=""_new"" href=""viewtopdf.aspx?amod_id=" + localCriteria.ViewCriteriaAmodID.ToString + "&viewID=1&sub_id=" + Session.Item("localSubscription").crmSubscriptionID.ToString + "&pc=" + sSelectedProductCode + "&months=" + localCriteria.ViewCriteriaTimeSpan.ToString + """ class=""pdf_button"">PDF</a>"
                        Else

                            If localCriteria.ViewID > 2 Then
                                buttons.Text = "<a href=""view_template.aspx?noMaster=false&ViewID=1&ViewName=" + Server.UrlEncode("Model Market Summary") + "&amod_id=" + localCriteria.ViewCriteriaAmodID.ToString + """ target=""_new"" class=""print_button"">Model Market Summary</a>"
                            End If

                            If localCriteria.ViewID = 1 Then

                                If Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.HOMEBASE Then  ' added in MSW - 10/14/19
                                    If Trim(HttpContext.Current.Session.Item("jetnetServerNotesDatabase")) = "" Then
                                        HttpContext.Current.Session.Item("jetnetServerNotesDatabase") = HttpContext.Current.Session.Item("jetnetClientDatabase")
                                    End If
                                End If

                                buttons.Text += "<a target=""_new"" href=""viewtopdf.aspx?amod_id=" + localCriteria.ViewCriteriaAmodID.ToString + "&viewID=" + localCriteria.ViewID.ToString + "&sub_id=" + Session.Item("localSubscription").crmSubscriptionID.ToString + "&pc=" + sSelectedProductCode + "&new_PDF=Y&months=" + localCriteria.ViewCriteriaTimeSpan.ToString + """ class=""pdf_button underline cursor"">Standard</a>"

                                If Session.Item("localSubscription").crmAerodexFlag = False Then
                                    'If Session.Item("jetnetWebSiteType") = eWebSiteTypes.LOCAL Or HttpContext.Current.Session.Item("jetnetWebSiteType") = eWebSiteTypes.TEST Then
                                    buttons.Text += "<a target=""_new"" title=""Find potential prospects for buying this model."" onclick=""javascript:load('view_template.aspx?noMaster=false&amod_id=" + localCriteria.ViewCriteriaAmodID.ToString + "&viewID=18','','scrollbars=yes,menubar=no,height=900,width=1050,resizable=yes,toolbar=no,location=no,status=no');return false;"" class=""underline cursor prospectViewLink"">Prospector</a>"
                                    'End If
                                End If


                                ' If localDatalayer.Get_Subscription_Team(Session.Item("localUser").crmSubSubID, "Market Insight") = True Then
                                buttons.Text += "<i class=""fa fa-area-chart""></i><a href=""javascript:SubMenuDropValue2(0,'VALUE');"" class=""noBefore"">Market Report</a>&nbsp;&nbsp;&nbsp;"
                                ' End If

                                buttons.Text += "<a target=""_new"" href=""viewtopdf.aspx?amod_id=" + localCriteria.ViewCriteriaAmodID.ToString + "&viewID=" + localCriteria.ViewID.ToString + "&sub_id=" + Session.Item("localSubscription").crmSubscriptionID.ToString + "&pc=" + sSelectedProductCode + "&months=" + localCriteria.ViewCriteriaTimeSpan.ToString + """ class=""pdf_button underline cursor"">Classic</a>"
                            ElseIf localCriteria.ViewID <> 16 And localCriteria.ViewID <> 26 Then
                                If HttpContext.Current.Session.Item("localUser").crmDemoUserFlag = True Then  ' ADDED IN MSW - 3/26/20
                                Else
                                    buttons.Text += "<a target=""_new"" href=""viewtopdf.aspx?amod_id=" + localCriteria.ViewCriteriaAmodID.ToString + "&viewID=" + localCriteria.ViewID.ToString + "&sub_id=" + Session.Item("localSubscription").crmSubscriptionID.ToString + "&pc=" + sSelectedProductCode + "&months=" + localCriteria.ViewCriteriaTimeSpan.ToString + """ class=""pdf_button"">PDF</a>"
                                End If
                            ElseIf localCriteria.ViewID = 16 Then
                                If Not IsNothing(localCriteria.ViewCriteriaAmodIDArray) Then
                                    If UBound(localCriteria.ViewCriteriaAmodIDArray) > 0 Then
                                        buttons.Text += "<i class=""fa fa-area-chart""></i><a href=""javascript:SubMenuDropValue3(0,'VALUE');"" class=""noBefore"">Market Report</a>&nbsp;&nbsp;&nbsp;"
                                    End If
                                End If
                            End If
                        End If

                    Else
                        buttons.Text = ""
                    End If

                    'buttons.Text += "<a class=""underline cursor"" onclick=""javascript:window.close();return false;"" class=""close_button"">Close Window</a>"

                    If (localCriteria.ViewCriteriaAmodID > -1) Then
                        buttons1.Text = "<a href=""view_template.aspx?noMaster=false&ViewID=" + localCriteria.ViewID.ToString + "&ViewName=" + Server.UrlEncode("Model Market Summary") + "&amod_id=" + localCriteria.ViewCriteriaAmodID.ToString + """ target=""_new"" class=""print_button"">Model Market Summary</a>"

                        If localCriteria.ViewID <> 16 And localCriteria.ViewID <> 26 Then
                            buttons1.Text += "<a target=""_new"" href=""viewtopdf.aspx?amod_id=" + localCriteria.ViewCriteriaAmodID.ToString + "&viewID=" + localCriteria.ViewID.ToString + "&sub_id=" + Session.Item("localSubscription").crmSubscriptionID.ToString + "&pc=" + sSelectedProductCode + """ class=""pdf_button"">PDF</a>"
                        End If

                    Else
                        buttons1.Text = ""
                    End If

                    ' buttons1.Text += "<a class=""underline cursor"" onclick=""javascript:window.close();return false;"" class=""close_button"">Close Window</a>"

                Else

                    If (localCriteria.ViewCriteriaAmodID > -1) And localCriteria.ViewID <> 24 And localCriteria.ViewID <> 28 And localCriteria.ViewID <> 25 Then
                        buttons.Text = "<a href=""view_template.aspx?noMaster=false&ViewID=1&ViewName=" + Server.UrlEncode("Model Market Summary") + "&amod_id=" + localCriteria.ViewCriteriaAmodID.ToString + """ target=""_new"" class=""print_button"">Model Market Summary</a>"
                    Else
                        buttons.Text = ""
                    End If

                    ' buttons.Text += "<a class=""underline cursor"" onclick=""javascript:window.close();return false;"" class=""close_button"">Close Window</a>"

                    If (localCriteria.ViewCriteriaAmodID > -1) And localCriteria.ViewID <> 24 And localCriteria.ViewID <> 25 Then
                        buttons1.Text = "<a href=""view_template.aspx?noMaster=false&ViewID=1&ViewName=" + Server.UrlEncode("Model Market Summary") + "&amod_id=" + localCriteria.ViewCriteriaAmodID.ToString + """ target=""_new"" class=""print_button"">Model Market Summary</a>"
                    Else
                        buttons1.Text = ""
                    End If

                    'buttons1.Text += "<a class=""underline cursor"" onclick=""javascript:window.close();return false;"" class=""close_button"">Close Window</a>"

                End If

                'buttons2.Text = "<a class=""underline cursor"" onclick=""javascript:window.close();return false;"" class=""close_button"">Close Window</a>"

            Else ' this page is "viewed" inside the "main" window


                If localCriteria.ViewCriteriaAmodID > -1 Then
                    sStandalonePageLink += "&amod_id=" + localCriteria.ViewCriteriaAmodID.ToString
                End If

                If Not IsNothing(compare_amod_id_a.SelectedValue) Then
                    If Not String.IsNullOrEmpty(compare_amod_id_a.SelectedValue) Then
                        sStandalonePageLink += "&amod_id_a=" + compare_amod_id_a.SelectedValue
                    End If
                End If

                If Not IsNothing(compare_amod_id_b.SelectedValue) Then
                    If Not String.IsNullOrEmpty(compare_amod_id_b.SelectedValue) Then
                        sStandalonePageLink += "&amod_id_b=" + compare_amod_id_b.SelectedValue
                    End If
                End If

                If Not IsNothing(compare_amod_id_c.SelectedValue) Then
                    If Not String.IsNullOrEmpty(compare_amod_id_c.SelectedValue) Then
                        sStandalonePageLink += "&amod_id_c=" + compare_amod_id_c.SelectedValue
                    End If
                End If

                If Not IsNothing(Request.Item("bIsReport")) Then
                    If Not String.IsNullOrEmpty(Request.Item("bIsReport").ToString) Then
                        sStandalonePageLink += IIf(Request.Item("bIsReport").ToString.Trim.Contains("Y"), "&bIsReport=Y", "")
                    End If
                End If


                If localCriteria.ViewID <> 7 And localCriteria.ViewID <> 14 And localCriteria.ViewID <> 8 And localCriteria.ViewID <> 24 And localCriteria.ViewID <> 28 And localCriteria.ViewID <> 25 Then

                    If (localCriteria.ViewCriteriaAmodID > -1 Or localCriteria.ViewID <> 16) Then

                        If localCriteria.ViewID = 11 Then

                            If HttpContext.Current.Session.Item("localUser").crmDemoUserFlag = True Then  ' ADDED IN MSW - 3/26/20

                            Else
                                buttons.Text = "<a target=""_new"" href=""viewtopdf.aspx?amod_id=" + localCriteria.ViewCriteriaAmodID.ToString + "&viewID=1&sub_id=" + Session.Item("localSubscription").crmSubscriptionID.ToString + "&pc=" + sSelectedProductCode + "&months=" + localCriteria.ViewCriteriaTimeSpan.ToString + """ class=""pdf_button underline cursor"">PDF</a>"
                            End If
                        Else

                            If localCriteria.ViewID > 2 Then
                                buttons.Text = "<a href=""view_template.aspx?noMaster=false&ViewID=1&ViewName=" + Server.UrlEncode("Model Market Summary") + "&amod_id=" + localCriteria.ViewCriteriaAmodID.ToString + """ target=""_new"" class=""print_button underline cursor"">Model Market Summary</a>"
                            End If

                            If localCriteria.ViewID = 1 Then

                                ' buttons.Text += "<a target=""_new"" style=""font-weight:bold;"" href=""viewtopdf.aspx?amod_id=" + localCriteria.ViewCriteriaAmodID.ToString + "&viewID=" + localCriteria.ViewID.ToString + "&sub_id=" + Session.Item("localSubscription").crmSubscriptionID.ToString + "&pc=" + sSelectedProductCode + "&new_PDF=Y&months=" + localCriteria.ViewCriteriaTimeSpan.ToString + """ class=""pdf_button underline cursor"">Standard</a>"
                                If Session.Item("localSubscription").crmAerodexFlag = False Then
                                    'If Session.Item("jetnetWebSiteType") = eWebSiteTypes.LOCAL Or HttpContext.Current.Session.Item("jetnetWebSiteType") = eWebSiteTypes.TEST Then
                                    buttons.Text += "<a target=""_new"" title=""Find potential prospects for buying this model."" onclick=""javascript:load('view_template.aspx?noMaster=false&amod_id=" + localCriteria.ViewCriteriaAmodID.ToString + "&viewID=18','','scrollbars=yes,menubar=no,height=900,width=1050,resizable=yes,toolbar=no,location=no,status=no');return false;"" class=""underline cursor prospectViewLink"">Prospector</a>"
                                    'End If
                                End If

                                If Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.HOMEBASE Then
                                    If Trim(HttpContext.Current.Session.Item("jetnetServerNotesDatabase")) = "" Then
                                        HttpContext.Current.Session.Item("jetnetServerNotesDatabase") = HttpContext.Current.Session.Item("jetnetClientDatabase")
                                    End If
                                End If

                                ' If localDatalayer.Get_Subscription_Team(Session.Item("localUser").crmSubSubID, "Market Insight") = True Then
                                buttons.Text += "<i class=""fa fa-area-chart""></i><a href=""javascript:SubMenuDropValue2(0,'VALUE');"" class=""noBefore"">Market Report</a>&nbsp;&nbsp;&nbsp;"
                                ' End If

                                standard_pdf_button.Visible = True

                                ' buttons.Text += "<a target=""_new"" href=""viewtopdf.aspx?amod_id=" + localCriteria.ViewCriteriaAmodID.ToString + "&viewID=" + localCriteria.ViewID.ToString + "&sub_id=" + Session.Item("localSubscription").crmSubscriptionID.ToString + "&pc=" + sSelectedProductCode + "&new_PDF=Y&months=" + localCriteria.ViewCriteriaTimeSpan.ToString + """ class=""pdf_button underline cursor"">Standard</a>"
                                buttons.Text += "<a target=""_new"" href=""viewtopdf.aspx?amod_id=" + localCriteria.ViewCriteriaAmodID.ToString + "&viewID=" + localCriteria.ViewID.ToString + "&sub_id=" + Session.Item("localSubscription").crmSubscriptionID.ToString + "&pc=" + sSelectedProductCode + "&months=" + localCriteria.ViewCriteriaTimeSpan.ToString + """ class=""pdf_button underline cursor"">Classic</a>"
                            ElseIf localCriteria.ViewID = 16 Then
                                buttons.Text += "<i class=""fa fa-area-chart""></i><a href=""javascript:SubMenuDropValue3(0,'VALUE');"" class=""noBefore"">Market Report</a>&nbsp;&nbsp;&nbsp;"
                            Else
                                If localCriteria.ViewID <> 16 And localCriteria.ViewID <> 26 Then
                                    buttons.Text += "<a target=""_new"" href=""viewtopdf.aspx?amod_id=" + localCriteria.ViewCriteriaAmodID.ToString + "&viewID=" + localCriteria.ViewID.ToString + "&sub_id=" + Session.Item("localSubscription").crmSubscriptionID.ToString + "&pc=" + sSelectedProductCode + "&months=" + localCriteria.ViewCriteriaTimeSpan.ToString + """ class=""pdf_button underline cursor"">PDF</a>"
                                End If
                            End If


                        End If

                    Else
                        buttons.Text = ""
                    End If

                    buttons.Text += "<a class=""underline cursor"" class=""open_button"" onclick='javascript:load(""view_template.aspx?noMaster=false&ViewID=" + localCriteria.ViewID.ToString + "&ViewName=" + localCriteria.ViewName + sStandalonePageLink.Trim + ""","""",""scrollbars=yes,menubar=no,height=900,width=1150,resizable=yes,toolbar=no,location=no,status=no"");'>New Window</a>"


                    If (localCriteria.ViewCriteriaAmodID > -1 And localCriteria.ViewID <> 32) Then
                        buttons1.Text = "<a href=""view_template.aspx?noMaster=false&ViewID=1&" + Server.UrlEncode("Model Market Summary") + "&amod_id=" + localCriteria.ViewCriteriaAmodID.ToString + """ target=""_new"" class=""print_button underline cursor"">Model Market Summary</a>"

                        If localCriteria.ViewID <> 16 And localCriteria.ViewID <> 26 And localCriteria.ViewID <> 32 Then
                            buttons1.Text += "<a target=""_new"" href=""viewtopdf.aspx?amod_id=" + localCriteria.ViewCriteriaAmodID.ToString + "&viewID=" + localCriteria.ViewID.ToString + "&sub_id=" + Session.Item("localSubscription").crmSubscriptionID.ToString + "&pc=" + sSelectedProductCode + """ class=""pdf_button underline cursor"">PDF</a>"
                        ElseIf localCriteria.ViewID = 16 Then
                            buttons1.Text += "<i class=""fa fa-area-chart""></i><a href=""javascript:SubMenuDropValue3(0,'VALUE');"" class=""noBefore"">Market Report</a>&nbsp;&nbsp;&nbsp;"
                        End If

                    ElseIf localCriteria.ViewID = 2 Then

                        If localCriteria.ViewID <> 16 And localCriteria.ViewID <> 26 Then
                            buttons1.Text += "<a target=""_new"" href=""viewtopdf.aspx?" + sStandalonePageLink + "&viewID=" + localCriteria.ViewID.ToString + "&sub_id=" + Session.Item("localSubscription").crmSubscriptionID.ToString + "&pc=" + sSelectedProductCode + """ class=""pdf_button underline cursor"">PDF</a>"
                        End If
                    Else
                        buttons1.Text = ""
                        If localCriteria.ViewID = 16 Then
                            If Not IsNothing(localCriteria.ViewCriteriaAmodIDArray) Then
                                If UBound(localCriteria.ViewCriteriaAmodIDArray) > 0 Then
                                    buttons1.Text += "<i class=""fa fa-area-chart""></i><a href=""javascript:SubMenuDropValue3(0,'VALUE');"" class=""noBefore"">Market Report</a>&nbsp;&nbsp;&nbsp;"
                                End If
                            End If
                        End If
                    End If

                    buttons1.Text += "<a class=""open_button underline cursor"" onclick=""javascript:load('view_template.aspx?noMaster=false&ViewID=" + localCriteria.ViewID.ToString + "&ViewName=" + localCriteria.ViewName + sStandalonePageLink.Trim + "','','scrollbars=yes,menubar=no,height=900,width=1150,resizable=yes,toolbar=no,location=no,status=no');"">New Window</a>"

                Else

                    If (localCriteria.ViewCriteriaAmodID > -1) And localCriteria.ViewID <> 24 And localCriteria.ViewID <> 28 And localCriteria.ViewID <> 25 Then
                        buttons.Text = "<a href=""view_template.aspx?noMaster=false&ViewID=1&ViewName=" + Server.UrlEncode("Model Market Summary") + "&amod_id=" + localCriteria.ViewCriteriaAmodID.ToString + """ target=""_new"" class=""print_button underline cursor"">Model Market Summary</a>"
                    Else
                        buttons.Text = ""
                    End If

                    If IsNothing(Session.Item("searchCriteria").SearchViewCriteriaAirportSelected) Then
                        Session.Item("searchCriteria").SearchViewCriteriaAirportSelected = 0
                    End If

                    'If localCriteria.ViewID = 28 And (Trim(Session.Item("searchCriteria").SearchViewCriteriaAirportSelected) <> "0" Or selectAirportsType.SelectedValue = "4") Then
                    '  'HttpContext.Current.Session.Item("jetnetServerNotesDatabase") = HttpContext.Current.Session.Item("jetnetClientDatabase")
                    '  ' If localDatalayer.Get_Subscription_Team(Session.Item("localUser").crmSubSubID, "Utilization Insight") = True Then
                    '  buttons.Text += "<a target=""_new"" href=""viewtopdf.aspx?amod_id=0&aport_id=" & Trim(Session.Item("searchCriteria").SearchViewCriteriaAirportSelected) & "&viewID=" + localCriteria.ViewID.ToString + "&sub_id=" + Session.Item("localUser").crmSubSubID.ToString.Trim + "&pc=" + sSelectedProductCode + "&months=" + localCriteria.ViewCriteriaTimeSpan.ToString + """ class=""pdf_button underline cursor"">Utilization Report</a>"
                    '  ' End If
                    'Else
                    '  buttons.Text += ""
                    'End If

                    buttons.Text += "<a class=""open_button underline cursor"" onclick=""javascript:load('view_template.aspx?noMaster=false&ViewID=" + localCriteria.ViewID.ToString + "&ViewName=" + localCriteria.ViewName + sStandalonePageLink.Trim + "','','scrollbars=yes,menubar=no,height=900,width=1150,resizable=yes,toolbar=no,location=no,status=no');"">New Window</a>"

                    If (localCriteria.ViewCriteriaAmodID > -1) And localCriteria.ViewID <> 24 And localCriteria.ViewID <> 28 And localCriteria.ViewID <> 25 Then
                        buttons1.Text = "<a href=""view_template.aspx?noMaster=false&ViewID=1&ViewName=" + Server.UrlEncode("Model Market Summary") + "&amod_id=" + localCriteria.ViewCriteriaAmodID.ToString + """ target=""_new"" class=""print_button underline cursor"">Model Market Summary</a>"
                    Else
                        buttons1.Text = ""
                    End If

                    buttons1.Text += ("<a class=""open_button underline cursor"" onclick=""javascript:load('view_template.aspx?noMaster=false&ViewID=" + localCriteria.ViewID.ToString + "&ViewName=" + localCriteria.ViewName + sStandalonePageLink.Trim + "','','scrollbars=yes,menubar=no,height=900,width=1150,resizable=yes,toolbar=no,location=no,status=no');"">New Window</a>")

                End If
            End If

            masterPage.RemoveLine()
            masterPage.setPageTitle(HttpContext.Current.Server.UrlDecode(localCriteria.ViewName))
        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [Page_PreRender] : " + ex.Message
        End Try

    End Sub

    Private Sub ToggleVisibilityOfActionMenu(ByRef ParentBulletedList As BulletedList, ByRef SubMenuBulletedList As BulletedList)
        'actions dropdown
        ParentBulletedList.Attributes.Add("onmouseover", "javascript:ShowBar('" & SubMenuBulletedList.ClientID & "', true);")
        ParentBulletedList.Attributes.Add("onmouseout", "javascript:ShowBar('" & SubMenuBulletedList.ClientID & "', false);")

        SubMenuBulletedList.Attributes.Add("onmouseover", "javascript:ShowBar('" & SubMenuBulletedList.ClientID & "', true);")
        SubMenuBulletedList.Attributes.Add("onmouseout", "javascript:ShowBar('" & SubMenuBulletedList.ClientID & "', false);")

        ParentBulletedList.Visible = True

        'This is a small example of removing a list item:
        'SubMenuBulletedList.Items.RemoveAt(0)
        'actions_submenu_dropdown.Items.Clear() - This removes all

        'This is a small example of adding a list item:
        'SubMenuBulletedList.Items.Add(New ListItem("Item for view #" & View_ID, "javascript:alert('You clicked on this folder.');"))

    End Sub

    Public Sub submenu_dropdown_Click(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.BulletedListEventArgs)
        Try
            Dim selectedLI As New ListItem
            selectedLI = sender.Items(e.Index) 'This is the item they clicked.
            'selectedLI.Text This is the text of the item they clicked
        Catch ex As Exception

        End Try
    End Sub

    Public Sub run_active_tab_changed(ByVal active_tab As Integer, Optional ByVal is_graph_only As Boolean = False, Optional ByVal results_label_to_display As String = "", Optional ByVal rep_id_selected As Long = 0, Optional ByVal run_comparable_insert As Boolean = False)

        Dim sHtmlMarketTrends As String = ""
        Dim NOTE_ID As Long = 0
        Dim temp_table As New DataTable
        Dim chart_htmlString As String = ""
        Dim temp_table2 As New DataTable
        Dim column As New DataColumn 'Column to Add Source to jetnet data.
        Dim column2 As New DataColumn 'Column to Add id to jetnet data. To match client side datatable 
        Dim column3 As New DataColumn 'Column to add take price to jetnet data (null)
        Dim column4 As New DataColumn
        Dim column5 As New DataColumn

        Dim rest_of_ac_string As String = ""
        Dim real_ac_id As Long = 0
        Dim make_name As String = ""
        Dim model_name As String = ""
        Dim temp_amod_id As Integer = 0
        Dim avg_asking As Long = 0
        Dim avg_take As Long = 0
        Dim avg_sold As Long = 0


        Dim db_fields(100) As String
        Dim name_fields(100) As String
        Dim desc_fields(100) As String
        Dim field_array_count As Integer = 0
        Dim count_of_records As Long = 0
        Dim select_string As String = ""
        Dim temp_label_string As String = ""
        Dim field_name_temp As String = ""
        Dim rep_id As Integer = 0
        Dim aclsData_Temp As New clsData_Manager_SQL
        Dim extra_crit As Boolean = False
        Dim model_default_id As String = ""
        Dim temp_val As String = ""
        Dim need_run As Boolean = True
        Dim past_date As String = ""

        Dim google_avg_asking As String = ""
        Dim google_avg_sold As String = ""
        Dim google_percent As String = ""
        Dim google_variance As String = ""
        Dim temp_graph As String = ""
        Dim charting_string As String = ""


        Dim charting_string_value As String = ""
        Dim temp_string_value As String = ""
        Dim results_table As New DataTable
        Dim temp_html_string As String = ""

        aclsData_Temp.JETNET_DB = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
        aclsData_Temp.client_DB = Application.Item("crmClientDatabase") 'HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim

        If Not IsNothing(HttpContext.Current.Request.Item("extra")) Then
            If Not String.IsNullOrEmpty(HttpContext.Current.Request.Item("extra").ToString.Trim) And HttpContext.Current.Request.Item("extra").ToString.ToLower.Contains("true") Then
                extra_crit = True
            End If
        End If

        If rep_id_selected <> 0 Then
            rep_id = rep_id_selected
        Else
            If Trim(Request("rep_id")) <> "" Then
                rep_id = Trim(Request("rep_id"))
                If rep_id = 11111 Then  ' if its that view, set extra to true 
                    extra_crit = True
                End If
                'If Not IsPostBack Then
                '  TabContainer1.ActiveTabIndex = 4
                'End If
            End If

            If IsPostBack Then
                If TabContainer1.ActiveTabIndex = 1 Then
                    If Trim(Request("activetab")) <> "1" And Trim(Request("activetab")) <> "" Then
                        rep_id = 0
                    End If
                ElseIf TabContainer1.ActiveTabIndex = 2 Then
                    If Trim(Request("activetab")) <> "2" And Trim(Request("activetab")) <> "" Then
                        rep_id = 0
                    End If
                ElseIf TabContainer1.ActiveTabIndex = 4 Then
                    If Trim(Request("activetab")) <> "4" And Trim(Request("activetab")) <> "" Then
                        rep_id = 0
                    End If
                End If
            End If
        End If




        Try


            column.DataType = System.Type.GetType("System.Double")
            column.DefaultValue = 0
            column.Unique = False
            column.ColumnName = "asking_price"
            temp_table.Columns.Add(column)

            column2.DataType = System.Type.GetType("System.Double")
            column2.DefaultValue = 0
            column2.Unique = False
            column2.ColumnName = "take_price"
            temp_table.Columns.Add(column2)

            column3.DataType = System.Type.GetType("System.Double")
            column3.DefaultValue = 0
            column3.AllowDBNull = True
            column3.Unique = False
            column3.ColumnName = "sold_price"
            temp_table.Columns.Add(column3)


            column4.DataType = System.Type.GetType("System.DateTime")
            column4.AllowDBNull = True
            column4.Unique = False
            column4.ColumnName = "date_of"
            temp_table.Columns.Add(column4)

            column5.DataType = System.Type.GetType("System.String")
            column5.AllowDBNull = True
            column5.Unique = False
            column5.ColumnName = "ac_details"
            temp_table.Columns.Add(column5)


            If Trim(Request("note_id")) <> "" Then
                NOTE_ID = Trim(Request("note_id"))
            Else
                If Trim(Request("noteID")) <> "" Then
                    NOTE_ID = Trim(Request("noteID"))
                Else
                    NOTE_ID = 2
                End If
            End If

            If NOTE_ID > 0 Then ' these both have table issues affeecting other tabs in certain circumstances
                Me.view_reports_label.Text = ""
                Me.view_wanteds_label1.Text = ""
                Me.compare_view_current_label.Text = ""
            End If

            If RunModelOnValueOnly Then
                temp_amod_id = localCriteria.ViewCriteriaAmodID
            End If

            If IsNothing(Session("LAST_RUN_OVERALL_TAB")) Then
                Session("LAST_RUN_OVERALL_TAB") = 0
            End If


            past_date = (Year(DateAdd(DateInterval.Month, -year_month_settings.SelectedValue, Date.Now)) & "-" & Month(DateAdd(DateInterval.Month, -year_month_settings.SelectedValue, Date.Now)) & "-" & Day(DateAdd(DateInterval.Month, -year_month_settings.SelectedValue, Date.Now)))

            '    Me.compare_analytics_panel.Visible = False

            ' if its view 11 dont reload anything 
            If localCriteria.ViewID = 18 Then

            ElseIf localCriteria.ViewID = 19 Then

                HttpContext.Current.Session.Item("jetnetServerNotesDatabase") = Application.Item("crmClientDatabase")

                Session.Item("localSubscription").crmServerSideNotes_Flag = True


                localDatalayer.run_view_19_actions(NOTE_ID, real_ac_id, make_name, model_name, temp_amod_id, rest_of_ac_string, chart_htmlString, Session.Item("CLIENT_AC_ID"), Me.model_reports_tab.HeaderText, COMPLETED_OR_OPEN, localCriteria, make_model_name_label.Text, Me.breadcrumbs.Text, TabContainer1, Me.settings_right_label.Text, Me.Page.Title, Me.LAST_SAVE_DATE, Session.Item("JETNET_AC_ID"), Me.edit_label_click.Text, Me.year_month_settings, Me.estimated_value, Me.years_of, Me.sales_within, Me.use_jetnet_data, Me.Page, Me.used_of_used, Me.year_of_current.Text, Me.aftt_of_current.Text, RunModelOnValueOnly)

                Call turn_on_off_tabs_compare_view(NOTE_ID)

                If RunModelOnValueOnly Then
                    aircraft_image.Visible = True
                    estimated_value_label.Visible = False
                    label_behind_pic.Visible = False
                    trends_tab.Visible = False
                    retail_tab.Visible = False
                    documents_tab.Visible = False
                    TabContainer1.ActiveTab = for_sale_tab
                    set_up_ac_model_pic(0, temp_amod_id, make_name, model_name, "", "", rest_of_ac_string, "")
                    resizeTopLeftTab.Width = "35%"
                    TabContainer2.Width = Unit.Percentage(100D)
                    aircraft_image.Width = Unit.Percentage(100D)
                    topLeftCSSContainer.CssClass = ""
                    TabPanel14.Width = Unit.Percentage(100D)
                End If

                ' make sure if there is a switch in amod id that we clear out the sessions
                If Not IsNothing(Session("Last_Amod")) Then
                    If (Trim(Session("Last_Amod")) <> Trim(temp_amod_id)) Then ' if we have switched models
                        Session("SELECTED_CURRENT_MARKET_EXPORT") = 0
                        Session("SELECTED_CURRENT_MARKET_EXPORT_INDEX") = 0
                        Session("SELECTED_SOLD_EXPORT") = 0
                        Session("SELECTED_SOLD_EXPORT_INDEX") = 0
                    End If
                End If



                If active_tab > 0 Then
                    TabContainer1.ActiveTabIndex = active_tab
                ElseIf TabContainer1.ActiveTabIndex > 13 Then   ' put this line in to correct the first time it comes in 
                    TabContainer1.ActiveTabIndex = active_tab
                End If

                If Trim(Me.estimated_value_label.Text) = "" Then
                    localDatalayer.views_analytics_graph_1(Session.Item("CLIENT_AC_ID"), Me.ANALYTICS_HISTORY, "", Session("JETNET_AC_ID"), "", COMPLETED_OR_OPEN, NOTE_ID, False, Me.estimated_value_label.Text)
                End If

                If Me.estimated_value.Checked = True And estimated_value_label2.Visible = False Then
                    If TabContainer1.ActiveTabIndex <> 5 Then
                        Call run_full_recent_sales(results_label_to_display, temp_amod_id, rep_id, temp_table, is_graph_only, aclsData_Temp, NOTE_ID, chart_htmlString, active_tab)
                        Me.estimated_value.Checked = True
                        Me.estimated_value_label2.Visible = True
                    End If
                ElseIf TabContainer1.ActiveTabIndex <> 5 And Not IsPostBack Then
                    Call run_full_recent_sales(results_label_to_display, temp_amod_id, rep_id, temp_table, is_graph_only, aclsData_Temp, NOTE_ID, chart_htmlString, active_tab)
                ElseIf Me.estimated_value.Checked = True Then
                    Me.estimated_value_label2.Visible = True
                End If




                'If Not IsPostBack Then
                '  If Not IsNothing(Session("Show_Estimated")) Then
                '    If Trim(Session("Show_Estimated")) = "Y" Then
                '      If Trim(Session("Show_Estimated")) = "Y" Then
                '        Me.estimated_value.Checked = True
                '        Me.estimated_value_label2.Visible = True
                '      End If
                '    End If
                '  End If
                'End If


                Me.view_reports_label.Text = results_label_to_display

                If IsNothing(Session("LAST_COMPARE_TAB")) Then
                    Session("LAST_COMPARE_TAB") = 0
                End If

                If IsNothing(Session("LAST_SOLD_TAB")) Then
                    Session("LAST_SOLD_TAB") = 0
                End If


                If TabContainer1.ActiveTabIndex = 0 Then


                    Me.view_reports_label.Text = results_label_to_display

                    Call Build_Analytics_Charts(localCriteria, chart_htmlString, NOTE_ID, "Value History", Nothing, True, 0, 0, 0, is_graph_only)
                    Me.view_trends_label.Text = chart_htmlString

                    Session("LAST_RUN_OVERALL_TAB") = 0
                ElseIf TabContainer1.ActiveTabIndex = 1 Then


                    If IsPostBack And Session("LAST_RUN_OVERALL_TAB") = 1 Then
                        If Not IsNothing(Session("SELECTED_CURRENT_MARKET_EXPORT")) Then
                            temp_val = ac_projects_ddl.SelectedValue
                            If InStr(temp_val, "+") > 0 Then
                                temp_val = Right(temp_val, Len(temp_val) - InStr(temp_val, "+"))
                                temp_val = Replace(temp_val, "+", "")
                            End If

                            If Trim(Session("SELECTED_CURRENT_MARKET_EXPORT")) <> Trim(temp_val) Then
                                need_run = False
                            End If
                        End If
                    End If


                    If Trim(COMPLETED_OR_OPEN) <> "C" Then
                        If IsNothing(Session("Last_Amod")) Then
                            Session("Last_Amod") = 0
                        End If
                        If Not IsPostBack Or ac_projects_ddl.Visible = False Or (Session("Last_Amod") <> temp_amod_id) Then
                            ac_projects_ddl.Visible = True
                            Session("Last_Amod") = temp_amod_id

                            If IsNothing(Session("SELECTED_CURRENT_MARKET_EXPORT")) Then
                                Session("SELECTED_CURRENT_MARKET_EXPORT") = 0
                                Session("SELECTED_CURRENT_MARKET_EXPORT_INDEX") = 0
                            ElseIf CDbl(Session("SELECTED_CURRENT_MARKET_EXPORT")) <> 0 Then
                                rep_id = Session("SELECTED_CURRENT_MARKET_EXPORT")
                            End If

                            ac_projects_ddl.Items.Clear()
                            ac_projects_ddl.Items.Add(New System.Web.UI.WebControls.ListItem("Standard Market Survey", -1))
                            ac_projects_ddl.Items.Add(New System.Web.UI.WebControls.ListItem("Standard Market Survey with Operator/Phone#s", 11111))

                            If rep_id = -1 Or rep_id > 0 Then 'if you have chosen to use first one, then display it , and dont use default
                                Call aclsData_Temp.Fill_Open_Box(ac_projects_ddl, Session.Item("localUser").crmLocalUserID, 3, rep_id, temp_amod_id, "3", "", False)
                            Else
                                Call aclsData_Temp.Fill_Open_Box(ac_projects_ddl, Session.Item("localUser").crmLocalUserID, 3, rep_id, temp_amod_id, "3", "", True)
                            End If

                            If rep_id > -1 And rep_id < 11111 Then

                            ElseIf rep_id = 11111 Then
                                ac_projects_ddl.SelectedIndex = 1
                            Else
                                ac_projects_ddl.SelectedIndex = 0
                            End If

                            temp_val = ac_projects_ddl.SelectedValue
                            If InStr(temp_val, "+") > 0 Then
                                temp_val = Right(temp_val, Len(temp_val) - InStr(temp_val, "+"))
                                temp_val = Replace(temp_val, "+", "")
                            End If
                            Session("SELECTED_CURRENT_MARKET_EXPORT") = temp_val
                            Session("SELECTED_CURRENT_MARKET_EXPORT_INDEX") = ac_projects_ddl.SelectedIndex

                            ac_projects_ddl.Visible = True
                            projects_text.Visible = True

                        ElseIf IsPostBack And Session("LAST_COMPARE_TAB") = 1 Then ' if you are re-loading from same 

                            temp_val = ac_projects_ddl.SelectedValue
                            If InStr(temp_val, "+") > 0 Then
                                temp_val = Right(temp_val, Len(temp_val) - InStr(temp_val, "+"))
                                temp_val = Replace(temp_val, "+", "")
                            End If
                            Session("SELECTED_CURRENT_MARKET_EXPORT") = temp_val
                            Session("SELECTED_CURRENT_MARKET_EXPORT_INDEX") = ac_projects_ddl.SelectedIndex
                            rep_id = temp_val

                        ElseIf IsPostBack And Session("LAST_COMPARE_TAB") = 2 Then ' has to be coming from last tab 2 

                            If IsNothing(Session("SELECTED_CURRENT_MARKET_EXPORT")) Then
                                Session("SELECTED_CURRENT_MARKET_EXPORT") = 0
                                Session("SELECTED_CURRENT_MARKET_EXPORT_INDEX") = 0
                            ElseIf CDbl(Session("SELECTED_CURRENT_MARKET_EXPORT")) <> 0 Then
                                rep_id = Session("SELECTED_CURRENT_MARKET_EXPORT")
                                Session("SELECTED_CURRENT_MARKET_EXPORT") = rep_id

                                ' if its coming from tab 2 and index > 0 then have to take 1 from spot to make up for extra export 
                                If CDbl(Session("SELECTED_CURRENT_MARKET_EXPORT_INDEX")) > 0 Then
                                    ac_projects_ddl.SelectedIndex = Session("SELECTED_CURRENT_MARKET_EXPORT_INDEX") + 1
                                Else
                                    ac_projects_ddl.SelectedIndex = Session("SELECTED_CURRENT_MARKET_EXPORT_INDEX")
                                End If

                            End If


                        ElseIf rep_id = 0 Then
                            Call aclsData_Temp.Fill_Open_Box(Nothing, Session.Item("localUser").crmLocalUserID, 3, rep_id, temp_amod_id, "3", "", True)
                        End If

                        If need_run = True Then
                            Session("LAST_COMPARE_TAB") = 1
                            localDatalayer = New viewsDataLayer
                            localDatalayer.adminConnectStr = Application.Item("crmClientSiteData").AdminDatabaseConn
                            localDatalayer.clientConnectStr = Session.Item("localPreferences").UserDatabaseConn
                            localDatalayer.starConnectStr = Session.Item("localPreferences").STARDatabaseConn
                            localDatalayer.serverConnectStr = Session.Item("localPreferences").ServerNotesDatabaseConn


                            If IsPostBack And Trim(Request("graph")) = "Y" Then
                                ' dont need to re-run, it will re-post
                            ElseIf Trim(Request("graph")) = "Y" And Not IsNothing(Session("charting_string")) And Trim(Session("charting_string")) <> "" Then
                                ' if you change "my" then you probably have to put in thing to run 

                                Call Build_Analytics_Charts(localCriteria, "GRAPH_RE_RUN", NOTE_ID, "Market Survey", temp_table2, False, 0, 0, 0, is_graph_only)
                            Else
                                If rep_id = 11111 Then
                                    extra_crit = True
                                End If
                                Session("charting_string") = ""

                                ' call this first time if ClientIDSToExclude has not been built yet
                                If Trim(ClientIDSToExclude) = "" Then
                                    crmViewDataLayer.Combined_views_display_fleet_market_summary(localCriteria, Build_FleetMarketSummary_text, chart_htmlString, localDatalayer, ClientIDSToExclude, True, False, 0, 0, 0)
                                End If


                                crmViewDataLayer.Build_For_sale_tab(localCriteria, compare_view_current_label.Text, NOTE_ID, Session("ForSale_File_EXCEL"), View_ID, CRMViewActive, extra_crit, Session.Item("localUser").crmAllowExport_Flag, "", localDatalayer, LAST_SAVE_DATE, ClientIDSToExclude, Session.Item("CLIENT_AC_ID"), True, 0, "", True, rep_id, aclsData_Temp, active_tab, run_comparable_insert, fullSaleCurrentIDs.Text, RunModelOnValueOnly, Nothing, displayEValues)
                                cellExportToExcel.Visible = True
                                If CRMViewActive Then
                                    informationIconForsale.Text = "<div class=""viewSearchClassSale""><div class=""searchCriteria slideoutToolTip""><p title='Information' class='blue'><span class='label'>Client/Edited records are displayed with pink/red background</span></p></div></div>"
                                    If Page.IsPostBack Then
                                        If Not Page.ClientScript.IsClientScriptBlockRegistered("runTooltip") Then
                                            Dim strJs As String = "SetUpSlider();"
                                            System.Web.UI.ScriptManager.RegisterClientScriptBlock(Me.bottom_tab_update_panel, Me.GetType, "runTooltip", strJs, True)
                                        End If
                                    End If
                                End If

                                CheckAndJSForDatatable()
                                ' TabContainer1.ActiveTabIndex = 1
                                Call Build_Analytics_Charts(localCriteria, chart_htmlString, NOTE_ID, "Market Survey", temp_table2, False, 0, 0, 0, is_graph_only)
                            End If
                        End If

                    Else
                        Me.compare_view_current_label.Text = "Market Survey as of the date of analysis completion is available by clicking on the following <a href='#' onclick=""window.open('/tempfiles/" & NOTE_ID & "_COMPLETED_MARKET_SURVEY_PDF.pdf','viewAnalysis','scrollbars=yes,menubar=no,height=900,width=1030,resizable=yes,toolbar=no,location=no,status=no');return false;"">PDF</a>."
                    End If


                    Session("LAST_RUN_OVERALL_TAB") = 1
                    Me.run_comparable_insert.Visible = True

                ElseIf TabContainer1.ActiveTabIndex = 2 Then

                    '--------------------------------- DROP DOWN SECTION--------------------------------------------
                    If Not IsPostBack Or ac_projects_ddl2.Visible = False Then

                        If IsNothing(Session("SELECTED_CURRENT_MARKET_EXPORT")) Then
                            Session("SELECTED_CURRENT_MARKET_EXPORT") = 0
                            Session("SELECTED_CURRENT_MARKET_EXPORT_INDEX") = 0
                        ElseIf CDbl(Session("SELECTED_CURRENT_MARKET_EXPORT")) <> 0 Then
                            rep_id = Session("SELECTED_CURRENT_MARKET_EXPORT")
                        End If

                        ac_projects_ddl2.Items.Clear()
                        ac_projects_ddl2.Items.Add(New System.Web.UI.WebControls.ListItem("Standard Market Summary", -1))

                        If rep_id = -1 Or rep_id > 0 Then
                            Call aclsData_Temp.Fill_Open_Box(ac_projects_ddl2, Session.Item("localUser").crmLocalUserID, 3, rep_id, localCriteria.ViewCriteriaAmodID, "3", model_default_id, False)
                        Else
                            Call aclsData_Temp.Fill_Open_Box(ac_projects_ddl2, Session.Item("localUser").crmLocalUserID, 3, rep_id, localCriteria.ViewCriteriaAmodID, "3", model_default_id, True)
                        End If

                        If Trim(model_default_id) <> "" Then
                            ac_projects_ddl2.SelectedValue = model_default_id
                        End If


                        If rep_id > 0 And rep_id < 11111 Then

                        ElseIf rep_id = 11111 Then
                            ac_projects_ddl2.SelectedValue = 11111
                        Else
                            ac_projects_ddl2.SelectedValue = 0
                        End If
                        ac_projects_ddl2.Visible = True
                        projects_text.Visible = True



                        temp_val = ac_projects_ddl2.SelectedValue
                        If InStr(temp_val, "+") > 0 Then
                            temp_val = Right(temp_val, Len(temp_val) - InStr(temp_val, "+"))
                            temp_val = Replace(temp_val, "+", "")
                        End If
                        Session("SELECTED_CURRENT_MARKET_EXPORT") = temp_val
                        Session("SELECTED_CURRENT_MARKET_EXPORT_INDEX") = ac_projects_ddl2.SelectedIndex

                    ElseIf IsPostBack And Session("LAST_COMPARE_TAB") = 2 Then

                        temp_val = ac_projects_ddl2.SelectedValue
                        If InStr(temp_val, "+") > 0 Then
                            temp_val = Right(temp_val, Len(temp_val) - InStr(temp_val, "+"))
                            temp_val = Replace(temp_val, "+", "")
                        End If
                        Session("SELECTED_CURRENT_MARKET_EXPORT") = temp_val
                        Session("SELECTED_CURRENT_MARKET_EXPORT_INDEX") = ac_projects_ddl2.SelectedIndex
                        rep_id = temp_val


                    ElseIf IsPostBack And Session("LAST_COMPARE_TAB") = 1 Then ' means it has to be 1

                        If IsNothing(Session("SELECTED_CURRENT_MARKET_EXPORT")) Then
                            Session("SELECTED_CURRENT_MARKET_EXPORT") = 0
                        ElseIf CDbl(Session("SELECTED_CURRENT_MARKET_EXPORT")) <> 0 Then
                            rep_id = Session("SELECTED_CURRENT_MARKET_EXPORT")

                            If rep_id = 11111 Then ' there is no -1 so go to standard 
                                rep_id = -1
                            End If

                            Session("SELECTED_CURRENT_MARKET_EXPORT") = rep_id


                            ' if its coming from tab 1 and index > 0 then have to take 1 from spot to make up for extra export 
                            If CDbl(Session("SELECTED_CURRENT_MARKET_EXPORT_INDEX")) > 0 Then
                                ac_projects_ddl2.SelectedIndex = Session("SELECTED_CURRENT_MARKET_EXPORT_INDEX") - 1
                            Else
                                ac_projects_ddl2.SelectedIndex = Session("SELECTED_CURRENT_MARKET_EXPORT_INDEX")
                            End If
                        End If
                    End If
                    '--------------------------------- DROP DOWN SECTION--------------------------------------------
                    Session("LAST_COMPARE_TAB") = 2


                    Call localDatalayer.Build_Compare_View(localCriteria.ViewCriteriaAmodID, localCriteria.ViewCriteriaAircraftMake, localCriteria.ViewCriteriaAircraftModel, aclsData_Temp, rep_id, NOTE_ID, TabContainer1, tabs_container, localCriteria, Session.Item("CLIENT_AC_ID"), Me.model_reports_tab.HeaderText, compare_view_sold_label, compare_view_sold_label, Me.make_model_name_label.Text, Me.breadcrumbs.Text, Session.Item("CLIENT_AC_ID"), Me.model_reports_tab.HeaderText, Me.settings_right_label.Text, Me.LAST_SAVE_DATE, False, Me.Page.Title, Session("JETNET_AC_ID"), Me.edit_label_click.Text, Me.year_month_settings, Me.estimated_value, Me.years_of, Me.sales_within, Me.use_jetnet_data, Me.Page, Me.used_of_used, Me.year_of_current.Text, Me.aftt_of_current.Text, RunModelOnValueOnly)


                    Call Build_Analytics_Charts(localCriteria, chart_htmlString, NOTE_ID, "Current Market", Nothing, True, 0, 0, 0, is_graph_only)
                    'Me.view_reports_label.Text &= chart_htmlString


                    If Trim(COMPLETED_OR_OPEN) <> "C" Then
                        If Trim(Request("rep_id")) = "" Or Trim(Request("rep_id")) = "0" Then
                            ' Me.add_comparable_field.Visible = True
                            ' Me.add_comparable_field.Text = "<a href='view_template.aspx?ViewID=19&ViewName=Market Value Analysis&extra=false&noteID=" & NOTE_ID & "&activetab=8&type_of=add&sold_current=F' alt='+ Add New Field' title='+ Add New Field'>+ Add New Field</a>"
                        End If
                    End If

                    Session("LAST_RUN_OVERALL_TAB") = 2

                ElseIf TabContainer1.ActiveTabIndex = 3 Then


                    If Trim(COMPLETED_OR_OPEN) <> "C" Then
                        ' ADD IN NEW MARKET STATUS GRAPH
                        crmViewDataLayer.Combined_views_display_fleet_market_summary(localCriteria, Build_FleetMarketSummary_text, chart_htmlString, localDatalayer, ClientIDSToExclude, True, False, avg_asking, avg_take, avg_sold)
                        Me.view_events_label.Text = chart_htmlString

                        chart_htmlString = ""
                        Call Build_Analytics_Charts(localCriteria, chart_htmlString, NOTE_ID, "Market Status", temp_table, False, avg_asking, avg_take, avg_sold, is_graph_only)
                    Else
                        Me.view_events_label.Text = "Market Status as of the date of analysis completion is available by clicking on the following <a href='#' onclick=""window.open('/tempfiles/" & NOTE_ID & "_COMPLETED_MARKET_STATUS_PDF.pdf','viewAnalysis','scrollbars=yes,menubar=no,height=900,width=1030,resizable=yes,toolbar=no,location=no,status=no');return false;"">PDF.</a>"
                    End If



                    Session("LAST_RUN_OVERALL_TAB") = 3

                ElseIf TabContainer1.ActiveTabIndex = 4 Then


                    If crmViewDataLayer.Get_Market_Snapshot_Count(past_date, chart_htmlString, localCriteria.ViewCriteriaAmodID) = True Then

                        Call make_value_graphs(past_date, localCriteria.ViewCriteriaAmodID, chart_htmlString)
                        Me.hidden_market_value_source_label.Text = "<span class='help_cursor' title='Information on this tab includes data customized based on edits made within the Marketplace Manager.'><em>Source: Marketplace Manager</em></span>"
                        Me.hidden_market_value_source_label.Visible = True

                    Else
                        If Trim(COMPLETED_OR_OPEN) <> "C" Then
                            Build_Market_trends_tab(localCriteria, sHtmlMarketTrends, chart_htmlString, True, "")
                            Me.view_news_label1.Text = sHtmlMarketTrends
                        Else
                            Me.view_news_label1.Text = "Market Trends as of the date of analysis completion is available by clicking on the following PDF."
                        End If

                        Call Build_Analytics_Charts(localCriteria, chart_htmlString, NOTE_ID, "Market Trends", temp_table2, False, 0, 0, 0, is_graph_only)

                    End If

                    Session("LAST_RUN_OVERALL_TAB") = 4


                ElseIf TabContainer1.ActiveTabIndex = 5 Then


                    ' Me.view_wanteds_label.Text
                    Call run_full_recent_sales(results_label_to_display, temp_amod_id, rep_id, temp_table, is_graph_only, aclsData_Temp, NOTE_ID, chart_htmlString, active_tab)

                    Session("LAST_SOLD_TAB") = 5
                    Session("LAST_RUN_OVERALL_TAB") = 5

                ElseIf TabContainer1.ActiveTabIndex = 6 Then



                    'Me.view_wanteds_label.Text
                    If Not IsPostBack Or ac_projects_dd3.Visible = False Then

                        If IsNothing(Session("SELECTED_SOLD_EXPORT")) Then
                            Session("SELECTED_SOLD_EXPORT") = 0
                            Session("SELECTED_SOLD_EXPORT_INDEX") = 0
                        ElseIf CDbl(Session("SELECTED_SOLD_EXPORT")) <> 0 Then
                            rep_id = Session("SELECTED_SOLD_EXPORT")
                        End If

                        ac_projects_dd3.Items.Clear()
                        ac_projects_dd3.Items.Add(New System.Web.UI.WebControls.ListItem("Standard Sold Summary", -1))

                        Call aclsData_Temp.Fill_Open_Box(ac_projects_dd3, Session.Item("localUser").crmLocalUserID, 8, rep_id, localCriteria.ViewCriteriaAmodID, "8")

                        If rep_id > 0 And rep_id < 11111 Then

                        ElseIf rep_id = 11111 Then
                            ac_projects_dd3.SelectedIndex = 1
                        Else
                            ac_projects_dd3.SelectedIndex = 0
                        End If
                        ac_projects_dd3.Visible = True
                        projects_text3.Visible = True
                    ElseIf IsPostBack And Session("LAST_SOLD_TAB") = 6 Then ' if you are re-loading from same 

                        temp_val = ac_projects_dd3.SelectedValue
                        If InStr(temp_val, "+") > 0 Then
                            temp_val = Right(temp_val, Len(temp_val) - InStr(temp_val, "+"))
                            temp_val = Replace(temp_val, "+", "")
                        End If
                        Session("SELECTED_SOLD_EXPORT") = temp_val
                        Session("SELECTED_SOLD_EXPORT_INDEX") = ac_projects_dd3.SelectedIndex
                        rep_id = temp_val

                    ElseIf IsPostBack And Session("LAST_SOLD_TAB") = 5 Then ' has to be coming from last tab 5  

                        If IsNothing(Session("SELECTED_SOLD_EXPORT")) Then
                            Session("SELECTED_SOLD_EXPORT") = 0
                        ElseIf CDbl(Session("SELECTED_SOLD_EXPORT")) <> 0 Then
                            rep_id = Session("SELECTED_SOLD_EXPORT")
                            Session("SELECTED_SOLD_EXPORT") = rep_id

                            ac_projects_dd3.SelectedIndex = Session("SELECTED_SOLD_EXPORT_INDEX")
                        End If
                    End If

                    Session("LAST_SOLD_TAB") = 6
                    Session("LAST_RUN_OVERALL_TAB") = 6


                    Call localDatalayer.Build_Compare_View(localCriteria.ViewCriteriaAmodID, localCriteria.ViewCriteriaAircraftMake, localCriteria.ViewCriteriaAircraftModel, aclsData_Temp, rep_id, NOTE_ID, TabContainer1, Me.tabs_container, localCriteria, Session.Item("CLIENT_AC_ID"), Me.Page.Title, compare_view_current_label, view_documents_label1, Me.make_model_name_label.Text, Me.breadcrumbs.Text, Session.Item("CLIENT_AC_ID"), Me.model_reports_tab.HeaderText, Me.settings_text_label.Text, Me.LAST_SAVE_DATE, False, Me.Page.Title, Session("JETNET_AC_ID"), Me.edit_label_click.Text, Me.year_month_settings, Me.estimated_value, Me.years_of, Me.sales_within, Me.use_jetnet_data, Me.Page, Me.used_of_used, Me.year_of_current.Text, Me.aftt_of_current.Text, RunModelOnValueOnly)

                    Call Build_Analytics_Charts(localCriteria, chart_htmlString, NOTE_ID, "Sold Comparables", Nothing, True, 0, 0, 0, is_graph_only)

                ElseIf TabContainer1.ActiveTabIndex = 7 Then

                    localCriteria.ViewCriteriaTimeSpan = Me.year_month_settings.SelectedValue
                    localCriteria.ViewCriteriaSPIYearSld1 = "2005"

                    build_spi_tab(localCriteria, Me.view_operators_label.Text, chart_htmlString, "COMPARE_VIEW", is_graph_only)


                    '  google_variance = Me.hidden_spi_graph_text6.Text ' make sure it doesnt double-do the item
                    '  DisplayFunctions.load_google_chart(operators_tab, google_variance, "Average Days on Market", "Average Days on Market", "chart_div_dom_all", 480, 230, "POINTS", 5, charting_string, Me.Page, Me.bottom_tab_update_panel, False, True, False, False, True, True, False)

                    '  google_variance = Me.hidden_spi_graph_text7.Text ' make sure it doesnt double-do the item
                    '  DisplayFunctions.load_google_chart(operators_tab, google_variance, "Average Airframe Total Time", "Average Airframe Total Time", "chart_div_aftt_all", 480, 230, "POINTS", 5, charting_string, Me.Page, Me.bottom_tab_update_panel, False, True, False, False, True, True, False)


                    '  Me.hidden_spi_graph_text.Text = temp_graph ' make sure it doesnt double-do the item
                    ' Call Build_Analytics_Charts(localCriteria, temp_graph, NOTE_ID, "SPI", Nothing, False, 0, 0, 0, is_graph_only)
                    Me.google_sold_trends_graphs.Visible = True

                    Session("LAST_RUN_OVERALL_TAB") = 7


                ElseIf TabContainer1.ActiveTabIndex = 8 Then

                    ' Me.view_charter_label.Text 

                    If Trim(COMPLETED_OR_OPEN) <> "C" Then

                    End If

                    Build_Retail_sales_tab(localCriteria, Me.view_charter_label1, temp_table, Me.check_include_internals, Me.check_retail_sales, NOTE_ID)
                    crmViewDataLayer.Combined_views_display_fleet_market_summary(localCriteria, Build_FleetMarketSummary_text, chart_htmlString, localDatalayer, ClientIDSToExclude, True, False, avg_asking, avg_take, avg_sold)

                    Call Build_Analytics_Charts(localCriteria, chart_htmlString, NOTE_ID, "All", temp_table, False, avg_asking, avg_take, avg_sold, is_graph_only)
                    'Me.view_operators_label.Text = chart_htmlString
                    Me.view_charter_label1.Text = ""
                    Me.view_charter_label1.Visible = False

                    Session("LAST_RUN_OVERALL_TAB") = 8
                ElseIf TabContainer1.ActiveTabIndex = 10 Then



                    Dim extra_criteria As String = ""
                    Dim added_first As Boolean = False
                    Dim i As Integer = 0
                    Dim x As Integer = 9
                    Dim total_other_labels As Integer = 64
                    Dim labels_to_show As Integer = 0
                    Dim temp_date As String = ""
                    Dim last_date As String = ""
                    Dim date_changed As Boolean = False
                    Dim spot_to_start As Integer = 0
                    Dim serial_number_spot As Integer = 0
                    Dim temp_desc As String = ""
                    Dim temp_label As String = ""
                    Dim color As String = ""
                    Dim temp_num As Long = 0
                    Dim temp_label_new As String = ""
                    Dim temp_label_new_guts As String = ""
                    Dim ScriptBu As String = ""
                    Dim RemoveButton As Boolean = True
                    Dim RefreshTable As Boolean = True
                    Try

                        localDatalayer = New viewsDataLayer
                        localDatalayer.adminConnectStr = Application.Item("crmClientSiteData").AdminDatabaseConn
                        localDatalayer.clientConnectStr = Session.Item("localPreferences").UserDatabaseConn
                        localDatalayer.starConnectStr = Session.Item("localPreferences").STARDatabaseConn
                        localDatalayer.serverConnectStr = Session.Item("localPreferences").ServerNotesDatabaseConn

                        extra_criteria = ""
                        If year_month_settings.Text <> "" Then
                            '   past_date = (Year(DateAdd(DateInterval.Month, -year_month_settings.SelectedValue, Date.Now)) & "-" & Month(DateAdd(DateInterval.Month, -year_month_settings.SelectedValue, Date.Now)) & "-" & Day(DateAdd(DateInterval.Month, -year_month_settings.SelectedValue, Date.Now)))

                            extra_criteria &= " AND clival_entry_date >= '" & past_date & "' "
                        End If

                        If Not String.IsNullOrEmpty(valueEstimateCurrentID.Text) Then
                            extra_criteria &= " AND clival_id IN (" & clsGeneral.clsGeneral.StripChars(Trim(valueEstimateCurrentID.Text), False) & ") "
                        End If

                        ' If Trim(Me.years_of.Text) <> "" And Trim(Me.years_of.Text) <> "0" Then
                        ' extra_criteria &= " and (ac_mfr_year >= " & (CInt(Me.year_of_current.Text) - CInt(Me.years_of.Text)) & " and ac_mfr_year <= " & (CInt(Me.year_of_current.Text) + CInt(Me.years_of.Text)) & " ) "
                        ' extra_criteria &= " and (clitrans_year_mfr >= " & (years_current - years_of) & " and clitrans_year_mfr <= " & (years_current + years_of) & " ) "
                        ' End If

                        ' If Trim(Me.sales_within.Text) <> "" And Trim(Me.sales_within.Text) <> "0" Then
                        '  extra_criteria &= " and (ac_airframe_tot_hrs >= " & (CInt(Me.aftt_of_current.Text) - CInt(Me.sales_within.Text)) & " and ac_airframe_tot_hrs <= " & (CInt(Me.aftt_of_current.Text) + CInt(Me.sales_within.Text)) & " ) "
                        ' extra_criteria &= " and (clitrans_airframe_total_hours >= " & (aftt_current - aftt_within) & " and clitrans_airframe_total_hours <= " & (aftt_current + aftt_within) & " ) "
                        ' End If

                        results_table = localDatalayer.get_my_ac_value_history_comparables(0, "est_value", True, localCriteria.ViewCriteriaAircraftID, NOTE_ID, COMPLETED_OR_OPEN, False, localCriteria.ViewCriteriaAmodID, extra_criteria)


                        chart_htmlString = " data1.addColumn('string', 'Date'); "

                        chart_htmlString &= " data1.addColumn('number', 'Asking'); "
                        chart_htmlString &= " data1.addColumn('number', 'Take'); "
                        chart_htmlString &= " data1.addColumn('number', 'Est Value'); "
                        labels_to_show = 3

                        For i = 0 To total_other_labels
                            chart_htmlString &= " data1.addColumn('number', 'X_" & i & "_X'); "
                        Next

                        chart_htmlString &= " data1.addRows(["
                        'ac_details
                        chart_htmlString &= "["

                        If Not IsNothing(results_table) Then
                            If results_table.Rows.Count = 1 Then
                                RemoveButton = False
                                If String.IsNullOrEmpty(valueEstimateCurrentID.Text) Then
                                    RefreshTable = False
                                End If
                            End If
                            For Each r As DataRow In results_table.Rows
                                Dim dateSort As String = ""

                                If Not IsDBNull(r("date_of")) Then
                                    temp_date = FormatDateTime(r("date_of"), DateFormat.ShortDate)
                                    dateSort = Format(r("date_of"), "yyyy/MM/dd")

                                Else
                                    chart_htmlString = chart_htmlString ' error , no date
                                End If

                                If (Trim(temp_date) <> Trim(last_date)) And Trim(last_date) <> "" Then
                                    date_changed = True
                                Else
                                    date_changed = False
                                End If

                                If added_first = False Then
                                    chart_htmlString &= "'" & temp_date & "'"

                                    For x = 1 To labels_to_show
                                        chart_htmlString &= ", null"
                                    Next

                                    added_first = True
                                End If


                                If date_changed = True Then
                                    date_changed = False

                                    Call end_with_nulls(spot_to_start, total_other_labels, chart_htmlString)
                                    ' spot_to_start = 0 ' commented out, should start last spot

                                    ' If added_first = True Then
                                    chart_htmlString &= ",["
                                    'Else
                                    '  chart_htmlString &= "["
                                    '  added_first = True
                                    'End If

                                    chart_htmlString &= "'" & temp_date & "'"

                                    For x = 1 To labels_to_show
                                        chart_htmlString &= ", null"
                                    Next

                                    For x = 1 To spot_to_start
                                        chart_htmlString &= ", null"
                                    Next

                                End If

                                '' go thro, fill in from 0 to whereever we will start 0, 3
                                '' 0 - so wont go in 
                                '' 3, so will go 0,1,2 
                                'For x = 0 To spot_to_start - 1
                                '  chart_htmlString &= "," & (i + 100 + x) & ""
                                'Next

                                ' fill in current point
                                ' 0 so will display 0,1,2
                                ' 3, so will display 3,4,5



                                If Not IsDBNull(r("description")) Then
                                    temp_desc = Trim(r("description"))

                                    If Trim(temp_desc) = "F" Then
                                        temp_desc = "Full Appraisal"
                                    ElseIf Trim(temp_desc) = "D" Then
                                        temp_desc = "Desktop Appraisal"
                                    ElseIf Trim(temp_desc) = "V" Then
                                        temp_desc = "VREF"
                                    ElseIf Trim(temp_desc) = "B" Then
                                        temp_desc = "Blue Book"
                                    ElseIf Trim(temp_desc) = "H" Then
                                        temp_desc = "HeliValue$"
                                    End If



                                    If color = "alt_row" Then
                                        color = ""
                                    Else
                                        color = "alt_row"
                                    End If



                                    temp_label_new_guts &= "<td align='left'><font size='-2' style='font-family: Arial'>" & temp_date & "</font></td>"
                                    temp_label_new_guts &= "<td align='left'><font size='-2' style='font-family: Arial'>" & temp_desc & "</font></td>"
                                    temp_label_new_guts &= "</tr>"


                                    temp_label &= "<tr class='" & color & "'>"
                                    temp_label &= "<td align='left'>&nbsp;</td>"
                                    temp_label &= "<td align='left'>" & r("clival_id") & "</td>"
                                    temp_label &= "<td align='left'><font size='-2' style='font-family: Arial'  data-sort='" & dateSort & "'>" & temp_date & "</font></td>"
                                    temp_label &= "<td align='left'><font size='-2' style='font-family: Arial'>" & temp_desc & "</font></td>"

                                    If Not IsDBNull(r("ac_id")) Then
                                        Dim TemporaryAircraftTable As New DataTable
                                        temp_desc = temp_desc & " - " & get_ac_details_from_jetnet_for_graph(r("ac_id"))

                                        TemporaryAircraftTable = aclsData_Temp.GetJETNET_AC_NAME(r("ac_id"), "")

                                        If Not IsNothing(TemporaryAircraftTable) Then
                                            If TemporaryAircraftTable.Rows.Count > 0 Then
                                                'Make
                                                temp_label &= "<td align='left'>"
                                                If Not IsDBNull(TemporaryAircraftTable.Rows(0).Item("amod_make_name")) Then
                                                    temp_label &= TemporaryAircraftTable.Rows(0).Item("amod_make_name").ToString
                                                End If
                                                'temp_label &= "</td>"
                                                'Model
                                                'temp_label &= "<td align='left'>"
                                                If Not IsDBNull(TemporaryAircraftTable.Rows(0).Item("amod_model_name")) Then
                                                    temp_label &= TemporaryAircraftTable.Rows(0).Item("amod_model_name").ToString
                                                End If
                                                temp_label &= "</td>"
                                                'Ser
                                                temp_label &= "<td align='left'>"
                                                If Not IsDBNull(TemporaryAircraftTable.Rows(0).Item("ac_ser_nbr")) Then
                                                    temp_label &= TemporaryAircraftTable.Rows(0).Item("ac_ser_nbr").ToString
                                                End If
                                                temp_label &= "</td>"
                                                'Reg
                                                temp_label &= "<td align='left'>"
                                                If Not IsDBNull(TemporaryAircraftTable.Rows(0).Item("ac_reg_nbr")) Then
                                                    temp_label &= TemporaryAircraftTable.Rows(0).Item("ac_reg_nbr").ToString
                                                End If
                                                temp_label &= "</td>"
                                                'Year
                                                temp_label &= "<td align='left'>"
                                                If Not IsDBNull(TemporaryAircraftTable.Rows(0).Item("ac_year_mfr")) Then
                                                    temp_label &= TemporaryAircraftTable.Rows(0).Item("ac_year_mfr").ToString
                                                End If
                                                temp_label &= "</td>"
                                            End If
                                        End If
                                        TemporaryAircraftTable.Dispose()
                                        'temp_label &= "<td align='left'><font size='-2' style='font-family: Arial'>" & get_ac_details_from_jetnet_for_graph(r("ac_id")) & "</font></td>"
                                    Else
                                        temp_label &= "<td align='left'><font size='-2' style='font-family: Arial'>&nbsp;</font></td>"
                                    End If


                                    chart_htmlString = Replace(Trim(chart_htmlString), "X_" & serial_number_spot & "_X", "Asking($k): " & temp_desc)
                                    serial_number_spot = serial_number_spot + 1
                                    chart_htmlString = Replace(Trim(chart_htmlString), "X_" & serial_number_spot & "_X", "Take($k): " & temp_desc)
                                    serial_number_spot = serial_number_spot + 1
                                    chart_htmlString = Replace(Trim(chart_htmlString), "X_" & serial_number_spot & "_X", "Est/Value($k): " & temp_desc)
                                    serial_number_spot = serial_number_spot + 1
                                Else
                                    chart_htmlString = Replace(Trim(chart_htmlString), "X_" & serial_number_spot & "_X", "Asking($k): ")
                                    serial_number_spot = serial_number_spot + 1
                                    chart_htmlString = Replace(Trim(chart_htmlString), "X_" & serial_number_spot & "_X", "Take($k): ")
                                    serial_number_spot = serial_number_spot + 1
                                    chart_htmlString = Replace(Trim(chart_htmlString), "X_" & serial_number_spot & "_X", "Est/Value($k): ")
                                    serial_number_spot = serial_number_spot + 1
                                End If





                                If Not IsDBNull(r("asking_price")) Then
                                    If CInt(r("asking_price")) > 0 Then
                                        temp_num = r("asking_price")
                                        temp_num = (temp_num / 1000)
                                        chart_htmlString &= "," & temp_num & ""
                                        temp_label &= "<td align='right'><font size='-2' style='font-family: Arial'>$" & FormatNumber(temp_num, 0) & "k</font></td>"
                                    Else
                                        chart_htmlString &= ",null"
                                        temp_label &= "<td align='left'>&nbsp;</td>"
                                    End If
                                Else
                                    chart_htmlString &= ",null"
                                    temp_label &= "<td align='left'>&nbsp;</td>"
                                End If


                                If Not IsDBNull(r("take_price")) Then
                                    If CInt(r("take_price")) > 0 Then
                                        temp_num = r("take_price")
                                        temp_num = (temp_num / 1000)
                                        chart_htmlString &= "," & temp_num & ""
                                        temp_label &= "<td align='right'><font size='-2' style='font-family: Arial'>$" & FormatNumber(temp_num, 0) & "k</font></td>"
                                    Else
                                        chart_htmlString &= ",null"
                                        temp_label &= "<td align='left'>&nbsp;</td>"
                                    End If
                                Else
                                    chart_htmlString &= ",null"
                                    temp_label &= "<td align='left'>&nbsp;</td>"
                                End If


                                If Not IsDBNull(r("sold_price")) Then
                                    If CInt(r("sold_price")) > 0 Then
                                        temp_num = r("sold_price")
                                        temp_num = (temp_num / 1000)
                                        chart_htmlString &= "," & temp_num & ""
                                        temp_label &= "<td align='right'><font size='-2' style='font-family: Arial'>$" & FormatNumber(temp_num, 0) & "k</font></td>"
                                    Else
                                        chart_htmlString &= ",null"
                                        temp_label &= "<td align='left'>&nbsp;</td>"
                                    End If
                                Else
                                    chart_htmlString &= ",null"
                                    temp_label &= "<td align='left'>&nbsp;</td>"
                                End If

                                If Not IsDBNull(r("clival_aftt_hours")) Then
                                    If r("clival_aftt_hours") > 0 Then
                                        temp_label &= "<td align='right'><font size='-2' style='font-family: Arial'>" & FormatNumber(r("clival_aftt_hours"), 0) & "</font></td>"
                                    Else
                                        temp_label &= "<td align='left'>&nbsp;</td>"
                                    End If
                                Else
                                    temp_label &= "<td align='left'>&nbsp;</td>"
                                End If

                                If Not IsDBNull(r("clival_total_landings")) Then
                                    If r("clival_total_landings") > 0 Then
                                        temp_label &= "<td align='right'><font size='-2' style='font-family: Arial'>" & FormatNumber(r("clival_total_landings"), 0) & "</font></td>"
                                    Else
                                        temp_label &= "<td align='left'>&nbsp;</td>"
                                    End If
                                Else
                                    temp_label &= "<td align='left'>&nbsp;</td>"
                                End If


                                temp_label &= "</tr>"


                                spot_to_start = spot_to_start + 3


                                last_date = Trim(temp_date)

                            Next

                        End If


                        Me.view_spi_label.Text = "<span id=""ValueEstimateNewContents""><table id=""ValueEstimateCopy"" cellspacing='0' cellpadding='3' border='1' class='engine' width=""100%"">"
                        Me.view_spi_label.Text &= "<thead><tr>"
                        Me.view_spi_label.Text &= "<th>SEL</th>"
                        Me.view_spi_label.Text &= "<th>ID</th>"
                        Me.view_spi_label.Text &= "<th><font size='-2' style='font-family: Arial'><b>Date</b></font></th><th><font size='-2' style='font-family: Arial'><b>Type</b></font></th>"
                        Me.view_spi_label.Text &= "<th><font size='-2' style='font-family: Arial'><b>Make/Model</b></font></th>"
                        Me.view_spi_label.Text &= "<th><font size='-2' style='font-family: Arial'><b>Ser #</b></font></th>"
                        Me.view_spi_label.Text &= "<th><font size='-2' style='font-family: Arial'><b>Reg #</b></font></th>"
                        Me.view_spi_label.Text &= "<th><font size='-2' style='font-family: Arial'><b>Year MFR</b></font></th>"

                        Me.view_spi_label.Text &= "<th><font size='-2' style='font-family: Arial'><b>Asking($k)</b></font></th><th><font size='-2' style='font-family: Arial'><b>Take($k)</b></font></th><th><font size='-2' style='font-family: Arial'><b>Est Value($k)</b></font></th>"
                        Me.view_spi_label.Text &= "<th><font size='-2' style='font-family: Arial'><b>AFTT</b></font></th><th><font size='-2' style='font-family: Arial'><b>Total Landings</b></font></th>"
                        Me.view_spi_label.Text &= "</thead></tr>"
                        Me.view_spi_label.Text &= "<tbody"
                        Me.view_spi_label.Text &= temp_label
                        Me.view_spi_label.Text &= "</tbody>"
                        Me.view_spi_label.Text &= "</table>"
                        Me.view_spi_label.Text &= "</span><div id=""ValueEstimateInnerTable"" style=""width: 960px;""></div>"

                        Call end_with_nulls(spot_to_start, total_other_labels, chart_htmlString)




                        'temp_label_new = ("<table id='modelForsaleViewOuterTable' valign=""top"" width=""100%"" cellpadding=""0"" cellspacing=""0"" class=""module"">")
                        'temp_label_new &= ("<tr valign=""top""><td align=""left"" valign=""top"">")

                        'temp_label_new &= ("<table id='tableCopy' cellpadding='0' cellspacing='0' border='0'><thead>")

                        'temp_label_new &= ("<th class=""text_align_left"" nowrap='nowrap'>RANK</th>") 
                        'temp_label_new &= ("<th class=""text_align_left"" nowrap='nowrap'>RANK2</th>")
                        'temp_label_new &= ("</thead><tbody>")

                        'temp_label_new &= temp_label_new_guts


                        'temp_label_new &= ("</tbody></table>")
                        'temp_label_new &= ("<div id=""forSaleInnerTable"" style=""width: 490px;""></div>")
                        'temp_label_new &= ("</td></tr>")
                        'temp_label_new &= ("</table>")

                        'Call CheckAndJSForDatatable()

                        '  Me.view_spi_label.Text = temp_label_new

                        DisplayFunctions.load_google_chart_dynamic(spi_tab, chart_htmlString, "", "Value Estimates($k)", "chart_div_survey", 500, 250, "POINTS", 1, charting_string, Me.Page, Me.bottom_tab_update_panel, False, False, labels_to_show, total_other_labels, True)
                        ValueEstimateJSCheck(RemoveButton, RefreshTable)
                        Me.view_spi_label.Visible = True


                        Session("LAST_RUN_OVERALL_TAB") = 10



                    Catch ex As Exception

                    End Try


                ElseIf TabContainer1.ActiveTabIndex = 9 Then
                    Me.lease_tab.Visible = True

                    Session("LAST_RUN_OVERALL_TAB") = 9

                    If Trim(Request("compare_ac_id")) <> "" Then
                        ' ------ THEN WE ARE ADDING OR REMOVING A COMPARABLE----------------
                        Me.lease_tab.HeaderText = "Edit Comparables"


                        If Trim(Request("ac_type")) = "JETNET" Or Trim(Request("compare_ac_id")) = "0" Then

                            If Trim(Request("compare_ac_id")) = "0" Then

                                If Trim(Request("ac_type")) = "JETNET" Then
                                    Me.view_lease_label.Text &= "<table><Tr><td>"
                                    Me.view_lease_label.Text &= get_ac_details_from_jetnet(Trim(Request("jac_id")), Trim(Request("sold_current")))
                                    Me.view_lease_label.Text &= "</td></tr><tr><td align='left'>"
                                Else
                                    Me.view_lease_label.Text &= "<table><Tr><td>"
                                    Me.view_lease_label.Text &= get_ac_details_for_valuation(0, Trim(Request("sold_current")), Trim(Request("jac_id")))
                                    Me.view_lease_label.Text &= "</td></tr><tr><td align='left'>"
                                End If

                            Else
                                Me.view_lease_label.Text &= "<table><Tr><td>"
                                Me.view_lease_label.Text &= get_ac_details_from_jetnet(Trim(Request("compare_ac_id")), Trim(Request("sold_current")))
                                Me.view_lease_label.Text &= "</td></tr><tr><td align='left'>"
                            End If


                            If Trim(Request("sold_current")) = "F" Then
                                Me.view_lease_label.Text &= "<Br><br>Do you wish to " & Trim(Request("type_of")) & " the JETNET aircraft shown to the left as a current market comparable for this market value analysis?"
                            ElseIf Trim(Request("sold_current")) = "S" Then
                                Me.view_lease_label.Text &= "<Br><br>Do you wish to " & Trim(Request("type_of")) & " the sold record shown to the left as a sold comparables for this market value analysis?"
                            End If
                        Else
                            Me.view_lease_label.Text &= "<table><Tr><td>"
                            Me.view_lease_label.Text &= get_ac_details_for_valuation(Trim(Request("compare_ac_id")), Trim(Request("sold_current")), 0)
                            Me.view_lease_label.Text &= "</td></tr><tr><td align='left'>"

                            If Trim(Request("sold_current")) = "F" Then
                                Me.view_lease_label.Text &= "<Br><br>Do you wish to " & Trim(Request("type_of")) & " the client aircraft shown to the left as a current market comparable for this market value analysis?"
                            ElseIf Trim(Request("sold_current")) = "S" Then
                                Me.view_lease_label.Text &= "<Br><br>Do you wish to " & Trim(Request("type_of")) & " the sold record shown to the left as a sold comparables for this market value analysis?"
                            End If
                        End If



                        temp_label_string = " As part of "

                        If Trim(Request("type_of")) = "add" Then
                            If Trim(Request("sold_current")) = "F" Then
                                Me.change_comparable.Text = "Add Current Market Comparable"
                                temp_label_string &= "current market "
                            ElseIf Trim(Request("sold_current")) = "S" Then
                                Me.change_comparable.Text = "Add Sold Comparable"
                                temp_label_string &= "sold "
                            End If
                        Else
                            If Trim(Request("sold_current")) = "F" Then
                                Me.change_comparable.Text = "Delete Current Market Comparable"
                                temp_label_string &= "current market "
                            ElseIf Trim(Request("sold_current")) = "S" Then
                                Me.change_comparable.Text = "Delete Sold Comparable"
                                temp_label_string &= "sold "
                            End If
                        End If
                        temp_label_string &= " the Marketplace Manager allows you to customize the list of records that you wish to compare."
                        temp_label_string &= " Use the tab below to"

                        If Trim(Request("type_of")) = "add" Then
                            If Trim(Request("sold_current")) = "F" Then
                                temp_label_string &= " add a current market"
                            Else
                                temp_label_string &= " add a sold"
                            End If
                        Else
                            If Trim(Request("sold_current")) = "F" Then
                                temp_label_string &= " remove a current market"
                            Else
                                temp_label_string &= " remove a sold"
                            End If
                        End If

                        temp_label_string &= " comparable from your selected market value analysis.  "



                        Me.model_reports_tab.HeaderText = Me.change_comparable.Text
                        Me.view_reports_label.Text = temp_label_string

                        Me.cancel_comparable.Text = "Cancel"
                        Me.view_lease_label.Text &= "</td></tr></table>"

                        Me.change_comparable.Visible = True
                        Me.cancel_comparable.Visible = True

                        ' ------ THEN WE ARE ADDING OR REMOVING A COMPARABLE---------------- 
                    Else



                        ' ------ THEN WE ARE ADDING OR REMOVING A FIELD----------------
                        If Not IsPostBack Then  ' added msw - 9-15-14 .. if it postsback then it actually re-gets box and selects the first one 


                            If Trim(Request("field_name")) <> "" Then
                                field_name_temp = Trim(Request("field_name"))
                            Else
                                field_name_temp = ""
                            End If

                            If Trim(Request("type_of")) = "add" Then
                                Call check_custom_fields()
                            End If

                            Me.lease_tab.HeaderText = "Edit Comparable Fields"

                            If Trim(field_name_temp) <> "" Then
                                Call get_fields_for_add_comparable(NOTE_ID, Me.add_compare_field_list, field_name_temp)
                            Else
                                Call get_fields_for_add_comparable(NOTE_ID, Me.add_compare_field_list, "")
                            End If

                            Me.change_comparable.Visible = True
                            Me.cancel_comparable.Visible = True

                            temp_label_string = " As part of current market or sold comparables, the Marketplace Manager allows you to customize the field list that you compare. Use the tab below to "

                            If Trim(Request("type_of")) = "add" Then
                                Me.change_comparable.Text = "Add Comparable Field"
                                Me.add_compare_field_list.Height = 150
                                temp_label_string &= "add "
                            Else
                                Me.change_comparable.Text = "Delete '" & Trim(field_name_temp) & "' as Comparable Field"
                                Me.add_compare_field_list.Height = 18
                                temp_label_string &= "remove "
                            End If

                            temp_label_string &= "a comparable field from your selected market value analysis.  "

                            Me.model_reports_tab.HeaderText = Me.change_comparable.Text
                            Me.view_reports_label.Text = temp_label_string
                        End If


                        ' ------ THEN WE ARE ADDING OR REMOVING A FIELD----------------
                    End If


                End If
                top_tab_update_panel.Update()
                bottom_tab_update_panel.Update()
            End If


            If TabContainer1.ActiveTabIndex <> 8 And TabContainer1.ActiveTabIndex <> 6 And TabContainer1.ActiveTabIndex <> 10 Then
                Me.view_reports_label.Text &= "&nbsp;[<a href='#' onclick=""window.open('/View_Template.aspx?ViewID=19&ViewName=" + HttpContext.Current.Server.UrlEncode(localCriteria.ViewName) + "&noteID=" & NOTE_ID & "&activetab=" & TabContainer1.ActiveTabIndex & IIf(RunModelOnValueOnly, "&amod_ID=" & localCriteria.ViewCriteriaAmodID.ToString & "", "") & "&graph=Y','viewAnalysis','scrollbars=yes,menubar=no,height=900,width=1030,resizable=yes,toolbar=no,location=no,status=no');return false;"">View Full Size Graph</a>]"
            End If

            If Len(Me.label_behind_pic.Text) < 90 Then
                Me.label_behind_pic.Text &= "<table cellspacing='0' cellpadding='0' border='0' width=""375px""><tr><td>&nbsp;</td></tr></table>"
            End If


        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [run_active_tab_changed] : " + ex.Message
        Finally
            temp_table.Clear()
            temp_table.Dispose()
            temp_table = Nothing
        End Try
    End Sub

    Public Sub end_with_nulls(ByVal spot_to_start As Integer, ByVal total_other_labels As Integer, ByRef chart_htmlString As String)
        Dim x As Integer = 0
        'start and go thro to fill in the rest
        '3 so go 3,4,5 ++
        '6 so to 6'7'8 ++
        For x = spot_to_start To total_other_labels
            'chart_htmlString &= "," & (i + 100 + x) & ""
            chart_htmlString &= ",null"


            '0 will be asking
            '1 will be take
            '2 will be est value 

        Next

        chart_htmlString &= "]"

    End Sub

    Public Sub make_value_graphs(ByVal past_date As String, ByVal temp_model As String, ByVal chart_html_string As String)
        Dim results_table As New DataTable
        Dim temp_string_value As String = ""
        Dim charting_string As String = ""
        Dim temp_data As String = ""
        Dim temp_header As String = ""
        Dim asking_count As Integer = 0
        Dim asking_total As Double = 0
        Dim take_total As Double = 0
        Dim take_count As Integer = 0
        Dim sold_total As Double = 0
        Dim sold_count As Integer = 0
        Dim last_header As String = ""
        Dim row_Added As Boolean = False
        Dim temp_count As Integer = 0
        Dim i As Integer = 0
        Dim temp_ask As Double = 0
        Dim temp_take As Double = 0
        Dim temp_sold As Double = 0
        Dim row_string As String = ""
        Dim distinct_ser_num_list(100) As String
        Dim ser_num_row_string(100) As String
        Dim date_string(100) As String
        Dim date_count As Integer = 0
        Dim d As Integer = 0
        Dim date_value_array(100) As Double
        Dim avg_asking As Double = 0

        Me.hidden_market_survey1.Text = ""
        Me.hidden_market_survey2.Text = ""
        Me.hidden_market_survey3.Text = ""

        results_table = crmViewDataLayer.Get_Market_Snapshot_Datatable(past_date, temp_model)

        Me.hidden_market_survey1.Text = " data1.addColumn('string', 'Date'); "
        Me.hidden_market_survey1.Text &= " data1.addColumn('number', 'Avg Asking Price ($k)'); "
        Me.hidden_market_survey1.Text &= " data1.addRows(["

        Me.hidden_market_survey2.Text = " data2.addColumn('string', 'Date'); "
        Me.hidden_market_survey2.Text &= " data2.addColumn('number', 'Avg Take Price ($k)'); "
        Me.hidden_market_survey2.Text &= " data2.addRows(["


        Me.hidden_market_survey3.Text = " data3.addColumn('string', 'Date'); "
        Me.hidden_market_survey3.Text &= " data3.addColumn('number', 'Avg Sold Price ($k)'); "
        Me.hidden_market_survey3.Text &= " data3.addRows(["


        For Each r As DataRow In results_table.Rows
            row_Added = False
            If Not IsDBNull(r("clival_ser_nbr")) Then

                If temp_count > 0 Then
                    For i = 0 To temp_count - 1
                        If Trim(distinct_ser_num_list(i)) = Trim(r("clival_ser_nbr")) Then
                            row_Added = True
                            i = temp_count
                        End If
                    Next
                End If

                ' then there is no match, or its the first one
                If row_Added = False Then
                    distinct_ser_num_list(temp_count) = Trim(r("clival_ser_nbr"))
                    temp_count = temp_count + 1
                End If

            End If
        Next



        row_Added = False
        For Each r As DataRow In results_table.Rows

            temp_header = ""
            temp_data = ""
            temp_ask = 0
            temp_take = 0
            temp_sold = 0

            If Not IsDBNull(r("tdate")) Then
                temp_header = r("tdate")
            End If

            ' then its changed dates
            If Trim(temp_header) <> Trim(last_header) And Trim(last_header) <> "" Then

                date_string(date_count) = last_header
                date_count = date_count + 1

                avg_asking = Replace(FormatNumber(CDbl((asking_total / asking_count) / 1000), 0), ",", "")

                If row_Added = False Then
                    Me.hidden_market_survey1.Text &= "['" & last_header & "', " & avg_asking & "]"
                    Me.hidden_market_survey2.Text &= "['" & last_header & "', " & Replace(FormatNumber(CDbl((take_total / take_count) / 1000), 0), ",", "") & "]"
                    Me.hidden_market_survey3.Text &= "['" & last_header & "', " & Replace(FormatNumber(CDbl((sold_total / sold_count) / 1000), 0), ",", "") & "]"
                Else
                    Me.hidden_market_survey1.Text &= ",['" & last_header & "', " & avg_asking & "]"
                    Me.hidden_market_survey2.Text &= ",['" & last_header & "', " & Replace(FormatNumber(CDbl((take_total / take_count) / 1000), 0), ",", "") & "]"
                    Me.hidden_market_survey3.Text &= ",['" & last_header & "', " & Replace(FormatNumber(CDbl((sold_total / sold_count) / 1000), 0), ",", "") & "]"
                End If


                take_total = 0
                take_count = 0
                sold_count = 0
                sold_total = 0
                asking_count = 0
                asking_total = 0
                row_Added = True
            End If

            If Not IsDBNull(r("clival_asking_price")) Then
                If CDbl(r("clival_asking_price")) > 0 Then
                    asking_total = asking_total + CDbl(r("clival_asking_price"))
                    asking_count = asking_count + 1
                    temp_ask = CDbl(r("clival_asking_price"))
                End If
            End If

            If Not IsDBNull(r("clival_est_price")) Then
                If CDbl(r("clival_est_price")) > 0 Then
                    take_total = take_total + CDbl(r("clival_est_price"))
                    take_count = take_count + 1
                    temp_take = CDbl(r("clival_est_price"))
                End If
            End If


            If Not IsDBNull(r("clival_broker_price")) Then
                If CDbl(r("clival_broker_price")) > 0 Then
                    sold_total = sold_total + CDbl(r("clival_broker_price"))
                    sold_count = sold_count + 1
                    temp_sold = CDbl(r("clival_broker_price"))
                End If
            End If

            last_header = Trim(temp_header)
        Next

        If Trim(last_header) <> "" Then

            date_string(date_count) = last_header
            date_count = date_count + 1

            avg_asking = Replace(FormatNumber(CDbl((asking_total / asking_count) / 1000), 0), ",", "")

            If row_Added = False Then
                Me.hidden_market_survey1.Text &= "['" & last_header & "', " & avg_asking & "]"
                Me.hidden_market_survey2.Text &= "['" & last_header & "', " & Replace(FormatNumber(CDbl((take_total / take_count) / 1000), 0), ",", "") & "]"
                Me.hidden_market_survey3.Text &= "['" & last_header & "', " & Replace(FormatNumber(CDbl((sold_total / sold_count) / 1000), 0), ",", "") & "]"
            Else
                Me.hidden_market_survey1.Text &= ",['" & last_header & "', " & avg_asking & "]"
                Me.hidden_market_survey2.Text &= ",['" & last_header & "', " & Replace(FormatNumber(CDbl((take_total / take_count) / 1000), 0), ",", "") & "]"
                Me.hidden_market_survey3.Text &= ",['" & last_header & "', " & Replace(FormatNumber(CDbl((sold_total / sold_count) / 1000), 0), ",", "") & "]"
            End If
        End If


        row_string = row_string & "<table cellspacing='0' cellpadding='5' border='1' align='center' width='70%'>"

        row_string = row_string & "<tr><td colspan='50' align='center'>"
        row_string = row_string & "<b>Asking Price Summary</b>"
        row_string = row_string & "</td></tr>"

        row_string = row_string & "<tr><td><b>Serial #</b></td>"

        For d = 0 To date_count - 1
            row_string = row_string & "<td align='right'><b>"
            row_string = row_string & date_string(d)
            row_string = row_string & "</b>&nbsp;</td>"
        Next

        row_string = row_string & "</tr>"

        For i = 0 To temp_count - 1
            row_Added = False

            For d = 0 To 100
                date_value_array(d) = 0
            Next

            For Each r As DataRow In results_table.Rows '--------------------- DATA ROWS ------------

                ' if serial number matches this line
                If Not IsDBNull(r("clival_ser_nbr")) Then
                    If Trim(distinct_ser_num_list(i)) = Trim(r("clival_ser_nbr")) Then

                        ' and date matches any line 
                        If Not IsDBNull(r("tdate")) Then

                            For d = 0 To date_count - 1
                                If Trim(r("tdate")) = date_string(d) Then
                                    ' if there is an asking price

                                    date_value_array(d) = 1 ' set it to one to know a record exists

                                    If Not IsDBNull(r("clival_asking_price")) Then
                                        If CDbl(r("clival_asking_price")) > 0 Then
                                            date_value_array(d) = r("clival_asking_price")
                                        End If
                                    End If

                                End If
                            Next


                        End If
                    End If
                End If
            Next          '--------------------- DATA ROWS ------------

            row_string = row_string & "<tr><td align='left'>" & distinct_ser_num_list(i) & "</td>"


            For d = 0 To date_count - 1

                If CDbl(date_value_array(d)) = 0 Then
                    row_string = row_string & "<td align='right' bgcolor='#d9d9d9'>"
                ElseIf CDbl(date_value_array(d)) = 1 Then
                    row_string = row_string & "<td align='right' bgcolor='#8ee388'>"
                Else
                    row_string = row_string & "<td align='right' bgcolor='#8ee388'>"
                    row_string = row_string & FormatNumber(date_value_array(d), 0)
                End If

                row_string = row_string & "</td>"


            Next

            row_string = row_string & "</tr>"

        Next

        row_string = row_string & "</table>"


        Me.view_snapshot_label.Text = row_string
        HttpContext.Current.Session.Item("ASKING_PRICE_SUMMARY_BLOCK") = row_string
        row_string = ""

        ' put this one on top--------------------------------------------------------------------------
        temp_string_value = Me.hidden_market_survey1.Text ' make sure it doesnt double-do the item  
        DisplayFunctions.load_google_chart(news_tab, temp_string_value, "Market Snapshot - Avg Asking Price", "Avg Asking Price ($k)", "chart_div_survey", 500, 250, "POINTS", 1, charting_string, Me.Page, Me.bottom_tab_update_panel, False, True, True, False, False, False, False)
        ' put this one on top--------------------------------------------------------------------------


        temp_string_value = chart_html_string
        DisplayFunctions.load_google_chart(news_tab, temp_string_value, "Aircraft For Sale By Date", "Number For Sale", "value_panel1_all", 480, 230, "POINTS", 1, charting_string, Me.Page, Me.bottom_tab_update_panel, False, True, True, False, False, True, False)

        temp_string_value = Me.hidden_market_survey2.Text ' make sure it doesnt double-do the item  
        DisplayFunctions.load_google_chart(news_tab, temp_string_value, "Avg Take Price By Date", "Avg Take Price ($k)", "value_panel2_all", 480, 230, "POINTS", 2, charting_string, Me.Page, Me.bottom_tab_update_panel, False, True, True, False, False, True, False)

        ' temp_string_value = Me.hidden_market_survey3.Text ' make sure it doesnt double-do the item  
        ' DisplayFunctions.load_google_chart(news_tab, temp_string_value, "Market Snapshot - Avg Sold Price", "Avg Sold Price ($k)", "value_panel3_all", 480, 230, "POINTS", 3, charting_string, Me.Page, Me.bottom_tab_update_panel, False, True, True, False, False, True, False)


        Call load_google_chart_all(news_tab, charting_string)
        Me.value_panel_all.Visible = True
    End Sub

    Public Sub run_full_recent_sales(ByRef results_label_to_display As String, ByRef temp_amod_id As Integer, ByRef rep_id As Integer, ByRef temp_table As DataTable, ByRef is_graph_only As String, ByRef aclsData_Temp As clsData_Manager_SQL, ByRef note_id As Integer, ByRef chart_htmlString As String, ByVal activetab As Integer)

        Dim temp_val As String = ""
        Dim need_run As Boolean = True

        If IsPostBack And Session("LAST_RUN_OVERALL_TAB") = 5 Then
            If Not IsNothing(Session("SELECTED_SOLD_EXPORT")) Then
                temp_val = ac_projects_ddl4.SelectedValue
                If InStr(temp_val, "+") > 0 Then
                    temp_val = Right(temp_val, Len(temp_val) - InStr(temp_val, "+"))
                    temp_val = Replace(temp_val, "+", "")
                End If

                If Trim(Session("SELECTED_SOLD_EXPORT")) <> Trim(temp_val) Then
                    need_run = False
                End If
            End If
        End If

        ' Me.view_reports_label.Text = "Displays a list of all aircraft sold in the last year for the model of aircraft being evaluated based on a combination of JETNET data and aircraft tailored by edits within my Marketplace Manager. The graph below shows my current aircraft value(s) with respect to the asking, take, and sold prices."
        Me.view_reports_label.Text = results_label_to_display
        If Not IsPostBack Or ac_projects_ddl4.Visible = False Or (Session("Last_Amod") <> temp_amod_id) Then


            If IsNothing(Session("SELECTED_SOLD_EXPORT")) Then
                Session("SELECTED_SOLD_EXPORT") = 0
                Session("SELECTED_SOLD_EXPORT") = 0
            ElseIf CDbl(Session("SELECTED_SOLD_EXPORT")) <> 0 Then
                rep_id = Session("SELECTED_SOLD_EXPORT")
            End If



            ac_projects_ddl4.Items.Clear()
            Session("Last_Amod") = temp_amod_id
            ac_projects_ddl4.Items.Add(New System.Web.UI.WebControls.ListItem("Standard Recent Sales Summary", -1))

            If rep_id = -1 Or rep_id > 0 Then 'if you have chosen to use first one, then display it , and dont use default
                Call aclsData_Temp.Fill_Open_Box(ac_projects_ddl4, Session.Item("localUser").crmLocalUserID, 8, rep_id, temp_amod_id, "8", "", False)
            Else
                Call aclsData_Temp.Fill_Open_Box(ac_projects_ddl4, Session.Item("localUser").crmLocalUserID, 8, rep_id, temp_amod_id, "8", "", True)
            End If

            If rep_id > -1 And rep_id < 11111 Then

            ElseIf rep_id = 11111 Then
                ac_projects_ddl4.SelectedIndex = 1
            Else
                ac_projects_ddl4.SelectedIndex = 0
            End If
            ac_projects_ddl4.Visible = True
            project_text4.Visible = True
        ElseIf IsPostBack And Session("LAST_SOLD_TAB") = 5 Then ' if you are re-loading from same 

            temp_val = ac_projects_ddl4.SelectedValue
            If InStr(temp_val, "+") > 0 Then
                temp_val = Right(temp_val, Len(temp_val) - InStr(temp_val, "+"))
                temp_val = Replace(temp_val, "+", "")
            End If
            Session("SELECTED_SOLD_EXPORT") = temp_val
            Session("SELECTED_SOLD_EXPORT_INDEX") = ac_projects_ddl4.SelectedIndex
            rep_id = temp_val

        ElseIf IsPostBack And Session("LAST_SOLD_TAB") = 6 Then ' has to be coming from last tab 6

            If IsNothing(Session("SELECTED_SOLD_EXPORT")) Then
                Session("SELECTED_SOLD_EXPORT") = 0
            ElseIf CDbl(Session("SELECTED_SOLD_EXPORT")) <> 0 Then
                rep_id = Session("SELECTED_SOLD_EXPORT")
                Session("SELECTED_SOLD_EXPORT") = rep_id
                ac_projects_ddl4.SelectedIndex = Session("SELECTED_SOLD_EXPORT_INDEX")

            End If
        End If

        If View_ID = 19 Then
            If ((TabContainer1.ActiveTab.ID.ToString <> "wanted_tab") And (estimated_value.Checked = False)) Then
                need_run = False
            End If
            If Not (String.IsNullOrEmpty(SoldSurveyCurrentID.Text)) Then
                need_run = True
            End If
        End If

        If need_run = True Then
            Build_Retail_sales_tab(localCriteria, Me.view_wanteds_label1, temp_table, Me.check_include_internals, Me.check_retail_sales, note_id, rep_id, aclsData_Temp, activetab)

            If Me.estimated_value_label2.Visible = True Or TabContainer1.ActiveTabIndex = 5 Then
                Call Build_Analytics_Charts(localCriteria, chart_htmlString, note_id, "Recent Sales", temp_table, False, 0, 0, 0, is_graph_only)
                'Me.view_reports_label.Text &= chart_htmlString
            End If
        End If

    End Sub

#End Region

#Region "helper_functions"

    Private Function ControlThatCausedPostBack(ByVal myPage As Page)
        Dim ctrl As New Control
        Dim ctrlName As String = ""

        ctrlName = Page.Request.Params.Get("__EVENTTARGET")
        If Not String.IsNullOrEmpty(ctrlName) Then
            ctrl = Page.FindControl(ctrlName)
        End If
        Return ctrl

    End Function

    Public Sub set_up_ac_model_pic(ByRef temp_ac_id As Long, ByRef temp_amod_id As Long, ByRef make_name As String, ByRef model_name As String, ByRef ac_ser_no As String, ByRef type_of_search As String, ByRef rest_of_ac_string As String, ByRef imgDisplayFolder As String)

        If temp_ac_id > 0 Then

            Me.make_model_name_label.Text = rest_of_ac_string
            topLeftCSSContainer.CssClass = "gray_background tab_container_div_small"
            aircraft_picture_slideshow.Text = GetAircraftPictures_For_CRM_VIEW(temp_ac_id, 0, make_name, model_name, ac_ser_no)

            aircraft_picture_slideshow.Text = "<table align='left' width='100%'><tr><td>" & aircraft_picture_slideshow.Text & "</td></tr></table>"
            aircraft_image.Visible = False

            Me.TabPanel14.Width = 240
            Me.TabPanel14.Height = 178
            Me.TabContainer2.Height = 178
            Me.TabContainer2.Width = 240
            Me.tabs_container.Height = 178

            ' so that it searches by model
            If Trim(type_of_search) = "" Or Trim(type_of_search) = "My Model" Then
                make_name = ""
            ElseIf Trim(type_of_search) = "Same Make" Then
                temp_amod_id = 0
            End If
        Else
            imgDisplayFolder = Application.Item("crmClientSiteData").ClientFullHostName + Session.Item("ModelPicturesFolderVirtualPath").ToString

            'Let's do this instead.
            Dim DisplayPicture As Boolean = False

            CheckSharedModelTable()

            If Not IsNothing(SharedModelTable) Then
                If SharedModelTable.Rows.Count > 0 Then
                    If SharedModelTable.Rows(0).Item("amod_picture_exists_flag").ToString.ToUpper = "Y" Then
                        DisplayPicture = True
                    End If
                End If
            End If

            If DisplayPicture Then
                topLeftCSSContainer.CssClass = "gray_background tab_container_div_small"
                If localCriteria.ViewCriteriaAmodID > -1 Then
                    Me.aircraft_image.ImageUrl = imgDisplayFolder.Trim + "/" + localCriteria.ViewCriteriaAmodID.ToString + ".jpg"
                ElseIf localCriteria.ViewCriteriaMakeAmodID > -1 Then
                    Me.aircraft_image.ImageUrl = imgDisplayFolder.Trim + "/" + localCriteria.ViewCriteriaMakeAmodID.ToString + ".jpg"
                End If
                Me.label_behind_pic.Text = ""
                Me.aircraft_image.Width = 225
                'Me.aircraft_image.Height = 178
            Else
                Me.aircraft_image.Visible = False
                Me.label_behind_pic.Text = "No Picture Available"
            End If

            If Trim(type_of_search) = "" Or Trim(type_of_search) = "My Model" Then
                make_model_name = commonEvo.Get_Aircraft_Model_Info(localCriteria.ViewCriteriaAmodID, False, "")
                Me.make_model_name_label.Text = make_model_name
            Else
                Me.make_model_name_label.Text = make_name
            End If

            Me.TabPanel14.Width = 240
            Me.TabPanel14.Height = 205
            Me.TabContainer2.Height = 205
            Me.TabContainer2.Width = 250
            Me.tabs_container.Height = 205
        End If
    End Sub

    Public Sub add_ChangeTopActiveTab_Script(ByVal tcSource As AjaxControlToolkit.TabContainer)

        'Register the script block
        Dim sScptStr As StringBuilder = New StringBuilder()

        If Not Page.ClientScript.IsClientScriptBlockRegistered("cht-top-onclick") Then

            sScptStr.Append("<script type=""text/javascript"">")
            sScptStr.Append(vbCrLf & "  function changeTopTab(num) {")
            sScptStr.Append(vbCrLf & "    var container = $find(""" + tcSource.ClientID.ToString + """);")
            sScptStr.Append(vbCrLf & "    container.set_activeTabIndex(num);")
            sScptStr.Append(vbCrLf & "  }")
            sScptStr.Append(vbCrLf & "</script>")

            Page.ClientScript.RegisterClientScriptBlock(Me.GetType(), "cht-top-onclick", sScptStr.ToString, False)

        End If

        sScptStr = Nothing

    End Sub

    Function get_make_model_info(ByRef searchCriteria As viewSelectionCriteriaClass) As Boolean

        Dim make_name As String = ""
        Dim model_name As String = ""
        Dim weight_class As String = ""
        Dim type_code As String = ""
        Dim airframe_type As String = ""

        Dim fAmod_start_year As String = ""
        Dim fAmod_end_year As String = ""
        Dim fAmod_ser_no_prefix As String = ""
        Dim fAmod_ser_no_start As String = ""
        Dim fAmod_ser_no_end As String = ""
        Dim fAmod_ser_no_suffix As String = ""
        Dim fAmod_start_price As Integer = 0
        Dim fAmod_end_price As Integer = 0

        'Dim results_table As DataTable

        Try

            CheckSharedModelTable()

            If Not IsNothing(SharedModelTable) Then

                If SharedModelTable.Rows.Count > 0 Then

                    For Each r As DataRow In SharedModelTable.Rows

                        If Not IsDBNull(r.Item("amod_make_name")) Then
                            If Not String.IsNullOrEmpty(r.Item("amod_make_name").ToString) Then
                                make_name = r.Item("amod_make_name").ToString.Trim
                            End If
                        End If

                        If Not IsDBNull(r.Item("amod_model_name")) Then
                            If Not String.IsNullOrEmpty(r.Item("amod_make_name").ToString) Then
                                model_name = r.Item("amod_model_name").ToString.Trim
                            End If
                        End If

                        make_model_name = make_name + " " + model_name

                        If Not IsDBNull(r.Item("amod_manufacturer")) Then
                            If Not String.IsNullOrEmpty(r.Item("amod_manufacturer").ToString) Then
                                Amod_manufacturer = r.Item("amod_manufacturer").ToString.Trim
                            End If
                        End If

                        If Not IsDBNull(r.Item("amod_type_code")) Then
                            If Not String.IsNullOrEmpty(r.Item("amod_type_code").ToString) Then
                                type_code = r.Item("amod_type_code").ToString.ToUpper.Trim
                            End If
                        End If

                        If Not IsDBNull(r.Item("amod_airframe_type_code")) Then
                            If Not String.IsNullOrEmpty(r.Item("amod_airframe_type_code").ToString) Then
                                airframe_type = r.Item("amod_airframe_type_code").ToString.ToUpper.Trim
                            End If
                        End If

                        Select Case type_code.Trim.ToUpper
                            Case Constants.AMOD_TYPE_AIRLINER
                                Amod_type_name = "Jet Airliner"
                            Case Constants.AMOD_TYPE_JET
                                Amod_type_name = "Business Jet"
                            Case Constants.AMOD_TYPE_TURBO
                                If airframe_type.Trim.ToUpper.Contains(Constants.AMOD_ROTARY_AIRFRAME) Then
                                    Amod_type_name = "Turbine"
                                Else
                                    Amod_type_name = "Turboprop"
                                End If
                            Case Constants.AMOD_TYPE_PISTON
                                Amod_type_name = "Piston"
                        End Select

                        If Not IsDBNull(r.Item("amod_weight_class")) Then
                            If Not String.IsNullOrEmpty(r.Item("amod_weight_class").ToString) Then
                                weight_class = r.Item("amod_weight_class").ToString.ToUpper.Trim
                            End If
                        End If

                        Select Case weight_class
                            Case "V"
                                Amod_weight_class_name = "Very Light Jet"
                            Case "L"
                                Amod_weight_class_name = "Light"
                            Case "M"
                                Amod_weight_class_name = "Medium"
                            Case "H"
                                Amod_weight_class_name = "Heavy"
                        End Select

                        If Not IsDBNull(r.Item("amod_start_year")) Then
                            If Not String.IsNullOrEmpty(r.Item("amod_start_year").ToString) Then
                                fAmod_start_year = r.Item("amod_start_year").ToString.ToUpper.Trim
                            End If
                        End If

                        If Not IsDBNull(r.Item("amod_end_year")) Then
                            If Not String.IsNullOrEmpty(r.Item("amod_end_year").ToString) Then
                                fAmod_end_year = r.Item("amod_end_year").ToString.ToUpper.Trim
                            End If
                        End If

                        Amod_start_end_years = fAmod_start_year


                        If Not IsDBNull(r.Item("amod_end_year")) Then
                            If Not String.IsNullOrEmpty(r.Item("amod_end_year").ToString) Then
                                fAmod_end_year = r.Item("amod_end_year").ToString.ToUpper.Trim
                            End If
                        End If

                        If Not String.IsNullOrEmpty(fAmod_end_year) Then
                            Amod_start_end_years += " - " + fAmod_end_year + "&nbsp;"
                        ElseIf Not String.IsNullOrEmpty(fAmod_start_year) Then
                            Amod_start_end_years += " - Present&nbsp;"
                        Else
                            Amod_start_end_years += "&nbsp;"
                        End If

                        If Not IsDBNull(r.Item("amod_ser_no_prefix")) Then
                            If Not String.IsNullOrEmpty(r.Item("amod_ser_no_prefix").ToString) Then
                                fAmod_ser_no_prefix = r.Item("amod_ser_no_prefix").ToString.ToUpper.Trim
                            End If
                        End If

                        If Not IsDBNull(r.Item("amod_ser_no_start")) Then
                            If Not String.IsNullOrEmpty(r.Item("amod_ser_no_start").ToString) Then
                                fAmod_ser_no_start = r.Item("amod_ser_no_start").ToString.ToUpper.Trim
                            End If
                        End If

                        If Not IsDBNull(r.Item("amod_ser_no_end")) Then
                            If Not String.IsNullOrEmpty(r.Item("amod_ser_no_end").ToString) Then
                                fAmod_ser_no_end = r.Item("amod_ser_no_end").ToString.ToUpper.Trim
                            End If
                        End If

                        If Not IsDBNull(r.Item("amod_ser_no_suffix")) Then
                            If Not String.IsNullOrEmpty(r.Item("amod_ser_no_suffix").ToString) Then
                                fAmod_ser_no_suffix = r.Item("amod_ser_no_suffix").ToString.ToUpper.Trim
                            End If
                        End If

                        Amod_ser_nbr_range = fAmod_ser_no_prefix + fAmod_ser_no_start + fAmod_ser_no_suffix

                        If Not String.IsNullOrEmpty(fAmod_ser_no_end) Then
                            Amod_ser_nbr_range += " - " + fAmod_ser_no_prefix + fAmod_ser_no_end + fAmod_ser_no_suffix + "&nbsp;"
                        ElseIf Not String.IsNullOrEmpty(fAmod_ser_no_start) Then
                            Amod_ser_nbr_range += " &amp; Up&nbsp;"
                        Else
                            Amod_ser_nbr_range += "&nbsp;"
                        End If

                        If Not IsDBNull(r.Item("amod_start_price")) Then
                            If Not String.IsNullOrEmpty(r.Item("amod_start_price").ToString) Then
                                fAmod_start_price = CDbl(r.Item("amod_start_price").ToString)
                            End If
                        End If

                        If Not IsDBNull(r.Item("amod_end_price")) Then
                            If Not String.IsNullOrEmpty(r.Item("amod_end_price").ToString) Then
                                fAmod_end_price = CDbl(r.Item("amod_end_price").ToString)
                            End If
                        End If

                        If fAmod_start_price <> 0 Then
                            Amod_price_range += "$" & FormatNumber((fAmod_start_price / 1000), 0, False, False, True) & "k"
                        Else
                            Amod_price_range += "&nbsp;"
                        End If

                        If fAmod_end_price <> 0 Then
                            Amod_price_range += " - $ " & FormatNumber((fAmod_end_price / 1000), 0, False, False, True) & "k&nbsp;"
                        Else
                            Amod_price_range += "&nbsp;"
                        End If

                        If Not IsDBNull(r.Item("amod_description")) Then
                            If Not String.IsNullOrEmpty(r.Item("amod_description").ToString) Then
                                Amod_description = r.Item("amod_description").ToString.Trim
                            End If
                        End If

                        If Not IsDBNull(r.Item("ambc_name")) Then
                            If Not String.IsNullOrEmpty(r.Item("ambc_name").ToString) Then
                                If Not r.Item("ambc_name").ToString.ToLower.Contains("unknown") And (r.Item("amod_product_helicopter_flag").ToString.ToUpper.Trim.Contains("Y") Or r.Item("amod_product_commercial_flag").ToString.ToUpper.Trim.Contains("Y")) Then
                                    Amod_body_config = r.Item("ambc_name").ToString.Trim
                                End If
                            End If
                        End If

                    Next

                End If

            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [get_make_model_info] : " + ex.Message
        End Try

    End Function

    Public Sub ac_projects_ddl_SelectedIndexChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles ac_projects_ddl.SelectedIndexChanged
        Dim temp_val As String = ""
        Dim page_changed As Boolean = False
        Dim temp_label As String = ""
        Dim chart_htmlString As String = ""
        Dim NOTE_ID As Integer = 0
        Dim rest_of_ac_string As String = ""
        Dim make_name As String = ""
        Dim model_name As String = ""
        Dim temp_amod_id As Long = 0
        Dim real_ac_id As Long = 0

        Dim activetab As Integer = 0
        Dim temp_table2 As New DataTable
        Dim google_map_array_list As String = ""
        Dim COMPLETED_OR_OPEN As String = "O"
        Dim selected_changed As Boolean = False
        Dim results_label_to_display As String = ""
        Dim comp_distance As Integer = 0

        temp_val = ac_projects_ddl.SelectedValue
        If InStr(temp_val, "+") > 0 Then
            temp_val = Right(temp_val, Len(temp_val) - InStr(temp_val, "+"))
            temp_val = Replace(temp_val, "+", "")
        End If

        If Trim(Request("cdistance")) <> "" Then
            comp_distance = Trim(Request("cdistance"))
        Else
            comp_distance = 25
        End If

        If IsNumeric(temp_val) Then
            If temp_val > 0 Then
                Me.edit_export_link.Text = "<A href='export_creator.aspx?project_id=" & temp_val & "' target='_blank'>Edit Format</A>"
                Me.edit_export_link.Visible = True
            Else
                Me.edit_export_link.Visible = True
            End If
        Else
            Me.edit_export_link.Visible = True
        End If

        If View_ID = 24 Then
            Response.Redirect("View_template.aspx?ViewID=24&ViewName=Airport FBO View&activetab=1&start_date=" & Me.start_date.Text & "&end_date=" & Me.end_date.Text & "&bus_type= " & Trim(Request("bus_type")) & "&flight=" & temp_val & "&cdistance=" & comp_distance & "")

        ElseIf View_ID = 19 Then

            Call run_compare_view_items(results_label_to_display, 1, selected_changed, Trim(Request("noteID")), real_ac_id, make_name, model_name, temp_amod_id, rest_of_ac_string, chart_htmlString, temp_val, False)

        Else
            Response.Redirect("View_template.aspx?ViewID=" & Trim(Request("ViewID")) & "&noMaster=" & bHasMaster.ToString & "&rep_id=" & temp_val & "&noteID=" & Trim(Request("noteID")) & "&cboAircraftViewModel=" & Trim(Request("cboAircraftViewModel")) & "&activetab=1")
        End If

    End Sub

    Public Sub fbo_months_drop_SelectedIndexChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles fbo_months_drop.SelectedIndexChanged
        Dim temp_val As String = ""
        Dim page_changed As Boolean = False
        Dim temp_label As String = ""
        Dim chart_htmlString As String = ""
        Dim NOTE_ID As Integer = 0
        Dim rest_of_ac_string As String = ""
        Dim make_name As String = ""
        Dim model_name As String = ""
        Dim temp_amod_id As Long = 0
        Dim real_ac_id As Long = 0

        Dim activetab As Integer = 0
        Dim temp_table2 As New DataTable
        Dim google_map_array_list As String = ""
        Dim COMPLETED_OR_OPEN As String = "O"
        Dim selected_changed As Boolean = False
        Dim results_label_to_display As String = ""

        temp_val = fbo_months_drop.SelectedValue
        If InStr(temp_val, "+") > 0 Then
            temp_val = Right(temp_val, Len(temp_val) - InStr(temp_val, "+"))
            temp_val = Replace(temp_val, "+", "")
        End If

        Response.Redirect("View_template.aspx?ViewID=24&ViewName=Airport FBO View&activetab=1&bus_type= " & Trim(Request("bus_type")) & "&recent=" & temp_val & "&flight=" & Me.ac_projects_ddl.SelectedValue & "")


    End Sub

    Public Sub ac_projects_ddl2_SelectedIndexChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles ac_projects_ddl2.SelectedIndexChanged
        Dim temp_val As String = ""
        Dim temp_val2 As String = ""
        Dim page_changed As Boolean = False
        Dim temp_label As String = ""
        Dim chart_htmlString As String = ""
        Dim NOTE_ID As Integer = 0
        Dim rest_of_ac_string As String = ""
        Dim make_name As String = ""
        Dim model_name As String = ""
        Dim temp_amod_id As Long = 0
        Dim real_ac_id As Long = 0

        Dim activetab As Integer = 0
        Dim temp_table2 As New DataTable
        Dim google_map_array_list As String = ""
        Dim COMPLETED_OR_OPEN As String = "O"
        Dim selected_changed As Boolean = False
        Dim results_label_to_display As String = ""
        Dim localcriteria As New viewSelectionCriteriaClass


        If View_ID = 24 Then
            temp_val = ac_projects_ddl2.SelectedValue
            temp_val2 = company_range.SelectedValue
            If Trim(Request("aport_id")) <> "" Then
                Response.Redirect("view_template.aspx?ViewID=24&ViewName=Airport FBO View&aport_id=" & Trim(Request("aport_id")) & "&activetab=2&bus_type=" & temp_val & "&cdistance=" & temp_val2 & "")
            Else
                Response.Redirect("view_template.aspx?ViewID=24&ViewName=Airport FBO View&activetab=2&bus_type=" & temp_val & "&cdistance=" & temp_val2 & "")
            End If
        Else
            temp_val = ac_projects_ddl2.SelectedValue
            If InStr(temp_val, "+") > 0 Then
                temp_val = Right(temp_val, Len(temp_val) - InStr(temp_val, "+"))
                temp_val = Replace(temp_val, "+", "")
            End If
            Call run_compare_view_items(results_label_to_display, 2, selected_changed, Trim(Request("noteID")), real_ac_id, make_name, model_name, temp_amod_id, rest_of_ac_string, chart_htmlString, temp_val, False)
        End If

    End Sub

    Public Sub company_range_SelectedIndexChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles company_range.SelectedIndexChanged
        Dim temp_val As String = ""
        Dim temp_val2 As String = ""
        Dim page_changed As Boolean = False
        Dim temp_label As String = ""
        Dim chart_htmlString As String = ""
        Dim NOTE_ID As Integer = 0
        Dim rest_of_ac_string As String = ""
        Dim make_name As String = ""
        Dim model_name As String = ""
        Dim temp_amod_id As Long = 0
        Dim real_ac_id As Long = 0

        Dim activetab As Integer = 0
        Dim temp_table2 As New DataTable
        Dim google_map_array_list As String = ""
        Dim COMPLETED_OR_OPEN As String = "O"
        Dim selected_changed As Boolean = False
        Dim results_label_to_display As String = ""
        Dim localcriteria As New viewSelectionCriteriaClass


        temp_val = ac_projects_ddl2.SelectedValue
        temp_val2 = company_range.SelectedValue


        If Trim(Request("aport_id")) <> "" Then
            Response.Redirect("view_template.aspx?ViewID=28&ViewName=Flight Activity (Operator/Airport)&aport_id=" & Trim(Request("aport_id")) & "&activetab=19&bus_type=" & temp_val & "&cdistance=" & temp_val2 & "")
        Else
            Response.Redirect("view_template.aspx?ViewID=28&ViewName=Flight Activity (Operator/Airport)&activetab=19bus_type=" & temp_val & "&cdistance=" & temp_val2 & "")
        End If


    End Sub

    Public Sub ac_projects_dd_sales_SelectedIndexChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles ac_projects_dd_sales.SelectedIndexChanged

        Dim temp_val As String = ""
        Dim page_changed As Boolean = False
        Dim temp_label As String = ""
        Dim chart_htmlString As String = ""
        Dim NOTE_ID As Integer = 0
        Dim rest_of_ac_string As String = ""
        Dim make_name As String = ""
        Dim model_name As String = ""
        Dim temp_amod_id As Long = 0
        Dim real_ac_id As Long = 0

        Dim activetab As Integer = 0
        Dim temp_table2 As New DataTable
        Dim google_map_array_list As String = ""
        Dim COMPLETED_OR_OPEN As String = "O"
        Dim selected_changed As Boolean = False
        Dim results_label_to_display As String = ""
        temp_val = ac_projects_dd_sales.SelectedValue
        If InStr(temp_val, "+") > 0 Then
            temp_val = Right(temp_val, Len(temp_val) - InStr(temp_val, "+"))
            temp_val = Replace(temp_val, "+", "")
        End If

        '&noMaster=false got rid of this, was making the tabs dissapear in evo 
        Response.Redirect("View_template.aspx?ViewID=1&rep_id=" & temp_val & "&noteID=" & Trim(Request("noteID")) & "&activetab=2")

    End Sub
    Public Sub ac_projects_dd3_SelectedIndexChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles ac_projects_dd3.SelectedIndexChanged

        Dim temp_val As String = ""
        Dim page_changed As Boolean = False
        Dim temp_label As String = ""
        Dim chart_htmlString As String = ""
        Dim NOTE_ID As Integer = 0
        Dim rest_of_ac_string As String = ""
        Dim make_name As String = ""
        Dim model_name As String = ""
        Dim temp_amod_id As Long = 0
        Dim real_ac_id As Long = 0

        Dim activetab As Integer = 0
        Dim temp_table2 As New DataTable
        Dim google_map_array_list As String = ""
        Dim COMPLETED_OR_OPEN As String = "O"
        Dim selected_changed As Boolean = False
        Dim results_label_to_display As String = ""
        temp_val = ac_projects_dd3.SelectedValue
        If InStr(temp_val, "+") > 0 Then
            temp_val = Right(temp_val, Len(temp_val) - InStr(temp_val, "+"))
            temp_val = Replace(temp_val, "+", "")
        End If

        If View_ID = 19 Then
            Call run_compare_view_items(results_label_to_display, 6, selected_changed, Trim(Request("noteID")), real_ac_id, make_name, model_name, temp_amod_id, rest_of_ac_string, chart_htmlString, temp_val, False)
        ElseIf View_ID = 1 Then
            Response.Redirect("View_template.aspx?ViewID=1&noMaster=false&rep_id=" & temp_val & "&noteID=" & Trim(Request("noteID")) & "&activetab=2")
        End If

    End Sub

    Public Sub ac_projects_ddl4_SelectedIndexChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles ac_projects_ddl4.SelectedIndexChanged
        Dim temp_val As String = ""
        Dim page_changed As Boolean = False
        Dim temp_label As String = ""
        Dim chart_htmlString As String = ""
        Dim NOTE_ID As Integer = 0
        Dim rest_of_ac_string As String = ""
        Dim make_name As String = ""
        Dim model_name As String = ""
        Dim temp_amod_id As Long = 0
        Dim real_ac_id As Long = 0

        Dim activetab As Integer = 0
        Dim temp_table2 As New DataTable
        Dim google_map_array_list As String = ""
        Dim COMPLETED_OR_OPEN As String = "O"
        Dim selected_changed As Boolean = False
        Dim results_label_to_display As String = ""

        temp_val = ac_projects_ddl4.SelectedValue
        If InStr(temp_val, "+") > 0 Then
            temp_val = Right(temp_val, Len(temp_val) - InStr(temp_val, "+"))
            temp_val = Replace(temp_val, "+", "")
        End If

        If View_ID = 19 Then
            Call run_compare_view_items(results_label_to_display, 5, selected_changed, Trim(Request("noteID")), real_ac_id, make_name, model_name, temp_amod_id, rest_of_ac_string, chart_htmlString, temp_val, False)
        End If

    End Sub

    Public Sub on_click_load_bottom(ByRef searchCriteria As viewSelectionCriteriaClass)
        Dim is_aero As Integer = 0
        Dim rep_id As Integer = 0
        Dim aclsData_Temp As New clsData_Manager_SQL
        Dim extra_crit As Boolean = False
        Dim temp_activetab As Integer = 0
        Dim note_id As Long = 0
        Dim RunComparableInsert As Boolean = False

        Dim utilization_functions As New utilization_view_functions
        utilization_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
        utilization_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
        utilization_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
        utilization_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
        utilization_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

        If CRMViewActive Then
            value_estimates_label.Text = "Please wait a Moment while Estimate Data is loading.."
            market_values_top_tab.Visible = False
            market_values_top_tab.HeaderText = "Market Values"
            tabs_container.ActiveTab = model_market_status_tab
            RunComparableInsert = HttpContext.Current.Request.Form(run_comparable_insert.UniqueID) IsNot Nothing
            top_tab_update_panel.Update()

        End If

        aclsData_Temp.JETNET_DB = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
        aclsData_Temp.client_DB = Application.Item("crmClientDatabase") 'HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim

        If Not IsNothing(HttpContext.Current.Request.Item("extra")) Then
            If Not String.IsNullOrEmpty(HttpContext.Current.Request.Item("extra").ToString.Trim) And HttpContext.Current.Request.Item("extra").ToString.ToLower.Contains("true") Then
                extra_crit = True
            End If
        End If

        If CRMViewActive Then
            FillEventsCategory(aclsData_Temp, crm_event_category1)
        Else
            FillEventsCategory(aclsData_Temp, crm_event_category2)
        End If

        If Session.Item("localPreferences").AerodexFlag Then
            is_aero = 1
        End If

        Me.show_sale.Visible = False

        If Trim(Request("note_id")) <> "" Then
            note_id = Trim(Request("note_id"))
        Else
            If Trim(Request("noteID")) <> "" Then
                note_id = Trim(Request("noteID"))
            Else
                note_id = 0
            End If
        End If

        If Trim(Request("rep_id")) <> "" Then
            rep_id = Trim(Request("rep_id"))
            If rep_id = 11111 Then  ' if its that view, set extra to true 
                extra_crit = True
            End If

        End If

        If Not IsPostBack Then
            If Trim(Request("activetab")) <> "" Then
                If TabContainer1.ActiveTabIndex = 0 Then
                    temp_activetab = CDbl(Trim(Request("activetab")))
                    TabContainer1.ActiveTabIndex = temp_activetab
                ElseIf Not String.IsNullOrEmpty(Trim(Request("ref"))) Then
                    If Trim(Request("ref")) = "true" Then
                        temp_activetab = CDbl(Trim(Request("activetab")))
                        TabContainer1.ActiveTabIndex = temp_activetab
                    End If
                End If
            End If
        End If

        If IsNothing(Session("LAST_RUN_OVERALL_TAB_MMS")) Then
            Session("LAST_RUN_OVERALL_TAB_MMS") = 0
        End If


        If Session.Item("isMobile") Then

            If Not Page.IsPostBack Then
                If Not IsNothing(SharedModelTable) Then
                    If SharedModelTable.Rows.Count > 0 Then
                        makeModelDynamic.SelectedValue = SharedModelTable.Rows(0).Item("amod_type_code") & "|" & SharedModelTable.Rows(0).Item("amod_airframe_type_code") & "|" & SharedModelTable.Rows(0).Item("amod_make_name") & "|" & localCriteria.ViewCriteriaAmodID
                    End If
                End If
            End If
        End If


        Try

            If Page.IsPostBack Then
                System.Web.UI.ScriptManager.RegisterStartupScript(Me.bottom_tab_update_panel, Me.GetType, "toggleExport", " $(document).ready(function() {document.getElementById('" & exportReportCell.ClientID & "').classList.add('display_none')});", True)
            Else
                ToggleVisibilityOfActionMenu(ParentExportReport, ChildExportReport)
            End If

            Select Case TabContainer1.ActiveTabIndex
                Case 1
                    '  Me.show_sale.Visible = True

                    If (InStr(Session.Item("localUser").crmLocalUserName, "@jetnet.com") > 0 Or InStr(Session.Item("localUser").crmLocalUserName, "@mvintech.com") > 0) Then
                        System.Web.UI.ScriptManager.RegisterStartupScript(Me.bottom_tab_update_panel, Me.GetType, "toggleExport2", " $(document).ready(function() {document.getElementById('" & exportReportCell.ClientID & "').classList.remove('display_none')});", True)

                    End If

                    If CRMViewActive Then

                        ' if its a postback, and hasnt been made visible yet 
                        If IsNothing(Session("Last_Amod")) Then
                            Session("Last_Amod") = 0
                        End If

                        If Not IsPostBack Or ac_projects_ddl.Visible = False Or (Session("Last_Amod") <> searchCriteria.ViewCriteriaAmodID) Then
                            Session("Last_Amod") = searchCriteria.ViewCriteriaAmodID
                            ac_projects_ddl.Items.Clear()
                            ac_projects_ddl.Items.Add(New System.Web.UI.WebControls.ListItem("Standard Market Survey", 0))
                            ac_projects_ddl.Items.Add(New System.Web.UI.WebControls.ListItem("Standard Market Survey with Operator/Phone#s", 11111))


                            Call aclsData_Temp.Fill_Open_Box(ac_projects_ddl, Session.Item("localUser").crmLocalUserID, 3, rep_id, searchCriteria.ViewCriteriaAmodID, "3", "", IIf(IsNumeric(Trim(Request("rep_id"))), False, True))
                            If rep_id > 0 And rep_id < 11111 Then

                            ElseIf rep_id = 11111 Then
                                ac_projects_ddl.SelectedValue = 11111
                                extra_crit = True
                            Else
                                ac_projects_ddl.SelectedValue = 0
                            End If
                            ac_projects_ddl.Visible = True
                            projects_text.Visible = True
                        End If

                        If rep_id > 0 Then
                            Me.edit_export_link.Text = "<A href='export_creator.aspx?project_id=" & rep_id & "' target='_blank'>Edit Format</A>"
                            Me.edit_export_link.Visible = True
                        Else
                            Me.edit_export_link.Visible = True
                        End If

                        Me.create_new_format.Text = "<A href='export_creator.aspx?project_id=0&new_project=Y' target='_blank'  style=""margin-left:60px;"">New Format Template</A>"
                        Me.create_new_format.Visible = True


                        informationIconForsale.Text = "<div class=""viewSearchClassSale""><div class=""searchCriteria slideoutToolTip""><p title='Information' class='blue'><span class='label'>Client/Edited records are displayed with pink/red background</span></p></div></div>"
                        If Not Page.ClientScript.IsClientScriptBlockRegistered("runTooltip") Then
                            Dim strJs As String = "SetUpSlider();"

                            If CRMViewActive Then
                                If Not IsNothing(Trim(Request("expand"))) Then
                                    If Not String.IsNullOrEmpty(Trim(Request("expand"))) Then
                                        If Trim(Request("expand")) = "true" Then
                                            strJs = ""
                                        End If
                                    End If
                                End If
                            End If


                            System.Web.UI.ScriptManager.RegisterClientScriptBlock(Me.bottom_tab_update_panel, Me.GetType, "runTooltip", strJs, True)
                        End If
                    End If

                    Dim GraphTable As New DataTable


                    crmViewDataLayer.Build_For_sale_tab(searchCriteria, view_for_sale_label.Text, 0, Session("ForSale_File_EXCEL"), View_ID, CRMViewActive, extra_crit, Session.Item("localUser").crmAllowExport_Flag, "", localDatalayer, LAST_SAVE_DATE, ClientIDSToExclude, Session.Item("CLIENT_AC_ID"), True, 0, "", True, rep_id, aclsData_Temp, 1, IIf(CRMViewActive, RunComparableInsert, False), IIf(CRMViewActive = True, fullSaleCurrentIDs.Text, ""), RunModelOnValueOnly, GraphTable, displayEValues)

                    If CRMViewActive And displayEValues = False Then
                        If rep_id = 0 Or rep_id = 11111 Then
                            If Not IsNothing(GraphTable) Then
                                If GraphTable.Rows.Count > 0 Then
                                    'Let's graph this:
                                    market_values_top_tab.Visible = True
                                    market_values_top_tab.HeaderText = "Market Values"
                                    tabs_container.ActiveTab = market_values_top_tab

                                    top_tab_update_panel.Update()
                                    MakeAModelValuesGraph(GraphTable, 1)
                                End If

                            End If
                        End If
                    ElseIf displayEValues = True Then
                        market_values_top_tab.Visible = True
                        market_values_top_tab.HeaderText = "Market Values"
                        tabs_container.ActiveTab = market_values_top_tab

                        top_tab_update_panel.Update()
                        buildCurrentMarketChart(searchCriteria, utilization_functions)
                    ElseIf displayEValues = False And CRMViewActive = False Then
                        market_values_top_tab.Visible = False
                    End If


                    CheckAndJSForDatatable()


                    TabContainer1.ActiveTabIndex = 1
                    ' enable export to excel button
                    cellExportToExcel.Visible = True

                    If Session("LAST_RUN_OVERALL_TAB_MMS") <> 1 Then
                        fullSaleCurrentIDs.Text = ""
                    End If


                    Session("LAST_RUN_OVERALL_TAB_MMS") = 1

                Case 2


                    If CRMViewActive Then

                        If Not IsPostBack Or ac_projects_dd3.Visible = False Or ac_projects_dd_sales.Visible = False Or (Session("Last_Amod") <> searchCriteria.ViewCriteriaAmodID) Then

                            ' and its view1 and its invisible or model has changed 
                            If View_ID = 1 And (ac_projects_dd_sales.Visible = False Or (Session("Last_Amod") <> searchCriteria.ViewCriteriaAmodID)) Then
                                ' added MSW - 11/23/18 - 
                                ac_projects_dd_sales.Items.Clear()
                                Session("Last_Amod") = searchCriteria.ViewCriteriaAmodID
                                ac_projects_dd_sales.Items.Add(New System.Web.UI.WebControls.ListItem("Standard Recent Sales Summary", 0))
                                Call aclsData_Temp.Fill_Open_Box(ac_projects_dd_sales, Session.Item("localUser").crmLocalUserID, 8, rep_id, searchCriteria.ViewCriteriaAmodID, "8", "", True)
                                If rep_id > 0 And rep_id < 11111 Then

                                ElseIf rep_id = 11111 Then
                                    'This was throwing an error. There is no selected index 1. Keeping it like this stops the 
                                    'sold survey tab from ever loading
                                    'ac_projects_dd3.SelectedIndex = 1
                                Else
                                    ac_projects_dd_sales.SelectedIndex = 0
                                End If
                                ac_projects_dd_sales.Visible = True
                            ElseIf Not IsPostBack Or ac_projects_dd3.Visible = False Or (Session("Last_Amod") <> searchCriteria.ViewCriteriaAmodID) Then ' move this down to only run like it did before
                                ac_projects_dd3.Items.Clear()
                                Session("Last_Amod") = searchCriteria.ViewCriteriaAmodID
                                ac_projects_dd3.Items.Add(New System.Web.UI.WebControls.ListItem("Standard Recent Sales Summary", 0))
                                Call aclsData_Temp.Fill_Open_Box(ac_projects_dd3, Session.Item("localUser").crmLocalUserID, 8, rep_id, searchCriteria.ViewCriteriaAmodID, "8", "", True)
                                If rep_id > 0 And rep_id < 11111 Then

                                ElseIf rep_id = 11111 Then
                                    'This was throwing an error. There is no selected index 1. Keeping it like this stops the 
                                    'sold survey tab from ever loading
                                    'ac_projects_dd3.SelectedIndex = 1
                                Else
                                    ac_projects_dd3.SelectedIndex = 0
                                End If
                                ac_projects_dd3.Visible = True
                            End If



                            projects_text3.Visible = True
                        End If

                        Dim GraphTable As New DataTable
                        Build_Retail_sales_tab(localCriteria, Me.view_retail_sales_label1, Nothing, Me.check_include_internals2, Me.check_retail_sales, note_id, rep_id, aclsData_Temp, 0, GraphTable)
                        If CRMViewActive Then
                            If rep_id = 0 Or rep_id = 11111 Then
                                If Not IsNothing(GraphTable) Then
                                    If GraphTable.Rows.Count > 0 Then
                                        'Let's graph this:
                                        market_values_top_tab.Visible = True
                                        market_values_top_tab.HeaderText = "Sales Values"
                                        tabs_container.ActiveTab = market_values_top_tab
                                        If Not Session.Item("localPreferences").AerodexFlag Then
                                            System.Web.UI.ScriptManager.RegisterStartupScript(Me.top_tab_update_panel, Me.GetType(), "FillGaugePost", "initGauge_AbsorptionRate();", True)
                                        End If

                                        top_tab_update_panel.Update()
                                        MakeAModelValuesGraph(GraphTable, 2)
                                    End If

                                End If
                            End If
                        End If
                    Else
                        Build_Retail_sales_tab(searchCriteria, view_retail_sales_label1, Nothing, Me.check_include_internals2, Me.check_retail_sales2, 0)
                    End If
                    TabContainer1.ActiveTabIndex = 2

                    If Session("LAST_RUN_OVERALL_TAB_MMS") <> 2 Then
                        EvoRetailSalesIDsCurrent.Text = ""
                    End If

                    Session("LAST_RUN_OVERALL_TAB_MMS") = 2

                Case 3
                    If CRMViewActive Then
                        If Session.Item("localPreferences").UserSPIViewFlag Then
                            build_spi_tab(searchCriteria, view_events_label.Text, "", "MMS", False)
                        End If
                    Else
                        Build_Events_tab(searchCriteria)
                    End If

                    TabContainer1.ActiveTabIndex = 3
                    Session("LAST_RUN_OVERALL_TAB_MMS") = 3

                Case 4
                    Build_News_tab(searchCriteria)
                    TabContainer1.ActiveTabIndex = 4
                Case 5
                    If Not Session.Item("localPreferences").AerodexFlag Then
                        Build_Wanteds_tab(searchCriteria)
                        TabContainer1.ActiveTabIndex = 5
                    End If
                Case 6
                    Build_Financial_Documents_tab(searchCriteria, view_documents_label1.Text)
                    TabContainer1.ActiveTabIndex = 6
                Case 7
                    Build_Operators_tab(searchCriteria, view_operators_label.Text)
                    TabContainer1.ActiveTabIndex = 7
                Case 8
                    Build_Charter_tab(searchCriteria, view_charter_label1.Text)
                    TabContainer1.ActiveTabIndex = 8
                Case 9
                    Build_Lease_tab(searchCriteria, view_lease_label.Text)
                    TabContainer1.ActiveTabIndex = 9
                Case 10
                    If CRMViewActive Then
                        Build_Events_tab(searchCriteria)
                    Else

                        If Session.Item("localPreferences").UserSPIViewFlag Then
                            'If CRMViewActive Then
                            '  build_spi_tab(searchCriteria, Me.view_spi_label.Text, "", "COMPARE_VIEW", false)
                            'Else
                            build_spi_tab(searchCriteria, view_spi_label.Text, "", "MMS", False)
                            'End If
                            TabContainer1.ActiveTabIndex = 10
                        End If
                    End If
                Case 11
                    Build_Location_Tab(searchCriteria, view_location_tab_label.Text)
                    TabContainer1.ActiveTabIndex = 11
                Case 12

                    Build_StarModel_tab(searchCriteria)
                    TabContainer1.ActiveTabIndex = 12
                Case 13

                    Build_Range_tab(searchCriteria)
                    TabContainer1.ActiveTabIndex = 13
                Case 14
                    Build_Fractional_tab(searchCriteria, view_fractional_label.Text)
                    TabContainer1.ActiveTabIndex = 14
                Case 15
                    Build_Flight_tab(searchCriteria)
                    TabContainer1.ActiveTabIndex = 15
            End Select

            If CRMViewActive Or displayEValues Then
                'Using the ID string causes less problems when needing to reorder everything.
                Select Case TabContainer1.ActiveTab.ID.ToString
                    Case "estimates_tab"
                        If CRMViewActive And displayEValues = False Then
                            market_values_top_tab.Visible = True

                            market_values_top_tab.HeaderText = "Estimate Values"
                            BuildEstimates(value_estimates_label, aclsData_Temp)

                            tabs_container.ActiveTab = market_values_top_tab
                            top_tab_update_panel.Update()
                        ElseIf displayEValues Then
                            buildEValuesTab(localCriteria, utilization_functions)
                        End If
                End Select

            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [on_click_load_bottom] : " + ex.Message
        Finally

        End Try
    End Sub

    Public Sub buildCurrentMarketChart(ByVal localCriteria As viewSelectionCriteriaClass, ByVal utilization_functions As utilization_view_functions)
        marketValuesTopTabContainer.Attributes.Remove("class")
        currentMarketEValuesGraph.Text = "<div class=""valueSpec aircraftListing Simplistic aircraftSpec gray_background viewBoxMargin""><div class=""Box marginAutoDiv"">"
        utilization_functions.FillAssettInsightGraphs("CURRENTMARKET", localCriteria.ViewCriteriaAmodID, currentMarketEValuesGraph.Text, top_tab_update_panel, 5, 0, 0, 150, 0, True, True, True, "", "N", "", "", "", "", "", "", "", "", "", "", "", True, True)
        currentMarketEValuesGraph.Text += "</div></div>"
    End Sub

    Public Sub buildEValuesTab(ByVal localCriteria As viewSelectionCriteriaClass, ByVal utilization_functions As utilization_view_functions)
        value_estimates_label.Text = ""
        estimatesMfrYearGraph.Text = "<div class=""valueSpec aircraftListing Simplistic aircraftSpec gray_background viewBoxMargin""><div class=""Box marginAutoDiv""><span class=""subHeader"">" & localCriteria.ViewCriteriaAircraftMake & " " & localCriteria.ViewCriteriaAircraftModel & " VALUES BY DLV YEAR</span>"
        Call utilization_functions.FillAssettInsightGraphs("DLVYEAR", localCriteria.ViewCriteriaAmodID, estimatesMfrYearGraph.Text, bottom_tab_update_panel, 1, 0, 0, 400, 0)
        estimatesMfrYearGraph.Text += "</div>"
        estimatesMonthGraph.Text = "<br clear=""all"" /><div class=""Box marginAutoDiv""><span class=""subHeader"">" & localCriteria.ViewCriteriaAircraftMake & " " & localCriteria.ViewCriteriaAircraftModel & " VALUES BY MONTH</span>"
        Call utilization_functions.FillAssettInsightGraphs("ASKSOLD", localCriteria.ViewCriteriaAmodID, estimatesMonthGraph.Text, bottom_tab_update_panel, 2, 0, 0, 400, 0)
        estimatesMonthGraph.Text += "</div><br clear=""all"" />"

        estimatesAFTTGraph.Text = "<br clear=""all"" /><div class=""Box marginAutoDiv""><span class=""subHeader"">" & localCriteria.ViewCriteriaAircraftMake & " " & localCriteria.ViewCriteriaAircraftModel & " VALUES BY AFTT</span>"
        Call utilization_functions.FillAssettInsightGraphs("AFTT", localCriteria.ViewCriteriaAmodID, estimatesAFTTGraph.Text, bottom_tab_update_panel, 3, 0, 0, 400, 0)
        estimatesAFTTGraph.Text += "</div><br clear=""all"" />"


        estimatesResidualGraph.Text = "<div class=""Box marginAutoDiv""><span class=""subHeader"">" & localCriteria.ViewCriteriaAircraftMake & " " & localCriteria.ViewCriteriaAircraftModel & " RESIDUAL VALUES BY DLV YEAR</span>"
        Call utilization_functions.FillAssettInsightGraphs("RESIDUAL", localCriteria.ViewCriteriaAmodID, estimatesResidualGraph.Text, bottom_tab_update_panel, 4, 0, 0, 500, 0)
        estimatesResidualGraph.Text += "</div></div>"
    End Sub

    Public Sub RetailSalesJavascript(ByVal isProspector As Boolean)
        Dim ScriptBu As String = ""
        Dim ExcelButton As String = ""
        Dim EveryRowScript As String = ""
        Dim ReloadScript As String = ""
        Dim ClearIDScript As String = ""
        Dim ExportOptions As String = ""

        Dim crmClearIDScript As String = ""
        If CRMViewActive Or CRMViewActive = False Then
            EveryRowScript = "var data = dt.rows().column(1).data();"
            If CRMViewActive = False Then
                EveryRowScript += "var IDsToUse ='';"
            Else
                EveryRowScript += "var IDsToUse ='0|CLIENT, 0|JETNET';"
                crmClearIDScript = "$(""#" & IIf(CRMViewActive, SoldSurveyCurrentID.ClientID, EvoRetailSalesIDsCurrent.ClientID) & """).val('');$(""#" & SoldSurveyIdButton.ClientID & """).click();"
            End If

            EveryRowScript += "data.each(function (value, index) {"
            EveryRowScript += " if (IDsToUse.length > 0) {"
            EveryRowScript += " IDsToUse += ', '; "
            EveryRowScript += " }"
            EveryRowScript += "IDsToUse += ' ' + value;"
            EveryRowScript += "});"


            EveryRowScript += "$(""#" & IIf(CRMViewActive, SoldSurveyCurrentID.ClientID, EvoRetailSalesIDsCurrent.ClientID) & """).val(IDsToUse);"

            '  ClearIDScript = "$(""#" & IIf(CRMViewActive, SoldSurveyCurrentID.ClientID, EvoRetailSalesIDsCurrent.ClientID) & """).val('');"
            'EveryRowScript += "$(""#" & SoldSurveyIdButton.ClientID & """).click();ChangeTheMouseCursorOnItemParentDocument('cursor_wait');"

            'ReloadScript = "ChangeTheMouseCursorOnItemParentDocument('cursor_wait');$(""#" & SoldSurveyCurrentID.ClientID & """).val('');"
            'ReloadScript += "$(""#" & SoldSurveyIdButton.ClientID & """).click();"
        End If

        CreateExcelButton(ExcelButton, "RetailsTable")


        ScriptBu += "function CreateRetailsDatatable() {"

        ScriptBu += "var mw =  $('.MaxWidthRemove').width() - 50;"
        ScriptBu += " if (mw <= 0 || isNaN(mw)) {mw = 924;};"

        ScriptBu += "$("".resizeCWRetail"").width(mw); "
        ScriptBu += "$(window).resize(function() {"
        ScriptBu += "var mw = $('.MaxWidthRemove').width() - 50;"
        ScriptBu += "$("".resizeCWRetail"").width(mw);"
        ScriptBu += "});"

        If CRMViewActive = False Then
            ScriptBu += ClearIDScript
        End If
        'Adding this check to destroy a table if one already exists:
        ScriptBu += " if ($.fn.DataTable.isDataTable( '#RetailsTable' ) ) {"
        ScriptBu += "$('#RetailInnerTable').empty();"
        ScriptBu += "};"

        ScriptBu += "if ( $(""#retailSalesCopy"").length ) {"
        ScriptBu += "jQuery(""#retailSalesCopy"").css('display','block');"
        ScriptBu += "var clone = jQuery(""#retailSalesCopy"").clone(true);"
        ScriptBu += "jQuery(""#retailSalesCopy"").css('display','none');"

        ScriptBu += "clone[0].setAttribute('id', 'RetailsTable');"
        ScriptBu += "clone.appendTo(""#RetailInnerTable"");"


        'If CRMViewActive = True Then
        If clsGeneral.clsGeneral.isCrmDisplayMode Then
            ScriptBu += "var hideFromExportRetailTable = [0,1,2,3];"
        Else
            ScriptBu += "var hideFromExportRetailTable = [0,1];"
        End If

        ExportOptions = "columns: [function ( idx, data, node ) {"
        ExportOptions += "var isVisible =retailSalesTableJS.column( idx ).visible();"
        ExportOptions += "var isNotForExport = $.inArray( idx, hideFromExportRetailTable ) !== -1;"
        ExportOptions += "return isVisible && !isNotForExport ? true : false; "
        ExportOptions += "}, 'colvis']"


        ScriptBu += "var retailSalesTableJS = $('#RetailsTable').DataTable({"

        ScriptBu += " destroy: true,"

        If Session.Item("isMobile") Then
            ScriptBu += "responsive: true, "
        Else
            ScriptBu += "scrollX: mw,"
            ScriptBu += "scrollY: 430,"
        End If


        ScriptBu += """initComplete"": function(settings, json) {"
        ScriptBu += "setTimeout(function(){"

        ScriptBu += "$('#RetailsTable').DataTable().columns.adjust();"
        ScriptBu += "$('#RetailsTable').DataTable().fixedColumns().relayout();"
        ScriptBu += "},1200)"
        ScriptBu += "},"


        ' If CRMViewActive Then
        ScriptBu += """infoCallback"": function( settings, start, end, max, total, pre ) {"
        ScriptBu += "return end + "" entries"";"
        ScriptBu += "},"
        ' End If

        If Session.Item("isMobile") = True Then
        Else
            If isProspector Then
                ScriptBu += "fixedColumns: {leftColumns:5} ,"
            Else
                ScriptBu += "fixedColumns: {leftColumns:5} ,"
            End If
        End If

        ScriptBu += "scrollCollapse: true, "
        ScriptBu += " stateSave: true, width:'100%',"
        ScriptBu += "paging: false, "
        ScriptBu += "columnDefs: [ "

        If CRMViewActive = True Then 'And isProspector = True Then
            ScriptBu += " {"
            ScriptBu += "targets: [ 1,2 ],"
            ScriptBu += "className: 'display_none',"
            ScriptBu += "orderable: false"
            ScriptBu += "},"
        Else 'If CRMViewActive Then
            ScriptBu += " {"
            ScriptBu += "targets: [1 " & IIf(clsGeneral.clsGeneral.isCrmDisplayMode, ",2", "") & "],"
            ScriptBu += "className: 'display_none'"
            ScriptBu += "},"

        End If

        If Trim(Request("viewID")) = "1" Or Trim(Request("viewID")) = "11" Then
            If Session.Item("isMobile") Then
                ScriptBu += " { responsivePriority: 1, targets: 0 },"
                ScriptBu += " { responsivePriority: 2, targets: 1 },"
                ScriptBu += " { responsivePriority: 3, targets: 4 },"
                ScriptBu += " { responsivePriority: 4, targets: 5 },"
                ScriptBu += " { responsivePriority: 5, targets: 7 },"
            End If
        End If

        ScriptBu += " {"
        ScriptBu += "targets: [0" & IIf(isProspector, ",3", "") & "],"
        ScriptBu += "orderable: false"
        ScriptBu += "}, "

        If clsGeneral.clsGeneral.isCrmDisplayMode Or CRMViewActive Then
            ScriptBu += " {"
            ScriptBu += "targets: [3],"
            ScriptBu += "orderable: false"
            ScriptBu += "}, "
        End If

        If Session.Item("isMobile") Then
            ScriptBu += "],"
        Else
            ScriptBu += " {"
            ScriptBu += "orderable: false,"
            ScriptBu += "className:  'select-checkbox',"
            ScriptBu += " width: '10px',"
            ScriptBu += "targets:   0"
            ScriptBu += " }"
            ScriptBu += "],"
            ScriptBu += "select: {"
            ScriptBu += "style:    'multi',"
            ScriptBu += "selector: 'td:first-child'"
            ScriptBu += "},"
        End If

        ScriptBu += "dom:        'Bfitrp',"

        'If Trim(Request("ViewID")) = "1" Then
        '  ScriptBu += "order: [[ 1, 'asc' ]],"
        '  ScriptBu += "order: [[ 2, 'asc' ]],"
        '  ScriptBu += "order: [[ 3, 'asc' ]],"
        '  ScriptBu += "order: [[ 4, 'asc' ]],"
        '  ScriptBu += "order: [[ 5, 'asc' ]],"
        '  ScriptBu += "order: [[ 6, 'asc' ]],"
        'Else

        If Trim(Request("ViewID")) = "1" Then
            If clsGeneral.clsGeneral.isCrmDisplayMode() Or CRMViewActive Then
                ScriptBu += "order: [[ 4, 'asc' ]],"
            Else
                ScriptBu += "order: [[ 2, 'asc' ]],"
            End If

        ElseIf isProspector Then
            ScriptBu += "order: [[ 4, 'asc' ]],"
        Else
            ScriptBu += "order: [[ 3, 'asc' ]],"
        End If

        ScriptBu += "buttons: [ "
        If Session.Item("isMobile") Then
        Else

            If Session.Item("localUser").crmDemoUserFlag = True Then
                ScriptBu += " {extend: 'csv', enabled: false , exportOptions : {" & ExportOptions & "}}, "
            Else
                ScriptBu += " {extend: 'csv', exportOptions : {" & ExportOptions & "}}, "
            End If

            'Excel Button
            ScriptBu += Replace(ExcelButton, "columns: ':visible'", ExportOptions)

            'ScriptBu += " {extend: 'excel', exportOptions : {columns: ':visible'}}, "
            'PDF Button
            If Session.Item("localUser").crmDemoUserFlag = True Then
                ScriptBu += " {extend: 'pdf', enabled: false , orientation: 'landscape', pageSize: 'A2', exportOptions : {" & ExportOptions & "}}, "
            Else
                ScriptBu += " {extend: 'pdf', orientation: 'landscape', pageSize: 'A2', exportOptions :{" & ExportOptions & "}}, "
            End If


            'Print Button
            ' ScriptBu += " {extend: 'print', exportOptions : {columns: ':visible'}}, "
            'Column Visibility Button
            ScriptBu += "{"
            ScriptBu += "extend: 'colvis',"
            ScriptBu += " text: 'Columns',"
            ScriptBu += "collectionLayout:  'fixed two-column',"
            ScriptBu += "postfixButtons: [ 'colvisRestore' ]"
            ScriptBu += "},"
            'Remove Selected Button:
            ScriptBu += "{ text:'Remove Selected', "
            ScriptBu += " action: function( e, dt, node, config) { dt.rows( { selected: true } ).remove().draw( false ); " & IIf(((CRMViewActive = True) Or (CRMViewActive = False)), EveryRowScript, "") & "}},"

            ScriptBu += "{ text:'Keep Selected', "
            ScriptBu += " action: function( e, dt, node, config) { dt.rows( { selected: false } ).remove().draw( false );dt.draw();dt.rows('.selected').deselect();" & IIf(((CRMViewActive = True) Or (CRMViewActive = False)), EveryRowScript, "") & "}},"
            ScriptBu += "{ text:'Reload Table', action: function( e, dt, node, config) { $('#RetailInnerTable').empty();CreateRetailsDatatable();RedrawDatatablesOnSys();" & IIf(CRMViewActive = True, crmClearIDScript, "") & IIf(CRMViewActive = False, ClearIDScript, "") & "}}"

            If (CRMViewActive) Then
                'Remove Selected Button:
                ScriptBu += ","
                ScriptBu += "{ text:'Refresh Graph', className: 'openButtonVis', "
                ScriptBu += " action: function( e, dt, node, config) {"
                ScriptBu += "$(""#" & SoldSurveyIdButton.ClientID & """).click();ChangeTheMouseCursorOnItemParentDocument('cursor_wait');}}"
            End If

            'test button
            'If CRMViewActive Then
            Dim OpenButton As String = ""
            OpenButton = CreateOpenButton("CreateRetailsDatatable", "RetailNewWindowContents", "sold")
            ScriptBu += OpenButton
            'End If

        End If

        ScriptBu += "] "

        ScriptBu += " });}"
        ScriptBu += ";}"
        ScriptBu += "$($.fn.dataTable.tables(true)).DataTable().columns.adjust();"
        ScriptBu += "$($.fn.dataTable.tables(true)).DataTable().scroller.measure();"



        System.Web.UI.ScriptManager.RegisterStartupScript(Me, Me.GetType(), "CreateRetailsDatatableFunction", ScriptBu.ToString, True)
    End Sub

    Public Sub ValueEstimateJavascript()
        Dim ScriptBu As String = ""
        Dim ExcelButton As String = ""
        Dim EveryRowScript As String = ""
        EveryRowScript = "var data = dt.rows().column(1).data();"
        EveryRowScript += "var IDsToUse ='';"
        EveryRowScript += "data.each(function (value, index) {"
        EveryRowScript += " if (IDsToUse.length > 0) {"
        EveryRowScript += " IDsToUse += ', '; "
        EveryRowScript += " }"
        EveryRowScript += "IDsToUse += ' ' + value;"
        EveryRowScript += "});"
        EveryRowScript += "$(""#" & valueEstimateCurrentID.ClientID & """).val(IDsToUse);"
        CreateExcelButton(ExcelButton, "ValueEstimateTable")

        ScriptBu += "function CreateValueEstimateDatatable() {"
        'ScriptBu += "$(""#" & valueEstimateCurrentID.ClientID & """).val('');"
        'Adding this check to destroy a table if one already exists:
        ScriptBu += " if ($.fn.DataTable.isDataTable( '#ValueEstimateTable' ) ) {"
        ScriptBu += "$('#ValueEstimateInnerTable').empty();"
        ScriptBu += "};"

        ScriptBu += "if ( $(""#ValueEstimateCopy"").length ) {"
        ScriptBu += "jQuery(""#ValueEstimateCopy"").css('display','block');"
        ScriptBu += "var clone = jQuery(""#ValueEstimateCopy"").clone(true);"
        ScriptBu += "jQuery(""#ValueEstimateCopy"").css('display','none');"

        ScriptBu += "clone[0].setAttribute('id', 'ValueEstimateTable');"
        ScriptBu += "clone.appendTo(""#ValueEstimateInnerTable"");"

        ScriptBu += "$('#ValueEstimateTable').DataTable({"

        ScriptBu += " destroy: true,"
        ScriptBu += " fixedHeader: true, "

        ScriptBu += "scrollX: 960,"
        ScriptBu += "scrollY: 430,"
        ScriptBu += """initComplete"": function(settings, json) {"
        ScriptBu += "setTimeout(function(){"
        ScriptBu += "$('#ValueEstimateTable').DataTable().columns.adjust();"
        ScriptBu += "$('#ValueEstimateTable').DataTable().fixedColumns().relayout();"
        ScriptBu += "},1200)"
        ScriptBu += "},"


        If CRMViewActive Then
            ScriptBu += """infoCallback"": function( settings, start, end, max, total, pre ) {"
            ScriptBu += "return end + "" entries"";"
            ScriptBu += "},"
        End If

        ScriptBu += "fixedColumns: {leftColumns:6} ,"


        ScriptBu += "scrollCollapse: true,"
        ScriptBu += " stateSave: true,"
        ScriptBu += "paging: false, "
        ScriptBu += "columnDefs: [ "
        ScriptBu += " {"
        ScriptBu += "targets: [ 1 ],"
        ScriptBu += "visible: false"
        ScriptBu += "},"
        ScriptBu += " {"
        ScriptBu += "orderable: false,"
        ScriptBu += "className:  'select-checkbox',"
        ScriptBu += " width: '10px',"
        ScriptBu += "targets:   0"
        ScriptBu += " }],"
        ScriptBu += "select: {"
        ScriptBu += "style:    'multi',"
        ScriptBu += "selector: 'td:first-child'"
        ScriptBu += "},"
        ScriptBu += "dom:        'Bfitrp',"


        ScriptBu += "order: [[ 1, 'asc' ]],"


        ScriptBu += "buttons: [ "


        If Session.Item("localUser").crmDemoUserFlag = True Then
            ScriptBu += " {extend: 'csv', enabled: false , exportOptions : {columns: ':visible'}}, "
        Else
            ScriptBu += " {extend: 'csv', exportOptions : {columns: ':visible'}}, "
        End If

        'Excel Button
        ScriptBu += ExcelButton
        'ScriptBu += " {extend: 'excel', exportOptions : {columns: ':visible'}}, "
        'PDF Button
        If Session.Item("localUser").crmDemoUserFlag = True Then
            ScriptBu += " {extend: 'pdf', enabled: false , orientation: 'landscape', pageSize: 'A2', exportOptions : {columns: ':visible'}}, "
        Else
            ScriptBu += " {extend: 'pdf', orientation: 'landscape', pageSize: 'A2', exportOptions : {columns: ':visible'}}, "
        End If



        'Print Button
        ScriptBu += " {extend: 'print', exportOptions : {columns: ':visible'}}, "
        'Column Visibility Button
        ScriptBu += "{"
        ScriptBu += "extend: 'colvis',"
        ScriptBu += "collectionLayout:  'fixed two-column',"
        ScriptBu += "postfixButtons: [ 'colvisRestore' ]"
        ScriptBu += "},"
        'Remove Selected Button:
        ScriptBu += "{ text:'Remove Selected', className: 'RemoveRowsValue', "
        ScriptBu += " action: function( e, dt, node, config) { dt.rows( { selected: true } ).remove().draw( false );"
        'ScriptBu += "var data = dt.rows().column(1).data();"
        'ScriptBu += "var IDsToUse ='';"
        'ScriptBu += "data.each(function (value, index) {"
        'ScriptBu += " if (IDsToUse.length > 0) {"
        'ScriptBu += " IDsToUse += ', '; "
        'ScriptBu += " }"
        'ScriptBu += "IDsToUse += ' ' + value;"
        'ScriptBu += "});"
        'ScriptBu += "$(""#" & valueEstimateCurrentID.ClientID & """).val(IDsToUse);"
        ScriptBu += EveryRowScript
        ' ScriptBu += "$(""#" & RefreshCurrentValueGraph.ClientID & """).click();"

        ScriptBu += "}},"
        ScriptBu += "{ text:'Keep Selected', className: 'KeepSelected', action: function( e, dt, node, config) { dt.rows({ selected: false }).remove().draw(false);" & EveryRowScript & "dt.rows('.selected').deselect();}},"

        ScriptBu += "{ text:'Reload Table', className: 'RefreshTableValue', action: function( e, dt, node, config) {$(""#" & valueEstimateCurrentID.ClientID & """).val('');$(""#" & RefreshCurrentValueGraph.ClientID & """).click();ChangeTheMouseCursorOnItemParentDocument('cursor_wait');"
        '" $('#ValueEstimateInnerTable').empty();CreateValueEstimateDatatable();RedrawDatatablesOnSys();"
        ScriptBu += "}}"


        If (CRMViewActive) Then
            'Remove Selected Button:
            ScriptBu += ","
            ScriptBu += "{ text:'Refresh Graph', className: 'openButtonVis',"
            ScriptBu += " action: function( e, dt, node, config) {"
            ScriptBu += "$(""#" & RefreshCurrentValueGraph.ClientID & """).click();ChangeTheMouseCursorOnItemParentDocument('cursor_wait');}}"
        End If

        'test button
        If CRMViewActive Then
            Dim OpenButton As String = ""
            OpenButton = CreateOpenButton("CreateValueEstimateDatatable", "ValueEstimateNewContents", "value")
            ScriptBu += OpenButton
        End If

        ScriptBu += "] "

        ScriptBu += " });}"
        ScriptBu += ";}"
        ScriptBu += "$($.fn.dataTable.tables(true)).DataTable().columns.adjust();"
        ScriptBu += "$($.fn.dataTable.tables(true)).DataTable().scroller.measure();"

        System.Web.UI.ScriptManager.RegisterStartupScript(Me, Me.GetType(), "CreateValueEstimateDatatableFunction", ScriptBu.ToString, True)
    End Sub
    Private Sub ValueEstimateJSCheck(ByRef removeButton As Boolean, ByRef refreshTable As Boolean, Optional ByVal AdditionalScripts As String = "")
        'If Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CRM Then
        Dim scriptBuOnLoad As String = ""
        Dim ScriptBuPostback As String = ""


        'First we need to check - is this table already initialized?
        'This is important because it doesn't need to be ran twice.

        scriptBuOnLoad = ScriptBuPostback & "CreateValueEstimateDatatable();"
        ScriptBuPostback += "Sys.Application.add_load(function() {CreateValueEstimateDatatable();"
        If removeButton = False Then 'do not show this
            ScriptBuPostback += "$("".RemoveRowsValue"").addClass('display_none');"
        End If
        If refreshTable = False Then 'do not show this
            ScriptBuPostback += "$("".RefreshTableValue"").addClass('display_none');"
        End If
        ScriptBuPostback += AdditionalScripts
        ScriptBuPostback += "ChangeTheMouseCursorOnItemParentDocument('cursor_default standalone_page " & IIf(Session.Item("isMobile"), " lowerLevel", "") & "');});"


        scriptBuOnLoad = "window.onload = function() {" & scriptBuOnLoad & ";RedrawDatatablesOnSys();ChangeTheMouseCursorOnItemParentDocument('cursor_default standalone_page" & IIf(Session.Item("isMobile"), " lowerLevel", "") & "');};"
        System.Web.UI.ScriptManager.RegisterStartupScript(bottom_tab_update_panel, Me.GetType(), "CreateValueEstimateDatatablePostback", ScriptBuPostback.ToString, True)
        System.Web.UI.ScriptManager.RegisterClientScriptBlock(bottom_tab_update_panel, Me.GetType, "CreateValueEstimateDatatableOnLoad", scriptBuOnLoad, True)
    End Sub
    Private Sub RetailSalesJSCheck()
        'If Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CRM Then
        Dim scriptBuOnLoad As String = ""
        Dim ScriptBuPostback As String = ""


        'First we need to check - is this table already initialized?
        'This is important because it doesn't need to be ran twice.

        scriptBuOnLoad = ScriptBuPostback & "CreateRetailsDatatable();"


        ScriptBuPostback += "Sys.Application.add_load(function() {"
        ScriptBuPostback += "setTimeout(function(){CreateRetailsDatatable();},500);" 'TableBuild.ToString"
        ScriptBuPostback += "$(window).resize(function() {"
        ScriptBuPostback += "var mw = $('.MaxWidthRemove').width() - 30;"
        ScriptBuPostback += "$("".resizeCWRetail"").width(mw);"
        ScriptBuPostback += "});"
        ScriptBuPostback += "ChangeTheMouseCursorOnItemParentDocument('cursor_default standalone_page" & IIf(Session.Item("isMobile"), " lowerLevel", "") & "');});"


        scriptBuOnLoad = "window.onload = function() {" & scriptBuOnLoad & ";RedrawDatatablesOnSys();ChangeTheMouseCursorOnItemParentDocument('cursor_default standalone_page" & IIf(Session.Item("isMobile"), " lowerLevel", "") & "');};"
        System.Web.UI.ScriptManager.RegisterStartupScript(bottom_tab_update_panel, Me.GetType(), "CreateRDatatablePostback", ScriptBuPostback.ToString, True)
        System.Web.UI.ScriptManager.RegisterClientScriptBlock(bottom_tab_update_panel, Me.GetType, "CreateRDatatableOnLoad", scriptBuOnLoad, True)
    End Sub
    Public Sub UtilJavascript()
        Dim ScriptBu As String = ""
        Dim ExcelButton As String = ""


        CreateExcelButton(ExcelButton, "flightUtilTable")

        ScriptBu += "function CreateUtilDatatable() {"

        ScriptBu += "var cw =  $('.MaxWidthRemove').width() - 20;"
        ScriptBu += " if (cw <= 0) {cw = 924;};"
        ScriptBu += "$("".resizeCW"").width(cw); "
        ScriptBu += "$(window).resize(function() {"
        ScriptBu += "var cw = $('.MaxWidthRemove').width() - 20;"
        ScriptBu += "$("".resizeCW"").width(cw);"
        ScriptBu += "});"

        ScriptBu += "$('#flightUtilTable').DataTable({"

        ScriptBu += " destroy: true,"
        ScriptBu += " fixedHeader: true, "

        ScriptBu += "scrollX: cw,"
        ScriptBu += "scrollY: 430,"

        ScriptBu += """initComplete"": function(settings, json) {"
        ScriptBu += "setTimeout(function(){"
        ScriptBu += "$('#flightUtilTable').DataTable().columns.adjust();"
        ScriptBu += "$('#flightUtilTable').DataTable().fixedColumns().relayout();"
        ScriptBu += "},1200)"
        ScriptBu += "},"

        ScriptBu += "scrollCollapse: true,"
        ScriptBu += " stateSave: true,"
        ScriptBu += "paging: false, "
        ScriptBu += "columnDefs: [ "
        ScriptBu += "],"

        ScriptBu += "dom: 'Bfitrp',"

        ScriptBu += "order: [[ 0, 'asc' ]],"
        ScriptBu += "buttons: [ "

        If Session.Item("localUser").crmDemoUserFlag = True Then
            ScriptBu += " {extend: 'csv', enabled: false, exportOptions : {columns: ':visible'}}, "
        Else
            ScriptBu += " {extend: 'csv', exportOptions : {columns: ':visible'}}, "
        End If


        'Excel Button
        ScriptBu += ExcelButton
        'PDF Button
        If Session.Item("localUser").crmDemoUserFlag = True Then
            ScriptBu += " {extend: 'pdf', enabled: false, orientation: 'landscape', pageSize: 'A2', exportOptions : {columns: ':visible'}}, "
        Else
            ScriptBu += " {extend: 'pdf', orientation: 'landscape', pageSize: 'A2', exportOptions : {columns: ':visible'}}, "
        End If


        'Column Visibility Button
        ScriptBu += "{"
        ScriptBu += "extend: 'colvis',"
        ScriptBu += " text: 'Columns',"
        ScriptBu += "collectionLayout:  'fixed two-column',"
        ScriptBu += "postfixButtons: [ 'colvisRestore' ]"
        ScriptBu += "}"

        ScriptBu += "] "

        ScriptBu += " });}"

        ScriptBu += "$($.fn.dataTable.tables(true)).DataTable().columns.adjust();"
        ScriptBu += "$($.fn.dataTable.tables(true)).DataTable().scroller.measure();"

        System.Web.UI.ScriptManager.RegisterStartupScript(Me, Me.GetType(), "CreateUtilDatatableFunction", ScriptBu.ToString, True)
    End Sub
    Private Sub UtilizationJSCheck()
        Dim scriptBuOnLoad As String = ""
        Dim ScriptBuPostback As String = ""

        'First we need to check - is this table already initialized?
        'This is important because it doesn't need to be ran twice.

        scriptBuOnLoad = ScriptBuPostback & "CreateUtilDatatable();"
        ScriptBuPostback += "Sys.Application.add_load(function() {CreateUtilDatatable();ChangeTheMouseCursorOnItemParentDocument('cursor_default standalone_page" & IIf(Session.Item("isMobile"), " lowerLevel", "") & "');});"


        scriptBuOnLoad = "window.onload = function() {" & scriptBuOnLoad & ";RedrawDatatablesOnSys();ChangeTheMouseCursorOnItemParentDocument('cursor_default standalone_page" & IIf(Session.Item("isMobile"), " lowerLevel", "") & "');};"
        System.Web.UI.ScriptManager.RegisterStartupScript(bottom_tab_update_panel, Me.GetType(), "CreateUDatatablePostback", ScriptBuPostback.ToString, True)
        System.Web.UI.ScriptManager.RegisterClientScriptBlock(bottom_tab_update_panel, Me.GetType, "CreateUDatatableOnLoad", scriptBuOnLoad, True)
    End Sub

    Private Sub MakeAModelValuesGraph(ByVal DataToGraph As DataTable, ByVal GraphType As Integer)
        '1 is current
        '2 is sold
        Dim EstHeader As String = "Est Value"
        Dim first_field As String = "ac_take_price"
        Dim second_field As String = "sold_price"
        If GraphType = 2 Then
            EstHeader = "Sold Value"
            first_field = "ac_sold_price"
            second_field = "ac_take_price"
        End If
        Dim MapString As String = ""
        Dim CRMRow As Boolean = False
        Dim RowsString As String = ""
        MapString += "   drawValueChart();"
        MapString += "function drawValueChart() {"
        MapString += "var valData = new google.visualization.DataTable();"

        If (CRMViewActive And HttpContext.Current.Session.Item("localSubscription").crmSalesPriceIndex_Flag = True) Or (HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag = True) Then
            MapString += "valData.addColumn('string', 'Serial#');  "
            MapString += "valData.addColumn('number', 'Asking');  "

            MapString += "valData.addColumn('number', '" & EstHeader & "');  "
            MapString += "valData.addColumn('number', 'Take');  "
        Else
            MapString += "valData.addColumn('string', 'Serial#');  "
            MapString += "valData.addColumn('number', 'Asking');  "

            If CRMViewActive Then
                MapString += "valData.addColumn('number', '" & EstHeader & "');  "
                MapString += "valData.addColumn('number', 'Take');  "
            End If
        End If

        If Not IsNothing(DataToGraph) Then
            If DataToGraph.Rows.Count > 0 Then


                MapString += "valData.addRows(["

                For Each r As DataRow In DataToGraph.Rows
                    Dim displayData As Integer = 0
                    CRMRow = False

                    If CRMViewActive Then
                        If r("source") = "CLIENT" Then
                            CRMRow = True
                        End If
                    End If
                    Dim ItemString As String = ""
                    If RowsString <> "" Then
                        ItemString += ","
                    End If
                    ItemString += "["

                    'The first 2 rows show no matter what. They are Ser/ask:

                    If GraphType = 2 Then
                        If Not IsDBNull(r.Item("journ_date")) Then
                            ItemString += "'" & r.Item("journ_date")
                        End If
                        ItemString += "("
                    Else
                        ItemString += "'"
                    End If
                    If Not IsDBNull(r.Item("ac_ser_no_full")) Then
                        ItemString += r.Item("ac_ser_no_full")  'Serial
                    Else
                        ItemString += "null,"
                    End If
                    If GraphType = 2 Then
                        ItemString += ")',"
                    Else
                        ItemString += "',"
                    End If

                    If Not IsDBNull(r.Item("ac_asking_price")) Then
                        If r.Item("ac_asking_price") > 0 Then
                            ItemString += (CDbl(r.Item("ac_asking_price").ToString) / 1000).ToString & "" 'Asking #
                            displayData += 1
                        Else
                            ItemString += "null"
                        End If
                    Else
                        ItemString += "null"
                    End If

                    'The next two rows only show depending.
                    'They show if the SPI flag is on:
                    'They ALSO show if CRM Is active and it's a CRM Row.
                    If ((HttpContext.Current.Session.Item("localSubscription").crmSalesPriceIndex_Flag = True) Or (CRMViewActive And CRMRow = True)) Then
                        If Not IsDBNull(r.Item(first_field)) Then
                            If r.Item(first_field) > 0 Then
                                ItemString += "," & (CDbl(r.Item(first_field).ToString) / 1000).ToString & "," 'Take
                                displayData += 1
                            Else
                                ItemString += "," & "null,"
                            End If
                        Else
                            ItemString += "," & "null,"
                        End If
                        If CRMViewActive Then
                            If Not IsDBNull(r.Item(second_field)) Then
                                If r.Item(second_field) > 0 Then
                                    ItemString += (CDbl(r.Item(second_field).ToString) / 1000).ToString & "" 'sold Price
                                    displayData += 1
                                Else
                                    ItemString += "null"
                                End If
                            Else
                                ItemString += "null"
                            End If

                        End If
                    Else
                        If CRMViewActive Then
                            'We need to pass these rows as null:
                            ItemString += ",null, null"
                        End If
                    End If


                    ItemString += "]"

                    If displayData > 0 Then
                        RowsString += ItemString
                    End If
                Next

                MapString += RowsString & "]);"

            End If
        End If


        MapString += "var valOptions = {'title':'','width':560,'height':230,legend: { position: 'right', textStyle:{fontSize:'11'}},curveType:  'function',colors: ['blue', 'red', 'green','blue', 'red', 'green'], 'chartArea': {top:5}, hAxis: { textStyle:{fontSize:'9'}, slantedText:true, slantedTextAngle:70},vAxis: { title: 'Aircraft Value ($k)'} , series: {    0: { lineWidth: 0, pointSize: 3  } ,  1: { lineWidth: 0, pointSize: 3  } ,  2: { lineWidth: 0, pointSize: 3  } ,  3: { lineWidth: 0, pointSize: 7,  pointShape: 'star', visibleInLegend: false  } ,  4: { lineWidth: 0, pointSize: 7,  pointShape: 'star', visibleInLegend: false  } ,  5: { lineWidth: 0, pointSize: 7,  pointShape: 'star', visibleInLegend: false  }  } };"
        MapString += "var valChart = new google.visualization.LineChart(document.getElementById('valChart'));"
        MapString += "valChart.draw(valData, valOptions);"
        MapString += "}"


        'testtestest.Text = MapString
        System.Web.UI.ScriptManager.RegisterStartupScript(Me.top_tab_update_panel, Me.GetType, "refreshValGraphs", "" & MapString & ";", True)

    End Sub

    Public Sub CreateExcelButton(ByRef ExcelButton As String, ByVal PanelName As String)
        Dim PlaceholderString As String = ""

        ExcelButton = "var panel = document.getElementById(""" & PanelName & """);"
        ExcelButton += "my_form = document.createElement('FORM');"
        ExcelButton += "my_form.name = 'myForm';"
        ExcelButton += "my_form.method = 'POST';"
        ExcelButton += "my_form.action = 'MacShell.aspx';"
        ExcelButton += "my_form.target = '_new';"
        ExcelButton += " my_tb = document.createElement('INPUT');"
        ExcelButton += "my_tb.type = 'HIDDEN';"
        ExcelButton += "my_tb.name = 'MacExport';"
        ExcelButton += "my_tb.value = true;"
        ExcelButton += "my_form.appendChild(my_tb);"

        ExcelButton += " my_tb = document.createElement('INPUT');"
        ExcelButton += "my_tb.type = 'HIDDEN';"
        ExcelButton += "my_tb.name = 'data';"
        ExcelButton += "my_tb.value = escape(panel.innerHTML);"
        ExcelButton += "my_form.appendChild(my_tb);"
        ExcelButton += " document.body.appendChild(my_form);"
        ExcelButton += "  my_form.submit();"

        If Session.Item("localUser").crmDemoUserFlag = True Then
            If Not IsNothing(Session.Item("localUser").crmPlatformOS) Then
                If Not String.IsNullOrEmpty(Session.Item("localUser").crmPlatformOS) Then
                    If InStr(Session.Item("localUser").crmPlatformOS, "mac") > 0 Then
                        'PlaceholderString += ", { text:'Excel', "
                        'PlaceholderString += " action: function( e, dt, node, config) {" & ExcelButton & "}},"
                    Else
                        PlaceholderString += " {extend: 'excel', enabled: false, messageBottom: null, messageTop: null, title: null, exportOptions : {columns: ':visible'}}, "
                    End If
                Else
                    PlaceholderString += " {extend: 'excel', enabled: false, messageBottom: null, messageTop: null,  title: null, exportOptions : {columns: ':visible'}}, "
                End If
            Else
                PlaceholderString += " {extend: 'excel', enabled: false, messageBottom: null, messageTop: null, title: null, exportOptions : {columns: ':visible'}}, "
            End If
        Else
            If Not IsNothing(Session.Item("localUser").crmPlatformOS) Then
                If Not String.IsNullOrEmpty(Session.Item("localUser").crmPlatformOS) Then
                    If InStr(Session.Item("localUser").crmPlatformOS, "mac") > 0 Then
                        PlaceholderString += ", { text:'Excel', "
                        PlaceholderString += " action: function( e, dt, node, config) {" & ExcelButton & "}},"
                    Else
                        PlaceholderString += " {extend: 'excel', messageBottom: null, messageTop: null, title: null, exportOptions : {columns: ':visible'}}, "
                    End If
                Else
                    PlaceholderString += " {extend: 'excel', messageBottom: null, messageTop: null,  title: null,exportOptions : {columns: ':visible'}}, "
                End If
            Else
                PlaceholderString += " {extend: 'excel', messageBottom: null, messageTop: null,  title: null,exportOptions : {columns: ':visible'}}, "
            End If
        End If







        ExcelButton = PlaceholderString
    End Sub

    Private Sub CheckAndJSForDatatable()
        'If Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CRM Then
        Dim scriptBuOnLoad As String = ""
        Dim ScriptBuPostback As String = ""


        'First we need to check - is this table already initialized?
        'This is important because it doesn't need to be ran twice.

        'scriptBuOnLoad = ScriptBuPostback & "CreateTheDatatable();" ';RedrawDatatablesOnSys();" 
        'ScriptBuPostback += "Sys.Application.add_load(function() {CreateTheDatatable();RedrawDatatablesOnSys();});"

        Call make_script_bu_load_postback("", scriptBuOnLoad, ScriptBuPostback)

        If Trim(Request("viewID")) = "26" Then
            Call make_script_bu_load_postback("2", scriptBuOnLoad, ScriptBuPostback)
            Call make_script_bu_load_postback("3", scriptBuOnLoad, ScriptBuPostback)
            Call make_script_bu_load_postback("4", scriptBuOnLoad, ScriptBuPostback)
        End If

        'Close postback script tag/added code to measure scrollbar/columns for table since tab swap will make the table need it.


        'Added to OnLoad variable on purposes before last close of tag, not needed because the window onLoad is a little different.


        scriptBuOnLoad = "window.onload = function() {" & scriptBuOnLoad & ";" & IIf(CRMViewActive, "ChangeTheMouseCursorOnItemParentDocument('cursor_default standalone_page" & IIf(Session.Item("isMobile"), " lowerLevel", "") & "');", "") & "};"
        System.Web.UI.ScriptManager.RegisterStartupScript(bottom_tab_update_panel, Me.GetType(), "CreateDatatablePostback", ScriptBuPostback.ToString, True)
        System.Web.UI.ScriptManager.RegisterClientScriptBlock(bottom_tab_update_panel, Me.GetType, "CreateDatatableOnLoad", scriptBuOnLoad, True)
        'End If

    End Sub
    Public Sub make_script_bu_load_postback(ByVal num_spot As String, ByRef scriptBuOnLoad As String, ByRef ScriptBuPostback As String)

        scriptBuOnLoad = ScriptBuPostback & "CreateTheDatatable" & Trim(num_spot) & "();" ';RedrawDatatablesOnSys();" 
        ScriptBuPostback += "Sys.Application.add_load(function() {CreateTheDatatable" & Trim(num_spot) & "();RedrawDatatablesOnSys" & Trim(num_spot) & "()" & IIf(CRMViewActive, ";ChangeTheMouseCursorOnItemParentDocument('cursor_default standalone_page" & IIf(Session.Item("isMobile"), " lowerLevel", "") & "')", "") & ";});"

    End Sub
    Protected Sub views_range_search_IATA_ICAO_AIRPORT()

        Dim AirportData As New DataTable
        Dim AirportLocation As String = ""
        Dim begin_display_text As String = ""
        Dim end_display_text As String = ""
        Dim First_Model_Array As Array = Nothing
        Dim Second_Model_Array As Array = Nothing

        Try

            If Not IsNothing(range_search_text) Then
                If Not String.IsNullOrEmpty(range_search_text.Text.Trim) Then
                    If range_search_text.Text.Trim.Length <= 4 Then
                        If range_search_text.Text.Trim.Length = 3 Then
                            localCriteria.ViewCriteriaAirportIATA = range_search_text.Text.Trim
                        Else
                            localCriteria.ViewCriteriaAirportICAO = range_search_text.Text.Trim
                        End If
                    Else
                        localCriteria.ViewCriteriaAirportName = range_search_text.Text.Trim
                    End If
                End If
            End If

            AirportData = localDatalayer.get_range_airports_by_IATA_or_ICAO(localCriteria, 0)
            Call localDatalayer.find_range_by_model(localCriteria)

            begin_display_text = "<hr class='hr' /><h1>Chart Information</h1><table width='100%' cellpadding='4' cellspacing='0'>"
            begin_display_text += "<tr style='background-color:" + First_Color_RGB + "; color:#000000 !important; font-weight:bold;'><td align='left' valign='top'>" + commonEvo.Get_Aircraft_Model_Info(localCriteria.ViewCriteriaAmodID, False, "") + "<br /><img src='images/spacer.gif' alt='' width='60' height='1' /></td>"

            Select Case CInt(localCriteria.ViewCriteriaAirframeType)
                Case Constants.VIEW_HELICOPTERS
                    Amod_model_ac_range = ConversionFunctions.ConvertNauticalMileToMeter(localCriteria.ViewCriteriaHeliRangeTanksFull)
                    begin_display_text += "<td align='left' valign='top'><em>Range (nm):</em> " + localCriteria.ViewCriteriaHeliRangeTanksFull.ToString + "</td></tr>"
                    'localCriteria.ViewCriteriaHeliRangeSeatsFull
                Case Else
                    Amod_model_ac_range = ConversionFunctions.ConvertNauticalMileToMeter(localCriteria.ViewCriteriaAircraftRange)
                    begin_display_text += "<td align='left' valign='top'><em>Range (nm):</em> " + localCriteria.ViewCriteriaAircraftRange.ToString + "</td></tr>"
            End Select

            If Not IsNothing(AirportData) Then
                If AirportData.Rows.Count > 0 Then
                    AirportLocation = AirportData.Rows(0).Item("aport_city").ToString
                    If Not IsDBNull(AirportData.Rows(0).Item("aport_state")) Then
                        If Not String.IsNullOrEmpty(AirportData.Rows(0).Item("aport_state")) Then
                            AirportLocation += ", " + AirportData.Rows(0).Item("aport_state").ToString
                        End If
                    End If
                    AirportLocation += " " + AirportData.Rows(0).Item("aport_country").ToString

                    localCriteria.ViewCriteriaAirportName = AirportLocation

                    If Not IsDBNull(AirportData.Rows(0).Item("aport_name")) Then
                        end_display_text += "<tr class='alt_row'><td align='left' valign='top'>Airport Name:</td><td align='left' valign='top'>" + AirportData.Rows(0).Item("aport_name").ToString + "</td></tr>"
                    End If

                    end_display_text += "<tr><td align='left' valign='top'>Location:</td><td align='left' valign='top'>"

                    If Not IsDBNull(AirportData.Rows(0).Item("aport_city")) Then
                        end_display_text += AirportData.Rows(0).Item("aport_city").ToString + " "
                    End If

                    If Not IsDBNull(AirportData.Rows(0).Item("aport_state")) Then
                        end_display_text += AirportData.Rows(0).Item("aport_state").ToString + ", "
                    End If

                    If Not IsDBNull(AirportData.Rows(0).Item("aport_country")) Then
                        end_display_text += AirportData.Rows(0).Item("aport_country").ToString
                    End If

                    end_display_text += "</td></tr>"
                    end_display_text += "<tr class='alt_row'><td align='left' valign='top'>Coordinates:</td><td align='left' valign='top'>"

                    If Not IsDBNull(AirportData.Rows(0).Item("aport_latitude_decimal")) Then
                        end_display_text += AirportData.Rows(0).Item("aport_latitude_decimal").ToString
                        localCriteria.ViewCriteriaAirportLatitude = AirportData.Rows(0).Item("aport_latitude_decimal").ToString
                    End If

                    If Not IsDBNull(AirportData.Rows(0).Item("aport_longitude_decimal")) Then
                        end_display_text += ", " + AirportData.Rows(0).Item("aport_longitude_decimal").ToString
                        localCriteria.ViewCriteriaAirportLongitude = AirportData.Rows(0).Item("aport_longitude_decimal").ToString
                    End If
                    end_display_text += "</td></tr></table><hr class='hr' />"

                    If Not IsNothing(first_model) Then
                        First_Model_Array = Split(first_model.SelectedValue, "|")
                    End If
                    If UBound(First_Model_Array) > 0 Then
                        If first_model.SelectedValue <> "" Then
                            localCriteria.ViewCriteriaSecondAmodID = CLng(First_Model_Array(0).ToString)
                            begin_display_text += "<tr style='background-color:" + Second_Color_RGB + "; color:#000000 !important; font-weight:bold;'><td align='left' valign='top'>" + first_model.SelectedItem.Text + "</td>"
                            begin_display_text += "<td align='left' valign='top'><em>Range (nm): </em> " + ConversionFunctions.ConvertMeterToNauticalMile(CDbl(First_Model_Array(1).ToString)).ToString + "</td></tr>"

                        End If
                    End If

                    'second model/optional display for range and marker
                    If Not IsNothing(second_model) Then
                        Second_Model_Array = Split(second_model.SelectedValue, "|")
                    End If
                    If UBound(Second_Model_Array) > 0 Then
                        If second_model.SelectedValue <> "" Then
                            localCriteria.ViewCriteriaThirdAmodID = CLng(Second_Model_Array(0).ToString)
                            begin_display_text += "<tr style='background-color:" + Third_Color_RGB + "; color:#000000 !important; font-weight:bold;'><td align='left' valign='top'>" + second_model.SelectedItem.Text + "</td>"
                            begin_display_text += "<td align='left' valign='top'><em>Range (nm): </em> " + ConversionFunctions.ConvertMeterToNauticalMile(CDbl(Second_Model_Array(1).ToString)).ToString + "</td></tr>"
                        End If
                    End If

                    airport_information.Text = begin_display_text + end_display_text
                    airport_information_label_large.Text = begin_display_text + end_display_text

                    bClickedRange = True

                    sRangeTabScriptID = "range_tab_map_script"
                    sRangeTabScript = "$(document).ready(function(){build_range_tab_map('" + localCriteria.ViewCriteriaAirportName + "', " + localCriteria.ViewCriteriaAirportLatitude.ToString + ", " + localCriteria.ViewCriteriaAirportLongitude.ToString + ", " + Amod_model_ac_range.ToString + ");});" + vbCrLf

                Else
                    airport_information.Text = "<p class=""error_text"">No applicable airport with acceptable maximum runway length found.</p>"
                End If
            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [views_range_search_IATA] : " + ex.Message
        End Try

    End Sub

    Public Shared Sub fillRangeDropDowns(ByRef MyDropDownControl As DropDownList, ByRef maxWidth As Long, ByVal inAmodID As String, ByVal bIsForSale As Boolean)

        Dim results_table As New DataTable

        Dim fAmod_make_name As String = ""
        Dim fAmod_model_name As String = ""
        Dim fAmod_id As String = ""
        Dim fAmod_max_range_miles As String = ""
        Dim fAmod_range_tanks_full As String = ""
        Dim fAmod_range_seats_full As String = ""
        Dim fAmod_airframe_type_code As String = ""

        Dim sMakeModelName As String = ""

        Dim sTmpRange As String = ""
        Dim sTmpValue As String = ""

        MyDropDownControl.Items.Clear()

        If String.IsNullOrEmpty(inAmodID) Then
            inAmodID = "-1"
        End If

        Try

            results_table = commonEvo.Get_MakesModels_ByProductCode(bIsForSale)

            If Not IsNothing(results_table) Then

                If results_table.Rows.Count > 0 Then

                    MyDropDownControl.Items.Add(New ListItem("", ""))

                    For Each r As DataRow In results_table.Rows

                        If Not (IsDBNull(r("amod_make_name"))) Then
                            fAmod_make_name = r.Item("amod_make_name").ToString
                        End If

                        If Not (IsDBNull(r("amod_model_name"))) Then
                            fAmod_model_name = r.Item("amod_model_name").ToString
                        End If

                        If Not (IsDBNull(r("amod_id"))) Then
                            fAmod_id = r.Item("amod_id").ToString
                        End If

                        If Not (IsDBNull(r("amod_max_range_miles"))) Then
                            fAmod_max_range_miles = r.Item("amod_max_range_miles").ToString
                        End If

                        If Not (IsDBNull(r("amod_range_tanks_full"))) Then
                            fAmod_range_tanks_full = r.Item("amod_range_tanks_full").ToString
                        End If

                        If Not (IsDBNull(r("amod_range_seats_full"))) Then
                            fAmod_range_seats_full = r.Item("amod_range_seats_full").ToString
                        End If

                        If Not (IsDBNull(r("amod_airframe_type_code"))) Then
                            fAmod_airframe_type_code = r.Item("amod_airframe_type_code").ToString.ToUpper
                        End If

                        sMakeModelName = fAmod_make_name.Trim + " / " + fAmod_model_name.Trim

                        If (sMakeModelName.Length * Constants._STARTCHARWIDTH) > maxWidth Then
                            maxWidth = (sMakeModelName.Length * Constants._STARTCHARWIDTH)
                        End If

                        Select Case fAmod_airframe_type_code
                            Case Constants.AMOD_ROTARY_AIRFRAME
                                sTmpRange = ConversionFunctions.ConvertNauticalMileToMeter(CDbl(fAmod_range_tanks_full)).ToString
                                'sTmpRange = ConversionFunctions.ConvertNauticalMileToMeter(fAmod_range_seats_full)
                            Case Else
                                sTmpRange = ConversionFunctions.ConvertNauticalMileToMeter(CDbl(fAmod_max_range_miles)).ToString
                        End Select

                        sTmpValue = fAmod_id.Trim + "|" + sTmpRange.Trim
                        MyDropDownControl.Items.Add(New ListItem(sMakeModelName, sTmpValue))

                        If (CLng(fAmod_id) = CLng(inAmodID)) Then
                            MyDropDownControl.SelectedValue = sTmpValue
                        End If

                    Next

                    MyDropDownControl.Width = (maxWidth)

                End If
            End If

        Catch ex As Exception

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [fillRangeDropDowns] : " + ex.Message

        Finally


        End Try


    End Sub

    Function forSaleViewTranslateStatus(ByVal in_StrToTranslate)

        Select Case (UCase(in_StrToTranslate))

            Case "MAKE OFFER"
                forSaleViewTranslateStatus = "M/O"
            Case "SHARE"
                forSaleViewTranslateStatus = "Share"
            Case "LEASE"
                forSaleViewTranslateStatus = "LS"
            Case "FOR SALE/LEASE"
                forSaleViewTranslateStatus = "FS/LS"
            Case "SALE/LEASE"
                forSaleViewTranslateStatus = "FS/LS"
            Case "LEASE ONLY"
                forSaleViewTranslateStatus = "LS/O"
            Case "SEALED BID"
                forSaleViewTranslateStatus = "BID"
            Case "TRADE"
                forSaleViewTranslateStatus = "TRD"
            Case "FOR SALE/TRADE"
                forSaleViewTranslateStatus = "FS/TRD"
            Case "SALE/TRADE"
                forSaleViewTranslateStatus = "FS/TRD"
            Case "SALE/SHARE"
                forSaleViewTranslateStatus = "FS/SH"
            Case "FOR SALE/SHARE"
                forSaleViewTranslateStatus = "FS/SH"
            Case "NO ENGINES"
                forSaleViewTranslateStatus = "NO/ENG"
            Case "AUCTION"
                forSaleViewTranslateStatus = "AUC"
            Case "UNCONFIRMED"
                forSaleViewTranslateStatus = "UNC"
            Case "CONFIDENTIAL"
                forSaleViewTranslateStatus = "CONF"
            Case "SALE PENDING"
                forSaleViewTranslateStatus = "SP"
            Case Else
                forSaleViewTranslateStatus = UCase(in_StrToTranslate)

        End Select

    End Function

    Function Get_Quarter_Select(ByVal in_Quarter) As String
        Get_Quarter_Select = ""

        Select Case (in_Quarter)
            Case "Q1"
                Get_Quarter_Select = cAndClause & "(month(journ_date) >= 1 and month(journ_date) <= 3)"
            Case "Q2"
                Get_Quarter_Select = cAndClause & "(month(journ_date) > 3 and month(journ_date) <= 6)"
            Case "Q3"
                Get_Quarter_Select = cAndClause & "(month(journ_date) > 6 and month(journ_date) <= 9)"
            Case "Q4"
                Get_Quarter_Select = cAndClause & "(month(journ_date) > 9 and month(journ_date) <= 12)"
        End Select

    End Function

    Function Get_Quarter_For_Month_Server(ByVal in_Month) As String
        Get_Quarter_For_Month_Server = ""
        Select Case (CInt(in_Month))

            Case 1, 2, 3
                Get_Quarter_For_Month_Server = "Q1"
            Case 4, 5, 6
                Get_Quarter_For_Month_Server = "Q2"
            Case 7, 8, 9
                Get_Quarter_For_Month_Server = "Q3"
            Case 10, 11, 12
                Get_Quarter_For_Month_Server = "Q4"

        End Select

    End Function

    Function Get_FirstMonth_For_Quarter_Server(ByVal in_Quarter) As String
        Get_FirstMonth_For_Quarter_Server = ""

        Select Case (in_Quarter)

            Case "Q1"
                Get_FirstMonth_For_Quarter_Server = 1
            Case "Q2"
                Get_FirstMonth_For_Quarter_Server = 4
            Case "Q3"
                Get_FirstMonth_For_Quarter_Server = 7
            Case "Q4"
                Get_FirstMonth_For_Quarter_Server = 10

        End Select

    End Function

    Function ReturnDefaultSummaryRange_Server(ByVal sTimeScale)

        Select Case (sTimeScale)
            Case "Years"
                ReturnDefaultSummaryRange_Server = 5
            Case "Months"
                ReturnDefaultSummaryRange_Server = 6
            Case "Days"
                ReturnDefaultSummaryRange_Server = 15
            Case "Quarters"
                ReturnDefaultSummaryRange_Server = 4
            Case Else
                ReturnDefaultSummaryRange_Server = 6
        End Select

    End Function

    Function ReturnTotalRange_Server(ByVal sTimeScale)

        Select Case (sTimeScale)
            Case "Years"
                ReturnTotalRange_Server = 10
            Case "Months"
                ReturnTotalRange_Server = 12
            Case "Days"
                ReturnTotalRange_Server = 31
            Case "Quarters"
                ReturnTotalRange_Server = 12
            Case Else
                ReturnTotalRange_Server = 12
        End Select

    End Function

    Function InString(ByVal inBigString() As String, ByVal inSubString As String)
        Dim tmpString() As String

        InString = False

        If Trim(inBigString.ToString) = "" Then
            InString = False
            Exit Function
        End If

        tmpString = Split(inBigString.ToString, ",")
        For I = LBound(tmpString) To UBound(tmpString)
            If Trim(inSubString) = Trim(tmpString(I)) Then
                InString = True
                Exit Function
            End If
        Next

    End Function

    Public Function GetAircraftPictures_For_CRM_VIEW(ByVal ac_id As Long, ByVal journ_id As Long, ByVal amod_make_name As String, ByVal amod_model_name As String, ByVal ser_no As String) As String

        Dim fAcpic_image_type As String = ""
        Dim fAcpic_id As String = ""
        Dim fAcpic_subject As String = ""
        Dim imgDisplayFolder As String = ""
        Dim theImgFile As String = ""
        Dim picture_counter As Integer = 0
        Dim javascript_slideshow_begining As String = ""
        Dim javascript_slideshow_ending As String = ""
        Dim PictureTable As New DataTable
        Dim sQuery As String = ""
        Dim htmlOut As StringBuilder = New StringBuilder()
        Dim view_all_pictures As String = ""
        Dim first_picture As String = ""
        Dim aclsData_Temp As New clsData_Manager_SQL
        ' Try
        aclsData_Temp.JETNET_DB = Application.Item("crmClientSiteData").AdminDatabaseConn

        PictureTable = aclsData_Temp.GetJETNET_AC_pictures(ac_id, journ_id)

        htmlOut.Append("<table cellspacing='0' cellpadding='0' width='100%'>")
        htmlOut.Append("<tr><td align='left' valign='top'>")
        If Not IsNothing(PictureTable) Then
            If PictureTable.Rows.Count > 0 Then
                'view all pictures button is relevant

                view_all_pictures = "<img src=""images/view_all_pictures.png"" onclick=""javascript:SubmitTransactionDocumentForm('" & amod_make_name & "','" & amod_model_name & "','" & ser_no & "'," & ac_id & "," & journ_id & ",'');""  alt=""View all Pictures"" class=""spec_image"" width=""125""/>"


                If Not (IsDBNull(PictureTable.Rows(0).Item("acpic_image_type"))) Then
                    If Not String.IsNullOrEmpty(PictureTable.Rows(0).Item("acpic_image_type").ToString) Then
                        fAcpic_image_type = PictureTable.Rows(0).Item("acpic_image_type").ToString.ToLower.Trim
                    End If
                End If

                If Not (IsDBNull(PictureTable.Rows(0).Item("acpic_id"))) Then
                    If Not String.IsNullOrEmpty(PictureTable.Rows(0).Item("acpic_id").ToString) Then
                        fAcpic_id = PictureTable.Rows(0).Item("acpic_id").ToString.Trim
                    End If
                End If

                If Not (IsDBNull(PictureTable.Rows(0).Item("acpic_subject"))) Then
                    If Not String.IsNullOrEmpty(PictureTable.Rows(0).Item("acpic_subject").ToString) Then
                        fAcpic_subject = PictureTable.Rows(0).Item("acpic_subject").ToString.Trim
                    End If
                End If



                If fAcpic_image_type.Contains("jpg") Then
                    ' MJM - New Path Added 9/04
                    imgDisplayFolder = HttpContext.Current.Session.Item("jetnetFullHostName").ToString.Trim + Session.Item("AircraftPicturesFolderVirtualPath")
                    If Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then
                        imgDisplayFolder = "https://www.testjetnetevolution.com/pictures/aircraft/"
                    End If

                    'imgDisplayFolder = Application.Item("crmClientSiteData").ClientFullHostName + Session.Item("AircraftPicturesFolderVirtualPath").ToString
                    theImgFile = imgDisplayFolder + "/" + ac_id.ToString + Constants.cHyphen + journ_id.ToString + Constants.cHyphen + fAcpic_id + Constants.cDot + fAcpic_image_type

                    picture_counter = 1

                    first_picture = ("<img border=""0"" src=""" + imgDisplayFolder + "/" + ac_id.ToString + Constants.cHyphen + journ_id.ToString + Constants.cHyphen + fAcpic_id + Constants.cDot + fAcpic_image_type + """ Title=""" + fAcpic_subject + """ alt=""" + fAcpic_subject + """  width=""205"" style=""padding-bottom:3px;"" />")

                End If

            End If

        End If

        ' End If

        PictureTable = New DataTable

        Return first_picture

    End Function

    Public Shared Sub IterateThroughChildren(ByVal parent As Control, ByVal tabPanelID As String, ByRef Query_Class_Array As System.Collections.ArrayList)
        Try
            Dim OperatorChosen As String = ""
            For Each c As Control In parent.Controls
                If TypeOf c Is TextBox Then
                    Dim temporaryTextBox As TextBox = c
                    Dim comparedIDString As String = "COMPARE_" & c.ID.ToString

                    If foundChild.ID.ToString = comparedIDString Then
                        If foundChild.SelectedValue <> "" Then
                            OperatorChosen = foundChild.SelectedValue
                        End If
                        'Testing, setting the operator in session
                        If Not IsNothing(HttpContext.Current.Session.Item("Advanced-" & comparedIDString)) Then
                            If Not String.IsNullOrEmpty(HttpContext.Current.Session.Item("Advanced-" & comparedIDString)) Then
                                HttpContext.Current.Session.Item("Advanced-" & comparedIDString) = OperatorChosen
                            End If
                        Else
                            If OperatorChosen <> "" And temporaryTextBox.Text <> "" Then
                                HttpContext.Current.Session.Item("Advanced-" & comparedIDString) = OperatorChosen
                            End If
                        End If
                    End If

                    If temporaryTextBox.Text <> "" Then
                        If OperatorChosen <> "" Then

                            Dim QueryData As New AdvancedQueryResults
                            QueryData.CommasAsDelimiters = True
                            QueryData.FieldName = temporaryTextBox.ID 'Ar(2).ToString
                            QueryData.OperatorChoice = OperatorChosen.ToString
                            QueryData.DataType = temporaryTextBox.ValidationGroup 'Ar(0).ToString
                            QueryData.SearchValue = clsGeneral.clsGeneral.StripChars(temporaryTextBox.Text, False) 'added in a special check to remove some special characters.

                            If UCase(tabPanelID) = "COMPANY/CONTACT" Then
                                QueryData.CompanyContactSearch = True
                            End If

                            'This has been added in
                            'Almost as a check.
                            'What it's going to do is this:
                            'If the data type is either numeric, date or year
                            'it is going to check and see if you have a : in your statement
                            'if you have an : in your statement
                            'it's going to force you to use a BETWEEN.
                            If UCase(QueryData.DataType) = "DATE" Or UCase(QueryData.DataType) = "NUMERIC" Or UCase(QueryData.DataType) = "YEAR" Then
                                If InStr(QueryData.SearchValue, ":") > 0 Or InStr(QueryData.SearchValue, ";") > 0 Then
                                    QueryData.OperatorChoice = "Between"
                                End If
                            End If

                            'Note: In search fields where we use a between and we recommend a ":" and we still just recommend the “:” but also handle as ";" in case they mistype?
                            If UCase(QueryData.OperatorChoice) = "BETWEEN" Then
                                QueryData.SearchValue = Replace(Trim(temporaryTextBox.Text), ";", ":") '.ToString
                            End If

                            QueryData.FieldDisplay = temporaryTextBox.ToolTip
                            QueryData.SpecialConsideration = False
                            If temporaryTextBox.ID = "comp_name" Then 'this is a special case in which we have to look and see if the alt name has been set to true.
                                If search_alt_comp_name Then
                                    QueryData.SpecialConsideration = True
                                End If
                            End If
                            'This is a special case on the engine tab where you either check the do not include overdue or not.
                            If temporaryTextBox.ID = "engine_ac_hours" Then
                                If DoNotIncludeOverdue Then
                                    QueryData.SpecialConsideration = True
                                End If
                            End If

                            Query_Class_Array.Add(QueryData)

                        End If
                    End If
                    'Testing
                    If Not IsNothing(HttpContext.Current.Session.Item("Advanced-" & temporaryTextBox.ID)) Then
                        If Not String.IsNullOrEmpty(HttpContext.Current.Session.Item("Advanced-" & temporaryTextBox.ID)) Then
                            HttpContext.Current.Session.Item("Advanced-" & temporaryTextBox.ID) = temporaryTextBox.Text
                        End If
                    Else
                        If temporaryTextBox.Text <> "" Then
                            HttpContext.Current.Session.Item("Advanced-" & temporaryTextBox.ID) = temporaryTextBox.Text
                        End If
                    End If

                    temporaryTextBox.Dispose()
                ElseIf TypeOf c Is CheckBox Then
                    'There are two checkbox fields that we care about on the company advanced search/engine page.
                    Dim temporaryCheckbox As CheckBox = c
                    'If temporaryCheckbox.Checked Then
                    If temporaryCheckbox.ID = "comp_alt_name" Then
                        search_alt_comp_name = temporaryCheckbox.Checked 'True
                    End If
                    If temporaryCheckbox.ID = "EngineNoOverdue" Then
                        DoNotIncludeOverdue = temporaryCheckbox.Checked 'True
                    End If
                    If temporaryCheckbox.ID = "comp_not_in_selected" Then
                        DoNotIncludeRelationships = temporaryCheckbox.Checked ' True
                    End If
                    ' End If

                    HttpContext.Current.Session.Item("Advanced-" & temporaryCheckbox.ID) = temporaryCheckbox.Checked.ToString

                ElseIf TypeOf c Is ListBox Then
                    'These are the company advanced search listboxes. 

                    Dim TemporaryListbox As ListBox = c
                    Dim SelectedString As String = ""
                    SelectedString = clsGeneral.clsGeneral.ExtractSelectedStringFromListboxDropdown(TemporaryListbox, True, 0, False)
                    OperatorChosen = "Equals"
                    If Not IsNothing(HttpContext.Current.Session.Item("Advanced-" & TemporaryListbox.ID)) Then
                        If Not String.IsNullOrEmpty(HttpContext.Current.Session.Item("Advanced-" & TemporaryListbox.ID)) Then
                            HttpContext.Current.Session.Item("Advanced-" & TemporaryListbox.ID) = Replace(Replace(SelectedString, "'", ""), ",", "##")
                        End If
                    Else
                        If OperatorChosen <> "" And SelectedString <> "" Then
                            HttpContext.Current.Session.Item("Advanced-" & TemporaryListbox.ID) = Replace(Replace(SelectedString, "'", ""), ",", "##")
                        End If
                    End If

                    If SelectedString <> "" Then

                        Dim QueryData As New AdvancedQueryResults
                        QueryData.CommasAsDelimiters = True
                        QueryData.FieldName = TemporaryListbox.ID
                        QueryData.OperatorChoice = OperatorChosen.ToString
                        QueryData.DataType = TemporaryListbox.ValidationGroup


                        If UCase(tabPanelID) = "COMPANY/CONTACT" Then
                            QueryData.CompanyContactSearch = True
                        End If

                        'Time to loop through listbox to get values.
                        QueryData.SearchValue = SelectedString
                        QueryData.FieldDisplay = TemporaryListbox.ToolTip

                        If TemporaryListbox.ID = "cref_contact_type" Then
                            If DoNotIncludeRelationships Then
                                QueryData.SpecialConsideration = True
                            End If
                        End If

                        Query_Class_Array.Add(QueryData)
                    End If

                ElseIf TypeOf c Is DropDownList Then
                    Dim temporaryDropdownList As DropDownList = c
                    Dim comparedIDString As String = "COMPARE_" & c.ID.ToString

                    If Not IsNothing(foundChild.ID) Then
                        If foundChild.ID.ToString = comparedIDString Then

                            If foundChild.SelectedValue <> "" Then
                                OperatorChosen = foundChild.SelectedValue
                            End If

                            'Setting the operator in session
                            If Not IsNothing(HttpContext.Current.Session.Item("Advanced-" & comparedIDString)) Then
                                If Not String.IsNullOrEmpty(HttpContext.Current.Session.Item("Advanced-" & comparedIDString)) Then
                                    HttpContext.Current.Session.Item("Advanced-" & comparedIDString) = OperatorChosen
                                End If
                            Else
                                If OperatorChosen <> "" And temporaryDropdownList.Text.ToString <> "" Then
                                    HttpContext.Current.Session.Item("Advanced-" & comparedIDString) = OperatorChosen
                                End If
                            End If


                            If temporaryDropdownList.SelectedValue <> "" Then
                                If OperatorChosen <> "" Then

                                    Dim QueryData As New AdvancedQueryResults
                                    QueryData.CommasAsDelimiters = False
                                    QueryData.FieldName = temporaryDropdownList.ID 'Ar(2).ToString
                                    QueryData.OperatorChoice = OperatorChosen.ToString
                                    QueryData.DataType = temporaryDropdownList.ValidationGroup 'Ar(0).ToString
                                    QueryData.SearchValue = temporaryDropdownList.SelectedValue 'temporaryDropdownList.Text.ToString
                                    QueryData.FieldDisplay = temporaryDropdownList.ToolTip

                                    If UCase(tabPanelID) = "COMPANY/CONTACT" Then
                                        QueryData.CompanyContactSearch = True
                                    End If

                                    HttpContext.Current.Session.Item("Advanced-" & temporaryDropdownList.ID) = temporaryDropdownList.SelectedValue 'temporaryDropdownList.Text.ToString
                                    Query_Class_Array.Add(QueryData)

                                End If

                            End If

                            'Testing
                            If Not IsNothing(HttpContext.Current.Session.Item("Advanced-" & temporaryDropdownList.ID)) Then
                                If Not String.IsNullOrEmpty(HttpContext.Current.Session.Item("Advanced-" & temporaryDropdownList.ID)) Then
                                    HttpContext.Current.Session.Item("Advanced-" & temporaryDropdownList.ID) = temporaryDropdownList.Text.ToString
                                End If
                            Else
                                If temporaryDropdownList.Text.ToString <> "" Then
                                    HttpContext.Current.Session.Item("Advanced-" & temporaryDropdownList.ID) = temporaryDropdownList.Text.ToString
                                End If
                            End If

                            temporaryDropdownList.Dispose()
                        Else
                            foundChild = c
                        End If
                    Else
                        foundChild = c
                    End If

                End If

                If TypeOf c Is DropDownList Then
                    foundChild = c
                End If

                If c.Controls.Count > 0 Then
                    IterateThroughChildren(c, tabPanelID, Query_Class_Array)
                End If
            Next
        Catch ex As Exception
            ' Master.LogError(System.Reflection.MethodInfo.GetCurrentMethod().ToString & " (" & ErrorReportingTypeString & "):  " & ex.Message)
        End Try

    End Sub

    Private Sub build_location_tab_datatable(ByRef searchCriteria As viewSelectionCriteriaClass, ByRef out_htmlString As String, ByRef locationDataTable As DataTable)

        Dim htmlOut As New StringBuilder
        Dim htmlLocationStateProvince As String = ""
        Dim htmlLocationCountry As String = ""
        Dim htmlLocationContinent As String = ""
        Dim htmlLocationCity As String = ""
        Dim htmlLocationAC As String = ""

        Dim location_functions As New location_view_functions

        Try

            location_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            location_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            location_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            location_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            location_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

            If CRMViewActive Then
                htmlOut.Append("&nbsp;&nbsp;" + JetnetSourceText)
            End If

            htmlOut.Append("<table id=""locationViewDataTable"" width=""100%"" cellpadding=""4"" cellspacing=""0""><tr><td align=""center"" valign=""top"" width=""100%"">")

            If searchCriteria.ViewCriteriaLocationViewSort = Constants.LOCATION_SORT_CONTINENT Then

                location_functions.views_display_location_continent(searchCriteria, htmlLocationContinent, locationDataTable, bHasMaster)
                htmlOut.Append(htmlLocationContinent)

            ElseIf searchCriteria.ViewCriteriaLocationViewSort = Constants.LOCATION_SORT_COUNTRY Then

                location_functions.views_display_location_country(searchCriteria, htmlLocationCountry, locationDataTable, bHasMaster)
                htmlOut.Append(htmlLocationCountry)

            ElseIf searchCriteria.ViewCriteriaLocationViewSort = Constants.LOCATION_SORT_STATE Then

                location_functions.views_display_location_state_prov(searchCriteria, htmlLocationStateProvince, locationDataTable, "", bHasMaster)
                htmlOut.Append(htmlLocationStateProvince)

                'locationDataTable.Rows.Clear()
                ' this is so we r re-getting the information with the city info included 
                ' re- run it getting city so that it makes the map - added MSW - 1/31/19
                '   location_functions.views_display_location_state_prov(searchCriteria, htmlLocationStateProvince, locationDataTable, "City")

            ElseIf searchCriteria.ViewCriteriaLocationViewSort = Constants.LOCATION_SORT_CITY Then

                location_functions.views_display_location_city(searchCriteria, htmlLocationCity, locationDataTable, bHasMaster)
                htmlOut.Append(htmlLocationCity)

            ElseIf searchCriteria.ViewCriteriaLocationViewSort = Constants.LOCATION_SORT_AIRCRAFT Then

                location_functions.views_display_location_aircraft(searchCriteria, htmlLocationAC, locationDataTable, "", bHasMaster)
                htmlOut.Append(htmlLocationAC)

                location_functions.views_display_location_aircraft(searchCriteria, htmlLocationAC, locationDataTable, "City", bHasMaster)

            End If


            htmlOut.Append("</td></tr></table>")

            location_functions = Nothing

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [Build_Location_Tab_SortTable] : " + ex.Message
        Finally

        End Try

        out_htmlString = htmlOut.ToString()
        htmlOut = Nothing

    End Sub

    Private Sub build_location_standalone(ByRef searchCriteria As viewSelectionCriteriaClass, ByRef out_htmlString As String)

        Dim htmlOut As New StringBuilder
        Dim zoom_level As String = "4"
        Dim htmlLocationList As String = ""

        Dim center_map_table As DataTable = Nothing
        Dim location_map_lat_long_table As DataTable = Nothing
        Dim display_location_lable As String = ""

        Dim previous_city As String = ""
        Dim bHadCity As Boolean = False
        Dim sRefLink As String = ""

        Dim location_functions As New location_view_functions
        Dim sOutputScript As String = ""

        Dim view_latitude As String = ""
        Dim view_longitude As String = ""

        Dim loop_latitude As String = ""
        Dim loop_longitude As String = ""
        Dim re_load_drop As Boolean = True


        viewTabContainer.Visible = False
        Try

            location_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            location_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            location_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            location_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            location_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

            If Trim(last_selected_zoom.Text) = "" Then

            ElseIf Trim(last_selected_zoom.Text) <> view_location_display_by.Text Then ' if the zoon level has changed since the last post, since we havent re-loaded the box yet, it must be have been clicked
                re_load_drop = False
            End If

            If re_load_drop = True Then

                view_location_display_by.Items.Clear()

                If Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaCity.ToString.Trim) Then

                    view_location_display_by.Items.Add(New ListItem("Aircraft", Constants.LOCATION_SORT_AIRCRAFT))
                    view_location_display_by.SelectedValue = Constants.LOCATION_SORT_AIRCRAFT.ToString
                    zoom_level = "8"

                ElseIf Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaState.ToString.Trim) Then

                    view_location_display_by.Items.Add(New ListItem("City", Constants.LOCATION_SORT_CITY))
                    view_location_display_by.Items.Add(New ListItem("Aircraft", Constants.LOCATION_SORT_AIRCRAFT))

                    If searchCriteria.ViewCriteriaLocationViewSort = Constants.LOCATION_SORT_CITY Then
                        view_location_display_by.SelectedValue = Constants.LOCATION_SORT_CITY.ToString
                    Else
                        view_location_display_by.SelectedValue = Constants.LOCATION_SORT_AIRCRAFT.ToString
                    End If

                    zoom_level = "5"

                ElseIf Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaCountry.ToString.Trim) Then

                    If localCriteria.ViewCriteriaAmodID > -1 Then
                        view_location_display_by.Items.Add(New ListItem("Aircraft", Constants.LOCATION_SORT_AIRCRAFT))
                    End If

                    If searchCriteria.ViewCriteriaCountryHasStates Or view_location_display_by.SelectedValue.Contains(Constants.LOCATION_SORT_STATE.ToString) Then

                        view_location_display_by.Items.Add(New ListItem("State", Constants.LOCATION_SORT_STATE))
                        view_location_display_by.Items.Add(New ListItem("City", Constants.LOCATION_SORT_CITY))
                        view_location_display_by.SelectedValue = Constants.LOCATION_SORT_STATE.ToString

                    Else

                        view_location_display_by.Items.Add(New ListItem("City", Constants.LOCATION_SORT_CITY))
                        view_location_display_by.SelectedValue = Constants.LOCATION_SORT_CITY.ToString

                    End If

                    zoom_level = "4"

                ElseIf Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaContinent.ToString.Trim) Then

                    view_location_display_by.Items.Add(New ListItem("Country", Constants.LOCATION_SORT_COUNTRY))

                    If searchCriteria.ViewCriteriaCountryHasStates Then
                        view_location_display_by.Items.Add(New ListItem("State", Constants.LOCATION_SORT_STATE))
                    End If

                    view_location_display_by.Items.Add(New ListItem("City", Constants.LOCATION_SORT_CITY))
                    view_location_display_by.SelectedValue = Constants.LOCATION_SORT_COUNTRY.ToString

                    zoom_level = "4"

                Else

                    view_location_display_by.Items.Add(New ListItem("Continent", Constants.LOCATION_SORT_CONTINENT))
                    view_location_display_by.SelectedValue = Constants.LOCATION_SORT_CONTINENT.ToString

                    zoom_level = "2"

                End If
            End If

            view_location_label_display_by.Visible = True
            view_location_display_by.Visible = True

            view_location_clear_list.Visible = True

            last_selected_zoom.Text = view_location_display_by.Text

            searchCriteria.ViewCriteriaLocationViewSort = CInt(view_location_display_by.SelectedValue)

            build_location_tab_datatable(searchCriteria, htmlLocationList, location_map_lat_long_table)
            htmlOut.Append(htmlLocationList)

            If (Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaCountry.Trim) _
                Or Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaState.Trim) _
                Or Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaCity.Trim)) Then

                ' get the lat and long for the center of the map
                center_map_table = location_functions.get_location_map_center(searchCriteria)

                If Not IsNothing(center_map_table) Then
                    If center_map_table.Rows.Count > 0 Then
                        For Each r As DataRow In center_map_table.Rows

                            If Not IsDBNull(r.Item("map_latitude")) Then
                                If Not String.IsNullOrEmpty(r.Item("map_latitude").ToString.Trim) Then
                                    view_latitude = r.Item("map_latitude").ToString
                                End If
                            End If

                            If Not IsDBNull(r.Item("map_longitude")) Then
                                If Not String.IsNullOrEmpty(r.Item("map_longitude").ToString.Trim) Then
                                    view_longitude = r.Item("map_longitude").ToString
                                End If
                            End If

                            Exit For

                        Next
                    End If
                End If

                center_map_table = Nothing
                sOutputScript = ""
                ' on view can just RegisterStartupScript each script
                ' center map on the "country"
                System.Web.UI.ScriptManager.RegisterStartupScript(Me.viewOuterPanel, Me.GetType(), "location_view_map_center_script", "$(document).ready(function(){center_location_view_map(" + view_latitude + ", " + view_longitude + ", " + zoom_level + ");});" + vbCrLf, True)




                If Not IsNothing(location_map_lat_long_table) Then
                    If location_map_lat_long_table.Rows.Count > 0 Then

                        For Each r As DataRow In location_map_lat_long_table.Rows

                            loop_latitude = ""
                            loop_longitude = ""

                            ' add all the "markers" for each location item
                            sRefLink = ""
                            sRefLink = "view_template.aspx?ViewID=" + searchCriteria.ViewID.ToString + "&ViewName=" + searchCriteria.ViewName.Trim
                            sRefLink += "&onLocationTab=" + IIf(searchCriteria.ViewID < 2, "true", "false")
                            sRefLink += "&amod_id=" + searchCriteria.ViewCriteriaAmodID.ToString & IIf(bHasMaster = False, "&noMaster=false", "")

                            If Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaContinent.Trim) Then
                                sRefLink += "&viewContinent=" + HttpContext.Current.Server.UrlEncode(searchCriteria.ViewCriteriaContinent.Trim)
                            Else
                                sRefLink += "&viewContinent="
                            End If

                            If searchCriteria.ViewCriteriaLocationViewType <> Constants.LOCATION_VIEW_BASE Then

                                If Not IsDBNull(r.Item("comp_country")) Then
                                    If Not String.IsNullOrEmpty(r.Item("comp_country").ToString.Trim) Then

                                        sRefLink += "&viewCountry=" + HttpContext.Current.Server.UrlEncode(r.Item("comp_country").ToString.Trim)

                                        If r.Item("comp_country").ToString.Trim.ToLower.Contains("united states") Then
                                            display_location_lable = "USA"
                                        Else
                                            display_location_lable = r.Item("comp_country").ToString.Trim
                                        End If
                                    Else
                                        sRefLink += "&viewCountry="
                                    End If
                                Else
                                    sRefLink += "&viewCountry="
                                End If

                                If searchCriteria.ViewCriteriaCountryHasStates And r.Table.Columns.Contains("state_name") Then

                                    If Not IsDBNull(r.Item("state_name")) Then
                                        If Not String.IsNullOrEmpty(r.Item("state_name").ToString.Trim) Then
                                            display_location_lable += " - " + r.Item("state_name").ToString.Trim
                                            sRefLink += "&viewState=" + HttpContext.Current.Server.UrlEncode(r.Item("state_name").ToString.Trim)
                                        End If
                                    End If

                                Else
                                    sRefLink += "&viewState="
                                End If



                                If Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaCity.ToString.Trim) Then
                                    If Not IsDBNull(r.Item("comp_city")) Then
                                        If Not String.IsNullOrEmpty(r.Item("comp_city").ToString.Trim) Then
                                            display_location_lable += " - " + r.Item("comp_city").ToString.Trim
                                            bHadCity = True
                                        End If
                                    End If
                                ElseIf Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaState.ToString.Trim) Then
                                    If Not IsDBNull(r.Item("comp_city")) Then
                                        If Not String.IsNullOrEmpty(r.Item("comp_city").ToString.Trim) Then
                                            display_location_lable += " - " + r.Item("comp_city").ToString.Trim
                                            bHadCity = True
                                        End If
                                    End If
                                ElseIf Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaCountry.ToString.Trim) Then
                                    display_location_lable = display_location_lable
                                End If

                            Else

                                If Not IsDBNull(r.Item("ac_aport_country")) Then
                                    If Not String.IsNullOrEmpty(r.Item("ac_aport_country").ToString.Trim) Then

                                        sRefLink += "&viewCountry=" + HttpContext.Current.Server.UrlEncode(r.Item("ac_aport_country").ToString.Trim)

                                        If r.Item("ac_aport_country").ToString.Trim.ToLower.Contains("united states") Then
                                            display_location_lable = "USA"
                                        Else
                                            display_location_lable = r.Item("ac_aport_country").ToString.Trim
                                        End If
                                    Else
                                        sRefLink += "&viewCountry="
                                    End If
                                Else
                                    sRefLink += "&viewCountry="
                                End If

                                If searchCriteria.ViewCriteriaCountryHasStates And r.Table.Columns.Contains("state_name") Then

                                    If Not IsDBNull(r.Item("state_name")) Then
                                        If Not String.IsNullOrEmpty(r.Item("state_name").ToString.Trim) Then
                                            display_location_lable += " - " + r.Item("state_name").ToString.Trim
                                            sRefLink += "&viewState=" + HttpContext.Current.Server.UrlEncode(r.Item("state_name").ToString.Trim)
                                        End If
                                    End If

                                Else
                                    sRefLink += "&viewState="
                                End If

                                If Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaCity.ToString.Trim) Then
                                    If Not IsDBNull(r.Item("ac_aport_city")) Then
                                        If Not String.IsNullOrEmpty(r.Item("ac_aport_city").ToString.Trim) Then
                                            display_location_lable += " - " + r.Item("ac_aport_city").ToString.Trim
                                            bHadCity = True
                                        End If
                                    End If
                                ElseIf Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaState.ToString.Trim) Then
                                    If Not IsDBNull(r.Item("ac_aport_city")) Then
                                        If Not String.IsNullOrEmpty(r.Item("ac_aport_city").ToString.Trim) Then
                                            display_location_lable += " - " + r.Item("ac_aport_city").ToString.Trim
                                            bHadCity = True
                                        End If
                                    End If
                                ElseIf Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaCountry.ToString.Trim) Then
                                    display_location_lable = display_location_lable
                                End If



                            End If

                            If Not IsDBNull(r.Item("tlatitude")) Then
                                If Not String.IsNullOrEmpty(r.Item("tlatitude").ToString.Trim) Then
                                    loop_latitude = r.Item("tlatitude").ToString
                                End If
                            End If

                            If Not IsDBNull(r.Item("tlongitude")) Then
                                If Not String.IsNullOrEmpty(r.Item("tlongitude").ToString.Trim) Then
                                    loop_longitude = r.Item("tlongitude").ToString
                                End If
                            End If

                            If Not String.IsNullOrEmpty(loop_latitude) And Not String.IsNullOrEmpty(loop_longitude) Then

                                If Not bHadCity And searchCriteria.ViewCriteriaLocationViewSort <> Constants.LOCATION_SORT_CITY Then

                                    sRefLink += "&viewCity="

                                    If r.Table.Columns.Contains("tcount") Then
                                        sOutputScript += "$(document).ready(function(){add_location_view_marker('" + display_location_lable.Trim + "'," + loop_latitude + ", " + loop_longitude + ", " + r.Item("tcount").ToString + ", '" + sRefLink + "', view_map);});" + vbCrLf
                                    Else
                                        sOutputScript += "$(document).ready(function(){add_location_view_marker('" + display_location_lable.Trim + "'," + loop_latitude + ", " + loop_longitude + ", -1, '" + sRefLink + "', view_map);});" + vbCrLf
                                    End If

                                Else

                                    If searchCriteria.ViewCriteriaLocationViewType <> Constants.LOCATION_VIEW_BASE Then
                                        If Not previous_city.Trim.ToLower.Contains(r.Item("comp_city").ToString.Trim.ToLower) Then

                                            sRefLink += "&viewCity=" + HttpContext.Current.Server.UrlEncode(r.Item("comp_city").ToString.Trim)

                                            If r.Table.Columns.Contains("tcount") Then
                                                sOutputScript += "$(document).ready(function(){add_location_view_marker('" + display_location_lable.Trim + "'," + loop_latitude + ", " + loop_longitude + ", " + r.Item("tcount").ToString + ", '" + sRefLink + "', view_map);});" + vbCrLf
                                            Else
                                                sOutputScript += "$(document).ready(function(){add_location_view_marker('" + display_location_lable.Trim + "'," + loop_latitude + ", " + loop_longitude + ", -1, '" + sRefLink + "', view_map);});" + vbCrLf
                                            End If

                                            previous_city += r.Item("comp_city").ToString.Trim + ":"
                                        End If
                                    Else

                                        sRefLink += "&viewCity=" + HttpContext.Current.Server.UrlEncode(r.Item("ac_aport_city").ToString.Trim)

                                        If Not previous_city.Trim.ToLower.Contains(r.Item("ac_aport_city").ToString.Trim.ToLower) Then
                                            If r.Table.Columns.Contains("tcount") Then
                                                sOutputScript += "$(document).ready(function(){add_location_view_marker('" + display_location_lable.Trim + "'," + loop_latitude + ", " + loop_longitude + ", " + r.Item("tcount").ToString + ", '" + sRefLink + "', view_map);});" + vbCrLf
                                            Else
                                                sOutputScript += "$(document).ready(function(){add_location_view_marker('" + display_location_lable.Trim + "'," + loop_latitude + ", " + loop_longitude + ", -1, '" + sRefLink + "', view_map);});" + vbCrLf
                                            End If

                                            previous_city += r.Item("ac_aport_city").ToString.Trim + ":"
                                        End If

                                    End If

                                End If ' not had city

                            End If ' have to have a lat/long to plot city ...

                        Next ' r As DataRow In location_map_lat_long_table.Rows

                        System.Web.UI.ScriptManager.RegisterStartupScript(Me.viewOuterPanel, Me.GetType(), "location_view_map_marker_script", sOutputScript, True)

                    End If ' location_map_lat_long_table.Rows.Count > 0 

                Else

                    ' on view can just RegisterStartupScript each script for the marker
                    ' add all the "markers" for each location item
                    ' just display map with current selection variables
                    sRefLink = "view_template.aspx?ViewID=" + searchCriteria.ViewID.ToString + "&ViewName=" + searchCriteria.ViewName.Trim
                    sRefLink += "&onLocationTab=" + IIf(searchCriteria.ViewID < 2, "true", "false")
                    sRefLink += "&viewCountry=" + IIf(Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaCountry.Trim), HttpContext.Current.Server.UrlEncode(searchCriteria.ViewCriteriaCountry.Trim), "")
                    sRefLink += "&viewCity=" + IIf(Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaCity.Trim), HttpContext.Current.Server.UrlEncode(searchCriteria.ViewCriteriaCity.Trim), "")
                    sRefLink += "&viewContinent=" + IIf(Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaContinent.Trim), HttpContext.Current.Server.UrlEncode(searchCriteria.ViewCriteriaContinent.Trim), "")
                    sRefLink += "&viewState=" + IIf(Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaState.Trim), HttpContext.Current.Server.UrlEncode(searchCriteria.ViewCriteriaState.Trim), "")
                    sRefLink += "&amod_id=" + IIf(searchCriteria.ViewCriteriaAmodID > -1, searchCriteria.ViewCriteriaAmodID.ToString, "") & IIf(bHasMaster = False, "&noMaster=false", "")

                    sOutputScript = "$(document).ready(function(){add_location_view_marker('" + searchCriteria.ViewCriteriaCountry.Trim + "'," + view_latitude + ", " + view_longitude + ", 0, '" + sRefLink + "', view_map);});" + vbCrLf

                    System.Web.UI.ScriptManager.RegisterStartupScript(Me.viewOuterPanel, Me.GetType(), "location_view_map_marker_script", sOutputScript, True)
                End If '  Not IsNothing(location_map_lat_long_table)

            Else ' city or state or country are "non-blank"

                ' Continent is "empty" 
                If String.IsNullOrEmpty(searchCriteria.ViewCriteriaContinent.Trim) Then

                    ' on view can just RegisterStartupScript each script  
                    ' center on (0,0) just for a place to start

                    System.Web.UI.ScriptManager.RegisterStartupScript(Me.viewOuterPanel, Me.GetType(), "location_view_map_center_script", "$(document).ready(function(){center_location_view_map(0, 0, 2);});" + vbCrLf, True)

                    If Not IsNothing(location_map_lat_long_table) Then
                        If location_map_lat_long_table.Rows.Count > 0 Then

                            For Each r As DataRow In location_map_lat_long_table.Rows

                                sRefLink = "view_template.aspx?ViewID=" + searchCriteria.ViewID.ToString + "&ViewName=" + searchCriteria.ViewName.Trim
                                sRefLink += "&onLocationTab=" + IIf(searchCriteria.ViewID < 2, "true", "false")
                                sRefLink += "&amod_id=" + searchCriteria.ViewCriteriaAmodID.ToString & IIf(bHasMaster = False, "&noMaster=false", "")
                                sRefLink += "&viewCountry="
                                sRefLink += "&viewState="
                                sRefLink += "&viewCity="

                                Select Case r.Item("country_continent_name").ToString.ToLower.Trim

                                    Case "africa"  '0.2136714,16.98485

                                        sRefLink += "&viewContinent=" + HttpContext.Current.Server.UrlEncode(r.Item("country_continent_name").ToString.Trim)

                                        view_latitude = "0.2136714"
                                        view_longitude = "16.98485"

                                        ' on view can just RegisterStartupScript each script
                                        sOutputScript += "$(document).ready(function(){add_location_view_marker('" + r.Item("country_continent_name").ToString.Trim + "'," + view_latitude + ", " + view_longitude + ", " + r.Item("tcount").ToString + ", '" + sRefLink + "', view_map);});" + vbCrLf

                                    Case "asia"     ' 29,100

                                        sRefLink += "&viewContinent=" + HttpContext.Current.Server.UrlEncode(r.Item("country_continent_name").ToString.Trim)

                                        view_latitude = "29"
                                        view_longitude = "100"

                                        ' on view can just RegisterStartupScript each script
                                        sOutputScript += "$(document).ready(function(){add_location_view_marker('" + r.Item("country_continent_name").ToString.Trim + "'," + view_latitude + ", " + view_longitude + ", " + r.Item("tcount").ToString + ", '" + sRefLink + "', view_map);});" + vbCrLf

                                    Case "europe" ' 49.5,22

                                        sRefLink += "&viewContinent=" + HttpContext.Current.Server.UrlEncode(r.Item("country_continent_name").ToString.Trim)

                                        view_latitude = "49.5"
                                        view_longitude = "22"

                                        ' on view can just RegisterStartupScript each script
                                        sOutputScript += "$(document).ready(function(){add_location_view_marker('" + r.Item("country_continent_name").ToString.Trim + "'," + view_latitude + ", " + view_longitude + ", " + r.Item("tcount").ToString + ", '" + sRefLink + "', view_map);});" + vbCrLf

                                    Case "north america" '37.5,-110

                                        sRefLink += "&viewContinent=" + HttpContext.Current.Server.UrlEncode(r.Item("country_continent_name").ToString.Trim)

                                        view_latitude = "37.5"
                                        view_longitude = "-110"

                                        ' on view can just RegisterStartupScript each script
                                        sOutputScript += "$(document).ready(function(){add_location_view_marker('" + r.Item("country_continent_name").ToString.Trim + "'," + view_latitude + ", " + view_longitude + ", " + r.Item("tcount").ToString + ", '" + sRefLink + "', view_map);});" + vbCrLf

                                    Case "south america" '-21.7351043,-63.28125

                                        sRefLink += "&viewContinent=" + HttpContext.Current.Server.UrlEncode(r.Item("country_continent_name").ToString.Trim)

                                        view_latitude = "-21.7351043"
                                        view_longitude = "-63.28125"

                                        sOutputScript += "$(document).ready(function(){add_location_view_marker('" + r.Item("country_continent_name").ToString.Trim + "'," + view_latitude + ", " + view_longitude + ", " + r.Item("tcount").ToString + ", '" + sRefLink + "', view_map);});" + vbCrLf

                                End Select

                            Next ' Each r As DataRow In location_map_lat_long_table.Rows

                            ' on view can just RegisterStartupScript each script
                            System.Web.UI.ScriptManager.RegisterStartupScript(Me.viewOuterPanel, Me.GetType(), "location_view_map_marker_script", sOutputScript, True)

                        End If ' location_map_lat_long_table.Rows.Count > 0 
                    Else
                        ' on view can just RegisterStartupScript each script
                        'Setting up the default options for the map (default to center on world) 
                        System.Web.UI.ScriptManager.RegisterStartupScript(Me.viewOuterPanel, Me.GetType(), "location_view_map_script", "$(document).ready(function(){initialize_view_map();});" + vbCrLf, True)
                    End If '  Not IsNothing(location_map_lat_long_table)

                Else ' Continent is "non-blank"

                    Select Case searchCriteria.ViewCriteriaContinent.ToLower.Trim

                        Case "africa"  '0.2136714,16.98485

                            view_latitude = "0.2136714"
                            view_longitude = "16.98485"

                            ' on view can just RegisterStartupScript each script
                            System.Web.UI.ScriptManager.RegisterStartupScript(Me.viewOuterPanel, Me.GetType(), "location_view_map_center_script", "$(document).ready(function(){center_location_view_map(" + view_latitude + ", " + view_longitude + ", 3);});" + vbCrLf, True)

                        Case "asia"     ' 29,100

                            view_latitude = "29"
                            view_longitude = "100"

                            ' on view can just RegisterStartupScript each script
                            System.Web.UI.ScriptManager.RegisterStartupScript(Me.viewOuterPanel, Me.GetType(), "location_view_map_center_script", "$(document).ready(function(){center_location_view_map(" + view_latitude + ", " + view_longitude + ", 3);});" + vbCrLf, True)

                        Case "europe" ' 49.5,22

                            view_latitude = "49.5"
                            view_longitude = "22"

                            ' on view can just RegisterStartupScript each script
                            System.Web.UI.ScriptManager.RegisterStartupScript(Me.viewOuterPanel, Me.GetType(), "location_view_map_center_script", "$(document).ready(function(){center_location_view_map(" + view_latitude + ", " + view_longitude + ", 4);});" + vbCrLf, True)

                        Case "north america" '37.5,-110

                            view_latitude = "37.5"
                            view_longitude = "-110"

                            ' on view can just RegisterStartupScript each script
                            System.Web.UI.ScriptManager.RegisterStartupScript(Me.viewOuterPanel, Me.GetType(), "location_view_map_center_script", "$(document).ready(function(){center_location_view_map(" + view_latitude + ", " + view_longitude + ", 3);});" + vbCrLf, True)

                        Case "south america" '-21.7351043,-63.28125

                            view_latitude = "-21.7351043"
                            view_longitude = "-63.28125"

                            ' on view can just RegisterStartupScript each script
                            System.Web.UI.ScriptManager.RegisterStartupScript(Me.viewOuterPanel, Me.GetType(), "location_view_map_center_script", "$(document).ready(function(){center_location_view_map(" + view_latitude + ", " + view_longitude + ", 3);});" + vbCrLf, True)

                    End Select

                    ' now display markers for "all" aircraft on that Continent
                    If Not IsNothing(location_map_lat_long_table) Then
                        If location_map_lat_long_table.Rows.Count > 0 Then

                            For Each r As DataRow In location_map_lat_long_table.Rows

                                loop_latitude = ""
                                loop_longitude = ""

                                ' add all the "markers" for each location item
                                sRefLink = ""
                                sRefLink = "view_template.aspx?ViewID=" + searchCriteria.ViewID.ToString + "&ViewName=" + searchCriteria.ViewName.Trim
                                sRefLink += "&onLocationTab=" + IIf(searchCriteria.ViewID < 2, "true", "false") & IIf(bHasMaster = False, "&noMaster=false", "")
                                sRefLink += "&amod_id=" + searchCriteria.ViewCriteriaAmodID.ToString
                                sRefLink += "&viewState="
                                sRefLink += "&viewCity="

                                ' clear Continent (not needed when going to country)
                                sRefLink += "&viewContinent="

                                If searchCriteria.ViewCriteriaLocationViewType <> Constants.LOCATION_VIEW_BASE Then

                                    If Not IsDBNull(r.Item("comp_country")) Then
                                        If Not String.IsNullOrEmpty(r.Item("comp_country").ToString.Trim) Then

                                            sRefLink += "&viewCountry=" + HttpContext.Current.Server.UrlEncode(r.Item("comp_country").ToString.Trim)

                                            If r.Item("comp_country").ToString.Trim.ToLower.Contains("united states") Then
                                                display_location_lable = "USA"
                                            Else
                                                display_location_lable = r.Item("comp_country").ToString.Trim
                                            End If
                                        Else
                                            sRefLink += "&viewCountry="
                                        End If
                                    Else
                                        sRefLink += "&viewCountry="
                                    End If

                                Else

                                    If Not IsDBNull(r.Item("ac_aport_country")) Then
                                        If Not String.IsNullOrEmpty(r.Item("ac_aport_country").ToString.Trim) Then

                                            sRefLink += "&viewCountry=" + HttpContext.Current.Server.UrlEncode(r.Item("ac_aport_country").ToString.Trim)

                                            If r.Item("ac_aport_country").ToString.Trim.ToLower.Contains("united states") Then
                                                display_location_lable = "USA"
                                            Else
                                                display_location_lable = r.Item("ac_aport_country").ToString.Trim
                                            End If
                                        Else
                                            sRefLink += "&viewCountry="
                                        End If
                                    Else
                                        sRefLink += "&viewCountry="
                                    End If

                                End If

                                If Not IsDBNull(r.Item("tlatitude")) Then
                                    If Not String.IsNullOrEmpty(r.Item("tlatitude").ToString.Trim) Then
                                        loop_latitude = r.Item("tlatitude").ToString
                                    End If
                                End If

                                If Not IsDBNull(r.Item("tlongitude")) Then
                                    If Not String.IsNullOrEmpty(r.Item("tlongitude").ToString.Trim) Then
                                        loop_longitude = r.Item("tlongitude").ToString
                                    End If
                                End If

                                If Not String.IsNullOrEmpty(loop_latitude) And Not String.IsNullOrEmpty(loop_longitude) Then

                                    If r.Table.Columns.Contains("tcount") Then
                                        sOutputScript += "$(document).ready(function(){add_location_view_marker('" + display_location_lable.Trim + "'," + loop_latitude + ", " + loop_longitude + ", " + r.Item("tcount").ToString + ", '" + sRefLink + "', view_map);});" + vbCrLf
                                    Else
                                        sOutputScript += "$(document).ready(function(){add_location_view_marker('" + display_location_lable.Trim + "'," + loop_latitude + ", " + loop_longitude + ", 0, '" + sRefLink + "', view_map);});" + vbCrLf
                                    End If

                                End If

                            Next 'Each r As DataRow In location_map_lat_long_table.Rows

                            System.Web.UI.ScriptManager.RegisterStartupScript(Me.viewOuterPanel, Me.GetType(), "location_view_map_marker_script", sOutputScript, True)

                        End If 'location_map_lat_long_table.Rows.Count > 0 
                    Else
                        ' on view can just RegisterStartupScript each script
                        'Setting up the default options for the map (default to center on world) 
                        System.Web.UI.ScriptManager.RegisterStartupScript(Me.viewOuterPanel, Me.GetType(), "location_view_map_script", "$(document).ready(function(){initialize_view_map();});" + vbCrLf, True)
                    End If ' Not IsNothing(location_map_lat_long_table) 

                End If
            End If

        Catch ex As Exception

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [build_location_standalone] : " + ex.Message

        Finally

        End Try

        out_htmlString = htmlOut.ToString()
        htmlOut = Nothing

    End Sub

    Private Sub build_location_markettab(ByRef searchCriteria As viewSelectionCriteriaClass, ByRef out_htmlString As String)

        Dim htmlOut As New StringBuilder
        Dim zoom_level As String = "4"
        Dim htmlLocationList As String = ""

        Dim center_map_table As DataTable = Nothing
        Dim location_map_lat_long_table As DataTable = Nothing
        Dim display_location_lable As String = ""
        Dim ncount As Integer = 0

        Dim previous_city As String = ""
        Dim bHadCity As Boolean = False
        Dim sRefLink As String = ""

        Dim location_functions As New location_view_functions

        Dim tab_latitude As String = ""
        Dim tab_longitude As String = ""

        Dim loop_latitude As String = ""
        Dim loop_longitude As String = ""

        Try

            location_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            location_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            location_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            location_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            location_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

            view_location_tab_display_by.Items.Clear()

            If Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaCity.ToString.Trim) Then

                view_location_tab_display_by.Items.Add(New ListItem("Aircraft", Constants.LOCATION_SORT_AIRCRAFT))
                view_location_tab_display_by.SelectedValue = Constants.LOCATION_SORT_AIRCRAFT.ToString

                zoom_level = "8"

            ElseIf Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaState.ToString.Trim) Then

                view_location_tab_display_by.Items.Add(New ListItem("City", Constants.LOCATION_SORT_CITY))
                view_location_tab_display_by.Items.Add(New ListItem("Aircraft", Constants.LOCATION_SORT_AIRCRAFT))

                If searchCriteria.ViewCriteriaLocationViewSort = Constants.LOCATION_SORT_CITY Then
                    view_location_display_by.SelectedValue = Constants.LOCATION_SORT_CITY.ToString
                Else
                    view_location_display_by.SelectedValue = Constants.LOCATION_SORT_AIRCRAFT.ToString
                End If

                zoom_level = "5"

            ElseIf Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaCountry.ToString.Trim) Then

                If localCriteria.ViewCriteriaAmodID > -1 Then
                    view_location_tab_display_by.Items.Add(New ListItem("Aircraft", Constants.LOCATION_SORT_AIRCRAFT))
                End If

                If searchCriteria.ViewCriteriaCountryHasStates Or view_location_display_by.SelectedValue.Contains(Constants.LOCATION_SORT_STATE.ToString) Then

                    view_location_tab_display_by.Items.Add(New ListItem("State", Constants.LOCATION_SORT_STATE))
                    view_location_tab_display_by.Items.Add(New ListItem("City", Constants.LOCATION_SORT_CITY))
                    view_location_tab_display_by.SelectedValue = Constants.LOCATION_SORT_STATE.ToString

                Else

                    view_location_tab_display_by.Items.Add(New ListItem("City", Constants.LOCATION_SORT_CITY))
                    view_location_tab_display_by.SelectedValue = Constants.LOCATION_SORT_CITY.ToString

                End If

                zoom_level = "4"

            ElseIf Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaContinent.ToString.Trim) Then

                view_location_tab_display_by.Items.Add(New ListItem("Country", Constants.LOCATION_SORT_COUNTRY))

                If searchCriteria.ViewCriteriaCountryHasStates Then
                    view_location_tab_display_by.Items.Add(New ListItem("State", Constants.LOCATION_SORT_STATE))
                End If

                view_location_tab_display_by.Items.Add(New ListItem("City", Constants.LOCATION_SORT_CITY))
                view_location_tab_display_by.SelectedValue = Constants.LOCATION_SORT_COUNTRY.ToString

                zoom_level = "4"

            Else

                view_location_tab_display_by.Items.Add(New ListItem("Continent", Constants.LOCATION_SORT_CONTINENT))
                view_location_tab_display_by.SelectedValue = Constants.LOCATION_SORT_CONTINENT.ToString

                zoom_level = "2"

            End If

            view_location_tab_label_display_by.Visible = True
            view_location_tab_display_by.Visible = True
            searchCriteria.ViewCriteriaLocationViewSort = CInt(view_location_tab_display_by.SelectedValue)

            build_location_tab_datatable(searchCriteria, htmlLocationList, location_map_lat_long_table)
            htmlOut.Append(htmlLocationList)

            If Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaCountry.Trim) _
               Or Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaState.Trim) _
               Or Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaCity.Trim) Then

                ' get the lat and long for the center of the map
                center_map_table = location_functions.get_location_map_center(searchCriteria)

                If Not IsNothing(center_map_table) Then
                    If center_map_table.Rows.Count > 0 Then
                        For Each r As DataRow In center_map_table.Rows

                            If Not IsDBNull(r.Item("map_latitude")) Then
                                If Not String.IsNullOrEmpty(r.Item("map_latitude").ToString.Trim) Then
                                    tab_latitude = r.Item("map_latitude").ToString
                                End If
                            End If

                            If Not IsDBNull(r.Item("map_longitude")) Then
                                If Not String.IsNullOrEmpty(r.Item("map_longitude").ToString.Trim) Then
                                    tab_longitude = r.Item("map_longitude").ToString
                                End If
                            End If

                            Exit For

                        Next
                    End If
                End If

                center_map_table = Nothing

                ' for tab have to collect all scripts for the map to display on page.prerender
                ' center map on the "country"
                sLocationTabScriptID = "location_tab_map_script"
                sLocationTabScript = "$(document).ready(function(){center_location_tab_map(" + tab_latitude + ", " + tab_longitude + ", " + zoom_level + ");});" + vbCrLf

                ' add all the "markers" for each location item

                If Not IsNothing(location_map_lat_long_table) Then
                    If location_map_lat_long_table.Rows.Count > 0 Then

                        For Each r As DataRow In location_map_lat_long_table.Rows
                            ' add all the "markers" for each location item

                            loop_latitude = ""
                            loop_longitude = ""

                            sRefLink = ""
                            sRefLink = "view_template.aspx?ViewID=" + searchCriteria.ViewID.ToString + "&ViewName=" + searchCriteria.ViewName.Trim
                            sRefLink += "&onLocationTab=" + IIf(searchCriteria.ViewID < 2, "true", "false") & IIf(bHasMaster = False, "&noMaster=false", "")
                            sRefLink += "&amod_id=" + searchCriteria.ViewCriteriaAmodID.ToString

                            If Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaContinent.Trim) Then
                                sRefLink += "&viewContinent=" + HttpContext.Current.Server.UrlEncode(searchCriteria.ViewCriteriaContinent.Trim)
                            Else
                                sRefLink += "&viewContinent="
                            End If

                            If searchCriteria.ViewCriteriaLocationViewType <> Constants.LOCATION_VIEW_BASE Then

                                If Not IsDBNull(r.Item("comp_country")) Then
                                    If Not String.IsNullOrEmpty(r.Item("comp_country").ToString.Trim) Then

                                        sRefLink += "&viewCountry=" + HttpContext.Current.Server.UrlEncode(r.Item("comp_country").ToString.Trim)

                                        If r.Item("comp_country").ToString.Trim.ToLower.Contains("united states") Then
                                            display_location_lable = "USA"
                                        Else
                                            display_location_lable = r.Item("comp_country").ToString.Trim
                                        End If
                                    Else
                                        sRefLink += "&viewCountry="
                                    End If
                                Else
                                    sRefLink += "&viewCountry="
                                End If

                                If searchCriteria.ViewCriteriaCountryHasStates And r.Table.Columns.Contains("state_name") Then

                                    If Not IsDBNull(r.Item("comp_state")) Then
                                        If Not String.IsNullOrEmpty(r.Item("comp_state").ToString.Trim) Then
                                            display_location_lable += " - " + r.Item("comp_state").ToString.Trim
                                        End If
                                    End If

                                    If Not IsDBNull(r.Item("comp_state")) Then
                                        If Not String.IsNullOrEmpty(r.Item("comp_state").ToString.Trim) Then
                                            sRefLink += "&viewState=" + HttpContext.Current.Server.UrlEncode(r.Item("comp_state").ToString.Trim)
                                        End If
                                    End If

                                Else
                                    sRefLink += "&viewState="
                                End If

                                If Not IsDBNull(r.Item("comp_city")) Then
                                    If Not String.IsNullOrEmpty(r.Item("comp_city").ToString.Trim) Then
                                        display_location_lable += " - " + r.Item("comp_city").ToString.Trim
                                        bHadCity = True
                                    End If
                                End If

                            Else

                                If Not IsDBNull(r.Item("ac_aport_country")) Then
                                    If Not String.IsNullOrEmpty(r.Item("ac_aport_country").ToString.Trim) Then

                                        sRefLink += "&viewCountry=" + HttpContext.Current.Server.UrlEncode(r.Item("ac_aport_country").ToString.Trim)

                                        If r.Item("ac_aport_country").ToString.Trim.ToLower.Contains("united states") Then
                                            display_location_lable = "USA"
                                        Else
                                            display_location_lable = r.Item("ac_aport_country").ToString.Trim
                                        End If
                                    Else
                                        sRefLink += "&viewCountry="
                                    End If
                                Else
                                    sRefLink += "&viewCountry="
                                End If

                                If searchCriteria.ViewCriteriaCountryHasStates And r.Table.Columns.Contains("state_name") Then

                                    If Not IsDBNull(r.Item("ac_aport_state")) Then
                                        If Not String.IsNullOrEmpty(r.Item("ac_aport_state").ToString.Trim) Then
                                            display_location_lable += " - " + r.Item("ac_aport_state").ToString.Trim
                                        End If
                                    End If

                                    If Not IsDBNull(r.Item("ac_aport_state")) Then
                                        If Not String.IsNullOrEmpty(r.Item("ac_aport_state").ToString.Trim) Then
                                            sRefLink += "&viewState=" + HttpContext.Current.Server.UrlEncode(r.Item("ac_aport_state").ToString.Trim)
                                        End If
                                    End If

                                Else
                                    sRefLink += "&viewState="
                                End If

                                If Not IsDBNull(r.Item("ac_aport_city")) Then
                                    If Not String.IsNullOrEmpty(r.Item("ac_aport_city").ToString.Trim) Then
                                        display_location_lable += " - " + r.Item("ac_aport_city").ToString.Trim
                                        bHadCity = True
                                    End If
                                End If

                            End If

                            If Not IsDBNull(r.Item("tlatitude")) Then
                                If Not String.IsNullOrEmpty(r.Item("tlatitude").ToString.Trim) Then
                                    loop_latitude = r.Item("tlatitude").ToString
                                End If
                            End If

                            If Not IsDBNull(r.Item("tlongitude")) Then
                                If Not String.IsNullOrEmpty(r.Item("tlongitude").ToString.Trim) Then
                                    loop_longitude = r.Item("tlongitude").ToString
                                End If
                            End If

                            If Not String.IsNullOrEmpty(loop_latitude) And Not String.IsNullOrEmpty(loop_longitude) Then

                                If Not bHadCity And searchCriteria.ViewCriteriaLocationViewSort <> Constants.LOCATION_SORT_CITY Then

                                    sRefLink += "&viewCity="

                                    If r.Table.Columns.Contains("tcount") Then
                                        sLocationTabScript += "$(document).ready(function(){add_location_tab_marker('" + display_location_lable.Trim + "'," + loop_latitude + ", " + loop_longitude + ", " + r.Item("tcount").ToString + ", '" + sRefLink + "');});" + vbCrLf
                                    Else
                                        sLocationTabScript += "$(document).ready(function(){add_location_tab_marker('" + display_location_lable.Trim + "'," + loop_latitude + ", " + loop_longitude + ", -1, '" + sRefLink + "');});" + vbCrLf
                                    End If

                                Else

                                    If searchCriteria.ViewCriteriaLocationViewType <> Constants.LOCATION_VIEW_BASE Then
                                        If Not previous_city.Trim.ToLower.Contains(r.Item("comp_city").ToString.Trim.ToLower) Then

                                            sRefLink += "&viewCity=" + HttpContext.Current.Server.UrlEncode(r.Item("comp_city").ToString.Trim)

                                            If r.Table.Columns.Contains("tcount") Then
                                                sLocationTabScript += "$(document).ready(function(){add_location_tab_marker('" + display_location_lable.Trim + "'," + loop_latitude + ", " + loop_longitude + ", " + r.Item("tcount").ToString + ", '" + sRefLink + "');});" + vbCrLf
                                            Else
                                                sLocationTabScript += "$(document).ready(function(){add_location_tab_marker('" + display_location_lable.Trim + "'," + loop_latitude + ", " + loop_longitude + ", -1, '" + sRefLink + "');});" + vbCrLf
                                            End If
                                            previous_city = r.Item("comp_city").ToString.Trim + ":"
                                        End If

                                    Else

                                        If Not previous_city.Trim.ToLower.Contains(r.Item("ac_aport_city").ToString.Trim.ToLower) Then

                                            sRefLink += "&viewCity=" + HttpContext.Current.Server.UrlEncode(r.Item("ac_aport_city").ToString.Trim)

                                            If r.Table.Columns.Contains("tcount") Then
                                                sLocationTabScript += "$(document).ready(function(){add_location_tab_marker('" + display_location_lable.Trim + "'," + loop_latitude + ", " + loop_longitude + ", " + r.Item("tcount").ToString + ", '" + sRefLink + "');});" + vbCrLf
                                            Else
                                                sLocationTabScript += "$(document).ready(function(){add_location_tab_marker('" + display_location_lable.Trim + "'," + loop_latitude + ", " + loop_longitude + ", -1, '" + sRefLink + "');});" + vbCrLf
                                            End If
                                            previous_city = r.Item("ac_aport_city").ToString.Trim + ":"
                                        End If
                                    End If

                                End If ' not had city

                            End If ' have to have a lat/long to plot city ...

                        Next ' r As DataRow In location_map_lat_long_table.Rows

                    End If ' location_map_lat_long_table.Rows.Count > 0

                Else
                    ' for tab have to collect all scripts for the map to display on page.prerender
                    ' add all the "markers" for each location item

                    sRefLink = "view_template.aspx?ViewID=" + searchCriteria.ViewID.ToString + "&ViewName=" + searchCriteria.ViewName.Trim
                    sRefLink += "&onLocationTab=" + IIf(searchCriteria.ViewID < 2, "true", "false") & IIf(bHasMaster = False, "&noMaster=false", "")
                    sRefLink += "&viewCountry=" + IIf(Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaCountry.Trim), HttpContext.Current.Server.UrlEncode(searchCriteria.ViewCriteriaCountry.Trim), "")
                    sRefLink += "&viewCity=" + IIf(Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaCity.Trim), HttpContext.Current.Server.UrlEncode(searchCriteria.ViewCriteriaCity.Trim), "")
                    sRefLink += "&viewContinent=" + IIf(Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaContinent.Trim), HttpContext.Current.Server.UrlEncode(searchCriteria.ViewCriteriaContinent.Trim), "")
                    sRefLink += "&viewState=" + IIf(Not String.IsNullOrEmpty(searchCriteria.ViewCriteriaState.Trim), HttpContext.Current.Server.UrlEncode(searchCriteria.ViewCriteriaState.Trim), "")
                    sRefLink += "&amod_id=" + IIf(searchCriteria.ViewCriteriaAmodID > -1, searchCriteria.ViewCriteriaAmodID.ToString, "")

                    sLocationTabScriptID = "location_tab_map_marker_script"
                    sLocationTabScript = "$(document).ready(function(){add_location_tab_marker('" + searchCriteria.ViewCriteriaCountry.Trim + "'," + tab_latitude + ", " + tab_longitude + ", 0, '" + sRefLink + "');});"
                End If

            Else

                If String.IsNullOrEmpty(searchCriteria.ViewCriteriaContinent.Trim) Then

                    sLocationTabScriptID = "location_tab_map_script"
                    sLocationTabScript = "$(document).ready(function(){center_location_tab_map(" + tab_latitude + ", " + tab_longitude + ", " + zoom_level + ");});" + vbCrLf

                    If Not IsNothing(location_map_lat_long_table) Then
                        If location_map_lat_long_table.Rows.Count > 0 Then
                            Dim sOutputScript As String = ""

                            For Each r As DataRow In location_map_lat_long_table.Rows

                                sRefLink = "view_template.aspx?ViewID=" + searchCriteria.ViewID.ToString + "&ViewName=" + searchCriteria.ViewName.Trim
                                sRefLink += "&onLocationTab=" + IIf(searchCriteria.ViewID < 2, "true", "false") & IIf(bHasMaster = False, "&noMaster=false", "")
                                sRefLink += "&amod_id=" + searchCriteria.ViewCriteriaAmodID.ToString
                                sRefLink += "&viewCountry="
                                sRefLink += "&viewState="
                                sRefLink += "&viewCity="

                                Select Case r.Item("country_continent_name").ToString.ToLower.Trim

                                    Case "africa"  '0.2136714,16.98485

                                        sRefLink += "&viewContinent=" + HttpContext.Current.Server.UrlEncode(r.Item("country_continent_name").ToString.Trim)

                                        tab_latitude = "0.2136714"
                                        tab_longitude = "16.98485"

                                        ' on view can just RegisterStartupScript each script
                                        sLocationTabScript += "$(document).ready(function(){add_location_tab_marker('" + r.Item("country_continent_name").ToString.Trim + "'," + tab_latitude + ", " + tab_longitude + ", " + r.Item("tcount").ToString + ", '" + sRefLink + "');});" + vbCrLf

                                    Case "asia"     ' 29,100

                                        sRefLink += "&viewContinent=" + HttpContext.Current.Server.UrlEncode(r.Item("country_continent_name").ToString.Trim)

                                        tab_latitude = "29"
                                        tab_longitude = "100"

                                        ' on view can just RegisterStartupScript each script
                                        sLocationTabScript += "$(document).ready(function(){add_location_tab_marker('" + r.Item("country_continent_name").ToString.Trim + "'," + tab_latitude + ", " + tab_longitude + ", " + r.Item("tcount").ToString + ", '" + sRefLink + "');});" + vbCrLf

                                    Case "europe" ' 49.5,22

                                        sRefLink += "&viewContinent=" + HttpContext.Current.Server.UrlEncode(r.Item("country_continent_name").ToString.Trim)

                                        tab_latitude = "49.5"
                                        tab_longitude = "22"

                                        ' on view can just RegisterStartupScript each script
                                        sLocationTabScript += "$(document).ready(function(){add_location_tab_marker('" + r.Item("country_continent_name").ToString.Trim + "'," + tab_latitude + ", " + tab_longitude + ", " + r.Item("tcount").ToString + ", '" + sRefLink + "');});" + vbCrLf

                                    Case "north america" '37.5,-110

                                        sRefLink += "&viewContinent=" + HttpContext.Current.Server.UrlEncode(r.Item("country_continent_name").ToString.Trim)

                                        tab_latitude = "37.5"
                                        tab_longitude = "-110"

                                        ' on view can just RegisterStartupScript each script
                                        sLocationTabScript += "$(document).ready(function(){add_location_tab_marker('" + r.Item("country_continent_name").ToString.Trim + "'," + tab_latitude + ", " + tab_longitude + ", " + r.Item("tcount").ToString + ", '" + sRefLink + "');});" + vbCrLf

                                    Case "south america" '-21.7351043,-63.28125

                                        sRefLink += "&viewContinent=" + HttpContext.Current.Server.UrlEncode(r.Item("country_continent_name").ToString.Trim)

                                        tab_latitude = "-21.7351043"
                                        tab_longitude = "-63.28125"

                                        sLocationTabScript += "$(document).ready(function(){add_location_tab_marker('" + r.Item("country_continent_name").ToString.Trim + "'," + tab_latitude + ", " + tab_longitude + ", " + r.Item("tcount").ToString + ", '" + sRefLink + "');});" + vbCrLf

                                End Select

                            Next ' Each r As DataRow In location_map_lat_long_table.Rows

                        End If ' location_map_lat_long_table.Rows.Count > 0

                    Else
                        ' Setting up the default options for the map (default to center on world) 
                        sLocationTabScriptID = "location_tab_map_script"
                        sLocationTabScript = "$(document).ready(function(){initialize_tab_map();});"
                    End If

                Else

                    sLocationTabScriptID = "location_tab_map_script"

                    Select Case searchCriteria.ViewCriteriaContinent.ToLower.Trim

                        Case "africa"  '0.2136714,16.98485

                            tab_latitude = "0.2136714"
                            tab_longitude = "16.98485"

                            ' on view can just RegisterStartupScript each script
                            sLocationTabScript = "$(document).ready(function(){center_location_tab_map(" + tab_latitude + ", " + tab_longitude + ", 3);});" + vbCrLf

                        Case "asia"     ' 29,100

                            tab_latitude = "29"
                            tab_longitude = "100"

                            ' on view can just RegisterStartupScript each script
                            sLocationTabScript = "$(document).ready(function(){center_location_tab_map(" + tab_latitude + ", " + tab_longitude + ", 3);});" + vbCrLf

                        Case "europe" ' 49.5,22

                            tab_latitude = "49.5"
                            tab_longitude = "22"

                            ' on view can just RegisterStartupScript each script
                            sLocationTabScript = "$(document).ready(function(){center_location_tab_map(" + tab_latitude + ", " + tab_longitude + ", 4);});" + vbCrLf

                        Case "north america" '37.5,-110

                            tab_latitude = "37.5"
                            tab_longitude = "-110"

                            ' on view can just RegisterStartupScript each script
                            sLocationTabScript = "$(document).ready(function(){center_location_tab_map(" + tab_latitude + ", " + tab_longitude + ", 3);});" + vbCrLf

                        Case "south america" '-21.7351043,-63.28125

                            tab_latitude = "-21.7351043"
                            tab_longitude = "-63.28125"

                            ' on tab collect scripts to show at pre-render
                            sLocationTabScript = "$(document).ready(function(){center_location_tab_map(" + tab_latitude + ", " + tab_longitude + ", 3);});" + vbCrLf

                    End Select

                    If Not IsNothing(location_map_lat_long_table) Then
                        If location_map_lat_long_table.Rows.Count > 0 Then

                            For Each r As DataRow In location_map_lat_long_table.Rows

                                loop_latitude = ""
                                loop_longitude = ""

                                ' add all the "markers" for each location item
                                sRefLink = ""
                                sRefLink = "view_template.aspx?ViewID=" + searchCriteria.ViewID.ToString + "&ViewName=" + searchCriteria.ViewName.Trim
                                sRefLink += "&onLocationTab=" + IIf(searchCriteria.ViewID < 2, "true", "false") & IIf(bHasMaster = False, "&noMaster=false", "")
                                sRefLink += "&amod_id=" + searchCriteria.ViewCriteriaAmodID.ToString

                                sRefLink += "&viewState="
                                sRefLink += "&viewCity="

                                ' clear Continent (not needed when going to country)
                                sRefLink += "&viewContinent="

                                If searchCriteria.ViewCriteriaLocationViewType <> Constants.LOCATION_VIEW_BASE Then

                                    If Not IsDBNull(r.Item("comp_country")) Then
                                        If Not String.IsNullOrEmpty(r.Item("comp_country").ToString.Trim) Then

                                            sRefLink += "&viewCountry=" + HttpContext.Current.Server.UrlEncode(r.Item("comp_country").ToString.Trim)

                                            If r.Item("comp_country").ToString.Trim.ToLower.Contains("united states") Then
                                                display_location_lable = "USA"
                                            Else
                                                display_location_lable = r.Item("comp_country").ToString.Trim
                                            End If
                                        Else
                                            sRefLink += "&viewCountry="
                                        End If
                                    Else
                                        sRefLink += "&viewCountry="
                                    End If


                                Else

                                    If Not IsDBNull(r.Item("ac_aport_country")) Then
                                        If Not String.IsNullOrEmpty(r.Item("ac_aport_country").ToString.Trim) Then

                                            sRefLink += "&viewCountry=" + HttpContext.Current.Server.UrlEncode(r.Item("ac_aport_country").ToString.Trim)

                                            If r.Item("ac_aport_country").ToString.Trim.ToLower.Contains("united states") Then
                                                display_location_lable = "USA"
                                            Else
                                                display_location_lable = r.Item("ac_aport_country").ToString.Trim
                                            End If
                                        Else
                                            sRefLink += "&viewCountry="
                                        End If
                                    Else
                                        sRefLink += "&viewCountry="
                                    End If

                                End If

                                If Not IsDBNull(r.Item("tlatitude")) Then
                                    If Not String.IsNullOrEmpty(r.Item("tlatitude").ToString.Trim) Then
                                        loop_latitude = r.Item("tlatitude").ToString
                                    End If
                                End If

                                If Not IsDBNull(r.Item("tlongitude")) Then
                                    If Not String.IsNullOrEmpty(r.Item("tlongitude").ToString.Trim) Then
                                        loop_longitude = r.Item("tlongitude").ToString
                                    End If
                                End If

                                If Not String.IsNullOrEmpty(loop_latitude) And Not String.IsNullOrEmpty(loop_longitude) Then

                                    If r.Table.Columns.Contains("tcount") Then
                                        sLocationTabScript += "$(document).ready(function(){add_location_tab_marker('" + display_location_lable.Trim + "'," + loop_latitude + ", " + loop_longitude + ", " + r.Item("tcount").ToString + ", '" + sRefLink + "');});" + vbCrLf
                                    Else
                                        sLocationTabScript += "$(document).ready(function(){add_location_tab_marker('" + display_location_lable.Trim + "'," + loop_latitude + ", " + loop_longitude + ", 0, '" + sRefLink + "');});" + vbCrLf
                                    End If

                                End If

                            Next 'Each r As DataRow In location_map_lat_long_table.Rows

                        End If 'location_map_lat_long_table.Rows.Count > 0
                    Else
                        ' Setting up the default options for the map (default to center on united states) 
                        sLocationTabScriptID = "location_tab_map_script"
                        sLocationTabScript = "$(document).ready(function(){initialize_tab_map();});"
                    End If

                End If

            End If

        Catch ex As Exception

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [build_location_markettab] : " + ex.Message

        Finally

        End Try

        out_htmlString = htmlOut.ToString()
        htmlOut = Nothing

    End Sub

    Public Sub fboViewSearch_Button_Click()
        'fboViewSearch_Results.CssClass = ""
        'Dim ResultsTable As New DataTable
        'Dim cssClass As String = "alt_row_light"
        'Dim ResultsString As String = ""


        'ResultsTable = localDatalayer.get_airports_by_IATA_or_ICAO_City_Name(fboViewSearch_textbox.Text, fboViewSearch_textbox.Text, fboViewSearch_textbox.Text, fboViewSearch_textbox.Text)

        'If Not IsNothing(ResultsTable) Then
        '  If ResultsTable.Rows.Count > 0 Then
        '    ResultsString = "<br /><br /><table width=""100%"" cellpadding=""5"" cellspacing=""0"">"
        '    ResultsString += "<tr class=""header"">"
        '    ResultsString += "<td align=""left"" valign=""top""><b>AIRPORT RESULTS LIST</b></td>"
        '    ResultsString += "</tr><tr><td align=""left"" valign=""top""><ul class=""commentlist"" id=""fboViewUL"">"
        '    For Each r As DataRow In ResultsTable.Rows

        '      Dim IATACode As String = ""
        '      Dim ICAOCode As String = ""
        '      Dim AirportName As String = ""
        '      Dim AirportCity As String = ""

        '      If Not IsDBNull(r("aport_iata_code")) Then
        '        If Not String.IsNullOrEmpty(r("aport_iata_code")) Then
        '          If InStr(UCase(r("aport_iata_code")), UCase(fboViewSearch_textbox.Text)) > 0 Then
        '            IATACode = " IATA: <span class=""error_text"">" & r("aport_iata_code") & "</span>" & ","
        '          Else
        '            IATACode = " IATA: " & r("aport_iata_code") & "" & ","
        '          End If
        '        End If
        '      End If

        '      If Not IsDBNull(r("aport_icao_code")) Then
        '        If Not String.IsNullOrEmpty(r("aport_icao_code")) Then
        '          If InStr(UCase(r("aport_icao_code")), UCase(fboViewSearch_textbox.Text)) > 0 Then
        '            ICAOCode = " ICAO: <span class=""error_text"">" & r("aport_icao_code") & "</span>" & ","
        '          Else
        '            ICAOCode = " ICAO: " & r("aport_icao_code") & "" & ","
        '          End If
        '        End If
        '      End If

        '      If Not IsDBNull(r("aport_name")) Then
        '        If Not String.IsNullOrEmpty(r("aport_name")) Then
        '          If InStr(UCase(r("aport_name")), UCase(fboViewSearch_textbox.Text)) > 0 Then
        '            AirportName = " class=""error_text""><strong class=""red_text""> " & r("aport_name") & " "
        '          Else
        '            AirportName = "><strong> " & r("aport_name") & "" & " "
        '          End If
        '        End If
        '      End If

        '      If Not IsDBNull(r("aport_city")) Then
        '        If Not String.IsNullOrEmpty(r("aport_city")) Then
        '          If InStr(UCase(r("aport_city")), UCase(fboViewSearch_textbox.Text)) > 0 Then
        '            AirportCity = " <span class=""error_text"">" & r("aport_city") & "</span>" & ""
        '          Else
        '            AirportCity = " " & r("aport_city") & ""
        '          End If
        '        End If
        '      End If

        '      If Trim(Request("ViewID")) <> "" Then
        '        'If Trim(Request("ViewID")) = 28 Then
        '        '  ResultsString += "<li class=""" & cssClass & """>"
        '        '  Dim jsPerformed As String = "" '
        '        '  jsPerformed = "$('#" & selectAirportID.ClientID & "').val('" & r("aport_id") & "');$get('" & fboViewSearch_Results.ClientID & "').style.display = 'none';$('#" & goSearchAirports.ClientID & "').click();"
        '        '  'document.body.style.cursor='wait';$get('" & UpdateProgress1.ClientID & "').style.display = 'block';
        '        '  ResultsString += "<a href=""#"" onclick=""" & jsPerformed & """ " & AirportName & "</strong></a>, " & IATACode & ICAOCode & " (" & r("aport_country") & " - " & AirportCity & IIf(Not IsDBNull(r("aport_state")), ", " & r("aport_state"), "") & ")"
        '        '  ResultsString += "</li>"
        '        'Else
        '        ResultsString += "<li class=""" & cssClass & """>"
        '        ResultsString += "<a href=""/view_template.aspx?ViewID=" & Trim(Request("ViewID")) & "&ViewName=" & Trim(Request("ViewName")) & "&aport_id=" & r("aport_id") & """ onclick=""document.body.style.cursor='wait';$get('" & UpdateProgress1.ClientID & "').style.display = 'block';"" " & AirportName & "</strong></a>, " & IATACode & ICAOCode & " (" & r("aport_country") & " - " & AirportCity & IIf(Not IsDBNull(r("aport_state")), ", " & r("aport_state"), "") & ")"
        '        ResultsString += "</li>"
        '        ' End If
        '      Else
        '        ResultsString += "<li class=""" & cssClass & """>"
        '        ResultsString += "<a href=""/view_template.aspx?ViewID=24&ViewName=Airport%20FBO%20View&aport_id=" & r("aport_id") & """ onclick=""document.body.style.cursor='wait';$get('" & UpdateProgress1.ClientID & "').style.display = 'block';"" " & AirportName & "</strong></a>, " & IATACode & ICAOCode & " (" & r("aport_country") & " - " & AirportCity & IIf(Not IsDBNull(r("aport_state")), ", " & r("aport_state"), "") & ")"
        '        ResultsString += "</li>"
        '      End If


        '      If cssClass = "alt_row" Then
        '        cssClass = "alt_row_light"
        '      Else
        '        cssClass = "alt_row"
        '      End If
        '    Next
        '    ResultsString += "</ul></td></tr></table><br />"
        '  Else
        '    ResultsString = "<br /><br /><p align=""center"" class=""error_text small_to_medium_text"">Your search terms returned no results. Please try again.</p>"
        '  End If
        'Else
        '  ResultsString = "<br /><br /><p align=""center"" class=""error_text small_to_medium_text"">Your search terms returned no results. Please try again.</p>"
        'End If
        'fboViewSearch_ResultsLabel.CssClass = ""
        'fboViewSearch_ResultsLabel.Text = ResultsString

        'If View_ID = 28 Then


        bottom_tab_update_panel.Update()
        UpdatePanel_top_left.Update()
        top_tab_update_panel.Update()
        'End If

    End Sub

    Private Sub invisibleAirportFBOButtonToCausePostback_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles invisibleAirportFBOButtonToCausePostback.Click


        Dim airport_fbo_functions As New airport_fbo_view_functions
        airport_fbo_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
        airport_fbo_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
        airport_fbo_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
        airport_fbo_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
        airport_fbo_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim
        Me.months_choice.Visible = False
        Me.my_airports_label.Visible = False

        '' if its not a postback, then the page is reloading, so as long as we have the airport string, we should re-do the page 
        'If Not IsPostBack Then
        If Not IsNothing(Session.Item("localUser").crmUserDefaultAirports) Then
            If Trim(Session.Item("localUser").crmUserDefaultAirports) <> "" Then
                Call airport_fbo_functions.GET_USER_AIRPORTS_top_function(Session.Item("localUser").crmUserDefaultAirports, Me.view_reports_label.Text, UpdateProgress1, "view", Me.months_choice.SelectedValue, Session("Last_FAA_DATE"))
                Session("Last_Airport_Range") = Me.months_choice.SelectedValue
                Me.months_choice.Visible = True
                Me.my_airports_label.Visible = True
            End If
        End If

        'This is just a nice javascript way of resetting the cursor to default so it doesn't spin.
        If Not Page.ClientScript.IsClientScriptBlockRegistered("ResetCursor") Then
            System.Web.UI.ScriptManager.RegisterClientScriptBlock(Me.top_tab_update_panel, Me.GetType(), "ResetCursor", "document.body.style.cursor='default';", True)
        End If

        myairportsLabelRan.Text = Now.Date.ToString 'fill this up so it doesn't rerun twice.

        If InStr(Me.view_reports_label.Text, "fractionsExpiringOuterTable") = 0 Then
            Me.view_reports_label.Text = "<table id=""fractionsExpiringOuterTable"" width=""100%"" cellpadding=""0"" cellspacing=""0"" class=""module""><tr><td valign=""top"" align=""center"" class=""header"">To modify your airport list below click <A href='Preferences.aspx' target='_blank'>Here</a> and use the 'MyAirports' tab.</td></tr>" & Me.view_reports_label.Text
        End If
        If InStr(Me.view_reports_label.Text, "clearfix margin-bottom padding") = 0 Then
            Me.view_reports_label.Text = "<div class=""clearfix margin-bottom padding""></div>" & Me.view_reports_label.Text & "<div class=""clearfix margin-bottom margin-top padding""></div>"
        End If
    End Sub

    Private Sub months_choice_SelectedIndexChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles months_choice.SelectedIndexChanged
        Me.months_choice.Visible = False
        Me.my_airports_label.Visible = False

        If View_ID = 24 Then 'I have absolutely no idea if this is needed. If this dropdown is used in another view, it is.
            If Trim(Session("Last_Airport_Range")) = "" Or (Trim(Session("Last_Airport_Range")) <> Me.months_choice.SelectedValue) Then
                Dim airport_fbo_functions As New airport_fbo_view_functions
                airport_fbo_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
                airport_fbo_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
                airport_fbo_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
                airport_fbo_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
                airport_fbo_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

                If Not IsNothing(Session.Item("localUser").crmUserDefaultAirports) Then
                    If Trim(Session.Item("localUser").crmUserDefaultAirports) <> "" Then
                        Call airport_fbo_functions.GET_USER_AIRPORTS_top_function(Session.Item("localUser").crmUserDefaultAirports, Me.view_reports_label.Text, UpdateProgress1, "view", Me.months_choice.SelectedValue, Session("Last_FAA_DATE"))
                        Session("Last_Airport_Range") = Me.months_choice.SelectedValue
                        Me.months_choice.Visible = True
                        Me.my_airports_label.Visible = True
                    End If
                End If
            End If

            If InStr(Me.view_reports_label.Text, "fractionsExpiringOuterTable") = 0 Then
                Me.view_reports_label.Text = "<table id=""fractionsExpiringOuterTable"" width=""100%"" cellpadding=""0"" cellspacing=""0"" class=""module""><tr><td valign=""top"" align=""center"" class=""header"">To modify your airport list below click <A href='Preferences.aspx' target='_blank'>Here</a> and use the 'MyAirports' tab.</td></tr>" & Me.view_reports_label.Text
            End If

            If InStr(Me.view_reports_label.Text, "clearfix margin-bottom padding") = 0 Then
                Me.view_reports_label.Text = "<div class=""clearfix margin-bottom padding""></div>" & Me.view_reports_label.Text & "<div class=""clearfix margin-bottom margin-top padding""></div>"
            End If

        End If
    End Sub

#End Region

#Region "page_load_functions"

    Public Sub load_page_variables()

        Dim sAirFrame As String = ""
        Dim sAirType As String = ""
        Dim sMake As String = ""
        Dim sModel As String = ""
        Dim sUsage As String = ""
        Dim amod_product As String = ""
        Dim multiProduct As Array = Nothing
        Dim type_search_variable_only As String = ""
        Dim type_search_string_variable_only As String = ""

        Try




            ' load type/make/model boxes
            If Not String.IsNullOrEmpty(Session.Item("viewAircraftModel").ToString.Trim) Then

                Dim modelArray() As String = Nothing
                Dim tmpModelArray() As String = Nothing

                ' Check and see if user selected more than one model
                If Session.Item("viewAircraftModel").ToString.Contains(Constants.cCommaDelim) Then
                    modelArray = Session.Item("viewAircraftModel").ToString.Split(Constants.cCommaDelim)

                    If IsArray(modelArray) And Not IsNothing(modelArray) Then
                        ' translate index into actual amod_id

                        ReDim tmpModelArray(UBound(modelArray))

                        For x As Integer = 0 To UBound(modelArray)
                            ' translate index into actual amod_id
                            tmpModelArray(x) = commonEvo.ReturnAmodIDForItemIndex(CLng(modelArray(x)))
                            If commonEvo.ReturnModelDataFromIndex(CLng(modelArray(x)), sAirFrame, sAirType, sMake, sModel, sUsage) Then
                                If String.IsNullOrEmpty(localCriteria.ViewCriteriaAircraftModel.Trim) Then
                                    localCriteria.ViewCriteriaAircraftModel = sModel
                                Else
                                    localCriteria.ViewCriteriaAircraftModel += Constants.cCommaDelim + sModel
                                End If
                            End If
                        Next

                        localCriteria.ViewCriteriaAmodIDArray = tmpModelArray
                        If View_ID = 16 Then
                            localCriteria.ViewCriteriaAmodID = -1
                        End If

                    End If

                Else

                    ' translate index into actual amod_id
                    localCriteria.ViewCriteriaAmodID = commonEvo.ReturnAmodIDForItemIndex(CLng(Session.Item("viewAircraftModel").ToString))

                    If commonEvo.ReturnModelDataFromIndex(CLng(Session.Item("viewAircraftModel").ToString), sAirFrame, sAirType, sMake, sModel, sUsage) Then
                        localCriteria.ViewCriteriaAircraftModel = sModel
                        localCriteria.ViewCriteriaAircraftType = sAirType
                    End If

                End If

            Else
                localCriteria.ViewCriteriaAmodIDArray = Nothing
                localCriteria.ViewCriteriaAmodID = -1
                localCriteria.ViewCriteriaAircraftModel = ""
                Session.Item("viewAircraftModel") = ""
            End If

            If Not String.IsNullOrEmpty(Session.Item("viewAircraftMake").ToString.Trim) Then

                Dim makeArray() As String = Nothing
                Dim tmpMakeArray() As String = Nothing

                ' Check and see if user selected more than one make
                If Session.Item("viewAircraftMake").ToString.Contains(Constants.cCommaDelim) Then

                    makeArray = Session.Item("viewAircraftMake").ToString.Split(Constants.cCommaDelim)

                    If IsArray(makeArray) And Not IsNothing(makeArray) Then

                        ReDim tmpMakeArray(UBound(makeArray))

                        For x As Integer = 0 To UBound(makeArray)
                            ' translate index into actual amod_make_id
                            tmpMakeArray(x) = commonEvo.ReturnAmodIDForItemIndex(CLng(makeArray(x)))
                            If commonEvo.ReturnModelDataFromIndex(CLng(makeArray(x)), sAirFrame, sAirType, sMake, sModel, sUsage) Then
                                If String.IsNullOrEmpty(localCriteria.ViewCriteriaAircraftMake.Trim) Then
                                    localCriteria.ViewCriteriaAircraftMake = sMake
                                Else
                                    localCriteria.ViewCriteriaAircraftMake += Constants.cCommaDelim + sMake
                                End If
                            End If
                        Next

                        localCriteria.ViewCriteriaMakeIDArray = tmpMakeArray

                    End If

                Else
                    ' translate index into actual amod_make_id
                    localCriteria.ViewCriteriaMakeAmodID = commonEvo.ReturnAmodIDForItemIndex(CLng(Session.Item("viewAircraftMake")))

                    If commonEvo.ReturnModelDataFromIndex(CLng(Session.Item("viewAircraftMake").ToString), sAirFrame, sAirType, sMake, sModel, sUsage) Then
                        localCriteria.ViewCriteriaAircraftMake = sMake

                        Select Case (sAirType)
                            Case Constants.AMOD_TYPE_AIRLINER
                                localCriteria.ViewCriteriaAirframeType = Constants.VIEW_EXECUTIVE
                            Case Constants.AMOD_TYPE_JET
                                localCriteria.ViewCriteriaAirframeType = Constants.VIEW_JETS
                            Case Constants.AMOD_TYPE_TURBO
                                Select Case (sAirFrame)
                                    Case Constants.AMOD_FIXED_AIRFRAME
                                        localCriteria.ViewCriteriaAirframeType = Constants.VIEW_TURBOPROPS
                                    Case Constants.AMOD_ROTARY_AIRFRAME
                                        localCriteria.ViewCriteriaAirframeType = Constants.VIEW_HELICOPTERS

                                End Select
                            Case Constants.AMOD_TYPE_PISTON
                                Select Case (sAirFrame)
                                    Case Constants.AMOD_FIXED_AIRFRAME
                                        localCriteria.ViewCriteriaAirframeType = Constants.VIEW_PISTONS
                                    Case Constants.AMOD_ROTARY_AIRFRAME
                                        localCriteria.ViewCriteriaAirframeType = Constants.VIEW_HELICOPTERS
                                End Select
                        End Select

                    End If
                End If

            Else
                localCriteria.ViewCriteriaMakeIDArray = Nothing
                localCriteria.ViewCriteriaMakeAmodID = -1
                localCriteria.ViewCriteriaAircraftMake = ""
                localCriteria.ViewCriteriaAirframeType = Constants.VIEW_ALLAIRFRAME
                Session.Item("viewAircraftMake") = ""
            End If

            If String.IsNullOrEmpty(Session.Item("viewAircraftMake").ToString.Trim) Then
                If String.IsNullOrEmpty(Session.Item("viewAircraftModel").ToString.Trim) Then
                    If Trim(Session.Item("viewAircraftType")) <> "" Then
                        If View_ID = 26 Or View_ID = 28 Then
                            If commonEvo.ReturnModelDataFromIndex(CLng(Session.Item("viewAircraftType").ToString), sAirFrame, sAirType, sMake, sModel, sUsage) Then
                                ' localCriteria.ViewCriteriaAircraftType = sAirType
                                type_search_variable_only = sAirType
                                type_search_string_variable_only = sAirFrame

                                Select Case (type_search_variable_only)
                                    Case Constants.AMOD_TYPE_AIRLINER
                                        localCriteria.ViewCriteriaAirframeType = Constants.VIEW_EXECUTIVE
                                    Case Constants.AMOD_TYPE_JET
                                        localCriteria.ViewCriteriaAirframeType = Constants.VIEW_JETS
                                    Case Constants.AMOD_TYPE_TURBO
                                        Select Case (sAirFrame)
                                            Case Constants.AMOD_FIXED_AIRFRAME
                                                localCriteria.ViewCriteriaAirframeType = Constants.VIEW_TURBOPROPS
                                            Case Constants.AMOD_ROTARY_AIRFRAME
                                                localCriteria.ViewCriteriaAirframeType = Constants.VIEW_HELICOPTERS

                                        End Select
                                    Case Constants.AMOD_TYPE_PISTON
                                        Select Case (sAirFrame)
                                            Case Constants.AMOD_FIXED_AIRFRAME
                                                localCriteria.ViewCriteriaAirframeType = Constants.VIEW_PISTONS
                                            Case Constants.AMOD_ROTARY_AIRFRAME
                                                localCriteria.ViewCriteriaAirframeType = Constants.VIEW_HELICOPTERS

                                        End Select
                                End Select

                            End If
                        End If
                    End If
                End If
            End If

            If localCriteria.ViewCriteriaAmodID = -1 And localCriteria.ViewCriteriaMakeAmodID > -1 And ((View_ID < 2) Or View_ID = 11) Then

                localCriteria.ViewCriteriaAmodID = localCriteria.ViewCriteriaMakeAmodID
                Session.Item("viewAircraftModel") = commonEvo.FindIndexForItemByAmodID(localCriteria.ViewCriteriaAmodID)
                Session.Item("viewAircraftMake") = Session.Item("viewAircraftModel")
                Session.Item("viewAircraftType") = Session.Item("viewAircraftModel")

                If commonEvo.ReturnModelDataFromIndex(CLng(Session.Item("viewAircraftModel").ToString), sAirFrame, sAirType, sMake, sModel, sUsage) Then
                    localCriteria.ViewCriteriaAirframeTypeStr = sAirFrame
                    localCriteria.ViewCriteriaAircraftType = sAirType
                    localCriteria.ViewCriteriaAircraftModel = sModel
                End If

            End If


            ' ie : user picks Business Jets airframe = F amod_type = J
            ' Helicopters Turbines airframe = R amod_type = T
            If Not String.IsNullOrEmpty(Session.Item("viewAircraftType").ToString.Trim) And
              localCriteria.ViewCriteriaAmodID = -1 And
              (View_ID = 16 Or View_ID = 3 Or View_ID = 8 Or View_ID = 9 Or View_ID = 10 Or View_ID = 26 Or View_ID = 28 Or View_ID = 32) Then

                If (CLng(Session.Item("viewAircraftType").ToString) > -1) Or (View_ID = 28) Then ' And InStr(Session.Item("viewAircraftType"), ",") = 0) Then
                    ' translate index into actual amod_type_code
                    Dim typeArray As String() = Split(Session.Item("viewAircraftType").ToString, ",")
                    Dim arrayHold As String = ""
                    For Each typeA In typeArray

                        localCriteria.ViewCriteriaTypeAmodID = commonEvo.ReturnAmodIDForItemIndex(CLng(typeA.ToString))

                        If commonEvo.ReturnModelDataFromIndex(CLng(typeA), sAirFrame, sAirType, sMake, sModel, sUsage) Then

                            localCriteria.ViewCriteriaAircraftType = sAirType
                            localCriteria.ViewCriteriaAirframeTypeStr = sAirFrame

                            Select Case (sAirType)
                                Case Constants.AMOD_TYPE_AIRLINER
                                    localCriteria.ViewCriteriaAirframeType = Constants.VIEW_EXECUTIVE
                                Case Constants.AMOD_TYPE_JET
                                    localCriteria.ViewCriteriaAirframeType = Constants.VIEW_JETS
                                Case Constants.AMOD_TYPE_TURBO
                                    Select Case (sAirFrame)
                                        Case Constants.AMOD_FIXED_AIRFRAME
                                            localCriteria.ViewCriteriaAirframeType = Constants.VIEW_TURBOPROPS
                                        Case Constants.AMOD_ROTARY_AIRFRAME
                                            localCriteria.ViewCriteriaAirframeType = Constants.VIEW_HELICOPTERS

                                    End Select
                                Case Constants.AMOD_TYPE_PISTON
                                    Select Case (sAirFrame)
                                        Case Constants.AMOD_FIXED_AIRFRAME
                                            localCriteria.ViewCriteriaAirframeType = Constants.VIEW_PISTONS
                                        Case Constants.AMOD_ROTARY_AIRFRAME
                                            localCriteria.ViewCriteriaAirframeType = Constants.VIEW_HELICOPTERS

                                    End Select

                            End Select

                            If Not String.IsNullOrEmpty(localCriteria.ViewCriteriaAirframeType) And View_ID = 28 Then
                                'If UBound(typeArray) >= 1 Then
                                If arrayHold <> "" Then
                                    arrayHold += ","
                                End If
                                arrayHold += localCriteria.ViewCriteriaAircraftType & "|" & localCriteria.ViewCriteriaAirframeTypeStr
                                'End If
                            End If

                        End If
                    Next

                    If arrayHold <> "" And View_ID = 28 Then
                        localCriteria.ViewCriteriaTypeIDArray = Split(arrayHold, ",")
                        localCriteria.ViewCriteriaTypeIDArray = localCriteria.ViewCriteriaTypeIDArray
                    End If
                Else
                    localCriteria.ViewCriteriaTypeAmodID = -1
                    localCriteria.ViewCriteriaAircraftType = ""
                    localCriteria.ViewCriteriaAirframeTypeStr = ""

                    ' only reset airframe if make IS NOT selected
                    If localCriteria.ViewCriteriaMakeAmodID = -1 Then
                        localCriteria.ViewCriteriaAirframeType = Constants.VIEW_ALLAIRFRAME
                    End If

                    Session.Item("viewAircraftType") = ""

                End If

            Else
                localCriteria.ViewCriteriaTypeAmodID = -1
                localCriteria.ViewCriteriaAircraftType = ""
                localCriteria.ViewCriteriaAirframeTypeStr = ""

                ' only reset airframe if make IS NOT selected
                If localCriteria.ViewCriteriaMakeAmodID = -1 Then
                    localCriteria.ViewCriteriaAirframeType = Constants.VIEW_ALLAIRFRAME
                End If

                Session.Item("viewAircraftType") = ""
            End If

            ' if amod_id has data that overides type/make/model selections
            If Not IsNothing(Request.Item("amod_id")) Then
                If Not String.IsNullOrEmpty(Request.Item("amod_id").ToString) Then

                    If CLng(Request.Item("amod_id").ToString.Trim) = -1 Then

                        localCriteria.ViewCriteriaAmodID = -1
                        localCriteria.ViewCriteriaAircraftModel = ""
                        Session.Item("viewAircraftModel") = ""

                        localCriteria.ViewCriteriaMakeAmodID = -1
                        localCriteria.ViewCriteriaAircraftMake = ""
                        Session.Item("viewAircraftMake") = ""

                        localCriteria.ViewCriteriaTypeAmodID = -1
                        localCriteria.ViewCriteriaAircraftType = ""
                        Session.Item("viewAircraftType") = ""

                        localCriteria.ViewCriteriaAirframeTypeStr = ""
                        localCriteria.ViewCriteriaAirframeType = Constants.VIEW_ALLAIRFRAME

                    Else

                        localCriteria.ViewCriteriaAmodID = CLng(Request.Item("amod_id").ToString.Trim)
                        Session.Item("viewAircraftModel") = commonEvo.FindIndexForItemByAmodID(localCriteria.ViewCriteriaAmodID)
                        Session.Item("viewAircraftMake") = Session.Item("viewAircraftModel")
                        Session.Item("viewAircraftType") = Session.Item("viewAircraftModel")

                        If commonEvo.ReturnModelDataFromIndex(CLng(Session.Item("viewAircraftModel").ToString), sAirFrame, sAirType, sMake, sModel, sUsage) Then
                            localCriteria.ViewCriteriaAirframeTypeStr = sAirFrame
                            localCriteria.ViewCriteriaAircraftType = sAirType
                            localCriteria.ViewCriteriaAircraftModel = sModel
                            localCriteria.ViewCriteriaAircraftMake = sMake
                            Select Case (sAirType)
                                Case Constants.AMOD_TYPE_AIRLINER
                                    localCriteria.ViewCriteriaAirframeType = Constants.VIEW_EXECUTIVE
                                Case Constants.AMOD_TYPE_JET
                                    localCriteria.ViewCriteriaAirframeType = Constants.VIEW_JETS
                                Case Constants.AMOD_TYPE_TURBO
                                    Select Case (sAirFrame)
                                        Case Constants.AMOD_FIXED_AIRFRAME
                                            localCriteria.ViewCriteriaAirframeType = Constants.VIEW_TURBOPROPS
                                        Case Constants.AMOD_ROTARY_AIRFRAME
                                            localCriteria.ViewCriteriaAirframeType = Constants.VIEW_HELICOPTERS

                                    End Select
                                Case Constants.AMOD_TYPE_PISTON
                                    Select Case (sAirFrame)
                                        Case Constants.AMOD_FIXED_AIRFRAME
                                            localCriteria.ViewCriteriaAirframeType = Constants.VIEW_PISTONS
                                        Case Constants.AMOD_ROTARY_AIRFRAME
                                            localCriteria.ViewCriteriaAirframeType = Constants.VIEW_HELICOPTERS

                                    End Select

                            End Select

                        End If
                    End If

                End If
            End If

            If Not IsNothing(ViewTMMDropDowns1) Then
                If Not String.IsNullOrEmpty(ViewTMMDropDowns1.getWeightClass.Trim) Then
                    If Not ViewTMMDropDowns1.getWeightClass.ToString.ToLower.Contains("all") Then
                        localCriteria.ViewCriteriaWeightClass = ViewTMMDropDowns1.getWeightClass
                        Session.Item("viewAircraftModelWeightClass") = localCriteria.ViewCriteriaWeightClass
                    Else
                        localCriteria.ViewCriteriaWeightClass = ""
                        Session.Item("viewAircraftModelWeightClass") = ""
                    End If
                ElseIf Not String.IsNullOrEmpty(Session.Item("viewAircraftModelWeightClass").ToString.Trim) And View_ID = 16 Then
                    localCriteria.ViewCriteriaWeightClass = Session.Item("viewAircraftModelWeightClass")
                Else
                    localCriteria.ViewCriteriaWeightClass = ""
                    Session.Item("viewAircraftModelWeightClass") = ""
                End If
            Else
                localCriteria.ViewCriteriaWeightClass = ""
                Session.Item("viewAircraftModelWeightClass") = ""
            End If

            ' get the "selected" items from the "company location drop-downs"
            If Not String.IsNullOrEmpty(Session.Item("viewRegionOrContinent").ToString.Trim) Then

                If Session.Item("viewRegionOrContinent").ToString.Trim.ToLower.Contains("continent") Then
                    localCriteria.ViewCriteriaUseContinent = True
                    localCriteria.ViewCriteriaUseRegion = False
                Else
                    localCriteria.ViewCriteriaUseContinent = False
                    localCriteria.ViewCriteriaUseRegion = True
                End If

            Else
                localCriteria.ViewCriteriaUseContinent = True
                localCriteria.ViewCriteriaUseRegion = False
                Session.Item("viewRegionOrContinent") = "Continent"
            End If

            localCriteria.ViewCriteriaHasCompanyLocationInfo = False

            ' pick up the Continent/Region from the "company location drop-downs"
            If Not String.IsNullOrEmpty(Session.Item("viewRegion").ToString.Trim) Then

                Dim continentArray() As String = Nothing

                ' Check and see if user selected more than one continent/region
                If InStr(Session.Item("viewRegion").ToString, Constants.cCommaDelim) Then
                    continentArray = Session.Item("viewRegion").ToString.Split(Constants.cCommaDelim)

                    If IsArray(continentArray) And Not IsNothing(continentArray) Then

                        localCriteria.ViewCriteriaContinentArray = continentArray

                    End If

                End If

                localCriteria.ViewCriteriaContinent = Session.Item("viewRegion").ToString
                localCriteria.ViewCriteriaHasCompanyLocationInfo = True

            Else
                localCriteria.ViewCriteriaContinent = ""
                Session.Item("viewRegion") = ""
            End If

            ' pick up the Continent from "view page selections"
            If Not IsNothing(Request.Item("viewContinent")) Then
                If Not String.IsNullOrEmpty(Request.Item("viewContinent").ToString) Then
                    If Not Request.Item("viewContinent").ToString.ToLower.Contains("clear") Then
                        localCriteria.ViewCriteriaContinent = Request.Item("viewContinent").ToString.Trim
                        localCriteria.ViewCriteriaHasCompanyLocationInfo = True
                    Else
                        localCriteria.ViewCriteriaContinent = ""
                    End If
                End If
            End If

            ' pick up the Country from the "company location drop-downs"
            If Not String.IsNullOrEmpty(Session.Item("viewCountry").ToString.Trim) Then

                Dim countryArray() As String = Nothing

                ' Check and see if user selected more than one country
                If InStr(Session.Item("viewCountry").ToString, Constants.cCommaDelim) Then
                    countryArray = Session.Item("viewCountry").ToString.Split(Constants.cCommaDelim)

                    If IsArray(countryArray) And Not IsNothing(countryArray) Then

                        localCriteria.ViewCriteriaCountryArray = countryArray

                    End If

                End If

                localCriteria.ViewCriteriaCountry = Session.Item("viewCountry").ToString
                localCriteria.ViewCriteriaHasCompanyLocationInfo = True

            Else
                localCriteria.ViewCriteriaCountry = ""
                Session.Item("viewCountry") = ""
            End If

            ' pick up the country from "view page selections"
            If Not IsNothing(Request.Item("viewCountry")) Then
                If Not String.IsNullOrEmpty(Request.Item("viewCountry").ToString) Then
                    If Not Request.Item("viewCountry").ToString.ToLower.Contains("clear") Then
                        localCriteria.ViewCriteriaCountry = Request.Item("viewCountry").ToString.Trim
                        localCriteria.ViewCriteriaHasCompanyLocationInfo = True
                    Else
                        localCriteria.ViewCriteriaCountry = ""
                    End If
                End If
            End If

            ' pick up the state from the "company location drop-downs"
            If Not String.IsNullOrEmpty(Session.Item("viewState").ToString.Trim) Then

                Dim stateArray() As String = Nothing

                ' Check and see if user selected more than one state
                If InStr(Session.Item("viewState").ToString, Constants.cCommaDelim) Then
                    stateArray = Session.Item("viewState").ToString.Split(Constants.cCommaDelim)

                    If IsArray(stateArray) And Not IsNothing(stateArray) Then

                        localCriteria.ViewCriteriaStateArray = stateArray

                    End If

                End If

                localCriteria.ViewCriteriaState = Session.Item("viewState").ToString
                localCriteria.ViewCriteriaHasCompanyLocationInfo = True

            Else
                localCriteria.ViewCriteriaState = ""
                Session.Item("viewState") = ""
            End If

            ' pick up the state from "view page selections"
            If Not IsNothing(Request.Item("viewState")) Then
                If Not String.IsNullOrEmpty(Request.Item("viewState").ToString) Then
                    If Not Request.Item("viewState").ToString.ToLower.Contains("clear") Then
                        localCriteria.ViewCriteriaState = Request.Item("viewState").ToString.Trim
                        localCriteria.ViewCriteriaHasCompanyLocationInfo = True
                    Else
                        localCriteria.ViewCriteriaState = ""
                    End If
                End If
            End If

            ' pick up the city from "view page selections"
            If Not IsNothing(Request.Item("viewCity")) Then
                If Not String.IsNullOrEmpty(Request.Item("viewCity").ToString) Then
                    If Not Request.Item("viewCity").ToString.ToLower.Contains("clear") Then
                        localCriteria.ViewCriteriaCity = Request.Item("viewCity").ToString.Trim
                    Else
                        localCriteria.ViewCriteriaCity = ""
                    End If
                Else
                    localCriteria.ViewCriteriaCity = ""
                End If
            Else
                localCriteria.ViewCriteriaCity = ""
            End If

            ' pick up the timeZone from the "company location drop-downs"
            If Not String.IsNullOrEmpty(Session.Item("viewTimeZone").ToString.Trim) Then

                Dim timeZoneArray() As String = Nothing

                ' Check and see if user selected more than one state
                If InStr(Session.Item("viewTimeZone").ToString, Constants.cCommaDelim) Then
                    timeZoneArray = Session.Item("viewTimeZone").ToString.Split(Constants.cCommaDelim)

                    If IsArray(timeZoneArray) And Not IsNothing(timeZoneArray) Then

                        localCriteria.ViewCriteriaTimeZoneArray = timeZoneArray

                    End If

                End If

                localCriteria.ViewCriteriaTimeZone = Session.Item("viewTimeZone").ToString
                localCriteria.ViewCriteriaHasCompanyLocationInfo = True

            Else
                localCriteria.ViewCriteriaTimeZone = ""
                Session.Item("viewTimeZone") = ""
            End If

            ' pick up the company from "view page selections"
            If Not IsNothing(Request.Item("viewCompany")) Then
                If Not String.IsNullOrEmpty(Request.Item("viewCompany").ToString) Then
                    localCriteria.ViewCriteriaCompanyID = CLng(Request.Item("viewCompany").ToString.Trim)
                Else
                    localCriteria.ViewCriteriaCompanyID = 0
                End If
            Else
                localCriteria.ViewCriteriaCompanyID = 0
            End If

            ' get the "selected" items from the "aircraft location drop-downs"
            If Not String.IsNullOrEmpty(Session.Item("baseRegionOrContinent").ToString.Trim) Then

                If Session.Item("baseRegionOrContinent").ToString.Trim.ToLower.Contains("continent") Then
                    localCriteria.ViewCriteriaBaseUseContinent = True
                    localCriteria.ViewCriteriaBaseUseRegion = False
                Else
                    localCriteria.ViewCriteriaBaseUseContinent = False
                    localCriteria.ViewCriteriaBaseUseRegion = True
                End If

            Else
                localCriteria.ViewCriteriaBaseUseContinent = True
                localCriteria.ViewCriteriaBaseUseRegion = False
                Session.Item("baseRegionOrContinent") = "Continent"
            End If

            ' pick up the Continent/Region from the "aircraft location drop-downs"
            If Not String.IsNullOrEmpty(Session.Item("baseRegion").ToString.Trim) Then

                Dim continentArray() As String = Nothing

                ' Check and see if user selected more than one continent/region
                If InStr(Session.Item("baseRegion").ToString, Constants.cCommaDelim) Then
                    continentArray = Session.Item("baseRegion").ToString.Split(Constants.cCommaDelim)

                    If IsArray(continentArray) And Not IsNothing(continentArray) Then

                        localCriteria.ViewCriteriaBaseContinentArray = continentArray

                    End If

                End If

                localCriteria.ViewCriteriaBaseContinent = Session.Item("baseRegion").ToString
                localCriteria.ViewCriteriaHasBaseLocationInfo = True

            Else
                localCriteria.ViewCriteriaBaseContinent = ""
                Session.Item("baseRegion") = ""
            End If

            ' pick up the Country from the "aircraft location drop-downs"
            If Not String.IsNullOrEmpty(Session.Item("baseCountry").ToString.Trim) Then

                Dim countryArray() As String = Nothing

                ' Check and see if user selected more than one country
                If InStr(Session.Item("baseCountry").ToString, Constants.cCommaDelim) Then
                    countryArray = Session.Item("baseCountry").ToString.Split(Constants.cCommaDelim)

                    If IsArray(countryArray) And Not IsNothing(countryArray) Then

                        localCriteria.ViewCriteriaBaseCountryArray = countryArray

                    End If

                End If

                localCriteria.ViewCriteriaBaseCountry = Session.Item("baseCountry").ToString
                localCriteria.ViewCriteriaHasBaseLocationInfo = True

            Else
                localCriteria.ViewCriteriaBaseCountry = ""
                Session.Item("baseCountry") = ""
            End If

            ' pick up the state from the "aircraft location drop-downs"
            If Not String.IsNullOrEmpty(Session.Item("baseState").ToString.Trim) Then

                Dim stateArray() As String = Nothing

                ' Check and see if user selected more than one state
                If InStr(Session.Item("baseState").ToString, Constants.cCommaDelim) Then
                    stateArray = Session.Item("baseState").ToString.Split(Constants.cCommaDelim)

                    If IsArray(stateArray) And Not IsNothing(stateArray) Then

                        localCriteria.ViewCriteriaBaseStateArray = stateArray

                    End If

                End If

                localCriteria.ViewCriteriaBaseState = Session.Item("baseState").ToString
                localCriteria.ViewCriteriaHasBaseLocationInfo = True

            Else
                localCriteria.ViewCriteriaBaseState = ""
                Session.Item("baseState") = ""
            End If

            If (View_ID < 2) Or View_ID = 11 Then

                If Not IsNothing(Request.Item("tabStarReportID")) Then
                    If Not String.IsNullOrEmpty(Request.Item("tabStarReportID").ToString) Then
                        If CInt(Request.Item("tabStarReportID").ToString) > -1 Then
                            localCriteria.ViewCriteriaStarReportID = CInt(Request.Item("tabStarReportID").ToString)
                        Else
                            localCriteria.ViewCriteriaStarReportID = -1
                            localCriteria.ViewCriteriaStarReportDate = Now.ToString
                        End If
                    End If
                End If

                ' might need to reseet view to 0 if > 2 < 16
                If Not IsNothing(HttpContext.Current.Session.Item("localPreferences")) And localCriteria.ViewCriteriaAmodID = -1 And localCriteria.ViewCriteriaMakeAmodID = -1 Then

                    commonEvo.fillAirframeArray("")
                    commonEvo.fillAircraftTypeLableArray("")

                    If IsNumeric(HttpContext.Current.Session.Item("localPreferences").DefaultModel) And CLng(HttpContext.Current.Session.Item("localPreferences").DefaultModel.ToString) > -1 Then
                        localCriteria.ViewCriteriaAmodID = HttpContext.Current.Session.Item("localPreferences").DefaultModel
                    Else
                        ' ADDED MSW - 8/4/15---------
                        ' CHECKS AND MAKES SURE YOU CAN SEE THE DEFAULT OR SELECTED MODEL
                        Call check_and_reset_model()
                    End If

                    Session.Item("viewAircraftModel") = commonEvo.FindIndexForItemByAmodID(localCriteria.ViewCriteriaAmodID)
                    Session.Item("viewAircraftMake") = Session.Item("viewAircraftModel")
                    Session.Item("viewAircraftType") = Session.Item("viewAircraftModel")

                    If commonEvo.ReturnModelDataFromIndex(CLng(Session.Item("viewAircraftModel").ToString), sAirFrame, sAirType, sMake, sModel, sUsage) Then
                        localCriteria.ViewCriteriaAirframeTypeStr = sAirFrame
                        localCriteria.ViewCriteriaAircraftType = sAirType
                        localCriteria.ViewCriteriaAircraftModel = sModel
                    End If

                Else 'If CRMViewActive Then

                    'This had to be added in. In the Model View if this doesn't get filled up,
                    'Everything gets set to -1 and then nothing gets filled up correctly.
                    'Since these should only fill once, it shouldn't cause any issues if I put the fill up right here.
                    'if the variable already exists and is filled, it won't do anything.
                    commonEvo.fillAirframeArray("")
                    commonEvo.fillAircraftTypeLableArray("")

                    If Not String.IsNullOrEmpty(aftt_end.Text) Then
                        If IsNumeric(aftt_end.Text) Then
                            localCriteria.ViewCriteriaAFTTEnd = aftt_end.Text
                        End If
                    End If

                    If Not String.IsNullOrEmpty(aftt_start.Text) Then
                        If IsNumeric(aftt_start.Text) Then
                            localCriteria.ViewCriteriaAFTTStart = aftt_start.Text
                        End If
                    End If

                    If Not String.IsNullOrEmpty(year_start.Text) Then
                        If IsNumeric(year_start.Text) Then
                            localCriteria.ViewCriteriaYearStart = year_start.Text
                        End If
                    End If

                    If Not String.IsNullOrEmpty(year_end.Text) Then
                        If IsNumeric(year_end.Text) Then
                            localCriteria.ViewCriteriaYearEnd = year_end.Text
                        End If
                    End If

                    'if we are coming back from the other page 
                    If Trim(Request("extra_amod")) <> "" And VariantList.SelectedValue = "" And Not IsPostBack Then
                        localCriteria.ViewCriteriaAmodIDArray = Split(Trim(Request("extra_amod")), ",")
                        Call load_full_model_view()
                        bottom_tab_update_panel.Update()
                        Me.view_retail_sales_label1.Text = Me.view_retail_sales_label1.Text
                    ElseIf VariantList.SelectedValue <> "" Then
                        localCriteria.ViewCriteriaAmodIDArray = Split(clsGeneral.clsGeneral.ExtractSelectedStringFromListboxDropdown(VariantList, False, 0, True) & "," & localCriteria.ViewCriteriaAmodID.ToString, ",")
                    End If




                    If localCriteria.ViewCriteriaAmodID > -1 Then
                        Session.Item("viewAircraftModel") = commonEvo.FindIndexForItemByAmodID(localCriteria.ViewCriteriaAmodID)
                        Session.Item("viewAircraftMake") = Session.Item("viewAircraftModel")
                        Session.Item("viewAircraftType") = Session.Item("viewAircraftModel")
                        If commonEvo.ReturnModelDataFromIndex(CLng(Session.Item("viewAircraftModel").ToString), sAirFrame, sAirType, sMake, sModel, sUsage) Then
                            localCriteria.ViewCriteriaAirframeTypeStr = sAirFrame
                            localCriteria.ViewCriteriaAircraftType = sAirType
                            localCriteria.ViewCriteriaAircraftModel = sModel
                        End If
                    ElseIf localCriteria.ViewCriteriaMakeAmodID > -1 Then
                        Session.Item("viewAircraftMake") = commonEvo.FindIndexForItemByAmodID(localCriteria.ViewCriteriaMakeAmodID)
                        Session.Item("viewAircraftType") = Session.Item("viewAircraftMake").ToString
                        If commonEvo.ReturnModelDataFromIndex(CLng(Session.Item("viewAircraftMake").ToString), sAirFrame, sAirType, sMake, sModel, sUsage) Then
                            localCriteria.ViewCriteriaAirframeTypeStr = sAirFrame
                            localCriteria.ViewCriteriaAircraftType = sAirType
                            localCriteria.ViewCriteriaAircraftMake = sMake
                            localCriteria.ViewCriteriaAmodID = -1
                        End If
                    Else

                        ' ADDED MSW - 8/4/15---------
                        ' CHECKS AND MAKES SURE YOU CAN SEE THE DEFAULT OR SELECTED MODEL
                        Call check_and_reset_model()
                        '------------------------------------------------

                    End If

                End If


                Me.permenant_amod_id.Text = localCriteria.ViewCriteriaAmodID.ToString

                localCriteria.ViewCriteriaTimeSpan = selectViewTimeSpan.SelectedValue

            Else

                commonEvo.fillAirframeArray("")
                commonEvo.fillAircraftTypeLableArray("")
                commonEvo.fillDefaultAirframeArray("")

                localCriteria.ViewCriteriaTimeSpan = selectMarketTimeSpan.SelectedValue

                'pick up the selected variables from the current view
                Select Case View_ID
                    Case 2 ' model compare view

                        If Not IsNothing(HttpContext.Current.Session.Item("localPreferences")) And localCriteria.ViewCriteriaAmodID = -1 And String.IsNullOrEmpty(compare_amod_id_a.SelectedValue) Then

                            If IsNumeric(HttpContext.Current.Session.Item("localPreferences").DefaultModel) And CLng(HttpContext.Current.Session.Item("localPreferences").DefaultModel.ToString) > -1 Then
                                localCriteria.ViewCriteriaAmodID = HttpContext.Current.Session.Item("localPreferences").DefaultModel
                            Else
                                If Not isHeliOnlyProduct Then
                                    localCriteria.ViewCriteriaAmodID = 272
                                Else
                                    localCriteria.ViewCriteriaAmodID = 442
                                End If
                            End If

                            If Not IsNothing(Request.Item("amod_id_a")) Then
                                If Not String.IsNullOrEmpty(Request.Item("amod_id_a").ToString) Then
                                    localCriteria.ViewCriteriaAmodID = CLng(Request.Item("amod_id_a").ToString)
                                End If
                            End If

                            compare_amod_id_a.SelectedValue = localCriteria.ViewCriteriaAmodID.ToString

                        Else

                            If Not IsNothing(compare_amod_id_a) Then
                                If Not String.IsNullOrEmpty(compare_amod_id_a.SelectedValue) Then
                                    localCriteria.ViewCriteriaAmodID = CLng(compare_amod_id_a.SelectedValue)
                                Else
                                    If Not IsNothing(Request.Item("amod_id_a")) Then
                                        If Not String.IsNullOrEmpty(Request.Item("amod_id_a").ToString) Then
                                            localCriteria.ViewCriteriaAmodID = CLng(Request.Item("amod_id_a").ToString)
                                            compare_amod_id_a.SelectedValue = localCriteria.ViewCriteriaAmodID.ToString
                                        End If
                                    End If
                                End If

                            End If
                        End If

                        If Not IsNothing(compare_amod_id_b) Then
                            If localCriteria.ViewCriteriaSecondAmodID = -1 And String.IsNullOrEmpty(compare_amod_id_b.SelectedValue) Then

                                If Not IsNothing(Request.Item("amod_id_b")) Then
                                    If Not String.IsNullOrEmpty(Request.Item("amod_id_b").ToString) Then
                                        localCriteria.ViewCriteriaSecondAmodID = CLng(Request.Item("amod_id_b").ToString)
                                    Else
                                        localCriteria.ViewCriteriaSecondAmodID = localCriteria.ViewCriteriaAmodID
                                    End If

                                Else
                                    localCriteria.ViewCriteriaSecondAmodID = localCriteria.ViewCriteriaAmodID
                                End If

                                compare_amod_id_b.SelectedValue = localCriteria.ViewCriteriaSecondAmodID.ToString

                            Else
                                localCriteria.ViewCriteriaSecondAmodID = CLng(compare_amod_id_b.SelectedValue)
                            End If

                        Else

                            If localCriteria.ViewCriteriaSecondAmodID = -1 Then
                                If Not IsNothing(Request.Item("amod_id_b")) Then
                                    If Not String.IsNullOrEmpty(Request.Item("amod_id_b").ToString) Then
                                        localCriteria.ViewCriteriaSecondAmodID = CLng(Request.Item("amod_id_b").ToString)
                                    Else
                                        localCriteria.ViewCriteriaSecondAmodID = localCriteria.ViewCriteriaAmodID
                                    End If

                                Else
                                    localCriteria.ViewCriteriaSecondAmodID = localCriteria.ViewCriteriaAmodID
                                End If
                            End If

                            compare_amod_id_b.SelectedValue = localCriteria.ViewCriteriaSecondAmodID.ToString

                        End If

                        If Not IsNothing(compare_amod_id_c) Then
                            If localCriteria.ViewCriteriaThirdAmodID = -1 And String.IsNullOrEmpty(compare_amod_id_c.SelectedValue) Then
                                If Not IsNothing(Request.Item("amod_id_c")) Then
                                    If Not String.IsNullOrEmpty(Request.Item("amod_id_c").ToString) Then
                                        localCriteria.ViewCriteriaThirdAmodID = CLng(Request.Item("amod_id_c").ToString)
                                    Else
                                        localCriteria.ViewCriteriaThirdAmodID = -1
                                    End If

                                Else
                                    localCriteria.ViewCriteriaThirdAmodID = -1
                                End If

                                compare_amod_id_c.SelectedValue = IIf(Not localCriteria.ViewCriteriaThirdAmodID.ToString.Contains("-1"), localCriteria.ViewCriteriaThirdAmodID.ToString, "")

                            Else
                                localCriteria.ViewCriteriaThirdAmodID = CLng(compare_amod_id_c.SelectedValue)
                            End If

                        Else
                            If localCriteria.ViewCriteriaThirdAmodID = -1 Then
                                If Not IsNothing(Request.Item("amod_id_c")) Then
                                    If Not String.IsNullOrEmpty(Request.Item("amod_id_c").ToString) Then
                                        localCriteria.ViewCriteriaThirdAmodID = CLng(Request.Item("amod_id_c").ToString)
                                    Else
                                        localCriteria.ViewCriteriaThirdAmodID = -1
                                    End If

                                Else
                                    localCriteria.ViewCriteriaThirdAmodID = -1
                                End If
                            End If

                            compare_amod_id_c.SelectedValue = IIf(Not localCriteria.ViewCriteriaThirdAmodID.ToString.Contains("-1"), localCriteria.ViewCriteriaThirdAmodID.ToString, "")

                        End If

                    Case 3 ' operator view

                        ' pick up the operator engine
                        If Not IsNothing(Request.Item("operatorViewEngine")) Then
                            If Not String.IsNullOrEmpty(Request.Item("operatorViewEngine").ToString) Then
                                localCriteria.ViewCriteriaEngineName = Request.Item("operatorViewEngine").ToString.Trim
                            Else
                                localCriteria.ViewCriteriaEngineName = ""
                            End If
                        Else
                            localCriteria.ViewCriteriaEngineName = ""
                        End If

                        If Not IsNothing(Request.Item("viewWeight")) Then
                            If Not String.IsNullOrEmpty(Request.Item("viewWeight").ToString) Then
                                localCriteria.ViewCriteriaSPIWeightClass = Request.Item("viewWeight").ToString.Trim
                            Else
                                localCriteria.ViewCriteriaSPIWeightClass = ""
                            End If
                        Else
                            localCriteria.ViewCriteriaSPIWeightClass = ""
                        End If


                    Case 4 ' documents

                        localCriteria.ViewCriteriaShowInternal = chk_internal_transactions.Checked

                        ' pick up the financial institution from the list box
                        If Not IsNothing(lbFinancialInstitutions) And lbFinancialInstitutions.Items.Count > 1 Then
                            If Not IsNothing(lbFinancialInstitutions.SelectedValue) And Not String.IsNullOrEmpty(lbFinancialInstitutions.SelectedValue.Trim) Then
                                localCriteria.ViewCriteriaCompanyID = CLng(lbFinancialInstitutions.SelectedValue.ToString)
                            Else
                                localCriteria.ViewCriteriaCompanyID = 0
                                lbFinancialInstitutions.SelectedValue = ""
                            End If

                        Else ' pick up the financial institution from the request variable
                            If Not IsNothing(Request.Item("viewCompany")) Then
                                If Not String.IsNullOrEmpty(Request.Item("viewCompany").ToString.Trim) Then
                                    localCriteria.ViewCriteriaCompanyID = CLng(Request.Item("viewCompany").ToString.Trim)
                                Else
                                    localCriteria.ViewCriteriaCompanyID = 0
                                    lbFinancialInstitutions.SelectedValue = ""
                                End If
                            Else
                                localCriteria.ViewCriteriaCompanyID = 0
                                lbFinancialInstitutions.SelectedValue = ""
                            End If
                        End If

                        If Not IsNothing(viewFinancialStartDate) Then

                            If Not String.IsNullOrEmpty(viewFinancialStartDate.Text.ToString) And IsDate(viewFinancialStartDate.Text) Then
                                localCriteria.ViewCriteriaDocumentsStartDate = viewFinancialStartDate.Text.Trim
                            Else
                                If Not IsNothing(Session.Item("viewDocsStartDate")) Then
                                    If Not String.IsNullOrEmpty(Session.Item("viewDocsStartDate").ToString.Trim) And IsDate(Session.Item("viewDocsStartDate").ToString) Then
                                        localCriteria.ViewCriteriaDocumentsStartDate = Session.Item("viewDocsStartDate").ToString.Trim
                                    Else
                                        localCriteria.ViewCriteriaDocumentsStartDate = FormatDateTime(DateAdd(DateInterval.Month, (-1 * 6), CDate(Now.ToShortDateString)).ToString, DateFormat.ShortDate)
                                    End If
                                Else
                                    localCriteria.ViewCriteriaDocumentsStartDate = FormatDateTime(DateAdd(DateInterval.Month, (-1 * 6), CDate(Now.ToShortDateString)).ToString, DateFormat.ShortDate)
                                End If
                            End If

                            viewFinancialStartDate.Text = FormatDateTime(CDate(localCriteria.ViewCriteriaDocumentsStartDate), DateFormat.ShortDate)
                            Session.Item("viewDocsStartDate") = localCriteria.ViewCriteriaDocumentsStartDate

                        End If

                        If Not IsNothing(viewFinancialEndDate) Then

                            If Not String.IsNullOrEmpty(viewFinancialEndDate.Text.ToString) And IsDate(viewFinancialEndDate.Text) Then
                                localCriteria.ViewCriteriaDocumentsEndDate = viewFinancialEndDate.Text.Trim
                            Else
                                If Not IsNothing(Session.Item("viewDocsEndDate")) Then
                                    If Not String.IsNullOrEmpty(Session.Item("viewDocsEndDate").ToString.Trim) And IsDate(Session.Item("viewDocsEndDate").ToString) Then
                                        localCriteria.ViewCriteriaDocumentsEndDate = Session.Item("viewDocsEndDate").ToString.Trim
                                    Else
                                        localCriteria.ViewCriteriaDocumentsEndDate = Now.ToShortDateString
                                    End If
                                Else
                                    localCriteria.ViewCriteriaDocumentsEndDate = Now.ToShortDateString
                                End If
                            End If

                            viewFinancialEndDate.Text = FormatDateTime(CDate(localCriteria.ViewCriteriaDocumentsEndDate), DateFormat.ShortDate)
                            Session.Item("viewDocsEndDate") = localCriteria.ViewCriteriaDocumentsEndDate

                        End If

                        If Not IsNothing(viewFinancialTxsddl) And viewFinancialTxsddl.Items.Count > 1 Then
                            If Not IsNothing(viewFinancialTxsddl.SelectedValue) And Not String.IsNullOrEmpty(viewFinancialTxsddl.SelectedValue.Trim) Then
                                localCriteria.ViewCriteriaDocumentsTxType = viewFinancialTxsddl.SelectedValue.ToString
                            Else
                                localCriteria.ViewCriteriaDocumentsTxType = ""
                                viewFinancialTxsddl.SelectedValue = ""
                            End If
                        End If

                        If Not IsNothing(lbFinancialDocType) And lbFinancialDocType.Items.Count > 1 Then

                            ' get selected values
                            For i As Integer = 0 To lbFinancialDocType.Items.Count - 1

                                If lbFinancialDocType.Items(i).Selected Then
                                    If String.IsNullOrEmpty(localCriteria.ViewCriteriaDocumentType) Then
                                        localCriteria.ViewCriteriaDocumentType = lbFinancialDocType.Items(i).Value
                                    Else
                                        localCriteria.ViewCriteriaDocumentType += Constants.cCommaDelim + lbFinancialDocType.Items(i).Value
                                    End If
                                End If

                            Next

                        Else ' pick up the financial doc Type from the request variable
                            If Not IsNothing(Request.Item("viewDocType")) Then
                                If Not String.IsNullOrEmpty(Request.Item("viewDocType").ToString.Trim) Then
                                    localCriteria.ViewCriteriaDocumentType = Request.Item("viewDocType").ToString.Trim
                                Else
                                    localCriteria.ViewCriteriaDocumentType = ""
                                    lbFinancialDocType.SelectedValue = ""
                                End If
                            Else
                                localCriteria.ViewCriteriaDocumentType = ""
                                lbFinancialDocType.SelectedValue = ""
                            End If
                        End If

                    Case 6 ' star view

                        ' pick up star report request variables
                        If Not IsNothing(Request.Item("reportYear")) Then
                            If Not String.IsNullOrEmpty(Request.Item("reportYear").ToString) Then
                                localCriteria.ViewCriteriaStarReportYear = CInt(Request.Item("reportYear").ToString)
                            End If
                        End If

                        If Not IsNothing(Request.Item("reportID")) Then
                            If Not String.IsNullOrEmpty(Request.Item("reportID").ToString) Then
                                localCriteria.ViewCriteriaStarReportID = CInt(Request.Item("reportID").ToString)
                            End If
                        End If

                        If Not IsNothing(Request.Item("reportType")) Then
                            If Not String.IsNullOrEmpty(Request.Item("reportType").ToString) Then
                                localCriteria.ViewCriteriaStarReportType = Request.Item("reportType").ToString
                            End If
                        End If

                        If Not IsNothing(Request.Item("reportDate")) Then
                            If Not String.IsNullOrEmpty(Request.Item("reportDate").ToString) Then
                                localCriteria.ViewCriteriaStarReportDate = Request.Item("reportDate").ToString
                            End If
                        End If

                        If Not IsNothing(Request.Item("reportPrefix")) Then
                            If Not String.IsNullOrEmpty(Request.Item("reportPrefix").ToString) Then
                                localCriteria.ViewCriteriaStarReportPrefix = Request.Item("reportPrefix").ToString
                            End If
                        End If

                        If Not IsNothing(Request.Item("reportSuffix")) Then
                            If Not String.IsNullOrEmpty(Request.Item("reportSuffix").ToString) Then
                                localCriteria.ViewCriteriaStarReportSuffix = Request.Item("reportSuffix").ToString
                            End If
                        End If

                        If Not IsNothing(Request.Item("reportCatagory")) Then
                            If Not String.IsNullOrEmpty(Request.Item("reportCatagory").ToString) Then
                                localCriteria.ViewCriteriaStarReportCatagory = Request.Item("reportCatagory").ToString
                            End If
                        End If

                    Case 7 ' fractional view

                        ' pick up the fractional program from the list box
                        If Not IsNothing(lbFractionalProgram) And lbFractionalProgram.Items.Count > 1 Then
                            If Not IsNothing(lbFractionalProgram.SelectedValue) And Not String.IsNullOrEmpty(lbFractionalProgram.SelectedValue.Trim) Then
                                localCriteria.ViewCriteriaFractionalProgramID = CLng(lbFractionalProgram.SelectedValue.ToString)
                            Else
                                localCriteria.ViewCriteriaFractionalProgramID = 0
                                localCriteria.ViewCriteriaFractionalProgramName = ""
                                lbFractionalProgram.SelectedValue = ""
                            End If
                        Else ' pick up the fractional program from the request variable
                            If Not IsNothing(Request.Item("selectFractionalProgram")) Then
                                If Not String.IsNullOrEmpty(Request.Item("selectFractionalProgram").ToString.Trim) Then
                                    localCriteria.ViewCriteriaFractionalProgramID = CLng(Request.Item("selectFractionalProgram").ToString.Trim)
                                Else
                                    localCriteria.ViewCriteriaFractionalProgramID = 0
                                    localCriteria.ViewCriteriaFractionalProgramName = ""
                                    lbFractionalProgram.SelectedValue = ""
                                End If
                            Else
                                localCriteria.ViewCriteriaFractionalProgramID = 0
                                localCriteria.ViewCriteriaFractionalProgramName = ""
                                lbFractionalProgram.SelectedValue = ""
                            End If
                        End If

                        ' pick up the fractional model from the list box
                        If Not IsNothing(lbFractionalModel) And lbFractionalModel.Items.Count > 1 Then

                            If Not IsNothing(lbFractionalModel.SelectedValue) And Not String.IsNullOrEmpty(lbFractionalModel.SelectedValue.Trim) Then
                                Session.Item("viewAircraftModel") = commonEvo.FindIndexForItemByAmodID(CLng(lbFractionalModel.SelectedValue.ToString))
                                Session.Item("viewAircraftMake") = Session.Item("viewAircraftModel")
                                Session.Item("viewAircraftType") = Session.Item("viewAircraftModel")
                                If commonEvo.ReturnModelDataFromIndex(CLng(Session.Item("viewAircraftModel").ToString), sAirFrame, sAirType, sMake, sModel, sUsage) Then
                                    localCriteria.ViewCriteriaAirframeTypeStr = sAirFrame
                                    localCriteria.ViewCriteriaAircraftType = sAirType
                                    localCriteria.ViewCriteriaAircraftModel = sModel
                                End If
                                localCriteria.ViewCriteriaAmodID = CLng(lbFractionalModel.SelectedValue.ToString)
                            ElseIf Not IsNothing(lbFractionalModel.SelectedValue) And String.IsNullOrEmpty(lbFractionalModel.SelectedValue.Trim) Then
                                ' clean out session variables
                                Session.Item("viewAircraftModel") = ""
                                localCriteria.ViewCriteriaAircraftModel = ""
                                Session.Item("viewAircraftMake") = ""
                                localCriteria.ViewCriteriaAircraftMake = ""
                                Session.Item("viewAircraftType") = ""
                                localCriteria.ViewCriteriaAircraftType = ""

                                localCriteria.ViewCriteriaAmodID = -1
                                localCriteria.ViewCriteriaAirframeTypeStr = ""
                                localCriteria.ViewCriteriaAircraftType = ""
                                lbFractionalModel.SelectedValue = ""

                            End If

                        Else ' pick up the fractional model from the request variable

                            lbFractionalModel.SelectedValue = localCriteria.ViewCriteriaAmodID.ToString

                        End If

            ' if user hasn't set a fractional model but picked a fractional program clear model
            'If localCriteria.ViewCriteriaFractionalProgramID > 0 Then
            '  Session.Item("viewAircraftModel") = ""
            '  Session.Item("viewAircraftMake") = ""
            '  Session.Item("viewAircraftType") = ""
            '  localCriteria.ViewCriteriaAmodID = -1
            'End If

                    Case 8  ' location

                        If Not IsNothing(HttpContext.Current.Session.Item("localPreferences")) And localCriteria.ViewCriteriaAmodID = -1 Then

                            If IsNumeric(HttpContext.Current.Session.Item("localPreferences").DefaultModel) And CLng(HttpContext.Current.Session.Item("localPreferences").DefaultModel.ToString) > -1 Then
                                localCriteria.ViewCriteriaAmodID = HttpContext.Current.Session.Item("localPreferences").DefaultModel
                            Else
                                'If Not isHeliOnlyProduct Then
                                '  localCriteria.ViewCriteriaAmodID = 272
                                'Else
                                '  localCriteria.ViewCriteriaAmodID = 442
                                'End If
                            End If
                        End If

                        localCriteria.ViewCriteriaLocationViewType = CInt(locationViewTypeID.SelectedValue.ToString)

                        If Not IsNothing(view_location_display_by) Then
                            If Not String.IsNullOrEmpty(view_location_display_by.Text.Trim) Then
                                localCriteria.ViewCriteriaLocationViewSort = CInt(view_location_display_by.SelectedValue.ToString)
                            End If
                        End If

                        If Not IsNothing(view_location_clear_list) Then
                            If Not String.IsNullOrEmpty(view_location_clear_list.Text.Trim) Then
                                Response.Redirect(view_location_clear_list.SelectedValue.ToString)
                            End If
                        End If

                    Case 9 ' market trends

                        ' pick up the makename
                        If Not IsNothing(Request.Item("make_name")) Then
                            If Not String.IsNullOrEmpty(Request.Item("make_name").ToString) Then
                                localCriteria.ViewCriteriaAircraftMake = Request.Item("make_name").ToString.Trim

                                localCriteria.ViewCriteriaMakeAmodID = commonEvo.ReturnAmodIDForItemIndex(commonEvo.FindIndexForFirstItem(localCriteria.ViewCriteriaAircraftMake, Constants.AIRFRAME_MAKE))
                                Session.Item("viewAircraftMake") = commonEvo.FindIndexForItemByAmodID(localCriteria.ViewCriteriaMakeAmodID)
                                Session.Item("viewAircraftType") = Session.Item("viewAircraftMake")
                                If commonEvo.ReturnModelDataFromIndex(CLng(Session.Item("viewAircraftMake").ToString), sAirFrame, sAirType, sMake, sModel, sUsage) Then
                                    localCriteria.ViewCriteriaAirframeTypeStr = sAirFrame
                                    localCriteria.ViewCriteriaAircraftType = sAirType
                                End If

                            Else
                                localCriteria.ViewCriteriaMakeAmodID = -1
                                localCriteria.ViewCriteriaAircraftMake = ""
                                Session.Item("viewAircraftMake") = ""
                            End If
                        Else ' check the makeAmodId to see if they selected through the type/make/model list boxes (only if model not selected)
                            If localCriteria.ViewCriteriaMakeAmodID > -1 And localCriteria.ViewCriteriaAmodID = -1 Then
                                Session.Item("viewAircraftMake") = commonEvo.FindIndexForItemByAmodID(localCriteria.ViewCriteriaMakeAmodID)
                                Session.Item("viewAircraftType") = Session.Item("viewAircraftMake").ToString
                                If commonEvo.ReturnModelDataFromIndex(CLng(Session.Item("viewAircraftMake").ToString), sAirFrame, sAirType, sMake, sModel, sUsage) Then
                                    localCriteria.ViewCriteriaAirframeTypeStr = sAirFrame
                                    localCriteria.ViewCriteriaAircraftType = sAirType
                                    localCriteria.ViewCriteriaAircraftMake = sMake
                                    localCriteria.ViewCriteriaAmodID = -1
                                End If
                            ElseIf localCriteria.ViewCriteriaAmodID > -1 Then
                                Session.Item("viewAircraftModel") = commonEvo.FindIndexForItemByAmodID(localCriteria.ViewCriteriaAmodID)
                                Session.Item("viewAircraftMake") = Session.Item("viewAircraftModel")
                                Session.Item("viewAircraftType") = Session.Item("viewAircraftModel")
                                If commonEvo.ReturnModelDataFromIndex(CLng(Session.Item("viewAircraftModel").ToString), sAirFrame, sAirType, sMake, sModel, sUsage) Then
                                    localCriteria.ViewCriteriaAirframeTypeStr = sAirFrame
                                    localCriteria.ViewCriteriaAircraftType = sAirType
                                    localCriteria.ViewCriteriaAircraftModel = sModel
                                End If

                            End If
                        End If

                    Case 10  ' charter

                        If String.IsNullOrEmpty(localCriteria.ViewCriteriaAirframeTypeStr) Then
                        End If

                        ' pick up the charter airframe only if model is NOT selected
                        If localCriteria.ViewCriteriaAmodID = -1 Then
                            If Not IsNothing(Request.Item("viewAirframe")) Then
                                If Not String.IsNullOrEmpty(Request.Item("viewAirframe").ToString) Then
                                    localCriteria.ViewCriteriaAirframeTypeStr = Request.Item("viewAirframe").ToString.Trim
                                Else
                                    localCriteria.ViewCriteriaAirframeTypeStr = ""
                                End If
                            Else
                                localCriteria.ViewCriteriaAirframeTypeStr = ""
                            End If
                        End If

                    Case 12 ' spi

                        If Not IsNothing(HttpContext.Current.Session.Item("localPreferences")) And localCriteria.ViewCriteriaAmodID = -1 Then

                            If IsNumeric(HttpContext.Current.Session.Item("localPreferences").DefaultModel) And CLng(HttpContext.Current.Session.Item("localPreferences").DefaultModel.ToString) > -1 Then
                                localCriteria.ViewCriteriaAmodID = HttpContext.Current.Session.Item("localPreferences").DefaultModel
                            Else
                                If Not isHeliOnlyProduct Then
                                    localCriteria.ViewCriteriaAmodID = 272
                                Else
                                    localCriteria.ViewCriteriaAmodID = 442
                                End If
                            End If
                        End If

                        If commonEvo.ReturnModelDataFromIndex(commonEvo.FindIndexForItemByAmodID(localCriteria.ViewCriteriaAmodID), sAirFrame, sAirType, sMake, sModel, sUsage) Then
                            localCriteria.ViewCriteriaAircraftMake = sMake
                            localCriteria.ViewCriteriaAircraftModel = sModel
                        End If

                        localCriteria.ViewCriteriaSPIYearSld1 = "2005"

                        If localCriteria.ViewCriteriaAmodID > -1 Then
                            localDatalayer.get_model_weight_class_type_code(localCriteria.ViewCriteriaAmodID, localCriteria.ViewCriteriaSPIWeightClass, localCriteria.viewCriteriaSPIAirframe)
                        End If

                    Case 13 ' lease view

                    Case 14 ' manufacturer view

                        If Not bIsReport Then
                            HttpContext.Current.Session.Item("evoViewCriteria") = localCriteria ' save selections if user wants report
                        Else
                            localCriteria = HttpContext.Current.Session.Item("evoViewCriteria") ' use saved selections for report
                            localCriteria.ViewCriteriaIsReport = bIsReport ' set report flag on criteria
                        End If

                    Case 15

                    Case 16 ' industry at a glance

                        ' pick up the makename
                        If Not IsNothing(Request.Item("make_name")) Then
                            If Not String.IsNullOrEmpty(Request.Item("make_name").ToString) Then

                                localCriteria.ViewCriteriaAircraftMake = Request.Item("make_name").ToString.Trim
                                localCriteria.ViewCriteriaMakeAmodID = commonEvo.ReturnAmodIDForItemIndex(commonEvo.FindIndexForFirstItem(localCriteria.ViewCriteriaAircraftMake, Constants.AIRFRAME_MAKE))

                                Session.Item("viewAircraftMake") = commonEvo.FindIndexForItemByAmodID(localCriteria.ViewCriteriaMakeAmodID)
                                Session.Item("viewAircraftType") = Session.Item("viewAircraftMake")
                                If commonEvo.ReturnModelDataFromIndex(CLng(Session.Item("viewAircraftMake").ToString), sAirFrame, sAirType, sMake, sModel, sUsage) Then
                                    localCriteria.ViewCriteriaAirframeTypeStr = sAirFrame
                                    localCriteria.ViewCriteriaAircraftType = sAirType
                                End If
                            Else
                                localCriteria.ViewCriteriaMakeAmodID = -1
                                localCriteria.ViewCriteriaAircraftMake = ""
                                Session.Item("viewAircraftMake") = ""
                            End If
                        Else ' check the makeAmodId first to see if they selected through the type/make/model list boxes (only if model not selected)
                            If localCriteria.ViewCriteriaMakeAmodID > -1 And localCriteria.ViewCriteriaAmodID = -1 Then
                                Session.Item("viewAircraftMake") = commonEvo.FindIndexForItemByAmodID(localCriteria.ViewCriteriaMakeAmodID)
                                Session.Item("viewAircraftType") = Session.Item("viewAircraftMake").ToString
                                If commonEvo.ReturnModelDataFromIndex(CLng(Session.Item("viewAircraftMake").ToString), sAirFrame, sAirType, sMake, sModel, sUsage) Then
                                    localCriteria.ViewCriteriaAirframeTypeStr = sAirFrame
                                    localCriteria.ViewCriteriaAircraftType = sAirType
                                    localCriteria.ViewCriteriaAircraftMake = sMake
                                    localCriteria.ViewCriteriaAmodID = -1
                                End If
                            ElseIf localCriteria.ViewCriteriaAmodID > -1 Then
                                Session.Item("viewAircraftModel") = commonEvo.FindIndexForItemByAmodID(localCriteria.ViewCriteriaAmodID)
                                Session.Item("viewAircraftMake") = Session.Item("viewAircraftModel")
                                Session.Item("viewAircraftType") = Session.Item("viewAircraftModel")
                                If commonEvo.ReturnModelDataFromIndex(CLng(Session.Item("viewAircraftModel").ToString), sAirFrame, sAirType, sMake, sModel, sUsage) Then
                                    localCriteria.ViewCriteriaAirframeTypeStr = sAirFrame
                                    localCriteria.ViewCriteriaAircraftType = sAirType
                                    localCriteria.ViewCriteriaAircraftModel = sModel
                                End If

                            End If
                        End If

                    Case 25 ' notes view

                        If Not bIsReport Then

                            If Not IsNothing(notesSearch_for_txt) Then
                                If Not String.IsNullOrEmpty(notesSearch_for_txt.Text.Trim) Then
                                    localCriteria.ViewCriteriaNoteTextValue = notesSearch_for_txt.Text.Trim
                                Else
                                    localCriteria.ViewCriteriaNoteTextValue = ""
                                End If
                            Else
                                localCriteria.ViewCriteriaNoteTextValue = ""
                            End If

                            If Not IsNothing(notesSearch_who) And notesSearch_who.Items.Count > 0 Then

                                If Not IsNothing(notesSearch_who.SelectedValue) And Not String.IsNullOrEmpty(notesSearch_who.SelectedValue.Trim) Then
                                    Dim tmpSelect As Long = 0

                                    If IsNumeric(notesSearch_who.SelectedValue) Then
                                        tmpSelect = CLng(notesSearch_who.SelectedValue)
                                        bUseLoggedInUser = False ' once selection is made use "selected item"
                                    End If

                                    If tmpSelect = -1 Then
                                        localCriteria.ViewCriteriaNoteUserID = 0
                                    Else
                                        localCriteria.ViewCriteriaNoteUserID = tmpSelect
                                    End If

                                End If

                            End If

                            If Not IsNothing(notesSearch_ac_search_field.SelectedValue) And Not String.IsNullOrEmpty(notesSearch_ac_search_field.SelectedValue.Trim) Then
                                localCriteria.ViewCriteriaNoteACSearchField = CInt(notesSearch_ac_search_field.SelectedValue)
                            Else
                                localCriteria.ViewCriteriaNoteACSearchField = 0
                                notesSearch_ac_search_field.SelectedValue = ""
                            End If

                            If Not IsNothing(notesSearch_ac_search_field_text) Then
                                If Not String.IsNullOrEmpty(notesSearch_ac_search_field_text.Text.Trim) Then
                                    localCriteria.ViewCriteriaNoteACSearchTextValue = notesSearch_ac_search_field_text.Text.Trim
                                Else
                                    localCriteria.ViewCriteriaNoteACSearchTextValue = ""
                                End If
                            Else
                                localCriteria.ViewCriteriaNoteACSearchTextValue = ""
                            End If

                            If Not IsNothing(notesSearch_ac_search_field_operator.SelectedValue) And Not String.IsNullOrEmpty(notesSearch_ac_search_field_operator.SelectedValue.Trim) Then
                                localCriteria.ViewCriteriaNoteACSearchOperator = CInt(notesSearch_ac_search_field_operator.SelectedValue)
                            Else
                                localCriteria.ViewCriteriaNoteACSearchOperator = 0
                                notesSearch_ac_search_field_operator.SelectedValue = ""
                            End If

                            If Not String.IsNullOrEmpty(notesSearch_date.Text.Trim) Then
                                If notesSearch_date.Text.Contains(Constants.cColonDelim) Then

                                    Dim datesArray As Array = Split(notesSearch_date.Text, Constants.cColonDelim)

                                    localCriteria.ViewCriteriaNoteStartDate = datesArray(0).ToString.Trim
                                    localCriteria.ViewCriteriaNoteEndDate = datesArray(1).ToString.Trim

                                Else
                                    localCriteria.ViewCriteriaNoteStartDate = notesSearch_date.Text.Trim
                                End If

                            Else
                                notesSearch_date.Text = ""
                                localCriteria.ViewCriteriaNoteStartDate = ""
                                localCriteria.ViewCriteriaNoteEndDate = ""
                            End If

                            If Not IsNothing(notesSearch_order_by.SelectedValue) And Not String.IsNullOrEmpty(notesSearch_order_by.SelectedValue.Trim) Then
                                localCriteria.ViewCriteriaNoteOrderBy = notesSearch_order_by.SelectedValue.Trim
                            Else
                                localCriteria.ViewCriteriaNoteOrderBy = ""
                                notesSearch_order_by.SelectedValue = "date"
                            End If

                            HttpContext.Current.Session.Item("evoViewCriteria") = localCriteria ' save selections if user wants report

                        Else
                            localCriteria = HttpContext.Current.Session.Item("evoViewCriteria") ' use saved selections for report
                            localCriteria.ViewCriteriaIsReport = bIsReport ' set report flag on criteria
                            bUseLoggedInUser = False ' and use the "user from the selection criteria"  
                        End If

                    Case 32

                        localCriteria.ViewCriteriaTimeSpan = selectMarketTimeSpan.SelectedValue

                    Case Else

                End Select

            End If

            ' gets make model name and product code of current model if > 0
            If localCriteria.ViewCriteriaAmodID > -1 Then
                make_model_name = commonEvo.Get_Aircraft_Model_Info(localCriteria.ViewCriteriaAmodID, False, amod_product)
            ElseIf localCriteria.ViewCriteriaMakeAmodID > -1 Then
                make_model_name = commonEvo.Get_Aircraft_Model_Info(localCriteria.ViewCriteriaMakeAmodID, True, amod_product)
            End If

            If (View_ID < 2) Or View_ID = 11 Then
                make_model_name_label.Text = make_model_name.Trim
            End If

            localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_NONE

            ' make sure local criteria has current product code of Make or Model ... if user made no "filter" selections
            ' helps insure users "can't see" makes and models that are not available for this user
            If localCriteria.ViewCriteriaAmodID > -1 Or localCriteria.ViewCriteriaMakeAmodID > -1 Then
                multiProduct = Split(amod_product, Constants.cCommaDelim)

                If UBound(multiProduct) < 1 Then ' only one product use it

                    If CLng(amod_product) <> localCriteria.ViewCriteriaProductType Then
                        localCriteria.ViewCriteriaProductType = CLng(amod_product)
                    End If

                Else ' multi product 

                    For y As Integer = 0 To UBound(multiProduct)

                        Select Case (CLng(multiProduct(y)))

                            Case Constants.PRODUCT_CODE_BUSINESS
                                If Session.Item("localPreferences").UserBusinessFlag Then
                                    localCriteria.ViewCriteriaHasBusinessFlag = True
                                End If

                            Case Constants.PRODUCT_CODE_HELICOPTERS
                                If Session.Item("localPreferences").UserHelicopterFlag Then
                                    localCriteria.ViewCriteriaHasHelicopterFlag = True
                                End If

                            Case Constants.PRODUCT_CODE_COMMERCIAL
                                If Session.Item("localPreferences").UserCommercialFlag Then
                                    localCriteria.ViewCriteriaHasCommercialFlag = True
                                End If

                        End Select

                    Next

                    localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_COMBO

                End If

            End If

            If Not IsPostBack Then
                If Session.Item("hasModelFilter") Then ' if true then set the "filter" flags to match previous selection
                    bHasHelicopterFilter = Session.Item("hasHelicopterFilter")
                    bHasBusinessFilter = Session.Item("hasBusinessFilter")
                    bHasCommercialFilter = Session.Item("hasCommercialFilter")
                    localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_COMBO
                End If
            End If

            ' filter checkboxes override any model product code
            If bHasHelicopterFilter And Not bHasBusinessFilter And Not bHasCommercialFilter Then
                localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_HELICOPTERS
            End If

            If bHasBusinessFilter And Not bHasHelicopterFilter And Not bHasCommercialFilter Then
                localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_BUSINESS
            End If

            If bHasCommercialFilter And Not bHasBusinessFilter And Not bHasHelicopterFilter Then
                localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_COMMERCIAL
            End If

            If Not bHasHelicopterFilter And Not bHasBusinessFilter And Not bHasCommercialFilter And localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_NONE Then
                localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_ALL ' use subscribers product code(s) for queries
            ElseIf bHasHelicopterFilter And bHasBusinessFilter And bHasCommercialFilter And localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_NONE Then
                localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_ALL ' use subscribers product code(s) for queries
            End If

            ' set the "filter flags" based on selections override previous "model product code"
            If bHasHelicopterFilter Or bHasBusinessFilter Or bHasCommercialFilter Then
                localCriteria.ViewCriteriaHasHelicopterFlag = bHasHelicopterFilter
                localCriteria.ViewCriteriaHasBusinessFlag = bHasBusinessFilter
                localCriteria.ViewCriteriaHasCommercialFlag = bHasCommercialFilter
            End If


        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  load_page_variables] : " + ex.Message
        End Try

        Try
            If Trim(type_search_variable_only) <> "" And View_ID = 26 Then
                localCriteria.ViewCriteriaAircraftType = type_search_variable_only
                localCriteria.ViewCriteriaAirframeTypeStr = type_search_string_variable_only

                Select Case (type_search_variable_only)
                    Case Constants.AMOD_TYPE_AIRLINER
                        localCriteria.ViewCriteriaAirframeType = Constants.VIEW_EXECUTIVE
                    Case Constants.AMOD_TYPE_JET
                        localCriteria.ViewCriteriaAirframeType = Constants.VIEW_JETS
                    Case Constants.AMOD_TYPE_TURBO
                        Select Case (sAirFrame)
                            Case Constants.AMOD_FIXED_AIRFRAME
                                localCriteria.ViewCriteriaAirframeType = Constants.VIEW_TURBOPROPS
                            Case Constants.AMOD_ROTARY_AIRFRAME
                                localCriteria.ViewCriteriaAirframeType = Constants.VIEW_HELICOPTERS

                        End Select
                    Case Constants.AMOD_TYPE_PISTON
                        Select Case (sAirFrame)
                            Case Constants.AMOD_FIXED_AIRFRAME
                                localCriteria.ViewCriteriaAirframeType = Constants.VIEW_PISTONS
                            Case Constants.AMOD_ROTARY_AIRFRAME
                                localCriteria.ViewCriteriaAirframeType = Constants.VIEW_HELICOPTERS

                        End Select

                        ' Session.Item("viewAircraftType") = type_search_variable_only
                End Select

            End If

        Catch ex As Exception

        End Try
    End Sub

    Public Sub check_and_reset_model()
        Dim ComparableID As Long = 0
        Dim hadItem As Boolean = False

        If Not IsNothing(Request.Item("ViewID")) Then
            If Not String.IsNullOrEmpty(Request.Item("ViewID").ToString) Then
                ComparableID = Trim(Request.Item("ViewID"))
            End If
        End If


        If ComparableID <> 28 Then

            If ComparableID = 1 Or ComparableID = 11 Then
                If Not IsNothing(localCriteria.ViewCriteriaAmodIDArray) Then
                    hadItem = True
                ElseIf localCriteria.ViewCriteriaAmodID > -1 Then
                    hadItem = True
                ElseIf localCriteria.ViewCriteriaSecondAmodID > -1 Then
                    hadItem = True
                ElseIf localCriteria.ViewCriteriaThirdAmodID > -1 Then
                    hadItem = True
                ElseIf Not IsNothing(localCriteria.ViewCriteriaMakeIDArray) Then
                    hadItem = True
                ElseIf Not String.IsNullOrEmpty(localCriteria.ViewCriteriaAircraftMake.Trim) Then
                    hadItem = True
                ElseIf Not String.IsNullOrEmpty(localCriteria.ViewCriteriaAircraftType.Trim) Then
                    hadItem = True
                End If
            End If

            ' if we dont have any of the items, then skip the selection and it will use default 
            If hadItem = True Then
                CheckSharedModelTable()
            End If


            If IsNothing(SharedModelTable) Or hadItem = False Then 'We dont have a shared model table set a defaut
                If isHeliOnlyProduct Then
                    localCriteria.ViewCriteriaAmodID = 442
                    Exit Sub
                End If

                If Session.Item("localPreferences").Tierlevel = 1 Then   'jets exec
                    If Session.Item("localPreferences").UserBusinessFlag = True Then
                        localCriteria.ViewCriteriaAmodID = 272   ' challenger 300 - business jet
                    ElseIf Session.Item("localPreferences").UserCommercialFlag = True Then
                        localCriteria.ViewCriteriaAmodID = 698 '  AIRBUS  A300B2K-200  -  commercial jet 
                    ElseIf Session.Item("localPreferences").UserHelicopterFlag = True Then
                        localCriteria.ViewCriteriaAmodID = 442
                    End If
                ElseIf Session.Item("localPreferences").Tierlevel = 2 Then 'pistons turbos
                    If Session.Item("localPreferences").UserBusinessFlag = True Then
                        localCriteria.ViewCriteriaAmodID = 180   ' caravan 208 - business turbo
                    ElseIf Session.Item("localPreferences").UserCommercialFlag = True Then
                        localCriteria.ViewCriteriaAmodID = 181 ' caravan 208B  -  commercial turbo 
                    ElseIf Session.Item("localPreferences").UserHelicopterFlag = True Then
                        localCriteria.ViewCriteriaAmodID = 408 ' augusta westland aw139 - helicopter 
                    End If
                Else
                    If Session.Item("localPreferences").UserBusinessFlag = True Then
                        localCriteria.ViewCriteriaAmodID = 272   ' challenger 300 - business jet
                    ElseIf Session.Item("localPreferences").UserCommercialFlag = True Then
                        localCriteria.ViewCriteriaAmodID = 698 ' boeng bbj -  commercial jet 
                    ElseIf Session.Item("localPreferences").UserHelicopterFlag = True Then
                        localCriteria.ViewCriteriaAmodID = 408 ' augusta westland aw139 - helicopter 
                    End If
                End If
            End If
        End If
    End Sub

    Public Sub load_standalone_view()

        Dim sTmpMakeModel As String = ""
        Dim sTmpCompany As String = ""

        Dim sTmpProduct As String = ""
        Dim sTmpAirframe As String = ""

        Dim sTmpLocation As String = ""
        Dim temp_label As String = ""
        Dim aclsData_Temp As New clsData_Manager_SQL

        Try

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />" & Date.Now & " - load_standalone_view - START<br />"


            If View_ID = 16 Then
                Select Case CInt(localCriteria.ViewCriteriaProductType)
                    Case Constants.PRODUCT_CODE_BUSINESS
                        sTmpProduct = "Business - "
                    Case Constants.PRODUCT_CODE_COMMERCIAL
                        sTmpProduct = "Commercial - "
                    Case Constants.PRODUCT_CODE_HELICOPTERS
                        sTmpProduct = "Helicopters - "
                End Select

                Select Case CInt(localCriteria.ViewCriteriaAirframeType)
                    Case Constants.VIEW_EXECUTIVE
                        sTmpAirframe = "Airliners - "
                    Case Constants.VIEW_JETS
                        sTmpAirframe = "Jets - "
                    Case Constants.VIEW_TURBOPROPS
                        sTmpAirframe = "Turboprops - "
                    Case Constants.VIEW_PISTONS
                        sTmpAirframe = "Pistons - "
                    Case Constants.VIEW_HELICOPTERS
                        sTmpAirframe = "Helicopters - "
                    Case Constants.VIEW_ALLAIRFRAME
                        sTmpAirframe = "All Airframes - "
                End Select

            End If

            If localCriteria.ViewCriteriaCompanyID > 0 Then
                sTmpCompany = "<a href='DisplayCompanyDetail.aspx?compid=" + localCriteria.ViewCriteriaCompanyID.ToString + "' target='_new' class='underline'>" + commonEvo.get_company_name_fromID(localCriteria.ViewCriteriaCompanyID, 0, False, True, "") + "</a> - "
            End If

            If localCriteria.ViewCriteriaAmodID > -1 Then
                sTmpMakeModel = "<a href='DisplayModelDetail.aspx?id=" + localCriteria.ViewCriteriaAmodID.ToString + "' target='_new' class='underline'>" + commonEvo.Get_Aircraft_Model_Info(localCriteria.ViewCriteriaAmodID, False, "") + "</a> - "
            ElseIf localCriteria.ViewCriteriaMakeAmodID > -1 Then
                sTmpMakeModel = "<a href='DisplayModelDetail.aspx?id=" + localCriteria.ViewCriteriaMakeAmodID.ToString + "' target='_new' class='underline'>" + commonEvo.Get_Aircraft_Model_Info(localCriteria.ViewCriteriaMakeAmodID, True, "") + "</a> - "
            End If

            If View_ID = 2 Then ' add the other selected model names

                If localCriteria.ViewCriteriaSecondAmodID > -1 Then
                    sTmpMakeModel += "&nbsp;<a href='DisplayModelDetail.aspx?id=" + localCriteria.ViewCriteriaSecondAmodID.ToString + "' target='_new' class='underline'>" + commonEvo.Get_Aircraft_Model_Info(localCriteria.ViewCriteriaSecondAmodID, False, "") + "</a> - "
                End If

                If localCriteria.ViewCriteriaThirdAmodID > -1 Then
                    sTmpMakeModel += "&nbsp;<a href='DisplayModelDetail.aspx?id=" + localCriteria.ViewCriteriaThirdAmodID.ToString + "' target='_new' class='underline'>" + commonEvo.Get_Aircraft_Model_Info(localCriteria.ViewCriteriaThirdAmodID, False, "") + "</a> - "
                End If

            End If

            If Not String.IsNullOrEmpty(localCriteria.ViewCriteriaCity.Trim) Then

                sTmpLocation += "&nbsp;" + localCriteria.ViewCriteriaCity.Trim

                If Not String.IsNullOrEmpty(localCriteria.ViewCriteriaState.Trim) Then
                    sTmpLocation += ",&nbsp;" + localCriteria.ViewCriteriaState.Trim
                End If

                If Not String.IsNullOrEmpty(localCriteria.ViewCriteriaCountry.Trim) Then
                    sTmpLocation += ",&nbsp;" + localCriteria.ViewCriteriaCountry.Trim
                End If

                sTmpLocation += " - "

            ElseIf Not String.IsNullOrEmpty(localCriteria.ViewCriteriaState.Trim) Then

                sTmpLocation += "&nbsp;" + localCriteria.ViewCriteriaState.Trim

                If Not String.IsNullOrEmpty(localCriteria.ViewCriteriaCountry.Trim) Then
                    sTmpLocation += ",&nbsp;" + localCriteria.ViewCriteriaCountry.Trim
                End If

                sTmpLocation += " - "

            ElseIf Not String.IsNullOrEmpty(localCriteria.ViewCriteriaCountry.Trim) Then
                sTmpLocation += "&nbsp;" + localCriteria.ViewCriteriaCountry.Trim + " - "
            ElseIf Not String.IsNullOrEmpty(localCriteria.ViewCriteriaContinent.Trim) Then
                sTmpLocation += "&nbsp;" + localCriteria.ViewCriteriaContinent.Trim + " - "
            End If

            breadcrumbs1.Text = "<strong>" + sTmpProduct + sTmpAirframe + sTmpMakeModel + sTmpLocation + sTmpCompany + View_Name.Trim + "</strong>"

            viewTabContainer.Visible = True

            Me.loaded_visibility.Visible = False
            Me.loaded_visibility1.Visible = True
            divLoading.Visible = False
            loaded_visibility1.CssClass = "display_block"

            viewTabPanel.Visible = True

            'turn off previously enabled controls ( table cell )
            cellLocationViewType.Visible = False
            cellExportToExcel.Visible = False
            cellFractionalControls.Visible = False
            cellRegionDropdowns.Visible = False
            cellBaseDropdowns.Visible = False

            cellTransType.Visible = False
            cellDocType.Visible = False

            cellModelIDA.Visible = False
            cellModelIDB.Visible = False
            cellModelIDC.Visible = False

            cellFinancialInstitutions.Visible = False
            cellFinancialStartDate.Visible = False
            cellFinancialEndDate.Visible = False
            cellInternalTransactions.Visible = False

            ' most views use these controls ( table cell )
            cellTypeMakeModelView.Visible = True
            cellTimeSpanView.Visible = True

            cellNotesSearchPnl.Visible = False
            cellUserPortfolio.Visible = False

            Select Case View_ID
                Case 2 ' model compare 
                    viewHeaderLabel.Text = "Model Comparision View"

                    cellTypeMakeModelView.Visible = False
                    cellTimeSpanView.Visible = False

                    commonEvo.fillMakeModelDropDown(compare_amod_id_a, Nothing, nMaxWidth, "", localCriteria.ViewCriteriaAmodID, False, False, False, False, False, False) ' fill list with models
                    commonEvo.fillMakeModelDropDown(compare_amod_id_b, Nothing, nMaxWidth, "", localCriteria.ViewCriteriaSecondAmodID, False, False, False, False, False, False) ' fill list with models
                    commonEvo.fillMakeModelDropDown(compare_amod_id_c, Nothing, nMaxWidth, "", localCriteria.ViewCriteriaThirdAmodID, False, False, False, True, False, False) ' fill list with models

                    cellModelIDA.Visible = True
                    cellModelIDB.Visible = True
                    cellModelIDC.Visible = True

                    Build_Model_Compare_tab(localCriteria, viewContentLabel.Text)

                Case 3 ' operator
                    viewHeaderLabel.Text = ""
                    viewTabContainer.TabStripPlacement = AjaxControlToolkit.TabStripPlacement.Bottom
                    ' extra_class_operator_container .ajax__tab_outer {display:none;}
                    Build_Operators_tab(localCriteria, viewContentLabel.Text)

                Case 4 ' documents

                    viewHeaderLabel.Text = "Financial Documents View"

                    ' fill financial institution drop down
                    Dim financial_documents_functions As New financial_view_functions

                    financial_documents_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
                    financial_documents_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
                    financial_documents_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
                    financial_documents_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
                    financial_documents_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

                    financial_documents_functions.views_fill_financial_institutions(localCriteria, 0, lbFinancialInstitutions)
                    financial_documents_functions.views_fill_financial_doc_types(localCriteria, 0, lbFinancialDocType)
                    financial_documents_functions = Nothing

                    cellInternalTransactions.Visible = True

                    cellFinancialStartDate.Visible = True
                    cellFinancialEndDate.Visible = True
                    cellTypeMakeModelView.ColumnSpan = 4
                    cellTimeSpanView.Visible = False ' turn off time span for "documents view"

                    cellFinancialInstitutions.Visible = True

                    cellRegionDropdowns.Visible = True

                    cellTransType.Visible = True
                    cellDocType.ColumnSpan = 3
                    cellDocType.Visible = True

                    Build_Financial_Documents_tab(localCriteria, viewContentLabel.Text)
                    documents_view.Visible = True

                Case 6 ' star

                    cellTypeMakeModelView.Visible = False
                    cellTimeSpanView.Visible = False

                    viewHeaderLabel.Text = "STAR <em>(Statistical And Analysis Reports)</em>"
                    Build_StarReports_tab(localCriteria, viewContentLabel.Text)

                Case 7 ' fractional
                    viewHeaderLabel.Text = "Fractional View"

                    ' turn off type make model and time span controls
                    cellTypeMakeModelView.Visible = False
                    cellTimeSpanView.Visible = False

                    Dim fractional_functions As New fractional_view_functions
                    fractional_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
                    fractional_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
                    fractional_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
                    fractional_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
                    fractional_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

                    ' fill fractional controls
                    fractional_functions.views_fill_fractional_dropdowns(localCriteria, 0, lbFractionalProgram, lbFractionalModel)
                    fractional_functions = Nothing

                    ' show fractional controls
                    cellFractionalControls.Visible = True

                    Build_Fractional_tab(localCriteria, viewContentLabel.Text)

                Case 8 ' location 

                    cellLocationViewType.Visible = True
                    cellTimeSpanView.Visible = False ' turn off time span for "location view"

                    localDatalayer.fill_location_view_type(localCriteria, locationViewTypeID, 0)
                    viewHeaderLabel.Text = "Location Summary"

                    location_view.Visible = True
                    viewContentLabel.Visible = False

                    Build_Location_Tab(localCriteria, view_location_label.Text)

                Case 9 ' market trends
                    viewHeaderLabel.Text = "Financial Market Trends"
                    Build_Financial_Market_tab(localCriteria, viewContentLabel.Text)

                Case 10 ' charter
                    viewHeaderLabel.Text = "Charter Summary"
                    Build_Charter_tab(localCriteria, viewContentLabel.Text)
                Case 11 ' for sale

                Case 12 ' spi
                    If HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag = True Then
                        viewHeaderLabel.Text = "SPI <em>(Sales Price Index)</em>"
                        build_spi_tab(localCriteria, viewContentLabel.Text, "", "SPI", False)
                    End If

                Case 13 ' lease view
                    viewHeaderLabel.Text = "Lease Summary"
                    Build_Lease_tab(localCriteria, viewContentLabel.Text)

                Case 14 ' manufacturer view
                    viewHeaderLabel.Text = "Manufacturer Summary"
                    Build_Manufacturer_tab(localCriteria, viewContentLabel.Text)

                Case 15 ' reminder view (not used)

                Case 16 ' industry at a glance
                    viewHeaderLabel.Text = "Industry at a Glance"
                    Build_Market_summary_tab(localCriteria, viewContentLabel.Text, "")

                Case 24
                    viewHeaderLabel.Text = "Airport/FBO Summary"

                    airportSearchToggleOnOff.Attributes.Add("class", "")

                    If Not IsPostBack Then
                        date_labels.Visible = True
                        If Trim(Request("start_date")) <> "" And Trim(Request("end_date")) <> "" Then
                            start_date.Text = Trim(Request("start_date"))
                            end_date.Text = Trim(Request("end_date"))
                        Else
                            start_date.Text = FormatDateTime(DateAdd(DateInterval.Month, -3, Date.Now()), DateFormat.ShortDate)
                            end_date.Text = Month(Now()).ToString & "/" & Day(Now()).ToString & "/" & Year(Now()).ToString
                        End If
                        'check for requests



                        If Trim(Request("check_busj")) = "N" Then
                            Me.check_busj.Checked = False
                        Else
                            Me.check_busj.Checked = True
                        End If

                        If Trim(Request("check_bust")) = "N" Then
                            Me.check_bust.Checked = False
                        Else
                            Me.check_bust.Checked = True
                        End If

                        If Trim(Request("check_heli")) = "N" Then
                            Me.check_heli.Checked = False
                        Else
                            Me.check_heli.Checked = True
                        End If

                        If Trim(Request("check_comm")) = "Y" Then
                            Me.check_comm.Checked = True
                        Else
                            Me.check_comm.Checked = False
                        End If


                        If Session.Item("localPreferences").UserBusinessFlag = False Then
                            Me.check_busj.Enabled = False
                            Me.check_busj.Checked = False
                            Me.check_busj.Visible = False
                            Me.check_bust.Enabled = False
                            Me.check_bust.Checked = False
                            Me.check_bust.Visible = False
                        End If

                        If Session.Item("localPreferences").UserHelicopterFlag = False Then
                            Me.check_heli.Enabled = False
                            Me.check_heli.Checked = False
                            Me.check_heli.Visible = False
                        End If

                        If Session.Item("localPreferences").UserCommercialFlag = False Then
                            Me.check_comm.Enabled = False
                            Me.check_comm.Checked = False
                            Me.check_comm.Visible = False
                        End If


                    Else
                        BuildSliderDateJavascript()
                    End If

                    Me.check_owner_ac.Visible = True
                    Me.check_operator_ac.Visible = True

                    Build_Airport_FBO_Summary_tab(localCriteria, viewContentLabel.Text)

                Case 25

                    cellTimeSpanView.Visible = False
                    cellNotesSearchPnl.Visible = True

                    ' certian items display 
                    Dim bHasStandardCloudNotes As Boolean = HttpContext.Current.Session.Item("localPreferences").HasCloudNotes
                    Dim bHasServerNotes As Boolean = HttpContext.Current.Session.Item("localPreferences").HasServerNotes

                    Dim notes_functions As New notes_view_functions
                    notes_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
                    notes_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
                    notes_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
                    notes_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
                    notes_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

                    localCriteria.ViewCriteriaSubID = CLng(HttpContext.Current.Session.Item("localUser").crmSubSubID.ToString)
                    localCriteria.ViewCriteriaLogin = HttpContext.Current.Session.Item("localUser").crmUserLogin.ToString.Trim

                    If bUseLoggedInUser Then

                        localCriteria.ViewCriteriaNoteUserID = CLng(HttpContext.Current.Session.Item("localUser").crmUserContactID)

                        If bHasServerNotes Then 'If they're plus + notes users. 

                            Dim tempTable As New DataTable
                            Dim tmpPrefobj As New preferencesDataLayer

                            tmpPrefobj.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim

                            tempTable = tmpPrefobj.ReturnUserDetailsAndImage(localCriteria.ViewCriteriaNoteUserID)

                            If Not IsNothing(tempTable) Then
                                If tempTable.Rows.Count > 0 Then

                                    For Each r As DataRow In tempTable.Rows

                                        If Not (IsDBNull(r.Item("contact_email_address"))) And Not String.IsNullOrEmpty(r.Item("contact_email_address").ToString) Then
                                            localCriteria.ViewCriteriaNoteUserID = commonEvo.get_crm_client_info(r.Item("contact_email_address").ToString.Trim, "", "", "")
                                        End If

                                    Next

                                End If

                            End If

                            tempTable = Nothing
                            tmpPrefobj = Nothing

                        End If

                    End If

                    ' fill in notesSearch_who
                    notes_functions.views_fill_notesUserDropdown(localCriteria, 0, notesSearch_who)

                    ' fill in notesSearch_display_cbo
                    notes_functions = Nothing

                    viewHeaderLabel.Text = "Notes Center"
                    Build_Notes_tab(localCriteria, viewContentLabel.Text)




                Case 26
                    viewHeaderLabel.Text = "Aircraft Dealer/Broker View"
                    Build_Aircraft_Dealer_Broker_View(localCriteria, viewContentLabel.Text)
                Case 28

                    viewHeaderLabel.Text = "Fuel Utilization View"

                    ViewTMMDropDowns.setIsView(True)
                    ViewTMMDropDowns.setShowWeightClass(False)
                    ViewTMMDropDowns.setListSize(6)
                    ViewTMMDropDowns.setOverideDefaultModel(True)
                    ViewTMMDropDowns.setOverideMultiSelect(False)
                    ViewTMMDropDowns.setControlName(sTypeMakeModelCtrlBaseName)


                    If Not IsPostBack Then
                        date_labels.Visible = False
                    Else
                        BuildSliderDateJavascript()
                    End If

                    Me.check_owner_ac.Visible = False
                    ' Me.owner_drop.Visible = False

                    'Me.check_operator_ac2.Visible = True
                    If aclsData_Temp.is_aerodex_insight() = True Then
                        Build_Utilization_Summary_tab(localCriteria, viewContentLabel.Text)
                    End If

                Case 32

                    celldeliveryLeasesView.Visible = True

                    viewHeaderLabel.Text = "New Deliveries Summary"
                    Build_Deliveries_tab(localCriteria, viewContentLabel.Text)


            End Select

            If Not IsPostBack Then

                If Trim(localCriteria.ViewCriteriaAircraftMake) <> "" Then
                    temp_label = temp_label & localCriteria.ViewCriteriaAircraftMake.ToString & " "
                End If

                If Trim(localCriteria.ViewCriteriaAircraftModel) <> "" Then
                    temp_label = temp_label & localCriteria.ViewCriteriaAircraftModel.ToString & " "
                End If

                If Trim(localCriteria.ViewCriteriaAmodID) > 0 Then
                    temp_label = temp_label & " (" & localCriteria.ViewCriteriaAmodID & ") "
                End If


            End If

            PanelCollapseEx1.Collapsed = True
            PanelCollapseEx1.ClientState = "True"

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [load_standalone_view] : " + ex.Message
        End Try

    End Sub

    Private Sub GetMinMax(ByRef SliderValuesTable As DataTable, ByRef MaxAftt As Long, ByRef minAftt As Long, ByRef minYear As Integer, ByRef maxYear As Integer)
        If Not IsNothing(SliderValuesTable) Then
            If SliderValuesTable.Rows.Count > 0 Then
                If Not IsDBNull(SliderValuesTable.Rows(0).Item("MAXAFTT")) Then
                    MaxAftt = SliderValuesTable.Rows(0).Item("MAXAFTT")
                End If
                minAftt = 0
                If Not IsDBNull(SliderValuesTable.Rows(0).Item("MAXYEAR")) Then
                    maxYear = SliderValuesTable.Rows(0).Item("MAXYEAR")
                End If
                If Not IsDBNull(SliderValuesTable.Rows(0).Item("MINYEAR")) Then
                    minYear = SliderValuesTable.Rows(0).Item("MINYEAR")
                End If
                If Not IsDBNull(SliderValuesTable.Rows(0).Item("MINYEAR")) Then
                    minTransDate = "01/01/" & SliderValuesTable.Rows(0).Item("MINYEAR")
                End If
            End If
        End If
    End Sub

    Private Sub BuildSliderJavascript(ByVal AmodID As Long, ByRef valClassRef As valueControl, ByRef searchCriteria As viewSelectionCriteriaClass)
        Dim minAFTT As Long = 0
        Dim maxAFTT As Long = 0
        Dim minYear As Integer = 0
        Dim maxYear As Integer = 0
        Dim SliderString As New StringBuilder
        Dim SliderValuesTable As New DataTable
        Dim ModelVariantTable As New DataTable
        Dim isVariantsRan As Boolean = HttpContext.Current.Request.Form(includeVariants.UniqueID) IsNot Nothing
        Dim isSearchRan As Boolean = HttpContext.Current.Request.Form(viewApplyID.UniqueID) IsNot Nothing
        Dim hasMinMaxChanged As Boolean = False

        SliderValuesTable = GetAircraftSliderValues(AmodID.ToString, clsGeneral.clsGeneral.ExtractSelectedStringFromListboxDropdown(VariantList, False, 0, True))

        GetMinMax(SliderValuesTable, maxAFTT, minAFTT, minYear, maxYear)

        If (maxAFTT <> CInt(hidden_aftt_end.Text)) Or (minYear <> CInt(hidden_year_start.Text)) Or (maxYear <> CInt(hidden_year_end.Text)) Then
            hasMinMaxChanged = True
        End If

        If isVariantsRan Or hasMinMaxChanged Then ' reset the start/end
            aftt_end.Text = ""
            aftt_start.Text = ""
            year_start.Text = ""
            year_end.Text = ""
        End If


        SliderString = New StringBuilder

        SliderString.Append("$( ""#aftt-range"" ).slider({")
        SliderString.Append("range: true,")
        SliderString.Append("step: 1000,")
        SliderString.Append("min: " & minAFTT & ",")
        SliderString.Append("max: " & maxAFTT & ",")

        'Assigning values to hidden/nonchanged min-max
        hidden_aftt_end.Text = maxAFTT
        hidden_aftt_start.Text = minAFTT

        SliderString.Append("values: [ " & IIf(Not String.IsNullOrEmpty(aftt_start.Text), aftt_start.Text, minAFTT) & ", " & IIf(Not String.IsNullOrEmpty(aftt_end.Text), aftt_end.Text, maxAFTT) & " ],")

        SliderString.Append("slide: function( event, ui ) {")
        SliderString.Append("$( ""#" & aftt_start.ClientID & """ ).val( ui.values[ 0 ]); $( ""#" & aftt_end.ClientID & """ ).val( ui.values[ 1 ]); ")
        SliderString.Append("}")
        SliderString.Append("});")



        SliderString.Append("$( ""#slider-range"" ).slider({")
        SliderString.Append("range: true,")
        SliderString.Append("min: " & minYear & ",")
        SliderString.Append("max: " & maxYear & ",")

        'Assigning values to hidden/nonchanged min-max
        hidden_year_end.Text = maxYear
        hidden_year_start.Text = minYear


        SliderString.Append("values: [ " & IIf(Not String.IsNullOrEmpty(year_start.Text), year_start.Text, minYear) & ", " & IIf(Not String.IsNullOrEmpty(year_end.Text), year_end.Text, maxYear) & " ],")

        SliderString.Append("slide: function( event, ui ) {")
        SliderString.Append("$( ""#" & year_start.ClientID & """ ).val( ui.values[ 0 ]); $( ""#" & year_end.ClientID & """ ).val( ui.values[ 1 ]); ")
        SliderString.Append("}")
        SliderString.Append("});")

        Dim JavascriptOnLoad As String = ""
        JavascriptOnLoad = vbCrLf & "if (window.addEventListener) {"
        JavascriptOnLoad += vbCrLf & " window.addEventListener(""load"", "
        JavascriptOnLoad += vbCrLf & "function () {"
        JavascriptOnLoad += SliderString.ToString
        JavascriptOnLoad += vbCrLf & ";}, false); "
        JavascriptOnLoad += vbCrLf & "}" 'Else 
        JavascriptOnLoad += vbCrLf & "else {"


        JavascriptOnLoad += vbCrLf & " window.attachEvent(""load"","
        JavascriptOnLoad += vbCrLf & "function () {"
        'function goes here.
        JavascriptOnLoad += SliderString.ToString
        JavascriptOnLoad += vbCrLf & ";});"
        JavascriptOnLoad += vbCrLf & "}" 'End if

        If Page.IsPostBack Then
            If isVariantsRan Or hasMinMaxChanged Then
                SliderString.Append("$(""#" & year_start.ClientID & """).val(""" & minYear.ToString & """);")
                SliderString.Append("$(""#" & year_end.ClientID & """).val(""" & maxYear.ToString & """);")
                SliderString.Append("$(""#" & aftt_start.ClientID & """).val(""" & minAFTT.ToString & """);")
                SliderString.Append("$(""#" & aftt_end.ClientID & """).val(""" & maxAFTT.ToString & """);")

                'reset hidden
                SliderString.Append("$(""#" & hidden_year_start.ClientID & """).val(""" & minYear.ToString & """);")
                SliderString.Append("$(""#" & hidden_year_end.ClientID & """).val(""" & maxYear.ToString & """);")
                SliderString.Append("$(""#" & hidden_aftt_start.ClientID & """).val(""" & minAFTT.ToString & """);")
                SliderString.Append("$(""#" & hidden_aftt_end.ClientID & """).val(""" & maxAFTT.ToString & """);")

                year_start.Text = minYear
                year_end.Text = maxYear
                aftt_start.Text = minAFTT
                aftt_end.Text = maxAFTT

                searchCriteria.ViewCriteriaAFTTEnd = maxAFTT
                searchCriteria.ViewCriteriaAFTTStart = minAFTT
                searchCriteria.ViewCriteriaYearStart = minYear
                searchCriteria.ViewCriteriaYearEnd = maxYear

            End If

            If isVariantsRan Then

                System.Web.UI.ScriptManager.RegisterClientScriptBlock(UpdatePanel_top_left, Me.GetType(), "resetSlider", "$( ""#aftt-range"" ).slider(""destroy"" );$( ""#slider-range"" ).slider(""destroy"" );" & SliderString.ToString & ";", True)
            Else
                System.Web.UI.ScriptManager.RegisterStartupScript(Me, Me.GetType(), "onLoadCode", JavascriptOnLoad.ToString, True)
            End If
        Else
            year_start.Text = minYear
            year_end.Text = maxYear
            aftt_start.Text = minAFTT
            aftt_end.Text = maxAFTT
            System.Web.UI.ScriptManager.RegisterStartupScript(Me, Me.GetType(), "onLoadCode", JavascriptOnLoad.ToString, True)
        End If
    End Sub
    ''' <summary>
    ''' Grabs the min/max slider values
    ''' </summary>
    ''' <param name="amod_id"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function GetAircraftSliderValues(ByVal amod_id As Long, ByVal variantIDs As String) As DataTable
        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlReader As SqlClient.SqlDataReader
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing
        Dim TempTable As New DataTable
        Dim query As String
        Try

            If amod_id <> 0 Then


                'Opening Connection
                SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString
                SqlConn.Open()


                query = "select MIN(ac_mfr_year) as MINYEAR, MAX(ac_mfr_year) AS MAXYEAR, "
                query += " MAX(ac_est_airframe_hrs) AS MAXAFTT, MAX(afmv_airframe_hrs) as MAXAFTT_PROJ "

                query += " from Aircraft_Flat with (NOLOCK)"
                query += " left outer join Aircraft_FMV on afmv_ac_id = ac_id and afmv_latest_flag = 'Y' and afmv_status = 'Y' "

                If Not String.IsNullOrEmpty(variantIDs) Then
                    query += " where amod_id in (" & amod_id & "," & variantIDs & ") "
                Else
                    query += " where amod_id = @amodID "
                End If


                query += clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(HttpContext.Current.Session.Item("localSubscription"), False, True)
                query += " and ac_journ_id = 0"



                clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, query.ToString)
                Dim SqlCommand As New SqlClient.SqlCommand(query, SqlConn)


                SqlCommand.Parameters.AddWithValue("amodID", amod_id)


                SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

                Try
                    TempTable.Load(SqlReader)
                Catch constrExc As System.Data.ConstraintException
                    Dim rowsErr As System.Data.DataRow() = TempTable.GetErrors()
                End Try

                SqlCommand.Dispose()
                SqlCommand = Nothing

            End If
            Return TempTable
        Catch ex As Exception
            GetAircraftSliderValues = Nothing
            'Me.class_error = "Error in GetAircraftStartingTable(ByVal amod_id As Long) As DataTable SQL VERSION: " & ex.Message
        Finally
            SqlReader = Nothing

            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing



        End Try

    End Function

    Private Sub LoadModelVariants(ByVal AmodID As Long, ByRef valClassRef As valueControl)
        Dim ModelVariantTable As New DataTable

        '  If VariantList.SelectedValue = "" Then
        modelVariants.Visible = False
        variantTabPanel.Visible = False
        VariantList.Items.Clear()

        VariantList.Items.Add(New ListItem("NONE", ""))
        ModelVariantTable = valClassRef.GetFeaturesListByModel(AmodID)
        If Not IsNothing(ModelVariantTable) Then
            If ModelVariantTable.Rows.Count > 0 Then
                If IsDBNull(ModelVariantTable.Rows(0).Item("ModelVariants")) Then
                    VariantList.SelectedValue = ""
                    localCriteria.ViewCriteriaAmodIDArray = Nothing
                ElseIf Not IsDBNull(ModelVariantTable.Rows(0).Item("ModelVariants")) Then
                    modelVariants.Visible = True
                    variantTabPanel.Visible = True
                    Dim VariantModelList As String() = Split(ModelVariantTable.Rows(0).Item("ModelVariants"), ",")


                    For VariantModelListCount = 0 To UBound(VariantModelList)
                        Dim tempModel As String = ""
                        Dim tempMake As String = ""
                        Dim arrIndex As Long = commonEvo.FindIndexForItemByAmodID(VariantModelList(VariantModelListCount))
                        commonEvo.ReturnModelDataFromIndex(arrIndex, "", "", tempMake, tempModel, "")
                        VariantList.Items.Add(New ListItem(tempMake & " " & tempModel, VariantModelList(VariantModelListCount).ToString))
                    Next

                    'Here is where we reload if they exist:

                    If Not IsNothing(localCriteria.ViewCriteriaAmodIDArray) Then
                        For VariantSelListCount = 0 To UBound(localCriteria.ViewCriteriaAmodIDArray)
                            For i = 0 To VariantList.Items.Count - 1
                                If localCriteria.ViewCriteriaAmodIDArray(VariantSelListCount) = VariantList.Items(i).Value Then
                                    VariantList.Items(i).Selected = True
                                End If
                            Next
                        Next


                    End If
                End If
            End If
        End If
        ' End If

    End Sub
    Private Sub FillEventsCategory(ByVal aclsData_Temp As clsData_Manager_SQL, ByVal eventCategoryRadio As RadioButtonList)
        If Not Page.IsPostBack Then
            Dim EventCategory As New DataTable
            EventCategory = aclsData_Temp.Market_Search_Category()
            If Not IsNothing(EventCategory) Then
                If Not EventCategory.Rows.Count < 0 Then
                    For Each r As DataRow In EventCategory.Rows
                        If Not IsDBNull(r("apecat_category_group")) Then
                            eventCategoryRadio.Items.Add(New ListItem(r("apecat_category_group"), r("apecat_category_group")))
                        End If
                    Next
                End If
                eventCategoryRadio.SelectedValue = ""
            End If
        End If
    End Sub
    Public Sub load_full_model_view()

        Try

            'If CRMVIEW (set on PageInit) is true, then we overwrite the page title.
            'We toggle the crm view help/set the on client click to click out to the model help
            'Toggle off the evo view help
            TabContainer2.Visible = False
            preownedSales_Only.Visible = True

            If Not Page.IsPostBack Then
                preownedSales_Only.Checked = True
            End If
            If CRMViewActive Then
                crm_time_panel1.Visible = True
                crm_time_panel1.CssClass = "light_seafoam_green_header_color"
                Me.Page.Title = "Model Market Summary View"

                crm_view_help.Visible = True
                ' commented out MSW - 12/18/18
                ' crm_view_help.OnClientClick = "javascript:load('http://www.jetnetcrm.com/support/ModelViewHelp.pdf','','scrollbars=yes,menubar=no,height=900,width=1050,resizable=yes,toolbar=no,location=no,status=no');return false;"
                evo_view_help.Visible = False
                for_sale_tab.HeaderText = "Market Survey"
                retail_tab.HeaderText = "Sold Survey"
                event_tab.HeaderText = "Sold Trends"

                trends_tab.HeaderText = "Market Trends"
                spi_tab.HeaderText = "Events"
                documents_tab.HeaderText = "Docs"
                run_comparable_insert.Visible = True
                estimates_tab.Visible = True


                If Not Page.IsPostBack Then
                    used_of_used.Checked = True

                    selectViewTimeSpan.SelectedValue = 12
                    localCriteria.ViewCriteriaTimeSpan = selectViewTimeSpan.SelectedValue
                End If

                used_of_used.Checked = preownedSales_Only.Checked
            Else
                crm_time_panel2.Visible = True
                crm_time_panel2.CssClass = "light_seafoam_green_header_color"

                If Not Page.IsPostBack Then
                    selectViewTimeSpan.SelectedValue = 12
                    localCriteria.ViewCriteriaTimeSpan = selectViewTimeSpan.SelectedValue
                End If
            End If

            Dim valClassRef As New valueControl
            searchSliders.Visible = True

            'Load Year/AFTT slider
            BuildSliderJavascript(localCriteria.ViewCriteriaAmodID, valClassRef, localCriteria)


            'Load Model Variants.
            LoadModelVariants(localCriteria.ViewCriteriaAmodID, valClassRef)
            If CRMViewActive = False Then
                If Session.Item("localPreferences").AerodexFlag Then
                    evoSliderText.InnerText = "Sliders only applied to Fleet and Recent Sales tables.*"
                Else
                    evoSliderText.InnerText = "Sliders only applied to Market Status, and For Sale/Recent Sales tables.*"
                End If
            End If

            If Session.Item("isMobile") Then
                evo_view_help.Visible = False
                breadcrumbs.Visible = False
                newSearchContainer.Attributes("class") = "display_none"
                ControlImage.CssClass = "display_none"
                model_performance_tab.HeaderText = "Perf."
                model_description_tab.HeaderText = "Desc."
                If View_ID = 1 Then
                    View_Name = "Summary"
                End If

                Dim dropdownString As New StringBuilder
                dropdownString.Append("function swapChosenDropdowns() {")
                dropdownString.Append("$("".chosen-select"").chosen(""destroy"");")
                dropdownString.Append("$("".chosen-select"").chosen({ no_results_text: ""No results found."", disable_search_threshold: 10 });")
                dropdownString.Append("}")
                If Not Page.ClientScript.IsClientScriptBlockRegistered("chosenDropdowns") Then
                    System.Web.UI.ScriptManager.RegisterStartupScript(Me, Me.GetType(), "chosenDropdowns", dropdownString.ToString, True)
                End If

                dropdownString = New StringBuilder
                dropdownString.Append(";swapChosenDropdowns();")

                System.Web.UI.ScriptManager.RegisterStartupScript(Me, Me.GetType(), "CreateDropdown", dropdownString.ToString, True)

            End If

            If clsGeneral.clsGeneral.isEValuesAvailable() Then
                valuesCheckboxHolderToggle.Visible = True
                valuesCheckbox.Text = "Integrate " & Constants.eValues_Refer_Name

                'If Not Page.IsPostBack Then
                Dim str As String = ""

                str = "$('#" & valuesCheckbox.ClientID & "').click(function() {"
                str += " if (this.checked == false) {"
                str += "createCookie('evalues', 'false', 365);"
                str += " } else { "
                str += "createCookie('evalues', 'true', 365);"
                str += "};"
                str += "});"
                System.Web.UI.ScriptManager.RegisterStartupScript(Me.top_tab_update_panel, Me.GetType, "toggleEvalCookie", str + vbCrLf, True)
                'End If

                Dim ToggleCookie As HttpCookie = Request.Cookies("evalues")

                If Not IsNothing(ToggleCookie) Then
                    If ToggleCookie.Value = "true" Then
                        displayEValues = True

                        System.Web.UI.ScriptManager.RegisterStartupScript(Me.top_tab_update_panel, Me.GetType, "togglevaluesCheckbox", " $('#" & valuesCheckbox.ClientID & "').prop('checked', true);", True)
                    End If
                Else
                    Dim aCookie As New HttpCookie("evalues")
                    aCookie.Value = "true"
                    aCookie.Expires = DateTime.Now.AddDays(365)
                    HttpContext.Current.Response.Cookies.Add(aCookie)

                    displayEValues = True
                    System.Web.UI.ScriptManager.RegisterStartupScript(Me.top_tab_update_panel, Me.GetType, "togglevaluesCheckbox", " $('#" & valuesCheckbox.ClientID & "').prop('checked', true);", True)
                End If
            End If

            If displayEValues Then
                estimates_tab.Visible = True
                estimates_tab.HeaderText = "Valuation"
            Else
                estimates_tab.HeaderText = "Estimates"
            End If

            Me.actions_dropdown.Visible = False
            Me.actions_submenu_dropdown.Visible = False

            get_make_model_info(localCriteria)

            Me.TabContainer1.Visible = True
            Me.tabs_container.Visible = True
            utilization_tab.Visible = True

            If Session.Item("localPreferences").AerodexFlag Then
                model_market_status_tab.Visible = False
                for_sale_tab.Visible = False
                wanted_tab.Visible = False
                trends_tab.Visible = False
                If Not Page.IsPostBack Then
                    TabContainer1.ActiveTabIndex = 2
                End If
            ElseIf Not Session.Item("localPreferences").isCommercialOnlyProduct Then
                ' if its not commercial only
                model_market_status_tab.Visible = True
                for_sale_tab.Visible = True
                wanted_tab.Visible = True
            End If

            If Session.Item("localPreferences").UserSPIViewFlag And Not Session.Item("localPreferences").AerodexFlag Then
                spi_tab.Visible = True
            Else
                spi_tab.Visible = False
            End If

            Dim imgDisplayFolder As String = ""
            Dim DisplayPicture As Boolean = False
            Dim ModelImage As String = ""


            If Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then
                imgDisplayFolder = "https://www.testjetnetevolution.com/" & Session.Item("ModelPicturesFolderVirtualPath")
            Else
                If HttpContext.Current.Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CRM Then
                    imgDisplayFolder = IIf(CRMViewActive, clsData_Manager_SQL.get_site_name, Session.Item("jetnetFullHostName")) & Session.Item("ModelPicturesFolderVirtualPath")
                Else
                    imgDisplayFolder = Session.Item("jetnetFullHostName") & Session.Item("ModelPicturesFolderVirtualPath")
                End If
            End If



            CheckSharedModelTable()

            If Not IsNothing(SharedModelTable) Then
                If SharedModelTable.Rows.Count > 0 Then
                    If SharedModelTable.Rows(0).Item("amod_picture_exists_flag").ToString.ToUpper.Contains("Y") Then
                        DisplayPicture = True
                    End If
                End If
            End If

            If DisplayPicture Then
                'topLeftCSSContainer.CssClass = "gray_background tab_container_div_small"
                If localCriteria.ViewCriteriaAmodID > -1 Then
                    'Me.aircraft_image.ImageUrl = imgDisplayFolder.Trim + "/" + localCriteria.ViewCriteriaAmodID.ToString + ".jpg"
                    ModelImage = imgDisplayFolder.Trim + "/" + localCriteria.ViewCriteriaAmodID.ToString + ".jpg"
                ElseIf localCriteria.ViewCriteriaMakeAmodID > -1 Then
                    ' Me.aircraft_image.ImageUrl = imgDisplayFolder.Trim + "/" + localCriteria.ViewCriteriaMakeAmodID.ToString + ".jpg"
                    ModelImage = imgDisplayFolder.Trim + "/" + localCriteria.ViewCriteriaMakeAmodID.ToString + ".jpg"
                End If

            End If

            ' fills in the 3 graphs AVG_PRICE_MONTH, PER_MONTH, AVG_DAYS_ON
            Dim sHtmlMarketTrends As String = ""
            Dim excel_table As String = ""
            Build_Market_trends_tab(localCriteria, sHtmlMarketTrends, "", IIf(CRMViewActive = False, False, True), excel_table)
            view_trends_label.Text = sHtmlMarketTrends

            If Trim(excel_table) <> "" Then
                end_div.Visible = True
                end_div.Text = "<br/>" & excel_table
            End If


            model_performance_tab.CssClass = "newViewStyle"
            model_operating_costs_tab.CssClass = "newViewStyle"
            model_description_tab.CssClass = "newViewStyle"
            model_market_status_tab.CssClass = "newViewStyle"
            model_fleet_tab.CssClass = "newViewStyle"
            tabs_container.CssClass += " removeBorder"
            ' fills in other data as well
            Dim sHtmlMarketStatus As String = ""
            Build_Market_summary_tab(localCriteria, sHtmlMarketStatus, ModelImage)
            model_market_summary_status_text.Text = "<div  class=""valueSpec aircraftListing Simplistic aircraftSpec gray_background viewBoxMargin""><div class=""row""><div class=""five columns enableMarginColumn"">"
            model_market_summary_status_text.Text += DisplayFunctions.BuildViewMarketCompositionBox("", "blue", "$" & FormatNumber(values_forsale_avg_low, 0).ToString & "k", "$" & FormatNumber(values_avg_asking_display, 0).ToString & "k", "$" & FormatNumber(values_forsale_avg_high, 0).ToString & "k", values_mfr_avg_low, values_mfr_avg, values_mfr_avg_high, values_days_low, values_days_avg, values_days_high, values_aftt_low, values_aftt_avg, values_aftt_high, displayEValues, evalues_low, evalues_avg, evalues_high, landings_high, landings_low, landings_avg)
            model_market_summary_status_text.Text += "</div><div class=""four columns enableMarginColumn"">" & DisplayFunctions.BuildViewMarketSummaryBox("", "blue", values_total_inop, values_for_sale, values_for_sale_exclusive, values_lease, values_per1, values_per2, values_per3) & "</div>"
            model_market_summary_status_text.Text += "<div  class=""three columns enableMarginColumn""><div class=""Box gaugeImage"" style=""height:125px;margin-top:-3px;padding-top:16px;overflow:hidden;""><div class='subHeader'>ABSORPTION RATE</div><canvas id=""scripted-gauge""></canvas></div></div>"
            If VariantList.SelectedValue <> "" Then
                model_market_summary_status_text.Text += "<span class=""float_right red_text tiny_text"" style=""margin-bottom:-10px;padding-top:10px;padding-right:16px;"">" & DisplayFunctions.BuildSearchTextDisplay(VariantList, "*Variant Models Loaded, Including") & "</span>"
            End If

            model_market_summary_status_text.Text += "</div></div>"

            If Not Session.Item("localPreferences").AerodexFlag Then
                If Not Page.IsPostBack Then
                    System.Web.UI.ScriptManager.RegisterStartupScript(Me, Me.GetType(), "FillGauge", DisplayFunctions.BuildViewMarketAbsorptionGauge(values_abs_rate, False) & ";$(document).ready(function() { initGauge_AbsorptionRate();});", True)
                Else
                    System.Web.UI.ScriptManager.RegisterStartupScript(Me.top_tab_update_panel, Me.GetType(), "FillGaugePost", DisplayFunctions.BuildViewMarketAbsorptionGauge(values_abs_rate, False) & ";initGauge_AbsorptionRate();", True)
                End If
            End If

            If Session.Item("isMobile") = False Then
                Build_Model_Resources_Tab(localCriteria.ViewCriteriaAmodID)
            End If

            If Session.Item("localPreferences").isCommercialOnlyProduct Then

                ' if its commercial conly
                model_market_status_tab.Visible = False
                model_fleet_tab.Visible = False
                model_performance_tab.Visible = False
                model_operating_costs_tab.Visible = False

                If Not ScriptManager.GetCurrent(Page).IsInAsyncPostBack Then
                    Build_Description_tab()
                    'Build_Reports_tab() ' commented out- MSW 6/16/15 - does nothing 
                End If

                tabs_container.ActiveTabIndex = 4
            Else
                Build_Fleet_tab()
                If Not ScriptManager.GetCurrent(Page).IsInAsyncPostBack Then
                    Build_Description_tab()
                    Build_Performance_tab(localCriteria)
                    Build_OpCosts_tab(localCriteria)

                    'Build_Reports_tab() ' commented out- MSW 6/16/15 - does nothing 
                End If
            End If

            If View_ID = 11 And Not IsPostBack Then
                TabContainer1.ActiveTabIndex = 1
            End If

            ' check and see if they cleared the "STAR" Report
            If Not IsNothing(Request.Item("onStarReportTab")) Then
                If Not String.IsNullOrEmpty(Request.Item("onStarReportTab").ToString) Then
                    bFromStarTab = CBool(Request.Item("onStarReportTab").ToString.Trim)
                End If
            End If


            If Not IsNothing(Request.Item("tabStarReportID")) Then
                If Not String.IsNullOrEmpty(Request.Item("tabStarReportID").ToString) Then
                    bFromStarTab = CBool(CLng(Request.Item("tabStarReportID").ToString.Trim) > -1)
                End If
            End If

            If bFromStarTab And ((TabContainer1.ActiveTabIndex = 12 Or TabContainer1.ActiveTabIndex = 0) Or (TabContainer1.ActiveTabIndex = 1 And View_ID = 11)) Then
                TabContainer1.ActiveTabIndex = 12
            End If

            If Not IsNothing(Request.Item("onLocationTab")) Then
                If Not String.IsNullOrEmpty(Request.Item("onLocationTab").ToString) Then
                    bFromLocationTab = CBool(Request.Item("onLocationTab").ToString.Trim)
                End If
            End If

            If bFromLocationTab And (TabContainer1.ActiveTabIndex = 11 Or TabContainer1.ActiveTabIndex = 0) Then
                TabContainer1.ActiveTabIndex = 11
            End If

            If Not IsNothing(Request.Item("onUtilizationTab")) Then
                If Not String.IsNullOrEmpty(Request.Item("onUtilizationTab").ToString) Then
                    bFromUtilizationTab = CBool(Request.Item("onUtilizationTab").ToString.Trim)
                End If
            End If

            If bFromUtilizationTab And (TabContainer1.ActiveTabIndex = 15 Or TabContainer1.ActiveTabIndex = 0) Then
                TabContainer1.ActiveTabIndex = 15
            End If

            If Not String.IsNullOrEmpty(Session.Item("ViewActiveTab")) Then
                If IsNumeric(Session.Item("ViewActiveTab")) Then
                    TabContainer1.ActiveTabIndex = Session.Item("ViewActiveTab")
                    Session.Item("ViewActiveTab") = ""
                End If
            End If


            If Session.Item("isMobile") Then
                documents_tab.Visible = False
                event_tab.Visible = False
                charter_tab.Visible = False
                operators_tab.Visible = False
                spi_tab.Visible = False
                location_tab.Visible = False
                utilization_tab.Visible = False
                'star_tab.Visible = False
                range_tab.Visible = False
                fractional_tab.Visible = False
                lease_tab.Visible = False
                'parent_toggle.Visible = False
                buttons.Visible = False
                cellTimeSpan.Visible = False
                cellGoApply.Visible = False
                TabContainer2.Visible = False
                news_tab.Visible = False
                wanted_tab.Visible = False
                dropdownCell.Attributes.Add("class", "display_none")
                buttonsCell.Attributes.Add("class", "display_none")
            End If

            Me.view_retail_sales_label1.Text = "Please Wait a Moment for Recent Sales..."

            If CRMViewActive Then
                Me.view_events_label.Text = "Please Wait a Moment for Sold Trends Data..."
                Me.view_spi_label.Text = "Please Wait a Moment for Market Activity Data..."
            Else
                Me.view_events_label.Text = "Please Wait a Moment for Market Activity Data..."
                Me.view_spi_label.Text = "Please Wait a Moment for SPI Data..."
            End If

            Me.view_news_label1.Text = "Please Wait a Moment for News Data..."
            Me.view_wanteds_label1.Text = "Please Wait a Moment for Wanteds Data..."
            Me.view_documents_label1.Text = "Please Wait a Moment for Documents Data..."
            Me.view_operators_label.Text = "Please Wait a Moment for Operator Data..."
            Me.view_charter_label1.Text = "Please Wait a Moment for Charter Data..."
            Me.view_lease_label.Text = "Please Wait a Moment for Lease Data..."
            Me.view_for_sale_label.Text = "Please Wait a Moment for For Sale Data..."
            Me.view_location_tab_label.Text = "Please Wait a Moment for Location Data..."

            Me.view_star_reports_label.Text = "Please Wait a Moment for Star Report Data..."
            Me.view_fractional_label.Text = "Please Wait a Moment for Fractional Data..."
            Me.utilization_label.Text = "Please Wait a Moment for Flight Data..."

            breadcrumbs.Text = "<strong><a href='DisplayModelDetail.aspx?id=" + localCriteria.ViewCriteriaAmodID.ToString + "' target='_new' class='underline'>" + make_model_name_label.Text.Trim + "</a> " + View_Name.Trim + "</strong>"
            resizeTopLeftTab.Attributes.Add("class", "display_none")
            Me.loaded_visibility.Visible = True
            Me.loaded_visibility1.Visible = False
            divLoading.Visible = False
            loaded_visibility.CssClass = "display_block"

            add_ChangeTopActiveTab_Script(tabs_container)

            on_click_load_bottom(localCriteria)

            PanelCollapseEx.Collapsed = True
            PanelCollapseEx.ClientState = "True"

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [load_full_model_view] : " + ex.Message
        End Try

    End Sub

    Public Sub load_view_session_variables()

        Try

            ' because these values are needed on this page they need to match the control names in the control
            ' so the request header pickes up the right values
            If Not IsNothing(Request.Item("cbo" + sTypeMakeModelCtrlBaseName + "Type")) Then
                If Not String.IsNullOrEmpty(Request.Item("cbo" + sTypeMakeModelCtrlBaseName + "Type").ToString) Then
                    If Not Request.Item("cbo" + sTypeMakeModelCtrlBaseName + "Type").ToString.ToLower.Contains("all") Then
                        Session.Item("viewAircraftType") = Request.Item("cbo" + sTypeMakeModelCtrlBaseName + "Type").ToString.Trim
                    Else
                        Session.Item("viewAircraftModel") = ""
                        Session.Item("viewAircraftMake") = ""
                        Session.Item("viewAircraftType") = ""
                    End If
                End If
            End If

            If Not IsNothing(Request.Item("cbo" + sTypeMakeModelCtrlBaseName + "Make")) Then
                If Not String.IsNullOrEmpty(Request.Item("cbo" + sTypeMakeModelCtrlBaseName + "Make").ToString) Then
                    If Not Request.Item("cbo" + sTypeMakeModelCtrlBaseName + "Make").ToString.ToLower.Contains("all") Then
                        Session.Item("viewAircraftMake") = Request.Item("cbo" + sTypeMakeModelCtrlBaseName + "Make").ToString.Trim
                    Else
                        Session.Item("viewAircraftModel") = ""
                        Session.Item("viewAircraftMake") = ""
                    End If
                End If
            End If

            If Not IsNothing(Request.Item("cbo" + sTypeMakeModelCtrlBaseName + "Model")) Then
                If Not String.IsNullOrEmpty(Request.Item("cbo" + sTypeMakeModelCtrlBaseName + "Model").ToString) Then
                    If Not Request.Item("cbo" + sTypeMakeModelCtrlBaseName + "Model").ToString.ToLower.Contains("all") Then
                        Session.Item("viewAircraftModel") = Request.Item("cbo" + sTypeMakeModelCtrlBaseName + "Model").ToString.Trim
                    Else
                        Session.Item("viewAircraftModel") = ""
                    End If
                End If
            End If

            If Not IsNothing(Request.Item("chkHelicopterFilter")) Then
                If Not String.IsNullOrEmpty(Request.Item("chkHelicopterFilter").ToString) Then
                    bHasHelicopterFilter = CBool(Request.Item("chkHelicopterFilter").ToString.Trim)
                End If
            End If

            If Not IsNothing(Request.Item("chkBusinessFilter")) Then
                If Not String.IsNullOrEmpty(Request.Item("chkBusinessFilter").ToString) Then
                    bHasBusinessFilter = CBool(Request.Item("chkBusinessFilter").ToString.Trim)
                End If
            End If

            If Not IsNothing(Request.Item("chkCommercialFilter")) Then
                If Not String.IsNullOrEmpty(Request.Item("chkCommercialFilter").ToString) Then
                    bHasCommercialFilter = CBool(Request.Item("chkCommercialFilter").ToString.Trim)
                End If
            End If

            ' pick up the "company location values"
            If Not IsNothing(Request.Item("radViewContinentRegion")) Then
                If Not String.IsNullOrEmpty(Request.Item("radViewContinentRegion").ToString) And (Request.Item("radViewContinentRegion").ToString.ToLower <> Session.Item("viewRegionOrContinent").ToString.ToLower) Then
                    Session.Item("viewRegionOrContinent") = Request.Item("radViewContinentRegion").ToString.ToLower
                    Session.Item("viewRegion") = ""
                    Session.Item("viewCountry") = ""
                    Session.Item("viewState") = ""
                    Session.Item("viewTimeZone") = ""
                End If
            End If

            If Not IsNothing(Request.Item("cboViewRegion")) Then
                If Not String.IsNullOrEmpty(Request.Item("cboViewRegion")) And Not Request.Item("cboViewRegion").ToString.ToLower.Contains("all") Then
                    Session.Item("viewRegion") = Request.Item("cboViewRegion").ToString.Trim
                End If
            End If

            If Not String.IsNullOrEmpty(Session.Item("viewRegion").ToString.Trim) Then
                If Session.Item("viewRegion").ToString.ToLower.Contains("clear") Then
                    Session.Item("viewRegion") = ""
                    Session.Item("viewCountry") = ""
                    Session.Item("viewState") = ""
                    Session.Item("viewTimeZone") = ""
                End If
            End If

            If Not IsNothing(Request.Item("cboViewCountry")) Then
                If Not String.IsNullOrEmpty(Request.Item("cboViewCountry")) And Not Request.Item("cboViewCountry").ToString.ToLower.Contains("all") Then
                    Session.Item("viewCountry") = Request.Item("cboViewCountry").ToString.Trim
                End If
            End If

            If Not String.IsNullOrEmpty(Session.Item("viewCountry").ToString.Trim) Then
                If Session.Item("viewCountry").ToString.ToLower.Contains("clear") Then
                    Session.Item("viewCountry") = ""
                    Session.Item("viewState") = ""
                    Session.Item("viewTimeZone") = ""
                End If
            End If

            If Not IsNothing(Request.Item("cboViewState")) Then
                If Not String.IsNullOrEmpty(Request.Item("cboViewState")) And Not Request.Item("cboViewState").ToString.ToLower.Contains("all") Then
                    Session.Item("viewState") = Request.Item("cboViewState").ToString.Trim
                End If
            End If

            If Not String.IsNullOrEmpty(Session.Item("viewState").ToString.Trim) Then
                If Session.Item("viewState").ToString.ToLower.Contains("clear") Then
                    Session.Item("viewState") = ""
                    Session.Item("viewTimeZone") = ""
                End If
            End If

            If Not IsNothing(Request.Item("cboViewTimeZone")) Then
                If Not String.IsNullOrEmpty(Request.Item("cboViewTimeZone")) And Not Request.Item("cboViewTimeZone").ToString.ToLower.Contains("all") Then
                    Session.Item("viewTimeZone") = Request.Item("cboViewTimeZone").ToString.Trim
                End If
            End If

            If Not String.IsNullOrEmpty(Session.Item("viewTimeZone").ToString.Trim) Then
                If Session.Item("viewTimeZone").ToString.ToLower.Contains("clear") Then
                    Session.Item("viewState") = ""
                End If
            End If

            ' pick up the "aircraft base location values"
            If Not IsNothing(Request.Item("radBaseContinentRegion")) Then
                If Not String.IsNullOrEmpty(Request.Item("radBaseContinentRegion").ToString) And (Request.Item("radBaseContinentRegion").ToString.ToLower <> Session.Item("baseRegionOrContinent").ToString.ToLower) Then
                    Session.Item("baseRegionOrContinent") = Request.Item("radBaseContinentRegion").ToString.ToLower
                    Session.Item("baseRegion") = ""
                    Session.Item("baseCountry") = ""
                    Session.Item("baseState") = ""
                End If
            End If

            If Not IsNothing(Request.Item("cboBaseRegion")) Then
                If Not String.IsNullOrEmpty(Request.Item("cboBaseRegion")) And Not Request.Item("cboBaseRegion").ToString.ToLower.Contains("all") Then
                    Session.Item("baseRegion") = Request.Item("cboBaseRegion").ToString.Trim
                End If
            End If

            If Not IsNothing(Request.Item("cboBaseCountry")) Then
                If Not String.IsNullOrEmpty(Request.Item("cboBaseCountry")) And Not Request.Item("cboBaseCountry").ToString.ToLower.Contains("all") Then
                    Session.Item("baseCountry") = Request.Item("cboBaseCountry").ToString.Trim
                End If
            End If

            If Not IsNothing(Request.Item("cboBaseState")) Then
                If Not String.IsNullOrEmpty(Request.Item("cboBaseState")) And Not Request.Item("cboBaseState").ToString.ToLower.Contains("all") Then
                    Session.Item("baseState") = Request.Item("cboBaseState").ToString.Trim
                End If
            End If

            If Not IsNothing(Request.Item("clear")) Then
                If Not String.IsNullOrEmpty(Request.Item("clear").ToString) Then
                    bClearView = CBool(Request.Item("clear").ToString.Trim)
                End If
            End If

            If Not IsNothing(Request.Item("bIsReport")) Then
                If Not String.IsNullOrEmpty(Request.Item("bIsReport").ToString) Then
                    bIsReport = IIf(Request.Item("bIsReport").ToString.Trim.Contains("Y"), True, False)
                End If
            End If

            If Not IsNothing(Request.Item("bIsMfrModel")) Then
                If Not String.IsNullOrEmpty(Request.Item("bIsMfrModel").ToString) Then
                    bIsMfrModel = IIf(Request.Item("bIsMfrModel").ToString.Trim.Contains("Y"), True, False)
                End If
            End If

            aclsData_Temp_aspx = New clsData_Manager_SQL
            aclsData_Temp_aspx.JETNET_DB = Session.Item("jetnetClientDatabase")
            aclsData_Temp_aspx.client_DB = Session.Item("jetnetServerNotesDatabase")

            If bClearView Then

                HttpContext.Current.Session.Item("hasModelFilter") = False
                HttpContext.Current.Session.Item("hasHelicopterFilter") = False
                HttpContext.Current.Session.Item("hasBusinessFilter") = False
                HttpContext.Current.Session.Item("hasCommercialFilter") = False

                HttpContext.Current.Session.Item("viewAircraftModel") = ""
                HttpContext.Current.Session.Item("viewAircraftMake") = ""
                HttpContext.Current.Session.Item("viewAircraftType") = ""

                HttpContext.Current.Session.Item("viewRegionOrContinent") = "Continent"
                HttpContext.Current.Session.Item("viewRegion") = ""
                HttpContext.Current.Session.Item("viewCountry") = ""
                HttpContext.Current.Session.Item("viewState") = ""
                HttpContext.Current.Session.Item("viewTimeZone") = ""

                HttpContext.Current.Session.Item("baseRegionOrContinent") = "Continent"
                HttpContext.Current.Session.Item("baseRegion") = ""
                HttpContext.Current.Session.Item("baseCountry") = ""
                HttpContext.Current.Session.Item("baseState") = ""

            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "** Error in [View_Master.ascx.vb :  [load_view_session_variables] : " + ex.Message
        End Try

    End Sub

    Public Sub CheckSharedModelTable()
        'All that this does is check for the existence of the shared model table - basically so you don't use it if it doesn't exist.
        'It returns nothing but fills it up if it's not there.
        If Not IsNothing(SharedModelTable) Then
            If SharedModelTable.Rows.Count = 0 Then
                'We need to fill this up. If it has rows already, it already exists - so we're good to go.
                SharedModelTable = commonEvo.get_view_model_info(localCriteria, True)
            End If
        Else
            SharedModelTable = commonEvo.get_view_model_info(localCriteria, True)
        End If
    End Sub
#End Region

#Region "CRM VIEW"

    Private Sub Build_CRM_View(ByVal temp_amod_id As Long, ByVal make_name As String, ByVal model_name As String)
        Dim Aircraft_Model_Make_Name As String = ""
        Dim Aircraft_Make_Name As String = ""
        Dim query As String = ""
        Dim results_table As New DataTable
        Dim tempStr As String = ""
        Dim sHtmlMarketStatus As String = ""
        Dim aclsData_Temp As New clsData_Manager_SQL
        Dim CompanyLocation As String = ""
        Dim CompanyTitle As String = ""
        Dim type_of_search As String = ""
        Dim header_string As String = ""
        Dim header_string_title As String = ""
        Dim header_string_text As String = ""
        Dim temp_ac_id As Long = 0
        Dim imgDisplayFolder As String = ""
        Dim rest_of_ac_string As String = ""
        Dim PictureTable As New DataTable
        Dim ac_ser_no As String = ""
        Dim ViewAll As Boolean = True 'False
        Dim PerformExport As Boolean = False
        Dim PerformEmailExport As Boolean = False
        Dim DisplayCommonModelText As Boolean = True
        Dim can_export As Boolean = False
        UpdateProgress1.Visible = True 'Enable the update progress tab loading screen
        UpdateProgress5.Visible = True
        'I really don't lie doing this, it's weird.
        'However - it basically looks at the postback to figure out what caused it.
        Dim controlName As String = Page.Request.Params("__EVENTTARGET")
        Dim stringControl As New Control
        If Not String.IsNullOrEmpty(controlName) Then
            stringControl = Page.FindControl(controlName)
            ' If stringControl.ID.ToString = "crm_prospect_link_view_all" Then
            'ViewAll = True
            'End If

            If stringControl.ID.ToString = "crm_export_email_button" Then
                PerformEmailExport = True
                ViewAll = True
            End If
            If stringControl.ID.ToString = "crm_export_button" Then
                PerformExport = True
                ViewAll = True
            End If
        End If
        crm_prospect_link_view_all.Visible = False
        If PerformExport Or PerformEmailExport Then
            If Session.Item("localUser").crmAllowExport_Flag = False Or Session.Item("localUser").crmUserType = eUserTypes.GUEST Or Session.Item("localUser").crmDemoUserFlag = True Then
                can_export = False
            Else
                can_export = True
            End If
        End If

        If Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.EVO Then
            If Not IsNumeric(Trim(Request("amod_id"))) Then
                temp_amod_id = 0
            End If
        End If

        Me.prospects_panel.Visible = True
        Me.upgrade_models_text2.Text = ""

        If Trim(Me.upgrade_models_text2.Text) = "" Then
            localCriteria.ViewCriteriaStarReportID = 12
            crmProspectWhiteBoxContainer.Width = Unit.Percentage(35)
            upgrade_models_text2.CssClass = "smallSpaceText"
            Call Build_star_report_Prospector(localCriteria, Me.upgrade_models_text2.Text)
            prospects_panel.Width = Unit.Percentage(31.5)
            localCriteria.ViewCriteriaStarReportID = 0

            Me.upgrade_text.Text = "Owners of the models below most commonly sold their aircraft and purchased a " & localCriteria.ViewCriteriaAircraftMake & " " & localCriteria.ViewCriteriaAircraftModel & ". These common upgrade models are in the selection dropdown as a group and separately"
        End If

        If Not Page.IsPostBack Then

            If Not IsNothing(Session.Item("selectedViewTab")) Then
                If IsNumeric(Session.Item("selectedViewTab")) Then
                    TabContainer1.ActiveTabIndex = Session.Item("selectedViewTab")
                    Session.Item("selectedViewTab") = ""
                Else 'if it's not numeric
                    'Go ahead and set the active tab to be the wanted tab.
                    TabContainer1.ActiveTab = wanted_tab
                End If
            Else 'If the session variable SelectedViewTab doesn't exist
                'Go ahead and set the active tab to be the wanted tab.
                TabContainer1.ActiveTab = wanted_tab
            End If
        End If

        Try

            Dim UpgradeModels(1) As String 'This stores: UpgradeModels(0) = a list of model IDs seperated by commas. UpgradeModels(1) = a list of make/model names seperated by commas. 
            Dim UpgradeModelDatatable As New DataTable 'This stores the upgrade Model Information so that we can look through it later for the subsequent steps.
            Dim toggleRowColor As Boolean = True

            'This function sets up the tabs/page to run this view.
            CRM_VIEW_Set_Up_Page_Toggle_Tabs()
            tabs_container.Visible = False
            resizeTopLeftTab.Visible = False
            If Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CRM Then
                'This connection string (when dealing with the crm side) should be: Application.Item("crmClientDatabase")
                'There were some references in Get_CRM_VIEW_Prospects() in the viewsDatalayer that uses this session variable. 
                'I have no idea what all that function does,so I didn't just want to change it on the fly.
                HttpContext.Current.Session.Item("jetnetServerNotesDatabase") = Application.Item("crmClientDatabase")

                'This tag toggles the notes display on the aircraft listing page.
                'It really shouldn't do anything here, but I had to set it to true to get the prospects to show.
                HttpContext.Current.Session.Item("localUser").crmDisplayNoteTag = True

                'This session variable does not matter on the CRM side. It's going to be false.
                'Every CRM user is a notes user, they all have that database set up
                Session.Item("localSubscription").crmServerSideNotes_Flag = True
            End If

            prospectCRMSearchCell.Visible = True
            cellTimeSpan.Visible = False
            ' kill the top panel 
            Me.Control_Panel.Visible = True
            Me.Collapse_Panel.Visible = True
            buttons.Visible = False
            close_window_only.Visible = True
            'If Not Page.IsPostBack Then
            '    Me.close_window_only.Text += ("<a class='underline cursor' onclick=""javascript:window.close();return false;"" class=""close_button"" style=""padding-right:15px;"">Close Window</a>")
            'End If
            If clsGeneral.clsGeneral.isCrmDisplayMode = False Then
                documents_tab.Visible = False
                operators_tab.Visible = False
            End If
            crmProspectSearchButton.OnClientClick = "$('#" & crmProspectAircraftID.ClientID & "').val('0');$('#loadingScreenViewSearchText').text('Please wait while your search loads...');$('#divTabLoading2').removeClass('display_none');"
            If Trim(Request("ac_id")) <> "" Then
                prospectCRMSearchCell.Visible = False
                cellTimeSpan.Visible = False
                ' kill the top panel 
                Me.Control_Panel.Visible = False
                Me.Collapse_Panel.Visible = False
                temp_ac_id = Trim(Request("ac_id"))

                ControlImage.CssClass = "display_none"
            ElseIf crmProspectAircraftID.Text > 0 Then
                temp_ac_id = crmProspectAircraftID.Text
            Else
                ControlImage.CssClass = "display_none"
            End If

            If temp_ac_id > 0 Then
                localDatalayer.Get_AC_MAKE_MODEL(temp_ac_id, make_name, model_name, temp_amod_id, rest_of_ac_string, ac_ser_no, Me.year_of_current.Text, Me.aftt_of_current.Text)
            End If

            'We're going to go ahead and run through this if there is a model id
            If temp_amod_id <> 0 Then
                '1.) The absolute first thing that we need to do is go ahead and get a list of models that people normally upgrade to from this model.
                'Note: This is a pretty important thing to have, regardless of what tab we're on in the CRM View.
                'So I am going to put it into a function, so that way if we decide to go ahead and run it somewhere else,
                'We can easily move it.
                UpgradeModels = crmViewDataLayer.CRM_VIEW_Find_Upgrade_Models_From_Records(temp_amod_id, UpgradeModelDatatable, localDatalayer)
            End If


            ' if its not postback 
            If IsNothing(Session.Item("Prospector_Model")) Or Not IsPostBack Then
                Session.Item("Prospector_Model") = 0
            End If


            aclsData_Temp.JETNET_DB = Application.Item("crmJetnetDatabase")
            aclsData_Temp.client_DB = Application.Item("crmClientDatabase")
            crm_export_email_button.Visible = False
            crm_export_button.Visible = False
            If temp_amod_id < 1 And temp_ac_id = 0 Then
                Dim isSearchRan As Boolean = HttpContext.Current.Request.Form(crmProspectSearchButton.UniqueID) IsNot Nothing
                crmProspectViewNewProspect.Visible = True
                'Ignore everything
                TabContainer2.Visible = False
                tabs_container.Visible = False
                TabContainer1.Visible = False

                PanelCollapseEx.Collapsed = False
                PanelCollapseEx.ClientState = "False"
                cellTypeMakeModel.Visible = False
                make_model_name_label.Text = ""
                prospectCRMSearchCell.Visible = True
                cellTimeSpan.Visible = False
                ' kill the top panel 
                Me.Control_Panel.Visible = True
                Me.Collapse_Panel.Visible = True
                cellGoApply.Visible = False

                'Keep this temporarily until I get clsgeneral-----------------------------------------------------------------------
                Dim crmTestMaster As New main_site
                crmTestMaster.aclsData_Temp.JETNET_DB = Application.Item("crmJetnetDatabase")
                crmTestMaster.aclsData_Temp.client_DB = Application.Item("crmClientDatabase")

                Dim jsString As String = ""
                jsString += "$(""#" & crmProspectSearchStartDate.ClientID & """).datepicker({"
                jsString += " showOn: ""button"", "
                jsString += " buttonImage: ""/images/final.jpg"","
                jsString += " buttonImageOnly: true,"
                jsString += " buttonText: ""Select date"""
                jsString += " });"
                jsString += "$(""#" & crmProspectSearchEndDate.ClientID & """).datepicker({"
                jsString += " showOn: ""button"", "
                jsString += " buttonImage: ""/images/final.jpg"","
                jsString += " buttonImageOnly: true,"
                jsString += " buttonText: ""Select date"""
                jsString += " }); "


                If Not Page.IsPostBack Then
                    System.Web.UI.ScriptManager.RegisterStartupScript(Me, Me.GetType, "dateString", " $(function() {" & jsString & ";  });", True)
                Else
                    System.Web.UI.ScriptManager.RegisterStartupScript(Me, Me.GetType, "dateStringPost", jsString, True)
                End If


                If Not Page.IsPostBack Then



                    If Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.HOMEBASE Or Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CUSTOMER_CENTER Then

                        Me.category_label.Text = "Service"
                        Me.action_label.Text = "Stage"


                        clsGeneral.clsGeneral.FillCRMUser_Homebase(crmTestMaster, "Prospects_Listing", crmProspectSearchUserDropdown, False, "")



                        clsGeneral.clsGeneral.FillCRMUser_Homebase(crmTestMaster, "Prospects", referrer_drop, False, "")

                        If Trim(Request("user_of_selected")) <> "" Then
                            Me.crmProspectSearchUserDropdown.SelectedValue = "0"
                        Else
                            If Not IsNothing(HttpContext.Current.Session.Item("homebaseUserClass").home_user_id) Then
                                If Trim(HttpContext.Current.Session.Item("homebaseUserClass").home_user_id) <> "" Then
                                    Me.crmProspectSearchUserDropdown.SelectedValue = HttpContext.Current.Session.Item("homebaseUserClass").home_user_id
                                End If
                            End If
                        End If


                        crmTestMaster.aclsData_Temp.Fill_Service_Category(crmProspectSearchCategory, New DataTable, aclsData_Temp)
                        crmProspectActionTakenList.Items.Add(New ListItem("ALL", "ALL"))


                        crmTestMaster.aclsData_Temp.Fill_Type_Category(crmProspectActionTakenList, aclsData_Temp)

                        ' already in the not postback section
                        If Trim(Request("type_of_selected")) <> "" Then

                            If InStr(Trim(Request("type_of_selected")), "Executed") > 0 And InStr(Trim(Request("type_of_selected")), "Contract") > 0 Then
                                crmProspectActionTakenList.SelectedValue = "Contract"
                                crmProspectSearchIncludeActive.Checked = False
                                crmProspectSearchIncludeClosed.Checked = True
                                crmProspectSearchIncludeInactive.Checked = False
                                crmProspectSearchStartDate.Text = "1/1/" & Year(Date.Now())
                                crmProspectSearchEndDate.Text = Date.Now().Date
                            Else
                                crmProspectActionTakenList.SelectedValue = Trim(Request("type_of_selected"))
                            End If



                        Else
                            crmProspectActionTakenList.SelectedValue = "ALL"
                        End If

                        crmProspectActionTakenList.Width = 110

                        source_listbox.Items.Add(New ListItem("ALL", "ALL"))
                        crmTestMaster.aclsData_Temp.Fill_Source(source_listbox, New DataTable, aclsData_Temp)
                        source_listbox.SelectedValue = "ALL"



                        If isSearchRan = False Then
                            crmProspectSearchButton_Click(crmProspectSearchButton, System.EventArgs.Empty)
                        End If

                    Else
                        'If crmProspectSearchUserInactive.Checked = True Then
                        'clsGeneral.clsGeneral.Fill_User_Dropdown(crmProspectSearchUserDropdown, "Prospects", Nothing, crmTestMaster, True)
                        'Else
                        clsGeneral.clsGeneral.FillCRMUserOnEvol(crmTestMaster, "Prospects", crmProspectSearchUserDropdown, False)
                        'clsGeneral.clsGeneral.Fill_User_Dropdown(crmProspectSearchUserDropdown, "Prospects", Nothing, crmTestMaster)
                        'End If
                        clsGeneral.clsGeneral.Fill_Opportunity_Category(crmProspectSearchCategory, New DataTable, aclsData_Temp)
                        crmProspectActionTakenList.Items.Add(New ListItem("ALL", "ALL"))
                        clsGeneral.clsGeneral.FillPriorityDropdown(crmProspectActionTakenList)

                        crmProspectActionTakenList.SelectedValue = "ALL"
                        'Only if postback wasn't caused by search
                        If isSearchRan = False Then
                            crmProspectSearchButton_Click(crmProspectSearchButton, System.EventArgs.Empty)
                        End If

                    End If




                End If

            Else
                TabContainer2.Visible = True
                get_make_model_info(localCriteria)



                'I don't really understand why, but the make and model name get cleared in the set up model pic function. So I created a new variable to store the model info.
                Aircraft_Model_Make_Name = make_name & " " & model_name
                Aircraft_Make_Name = make_name

                'set_up_ac_model_pic(temp_ac_id, temp_amod_id, make_name, model_name, ac_ser_no, type_of_search, rest_of_ac_string, imgDisplayFolder)

                DisplayCRMProspectPicture(temp_ac_id, make_name, model_name, ac_ser_no, imgDisplayFolder)

                BuildProspectDataTable("prospectDataTable", True, TabContainer1.ActiveTab.ID.ToString)



                If LCase(TabContainer1.ActiveTab.ID.ToString) = "trends_tab" Then 'trends_tab
                    'Display Text/Header
                    header_string_title = "Previous Owners"
                    header_string_text = "Displays <span class='label'><span class='help_cursor' title='Includes End Users, Aerial Mustering, Aerial Photography, Aerial Sprayer, Air Ambulance, Air Taxi, Air Tour, Firefighting, Flight school, Search & Rescue, & Technical School business types.'><u>end user companies</u></span></span> that previously owned an aircraft, and currently remain without replacement aircraft. Note that previous owners include owners of aircraft shares and fractions as shown in the (%) after the serial number in the listing. Also note that companies are excluded if any of their other business names, subsidiaries, or additional locations purchased another aircraft near or after they sold their aircraft."
                    crm_previous_owners_tab_search.Visible = True 'Toggle search panel on

                    'Fill Dropdown Common Models
                    crmViewDataLayer.CRM_VIEW_Fill_Common_Upgrade_Dropdown(UpgradeModelDatatable, temp_amod_id, crm_previous_owners_tab_model, header_string_title, model_reports_tab, crm_previous_owners_tab_search, Page.IsPostBack) 'First fill up the dropdowns.

                    Dim ModelSearchVariable As Long = 0 'Holds the model search variable. 
                    Dim MakeSearch As Boolean = False
                    Dim OrderByVariable As String = " order by comp_name asc, comp_city, comp_state, comp_country, journ_date" 'This only has one option right this minute, so I'm just going to default it. When more is added, this will come from the dropdown "crm_previous_owners_tab_sort
                    Dim YearDateVariable As String = DateAdd(DateInterval.Year, -CInt(1), Date.Now()).Date 'Defaulting to 1 year.

                    'If this is a number and it's not 1, go ahead and figure out what they picked.
                    If IsNumeric(crm_previous_owners_tab_sold_within.SelectedValue) Then
                        If crm_previous_owners_tab_sold_within.SelectedValue <> 1 Then
                            YearDateVariable = DateAdd(DateInterval.Year, -CInt(crm_previous_owners_tab_sold_within.SelectedValue), Date.Now()).Date
                        End If
                    End If

                    'we're going to run a select case for the sort. This is where you'll set up the order by for this particular tab. We don't need a case
                    'For company, because it's already defaulted.
                    Select Case UCase(crm_previous_owners_tab_sort.SelectedValue)
                        Case "DATE"
                            OrderByVariable = " order by journ_date desc"
                    End Select

                    'If that variable is not numeric, then we go ahead and assume that they're searching by make.
                    'The assumption is put in because this will force them to search by make and not somehow try to pass some SQL injection through the dropdown.
                    'So basically it's either numeric or make only.
                    If IsNumeric(crm_previous_owners_tab_model.SelectedValue) Then
                        ModelSearchVariable = crm_previous_owners_tab_model.SelectedValue
                    Else
                        ModelSearchVariable = 0
                        MakeSearch = True
                    End If


                    If (PerformExport Or PerformEmailExport) And can_export Then

                    End If

                    'Build/Run Query for this Tab
                    results_table = crmViewDataLayer.CRM_VIEW_Build_Previous_Owner_Build_Run_Query(MakeSearch, YearDateVariable, Aircraft_Make_Name, ModelSearchVariable, ViewAll, UpgradeModels, OrderByVariable, localDatalayer, PerformEmailExport)

                    If PerformExport Or PerformEmailExport Then
                        If can_export Then
                            crmViewDataLayer.ExportTableData(results_table)
                        End If
                    Else
                        'Display Table for Previous Owners.
                        tempStr = crmViewDataLayer.CRM_VIEW_Display_Previous_Owner_Table(results_table, CompanyTitle, CompanyLocation, aclsData_Temp, temp_ac_id, TabContainer1, crm_prospect_label_text_count, crm_prospect_link_view_all, TabContainer1.ActiveTab.ID.ToString)
                    End If

                    Me.view_trends_label.Text = tempStr
                    tempStr = ""

                    'Saving the search to session after it's ran.
                    crmViewDataLayer.ParseSaveSessionSearchOnProspector(crm_previous_owners_tab_search)

                ElseIf LCase(TabContainer1.ActiveTab.ID.ToString) = "for_sale_tab" Then
                    header_string_title = "Expiring Leases"
                    header_string_text = "Displays a list of <span class='label'><span  class='help_cursor' title='Includes End Users, Aerial Mustering, Aerial Photography, Aerial Sprayer, Air Ambulance, Air Taxi, Air Tour, Firefighting, Flight school, Search & Rescue, & Technical School business types.'><u>end user lessees</u></span></span> whose leases are scheduled to expire within the designated timeframe."

                    crm_expiring_leases_search.Visible = True

                    crmViewDataLayer.CRM_VIEW_Fill_Common_Upgrade_Dropdown(UpgradeModelDatatable, temp_amod_id, crm_expiring_leases_model, header_string_title, model_reports_tab, crm_expiring_leases_search, Page.IsPostBack) 'First fill up the dropdowns.
                    'Let's create some variables for this tab.
                    Dim ModelSearchVariable As Long = 0 'Holds the model search variable. 
                    Dim MakeSearch As Boolean = False
                    Dim OrderByVariable As String = " order by comp_name asc, comp_city, comp_state, comp_country, journ_date" 'This will come from the dropdown "crm_expiring_leases_sort
                    Dim YearVariable As Long = 1
                    Dim DoNotIncludeExpired As Boolean = True 'default to not include expired leases

                    'Setting up a select case for the sort. Company isn't needed because it's defaulted
                    Select Case UCase(crm_expiring_leases_sort.SelectedValue)
                        Case "EXPIRATION"
                            OrderByVariable = " order by journ_date desc"
                    End Select


                    'If include is selected, include expired leases
                    If UCase(crm_expiring_leases_do_not_include.SelectedValue) = "INCLUDE" Then
                        DoNotIncludeExpired = False
                    End If

                    'If this is a number and it's not 1, go ahead and figure out what they picked.
                    If IsNumeric(crm_expiring_leases_timeframe.SelectedValue) Then
                        If crm_expiring_leases_timeframe.SelectedValue <> 1 Then
                            YearVariable = crm_expiring_leases_timeframe.SelectedValue
                        End If
                    End If

                    'If that variable is not numeric, then we go ahead and assume that they're searching by make.
                    'The assumption is put in because this will force them to search by make and not somehow try to pass some SQL injection through the dropdown.
                    'So basically it's either numeric or make only.
                    If IsNumeric(crm_expiring_leases_model.SelectedValue) Then
                        ModelSearchVariable = crm_expiring_leases_model.SelectedValue
                    Else
                        ModelSearchVariable = 0
                        MakeSearch = True
                    End If

                    'Build/Run Query for this tab.
                    results_table = crmViewDataLayer.CRM_VIEW_Build_Expiring_Leases_Build_Run_Query(MakeSearch, YearVariable, Aircraft_Make_Name, ModelSearchVariable, ViewAll, UpgradeModels, OrderByVariable, DoNotIncludeExpired, localDatalayer, PerformEmailExport)


                    If PerformExport Or PerformEmailExport Then
                        If can_export Then
                            crmViewDataLayer.ExportTableData(results_table)
                        End If
                    Else
                        'Display Table for Previous Owners.
                        tempStr = crmViewDataLayer.CRM_VIEW_Display_Expiring_Leases_Table(results_table, CompanyTitle, CompanyLocation, aclsData_Temp, temp_ac_id, crm_prospect_label_text_count, crm_prospect_link_view_all, TabContainer1, TabContainer1.ActiveTab.ID.ToString)
                    End If

                    Me.view_for_sale_label.Text = tempStr
                    tempStr = ""

                    'Saving the search to session
                    crmViewDataLayer.ParseSaveSessionSearchOnProspector(crm_expiring_leases_search)

                ElseIf LCase(TabContainer1.ActiveTab.ID.ToString) = "retail_tab" Then
                    header_string_title = "Expiring Fractional Owners"
                    header_string_text = "Displays a list of <span class='label'><span class='help_cursor' title='Includes End Users, Aerial Mustering, Aerial Photography, Aerial Sprayer, Air Ambulance, Air Taxi, Air Tour, Firefighting, Flight school, Search & Rescue, & Technical School business types.'><u>end user fractional owners</u></span></span> whose agreements have expired or are expiring within the specified timeframe.  Keep in mind that when the fraction expiration date is passed, as a policy JETNET researches do not clear this date to indicate the expiration date has passed since this date can be useful in knowing the status of this shareholder. Once the expiration date has passed, typically the agreement rolls over into period based agreements allowing shareholders an opt-out clause with a 90 day notice."

                    crm_fractional_owners_search.Visible = True

                    crmViewDataLayer.CRM_VIEW_Fill_Common_Upgrade_Dropdown(UpgradeModelDatatable, temp_amod_id, crm_fractional_owners_tab_model, header_string_title, model_reports_tab, crm_fractional_owners_search, Page.IsPostBack) 'First fill up the dropdowns.
                    'Let's create some variables for this tab.
                    Dim ModelSearchVariable As Long = 0 'Holds the model search variable. 
                    Dim MakeSearch As Boolean = False
                    Dim OrderByVariable As String = " order by comp_name asc, comp_city, comp_state, comp_country, journ_date" 'this comes from crm_fractional_owners_tab_sort
                    Dim YearVariable As Integer = 1

                    Dim DoNotIncludeExpired As Boolean = True 'default to not include expired leases

                    'We're going to run a select case for the sort. This is where you'll set up the order by for this particular tab. We don't need a case
                    'For company, because it's already defaulted.
                    Select Case UCase(crm_fractional_owners_tab_sort.SelectedValue)
                        Case "EXPIRATION"
                            OrderByVariable = " order by journ_date desc"
                    End Select

                    'If include is selected, include expired leases
                    If UCase(crm_fractional_owners_tab_do_not_include.SelectedValue) = "INCLUDE" Then
                        DoNotIncludeExpired = False
                    End If

                    'If this is a number and it's not 1, go ahead and figure out what they picked.
                    If IsNumeric(crm_fractional_owners_tab_timeframe.SelectedValue) Then
                        If crm_fractional_owners_tab_timeframe.SelectedValue <> 1 Then
                            YearVariable = crm_fractional_owners_tab_timeframe.SelectedValue
                        End If
                    End If

                    'If that variable is not numeric, then we go ahead and assume that they're searching by make.
                    'The assumption is put in because this will force them to search by make and not somehow try to pass some SQL injection through the dropdown.
                    'So basically it's either numeric or make only.
                    If IsNumeric(crm_fractional_owners_tab_model.SelectedValue) Then
                        ModelSearchVariable = crm_fractional_owners_tab_model.SelectedValue
                    Else
                        ModelSearchVariable = 0
                        MakeSearch = True
                    End If


                    'Build/Run Query for Tab
                    results_table = crmViewDataLayer.CRM_VIEW_Build_Expiring_Fractional_Owner_Build_Run_Query(MakeSearch, YearVariable, Aircraft_Make_Name, ModelSearchVariable, ViewAll, UpgradeModels, OrderByVariable, DoNotIncludeExpired, localDatalayer, PerformEmailExport)

                    If PerformExport Or PerformEmailExport Then
                        If can_export Then
                            crmViewDataLayer.ExportTableData(results_table)
                        End If
                    Else
                        'Display Query
                        tempStr = crmViewDataLayer.CRM_VIEW_Display_Expiring_Fractional_Owner_Table(results_table, CompanyTitle, CompanyLocation, aclsData_Temp, temp_ac_id, crm_prospect_label_text_count, crm_prospect_link_view_all, TabContainer1, TabContainer1.ActiveTab.ID.ToString)
                    End If

                    Me.view_retail_sales_label1.Text = tempStr
                    tempStr = ""

                    'Saving the search to session
                    crmViewDataLayer.ParseSaveSessionSearchOnProspector(crm_fractional_owners_search)

                ElseIf LCase(TabContainer1.ActiveTab.ID.ToString) = "event_tab" Then
                    crm_wanted_tab_search.Visible = True 'Toggles Tab On
                    'Displays Text/Header Title.
                    header_string_title = "Wanteds"
                    header_string_text = "Displays a list of companies that have placed a wanted ad within JETNET's system for the designated models."

                    'Fills Common Upgrade Model Dropdown
                    crmViewDataLayer.CRM_VIEW_Fill_Common_Upgrade_Dropdown(UpgradeModelDatatable, temp_amod_id, crm_wanted_tab_models, header_string_title, model_reports_tab, crm_wanted_tab_search, Page.IsPostBack) 'First fill up the dropdowns.

                    'Let's create some variables for this tab.
                    Dim ModelSearchVariable As Long = 0 'Holds the model search variable. 
                    Dim MakeSearch As Boolean = False
                    Dim OrderByVariable As String = " order by comp_name asc, comp_city, comp_state, comp_country, journ_date" 'this comes from crm_wanted_tab_sort
                    Dim YearDateVariable As String = DateAdd(DateInterval.Year, -CInt(1), Date.Now()).Date 'Defaulting to 1 year. This comes from: crm_wanted_tab_timeframe
                    Dim DoNotIncludeBroker As Boolean = True 'default to not include broker wanteds


                    'We're going to run a select case for the sort. This is where you'll set up the order by for this particular tab. We don't need a case
                    'For company, because it's already defaulted.
                    Select Case UCase(crm_wanted_tab_sort.SelectedValue)
                        Case "DATE"
                            OrderByVariable = " order by journ_date desc "
                    End Select

                    'If include is selected, include broker wanteds
                    If UCase(crm_wanted_tab_do_not_include.SelectedValue) = "INCLUDE" Then
                        DoNotIncludeBroker = False
                    End If

                    'If this is a number and it's not 1, go ahead and figure out what they picked.
                    If IsNumeric(crm_wanted_tab_timeframe.SelectedValue) Then
                        If crm_wanted_tab_timeframe.SelectedValue <> 1 Then
                            YearDateVariable = DateAdd(DateInterval.Year, -CInt(crm_wanted_tab_timeframe.SelectedValue), Date.Now()).Date
                        End If
                    End If

                    'If that variable is not numeric, then we go ahead and assume that they're searching by make.
                    'The assumption is put in because this will force them to search by make and not somehow try to pass some SQL injection through the dropdown.
                    'So basically it's either numeric or make only.
                    If IsNumeric(crm_wanted_tab_models.SelectedValue) Then
                        ModelSearchVariable = crm_wanted_tab_models.SelectedValue
                    Else
                        ModelSearchVariable = 0
                        MakeSearch = True
                    End If

                    'Build/Run Query for Tab
                    results_table = crmViewDataLayer.CRM_VIEW_Wanted_Build_Run_Query(MakeSearch, YearDateVariable, Aircraft_Make_Name, ModelSearchVariable, ViewAll, UpgradeModels, OrderByVariable, DoNotIncludeBroker, localDatalayer, PerformEmailExport)

                    If PerformExport Or PerformEmailExport Then
                        If can_export Then
                            crmViewDataLayer.ExportTableData(results_table)
                        End If
                    Else
                        'Display Table
                        tempStr = crmViewDataLayer.CRM_VIEW_Display_Wanted_Table(results_table, CompanyTitle, CompanyLocation, aclsData_Temp, temp_ac_id, crm_prospect_label_text_count, crm_prospect_link_view_all, TabContainer1, TabContainer1.ActiveTab.ID.ToString)
                    End If
                    Me.view_events_label.Text = tempStr
                    tempStr = ""

                    'Saving the search to session
                    crmViewDataLayer.ParseSaveSessionSearchOnProspector(crm_wanted_tab_search)

                ElseIf LCase(TabContainer1.ActiveTab.ID.ToString) = "news_tab" Then
                    crm_recent_sales_search.Visible = True 'Toggles Tab on
                    'Display Header/Tab Text
                    header_string_title = "Recent Sales"
                    header_string_text = "Displays a list of broker companies and individual brokers that recently sold aircraft.  Sales staff may call these companies/contacts to see if they have 'leftover' leads for their sold aircraft; leads they may be willing to share. This list may also be useful in contacting brokers for recent sale prices."

                    'Fill Dropdown
                    crmViewDataLayer.CRM_VIEW_Fill_Common_Upgrade_Dropdown(UpgradeModelDatatable, temp_amod_id, crm_recent_sales_models, header_string_title, model_reports_tab, crm_recent_sales_search, Page.IsPostBack) 'First fill up the dropdowns.

                    Dim ModelSearchVariable As Long = 0 'Holds the model search variable. 
                    Dim MakeSearch As Boolean = False
                    Dim OrderByVariable As String = " order by comp_name asc, comp_city, comp_state, comp_country, journ_date" 'default t company.
                    Dim YearDateVariable As String = DateAdd(DateInterval.Year, -CInt(1), Date.Now()).Date 'Defaulting to 1 year.

                    'We're going to run a select case for the sort. This is where you'll set up the order by for this particular tab. We don't need a case
                    'For company, because it's already defaulted.
                    Select Case UCase(crm_recent_sales_sort.SelectedValue)
                        Case "SOLD"
                            OrderByVariable = " order by journ_date desc"
                    End Select

                    'If this is a number and it's not 1, go ahead and figure out what they picked.
                    If IsNumeric(crm_recent_sales_timeframe.SelectedValue) Then
                        If crm_recent_sales_timeframe.SelectedValue <> 1 Then
                            YearDateVariable = DateAdd(DateInterval.Year, -CInt(crm_recent_sales_timeframe.SelectedValue), Date.Now()).Date
                        End If
                    End If


                    'If that variable is not numeric, then we go ahead and assume that they're searching by make.
                    'The assumption is put in because this will force them to search by make and not somehow try to pass some SQL injection through the dropdown.
                    'So basically it's either numeric or make only.
                    If IsNumeric(crm_recent_sales_models.SelectedValue) Then
                        ModelSearchVariable = crm_recent_sales_models.SelectedValue
                    Else
                        ModelSearchVariable = 0
                        MakeSearch = True
                    End If


                    'Build/Run Query
                    results_table = crmViewDataLayer.CRM_VIEW_Recent_Sales_Build_Run_Query(MakeSearch, YearDateVariable, Aircraft_Make_Name, ModelSearchVariable, ViewAll, UpgradeModels, OrderByVariable, localDatalayer, PerformEmailExport)

                    If PerformExport Or PerformEmailExport Then
                        If can_export Then
                            crmViewDataLayer.ExportTableData(results_table)
                        End If
                    Else
                        'Display Table
                        tempStr = crmViewDataLayer.CRM_VIEW_Display_Recent_Sales_Table(results_table, CompanyTitle, CompanyLocation, aclsData_Temp, temp_ac_id, crm_prospect_label_text_count, crm_prospect_link_view_all, TabContainer1, TabContainer1.ActiveTab.ID.ToString)
                    End If

                    Me.view_news_label1.Text = tempStr

                    tempStr = ""

                    'Saving the search to session
                    crmViewDataLayer.ParseSaveSessionSearchOnProspector(crm_recent_sales_search)
                ElseIf LCase(TabContainer1.ActiveTab.ID.ToString) = "operators_tab" Then
                    crm_notes_search.Visible = True
                    header_string_title = "Notes"
                    header_string_text = "Displays a list of notes specifically associated with the selected aircraft."
                    DisplayCommonModelText = False

                    Dim OrderByVariable As String = "lnote_entry_date desc, clicomp_name"
                    Dim DisplayCompanyNotesOnly As Boolean = False

                    'Go ahead and Fill Session, but only if not postback
                    If Not Page.IsPostBack Then
                        crmViewDataLayer.FillSessionSearchOnProspector(crm_notes_search)
                    End If

                    If UCase(crm_notes_tab_sort.SelectedValue) <> "DATE" Then
                        OrderByVariable = "clicomp_name"
                    End If

                    If UCase(crm_notes_tab_filter.SelectedValue) <> "ALL" Then
                        DisplayCompanyNotesOnly = True
                    End If

                    'switched to pass in 0 for model since we want ac notes 
                    ' results_table = crmViewDataLayer.CRM_VIEW_Prospects_Notes_Build_Run_Query(temp_ac_id, UpgradeModels, False, localDatalayer, PerformExport, PerformEmailExport, temp_ac_id, True, OrderByVariable, DisplayCompanyNotesOnly, False)
                    results_table = crmViewDataLayer.CRM_VIEW_Prospects_Notes_Build_Run_Query(0, UpgradeModels, False, localDatalayer, PerformExport, PerformEmailExport, temp_ac_id, True, OrderByVariable, DisplayCompanyNotesOnly, False)

                    crm_prospect_label_text_count.Text = results_table.Rows.Count & " Notes Found."

                    If PerformExport Or PerformEmailExport Then
                        If can_export Then
                            crmViewDataLayer.ExportTableData(results_table)
                        End If
                    Else
                        tempStr = crmViewDataLayer.CRM_VIEW_Display_Prospects_Notes_Table(results_table, crm_prospect_label_text_count, aclsData_Temp, temp_ac_id, CompanyLocation, CompanyTitle, localDatalayer, True, "", TabContainer1.ActiveTab.ID.ToString)
                        view_operators_label.Text = tempStr
                    End If

                    'Saving the search to session
                    crmViewDataLayer.ParseSaveSessionSearchOnProspector(crm_notes_search)

                ElseIf LCase(TabContainer1.ActiveTab.ID.ToString) = "wanted_tab" Then 'I like finding the active tab this way, just in case you want to reorder them in the future.
                    crm_time_to_buy_tab_search.Visible = True 'Toggle Search Panel On

                    'Set Tab Text/Header
                    header_string_title = "Time to Buy"
                    header_string_text = "Displays a list of <span title='Includes End Users, Aerial Mustering, Aerial Photography, Aerial Sprayer, Air Ambulance, Air Taxi, Air Tour, Firefighting, Flight school, Search &amp; Rescue, &amp; Technical School business types.' class='help_cursor'><u><strong>end user companies</strong></u></span> who currently own "
                    header_string_text += " aircraft that have reached the typical length of ownership for their model meaning that they may be getting towards the timeframe that they would like to buy again. "

                    'Declaring the variables that we will need for this tab.
                    Dim Upgrade_Model_Ownership_Length As New DataTable 'This stores the upgrade model information as well as the length of typical ownership on new as well as used upgrade models.
                    Dim OwnerDatatable As New DataTable 'This stores the owners of aircraft models from upgrade report that have owned the ac longer than the length based on used.
                    Dim CommonUpgradeModels As Long = 0 'Stores either 0 (All Common Upgrade Models), The Common Upgrade Model IDs or My Model ID.
                    Dim ForSaleStatus As String = "BOTH" 'Stores either 'FOR SALE', 'NOT FOR SALE', 'BOTH'
                    Dim LifecyclePercentange As Decimal = 1 'Stores decimal. 1, 1.5, .9,  1.25
                    Dim OwnersToDisplay As String = "NEW" 'Stores either 'ALL', 'NEW' or 'PREVIOUS' to show which owners to display.
                    Dim CompanySort As String = "Company, Country, State, City" 'Stores sort.


                    'We need to go ahead and fill in the dropdowns for this view.
                    crmViewDataLayer.CRM_VIEW_Fill_Common_Upgrade_Dropdown(UpgradeModelDatatable, temp_amod_id, crm_time_to_buy_model_type, header_string_title, model_reports_tab, crm_time_to_buy_tab_search, Page.IsPostBack) 'First fill up the dropdowns.

                    'First let's get the pertinent information off the tab for the search.
                    'We need to get the information that's stored in the dropdown crm_time_to_buy_owners_of.
                    If crm_time_to_buy_owners_of.SelectedValue <> "" Then
                        OwnersToDisplay = crm_time_to_buy_owners_of.SelectedValue
                    End If

                    'Get this information from the dropdown.
                    If crm_time_to_buy_model_type.SelectedValue <> "" Then
                        If IsNumeric(crm_time_to_buy_model_type.SelectedValue) Then
                            CommonUpgradeModels = crm_time_to_buy_model_type.SelectedValue
                        End If
                    End If

                    'Get that information from the dropdown.
                    If crm_time_to_buy_aircraft_status.SelectedValue <> "" Then
                        ForSaleStatus = crm_time_to_buy_aircraft_status.SelectedValue
                    End If

                    If Page.IsPostBack Then
                        If IsNumeric(crm_time_to_buy_lifecycle.SelectedValue) Then
                            Select Case crm_time_to_buy_lifecycle.SelectedValue
                                Case 150
                                    LifecyclePercentange = 1.5
                                Case 125
                                    LifecyclePercentange = 1.25
                                Case 90
                                    LifecyclePercentange = 0.9
                                Case 85
                                    LifecyclePercentange = 0.85
                                Case 80
                                    LifecyclePercentange = 0.8
                                Case 75
                                    LifecyclePercentange = 0.75
                                Case Else '100
                                    LifecyclePercentange = 1
                            End Select
                        End If

                        If crm_time_to_buy_sort.SelectedValue <> "COMPANY" Then
                            CompanySort = "NbrDaysOwned desc"
                        End If

                        '3.) We need to find the owners of the aircraft based on parameters we've chosen
                        OwnerDatatable = crmViewDataLayer.CRM_VIEW_Find_Owners_From_Upgrade_Based_On_Parameters(temp_amod_id, ForSaleStatus, CommonUpgradeModels, OwnersToDisplay, LifecyclePercentange, CompanySort, ViewAll, localDatalayer, PerformEmailExport)

                        '7.) Display in a nice table.
                        If PerformExport Or PerformEmailExport Then
                            If can_export Then
                                crmViewDataLayer.ExportTableData(OwnerDatatable)
                            End If
                        Else
                            tempStr = crmViewDataLayer.CRM_VIEW_Display_Owner_Table_Time_To_Buy(OwnerDatatable, OwnersToDisplay, aclsData_Temp, temp_ac_id, crm_prospect_label_text_count, TabContainer1, crm_prospect_link_view_all, TabContainer1.ActiveTab.ID.ToString)
                        End If

                        'Display
                        view_wanteds_label1.Text = tempStr

                        'Saving the search to session
                        crmViewDataLayer.ParseSaveSessionSearchOnProspector(crm_time_to_buy_tab_search)
                    ElseIf Not Page.IsPostBack Then

                        System.Web.UI.ScriptManager.RegisterStartupScript(Me, Me.GetType, "enterLoading", " $(function() {$('#" & Button2.ClientID & "').click();  });", True)
                    End If
                ElseIf LCase(TabContainer1.ActiveTab.ID.ToString) = "documents_tab" Then
                    DisplayCommonModelText = False
                    'Display text/header
                    header_string_title = "Prospects"
                    header_string_text = "Displays a list of companies that have specifically been marked as prospects for the selected aircraft.  The  pencil indicator to the right can be used to edit the prospect description or remove the company as a prospect."
                    'Toggle Search on
                    crm_prospector_search.Visible = True

                    'Fill Dropdown
                    If crm_prospector_tab_models.SelectedValue.ToString.Trim = "" Then
                        crmViewDataLayer.CRM_VIEW_Fill_Common_Upgrade_Dropdown(UpgradeModelDatatable, temp_amod_id, crm_prospector_tab_models, header_string_title, model_reports_tab, crm_prospector_search, Page.IsPostBack, Aircraft_Model_Make_Name) 'First fill up the dropdowns.
                    End If


                    Dim ModelSearchVariable As Long = 0 'Holds the model search variable. 
                    Dim InactiveProspects As Boolean = False 'Default
                    Dim MyAircraftSearch As Boolean = False



                    'Getting the models.
                    'If IsNumeric(crm_prospector_tab_models.SelectedValue) Then
                    '  ModelSearchVariable = crm_prospector_tab_models.SelectedValue  
                    'Else
                    '  If crm_prospector_tab_models.SelectedValue = "AC" Then
                    '    MyAircraftSearch = True
                    '  Else
                    '    ModelSearchVariable = 0
                    '  End If
                    'End If

                    If crm_prospector_tab_models.SelectedValue = "AC" Then
                        MyAircraftSearch = True
                    ElseIf crm_prospector_tab_models.SelectedValue = "ACMODEL" Then
                        MyAircraftSearch = True
                        ModelSearchVariable = temp_amod_id
                    ElseIf crm_prospector_tab_models.SelectedValue = "MODEL" Then
                        MyAircraftSearch = False
                        ModelSearchVariable = temp_amod_id
                    End If

                    If crm_prospector_tab_checkbox.Checked Then
                        InactiveProspects = True
                    End If

                    results_table = crmViewDataLayer.CRM_VIEW_Prospects_Notes_Build_Run_Query(ModelSearchVariable, UpgradeModels, InactiveProspects, localDatalayer, PerformExport, PerformEmailExport, temp_ac_id, False, "lnote_opportunity_status asc, clicomp_name", False, MyAircraftSearch)

                    tempStr = ""
                    If PerformExport Or PerformEmailExport Then
                        If can_export Then
                            crmViewDataLayer.ExportTableData(results_table)
                        End If
                    Else
                        tempStr = crmViewDataLayer.CRM_VIEW_Display_Prospects_Notes_Table(results_table, crm_prospect_label_text_count, aclsData_Temp, temp_ac_id, CompanyLocation, CompanyTitle, localDatalayer, False, crm_prospector_tab_models.SelectedValue, TabContainer1.ActiveTab.ID.ToString)
                    End If
                    Me.prospects_label.Text = tempStr

                    'Saving the search to session
                    crmViewDataLayer.ParseSaveSessionSearchOnProspector(crm_prospector_search)


                End If


                'This appends the upgrade information based on what's in the upgrade table array (query ran at start of function)
                'If DisplayCommonModelText = True Then
                ' If UBound(UpgradeModels) = 1 Then
                ' If Not IsNothing(UpgradeModels(1)) Then
                'header_string_text += " <span title='Aircraft models whose owners most commonly sold their aircraft and then purchased the model shown.' class='help_cursor'><u><strong>Common Upgrade Models</strong></u></span> for the " & Aircraft_Model_Make_Name & " include the <span class='red_text'>" & UpgradeModels(1).ToString & "</span>."
                ' header_string_text += " These models are included in the selection dropdown as a group and separately. "
                'End If
                'End If
                'End If

                'Display the Report Selection/Text
                Me.model_reports_tab.HeaderText = "Report Selection: " & header_string_title
                header_string += "<table width='100%' cellpadding='0' cellspacing='0'><tr><td align='left' valign='top'>"
                header_string += "<table width='100%' cellpadding='0' cellspacing='0'>"
                header_string += "<tr class='aircraft_list'><td colspan='3'>" & header_string_text & "</td></tr>"
                header_string += "</table>"
                header_string += "</td></tr></table>"

            End If
            crm_prospect_label_text.Text = header_string

            top_tab_update_panel.Update()
            bottom_tab_update_panel.Update()
            'Set the title

            If temp_ac_id > 0 Or temp_amod_id > 0 Then
                Me.Page.Title = "Aircraft Prospector - "


                Me.Page.Title += Aircraft_Model_Make_Name
                crmProspectHeader.InnerHtml = "<strong>" & Aircraft_Model_Make_Name

                If temp_ac_id > 0 Then
                    Me.Page.Title += " S/N: " & ac_ser_no
                    crmProspectHeader.InnerHtml += " S/N: " & ac_ser_no
                End If
                crmProspectHeader.InnerHtml += "</strong>"
            Else
                Me.Page.Title = "Prospect Management"
                Me.breadcrumbs.Text = "Prospect Management"
            End If
        Catch ex As Exception

        End Try

    End Sub
    Public Sub DisplayCRMProspectPicture(ByVal temp_ac_id As Long, ByVal make_name As String, ByVal model_name As String, ByVal ac_ser_no As String, ByVal imgDisplayFolder As String)

        If temp_ac_id > 0 Then
            crmProspect_Picture.Text = GetAircraftPictures_For_CRM_VIEW(temp_ac_id, 0, make_name, model_name, ac_ser_no)
            If crmProspect_Picture.Text <> "" Then
                crmProspect_Picture.Text = "<table align='left' width='100%'><tr><td>" & crmProspect_Picture.Text & "</td></tr></table>"
            Else
                crmProspectPictureContainer.Visible = False
                crmProspectWhiteBoxContainer.Width = Unit.Percentage(95)
            End If
        Else
            imgDisplayFolder = HttpContext.Current.Session.Item("jetnetFullHostName").ToString.Trim + Session.Item("ModelPicturesFolderVirtualPath").ToString
            If Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then
                imgDisplayFolder = "https://www.testjetnetevolution.com/" + Session.Item("ModelPicturesFolderVirtualPath").ToString
            End If

            '  imgDisplayFolder = Application.Item("crmClientSiteData").ClientFullHostName + Session.Item("ModelPicturesFolderVirtualPath").ToString

            'Let's do this instead.
            Dim DisplayPicture As Boolean = False

            CheckSharedModelTable()

            If Not IsNothing(SharedModelTable) Then
                If SharedModelTable.Rows.Count > 0 Then
                    If SharedModelTable.Rows(0).Item("amod_picture_exists_flag").ToString.ToUpper = "Y" Then
                        DisplayPicture = True
                    End If
                End If
            End If

            If DisplayPicture Then
                If localCriteria.ViewCriteriaAmodID > -1 Then
                    crmProspect_Picture.Text = "<img width=""205"" src=""" & imgDisplayFolder.Trim + "/" + localCriteria.ViewCriteriaAmodID.ToString + ".jpg"""" />"
                ElseIf localCriteria.ViewCriteriaMakeAmodID > -1 Then
                    crmProspect_Picture.Text = "<img width=""205"" src=""" & imgDisplayFolder.Trim + "/" + localCriteria.ViewCriteriaMakeAmodID.ToString + ".jpg"""" />"
                End If
            Else
                crmProspectPictureContainer.Visible = False
                crmProspectWhiteBoxContainer.Width = Unit.Percentage(95)

            End If
        End If
    End Sub
    Public Function run_compare_view_items(ByRef results_label_to_display As String, ByRef activetab As Integer, ByRef selected_changed As Boolean, ByRef NOTE_ID As Long, ByRef real_ac_id As Long, ByRef make_name As String, ByRef model_name As String, ByRef temp_amod_id As Long, ByRef rest_of_ac_string As String, ByRef chart_htmlString As String, ByVal rep_id_selected As Long, ByVal run_comparable_insert As Boolean)

        run_compare_view_items = ""
        results_label_to_display = ""

        Me.settings_tab.Visible = True
        Me.months_text.Visible = True
        Me.settings_text_label.Visible = True

        Me.settings_text_label.Text = ""
        'Me.settings_text_label.Text = "<br /><br />"
        'Me.settings_text_label.Text &= "<font size='-3'>As part of your Market Value Analysis you may wish to include or exclude Estimated Values based on Recent Sales transactions.  Checking the box below will show estimated values on several tabs based on this sales data (for the timeframe specified above). For additional detail regarding estimated price calculations click "
        ' Me.settings_text_label.Text &= "<div class=""nonflyout_info_box"">In your Analysis, you may wish to include/exclude Estimates based on historical sales. Checking the box below will show these estimates based on the timeframe specified above. For additional detail regarding estimates click "
        Me.settings_text_label.Text &= "<div class=""nonflyout_info_box"">JETNET continuously gathers sale prices on transactions.  Some sale prices are gathered with permission from the source to display at a serial number level and these sale prices are displayed in listings and graphs for users with SPI subscriptions. Users without SPI subscriptions will see summaries by quarter only. Where JETNET sale price data is used in calculations, client sale price data always overrides JETNET sale price data."

        ' commented out MSW - 12/18/18
        'Me.settings_text_label.Text &= "<a href='http://www.jetnetcrm.com/support/PriceEstimates.pdf' target='_blank'>here</a>.</div>"
        'Me.settings_text_label.Text &= "<br /><br />"

        'Added this small catch to run only if this session variable is there.
        If Not IsNothing(Session.Item("selectedViewTab")) Then
            If IsNumeric(Session.Item("selectedViewTab")) Then
                TabContainer1.ActiveTabIndex = Session.Item("selectedViewTab")
                Session.Item("selectedViewTab") = ""
            End If
        End If


        If Not IsPostBack Then ' added in - only force active tab on re-load or load of page
            If Trim(Request("activetab")) <> "" Then
                activetab = CDbl(Trim(Request("activetab")))
            Else
                If IsNumeric(TabContainer1.ActiveTabIndex.ToString) Then
                    activetab = TabContainer1.ActiveTabIndex.ToString
                Else
                    activetab = 0
                End If
            End If
        ElseIf IsNumeric(TabContainer1.ActiveTabIndex.ToString) Then
            activetab = TabContainer1.ActiveTabIndex.ToString
        Else
            activetab = 0
        End If



        Me.estimated_value_label.Visible = True
        Me.edit_label_click.Visible = True

        Me.div_start_label.Text = "<div style='height:200px; width:355px; overflow: auto;'>"
        Me.div_end_label.Text = "</div>"



        If activetab = 0 Then
            ' my value history
            If RunModelOnValueOnly = False Then
                results_label_to_display = "Displays a graph & related table showing my aircraft value history including a) Past asking, take &amp; sold prices at the time of sale "
                results_label_to_display &= "b) Asking, take, &amp; estimated values stored as part of a market value analysis "
                results_label_to_display &= "c) The asking, take, &amp; estimated value of my aircraft today"
            Else
                results_label_to_display = "This graph shows asking, take, &amp; estimated values of aircraft on market."
            End If
        ElseIf activetab = 1 Then
            'market survery
            If RunModelOnValueOnly = False Then
                results_label_to_display = "Displays a list of all aircraft for sale for the model of aircraft being evaluated based on a combination of JETNET data and aircraft tailored by edits within my Marketplace Manager. The graph below shows my current aircraft value(s) with respect to the asking and take prices for all other aircraft for sale for the model of aircraft being evaluated."
            Else
                results_label_to_display = "This graph shows asking, take, &amp; estimated values of aircraft on market."
            End If
        ElseIf activetab = 2 Then
            'current market - now 3.	Market Comparables 
            results_label_to_display = "Displays a side by side of view of aircraft for sale that have been designated as 'comparable' to my selected aircraft.   The graph below shows my current aircraft value(s) with respect to the value of other individual aircraft that have specifically been identified as comparable to mine."
        ElseIf activetab = 3 Then
            'market status
            results_label_to_display = "Displays a summary of the market for my selected aircraft model as tailored by edits within my Marketplace Manager. The graph below shows my current aircraft value(s) with respect to the average asking and average take price for aircraft currently on the market for my model."
        ElseIf activetab = 4 Then
            'market trends
            results_label_to_display = "Displays a series of graphs and/or tables providing an overview of market trends for aircraft for sale for my selected aircraft model. Graphs include the Number of Aircraft for Sale over time as well as the Average Price of Aircraft over time."
            'results_label_to_display = "Displays a series of graphs providing an overview of historical trends for aircraft sales for my selected aircraft model from JETNET’s historical databases.  Graphs include the Number of Aircraft for Sale By Month,  the Average Price of Aircraft for Sale by Month, the Number of Aircraft Sold per Month, and the Average Days On Market for Aircraft for Sale for each Month."
        ElseIf activetab = 5 Then
            ' recent sales
            If RunModelOnValueOnly = False Then
                results_label_to_display = "Displays a list of all aircraft sold in the last year for the model of aircraft being evaluated based on a combination of JETNET data and aircraft tailored by edits within my Marketplace Manager. The graph below shows my current aircraft value(s) with respect to the asking, take, and sold prices."
            Else
                results_label_to_display = "This graph shows asking, take, and sold prices for the sold aircraft."
            End If
        ElseIf activetab = 6 Then
            'sold comparables
            results_label_to_display = "Displays a side by side of view of aircraft that have sold that have been designated as 'comparable' to my selected aircraft. The graph below shows my current aircraft value(s) with respect to select aircraft sold comparables. "
        ElseIf activetab = 7 Then
            'sold trends
            results_label_to_display = "Sold Trends"
        ElseIf activetab = 8 Then
            'analytics
            results_label_to_display = "Displays a series of graphs and related data showing the value of my aircraft over time with respect to other aircraft on the market or recently sold including:"
            results_label_to_display &= "<br>"
            results_label_to_display &= "<ul style='margin:5px; padding:1px;'>"
            results_label_to_display &= "<li style='border:0px; margin:5px; padding:1px;'>&#8226;<b>My Aircraft Value (Column 1)</b> – Shows a graph and related data table of my aircraft values throughout history based on (a) past sold prices for my aircraft (b) stored values of my aircraft stored at a given time associated with a market value analysis (c) the current value of my aircraft today.</li>"
            results_label_to_display &= "<li style='border:0px; margin:5px; padding:1px;'>&#8226;<b>Market Comparables (Column 2)</b> –Shows a graph and related data table of my current aircraft value(s) with respect to the value of other individual aircraft that have specifically been identified as comparable to mine.</li>"
            results_label_to_display &= "<li style='border:0px; margin:5px; padding:1px;'>&#8226;<b>Sold Comparables (Column 3)</b> –Shows a graph and related data table of my current aircraft value(s) with respect to aircraft sold comparables listed on the 'Sold Comparables' tab.</li>"
            results_label_to_display &= "<li style='border:0px; margin:5px; padding:1px;'>&#8226;<b>Market Status (Column 4)</b> – Shows a graph of average market values for my selected aircraft model as tailored by edits within my Marketplace Manager.</li>"
            results_label_to_display &= "<li style='border:0px; margin:5px; padding:1px;'>&#8226;<b>Market Survey (Column 5)</b> - Shows a graph of asking, take, and estimated prices of all aircraft for sale for the model of aircraft being evaluated based on a combination of JETNET data and aircraft tailored by edits within my Marketplace Manager.</li>"
            results_label_to_display &= "<li style='border:0px; margin:5px; padding:1px;'>&#8226;<b>Sold Survey (Column 6)</b> – Shows a graph of asking, take, and estimated prices of all aircraft for sold within the last year for the model of aircraft being evaluated based on a combination of JETNET data and aircraft tailored by edits within my Marketplace Manager.</li>"

            results_label_to_display &= "</ul>"
            results_label_to_display &= "Graph Values are shown as <font color='blue' size='+1'>&#8226;</font> asking, <font color='red' size='+1'>&#8226;</font> take, and  <font color='green' size='+1'>&#8226;</font> estimated value."
        ElseIf activetab = 9 Then
        ElseIf activetab = 10 Then

            results_label_to_display = "This graph shows estimated values of aircraft for this model."

        End If

        System.Threading.Thread.Sleep(100)



        If Trim(Request("graph")) <> "" Then

            HttpContext.Current.Session.Item("jetnetServerNotesDatabase") = Application.Item("crmClientDatabase")

            Session.Item("localSubscription").crmServerSideNotes_Flag = True

            Call localDatalayer.run_view_19_actions(NOTE_ID, real_ac_id, make_name, model_name, temp_amod_id, rest_of_ac_string, chart_htmlString, Session.Item("CLIENT_AC_ID"), Me.model_reports_tab.HeaderText, COMPLETED_OR_OPEN, localCriteria, make_model_name_label.Text, Me.breadcrumbs.Text, TabContainer1, Me.settings_right_label.Text, Me.Page.Title, Me.LAST_SAVE_DATE, Session.Item("JETNET_AC_ID"), Me.edit_label_click.Text, Me.year_month_settings, Me.estimated_value, Me.years_of, Me.sales_within, Me.use_jetnet_data, Me.Page, Me.used_of_used, Me.year_of_current.Text, Me.aftt_of_current.Text, RunModelOnValueOnly)

            Call run_active_tab_changed(activetab, True, results_label_to_display)


            Me.graph_panel.HeaderText = "Graph: " & TabContainer1.ActiveTab.HeaderText.ToString


            Me.TabContainer1.Visible = False
            Me.TabContainer2.Visible = False
            Me.loaded_visibility.Visible = False
            Me.loaded_visibility1.Visible = False
            Me.divLoading.Visible = False
            Me.large_graph_panel.Visible = True
            Me.graph_update_panel.Visible = True


        Else

            selected_changed = False

            If Not IsPostBack Then
                'I'm not sure if this is needed anymore. If you're not using that request variable
                'Anywhere else, please feel free to get rid of it. I grab the request variable on the edit page and 
                'store that session variable down below (ViewActiveTab) so that way I can clear it and it won't get stuck
                'On a certain tab.


                If CRMViewActive Then
                    If Not IsNothing(Session.Item("ViewActiveTab")) Then
                        If Not String.IsNullOrEmpty(Session.Item("ViewActiveTab").ToString.Trim) Then
                            If IsNumeric(Session.Item("ViewActiveTab")) Then
                                activetab = Session.Item("ViewActiveTab")
                                Session.Item("ViewActiveTab") = ""
                            End If
                        End If
                    End If
                End If

            Else

                If TabContainer1.ActiveTabIndex.ToString = Trim(Request("activetab")) Then
                    activetab = TabContainer1.ActiveTabIndex.ToString
                Else
                    activetab = TabContainer1.ActiveTabIndex.ToString
                End If


                'If activetab = 0 Then ' start
                '  If Len(Me.view_trends_label.Text) > 100 Then
                '    selected_changed = True
                '  End If
                'ElseIf activetab = 1 Then ' current 
                '  If Len(Me.compare_view_current_label.Text) > 100 Then
                '    selected_changed = True
                '  End If
                'ElseIf activetab = 2 Then ' current 
                '  If Len(Me.compare_view_sold_label.Text) > 100 Then
                '    selected_changed = True
                '  End If
                'ElseIf activetab = 4 Then ' current 
                '  If Len(Me.view_news_label.Text) > 100 Then
                '    selected_changed = True
                '  End If
                'End If



                If Trim(Session("LAST_ACTIVE_TAB")) <> "" Then
                    If CDbl(Session("LAST_ACTIVE_TAB")) = CDbl(activetab) Then
                        If Trim(Request("activetab")) = Trim(activetab) Then
                            ' if it is re-posting from the same tab, it will either be coming back to it
                            ' or running a new one .. either way it shouldnt run code
                            selected_changed = True
                        End If
                    End If
                End If




                If IsNumeric(TabContainer1.ActiveTabIndex.ToString) Then
                    Session("LAST_ACTIVE_TAB") = TabContainer1.ActiveTabIndex.ToString
                Else
                    Session("LAST_ACTIVE_TAB") = 0
                End If

            End If


            HttpContext.Current.Session.Item("jetnetServerNotesDatabase") = Application.Item("crmClientDatabase")

            Session.Item("localSubscription").crmServerSideNotes_Flag = True

            Call localDatalayer.run_view_19_actions(NOTE_ID, real_ac_id, make_name, model_name, temp_amod_id, rest_of_ac_string, chart_htmlString, Session.Item("CLIENT_AC_ID"), Me.model_reports_tab.HeaderText, COMPLETED_OR_OPEN, localCriteria, make_model_name_label.Text, Me.breadcrumbs.Text, TabContainer1, Me.settings_right_label.Text, Me.Page.Title, Me.LAST_SAVE_DATE, Session.Item("JETNET_AC_ID"), Me.edit_label_click.Text, Me.year_month_settings, Me.estimated_value, Me.years_of, Me.sales_within, Me.use_jetnet_data, Me.Page, Me.used_of_used, Me.year_of_current.Text, Me.aftt_of_current.Text, RunModelOnValueOnly)

            If selected_changed = False Then
                Call run_active_tab_changed(activetab, False, results_label_to_display, rep_id_selected, run_comparable_insert)
            Else
                Call turn_on_off_tabs_compare_view(NOTE_ID)
            End If

        End If

    End Function

    Private Sub CRM_VIEW_Set_Up_Page_Toggle_Tabs()

        'View tabs
        evo_view_help.Visible = False
        crm_view_help.Visible = True

        loaded_visibility.CssClass = "display_block"

        add_ChangeTopActiveTab_Script(tabs_container)

        PanelCollapseEx.Collapsed = True
        PanelCollapseEx.ClientState = "True"

        ' kill the top panel 
        Me.Control_Panel.Visible = False
        Me.Collapse_Panel.Visible = False

        'Let's toggle visibility on on some controls.
        crm_info.Visible = True 'This is the main container for the search panels down below.
        Me.documents_tab.Visible = True
        Me.TabContainer1.Visible = True
        Me.tabs_container.Visible = True
        Me.loaded_visibility.Visible = True
        Me.model_reports_tab.Visible = True
        count_label.Visible = True
        crm_view_view_all.Visible = False
        prospects_label.Visible = True


        If Session.Item("localUser").crmAllowExport_Flag = False Or Session.Item("localUser").crmUserType = eUserTypes.GUEST Or Session.Item("localUser").crmDemoUserFlag = True Then
            crm_export_button.Visible = False
            crm_export_email_button.Visible = False
        Else
            crm_export_button.Visible = True
            crm_export_email_button.Visible = True
        End If


        'These toggle off the search panels for the individual views.
        'They start off all toggled off, they end up being turned on individually down below.
        crm_time_to_buy_tab_search.Visible = False
        crm_previous_owners_tab_search.Visible = False
        crm_expiring_leases_search.Visible = False
        crm_fractional_owners_search.Visible = False
        crm_wanted_tab_search.Visible = False
        crm_recent_sales_search.Visible = False
        crm_prospector_search.Visible = False
        crm_notes_search.Visible = False

        'We are not using these tabs, so let's toggle them off.
        Me.charter_tab.Visible = False
        Me.fractional_tab.Visible = False
        Me.lease_tab.Visible = False
        Me.spi_tab.Visible = False
        Me.location_tab.Visible = False
        Me.star_tab.Visible = False
        Me.range_tab.Visible = False
        Me.actions_dropdown.Visible = False
        Me.actions_submenu_dropdown.Visible = False
        Me.divLoading.Visible = False
        Me.loaded_visibility1.Visible = False
        Me.model_market_status_tab.Visible = False
        Me.model_fleet_tab.Visible = False
        Me.model_performance_tab.Visible = False
        Me.model_operating_costs_tab.Visible = False
        Me.model_description_tab.Visible = False
        Me.model_flight_tab.Visible = False
        'update_compare.Visible = False
        'Set up the breadcrumb (view name in gray bar)
        Me.breadcrumbs.Text = "Aircraft Prospector"

        'Set up the tab header text
        Me.trends_tab.HeaderText = "Previous Owners"
        Me.for_sale_tab.HeaderText = "Expiring Leases"
        Me.retail_tab.HeaderText = "Expiring Fractional Owners"
        Me.event_tab.HeaderText = "Wanteds"
        Me.news_tab.HeaderText = "Broker Sales"
        Me.wanted_tab.HeaderText = "Time To Buy"
        Me.operators_tab.HeaderText = "Notes"
        Me.documents_tab.HeaderText = "Prospects"
    End Sub

#End Region

#Region "view_19_functions"

    Public Function get_fields_high_order(ByVal NOTE_ID As Long) As Integer

        get_fields_high_order = 98

        Dim results_table As New DataTable
        Dim temp_name As String = ""
        Dim temp_val As String = ""
        Dim Query As String = ""

        Query = " SELECT top 1 clivalch_order  "
        Query &= "  from client_value_field_choice "
        Query &= " where clivalfld_val_id = " & NOTE_ID & " "
        Query &= " order by clivalch_order desc"

        results_table = localDatalayer.Get_Compare_Query(Query, "get_fields_high_order")

        If Not IsNothing(results_table) Then

            If results_table.Rows.Count > 0 Then
                For Each r As DataRow In results_table.Rows
                    get_fields_high_order = r("clivalch_order")
                Next
            End If
        End If

        get_fields_high_order = get_fields_high_order + 1

    End Function

    Public Sub check_custom_fields()

        Dim Query As String = ""
        Dim results_table As New DataTable
        Dim temp_name As String = ""
        Dim temp_val As String = ""
        Dim found_spot As Boolean = False
        Dim insert_string_start As String = ""
        Dim insert_string As String = ""
        Dim i As Integer = 0
        Dim SqlConn As New MySql.Data.MySqlClient.MySqlConnection
        Dim SqlCommand As New MySql.Data.MySqlClient.MySqlCommand
        Dim SqlException As MySql.Data.MySqlClient.MySqlException : SqlException = Nothing

        Try

            Query = " SELECT * "
            Query &= " from client_preference "
            Query &= " where clipref_ac_custom_1_use = 'Y' "

            results_table = localDatalayer.Get_Compare_Query(Query, "check_custom_fields")

            If Not IsNothing(results_table) Then

                If results_table.Rows.Count > 0 Then

                    insert_string_start = "INSERT INTO client_value_field_choice("
                    insert_string_start &= " clivalch_order, clivalch_name, clivalch_db_name, clivalch_trans_db_name, clivalch_closed_db_name, "
                    insert_string_start &= " clivalch_description"
                    insert_string_start &= ") VALUES ( "

                    SqlConn.ConnectionString = Application.Item("crmClientDatabase")
                    SqlConn.Open()
                    SqlCommand.Connection = SqlConn

                    insert_string = " delete from client_value_field_choice where clivalch_db_name like 'cliaircraft_custom_%' "

                    SqlCommand.CommandText = insert_string
                    SqlCommand.ExecuteNonQuery()
                    HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />Check_Custom_Fields (" & Date.Now & ")</b><br />" + insert_string.ToString


                    For Each r As DataRow In results_table.Rows

                        For i = 1 To 10
                            If Not IsDBNull(r("clipref_ac_custom_" & i & "_use")) Then
                                If Trim(r("clipref_ac_custom_" & i & "_use")) = "Y" Then
                                    If Not IsDBNull(r("clipref_ac_custom_" & i & "")) Then
                                        If Trim(r("clipref_ac_custom_" & i & "")) <> "" Then
                                            insert_string = insert_string_start
                                            insert_string &= "10" & i & ", '" & r("clipref_ac_custom_" & i & "") & "' "
                                            insert_string &= ", 'cliaircraft_custom_" & i & "', '', 'clival_custom_" & i & "', "
                                            insert_string &= "'" & r("clipref_ac_custom_" & i & "") & "'"
                                            insert_string &= " )"

                                            ' RUN INSERT STATEMENT -------------- 

                                            SqlCommand.CommandText = insert_string
                                            SqlCommand.ExecuteNonQuery()
                                            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />Check_Custom_Fields2 (" & Date.Now & ")</b><br />" + insert_string.ToString

                                            ' RUN INSERT STATEMENT --------------
                                        End If
                                    End If
                                End If
                            End If
                        Next

                    Next
                End If
            End If


        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Sub

    Public Sub get_fields_for_add_comparable(ByVal NOTE_ID As Long, ByRef drop_list As ListBox, ByVal selected_field As String)

        Dim Query As String = ""
        Dim results_table As New DataTable
        Dim temp_name As String = ""
        Dim temp_val As String = ""
        Dim found_spot As Boolean = False

        Query = " SELECT clivalch_id, clivalch_order, clivalch_name, clivalch_db_name, clivalch_trans_db_name, clivalch_closed_db_name,  "
        Query &= " clivalch_description " '
        Query &= "  from client_value_field_choice "
        If Trim(selected_field) = "" Then
            Query &= " where clivalch_id not in (SELECT distinct clivalfld_choice_id "
            Query &= "  from client_value_fields "
            Query &= " where clivalfld_val_id = " & NOTE_ID & " ) "
        Else
            Query &= " where clivalch_name = '" & Trim(selected_field) & "' "
        End If
        Query &= " order by clivalch_order"

        results_table = localDatalayer.Get_Compare_Query(Query, "get_fields_for_add_comparable")

        If Not IsNothing(results_table) Then

            If results_table.Rows.Count > 0 Then

                drop_list.Items.Clear()
                drop_list.Visible = True

                For Each r As DataRow In results_table.Rows

                    If Not IsDBNull(r("clivalch_name")) Then
                        temp_name = r("clivalch_name")
                    Else
                        temp_name = ""
                    End If


                    If Not IsDBNull(r("clivalch_id")) Then
                        temp_val = r("clivalch_id") & "XXX"
                    Else
                        temp_val = "0XXX"
                    End If

                    If Not IsDBNull(r("clivalch_name")) Then
                        temp_val &= r("clivalch_name") & "XXX"
                    Else
                        temp_val &= " XXX"
                    End If


                    If Not IsDBNull(r("clivalch_db_name")) Then
                        temp_val &= r("clivalch_db_name") & "XXX"
                    Else
                        temp_val &= " " & "XXX"
                    End If

                    If Not IsDBNull(r("clivalch_trans_db_name")) Then
                        temp_val &= r("clivalch_trans_db_name") & "XXX"
                    Else
                        temp_val &= " XXX"
                    End If

                    If Not IsDBNull(r("clivalch_closed_db_name")) Then
                        temp_val &= r("clivalch_closed_db_name")
                    Else
                        temp_val &= " "
                    End If


                    drop_list.Items.Add(New ListItem(temp_name, temp_val))


                Next


                If found_spot = False Then
                    drop_list.SelectedIndex = 0
                End If

            End If
        End If



    End Sub

    Public Function get_ac_details_from_jetnet(ByVal jetnet_ac_id As Long, ByVal type_of As String) As String
        get_ac_details_from_jetnet = ""

        Dim results_table As New DataTable
        Dim Query As String = ""
        Dim temp_table As String = ""

        Try

            If Trim(type_of) = "F" Then
                Query = " select "
                Query &= " amod_make_name + ' ' + amod_model_name + ' ' + ac_ser_no as ac_details, "
                Query &= " ac_mfr_year  as year_mfr, ac_reg_no as reg_nbr, ac_asking_price as asking_price "
                Query &= " from aircraft "
                Query &= "  inner join aircraft_model on amod_id = ac_amod_id  "
                Query &= " where ac_id = " & jetnet_ac_id & " and ac_journ_id = 0 "
            Else
                Query = " select "
                Query &= "  ac_ser_no  + ' ' + amod_make_name + ' ' + amod_model_name  as ac_details,  "
                Query &= "  ac_mfr_year as year_mfr, ac_reg_no as reg_nbr, ac_asking_price as asking_price, journ_date   "
                Query &= " from journal "
                Query &= " inner join Aircraft on ac_id = journ_ac_id "
                Query &= " INNER JOIN aircraft_model ON  amod_id = ac_amod_id "
                Query &= " where ac_id = " & jetnet_ac_id & " and ac_journ_id = 0 "

                If Trim(Request("trans_id")) <> "" Then
                    Query &= " and journ_id = " & Trim(Request("trans_id"))
                End If
            End If

            results_table = get_JETNET_Compare_query(Query, "get_ac_details_for_valuation")

            If Not IsNothing(results_table) Then

                If results_table.Rows.Count > 0 Then

                    temp_table &= "<table cellspacing='0' cellpadding='3' border='1'>"

                    For Each r As DataRow In results_table.Rows


                        temp_table &= "<tr><td bgcolor='gray'><font color='white'>AC</font></td>"

                        If Not IsDBNull(r("ac_details")) Then
                            temp_table &= "<td align='left'>" & r("ac_details") & "</td></tr>"
                        Else
                            temp_table &= "<td align='left'>&nbsp;</td></tr>"
                        End If


                        temp_table &= "<tr><td bgcolor='gray'><font color='white'>Year Mfr</font></td>"


                        If Not IsDBNull(r("year_mfr")) Then
                            temp_table &= "<td align='left'>" & r("year_mfr") & "</td></tr>"
                        Else
                            temp_table &= "<td align='left'>&nbsp;</td></tr>"
                        End If

                        temp_table &= "<tr><td bgcolor='gray'><font color='white'>Registration Number</font></td>"


                        If Not IsDBNull(r("reg_nbr")) Then
                            temp_table &= "<td align='left'>" & r("reg_nbr") & "</td></tr>"
                        Else
                            temp_table &= "<td align='left'>&nbsp;</td></tr>"
                        End If

                        temp_table &= "<tr><td bgcolor='gray'><font color='white'>Asking Price</font></td>"

                        If Not IsDBNull(r("asking_price")) Then
                            If r("asking_price") > 0 Then
                                temp_table &= "<td align='left'>" & FormatNumber((r("asking_price") / 1000), 0) & "k</td></tr>"
                            Else
                                temp_table &= "<td align='left'>-</td></tr>"
                            End If
                        Else
                            temp_table &= "<td align='left'>-</td></tr>"
                        End If



                        If Trim(type_of) = "S" Then
                            temp_table &= "<tr><td bgcolor='gray'><font color='white'>Date</font></td>"
                            temp_table &= "<td align='left'>" & r("journ_date") & "</td></tr>"
                        End If

                    Next

                    temp_table &= "</table>"

                End If
            End If

            get_ac_details_from_jetnet = temp_table

        Catch ex As Exception

        End Try
    End Function

    Public Function get_ac_details_from_jetnet_for_graph(ByVal jetnet_ac_id As Long) As String
        get_ac_details_from_jetnet_for_graph = ""

        Dim results_table As New DataTable
        Dim Query As String = ""
        Dim temp_table As String = ""

        Try

            Query = " select "
            Query &= " amod_make_name + ' ' + amod_model_name + ' ' + ac_ser_no as ac_details, "
            Query &= " ac_mfr_year  as year_mfr, ac_reg_no as reg_nbr, ac_asking_price as asking_price "
            Query &= " from aircraft "
            Query &= "  inner join aircraft_model on amod_id = ac_amod_id  "
            Query &= " where ac_id = " & jetnet_ac_id & " and ac_journ_id = 0 "


            results_table = get_JETNET_Compare_query(Query, "get_ac_details_from_jetnet_for_graph")

            If Not IsNothing(results_table) Then

                If results_table.Rows.Count > 0 Then

                    For Each r As DataRow In results_table.Rows


                        If Not IsDBNull(r("year_mfr")) Then
                            temp_table &= "" & r("year_mfr") & ""
                        End If

                        If Not IsDBNull(r("ac_details")) Then
                            temp_table &= " " & r("ac_details") & ""
                        End If

                        If Not IsDBNull(r("reg_nbr")) Then
                            temp_table &= " " & r("reg_nbr") & ""
                        End If

                    Next

                End If
            End If

            get_ac_details_from_jetnet_for_graph = temp_table

        Catch ex As Exception

        End Try
    End Function

    Public Function get_JETNET_Compare_query(ByVal sQuery As String, ByVal title_of_query As String) As DataTable

        Dim atemptable As New DataTable

        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader : SqlReader = Nothing
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing

        Try

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />" & title_of_query & " (" & Date.Now & ")</b><br />" + sQuery.ToString

            SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            SqlConn.Open()
            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 60

            SqlCommand.CommandText = sQuery.ToString
            SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

            Try
                atemptable.Load(SqlReader)
            Catch constrExc As System.Data.ConstraintException
                ' Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
                ' aError = "** Error in [View_Master.ascx.vb :  Get_CRM_VIEW_Prospects load datatable" + constrExc.Message
            End Try

        Catch ex As Exception
            Return Nothing
            ' aError = "** Error in [View_Master.ascx.vb :  Get_CRM_VIEW_Prospects()" + ex.Message
        Finally
            SqlReader = Nothing

            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing
        End Try

        Return atemptable

    End Function

    Public Function get_ac_details_for_valuation(ByVal client_ac As Long, ByVal type_of As String, ByVal jetnet_ac_id As Long) As String
        get_ac_details_for_valuation = ""

        Dim results_table As New DataTable
        Dim Query As String = ""
        Dim temp_table As String = ""

        Try

            If Trim(type_of) = "F" Then
                Query = " select "
                Query &= " CONCAT(cliamod_make_name, ' ', cliamod_model_name  , ' ', cliaircraft_ser_nbr) as ac_details, "
                Query &= "cliaircraft_year_mfr as year_mfr, cliaircraft_reg_nbr as reg_nbr, cliaircraft_asking_price as asking_price, cliaircraft_est_price as take_price, cliaircraft_broker_price as sold_price "
                Query &= " from client_aircraft "
                Query &= " inner join client_aircraft_model on cliamod_id = cliaircraft_cliamod_id "
                Query &= " where cliaircraft_id = " & client_ac
            Else
                Query = " select "
                Query &= "  CONCAT(clitrans_ser_nbr, ' ' , cliamod_make_name, ' ', cliamod_model_name) as ac_details, "
                Query &= "clitrans_year_mfr as year_mfr, clitrans_reg_nbr as reg_nbr, clitrans_asking_price as asking_price, clitrans_est_price as take_price, clitrans_sold_price as sold_price, clitrans_date  "
                Query &= " from client_transactions "
                Query &= " INNER JOIN client_aircraft_model ON cliamod_id  = clitrans_cliamod_id "
                If client_ac > 0 Then
                    Query &= " where clitrans_cliac_id = " & client_ac
                Else
                    Query &= " where clitrans_jetnet_ac_id = " & jetnet_ac_id
                End If
                If Trim(Request("trans_id")) <> "" Then
                    Query &= " and clitrans_id = " & Trim(Request("trans_id"))
                End If
            End If

            results_table = localDatalayer.Get_Compare_Query(Query, "get_ac_details_for_valuation")

            If Not IsNothing(results_table) Then

                If results_table.Rows.Count > 0 Then

                    temp_table &= "<table cellspacing='0' cellpadding='3' border='1'>"

                    For Each r As DataRow In results_table.Rows


                        temp_table &= "<tr><td bgcolor='gray'><font color='white'>AC</font></td>"
                        temp_table &= "<td align='left'>" & r("ac_details") & "</td></tr>"


                        temp_table &= "<tr><td bgcolor='gray'><font color='white'>Year Mfr</font></td>"
                        temp_table &= "<td align='left'>" & r("year_mfr") & "</td></tr>"

                        temp_table &= "<tr><td bgcolor='gray'><font color='white'>Registration Number</font></td>"
                        temp_table &= "<td align='left'>" & r("reg_nbr") & "</td></tr>"


                        temp_table &= "<tr><td bgcolor='gray'><font color='white'>Asking Price</font></td>"

                        If r("asking_price") > 0 Then
                            temp_table &= "<td align='left'>" & FormatNumber((r("asking_price") / 1000), 0) & "k</td></tr>"
                        Else
                            temp_table &= "<td align='left'>-</td></tr>"
                        End If

                        temp_table &= "<tr><td bgcolor='gray'><font color='white'>Take Price</font></td>"

                        If r("take_price") > 0 Then
                            temp_table &= "<td align='left'>" & FormatNumber((r("take_price") / 1000), 0) & "k</td></tr>"
                        Else
                            temp_table &= "<td align='left'>-</td></tr>"
                        End If

                        If Trim(type_of) = "F" Then
                            temp_table &= "<tr><td bgcolor='gray'><font color='white'>Estimated Value</font></td>"
                        Else
                            temp_table &= "<tr><td bgcolor='gray'><font color='white'>Sold Value</font></td>"
                        End If

                        If r("sold_price") > 0 Then
                            temp_table &= "<td align='left'>" & FormatNumber((r("sold_price") / 1000), 0) & "k</td></tr>"
                        Else
                            temp_table &= "<td align='left'>-</td></tr>"
                        End If

                        If Trim(type_of) = "S" Then
                            temp_table &= "<tr><td bgcolor='gray'><font color='white'>Date</font></td>"
                            temp_table &= "<td align='left'>" & r("clitrans_date") & "</td></tr>"
                        End If

                    Next

                    temp_table &= "</table>"

                End If
            End If

            get_ac_details_for_valuation = temp_table

        Catch ex As Exception

        End Try
    End Function

    Sub ac_based_changed(ByVal sender As Object, ByVal e As System.EventArgs) Handles ac_based.CheckedChanged

        Dim this_section_string As String = ""
        Dim airport_fbo_functions As New airport_fbo_view_functions
        Dim aport_id As Integer = 0
        Dim amod_id As Integer = 0
        Dim AirportData As New DataTable
        Dim location_name As String = ""
        Dim orig_lat As Double = 0.0
        Dim orig_long As Double = 0.0
        Dim temp_distance As Integer = 0
        Dim show_not_based As Boolean = False

        Try


            If Trim(Request("months")) <> "" Then
                localCriteria.ViewCriteriaTimeSpan = CDbl(Trim(Request("months")))
            Else
                localCriteria.ViewCriteriaTimeSpan = 12
            End If

            If Me.ac_based.Checked Then
                show_not_based = True
            Else
                show_not_based = False
            End If


            airport_fbo_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            airport_fbo_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            airport_fbo_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            airport_fbo_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            airport_fbo_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim



            'If Trim(Request("aport_id")) <> "" Then
            '  aport_id = Trim(Request("aport_id"))
            'Else
            '  aport_id = airport_fbo_functions.get_default_airport_id(localCriteria, Session.Item("localPreferences").UserCompanyID, "City", 0)
            '  If aport_id = 0 Then
            '    aport_id = airport_fbo_functions.get_default_airport_id(localCriteria, Session.Item("localPreferences").UserCompanyID, "Radius", 25)
            '  End If
            '  If aport_id = 0 Then
            '    aport_id = airport_fbo_functions.get_default_airport_id(localCriteria, Session.Item("localPreferences").UserCompanyID, "State", 0)
            '  End If
            'End If


            If Trim(Request("aport_id")) <> "" Then
                aport_id = Trim(Request("aport_id"))
                Session("Last_Aport_ID") = aport_id
            Else
                If Session("Last_Aport_ID") = 0 Then
                    aport_id = airport_fbo_functions.get_default_airport_id(localCriteria, Session.Item("localPreferences").UserCompanyID, "City", 0)
                    If aport_id = 0 Then
                        aport_id = airport_fbo_functions.get_default_airport_id(localCriteria, Session.Item("localPreferences").UserCompanyID, "Radius", 25)
                    End If
                    If aport_id = 0 Then
                        aport_id = airport_fbo_functions.get_default_airport_id(localCriteria, Session.Item("localPreferences").UserCompanyID, "State", 0)
                    End If
                Else
                    aport_id = Session("Last_Aport_ID")
                End If
            End If


            airport_fbo_functions.Airport_ID_OVERALL = aport_id

            'clear any model data
            localCriteria.ViewCriteriaAmodID = -1
            localCriteria.ViewCriteriaAircraftMake = ""
            localCriteria.ViewCriteriaAircraftModel = ""

            If Trim(Request("amod_id")) <> "" Then
                amod_id = Trim(Request("amod_id"))
                localCriteria.ViewCriteriaAmodID = amod_id
            End If


            AirportData = localDatalayer.get_range_airports_by_IATA_or_ICAO(localCriteria, aport_id)
            Call localDatalayer.get_airport_information(AirportData, Me.view_market_status_label.Text, localCriteria, location_name, orig_lat, orig_long)

            System.Web.UI.ScriptManager.RegisterStartupScript(Me.TabContainer1, Me.GetType, "fbo_view_map_script", "initialize_view_mapWithCenter(" + orig_lat.ToString + ", " + orig_long.ToString + ",'airport_map_label');add_location_view_marker('" + localCriteria.ViewCriteriaAirportName.Trim + "'," + orig_lat.ToString + ", " + orig_long.ToString + ", -1, '', viewMapFBO);" + vbCrLf, True)

            this_section_string = ""
            Call airport_fbo_functions.get_flight_activity_by_ac_top_function(localCriteria, this_section_string, show_not_based, "")
            Me.view_operating_costs_label.Text = this_section_string

        Catch ex As Exception

        End Try


    End Sub

    Sub controlled_check_changed(ByVal sender As Object, ByVal e As System.EventArgs) Handles controlled.CheckedChanged

        Dim this_section_string As String = ""
        Dim airport_fbo_functions As New airport_fbo_view_functions
        Dim aport_id As Integer = 0
        Dim amod_id As Integer = 0
        Dim AirportData As New DataTable
        Dim searchCriteria As New viewSelectionCriteriaClass
        Dim location_name As String = ""
        Dim orig_lat As Double = 0.0
        Dim orig_long As Double = 0.0
        Dim temp_distance As Integer = 0

        Try


            If Trim(Request("months")) <> "" Then
                searchCriteria.ViewCriteriaTimeSpan = CDbl(Trim(Request("months")))
            Else
                searchCriteria.ViewCriteriaTimeSpan = 12
            End If

            If Trim(Request("distance")) <> "" Then
                temp_distance = Trim(Request("distance"))
            Else
                temp_distance = 150
            End If



            airport_fbo_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            airport_fbo_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            airport_fbo_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            airport_fbo_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            airport_fbo_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim



            'If Trim(Request("aport_id")) <> "" Then
            '  aport_id = Trim(Request("aport_id"))
            'Else
            '  aport_id = airport_fbo_functions.get_default_airport_id(searchCriteria, Session.Item("localPreferences").UserCompanyID, "City", 0)
            '  If aport_id = 0 Then
            '    aport_id = airport_fbo_functions.get_default_airport_id(localCriteria, Session.Item("localPreferences").UserCompanyID, "Radius", 25)
            '  End If
            '  If aport_id = 0 Then
            '    aport_id = airport_fbo_functions.get_default_airport_id(searchCriteria, Session.Item("localPreferences").UserCompanyID, "State", 0)
            '  End If
            'End If

            If Trim(Request("aport_id")) <> "" Then
                aport_id = Trim(Request("aport_id"))
                Session("Last_Aport_ID") = aport_id
            Else
                If Session("Last_Aport_ID") = 0 Then
                    aport_id = airport_fbo_functions.get_default_airport_id(localCriteria, Session.Item("localPreferences").UserCompanyID, "City", 0)
                    If aport_id = 0 Then
                        aport_id = airport_fbo_functions.get_default_airport_id(localCriteria, Session.Item("localPreferences").UserCompanyID, "Radius", 25)
                    End If
                    If aport_id = 0 Then
                        aport_id = airport_fbo_functions.get_default_airport_id(localCriteria, Session.Item("localPreferences").UserCompanyID, "State", 0)
                    End If
                Else
                    aport_id = Session("Last_Aport_ID")
                End If
            End If



            airport_fbo_functions.Airport_ID_OVERALL = aport_id

            'clear any model data
            localCriteria.ViewCriteriaAmodID = -1
            localCriteria.ViewCriteriaAircraftMake = ""
            localCriteria.ViewCriteriaAircraftModel = ""

            If Trim(Request("amod_id")) <> "" Then
                amod_id = Trim(Request("amod_id"))
                localCriteria.ViewCriteriaAmodID = amod_id
            End If
            fboMapScript.Visible = True


            AirportData = localDatalayer.get_range_airports_by_IATA_or_ICAO(localCriteria, aport_id)
            Call localDatalayer.get_airport_information(AirportData, Me.view_market_status_label.Text, localCriteria, location_name, orig_lat, orig_long)


            System.Web.UI.ScriptManager.RegisterStartupScript(Me.TabContainer1, Me.GetType, "fbo_view_map_script", "initialize_view_mapWithCenter(" + orig_lat.ToString + ", " + orig_long.ToString + ",'airport_map_label');add_location_view_marker('" + localCriteria.ViewCriteriaAirportName.Trim + "'," + orig_lat.ToString + ", " + orig_long.ToString + ", -1, '', viewMapFBO);" + vbCrLf, True)

            this_section_string = ""
            Call airport_fbo_functions.get_nearby_airports_top_function(searchCriteria, this_section_string, temp_distance, orig_lat, orig_long, Trim(Request("bus_type")), aport_id, Me.controlled.Checked, UpdateProgress1)
            Me.view_description_label.Text = this_section_string

        Catch ex As Exception

        End Try


    End Sub

    Sub search_reg_clicked(ByVal sender As Object, ByVal e As System.EventArgs) Handles search_reg.Click
        Dim temp_link As String = ""
        Dim temp_reg As String = ""
        Dim exact_match_reg As String = "N"
        Dim dont_search_prev_reg As String = "N"
        Dim airport_fbo_functions As New airport_fbo_view_functions
        Dim atemptable As New DataTable
        Dim htmlOut As New StringBuilder
        Dim toggleRowColor As Boolean = False


        Try

            airport_fbo_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            airport_fbo_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            airport_fbo_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            airport_fbo_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            airport_fbo_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim


            If Me.exact_match_reg.Checked = True Then
                exact_match_reg = "Y"
            Else
                exact_match_reg = "N"
            End If

            If Me.dont_search_prev_reg.Checked = True Then
                dont_search_prev_reg = "Y"
            Else
                dont_search_prev_reg = "N"
            End If

            temp_reg = Me.reg_search.Text.ToString
            temp_reg = Trim(temp_reg)

            Me.view_description_label.Text = ""
            If Trim(temp_reg) <> "" Then
                atemptable = airport_fbo_functions.get_ac_reg_searched(temp_reg, exact_match_reg, dont_search_prev_reg)


                htmlOut.Append("<table id=""fractionsExpiringInnerTable"" width=""100%"" cellpadding=""2"" cellspacing=""0"">")

                htmlOut.Append("<tr><td colspan=""2"" class=""rightside"" valign=""top"">")
                htmlOut.Append("<div style=""height: 250px; overflow: auto;"">")

                htmlOut.Append("<table id=""fractionsExpiringDataTable"" width=""100%"" cellpadding=""4"" cellspacing=""0"">")
                htmlOut.Append("<tr><td valign=""top"" align=""left"" class=""seperator"" width=""80%""><strong>Aircraft for Search '" & temp_reg & "'&nbsp;</strong></td>")
                htmlOut.Append("</tr>")

                If Not IsNothing(atemptable) Then
                    If atemptable.Rows.Count > 0 Then



                        For Each r As DataRow In atemptable.Rows

                            If Not toggleRowColor Then
                                htmlOut.Append("<tr class=""alt_row"">")
                                toggleRowColor = True
                            Else
                                htmlOut.Append("<tr bgcolor=""white"">")
                                toggleRowColor = False
                            End If
                            htmlOut.Append("<td align=""left"" valign=""top"" class=""seperator"">")
                            htmlOut.Append("" & r.Item("Make").ToString & " ")
                            htmlOut.Append("" & r.Item("Model").ToString & " ")
                            htmlOut.Append(", S#: ")
                            htmlOut.Append("<a class='underline' onclick='javascript:load(""DisplayAircraftDetail.aspx?acid=" + r.Item("ACId").ToString + "&jid=0"","""",""scrollbars=yes,menubar=no,height=900,width=1150,resizable=yes,toolbar=no,location=no,status=no"");' title='Display Aircraft Details'>")
                            htmlOut.Append("" & r.Item("SerNbr").ToString & "</a> ")
                            htmlOut.Append(", R#: " & r.Item("RegNbr").ToString & " ")
                            htmlOut.Append("</td>")

                            htmlOut.Append("</tr>")

                        Next


                    Else
                        htmlOut.Append("<tr class=""alt_row"">")
                        htmlOut.Append("<td align=""left"" valign=""top"" class=""seperator"">No Aircraft Found Matching: '" & temp_reg & "'")
                        htmlOut.Append("</td>")
                        htmlOut.Append("</tr>")
                    End If
                Else
                    htmlOut.Append("<tr class=""alt_row"">")
                    htmlOut.Append("<td align=""left"" valign=""top"" class=""seperator"">No Aircraft Found Matching: '" & temp_reg & "'")
                    htmlOut.Append("</td>")
                    htmlOut.Append("</tr>")
                End If
            End If


            htmlOut.Append("</table>")
            htmlOut.Append("</div>")
            htmlOut.Append("</td></tr></table>")

            Me.view_flights_label.Text = htmlOut.ToString

        Catch ex As Exception

        End Try

    End Sub

    Private Sub change_large_graph_clicked(ByVal sender As Object, ByVal e As System.EventArgs) Handles change_large_graph.Click
        Dim temp_link As String = ""

        temp_link &= "View_Template.aspx?ViewID=19&ViewName=&noteID=" & Trim(Request("noteID")) & "&activetab=1&graph=Y"

        If Me.show_asking.Checked = True Then
            temp_link &= "&show_asking=Y"
        Else
            temp_link &= "&show_asking=N"
        End If

        If Me.show_take.Checked = True Then
            temp_link &= "&show_take=Y"
        Else
            temp_link &= "&show_take=N"
        End If

        If Me.show_estimated.Checked = True Then
            temp_link &= "&show_estimated=Y"
        Else
            temp_link &= "&show_estimated=N"
        End If

        If Me.show_my.Checked = True Then
            temp_link &= "&show_my=Y"
        Else
            temp_link &= "&show_my=N"
        End If


        Response.Redirect(temp_link)


    End Sub

    Private Sub run_comparable_insert_clicked(ByVal sender As Object, ByVal e As System.EventArgs) Handles run_comparable_insert.Click
        Dim chart_htmlString As String = ""
        Dim rest_of_ac_string As String = ""
        Dim make_name As String = ""
        Dim model_name As String = ""
        Dim temp_amod_id As Long = 0
        Dim real_ac_id As Long = 0

        If run_comparable_insert.Visible = True Then
            If View_ID = 19 Then
                Call run_compare_view_items("", 1, False, Trim(Request("noteID")), real_ac_id, make_name, model_name, temp_amod_id, rest_of_ac_string, chart_htmlString, 0, True)
            End If
        End If

        System.Web.UI.ScriptManager.RegisterStartupScript(Me.model_summary_update_panel, Me.GetType(), "MarketSnapshotCreated", "alert(""Market Snapshot Created."");document.getElementById(""" & divComparableTab.ClientID & """).className = ""display_none"";document.getElementById(""" & displayDisable.ClientID & """).className = """";", True)

    End Sub

    Private Sub cancel_comparable_clicked(ByVal sender As Object, ByVal e As System.EventArgs) Handles cancel_comparable.Click

        Dim query_string As String = ""
        Dim NOTE_ID As Long = 0
        Dim sold_current As String = ""
        Dim type_of As String = ""

        Try




            If Trim(Request("note_id")) <> "" Then
                NOTE_ID = Trim(Request("note_id"))
            Else
                If Trim(Request("noteID")) <> "" Then
                    NOTE_ID = Trim(Request("noteID"))
                Else
                    NOTE_ID = 2
                End If
            End If

            If Trim(Request("sold_current")) <> "" Then
                sold_current = Trim(Request("sold_current"))
            Else
                sold_current = "F"
            End If

            If Trim(Request("type_of")) <> "" Then
                type_of = Trim(Request("type_of"))
            Else
                type_of = "add"
            End If



        Catch ex As Exception
        Finally
        End Try

        If Trim(Request("compare_ac_id")) <> "" Then
            If Trim(sold_current) = "F" Then
                Response.Redirect("view_template.aspx?ViewID=19&ViewName=Market Value Analysis&extra=false&noteID=" & NOTE_ID & "&activetab=1")
            Else
                Response.Redirect("view_template.aspx?ViewID=19&ViewName=Market Value Analysis&extra=false&noteID=" & NOTE_ID & "&activetab=5")
            End If
        Else
            Response.Redirect("view_template.aspx?ViewID=19&ViewName=Market Value Analysis&extra=false&noteID=" & NOTE_ID & "")
        End If

    End Sub

    Private Sub update_check1_clicked(ByVal sender As Object, ByVal e As System.EventArgs) Handles update_check1.Click

        Dim note_id As Long = 0
        Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
        Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
        Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
        Dim update_string As String = ""

        note_id = Trim(Request("noteID"))

        If Trim(note_id) <> "" Then
            If CDbl(note_id) > 0 Then


                Try

                    MySqlConn.ConnectionString = Application.Item("crmClientDatabase")
                    MySqlConn.Open()
                    MySqlCommand.Connection = MySqlConn
                    MySqlCommand.CommandType = CommandType.Text
                    MySqlCommand.CommandTimeout = 60

                    update_string = "update local_notes set  "
                    update_string &= " lnote_value_sold_time = " & Me.year_month_settings.SelectedValue

                    update_string &= ", lnote_value_show_estimates = '"

                    If Me.estimated_value.Checked = True Then
                        update_string &= "Y'"
                    Else
                        update_string &= "N'"
                    End If

                    update_string &= ", lnote_value_used_ac_only  = '"

                    If Me.used_of_used.Checked = True Then
                        update_string &= "Y'"
                    Else
                        update_string &= "N'"
                    End If


                    update_string &= ", lnote_value_filter_years = " & Me.years_of.SelectedValue
                    update_string &= ", lnote_value_filter_aftt = " & Me.sales_within.SelectedValue
                    update_string &= ", lnote_value_use_jetnet = '"

                    If Me.use_jetnet_data.Checked = True Then
                        update_string &= "Y'"
                    Else
                        update_string &= "N'"
                    End If


                    update_string &= " where lnote_id = '" & note_id & "' limit 1"
                    MySqlCommand.CommandText = update_string
                    MySqlCommand.ExecuteNonQuery()
                    HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />Update_Check1 (" & Date.Now & ")</b><br />" + update_string.ToString

                Catch ex As Exception

                Finally

                    MySqlConn.Dispose()
                    MySqlConn.Close()
                    MySqlConn = Nothing

                    MySqlCommand.Dispose()
                    MySqlCommand = Nothing
                End Try
            End If
        End If


        Response.Redirect("view_template.aspx?ViewID=19&ViewName=Market Value Analysis&extra=false&noteID=" & Trim(Request("noteID")) & "")

    End Sub

    Private Sub change_comparable_clicked(ByVal sender As Object, ByVal e As System.EventArgs) Handles change_comparable.Click

        Call clicked_comparable_or_re_entered(True)

    End Sub

    Public Sub clicked_comparable_or_re_entered(ByVal is_clicked As Boolean)

        Dim query_string As String = ""
        Dim NOTE_ID As Long = 0
        Dim sold_current As String = ""
        Dim type_of As String = ""
        Dim SqlConn As New MySql.Data.MySqlClient.MySqlConnection
        Dim SqlCommand As New MySql.Data.MySqlClient.MySqlCommand
        Dim SqlException As MySql.Data.MySqlClient.MySqlException : SqlException = Nothing
        Dim trans_id As Long = 0
        Dim real_next_order As Integer = 99
        Dim array_field_add(5) As String
        Dim FIELD_ID As Long = 0
        Dim FIELD_NAME As String = ""
        Dim FIELD_DB_NAME As String = ""
        Dim FIELD_TRANS_DB_NAME As String = ""
        Dim FIELD_CLOSED_DB_NAME As String = ""
        Dim jac_id As String = ""
        Dim temp_val As String = ""
        Dim page_changed As Boolean = False
        Dim temp_label As String = ""
        Dim chart_htmlString As String = ""
        Dim rest_of_ac_string As String = ""
        Dim make_name As String = ""
        Dim model_name As String = ""
        Dim temp_amod_id As Long = 0
        Dim real_ac_id As Long = 0

        Dim activetab As Integer = 0
        Dim temp_table2 As New DataTable
        Dim google_map_array_list As String = ""
        Dim COMPLETED_OR_OPEN As String = "O"
        Dim selected_changed As Boolean = False
        Dim results_label_to_display As String = ""


        If Trim(Request("jac_id")) <> "" Then
            jac_id = Trim(Request("jac_id"))
        Else
            jac_id = "0"
        End If

        If Trim(Request("note_id")) <> "" Then
            NOTE_ID = Trim(Request("note_id"))
        Else
            If Trim(Request("noteID")) <> "" Then
                NOTE_ID = Trim(Request("noteID"))
            Else
                NOTE_ID = 2
            End If
        End If

        If Trim(Request("sold_current")) <> "" Then
            sold_current = Trim(Request("sold_current"))
        Else
            sold_current = "F"
        End If

        If Trim(Request("type_of")) <> "" Then
            type_of = Trim(Request("type_of"))
        Else
            type_of = "add"
        End If

        If Trim(Request("trans_id")) <> "" Then
            trans_id = Trim(CDbl(Request("trans_id")))
        Else
            trans_id = 0
        End If





        If Trim(Request("ac_type")) = "JETNET" And Trim(Request("direct")) = "Y" Then
            ' CREATE CLIENT RECORD 
            ' GET CLIENT ID TO PUT INTO RECORDS
            If Trim(sold_current) = "F" Then

                If Trim(Request("compare_ac_id")) = "" Or Trim(Request("compare_ac_id")) = "0" Then
                    Response.Redirect("/edit.aspx?action=edit&type=aircraft&ac_ID=" & jac_id & "&source=JETNET&from=view&viewNOTEID=" & NOTE_ID & "&activetab=1&ac_type=JETNET&created_client=Y&auto_ac=true")
                Else
                    Response.Redirect("/edit.aspx?action=edit&type=aircraft&acID=" & Trim(Request("compare_ac_id")) & "&source=CLIENT&from=view&viewNOTEID=" & NOTE_ID & "&activetab=1&ac_type=JETNET&created_client=Y&auto_ac=true")
                End If
            Else
                'Response.Redirect("/edit.aspx?action=edit&type=aircraft&ac_ID=" & Trim(Request("compare_ac_id")) & "&source=JETNET&from=view&viewNOTEID=" & NOTE_ID & "&activetab=6&ac_type=JETNET&created_client=Y&auto_ac=true")

                If Trim(Request("compare_ac_id")) = "" Or Trim(Request("compare_ac_id")) = "0" Then
                    Response.Redirect("/edit.aspx?action=edit&type=transaction&trans=" & trans_id & "&acID=" & jac_id & "&compare_ac_id=" & Trim(Request("compare_ac_id")) & "&from=view&source=JETNET&viewNOTEID=" & NOTE_ID & "&activetab=5&ac_type=JETNET&jac_id=" & Trim(Request("jac_id")) & "&sold_current=" & Trim(sold_current) & "&created_client=Y&auto_trans=true")
                Else
                    Response.Redirect("/edit.aspx?action=edit&type=transaction&trans=" & trans_id & "&acID=" & Trim(Request("compare_ac_id")) & "&compare_ac_id=" & Trim(Request("compare_ac_id")) & "&from=view&source=JETNET&viewNOTEID=" & NOTE_ID & "&activetab=5&ac_type=JETNET&jac_id=" & Trim(Request("jac_id")) & "&sold_current=" & Trim(sold_current) & "&created_client=Y&auto_trans=true")
                End If

            End If

        Else


            Try
                HttpContext.Current.Session.Item("jetnetServerNotesDatabase") = Application.Item("crmClientDatabase")


                If (Trim(Request("compare_ac_id")) <> "" Or Trim(Request("jac_id")) <> "") And is_clicked = True Then


                    If Trim(type_of) = "add" Then
                        ' INSERT THE RECORD----------------------------
                        query_string = " insert into client_value_comparables "
                        query_string &= " (clival_note_id,clival_type, clival_client_ac_id, clival_clitrans_id, clival_ac_type, clival_jetnet_ac_id) "

                        If Trim(Request("compare_ac_id")) = "0" Or Trim(Request("compare_ac_id")) = "" Then
                            query_string &= " values (" & NOTE_ID & ",'S',0," & trans_id & ",'C', " & jac_id & ")"
                        ElseIf Trim(sold_current) = "F" Then
                            query_string &= " values (" & NOTE_ID & ",'F'," & Trim(Request("compare_ac_id")) & ",0,'C', " & jac_id & ")"
                        Else
                            query_string &= " values (" & NOTE_ID & ",'S'," & Trim(Request("compare_ac_id")) & "," & trans_id & ",'C', " & jac_id & ")"
                        End If
                        ' INSERT THE RECORD----------------------------
                    Else
                        ' DELETE THE RECORD----------------------------
                        If Trim(Request("compare_ac_id")) = "0" Or Trim(Request("compare_ac_id")) = "" Then
                            query_string = " delete from client_value_comparables where clival_note_id = " & NOTE_ID & " and clival_type='S' and clival_jetnet_ac_id = " & jac_id & " "
                        ElseIf Trim(sold_current) = "F" Then
                            query_string = " delete from client_value_comparables where clival_note_id = " & NOTE_ID & " and clival_type='F' and clival_client_ac_id = " & Trim(Request("compare_ac_id")) & " "
                        Else
                            query_string = " delete from client_value_comparables where clival_note_id = " & NOTE_ID & " and clival_type='S' and clival_client_ac_id = " & Trim(Request("compare_ac_id")) & " "
                        End If
                        ' DELETE THE RECORD----------------------------
                    End If


                Else


                End If


                If NOTE_ID > 0 And Trim(query_string) <> "" Then
                    SqlConn.ConnectionString = Application.Item("crmClientDatabase")
                    SqlConn.Open()
                    SqlCommand.Connection = SqlConn

                    SqlCommand.CommandText = query_string
                    SqlCommand.ExecuteNonQuery()

                    'HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />Clicked_Comparable_Or_Re_Entered (" & Date.Now & ")</b><br />" + query_string.ToString
                    clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, query_string.ToString)

                End If


            Catch ex As Exception
            Finally
                SqlCommand.Dispose()
                SqlConn.Close()
                SqlConn.Dispose()
            End Try

            If Trim(Request("compare_ac_id")) <> "" And is_clicked = True Then

                If Trim(Request("from_spot")) <> "" Then
                    TabContainer1.ActiveTabIndex = Trim(Request("from_spot"))
                    Call run_compare_view_items(results_label_to_display, Trim(Request("from_spot")), selected_changed, Trim(Request("noteID")), real_ac_id, make_name, model_name, temp_amod_id, rest_of_ac_string, chart_htmlString, 0, False)

                Else
                    If Trim(sold_current) = "F" Then
                        TabContainer1.ActiveTabIndex = 1
                        Call run_compare_view_items(results_label_to_display, 1, selected_changed, Trim(Request("noteID")), real_ac_id, make_name, model_name, temp_amod_id, rest_of_ac_string, chart_htmlString, 0, False)

                    Else
                        TabContainer1.ActiveTabIndex = 5
                        Call run_compare_view_items(results_label_to_display, 5, selected_changed, Trim(Request("noteID")), real_ac_id, make_name, model_name, temp_amod_id, rest_of_ac_string, chart_htmlString, 0, False)

                    End If
                End If


            Else


                Call run_compare_view_items(results_label_to_display, TabContainer1.ActiveTabIndex, selected_changed, Trim(Request("noteID")), real_ac_id, make_name, model_name, temp_amod_id, rest_of_ac_string, chart_htmlString, 0, False)


            End If




        End If


    End Sub

    Public Sub fill_compare_tabs(ByVal type_of As String, ByVal view_items_array As Array, ByVal name_fields As Array, ByVal field_array_count As Integer, ByVal select_string As String)

        Dim Tab As New Table
        Dim TR As New TableRow
        Dim TD As New TableCell
        Dim k_row As Integer = 0
        Dim the_row As Integer = 0
        Dim textbox1 As New TextBox

        Tab = New Table
        Tab.CellPadding = 3
        Tab.CellSpacing = 0
        Tab.BorderWidth = 1
        Tab.BorderColor = Drawing.Color.Black
        Tab.ID = "table_start" & type_of
        Tab.Visible = True

        TR = New TableRow
        TR.ID = "header_row" & type_of
        TR.Visible = True
        TR.ForeColor = Drawing.Color.White

        TD = New TableCell
        TD.ID = "col_compare" & type_of
        TD.Visible = True
        TD.BackColor = Drawing.Color.Gray
        TD.Text = "Comparing"

        TR.Controls.Add(TD)





        If field_array_count > 0 Then
            TD = New TableCell
            TD.ID = "col_my" & type_of
            TD.Visible = True
            TD.BackColor = Drawing.Color.Gray
            TD.Text = "My Aircraft"
            TR.Controls.Add(TD)

            For i = 1 To field_array_count - 1
                TD = New TableCell
                TD.ID = "col_" & i & type_of
                TD.Visible = True
                TD.BackColor = Drawing.Color.Gray
                TD.Text = "Comparable " & (i) & ""

                TR.Controls.Add(TD)
            Next
            Tab.Controls.Add(TR)
        End If

        If field_array_count > 0 Then


            For i = 0 To field_array_count - 1

                TR = New TableRow
                TR.ID = "row_" & k_row.ToString & type_of
                TR.Visible = True


                TD = New TableCell
                TD.ID = "colx" & i & type_of
                TD.Visible = True
                TR.ForeColor = Drawing.Color.White

                TD.Text = TD.Text & name_fields(i)

                TD.BackColor = Drawing.Color.Gray
                TR.Controls.Add(TD)

                '---------------------------------------------------------- 
                For k = 0 To field_array_count - 1

                    TD = New TableCell
                    TD.ID = "col" & i & "_" & k & type_of
                    TD.Visible = True

                    textbox1 = New TextBox
                    textbox1.Font.Size = 9

                    textbox1.ID = view_items_array(i) & "_" & k & type_of
                    textbox1.Text = view_items_array(i) & "_" & k


                    TD.Controls.Add(textbox1)

                    TR.Controls.Add(TD)
                Next
                '----------------------------------------------------------  


                Tab.Controls.Add(TR)


                k_row = k_row + 1
            Next

        End If



        TR = New TableRow
        TR.ID = "row_" & k_row.ToString & type_of
        TR.Visible = True

        TD = New TableCell
        TD.ID = "col_final_blank" & type_of
        TD.Visible = True
        TD.Text = " "

        TR.Controls.Add(TD)


        For k = 1 To 10
            TD = New TableCell
            TD.ID = "col_final_" & k & type_of
            TD.Visible = True


            TR.Controls.Add(TD)
        Next

        Tab.Controls.Add(TR)

        If Trim(type_of) = "" Then
            for_sale_tab.Controls.AddAt(0, Tab)
        Else
            retail_tab.Controls.AddAt(0, Tab)
        End If





    End Sub

    Public Sub load_google_chart_all(ByVal tab_to_add_to As AjaxControlToolkit.TabPanel, ByVal string_from_charts As String)
        Dim GoogleChart1TabScript As StringBuilder = New StringBuilder()

        Dim temp_string As String = ""
        Dim label_script As New Label
        Dim chart_label As New Label
        '    google.charts.setOnLoadCallback(
        'Function() { // Anonymous function that calls drawChart1 And drawChart2
        '     drawChart1();
        '     drawChart2();
        '  });
        'If Not Page.IsPostBack Then
        temp_string = "google.charts.setOnLoadCallback(" & vbNewLine
            temp_string &= "function() {" & vbNewLine
        'End If

        temp_string &= "drawChartsAll();" & vbNewLine


        temp_string &= "function drawChartsAll() {" & vbNewLine

        temp_string &= string_from_charts

        temp_string &= " }; " & vbNewLine

        'If Not Page.IsPostBack Then
        temp_string &= "}); " & vbNewLine
        'End If

        label_script.ID = "label_script"
        label_script.Text = temp_string


        'tab_to_add_to.Controls.AddAt(0, label_script)


        If Not Page.ClientScript.IsClientScriptBlockRegistered("GoogleChartAllTab") Then
            GoogleChart1TabScript.Append(temp_string)

            System.Web.UI.ScriptManager.RegisterStartupScript(Me.bottom_tab_update_panel, Me.GetType(), "GoogleChartAllTab", GoogleChart1TabScript.ToString, True)
        End If


    End Sub

    Public Sub turn_on_off_tabs_compare_view(ByVal note_id As Long)
        '----------------- TURN OFF / ON TABS------------------------------------------
        Dim added_link As String = ""

        Me.aircraft_image.Visible = False
        Me.model_reports_tab.Visible = True

        Me.crm_info.Visible = False


        Me.model_market_status_tab.Visible = False
        Me.model_fleet_tab.Visible = False
        Me.model_performance_tab.Visible = False
        Me.model_operating_costs_tab.Visible = False
        Me.model_description_tab.Visible = False
        Me.model_flight_tab.Visible = False

        Me.event_tab.Visible = True
        Me.news_tab.Visible = True
        Me.wanted_tab.Visible = True
        Me.documents_tab.Visible = True
        Me.operators_tab.Visible = True
        Me.charter_tab.Visible = True

        spi_tab.Visible = True

        ' top tabs

        ' bottom tabs
        Me.retail_tab.Visible = True

        Me.trends_tab.HeaderText = "My Value History"     ' tab 0 
        Me.for_sale_tab.HeaderText = "Market Survey"     ' tab 1
        Me.retail_tab.HeaderText = "Market Comparables"     ' tab 2 
        Me.event_tab.HeaderText = "Market Status"     ' tab 3 
        Me.news_tab.HeaderText = "Market Trends"     ' tab 4 
        Me.wanted_tab.HeaderText = "Sold Survey"     ' tab 5 
        Me.documents_tab.HeaderText = "Sold Comparables"     ' tab 6 
        Me.operators_tab.HeaderText = "Sold Trends"     ' tab 7
        Me.charter_tab.HeaderText = "Analytics"     ' tab 8 
        Me.lease_tab.HeaderText = "Edit Comparables"     ' tab 9 
        Me.spi_tab.HeaderText = "Value Estimates"  ' tab 10 


        Me.evo_view_help.Text = ""

        Me.market_check.Visible = True

        Me.fractional_tab.Visible = False
        Me.lease_tab.Visible = False
        Me.location_tab.Visible = False
        Me.star_tab.Visible = False
        Me.range_tab.Visible = False





        Me.actions_dropdown.Visible = False
        Me.actions_submenu_dropdown.Visible = False

        'get_make_model_info(localCriteria)

        Me.TabContainer1.Visible = True
        Me.tabs_container.Visible = True

        Me.loaded_visibility.Visible = True
        Me.loaded_visibility1.Visible = False



        divLoading.Visible = False
        loaded_visibility.CssClass = "display_block"

        add_ChangeTopActiveTab_Script(tabs_container)



        ' grey line
        Me.parent_toggle.Visible = True
        Me.evo_view_help.Visible = True
        Me.PanelCollapseEx.CollapsedText = ""

        Me.buttons.Visible = False

        If CRMViewActive Then
            If Not Page.IsPostBack Then
                If View_ID = 19 Then
                    If Not IsNothing(Session.Item("year_month_settings")) Then
                        If Not String.IsNullOrEmpty(Session.Item("year_month_settings")) Then
                            Try
                                year_month_settings.SelectedValue = Session.Item("year_month_settings")
                            Catch ex As Exception
                                year_month_settings.SelectedValue = 18
                            End Try
                        End If
                    End If
                End If
            End If
        End If

        Me.close_window_only.Visible = True
        '   Me.close_window_only.Text = "<a target='_new' href='print_spec.aspx?ac_id=" & localCriteria.ViewCriteriaAircraftID.ToString & "&noteid=" & Note_ID.ToString & "' class='pdf_button'>PDF</a>"
        If COMPLETED_OR_OPEN <> "C" Then

            added_link = ""
            added_link &= "&sales_within_years=" & Me.years_of.SelectedValue
            added_link &= "&timeframe=" & Me.year_month_settings.SelectedValue
            added_link &= "&sales_within_Aftt=" & Me.sales_within.SelectedValue

            If Me.used_of_used.Checked = True Then
                added_link &= "&use_only_used=Y"
            Else
                added_link &= "&use_only_used=N"
            End If

            If Me.use_jetnet_data.Checked = True Then
                added_link &= "&use_jetnet_data=Y"
            Else
                added_link &= "&use_jetnet_data=N"
            End If

            added_link &= "&current_aftt=" & Me.aftt_of_current.Text

            If Me.check_include_internals2.Checked = True Then
                added_link &= "&internal_flag=Y"
            Else
                added_link &= "&internal_flag=N"
            End If

            If Me.check_retail_sales2.Checked = True Then
                added_link &= "&retail_flag=Y"
            Else
                added_link &= "&retail_flag=N"
            End If

            If RunModelOnValueOnly Then
                added_link &= "&amod_ID=" & localCriteria.ViewCriteriaAmodID
            End If



            Me.close_window_only.Text = "<a href='#' onclick=""window.open('/print_spec.aspx?ac_id=" & Session.Item("CLIENT_AC_ID") & "&type=client&noteid=" & note_id.ToString & added_link & "','viewAnalysis','scrollbars=yes,menubar=no,height=900,width=1030,resizable=yes,toolbar=no,location=no,status=no');return false;""  class='pdf_button'>PDF</a>"
        Else
            Me.close_window_only.Text = "<a href='#' onclick=""window.open('/tempfiles/" & note_id.ToString & "_COMPLETED_VALUE_ANALYSIS_FULL_PDF.pdf','viewAnalysis','scrollbars=yes,menubar=no,height=900,width=1030,resizable=yes,toolbar=no,location=no,status=no');return false;""  class='pdf_button'>PDF</a>"
        End If

        'Me.close_window_only.Text += ("<a class='underline cursor' onclick=""javascript:window.close();return false;"" class=""close_button"">Close Window</a>")




        Me.ControlImage.Visible = False
        Me.crm_view_view_all.Visible = False



        PanelCollapseEx.Collapsed = True
        PanelCollapseEx.ClientState = "True"

        If RunModelOnValueOnly = False Then
            Me.model_reports_tab.HeaderText = "Selection: " & TabContainer1.ActiveTab.HeaderText.ToString
        Else
            If Not Page.IsPostBack Then
                Me.model_reports_tab.HeaderText = "Selection: Market Survey"
            End If
        End If
    End Sub

#End Region

    Private Sub submit_date_change_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles submit_date_change.Click
        BuildSliderDateJavascript()
    End Sub

    Private Sub year_month_settings_SelectedIndexChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles year_month_settings.SelectedIndexChanged
        Session.Item("year_month_settings") = year_month_settings.SelectedValue
    End Sub

    Private Sub makeModelDynamic_SelectedIndexChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles makeModelDynamic.SelectedIndexChanged
        If Not String.IsNullOrEmpty(makeModelDynamic.SelectedValue) Then
            Dim ModelData As Array = Split(makeModelDynamic.SelectedValue, "|")
            If UBound(ModelData) = 3 Then
                ' Response.Redirect("/view_template.aspx?ViewID=" & localCriteria.ViewID & "&amod_id=" & HttpContext.Current.Session.Item("tabAircraftModel").ToString)
                localCriteria.ViewCriteriaAmodID = CLng(ModelData(3))

                Session.Item("viewAircraftModel") = commonEvo.FindIndexForItemByAmodID(CLng(ModelData(3)).ToString)
                Session.Item("viewAircraftMake") = commonEvo.FindIndexForFirstItem(UCase(ModelData(2)), crmWebClient.Constants.AIRFRAME_MAKE)
                Response.Redirect("/view_template.aspx?ViewID=" & localCriteria.ViewID & "&amod_id=" & CLng(ModelData(3)).ToString, True)
            End If
        End If
    End Sub

    Private Sub goSearchAirports_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles goSearchAirports.Click
        Dim searchSession As New SearchSelectionCriteria
        If Not IsNothing(HttpContext.Current.Session.Item("searchCriteria")) Then
            searchSession = HttpContext.Current.Session.Item("searchCriteria")
        End If

        searchSession.SearchViewCriteriaAirportCodes = airportIATABoxSearch.Text
        searchSession.SearchViewCriteriaOperatorDropdown = airportOperatorType.SelectedValue
        searchSession.SearchViewCriteriaOperatorFolderName = airportOperatorFolder.SelectedItem.Text
        searchSession.SearchViewCriteriaRegList = aircraftRegNumberView.Text
        searchSession.SearchViewCriteriaAircraftDropdown = airportAircraftType.SelectedValue

        searchSession.SearchViewCriteriaAircraftFolderName = airportAircraftFolder.SelectedItem.Text
        searchSession.SearchViewCriteriaAircraftDropdown2 = IIf(IsNumeric(airportAircraftFolder.SelectedValue), airportAircraftFolder.SelectedValue, 0)

        searchSession.SearchViewCriteriaStartDate = airportViewStartDate.Text
        searchSession.SearchViewCriteriaEndDate = airportViewEndDate.Text

        searchSession.SearchViewCriteriaBasedOn = searchBasedOnDropdown.SelectedValue
        searchSession.SearchViewCriteriaOperatorDropdown2 = IIf(IsNumeric(airportOperatorFolder.SelectedValue), airportOperatorFolder.SelectedValue, 0)
        searchSession.SearchViewCriteriaOperatorExcludeFolder = airportOperatorExclude.Checked
        searchSession.SearchViewCriteriaAirportExcludeFolder = excludeAircraftFolders.Checked
        searchSession.SearchViewCriteriaAircraftExcludeFolder = airportAircraftExclude.Checked
        searchSession.SearchViewCriteriaAirportDropdown = selectAirportsType.SelectedValue
        searchSession.SearchViewCriteriaAirportSelected = selectAirportID.Text
        searchSession.SearchViewCriteriaOperatorSelected = selectOperatorID.Text
        searchSession.SearchViewCriteriaAirportFolderName = searchAirportFolder.SelectedItem.Text
        searchSession.SearchViewCriteriaAirportDropdown2 = IIf(IsNumeric(searchAirportFolder.SelectedValue), searchAirportFolder.SelectedValue, 0)
        HttpContext.Current.Session.Item("searchCriteria") = searchSession


        bottom_tab_update_panel.Update()
        UpdatePanel_top_left.Update()
        top_tab_update_panel.Update()
        UpdatePanel1.Update()
    End Sub

    Private Sub airport_overview_type_SelectedIndexChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles airport_overview_type.SelectedIndexChanged
        bottom_tab_update_panel.Update()
        UpdatePanel_top_left.Update()
    End Sub

    Private Sub clearAirportCriteria_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles clearAirportCriteria.Click
        HttpContext.Current.Session.Item("searchCriteria").SearchViewCriteriaStartDate = ""
        HttpContext.Current.Session.Item("searchCriteria").SearchViewCriteriaEndDate = ""
        HttpContext.Current.Session.Item("searchCriteria").SearchViewCriteriaOperatorDropdown = 0
        HttpContext.Current.Session.Item("searchCriteria").SearchViewCriteriaOperatorFolderName = ""
        HttpContext.Current.Session.Item("searchCriteria").SearchViewCriteriaOperatorExcludeFolder = False
        HttpContext.Current.Session.Item("searchCriteria").SearchViewCriteriaOperatorDropdown2 = 0
        HttpContext.Current.Session.Item("searchCriteria").SearchViewCriteriaAirportExcludeFolder = False
        HttpContext.Current.Session.Item("searchCriteria").SearchViewCriteriaAircraftExcludeFolder = False
        HttpContext.Current.Session.Item("searchCriteria").SearchViewCriteriaAirportDropdown = 0


        HttpContext.Current.Session.Item("searchCriteria").SearchViewCriteriaRegList = ""
        HttpContext.Current.Session.Item("searchCriteria").SearchViewCriteriaAirportCodes = ""

        If IsNumeric(clearAirportCriteria.CssClass) Then
            HttpContext.Current.Session.Item("searchCriteria").SearchViewCriteriaAirportSelected = clearAirportCriteria.CssClass
            Session("Last_Aport_ID") = clearAirportCriteria.CssClass
        Else
            HttpContext.Current.Session.Item("searchCriteria").SearchViewCriteriaAirportSelected = 0
            Session("Last_Aport_ID") = 0
        End If

        HttpContext.Current.Session.Item("searchCriteria").SearchViewCriteriaOperatorSelected = 0
        HttpContext.Current.Session.Item("searchCriteria").SearchViewCriteriaAirportFolderName = ""
        HttpContext.Current.Session.Item("searchCriteria").SearchViewCriteriaAirportDropdown2 = 0
        HttpContext.Current.Session.Item("searchCriteria").SearchViewCriteriaAircraftDropdown = 0
        HttpContext.Current.Session.Item("searchCriteria").SearchViewCriteriaAircraftFolderName = ""
        HttpContext.Current.Session.Item("searchCriteria").SearchViewCriteriaAircraftDropdown2 = 0
        HttpContext.Current.Session.Item("searchCriteria").SearchViewCriteriaBasedOn = "D"
        HttpContext.Current.Session.Item("searchCriteria").SearchViewCriteriaClearAirport = False
        HttpContext.Current.Session.Item("searchCriteria").SearchViewCriteriaClearCompany = False



        HttpContext.Current.Session.Item("hasModelFilter") = False
        HttpContext.Current.Session.Item("hasHelicopterFilter") = False
        HttpContext.Current.Session.Item("hasBusinessFilter") = False
        HttpContext.Current.Session.Item("hasCommercialFilter") = False

        HttpContext.Current.Session.Item("viewAircraftModel") = ""
        HttpContext.Current.Session.Item("viewAircraftMake") = ""
        HttpContext.Current.Session.Item("viewAircraftType") = ""


        Response.Redirect("/view_template.aspx?ViewID=28&noMaster=false&ViewName=Fuel Utilization View") '&" & IIf(clearAirportCriteria.CssClass.ToString <> "0", "aport_id=" & clearAirportCriteria.CssClass.ToString, "") & "&comp_id=0")
    End Sub

    'Private Sub preownedSales_Only_CheckedChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles preownedSales_Only.CheckedChanged
    '  used_of_used.Checked = preownedSales_Only.Checked
    '  on_click_load_bottom(localCriteria)
    'End Sub


    Private Sub BuildEstimates(ByVal ToWriteOn As Label, ByVal aclsData_Temp As clsData_Manager_SQL)
        Dim GraphTable As New DataTable
        Dim ExtraCriteriaString As String = ""
        Dim MapString As String = ""
        Dim DisplayDate As String = ""
        Dim DisplayDesc As String = ""
        ExtraCriteriaString = " AND clival_entry_date >= '" & (Year(DateAdd(DateInterval.Month, -localCriteria.ViewCriteriaTimeSpan, Date.Now)) & "-" & Month(DateAdd(DateInterval.Month, -localCriteria.ViewCriteriaTimeSpan, Date.Now)) & "-" & Day(DateAdd(DateInterval.Month, -localCriteria.ViewCriteriaTimeSpan, Date.Now))) & "' "

        If localCriteria.ViewCriteriaAircraftID > 0 Then
            GraphTable = localDatalayer.get_my_ac_value_history_comparables(0, "est_value", True, localCriteria.ViewCriteriaAircraftID, 0, COMPLETED_OR_OPEN, False, localCriteria.ViewCriteriaAmodID, ExtraCriteriaString)
        Else
            GraphTable = crmViewDataLayer.GetEstimates(0, "est_value", True, localCriteria.ViewCriteriaAircraftID, 0, COMPLETED_OR_OPEN, False, localCriteria, ExtraCriteriaString)
        End If
        ToWriteOn.Text = "<span id=""ValueEstimateNewContents""><table id=""ValueEstimateCopy"" cellspacing='0' cellpadding='3' border='1' class='engine' width=""100%"">"
        ToWriteOn.Text &= "<thead><tr>"
        ToWriteOn.Text &= "<th>SEL</th>"
        ToWriteOn.Text &= "<th>ID</th>"
        ToWriteOn.Text &= "<th><b>Date</b</th>"
        ToWriteOn.Text &= "<th><b>Type</b></th>"
        ToWriteOn.Text &= "<th><b>Make/Model</b></th>"
        ToWriteOn.Text &= "<th><b>Ser #</b></th>"
        ToWriteOn.Text &= "<th><b>Reg #</b></th>"
        ToWriteOn.Text &= "<th><b>Year MFR</b></th>"

        ToWriteOn.Text &= "<th><b>Asking($k)</b></th>"
        ToWriteOn.Text &= "<th><b>Take($k)</b></th>"
        ToWriteOn.Text &= "<th><b>Est Value($k)</b></th>"
        ToWriteOn.Text &= "<th><b>AFTT</b></th>"
        ToWriteOn.Text &= "<th><b>Total Landings</b></th>"
        ToWriteOn.Text &= "</thead></tr>"
        ToWriteOn.Text &= "<tbody>"


        If Not IsNothing(GraphTable) Then
            If GraphTable.Rows.Count > 0 Then
                MapString += "   drawEstChart();"
                MapString += "function drawEstChart() {"
                MapString &= "var dataEst = new google.visualization.DataTable();"


                MapString &= " dataEst.addColumn('string', 'Date'); "
                MapString &= " dataEst.addColumn('number', 'Asking'); "
                MapString &= " dataEst.addColumn('number', 'Take'); "
                MapString &= " dataEst.addColumn('number', 'Est Value'); "

                MapString &= "dataEst.addRows(["
                Dim mapStringMiddle As String = ""
                For Each r As DataRow In GraphTable.Rows
                    Dim dateSort As String = ""

                    If mapStringMiddle <> "" Then
                        mapStringMiddle = "" 'clear since it's already been added
                        mapStringMiddle = ","
                    End If
                    mapStringMiddle &= "['"
                    If Not IsDBNull(r("date_of")) Then
                        DisplayDate = FormatDateTime(r("date_of"), DateFormat.ShortDate)
                        dateSort = Format(r("date_of"), "yyyy/MM/dd")
                        mapStringMiddle += DisplayDate & " - "
                    End If

                    If Not IsDBNull(r("description")) Then
                        DisplayDesc = Trim(r("description"))

                        If Trim(DisplayDesc) = "F" Then
                            DisplayDesc = "Full Appraisal"
                        ElseIf Trim(DisplayDesc) = "D" Then
                            DisplayDesc = "Desktop Appraisal"
                        ElseIf Trim(DisplayDesc) = "V" Then
                            DisplayDesc = "VREF"
                        ElseIf Trim(DisplayDesc) = "B" Then
                            DisplayDesc = "Blue Book"
                        ElseIf Trim(DisplayDesc) = "H" Then
                            DisplayDesc = "HeliValue$"
                        End If
                    End If

                    ToWriteOn.Text &= "<tr>"
                    ToWriteOn.Text &= "<td align='left'>&nbsp;</td>"
                    ToWriteOn.Text &= "<td align='left'>" & r("clival_id") & "</td>"
                    ToWriteOn.Text &= "<td align='left' data-sort='" & dateSort & "'>" & DisplayDate & "</td>"
                    ToWriteOn.Text &= "<td align='left'>" & DisplayDesc & "</td>"

                    If Not IsDBNull(r("ac_id")) Then
                        Dim TemporaryAircraftTable As New DataTable
                        DisplayDesc &= " - " & get_ac_details_from_jetnet_for_graph(r("ac_id"))
                        mapStringMiddle += DisplayDesc
                        TemporaryAircraftTable = aclsData_Temp.GetJETNET_AC_NAME(r("ac_id"), "")

                        If Not IsNothing(TemporaryAircraftTable) Then
                            If TemporaryAircraftTable.Rows.Count > 0 Then
                                'Make
                                ToWriteOn.Text &= "<td align='left'>"
                                If Not IsDBNull(TemporaryAircraftTable.Rows(0).Item("amod_make_name")) Then
                                    ToWriteOn.Text &= TemporaryAircraftTable.Rows(0).Item("amod_make_name").ToString
                                End If
                                'Model
                                If Not IsDBNull(TemporaryAircraftTable.Rows(0).Item("amod_model_name")) Then
                                    ToWriteOn.Text &= " " & TemporaryAircraftTable.Rows(0).Item("amod_model_name").ToString
                                End If
                                ToWriteOn.Text &= "</td>"
                                'Ser
                                ToWriteOn.Text &= "<td align='left'>"
                                If Not IsDBNull(TemporaryAircraftTable.Rows(0).Item("ac_ser_nbr")) Then
                                    ToWriteOn.Text &= TemporaryAircraftTable.Rows(0).Item("ac_ser_nbr").ToString
                                End If
                                ToWriteOn.Text &= "</td>"
                                'Reg
                                ToWriteOn.Text &= "<td align='left'>"
                                If Not IsDBNull(TemporaryAircraftTable.Rows(0).Item("ac_reg_nbr")) Then
                                    ToWriteOn.Text &= TemporaryAircraftTable.Rows(0).Item("ac_reg_nbr").ToString
                                End If
                                ToWriteOn.Text &= "</td>"
                                'Year
                                ToWriteOn.Text &= "<td align='left'>"
                                If Not IsDBNull(TemporaryAircraftTable.Rows(0).Item("ac_year_mfr")) Then
                                    ToWriteOn.Text &= TemporaryAircraftTable.Rows(0).Item("ac_year_mfr").ToString
                                End If
                                ToWriteOn.Text &= "</td>"
                            End If
                        End If
                        TemporaryAircraftTable.Dispose()
                    Else
                        ToWriteOn.Text &= "<td align='left'>&nbsp;</td>"
                    End If
                    mapStringMiddle &= "',"

                    If Not IsDBNull(r("asking_price")) Then
                        If CInt(r("asking_price")) > 0 Then
                            mapStringMiddle += (r("asking_price") / 1000) & ","
                            ToWriteOn.Text &= "<td align='right'>$" & FormatNumber((r("asking_price") / 1000), 0) & "k</td>"
                        Else
                            mapStringMiddle += "null,"
                            ToWriteOn.Text &= "<td align='left'>&nbsp;</td>"
                        End If
                    Else
                        mapStringMiddle += "null,"
                        ToWriteOn.Text &= "<td align='left'>&nbsp;</td>"
                    End If


                    If Not IsDBNull(r("take_price")) Then
                        If CInt(r("take_price")) > 0 Then
                            mapStringMiddle += (r("take_price") / 1000) & ","
                            ToWriteOn.Text &= "<td align='right'>$" & FormatNumber((r("take_price") / 1000), 0) & "k</td>"
                        Else
                            mapStringMiddle += "null,"
                            ToWriteOn.Text &= "<td align='left'>&nbsp;</td>"
                        End If
                    Else
                        mapStringMiddle += "null,"
                        ToWriteOn.Text &= "<td align='left'>&nbsp;</td>"
                    End If


                    If Not IsDBNull(r("sold_price")) Then
                        If CInt(r("sold_price")) > 0 Then
                            mapStringMiddle += (r("sold_price") / 1000) & ""
                            ToWriteOn.Text &= "<td align='right'>$" & FormatNumber((r("sold_price") / 1000), 0) & "k</td>"
                        Else
                            mapStringMiddle += "null"
                            ToWriteOn.Text &= "<td align='left'>&nbsp;</td>"
                        End If
                    Else
                        mapStringMiddle += "null"
                        ToWriteOn.Text &= "<td align='left'>&nbsp;</td>"
                    End If

                    If Not IsDBNull(r("clival_aftt_hours")) Then
                        If r("clival_aftt_hours") > 0 Then
                            ToWriteOn.Text &= "<td align='right'>" & FormatNumber(r("clival_aftt_hours"), 0) & "</td>"
                        Else
                            ToWriteOn.Text &= "<td align='left'>&nbsp;</td>"
                        End If
                    Else
                        ToWriteOn.Text &= "<td align='left'>&nbsp;</td>"
                    End If

                    If Not IsDBNull(r("clival_total_landings")) Then
                        If r("clival_total_landings") > 0 Then
                            ToWriteOn.Text &= "<td align='right'>" & FormatNumber(r("clival_total_landings"), 0) & "</td>"
                        Else
                            ToWriteOn.Text &= "<td align='left'>&nbsp;</td>"
                        End If
                    Else
                        ToWriteOn.Text &= "<td align='left'>&nbsp;</td>"
                    End If

                    ToWriteOn.Text &= "</tr>"


                    mapStringMiddle &= "]"
                    MapString &= mapStringMiddle

                Next
                MapString &= "]);"

                MapString += "var estOptions = {'title':'','width':560,'height':230,legend: { position: 'right', textStyle:{fontSize:'11'}},curveType:  'function',colors: ['blue', 'red', 'green','blue', 'red', 'green'], 'chartArea': {top:5}, hAxis: { textStyle:{fontSize:'9'}, slantedText:true, slantedTextAngle:70},vAxis: { title: 'Estimates Value ($k)'} , series: {    0: { lineWidth: 0, pointSize: 3  } ,  1: { lineWidth: 0, pointSize: 3  } ,  2: { lineWidth: 0, pointSize: 3  } ,  3: { lineWidth: 0, pointSize: 7,  pointShape: 'star', visibleInLegend: false  } ,  4: { lineWidth: 0, pointSize: 7,  pointShape: 'star', visibleInLegend: false  } ,  5: { lineWidth: 0, pointSize: 7,  pointShape: 'star', visibleInLegend: false  }  } };"
                MapString += "var estChart = new google.visualization.LineChart(document.getElementById('valChart'));"
                MapString += "estChart.draw(dataEst, estOptions);"
                MapString += "}"
                System.Web.UI.ScriptManager.RegisterStartupScript(Me.top_tab_update_panel, Me.GetType, "refreshEstGraphs", "" & MapString & ";", True)


            Else
                market_values_top_tab.Visible = False
                market_values_top_tab.HeaderText = "Market Values"
                tabs_container.ActiveTab = model_market_status_tab
            End If
        Else
            market_values_top_tab.Visible = False
            market_values_top_tab.HeaderText = "Market Values"
            tabs_container.ActiveTab = model_market_status_tab
        End If

        ToWriteOn.Text &= "</tbody>"
        ToWriteOn.Text &= "</table>"
        ToWriteOn.Text &= "</span><div id=""ValueEstimateInnerTable"" style=""width: 960px;""></div>"
        'ToWriteOn.Text = MapString
        Dim AdditionalScripts As String = ""
        AdditionalScripts = "$("".openButtonVis"").addClass('display_none');"
        AdditionalScripts += "$("".KeepSelected"").addClass('display_none');"

        ValueEstimateJSCheck(False, False, AdditionalScripts)

    End Sub

    Private Sub includeVariants_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles includeVariants.Click
        If Not Page.ClientScript.IsClientScriptBlockRegistered("ResetCursor") Then
            System.Web.UI.ScriptManager.RegisterClientScriptBlock(Me.bottom_tab_update_panel, Me.GetType(), "ResetCursorVar", ";ChangeTheMouseCursorOnItemParentDocument('cursor_default standalone_page" & IIf(Session.Item("isMobile"), " lowerLevel", "") & "')", True)
        End If

        bottom_tab_update_panel.Update()
    End Sub

    Private Sub crmProspectSearchButton_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles crmProspectSearchButton.Click
        If crmProspectAircraftID.Text = 0 Then
            Dim atemptable As New DataTable

            Dim crmTestMaster As New main_site

            Dim strBuild As New StringBuilder
            Dim exportProspect As Boolean = crmProspectSearchExport.Checked
            Dim ProspectStatus As String = ""
            crmProspectSearchExport.Checked = False
            crmTestMaster.aclsData_Temp.JETNET_DB = Session.Item("jetnetClientDatabase")
            crmTestMaster.aclsData_Temp.client_DB = Session.Item("jetnetServerNotesDatabase")

            Dim searchString As String = crmProspectSearchText.Text
            Dim startDate As String = ""
            Dim endDate As String = ""
            If crmProspectSearchTextWhere.SelectedValue = "1" Then
                searchString = "%" & searchString & "%"
            Else
                searchString = searchString & "%"
            End If

            If crmProspectSearchIncludeInactive.Checked Then
                ProspectStatus = "I"
            End If
            If crmProspectSearchIncludeActive.Checked Then
                If ProspectStatus <> "" Then
                    ProspectStatus += "','"
                End If
                ProspectStatus += "A','O"
            End If
            If crmProspectSearchIncludeClosed.Checked Then
                If ProspectStatus <> "" Then
                    ProspectStatus += "','C"
                Else
                    ProspectStatus += "C"
                End If
            End If
            If Not String.IsNullOrEmpty(crmProspectSearchStartDate.Text) Then
                If IsDate(crmProspectSearchStartDate.Text) Then
                    startDate = Year(crmProspectSearchStartDate.Text) & "-" & Month(crmProspectSearchStartDate.Text) & "-" & Day(crmProspectSearchStartDate.Text)
                End If
            End If
            If Not String.IsNullOrEmpty(crmProspectSearchEndDate.Text) Then
                If IsDate(crmProspectSearchEndDate.Text) Then
                    endDate = Year(crmProspectSearchEndDate.Text) & "-" & Month(crmProspectSearchEndDate.Text) & "-" & Day(crmProspectSearchEndDate.Text)
                End If
            End If

            Dim crmProspectActionTakenString As String = ""
            crmProspectActionTakenString = clsGeneral.clsGeneral.ExtractSelectedStringFromListboxDropdown(crmProspectActionTakenList, True, 0, False)

            Dim crmSource_prospect As String = ""
            crmSource_prospect = clsGeneral.clsGeneral.ExtractSelectedStringFromListboxDropdown(source_listbox, True, 0, False)

            Dim crmReferrel As String = ""
            crmReferrel = clsGeneral.clsGeneral.ExtractSelectedStringFromListboxDropdown(referrer_drop, True, 0, False)


            Dim active_closed_inactive As String = ""
            If crmProspectSearchIncludeActive.Checked = True Then
                If Trim(active_closed_inactive) <> "" Then
                    active_closed_inactive &= ","
                End If
                active_closed_inactive &= "'Active'"
            End If

            If crmProspectSearchIncludeInactive.Checked = True Then
                If Trim(active_closed_inactive) <> "" Then
                    active_closed_inactive &= ","
                End If
                active_closed_inactive &= "'Inactive'"
            End If

            If crmProspectSearchIncludeClosed.Checked = True Then
                If Trim(active_closed_inactive) <> "" Then
                    active_closed_inactive &= ","
                End If
                active_closed_inactive &= "'Closed'"
            End If







            If Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.HOMEBASE Or Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CUSTOMER_CENTER Then
                If Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CUSTOMER_CENTER Then
                    'Update close window link.
                    close_window_only.Text = "<a href=""javascript:void(0);"" onclick=""javascript:window.opener.location = '/adminHome.aspx';self.close();"">CLOSE</a>"
                End If
                atemptable = crmTestMaster.aclsData_Temp.Notes_Search_For_Prospect_View_Homebase(searchString, startDate, endDate, "B','O", crmProspectSearchCategory.SelectedValue, "", "", crmProspectSearchUserDropdown.Text, ProspectStatus, "", "", 0, 0, "", IIf(crmProspectSearchTypeOfProspect.SelectedValue = 2, True, False), IIf(crmProspectSearchTypeOfProspect.SelectedValue = 1, True, False), active_closed_inactive, crmProspectActionTakenString, , 0, 0, crmSource_prospect, crmReferrel)
                Call run_prospector_guts_homebase(atemptable, strBuild, crmTestMaster)
            Else
                atemptable = crmTestMaster.aclsData_Temp.Notes_Search_For_Prospect_View(searchString, startDate, endDate, "B','O", crmProspectSearchCategory.SelectedValue, "", "", crmProspectSearchUserDropdown.SelectedValue, ProspectStatus, "", "", 0, 0, "", IIf(crmProspectSearchTypeOfProspect.SelectedValue = 2, True, False), IIf(crmProspectSearchTypeOfProspect.SelectedValue = 1, True, False), 3, crmProspectActionTakenString)
                Call run_prospector_guts(atemptable, strBuild, crmTestMaster)
            End If



            If exportProspect = True Then
                Session("export_info") = ConvertNotesTable(atemptable, crmTestMaster.aclsData_Temp)
                System.Web.UI.ScriptManager.RegisterStartupScript(Me, Me.GetType(), "export", "$('#" & crmProspectSearchExport.ClientID.ToString & "').prop('checked', false);window.open('export.aspx','_blank','width=400,height=400,toolbar=no,location=no, directories=no,status=no,menubar=no,scrollbars=no,resizable=no');", True)
            End If

            BuildProspectDataTable()
            strBuild.Append("</div>")
            crmProspectSearchLabel.Text = "<div class=""valueSpec Simplistic aircraftSpec""><div class=""Box remove_padding""><span class=""float_right padding"">" & atemptable.Rows.Count & " Records.&nbsp;&nbsp;</span><br />" & strBuild.ToString & "</div></div>"



        Else
            crmProspectSearchLabel.Text = ""
        End If
    End Sub
    Public Sub run_prospector_guts(ByRef atemptable As DataTable, ByRef strBuild As StringBuilder, ByVal crmTestMaster As main_site)


        crmProspectViewExportLink.Visible = False
        If Not IsNothing(atemptable) Then
            atemptable = crmTestMaster.aclsData_Temp.Notes_FillupSearch_WithoutClient(atemptable, IIf(UCase(crmProspectSearchOrder.SelectedValue) = "COMPANY", "comp_name, amod_make_name, amod_model_name, ac_ser_nbr", "amod_make_name, amod_model_name, ac_ser_nbr, comp_name"))
            strBuild.Append("<div class=""prospectDataTableContainer"">")

            If atemptable.Rows.Count > 0 Then
                ' crmProspectViewExportLink.Visible = True
                strBuild.Append("<table width=""100%"" cellpadding=""0"" cellspacing=""0"" id=""prospectTable"">")
                strBuild.Append("<thead><tr><!--<th>Edit Checkbox Placeholder</th>--><th valign=""top"" align=""left"">EDIT</th><th valign=""top"" align=""left"">Prospect</th><th valign=""top"" align=""left"">Category</th><th valign=""top"" align=""left"">Priority</th><th valign=""top"" align=""left"">Aircraft</th><th valign=""top"" align=""left"">Details</th><th valign=""top"" align=""left"">Assigned</th><th valign=""top"" align=""left"">Target Date</th><th valign=""top"" align=""left"">Next Action</th><th valign=""top"" align=""left"">Value</th><th valign=""top"" align=""left"">Value %</th></tr></thead>")
                strBuild.Append("<tbody>")
                For Each r As DataRow In atemptable.Rows
                    strBuild.Append("<tr class=""" & r("lnote_opportunity_status") & "-statusColor""><!--<td>Edit Checkbox Placeholder</td>-->")

                    strBuild.Append("<td valign=""top"" align=""left""><img src=""/images/edit_icon.png"" alt=""Edit"" class=""cursor"" onclick=""javascript:load('/edit_note.aspx?ViewID=18&refreshing=prospect&action=edit&type=prospect&id=" & r("lnote_id").ToString & "','unloaded_me','scrollbars=yes,menubar=no,height=435,width=860,resizable=yes,toolbar=no,location=no,status=no');"" /></td>")
                    strBuild.Append("<td valign=""top"" align=""left"">")
                    If Not IsDBNull(r("comp_id")) Then
                        If Not IsDBNull(r("comp_name")) Then
                            strBuild.Append(DisplayFunctions.WriteDetailsLink(0, r("comp_id"), 0, 0, True, r("comp_name"), "emphasisColor", "&source=" & r("comp_source")))
                        End If

                        strBuild.Append(IIf(Not IsDBNull(r("comp_address1")), "<br />" & r("comp_address1") & " ", ""))
                        strBuild.Append("<br />")
                        strBuild.Append(IIf(Not IsDBNull(r("comp_city")), r("comp_city") & ", ", ""))
                        strBuild.Append(IIf(Not IsDBNull(r("comp_state")), r("comp_state") & " ", ""))
                        strBuild.Append(IIf(Not IsDBNull(r("comp_country")), r("comp_country") & " ", ""))
                        strBuild.Append(r("comp_zip_code").ToString)
                    End If

                    strBuild.Append("</td>")
                    strBuild.Append("<td valign=""top"" align=""left"">")

                    'Dim CatTable As DataTable = crmTestMaster.aclsData_Temp.Get_Opportunity_Categories_ID(r("lnote_notecat_key"))
                    'If Not IsNothing(CatTable) Then
                    '  If CatTable.Rows.Count > 0 Then
                    If Not IsDBNull(r("oppcat")) Then
                        strBuild.Append(UCase(r("oppcat")))
                    End If
                    '  End If
                    'End If

                    'CatTable.Dispose()

                    strBuild.Append("</td>")
                    strBuild.Append("<td valign=""top"" align=""left"">" & r("clipri_name").ToString)
                    strBuild.Append("</td>")
                    strBuild.Append("<td valign=""top"" align=""left"">")
                    If r("lnote_client_ac_id") > 0 Or r("lnote_jetnet_ac_id") > 0 Then
                        strBuild.Append(clsGeneral.clsGeneral.addACInfo(IIf(r("lnote_client_ac_id") > 0, r("lnote_client_ac_id"), r("lnote_jetnet_ac_id")), 2, IIf(r("lnote_client_ac_id") > 0, "CLIENT", "JETNET"), crmTestMaster.aclsData_Temp, crmProspectAircraftID, crmProspectViewAcSearchButton, r))
                    ElseIf r("lnote_client_ac_id") = 0 And r("lnote_jetnet_ac_id") = 0 Then
                        If r("lnote_client_amod_id") = 0 And r("lnote_jetnet_amod_id") = 0 Then
                            strBuild.Append("NOT SPECIFIED")
                        Else
                            strBuild.Append(r("amod_make_name") & " " & r("amod_model_name") & "<br />")
                        End If
                    End If
                    strBuild.Append("</td>")

                    strBuild.Append("<td valign=""top"" align=""left"">")

                    If Not IsDBNull(r("lnote_note")) Then
                        Dim lnoteString As String = r("lnote_note")
                        If InStr(r("lnote_note"), " ::: ") > 0 Then
                            Dim splNote As String() = Split(r("lnote_note"), " ::: ")
                            lnoteString = UCase(splNote(0)) & "<br /><br />"
                            lnoteString += "<p>" & splNote(1) & "</p>"
                        End If

                        strBuild.Append(lnoteString)
                    End If

                    strBuild.Append("</td>")
                    strBuild.Append("<td valign=""top"" align=""left"">")


                    'Dim UserTable As DataTable = crmTestMaster.aclsData_Temp.Get_Client_User(r("lnote_user_id"))

                    'If Not IsNothing(UserTable) Then
                    '  If UserTable.Rows.Count > 0 Then
                    If Not IsDBNull(r("cliuser_first_name")) Then
                        strBuild.Append(r("cliuser_first_name"))
                    End If
                    If Not IsDBNull(r("cliuser_last_name")) Then
                        strBuild.Append(" " & r("cliuser_last_name") & " ")
                    End If
                    '  End If
                    'End If


                    strBuild.Append("</td>")
                    If Not IsDBNull(r("lnote_schedule_start_date")) Then
                        strBuild.Append("<td valign=""top"" align=""left"" data-sort='" & Format(CDate(r("lnote_schedule_start_date")), "yyyy/MM/dd") & "'>" & clsGeneral.clsGeneral.TwoPlaceYear(r("lnote_schedule_start_date")))
                        strBuild.Append("</td>")
                    Else
                        strBuild.Append("<td valign=""top"" align=""left"" data-sort=''></td>")
                    End If

                    If Not IsDBNull(r("lnote_entry_date")) Then
                        strBuild.Append("<td valign=""top"" align=""left"" data-sort='" & Format(CDate(r("lnote_entry_date")), "yyyy/MM/dd") & "'>" & clsGeneral.clsGeneral.TwoPlaceYear(r("lnote_entry_date")))
                        strBuild.Append("</td>")
                    Else
                        strBuild.Append("<td valign=""top"" align=""left"" data-sort=''></td>")
                    End If

                    strBuild.Append("<td valign=""top"" align=""right"" class=""text_align_right"">")
                    If Not IsDBNull(r("lnote_cash_value")) Then
                        If r("lnote_cash_value") > 0 Then
                            strBuild.Append("$" & FormatNumber(r("lnote_cash_value"), 0))
                        End If
                    End If
                    strBuild.Append("</td><td valign=""top"" align=""right"" class=""text_align_right""")
                    If Not IsDBNull(r("lnote_capture_percentage")) Then
                        If r("lnote_capture_percentage") > 0 Then
                            strBuild.Append(" data-sort='" & r("lnote_capture_percentage").ToString & "'>" & r("lnote_capture_percentage").ToString)
                        Else
                            strBuild.Append(" data-sort='0'")
                        End If
                    Else
                        strBuild.Append(" data-sort='0'")
                    End If
                    strBuild.Append("</td>")

                    strBuild.Append("</tr>")
                Next
                strBuild.Append("</tbody>")
                strBuild.Append("</table>")

                'Build Opportunities Summary:
                Dim distinct_table_view As New DataView
                Dim distinct_table As New DataTable
                Dim totalAnswer As Long = 0
                Dim totalRated As Long = 0
                Dim totalCounted As Long = 0
                distinct_table_view = atemptable.DefaultView

                ''actually get the distinct values.
                distinct_table = distinct_table_view.ToTable(True, "lnote_notecat_key")
                If distinct_table.Rows.Count > 0 Then
                    strBuild.Append("<div class=""gray_background""><div class=""Box""><table width=""99%"" cellpadding=""0"" cellspacing=""0"" class=""formatTable blue"">")
                    strBuild.Append("<thead><tr><th align=""left"" valign=""top"">Category Name</th><th align=""left"" valign=""top"" width=""15"" class=""text_align_right"">Qty</th><th valign=""top"" class=""text_align_right"" width=""150"">Value</th><th valign=""top"" class=""text_align_right"" width=""150"">Rated Value</th></tr></thead>")
                    strBuild.Append("<tbody>")
                    For Each q As DataRow In distinct_table.Rows
                        'So let's loop through and add up the category max
                        'We need to take each category, filter the main table to get only those records, then max it

                        Dim FilterView As New DataView
                        Dim displayTable As New DataTable
                        FilterView = atemptable.DefaultView
                        FilterView.RowFilter = "lnote_notecat_key = " & q(0)

                        displayTable = FilterView.ToTable()
                        Dim maxAnswer As Long = 0 'Convert.ToInt64(IIf(Not IsDBNull(displayTable.Compute("max(lnote_cash_value)", String.Empty)), displayTable.Compute("max(lnote_cash_value)", String.Empty), 0))
                        Dim maxRated As Long = 0
                        For Each n As DataRow In displayTable.Rows
                            If Not IsDBNull(n("lnote_cash_value")) Then
                                maxAnswer += n("lnote_cash_value")
                                If Not IsDBNull(n("lnote_capture_percentage")) Then
                                    maxRated += n("lnote_cash_value") * (n("lnote_capture_percentage") / 100)
                                End If
                            End If

                        Next

                        ' If maxAnswer > 0 Then
                        strBuild.Append("<tr><td align=""left"" valign=""top"">")
                        Dim CatTable As DataTable = crmTestMaster.aclsData_Temp.Get_Opportunity_Categories_ID(q(0))
                        If Not IsNothing(CatTable) Then
                            If CatTable.Rows.Count > 0 Then
                                strBuild.Append(UCase(CatTable.Rows(0).Item("oppcat")))
                            Else
                                strBuild.Append("NO CATEGORY")
                            End If
                        End If
                        strBuild.Append("</td><td align=""left"" valign=""top"" class=""text_align_right"">" & displayTable.Rows.Count.ToString & "</td>")
                        strBuild.Append("<td align=""left"" valign=""top"" class=""text_align_right"">$")
                        strBuild.Append(FormatNumber(maxAnswer, 0))
                        strBuild.Append("</td><td align=""left"" valign=""top"" class=""text_align_right"">$")
                        strBuild.Append(FormatNumber(maxRated, 0))
                        strBuild.Append("</td></tr>")
                        totalAnswer += maxAnswer
                        totalRated += maxRated
                        totalCounted += displayTable.Rows.Count
                        'End If

                    Next
                    strBuild.Append("</tbody>")

                    strBuild.Append("<tfoot><tr><th align=""left"" valign=""top"">TOTALS:</th><th valign=""top""  class=""text_align_right"">" & totalCounted.ToString & "</th><th class=""text_align_right"" valign=""top"">$" & FormatNumber(totalAnswer, 0) & "</th><th class=""text_align_right"" valign=""top"">$" & FormatNumber(totalRated, 0) & "</th></tr></tfoot>")
                    strBuild.Append("</table></div></div>")
                End If
            Else

                strBuild.Append("<div class=""valueSpec Simplistic aircraftSpec""><div class=""gray_background""><div class=""Box""><table width=""100%"" cellpadding=""0"" cellspacing=""0"" class=""formatTable blue datagrid""><tr><td align=""left"" valign=""top"">No Applicable Results.</td></tr></table></div></div></div>")

            End If
        End If



    End Sub
    Public Sub run_prospector_guts_homebase(ByRef atemptable As DataTable, ByRef strBuild As StringBuilder, ByVal crmTestMaster As main_site)


        crmProspectViewExportLink.Visible = False
        search_by_label.Visible = False
        crmProspectSearchTypeOfProspect.Visible = False
        crmProspectSearchOrder.Visible = False
        search_for.Visible = False
        crmProspectSearchText.Visible = False
        crmProspectSearchExport.Visible = False
        crmProspectAircraftID.Visible = False
        crmProspectSearchTextWhere.Visible = False
        prospects_panel.Visible = False


        If Not IsNothing(atemptable) Then
            '  atemptable = crmTestMaster.aclsData_Temp.Notes_FillupSearch_WithoutClient(atemptable, IIf(UCase(crmProspectSearchOrder.SelectedValue) = "COMPANY", "comp_name, amod_make_name, amod_model_name, ac_ser_nbr", "amod_make_name, amod_model_name, ac_ser_nbr, comp_name"))
            strBuild.Append("<div class=""prospectDataTableContainer"">")

            If atemptable.Rows.Count > 0 Then

                '     comp_id, comp_name, comp_address1, comp_city, comp_state, comp_country, "
                '      sqlQuery = sqlQuery & " cprospect_service, cprospect_type, cprospect_details, "
                '      sqlQuery = sqlQuery & " cprospect_assigned_to, cprospect_target_date, cprospect_next_action_date, "
                '      sqlQuery = sqlQuery & " cprospect_value, cprospect_percent_win "


                ' crmProspectViewExportLink.Visible = True
                strBuild.Append("<table width=""100%"" cellpadding=""0"" cellspacing=""0"" id=""prospectTable"">")
                strBuild.Append("<thead><tr>")

                '  <th><!--checkbox placeholder--></th>
                strBuild.Append("<th valign= ""top"" align=""left""> </th><th valign=""top"" align=""left"">Prospect</th><th valign=""top"" align=""left"">Service</th><th valign=""top"" align=""left"">Stage</th><th valign=""top"" align=""left"">Details</th><th valign=""top"" align=""left"">Staff</br>(Referrer)</th><th valign=""top"" align=""left"">Start</br>Date</th><th valign=""top"" align=""left"">Target</br>/Close Date</th><th valign=""top"" align=""left"">Next</br>Action</th><th valign=""top"" align=""left"">BType</th><th valign=""top"" align=""left"">Value</th><th valign=""top"" align=""left"">%</th>")
                strBuild.Append("<th valign=""top"" align=""left"">JETNET</th>")
                strBuild.Append("<th valign=""top"" align=""left"">LASTNOTE</th>")
                strBuild.Append("<th valign=""top"" align=""left"">Source</th>")
                strBuild.Append("</tr></thead>")
                strBuild.Append("<tbody>")
                For Each r As DataRow In atemptable.Rows
                    ' strBuild.Append("<tr Class=""" & r("lnote_opportunity_status") & "-statusColor"">")
                    strBuild.Append("<tr Class=""-statusColor"">'")

                    '  strBuild.Append("<td><!--checkbox placeholder--></td>")

                    'strBuild.Append("<td valign= ""top"" align=""left""><img src=""/images/edit_icon.png"" alt=""Edit"" Class=""cursor"" onclick=""javascript:Load('/edit_note.aspx?ViewID=18&refreshing=prospect&action=edit&type=prospect&id=" & r("lnote_id").ToString & "','unloaded_me','scrollbars=yes,menubar=no,height=435,width=860,resizable=yes,toolbar=no,location=no,status=no');"" /></td>")
                    strBuild.Append("<td valign=""top"" align=""left""><img src=""/images/edit_icon.png"" alt=""Edit"" class=""cursor"" onclick=""javascript:load('/edit_note.aspx?ViewID=18&refreshing=prospect&action=edit&type=prospect&id=" & r("cprospect_id").ToString & "','unloaded_me','scrollbars=yes,menubar=no,height=435,width=860,resizable=yes,toolbar=no,location=no,status=no');"" /></td>")

                    strBuild.Append("<td valign=""top"" align=""left"">")
                    If Not IsDBNull(r("comp_id")) Then
                        If Not IsDBNull(r("comp_name")) Then
                            strBuild.Append(DisplayFunctions.WriteDetailsLink(0, r("comp_id"), 0, 0, True, r("comp_name"), "emphasisColor", ""))
                        End If

                        strBuild.Append(IIf(Not IsDBNull(r("comp_address1")), "<br />" & r("comp_address1") & " ", ""))
                        strBuild.Append("<br />")
                        strBuild.Append(IIf(Not IsDBNull(r("comp_city")), r("comp_city") & ", ", ""))
                        strBuild.Append(IIf(Not IsDBNull(r("comp_state")), r("comp_state") & " ", ""))
                        strBuild.Append(IIf(Not IsDBNull(r("comp_country")), r("comp_country") & " ", ""))
                        strBuild.Append(r("comp_zip_code").ToString)
                    End If

                    strBuild.Append("</td>")
                    strBuild.Append("<td valign=""top"" align=""left"">")

                    'Dim CatTable As DataTable = crmTestMaster.aclsData_Temp.Get_Opportunity_Categories_ID(r("lnote_notecat_key"))
                    'If Not IsNothing(CatTable) Then
                    '  If CatTable.Rows.Count > 0 Then
                    If Not IsDBNull(r("cprospect_service")) Then
                        strBuild.Append(UCase(Break_On_Spaces(r("cprospect_service"))))
                    End If
                    '  End If
                    'End If

                    'CatTable.Dispose()

                    strBuild.Append("</td>")
                    strBuild.Append("<td valign=""top"" align=""left"">")
                    If Not IsDBNull(r("cprospect_type")) Then
                        strBuild.Append(UCase(r("cprospect_type")))
                    End If
                    strBuild.Append("</td>")
                    strBuild.Append("<td valign=""top"" align=""left"">")

                    If Not IsDBNull(r("cprospect_details")) Then
                        Dim lnoteString As String = r("cprospect_details")
                        'If InStr(r("cprospect_details"), " ::: ") > 0 Then
                        '    Dim splNote As String() = Split(r("cprospect_details"), " ::: ")
                        '    lnoteString = UCase(splNote(0)) & "<br /><br />"
                        '    lnoteString += "<p>" & splNote(1) & "</p>"
                        'End If 
                        strBuild.Append(lnoteString)
                    End If

                    strBuild.Append("</td>")
                    strBuild.Append("<td valign=""top"" align=""left"">")


                    'Dim UserTable As DataTable = crmTestMaster.aclsData_Temp.Get_Client_User(r("lnote_user_id"))

                    If Not IsDBNull(r("cprospect_user_id")) Then
                        strBuild.Append(clsGeneral.clsGeneral.FindCRMUser_Homebase(crmTestMaster, r("cprospect_user_id")))
                    End If

                    If Not IsDBNull(r("referrer")) Then
                        strBuild.Append(" (" & r("referrer") & ")")
                    End If

                    strBuild.Append("</td>")


                    If Not IsDBNull(r("cprospect_start_date")) Then
                        strBuild.Append("<td valign=""top"" align=""left"" data-sort='" & Format(CDate(r("cprospect_start_date")), "yyyy/MM/dd") & "'>" & clsGeneral.clsGeneral.TwoPlaceYear(r("cprospect_start_date")))
                        strBuild.Append("</td>")
                    Else
                        strBuild.Append("<td valign=""top"" align=""left"" data-sort=''></td>")
                    End If

                    If Not IsDBNull(r("cprospect_target_date")) Then
                        strBuild.Append("<td valign=""top"" align=""left"" data-sort='" & Format(CDate(r("cprospect_target_date")), "yyyy/MM/dd") & "'>" & clsGeneral.clsGeneral.TwoPlaceYear(r("cprospect_target_date")))
                        strBuild.Append("</td>")
                    Else
                        strBuild.Append("<td valign=""top"" align=""left"" data-sort=''></td>")
                    End If

                    If Not IsDBNull(r("cprospect_next_action_date")) Then

                        strBuild.Append("<td valign=""top"" align=""left"" data-sort='" & Format(CDate(r("cprospect_next_action_date")), "yyyy/MM/dd") & "'>")

                        If Not IsDBNull(r("cprospect_next_action")) Then
                            strBuild.Append("<a href='#' title='" & Left(Trim(r("cprospect_next_action")), 25) & "'  name='" & Left(Trim(r("cprospect_next_action")), 25) & "'  alt='" & Left(Trim(r("cprospect_next_action")), 25) & "'>")
                        End If

                        strBuild.Append("" & clsGeneral.clsGeneral.TwoPlaceYear(r("cprospect_next_action_date")))

                        If Not IsDBNull(r("cprospect_next_action")) Then
                            strBuild.Append("</a>")
                        End If
                        strBuild.Append("</td>")
                    Else
                        strBuild.Append("<td valign=""top"" align=""left"" data-sort=''></td>")
                    End If

                    ' added MSW - 12/10/19
                    strBuild.Append("<td valign=""top"" align=""left"">")
                    If Not IsDBNull(r("cbus_name")) Then
                        strBuild.Append(UCase(Break_On_Spaces(r("cbus_name"))))
                    End If
                    strBuild.Append("</td>")

                    strBuild.Append("<td valign=""top"" align=""right"" class=""text_align_right"">")
                    If Not IsDBNull(r("cprospect_value")) Then
                        If r("cprospect_value") > 0 Then
                            strBuild.Append("$" & FormatNumber(r("cprospect_value"), 0))
                        End If
                    End If
                    strBuild.Append("</td><td valign=""top"" align=""right"" class=""text_align_right""")
                    If Not IsDBNull(r("cprospect_percent_win")) Then
                        If r("cprospect_percent_win") > 0 Then
                            strBuild.Append(" data-sort='" & r("cprospect_percent_win").ToString & "'>" & r("cprospect_percent_win").ToString)
                        Else
                            strBuild.Append(" data-sort='0'")
                        End If
                    Else
                        strBuild.Append(" data-sort='0'")
                    End If
                    strBuild.Append("</td>")


                    strBuild.Append("<td valign=""top"" align=""left"">")
                    If Not IsDBNull(r("JETNET")) Then
                        strBuild.Append(UCase(r("JETNET")))
                    End If
                    strBuild.Append("</td>")

                    If Not IsDBNull(r("LASTNOTE")) Then

                        strBuild.Append("<td valign=""top"" align=""left"" data-sort='" & Format(CDate(r("LASTNOTE")), "yyyy/MM/dd") & "'>")

                        ' If Not IsDBNull(r("LASTNOTE_TEXT")) Then
                        '  strBuild.Append("<a href='#' title='" & Left(Trim(r("LASTNOTE_TEXT")), 25) & "'  name='" & Left(Trim(r("LASTNOTE_TEXT")), 25) & "'  alt='" & Left(Trim(r("LASTNOTE_TEXT")), 25) & "'>")
                        'End If

                        strBuild.Append("" & clsGeneral.clsGeneral.TwoPlaceYear(r("LASTNOTE")))

                        If Not IsDBNull(r("LASTNOTE_TEXT")) Then
                            strBuild.Append(" - " & Trim(r("LASTNOTE_TEXT")))
                        End If

                        '  If Not IsDBNull(r("LASTNOTE_TEXT")) Then
                        '  strBuild.Append("</a>")
                        'End If
                        strBuild.Append("</td>")
                    Else
                        strBuild.Append("<td valign=""top"" align=""left"" data-sort=''></td>")
                    End If


                    strBuild.Append("<td valign=""top"" align=""left"">")


                    If Not IsDBNull(r("cpsource_name")) Then
                        strBuild.Append(r("cpsource_name"))
                    End If

                    strBuild.Append("</td>")


                    strBuild.Append("</tr>")
                Next
                strBuild.Append("</tbody>")
                strBuild.Append("</table>")

                'Build Opportunities Summary:
                Dim distinct_table_view As New DataView
                Dim distinct_table As New DataTable
                Dim totalAnswer As Long = 0
                Dim totalRated As Long = 0
                Dim totalCounted As Long = 0
                distinct_table_view = atemptable.DefaultView

                ''actually get the distinct values.
                distinct_table = distinct_table_view.ToTable(True, "cprospect_type")
                If distinct_table.Rows.Count > 0 Then
                    strBuild.Append("<div class=""gray_background""><div class=""Box""><table width=""99%"" cellpadding=""0"" cellspacing=""0"" class=""formatTable blue"">")
                    strBuild.Append("<thead><tr><th align=""left"" valign=""top"">PROSPECT TYPE</th><th align=""left"" valign=""top"" width=""15"" class=""text_align_right"">Qty</th><th valign=""top"" class=""text_align_right"" width=""150"">Value</th><th valign=""top"" class=""text_align_right"" width=""150"">Rated Value</th></tr></thead>")
                    strBuild.Append("<tbody>")
                    For Each q As DataRow In distinct_table.Rows
                        'So let's loop through and add up the category max
                        'We need to take each category, filter the main table to get only those records, then max it

                        Dim FilterView As New DataView
                        Dim displayTable As New DataTable
                        FilterView = atemptable.DefaultView
                        FilterView.RowFilter = "cprospect_type = '" & q(0) & "' "

                        displayTable = FilterView.ToTable()
                        Dim maxAnswer As Long = 0 'Convert.ToInt64(IIf(Not IsDBNull(displayTable.Compute("max(lnote_cash_value)", String.Empty)), displayTable.Compute("max(lnote_cash_value)", String.Empty), 0))
                        Dim maxRated As Long = 0
                        For Each n As DataRow In displayTable.Rows
                            If Not IsDBNull(n("cprospect_value")) Then
                                maxAnswer += n("cprospect_value")
                                If Not IsDBNull(n("cprospect_percent_win")) Then
                                    maxRated += n("cprospect_value") * (n("cprospect_percent_win") / 100)
                                End If
                            End If

                        Next

                        ' If maxAnswer > 0 Then
                        strBuild.Append("<tr><td align=""left"" valign=""top"">")
                        strBuild.Append(q(0))
                        'Dim CatTable As DataTable = crmTestMaster.aclsData_Temp.Get_Opportunity_Categories_ID(q(0))
                        'If Not IsNothing(CatTable) Then
                        '    If CatTable.Rows.Count > 0 Then
                        '        strBuild.Append(UCase(CatTable.Rows(0).Item("cprospect_type")))
                        '    Else
                        '        strBuild.Append("NO CATEGORY")
                        '    End If
                        'End If
                        strBuild.Append("</td><td align=""left"" valign=""top"" class=""text_align_right"">" & displayTable.Rows.Count.ToString & "</td>")
                        strBuild.Append("<td align=""left"" valign=""top"" class=""text_align_right"">$")
                        strBuild.Append(FormatNumber(maxAnswer, 0))
                        strBuild.Append("</td><td align=""left"" valign=""top"" class=""text_align_right"">$")
                        strBuild.Append(FormatNumber(maxRated, 0))
                        strBuild.Append("</td></tr>")
                        totalAnswer += maxAnswer
                        totalRated += maxRated
                        totalCounted += displayTable.Rows.Count
                        'End If

                    Next
                    strBuild.Append("</tbody>")

                    strBuild.Append("<tfoot><tr><th align=""left"" valign=""top"">TOTALS:</th><th valign=""top""  class=""text_align_right"">" & totalCounted.ToString & "</th><th class=""text_align_right"" valign=""top"">$" & FormatNumber(totalAnswer, 0) & "</th><th class=""text_align_right"" valign=""top"">$" & FormatNumber(totalRated, 0) & "</th></tr></tfoot>")
                    strBuild.Append("</table></div></div>")
                End If
            Else

                strBuild.Append("<div class=""valueSpec Simplistic aircraftSpec""><div class=""gray_background""><div class=""Box""><table width=""100%"" cellpadding=""0"" cellspacing=""0"" class=""formatTable blue datagrid""><tr><td align=""left"" valign=""top"">No Applicable Results.</td></tr></table></div></div></div>")

            End If
        End If



    End Sub
    Public Function Break_On_Spaces(ByVal texttoedit As String) As String

        Break_On_Spaces = Trim(texttoedit)

        If InStr(Trim(Break_On_Spaces), " ") > 0 Then
            Break_On_Spaces = Replace(Break_On_Spaces, " ", "<br/>")
        End If

    End Function
    Private Sub BuildProspectDataTable(Optional ByRef tableClass As String = "", Optional ByRef postbackCheck As Boolean = False, Optional ByVal ActiveTabID As String = "")
        Dim scriptBu As String = ""
        Dim ExcelButton As String = ""

        If tableClass = "" Then
            CreateExcelButton(ExcelButton, "prospectTable")
        Else
            CreateExcelButton(ExcelButton, "" & ActiveTabID & "Table")
        End If

        scriptBu += "function BuildProspectTable() {"

        If ActiveTabID <> "" Then
            scriptBu += " if ($.fn.DataTable.isDataTable('#" & ActiveTabID & "Table' ) ) {"
            scriptBu += "$('#" & ActiveTabID & "InnerTable').empty();"
            scriptBu += "};"

            scriptBu += "if ( $(""#" & ActiveTabID & "Copy"").length ) {"
            scriptBu += "jQuery(""#" & ActiveTabID & "Copy"").css('display','block');"
            scriptBu += "var clone = jQuery(""#" & ActiveTabID & "Copy"").clone(true);"
            scriptBu += "jQuery(""#" & ActiveTabID & "Copy"").css('display','none');"

            scriptBu += "clone[0].setAttribute('id', '" & ActiveTabID & "Table');"
            scriptBu += "clone.appendTo(""#" & ActiveTabID & "InnerTable"");"
            scriptBu += "};"
        End If

        scriptBu += "var cw = $('.sixteen').width() - 40;"
        scriptBu += "$("".prospectDataTableContainer"").width(cw);"

        scriptBu += "$(window).resize(function() {"
        scriptBu += "var cw = $('.sixteen').width() - 40;"
        scriptBu += "$("".prospectDataTableContainer"").width(cw);"
        scriptBu += "});"


        If tableClass = "" Then
            scriptBu += "$('#prospectTable').DataTable({"
        Else
            scriptBu += "$('#" & ActiveTabID & "Table').DataTable({"
        End If
        scriptBu += " destroy: true,"
        scriptBu += " fixedHeader: true, "

        scriptBu += "scrollX: cw,"
        scriptBu += "scrollY: 430,"

        scriptBu += """initComplete"": function(settings, json) {"
        scriptBu += "setTimeout(function(){"
        scriptBu += "$('#prospectTable').DataTable().columns.adjust();"
        scriptBu += "$('#prospectTable').DataTable().fixedColumns().relayout();"
        scriptBu += "},1200)"
        scriptBu += "},"

        scriptBu += "scrollCollapse: true,"
        scriptBu += " stateSave: true,"
        scriptBu += "paging: false, "

        ' comment out here for checkbox now 
        'scriptBu += """columnDefs"": [ "
        'scriptBu += " {"
        'scriptBu += "orderable: false,"
        'scriptBu += "className:  'select-checkbox',"
        'scriptBu += " width: '10px',"
        'scriptBu += "targets:   0"
        'scriptBu += " }"
        'scriptBu += " ],"

        scriptBu += "dom: 'Bfitrp',"

        'scriptBu += "order: [[ 0, 'asc' ]],"

        'scriptBu += "select: {"
        'scriptBu += "style:    'multi',"
        'scriptBu += "selector: 'td:first-child',"
        'scriptBu += "},"

        scriptBu += "buttons: [ "

        If Session.Item("localUser").crmDemoUserFlag = True Then
            scriptBu += " {extend: 'csv', enabled: false, exportOptions : {columns: ':visible'}}, "
        Else
            scriptBu += " {extend: 'csv', exportOptions : {columns: ':visible'}}, "
        End If


        'Excel Button
        scriptBu += ExcelButton
        'PDF Button
        If Session.Item("localUser").crmDemoUserFlag = True Then
            scriptBu += " {extend: 'pdf', enabled: false, orientation: 'landscape', pageSize: 'A2', exportOptions : {columns: ':visible'}}, "
        Else
            scriptBu += " {extend: 'pdf', orientation: 'landscape', pageSize: 'A2', exportOptions : {columns: ':visible'}}, "
        End If


        'Column Visibility Button
        scriptBu += "{"
        scriptBu += "extend: 'colvis',"
        scriptBu += " text: 'Columns',"
        scriptBu += "collectionLayout:  'fixed two-column',"
        scriptBu += "postfixButtons: [ 'colvisRestore' ]"
        scriptBu += "},"

        If ActiveTabID <> "" Then
            scriptBu += ",{ text:'Remove Selected', "
            scriptBu += " action: function( e, dt, node, config) { dt.rows( { selected: true } ).remove().draw( false );}},"
            scriptBu += "{ text:'Keep Selected', "
            scriptBu += " action: function( e, dt, node, config) { dt.rows( { selected: false } ).remove().draw( false );dt.draw();dt.rows('.selected').deselect();}},"

            scriptBu += "{ text:'Reload Table', action: function( e, dt, node, config) { $('#" & ActiveTabID & "Table').empty();BuildProspectTable();}}"
        End If


        scriptBu += "] "

        scriptBu += " });"
        scriptBu += "$($.fn.dataTable.tables(true)).DataTable().columns.adjust();"
        scriptBu += "$($.fn.dataTable.tables(true)).DataTable().scroller.measure();"
        scriptBu += "};BuildProspectTable();"



        If postbackCheck = False Then
            System.Web.UI.ScriptManager.RegisterStartupScript(Me, Me.GetType(), "CreateDatatableProspect", scriptBu.ToString, True)
        Else
            If Not Page.IsPostBack Then
                System.Web.UI.ScriptManager.RegisterStartupScript(Me, Me.GetType, "datatableString", " $(function() {" & scriptBu.ToString & "} );", True)
            Else
                System.Web.UI.ScriptManager.RegisterClientScriptBlock(Me.bottom_tab_update_panel, Me.GetType, "datatableStringPost", scriptBu.ToString, True)
            End If
        End If


    End Sub
    Private Sub crmProspectViewAcSearchButton_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles crmProspectViewAcSearchButton.Click
        crmProspectSearchLabel.Text = ""
        crmProspectViewExportLink.Visible = False
    End Sub

    Private Sub crmProspectSearchClearButton_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles crmProspectSearchClearButton.Click
        Response.Redirect("/view_template.aspx?ViewID=18&ViewName=Prospect+Management&noMaster=false")
    End Sub
    Public Shared Function ConvertNotesTable(ByVal dt As DataTable, ByVal aclsDataTemp As clsData_Manager_SQL) As String
        Dim html As New StringBuilder
        html.Append("<table id='flighttable' class=""formatTable blue""  style=""width:100%"">")
        html.Append("<thead>")
        html.Append("<tr>")

        html.Append("<th>Entry Date</th>")
        html.Append("<th>Action Date</th>")
        html.Append("<th>Start Date</th>")
        html.Append("<th>User</th>")
        html.Append("<th>Category</th>")
        html.Append("<th>OPERATOR</th>")
        html.Append("<th>ADDRESS</th>")
        html.Append("<th>CITY</th>")
        html.Append("<th>STATE</th>")
        html.Append("<th>COUNTRY</th>")
        html.Append("<th>ZIP CODE</th>")
        html.Append("<th>EMAIL</th>")
        html.Append("<th>OFFICE PHONE</th>")
        html.Append("<th>FAX</th>")
        html.Append("<th>MAKE</th>")
        html.Append("<th>MODEL</th>")
        html.Append("<th>MFR YEAR</th>")
        html.Append("<th>SERNBR</th>")
        html.Append("<th>REGNBR</th>")
        html.Append("<th>Date Purchased</th>")
        html.Append("<th>AC Status</th>")
        html.Append("<th>Asking Price</th>")
        html.Append("<th>Take Price</th>")
        html.Append("<th>Value</th>")
        html.Append("<th>%</th>")
        html.Append("<th>Title</th>")
        html.Append("<th>Description</th>")
        html.Append("</tr>")
        html.Append("</thead>")
        html.Append("<tbody>")
        For Each r As DataRow In dt.Rows
            html.Append("<tr>")

            html.Append("<td>")
            If Not IsDBNull(r("lnote_entry_date")) Then
                html.Append(FormatDateTime(r("lnote_entry_date"), DateFormat.ShortDate))
            End If
            html.Append("</td>")

            html.Append("<td>")
            If Not IsDBNull(r("lnote_action_date")) Then
                html.Append(FormatDateTime(r("lnote_action_date"), DateFormat.ShortDate))
            End If
            html.Append("</td>")


            html.Append("<td>")
            If Not IsDBNull(r("lnote_schedule_start_date")) Then
                html.Append(FormatDateTime(r("lnote_schedule_start_date"), DateFormat.ShortDate))
            End If
            html.Append("</td>")

            html.Append("<td>")
            If Not IsDBNull(r("lnote_user_name")) Then
                html.Append(r("lnote_user_name"))
            End If
            html.Append("</td>")
            html.Append("<td>")
            Dim CatTable As DataTable = aclsDataTemp.Get_Opportunity_Categories_ID(r("lnote_notecat_key"))
            If Not IsNothing(CatTable) Then
                If CatTable.Rows.Count > 0 Then
                    html.Append(UCase(CatTable.Rows(0).Item("oppcat")))
                End If
            End If

            CatTable.Dispose()
            html.Append("</td>")

            html.Append("<td>")
            If Not IsDBNull(r("comp_name")) Then
                html.Append(r("comp_name"))
            End If
            html.Append("</td>")

            html.Append("<td>")
            If Not IsDBNull(r("comp_address1")) Then
                html.Append(r("comp_address1"))
            End If
            html.Append("</td>")
            html.Append("<td>")
            If Not IsDBNull(r("comp_city")) Then
                html.Append(r("comp_city"))
            End If
            html.Append("</td>")
            html.Append("<td>")
            If Not IsDBNull(r("comp_state")) Then
                html.Append(r("comp_state"))
            End If
            html.Append("</td>")
            html.Append("<td>")
            If Not IsDBNull(r("comp_country")) Then
                html.Append(r("comp_country"))
            End If
            html.Append("</td>")
            html.Append("<td>")
            If Not IsDBNull(r("comp_zip_code")) Then
                html.Append(r("comp_zip_code"))
            End If
            html.Append("</td>")
            html.Append("<td>")
            If Not IsDBNull(r("comp_email_address")) Then
                html.Append(r("comp_email_address"))
            End If
            html.Append("</td>")
            html.Append("<td>")
            If Not IsDBNull(r("comp_phone_office")) Then
                html.Append(r("comp_phone_office"))
            End If
            html.Append("</td>")
            html.Append("<td>")
            If Not IsDBNull(r("comp_phone_fax")) Then
                html.Append(r("comp_phone_fax"))
            End If
            html.Append("</td>")
            html.Append("<td>")
            If Not IsDBNull(r("amod_make_name")) Then
                html.Append(r("amod_make_name"))
            End If
            html.Append("</td>")
            html.Append("<td>")
            If Not IsDBNull(r("amod_model_name")) Then
                html.Append(r("amod_model_name"))
            End If
            html.Append("</td>")
            html.Append("<td>")
            If Not IsDBNull(r("ac_year_mfr")) Then
                html.Append(r("ac_year_mfr"))
            End If
            html.Append("</td>")
            html.Append("<td>")
            If Not IsDBNull(r("ac_ser_nbr")) Then
                html.Append(r("ac_ser_nbr"))
            End If
            html.Append("</td>")
            html.Append("<td>")
            If Not IsDBNull(r("ac_reg_nbr")) Then
                html.Append(r("ac_reg_nbr"))
            End If
            html.Append("</td>")
            html.Append("<td>")
            If Not IsDBNull(r("ac_date_purchased")) Then
                html.Append(r("ac_date_purchased"))
            End If
            html.Append("</td>")
            html.Append("<td>")
            If Not IsDBNull(r("ac_status")) Then
                html.Append(r("ac_status"))
            End If
            html.Append("</td>")
            html.Append("<td>")
            If Not IsDBNull(r("ac_asking_price")) Then
                html.Append(crmWebClient.clsGeneral.clsGeneral.ConvertIntoThousands(r("ac_asking_price")))
            End If
            html.Append("</td>")
            html.Append("<td>")
            If Not IsDBNull(r("ac_est_price")) Then
                html.Append(crmWebClient.clsGeneral.clsGeneral.ConvertIntoThousands(r("ac_est_price")))
            End If
            html.Append("</td>")



            html.Append("<td>")
            If Not IsDBNull(r("lnote_cash_value")) Then
                If r("lnote_cash_value") > 0 Then
                    html.Append("$" & FormatNumber(r("lnote_cash_value"), 0))
                End If
            End If
            html.Append("</td>")
            html.Append("<td>")
            If Not IsDBNull(r("lnote_capture_percentage")) Then
                If r("lnote_capture_percentage") > 0 Then
                    html.Append(" " & r("lnote_capture_percentage") & "%")
                End If
            End If
            html.Append("</td>")

            Dim title As String = ""
            Dim note As String = ""
            If Not IsDBNull(r("lnote_note")) Then
                Dim lnoteString As String = r("lnote_note")
                If InStr(r("lnote_note"), " ::: ") > 0 Then
                    Dim splNote As String() = Split(r("lnote_note"), " ::: ")
                    lnoteString = UCase(splNote(0)) & "<br /><br />"
                    lnoteString += "<p>" & splNote(1) & "</p>"
                    title = splNote(0)
                    note = splNote(1)
                Else
                    note = r("lnote_note")
                End If
            End If

            html.Append("<td>" & title & "</td>")
            html.Append("<td>" & note & "</td>")


            html.Append("</tr>")
        Next
        html.Append("</tbody>")
        html.Append("<tfoot>")
        html.Append("</table>")
        Return html.ToString
    End Function


End Class