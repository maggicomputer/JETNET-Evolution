'********************************************************************************
' Copyright 2004-05. JETNET,LLC. All rights reserved.
'
'$$Archive: /commonWebProject/viewToPDF.aspx.vb $
'$$Author: Matt $
'$$Date: 7/02/20 3:33p $
'$$Modtime: 7/02/20 3:33p $
'$$Revision: 47 $
'$$Workfile: viewToPDF.aspx.vb $
'
' ********************************************************************************

Partial Public Class viewtopdf_aspx

    Inherits System.Web.UI.Page

    Dim report_name As String ' Used for defining name of pdf report
    Dim real_make_model_name As String = ""
    Dim amod_id_overall As String = ""
    Dim amod_id As Long = 0
    Dim avgyear As Integer = 0
    Dim totalcount As Integer = 0
    Dim totalInOpcount As Integer = 0
    Dim ac_for_sale As Integer = 0
    Dim ac_exclusive_sale As Integer = 0
    Dim ac_lease As Integer = 0
    Dim w_owner As Integer = 0
    Dim s_owner As Integer = 0
    Dim f_owner As Integer = 0
    Dim o_stage As Integer = 0
    Dim t_stage As Integer = 0
    Dim th_stage As Integer = 0
    Dim f_stage As Integer = 0
    Dim daysonmarket As Integer = 0
    Dim daysonmarket2 As Integer = 0
    Dim forsaleavghigh As String = ""
    Dim forsaleavlow As String = "199999999999999999999999999999999999999999999999999999"
    Dim forsaleavg As String = ""
    Dim allhigh As Integer = 0
    Dim alllow As Integer = 0
    Dim mfr_high_fs As Integer = 0
    Dim mfr_low_fs As Integer = 50000
    Dim mfr_avg_fs As Integer = 0
    Dim aftt_high As Integer = 0
    Dim aftt_low As Integer = 0
    Dim aftt_avg As Integer = 0
    Dim aftt_high_fs As Integer = 0
    Dim aftt_low_fs As Integer = 50000
    Dim aftt_avg_fs As Integer = 0
    Dim year_high As Integer = 0
    Dim year_low As Integer = 0
    Dim us_reg As Integer = 0
    Dim per As Double = 0.0
    Dim per2 As Double = 0.0
    Dim per3 As Double = 0.0
    Dim days As Long = 0
    Dim highdays As Long = 0
    Dim lowdays As Long = 50000
    Dim LowSalesPrice As Double = 0
    Dim HighSalesPrice As Double = 0
    Dim AvgSalesPrice As Double = 0
    Dim imgFolder_location As String
    Public word_width As String = "700"
    Public word_half As String = "350"
    Public word_35 As String = "245"
    Public word_1_4 As String = "160"
    Public word_32 As String = ""
    Public word_60 As String = ""
    Dim made_first_page As Boolean = False
    Dim table_color As String = "blue"
    Dim graph_color_new As String = "blue"
    Public aclsData_Temp_aspx As New clsData_Manager_SQL

    Private number_of_engine_types As Long = 0

    Private TYPE_OF_AC As String = ""
    Private PDF_Page_Flag As String = "N"
    Public all_pdf As Boolean = False
    Public location_string As String = ""
    Private localCriteria As New viewSelectionCriteriaClass
    Private localdatalayer As viewsDataLayer
    Dim comp_functions As New CompanyFunctions
    Dim bWordReport As Boolean = False
    Public spacer_width As String = "218"
    Public word_width_new As String = "700"
    Public pdf_html_width As String = "95%"
    Dim comp_address As String = ""
    Dim comp_logo As String = ""
    Dim temp_pdf_header As String = ""
    Dim temp_pdf_footer As String = ""
    Dim NEW_CRMViewActive As Boolean = False
    Dim NEW_PDF_AMOD_ID As Long = 0
    Dim ac_id_list As String = ""
    Dim journ_id_list As String = ""
    Dim market_functions As New market_model_functions
    Dim FeaturesList As String = ""
    Dim value_summary As String = ""
    Dim in_op_count As Double = 0
    Dim total_in_op As Long = 0
    Dim afttFilter As Boolean = False
    Dim yearFilter As Boolean = False
    Dim valueHeaderString As String = ""
    Dim valueEmptyHeaderString As String = ""
    Dim util_functions As New utilization_functions
    Dim util_view_functions As New utilization_view_functions
    Dim aport_id As Long = 0
    Dim is_aport_us As Boolean = False
    Dim aport_name As String = ""
    Dim ModelPrograms As New ArrayList
    Dim star_functions As New star_view_functions
    Dim new_PDF_AC_ID As Long = 0
    Dim year_start_mms As Long = 0
    Dim year_end_mms As Long = 0
    Dim temp_util_title As String = ""
    Dim international_label As String = ""
    Dim percent_flight As Long = 0
    Dim ground_time As Long = 0
    Dim origin_or_dest As String = "D"
    Dim total_flights_count As Long = 1
    Dim amod_id_list As String = ""
    Dim show_fuel_burn_in_liters As Boolean = False
    Dim afolder_id As Long = 0
    Dim airport_list As String = ""





    Protected Sub Page_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load
        If Session.Item("crmUserLogon") <> True Then
            Response.Redirect("Default.aspx", False)
        Else
            Session.Item("localPreferences").DefaultCurrency = 9 ' us dollar 
            '**** will have to remove to use real user info ....
            '**** will have to remove to use real user info ....
            Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
            Dim SqlConn As New System.Data.SqlClient.SqlConnection
            Dim SqlCommand As New System.Data.SqlClient.SqlCommand
            Dim localAdoRs2 As System.Data.SqlClient.SqlDataReader : localAdoRs2 = Nothing
            Dim Query As String = ""
            Dim amod_id As Integer = 0
            Dim comp_id As Integer = 0
            Dim COMP_NAME As String = ""
            Dim View_Type As Integer = 0
            Dim airframe_type As String = ""
            Dim i As Integer = 0
            Dim subs_id As Integer = 0
            Dim real_city_name As String = ""
            Dim real_country_name As String = ""
            Dim selected_product_code_from_drop_down As String = ""
            Dim make_name As String = ""
            Session.Item("localPreferences").DefaultCurrency = 9 ' us dollar
            Dim sProductList() As eProductCodeTypes = Nothing
            Dim temp_test As String = ""
            Dim engine_name As String = ""
            ' This section gets all of the request variables and sets them to local variables to display on the screen
            Dim current_spi_year As Integer = 0
            Dim model_weight As String = ""
            Dim model_weight_name As String = ""
            Dim current_spi_year2 As Integer = 0
            Dim months_count As Integer = 0
            Dim real_make_model_name2 As String = ""
            Dim real_make_model_name3 As String = ""
            Dim amod_id2 As Integer = 0
            Dim amod_id3 As Integer = 0
            Dim html_for_google_graph As String = ""
            Dim charting_string As String = ""
            Dim AvgAskingPriceVsSellingPrice As String = ""
            Dim AvgSellingPriceByYear As String = ""
            Dim Graph5 As String = ""
            Dim Graph6 As String = ""
            Dim Graph7 As String = ""
            Dim Graph8 As String = ""
            Dim Graph9 As String = ""
            Dim Graph10 As String = ""
            Dim Graph11 As String = ""
            Dim Graph12 As String = ""
            Dim Graph13 As String = ""
            Dim Graph14 As String = ""
            Dim Graph15 As String = ""
            Dim Graph16 As String = ""
            Dim Graph17 As String = ""
            Dim Graph18 As String = ""
            Dim guage_string As String = ""
            Dim chart_string As String = ""
            Dim Graph19 As String = ""
            Dim Graph21 As String = ""
            Dim Graph22 As String = ""
            Dim Graph23 As String = ""
            Dim graph24 As String = ""
            Dim graph25 As String = ""
            Dim graph26 As String = ""
            Dim graph27 As String = ""
            Dim graph28 As String = ""
            Dim graph29 As String = ""
            Dim graph30 As String = ""
            Dim graph31 As String = ""
            Dim graph32 As String = ""
            Dim graph33 As String = ""
            Dim graph27_ticks_string As String = ""
            Dim graph28_ticks_string As String = ""
            Dim graph29_ticks_string As String = ""
            Dim graph30_ticks_string As String = ""
            Dim graph31_ticks_string As String = ""
            Dim graph32_ticks_string As String = ""
            Dim graph33_ticks_string As String = ""
            Dim htmlOperationalTrendsGraph As String = ""
            Dim htmlOperationalTrendsGraphScript As String = ""
            Dim operationalTrendsID As Integer = 20
            Dim htmlFlightUtilizationGraphScript As String = ""
            Dim graphID As Integer = 1
            Dim htmlFlightUtilizationFunctionScript As String = ""
            Dim htmlOperationalTrendsFunctionScript As String = ""
            Dim color_changed As Boolean = False
            Dim skip_run As Boolean = False
            Dim temp_ticks_string As String = ""

            Dim make_list As String = ""
            Dim type_list As String = ""

            'If Application.Item("crmClientSiteData").ClientFullHostName.ToString.ToUpper.Contains("WWW.JETNETEVO.COM") Then
            '    location_string = "jetnetevo"
            'ElseIf Application.Item("crmClientSiteData").ClientFullHostName.ToString.ToUpper.Contains("WWW.JETNETEVO1.COM") Then
            '    location_string = "jetnetevo1"
            'ElseIf Application.Item("crmClientSiteData").ClientFullHostName.ToString.ToUpper.Contains("WWW.JETNETEVO2.COM") Then
            '    location_string = "jetnetevo2"
            'ElseIf Application.Item("crmClientSiteData").ClientFullHostName.ToString.ToUpper.Contains("LOCALHOST") Then
            '    location_string = "localhost"
            'ElseIf Application.Item("crmClientSiteData").ClientFullHostName.ToString.ToUpper.Contains("WWW.JETNETEVOLUTION.COM") Then
            '    location_string = "jetnetevo"
            'Else
            '    location_string = "jetnetevo"
            'End If

            If InStr(HttpContext.Current.Session.Item("jetnetFullHostName").ToString.Trim, "jetnetevo") > 0 Then
                location_string = HttpContext.Current.Session.Item("jetnetFullHostName").ToString.Trim
            Else
                location_string = "http://www.jetnetevolution.com/"
            End If

            If Not IsNothing(Request.Item("weight")) Then
                If Not String.IsNullOrEmpty(Request.Item("weight").ToString) Then
                    model_weight = Request("weight").ToString
                End If '
            End If

            If Not IsNothing(Request.Item("weight_name")) Then
                If Not String.IsNullOrEmpty(Request.Item("weight_name").ToString) Then
                    model_weight_name = Request("weight_name").ToString
                End If '
            End If

            If Not IsNothing(Request.Item("year")) Then
                If Not String.IsNullOrEmpty(Request.Item("year").ToString) Then
                    current_spi_year = Request("year").ToString
                End If '
            End If

            If Not IsNothing(Request.Item("year2")) Then
                If Not String.IsNullOrEmpty(Request.Item("year2").ToString) Then
                    current_spi_year2 = Request("year2").ToString
                End If '
            End If



            If Not IsNothing(Request.Item("sub")) Then
                If Not String.IsNullOrEmpty(Request.Item("sub").ToString) Then
                    Session.Item("localUser").crmSubSubID = CLng(Request.Item("sub").ToString.Trim)
                    subs_id = CLng(Session.Item("localUser").crmSubSubID.ToString)
                End If
            End If


            If Not IsNothing(Request.Item("ac_id_list")) Then
                If Not String.IsNullOrEmpty(Request.Item("ac_id_list").ToString) Then
                    ac_id_list = Request.Item("ac_id_list").ToString.Trim
                End If
            End If

            If Not IsNothing(Request.Item("ac_id")) Then
                If Not String.IsNullOrEmpty(Request.Item("ac_id").ToString) Then
                    new_PDF_AC_ID = Request.Item("ac_id").ToString.Trim
                End If
            End If

            If Not IsNothing(Request.Item("journ_id_list")) Then
                If Not String.IsNullOrEmpty(Request.Item("journ_id_list").ToString) Then
                    journ_id_list = Request.Item("journ_id_list").ToString.Trim
                End If
            End If




            If Not IsNothing(Request.Item("log")) Then
                If Not String.IsNullOrEmpty(Request.Item("log").ToString) Then
                    Session.Item("localUser").crmSubUserID = Request.Item("log").ToString.Trim
                End If
            End If

            If Not IsNothing(Request.Item("seq")) Then
                If Not String.IsNullOrEmpty(Request.Item("seq").ToString) Then
                    Session.Item("localUser").crmSubSeqNo = CInt(Request.Item("seq").ToString.Trim)
                End If
            End If

            Dim fSubins_platform_os As String = commonEvo.getBrowserCapabilities(Request.Browser)


            Dim sErrorString As String = ""


            If Not IsNothing(Request.Item("viewID")) Then
                If Not String.IsNullOrEmpty(Request.Item("viewID").ToString) Then
                    View_Type = Request("viewID")
                Else
                    View_Type = 1
                End If '
            Else
                View_Type = 1
            End If



            If View_Type = 111 Then
                ' ONLY RUN IF ITS LOCAL OR TEST 
                If Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CUSTOMER_CENTER Then

                    If Not IsNothing(Request.Item("amod_id")) Then
                        If Not String.IsNullOrEmpty(Request.Item("amod_id").ToString) Then

                            If InStr(Request("amod_id").ToString, ",") > 0 And View_Type = 28 Then
                                amod_id_list = Request("amod_id").ToString
                                amod_id = -1
                                real_make_model_name = "" ' Get_Model_Name(amod_id).ToString
                            Else
                                amod_id = CLng(Request("amod_id").ToString)
                                real_make_model_name = Get_Model_Name(amod_id).ToString
                            End If
                        End If
                    End If

                End If
            End If


            If MMS_RM.Checked = True And Trim(destination.Text) = "" And View_Type = 998 Then
                Me.extra_map_warning_label.Visible = True
                skip_run = True
            End If

            If skip_run = True Then

            Else

                If Not Session.Item("localPreferences").loadUserSession(sErrorString, CLng(Session.Item("localUser").crmSubSubID.ToString), Session.Item("localUser").crmUserLogin.ToString, CLng(Session.Item("localUser").crmSubSeqNo.ToString), CLng(Session.Item("localUser").crmUserContactID.ToString)) Then
                    'Response.Write("error in load preferences : " + sErrorString) 
                End If

                ' call the Get_Model_Name funciton
                If Not IsNothing(Request.Item("amod_id")) Then
                    If Not String.IsNullOrEmpty(Request.Item("amod_id").ToString) Then

                        If InStr(Request("amod_id").ToString, ",") > 0 And View_Type = 28 Then
                            amod_id_list = Request("amod_id").ToString
                            amod_id = -1
                            real_make_model_name = "" ' Get_Model_Name(amod_id).ToString
                        Else
                            amod_id = CLng(Request("amod_id").ToString)
                            real_make_model_name = Get_Model_Name(amod_id).ToString
                        End If
                    End If
                End If

                If Not IsNothing(Request.Item("type_string")) Then
                    localCriteria.ViewCriteriaTypeIDArray = Split(Trim(Request.Item("type_string")), ",")
                End If

                If Not IsNothing(Request.Item("make_string")) Then
                    localCriteria.ViewCriteriaAircraftMake = Trim(Request.Item("make_string"))
                End If

                If amod_id = 0 Then
                    If Not IsNothing(Request.Item("modelList")) Then
                        If Not String.IsNullOrEmpty(Request.Item("modelList").ToString) Then
                            amod_id = CLng(Request("modelList").ToString)
                            real_make_model_name = Get_Model_Name(amod_id).ToString
                        End If
                    End If
                End If

                If amod_id = 0 Then
                    If Not IsNothing(Request.Item("cboAircraftViewModelID")) Then
                        If IsNumeric(Request.Item("cboAircraftViewModelID")) Then
                            If Request.Item("cboAircraftViewModelID") > 0 Then
                                amod_id = commonEvo.ReturnAmodIDForItemIndex(CLng(Request.Item("cboAircraftViewModelID")))
                                real_make_model_name = Get_Model_Name(amod_id).ToString
                                NEW_PDF_AMOD_ID = amod_id
                            End If
                        End If
                    End If
                End If

                If Not IsNothing(Request.Item("months")) Then
                    If Not String.IsNullOrEmpty(Request.Item("months").ToString) Then
                        months_count = Request("months").ToString
                    End If '
                End If

                ' This is used to show the metric/us standard on other page
                If Session.Item("show_cost_values") = "" Then
                    Session.Item("show_cost_values") = "Yes"
                End If

                If Not IsNothing(Request.Item("standardormetric")) Then
                    If Not String.IsNullOrEmpty(Request.Item("standardormetric").ToString) Then
                        Session.Item("localPreferences").UseStandardOrMetric = Request.Item("standardormetric").Trim.ToLower
                    Else
                        Session.Item("localPreferences").UseStandardOrMetric = "standard"
                    End If
                Else
                    Session.Item("localPreferences").UseStandardOrMetric = "standard"
                End If

                'added msw 2/2/16
                If Not IsPostBack Then
                    For Each item As ListItem In useStandardOrMetric.Items
                        If item.Value = Session.Item("localPreferences").UseStandardOrMetric Then
                            item.Selected = True
                            Exit For
                        Else
                            item.Selected = False
                        End If
                    Next
                End If
                Session.Item("localPreferences").DefaultCurrency = 9
                If Not IsNothing(Request.Item("currency")) Then
                    If Not String.IsNullOrEmpty(Request.Item("currency").ToString) Then
                        Session.Item("localPreferences").DefaultCurrency = Request.Item("currency").Trim
                    End If
                End If

                If Not IsNothing(Request.Item("amod_id2")) Then
                    If Not String.IsNullOrEmpty(Request.Item("amod_id2").ToString) Then
                        amod_id2 = CLng(Request("amod_id2").ToString)
                    End If
                End If

                If Not IsNothing(Request.Item("amod_id3")) Then
                    If Not String.IsNullOrEmpty(Request.Item("amod_id3").ToString) Then
                        amod_id3 = CLng(Request("amod_id3").ToString)
                    End If
                End If
                If amod_id2 > 0 Then
                    real_make_model_name2 = Get_Model_Name(amod_id2).ToString
                End If

                If amod_id3 > 0 Then
                    real_make_model_name3 = Get_Model_Name(amod_id3).ToString
                End If

                ' call the Get_Model_Name funciton
                If Not IsNothing(Request.Item("make_name")) Then
                    If Not String.IsNullOrEmpty(Request.Item("make_name").ToString) Then
                        make_name = Request("make_name").ToString
                    End If '
                End If

                ' call the Get_Model_Name funciton
                If Not IsNothing(Request.Item("comp_id")) Then
                    If Not String.IsNullOrEmpty(Request.Item("comp_id").ToString) Then
                        comp_id = CLng(Request("comp_id").ToString)
                    End If '
                End If

                If Not IsNothing(Request.Item("percent_flight")) Then
                    If Not String.IsNullOrEmpty(Request.Item("percent_flight").ToString) Then
                        If IsNumeric(Trim(Request.Item("percent_flight"))) Then
                            percent_flight = Request("percent_flight").ToString
                        Else
                            percent_flight = 60
                        End If
                    Else
                        percent_flight = 60
                    End If
                Else
                    percent_flight = 60
                End If




                If Not IsNothing(Request.Item("origin_or_dest")) Then
                    If Not String.IsNullOrEmpty(Request.Item("origin_or_dest").ToString) Then
                        origin_or_dest = Request("origin_or_dest").ToString
                    End If
                End If

                If Not IsNothing(Request.Item("ground_time")) Then
                    If Not String.IsNullOrEmpty(Request.Item("ground_time").ToString) Then
                        If IsNumeric(Trim(Request.Item("ground_time"))) Then
                            ground_time = Request("ground_time").ToString
                        End If
                    End If
                End If

                If ground_time = 0 Then
                    ground_time = 90
                End If


                If Not IsNothing(Request.Item("airframe_type")) Then
                    If Not String.IsNullOrEmpty(Request.Item("airframe_type").ToString) Then
                        airframe_type = Request("airframe_type").ToString
                    End If
                End If

                If airframe_type.ToString.Trim = "F" Then
                    airframe_type = "Fixed Wing Aircraft"
                ElseIf airframe_type.ToString.Trim = "R" Then
                    airframe_type = "Rotary Wing Aircraft"
                End If

                If Not IsNothing(Request.Item("pc")) Then
                    If Not String.IsNullOrEmpty(Request.Item("pc").ToString) Then
                        selected_product_code_from_drop_down = Request("pc").ToString
                        If selected_product_code_from_drop_down.ToString.Trim = "1" Then
                            selected_product_code_from_drop_down = "Business"
                        ElseIf selected_product_code_from_drop_down.ToString.Trim = "2" Then
                            selected_product_code_from_drop_down = "Commercial"
                        ElseIf selected_product_code_from_drop_down.ToString.Trim = "3" Then
                            selected_product_code_from_drop_down = "Helicopters"
                        ElseIf selected_product_code_from_drop_down.ToString.Trim = "B" Then
                            selected_product_code_from_drop_down = "Business"
                        ElseIf selected_product_code_from_drop_down.ToString.Trim = "C" Then
                            selected_product_code_from_drop_down = "Commercial"
                        ElseIf selected_product_code_from_drop_down.ToString.Trim = "H" Then
                            selected_product_code_from_drop_down = "Helicopters"
                        ElseIf selected_product_code_from_drop_down.ToString.Trim = "B,C" Then
                            selected_product_code_from_drop_down = "Business, Commercial"
                        ElseIf selected_product_code_from_drop_down.ToString.Trim = "B,H" Then
                            selected_product_code_from_drop_down = "Business, Helicopters"
                        ElseIf selected_product_code_from_drop_down.ToString.Trim = "C,H" Then
                            selected_product_code_from_drop_down = "Commercial, Helicopters"
                        End If
                    End If
                End If

                If Not IsNothing(Request.Item("engine")) Then
                    If Not String.IsNullOrEmpty(Request.Item("engine").ToString) Then
                        engine_name = Request("engine").ToString
                    End If '
                End If

                If amod_id > 0 Then
                    TYPE_OF_AC = Get_Model_Name(amod_id).ToString
                End If

                If HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then
                    If Trim(Session.Item("localPreferences").UserDatabaseConn) <> "" Then
                        Session.Item("fuelPriceBase") = Get_Fuel_Price()
                    Else
                        Session.Item("fuelPriceBase") = ""
                    End If
                Else
                    Session.Item("fuelPriceBase") = Get_Fuel_Price()
                End If

                '  If Trim(Request("gg")) = "Y" Then
                html_for_google_graph = "Y"
                If View_Type = 1 Then
                    SetUpJavascriptOnClickGoogleGraph()
                ElseIf View_Type = 997 Or View_Type = 998 Then
                    SetUpJavascriptOnClickGoogleGraph()
                    If Session.Item("localPreferences").AerodexFlag = True Then
                        Me.current_market_panel.Visible = False
                        Me.sales_panel.Visible = False
                    End If

                    ' TBD EVALUES
                    If clsGeneral.clsGeneral.isEValuesAvailable() = True And clsGeneral.clsGeneral.isShowingEvalues() = True Then
                        'If HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.TEST Or HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Then
                        'If HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag = True Then
                        Me.valuation_panel.Visible = True
                        'End If
                    End If

                ElseIf View_Type = 28 Or View_Type = 928 Then
                    SetUpJavascriptOnClickGoogleGraph_28()
                End If

                If Trim(HttpContext.Current.Session.Item("localPreferences").crmUserID) <> "0" And (View_Type = 997 Or View_Type = 998) Then
                    Me.mpm_attention.Visible = True
                End If

                ' added MSW - 5/7/19
                If View_Type = 998 Then
                    btnSave_Selections.Visible = True
                Else
                    btnSave_Selections.Visible = False
                End If

                ' End If

                If comp_id > 0 Then
                    'COMP_NAME = commonEVO.get_company_name_fromID(comp_id, 0, False)
                    COMP_NAME = get_company_name(comp_id).ToString
                End If

                If Not IsNothing(Request.Item("city")) Then
                    If Not String.IsNullOrEmpty(Request.Item("city").ToString) Then
                        real_city_name = Request("city").ToString
                    End If '
                End If



                If View_Type = 28 Then
                    If Trim(Request("aport_id")) <> "" Then
                        aport_id = Trim(Request("aport_id"))
                        Call Get_Airport_Name_Country(aport_id, is_aport_us, aport_name)
                    End If
                End If


                If Not IsNothing(Request.Item("country")) Then
                    If Not String.IsNullOrEmpty(Request.Item("country").ToString) Then
                        real_country_name = Request("country").ToString
                    End If '
                End If

                ' ADDED IN MSW 
                If Trim(View_Type) = 997 Then
                    Call get_multi_model_info()
                End If

                If Not IsNothing(Request.Item("print_details")) Then
                    Build_PDF_Form_Final(999, "", "", "", "", "", "", "", "", "", "", "", 0, "", "")
                Else
                    Build_PDF_Form_Final(View_Type, COMP_NAME, TYPE_OF_AC, real_country_name, real_city_name, airframe_type, engine_name, selected_product_code_from_drop_down, current_spi_year, current_spi_year2, model_weight_name, make_name, months_count, real_make_model_name2, real_make_model_name3)
                End If

                If Not IsPostBack Then
                    If View_Type = 998 Then
                        load_selection_cookie_defaults()
                    End If
                End If

                '  outerDivViewToPDFID.Attributes.Item("width") = Session.Item("MainTableWidth").ToString
                outerDivViewToPDFID.Attributes.Item("width") = 800
                If IsNothing(HttpContext.Current.Session.Item("graph_color")) Then
                    HttpContext.Current.Session.Item("graph_color") = ""
                End If

                If Trim(View_Type) = 998 Or Trim(View_Type) = 997 Then
                    If Not IsNothing(market_color.SelectedValue) Then
                        If Trim(market_color.SelectedValue) <> "" Then
                            table_color = market_color.SelectedValue

                            If Trim(HttpContext.Current.Session.Item("graph_color")) <> "" Then
                                If LCase(Trim(HttpContext.Current.Session.Item("graph_color"))) <> LCase(Trim(table_color)) Then
                                    color_changed = True
                                End If
                            End If
                            ' HttpContext.Current.Session.Item("graph_color") = table_color

                            graph_color_new = create_graph_color(table_color)
                            HttpContext.Current.Session.Item("graph_color") = graph_color_new
                        Else
                            HttpContext.Current.Session.Item("graph_color") = ""
                        End If
                    Else
                        HttpContext.Current.Session.Item("graph_color") = ""
                    End If
                Else
                    HttpContext.Current.Session.Item("graph_color") = ""
                End If


                If Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CRM Then
                    Me.CRM_Wanteds.Visible = True
                Else
                    Me.CRM_Wanteds.Visible = False
                End If

                If HttpContext.Current.Session.Item("localPreferences").AerodexFlag Then
                    Me.MMS_BAFS.Visible = False
                    Me.MMS_BAFS.Enabled = False
                    ' Me.MMS_BRMA.Visible = False
                    '  Me.MMS_BRMA.Enabled = False
                End If

                If IsNothing(Session("Last_PDF_TIMEFRAME")) Then
                    Session("Last_PDF_TIMEFRAME") = ""
                End If
                If IsNothing(Session("Last_PDF_DOC_TYPE")) Then
                    Session("Last_PDF_DOC_TYPE") = ""
                End If
                ' HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag = False

                If HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag = True And (View_Type = 998 Or View_Type = 997) Then
                    'Me.indent_label2.Visible = True
                    Me.MMS_Sale_Prices.Visible = True
                Else
                    Me.indent_label2.Visible = False
                    Me.MMS_Sale_Prices.Visible = False
                    Me.MMS_Sale_Prices.Checked = False
                End If





                If Trim(Request("Residual")) = "Y" And HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag And View_Type = 300 Then
                    If Not IsPostBack Then
                        If Trim(HttpContext.Current.Session.Item("Residual_Chart_Java_PDF")) <> "" Then
                            Me.btnRunReport.Text = "Click to Create PDF"
                            Dim temp_string_res As String = ""
                            Dim spot_to_find As Integer = 0
                            Dim temp_series As String = ""
                            Dim spot_to_find2 As Long = 0
                            Call SetUpJavascriptOnClickGoogleGraph_Residual()

                            temp_string_res = HttpContext.Current.Session.Item("Residual_Chart_Java_PDF")
                            temp_string_res = Replace(temp_string_res, "Function drawVisualization7() {", "")
                            temp_string_res = Replace(temp_string_res, "function drawVisualization7() {", "")
                            temp_string_res = Replace(temp_string_res, "var data7 = New google.visualization.DataTable();", "")
                            '  temp_string_res = Replace(temp_string_res, "pointSize: 1", "pointSize: 2")


                            spot_to_find = InStr(Trim(temp_string_res), "]]);")
                            If spot_to_find > 0 Then

                                'get the series, for the residual chart 
                                spot_to_find2 = InStr(Trim(temp_string_res), "hAxis:")
                                If spot_to_find2 > 0 Then
                                    temp_series = Left(Trim(temp_string_res), spot_to_find2 - 1)
                                End If

                                spot_to_find2 = InStr(Trim(temp_series), "series:")
                                If spot_to_find2 > 0 Then
                                    temp_series = Right(Trim(temp_series), Len(Trim(temp_series)) - ((spot_to_find2) - 1))
                                End If

                                If Right(Trim(temp_series), 1) = "," Then
                                    temp_series = Left(Trim(temp_series), Len(Trim(temp_series)) - 1)
                                End If


                                temp_string_res = Left(Trim(temp_string_res), spot_to_find)  ' dont do minus 1, need last ]
                            End If

                            DisplayFunctions.load_google_chart(graph_panel, temp_string_res, "", "", "chart_div_tab7_all", 1250, 750, "POINTS", 7, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, False, False, False, False, False, False, 0, "bottom", png7.ClientID, True, 0, "", temp_series)

                            Call load_google_chart_all(charting_string)
                        End If
                    End If
                End If










                ' added utilizationGraphs MSw - in case u change that checkbox 
                If Not IsPostBack Or Trim(Session("Last_PDF_TIMEFRAME")) <> Trim(month_timeframe.SelectedValue.ToString.Trim) Or Trim(Session("Last_PDF_DOC_TYPE")) <> Trim(Me.WD.SelectedValue.ToString.Trim) Or utilizationInternational.Checked = True Or color_changed = True Then

                    Session("Last_PDF_TIMEFRAME") = Trim(month_timeframe.SelectedValue.ToString.Trim)
                    Session("Last_PDF_DOC_TYPE") = Trim(Me.WD.SelectedValue.ToString.Trim)
                    If Trim(View_Type) = 28 Or Trim(View_Type) = 928 Then

                        If amod_id > 0 Then
                            amod_id_list = amod_id ' to be changed later 
                        End If

                        aport_id = Trim(Request("aport_id"))

                        ' added MSW to check if usa 
                        Call Get_Airport_Name_Country(aport_id, is_aport_us, aport_name)

                        If is_aport_us = True Then
                            utilizationInternational.Visible = True
                        Else
                            utilizationInternational.Checked = False
                            utilizationInternational.Visible = False
                        End If

                        localCriteria.ViewCriteriaAmodID = amod_id
                        localCriteria.ViewCriteriaTimeSpan = 6
                        WD.Items.Remove(WD.Items.FindByValue("Word"))

                        ' pick up the company from "view page selections"
                        If Not IsNothing(Request.Item("viewCompany")) Then
                            If Not String.IsNullOrEmpty(Request.Item("viewCompany").ToString) Then
                                localCriteria.ViewCriteriaCompanyID = CLng(Request.Item("viewCompany").ToString.Trim)
                            Else
                                localCriteria.ViewCriteriaCompanyID = 0
                            End If
                        Else
                            localCriteria.ViewCriteriaCompanyID = 0
                        End If

                        NEW_PDF_AMOD_ID = amod_id
                        Session("Last_FAA_DATE") = Session.Item("localSubscription").crmSubinst_FAA_data_date

                        util_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
                        util_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
                        util_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
                        util_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
                        util_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim
                        util_functions.Airport_ID_OVERALL = aport_id
                        util_functions.airport_direction = origin_or_dest


                        'If Trim(Request("Folder_Id")) <> "" Then
                        '    localCriteria.ViewCriteriaFolderID = Trim(Request("Folder_Id"))
                        'End If


                        If Trim(Request("start_date")) <> "" Then
                            start_date.Text = Trim(Request("start_date"))
                            localCriteria.ViewCriteriaDocumentsStartDate = start_date.Text
                        Else

                            If Trim(Request("months")) <> "" Then
                                localCriteria.ViewCriteriaTimeSpan = Trim(Request("months"))
                            Else
                                localCriteria.ViewCriteriaTimeSpan = 6
                            End If

                            ' will need to change when you bring over custom 
                            localCriteria.ViewCriteriaDocumentsStartDate = FormatDateTime(DateAdd(DateInterval.Month, -localCriteria.ViewCriteriaTimeSpan, Now()), DateFormat.ShortDate)

                        End If

                        If Trim(Request("end_date")) <> "" Then
                            end_date.Text = Trim(Request("end_date"))
                            localCriteria.ViewCriteriaDocumentsEndDate = end_date.Text
                        Else
                            If Trim(Request("months")) <> "" Then
                                localCriteria.ViewCriteriaTimeSpan = Trim(Request("months"))
                            Else
                                localCriteria.ViewCriteriaTimeSpan = 6
                            End If

                            ' will need to change when you bring over custom 

                            localCriteria.ViewCriteriaDocumentsEndDate = FormatDateTime(Now(), DateFormat.ShortDate)
                        End If

                        ' pc is for business, commercial and helicopter, pc2 is for jets, turbo props etc
                        If Not IsNothing(Request.Item("pc")) Then
                            If Not String.IsNullOrEmpty(Request.Item("pc").ToString) Then
                                selected_product_code_from_drop_down = Request("pc").ToString
                                If selected_product_code_from_drop_down.ToString.Trim = "1" Then
                                    selected_product_code_from_drop_down = "B"
                                    localCriteria.ViewCriteriaHasBusinessFlag = True
                                ElseIf selected_product_code_from_drop_down.ToString.Trim = "2" Then
                                    selected_product_code_from_drop_down = "C"
                                    localCriteria.ViewCriteriaHasCommercialFlag = True
                                ElseIf selected_product_code_from_drop_down.ToString.Trim = "3" Then
                                    selected_product_code_from_drop_down = "H"
                                    localCriteria.ViewCriteriaHasHelicopterFlag = True
                                ElseIf selected_product_code_from_drop_down.ToString.Trim = "B" Then
                                    selected_product_code_from_drop_down = "B"
                                    localCriteria.ViewCriteriaHasBusinessFlag = True
                                ElseIf selected_product_code_from_drop_down.ToString.Trim = "C" Then
                                    selected_product_code_from_drop_down = "C"
                                    localCriteria.ViewCriteriaHasCommercialFlag = True
                                ElseIf selected_product_code_from_drop_down.ToString.Trim = "H" Then
                                    selected_product_code_from_drop_down = "H"
                                    localCriteria.ViewCriteriaHasHelicopterFlag = True
                                ElseIf selected_product_code_from_drop_down.ToString.Trim = "B,C" Then
                                    selected_product_code_from_drop_down = "B,C"
                                    localCriteria.ViewCriteriaHasBusinessFlag = True
                                    localCriteria.ViewCriteriaHasCommercialFlag = True
                                ElseIf selected_product_code_from_drop_down.ToString.Trim = "B,H" Then
                                    selected_product_code_from_drop_down = "B,H"
                                    localCriteria.ViewCriteriaHasHelicopterFlag = True
                                    localCriteria.ViewCriteriaHasBusinessFlag = True
                                ElseIf selected_product_code_from_drop_down.ToString.Trim = "C,H" Then
                                    selected_product_code_from_drop_down = "C,H"
                                    localCriteria.ViewCriteriaHasCommercialFlag = True
                                    localCriteria.ViewCriteriaHasHelicopterFlag = True
                                End If '
                            End If ' 

                        Else
                            If Session.Item("localPreferences").UserBusinessFlag Then
                                localCriteria.ViewCriteriaHasBusinessFlag = True
                            End If

                            If Session.Item("localPreferences").UserHelicopterFlag Then
                                localCriteria.ViewCriteriaHasHelicopterFlag = True
                            End If

                            If Session.Item("localPreferences").UserCommercialFlag Then
                                localCriteria.ViewCriteriaHasCommercialFlag = True
                            End If
                        End If

                        If utilizationInternational.Checked = True Then
                            localCriteria.ViewCriteriaContinent = "International"
                        End If

                        If Trim(amod_id_list) <> "" Then
                            localCriteria.ViewCriteriaAmodIDArray = Split(amod_id_list, ",")
                            localCriteria.ViewCriteriaAmodID = -1
                        ElseIf amod_id > 0 Then
                            localCriteria.ViewCriteriaAmodID = amod_id
                            localCriteria.ViewCriteriaAmodIDArray = Nothing
                        Else
                            localCriteria.ViewCriteriaAmodID = -1
                            localCriteria.ViewCriteriaAmodIDArray = Nothing
                        End If

                        If Trim(View_Type) = 928 Then
                            ' Session.Item("searchCriteria").SearchViewCriteriaAirportDropdown = Session.Item("searchCriteria").SearchViewCriteriaAirportDropdown
                            Session.Item("searchCriteria").SearchViewCriteriaAirportDropdown2 = Session.Item("searchCriteria").SearchViewCriteriaAirportDropdown2
                            Session.Item("searchCriteria").SearchViewCriteriaAirportFolderName = Session.Item("searchCriteria").SearchViewCriteriaAirportFolderName
                            Session.Item("Airport_Folder_List") = Session.Item("Airport_Folder_List")

                            util_functions.Airport_IDS_String = Session.Item("Airport_Folder_List")
                        End If


                        '  localCriteria.ViewCriteriaMakeIDArray
                        'amod_id_list

                        temp_ticks_string = ""
                        Call util_functions.get_flight_profile_top_function(localCriteria, chart_string, "Month", Session("Last_FAA_DATE"), "", "pdf4", Nothing, "", temp_ticks_string)
                        chart_string = Replace(chart_string, "data1.", "data4.")

                        DisplayFunctions.load_google_chart(graph_panel, chart_string, "", "", "chart_div_tab4_all", 910, 485, "POINTS", 4, charting_string, Me.Page, Me.graph_update_panel, False, True, False, False, True, True, False, False, False, False, 0, "", png4.ClientID, True, 0, temp_ticks_string)

                        ' commented out to be double safe for now 

                        If utilizationGraphs.Checked = False Or utilizationGraphs.Visible = False Then ' then we need to make them here 
                            Call load_google_chart_all(charting_string)

                            System.Web.UI.ScriptManager.RegisterStartupScript(Me.graph_update_panel, Me.GetType(), "ToggleHidden", "<script type=""text/javascript"">$(""body"").removeClass(""loading"");</script>", False)
                        End If

                    ElseIf View_Type = 1 Then

                        NEW_PDF_AMOD_ID = amod_id

                        Call NEW_display_by_mft_year(NEW_PDF_AMOD_ID, Graph17)

                        DisplayFunctions.load_google_chart(graph_panel, Graph17, "", "", "chart_div_tab17_all", 950, 865, "POINTS", 17, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, True, True, False, False, False, False, 0, "", png17.ClientID, True)

                        Call load_google_chart_all(charting_string)

                        commonEvo.model_operational_trends_graph(NEW_PDF_AMOD_ID, htmlOperationalTrendsFunctionScript, htmlOperationalTrendsGraph, graphID, True, Nothing)

                        If Not String.IsNullOrEmpty(htmlOperationalTrendsFunctionScript.Trim) Then

                            htmlOperationalTrendsGraphScript = vbCrLf + "<script type=""text/javascript"">" + vbCrLf
                            htmlOperationalTrendsGraphScript += " drawVisualization" + graphID.ToString + "();" + vbCrLf
                            htmlOperationalTrendsGraphScript += htmlOperationalTrendsFunctionScript.Trim
                            htmlOperationalTrendsGraphScript += "</script>" + vbCrLf

                            System.Web.UI.ScriptManager.RegisterStartupScript(Me.graph_update_panel, Me.GetType(), "showOperationalTrendsGraph" + graphID.ToString, htmlOperationalTrendsGraphScript, False)

                        End If



                    ElseIf Trim(View_Type) = 998 Or Trim(View_Type) = 997 Then

                        If Not IsNothing(market_color.SelectedValue) Then
                            If Trim(market_color.SelectedValue) <> "" Then
                                table_color = market_color.SelectedValue
                                'HttpContext.Current.Session.Item("graph_color") = table_color
                                HttpContext.Current.Session.Item("graph_color") = ""
                                graph_color_new = create_graph_color(table_color)
                                HttpContext.Current.Session.Item("graph_color") = graph_color_new
                            End If
                        End If


                        Dim JavascriptOnLoad As String = ""
                        Dim middleScript As String = ""
                        middleScript = "function swapChosenDropdowns() {"
                        middleScript += "$("".chosen-select"").chosen(""destroy"");"
                        middleScript += "$("".chosen-select"").chosen({ no_results_text: ""No results found."", disable_search_threshold: 10, search_contains: true });"
                        middleScript += "};"

                        If MMS_RM.Checked = True Then
                            middleScript += "$(""#rangeOptions"").addClass(""display_none"");"
                            '----- STOLE CLASS FROM WHEN IT IS CHECKED ----------
                            middleScript += "$(""#rangeOptions"").removeClass(""display_none"");swapChosenDropdowns();"
                            '----- STOLE CLASS FROM WHEN IT IS CHECKED ----------
                        Else
                            middleScript += "$(""#rangeOptions"").addClass(""display_none"");"
                        End If


                        middleScript += "$(""#" & MMS_RM.ClientID & """).click(function() {"
                        middleScript += "if ($(this).is(':checked')) {"
                        middleScript += "$(""#rangeOptions"").removeClass(""display_none"");swapChosenDropdowns();"
                        middleScript += "$(""#" & attentionAirport.ClientID & """).removeClass(""display_none"");"
                        middleScript += "$(""#" & btnRunReport.ClientID & """).addClass(""display_none"");"
                        middleScript += "} else {"
                        middleScript += "$(""#rangeOptions"").addClass(""display_none"");"
                        middleScript += "$(""#" & attentionAirport.ClientID & """).addClass(""display_none"");"
                        middleScript += "$(""#" & btnRunReport.ClientID & """).removeClass(""display_none"");"
                        middleScript += "}"
                        middleScript += "});"
                        middleScript += "$('#" & btnRunReport.ClientID & "').removeClass('display_none');"
                        JavascriptOnLoad = vbCrLf & "if (window.addEventListener) {"
                        JavascriptOnLoad += vbCrLf & " window.addEventListener(""load"", "
                        JavascriptOnLoad += vbCrLf & "function () {"
                        'function goes here.
                        JavascriptOnLoad += middleScript
                        JavascriptOnLoad += "}, false); "
                        JavascriptOnLoad += vbCrLf & "}" 'Else 
                        JavascriptOnLoad += vbCrLf & "else {"

                        JavascriptOnLoad += vbCrLf & " window.attachEvent(""load"","
                        JavascriptOnLoad += vbCrLf & "function () {"
                        JavascriptOnLoad += middleScript
                        JavascriptOnLoad += "});"

                        JavascriptOnLoad += vbCrLf & "}" 'End if

                        If Not Page.IsPostBack Then
                            System.Web.UI.ScriptManager.RegisterStartupScript(Me, Me.GetType(), "unhideButton", JavascriptOnLoad.ToString, True)
                        Else
                            System.Web.UI.ScriptManager.RegisterStartupScript(Me, Me.GetType(), "toggleView", middleScript, True)
                        End If
                        If Not Page.IsPostBack Then
                            If Not IsNothing(HttpContext.Current.Session.Item("localPreferences").DefaultAnalysisMonths) Then
                                If Trim(HttpContext.Current.Session.Item("localPreferences").DefaultAnalysisMonths) <> "" Then
                                    If IsNumeric(HttpContext.Current.Session.Item("localPreferences").DefaultAnalysisMonths) = True Then
                                        If HttpContext.Current.Session.Item("localPreferences").DefaultAnalysisMonths > 0 Then
                                            month_timeframe.SelectedValue = HttpContext.Current.Session.Item("localPreferences").DefaultAnalysisMonths
                                        End If
                                    End If
                                End If
                            End If
                        End If
                        Session("Last_PDF_TIMEFRAME") = month_timeframe.SelectedValue
                        WD.Items.Remove(WD.Items.FindByValue("Word"))
                        MR_UTILIZATION.Text = "Fleet Utilization"
                        If Trim(html_for_google_graph) <> "" Then
                            util_view_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
                            util_view_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
                            util_view_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
                            util_view_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
                            util_view_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

                            market_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
                            market_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
                            market_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
                            market_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
                            market_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim



                            If Trim(View_Type) = 997 Then
                                NEW_PDF_AMOD_ID = amod_id
                                If Trim(Request("year_start")) <> "" Then
                                    Call Load_Values_Variables_From_ViewMaster()
                                Else
                                    Call Load_Values_Variables()
                                End If

                                Call get_multi_model_info()
                                Call get_time_values()
                            Else
                                localCriteria.ViewCriteriaAmodID = amod_id

                                Call get_time_values()


                                NEW_PDF_AMOD_ID = amod_id
                                If Trim(Request("year_start")) <> "" Then
                                    Call Load_Values_Variables_From_ViewMaster()
                                Else
                                    Call Load_Values_Variables()
                                End If

                            End If






                            contentClass.CssClass = "valueViewPDFExport"
                            ' market_functions.views_display_avg_price_by_month_graph(localCriteria, Me.AVG_PRICE_MONTH, html_for_google_graph, False)
                            ' DisplayFunctions.load_google_chart(graph_panel, html_for_google_graph, "", "Average Asking Price ($k)", "chart_div_tab1_all", 950, 550, "POINTS", 1, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, False, False, False, False, False, False, 0, "", png2.ClientID)

                            'html_for_google_graph = Replace(html_for_google_graph, "data1", "data2")
                            'DisplayFunctions.load_google_chart(graph_panel, html_for_google_graph, "", "Average Asking Price4444 ($k)", "chart_div_tab4_all", 950, 550, "POINTS", 2, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, False, False, False, False, False, False, 0, "", png4.ClientID)

                            GetFleetInfo(NEW_PDF_AMOD_ID, False, localCriteria)
                            Dim fieldLength As Double = 0

                            RangeOfModel(localCriteria, fieldLength)


                            Select Case CInt(localCriteria.ViewCriteriaAirframeType)
                                Case Constants.VIEW_HELICOPTERS
                                    localCriteria.ViewCriteriaAircraftRange = ConversionFunctions.ConvertNauticalMileToMeter(localCriteria.ViewCriteriaHeliRangeTanksFull)
                                Case Else
                                    localCriteria.ViewCriteriaAircraftRange = ConversionFunctions.ConvertNauticalMileToMeter(localCriteria.ViewCriteriaAircraftRange)
                            End Select


                            '   localCriteria

                            If View_Type = 998 Then
                                If Trim(Request("year_start")) <> "" Then
                                    Call Load_Values_Variables_From_ViewMaster()
                                End If
                            End If

                            'Fill Range dropdowns 
                            resetButton.CssClass = ""
                            If Not Page.IsPostBack Then
                                clsGeneral.clsGeneral.fillRangeDropDowns(first_model, 0, "", False, "")
                                Dim lstItems As ListItem() = New ListItem(first_model.Items.Count - 1) {}
                                first_model.Items.CopyTo(lstItems, 0)
                                second_model.Items.AddRange(lstItems)
                                'FillAirports(fieldLength)
                                'BuildJqueryDropdownJavascript()
                            End If

                            first_model.Attributes.Add("onchange", "build_range_tab_map($('#" & destination_id.ClientID & "').val(), " & localCriteria.ViewCriteriaAircraftRange & ");return false;")
                            second_model.Attributes.Add("onchange", "build_range_tab_map($('#" & destination_id.ClientID & "').val(), " & localCriteria.ViewCriteriaAircraftRange & ");return false;")
                            destination.Attributes.Add("onchange", "build_range_tab_map($('#" & destination_id.ClientID & "').val(), " & localCriteria.ViewCriteriaAircraftRange & ");return false;")
                            acRangeText.Text = localCriteria.ViewCriteriaAircraftRange
                            btnRunReport.OnClientClick = "SetWaitCursor();SetLoadingText('Generating Report..');$('body').addClass('loading standalone_page');$('#" & btnRunReport.ClientID & "').removeClass('display_none'); "
                            btnRunReport.CssClass = "display_none"
                            Call DisplayValueVintageTable(False, False, "", AvgAskingPriceVsSellingPrice, AvgSellingPriceByYear)

                            Call DisplayQuarterTable(Graph5, Graph6, Graph7, Graph8, Graph9, Graph10)

                            Call DisplayAFTTTable(Graph11, Graph12)

                            Call DisplayWeightTable(Graph13, Graph14)

                            Call display_avg_price_by_month_graph(NEW_PDF_AMOD_ID, AVG_PRICE_MONTH, days, localCriteria.ViewCriteriaTimeSpan, localCriteria, Graph15)

                            Call display_for_sale_by_month_graph(NEW_PDF_AMOD_ID, FOR_SALE, days, localCriteria.ViewCriteriaTimeSpan, localCriteria, Graph16)

                            Call NEW_display_by_mft_year(NEW_PDF_AMOD_ID, Graph17)

                            Call DisplayDaysOnMarket(localCriteria.ViewCriteriaTimeSpan, graph24, localCriteria)

                            Call NEW_Build_PDF_Upgrade(amod_id, real_make_model_name, True, "", Graph19, Graph21)

                            If HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag = True Then
                                If Me.valuation_panel.Visible = True Then
                                    Call util_view_functions.FillAssettInsightGraphs("CURRENTMARKET", localCriteria.ViewCriteriaAmodID, graph27, updateSelections, 27, 0, 0, 600, 0, True, True, True, "Serial Number", "Y", "", "", graph27_ticks_string, localCriteria.ViewCriteriaYearStart, localCriteria.ViewCriteriaYearEnd)

                                    Call util_view_functions.FillAssettInsightGraphs("DLVYEAR", localCriteria.ViewCriteriaAmodID, graph28, updateSelections, 28, 0, 0, 600, 0, True, True, True, "", "Y", "", "", graph28_ticks_string, localCriteria.ViewCriteriaYearStart, localCriteria.ViewCriteriaYearEnd)

                                    Call util_view_functions.FillAssettInsightGraphs("ASKSOLD", localCriteria.ViewCriteriaAmodID, graph29, updateSelections, 29, 0, 0, 600, 0, True, True, True, "", "Y", "", "", graph29_ticks_string, , localCriteria.ViewCriteriaYearStart, localCriteria.ViewCriteriaYearEnd)

                                    Me.invisible_count_years.Text = ""
                                    Call util_view_functions.FillAssettInsightGraphs("RESIDUAL", localCriteria.ViewCriteriaAmodID, graph30, updateSelections, 30, 0, 0, 600, 0, True, True, True, "", "Y", "", Me.invisible_count_years.Text, graph30_ticks_string, localCriteria.ViewCriteriaYearStart, localCriteria.ViewCriteriaYearEnd)

                                    Call util_view_functions.FillAssettInsightGraphs("AFTT", localCriteria.ViewCriteriaAmodID, graph31, updateSelections, 31, 0, 0, 600, 0, True, True, True, "", "Y", "", Me.invisible_count_years.Text, graph31_ticks_string, localCriteria.ViewCriteriaYearStart, localCriteria.ViewCriteriaYearEnd)

                                End If
                            End If

                            If amod_id > 0 Then
                                Call display_sold_per_month_graph(False, False, amod_id, PER_MONTH, localCriteria.ViewCriteriaTimeSpan, False, Graph18)
                            Else
                                Call display_sold_per_month_graph(False, False, 0, PER_MONTH, localCriteria.ViewCriteriaTimeSpan, False, Graph18, localCriteria.ViewCriteriaAircraftModel)
                            End If


                            '--------- ADDED MSW - 8/2/19
                            util_view_functions.views_display_flight_utilization_graph(localCriteria, graph32, "", 32, "", False, True)

                            commonEvo.model_operational_trends_graph(NEW_PDF_AMOD_ID, graph33, htmlOperationalTrendsGraph, 33, True, Nothing)


                            star_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
                            star_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
                            star_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
                            star_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
                            star_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim
                            Dim results_table As New DataTable
                            results_table = star_functions.get_max_star_report_date(localCriteria)

                            If Not IsNothing(results_table) Then
                                If results_table.Rows.Count > 0 Then
                                    For Each r As DataRow In results_table.Rows

                                        If Not IsDBNull(r.Item("ac1_start_date")) Then
                                            If Not String.IsNullOrEmpty(r.Item("ac1_start_date").ToString.Trim) Then
                                                localCriteria.ViewCriteriaStarReportDate = CDate(r.Item("ac1_start_date").ToString)
                                            Else
                                            End If
                                        End If

                                    Next
                                Else
                                End If
                            Else
                            End If
                            star_functions.views_display_live_star_aircraft_13(localCriteria, "", True, graph25, graph26)


                            'Avg Asking vs Selling Price By Year MFR ($k)
                            DisplayFunctions.load_google_chart(graph_panel, AvgAskingPriceVsSellingPrice, "", "", "chart_div_tab1_all", 1050, 545, "POINTS", 1, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, False, False, False, False, False, False, 0, "", png2.ClientID)



                            'Avg Selling Price By Year MFR ($k)
                            DisplayFunctions.load_google_chart(graph_panel, AvgSellingPriceByYear, "", "", "chart_div_tab4_all", 910, 485, "POINTS", 2, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, False, False, False, False, False, False, 0, "", png4.ClientID, True)

                            DisplayFunctions.load_google_chart(graph_panel, Graph5, "", "", "chart_div_tab5_all", 950, 800, "POINTS", 5, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, False, False, False, False, False, False, 0, "", png5.ClientID, True)

                            DisplayFunctions.load_google_chart(graph_panel, Graph6, "", "", "chart_div_tab6_all", 950, 800, "POINTS", 6, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, False, False, False, False, False, False, 0, "", png6.ClientID, True)

                            DisplayFunctions.load_google_chart(graph_panel, Graph7, "", "", "chart_div_tab7_all", 1150, 600, "POINTS", 7, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, False, False, False, False, False, False, 0, "top", png7.ClientID, True)

                            DisplayFunctions.load_google_chart(graph_panel, Graph8, "", "", "chart_div_tab8_all", 950, 800, "POINTS", 8, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, False, False, False, False, False, False, 0, "top", png8.ClientID, True)

                            DisplayFunctions.load_google_chart(graph_panel, Graph9, "", "", "chart_div_tab9_all", 950, 800, "POINTS", 9, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, False, False, False, False, False, False, 0, "", png9.ClientID, True)

                            DisplayFunctions.load_google_chart(graph_panel, Graph10, "", "", "chart_div_tab10_all", 950, 800, "POINTS", 10, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, False, False, False, False, False, False, 0, "", png10.ClientID, True)

                            DisplayFunctions.load_google_chart(graph_panel, Graph11, "", "", "chart_div_tab11_all", 1150, 670, "POINTS", 11, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, False, False, False, False, False, False, 0, "top", png11.ClientID, True)

                            DisplayFunctions.load_google_chart(graph_panel, Graph12, "", "", "chart_div_tab12_all", 950, 830, "POINTS", 12, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, False, False, False, False, False, False, 0, "", png12.ClientID, True)

                            DisplayFunctions.load_google_chart(graph_panel, Graph13, "", "", "chart_div_tab13_all", 950, 460, "POINTS", 13, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, False, True, False, False, False, False, 0, "", png13.ClientID, True)

                            DisplayFunctions.load_google_chart(graph_panel, Graph14, "", "", "chart_div_tab14_all", 950, 865, "POINTS", 14, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, False, False, False, False, False, False, 0, "", png14.ClientID, True)

                            DisplayFunctions.load_google_chart(graph_panel, Graph15, "", "", "chart_div_tab15_all", 950, 755, "POINTS", 15, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, False, True, False, False, False, False, 0, "", png15.ClientID, True)

                            DisplayFunctions.load_google_chart(graph_panel, Graph16, "", "", "chart_div_tab16_all", 950, 705, "POINTS", 16, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, False, True, False, False, False, False, 0, "", png16.ClientID, True)

                            DisplayFunctions.load_google_chart(graph_panel, Graph17, "", "", "chart_div_tab17_all", 950, 865, "POINTS", 17, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, True, True, False, False, False, False, 0, "", png17.ClientID, True)

                            DisplayFunctions.load_google_chart(graph_panel, Graph18, "", "", "chart_div_tab18_all", 950, 865, "POINTS", 18, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, False, False, False, False, False, False, 0, "", png18.ClientID, True)

                            DisplayFunctions.load_google_chart(graph_panel, Graph19, "", "", "chart_div_tab20_all", 950, 500, "POINTS", 20, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, True, True, False, False, False, False, 0, "", png19.ClientID, True)

                            DisplayFunctions.load_google_chart(graph_panel, Graph21, "", "", "chart_div_tab21_all", 950, 500, "POINTS", 21, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, True, True, False, False, False, False, 0, "", png21.ClientID, True)

                            DisplayFunctions.load_google_chart(graph_panel, graph24, "", "", "chart_div_tab24_all", 950, 500, "POINTS", 24, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, False, True, False, False, False, False, 0, "", png24.ClientID, True)

                            DisplayFunctions.load_google_chart(graph_panel, graph25, "", "", "chart_div_tab25_all", 950, 500, "POINTS", 25, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, True, True, False, False, False, False, 0, "", png25.ClientID, True)

                            DisplayFunctions.load_google_chart(graph_panel, graph26, "", "", "chart_div_tab26_all", 950, 500, "POINTS", 26, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, True, True, False, False, False, False, 0, "", png26.ClientID, True)

                            DisplayFunctions.load_google_chart(graph_panel, graph27, "", "", "chart_div_tab_Valuation1_all", 910, 485, "POINTS", 27, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, False, False, False, False, False, False, 0, "", pngValuation1.ClientID, True, 0, graph27_ticks_string)

                            DisplayFunctions.load_google_chart(graph_panel, graph28, "", "", "chart_div_tab_Valuation2_all", 910, 485, "POINTS", 28, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, False, False, False, False, False, False, 0, "", pngValuation2.ClientID, True, 0, graph28_ticks_string)

                            DisplayFunctions.load_google_chart(graph_panel, graph29, "", "", "chart_div_tab_Valuation3_all", 910, 485, "POINTS", 29, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, False, False, False, False, False, False, 0, "", pngValuation3.ClientID, True, 0, graph29_ticks_string)

                            If IsNumeric(Trim(Me.invisible_count_years.Text)) Then
                                DisplayFunctions.load_google_chart(graph_panel, graph30, "", "", "chart_div_tab_Valuation4_all", 910, 485, "POINTS", 30, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, False, False, False, False, False, False, 0, "", pngValuation4.ClientID, True, CInt(Trim(Me.invisible_count_years.Text)), graph30_ticks_string)
                            Else
                                DisplayFunctions.load_google_chart(graph_panel, graph30, "", "", "chart_div_tab_Valuation4_all", 910, 485, "POINTS", 30, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, False, False, False, False, False, False, 0, "", pngValuation4.ClientID, True, 0, graph30_ticks_string)
                            End If

                            DisplayFunctions.load_google_chart(graph_panel, graph31, "", "", "chart_div_tab_Valuation5_all", 910, 485, "POINTS", 31, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, False, False, False, False, False, False, 0, "", pngValuation5.ClientID, True, 0, graph31_ticks_string)




                            ' changed hide legend to be false 
                            DisplayFunctions.load_google_chart(graph_panel, graph32, "", "", "chart_div_tab32_all", 910, 295, "POINTS", 32, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, False, False, False, False, False, False, 0, "", png32.ClientID, True)


                            DisplayFunctions.load_google_chart(graph_panel, graph33, "", "", "chart_div_tab33_all", 950, 485, "POINTS", 33, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, False, True, False, False, False, False, 0, "", png33.ClientID, True)




                            Call load_google_chart_all(charting_string)
                            If Trim(View_Type) = 997 Then
                            Else
                                MR_LOCATIONS.Visible = True
                                MR_MARKET_CHARACTERISTICS.Visible = True
                            End If

                            guage_string = ""
                            Call NEW_Build_FleetMarketSummary(NEW_PDF_AMOD_ID, False, real_make_model_name, "", "N", guage_string, localCriteria)

                            Dim googleGraph As String = ""
                            BuildMarketCharacteristicsChart(Graph22, Graph23)
                            DisplayFunctions.load_google_chart(graph_panel, Graph22, "", "", "chart_div_tab22_all", 950, 500, "POINTS", 22, googleGraph, Me.Page, Me.graph_update_panel, False, True, True, False, True, True, False, False, False, False, 0, "", png22.ClientID, True)
                            DisplayFunctions.load_google_chart(graph_panel, Graph23, "", "", "chart_div_tab23_all", 950, 500, "POINTS", 23, googleGraph, Me.Page, Me.graph_update_panel, False, True, True, False, True, True, False, False, False, False, 0, "", png23.ClientID, True)
                            loadMarketScript(googleGraph)


                            month_timeframe.Attributes.Add("onchange", "SetLoadingText('Changing Report Options..');$('#" & attentionLabel.ClientID & "').text('');" & middleScript & ";$('body').addClass('loading');$('#" & btnRunReport.ClientID & "').addClass('display_none');")
                            'System.Web.UI.ScriptManager.RegisterStartupScript(Me, Me.GetType(), "Loading", "<script type=""text/javascript"">function SetLoadingText(textToSet) {$('#" & loadingText.ClientID & "').text(textToSet);};</script>", False)

                            System.Web.UI.ScriptManager.RegisterStartupScript(Me.graph_update_panel, Me.GetType(), "GoogleChart1Tab3", "<script type=""text/javascript"">" & guage_string & "</script>", False)

                            System.Web.UI.ScriptManager.RegisterStartupScript(Me.graph_update_panel, Me.GetType(), "GoogleChart1Tab2", "<script type=""text/javascript"">initGauge_AbsorptionRate();initGauge_US();initGauge_Foreign();</script>", False)


                            ''''''''''''''''''''

                            'commonEvo.model_operational_trends_graph(NEW_PDF_AMOD_ID, htmlOperationalTrendsFunctionScript, htmlOperationalTrendsGraph, 2, True, Nothing)

                            '    If Not String.IsNullOrEmpty(htmlOperationalTrendsFunctionScript.Trim) Then

                            '        htmlOperationalTrendsGraphScript = vbCrLf + "<script type=""text/javascript"">" + vbCrLf
                            '        htmlOperationalTrendsGraphScript += " drawVisualization2();" + vbCrLf
                            '        htmlOperationalTrendsGraphScript += Replace(Replace(htmlOperationalTrendsFunctionScript.Trim, "visualization2", "visualization20"), "ctl00_ContentPlaceHolder1_png20", "png20")
                            '        htmlOperationalTrendsGraphScript += "</script>" + vbCrLf

                            '        System.Web.UI.ScriptManager.RegisterStartupScript(Me.graph_update_panel, Me.GetType(), "showOperationalTrendsGraph2", htmlOperationalTrendsGraphScript, False)

                            '    End If



                            guage_string = ""
                            Call NEW_Build_MarketStatus(NEW_PDF_AMOD_ID, False, real_make_model_name, "", "N", guage_string, localCriteria)

                            '   guage_string = Replace(guage_string, "initGauge_AbsorptionRate", "initGauge_AvgAsking")
                            '  guage_string = Replace(guage_string, "scripted-gauge'", "scripted-gauge2'")
                            '  guage_string = Replace(guage_string, "ctl00_ContentPlaceHolder1_pngGuage1", "ctl00_ContentPlaceHolder1_pngGuage2")


                            System.Web.UI.ScriptManager.RegisterStartupScript(Me.graph_update_panel, Me.GetType(), "GoogleChart1Tab4", "<script type=""text/javascript"">" & guage_string & "</script>", False)

                            System.Web.UI.ScriptManager.RegisterStartupScript(Me.graph_update_panel, Me.GetType(), "GoogleChart1Tab5", "<script type=""text/javascript"">" & IIf(NEW_PDF_AMOD_ID > 0, "initGauge_AvgAsking()", "") & ";initGauge_AvgSale();initGauge_LengthOfOwnership();initGauge_LengthOfOwnershipPreOwned();initGauge_DaysOnMarket();</script>", False)

                            guage_string = ""
                            BuildFeaturesGauge(guage_string, localCriteria)
                            ' BuildProgramGauge(guage_string, localCriteria)
                            System.Web.UI.ScriptManager.RegisterStartupScript(Me.graph_update_panel, Me.GetType(), "FeaturesGauge", "<script type= ""text/javascript"">" & guage_string & ";initGauge_Features();</script>", False)


                            ' THIS WORK, JUST DOING IT OVER AGAIN 
                            'guage_string = ""
                            'guage_string &= "  Function initGauge2() { "
                            'guage_string &= "  var gauge2 = New RadialGauge({"
                            'guage_string &= "renderTo:  'scripted-gauge2',"
                            'guage_string &= "width: 400,"
                            'guage_string &= "height: 300,"
                            'guage_string &= "units: ""Days"","
                            'guage_string &= " fontTitleSize: 18,"
                            'guage_string &= "title: ""Avg Days on Market"","
                            'guage_string &= " minValue: 0,"
                            'guage_string &= " startAngle: 90,"
                            'guage_string &= " ticksAngle: 180,"
                            'guage_string &= "  valueBox: false,"
                            'guage_string &= " maxValue: 220,"
                            'guage_string &= " majorTicks: ["
                            'guage_string &= """0"","
                            'guage_string &= """20"","
                            'guage_string &= """40"","
                            'guage_string &= """60"","
                            'guage_string &= " ""80"","
                            'guage_string &= """100"","
                            'guage_string &= """120"","
                            'guage_string &= """140"","
                            'guage_string &= " ""160"","
                            'guage_string &= """180"","
                            'guage_string &= " ""200"","
                            'guage_string &= " ""220"","
                            'guage_string &= " ""240"""
                            'guage_string &= " ],"
                            'guage_string &= " minorTicks: 2,"
                            'guage_string &= " strokeTicks: true,"
                            'guage_string &= " highlights: ["
                            'guage_string &= " {"
                            'guage_string &= "   ""from"": 160,"
                            'guage_string &= "   ""to"": 220,"
                            'guage_string &= "    ""color"": ""rgba(255, 50, 50, .75)"""
                            'guage_string &= "  },"
                            'guage_string &= "	{"
                            'guage_string &= " ""from"": 0,"
                            'guage_string &= " ""to"": 90,"
                            'guage_string &= "  ""color"": ""rgba(50, 200, 50, .75)"""
                            'guage_string &= "},"
                            'guage_string &= "	{"
                            'guage_string &= "  ""from"": 90,"
                            'guage_string &= "  ""to"": 160,"
                            'guage_string &= "  ""color"": ""rgba(255, 255, 0, .75)"""
                            'guage_string &= "	}"
                            'guage_string &= "  ],"
                            'guage_string &= "  colorPlate: ""#fff"","
                            'guage_string &= "colorMajorTicks:  '#2a62aa',"
                            'guage_string &= "colorTitle:  '#2a62aa',"
                            'guage_string &= "colorNumbers:  '#1d3566',"
                            'guage_string &= "colorNeedle:  '#1d3566',"
                            'guage_string &= "colorNeedleEnd:  '#2a62aa',"
                            'guage_string &= "    borderShadowWidth: 0,"
                            'guage_string &= "    borders: false,"
                            'guage_string &= "    needleType: ""arrow"","
                            'guage_string &= "   needleWidth: 2,"
                            'guage_string &= "  needleCircleSize: 7,"
                            'guage_string &= "  needleCircleOuter: true,"
                            'guage_string &= "  needleCircleInner: false,"
                            'guage_string &= " animationDuration: 1500,"
                            'guage_string &= "  value: 80,"
                            'guage_string &= "  animationRule: ""linear"""
                            'guage_string &= "}).draw();"
                            'guage_string &= " }"

                            'System.Web.UI.ScriptManager.RegisterStartupScript(Me.graph_update_panel, Me.GetType(), "GoogleChart1Tab4", "<script type=""text/javascript"">" & guage_string & "</script>", False)


                            'System.Web.UI.ScriptManager.RegisterStartupScript(Me.graph_update_panel, Me.GetType(), "GoogleChart1Tab5", "<script type=""text/javascript"">initGauge2();</script>", False)
                            System.Web.UI.ScriptManager.RegisterStartupScript(Me.graph_update_panel, Me.GetType(), "ToggleHidden", "<script type=""text/javascript"">$(""body"").removeClass(""loading"");</script>", False)

                        End If
                    End If

                End If



                If utilizationGraphs.Checked = True And utilizationGraphs.Visible = True Then

                    '-----------------------------------------------------------------------------------
                    If amod_id > 0 Then
                        amod_id_list = amod_id ' to be changed later 
                    End If

                    aport_id = Trim(Request("aport_id"))

                    ' added MSW to check if usa 
                    Call Get_Airport_Name_Country(aport_id, is_aport_us, aport_name)

                    localCriteria.ViewCriteriaAmodID = amod_id
                    localCriteria.ViewCriteriaTimeSpan = 6
                    WD.Items.Remove(WD.Items.FindByValue("Word"))

                    ' pick up the company from "view page selections"
                    If Not IsNothing(Request.Item("viewCompany")) Then
                        If Not String.IsNullOrEmpty(Request.Item("viewCompany").ToString) Then
                            localCriteria.ViewCriteriaCompanyID = CLng(Request.Item("viewCompany").ToString.Trim)
                        Else
                            localCriteria.ViewCriteriaCompanyID = 0
                        End If
                    Else
                        localCriteria.ViewCriteriaCompanyID = 0
                    End If

                    NEW_PDF_AMOD_ID = amod_id
                    Session("Last_FAA_DATE") = Session.Item("localSubscription").crmSubinst_FAA_data_date

                    util_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
                    util_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
                    util_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
                    util_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
                    util_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim
                    util_functions.Airport_ID_OVERALL = aport_id
                    util_functions.airport_direction = origin_or_dest


                    If Trim(Request("start_date")) <> "" Then
                        start_date.Text = Trim(Request("start_date"))
                        localCriteria.ViewCriteriaDocumentsStartDate = start_date.Text
                    Else

                        If Trim(Request("months")) <> "" Then
                            localCriteria.ViewCriteriaTimeSpan = Trim(Request("months"))
                        Else
                            localCriteria.ViewCriteriaTimeSpan = 6
                        End If

                        ' will need to change when you bring over custom 
                        localCriteria.ViewCriteriaDocumentsStartDate = FormatDateTime(DateAdd(DateInterval.Month, -localCriteria.ViewCriteriaTimeSpan, Now()), DateFormat.ShortDate)

                    End If

                    If Trim(Request("end_date")) <> "" Then
                        end_date.Text = Trim(Request("end_date"))
                        localCriteria.ViewCriteriaDocumentsEndDate = end_date.Text
                    Else
                        If Trim(Request("months")) <> "" Then
                            localCriteria.ViewCriteriaTimeSpan = Trim(Request("months"))
                        Else
                            localCriteria.ViewCriteriaTimeSpan = 6
                        End If

                        ' will need to change when you bring over custom 

                        localCriteria.ViewCriteriaDocumentsEndDate = FormatDateTime(Now(), DateFormat.ShortDate)
                    End If

                    ' pc is for business, commercial and helicopter, pc2 is for jets, turbo props etc
                    If Not IsNothing(Request.Item("pc")) Then
                        If Not String.IsNullOrEmpty(Request.Item("pc").ToString) Then
                            selected_product_code_from_drop_down = Request("pc").ToString
                            If selected_product_code_from_drop_down.ToString.Trim = "1" Then
                                selected_product_code_from_drop_down = "B"
                                localCriteria.ViewCriteriaHasBusinessFlag = True
                            ElseIf selected_product_code_from_drop_down.ToString.Trim = "2" Then
                                selected_product_code_from_drop_down = "C"
                                localCriteria.ViewCriteriaHasCommercialFlag = True
                            ElseIf selected_product_code_from_drop_down.ToString.Trim = "3" Then
                                selected_product_code_from_drop_down = "H"
                                localCriteria.ViewCriteriaHasHelicopterFlag = True
                            ElseIf selected_product_code_from_drop_down.ToString.Trim = "B" Then
                                selected_product_code_from_drop_down = "B"
                                localCriteria.ViewCriteriaHasBusinessFlag = True
                            ElseIf selected_product_code_from_drop_down.ToString.Trim = "C" Then
                                selected_product_code_from_drop_down = "C"
                                localCriteria.ViewCriteriaHasCommercialFlag = True
                            ElseIf selected_product_code_from_drop_down.ToString.Trim = "H" Then
                                selected_product_code_from_drop_down = "H"
                                localCriteria.ViewCriteriaHasHelicopterFlag = True
                            ElseIf selected_product_code_from_drop_down.ToString.Trim = "B,C" Then
                                selected_product_code_from_drop_down = "B,C"
                                localCriteria.ViewCriteriaHasBusinessFlag = True
                                localCriteria.ViewCriteriaHasCommercialFlag = True
                            ElseIf selected_product_code_from_drop_down.ToString.Trim = "B,H" Then
                                selected_product_code_from_drop_down = "B,H"
                                localCriteria.ViewCriteriaHasHelicopterFlag = True
                                localCriteria.ViewCriteriaHasBusinessFlag = True
                            ElseIf selected_product_code_from_drop_down.ToString.Trim = "C,H" Then
                                selected_product_code_from_drop_down = "C,H"
                                localCriteria.ViewCriteriaHasCommercialFlag = True
                                localCriteria.ViewCriteriaHasHelicopterFlag = True
                            End If '
                        End If ' 

                    Else
                        If Session.Item("localPreferences").UserBusinessFlag Then
                            localCriteria.ViewCriteriaHasBusinessFlag = True
                        End If

                        If Session.Item("localPreferences").UserHelicopterFlag Then
                            localCriteria.ViewCriteriaHasHelicopterFlag = True
                        End If

                        If Session.Item("localPreferences").UserCommercialFlag Then
                            localCriteria.ViewCriteriaHasCommercialFlag = True
                        End If
                    End If

                    If utilizationInternational.Checked = True Then
                        localCriteria.ViewCriteriaContinent = "International"
                    End If

                    If Trim(amod_id_list) <> "" Then
                        localCriteria.ViewCriteriaAmodIDArray = Split(amod_id_list, ",")
                        localCriteria.ViewCriteriaAmodID = -1
                    ElseIf amod_id > 0 Then
                        localCriteria.ViewCriteriaAmodID = amod_id
                        localCriteria.ViewCriteriaAmodIDArray = Nothing
                    Else
                        localCriteria.ViewCriteriaAmodID = -1
                        localCriteria.ViewCriteriaAmodIDArray = Nothing
                    End If
                    '-----------------------------------------------------------------------------------

                    ' if it is us airport, check the states 
                    If utilization_state_check.Visible = False And utilization_state_check.Checked = False Then
                        If is_aport_us = True Then
                            utilization_state_check.Checked = True
                            utilization_state_check.Visible = True
                        End If
                    End If

                    Call util_functions.get_flight_profile_top_function(localCriteria, chart_string, "Month", Session("Last_FAA_DATE"), "", "pdf4")
                    chart_string = Replace(chart_string, "data1.", "data4.")

                    DisplayFunctions.load_google_chart(graph_panel, chart_string, "", "", "chart_div_tab4_all", 910, 485, "POINTS", 4, charting_string, Me.Page, Me.graph_update_panel, False, True, False, False, True, True, False, False, False, False, 0, "", png4.ClientID, True)


                    Call util_functions.views_display_operator_piechart(localCriteria, "country_continent_name", "", 6, chart_string, Session("Last_FAA_DATE"), aport_id, 0, "", 0, total_flights_count)

                    If utilization_state_check.Visible = True And utilization_state_check.Checked = True Then
                        Call util_functions.views_display_operator_piechart(localCriteria, "state_name", "", 6, chart_string, Session("Last_FAA_DATE"), aport_id, 0, "", 0)
                    Else
                        Call util_functions.views_display_operator_piechart(localCriteria, "country_continent_name", "", 6, chart_string, Session("Last_FAA_DATE"), aport_id, 0, "", 0)
                    End If


                    DisplayFunctions.load_google_chart(graph_panel, chart_string, "", "", "chart_div_tab6_all", 910, 910, "POINTS", 6, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, False, False, False, False, False, True, 0, "", png6.ClientID)



                    Call util_functions.views_display_operator_piechart(localCriteria, "cbus_name", "", 5, chart_string, Session("Last_FAA_DATE"), aport_id, 0, "", 0, total_flights_count)

                    DisplayFunctions.load_google_chart(graph_panel, chart_string, "", "", "chart_div_tab5_all", 910, 910, "POINTS", 5, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, True, True, False, False, False, False, 0, "", png5.ClientID, True)


                    Call util_functions.views_display_operator_piechart(localCriteria, "comp_country", "", 7, chart_string, Session("Last_FAA_DATE"), aport_id, 0, "", 0, total_flights_count)

                    DisplayFunctions.load_google_chart(graph_panel, chart_string, "", "", "chart_div_tab7_all", 910, 910, "POINTS", 7, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, True, True, False, False, False, False, 0, "", png7.ClientID, True)

                    Call util_functions.views_display_operator_piechart(localCriteria, "comp_name", "", 18, chart_string, Session("Last_FAA_DATE"), aport_id, 0, "", 0, total_flights_count)

                    DisplayFunctions.load_google_chart(graph_panel, chart_string, "", "", "chart_div_tab18_all", 910, 910, "POINTS", 18, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, True, True, False, False, False, False, 0, "", png18.ClientID, True)


                    '------------ AIRPORTS SECTION------------------------------------
                    Call util_functions.views_display_routes_piechart(localCriteria, "aport_country", 8, chart_string, aport_id, "", 0, "", "", False, "")

                    DisplayFunctions.load_google_chart(graph_panel, chart_string, "", "", "chart_div_tab8_all", 915, 910, "POINTS", 8, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, True, True, False, False, False, False, 0, "", png8.ClientID, True)


                    If utilization_state_check.Visible = True And utilization_state_check.Checked = True Then
                        Call util_functions.views_display_routes_piechart(localCriteria, "state_name", 9, chart_string, aport_id, "", 0, "", "", False, "")
                    Else
                        Call util_functions.views_display_routes_piechart(localCriteria, "country_continent_name", 9, chart_string, aport_id, "", 0, "", "", False, "")
                    End If

                    DisplayFunctions.load_google_chart(graph_panel, chart_string, "", "", "chart_div_tab9_all", 915, 910, "POINTS", 9, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, False, False, False, False, False, True, 0, "", png9.ClientID)

                    Call util_functions.views_display_routes_piechart(localCriteria, "aport_icao_code", 16, chart_string, aport_id, "", 0, "", "", False, "")

                    DisplayFunctions.load_google_chart(graph_panel, chart_string, "", "", "chart_div_tab16_all", 915, 410, "POINTS", 16, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, True, True, False, False, False, False, 0, "", png16.ClientID, True)



                    '---------- TOP MODELS SECTION--------------------------
                    Call util_functions.views_display_top_model_piechart(localCriteria, "acwgtcls_name", 10, chart_string, aport_id, "", 0, "", "", False, "")

                    DisplayFunctions.load_google_chart(graph_panel, chart_string, "", "", "chart_div_tab10_all", 910, 910, "POINTS", 10, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, False, False, False, False, False, True, 0, "", png10.ClientID)

                    Call util_functions.views_display_top_model_piechart(localCriteria, "amjiqs_cat_desc", 11, chart_string, aport_id, "", 0, "", "", False, "")

                    DisplayFunctions.load_google_chart(graph_panel, chart_string, "", "", "chart_div_tab11_all", 910, 910, "POINTS", 11, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, True, True, False, False, False, False, 0, "", png11.ClientID, True)

                    Call util_functions.views_display_top_model_piechart(localCriteria, "amod_model_name", 17, chart_string, aport_id, "", 0, "", "", False, "")

                    DisplayFunctions.load_google_chart(graph_panel, chart_string, "", "", "chart_div_tab17_all", 910, 410, "POINTS", 17, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, True, True, False, False, False, False, 0, "", png17.ClientID, True)



                    '---- AIRCRAFT SECTION ----------------------------
                    Call util_functions.views_display_top_ac_piechart(localCriteria, "amod_number_of_passengers", 13, chart_string, aport_id, "", 0, "", "", False, "")

                    DisplayFunctions.load_google_chart(graph_panel, chart_string, "", "", "chart_div_tab13_all", 910, 910, "POINTS", 13, charting_string, Me.Page, Me.graph_update_panel, False, True, False, False, True, True, False, False, False, False, 0, "", png13.ClientID, True)


                    Call util_functions.views_display_top_ac_piechart(localCriteria, "amod_number_of_crew", 14, chart_string, aport_id, "", 0, "", "", False, "")

                    DisplayFunctions.load_google_chart(graph_panel, chart_string, "", "", "chart_div_tab14_all", 910, 910, "POINTS", 14, charting_string, Me.Page, Me.graph_update_panel, False, True, True, False, True, True, False, False, False, False, 0, "", png14.ClientID, True)

                    Call util_functions.views_display_top_ac_piechart(localCriteria, "ac_reg_no", 19, chart_string, aport_id, "", 0, "", "", False, "")

                    DisplayFunctions.load_google_chart(graph_panel, chart_string, "", "", "chart_div_tab19_all", 910, 410, "POINTS", 19, charting_string, Me.Page, Me.graph_update_panel, False, True, False, False, True, True, False, False, False, False, 0, "", png19.ClientID, True)

                    Call load_google_chart_all(charting_string)

                    System.Web.UI.ScriptManager.RegisterStartupScript(Me.graph_update_panel, Me.GetType(), "ToggleHidden", "<script type=""text/javascript"">$(""body"").removeClass(""loading"");</script>", False)
                End If


                If Trim(Request("test_pic")) = "1" Then
                    Dim ac_image_file As String = HttpContext.Current.Server.MapPath("pictures\aircraft\") & "3297-0-205230.jpg"
                    Response.Write("<Br>Desired Size of Image: 640 x 480- ")
                    Response.Write(ac_image_file)
                    Dim zimage2 As System.Drawing.Image
                    Dim temp_height As Integer = 0
                    Dim temp_width As Integer = 0
                    zimage2 = System.Drawing.Image.FromFile(ac_image_file)
                    temp_width = zimage2.Width
                    temp_height = zimage2.Height
                    Response.Write("<Br>ACTUAL WIDTH:" & temp_width)
                    Response.Write("<Br>ACTUAL HEGIHT:" & temp_height)
                End If
            End If
        End If
    End Sub
    Public Sub get_time_values()

        ' added msww - 2/9/18 - needed to pass in the value from the view , only set the drop down on the page load  
        If Not Page.IsPostBack Then
            If Not IsNothing(Trim(Request("selectViewTimeSpan"))) Then
                If Not String.IsNullOrEmpty(Trim(Request("selectViewTimeSpan")).ToString) Then
                    Try
                        If IsNumeric(Trim(Request("selectViewTimeSpan"))) Then
                            If Trim(Request("selectViewTimeSpan")) > 24 Then
                                Me.month_timeframe.SelectedValue = 24
                                attentionLabel.Text = "Note that the maximum timeframe for this report is 2 years."
                            Else
                                Me.month_timeframe.SelectedValue = Trim(Request("selectViewTimeSpan"))
                            End If
                        End If
                    Catch ex As Exception
                        Me.month_timeframe.SelectedValue = 24
                        attentionLabel.Text = "Note that the maximum timeframe for this report is 2 years."
                    End Try
                ElseIf Not IsNothing(Trim(Request("selectMarketTimeSpan"))) Then
                    If Not String.IsNullOrEmpty(Trim(Request("selectMarketTimeSpan")).ToString) Then
                        Try
                            If IsNumeric(Trim(Request("selectMarketTimeSpan"))) Then
                                If Trim(Request("selectMarketTimeSpan")) > 24 Then
                                    Me.month_timeframe.SelectedValue = 24
                                    attentionLabel.Text = "Note that the maximum timeframe for this report is 2 years."
                                Else
                                    Me.month_timeframe.SelectedValue = Trim(Request("selectMarketTimeSpan"))
                                End If
                            End If
                        Catch ex As Exception
                            Me.month_timeframe.SelectedValue = 24
                            attentionLabel.Text = "Note that the maximum timeframe for this report is 2 years."
                        End Try
                    End If
                End If
            ElseIf Not IsNothing(Trim(Request("selectMarketTimeSpan"))) Then
                If Not String.IsNullOrEmpty(Trim(Request("selectMarketTimeSpan")).ToString) Then
                    Try
                        If IsNumeric(Trim(Request("selectMarketTimeSpan"))) Then
                            If Trim(Request("selectMarketTimeSpan")) > 24 Then
                                Me.month_timeframe.SelectedValue = 24
                                attentionLabel.Text = "Note that the maximum timeframe for this report is 2 years."
                            Else
                                Me.month_timeframe.SelectedValue = Trim(Request("selectMarketTimeSpan"))
                            End If
                        End If
                    Catch ex As Exception
                        Me.month_timeframe.SelectedValue = 24
                        attentionLabel.Text = "Note that the maximum timeframe for this report is 2 years."
                    End Try
                End If
            End If




        End If

        localCriteria.ViewCriteriaTimeSpan = Trim(month_timeframe.SelectedValue.ToString.Trim)

        localCriteria.ViewCriteriaDocumentsStartDate = FormatDateTime(DateAdd(DateInterval.Month, -localCriteria.ViewCriteriaTimeSpan, Now()), DateFormat.ShortDate)
        localCriteria.ViewCriteriaDocumentsEndDate = FormatDateTime(Now(), DateFormat.ShortDate)

    End Sub

    Public Sub RangeOfModel(ByRef searchCriteria As viewSelectionCriteriaClass, ByRef fieldLength As Double)
        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader : SqlReader = Nothing
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing
        Dim sql As String = ""

        Try

            sql = "select amod_range_tanks_full, amod_max_range_miles,amod_airframe_type_code,amod_field_length from aircraft_model where amod_id = " & searchCriteria.ViewCriteriaAmodID

            clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            SqlConn.Open()
            SqlCommand.Connection = SqlConn

            SqlCommand.CommandText = sql
            SqlReader = SqlCommand.ExecuteReader()
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 60

            If SqlReader.HasRows Then
                SqlReader.Read()
                searchCriteria.ViewCriteriaAircraftRange = SqlReader("amod_max_range_miles")
                searchCriteria.ViewCriteriaHeliRangeTanksFull = SqlReader("amod_range_tanks_full")
                searchCriteria.ViewCriteriaAirframeTypeStr = SqlReader("amod_airframe_type_code")
                fieldLength = SqlReader("amod_field_length")
            End If

            Select Case (searchCriteria.ViewCriteriaAirframeTypeStr)
                Case Constants.AMOD_TYPE_AIRLINER
                    localCriteria.ViewCriteriaAirframeType = Constants.VIEW_EXECUTIVE
                Case Constants.AMOD_TYPE_JET
                    localCriteria.ViewCriteriaAirframeType = Constants.VIEW_JETS
                Case Constants.AMOD_TYPE_TURBO
                    Select Case (searchCriteria.ViewCriteriaAirframeTypeStr)
                        Case Constants.AMOD_FIXED_AIRFRAME
                            localCriteria.ViewCriteriaAirframeType = Constants.VIEW_TURBOPROPS
                        Case Constants.AMOD_ROTARY_AIRFRAME
                            localCriteria.ViewCriteriaAirframeType = Constants.VIEW_HELICOPTERS

                    End Select
                Case Constants.AMOD_TYPE_PISTON
                    Select Case (searchCriteria.ViewCriteriaAirframeTypeStr)
                        Case Constants.AMOD_FIXED_AIRFRAME
                            localCriteria.ViewCriteriaAirframeType = Constants.VIEW_PISTONS
                        Case Constants.AMOD_ROTARY_AIRFRAME
                            localCriteria.ViewCriteriaAirframeType = Constants.VIEW_HELICOPTERS
                    End Select
            End Select



            SqlReader.Close()

        Catch ex As Exception
        Finally
            SqlReader = Nothing

            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing

        End Try

    End Sub

    Public Sub SetUpJavascriptOnClickGoogleGraph_28()
        Dim jScript As String = ""
        jScript = ""
        jScript = "$(""#" & btnRunReport.ClientID & """).click(function() {"
        jScript += "$(""#" & valueGraphText4.ClientID & """).val($('#" & png4.ClientID & " img').prop('src'));"

        'operator pie charts 
        jScript += "$(""#" & valueGraphText5.ClientID & """).val($('#" & png5.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valueGraphText6.ClientID & """).val($('#" & png6.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valueGraphText7.ClientID & """).val($('#" & png7.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valueGraphText18.ClientID & """).val($('#" & png18.ClientID & " img').prop('src'));"

        ' routes section 
        jScript += "$(""#" & valueGraphText8.ClientID & """).val($('#" & png8.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valueGraphText9.ClientID & """).val($('#" & png9.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valueGraphText16.ClientID & """).val($('#" & png16.ClientID & " img').prop('src'));"

        ' models section 
        jScript += "$(""#" & valueGraphText10.ClientID & """).val($('#" & png10.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valueGraphText11.ClientID & """).val($('#" & png11.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valueGraphText17.ClientID & """).val($('#" & png17.ClientID & " img').prop('src'));"
        '  jScript += "$(""#" & valueGraphText12.ClientID & """).val($('#" & png12.ClientID & " img').prop('src'));"


        ' aircraft section 
        jScript += "$(""#" & valueGraphText13.ClientID & """).val($('#" & png13.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valueGraphText14.ClientID & """).val($('#" & png14.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valueGraphText15.ClientID & """).val($('#" & png15.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valueGraphText19.ClientID & """).val($('#" & png19.ClientID & " img').prop('src'));"


        ' extras to be organized later   


        jScript += "});"
        System.Web.UI.ScriptManager.RegisterStartupScript(Me, Me.GetType(), "btnReportOnClickEvent", jScript.ToString, True)
    End Sub



    Public Sub loadMarketScript(ByVal string_from_charts As String)
        Dim GoogleChart1TabScript As StringBuilder = New StringBuilder()

        Dim temp_string As String = ""
        Dim label_script As New Label
        Dim chart_label As New Label

        'temp_string = "<script type=""text/javascript"">"
        temp_string &= "google.charts.setOnLoadCallback(function() {"
        temp_string &= "drawChartsMarketChar();"

        temp_string &= "function drawChartsMarketChar() {"
        temp_string &= string_from_charts
        temp_string &= "} "
        temp_string &= "});"
        'temp_string &= "</script>"


        If Not Page.ClientScript.IsClientScriptBlockRegistered("loadMarketChar") Then
            GoogleChart1TabScript.Append(temp_string)
            System.Web.UI.ScriptManager.RegisterStartupScript(Me.graph_update_panel, Me.GetType(), "loadMarketChar", GoogleChart1TabScript.ToString, True)
        End If


    End Sub

    Public Sub load_google_chart_all(ByVal string_from_charts As String)
        Dim GoogleChart1TabScript As StringBuilder = New StringBuilder()

        Dim temp_string As String = ""
        Dim label_script As New Label
        Dim chart_label As New Label



        temp_string &= "google.charts.setOnLoadCallback(function() {"
        temp_string &= "drawCharts();"


        temp_string &= "function drawCharts() {"

        temp_string &= string_from_charts

        temp_string &= " } "
        temp_string &= "}); "
        'temp_string &= "alert(document.getElementById('" & div_name & "'));"



        label_script.ID = "label_script"
        label_script.Text = temp_string


        'tab_to_add_to.Controls.AddAt(0, label_script)


        If Not Page.ClientScript.IsClientScriptBlockRegistered("GoogleChart1Tab") Then
            GoogleChart1TabScript.Append(temp_string)

            System.Web.UI.ScriptManager.RegisterStartupScript(Me.graph_update_panel, Me.GetType(), "GoogleChart1Tab", GoogleChart1TabScript.ToString, True)
        End If


    End Sub

    Protected Sub All_Button_Clicked(ByVal sender As Object, ByVal e As EventArgs) Handles select_all_types_button.Click
        Dim amod_id As Integer = 0
        Dim comp_id As Integer = 0
        Dim COMP_NAME As String = ""
        Dim TYPE_OF_AC As String = ""
        Dim View_Type As Integer = 0
        Dim airframe_type As String = ""
        Dim i As Integer = 0
        Dim subs_id As Integer = 0
        Dim real_city_name As String = ""
        Dim real_country_name As String = ""
        Dim selected_product_code_from_drop_down As String = ""
        Dim make_name As String = ""
        Session.Item("localPreferences").DefaultCurrency = 9 ' us dollar
        Dim sProductList() As eProductCodeTypes = Nothing
        Dim temp_test As String = ""
        Dim engine_name As String = ""
        ' This section gets all of the request variables and sets them to local variables to display on the screen
        Dim current_spi_year As Integer = 0
        Dim model_weight As String = ""
        Dim model_weight_name As String = ""
        Dim current_spi_year2 As Integer = 0
        Dim months_count As Integer = 0
        Dim real_make_model_name2 As String = ""
        Dim real_make_model_name3 As String = ""
        Dim amod_id2 As Integer = 0
        Dim amod_id3 As Integer = 0



        If Not IsNothing(Request.Item("weight")) Then
            If Not String.IsNullOrEmpty(Request.Item("weight").ToString) Then
                model_weight = Request("weight").ToString
            End If '
        End If

        If Not IsNothing(Request.Item("weight_name")) Then
            If Not String.IsNullOrEmpty(Request.Item("weight_name").ToString) Then
                model_weight_name = Request("weight_name").ToString
            End If '
        End If

        If Not IsNothing(Request.Item("year")) Then
            If Not String.IsNullOrEmpty(Request.Item("year").ToString) Then
                current_spi_year = Request("year").ToString
            End If '
        End If

        If Not IsNothing(Request.Item("year2")) Then
            If Not String.IsNullOrEmpty(Request.Item("year2").ToString) Then
                current_spi_year2 = Request("year2").ToString
            End If '
        End If


        Dim fSubins_platform_os As String = commonEvo.getBrowserCapabilities(Request.Browser)


        Dim sErrorString As String = ""

        If Not Session.Item("localPreferences").loadUserSession(Me.Application, Me.Session, sErrorString, CLng(Session.Item("localUser").crmSubSubID.ToString), Session.Item("localUser").crmUserLogin.ToString, CLng(Session.Item("localUser").crmSubSeqNo.ToString), CLng(Session.Item("localUser").crmUserContactID.ToString)) Then
            Response.Write("error in load preferences : " + sErrorString)
        End If

        ' call the Get_Model_Name funciton
        If Not IsNothing(Request.Item("amod_id")) Then
            If Not String.IsNullOrEmpty(Request.Item("amod_id").ToString) Then
                amod_id = CLng(Request("amod_id").ToString)
            End If
        End If

        If Not IsNothing(Request.Item("months")) Then
            If Not String.IsNullOrEmpty(Request.Item("months").ToString) Then
                months_count = Request("months").ToString
            End If '
        End If

        ' This is used to show the metric/us standard on other page
        If Session.Item("show_cost_values") = "" Then
            Session.Item("show_cost_values") = "Yes"
        End If

        If Not IsNothing(Request.Item("standardormetric")) Then
            If Not String.IsNullOrEmpty(Request.Item("standardormetric").ToString) Then
                Session.Item("localPreferences").UseStandardOrMetric = Request.Item("standardormetric").Trim.ToLower
            Else
                Session.Item("localPreferences").UseStandardOrMetric = "standard"
            End If
        Else
            Session.Item("localPreferences").UseStandardOrMetric = "standard"
        End If

        For Each item As ListItem In useStandardOrMetric.Items
            If item.Value = Session.Item("localPreferences").UseStandardOrMetric Then
                item.Selected = True
                Exit For
            Else
                item.Selected = False
            End If
        Next

        Session.Item("localPreferences").DefaultCurrency = 9
        If Not IsNothing(Request.Item("currency")) Then
            If Not String.IsNullOrEmpty(Request.Item("currency").ToString) Then
                Session.Item("localPreferences").DefaultCurrency = Request.Item("currency").Trim
            End If
        End If


        If Not IsNothing(Request.Item("amod_id2")) Then
            If Not String.IsNullOrEmpty(Request.Item("amod_id2").ToString) Then
                amod_id2 = CLng(Request("amod_id2").ToString)
            End If
        End If

        If Not IsNothing(Request.Item("amod_id3")) Then
            If Not String.IsNullOrEmpty(Request.Item("amod_id3").ToString) Then
                amod_id3 = CLng(Request("amod_id3").ToString)
            End If
        End If
        If amod_id2 > 0 Then
            real_make_model_name2 = Get_Model_Name(amod_id2).ToString
        Else
        End If

        If amod_id3 > 0 Then
            real_make_model_name3 = Get_Model_Name(amod_id3).ToString
        Else
        End If

        ' call the Get_Model_Name funciton
        If Not IsNothing(Request.Item("make_name")) Then
            If Not String.IsNullOrEmpty(Request.Item("make_name").ToString) Then
                make_name = Request("make_name").ToString
            End If '
        End If

        ' call the Get_Model_Name funciton
        If Not IsNothing(Request.Item("comp_id")) Then
            If Not String.IsNullOrEmpty(Request.Item("comp_id").ToString) Then
                comp_id = CLng(Request("comp_id").ToString)
            End If '
        End If


        If Not IsNothing(Request.Item("viewID")) Then
            If Not String.IsNullOrEmpty(Request.Item("viewID").ToString) Then
                View_Type = Request("viewID")
            Else
                View_Type = 1
            End If '
        Else
            View_Type = 1
        End If


        If Not IsNothing(Request.Item("airframe_type")) Then
            If Not String.IsNullOrEmpty(Request.Item("airframe_type").ToString) Then
                airframe_type = Request("airframe_type").ToString
            End If
        End If


        If airframe_type.ToString.Trim = "F" Then
            airframe_type = "Fixed Wing Aircraft"
        ElseIf airframe_type.ToString.Trim = "R" Then
            airframe_type = "Rotary Wing Aircraft"
        End If

        If Not IsNothing(Request.Item("pc")) Then
            If Not String.IsNullOrEmpty(Request.Item("pc").ToString) Then
                selected_product_code_from_drop_down = Request("pc").ToString
                If selected_product_code_from_drop_down.ToString.Trim = "1" Then
                    selected_product_code_from_drop_down = "Business"
                ElseIf selected_product_code_from_drop_down.ToString.Trim = "2" Then
                    selected_product_code_from_drop_down = "Commercial"
                ElseIf selected_product_code_from_drop_down.ToString.Trim = "3" Then
                    selected_product_code_from_drop_down = "Helicopters"
                ElseIf selected_product_code_from_drop_down.ToString.Trim = "B" Then
                    selected_product_code_from_drop_down = "Business"
                ElseIf selected_product_code_from_drop_down.ToString.Trim = "C" Then
                    selected_product_code_from_drop_down = "Commercial"
                ElseIf selected_product_code_from_drop_down.ToString.Trim = "H" Then
                    selected_product_code_from_drop_down = "Helicopters"
                End If

            End If
        End If

        If Not IsNothing(Request.Item("engine")) Then
            If Not String.IsNullOrEmpty(Request.Item("engine").ToString) Then
                engine_name = Request("engine").ToString
            End If '
        End If


        If amod_id > 0 Then
            TYPE_OF_AC = Get_Model_Name(amod_id).ToString
        End If

        Session.Item("fuelPriceBase") = Get_Fuel_Price()

        If comp_id > 0 Then
            'COMP_NAME = commonEVO.get_company_name_fromID(comp_id, 0, False)
            COMP_NAME = get_company_name(comp_id).ToString
        End If

        If Not IsNothing(Request.Item("city")) Then
            If Not String.IsNullOrEmpty(Request.Item("city").ToString) Then
                real_city_name = Request("city").ToString
            End If '
        End If

        If Not IsNothing(Request.Item("country")) Then
            If Not String.IsNullOrEmpty(Request.Item("country").ToString) Then
                real_country_name = Request("country").ToString
            End If ''
        End If


        all_pdf = True

        If Me.Lease_View_PDF.Checked = True Then
            Build_PDF_Form_Final(13, COMP_NAME, TYPE_OF_AC, real_country_name, real_city_name, airframe_type, engine_name, selected_product_code_from_drop_down, current_spi_year, current_spi_year2, model_weight_name, make_name, months_count, real_make_model_name2, real_make_model_name3)
        End If

        If Me.Operator_View_PDF.Checked = True Then
            Build_PDF_Form_Final(3, COMP_NAME, TYPE_OF_AC, real_country_name, real_city_name, airframe_type, engine_name, selected_product_code_from_drop_down, current_spi_year, current_spi_year2, model_weight_name, make_name, months_count, real_make_model_name2, real_make_model_name3)
        End If

        Me.btnRunReport.Visible = True
        Me.btnRunReport.Enabled = True
        Me.select_all_types_button.Visible = False
        Me.select_all_types_button.Enabled = False
    End Sub
    Public Sub load_selection_cookie_defaults()

        Dim temp_val As String = ""


        If Not IsNothing(Request.Cookies("COOKIES_EXIST")) Then
            temp_val = Nothing
            temp_val = Request.Cookies("COOKIES_EXIST").Value
            If Trim(temp_val) = "Y" Then
                Call IterateThroughChildren_Load(outerDivViewToPDFID)
            End If
        End If

    End Sub

    Public Sub IterateThroughChildren_Load(ByVal parent As Control)


        Dim temp_val As String = ""

        For Each c As Control In parent.Controls
            If TypeOf c Is CheckBox Then
                Dim temporaryCheckbox As CheckBox = c

                If Not IsNothing(Request.Cookies(temporaryCheckbox.ID)) Then

                    '   If Request.Cookies(temporaryCheckbox.ID).ToString = "utilizationGraphs" Then
                    'temp_val = temp_val
                    ' End If


                    temp_val = Nothing
                    temp_val = Request.Cookies(temporaryCheckbox.ID).Value

                    If Trim(temp_val) = "Y" Then
                        temporaryCheckbox.Checked = True
                    Else
                        temporaryCheckbox.Checked = False
                    End If

                Else
                    temporaryCheckbox.Checked = False
                End If

            End If

            If c.Controls.Count > 0 Then
                IterateThroughChildren_Load(c)
            End If

        Next
    End Sub



    Public Sub IterateThroughChildren_Save(ByVal parent As Control)

        Try


            Dim aCookie2 As New HttpCookie("COOKIES_EXIST")
            aCookie2.Value = "Y"
            aCookie2.Expires = DateTime.Now.AddDays(365)
            Response.Cookies.Add(aCookie2)

            Dim temp_val As String = ""

            For Each c As Control In parent.Controls
                If TypeOf c Is CheckBox Then
                    Dim temporaryCheckbox As CheckBox = c


                    'If temporaryCheckbox.ID = "utilizationGraphs" Then
                    'temp_val = temp_val
                    ' End If
                    'If IsNothing(Response.Cookies.Item("PDF_UTIL").Item(temporaryCheckbox.ID)) Then
                    '  Response.Cookies.Item("PDF_UTIL").Item(temporaryCheckbox.ID) = "N"
                    'Else

                    'End If


                    'If temporaryCheckbox.Checked = True Then
                    '  Response.Cookies.Item("PDF_UTIL").Item(temporaryCheckbox.ID) = "Y"
                    'End If

                    'HttpContext.Current.Response.Cookies(temporaryCheckbox.ID).Values("CHECKEd") = 1
                    'HttpContext.Current.Response.Cookies(temporaryCheckbox.ID).Values("SOURCE") = ""
                    'HttpContext.Current.Response.Cookies(temporaryCheckbox.ID).Values("USER") = ""
                    'HttpContext.Current.Response.Cookies(temporaryCheckbox.ID).Expires = DateTime.Now.AddDays(10)


                    'Dim aCookie As New HttpCookie(temporaryCheckbox.ID)
                    'aCookie.Values("VALUE") = "N"
                    'aCookie.Expires = DateTime.Now.AddDays(365)
                    'HttpContext.Current.Response.Cookies.Add(aCookie) 

                    'If IsNothing(Request.Cookies(temporaryCheckbox.ID)) Then
                    Dim aCookie As New HttpCookie(temporaryCheckbox.ID)
                    aCookie.Value = "N"
                    aCookie.Expires = DateTime.Now.AddDays(365)
                    Response.Cookies.Add(aCookie)
                    'Response.Cookies(temporaryCheckbox.ID).Value = "N"
                    'End If

                    If temporaryCheckbox.Checked = True Then
                        HttpContext.Current.Response.Cookies(temporaryCheckbox.ID).Value = "Y"
                    Else
                        HttpContext.Current.Response.Cookies(temporaryCheckbox.ID).Value = "N"
                    End If


                    '  HttpContext.Current.Response.Cookies(temporaryCheckbox.ID).Values("CHECKED") = "Y"
                    ' Response.Cookies(temporaryCheckbox.ID).Values("CHECKED") = "Y"


                    'If IsNothing(HttpContext.Current.Response.Cookies(temporaryCheckbox.ID)) Then
                    '  Dim aCookie As New HttpCookie(temporaryCheckbox.ID) 
                    '  aCookie.Expires = DateTime.Now.AddDays(365)
                    '  HttpContext.Current.Response.Cookies.Add(aCookie)
                    '  HttpContext.Current.Response.Cookies(temporaryCheckbox.ID).Value = "N"
                    'End If


                    ' If IsNothing(HttpContext.Current.Response.Cookies(temporaryCheckbox.ID).Values("CHECKED")) Then
                    'HttpContext.Current.Response.Cookies(temporaryCheckbox.ID).Values("CHECKED") = "N"
                    ' End If

                    'HttpContext.Current.Response.Cookies(temporaryCheckbox.ID).Expires = DateTime.Now.AddDays(365)



                    'HttpContext.Current.Response.Cookies(temporaryCheckbox.ID).Values("SOURCE") = ""
                    'HttpContext.Current.Response.Cookies(temporaryCheckbox.ID).Values("USER") = ""
                    'HttpContext.Current.Response.Cookies(temporaryCheckbox.ID).Expires = DateTime.Now.AddDays(10)




                    'If IsNothing(HttpContext.Current.Request.Cookies.Item("PDF_UTIL").Item(temporaryCheckbox.ID)) Then
                    '  HttpContext.Current.Request.Cookies.Item("PDF_UTIL").Item(temporaryCheckbox.ID) = "N"
                    'Else

                    'End If


                    'If temporaryCheckbox.Checked = True Then
                    '  HttpContext.Current.Request.Cookies.Item("PDF_UTIL").Item(temporaryCheckbox.ID) = "Y"
                    'End If


                    'Dim tempcook1 As HttpCookie = HttpContext.Current.Request.Cookies("PDF_UTIL")

                    'If Not IsNothing(HttpContext.Current.Request.Cookies.Item(temporaryCheckbox.ID)) Then
                    '  HttpContext.Current.Request.Cookies.Item("PDF_UTIL").Values.Add()
                    'End If

                    'HttpContext.Current.Request.Cookies.Item(sCookieName).Values.Item(0).ToString.ToLower.Trim

                    'If temporaryCheckbox.ID = "MMS_FMS" Then
                    '  If temporaryCheckbox.Checked = True Then
                    '    HttpContext.Current.Request.Cookies.Item("PDF").Values(temporaryCheckbox.ID) = "Y"
                    '  End If
                    'End If


                End If

                If c.Controls.Count > 0 Then
                    IterateThroughChildren_Save(c)
                End If

            Next


        Catch ex As Exception

        End Try

    End Sub
    Protected Sub btnSave_Selections_Click(ByVal sender As Object, ByVal e As EventArgs) Handles btnSave_Selections.Click

        Call IterateThroughChildren_Save(outerDivViewToPDFID)


        'All done
        If Not Page.ClientScript.IsClientScriptBlockRegistered("CursorNormalRemove") Then
            System.Web.UI.ScriptManager.RegisterClientScriptBlock(Me, updateSelections.GetType(), "CursorNormalRemove", "ChangeTheMouseCursorOnItemParentDocument('cursor_default standalone_page');$('#" & btnRunReport.ClientID & "').removeClass('display_none');", True)
        End If
    End Sub

    Protected Sub runReport() 'Handles btnRunReport.Click
        Try

            If Session.Item("localUser").crmDemoUserFlag = True And Trim(Request("viewID")) = "998" Then
                Response.Redirect("/reportexamples/MarketReportSampleVSP.pdf", False)
            ElseIf MMS_RM.Checked = True And Trim(destination.Text) = "" And Trim(Request("viewID")) = "998" Then
                Me.extra_map_warning_label.Visible = True
            ElseIf Session.Item("localUser").crmDemoUserFlag = True And Trim(Request("viewID")) = "1" And Trim(Request("new_PDF")) = "Y" Then
                Response.Redirect("/reportexamples/STANDARD_REPORT_EXAMPLE.pdf", False)   ' new spec pdf 
            ElseIf Session.Item("localUser").crmDemoUserFlag = True And Trim(Request("viewID")) = "1" Then
                Response.Redirect("/reportexamples/CLASSIC_REPORT_EXAMPLE.pdf", False) ' classic report spec  
            Else

                Dim report_name As String = "test.html"
                Dim new_pdf_name As String = ""
                Dim real_company_name As String = ""
                Dim real_make_model_name2 As String = ""
                Dim real_make_model_name3 As String = ""
                Dim Query As String : Query = ""
                Dim amod_id As Integer = 0
                Dim comp_id As Integer = 0
                Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
                Dim SqlConn As New System.Data.SqlClient.SqlConnection
                Dim SqlCommand As New System.Data.SqlClient.SqlCommand
                Dim localAdoRs2 As System.Data.SqlClient.SqlDataReader : localAdoRs2 = Nothing
                Dim imgFolder As String = ""
                Dim subs_id As Integer = 0
                Dim i As Integer = 0
                Dim text_for_graph_title As String = ""
                Dim sub_info As String = ""
                Dim View_Type As Integer = 0
                Dim bool_bus As Boolean = False
                Dim bool_hel As Boolean = False
                Dim bool_com As Boolean = False
                Dim PDF_String As String = ""
                Dim sub_type As String = ""
                Dim airframe_type As String = ""
                Dim real_country_name As String = ""
                Dim real_city_name As String = ""
                Dim selected_product_code_from_drop_down As String = ""
                Dim engine_name As String = ""
                Dim current_spi_year As Integer = 0
                Dim model_weight As String = ""
                Dim model_weight_name As String = ""
                Dim current_spi_year2 As Integer = 0
                Dim quarter As Integer = 0
                Dim first_model As Boolean = False
                Dim months_count As Integer = 0
                Dim make_name As String = ""
                Dim amod_id2 As Integer = 0
                Dim amod_id3 As Integer = 0
                Dim subscriptionInfo As String = ""

                '--------- THIS IS FOR THE FIX OF THE PRINT AC DETIALS ASP OLD PAGE-----------------------
                If Not IsNothing(Request.Item("print_details")) Then

                    report_name = "1"

                    PDF_String = PrintAircraftDetails_PDF(Request("print_id"), Request("comp_id"))


                    '--------- THIS IS FOR THE FIX OF THE PRINT AC DETIALS ASP OLD PAGE-----------------------
                Else

                    Session.Item("localPreferences").DefaultCurrency = 9 ' us dollar


                    If Not IsNothing(Request.Item("viewID")) Then
                        If Not String.IsNullOrEmpty(Request.Item("viewID").ToString) Then
                            View_Type = Request("viewID").ToString
                        Else
                            View_Type = 1
                        End If '
                    Else
                        View_Type = 1
                    End If


                    If Not IsNothing(Request.Item("first")) Then
                        If Not String.IsNullOrEmpty(Request.Item("first").ToString) Then
                            first_model = Request.Item("first")
                        End If
                    End If

                    ' call the Get_Model_Name funciton if there is an amod_id passed
                    If Not IsNothing(Request.Item("amod_id")) Then
                        If Not String.IsNullOrEmpty(Request.Item("amod_id").ToString) Then

                            If InStr(Request("amod_id").ToString, ",") > 0 And View_Type = 28 Then
                                amod_id_list = Request("amod_id").ToString
                                amod_id = -1
                                real_make_model_name = "" ' Get_Model_Name(amod_id).ToString
                            Else
                                amod_id = CLng(Request("amod_id").ToString)
                                real_make_model_name = Get_Model_Name(amod_id).ToString
                            End If

                        End If
                    End If

                    If amod_id = 0 Then
                        If Not IsNothing(Request.Item("cboAircraftViewModelID")) Then
                            If IsNumeric(Request.Item("cboAircraftViewModelID")) Then
                                amod_id = commonEvo.ReturnAmodIDForItemIndex(CLng(Request.Item("cboAircraftViewModelID")))
                                real_make_model_name = Get_Model_Name(amod_id).ToString
                                NEW_PDF_AMOD_ID = amod_id
                            End If
                        End If
                    End If



                    ' call the Get_Model_Name funciton if there is an amod_id passed
                    If Not IsNothing(Request.Item("amod_id_a")) Then
                        If Not String.IsNullOrEmpty(Request.Item("amod_id_a").ToString) Then
                            amod_id = CLng(Request("amod_id_a").ToString)
                        End If
                    End If

                    If amod_id = 0 Then
                        If Not IsNothing(Request.Item("modelList")) Then
                            If Not String.IsNullOrEmpty(Request.Item("modelList").ToString) Then
                                amod_id = CLng(Request("modelList").ToString)
                            End If
                        End If
                    End If


                    If Not IsNothing(Request.Item("amod_id_b")) Then
                        If Not String.IsNullOrEmpty(Request.Item("amod_id_b").ToString) Then
                            amod_id2 = CLng(Request("amod_id_b").ToString)
                        End If
                    End If

                    If Not IsNothing(Request.Item("amod_id_c")) Then
                        If Not String.IsNullOrEmpty(Request.Item("amod_id_c").ToString) Then
                            amod_id3 = CLng(Request("amod_id_c").ToString)
                        End If
                    End If

                    If amod_id > 0 Then
                        real_make_model_name = Get_Model_Name(amod_id).ToString
                    ElseIf Not IsNothing(Request.Item("make")) Then
                        real_make_model_name = Request.Item("make").ToString
                    End If

                    If amod_id2 > 0 Then
                        real_make_model_name2 = Get_Model_Name(amod_id2).ToString
                    End If

                    If amod_id3 > 0 Then
                        real_make_model_name3 = Get_Model_Name(amod_id3).ToString
                    End If



                    ' call the Get_Model_Name funciton if there is a comp_id passed 
                    If Not IsNothing(Request.Item("comp_id")) Then
                        If Not String.IsNullOrEmpty(Request.Item("comp_id").ToString) Then
                            comp_id = CLng(Request("comp_id").ToString)
                        End If '
                    End If

                    If comp_id > 0 Then
                        real_company_name = get_company_name(comp_id).ToString
                    End If

                    subs_id = CLng(Session.Item("localUser").crmSubSubID.ToString)


                    If Not IsNothing(Request.Item("airframe_type")) Then
                        If Not String.IsNullOrEmpty(Request.Item("airframe_type").ToString) Then
                            airframe_type = Request("airframe_type").ToString
                        End If '
                    End If


                    If Not IsNothing(Request.Item("city")) Then
                        If Not String.IsNullOrEmpty(Request.Item("city").ToString) Then
                            real_city_name = Request("city").ToString
                        End If '
                    End If

                    If Not IsNothing(Request.Item("months")) Then
                        If Not String.IsNullOrEmpty(Request.Item("months").ToString) Then
                            months_count = Request("months").ToString
                        End If '
                    End If


                    ' call the Get_Model_Name funciton
                    If Not IsNothing(Request.Item("make_name")) Then
                        If Not String.IsNullOrEmpty(Request.Item("make_name").ToString) Then
                            make_name = Request("make_name").ToString
                        End If '
                    End If


                    If Not IsNothing(Request.Item("quarter")) Then
                        If Not String.IsNullOrEmpty(Request.Item("quarter")) Then
                            quarter = Request("quarter")
                        End If '
                    End If


                    If Not IsNothing(Request.Item("country")) Then
                        If Not String.IsNullOrEmpty(Request.Item("country").ToString) Then
                            real_country_name = Request("country").ToString
                        End If '
                    End If

                    If Not IsNothing(Request.Item("weight")) Then
                        If Not String.IsNullOrEmpty(Request.Item("weight").ToString) Then
                            model_weight = Request("weight").ToString
                        End If '
                    End If

                    If Not IsNothing(Request.Item("weight_name")) Then
                        If Not String.IsNullOrEmpty(Request.Item("weight_name").ToString) Then
                            model_weight_name = Request("weight_name").ToString
                        End If '
                    End If

                    If Not IsNothing(Request.Item("year")) Then
                        If Not String.IsNullOrEmpty(Request.Item("year").ToString) Then
                            current_spi_year = Request("year").ToString
                        End If '
                    End If

                    If Not IsNothing(Request.Item("year2")) Then
                        If Not String.IsNullOrEmpty(Request.Item("year2").ToString) Then
                            current_spi_year2 = Request("year2").ToString
                        End If '
                    End If


                    If Not IsNothing(Request.Item("engine")) Then
                        If Not String.IsNullOrEmpty(Request.Item("engine").ToString) Then
                            engine_name = Request("engine").ToString
                        End If '
                    End If

                    ' pc is for business, commercial and helicopter, pc2 is for jets, turbo props etc
                    If Not IsNothing(Request.Item("pc")) Then
                        If Not String.IsNullOrEmpty(Request.Item("pc").ToString) Then
                            selected_product_code_from_drop_down = Request("pc").ToString
                            If selected_product_code_from_drop_down.ToString.Trim = "1" Then
                                selected_product_code_from_drop_down = "B"
                                bool_bus = True
                                localCriteria.ViewCriteriaHasBusinessFlag = True
                            ElseIf selected_product_code_from_drop_down.ToString.Trim = "2" Then
                                selected_product_code_from_drop_down = "C"
                                bool_com = True
                                localCriteria.ViewCriteriaHasCommercialFlag = True
                            ElseIf selected_product_code_from_drop_down.ToString.Trim = "3" Then
                                selected_product_code_from_drop_down = "H"
                                bool_hel = True
                                localCriteria.ViewCriteriaHasHelicopterFlag = True
                            ElseIf selected_product_code_from_drop_down.ToString.Trim = "B" Then
                                selected_product_code_from_drop_down = "B"
                                bool_bus = True
                                localCriteria.ViewCriteriaHasBusinessFlag = True
                            ElseIf selected_product_code_from_drop_down.ToString.Trim = "C" Then
                                selected_product_code_from_drop_down = "C"
                                bool_com = True
                                localCriteria.ViewCriteriaHasCommercialFlag = True
                            ElseIf selected_product_code_from_drop_down.ToString.Trim = "H" Then
                                selected_product_code_from_drop_down = "H"
                                bool_hel = True
                                localCriteria.ViewCriteriaHasHelicopterFlag = True
                            ElseIf selected_product_code_from_drop_down.ToString.Trim = "B,C" Then
                                selected_product_code_from_drop_down = "B,C"
                                bool_bus = True
                                bool_com = True
                                localCriteria.ViewCriteriaHasBusinessFlag = True
                                localCriteria.ViewCriteriaHasCommercialFlag = True
                            ElseIf selected_product_code_from_drop_down.ToString.Trim = "B,H" Then
                                selected_product_code_from_drop_down = "B,H"
                                bool_bus = True
                                bool_hel = True
                                localCriteria.ViewCriteriaHasHelicopterFlag = True
                                localCriteria.ViewCriteriaHasBusinessFlag = True
                            ElseIf selected_product_code_from_drop_down.ToString.Trim = "C,H" Then
                                selected_product_code_from_drop_down = "C,H"
                                bool_com = True
                                bool_hel = True
                                localCriteria.ViewCriteriaHasCommercialFlag = True
                                localCriteria.ViewCriteriaHasHelicopterFlag = True
                            End If '
                        End If ' 

                    Else
                        If Session.Item("localPreferences").UserBusinessFlag Then
                            localCriteria.ViewCriteriaHasBusinessFlag = True
                        End If

                        If Session.Item("localPreferences").UserHelicopterFlag Then
                            localCriteria.ViewCriteriaHasHelicopterFlag = True
                        End If

                        If Session.Item("localPreferences").UserCommercialFlag Then
                            localCriteria.ViewCriteriaHasCommercialFlag = True
                        End If
                    End If

                    If Not IsNothing(Request.Item("pc2")) Then
                        If Not String.IsNullOrEmpty(Request.Item("pc2").ToString) Then
                            selected_product_code_from_drop_down = Request("pc2").ToString
                        End If '
                    End If

                    ' this section, if the page uses a drop down it puts the sub type to be the one selected. the sub type is passed to all functions, used only as a title
                    If View_Type = 1 Or View_Type = 3 Or View_Type = 13 Or View_Type = 4 Then
                        If selected_product_code_from_drop_down = "B" Then
                            sub_type = "Business Aircraft"
                        ElseIf selected_product_code_from_drop_down = "C" Then
                            sub_type = "Commercial Aircraft"
                        ElseIf selected_product_code_from_drop_down = "H" Then
                            sub_type = "Helicopters"
                        End If
                    ElseIf View_Type = 12 Then

                        If selected_product_code_from_drop_down = "B" Then
                            sub_type = "Business Aircraft"
                        ElseIf selected_product_code_from_drop_down = "C" Then
                            sub_type = "Commercial Aircraft"
                        ElseIf selected_product_code_from_drop_down = "H" Then
                            sub_type = "Helicopters"
                        End If

                    Else
                        If bool_bus And bool_com And bool_hel Then
                            sub_type = "All Aircraft"
                        ElseIf bool_bus And bool_com Then
                            sub_type = "Business and Commercial Aircraft"
                        ElseIf bool_bus And bool_hel Then
                            sub_type = "Business Aircraft and Helicopters"
                        ElseIf bool_com And bool_hel Then
                            sub_type = "Commercial Aircraft and Helicopters"
                        ElseIf bool_bus Then
                            sub_type = "Business Aircraft"
                        ElseIf bool_com Then
                            sub_type = "Commercial Aircraft"
                        ElseIf bool_hel Then
                            sub_type = "Helicopters"
                        End If
                    End If

                    If CLng(Session.Item("localUser").crmSubSubID) >= 0 Then

                        Try


                            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
                            'end Select
                            SqlConn.Open()

                            SqlCommand.Connection = SqlConn
                            SqlCommand.CommandType = System.Data.CommandType.Text
                            SqlCommand.CommandTimeout = 60

                            'SECTION 1 - COMPANY INFO ----------------------------------------------------------------------------------------------------------------------------------- 

                            Query = "SELECT TOP 1 Company.comp_name, Company.comp_web_address, Company.comp_email_address, Company.comp_address1, Company.comp_address2, Company.comp_city, Company.comp_state, Company.comp_zip_code, Company.comp_country, Phone_Numbers.pnum_number_full, Phone_Numbers.pnum_type FROM Subscription "
                            Query += " INNER JOIN Company ON Subscription.sub_comp_id = Company.comp_id AND Company.comp_journ_id = 0 "
                            Query += " INNER JOIN Phone_Numbers ON pnum_comp_id = Company.comp_id and pnum_contact_id = 0 and pnum_journ_id = 0 and pnum_hide_customer = 'N' "
                            Query += " INNER JOIN Phone_Type ON ptype_name = pnum_type "
                            Query += " WHERE(Subscription.sub_id = " & Session.Item("localUser").crmSubSubID & ")"
                            Query += " ORDER BY ptype_seq_no asc"

                            SqlCommand.CommandText = Query
                            localAdoRs2 = SqlCommand.ExecuteReader()

                            localAdoRs2.Read()

                            If localAdoRs2.HasRows Then
                                sub_info = "<table width='100%' cellspacing='0' cellpadding='0'><tr><td align='left'><font size='+1' color='white'>"
                                sub_info += localAdoRs2("comp_name")
                                sub_info += "</font></td></tr><tr><td align='left'><font color='white'>"
                                sub_info += localAdoRs2("comp_address1") & ", "
                                sub_info += localAdoRs2("comp_address2") & " "
                                sub_info += localAdoRs2("comp_city") & ", "
                                sub_info += localAdoRs2("comp_state") & " "
                                sub_info += localAdoRs2("comp_zip_code") & " "
                                'sub_info += localAdoRs2("comp_country") & " "
                                sub_info += "</font></td></tr><tr><td align='left'><font color='white'>"
                                sub_info += localAdoRs2("pnum_type") & ": "
                                sub_info += localAdoRs2("pnum_number_full") & "&nbsp;&#8226;&nbsp;"
                                sub_info += "<u>"
                                sub_info += localAdoRs2("comp_web_address")
                                'sub_info += localAdoRs2("comp_email_address")
                                sub_info += "</u></font></td></tr></table>"
                            End If
                            localAdoRs2.Close()
                        Catch ex As Exception

                        Finally
                            SqlCommand.Dispose()
                            SqlConn.Close()
                            SqlConn.Dispose()
                        End Try
                    End If

                    ' call the Build HTML Page
                    PDF_String = Build_HTML_Page(PDF_String)

                    report_name = ""


                    If Session.Item("localUser").crmSubSubID.ToString > 0 Then ' if evo
                        subscriptionInfo = Session.Item("localUser").crmSubSubID.ToString & "_" & Session.Item("localUser").crmUserLogin.ToString.Trim & "_" & Session.Item("localUser").crmSubSeqNo.ToString & "_"
                        report_name = subscriptionInfo
                    Else

                        'If Session.Item("localSubscription").crmSubscriptionID > 0 Then
                        '  report_name += Session.Item("localSubscription").crmSubscriptionID.ToString & "_"
                        'End If 

                        'If Session.Item("localPreferences").UserID <> "" Then
                        '  report_name += Session.Item("localPreferences").UserID.ToString & "_"
                        'End If

                        'If Session.Item("localPreferences").SeqNo > 0 Then
                        '  report_name += Session.Item("localPreferences").SeqNo.ToString & "_"
                        'End If

                        ''If Session.Item("localSubscription").crmRegID > 0 Then
                        ''  report_name += Session.Item("localSubscription").crmRegID.ToString & "_"
                        ''ElseIf subs_id > 0 Then
                        ''  report_name += subs_id.ToString & "_"
                        ''End If

                        ''If Session.Item("localUser").crmLocalUserID > 0 Then
                        ''  report_name += Session.Item("localUser").crmLocalUserID.ToString & "_"
                        ''End If


                        ''If comp_id > 0 Then
                        ''  report_name += comp_id.ToString & "_"
                        ''End If

                        report_name = Session.Item("localUser").crmUserTemporaryFilePrefix

                        If amod_id > 0 Then
                            report_name += amod_id.ToString & "_"
                        End If
                    End If







                    If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                        If View_Type = 1 Or View_Type = 2 Or View_Type = 3 Then
                            word_width = CInt(700)
                            word_half = (CInt(word_width) / 2)
                            word_35 = (CInt(word_width) * 0.35)
                            word_32 = (CInt(word_width) * 0.32)
                            word_1_4 = (CInt(word_width) * 0.25)
                            word_60 = (CInt(word_width) * 0.6)
                        End If
                        ' view 2 attempted, might need image work
                        'attempted 3 
                    End If




                    report_name += Now()
                    report_name = Replace(report_name, "/", "_")
                    report_name = Replace(report_name, ":", "_")
                    report_name = Replace(report_name, " ", "_")
                    report_name = Replace(report_name, "#", "_")

                    If View_Type = 1 Then ' model_market_sumamry view 
                        Dim temp_type As String = ""
                        If Me.WD.SelectedValue = "Word" Then
                            temp_type = "Word"
                        Else
                            temp_type = "PDF"
                        End If

                        If Trim(Request("new_PDF")) = "Y" Then
                            Call commonLogFunctions.Log_User_Event_Data("UserJetnetReport", "Model Market Summary Standard Report: " & temp_type, Nothing, View_Type, localCriteria.ViewCriteriaJournalID, 0, localCriteria.ViewCriteriaAircraftID, 0, localCriteria.ViewCriteriaAircraftID, 0, 0, "")
                            PDF_String = Build_Model_Market_Summary_PDF_Standard(amod_id, real_make_model_name, months_count)
                        Else
                            Call commonLogFunctions.Log_User_Event_Data("UserJetnetReport", "Model Market Summary Classic Report: " & temp_type, Nothing, View_Type, localCriteria.ViewCriteriaJournalID, 0, localCriteria.ViewCriteriaAircraftID, 0, localCriteria.ViewCriteriaAircraftID, 0, 0, "")
                            PDF_String = Build_Model_Market_Summary_PDF(amod_id, real_make_model_name, months_count)
                        End If
                        report_name += "_MMS_View_PDF"
                    ElseIf View_Type = 2 Then ' model_market_sumamry view 
                        PDF_String = Build_Model_Comparison_PDF(amod_id, real_make_model_name, amod_id2, amod_id3, real_make_model_name2, real_make_model_name3, sub_info, sub_type, real_company_name, airframe_type, months_count)
                        report_name += "_MMS_View_PDF"
                    ElseIf View_Type = 3 Then ' model_market_sumamry view 
                        PDF_String = Build_Operator_PDF(real_company_name, comp_id, real_make_model_name, amod_id, sub_info, sub_type, selected_product_code_from_drop_down, engine_name)
                        report_name += "_Operator_View_PDF"
                    ElseIf View_Type = 4 Then ' model_market_sumamry view 
                        localCriteria.ViewCriteriaAmodID = amod_id
                        localCriteria.ViewCriteriaCompanyID = comp_id
                        Build_Financial_Documents_tab(localCriteria, PDF_String)
                        report_name += "_Financial_Docs_EXCEL"

                    ElseIf View_Type = 9 Then ' financial view functions 
                        PDF_String = Build_Financial_PDF(real_company_name, comp_id, real_make_model_name, amod_id, sub_info, sub_type, airframe_type, selected_product_code_from_drop_down, real_country_name, real_city_name, months_count, make_name)
                        report_name += "_Financial_View_PDF"
                    ElseIf View_Type = 10 Then        ' charter view
                        PDF_String = Build_Charter_PDF(real_company_name, comp_id, real_make_model_name, amod_id, sub_info, sub_type, airframe_type, real_country_name, real_city_name)
                        report_name += "_Charter_View_PDF"
                    ElseIf View_Type = 12 Then        ' spi view
                        PDF_String = Build_SPI_PDF(real_make_model_name, amod_id, sub_info, sub_type, model_weight, model_weight_name, current_spi_year, current_spi_year2, selected_product_code_from_drop_down, quarter, first_model)
                        report_name += "_SPI_View_PDF"
                    ElseIf View_Type = 13 Then ' lease view 
                        PDF_String = Build_Lease_PDF(real_company_name, comp_id, real_make_model_name, amod_id, sub_info, sub_type, airframe_type, selected_product_code_from_drop_down)
                        report_name += "_Lease_View_PDF"
                    ElseIf View_Type = 28 Then
                        PDF_String = Build_Utilization_Summary_PDF_Standard(amod_id, real_make_model_name, months_count, selected_product_code_from_drop_down, View_Type)
                    ElseIf View_Type = 928 Then
                        PDF_String = Build_Utilization_Summary_PDF_Standard(amod_id, real_make_model_name, months_count, selected_product_code_from_drop_down, View_Type)
                    ElseIf View_Type = 997 Then

                        Call get_multi_model_info()

                        Call commonLogFunctions.Log_User_Event_Data("UserJetnetReport", "Market at a Glance Report", Nothing, View_Type, localCriteria.ViewCriteriaJournalID, 0, localCriteria.ViewCriteriaAircraftID, 0, localCriteria.ViewCriteriaAircraftID, 0, 0, "")
                        PDF_String = Build_VALUES_Summary_PDF_Standard(amod_id_overall, real_make_model_name, months_count, localCriteria.ViewCriteriaAircraftModel, View_Type)
                        report_name += "_MMS_Values_PDF"
                    ElseIf View_Type = 998 Then

                        Call commonLogFunctions.Log_User_Event_Data("UserJetnetReport", "Market Report", Nothing, View_Type, localCriteria.ViewCriteriaJournalID, 0, localCriteria.ViewCriteriaAircraftID, 0, localCriteria.ViewCriteriaAircraftID, localCriteria.ViewCriteriaAmodID)
                        PDF_String = Build_VALUES_Summary_PDF_Standard(amod_id, real_make_model_name, months_count)

                    ElseIf View_Type = 111 Then ' asset insight view 
                        If Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CUSTOMER_CENTER Then
                            '  PDF_String = Build_Assett_Inisght_Model_Function(amod_id, real_make_model_name)

                            PDF_String = Build_Assett_Inisght_Model_Function_2(amod_id, real_make_model_name, months_count)

                        End If

                    ElseIf View_Type = 100 Then ' all  view 
                        PDF_String = Build_SPI_PDF(real_make_model_name, amod_id, sub_info, sub_type, model_weight, model_weight_name, current_spi_year, current_spi_year2, selected_product_code_from_drop_down, quarter, first_model)
                        PDF_String += Build_Charter_PDF(real_company_name, comp_id, real_make_model_name, amod_id, sub_info, sub_type, airframe_type, real_country_name, real_city_name)
                        PDF_String += Build_Financial_PDF(real_company_name, comp_id, real_make_model_name, amod_id, sub_info, sub_type, airframe_type, selected_product_code_from_drop_down, real_country_name, real_city_name, months_count, make_name)
                        PDF_String += Build_Operator_PDF(real_company_name, comp_id, real_make_model_name, amod_id, sub_info, sub_type, selected_product_code_from_drop_down, engine_name)
                        If months_count > 0 Then
                            PDF_String += Build_Model_Market_Summary_PDF(amod_id, real_make_model_name, months_count)
                        Else
                            PDF_String += Build_Model_Market_Summary_PDF(amod_id, real_make_model_name, 6)
                        End If
                        PDF_String += Build_Lease_PDF(real_company_name, comp_id, real_make_model_name, amod_id, sub_info, sub_type, airframe_type, selected_product_code_from_drop_down)
                        report_name += "_All_View_PDF"

                    ElseIf View_Type = 300 And HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag Then
                        PDF_String = ""

                        PDF_String &= "<table cellspacing='0' cellpadding='0' border='0' width='100%' cellpadding=""0"" cellspacing=""0"">"
                        PDF_String &= "<tr><td><br/><br/><table cellspacing='0' cellpadding='0' border='0' width='100%'><tr><td align='center' width='100%' valign=""top""><div class=""Box""><div style=""width:1150px;"" class=""marginAuto"">"

                        PDF_String &= "<font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER_NOALIGN") & "'>" & Trim(Request("title")) & "</font>"
                        PDF_String &= "</br><img src='" & valueGraphText7.Text & "' width='1150' align='center'  align='center' class=""marginAuto"" />"
                        PDF_String &= "</div></div>"
                        PDF_String &= "</td></tr></table>"

                        report_name += "_Residual_View_PDF"
                    End If




                End If  ' end if if not print details

                ' PDF_String = "<html><body>Here</body></html>"

                If View_Type = 4 Then
                    report_name += ".xls"
                Else
                    If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                        If Me.WD.SelectedItem.Text = "Word (.docx)" Then
                            report_name += ".docx"
                        Else
                            report_name += ".doc"
                        End If

                    Else
                        report_name += ".html"
                    End If
                End If

                If Not Build_String_To_HTML(report_name, PDF_String) Then
                    HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "There was a problem generating your report"
                Else
                    If View_Type <> 4 Then
                        If Not (Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX") Then
                            Convert_To_PDF(report_name, View_Type)
                        End If
                    End If
                End If

                ' call the Output String to HTML file

                new_pdf_name = Replace(report_name, "html", "pdf")
                ' new_pdf_name = report_name
                Dim tstring As String = ""
                tstring = Session.Item("MarketSummaryFolderVirtualPath").ToString & "/" & new_pdf_name

                Response.Redirect(tstring)

            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in btnRunReport_Click: " & ex.Message
        End Try

    End Sub
    Public Sub get_multi_model_info()
        Dim modelArray As Array
        Dim tmpModelArray() As String = Nothing
        Dim sAirFrame As String = ""
        Dim sAirType As String = ""
        Dim sMake As String = ""
        Dim sModel As String = ""
        Dim sUsage As String = ""
        Dim amod_product As String = ""
        Dim multiProduct As Array = Nothing
        Dim type_search_variable_only As String = ""
        Dim type_search_string_variable_only As String = ""
        real_make_model_name = ""

        ' Check and see if user selected more than one model
        If Trim(Request("model_list")) <> "" Then
            If InStr(Trim(Request("model_list")), "##") > 0 Then
                modelArray = Split(Trim(Request("model_list")), "##")
                If IsArray(modelArray) And Not IsNothing(modelArray) Then
                    ReDim tmpModelArray(UBound(modelArray))
                    ' translate index into actual amod_id
                    localCriteria.ViewCriteriaAircraftModel = ""
                    real_make_model_name = ""

                    For x As Integer = 0 To UBound(modelArray)
                        If IsNumeric(modelArray(x)) Then
                            Dim lookedUpID As Long = commonEvo.ReturnAmodIDForItemIndex(CLng(modelArray(x)))

                            ' translate index into actual amod_id
                            ' tmpModelArray(x) = CLng(modelArray(x))
                            'If commonEvo.ReturnModelDataFromIndex(CLng(modelArray(x)), sAirFrame, sAirType, sMake, sModel, sUsage) Then 
                            tmpModelArray(x) = lookedUpID
                            If Trim(real_make_model_name) = "" Then
                                localCriteria.ViewCriteriaAircraftModel = lookedUpID
                                real_make_model_name = Get_Model_Name(lookedUpID).ToString
                            Else
                                localCriteria.ViewCriteriaAircraftModel &= Constants.cCommaDelim & CLng(lookedUpID)
                                real_make_model_name &= ", " & Get_Model_Name(CLng(lookedUpID)).ToString
                            End If
                            ' End If
                        End If
                    Next

                    localCriteria.ViewCriteriaAmodIDArray = tmpModelArray
                    amod_id_overall = 0
                    TYPE_OF_AC = real_make_model_name
                End If
            Else
                'localCriteria.ViewCriteriaAmodIDArray(0) = Trim(Request("model_list"))
                Dim tempModel As Long = 0
                tempModel = commonEvo.ReturnAmodIDForItemIndex(CLng(Trim(Request("model_list"))))
                real_make_model_name = Get_Model_Name(tempModel)
                amod_id_overall = tempModel
            End If
        End If
    End Sub
    '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
    ' Function name: Get_Model_Name
    ' Purpose: to build html open/close tags
    ' Parameters: viewToPdf - the table content
    ' Return: 
    '       String - in html table row format
    ' Change Log
    '           05/27/2010    - Created By: Tom Jones
    ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
    Public Function Get_Model_Name(ByVal amod_id As Integer) As String
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlDataReader As System.Data.SqlClient.SqlDataReader : SqlDataReader = Nothing

        Dim tmpStr As String : tmpStr = ""

        Dim Query As String : Query = ""
        Query = "SELECT DISTINCT amod_make_name, amod_model_name FROM Aircraft_Model WITH(NOLOCK) WHERE amod_id = " + amod_id.ToString

        '    Query &= " " + commonEvo.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, True)
        Query = Query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, False)

        Try

            'Select Case Application.Item("webHostObject").evoWebHostType
            'Case eWebSiteTypes.LOCAL
            'SqlConn.ConnectionString = My.Settings.DEFAULT_LOCAL_MSSQL
            '  Case Else
            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            'End Select

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandTimeout = 1000
            SqlCommand.CommandText = Query.ToString

            SqlDataReader = SqlCommand.ExecuteReader()

            If SqlDataReader.HasRows Then
                SqlDataReader.Read()
                If Not (IsDBNull(SqlDataReader("amod_make_name")) And Not IsDBNull(SqlDataReader("amod_model_name"))) Then
                    tmpStr = SqlDataReader("amod_make_name").ToString & " " & SqlDataReader("amod_model_name").ToString
                End If
            End If
            SqlDataReader.Close()
            SqlDataReader = Nothing
        Catch SqlException

            SqlConn.Dispose()
            SqlCommand.Dispose()

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Get_Model_Name: " & SqlException.Message

        Finally

            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()

        End Try

        Return tmpStr

    End Function
    Public Function Get_Type_Name(ByVal type_code As String) As String
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlDataReader As System.Data.SqlClient.SqlDataReader : SqlDataReader = Nothing

        Dim tmpStr As String : tmpStr = ""

        Dim Query As String : Query = ""
        Query = "SELECT DISTINCT atype_name FROM Aircraft_Type WITH(NOLOCK) WHERE atype_code in "

        Query = Query & " ('" & Replace(Trim(type_code), "|", "','") & "') "

        Try

            'Select Case Application.Item("webHostObject").evoWebHostType
            'Case eWebSiteTypes.LOCAL
            'SqlConn.ConnectionString = My.Settings.DEFAULT_LOCAL_MSSQL
            '  Case Else
            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            'End Select

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandTimeout = 1000
            SqlCommand.CommandText = Query.ToString

            SqlDataReader = SqlCommand.ExecuteReader()

            If SqlDataReader.HasRows Then

                Do While SqlDataReader.Read
                    If Not (IsDBNull(SqlDataReader("atype_name"))) Then
                        If Trim(tmpStr) <> "" Then
                            tmpStr &= ", "
                        End If
                        tmpStr &= SqlDataReader("atype_name").ToString
                    End If
                Loop
            End If
            SqlDataReader.Close()
            SqlDataReader = Nothing
        Catch SqlException

            SqlConn.Dispose()
            SqlCommand.Dispose()

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Get_Model_Name: " & SqlException.Message

        Finally

            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()

        End Try

        Return tmpStr

    End Function
    Public Function Get_Airport_Name_Country(ByVal aport_id As Long, ByRef is_aport_us As Boolean, ByRef aport_name As String) As String
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlDataReader As System.Data.SqlClient.SqlDataReader : SqlDataReader = Nothing

        Dim tmpStr As String : tmpStr = ""

        Dim Query As String : Query = ""
        Query = "SELECT DISTINCT aport_name, aport_country FROM Airport WITH(NOLOCK) WHERE aport_id = " + aport_id.ToString

        '    Query &= " " + commonEvo.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, True)
        '    Query = Query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, False)

        Try

            'Select Case Application.Item("webHostObject").evoWebHostType
            'Case eWebSiteTypes.LOCAL
            'SqlConn.ConnectionString = My.Settings.DEFAULT_LOCAL_MSSQL
            '  Case Else
            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            'End Select

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandTimeout = 1000
            SqlCommand.CommandText = Query.ToString

            SqlDataReader = SqlCommand.ExecuteReader()

            If SqlDataReader.HasRows Then
                SqlDataReader.Read()
                If Not (IsDBNull(SqlDataReader("aport_name")) And Not IsDBNull(SqlDataReader("aport_name"))) Then
                    aport_name = SqlDataReader("aport_name").ToString
                End If

                If Not (IsDBNull(SqlDataReader("aport_country")) And Not IsDBNull(SqlDataReader("aport_country"))) Then
                    If Trim(SqlDataReader("aport_country")) = "United States" Or Trim(SqlDataReader("aport_country")) = "U.S." Then
                        is_aport_us = True
                    End If
                End If
            End If
            SqlDataReader.Close()
            SqlDataReader = Nothing
        Catch SqlException

            SqlConn.Dispose()
            SqlCommand.Dispose()

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Get_Model_Name: " & SqlException.Message

        Finally

            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()

        End Try

        Return tmpStr

    End Function

    Public Function Get_Fuel_Price() As Double

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlDataReader As System.Data.SqlClient.SqlDataReader : SqlDataReader = Nothing
        Dim sQuery As StringBuilder = New StringBuilder()
        Dim tempprice As Double = 0.0
        sQuery.Append("SELECT evo_config_fuel_cost FROM Evolution_Configuration WITH(NOLOCK) WHERE evo_config_category = 'LIVE'")
        Try

            'Select Case Application.Item("webHostObject").evoWebHostType
            'Case eWebSiteTypes.LOCAL
            'SqlConn.ConnectionString = My.Settings.DEFAULT_LOCAL_MSSQL
            'Case Else
            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            'End Select

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandTimeout = 1000
            SqlCommand.CommandText = sQuery.ToString

            SqlDataReader = SqlCommand.ExecuteReader()

            If SqlDataReader.HasRows Then
                SqlDataReader.Read()
                If Not IsDBNull(SqlDataReader("evo_config_fuel_cost")) Then

                    tempprice = CDbl(SqlDataReader("evo_config_fuel_cost"))

                End If
            End If
            SqlDataReader.Close()
            SqlDataReader = Nothing
        Catch SqlException

            SqlConn.Dispose()
            SqlCommand.Dispose()

            sQuery = Nothing
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Get_Fuel_Price: " & SqlException.Message


        Finally

            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()

        End Try

        Return tempprice

    End Function
    '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
    ' Function name: Build_HTML_Page
    ' Purpose: to build html open/close tags
    ' Parameters: viewToPdf - the table content
    ' Return: 
    '       String - in html table row format
    ' Change Log
    '           05/27/2010    - Created By: Tom Jones
    ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
    Public Function Build_HTML_Page(ByVal viewToPDF As String) As String
        Build_HTML_Page = ""
        Try

            viewToPDF = viewToPDF & "</body></html>"
            Build_HTML_Page = viewToPDF
        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Build_HTML_Page: " & ex.Message
        End Try
    End Function
    '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
    ' Function name: Build_PDF_Template_Header
    ' Purpose: to build html head info for the PDF Template page
    ' Parameters: none
    ' Return: 
    '       String - in html table row format
    ' Change Log
    '           05/27/2010    - Created By: Tom Jones
    ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
    Public Function Build_PDF_Template_Header(ByVal foot_space_cover As String, ByVal foot_space_market_summary As String, ByVal foot_space_Performance_Specs As String,
  ByVal foot_space_op_costs As String, ByVal foot_space_ac_for_sale As String, ByVal foot_space_recent_retail_sales As String, ByVal foot_space_market_activity As String) As String
        Build_PDF_Template_Header = ""
        Try
            Dim sServerMapPath As String = ""
            Dim sSiteStyleSheet As String = "common\jetnet.css"
            sServerMapPath = Server.MapPath(sSiteStyleSheet)
            Dim txtFile As New System.IO.StreamReader(sServerMapPath)
            Dim readStyle As String = ""
            Dim formatStyle As String = ""
            readStyle = "<style>"
            Do While txtFile.EndOfStream <> True
                formatStyle = txtFile.ReadLine()
                If Trim(formatStyle.StartsWith(".border_bottom")) Then
                    formatStyle = formatStyle.Replace("0px", "1px")
                ElseIf Trim(formatStyle.StartsWith(".border_bottom_right")) Then
                    formatStyle = formatStyle.Replace("0px", "1px")
                ElseIf Trim(formatStyle.StartsWith(".leftside")) Then
                    formatStyle = formatStyle.Replace("0px", "1px")
                ElseIf Trim(formatStyle.StartsWith(".rightside")) Then
                    formatStyle = formatStyle.Replace("0px", "1px")
                ElseIf Trim(readStyle.EndsWith("TD{")) Then
                    formatStyle = formatStyle.Replace("8pt", "12pt")
                End If
                readStyle = readStyle & formatStyle
            Loop
            readStyle = readStyle & ".break { page-break-before: always; }" & vbCrLf


            If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then

                readStyle = readStyle & ".FleetMarket_Left_TD { border-top:1px solid #1F5298; border-right:1px solid #1F5298; font-family:Arial;}" & vbCrLf
                readStyle = readStyle & ".FleetMarket_Right_TD { border-top:1px solid #1F5298; font-family:Arial; }" & vbCrLf
                readStyle = readStyle & ".FleetMarket_Bottom_TD { border-top:1px solid #1F5298; border-bottom:1px solid #1F5298; font-family:Arial;font-size:10px;  }" & vbCrLf
                readStyle = readStyle & ".Performance_Specs_Left_TD_1 { border-top:1px solid #1F5298; border-bottom:1px solid #1F5298; font-family:Arial;font-size:10px;  }" & vbCrLf
                readStyle = readStyle & ".Performance_Specs_Left_TD_2 { border-top:1px solid #1F5298; border-right:1px solid #1F5298; border-bottom:1px solid #1F5298; font-family:Arial;font-size:10px;  }" & vbCrLf
                readStyle = readStyle & ".Performance_Specs_Right_TD_1 { border-top:1px solid #1F5298; border-bottom:1px solid #1F5298; font-family:Arial;font-size:10px; }" & vbCrLf
                readStyle = readStyle & ".Performance_Specs_Right_TD_2 { border-top:1px solid #1F5298; border-bottom:1px solid #1F5298; font-family:Arial;font-size:10px;  }" & vbCrLf
                readStyle = readStyle & ".Performance_Specs_Filler_TD_Middle { border-top:1px solid #1F5298; border-bottom:1px solid #1F5298; font-family:Arial;font-size:10px;  }" & vbCrLf
                readStyle = readStyle & ".Operating_Costs_TD_Top_1 { border-top:1px solid #1F5298; font-family:Arial;font-size:10px;  }" & vbCrLf
                readStyle = readStyle & ".Operating_Costs_TD_Top_2 { border-top:1px solid #1F5298; border-right:1px solid #1F5298; border-bottom:1px solid #1F5298; font-family:Arial;font-size:10px; }" & vbCrLf
                readStyle = readStyle & ".Operating_Costs_TD_Top_3 { border-top:1px solid #1F5298; font-family:Arial;font-size:10px; }" & vbCrLf
                readStyle = readStyle & ".Operating_Costs_TD_Bottom { border-bottom:1px solid #1F5298; font-family:Arial }" & vbCrLf
                'readStyle = readStyle & ".Label{font-size:10px;}" & vbCrLf
                readStyle = readStyle & ".th_title_details{font-size:10px;}" & vbCrLf
                readStyle = readStyle & ".table_specs{font-size:10px;}" & vbCrLf
                readStyle = readStyle & ".beige2{font-size:10px;}" & vbCrLf


            Else

                readStyle = readStyle & ".FleetMarket_Left_TD { border-top:1px solid #1F5298; border-right:1px solid #1F5298; font-family:Arial;}" & vbCrLf
                readStyle = readStyle & ".FleetMarket_Right_TD { border-top:1px solid #1F5298; font-family:Arial; }" & vbCrLf
                readStyle = readStyle & ".FleetMarket_Bottom_TD { border-top:1px solid #1F5298; border-bottom:1px solid #1F5298; font-family:Arial; }" & vbCrLf
                readStyle = readStyle & ".Performance_Specs_Left_TD_1 { border-top:1px solid #1F5298; border-bottom:1px solid #1F5298; font-family:Arial }" & vbCrLf
                readStyle = readStyle & ".Performance_Specs_Left_TD_2 { border-top:1px solid #1F5298; border-right:1px solid #1F5298; border-bottom:1px solid #1F5298; font-family:Arial; }" & vbCrLf
                readStyle = readStyle & ".Performance_Specs_Right_TD_1 { border-top:1px solid #1F5298; border-bottom:1px solid #1F5298; font-family:Arial; }" & vbCrLf
                readStyle = readStyle & ".Performance_Specs_Right_TD_2 { border-top:1px solid #1F5298; border-bottom:1px solid #1F5298; font-family:Arial; }" & vbCrLf
                readStyle = readStyle & ".Performance_Specs_Filler_TD_Middle { border-top:1px solid #1F5298; border-bottom:1px solid #1F5298; font-family:Arial; }" & vbCrLf
                readStyle = readStyle & ".Operating_Costs_TD_Top_1 { border-top:1px solid #1F5298; font-family:Arial }" & vbCrLf
                readStyle = readStyle & ".Operating_Costs_TD_Top_2 { border-top:1px solid #1F5298; border-right:1px solid #1F5298; border-bottom:1px solid #1F5298; font-family:Arial }" & vbCrLf
                readStyle = readStyle & ".Operating_Costs_TD_Top_3 { border-top:1px solid #1F5298; font-family:Arial }" & vbCrLf
                readStyle = readStyle & ".Operating_Costs_TD_Bottom { border-bottom:1px solid #1F5298; font-family:Arial }" & vbCrLf
                readStyle = readStyle & ".table_specs{font-size:12px;}" & vbCrLf
            End If

            'readStyle = readStyle & ".foot_space_cover{line-height: " & foot_space_cover & "px}" & vbCrLf '130
            'readStyle = readStyle & ".foot_space_market_summary{line-height:" & foot_space_market_summary & "px}" & vbCrLf '380
            'readStyle = readStyle & ".foot_space_Performance_Specs{line-height: " & foot_space_Performance_Specs & "px}" & vbCrLf '400
            ' readStyle = readStyle & ".foot_space_op_costs{line-height: " & foot_space_op_costs & "px}" & vbCrLf '30
            'readStyle = readStyle & ".foot_space_ac_for_sale{line-height: " & foot_space_ac_for_sale & "px}" & vbCrLf '390
            'readStyle = readStyle & ".foot_space_recent_retail_sales{line-height: " & foot_space_recent_retail_sales & "px}" & vbCrLf '370
            'readStyle = readStyle & ".foot_space_market_activity{line-height: " & foot_space_market_activity & "px}" & vbCrLf '380

            readStyle = readStyle & "</style>" & vbCrLf
            Build_PDF_Template_Header = "<html><head>" & vbCrLf & readStyle & "</head><body>" & vbCrLf

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Build_PDF_Template_Header: " & ex.Message
        End Try
    End Function
    '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
    ' Function name: Build_PDF_Template_Footer
    ' Purpose: to build html footer info for the PDF Template page
    ' Parameters: none
    ' Return: 
    '       String - in html table row format
    ' Change Log
    '           05/27/2010    - Created By: Tom Jones
    ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
    Public Function Build_PDF_Template_Footer_MMS() As String
        Build_PDF_Template_Footer_MMS = ""
        Try
            Build_PDF_Template_Footer_MMS = "<table width='100%' align='center'><tr id='trMaintbl_Footer'><hr />"
            Build_PDF_Template_Footer_MMS = Build_PDF_Template_Footer_MMS & "<td  id='tdMaintbl_Footer' align='center'>JETNET Evolution Model Market Summary Report"
            Build_PDF_Template_Footer_MMS = Build_PDF_Template_Footer_MMS & "</td></tr></table>"
        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Build_PDF_Template_Footer: " & ex.Message
        End Try
    End Function

    '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
    ' Function name: Build_PDF_CoverPage
    ' Purpose: to build the cover page for the pdf file
    ' Parameters: none
    ' Return: 
    '       String - in html table row format
    ' Change Log
    '           05/27/2010    - Created By: Tom Jones
    ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
    Public Function Build_PDF_CoverPage(ByVal amod_id As Integer, ByRef foot_space_cover As String) As String
        Build_PDF_CoverPage = ""
        Dim imgFolder As String = HttpContext.Current.Server.MapPath(Session.Item("ModelPicturesFolderVirtualPath"))
        '   Dim imgDisplayFolder As String = Application.Item("webHostObject").crmClientFullHostName + Session.Item("ModelPicturesFolderVirtualPath")

        Dim ac_image_file As String = ""
        Dim temp_height As Integer = 0
        Dim temp_width As Integer = 0
        ' Dim zimage2 As System.Drawing.Image
        Dim desired_width As Integer = 550
        Dim temp_percent1 As Double = 0.0
        Dim temp_percent2 As Double = 0.0

        Dim imgDisplayFolder As String = ""

        If Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CRM Then
            imgDisplayFolder = Application.Item("crmClientSiteData").ClientFullHostName & Session.Item("ModelPicturesFolderVirtualPath")
        Else
            imgDisplayFolder = "http://www.jetnetevolution.com/" & Session.Item("ModelPicturesFolderVirtualPath")
        End If

        Dim imgFileName As String = amod_id.ToString.Trim + ".jpg"

        Try


            ' If InStr(imgDisplayFolder, "evo") = 0 Then
            'imgDisplayFolder = "http://www.jetnetevolution.com/" & Session.Item("ModelPicturesFolderVirtualPath")
            '  End If

            '***********************************************************************
            '* You will need to use a select case to pick the right cover page
            '* Pass that to the funtion call later for now PDF Market Summary
            '***********************************************************************

            Build_PDF_CoverPage = Build_PDF_Template_Header_Final(WD)

            If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                Build_PDF_CoverPage = Build_PDF_CoverPage & "<table align='center' id='fleetTable'  cellpadding='1' cellspacing='0' width='" & word_width & "'>" & vbCrLf
            Else
                Build_PDF_CoverPage = Build_PDF_CoverPage & "<table align='center' id='fleetTable'  cellpadding='1' cellspacing='0' width='95%'>" & vbCrLf
            End If



            ' tr start for Logo



            Build_PDF_CoverPage = Build_PDF_CoverPage & "<tr id='trInner_Content_AC_PIC'>" & vbCrLf
            Build_PDF_CoverPage = Build_PDF_CoverPage & "<td  id='tdInner_Content_AC_PIC' align='center' colspan='3'>"


            If Me.logo_check.Checked = True Then
                Build_PDF_CoverPage = Build_PDF_CoverPage & get_company_images(real_make_model_name)
            Else
                Build_PDF_CoverPage = Build_PDF_CoverPage & "<img src='" & location_string & "images/marketpdfheader.jpg' />" & vbCrLf
            End If




            ' get the AC pic

            Build_PDF_CoverPage = Build_PDF_CoverPage & "</td>" & vbCrLf
            Build_PDF_CoverPage = Build_PDF_CoverPage & "</tr>" & vbCrLf

            Build_PDF_CoverPage = Build_PDF_CoverPage & "<tr id='trInnerTableSetup'>" & vbCrLf
            Build_PDF_CoverPage = Build_PDF_CoverPage & "<td align='center' valign='top' id='tdInnerTableSetup'>" & vbCrLf
            If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                Build_PDF_CoverPage = Build_PDF_CoverPage & "<table width='" & word_width & "' valign='top' id='tblInner_Content'>" & vbCrLf
            Else
                Build_PDF_CoverPage = Build_PDF_CoverPage & "<table width='95%' valign='top' id='tblInner_Content'>" & vbCrLf
            End If


            ' tr start for AC pic
            Build_PDF_CoverPage = Build_PDF_CoverPage & "<tr id='trInner_Content_AC_PIC'>" & vbCrLf
            Build_PDF_CoverPage = Build_PDF_CoverPage & "<td  id='tdInner_Content_AC_PIC' align='center'><strong>" & vbCrLf
            ' get the Make Model Name

            Build_PDF_CoverPage = Build_PDF_CoverPage & real_make_model_name & "</strong></td>" & vbCrLf
            Build_PDF_CoverPage = Build_PDF_CoverPage & "</tr>" & vbCrLf

            Build_PDF_CoverPage = Build_PDF_CoverPage & "<tr id='trInner_Content_AC_Description'>" & vbCrLf
            Build_PDF_CoverPage = Build_PDF_CoverPage & "<td id='tdInner_Content_AC_Description' align='center'>" & vbCrLf


            'Try


            '  'ac_image_file = HttpContext.Current.Server.MapPath("pictures\aircraft\") & imgFileName
            '  'zimage2 = System.Drawing.Image.FromFile(ac_image_file)
            '  'temp_width = zimage2.Width
            '  'temp_height = zimage2.Height

            '  '' if the image is wider then the desired image width, then shirnk down to size.
            '  'If temp_width > desired_width Then
            '  '  temp_percent1 = CDbl(CDbl(desired_width) / CDbl(temp_width))
            '  '  temp_width = CDbl(CDbl(temp_width) * CDbl(temp_percent1))
            '  '  temp_height = CDbl(CDbl(temp_height) * CDbl(temp_percent1))
            '  'End If

            '  ''assuming generally that a square is fine
            '  'If temp_height > temp_width Then
            '  '  temp_percent1 = CDbl(CDbl(temp_width) / CDbl(temp_height))
            '  '  temp_width = CDbl(CDbl(temp_width) * CDbl(temp_percent1))
            '  '  temp_height = CDbl(CDbl(temp_height) * CDbl(temp_percent1))
            '  'End If


            '  Build_PDF_CoverPage = Build_PDF_CoverPage & "<img Title='" + real_make_model_name.Trim + "' alt='" + real_make_model_name.Trim + "' src='" + imgDisplayFolder.Trim + "/" + imgFileName.Trim + "' width='550' />" & vbCrLf

            'Catch ex As Exception

            '  Build_PDF_CoverPage = Build_PDF_CoverPage & "<img Title='" + real_make_model_name.Trim + "' alt='" + real_make_model_name.Trim + "' src='" + imgDisplayFolder.Trim + "/" + imgFileName.Trim + "' />" & vbCrLf
            'End Try


            ' get the image
            '    If System.IO.File.Exists(imgFolder.Trim + "\" + imgFileName.Trim) Then

            'if its word, make sure its smaller, cause diminsions get all messed up 
            If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                Build_PDF_CoverPage = Build_PDF_CoverPage & "<img Title='" + real_make_model_name.Trim + "' alt='" + real_make_model_name.Trim + "' src='" + imgDisplayFolder.Trim + "/" + imgFileName.Trim + "'  width='400' height='400' />" & vbCrLf
            Else
                Build_PDF_CoverPage = Build_PDF_CoverPage & "<img Title='" + real_make_model_name.Trim + "' alt='" + real_make_model_name.Trim + "' src='" + imgDisplayFolder.Trim + "/" + imgFileName.Trim + "'  width='550'  />" & vbCrLf
            End If


            '  Else
            '  Build_PDF_CoverPage = Build_PDF_CoverPage & "<img src='' />" & vbCrLf
            ' End If



            Build_PDF_CoverPage = Build_PDF_CoverPage & "</td>" & vbCrLf
            Build_PDF_CoverPage = Build_PDF_CoverPage & "</tr>" & vbCrLf



            ' tr for AC description
            Build_PDF_CoverPage = Build_PDF_CoverPage & "<tr id='trInner_Content_AC_Description'>" & vbCrLf
            Build_PDF_CoverPage = Build_PDF_CoverPage & "<td id='tdInner_Content_AC_Description' align='center'><br /><p >" & vbCrLf
            ' get the description
            'My.Settings.whichDatabase = "LIVE"
            ' need to set it to LIVE
            Build_PDF_CoverPage = Build_PDF_CoverPage & Get_Aircraft_Model_Description(amod_id)
            Build_PDF_CoverPage = Build_PDF_CoverPage & "</p></td>" & vbCrLf
            Build_PDF_CoverPage = Build_PDF_CoverPage & "</tr>" & vbCrLf

            ' tr for AC description
            Build_PDF_CoverPage = Build_PDF_CoverPage & "<tr id='trInner_Content_AC_ReportDate'>" & vbCrLf
            Build_PDF_CoverPage = Build_PDF_CoverPage & "<td id='tdInner_Content_AC_ReportDate' align='center'><br />" & vbCrLf
            ' get the report date
            Build_PDF_CoverPage = Build_PDF_CoverPage & "Report Date: " & System.DateTime.Now.ToShortDateString

            Build_PDF_CoverPage = Build_PDF_CoverPage & "</td>" & vbCrLf
            Build_PDF_CoverPage = Build_PDF_CoverPage & "</tr>" & vbCrLf

            ' add the spacer to move the footer down
            '  Build_PDF_CoverPage = Build_PDF_CoverPage & "<tr>" & vbCrLf
            '   Build_PDF_CoverPage = Build_PDF_CoverPage & "<td  align='center'  id='tdInnerTableSetup' colspan='1'  class='foot_space_cover'>" & vbCrLf
            '    Build_PDF_CoverPage = Build_PDF_CoverPage & "&nbsp;" & vbCrLf
            '   Build_PDF_CoverPage = Build_PDF_CoverPage & "</td>" & vbCrLf
            '   Build_PDF_CoverPage = Build_PDF_CoverPage & "</tr>" & vbCrLf

            Build_PDF_CoverPage = Build_PDF_CoverPage & "</table>" & vbCrLf
            Build_PDF_CoverPage = Build_PDF_CoverPage & "</td>" & vbCrLf
            Build_PDF_CoverPage = Build_PDF_CoverPage & "</tr></table>" & vbCrLf
            ' check the length of build pdf cover page 

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Build_PDF_CoverPage: " & ex.Message
        End Try
    End Function
    Public Function Build_FleetMarketSummary(ByVal inModelID As Long, ByVal bIsAcContactTypeView As Boolean, ByVal inMakeName As String, ByRef foot_space_market_summary As String, ByVal header_y_or_n As String, ByRef searchCriteria As viewSelectionCriteriaClass) As String
        Build_FleetMarketSummary = ""
        Try
            Dim strHTML

            strHTML = ""
            Build_FleetMarketSummary = ""

            GetFleetInfo(inModelID, False, searchCriteria)

            If Trim(header_y_or_n) = "Y" Then
                If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                    strHTML = strHTML & "<table align='center' id='fleetTable'  cellpadding='1' cellspacing='0' width='" & word_width & "'>" & vbCrLf
                Else
                    strHTML = strHTML & "<table align='center' id='fleetTable'  cellpadding='1' cellspacing='0' width='95%'>" & vbCrLf
                End If


                ' tr start for Logo
                strHTML = strHTML & "<tr id='trInner_Content_AC_PIC'>" & vbCrLf
                If Me.logo_check.Checked = True Then
                    strHTML = strHTML & "<td  id='tdInner_Content_AC_PIC' align='center' colspan='3' width='95%'>"
                    strHTML = strHTML & get_company_images(real_make_model_name)
                Else
                    strHTML = strHTML & "<td  id='tdInner_Content_AC_PIC' align='center' colspan='3' width='95%'><img src='" & location_string & "images/marketpdfheader.jpg' />" & vbCrLf
                End If
                ' get the AC pic

                strHTML = strHTML & "</td>" & vbCrLf
                strHTML = strHTML & "</tr>" & vbCrLf
            End If

            '    strHTML = strHTML & "<tr><td colspan='3' align='center' valign='middle'><strong>" & UCase(real_make_model_name) & " Fleet/Market Summary</strong></td></tr>" & vbCrLf '<tr><td colspan='3'>&nbsp;</td></tr>
            strHTML = strHTML & "<tr>" & vbCrLf

            ' Ownership table
            If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                strHTML = strHTML & "<td align='right' valign='top' class='FleetMarket_Left_TD' width='" & word_half & "'>"
                strHTML = strHTML & "<table id='lifeCycleTable'  cellspacing='0' cellpadding='4' width='" & word_half & "'>" & vbCrLf
            Else
                strHTML = strHTML & "<td align='right' valign='top' class='FleetMarket_Left_TD' width='50%'>"
                strHTML = strHTML & "<table id='lifeCycleTable'  cellspacing='0' cellpadding='4' width='100%'>" & vbCrLf
            End If



            strHTML = strHTML & "<tr><td valign='middle' align='center' colspan='2'><strong>Ownership</strong></td></tr>" & vbCrLf ' <tr><td>&nbsp;</td></tr>

            If CLng(w_owner) > 0 Then
                strHTML = strHTML & "<tr><td valign='top' align='left' >Whole:&nbsp;</td><td align='right'>" & FormatNumber(w_owner, 0, True, False, True) & "</td></tr>" & vbCrLf
            Else
                strHTML = strHTML & "<tr><td valign='top' align='left' >Whole:&nbsp;</td><td align='right'>&nbsp;0</td><td>&nbsp;</td></tr>" & vbCrLf
            End If

            If CLng(s_owner) > 0 Then
                strHTML = strHTML & "<tr><td valign='top' align='left' >Shared:&nbsp;</td><td align='right'>&nbsp;" & FormatNumber(s_owner, 0, True, False, True) & "</td></tr>" & vbCrLf
            Else
                strHTML = strHTML & "<tr><td valign='top' align='left' >Shared:&nbsp;</td><td align='right'>&nbsp;0</td><td>&nbsp;</td></tr>" & vbCrLf
            End If

            If CLng(f_owner) > 0 Then
                strHTML = strHTML & "<tr><td valign='top' align='left' >Fractional:&nbsp;</td><td align='right'>&nbsp;" & FormatNumber(f_owner, 0, True, False, True) & "</td></tr>" & vbCrLf
            Else
                strHTML = strHTML & "<tr><td valign='top' align='left' >Fractional:&nbsp;</td><td align='right'>&nbsp;0</td><td>&nbsp;</td></tr>" & vbCrLf
            End If

            If CLng(totalInOpcount) > 0 Then
                strHTML = strHTML & "<tr><td bgcolor='#F8F8F8' valign='top' align='left'  nowrap='nowrap'>Total Aircraft:&nbsp;</td><td  bgcolor='#F8F8F8' align='right'>&nbsp;" & FormatNumber(totalInOpcount, 0, True, False, True) & "</td></tr>" & vbCrLf
            Else
                strHTML = strHTML & "<tr><td bgcolor='#F8F8F8' valign='top' align='left'  nowrap='nowrap'>Total Aircraft:&nbsp;</td><td align='right'>&nbsp;0</td><td>&nbsp;</td></tr>" & vbCrLf
            End If

            If CLng(alllow) > 0 And CLng(allhigh) > 0 Then
                strHTML = strHTML & "<tr><td valign='top' align='left' class='border_bottom' nowrap='nowrap'><strong>MFR Year Range:</strong>&nbsp;</td><td align='right'>&nbsp;" & alllow & " - " & allhigh & "</td><td>&nbsp;</td></tr>" & vbCrLf
            ElseIf CLng(alllow) > 0 And CLng(allhigh) = 0 Then
                strHTML = strHTML & "<tr><td valign='top' align='left' class='border_bottom' nowrap='nowrap'><strong>MFR Year Range:</strong>&nbsp;</td><td align='right'>&nbsp;" & alllow & " - To Present</td></tr>" & vbCrLf
            Else
                strHTML = strHTML & "<tr><td valign='top' align='left' class='border_bottom' nowrap='nowrap'><strong>MFR Year Range:</strong>&nbsp;</td><td align='right'>&nbsp;N/A</td></tr>" & vbCrLf
            End If

            strHTML = strHTML & "<tr><td>&nbsp;</td><td>&nbsp;</td></tr></table></td>" & vbCrLf
            ' spacer
            strHTML = strHTML & "<td rowspan='7' class='FleetMarket_Right_TD'>&nbsp;</td>" & vbCrLf

            ' Fleet Info


            If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                strHTML = strHTML & "<td align='left' class='FleetMarket_Right_TD' width='" & word_half & "'>" & vbCrLf
                strHTML = strHTML & "<table id='lifeCycleTable' cellspacing='0' cellpadding='4' width='" & word_half & "'>" & vbCrLf
            Else
                strHTML = strHTML & "<td align='left' class='FleetMarket_Right_TD' width='50%'>" & vbCrLf
                strHTML = strHTML & "<table id='lifeCycleTable' cellspacing='0' cellpadding='4' width='100%'>" & vbCrLf
            End If

            strHTML = strHTML & "<tr><td valign='top' align='center' colspan='2'><strong>Life Cycle</strong></td></tr>" & vbCrLf ' <tr><td>&nbsp;</td></tr>

            If CLng(o_stage) > 0 Then
                strHTML = strHTML & "<tr><td valign='top' align='left' >In Production:&nbsp;</td><td align='right'>&nbsp;" & FormatNumber(o_stage, 0, True, False, True) & "</td></tr>" & vbCrLf
            Else
                strHTML = strHTML & "<tr><td valign='top' align='left' >In Production:&nbsp;</td><td align='right'>&nbsp;0</td></tr>" & vbCrLf
            End If

            If CLng(t_stage) > 0 Then
                strHTML = strHTML & "<tr><td valign='top' align='left' >At MFR:&nbsp;</td><td align='right'>&nbsp;" & FormatNumber(t_stage, 0, True, False, True) & "</td></tr>" & vbCrLf
            Else
                strHTML = strHTML & "<tr><td valign='top' align='left' >At MFR:&nbsp;</td><td align='right'>&nbsp;0</td></tr>" & vbCrLf
            End If

            If CLng(th_stage) > 0 Then
                strHTML = strHTML & "<tr><td valign='top' align='left' >In Operation:&nbsp;</td><td align='right'>&nbsp;" & FormatNumber(th_stage, 0, True, False, True) & "</td></tr>" & vbCrLf
            Else
                strHTML = strHTML & "<tr><td valign='top' align='left' >In Operation:&nbsp;</td><td align='right'>&nbsp;0</td></tr>" & vbCrLf
            End If

            If CLng(f_stage) > 0 Then
                strHTML = strHTML & "<tr><td valign='top' align='left' >Retired:&nbsp;</td><td align='right'>&nbsp;" & FormatNumber(f_stage, 0, True, False, True) & "</td></tr>" & vbCrLf
            Else
                strHTML = strHTML & "<tr><td valign='top' align='left' >Retired:&nbsp;</td><td align='right'>&nbsp;0</td></tr>" & vbCrLf
            End If

            If CLng(totalcount) > 0 Then
                strHTML = strHTML & "<tr><td valign='top'  bgcolor='#F8F8F8' align='left' class='border_bottom'><strong>Total Aircraft:</strong>&nbsp;</td><td align='right'>&nbsp;" & FormatNumber(totalcount, 0, True, False, True) & "</td><td>&nbsp;</td></tr>" & vbCrLf
            Else
                strHTML = strHTML & "<tr bgcolor='#F8F8F8'><td valign='top' align='left' class='border_bottom'><strong>Total Aircraft:</strong>&nbsp;</td><td  class='border_bottom' align='right' bgcolor='#F8F8F8'>&nbsp;0</td><td>&nbsp;</td></tr>" & vbCrLf
            End If

            strHTML = strHTML & "<tr><td>&nbsp;</td></tr></table>" & vbCrLf

            strHTML = strHTML & "</td></tr><tr>" & vbCrLf

            Build_FleetMarketSummary = Trim(strHTML)
            Dim GetMarketStatus As String = ""
            GetMarketStatus = "<td align='center'  width='15%' class='FleetMarket_Bottom_TD' colspan='3'>"
            If Trim(header_y_or_n) = "N" Then
                GetMarketStatus = GetMarketStatus & "<table width='100%'><tr><td align='right'>"
            End If
            GetMarketStatus = GetMarketStatus & "<table id='marketPlaceStatusTable' cellspacing='0' cellpadding='4' colspan='2'>" & vbCrLf '<tr>&nbsp;</tr>
            GetMarketStatus = GetMarketStatus & "<tr><td valign='top' align='center' colspan='2'><strong>Market Status</strong></td></tr>" & vbCrLf

            If CLng(ac_for_sale) > 0 Then
                If Not HttpContext.Current.Session.Item("localPreferences").AerodexFlag Then
                    GetMarketStatus = GetMarketStatus & "<tr><td valign='top' align='left' >For Sale:&nbsp;</td><td align='left'>" & FormatNumber(ac_for_sale, 0, True, False, True) & "&nbsp;<span class='tiny'>(" & FormatNumber(per, 1) & "% of In Operation)</span></td></tr>" & vbCrLf
                Else
                    GetMarketStatus = GetMarketStatus & "<tr><td valign='top' align='left' >For Sale:&nbsp;</td><td align='left'>" & FormatNumber(ac_for_sale, 0, True, False, True) & " &nbsp;<span class='tiny'>(" & FormatNumber(per, 1) & "% of In Operation)</span></td></tr>" & vbCrLf
                End If
            Else
                GetMarketStatus = GetMarketStatus & "<tr><td valign='top' align='left' >For Sale:&nbsp;</td><td align='left'>0 <span class='tiny'>(0% of In Operation)</span></td></tr>" & vbCrLf
            End If

            If Trim(forsaleavlow) <> "0" And Trim(forsaleavghigh) <> "0" Then
                GetMarketStatus = GetMarketStatus & "<tr><td valign='top' align='left' >Asking Price Range:&nbsp;</td><td align='left'>" & forsaleavlow & " - " & forsaleavghigh & "</td></tr>" & vbCrLf
            Else
                GetMarketStatus = GetMarketStatus & "<tr><td valign='top' align='left' >Asking Price Range:&nbsp;</td><td align='left'>No Asking Prices</td></tr>" & vbCrLf
            End If

            If Not HttpContext.Current.Session.Item("localPreferences").AerodexFlag Then
                ' THIS IS FOR ON EXCLUSIVE %
                If CLng(ac_exclusive_sale) > 0 Then
                    GetMarketStatus = GetMarketStatus & "<tr><td valign='top' align='left' >On Exclusive:&nbsp;</td><td align='left'>" & FormatNumber(ac_exclusive_sale, 0, True, False, True) & " <span class='tiny'>(" & FormatNumber(per2, 1) & "% of For Sale on Exclusive)</span></td></tr>" & vbCrLf
                Else
                    GetMarketStatus = GetMarketStatus & "<tr><td valign='top' align='left' >On Exclusive:&nbsp;</td><td align='left'>(0% of For Sale on Exclusive)</span></td></tr>" & vbCrLf
                End If

            End If

            If Trim(avgyear) <> "0" Then
                GetMarketStatus = GetMarketStatus & "<tr><td valign='top' align='left' >Avg MFG Year:&nbsp;</td><td align='left'>" & avgyear & "</td></tr>" & vbCrLf
            Else
                GetMarketStatus = GetMarketStatus & "<tr><td valign='top' align='left' >Avg MFG Year:&nbsp;</td><td align='v'>N/A</td></tr>" & vbCrLf
            End If

            If Trim(days) <> "" Then
                GetMarketStatus = GetMarketStatus & "<tr><td valign='top' align='left' >Avg Days on Market:&nbsp;</td><td align='left'>" & days & "</td></tr>" & vbCrLf
            Else
                GetMarketStatus = GetMarketStatus & "<tr><td valign='top' align='left' >Avg Days on Market:&nbsp;</td><td align='left'>N/A</td></tr>" & vbCrLf
            End If

            If CLng(ac_lease) > 0 Then
                GetMarketStatus = GetMarketStatus & "<tr><td valign='top' align='left' >Leased:&nbsp;</td><td align='left'>" & FormatNumber(ac_lease, 0, True, False, True) & "<span class='tiny'>(" & FormatNumber(per3, 1) & "% of In Operation)</span></td></tr>" & vbCrLf
            Else
                GetMarketStatus = GetMarketStatus & "<tr><td valign='top' align='left' >Leased:&nbsp;</td><td align='left'>0 <span class='tiny'>(0% of In Operation)</span></td></tr>" & vbCrLf
            End If





            GetMarketStatus = GetMarketStatus & "<tr><td>&nbsp;</td></tr></table>"

            If Trim(header_y_or_n) = "Y" Then
                ' GetMarketStatus = GetMarketStatus & "</td><td align='left' width='42%'>&nbsp;</td></tr>" & vbCrLf
                GetMarketStatus = GetMarketStatus & "</td></tr>" & vbCrLf
                ' add the spacer to move the footer down
                GetMarketStatus = GetMarketStatus & "<tr>" & vbCrLf
                GetMarketStatus = GetMarketStatus & "<td  align='center'  id='tdInnerTableSetup' colspan='1'>" & vbCrLf
                GetMarketStatus = GetMarketStatus & "&nbsp;" & vbCrLf
                GetMarketStatus = GetMarketStatus & "</td>" & vbCrLf
                GetMarketStatus = GetMarketStatus & "</tr></table>" & vbCrLf

                ' GetMarketStatus = GetMarketStatus & aircraft_sales_by_year(amod_id) 'Show_Average_Year()
            Else


            End If

            If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = False Then
                Build_FleetMarketSummary = Build_FleetMarketSummary & GetMarketStatus
            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Build_FleetMarketSummary: " & ex.Message
        End Try
    End Function

    Public Function NEW_Build_MarketStatus(ByVal inModelID As Long, ByVal bIsAcContactTypeView As Boolean, ByVal inMakeName As String, ByRef foot_space_market_summary As String, ByVal header_y_or_n As String, ByRef guage_string As String, ByRef searchCriteria As viewSelectionCriteriaClass) As String
        NEW_Build_MarketStatus = ""

        Dim strHTML As String = ""
        Dim GetMarketStatus As String = ""
        Dim amod_count As Integer = 0


        Try

            If Me.MR_CMS.Checked = True Then

                GetMarketStatus = ""
                If inModelID > 0 Then

                    GetFleetInfo(inModelID, False, searchCriteria)
                    forsaleavg = Replace(forsaleavg, "$", "")
                    forsaleavg = Replace(forsaleavg, "k", "")
                    ' GetMarketStatus = GetMarketStatus & "<tr><td valign='middle' align='left' colspan='10'><font class='" & Session("FONT_CLASS_HEADER") & "'>" & real_make_model_name & "<font class='" & Session("FONT_CLASS_HEADER_BIG") & "'> MARKET OVERVIEW</font></font></td></tr>" & vbCrLf ' <tr><td>&nbsp;</td></tr>

                    GetMarketStatus = GetMarketStatus & "<tr><td valign='middle' align='left' colspan='3'><font class='" & Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & real_make_model_name & "</strong> Market Indices" & valueEmptyHeaderString & "</font></td></tr>" & vbCrLf ' <tr><td>&nbsp;</td></tr>

                    GetMarketStatus = GetMarketStatus & "<tr><td valign='middle' align='center' colspan='3' width='100%' class=""tickerBox""><div class=""Box"" style=""text-align:center;position:relative;"">"

                    GetMarketStatus = GetMarketStatus & DisplayFunctions.make_MTREND_CHANGE_TICKERS(inModelID, localCriteria.ViewCriteriaTimeSpan, aclsData_Temp_aspx, ac_for_sale, days, forsaleavg, in_op_count, total_in_op, "", searchCriteria.ViewCriteriaAircraftModel.ToString)

                    GetMarketStatus = GetMarketStatus & "<div class=""clear""></div></div></td></tr>"

                Else
                    Dim amod_id_Array(100) As String
                    Dim i As Integer = 0
                    Dim temp_make_model As String = ""
                    amod_id_Array = Split(searchCriteria.ViewCriteriaAircraftModel.ToString, ",")

                    GetMarketStatus = GetMarketStatus & "<tr><td valign='middle' align='center' colspan='3' width='100%' class=""tickerBox"">"
                    GetMarketStatus = GetMarketStatus & "<font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>Market Indices " & valueEmptyHeaderString & "</font>"
                    GetMarketStatus = GetMarketStatus & "<div class=""clear""></div></td></tr>"

                    For i = 0 To UBound(amod_id_Array)

                        If amod_count > 8 Then
                            Call Make_Page_Break_End_Start(GetMarketStatus)
                            amod_count = 0
                        End If

                        amod_count += 1
                        GetFleetInfo(amod_id_Array(i), False, searchCriteria)
                        temp_make_model = Get_Model_Name(amod_id_Array(i)).ToString

                        ' GetMarketStatus = GetMarketStatus & "<tr><td valign='middle' align='left' colspan='3'><font class='" & Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & temp_make_model & "</strong> Market Indices " & valueEmptyHeaderString & "</font></td></tr>" & vbCrLf ' <tr><td>&nbsp;</td></tr>
                        GetMarketStatus = GetMarketStatus & "<tr><td valign='middle' align='center' colspan='3' width='100%' class=""tickerBox"">"
                        'GetMarketStatus = GetMarketStatus & "<div class=""Box"" style=""text-align:center;position:relative;"">"
                        GetMarketStatus = GetMarketStatus & "<font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>" & temp_make_model & "</font>"
                        GetMarketStatus = GetMarketStatus & DisplayFunctions.make_MTREND_CHANGE_TICKERS(amod_id_Array(i), localCriteria.ViewCriteriaTimeSpan, aclsData_Temp_aspx, ac_for_sale, days, forsaleavg, in_op_count, total_in_op, "")
                        GetMarketStatus = GetMarketStatus & "<div class=""clear""></div></td></tr>"
                    Next

                    Call Make_Page_Break_End_Start(GetMarketStatus)

                    ' GET TOTALS FOR THE REST OF THE SECTIONS
                    GetFleetInfo(0, False, searchCriteria)

                End If



                ' GetMarketStatus = GetMarketStatus & "<tr><td valign='middle' align='center' colspan='10' height='1' style='border-bottom:1px solid lightgrey;'>&nbsp;</td></tr>"
                GetMarketStatus = GetMarketStatus & "<tr><td valign='middle' align='center' colspan='3'>&nbsp;</td></tr>"
                GetMarketStatus = GetMarketStatus & "<tr><td valign='middle' align='left' colspan='3'><font class='" & Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & real_make_model_name & "</strong> Market Trends " & valueEmptyHeaderString & "</font></td></tr>" & vbCrLf ' <tr><td>&nbsp;</td></tr>

                GetMarketStatus &= "<tr valign='top'><td align='center' class=""Box borderBottom"">"
                GetMarketStatus &= "<font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>For Sale By Month <strong>past " & localCriteria.ViewCriteriaTimeSpan & " months</strong></font><img src='" & valueGraphText16.Text & "' width='100%' align='center' />"

                GetMarketStatus &= "</td><td width=""40"">&nbsp;</td><td align='center' valign='top' width=""52%"">"



                'GetMarketStatus = GetMarketStatus & "<div class=""Box marginTop""><table id='marketPlaceStatusTable' cellspacing='0' cellpadding='0' class='formatTable " & table_color & "  large' width='100%'><thead>" & vbCrLf '<tr>&nbsp;</tr>
                'GetMarketStatus = GetMarketStatus & "<tr><th valign='top' align='left' colspan='2' class='center upperCase'>Market Summary</th></tr>" & vbCrLf
                'GetMarketStatus = GetMarketStatus & "</thead><tbody>"


                'If CLng(totalInOpcount) > 0 Then
                '  GetMarketStatus = GetMarketStatus & "<tr><td valign='top' align='left' class='upperCase'>In Operation:&nbsp;</td><td align='left'>" & FormatNumber(totalInOpcount, 0, True, False, True) & "</td></tr>" & vbCrLf
                'Else
                '  GetMarketStatus = GetMarketStatus & "<tr><td valign='top' align='left' class='upperCase'>In Operation:&nbsp;</td><td align='left'>0</td></tr>" & vbCrLf
                'End If

                'If CLng(ac_for_sale) > 0 Then
                '  If Not HttpContext.Current.Session.Item("localPreferences").AerodexFlag Then
                '    GetMarketStatus = GetMarketStatus & "<tr><td valign='top' align='left' class='upperCase'>For Sale:&nbsp;</td><td align='left'>" & FormatNumber(ac_for_sale, 0, True, False, True) & "&nbsp;<span class='tiny'>(" & FormatNumber(per, 1) & "% of In Operation)</span></td></tr>" & vbCrLf
                '  Else
                '    GetMarketStatus = GetMarketStatus & "<tr><td valign='top' align='left' class='upperCase'>For Sale:&nbsp;</td><td align='left'>" & FormatNumber(ac_for_sale, 0, True, False, True) & " &nbsp;<span class='tiny'>(" & FormatNumber(per, 1) & "% of In Operation)</span></td></tr>" & vbCrLf
                '  End If
                'Else
                '  GetMarketStatus = GetMarketStatus & "<tr><td valign='top' align='left' class='upperCase'>For Sale:&nbsp;</td><td align='left'>0 <span class='tiny'>(0% of In Operation)</span></td></tr>" & vbCrLf
                'End If

                'If Not HttpContext.Current.Session.Item("localPreferences").AerodexFlag Then
                '  ' THIS IS FOR ON EXCLUSIVE %
                '  If CLng(ac_exclusive_sale) > 0 Then
                '    GetMarketStatus = GetMarketStatus & "<tr><td valign='top' align='left' class='upperCase'>On Exclusive:&nbsp;</td><td align='left'>" & FormatNumber(ac_exclusive_sale, 0, True, False, True) & " <span class='tiny'>(" & FormatNumber(per2, 1) & "% of For Sale)</span></td></tr>" & vbCrLf
                '  Else
                '    GetMarketStatus = GetMarketStatus & "<tr><td valign='top' align='left' class='upperCase'>On Exclusive:&nbsp;</td><td align='left'>(0% of For Sale on Exclusive)</span></td></tr>" & vbCrLf
                '  End If

                'End If


                'If CLng(ac_lease) > 0 Then
                '  GetMarketStatus = GetMarketStatus & "<tr><td valign='top' align='left' class='upperCase'>Leased:&nbsp;</td><td align='left'>" & FormatNumber(ac_lease, 0, True, False, True) & " <span class='tiny'>(" & FormatNumber(per3, 1) & "% of In Operation)</span></td></tr>" & vbCrLf
                'Else
                '  GetMarketStatus = GetMarketStatus & "<tr><td valign='top' align='left' class='upperCase'>Leased:&nbsp;</td><td align='left'>0 <span class='tiny'>(0% of In Operation)</span></td></tr>" & vbCrLf
                'End If



                'GetMarketStatus = GetMarketStatus & "</tbody></table></div>"
                GetMarketStatus = GetMarketStatus & DisplayFunctions.BuildViewMarketSummaryBox("large", table_color, totalInOpcount, ac_for_sale, ac_exclusive_sale, ac_lease, per, per2, per3)
                GetMarketStatus = GetMarketStatus & "<Br/><div class=""Box gaugeImage""><font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>ABSORPTION RATE</font><img src='" & valueGraphTextGuage1.Text & "' width='320' align='center'  /></div>"

                GetMarketStatus = GetMarketStatus & "</td></tr>"
                '
                '  GetMarketStatus = GetMarketStatus & "<tr><td valign='middle' align='center' colspan='10' height='1' style='border-bottom:1px solid lightgrey;'>&nbsp;</td></tr>"
                GetMarketStatus = GetMarketStatus & "<tr><td valign='middle' align='center' colspan='3'>&nbsp;</td></tr>"

                GetMarketStatus = GetMarketStatus & "<Tr><td align='center' valign='top' class=""Box borderBottom"">"

                GetMarketStatus &= "<font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>Avg Asking Price By Month <strong>past " & localCriteria.ViewCriteriaTimeSpan & " months</strong></font><img src='" & valueGraphText15.Text & "' width='100%'  align='center' />"

                GetMarketStatus &= "</td><td width=""40"">&nbsp;</td>"

                If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                    GetMarketStatus = GetMarketStatus & "<td align='right' valign='top' width='" & word_32 & "' >" '<div class=""Box marginTop"">"
                    '' GetMarketStatus = GetMarketStatus & "<table align='center' cellpadding='0'><tr><td valign='middle' align='center' colspan='4' border='none'>Market Composition</td></tr></table>"
                    'GetMarketStatus = GetMarketStatus & "<table id='lifeCycleTable'  cellspacing='0' cellpadding='0' width='" & word_32 & "' class='formatTable " & table_color & "'><thead>" & vbCrLf
                Else
                    GetMarketStatus = GetMarketStatus & "<td align='center' valign='top'>" '<div class=""Box marginTop"">"
                    '  GetMarketStatus = GetMarketStatus & "<table align='center' cellpadding='0'><tr><td valign='middle' align='center' colspan='4' border='none'>Market Composition</td></tr></table>"
                    ' GetMarketStatus = GetMarketStatus & "<table id='lifeCycleTable'  cellspacing='0' cellpadding='0' class='formatTable " & table_color & " large' width='100%'><thead>" & vbCrLf
                End If

                'If Trim(Request("ViewID")) = "998" Then
                '  GetMarketStatus = GetMarketStatus & "<tr><th valign='top' align='left' class='upperCase'>Market<br/>Composition&nbsp;</th><th valign='top' class='upperCase right'>Low&nbsp;</th><th valign='top' class='upperCase right'>Avg&nbsp;</th><th valign='top' class='upperCase right'>High&nbsp;</th></tr>" & vbCrLf
                'Else
                '  GetMarketStatus = GetMarketStatus & "<tr><th valign='top' align='left' class='upperCase'>Market Composition&nbsp;</th><th valign='top' class='upperCase right'>Low&nbsp;</th><th valign='top' class='upperCase right'>Avg&nbsp;</th><th valign='top' class='upperCase right'>High&nbsp;</th></tr>" & vbCrLf
                'End If

                'GetMarketStatus = GetMarketStatus & "</thead><tbody>"
                'GetMarketStatus = GetMarketStatus & "<tr><td valign='top' align='left' nowrap='nowrap' class='upperCase'>Asking Price:&nbsp;</td>"
                'GetMarketStatus = GetMarketStatus & "<td align='right'>" & forsaleavlow & "</td>"
                'GetMarketStatus = GetMarketStatus & "<td align='right'>$" & FormatNumber(forsaleavg, 0) & "k</td>"  '  " &  & "
                'GetMarketStatus = GetMarketStatus & "<td align='right'>" & forsaleavghigh & "</td>"
                'GetMarketStatus = GetMarketStatus & "</tr>"

                'GetMarketStatus = GetMarketStatus & "<tr><td valign='top' align='left' nowrap='nowrap' class='upperCase'>MFR Year:&nbsp;</td>"
                'GetMarketStatus = GetMarketStatus & "<td align='right'>" & mfr_low_fs & "</td>"
                'GetMarketStatus = GetMarketStatus & "<td align='right'>" & mfr_avg_fs & "</td>"
                'GetMarketStatus = GetMarketStatus & "<td align='right'>" & mfr_high_fs & "</td>"
                'GetMarketStatus = GetMarketStatus & "</tr>"

                'GetMarketStatus = GetMarketStatus & "<tr><td valign='top' align='left' nowrap='nowrap' class='upperCase'>Days on Market:&nbsp;</td>"
                'GetMarketStatus = GetMarketStatus & "<td align='right'>" & FormatNumber(lowdays, 0) & "</td>"
                'GetMarketStatus = GetMarketStatus & "<td align='right'>" & FormatNumber(days, 0) & "</td>"
                'GetMarketStatus = GetMarketStatus & "<td align='right'>" & FormatNumber(highdays, 0) & "</td>"
                'GetMarketStatus = GetMarketStatus & "</tr>"

                'GetMarketStatus = GetMarketStatus & "<tr><td valign='top' align='left' nowrap='nowrap' class='upperCase'>Airframe Time:&nbsp;</td>"
                'GetMarketStatus = GetMarketStatus & "<td align='right'>" & FormatNumber(aftt_low_fs, 0) & "</td>"
                'GetMarketStatus = GetMarketStatus & "<td align='right'>" & FormatNumber(aftt_avg_fs, 0) & "</td>"
                'GetMarketStatus = GetMarketStatus & "<td align='right'>" & FormatNumber(aftt_high_fs, 0) & "</td>"
                'GetMarketStatus = GetMarketStatus & "</tr>"


                'GetMarketStatus = GetMarketStatus & "</tbody></table></div>"
                GetMarketStatus = GetMarketStatus & DisplayFunctions.BuildViewMarketCompositionBox("large", table_color, forsaleavlow, forsaleavg, forsaleavghigh, mfr_low_fs, mfr_avg_fs, mfr_high_fs, lowdays, days, highdays, aftt_low_fs, aftt_avg_fs, aftt_high_fs)

                GetMarketStatus = GetMarketStatus & "<Br/><div class=""Box gaugeImage""><font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>AVERAGE ASKING</font><img src='" & valueGraphTextGuage2.Text & "' width='320' align='center' /></div>"

                GetMarketStatus = GetMarketStatus & "</td>"
                GetMarketStatus = GetMarketStatus & "</tr>"


                NEW_Build_MarketStatus = GetMarketStatus



                Dim min_value As Long = 0
                Dim max_value As Long = 0
                Dim temp_val As Long = 0
                Dim points_string As String = ""
                Dim step_amount As Long = 0
                Dim major_ticks As Long = 0


                forsaleavlow = Replace(Replace(forsaleavlow, ",", ""), "k", "")
                forsaleavg = Replace(Replace(forsaleavg, ",", ""), "k", "")
                forsaleavghigh = Replace(Replace(forsaleavghigh, ",", ""), "k", "")

                min_value = 0
                max_value = 0
                major_ticks = 5
                Call Make_Guage_Totals(forsaleavlow, min_value, "low")

                Call Make_Guage_Totals(forsaleavghigh, max_value, "high")


                ' BUILD GUAGE SECTION----------------------
                guage_string = ""

                ' If Not Page.IsPostBack Then
                ForSaleGaugeJavascript(guage_string, HighSalesPrice, LowSalesPrice, AvgSalesPrice)
                BuildLengthOfOwnershipGauge(guage_string, localCriteria)
                BuildDaysOnMarketGauge(guage_string, days)

                'End If
                guage_string &= "  function initGauge_AvgAsking() { var gauge = new RadialGauge({ renderTo:  'scripted-gauge2',"
                guage_string &= " width: 400, height: 300, units: false," ' units: ""$" & FormatNumber(forsaleavg, 0) & "k""," 
                guage_string &= " fontTitleSize: ""34"","
                guage_string &= " fontTitle:""Arial"","
                guage_string &= "colorTitle:  '#4f5050',"

                ' guage_string &= " title: ""AVERAGE ASKING"","
                guage_string &= " title: ""$" & FormatNumber(forsaleavg, 0) & "k"", "
                guage_string &= "  startAngle: 90, SweepAngle: 180, valueBox: false, ticksAngle: 180, exactTicks: true, "
                guage_string &= "  minValue: " & min_value & ",  maxValue: " & max_value & ","
                guage_string &= " majorTicks: false, minorTicks: 0,strokeTicks: false,"
                'points_string = ""
                ' Call Make_Guage_Ticks(min_value, max_value, major_ticks, points_string, step_amount)

                'guage_string &= points_string

                'Color of the bottom text, like 9 months under the absorption rate gauge.
                guage_string &= " colorUnits: ""#000000"","
                'Size of bottom text.
                guage_string &= " fontUnitsSize: ""30"","
                guage_string &= "highlights: false,animation: false,"
                guage_string &= "barWidth: 25,"
                guage_string &= "barProgress: true,"

                If Trim(graph_color_new) <> "" Then
                    guage_string &= "colorBarProgress:  '" & Trim(graph_color_new) & "',"
                Else
                    guage_string &= "colorBarProgress:  '#078fd7',"
                End If



                guage_string &= "needle: false,"
                guage_string &= "colorBar:  '#eee',"
                guage_string &= "colorStrokeTicks: '#fff',"
                guage_string &= "numbersMargin: -18,"
                guage_string &= "  colorPlate: ""rgba(0,0,0,0)""," 'Make background transparent.
                'guage_string &= "colorMajorTicks:  '#2a62aa',"
                'guage_string &= "colorNumbers:  '#1d3566',"
                'guage_string &= "colorNeedle:  '#1d3566',"
                'guage_string &= "colorNeedleEnd:  '#2a62aa',"
                guage_string &= "    borderShadowWidth: 0,"
                guage_string &= "    borders: false,"
                'guage_string &= "    needleType: ""arrow"","
                'guage_string &= "   needleWidth: 2,"
                'guage_string &= "  needleCircleSize: 7,"
                'guage_string &= "  needleCircleOuter: true,"
                'guage_string &= "  needleCircleInner: false,"
                'guage_string &= " animationDuration: 1500,"
                guage_string &= "  value: " & Replace(forsaleavg, "$", "") & ","
                'guage_string &= "  animationRule: ""linear"""
                guage_string &= "}).draw();"



                guage_string &= "  var canvas = document.getElementById(""scripted-gauge2"");"
                '  guage_string &= "   google.visualization.events.addListener(canvas, 'ready', function() {" 
                guage_string &= "  var img = canvas.toDataURL(""image/png"");"
                '  guage_string &= "  console.log(img); "
                ' guage_string &= "  var img = canvas.toDataURL();"
                guage_string &= " document.getElementById('" & pngGuage2.ClientID & "').innerHTML = '<img src=""' + img + '"">'"
                '  guage_string &= " document.getElementById('" & pngGuage1.ClientID & "').innerHTML = img "
                ' guage_string &= "});"
                guage_string &= " }"
                ' BUILD GUAGE SECTION----------------------


            End If



            If inModelID = 0 Then
                Call Make_Page_Break_End_Start(NEW_Build_MarketStatus)
                NEW_Build_MarketStatus &= ("<tr><td valign='middle' class='left' colspan='10'><font class='" & Session("FONT_CLASS_HEADER") & "  mainHeading'><strong>" & real_make_model_name & "</strong> Sales Insight " & valueEmptyHeaderString & "</font></td></tr>")

                NEW_Build_MarketStatus &= ("<Tr><td align='center' valign=""top""><div class=""Box""><font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>Retail Sales Per Month<strong>Past " & localCriteria.ViewCriteriaTimeSpan & " Months</strong></font><img src='" & valueGraphText18.Text & "' width='100%' />")
                NEW_Build_MarketStatus &= ("</div></td><td>&nbsp;</td><td align='center' valign=""top"" width=""485""><div class=""Box"">")
                NEW_Build_MarketStatus &= (make_sold_table_values(amod_id))
                NEW_Build_MarketStatus &= ("</div></td></tr>")
            End If



        Catch ex As Exception

        End Try

    End Function
    Public Sub Make_Page_Break_End_Start(ByRef string_temp As String)
        string_temp = string_temp & ("</table>")
        string_temp = string_temp & (comp_functions.NEW_Insert_Page_Break_PDF(0, WD.SelectedValue))
        string_temp = string_temp & (temp_pdf_header)
        If bWordReport = True Then
            string_temp = string_temp & ("<table width='" & word_width & "' align='center' cellpadding='3'>")
        Else
            string_temp = string_temp & ("<table width='" & pdf_html_width & "' align='center' cellpadding='3'>")
        End If
    End Sub
    Public Sub BuildLengthOfOwnershipGauge(ByRef gaugeString As String, ByVal searchCriteria As viewSelectionCriteriaClass)

        Dim Results_Table As New DataTable
        Dim newYears As Double = 0
        Dim preYears As Double = 0
        star_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
        star_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
        star_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
        star_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
        star_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

        'Results_Table = star_functions.get_max_star_report_date(searchCriteria)

        'If Not IsNothing(Results_Table) Then
        '    If Results_Table.Rows.Count > 0 Then
        '        For Each r As DataRow In Results_Table.Rows

        '            If Not IsDBNull(r.Item("ac1_start_date")) Then
        '                If Not String.IsNullOrEmpty(r.Item("ac1_start_date").ToString.Trim) Then
        '                    searchCriteria.ViewCriteriaStarReportDate = CDate(r.Item("ac1_start_date").ToString)
        '                End If
        '            End If
        '        Next
        '    End If
        'End If

        Results_Table = star_functions.get_max_star_report_date_Number(searchCriteria, 4)

        If Not IsNothing(Results_Table) Then
            If Results_Table.Rows.Count > 0 Then
                For Each r As DataRow In Results_Table.Rows

                    If Not IsDBNull(r.Item("ac4_start_date")) Then
                        If Not String.IsNullOrEmpty(r.Item("ac4_start_date").ToString.Trim) Then
                            searchCriteria.ViewCriteriaStarReportDate = CDate(r.Item("ac4_start_date").ToString)
                        End If
                    End If
                Next
            End If
        End If



        Results_Table = star_functions.get_star_aircraft_4_info(searchCriteria)
        If Not IsNothing(Results_Table) Then
            If Results_Table.Rows.Count > 0 Then
                newYears = Results_Table.Rows(0).Item("ac4_new_years_owned")
                preYears = Results_Table.Rows(0).Item("ac4_used_years_owned")
            End If
        End If

        'gaugeString = ""
        gaugeString &= "  function initGauge_LengthOfOwnership() { var gauge = new RadialGauge({ renderTo:  'scripted-gauge4',"
        gaugeString &= " width: 400, height: 300, units: false,"
        gaugeString &= " fontTitleSize: ""34"","
        gaugeString &= " fontTitle:""Arial"","
        gaugeString &= "colorTitle:  '#4f5050',"

        gaugeString &= " title: """ & newYears.ToString & " Years"", "
        gaugeString &= "  startAngle: 90, SweepAngle: 180, valueBox: false, ticksAngle: 180, exactTicks: true, "
        gaugeString &= "  minValue: 0,  maxValue: " & IIf(newYears < 10, 10, newYears + 2) & ","
        gaugeString &= " majorTicks: false, minorTicks: 0,strokeTicks: false,"
        gaugeString &= " colorUnits: ""#000000"","
        gaugeString &= " fontUnitsSize: ""30"","
        gaugeString &= "highlights: false,animation: false,"
        gaugeString &= "barWidth: 25,"
        gaugeString &= "barProgress: true,"

        If Trim(graph_color_new) <> "" Then
            gaugeString &= vbNewLine & "colorBarProgress:  '" & Trim(graph_color_new) & "',"
        Else
            gaugeString &= "colorBarProgress:  '#078fd7',"
        End If

        gaugeString &= "needle: false,"
        gaugeString &= "colorBar:  '#eee',"
        gaugeString &= "colorStrokeTicks: '#fff',"
        gaugeString &= "numbersMargin: -18,"
        gaugeString &= "  colorPlate: ""rgba(0,0,0,0)""," 'Make background transparent.
        gaugeString &= "    borderShadowWidth: 0,"
        gaugeString &= "    borders: false,"
        gaugeString &= "  value: " & newYears.ToString & ","
        gaugeString &= "}).draw();"
        gaugeString &= "  var canvas = document.getElementById(""scripted-gauge4"");"
        gaugeString &= "  var img = canvas.toDataURL(""image/png"");"
        gaugeString &= " document.getElementById('" & pngGauge4.ClientID & "').innerHTML = '<img src=""' + img + '"">'"
        gaugeString &= " };"

        gaugeString &= "  function initGauge_LengthOfOwnershipPreOwned() { var gauge = new RadialGauge({ renderTo:  'scripted-gauge5',"
        gaugeString &= " width: 400, height: 300, units: false,"
        gaugeString &= " fontTitleSize: ""34"","
        gaugeString &= " fontTitle:""Arial"","
        gaugeString &= "colorTitle:  '#4f5050',"

        gaugeString &= " title: """ & preYears.ToString & " Years"", "
        gaugeString &= "  startAngle: 90, SweepAngle: 180, valueBox: false, ticksAngle: 180, exactTicks: true, "
        gaugeString &= "  minValue: 0,  maxValue: " & IIf(preYears < 10, 10, preYears + 2) & ","
        gaugeString &= " majorTicks: false, minorTicks: 0,strokeTicks: false,"
        gaugeString &= " colorUnits: ""#000000"","
        gaugeString &= " fontUnitsSize: ""30"","
        gaugeString &= "highlights: false,animation: false,"
        gaugeString &= "barWidth: 25,"
        gaugeString &= "barProgress: true,"
        If Trim(graph_color_new) <> "" Then
            gaugeString &= vbNewLine & "colorBarProgress:  '" & Trim(graph_color_new) & "',"
        Else
            gaugeString &= "colorBarProgress:  '#078fd7',"
        End If
        gaugeString &= "needle: false,"
        gaugeString &= "colorBar:  '#eee',"
        gaugeString &= "colorStrokeTicks: '#fff',"
        gaugeString &= "numbersMargin: -18,"
        gaugeString &= "  colorPlate: ""rgba(0,0,0,0)""," 'Make background transparent.
        gaugeString &= "    borderShadowWidth: 0,"
        gaugeString &= "    borders: false,"
        gaugeString &= "  value: " & preYears.ToString & ","
        gaugeString &= "}).draw();"
        gaugeString &= "  var canvas = document.getElementById(""scripted-gauge5"");"
        gaugeString &= "  var img = canvas.toDataURL(""image/png"");"
        gaugeString &= " document.getElementById('" & pngGauge5.ClientID & "').innerHTML = '<img src=""' + img + '"">'"
        gaugeString &= " };"
    End Sub
    Public Sub BuildDaysOnMarketGauge(ByRef gaugeString As String, ByVal days As Long)


        gaugeString &= "  function initGauge_DaysOnMarket() { var gauge = new RadialGauge({ renderTo:  'scripted-gauge6',"
        gaugeString &= " width: 400, height: 300, units: false,"
        gaugeString &= " fontTitleSize: ""34"","
        gaugeString &= " fontTitle:""Arial"","
        gaugeString &= "colorTitle:  '#4f5050',"

        gaugeString &= " title: """ & days & " Days"", "
        gaugeString &= "  startAngle: 90, SweepAngle: 180, valueBox: false, ticksAngle: 180, exactTicks: true, "

        If days < 365 Then
            gaugeString &= "  minValue: 0,  maxValue: 365,"
        ElseIf days < 730 Then
            gaugeString &= "  minValue: 365,  maxValue: 730,"
        ElseIf days < 1095 Then
            gaugeString &= "  minValue: 730,  maxValue: 1095,"
        End If


        gaugeString &= " majorTicks: false, minorTicks: 0,strokeTicks: false,"
        gaugeString &= " colorUnits: ""#000000"","
        gaugeString &= " fontUnitsSize: ""30"","
        gaugeString &= "highlights: false,animation: false,"
        gaugeString &= "barWidth: 25,"
        gaugeString &= "barProgress: true,"

        If Trim(graph_color_new) <> "" Then
            gaugeString &= vbNewLine & "colorBarProgress:  '" & Trim(graph_color_new) & "',"
        Else
            gaugeString &= "colorBarProgress:  '#078fd7',"
        End If

        gaugeString &= "needle: false,"
        gaugeString &= "colorBar:  '#eee',"
        gaugeString &= "colorStrokeTicks: '#fff',"
        gaugeString &= "numbersMargin: -18,"
        gaugeString &= "  colorPlate: ""rgba(0,0,0,0)""," 'Make background transparent.
        gaugeString &= "    borderShadowWidth: 0,"
        gaugeString &= "    borders: false,"
        gaugeString &= "  value: " & days & ","
        gaugeString &= "}).draw();"
        gaugeString &= "  var canvas = document.getElementById(""scripted-gauge6"");"
        gaugeString &= "  var img = canvas.toDataURL(""image/png"");"
        gaugeString &= " document.getElementById('" & pngGauge6.ClientID & "').innerHTML = '<img src=""' + img + '"">'"
        gaugeString &= " };"
    End Sub
    Public Sub BuildFeaturesGauge(ByRef gaugeString As String, ByVal searchCriteria As viewSelectionCriteriaClass)
        Dim results_Table As New DataTable
        results_Table = GetTopFeatures(NEW_PDF_AMOD_ID)


        'gaugeString = ""
        gaugeString &= vbNewLine & "  function initGauge_Features() { "
        Dim counter As Integer = 1
        If Not IsNothing(results_Table) Then
            If results_Table.Rows.Count > 0 Then
                For Each r As DataRow In results_Table.Rows
                    If counter < 7 Then
                        Dim variablePicture As New HtmlGenericControl
                        If Not IsNothing(featuresGaugePanel.FindControl("features" & counter.ToString & "image")) Then
                            variablePicture = featuresGaugePanel.FindControl("features" & counter.ToString & "image")
                        End If


                        gaugeString &= vbNewLine & " var gauge = new RadialGauge({ renderTo:  'features" & counter.ToString & "',"
                        gaugeString &= vbNewLine & " width: 400, height: 300, units: false,"
                        gaugeString &= vbNewLine & " fontTitleSize: ""34"","
                        gaugeString &= vbNewLine & " fontTitle:""Arial"","
                        gaugeString &= vbNewLine & "colorTitle:  '#4f5050',"

                        gaugeString &= vbNewLine & " title: """ & FormatNumber((r("ACFEATYES") / ac_for_sale) * 100, 0) & "%"", "
                        gaugeString &= vbNewLine & "  startAngle: 90, SweepAngle: 180, valueBox: false, ticksAngle: 180, exactTicks: true, "
                        gaugeString &= vbNewLine & "  minValue: 0,  maxValue: 100,"
                        gaugeString &= vbNewLine & " majorTicks: false, minorTicks: 0,strokeTicks: false,"
                        gaugeString &= vbNewLine & " colorUnits: ""#000000"","
                        gaugeString &= vbNewLine & " fontUnitsSize: ""30"","
                        gaugeString &= vbNewLine & "highlights: false,animation: false,"
                        gaugeString &= vbNewLine & "barWidth: 25,"
                        gaugeString &= vbNewLine & "barProgress: true,"

                        If Trim(graph_color_new) <> "" Then
                            gaugeString &= vbNewLine & "colorBarProgress:  '" & Trim(graph_color_new) & "',"
                        Else
                            gaugeString &= vbNewLine & "colorBarProgress:  '#078fd7',"
                        End If

                        gaugeString &= vbNewLine & "needle: false,"
                        gaugeString &= vbNewLine & "colorBar:  '#eee',"
                        gaugeString &= vbNewLine & "colorStrokeTicks: '#fff',"
                        gaugeString &= vbNewLine & "numbersMargin: -18,"
                        gaugeString &= vbNewLine & "  colorPlate: ""rgba(0,0,0,0)""," 'Make background transparent.
                        gaugeString &= vbNewLine & "    borderShadowWidth: 0,"
                        gaugeString &= vbNewLine & "    borders: false,"
                        gaugeString &= vbNewLine & "  value: " & (r("ACFEATYES") / ac_for_sale) * 100 & ","
                        gaugeString &= vbNewLine & "}).draw();"
                        gaugeString &= vbNewLine & "  var canvas = document.getElementById(""features" & counter.ToString & """);"
                        gaugeString &= vbNewLine & "  var img = canvas.toDataURL(""image/png"");"

                        gaugeString &= vbNewLine & " document.getElementById('" & variablePicture.ClientID & "').innerHTML = '<img src=""' + img + '"">';"



                        counter += 1
                    End If
                Next
            End If
        End If
        gaugeString &= " }"


    End Sub

    Public Sub BuildMarketCharacteristicsChart(ByRef engineMaintenanceString As String, ByRef locationString As String)
        Dim results_Table As New DataTable
        results_Table = GetTopProgramName(NEW_PDF_AMOD_ID)

        Dim LocationTable As New DataTable
        LocationTable = GetContinents(NEW_PDF_AMOD_ID, year_start.Text, year_end.Text, aftt_start.Text, aftt_end.Text, aircraft_registration.SelectedValue, localCriteria.ViewCriteriaDocumentsStartDate, localCriteria.ViewCriteriaDocumentsEndDate, True)

        If Not IsNothing(results_Table) Then
            If results_Table.Rows.Count > 0 Then
                For Each r As DataRow In results_Table.Rows
                    If Trim(engineMaintenanceString) <> "" Then
                        engineMaintenanceString &= ", "
                    End If
                    engineMaintenanceString += "['" & r("ENGPROGNAME").ToString & "'," & FormatNumber((r("tcount") / ac_for_sale) * 100, 0).ToString & " ]"
                Next
            End If
        End If

        engineMaintenanceString = " data22.addColumn('string', 'ENGINE MAINTENANCE'); data22.addColumn('number', '% FOR SALE'); data22.addRows([ " & engineMaintenanceString '& "]}"


        '''''''''''''''''Location

        If Not IsNothing(LocationTable) Then
            If LocationTable.Rows.Count > 0 Then
                For Each r As DataRow In LocationTable.Rows
                    If Trim(locationString) <> "" Then
                        locationString &= ", "
                    End If
                    locationString += "['" & r("country_continent_name").ToString & "'," & FormatNumber((r("tcount") / ac_for_sale) * 100, 0).ToString & " ]"
                Next
            End If
        End If

        locationString = " data23.addColumn('string', 'LOCATION'); data23.addColumn('number', '% FOR SALE'); data23.addRows([ " & locationString '& "]}"
    End Sub
    'Public Sub BuildProgramGauge(ByRef gaugeString As String, ByVal searchCriteria As viewSelectionCriteriaClass)
    '  Dim results_Table As New DataTable
    '  results_Table = GetTopProgramName(NEW_PDF_AMOD_ID)


    '  'gaugeString = ""
    '  gaugeString &= vbNewLine & "  function initGauge_Program() { "
    '  Dim counter As Integer = 1
    '  If Not IsNothing(results_Table) Then
    '    If results_Table.Rows.Count > 0 Then
    '      For Each r As DataRow In results_Table.Rows
    '        If counter < 7 Then
    '          Dim variablePicture As New HtmlGenericControl
    '          If Not IsNothing(featuresGaugePanel.FindControl("program" & counter.ToString & "image")) Then
    '            variablePicture = featuresGaugePanel.FindControl("program" & counter.ToString & "image")
    '          End If


    '          gaugeString &= vbNewLine & " var gauge = new RadialGauge({ renderTo:  'program" & counter.ToString & "',"
    '          gaugeString &= vbNewLine & " width: 400, height: 300, units: false,"
    '          gaugeString &= vbNewLine & " fontTitleSize: ""34"","
    '          gaugeString &= vbNewLine & " fontTitle:""Arial"","
    '          gaugeString &= vbNewLine & "colorTitle:  '#4f5050',"

    '          gaugeString &= vbNewLine & " title: """ & FormatNumber((r("tcount") / ac_for_sale) * 100, 0) & "%"", "
    '          gaugeString &= vbNewLine & "  startAngle: 90, SweepAngle: 180, valueBox: false, ticksAngle: 180, exactTicks: true, "
    '          gaugeString &= vbNewLine & "  minValue: 0,  maxValue: 100,"
    '          gaugeString &= vbNewLine & " majorTicks: false, minorTicks: 0,strokeTicks: false,"
    '          gaugeString &= vbNewLine & " colorUnits: ""#000000"","
    '          gaugeString &= vbNewLine & " fontUnitsSize: ""30"","
    '          gaugeString &= vbNewLine & "highlights: false,animation: false,"
    '          gaugeString &= vbNewLine & "barWidth: 25,"
    '          gaugeString &= vbNewLine & "barProgress: true,"
    '          gaugeString &= vbNewLine & "colorBarProgress:  '#078fd7',"
    '          gaugeString &= vbNewLine & "needle: false,"
    '          gaugeString &= vbNewLine & "colorBar:  '#eee',"
    '          gaugeString &= vbNewLine & "colorStrokeTicks: '#fff',"
    '          gaugeString &= vbNewLine & "numbersMargin: -18,"
    '          gaugeString &= vbNewLine & "  colorPlate: ""rgba(0,0,0,0)""," 'Make background transparent.
    '          gaugeString &= vbNewLine & "    borderShadowWidth: 0,"
    '          gaugeString &= vbNewLine & "    borders: false,"
    '          gaugeString &= vbNewLine & "  value: " & (r("tcount") / ac_for_sale) * 100 & ","
    '          gaugeString &= vbNewLine & "}).draw();"
    '          gaugeString &= vbNewLine & "  var canvas = document.getElementById(""program" & counter.ToString & """);"
    '          gaugeString &= vbNewLine & "  var img = canvas.toDataURL(""image/png"");"

    '          gaugeString &= vbNewLine & " document.getElementById('" & variablePicture.ClientID & "').innerHTML = '<img src=""' + img + '"">';"



    '          counter += 1
    '        End If
    '      Next
    '    End If
    '  End If
    '  gaugeString &= " }"


    'End Sub
    Public Sub ForSaleGaugeJavascript(ByRef gaugeString As String, ByVal maxValue As Double, ByVal minValue As Double, ByVal answerValue As Double)
        'gaugeString = ""
        gaugeString &= "  function initGauge_AvgSale() { var gauge = new RadialGauge({ renderTo:  'scripted-gauge3',"
        gaugeString &= " width: 400, height: 300, units: false," ' units: ""$" & FormatNumber(forsaleavg, 0) & "k""," 
        gaugeString &= " fontTitleSize: ""34"","
        gaugeString &= " fontTitle:""Arial"","
        gaugeString &= "colorTitle:  '#4f5050',"

        gaugeString &= " title: ""$" & FormatNumber((answerValue / 1000), 0) & "k"", "
        gaugeString &= "  startAngle: 90, SweepAngle: 180, valueBox: false, ticksAngle: 180, exactTicks: true, "
        gaugeString &= "  minValue: " & (minValue / 1000) - 100 & ",  maxValue: " & (maxValue / 1000) + 100 & ","
        gaugeString &= " majorTicks: false, minorTicks: 0,strokeTicks: false,"
        gaugeString &= " colorUnits: ""#000000"","
        gaugeString &= " fontUnitsSize: ""30"","
        gaugeString &= "highlights: false,animation: false,"
        gaugeString &= "barWidth: 25,"
        gaugeString &= "barProgress: true,"

        If Trim(graph_color_new) <> "" Then
            gaugeString &= vbNewLine & "colorBarProgress:  '" & Trim(graph_color_new) & "',"
        Else
            gaugeString &= "colorBarProgress:  '#078fd7',"
        End If

        gaugeString &= "needle: false,"
        gaugeString &= "colorBar:  '#eee',"
        gaugeString &= "colorStrokeTicks: '#fff',"
        gaugeString &= "numbersMargin: -18,"
        gaugeString &= "  colorPlate: ""rgba(0,0,0,0)""," 'Make background transparent.
        gaugeString &= "    borderShadowWidth: 0,"
        gaugeString &= "    borders: false,"
        gaugeString &= "  value: " & Replace(forsaleavg.ToString, "$", "") & ","
        gaugeString &= "}).draw();"
        gaugeString &= "  var canvas = document.getElementById(""scripted-gauge3"");"
        gaugeString &= "  var img = canvas.toDataURL(""image/png"");"
        gaugeString &= " document.getElementById('" & pngGauge3.ClientID & "').innerHTML = '<img src=""' + img + '"">'"
        gaugeString &= " };"
    End Sub

    Public Sub Make_Guage_Ticks(ByVal low_val As Long, ByVal high_val As Long, ByVal num_ticks As Long, ByRef guage_string As String, ByRef step_amount As Long)

        Dim temp_val As Long = 0
        Dim i As Integer = 0
        guage_string &= " majorTicks: ["

        guage_string &= low_val

        step_amount = ((high_val - low_val) / num_ticks)
        temp_val = low_val
        'make points 2-5
        'For i = 0 To num_ticks - 2
        '  temp_val = temp_val + step_amount

        '  If Trim(guage_string) <> "" Then
        '    guage_string &= ", "
        '  End If

        '  guage_string &= temp_val
        'Next

        guage_string &= "," & high_val
        guage_string &= " ],"

        guage_string &= " minorTicks: 0,"
        guage_string &= " strokeTicks: true,"
        guage_string &= " highlights: ["

        guage_string &= "	{"
        guage_string &= " ""from"": " & low_val & ","
        guage_string &= " ""to"": " & low_val + (step_amount * (num_ticks / 3)) & ","
        guage_string &= "  ""color"": ""rgba(242, 242, 242, .75)"""
        guage_string &= "}"

        guage_string &= ",	{"
        guage_string &= " ""from"": " & low_val + (step_amount * (num_ticks / 3)) & ","
        guage_string &= " ""to"": " & low_val + ((step_amount * 2) * (num_ticks / 3)) & ","
        guage_string &= "  ""color"": ""rgba(215, 217, 218, .75)""" ' gray
        guage_string &= "	}"


        guage_string &= ", {"
        guage_string &= " ""from"": " & low_val + ((step_amount * 2) * (num_ticks / 3)) & ","
        guage_string &= " ""to"": " & high_val & ","
        guage_string &= "    ""color"": ""rgba(178, 179, 179, .75)"""
        guage_string &= "  }"

        guage_string &= "  ],"

    End Sub
    Public Sub Make_Guage_Totals(ByVal value_temp As Long, ByRef val_to_set As Long, ByVal low_or_high As String)

        If Trim(value_temp) > 50000 Then
            If Trim(low_or_high) = "low" Then
                val_to_set = 50000
            Else
                val_to_set = 75000
            End If
        ElseIf Trim(value_temp) > 35000 Then
            If Trim(low_or_high) = "low" Then
                val_to_set = 35000
            Else
                val_to_set = 50000
            End If
        ElseIf Trim(value_temp) > 25000 Then
            If Trim(low_or_high) = "low" Then
                val_to_set = 25000
            Else
                val_to_set = 35000
            End If
        ElseIf Trim(value_temp) > 20000 Then
            If Trim(low_or_high) = "low" Then
                val_to_set = 20000
            Else
                val_to_set = 25000
            End If
        ElseIf Trim(value_temp) > 15000 Then
            If Trim(low_or_high) = "low" Then
                val_to_set = 15000
            Else
                val_to_set = 20000
            End If
        ElseIf Trim(value_temp) > 10000 Then
            If Trim(low_or_high) = "low" Then
                val_to_set = 10000
            Else
                val_to_set = 15000
            End If
        ElseIf Trim(value_temp) > 5000 Then
            If Trim(low_or_high) = "low" Then
                val_to_set = 5000
            Else
                val_to_set = 10000
            End If
        ElseIf Trim(value_temp) > 2000 Then
            If Trim(low_or_high) = "low" Then
                val_to_set = 2000
            Else
                val_to_set = 5000
            End If
        ElseIf Trim(value_temp) > 1000 Then
            If Trim(low_or_high) = "low" Then
                val_to_set = 1000
            Else
                val_to_set = 2000
            End If
        ElseIf Trim(value_temp) > 500 Then
            If Trim(low_or_high) = "low" Then
                val_to_set = 500
            Else
                val_to_set = 1000
            End If
        ElseIf Trim(value_temp) > 100 Then
            If Trim(low_or_high) = "low" Then
                val_to_set = 100
            Else
                val_to_set = 500
            End If
        End If

    End Sub

    Public Function NEW_Build_FleetMarketSummary(ByVal inModelID As Long, ByVal bIsAcContactTypeView As Boolean, ByVal inMakeName As String, ByRef foot_space_market_summary As String, ByVal header_y_or_n As String, ByRef guage_string As String, ByRef searchCriteria As viewSelectionCriteriaClass) As String
        NEW_Build_FleetMarketSummary = ""
        Try
            Dim strHTML As String = ""
            Dim GetMarketStatus As String = ""
            Dim absorp_rate As Double = 0
            Dim results_table As New DataTable
            Dim SalesPerTimeframe As Long = 0
            Dim min_value As Long = 0
            Dim max_value As Long = 0
            Dim temp_val As Long = 0
            Dim points_string As String = ""
            Dim step_amount As Long = 0
            Dim major_ticks As Long = 0

            NEW_Build_FleetMarketSummary = ""


            If Me.MR_Fleet.Checked = True Then

                GetFleetInfo(inModelID, False, searchCriteria)

                'strHTML = strHTML & "<tr><td valign='middle' align='center' colspan='10'><font class='" & Session("FONT_CLASS_HEADER") & "'>" & real_make_model_name & "<font class='" & Session("FONT_CLASS_HEADER_BIG") & "'> Fleet Summary</font></font></td></tr>" & vbCrLf ' <tr><td>&nbsp;</td></tr>

                'strHTML = strHTML & "<tr><td valign='middle' align='center' colspan='10' height='1' style='border-bottom:1px solid lightgrey;'>&nbsp;</td></tr>"

                strHTML = strHTML & "<tr><td valign='middle' class='left' colspan='10'><font class='" & Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & real_make_model_name & "</strong> Fleet Composition" & valueHeaderString & "</font></td></tr>" & vbCrLf ' <tr><td>&nbsp;</td></tr>


                strHTML = strHTML & "<tr>" & vbCrLf

                ''Table
                strHTML = strHTML & "<tr><td valign='middle' class='left' colspan='10'><table width=""100%"" cellpadding=""0"" cellspacing=""0""><tr>"

                ' Ownership table
                '-----------------------------------------------------------------------------------------------------
                If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                    strHTML = strHTML & "<td align='right' valign='top' width='" & word_32 & "'>" '<div class=""Box"">"
                    'strHTML = strHTML & "<table id='lifeCycleTable'  cellspacing='0' cellpadding='4' width='" & word_32 & "' class='formatTable " & table_color & " large'><thead>" & vbCrLf
                Else
                    strHTML = strHTML & "<td align='right' valign='top' width='32%'>" '<div class=""Box"">"
                    'strHTML = strHTML & "<table id='lifeCycleTable'  cellspacing='0' cellpadding='4' width='100%' class='formatTable " & table_color & " large'><thead>" & vbCrLf
                End If

                strHTML = strHTML & DisplayFunctions.BuildViewOwnershipBox("large", w_owner, s_owner, f_owner, totalInOpcount, alllow, allhigh)
                'strHTML = strHTML & "<tr class=""uppercase""><th valign='middle' align='center' colspan='2' class='center'>Ownership (In Operation)</th></tr>" & vbCrLf ' <tr><td>&nbsp;</td></tr>

                'strHTML = strHTML & "</thead><tbody>"

                'If CLng(w_owner) > 0 Then
                '  strHTML = strHTML & "<tr><td valign='top' align='left' >Whole:&nbsp;</td><td align='right'>" & FormatNumber(w_owner, 0, True, False, True) & "</td></tr>" & vbCrLf
                'Else
                '  strHTML = strHTML & "<tr><td valign='top' align='left' >Whole:&nbsp;</td><td align='right'>&nbsp;0</td><td>&nbsp;</td></tr>" & vbCrLf
                'End If

                'If CLng(s_owner) > 0 Then
                '  strHTML = strHTML & "<tr><td valign='top' align='left' >Shared:&nbsp;</td><td align='right'>&nbsp;" & FormatNumber(s_owner, 0, True, False, True) & "</td></tr>" & vbCrLf
                'Else
                '  strHTML = strHTML & "<tr><td valign='top' align='left' >Shared:&nbsp;</td><td align='right'>&nbsp;0</td><td>&nbsp;</td></tr>" & vbCrLf
                'End If

                'If CLng(f_owner) > 0 Then
                '  strHTML = strHTML & "<tr><td valign='top' align='left' >Fractional:&nbsp;</td><td align='right'>&nbsp;" & FormatNumber(f_owner, 0, True, False, True) & "</td></tr>" & vbCrLf
                'Else
                '  strHTML = strHTML & "<tr><td valign='top' align='left' >Fractional:&nbsp;</td><td align='right'>&nbsp;0</td><td>&nbsp;</td></tr>" & vbCrLf
                'End If

                'If CLng(totalInOpcount) > 0 Then
                '  strHTML = strHTML & "<tr><td valign='top' align='left'  nowrap='nowrap'>Active Fleet:&nbsp;</td><td align='right'>&nbsp;" & FormatNumber(totalInOpcount, 0, True, False, True) & "</td></tr>" & vbCrLf
                'Else
                '  strHTML = strHTML & "<tr><td valign='top' align='left'  nowrap='nowrap'>Active Fleet:&nbsp;</td><td align='right'>&nbsp;0</td><td>&nbsp;</td></tr>" & vbCrLf
                'End If
                'strHTML = strHTML & "<tr bgcolor='white'><td valign='top' align='left' bgcolor='white'>&nbsp;</td><td bgcolor='white'>&nbsp;</td><td bgcolor='white'>&nbsp;</td></tr>"
                'strHTML = strHTML & "</table></div>"
                strHTML = strHTML & "</td>" & vbCrLf
                '-----------------------------------------------------------------------------------------------------

                ' Life Cycle
                '-----------------------------------------------------------------------------------------------------
                If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                    strHTML = strHTML & "<td align='center' width='" & word_32 & "'>" '<div class=""Box"">" & vbCrLf
                    ' strHTML = strHTML & "<table id='lifeCycleTable' cellspacing='0' cellpadding='4' width='" & word_32 & "' class='formatTable " & table_color & " large'><thead>" & vbCrLf
                Else
                    strHTML = strHTML & "<td align='center' width='32%'>" '<div class=""Box"">" & vbCrLf
                    'strHTML = strHTML & "<table id='lifeCycleTable' cellspacing='0' cellpadding='4' width='100%' class='formatTable " & table_color & " large'><thead>" & vbCrLf
                End If

                'strHTML = strHTML & "<tr class=""uppercase""><th valign='top' align='center' colspan='2' class='center'>Life Cycle</th></tr>" & vbCrLf ' <tr><td>&nbsp;</td></tr>

                'strHTML = strHTML & "</thead><tbody>"

                'If CLng(o_stage) > 0 Then
                '  strHTML = strHTML & "<tr><td valign='top' align='left' >In Production:&nbsp;</td><td align='right'>&nbsp;" & FormatNumber(o_stage, 0, True, False, True) & "</td></tr>" & vbCrLf
                'Else
                '  strHTML = strHTML & "<tr><td valign='top' align='left' >In Production:&nbsp;</td><td align='right'>&nbsp;0</td></tr>" & vbCrLf
                'End If

                'If CLng(t_stage) > 0 Then
                '  strHTML = strHTML & "<tr><td valign='top' align='left' >At MFR:&nbsp;</td><td align='right'>&nbsp;" & FormatNumber(t_stage, 0, True, False, True) & "</td></tr>" & vbCrLf
                'Else
                '  strHTML = strHTML & "<tr><td valign='top' align='left' >At MFR:&nbsp;</td><td align='right'>&nbsp;0</td></tr>" & vbCrLf
                'End If

                'If CLng(th_stage) > 0 Then
                '  strHTML = strHTML & "<tr><td valign='top' align='left' >In Operation:&nbsp;</td><td align='right'>&nbsp;" & FormatNumber(th_stage, 0, True, False, True) & "</td></tr>" & vbCrLf
                'Else
                '  strHTML = strHTML & "<tr><td valign='top' align='left' >In Operation:&nbsp;</td><td align='right'>&nbsp;0</td></tr>" & vbCrLf
                'End If

                'If CLng(f_stage) > 0 Then
                '  strHTML = strHTML & "<tr><td valign='top' align='left' >Retired:&nbsp;</td><td align='right'>&nbsp;" & FormatNumber(f_stage, 0, True, False, True) & "</td></tr>" & vbCrLf
                'Else
                '  strHTML = strHTML & "<tr><td valign='top' align='left' >Retired:&nbsp;</td><td align='right'>&nbsp;0</td></tr>" & vbCrLf
                'End If

                'If CLng(totalcount) > 0 Then
                '  strHTML = strHTML & "<tr><td valign='top' align='left'>Total Fleet:&nbsp;</td><td align='right'>&nbsp;" & FormatNumber(totalcount, 0, True, False, True) & "</td></tr>" & vbCrLf
                'Else
                '  strHTML = strHTML & "<tr><td valign='top' align='left'>Total Fleet:&nbsp;</td><td align='right'>&nbsp;0</td></tr>" & vbCrLf
                'End If

                'strHTML = strHTML & "<tr bgcolor='white'><td valign='top' align='left' bgcolor='white'>&nbsp;</td><td bgcolor='white'>&nbsp;</td><td bgcolor='white'>&nbsp;</td></tr>"
                ' strHTML = strHTML & "</tbody></table>"
                strHTML = strHTML & DisplayFunctions.BuildViewLifecycleBox("large", o_stage, t_stage, th_stage, f_stage, totalcount)
                strHTML = strHTML & "</div>" & vbCrLf

                ' NEW SECTION ADDED IN --------------------------------------------------
                strHTML = strHTML & "</td>"

                '-----------------------------------------------------------------------------------------------------




                'Composition table
                '-----------------------------------------------------------------------------------------------------
                If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                    strHTML = strHTML & "<td align='center' valign='top' width='" & word_32 & "'>"
                    ' strHTML = strHTML & "<div class=""Box""><table id='lifeCycleTable'  cellspacing='0' cellpadding='4' width='" & word_32 & "' class='formatTable " & table_color & " center large'><thead>" & vbCrLf
                Else
                    strHTML = strHTML & "<td align='center' valign='top' width='32%'>"
                    'strHTML = strHTML & "<div class=""Box""><table id='lifeCycleTable'  cellspacing='0' cellpadding='4' width='100%' class='formatTable " & table_color & " center large'><thead>" & vbCrLf
                End If

                'strHTML = strHTML & "<tr class=""uppercase""><th valign='middle' align='center' colspan='2' class='center'>Composition</th></tr>" & vbCrLf ' <tr><td>&nbsp;</td></tr>


                'strHTML = strHTML & "</thead><tbody>"
                'If CLng(alllow) > 0 And CLng(allhigh) > 0 Then
                '  strHTML = strHTML & "<tr><td valign='top' align='left' class='border_bottom' nowrap='nowrap'>MFR Year Range:&nbsp;</td><td align='right' nowrap='nowrap'>&nbsp;" & alllow & " - " & allhigh & "</td></tr>" & vbCrLf
                'ElseIf CLng(alllow) > 0 And CLng(allhigh) = 0 Then
                '  strHTML = strHTML & "<tr><td valign='top' align='left' class='border_bottom' nowrap='nowrap'>MFR Year Range:&nbsp;</td><td align='right' nowrap='nowrap'>&nbsp;" & alllow & " - To Present</td></tr>" & vbCrLf
                'Else
                '  strHTML = strHTML & "<tr><td valign='top' align='left' class='border_bottom' nowrap='nowrap'>MFR Year Range:&nbsp;</td><td align='right' nowrap='nowrap'>&nbsp;N/A</td></tr>" & vbCrLf
                'End If


                'If CLng(aftt_low) > 0 And CLng(aftt_high) > 0 Then
                '  strHTML = strHTML & "<tr><td valign='top' align='left' class='border_bottom' nowrap='nowrap'>AFTT Range:&nbsp;</td><td align='right' nowrap='nowrap'>&nbsp;" & FormatNumber(aftt_low, 0) & " - " & FormatNumber(aftt_high, 0) & "</td></tr>" & vbCrLf
                'Else
                '  strHTML = strHTML & "<tr><td valign='top' align='left' class='border_bottom' nowrap='nowrap'>AFTT Range:&nbsp;</td><td align='right' nowrap='nowrap'>&nbsp;N/A</td></tr>" & vbCrLf
                'End If

                'If CLng(us_reg) > 0 Then
                '  strHTML = strHTML & "<tr><td valign='top' align='left' class='border_bottom' nowrap='nowrap'>US/Foreign:&nbsp;</td><td align='right' nowrap='nowrap'>&nbsp;" & us_reg & "/" & (th_stage - us_reg) & "</td></tr>" & vbCrLf
                'Else
                '  strHTML = strHTML & "<tr><td valign='top' align='left' class='border_bottom' nowrap='nowrap'>US/Foreign:&nbsp;</td><td align='right' nowrap='nowrap'>&nbsp;N/A</td></tr>" & vbCrLf
                'End If

                'strHTML = strHTML & "</tbody></table></div>" & vbCrLf
                strHTML = strHTML & DisplayFunctions.BuildViewFleetCompBox("large", IIf(CLng(alllow) > 0 And CLng(allhigh) > 0, alllow & " - " & allhigh, "N/A"), IIf(CLng(aftt_low) > 0 And CLng(aftt_high) > 0, FormatNumber(aftt_low, 0) & " - " & FormatNumber(aftt_high, 0), "N/A"), IIf(CLng(us_reg) > 0, us_reg & "/" & (th_stage - us_reg), "N/A"))
                strHTML = strHTML & "</td>"
                '-----------------------------------------------------------------------------------------------------

                strHTML = strHTML & "</tr>" & vbCrLf


                'table
                strHTML = strHTML & "</table></td></tr>"

                strHTML = strHTML & "<tr><td valign='middle' align='center'>&nbsp;</td></tr>"
                strHTML = strHTML & "<tr><td valign='middle' align='center' colspan='10' height='1' style='border-bottom:1px solid lightgrey;'>&nbsp;</td></tr>"
                strHTML = strHTML & "<tr><td valign='middle' class='left' colspan='10' align='left'><div class=""Box"" style=""max-width:100%;overflow:hidden;""><font class='" & Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & real_make_model_name & "</strong> AGE OF FLEET" & valueHeaderString & "</font></div></td></tr>" & vbCrLf ' <tr><td>&nbsp;</td></tr>

                strHTML = strHTML & "<tr>" & vbCrLf
                strHTML = strHTML & "<td valign=""top"" align='center' colspan='10'>"

                strHTML += "<table width=""100%"" cellpadding=""3"" cellspacing=""0""><tr><td valign=""top"" width=""46%"">"

                strHTML += "<div class=""Box"" style=""max-width:100%;overflow:hidden;"">"


                If Me.WD.SelectedValue = "Word" Then

                    strHTML = strHTML & "<font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>Age of Fleet by MFR Year</font>"

                    Me.PER_MONTH.Titles.Clear()
                    Call NEW_display_by_mft_year(NEW_PDF_AMOD_ID, "")
                    Me.PER_MONTH.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + NEW_PDF_AMOD_ID.ToString + "_PER_MONTH_AGE.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)

                    If InStr(HttpContext.Current.Session.Item("jetnetFullHostName").ToString.Trim, "jetnetevo") = 0 Or InStr(HttpContext.Current.Session.Item("jetnetFullHostName").ToString.Trim, "testjetnetevolution") > 0 Then
                        If InStr(HttpContext.Current.Session.Item("jetnetFullHostName").ToString, "http://") > 0 Then
                            strHTML = strHTML & ("<img src='" & HttpContext.Current.Session.Item("jetnetFullHostName").ToString & "/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + NEW_PDF_AMOD_ID.ToString + "_PER_MONTH_AGE.jpg'>")
                        Else
                            strHTML = strHTML & ("<img src='http://" & HttpContext.Current.Session.Item("jetnetFullHostName").ToString & "/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + NEW_PDF_AMOD_ID.ToString + "_PER_MONTH_AGE.jpg'>")
                        End If
                    Else
                        strHTML = strHTML & ("<img src='http://www.jetnetevolution.com/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + NEW_PDF_AMOD_ID.ToString + "_PER_MONTH_AGE.jpg'>")
                    End If



                    strHTML = strHTML & "</div></td><td valign=""top""><div class=""Box""><table width='100%'>"
                    strHTML = strHTML & NEW_Show_Average_Year(NEW_PDF_AMOD_ID, searchCriteria)
                    strHTML = strHTML & "</table></div><br clear=""all"" /><div class=""Box"" style=""max-width:100%;overflow:hidden;margin-top:-10px;""><font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>IN OPERATION TRENDS<strong>LAST 5 YEARS</strong></font>"

                    Me.IN_OPERATION_CHART.Titles.Clear()
                    Me.IN_OPERATION_CHART.Titles.Add("")
                    commonEvo.model_operational_trends_graph(NEW_PDF_AMOD_ID, "", "", 0, True, IN_OPERATION_CHART)
                    Me.IN_OPERATION_CHART.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + NEW_PDF_AMOD_ID.ToString + "_NEW_Show_Average_Year.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)

                    If InStr(HttpContext.Current.Session.Item("jetnetFullHostName").ToString.Trim, "jetnetevo") = 0 Or InStr(HttpContext.Current.Session.Item("jetnetFullHostName").ToString.Trim, "testjetnetevolution") > 0 Then
                        If InStr(HttpContext.Current.Session.Item("jetnetFullHostName").ToString, "http://") > 0 Then
                            strHTML = strHTML & ("<img src='" & HttpContext.Current.Session.Item("jetnetFullHostName").ToString & "/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + NEW_PDF_AMOD_ID.ToString + "_NEW_Show_Average_Year.jpg'>")
                        Else
                            strHTML = strHTML & ("<img src='http://" & HttpContext.Current.Session.Item("jetnetFullHostName").ToString & "/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + NEW_PDF_AMOD_ID.ToString + "_NEW_Show_Average_Year.jpg'>")
                        End If
                    Else
                        strHTML = strHTML & ("<img src='http://www.jetnetevolution.com/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + NEW_PDF_AMOD_ID.ToString + "_NEW_Show_Average_Year.jpg'>")
                    End If

                    ' strHTML = strHTML & "<img src='" & valueGraphText20.Text & "' align='center' style=""height: 232px;margin-top:-8px;width:119%;margin-left:-25px;"" />"

                    strHTML = strHTML & "</div>"

                Else
                    strHTML = strHTML & "<font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>Age of Fleet by MFR Year</font><img src='" & valueGraphText17.Text & "' width='100%' style=""height:490px;width:109%;margin-left:-9px;margin-bottom:-25px"" />"

                    strHTML = strHTML & "</div></td><td valign=""top""><div class=""Box""><table width='100%'>"
                    strHTML = strHTML & NEW_Show_Average_Year(NEW_PDF_AMOD_ID, searchCriteria)
                    strHTML = strHTML & "</table></div><br clear=""all"" /><div class=""Box"" style=""max-width:100%;overflow:hidden;margin-top:-10px;""><font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>IN OPERATION TRENDS<strong>LAST 5 YEARS</strong></font><img src='" & valueGraphText33.Text & "' align='center' style=""height: 232px;margin-top:-8px;width:119%;margin-left:-25px;"" /></div>"

                End If


                strHTML += "</td></tr></table>"


                strHTML = strHTML & "</td></tr>"
                strHTML = strHTML & "</table></td></tr>"
            End If



            NEW_Build_FleetMarketSummary = Trim(strHTML)



            If Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then

                If localCriteria.ViewCriteriaTimeSpan > 0 Then

                ElseIf Not IsNothing(HttpContext.Current.Session.Item("localPreferences").DefaultAnalysisMonths) Then
                    If IsNumeric(HttpContext.Current.Session.Item("localPreferences").DefaultAnalysisMonths) Then
                    Else
                        localCriteria.ViewCriteriaTimeSpan = 6
                    End If
                Else
                    localCriteria.ViewCriteriaTimeSpan = 6
                End If

                results_table = commonEvo.get_fleet_market_summary_info(localCriteria, IIf(localCriteria.ViewID = 10, True, False), localCriteria.ViewCriteriaTimeSpan)
                If results_table.Rows.Count > 0 Then
                    For Each adoRs As DataRow In results_table.Rows
                        SalesPerTimeframe = adoRs("SalesPerTimeframe")
                    Next
                End If

                absorp_rate = FormatNumber((FormatNumber(SalesPerTimeframe, 2) / localCriteria.ViewCriteriaTimeSpan), 2)
                absorp_rate = (FormatNumber(ac_for_sale, 2) / FormatNumber(absorp_rate, 2))

                min_value = 0
                max_value = 36

                'us_reg & "/" & (th_stage - us_reg)

                ' BUILD GUAGE SECTION----------------------
                Dim UsBased As Long = GetUSBasedByModel(NEW_PDF_AMOD_ID)
                guage_string = BuildUSForeignGauge(UsBased, th_stage)
                'guage_string &= "  function initGauge_AbsorptionRate() { var gauge = new RadialGauge({ renderTo:  'scripted-gauge',"
                'guage_string &= " width: 400, height: 300, units: false, " ' units: """ & absorp_rate & " Months"","
                'guage_string &= " fontTitleSize: ""34"","
                'guage_string &= " fontTitle:""Arial"","
                'guage_string &= "colorTitle:  '#4f5050',"
                ''Color of the bottom text, like 9 months under the absorption rate gauge.
                'guage_string &= " colorUnits: ""#000000"","
                ''Size of bottom text.
                'guage_string &= " fontUnitsSize: ""30"","

                'If IsNumeric(absorp_rate) And Not Double.IsInfinity(absorp_rate) And Not Double.IsNaN(absorp_rate) Then
                '  guage_string &= " title:  '" & FormatNumber(absorp_rate, 1) & IIf(absorp_rate > 9, " Mnths", " Months") & "',"
                'Else
                '  guage_string &= " title:  '0 Months',"
                'End If

                ''guage_string &= " title: ""ABSORPTION RATE"","
                'guage_string &= "  startAngle: 90, SweepAngle: 180, valueBox: false, ticksAngle: 180, exactTicks: true, "
                'guage_string &= "  minValue: " & min_value & ",  maxValue: " & max_value & ","
                'guage_string &= "majorTicks: false, strokeTicks: false, "
                ''guage_string &= " majorTicks: ["

                ''points_string &= min_value
                ''major_ticks = 6 

                ''step_amount = ((max_value - min_value) / major_ticks)
                ''temp_val = min_value
                ' ''make points 2-5
                ' ''For i = 0 To 5
                ' ''  temp_val = temp_val + step_amount

                ' ''  If Trim(points_string) <> "" Then
                ' ''    points_string &= ", "
                ' ''  End If

                ' ''  points_string &= temp_val
                ' ''Next

                ''points_string &= "," & max_value

                ''guage_string &= points_string
                ''guage_string &= " ],"
                'guage_string &= " minorTicks: 0,"
                ''  guage_string &= " strokeTicks: true,"
                ''guage_string &= " highlights: ["

                ''guage_string &= "	{"
                ''guage_string &= " ""from"": " & min_value & ","
                ''guage_string &= " ""to"": " & step_amount * (major_ticks / 3) & ","
                ' '' guage_string &= "  ""color"": ""rgba(116, 178, 48, .75)"""   ' green
                ' ''guage_string &= "  ""color"": ""rgba(50, 200, 50, .75)""" 
                ''guage_string &= "  ""color"": ""rgba(242, 242, 242, .75)"""
                ''guage_string &= "}"

                ''guage_string &= ",	{"
                ''guage_string &= " ""from"": " & step_amount * (major_ticks / 3) & ","
                ''guage_string &= " ""to"": " & (step_amount * 2) * (major_ticks / 3) & ","
                ' ''guage_string &= "  ""color"": ""rgba(255, 255, 0, .75)"""
                ' '' guage_string &= "  ""color"": ""rgba(103, 103, 103, .75)"""    ' grey
                ' '' guage_string &= "  ""color"": ""rgba(183, 220, 246, .75)"""  ' light blue
                ''guage_string &= "  ""color"": ""rgba(215, 217, 218, .75)""" ' gray
                ''guage_string &= "	}"


                ''guage_string &= ", {"
                ''guage_string &= " ""from"": " & (step_amount * 2) * (major_ticks / 3) & ","
                ''guage_string &= " ""to"": " & max_value & ","
                ' ''guage_string &= "    ""color"": ""rgba(255, 50, 50, .75)"""
                ' '' guage_string &= "    ""color"": ""rgba(255, 102, 102, .75)"""   ' light red 
                ' ''  guage_string &= "    ""color"": ""rgba(23, 74, 114, .75)""" ' navy
                ''guage_string &= "    ""color"": ""rgba(178, 179, 179, .75)"""
                ''guage_string &= "  }"

                ''guage_string &= "  ],"

                'guage_string &= "  colorPlate: ""rgba(0,0,0,0)""," 'Make background transparent.
                ''guage_string &= "colorMajorTicks:  '#2a62aa',"
                'guage_string &= " colorStrokeTicks: '#fff', "
                'guage_string &= " highlights: false, animation: false, barWidth:25, barProgress: true, colorBarProgress: '#078fd7', needle: false, colorBar: '#eee',"
                'guage_string &= " numbersMargin: -18, "
                'guage_string &= "colorNumbers:  '#1d3566',"
                'guage_string &= "colorNeedle:  '#1d3566',"
                'guage_string &= "colorNeedleEnd:  '#2a62aa',"
                'guage_string &= "    borderShadowWidth: 0,"
                'guage_string &= "    borders: false,"
                ''guage_string &= "    needleType: ""arrow"","
                ''guage_string &= "   needleWidth: 2,"
                ''guage_string &= "  needleCircleSize: 7,"
                ''guage_string &= "  needleCircleOuter: true,"
                ''guage_string &= "  needleCircleInner: false,"
                ''guage_string &= " animationDuration: 1500,"
                'guage_string &= "  value: " & absorp_rate & ","
                '' guage_string &= "  animationRule: ""linear"""
                'guage_string &= "}).draw();"



                'guage_string &= "  var canvas = document.getElementById(""scripted-gauge"");"
                ''  guage_string &= "   google.visualization.events.addListener(canvas, 'ready', function() {" 
                'guage_string &= "  var img = canvas.toDataURL(""image/png"");"
                ''  guage_string &= "  console.log(img); "
                '' guage_string &= "  var img = canvas.toDataURL();"
                'guage_string &= " document.getElementById('" & pngGuage1.ClientID & "').innerHTML = '<img src=""' + img + '"">'"
                ''  guage_string &= " document.getElementById('" & pngGuage1.ClientID & "').innerHTML = img "
                '' guage_string &= "});"
                'guage_string &= " }"
                Dim stringToModify As String = "var img = canvas.toDataURL(""image/png"");}"
                Dim StringToReplace As String = "var img = canvas.toDataURL(""image/png""); document.getElementById('" & pngGuage1.ClientID & "').innerHTML = '<img src=""' + img + '"">'; }"



                guage_string &= Replace(DisplayFunctions.BuildViewMarketAbsorptionGauge(absorp_rate, True, graph_color_new), stringToModify, StringToReplace)

                ' BUILD GUAGE SECTION----------------------
            End If


        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Build_FleetMarketSummary: " & ex.Message
        End Try
    End Function
    Private Function BuildUSForeignGauge(ByVal us_reg As Long, ByVal th_stage As Long) As String
        Dim gaugeString As String = ""
        gaugeString &= "  function initGauge_US() { var gauge = new RadialGauge({ renderTo:  'scripted-gaugeUS',"
        gaugeString &= " width: 400, height: 300, units: false, "
        gaugeString &= " fontTitleSize: ""34"","
        gaugeString &= " fontTitle:""Arial"","
        gaugeString &= "colorTitle:  '#4f5050',"
        'Color of the bottom text, like 9 months under the absorption rate gauge.
        gaugeString &= " colorUnits: ""#000000"","
        'Size of bottom text.
        gaugeString &= " fontUnitsSize: ""30"","

        If CLng(us_reg) > 0 Then
            gaugeString &= " title:  '" & FormatNumber((us_reg / th_stage) * 100, 1).ToString & "% (" & us_reg.ToString & ")'," 'change to percent
        Else
            gaugeString &= " title:  '0%',"
        End If

        gaugeString &= "  startAngle: 90, SweepAngle: 180, valueBox: false, ticksAngle: 180, exactTicks: true, "
        gaugeString &= "  minValue: 0,  maxValue: 100,"
        gaugeString &= "majorTicks: false, strokeTicks: false, "
        gaugeString &= " minorTicks: 0,"
        gaugeString &= "  colorPlate: ""rgba(0,0,0,0)""," 'Make background transparent.
        gaugeString &= " colorStrokeTicks: '#fff', "

        If Trim(graph_color_new) <> "" Then
            gaugeString &= " highlights: false, animation: false, barWidth:25, barProgress: true, colorBarProgress: '" & graph_color_new & "', needle: false, colorBar: '#eee',"
        Else
            gaugeString &= " highlights: false, animation: false, barWidth:25, barProgress: true, colorBarProgress: '#078fd7', needle: false, colorBar: '#eee',"
        End If

        gaugeString &= " numbersMargin: -18, "
        gaugeString &= "colorNumbers:  '#1d3566',"
        gaugeString &= "colorNeedle:  '#1d3566',"
        gaugeString &= "colorNeedleEnd:  '#2a62aa',"
        gaugeString &= "    borderShadowWidth: 0,"
        gaugeString &= "    borders: false,"
        gaugeString &= "  value: " & ((us_reg / th_stage) * 100).ToString & ""
        gaugeString &= "}).draw();"

        gaugeString &= "  var canvas = document.getElementById(""scripted-gaugeUS"");"
        gaugeString &= "  var img = canvas.toDataURL(""image/png"");"
        gaugeString &= " document.getElementById('" & pngGuageUS.ClientID & "').innerHTML = '<img src=""' + img + '"">'"
        gaugeString &= " }"

        gaugeString &= "  function initGauge_Foreign() { var gauge = new RadialGauge({ renderTo:  'scripted-gaugeForeign',"
        gaugeString &= " width: 400, height: 300, units: false, "
        gaugeString &= " fontTitleSize: ""34"","
        gaugeString &= " fontTitle:""Arial"","
        gaugeString &= "colorTitle:  '#4f5050',"
        'Color of the bottom text, like 9 months under the absorption rate gauge.
        gaugeString &= " colorUnits: ""#000000"","
        'Size of bottom text.
        gaugeString &= " fontUnitsSize: ""30"","

        If CLng(us_reg) > 0 Then
            gaugeString &= " title:  '" & (FormatNumber((((th_stage - us_reg) / th_stage) * 100), 1)).ToString & "% (" & (th_stage - us_reg).ToString & ")'," 'change to percent
        Else
            gaugeString &= " title:  '0%',"
        End If

        gaugeString &= "  startAngle: 90, SweepAngle: 180, valueBox: false, ticksAngle: 180, exactTicks: true, "
        gaugeString &= "  minValue: 0,  maxValue: 100,"
        gaugeString &= "majorTicks: false, strokeTicks: false, "
        gaugeString &= " minorTicks: 0,"
        gaugeString &= "  colorPlate: ""rgba(0,0,0,0)""," 'Make background transparent.
        gaugeString &= " colorStrokeTicks: '#fff', "

        If Trim(graph_color_new) <> "" Then
            gaugeString &= " highlights: false, animation: false, barWidth:25, barProgress: true, colorBarProgress: '" & Trim(graph_color_new) & "', needle: false, colorBar: '#eee',"
        Else
            gaugeString &= " highlights: false, animation: false, barWidth:25, barProgress: true, colorBarProgress: '#078fd7', needle: false, colorBar: '#eee',"
        End If
        gaugeString &= " numbersMargin: -18, "
        gaugeString &= "colorNumbers:  '#1d3566',"
        gaugeString &= "colorNeedle:  '#1d3566',"
        gaugeString &= "colorNeedleEnd:  '#2a62aa',"
        gaugeString &= "    borderShadowWidth: 0,"
        gaugeString &= "    borders: false,"
        gaugeString &= "  value: " & (((th_stage - us_reg) / th_stage) * 100).ToString & ""
        gaugeString &= "}).draw();"



        gaugeString &= "  var canvas = document.getElementById(""scripted-gaugeForeign"");"
        gaugeString &= "  var img = canvas.toDataURL(""image/png"");"
        gaugeString &= " document.getElementById('" & pngGuageForeign.ClientID & "').innerHTML = '<img src=""' + img + '"">'"

        gaugeString &= " }"
        Return gaugeString
    End Function


    Public Function Build_FleetMarketSummary_For_Compare(ByVal inModelID As Long, ByVal bIsAcContactTypeView As Boolean, ByVal inMakeName As String, ByRef font_size As Integer, ByVal header_y_or_n As String, ByRef searchCriteria As viewSelectionCriteriaClass) As String
        Build_FleetMarketSummary_For_Compare = ""
        Try
            Dim strHTML

            strHTML = ""
            Build_FleetMarketSummary_For_Compare = ""

            GetFleetInfo(inModelID, False, searchCriteria)




            strHTML = strHTML & "<table  cellspacing='0' cellpadding='2'>" & vbCrLf
            strHTML = strHTML & "<tr><td valign='middle' align='center' colspan='2'><strong>Ownership</strong></td></tr>" & vbCrLf ' <tr><td>&nbsp;</td></tr>

            If CLng(w_owner) > 0 Then
                strHTML = strHTML & "<tr><td valign='top' width='50%' align='left' ><font size='" & font_size & "'>Whole:&nbsp;</td><td align='right'><font size='" & font_size & "'>" & FormatNumber(w_owner, 0, True, False, True) & "</td></tr>" & vbCrLf
            Else
                strHTML = strHTML & "<tr><td valign='top'  width='50%'  align='left'> <font size='" & font_size & "'>Whole:&nbsp;</td><td align='right'><font size='" & font_size & "'>&nbsp;0</td><td>&nbsp;</td></tr>" & vbCrLf
            End If

            If CLng(s_owner) > 0 Then
                strHTML = strHTML & "<tr><td valign='top' align='left' ><font size='" & font_size & "'>Shared:&nbsp;</td><td align='right'><font size='" & font_size & "'>&nbsp;" & FormatNumber(s_owner, 0, True, False, True) & "</td></tr>" & vbCrLf
            Else
                strHTML = strHTML & "<tr><td valign='top' align='left' ><font size='" & font_size & "'>Shared:&nbsp;</td><td align='right'><font size='" & font_size & "'>&nbsp;0</td><td>&nbsp;</td></tr>" & vbCrLf
            End If

            If CLng(f_owner) > 0 Then
                strHTML = strHTML & "<tr><td valign='top' align='left' ><font size='" & font_size & "'>Fractional:&nbsp;</td><td align='right'><font size='" & font_size & "'>&nbsp;" & FormatNumber(f_owner, 0, True, False, True) & "</td></tr>" & vbCrLf
            Else
                strHTML = strHTML & "<tr><td valign='top' align='left' ><font size='" & font_size & "'>Fractional:&nbsp;</td><td align='right'><font size='" & font_size & "'>&nbsp;0</td><td>&nbsp;</td></tr>" & vbCrLf
            End If

            If CLng(totalInOpcount) > 0 Then
                strHTML = strHTML & "<tr><td bgcolor='#F8F8F8' valign='top' align='left' ><font size='" & font_size & "'>Total Aircraft:&nbsp;</td><td  bgcolor='#F8F8F8' align='right'><font size='" & font_size & "'>&nbsp;" & FormatNumber(totalInOpcount, 0, True, False, True) & "</td></tr>" & vbCrLf
            Else
                strHTML = strHTML & "<tr><td bgcolor='#F8F8F8' valign='top' align='left' ><font size='" & font_size & "'>Total Aircraft:&nbsp;</td><td align='right'><font size='" & font_size & "'>&nbsp;0</td><td>&nbsp;</td></tr>" & vbCrLf
            End If

            If CLng(alllow) > 0 And CLng(allhigh) > 0 Then
                strHTML = strHTML & "<tr><td valign='top' align='left'><strong><font size='" & font_size & "'>MFR Year Range:</strong>&nbsp;</td><td align='right'><font size='" & font_size & "'>&nbsp;" & alllow & " - " & allhigh & "</td></tr>" & vbCrLf
            ElseIf CLng(alllow) > 0 And CLng(allhigh) = 0 Then
                strHTML = strHTML & "<tr><td valign='top' align='left'><strong><font size='" & font_size & "'>MFR Year Range:</strong>&nbsp;</td><td align='right'><font size='" & font_size & "'>&nbsp;" & alllow & " - To Present</td></tr>" & vbCrLf
            Else
                strHTML = strHTML & "<tr><td valign='top' align='left'><strong><font size='" & font_size & "'>MFR Year Range:</strong>&nbsp;</td><td align='right'><font size='" & font_size & "'>&nbsp;N/A</td></tr>" & vbCrLf
            End If

            strHTML = strHTML & "<tr><td>&nbsp;</td><td>&nbsp;</td></tr><tr>" & vbCrLf
            ' spacer
            strHTML = strHTML & "<td class='FleetMarket_Right_TD'>&nbsp;</td></tr>" & vbCrLf

            ' Fleet Info
            strHTML = strHTML & "<tr><td align='center' class='FleetMarket_Right_TD' colspan='2'>" & vbCrLf
            strHTML = strHTML & "<table id='lifeCycleTable' width='200' cellspacing='0' cellpadding='4'>" & vbCrLf
            strHTML = strHTML & "<tr><td valign='top' align='center' colspan='2'><strong><font size='" & font_size & "'>Life Cycle</strong></td></tr>" & vbCrLf ' <tr><td>&nbsp;</td></tr>

            If CLng(o_stage) > 0 Then
                strHTML = strHTML & "<tr><td valign='top' align='left' ><font size='" & font_size & "'>In Production:&nbsp;</td><td align='right'><font size='" & font_size & "'>&nbsp;" & FormatNumber(o_stage, 0, True, False, True) & "</td></tr>" & vbCrLf
            Else
                strHTML = strHTML & "<tr><td valign='top' align='left' ><font size='" & font_size & "'>In Production:&nbsp;</td><td align='right'><font size='" & font_size & "'>&nbsp;0</td></tr>" & vbCrLf
            End If

            If CLng(t_stage) > 0 Then
                strHTML = strHTML & "<tr><td valign='top' align='left' ><font size='" & font_size & "'>At MFR:&nbsp;</td><td align='right'><font size='" & font_size & "'>&nbsp;" & FormatNumber(t_stage, 0, True, False, True) & "</td></tr>" & vbCrLf
            Else
                strHTML = strHTML & "<tr><td valign='top' align='left' ><font size='" & font_size & "'>At MFR:&nbsp;</td><td align='right'><font size='" & font_size & "'>&nbsp;0</td></tr>" & vbCrLf
            End If

            If CLng(th_stage) > 0 Then
                strHTML = strHTML & "<tr><td valign='top' align='left' ><font size='" & font_size & "'>In Operation:&nbsp;</td><td align='right'><font size='" & font_size & "'>&nbsp;" & FormatNumber(th_stage, 0, True, False, True) & "</td></tr>" & vbCrLf
            Else
                strHTML = strHTML & "<tr><td valign='top' align='left' ><font size='" & font_size & "'>In Operation:&nbsp;</td><td align='right'><font size='" & font_size & "'>&nbsp;0</td></tr>" & vbCrLf
            End If

            If CLng(f_stage) > 0 Then
                strHTML = strHTML & "<tr><td valign='top' align='left' ><font size='" & font_size & "'>Retired:&nbsp;</td><td align='right'><font size='" & font_size & "'>&nbsp;" & FormatNumber(f_stage, 0, True, False, True) & "</td></tr>" & vbCrLf
            Else
                strHTML = strHTML & "<tr><td valign='top' align='left' ><font size='" & font_size & "'>Retired:&nbsp;</td><td align='right'><font size='" & font_size & "'>&nbsp;0</td></tr>" & vbCrLf
            End If

            If CLng(totalcount) > 0 Then
                strHTML = strHTML & "<tr><td valign='top'  bgcolor='#F8F8F8' align='left' class='border_bottom'><strong><font size='" & font_size & "'>Total Aircraft:</strong>&nbsp;</td><td align='right'><font size='" & font_size & "'>&nbsp;" & FormatNumber(totalcount, 0, True, False, True) & "</td></tr>" & vbCrLf
            Else
                strHTML = strHTML & "<tr bgcolor='#F8F8F8'><td valign='top' align='left' class='border_bottom'><strong><font size='" & font_size & "'>Total Aircraft:</strong>&nbsp;</td><td  class='border_bottom' align='right' bgcolor='#F8F8F8'><font size='" & font_size & "'>&nbsp;0</td></tr>" & vbCrLf
            End If

            strHTML = strHTML & "<tr><td>&nbsp;</td></tr></table>" & vbCrLf

            strHTML = strHTML & "</td></tr>" & vbCrLf

            Build_FleetMarketSummary_For_Compare = Trim(strHTML)


            Dim GetMarketStatus As String = ""
            GetMarketStatus = "<tr><td align='center' class='FleetMarket_Bottom_TD' colspan='3'>"
            GetMarketStatus = GetMarketStatus & "<table id='marketPlaceStatusTable' cellspacing='0' cellpadding='4'>" & vbCrLf '<tr>&nbsp;</tr>
            GetMarketStatus = GetMarketStatus & "<tr><td valign='top' align='center' colspan='2'><strong><font size='" & font_size & "'>Market Status</strong></td></tr>" & vbCrLf

            If CLng(ac_for_sale) > 0 Then
                If Not HttpContext.Current.Session.Item("localPreferences").AerodexFlag Then
                    GetMarketStatus = GetMarketStatus & "<tr><td valign='top' align='left' width='44%' ><font size='" & font_size - 1 & "'>For Sale:&nbsp;</td><td align='left'><font size='" & font_size - 1 & "'>" & FormatNumber(ac_for_sale, 0, True, False, True) & "&nbsp;<span class='tiny'>(" & FormatNumber(per, 1) & "% of In Operation)</span></td></tr>" & vbCrLf
                Else
                    GetMarketStatus = GetMarketStatus & "<tr><td valign='top' align='left' width='44%' ><font size='" & font_size - 1 & "'>For Sale:&nbsp;</td><td align='left'><font size='" & font_size - 1 & "'>" & FormatNumber(ac_for_sale, 0, True, False, True) & " &nbsp;<span class='tiny'>(" & FormatNumber(per, 1) & "% of In Operation)</span></td></tr>" & vbCrLf
                End If
            Else
                GetMarketStatus = GetMarketStatus & "<tr><td valign='top' align='left'  width='44%'><font size='" & font_size & "'>For Sale:&nbsp;</td><td align='left'><font size='" & font_size & "'>0 </font><span class='tiny'>(0% of In Operation)</span></td></tr>" & vbCrLf
            End If

            If Trim(forsaleavlow) <> "0" And Trim(forsaleavghigh) <> "0" Then
                GetMarketStatus = GetMarketStatus & "<tr><td valign='top' align='left' ><font size='" & font_size - 1 & "'>Asking Price Range:&nbsp;</td><td align='left'><font size='" & font_size - 1 & "'>" & forsaleavlow & " - " & forsaleavghigh & "</td></tr>" & vbCrLf
            Else
                GetMarketStatus = GetMarketStatus & "<tr><td valign='top' align='left' ><font size='" & font_size - 1 & "'>Asking Price Range:&nbsp;</td><td align='left'><font size='" & font_size - 1 & "'>No Asking Prices</td></tr>" & vbCrLf
            End If

            If Not HttpContext.Current.Session.Item("localPreferences").AerodexFlag Then
                ' THIS IS FOR ON EXCLUSIVE %
                If CLng(ac_exclusive_sale) > 0 Then
                    GetMarketStatus = GetMarketStatus & "<tr><td valign='top' align='left' ><font size='" & font_size - 1 & "'>On Exclusive:&nbsp;</td><td align='left'><font size='" & font_size - 1 & "'>" & FormatNumber(ac_exclusive_sale, 0, True, False, True) & "<span class='tiny'> (" & FormatNumber(per2, 1) & "% of For Sale on Exclusive)</span></td></tr>" & vbCrLf
                Else
                    GetMarketStatus = GetMarketStatus & "<tr><td valign='top' align='left' ><font size='" & font_size - 1 & "'>On Exclusive:&nbsp;</td><td align='left'><font size='" & font_size - 1 & "'>(0% of For Sale on Exclusive)</span></td></tr>" & vbCrLf
                End If

            End If

            If Trim(avgyear) <> "0" Then
                GetMarketStatus = GetMarketStatus & "<tr><td valign='top' align='left' ><font size='" & font_size - 1 & "'>Avg MFG Year:&nbsp;</td><td align='left'><font size='" & font_size - 1 & "'>" & avgyear & "</td></tr>" & vbCrLf
            Else
                GetMarketStatus = GetMarketStatus & "<tr><td valign='top' align='left' ><font size='" & font_size - 1 & "'>Avg MFG Year:&nbsp;</td><td align='v'><font size='" & font_size - 1 & "'>N/A</td></tr>" & vbCrLf
            End If

            If Trim(days) <> "" Then
                GetMarketStatus = GetMarketStatus & "<tr><td valign='top' align='left' ><font size='" & font_size - 1 & "'>Avg Days on Market:&nbsp;</td><td align='left'><font size='" & font_size - 1 & "'>" & days & "</td></tr>" & vbCrLf
            Else
                GetMarketStatus = GetMarketStatus & "<tr><td valign='top' align='left' ><font size='" & font_size - 1 & "'>Avg Days on Market:&nbsp;</td><td align='left'><font size='" & font_size - 1 & "'>N/A</td></tr>" & vbCrLf
            End If

            If CLng(ac_lease) > 0 Then
                GetMarketStatus = GetMarketStatus & "<tr><td valign='top' align='left' ><font size='" & font_size - 1 & "'>Leased:&nbsp;</td><td align='left'><font size='" & font_size - 1 & "'>" & FormatNumber(ac_lease, 0, True, False, True) & "<span class='tiny'> (" & FormatNumber(per3, 1) & "% of In Operation)</span></td></tr>" & vbCrLf
            Else
                GetMarketStatus = GetMarketStatus & "<tr><td valign='top' align='left' ><font size='" & font_size - 1 & "'>Leased:&nbsp;</td><td align='left'><font size='" & font_size - 1 & "'>0 <span class='tiny'> (0% of In Operation)</span></td></tr>" & vbCrLf
            End If


            GetMarketStatus = GetMarketStatus & "<tr><td>&nbsp;</td></tr></table></td></tr></table>"


            Build_FleetMarketSummary_For_Compare = Build_FleetMarketSummary_For_Compare & GetMarketStatus



        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Build_FleetMarketSummary: " & ex.Message
        End Try
    End Function

    Function PrintAircraftDetails_PDF(ByVal id As Integer, ByVal comp_id As Integer) As String


        Dim nAircraftID As Integer = id

        Dim imgFolder As String = HttpContext.Current.Server.MapPath(Session.Item("AircraftPicturesFolderVirtualPath"))
        Dim imgDisplayFolder As String = Application.Item("crmClientSiteData").ClientFullHostName & Session.Item("AircraftPicturesFolderVirtualPath")
        Dim imgFileName As String = ""

        Dim fApicSubject As String = ""
        Dim fAcpic_image_type As String = ""
        Dim fAcpic_id As Integer = 0
        Dim pic_seq_num As Integer = 0

        Dim Query As String = ""
        Dim htmlOutput As String = ""
        Dim PDF_To_HTML, nAircraftJournalID, tempStr, xLoop, sAirframeType, sAircraftType, nloopCount, bHasMainBlades, bHasTailBlades, sLabel, path_PDF, ajavascript, temp_moyear, htmlOutput_start
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlConn2 As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim SqlCommand2 As New System.Data.SqlClient.SqlCommand
        Dim adoTempRS As System.Data.SqlClient.SqlDataReader : adoTempRS = Nothing
        Dim adoTempRS2 As System.Data.SqlClient.SqlDataReader : adoTempRS2 = Nothing
        Dim adoRSAircraft As System.Data.SqlClient.SqlDataReader : adoRSAircraft = Nothing
        Dim string_for_word As String = ""

        nAircraftJournalID = 0
        tempStr = ""
        xLoop = 0
        sAirframeType = ""
        sAircraftType = ""
        nloopCount = 0
        bHasMainBlades = False
        bHasTailBlades = False
        sLabel = ""
        htmlOutput = ""

        ajavascript = ""
        htmlOutput_start = ""
        PDF_To_HTML = "<html><head><title>Print Aircraft Details to PDF</title></head><body>"
        Dim temp_folder1 As String = ""

        Try

            path_PDF = HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\"

            '      htmlOutput_start = "<style type='text/css'>.MainTableBorder{border-left: thick solid #C3C3C3;border-right: thick solid #C3C3C3;border-bottom: thick solid #C3C3C3;border-top: thick solid #C3C3C3;border-width: thin;}.CompInfo{border-bottom: thick solid #C3C3C3;border-width: thin;}.FontSize{font-size: 11px;}</style>"

            htmlOutput_start += "<table align='center'><tr><td></td></tr></table>" ' " & chr(34) & "NewPage()" & chr(34) & ">   <a href='REPLACEXXX'><input type='button' value='Convert To PDF'></a>
            htmlOutput_start += "<table border='1' bordercolor='#949494' cellpadding='2' cellspacing='0'><tr>"



            htmlOutput_start += "<tr id='TR_Main_Table_For_AC_ID_Status_Pic'>"
            htmlOutput_start += "<td id='TD_Inner_Table_AC_ID_Status_Pic' valign='top' width='100%'>"
            htmlOutput_start += "<table id='Top_Table_Aircraft_Identification_Status' valign='top' width='100%'>"
            htmlOutput_start += "<tr id='TR_Aircraft_Idenification_Status_Logo_N_AC_Pic'>"
            ' start td for Aircraft Idenification status
            htmlOutput_start += "<td colspan='2' width='40%' id='Aircraft_Idenification_Status' valign='top'>"




            Query = "SELECT DISTINCT * FROM Company WITH(NOLOCK) WHERE (comp_journ_id =  0 AND comp_id = " & comp_id & " AND comp_hide_flag = 'N')"


            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            SqlConn2.ConnectionString = Session.Item("localPreferences").UserDatabaseConn

            SqlConn.Open()
            SqlConn2.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = Query
            adoTempRS = SqlCommand.ExecuteReader()


            If adoTempRS.HasRows Then
                adoTempRS.Read()
                htmlOutput = htmlOutput & "<table><tr><td width='2%'>&nbsp;</td><td>"
                If Not IsDBNull(adoTempRS("comp_name")) And adoTempRS("comp_name") <> "" Then
                    htmlOutput = htmlOutput & "<table class='FontSize'><tr><td><strong><i>" & adoTempRS("comp_name") & "</i></strong></td></tr>"
                End If

                If tempStr <> "" Then
                    htmlOutput = htmlOutput & tempStr
                End If
                If Not IsDBNull(adoTempRS("comp_web_address")) And adoTempRS("comp_web_address") <> "" Then
                    tempStr = "<tr><td><b>Website: </b>" & adoTempRS("comp_web_address") & "</td></tr>"
                End If
                If Not IsDBNull(adoTempRS("comp_web_address")) And adoTempRS("comp_web_address") <> "" Then
                    tempStr = tempStr & "<tr><td><b>E-mail: </b>" & adoTempRS("comp_email_address") & "</td></tr>"
                End If

            End If

            If Not Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                htmlOutput = htmlOutput & "</td></tr></table></td></tr></table>"
            End If

            adoTempRS.Close()
            adoTempRS.Dispose()
            adoTempRS = Nothing




            Query = "SELECT * FROM Phone_Numbers WITH(NOLOCK), Phone_Type WITH(NOLOCK)"
            Query = Query & " WHERE pnum_comp_id = " & CStr(comp_id)
            Query = Query & " AND pnum_journ_id = " & CStr(nAircraftJournalID)
            Query = Query & " AND pnum_hide_customer = 'N' AND pnum_contact_id = 0"
            Query = Query & " AND pnum_type = ptype_name ORDER BY pnum_type desc"  ' QUERY EDITED TO DISPLAY TOLL FREE THEN OFFICE THEN FAX

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = Query
            adoTempRS = SqlCommand.ExecuteReader()

            If adoTempRS.HasRows Then
                Do While adoTempRS.Read
                    htmlOutput = htmlOutput & "<tr><td><b>" & Trim(adoTempRS("pnum_type")) & "</b>: " & Trim(adoTempRS("pnum_number_full")) & "</li></td></tr>"
                Loop
                htmlOutput = htmlOutput & tempStr
            Else
                htmlOutput = htmlOutput & tempStr
            End If
            tempStr = ""


            adoTempRS.Close()
            adoTempRS.Dispose()
            adoTempRS = Nothing
            SqlCommand.Dispose()



            If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                htmlOutput = htmlOutput & "</td></tr></table>"
            End If


            ' get the Aircraft Identification / Status info 
            Query = "SELECT * FROM Aircraft WITH(NOLOCK) INNER JOIN Aircraft_Model WITH(NOLOCK) ON ac_amod_id = amod_id"
            Query = Query & " WHERE ac_journ_id = " & CStr(nAircraftJournalID) & " and ac_id = " & CStr(nAircraftID)
            ' Query = Query & commonEVO.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, False)
            Query = Query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, True)

            'htmlOutput = htmlOutput & Query)



            SqlCommand2.Connection = SqlConn
            SqlCommand2.CommandType = System.Data.CommandType.Text
            SqlCommand2.CommandTimeout = 60
            SqlCommand2.CommandText = Query
            adoRSAircraft = SqlCommand2.ExecuteReader()


            If adoRSAircraft.HasRows Then
                adoRSAircraft.Read()

                htmlOutput = htmlOutput & "<table id='Aircraft_Identification_Status' class='FontSize'>" 'class='SpecsTableBorderLittle'
                ' start company info

                ''''''''''''''''''''''''''''''''''''''''''''
                ' start the Aircraft Identification Status
                ''''''''''''''''''''''''''''''''''''''''''''
                ' make
                If Not IsDBNull(adoRSAircraft("amod_make_name")) Then
                    htmlOutput = htmlOutput & "<tr><td width='2%'>&nbsp;</td><td NOWRAP><br><br>"
                    '<b><i>Make: </i></b> 
                    htmlOutput = htmlOutput & adoRSAircraft("amod_make_name") & "&nbsp;"
                End If
                ' model
                If Not IsDBNull(adoRSAircraft("amod_model_name")) Then
                    ' htmlOutput = htmlOutput & "<tr><td width='2%'>&nbsp;</td><td NOWRAP>"
                    '<b><i>Model: </i></b>
                    htmlOutput = htmlOutput & adoRSAircraft("amod_model_name") & "</td></tr>"
                End If
                ' year of manufacture
                If Not IsDBNull(adoRSAircraft("ac_mfr_year")) Then
                    htmlOutput = htmlOutput & "<tr><td width='2%'>&nbsp;</td><td NOWRAP><b><i>Year of Manufacture: </i></b>" & adoRSAircraft("ac_mfr_year") & "</td></tr>"
                End If
                ' serial number
                If Not IsDBNull(adoRSAircraft("ac_ser_no_full")) Then
                    htmlOutput = htmlOutput & "<tr><td width='2%'>&nbsp;</td><td NOWRAP><b><i>Serial Number: </i></b>" & adoRSAircraft("ac_ser_no_full") & "</td></tr>"
                End If
                ' reg number
                If Not IsDBNull(adoRSAircraft("ac_reg_no")) Then
                    htmlOutput = htmlOutput & "<tr><td width='2%'>&nbsp;</td><td NOWRAP><b><i>Registration Number: </i></b>" & adoRSAircraft("ac_reg_no") & "</td></tr>"
                End If
                ' airframe total time
                If Not IsDBNull(adoRSAircraft("ac_airframe_tot_hrs")) Then
                    htmlOutput = htmlOutput & "<tr><td width='2%'>&nbsp;</td><td NOWRAP><b><i>Airframe Total Time(AFTT): </i></b>" & FormatNumber(adoRSAircraft("ac_airframe_tot_hrs"), 0) & "</td></tr>"
                End If
                ' landing cycles
                If Not IsDBNull(adoRSAircraft("ac_airframe_tot_landings")) Then
                    htmlOutput = htmlOutput & "<tr><td width='2%'>&nbsp;</td><td NOWRAP><b><i>Landings/Cycles: </i></b>" & FormatNumber(adoRSAircraft("ac_airframe_tot_landings"), 0) & "</td></tr>"
                End If
                ' asking amt
                If Not IsDBNull(adoRSAircraft("ac_asking_price")) Then
                    htmlOutput = htmlOutput & "<tr><td width='2%'>&nbsp;</td><td NOWRAP><b><i>Asking Amt (USD): </i></b>" & FormatCurrency(adoRSAircraft("ac_asking_price"), 0) & "</td></tr>"
                End If
                ' empty tr td
                ' htmlOutput = htmlOutput & "<tr><td width='2%'>&nbsp;</td><td>&nbsp;</td></tr>"
                htmlOutput = htmlOutput & "</table>" 'Aircraft_Identification_Status
                '--------------------------------------------------------------------------------------------------------------------------------------------------------------


                htmlOutput = htmlOutput & "</td>" 'Aircraft_Idenification_Status
                ' end td for Aircraft Idenification status

                ' start AC_Pic
                Query = "SELECT TOP 1 * FROM Aircraft_Pictures WITH(NOLOCK)"
                Query = Query & " WHERE acpic_ac_id = " & nAircraftID
                Query = Query & " AND acpic_journ_id = " & nAircraftJournalID
                Query = Query & " AND acpic_seq_no > '0'"
                Query = Query & " AND acpic_image_type = 'JPG'"
                Query = Query & " AND acpic_hide_flag = 'N'"
                Query = Query & " ORDER BY acpic_seq_no"

                SqlCommand.Connection = SqlConn2
                SqlCommand.CommandType = System.Data.CommandType.Text
                SqlCommand.CommandTimeout = 60
                SqlCommand.CommandText = Query
                adoTempRS2 = SqlCommand.ExecuteReader()

                If adoTempRS2.HasRows Then

                    adoTempRS2.Read()

                    pic_seq_num = CInt(adoTempRS2.Item("acpic_seq_no").ToString)

                    If Not IsDBNull(adoTempRS2("acpic_image_type")) Then
                        fAcpic_image_type = adoTempRS2.Item("acpic_image_type").ToString.ToLower.Trim
                    End If

                    If Not IsDBNull(adoTempRS2("acpic_id")) Then
                        fAcpic_id = adoTempRS2.Item("acpic_id").ToString.Trim
                    End If

                    If Not (IsDBNull(adoTempRS2("acpic_subject"))) Then
                        fApicSubject = adoTempRS2.Item("acpic_subject").ToString.Trim
                    End If

                    imgFileName = nAircraftID.ToString + crmWebClient.Constants.cHyphen + nAircraftJournalID.ToString + crmWebClient.Constants.cHyphen + fAcpic_id.ToString + crmWebClient.Constants.cDot + fAcpic_image_type.ToLower.Trim

                Else
                    imgFileName = ""
                End If

                ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
                ' setup the path for the pictures based on which site is running
                ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
                If Not String.IsNullOrEmpty(imgFileName) Then
                    If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                        If System.IO.File.Exists(imgFolder.Trim + "\" + imgFileName.Trim) Then
                            htmlOutput = htmlOutput & "<td width='60%' id='AC_Pic' align='right' valign='top'>"
                            htmlOutput = htmlOutput + "<img Title='" + fApicSubject.Trim + "' src='" + imgDisplayFolder.Trim + "/" + imgFileName.Trim + "' width='400' />"
                        End If
                    Else
                        If System.IO.File.Exists(imgFolder.Trim + "\" + imgFileName.Trim) Then
                            htmlOutput = htmlOutput & "<td width='450' id='AC_Pic' align='right' valign='top'>"
                            htmlOutput = htmlOutput + "<img Title='" + fApicSubject.Trim + "' alt='" + fApicSubject.Trim + "' src='" + imgDisplayFolder.Trim + "/" + imgFileName.Trim + "' width='450'/>"
                        End If
                    End If

                Else
                    htmlOutput = htmlOutput & "<img src='' width='250'/>"
                End If

                If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                    htmlOutput = "<table align='center' width='640' border='0' ><tr valign='top'><td valign='top'><table width='100%'><tr valign='top'><td valign='top'>" & htmlOutput
                    htmlOutput += "</td><td valign='top'>" & string_for_word
                    htmlOutput += "</td></tr></table>"
                Else
                    htmlOutput = htmlOutput_start & htmlOutput
                End If

                htmlOutput = htmlOutput & "</td>" 'Aircraft_Idenification_Status

                htmlOutput = htmlOutput & "</tr><tr>"
                adoTempRS2.Close()
                adoTempRS2.Dispose()
                adoTempRS2 = Nothing

                ' Addtl_Pics_Inner_Littler_Table
                '''''''''''''''''''''''
                ' code for images
                '''''''''''''''''''''''
                Query = "SELECT Top 4 * FROM Aircraft_Pictures WITH(NOLOCK)"
                Query = Query & " WHERE acpic_ac_id = " & nAircraftID
                Query = Query & " AND acpic_journ_id = " & nAircraftJournalID
                Query = Query & " AND acpic_seq_no > '0'"
                Query = Query & " AND acpic_image_type = 'JPG'"
                Query = Query & " AND acpic_hide_flag = 'N'"
                If pic_seq_num <> 0 Then
                    Query = Query & " AND acpic_seq_no <> " & pic_seq_num
                End If

                SqlCommand.Connection = SqlConn2
                SqlCommand.CommandType = System.Data.CommandType.Text
                SqlCommand.CommandTimeout = 60
                SqlCommand.CommandText = Query
                adoTempRS2 = SqlCommand.ExecuteReader()

                If adoTempRS2.HasRows Then
                    htmlOutput = htmlOutput & "<td colspan='2' valign='top' align='center'>" ' start td for Addtl_Pics_Inner_Littler_Table
                    htmlOutput = htmlOutput & "<table id='Addtl_Pics_Inner_Little_Table'  class='FontSize'>"
                    htmlOutput = htmlOutput & "<tr>"
                    Do While adoTempRS2.Read
                        pic_seq_num = CInt(adoTempRS2.Item("acpic_seq_no").ToString)

                        If Not IsDBNull(adoTempRS2("acpic_image_type")) Then
                            fAcpic_image_type = adoTempRS2.Item("acpic_image_type").ToString.ToLower.Trim
                        End If

                        If Not IsDBNull(adoTempRS2("acpic_id")) Then
                            fAcpic_id = adoTempRS2.Item("acpic_id").ToString.Trim
                        End If

                        If Not (IsDBNull(adoTempRS2("acpic_subject"))) Then
                            fApicSubject = adoTempRS2.Item("acpic_subject").ToString.Trim
                        End If

                        imgFileName = nAircraftID.ToString + crmWebClient.Constants.cHyphen + nAircraftJournalID.ToString + crmWebClient.Constants.cHyphen + fAcpic_id.ToString + crmWebClient.Constants.cDot + fAcpic_image_type.ToLower.Trim

                        htmlOutput = htmlOutput & "<td align='right'>"

                        ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
                        ' setup the path for the pictures based on which site is running
                        ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
                        If Not String.IsNullOrEmpty(imgFileName) Then
                            If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                                If System.IO.File.Exists(imgFolder.Trim + "\" + imgFileName.Trim) Then
                                    htmlOutput = htmlOutput + "<img Title='" + fApicSubject.Trim + "' src='" + imgDisplayFolder.Trim + "/" + imgFileName.Trim + "' width='160' height='160' />"
                                End If
                            Else
                                If System.IO.File.Exists(imgFolder.Trim + "\" + imgFileName.Trim) Then
                                    htmlOutput = htmlOutput + "<img Title='" + fApicSubject.Trim + "' alt='" + fApicSubject.Trim + "' src='" + imgDisplayFolder.Trim + "/" + imgFileName.Trim + "' width='180' height='180' />"
                                End If
                            End If
                        Else
                            htmlOutput = htmlOutput & "<img src='' width='150' height='150' />"
                        End If

                        htmlOutput = htmlOutput & "</td>"

                    Loop
                    htmlOutput = htmlOutput & "<tr></table>" ' end table Addtl_Pics_Inner_Little_Table
                    htmlOutput = htmlOutput & "</td>" ' end Addtl_Pics_Inner_Littler_Table
                Else
                    imgFileName = ""
                End If

                adoTempRS2.Close()
                adoTempRS2.Dispose()
                adoTempRS2 = Nothing


                ' start rest of specs and pics
                htmlOutput = htmlOutput & "<tr id='TR_Main_Table_For_AC_Specs_Addtl_Pics'>" 'TR_Main_Table_For_AC_Specs_Addtl_Pics
                htmlOutput = htmlOutput & "<td id='TD_Addtl_Specs_Inner_Table_Start' width='80%' colspan='2'>" 'TD_Addtl_Specs_Inner_Table_Start
                htmlOutput = htmlOutput & "<table id='Addtl_Specs_N_Pics' width='100%'  class='FontSize'>" 'Addtl_Specs_N_Pics
                htmlOutput = htmlOutput & "<td width='80%' valign='top'>"
                htmlOutput = htmlOutput & "<table id='Addtl_Specs_Inner_Little_Table'  class='FontSize'>" 'Table Addtl_Specs_Inner_Little_Table
                htmlOutput = htmlOutput & "<tr id='TR_Engine_Information'>" 'TR_Engine_Information
                htmlOutput = htmlOutput & "<td width='55%' colspan='2' valign='top'>"
                htmlOutput = htmlOutput & "<table id='Engine_Information'  class='FontSize'>" ' Table Engine Information
                htmlOutput = htmlOutput & "<tr><td colspan='2'><strong>ENGINE INFORMATION</strong></td></tr>"
                ' Engine Model
                htmlOutput = htmlOutput & "<tr><td width='2%'>&nbsp;</td><td nowrap><b><i>Model: </b></i>" & adoRSAircraft("ac_engine_name") '& "</td></tr>"
                ' Engine Maintenance Program



                '---------------------------------------------------------------------------- HERE IS SECTION--------------------------------------------------------------------------------------------
                Query = "SELECT emp_provider_name, emp_program_name FROM Engine_Maintenance_Program WITH(NOLOCK) WHERE emp_id = " & adoRSAircraft("ac_engine_maintenance_prog_EMP")

                'SELECT emgp_program_name FROM Engine_Management_Program WITH(NOLOCK) WHERE emgp_id = " & adoRSAircraft("ac_engine_management_prog_EMGP").Value


                SqlCommand.Connection = SqlConn2
                SqlCommand.CommandType = System.Data.CommandType.Text
                SqlCommand.CommandTimeout = 60
                SqlCommand.CommandText = Query
                adoTempRS2 = SqlCommand.ExecuteReader()

                If adoTempRS2.HasRows Then
                    adoTempRS2.Read()
                    If adoTempRS2("emp_provider_name") <> "" And adoTempRS2("emp_provider_name") <> "Unknown" Then
                        'htmlOutput = htmlOutput & "<tr><td width='2%'>&nbsp;</td><td>"

                        htmlOutput = htmlOutput & "&nbsp;&nbsp;<b><i>Maintenance Plan: </b></i>" & adoTempRS2("emp_provider_name") & "&nbsp;" & adoTempRS2("emp_program_name") & "</td></tr>"
                    End If
                End If


                adoTempRS2.Close()
                adoTempRS2.Dispose()
                adoTempRS2 = Nothing

                '---------------------------------------------------------------------------- HERE IS SECTION-------------------------------------------------------------------------------------------- 


                htmlOutput = htmlOutput & "<tr id='TR_Engine_Information_Mini_Table'>" 'TR_Engine_Information_Mini_Table
                htmlOutput = htmlOutput & "<td width='2%'>&nbsp;</td>"
                htmlOutput = htmlOutput & "<td colspan='2'>"
                htmlOutput = htmlOutput & "<table id='Engine_Information_Mini_Table'  class='FontSize'>" 'Table Engine_Information_Mini_Table
                htmlOutput = htmlOutput & "<tr id='TR_Headers_For_Engine'><td>&nbsp;</td><td><b>TTSN:</b></td><td><b>SMOH:</b></td><td><b>TBO:</b></td></tr>"
                nloopCount = 0
                xLoop = 0
                sAirframeType = UCase(Trim(adoRSAircraft("amod_airframe_type_code")))
                sAircraftType = UCase(Trim(adoRSAircraft("amod_type_code")))
                If sAirframeType <> "R" Then
                    nloopCount = 4
                Else
                    nloopCount = 3
                End If
                For xLoop = 1 To nloopCount
                    ' check for Engine info
                    If Not IsDBNull(adoRSAircraft("ac_engine_" & CStr(xLoop) & "_tot_hrs")) Or Not IsDBNull(adoRSAircraft("ac_engine_" & CStr(xLoop) & "_soh_hrs")) Or Not IsDBNull(adoRSAircraft("ac_engine_" & CStr(xLoop) & "_tbo_hrs")) Then
                        ' we have data
                        If xLoop Mod 2 <> 0 Then
                            'response.write "odd"
                            htmlOutput = htmlOutput & "<tr id='TR_Engine_Specs_Specific'>" ' TR_Engine_Specs_Specific
                            htmlOutput = htmlOutput & "<td nowrap><b><i>Engine " & xLoop & " (left):</i></b></td>"
                        Else
                            'response.write "even"
                            htmlOutput = htmlOutput & "<tr id='TR_Engine_Specs_Specific'>" ' TR_Engine_Specs_Specific
                            htmlOutput = htmlOutput & "<td nowrap><b><i>Engine " & xLoop & " (right):</i></b></td>"
                        End If
                        If Not IsDBNull(adoRSAircraft("ac_engine_" & CStr(xLoop) & "_tot_hrs")) Then
                            If IsNumeric(adoRSAircraft("ac_engine_" & CStr(xLoop) & "_tot_hrs")) Then
                                htmlOutput = htmlOutput & "<td>" & FormatNumber(CDbl(adoRSAircraft("ac_engine_" & CStr(xLoop) & "_tot_hrs")), 0, True, False, True) & "</td>"
                            Else
                                htmlOutput = htmlOutput & "<td>" & FormatNumber(0, 0, True, False, True) & "</td>"
                            End If
                        Else
                            htmlOutput = htmlOutput & "<td>&nbsp;</td>"
                        End If
                        If Not IsDBNull(adoRSAircraft("ac_engine_" & CStr(xLoop) & "_soh_hrs")) Then
                            If IsNumeric(adoRSAircraft("ac_engine_" & CStr(xLoop) & "_soh_hrs")) Then
                                htmlOutput = htmlOutput & "<td>" & FormatNumber(CDbl(adoRSAircraft("ac_engine_" & CStr(xLoop) & "_soh_hrs")), 0, True, False, True) & "</td>"
                            Else
                                htmlOutput = htmlOutput & "<td>" & FormatNumber(0, 0, True, False, True) & "</td>"
                            End If
                        Else
                            htmlOutput = htmlOutput & "<td>&nbsp;</td>"
                        End If
                        If Not IsDBNull(adoRSAircraft("ac_engine_" & CStr(xLoop) & "_tbo_hrs")) Then
                            If IsNumeric(adoRSAircraft("ac_engine_" & CStr(xLoop) & "_tbo_hrs")) Then
                                htmlOutput = htmlOutput & "<td>" & FormatNumber(CDbl(adoRSAircraft("ac_engine_" & CStr(xLoop) & "_tbo_hrs")), 0, True, False, True) & "</td></tr>"
                            Else
                                htmlOutput = htmlOutput & "<td>" & FormatNumber(0, 0, True, False, True) & "</td>"
                            End If
                        Else
                            htmlOutput = htmlOutput & "<td>&nbsp;</td>"
                        End If
                    End If

                Next ' xLoop
                htmlOutput = htmlOutput & "</table>" ' Engine_Information_Mini_Table
                htmlOutput = htmlOutput & "</td>"
                htmlOutput = htmlOutput & "</tr>" ' end TR_Engine_Information_Mini_Table
                '  htmlOutput = htmlOutput & "<tr><td width='2%'>&nbsp;</td><td>&nbsp;</td></tr>"
                htmlOutput = htmlOutput & "</table>" ' end Table Engine Information
                htmlOutput = htmlOutput & "</td>"




                If sAircraftType = "J" And sAirframeType = "F" Then
                    If Not IsDBNull(adoRSAircraft("ac_apu_model_name")) Then
                        If adoRSAircraft("ac_apu_model_name") <> "" Then

                            htmlOutput = htmlOutput & "<td width='55%' colspan='2' valign='top'>" ' td start table Aux Power Unit
                            htmlOutput = htmlOutput & "<table id='Auxiliary_Power_Unit'  class='FontSize'>" ' table Auxiliary_Power_Unit class='SpecsTableBorderLittle' 
                            htmlOutput = htmlOutput & "<tr><td colspan='2'><strong>AUXILIARY POWER UNIT (APU)</strong></td></tr>"
                            If adoRSAircraft("ac_apu_model_name") <> "" Then
                                htmlOutput = htmlOutput & "<tr><td width='2%'>&nbsp;</td>"
                                htmlOutput = htmlOutput & "<td><b><i>Model: </i></b>" & adoRSAircraft("ac_apu_model_name") & "</td></tr>"
                            End If
                            htmlOutput = htmlOutput & "<tr><td width='2%'>&nbsp;</td>"
                            If Not IsDBNull(adoRSAircraft("ac_apu_tot_hrs")) Then
                                If Trim(CStr(adoRSAircraft("ac_apu_tot_hrs"))) <> "" Then
                                    htmlOutput = htmlOutput & "<td nowrap><b><i>Total Time (Hours) Since New: </i></b>" & FormatNumber(CDbl(adoRSAircraft("ac_apu_tot_hrs")), 0, True, False, True) & "</td></tr>"
                                End If
                            Else
                                htmlOutput = htmlOutput & "<td>&nbsp;</td></tr>"
                            End If
                            htmlOutput = htmlOutput & "<tr><td width='2%'>&nbsp;</td><td>&nbsp;</td></tr>"
                            htmlOutput = htmlOutput & "</table>" ' end Auxiliary_Power_Unit
                            htmlOutput = htmlOutput & "</td>" ' end td Aux power unit
                        End If
                    End If
                ElseIf sAircraftType <> "J" And sAirframeType = "F" Then
                    htmlOutput = htmlOutput & "<td width='2%'>&nbsp;</td>"
                    htmlOutput = htmlOutput & "<td valign='top'>"
                    htmlOutput = htmlOutput & "<table id='Prop_Information_Mini_Table' class='FontSize'>" 'Table Prop_Information_Mini_Table
                    htmlOutput = htmlOutput & "<tr><td colspan='4'><strong>PROPELLER INFORMATION</strong></td></tr>"
                    htmlOutput = htmlOutput & "<tr><td colspan='2'>&nbsp;</td></tr>"
                    htmlOutput = htmlOutput & "<tr id='TR_Headers_For_Props'><td>&nbsp;</td><td><b>TTSN:</b></td><td><b>SPOH:</b></td><td nowrap><b>Date of Overhaul (MM/YY):</b></td></tr>"
                    nloopCount = 0
                    xLoop = 0
                    nloopCount = 4
                    For xLoop = 1 To nloopCount

                        ' check for prop info
                        If Not IsDBNull(adoRSAircraft("ac_prop_" & CStr(xLoop) & "_snew_hrs")) Or Not IsDBNull(adoRSAircraft("ac_prop_" & CStr(xLoop) & "_soh_hrs")) Or Not IsDBNull(adoRSAircraft("ac_prop_" & CStr(xLoop) & "_soh_moyear")) Then
                            ' we have data
                            If xLoop Mod 2 <> 0 Then
                                'response.write "odd"
                                htmlOutput = htmlOutput & "<tr id='TR_Prop_Info'>" ' TR_Prop_Info
                                htmlOutput = htmlOutput & "<td nowrap><b><i>Propeller " & xLoop & " (left):</i></b></td>"
                            Else
                                'response.write "even"
                                htmlOutput = htmlOutput & "<tr id='TR_Prop_Info'>" ' TR_Prop_Info
                                htmlOutput = htmlOutput & "<td nowrap><b><i>Propeller " & xLoop & " (right):</i></b></td>"
                            End If
                            If Not IsDBNull(adoRSAircraft("ac_prop_" & CStr(xLoop) & "_snew_hrs")) Then
                                If IsNumeric(adoRSAircraft("ac_prop_" & CStr(xLoop) & "_snew_hrs")) Then
                                    htmlOutput = htmlOutput & "<td>" & FormatNumber(CDbl(adoRSAircraft("ac_prop_" & CStr(xLoop) & "_snew_hrs")), 0, True, False, True) & "</td>"
                                Else
                                    htmlOutput = htmlOutput & "<td>" & FormatNumber(0, 0, True, False, True) & "</td>"
                                End If
                            Else
                                htmlOutput = htmlOutput & "<td>&nbsp;</td>"
                            End If
                            If Not IsDBNull(adoRSAircraft("ac_prop_" & CStr(xLoop) & "_soh_hrs")) Then
                                If IsNumeric(adoRSAircraft("ac_prop_" & CStr(xLoop) & "_soh_hrs")) Then
                                    htmlOutput = htmlOutput & "<td>" & FormatNumber(CDbl(adoRSAircraft("ac_prop_" & CStr(xLoop) & "_soh_hrs").Value), 0, True, False, True) & "</td>"
                                Else
                                    htmlOutput = htmlOutput & "<td>" & FormatNumber(0, 0, True, False, True) & "</td>"
                                End If
                            Else
                                htmlOutput = htmlOutput & "<td>&nbsp;</td>"
                            End If
                            If Not IsDBNull(adoRSAircraft("ac_prop_" & CStr(xLoop) & "_soh_moyear")) Then
                                If IsNumeric(adoRSAircraft("ac_prop_" & CStr(xLoop) & "_soh_moyear")) Then
                                    htmlOutput = htmlOutput & "<td>" & FormatNumber(CDbl(adoRSAircraft("ac_prop_" & CStr(xLoop) & "_soh_moyear")), 0, True, False, True) & "</td></tr>"
                                Else
                                    htmlOutput = htmlOutput & "<td>" & FormatNumber(0, 0, True, False, True) & "</td>"
                                End If
                            Else
                                htmlOutput = htmlOutput & "<td>&nbsp;</td>"
                            End If

                        End If

                    Next ' xLoop
                    htmlOutput = htmlOutput & "</table>" ' Prop_Information_Mini_Table
                    htmlOutput = htmlOutput & "</td>"
                ElseIf sAirframeType = "R" Then
                    Query = "SELECT * FROM Helicopter_Detail_Times WITH(NOLOCK) WHERE heldt_ac_id = " & CStr(nAircraftID)
                    Query = Query & " AND heldt_journ_id = " & CStr(nAircraftJournalID) & " AND heldt_category_type <> 'Tail Rotor Blades'"
                    'htmlOutput = htmlOutput & Query)

                    SqlCommand.Connection = SqlConn2
                    SqlCommand.CommandType = System.Data.CommandType.Text
                    SqlCommand.CommandTimeout = 60
                    SqlCommand.CommandText = Query
                    adoTempRS2 = SqlCommand.ExecuteReader()

                    If adoTempRS2.HasRows Then
                        htmlOutput = htmlOutput & "<td width='2%'>&nbsp;</td>"
                        htmlOutput = htmlOutput & "<td valign='top'>"
                        htmlOutput = htmlOutput & "<table id='Prop_Information_Mini_Table' class='FontSize' cellpadding='2' cellspacing='0'>" 'Table Prop_Information_Mini_Table
                        htmlOutput = htmlOutput & "<tr><td colspan='4'><strong>GEARBOX/ROTOR BLADE INFORMATION</strong></td></tr>"
                        ' htmlOutput = htmlOutput & "<tr><td colspan='2'>&nbsp;</td></tr>"
                        htmlOutput = htmlOutput & "<tr id='TR_Headers_For_Props'><td>&nbsp;</td><td>&nbsp;</td><td><b>TTSN:</b></td><td align='center'><b>Time Remaining:</b></td><td nowrap><b>TSOH:</b></td></tr>"
                        Do While adoTempRS2.Read
                            If Not IsDBNull(adoTempRS2("heldt_category_type")) And Trim(adoTempRS2("heldt_category_type")) <> "" Then
                                Select Case UCase(Trim(adoTempRS2("heldt_category_type")))
                                    Case "INTERMEDIATE GEARBOX"
                                        bHasMainBlades = False
                                        bHasTailBlades = False
                                        sLabel = "Intermediate&nbsp;Gearbox"
                                    Case "MAIN ROTOR #1 BLADES", "MAIN ROTOR #2 BLADES"
                                        ' Check for number of blades
                                        sLabel = "Main&nbsp;Blade&nbsp;"
                                        bHasMainBlades = True
                                        bHasTailBlades = False
                                        ' OK Get the Blade Number 1-10
                                        sLabel = sLabel & Right(Trim(adoTempRS2("heldt_subcat_type")), 2)
                                    Case "MAIN ROTOR HUB #1", "MAIN ROTOR HUB #2"
                                        bHasMainBlades = False
                                        bHasTailBlades = False
                                        sLabel = "Main&nbsp;Rotor&nbsp;Hub"
                                    Case "MAIN TRANSMISSION #1", "MAIN TRANSMISSION #2"
                                        bHasMainBlades = False
                                        bHasTailBlades = False
                                        sLabel = "Main&nbsp;Transmission"
                                    Case "TAIL ROTOR BLADES"
                                        ' Check for number of blades
                                        sLabel = "Tail&nbsp;Blade&nbsp;"
                                        bHasMainBlades = False
                                        bHasTailBlades = True
                                        ' OK Get the Blade Number 1-10
                                        sLabel = sLabel & Right(Trim(adoTempRS2("heldt_subcat_type")), 2)
                                    Case "TAIL ROTOR GEARBOX"
                                        bHasMainBlades = False
                                        bHasTailBlades = False
                                        sLabel = "Tail&nbsp;Rotor&nbsp;Gearbox"
                                    Case "TAIL ROTOR HUB"
                                        bHasMainBlades = False
                                        bHasTailBlades = False
                                        sLabel = "Tail&nbsp;Rotor&nbsp;Hub"
                                End Select
                            End If
                            If Not IsDBNull(adoTempRS2("heldt_ttsn")) Or Not IsDBNull(adoTempRS2("heldt_remaining_hours")) Or Not IsDBNull(adoTempRS2("heldt_soh")) Then
                                htmlOutput = htmlOutput & "<tr id='TR_Prop_Info'>" ' TR_Prop_Info
                                htmlOutput = htmlOutput & "<td nowrap>&nbsp;</td>"
                                htmlOutput = htmlOutput & "<td>&nbsp;" & sLabel & "&nbsp;&nbsp;</td>"
                                If Not IsDBNull(adoTempRS2("heldt_ttsn")) Then
                                    htmlOutput = htmlOutput & "<td align='center'>" & FormatNumber(CDbl(adoTempRS2("heldt_ttsn")), 0, True, False, True) & "</td>"
                                Else
                                    htmlOutput = htmlOutput & "<td>&nbsp;</td>"
                                End If
                                If Not IsDBNull(adoTempRS2("heldt_remaining_hours")) Then
                                    htmlOutput = htmlOutput & "<td align='center'>" & FormatNumber(CDbl(adoTempRS2("heldt_remaining_hours")), 0, True, False, True) & "</td>"
                                Else
                                    htmlOutput = htmlOutput & "<td>&nbsp;</td>"
                                End If
                                If Not IsDBNull(adoTempRS2("heldt_soh")) And (Not bHasMainBlades Or Not bHasTailBlades) Then
                                    htmlOutput = htmlOutput & "<td align='center'>" & FormatNumber(CDbl(adoTempRS2("heldt_soh")), 0, True, False, True) & "</td></tr>"
                                Else
                                    htmlOutput = htmlOutput & "<td>&nbsp;</td>"
                                End If
                            End If

                        Loop
                        htmlOutput = htmlOutput & "</table>" ' Prop_Information_Mini_Table
                        htmlOutput = htmlOutput & "</td>"

                        adoTempRS2.Close()
                        adoTempRS2.Dispose()
                        adoTempRS2 = Nothing
                    End If
                End If

                htmlOutput = htmlOutput & "</tr></table></table>" ' endTR_Engine_Information





                Query = "SELECT adet_data_description FROM Aircraft_Details WITH(NOLOCK) WHERE adet_ac_id = " & nAircraftID & " AND adet_journ_id = " & nAircraftJournalID & " AND adet_data_type = 'Maintenance' AND adet_data_name = 'Inspection'"
                'htmlOutput = htmlOutput & Query)

                SqlCommand.Connection = SqlConn2
                SqlCommand.CommandType = System.Data.CommandType.Text
                SqlCommand.CommandTimeout = 60
                SqlCommand.CommandText = Query
                adoTempRS2 = SqlCommand.ExecuteReader()

                If adoTempRS2.HasRows Or Not IsDBNull(adoRSAircraft("ac_maintained")) Then

                    'htmlOutput = htmlOutput & "<tr id='TR_Maintenance_Certifications'>" ' TR_Maintenance_Certifications
                    ' htmlOutput = htmlOutput & "<td width='55%' colspan='4'>" ' td start Maintenance_Certifications

                    htmlOutput = htmlOutput & "<table id='Maintenance_Certifications' class='FontSize' >" ' Maintenance_Certifications class='SpecsTableBorderLittle'
                    htmlOutput = htmlOutput & "<tr><td colspan='2'><strong>MAINTENANCE/CERTIFICATIONS</strong></td></tr>"

                    If Not IsDBNull(adoRSAircraft("ac_maintained")) Then
                        If adoRSAircraft("ac_maintained") <> "" Then
                            htmlOutput = htmlOutput & "<tr><td width='2%'>&nbsp;</td>"
                            htmlOutput = htmlOutput & "<td><b><i>Maintained: </i></b>" & adoRSAircraft("ac_maintained") ' & "</td></tr>"
                        End If
                    End If
                    If adoTempRS2.HasRows Then
                        adoTempRS2.Read()
                        If Not IsDBNull(adoRSAircraft("ac_maintained")) Then
                            If adoRSAircraft("ac_maintained") <> "" Then
                            Else
                                htmlOutput = htmlOutput & "<tr><td width='2%'&nbsp;</td><td>"
                            End If
                        Else
                            htmlOutput = htmlOutput & "<tr><td width='2%'&nbsp;</td><td>"
                        End If
                        htmlOutput = htmlOutput & "&nbsp;&nbsp;<b><i>Inspection: </b></i>" & adoTempRS2("adet_data_description") & "</td></tr>"
                    End If

                    '   htmlOutput = htmlOutput & "<tr><td width='2%'>&nbsp;</td><td>&nbsp;</td></tr>"
                    htmlOutput = htmlOutput & "</table>"

                    adoTempRS2.Close()
                    adoTempRS2.Dispose()
                    adoTempRS2 = Nothing
                End If


                ' Start Equipment Details    
                Query = "SELECT * FROM Aircraft_Details WITH(NOLOCK) WHERE adet_ac_id = " & nAircraftID
                Query = Query & " AND adet_journ_id = " & nAircraftJournalID & " AND adet_data_type = 'Equipment' AND adet_data_name <> 'General'"
                'response.write(Query)
                SqlCommand.Connection = SqlConn2
                SqlCommand.CommandType = System.Data.CommandType.Text
                SqlCommand.CommandTimeout = 60
                SqlCommand.CommandText = Query
                adoTempRS2 = SqlCommand.ExecuteReader()
                If adoTempRS2.HasRows Then
                    htmlOutput = htmlOutput & "<tr id='TR_Equipment_Details'>" ' TR_Equipment_Details
                    htmlOutput = htmlOutput & "<td width='100%' colspan='4'>" ' start td for table
                    htmlOutput = htmlOutput & "<table width='100%' id='Equipment_Details'  class='FontSize'>" ' table Equipment_Details
                    htmlOutput = htmlOutput & "<tr><td colspan='2'  width='100%'><strong>EQUIPMENT DETAILS</strong></td></tr>"
                    htmlOutput = htmlOutput & "<tr><td width='2%'>&nbsp;</td>"
                    htmlOutput = htmlOutput & "<td width='100%'>"
                    Do While adoTempRS2.Read
                        htmlOutput = htmlOutput & "<b><em>" & adoTempRS2("adet_data_name") & "</em></b>: "
                        htmlOutput = htmlOutput & adoTempRS2("adet_data_description") & " "
                    Loop
                    htmlOutput = htmlOutput & "</td></tr>"
                    'htmlOutput = htmlOutput & "<tr><td width='2%'>&nbsp;</td><td>&nbsp;</td></tr>"   
                    htmlOutput = htmlOutput & "</table>" ' end table Equipment_Details
                    htmlOutput = htmlOutput & "</td>" ' end td
                    htmlOutput = htmlOutput & "</tr>" ' TR_Equipment_Details
                End If

                adoTempRS2.Close()
                adoTempRS2.Dispose()
                adoTempRS2 = Nothing


                ' Start Interior Details    
                Query = "SELECT * FROM Aircraft_Details WITH(NOLOCK) WHERE adet_ac_id = " & nAircraftID
                Query = Query & " AND adet_journ_id = " & nAircraftJournalID & " AND adet_data_type = 'Interior' AND adet_data_name IN ('Configuration','Passengers','Seating')"
                'response.write(Query)

                SqlCommand.Connection = SqlConn2
                SqlCommand.CommandType = System.Data.CommandType.Text
                SqlCommand.CommandTimeout = 60
                SqlCommand.CommandText = Query
                adoTempRS2 = SqlCommand.ExecuteReader()


                If adoTempRS2.HasRows Then
                    htmlOutput = htmlOutput & "<tr id='TR_Interior_Details'>" ' start TR_Interior_Details
                    htmlOutput = htmlOutput & "<td width='100%' colspan='4'>" ' start td for table Interior_Details
                    htmlOutput = htmlOutput & "<table id='Interior_Details' width='100%'  class='FontSize'>"
                    htmlOutput = htmlOutput & "<tr><td colspan='2' width='100%'><b>INTERIOR DETAILS</b>&nbsp;"
                    If Not IsDBNull(adoRSAircraft("ac_interior_moyear")) Then
                        If adoRSAircraft("ac_interior_moyear") <> "" Then
                            'htmlOutput = htmlOutput & "<tr><td width='2%'>&nbsp;</td>"
                            If Len(adoRSAircraft("ac_interior_moyear")) > 4 Then
                                temp_moyear = adoRSAircraft("ac_interior_moyear")
                                If Len(temp_moyear) = 5 Then
                                    temp_moyear = Left(temp_moyear, 1) & "/" & Right(temp_moyear, 4)
                                Else
                                    If Len(temp_moyear) = 6 Then
                                        temp_moyear = Left(temp_moyear, 2) & "/" & Right(temp_moyear, 4)
                                    End If
                                End If
                                htmlOutput = htmlOutput & " ( <b><i>Updated: </i></b> " & temp_moyear & " )</i></b></td></tr>"
                            Else
                                htmlOutput = htmlOutput & " ( <b><i>Updated: </i></b> " & adoRSAircraft("ac_interior_moyear") & " )</i></b></td></tr>"
                            End If
                        End If
                    End If
                    htmlOutput = htmlOutput & "<tr><td width='2%'>&nbsp;</td><td><b><i>"
                    Do While adoTempRS2.Read
                        htmlOutput = htmlOutput & adoTempRS2("adet_data_name") & "</i></b>: " & adoTempRS2("adet_data_description")
                        htmlOutput = htmlOutput & ", <i><b>"
                    Loop
                    htmlOutput = htmlOutput & "</td></tr>"
                    '   htmlOutput = htmlOutput & "<tr><td width='2%'>&nbsp;</td><td>&nbsp;</td></tr>"
                    htmlOutput = htmlOutput & "</table>" ' end table TR_Interior_Details
                    htmlOutput = htmlOutput & "</td>" ' end td for table TR_Interior_Details
                    htmlOutput = htmlOutput & "</tr>" ' end TR_Interior_Details
                End If
                adoTempRS2.Close()
                adoTempRS2.Dispose()
                adoTempRS2 = Nothing


                ' Exterior Details

                Query = "SELECT * FROM Aircraft_Details WITH(NOLOCK) WHERE adet_ac_id = " & nAircraftID
                Query = Query & " AND adet_journ_id = " & nAircraftJournalID & " AND adet_data_type = 'Exterior' AND adet_data_name <> 'General'"
                'htmlOutput = htmlOutput & Query

                SqlCommand.Connection = SqlConn2
                SqlCommand.CommandType = System.Data.CommandType.Text
                SqlCommand.CommandTimeout = 60
                SqlCommand.CommandText = Query
                adoTempRS2 = SqlCommand.ExecuteReader()


                If adoTempRS2.HasRows Then
                    htmlOutput = htmlOutput & "<tr id='TR_Exterior_Details'>" ' start TR_Exterior_Details
                    htmlOutput = htmlOutput & "<td width='100%' colspan='4'>" ' start td for table TR_Exterior_Details
                    htmlOutput = htmlOutput & "<table id='Exterior_Details' width='100%'  class='FontSize'>" ' start table Exterior_Details
                    htmlOutput = htmlOutput & "<tr><td colspan='2' width='100%'><b>EXTERIOR DETAILS</b>"
                    'htmlOutput = htmlOutput & "<tr><td width='2%'>&nbsp;</td>"
                    If Not IsDBNull(adoRSAircraft("ac_exterior_moyear")) Then

                        If adoRSAircraft("ac_exterior_moyear") <> "" Then
                            If Len(adoRSAircraft("ac_exterior_moyear")) > 4 Then
                                temp_moyear = adoRSAircraft("ac_exterior_moyear")
                                If Len(temp_moyear) = 5 Then
                                    temp_moyear = Left(temp_moyear, 1) & "/" & Right(temp_moyear, 4)
                                Else
                                    If Len(temp_moyear) = 6 Then
                                        temp_moyear = Left(temp_moyear, 2) & "/" & Right(temp_moyear, 4)
                                    End If
                                End If
                                htmlOutput = htmlOutput & " ( <b><i>Updated: </i></b>" & temp_moyear & " )</td>"
                            Else
                                htmlOutput = htmlOutput & " ( <b><i>Updated: </i></b>" & adoRSAircraft("ac_exterior_moyear") & " )</td>"
                            End If
                        End If
                    End If
                    htmlOutput = htmlOutput & "<tr><td width='2%'>&nbsp;</td><td><b><i>"
                    Do While adoTempRS2.Read
                        htmlOutput = htmlOutput & adoTempRS2("adet_data_name") & "</i></b>: " & adoTempRS2("adet_data_description")
                        htmlOutput = htmlOutput & ", <i><b>"
                    Loop
                    htmlOutput = htmlOutput & "</td></tr>"
                    ' htmlOutput = htmlOutput & "<tr><td width='2%'>&nbsp;</td><td>&nbsp;</td></tr>"
                    htmlOutput = htmlOutput & "</table>" ' end table Exterior_Details
                    htmlOutput = htmlOutput & "</td>" ' end TD for TR_Exterior_Details

                    htmlOutput = htmlOutput & "</tr>" ' end TR_Exterior_Details
                End If
                adoTempRS2.Close()
                adoTempRS2.Dispose()
                adoTempRS2 = Nothing

                ' Start Avionics    
                Query = "SELECT * FROM Aircraft_Avionics WITH(NOLOCK) WHERE av_ac_id = " & nAircraftID & " AND av_ac_journ_id = " & nAircraftJournalID & " AND av_name IN ('Avioncs Package', 'FMS', 'GPS', 'TAWS', 'TCAS', 'SATCOM', 'EFIS', 'CVR', 'FDR')"
                'response.write(Query)
                SqlCommand.Connection = SqlConn2
                SqlCommand.CommandType = System.Data.CommandType.Text
                SqlCommand.CommandTimeout = 60
                SqlCommand.CommandText = Query
                adoTempRS2 = SqlCommand.ExecuteReader()
                If adoTempRS2.HasRows Then
                    htmlOutput = htmlOutput & "<tr id='TR_Avionics'>" ' TR_Avionics
                    htmlOutput = htmlOutput & "<td width='55%' colspan='4'>" ' start td for table Avionics
                    htmlOutput = htmlOutput & "<table id='Avionics' width='100%'  class='FontSize'>" ' start table Avionics
                    htmlOutput = htmlOutput & "<tr><td colspan='2'><b>AVIONICS</b></td></tr>"
                    htmlOutput = htmlOutput & "<tr><td with='2%'>&nbsp;</td><td><b><i>"
                    Do While adoTempRS2.Read
                        htmlOutput = htmlOutput & adoTempRS2("av_name") & "</i></b>: " & adoTempRS2("av_description")
                        htmlOutput = htmlOutput & ", <i><b>"
                    Loop
                    htmlOutput = htmlOutput & "</td></tr>"
                    ' htmlOutput = htmlOutput & "<tr><td width='2%'>&nbsp;</td><td>&nbsp;</td></tr>"
                    htmlOutput = htmlOutput & "</table>" ' end Avionics
                    htmlOutput = htmlOutput & "</td>" ' end td for table Avionics
                    htmlOutput = htmlOutput & "</tr>" ' end TR_Avionics
                End If
                adoTempRS2.Close()
                adoTempRS2.Dispose()
                adoTempRS2 = Nothing






                ' start Cockpit Details
                Query = "SELECT * FROM Aircraft_Details WITH(NOLOCK) WHERE adet_ac_id = " & nAircraftID
                Query = Query & " AND adet_journ_id = " & nAircraftJournalID & " AND adet_data_type = 'addl cockpit equipment' AND adet_data_name <> 'General'"
                'htmlOutput = htmlOutput & Query)
                SqlCommand.Connection = SqlConn2
                SqlCommand.CommandType = System.Data.CommandType.Text
                SqlCommand.CommandTimeout = 60
                SqlCommand.CommandText = Query
                adoTempRS2 = SqlCommand.ExecuteReader()
                If adoTempRS2.HasRows Then
                    htmlOutput = htmlOutput & "<tr id='TR_Cockpit_Details'>" ' start TR_Cockpit_Details
                    htmlOutput = htmlOutput & "<td width='55%' colspan='4'>"
                    htmlOutput = htmlOutput & "<table id='Cockpit_Details' width='100%'  class='FontSize'>" ' table Cockpit_Details
                    htmlOutput = htmlOutput & "<tr><td colspan='4'><b>COCKPIT DETAILS</b></td></tr>"
                    htmlOutput = htmlOutput & "<tr>"
                    htmlOutput = htmlOutput & "<tr><td with='2%'>&nbsp;</td><td><b><i>"
                    Do While adoTempRS2.Read
                        htmlOutput = htmlOutput & adoTempRS2("adet_data_name") & "</i></b>: " & adoTempRS2("adet_data_description")
                        htmlOutput = htmlOutput & ", <i><b>"
                    Loop
                    htmlOutput = htmlOutput & "</td></tr>"
                    htmlOutput = htmlOutput & "</table>" ' end table Cockpit_Details
                    htmlOutput = htmlOutput & "</td>"
                    htmlOutput = htmlOutput & "</tr>" ' end TR_Cockpit_Details
                End If

                ' end Cockpit Details
                ' htmlOutput = htmlOutput & "</table>" ' end Table Addtl_Specs_Inner_Little_Table
                htmlOutput = htmlOutput & "</td>" 'end td for Addtl_Specs_N_Pics



                ' htmlOutput = htmlOutput & "</table>" 'end Addtl_Specs_N_Pics
                ' htmlOutput = htmlOutput & "</td>" 'end TD_Addtl_Specs_Inner_Table_Start
                htmlOutput = htmlOutput & "</tr>" 'end TR_Main_Table_For_AC_Specs_Addtl_Pics

                ' start footer
                htmlOutput = htmlOutput & "<tr id='TR_Footer'><td align='center' width='100%' colspan='2'><table  width='100%' class='FontSize' style='border-top:thick solid #C3C3C3; border-width:thin;'><tr width='100%'><td width='100%' align=center colspan=2>"
                'class='tdFooter'
                htmlOutput = htmlOutput & "<b>JETNET LLC.</b></td></tr></table></td></tr>"


                adoTempRS2.Close()
                adoTempRS2.Dispose()
                adoTempRS2 = Nothing


                ' end footer







            End If   ' end of loop for big selection 

            adoRSAircraft.Close()
            adoRSAircraft.Dispose()
            adoRSAircraft = Nothing
            'adoTempRS.close

            htmlOutput = htmlOutput & "</table>" 'Main_Table_AC_Specs


        Catch ex As Exception
        Finally
            SqlConn.Close()
            SqlConn.Dispose()
            SqlConn = Nothing

            SqlConn2.Close()
            SqlConn2.Dispose()
            SqlConn2 = Nothing
        End Try


        PrintAircraftDetails_PDF = htmlOutput
    End Function

    Function display_top_financial_institutions(ByVal in_HeaderText As String, ByVal table_height As Integer, ByVal real_make_model_name As String, ByVal amod_id As Integer, ByVal num_months As Integer, ByVal airframe_type As String, ByVal sub_info As String, ByVal real_company_name As String, ByVal sub_type As String, ByVal make_name As String, ByVal make_model_or_make_for_title As String, ByVal product_codes As String)
        display_top_financial_institutions = ""
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim adoRs As System.Data.SqlClient.SqlDataReader : adoRs = Nothing
        Dim query As String = ""
        Dim outstring As String = ""
        Dim last_year_month_to_pass As String = ""
        Dim this_year_month_to_pass As String = ""
        Dim total_count As Integer = 0
        Dim first_outstring As String = ""
        Dim number_to_cut_at As Integer = 0
        Dim display_for_date_range As String = ""
        Try
            display_for_date_range = "From: " & Month(DateAdd("m", (-1) * num_months, Now)) & "/01/" & Year(DateAdd("m", (-1) * num_months, Now)) & " Up to: " & Month(Now) & "/01/" & Year(Now)


            first_outstring = "<table id='financialInstitutionsOuterTable' width='100%' cellpadding='1' cellspacing='0' class='module'>"

            first_outstring = first_outstring & "<tr><td valign='top' align='left' class='header' style='padding-left:3px;'>FINANCIAL INSTITUTIONS WITH DOCUMENTS (TOTALCOUNTER)</td></tr><tr valign='top'><td valign='top' align='left'><table valign='top' width='100%'>"
            first_outstring = first_outstring & "<tr><td valign='top' align='left' class='tabheader'><strong>"
            If amod_id > 0 Then
                first_outstring = first_outstring & make_name
            ElseIf Trim(make_name) <> "" Then
                first_outstring = first_outstring & make_name.ToString.ToUpper
            Else
                first_outstring = first_outstring & "ALL MAKES/MODELS"
            End If
            first_outstring = first_outstring & " : Institutions with Documents<br>" & display_for_date_range & "</strong></td><td width='20%' class='border_bottom'>&nbsp;</td></tr>"
            first_outstring = first_outstring & "<tr><td valign='top' align='left' class='seperator' width='70%'><strong>&nbsp;Name</strong></td><td valign='top' align='right' class='seperator' width='30%'><strong># of Docs&nbsp;&nbsp;&nbsp;</strong></td></tr>"
            first_outstring = first_outstring & "<tr><td colspan='2' class='rightside'><table id='financialInstitutionsDataTable' width='100%' cellpadding='4' cellspacing='0'>"




            display_top_financial_institutions = ""

            query = "SELECT case ISNULL(fipg_generic_name,'') WHEN '' THEN 'Misc. Institutions' ELSE fipg_generic_name END AS fipg_generic_name, fipg_main_comp_id, count(*) as tcount"

            query = query & " FROM Aircraft_Document WITH(NOLOCK)"
            query = query & " INNER JOIN Aircraft WITH(NOLOCK) ON ac_id = adoc_ac_id AND ac_journ_id = adoc_journ_id"
            query = query & " INNER JOIN aircraft_model WITH(NOLOCK) ON ac_amod_id = amod_id"
            query = query & " INNER JOIN Journal WITH(NOLOCK) ON ac_journ_id = journ_id"
            query = query & " INNER JOIN company WITH(NOLOCK) ON adoc_infavor_comp_id = comp_id and comp_journ_id = 0"
            query = query & " LEFT OUTER JOIN Financial_Institution_Company_Reference WITH(NOLOCK) ON ficr_sub_comp_id = adoc_infavor_comp_id"
            query = query & " LEFT OUTER JOIN Financial_Institution_Primary_Group WITH(NOLOCK) ON fipg_main_comp_id = ficr_main_comp_id"


            query = query & " WHERE (adoc_doc_date >= '" & Month(DateAdd("m", (-1) * num_months, Now)) & "/01/" & Year(DateAdd("m", (-1) * num_months, Now)) & "')"
            query = query & " AND (adoc_doc_date < '" & Month(Now) & "/01/" & Year(Now) & "')"


            If Trim(airframe_type) <> "" Then
                query = query & " AND amod_type_code = '" & Trim(airframe_type) & "'"
            End If

            If product_codes.ToString.Trim <> "" Then
                If product_codes.ToString.Trim = "B" Then
                    query = query & " and ac_product_business_flag = 'Y' "
                ElseIf product_codes.ToString.Trim = "H" Then
                    query = query & " and ac_product_helicopter_flag = 'Y' "
                ElseIf product_codes.ToString.Trim = "C" Then
                    query = query & " and ac_product_commercial_flag = 'Y' "
                End If
            End If


            '  query = query & commonEVO.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, True)
            query = query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, True)


            If Trim(make_name) <> "" Then
                query = query & " AND amod_make_name = '" & make_name & "' "
            ElseIf amod_id > 0 Then
                query = query & " AND amod_id = " & amod_id
            Else
                'Select Case CLng(airframe_type)
                '    Case 1
                '        query = query & " AND amod_airframe_type_code='F' AND amod_type_code = 'E'"
                '    Case 2
                '        query = query & " AND amod_airframe_type_code='F' AND amod_type_code = 'J'"
                '    Case 3
                '        query = query & " AND amod_airframe_type_code='F' AND amod_type_code = 'T'"
                '    Case 4
                '        query = query & " AND amod_airframe_type_code='F' AND amod_type_code = 'P'"
                '    Case 5
                '        query = query & " AND amod_airframe_type_code='R' AND amod_type_code in ('T','P')"
                'End Select
            End If

            query = query & " GROUP BY fipg_generic_name, fipg_main_comp_id"
            query = query & " ORDER BY tcount DESC"

            If Session("debug") Then
                Response.Write("<b>display_top_financial_institutions:" & Server.HtmlEncode(query) & "</b><br /><br />")
            End If


            'Select Case Application.Item("webHostObject").evoWebHostType
            'Case eWebSiteTypes.LOCAL
            'SqlConn.ConnectionString = My.Settings.DEFAULT_LOCAL_MSSQL
            'Case Else
            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            'End Select

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = query
            adoRs = SqlCommand.ExecuteReader()


            If adoRs.HasRows Then
                Do While adoRs.Read

                    If number_to_cut_at = 30 Then
                        outstring = outstring & Build_PDF_Template_Footer()
                        outstring = outstring & Insert_Page_Break_PDF()
                        outstring = outstring & Build_PDF_Header_Final("Financial Report", sub_info, make_model_or_make_for_title, real_company_name, sub_type, "", "", "", True)
                        outstring = outstring & Replace(first_outstring, "TOTALCOUNTER", "Continued")


                        number_to_cut_at = 0
                    End If


                    If CLng(adoRs("tcount")) > 0 Then
                        If adoRs("fipg_generic_name") = "Misc. Institutions" Then
                            outstring = outstring & "<tr><td valign='top' align='left' class='seperator'>" & adoRs("fipg_generic_name") & "</td>"
                        Else
                            outstring = outstring & "<tr><td valign='top' align='left' class='seperator'>" & Trim(adoRs("fipg_generic_name")) & "</td>"
                        End If

                        outstring = outstring & "<td valign='top' align='right' class='seperator'>" & FormatNumber(adoRs("tcount"), 0) & "&nbsp;&nbsp;</td></tr>"
                    End If
                    total_count = total_count + 1
                    number_to_cut_at = number_to_cut_at + 1
                Loop


            Else
                outstring = outstring & "<tr><td valign='top' align='left' class='seperator'>No data matches for your search criteria</td></tr>"
            End If


            outstring = outstring & "</table></p></div></td></tr></table></td></tr></table></td>"

            first_outstring = Replace(first_outstring, "TOTALCOUNTER", total_count.ToString)

            display_top_financial_institutions = Trim(first_outstring) & Trim(outstring)
        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function
    Function display_transaction_documents(ByVal model_id As Integer, ByVal table_height As Integer, ByVal city As String, ByVal country As String, ByVal in_HeaderText As String, ByVal comp_id As Integer, ByVal real_make_model_name As String, ByVal months_count As Integer, ByVal sub_info As String, ByVal real_company_name As String, ByVal sub_type As String, ByVal make_name As String, ByVal make_model_or_make_for_title As String, ByVal product_codes As String, ByVal airframe_type As String)
        display_transaction_documents = ""
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim adoRs As System.Data.SqlClient.SqlDataReader : adoRs = Nothing
        Dim query As String = ""
        Dim outstring As String = ""
        Dim total_counter As Integer = 0
        Dim QUOTE As String = "&quot;"
        Dim sTmpStr As String = ""
        Dim first_output_section As String = ""
        Dim break_counter As Integer = 0
        Dim temp_first As String = ""
        Dim cut_spot_for_page_break As Integer = 15
        Dim display_for_date_range As String = ""
        Try
            display_for_date_range = "From: " & Month(DateAdd("m", (-1) * months_count, Now)) & "/01/" & Year(DateAdd("m", (-1) * months_count, Now)) & " Up to: " & Month(Now) & "/01/" & Year(Now)


            first_output_section = "<table id='displayTransactionDocumentsOuterTable' width='100%'  cellpadding='1' cellspacing='0' class='module'>"
            first_output_section = first_output_section & "<tr><td valign='top' align='left' class='header' style='padding-left:3px;'>LATEST FINANCIAL DOCUMENTS (TOTALCOUNTER)</td></tr>"
            first_output_section = first_output_section & "<tr><td valign='top' align='left'><table id='displayTransactionDocumentsInnerTable' width='100%' cellpadding='1' cellspacing='0' >"
            temp_first = first_output_section

            If model_id > 0 Or country <> "" Then
                cut_spot_for_page_break = 10
                first_output_section = first_output_section & "<tr><td valign='top' align='left' class='tabheader'><strong>" & real_make_model_name
                first_output_section = first_output_section & "<br>" & display_for_date_range & "<br>" & in_HeaderText & "</strong></td><td class='border_bottom' width='20%'>&nbsp;</td></tr>"
            ElseIf make_name <> "" Then
                cut_spot_for_page_break = 10
                first_output_section = first_output_section & "<tr><td valign='top' align='left' class='tabheader'><strong>"
                If amod_id > 0 Then
                    first_output_section = first_output_section & real_make_model_name
                ElseIf Trim(make_name) <> "" Then
                    first_output_section = first_output_section & make_name.ToString.ToUpper
                Else
                    first_output_section = first_output_section & "ALL MAKES/MODELS"
                End If
                first_output_section = first_output_section & "<br>TOTALCOUNTER Most Recent Financial Documents<br>" & in_HeaderText & "</strong></td><td class='border_bottom' width='20%'>&nbsp;</td></tr>"
            Else
                cut_spot_for_page_break = 10
                first_output_section = first_output_section & "<tr><td valign='top' align='left' class='tabheader'><strong>"
                If amod_id > 0 Then
                    first_output_section = first_output_section & real_make_model_name
                ElseIf Trim(make_name) <> "" Then
                    first_output_section = first_output_section & make_name.ToString.ToUpper
                Else
                    first_output_section = first_output_section & "ALL MAKES/MODELS"
                End If
                first_output_section = first_output_section & "<br>50 Most Recent Financial Documents<br>" & in_HeaderText & "</strong></td><td class='border_bottom' width='20%'>&nbsp;</td></tr>"
            End If



            first_output_section = first_output_section & "<tr><td colspan='2' class='rightside'>"
            first_output_section = first_output_section & "<table id='displayTransactionDocumentsDataTable' width='100%' cellpadding='4' cellspacing='0'>"


            If model_id > 0 Or country <> "" Then
                query = "SELECT adoc_doc_date, adoc_doc_type, adoc_journ_id AS journ_id, adoc_journ_seq_no, journ_subject, journ_date, amod_make_name, amod_model_name, ac_id, ac_ser_no_full, ac_reg_no, comp_name, comp_city, comp_state, comp_id"
            ElseIf airframe_type <> "" Then
                cut_spot_for_page_break = 15
                query = "SELECT TOP 50 adoc_doc_date, adoc_doc_type, adoc_journ_id AS journ_id, adoc_journ_seq_no, journ_subject, journ_date, amod_make_name, amod_model_name, ac_id, ac_ser_no_full, ac_reg_no, comp_name, comp_city, comp_state, comp_id"
            Else
                cut_spot_for_page_break = 17
                query = "SELECT TOP 50 adoc_doc_date, adoc_doc_type, adoc_journ_id AS journ_id, adoc_journ_seq_no, journ_subject, journ_date, amod_make_name, amod_model_name, ac_id, ac_ser_no_full, ac_reg_no, comp_name, comp_city, comp_state, comp_id"
            End If

            query = query & " FROM Aircraft_Document WITH(NOLOCK)"
            query = query & " INNER JOIN Aircraft WITH(NOLOCK) ON ac_id = adoc_ac_id AND ac_journ_id = adoc_journ_id"
            query = query & " INNER JOIN Aircraft_Model WITH(NOLOCK) ON ac_amod_id = amod_id"
            query = query & " INNER JOIN Journal WITH(NOLOCK) ON ac_journ_id = journ_id"

            query = query & " LEFT OUTER JOIN Financial_Institution_Company_Reference WITH(NOLOCK) ON ficr_sub_comp_id = adoc_infavor_comp_id"
            query = query & " LEFT OUTER JOIN Financial_Institution_Primary_Group WITH(NOLOCK) ON fipg_main_comp_id = ficr_main_comp_id"
            query = query & " INNER JOIN company WITH(NOLOCK) ON adoc_infavor_comp_id = comp_id and comp_journ_id = 0"
            '     query = query & " WHERE (adoc_doc_date >= '"

            '    query = query & DateAdd(DateInterval.Month, -months_count, DateTime.Now) & " ')"

            '   query = query & "  AND (adoc_doc_date < '" & DateTime.Now & "')"

            query = query & " WHERE (adoc_doc_date >= '" & Month(DateAdd("m", (-1) * months_count, Now)) & "/01/" & Year(DateAdd("m", (-1) * months_count, Now)) & "')"
            query = query & " AND (adoc_doc_date < '" & Month(Now) & "/01/" & Year(Now) & "')"



            If Trim(airframe_type) <> "" Then
                query = query & " AND amod_type_code = '" & Trim(airframe_type) & "'"
            End If

            If product_codes.ToString.Trim <> "" Then
                If product_codes.ToString.Trim = "B" Then
                    query = query & " and ac_product_business_flag = 'Y' "
                ElseIf product_codes.ToString.Trim = "H" Then
                    query = query & " and ac_product_helicopter_flag = 'Y' "
                ElseIf product_codes.ToString.Trim = "C" Then
                    query = query & " and ac_product_commercial_flag = 'Y' "
                End If
            End If


            ' query = query & commonEVO.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, True)
            query = query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, True)


            ' updated from fipg_main_comp_id
            If CLng(comp_id) > 0 Then
                query = query & " AND ficr_main_comp_id = " & comp_id
            End If

            If Trim(make_name) <> "" Then
                query = query & " AND amod_make_name = '" & make_name & "' "
            ElseIf CLng(model_id) > 0 Then
                query = query & "AND amod_id = " & Trim(model_id)
            End If

            query = query & " ORDER BY adoc_doc_date desc"

            If Session("debug") Then
                Response.Write("<b>display_transaction_documents:" & Server.HtmlEncode(query) & "</b><br /><br />")
            End If

            'Select Case Application.Item("webHostObject").evoWebHostType
            'Case eWebSiteTypes.LOCAL
            'SqlConn.ConnectionString = My.Settings.DEFAULT_LOCAL_MSSQL
            '  Case Else
            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            ' End Select

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = query
            adoRs = SqlCommand.ExecuteReader()





            If adoRs.HasRows Then
                Do While adoRs.Read

                    If break_counter = cut_spot_for_page_break Then
                        outstring = outstring & Build_PDF_Template_Footer()
                        outstring = outstring & Build_PDF_Template_Footer()
                        outstring = outstring & Insert_Page_Break_PDF()
                        outstring = outstring & Build_PDF_Header_Final("Financial Report", sub_info, make_model_or_make_for_title, real_company_name, sub_type, "", "", "", True)
                        temp_first = Replace(temp_first, "TOTALCOUNTER", "Continued")
                        outstring = outstring & temp_first
                        outstring = outstring & "<tr><td valign='top' align='left' class='tabheader'><strong>Most Recent Financial Documents (Continued)</strong></td><td class='border_bottom' width='20%'>&nbsp;</td></tr>"

                        outstring = outstring & "<tr valign='top'><td valign='top'  colspan='2'> "
                        outstring = outstring & " <table  valign='top' width='100%' cellpadding='4' cellspacing='0'>"

                        break_counter = 0
                    End If


                    outstring = outstring & "<tr><td valign='top' align='left'></td>" ' & f_displayTransactionDocuments(adoRs("ac_id"), adoRs("journ_id"), adoRs("adoc_journ_seq_no"), False, False, False, True) & "</td>"
                    outstring = outstring & "<td valign='top' align='left' class='seperator'><em>" & adoRs("adoc_doc_date") & "</em>, " & adoRs("adoc_doc_type") & sTmpStr & " in favor of " & adoRs("comp_name") & ", " & adoRs("amod_make_name") & "&nbsp;" & adoRs("amod_model_name") & " Ser# " & adoRs("ac_ser_no_full") & " Reg# " & adoRs("ac_reg_no")
                    outstring = outstring & "," & adoRs("journ_subject") & " on " & FormatDateTime(adoRs("journ_date"), vbShortDate) & "</td></tr>"
                    total_counter = total_counter + 1
                    break_counter = break_counter + 1
                Loop
            Else
                outstring = outstring & "<tr><td valign='top' align='left' class='seperator'>No data matches for your search criteria.</td></tr>"
            End If

            outstring = outstring & "</table></p></div></td></tr></table></td></tr></table></td>"


            first_output_section = Replace(first_output_section, "TOTALCOUNTER", total_counter.ToString)


            display_transaction_documents = Trim(first_output_section) & Trim(outstring)
        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function


    Function GetFleetInfo(ByVal inModelID As Long, ByVal bIsAcContactTypeView As Boolean, ByRef searchCriteria As viewSelectionCriteriaClass)

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim fleetinfo As System.Data.SqlClient.SqlDataReader : fleetinfo = Nothing
        Dim fs_total As Long = 0
        Dim fs_w_asking As Long = 0
        Dim aftt_count As Long = 0
        Dim mfr_count_fs As Long = 0
        Dim aftt_count_fs As Long = 0


        Try
            'Select Case Application.Item("webHostObject").evoWebHostType
            'Case eWebSiteTypes.LOCAL
            'SqlConn.ConnectionString = My.Settings.DEFAULT_LOCAL_MSSQL
            'Case Else
            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            'End Select

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            Dim num, count, i, Query

            num = True
            count = 0

            If Not bIsAcContactTypeView Then
                Query = "SELECT ac_id, ac_ownership_type, ac_lifecycle_stage, ac_forsale_flag, ac_exclusive_flag, ac_mfr_year, "
                Query = Query & " ac_lease_flag, ac_asking, ac_asking_price, ac_list_date, ac_mfr_year, datediff(day, ac_list_date, getdate()) AS daysonmarket, ac_airframe_tot_Hrs, ac_country_of_registration"

                If inModelID = 0 And Trim(searchCriteria.ViewCriteriaAircraftModel.ToString) <> "" Then
                    Query = Query & " FROM Aircraft_Flat WITH(NOLOCK) WHERE  amod_id in ( " & searchCriteria.ViewCriteriaAircraftModel.ToString & ") AND ac_journ_id = 0"
                Else
                    Query = Query & " FROM Aircraft_Flat WITH(NOLOCK) WHERE  amod_id = " & inModelID & " AND ac_journ_id = 0"
                End If
            Else
                Query = "SELECT ac_id, ac_ownership_type, ac_lifecycle_stage, ac_forsale_flag, ac_exclusive_flag, ac_mfr_year, "
                Query = Query & " ac_lease_flag, ac_asking, ac_asking_price, ac_list_date, ac_mfr_year, datediff(day, ac_list_date, getdate()) AS daysonmarket, ac_airframe_tot_Hrs, ac_country_of_registration"

                If inModelID = 0 And Trim(searchCriteria.ViewCriteriaAircraftModel.ToString) <> "" Then
                    Query = Query & " FROM Aircraft_Flat WITH(NOLOCK) WHERE ac_amod_id in " & searchCriteria.ViewCriteriaAircraftModel.ToString & ") AND ac_journ_id = 0"
                Else
                    Query = Query & " FROM Aircraft_Flat WITH(NOLOCK) WHERE ac_amod_id = " & inModelID & " AND ac_journ_id = 0"
                End If

                Query = Query & " AND EXISTS (SELECT NULL FROM aircraft_reference WITH(NOLOCK)"
                Query = Query & " WHERE cref_ac_id = ac_id AND cref_journ_id = ac_journ_id"
                Query = Query & " AND (cref_contact_type IN ('94','33') OR cref_business_type = 'CH'))"
            End If

            If Not IsNothing(searchCriteria) Then
                If searchCriteria.ViewCriteriaAFTTStart > 0 Then
                    Query = Query & (Constants.cAndClause + " ((ac_airframe_tot_hrs >= " & searchCriteria.ViewCriteriaAFTTStart & ") or (ac_airframe_tot_hrs IS NULL))")
                End If

                If searchCriteria.ViewCriteriaAFTTEnd > 0 Then
                    Query = Query & (Constants.cAndClause + " ((ac_airframe_tot_hrs <= " & searchCriteria.ViewCriteriaAFTTEnd & ") or (ac_airframe_tot_hrs IS NULL))")
                End If


                If searchCriteria.ViewCriteriaYearStart > 0 Then
                    Query = Query & (Constants.cAndClause + " ac_mfr_year >= " & searchCriteria.ViewCriteriaYearStart)
                End If

                If searchCriteria.ViewCriteriaYearEnd > 0 Then
                    Query = Query & (Constants.cAndClause + " ac_mfr_year <=  " & searchCriteria.ViewCriteriaYearEnd)
                End If
            End If


            'If afttFilter Then
            '  'Only if filtered
            '  If IsNumeric(aftt_start.Text) Then
            '    If IsNumeric(aftt_end.Text) Then
            '      If aftt_start.Text = 0 And aftt_end.Text = 0 Then
            '      Else
            '        If aftt_start.Text = 0 Then
            '          Query += " and ((ac_airframe_tot_hrs between " & aftt_start.Text & " and " & aftt_end.Text & ") or (ac_airframe_tot_hrs is NULL))"
            '        Else
            '          Query += " and ac_airframe_tot_hrs between " & aftt_start.Text & " and " & aftt_end.Text
            '        End If
            '      End If
            '    End If
            '  End If
            'End If

            'If yearFilter Then
            '  'only if filtered
            '  If IsNumeric(year_start.Text) Then
            '    If IsNumeric(year_end.Text) Then
            '      If Trim(year_start.Text) <> "" Or Trim(year_end.Text) <> "" Then
            '        Query += " and ac_mfr_year between " & year_start.Text & " and " & year_end.Text
            '      End If
            '    End If
            '  End If
            'End If

            localCriteria.ViewCriteriaProductType = -1

            If Not localCriteria.ViewCriteriaHasHelicopterFlag And Not localCriteria.ViewCriteriaHasBusinessFlag And Not localCriteria.ViewCriteriaHasCommercialFlag And localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_NONE Then
                localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_ALL ' use subscribers product code(s) for queries
            ElseIf localCriteria.ViewCriteriaHasHelicopterFlag And localCriteria.ViewCriteriaHasBusinessFlag And localCriteria.ViewCriteriaHasCommercialFlag And localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_NONE Then
                localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_ALL ' use subscribers product code(s) for queries
            End If

            If localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_ALL Then
                Query = Query & "  " + commonEvo.GenerateProductCodeSelectionQuery(HttpContext.Current.Session.Item("localPreferences"), False, True)
            Else
                Query = Query & "  " + commonEvo.BuildProductCodeCheckWhereClause(localCriteria.ViewCriteriaHasHelicopterFlag, localCriteria.ViewCriteriaHasBusinessFlag, localCriteria.ViewCriteriaHasCommercialFlag, False, False, False, False)
            End If




            SqlCommand.Connection = SqlConn
            SqlCommand.CommandTimeout = 1000
            SqlCommand.CommandText = Query

            fleetinfo = SqlCommand.ExecuteReader()


            If fleetinfo.HasRows Then
                Dim readOnce As Boolean = False
                mfr_avg_fs = 0
                mfr_count_fs = 0

                avgyear = 0
                totalcount = 0
                totalInOpcount = 0
                ac_for_sale = 0
                ac_exclusive_sale = 0
                ac_lease = 0
                w_owner = 0
                s_owner = 0
                f_owner = 0
                o_stage = 0
                t_stage = 0
                th_stage = 0
                f_stage = 0
                us_reg = 0
                daysonmarket = 0
                daysonmarket2 = 0
                forsaleavghigh = 0
                days = 0
                forsaleavlow = "199999999999999999999999999999999999999999999999999999"
                Do While fleetinfo.Read()
                    If readOnce = False Then
                        If Not IsDBNull(fleetinfo.Item("ac_mfr_year")) Then
                            If IsNumeric(fleetinfo.Item("ac_mfr_year")) Then
                                allhigh = CInt(fleetinfo.Item("ac_mfr_year"))
                                alllow = CInt(fleetinfo.Item("ac_mfr_year"))
                            End If
                        Else
                            allhigh = 0
                            alllow = CInt(Year(Now()))
                        End If
                        readOnce = True

                        If Not IsDBNull(fleetinfo.Item("ac_airframe_tot_Hrs")) Then
                            If IsNumeric(fleetinfo.Item("ac_airframe_tot_Hrs")) Then
                                aftt_high = CInt(fleetinfo.Item("ac_airframe_tot_Hrs"))
                                aftt_low = CInt(fleetinfo.Item("ac_airframe_tot_Hrs"))
                            End If
                        Else
                            aftt_high = 0
                            aftt_low = 500000
                        End If
                    End If

                    If Not IsDBNull(fleetinfo.Item("daysonmarket")) Then
                        If CLng(fleetinfo.Item("daysonmarket")) > 0 Then
                            daysonmarket = daysonmarket + 1
                            daysonmarket2 = daysonmarket2 + CLng(fleetinfo("daysonmarket"))

                            If CInt(fleetinfo.Item("daysonmarket")) > CInt(highdays) Then
                                highdays = CInt(fleetinfo.Item("daysonmarket"))
                            End If

                            If CInt(fleetinfo.Item("daysonmarket")) < CInt(lowdays) Then
                                lowdays = CInt(fleetinfo.Item("daysonmarket"))
                            End If
                        End If
                    End If

                    If fleetinfo.Item("ac_lifecycle_stage") = "3" Then
                        If Not IsDBNull(fleetinfo.Item("ac_country_of_registration")) Then
                            If Trim(fleetinfo.Item("ac_country_of_registration")) = "United States" Then
                                us_reg = us_reg + 1
                            End If
                        End If
                    End If

                    If Not IsDBNull(fleetinfo.Item("ac_mfr_year")) Then
                        If IsNumeric(fleetinfo.Item("ac_mfr_year")) Then

                            If CInt(fleetinfo.Item("ac_mfr_year")) > CInt(allhigh) Then
                                allhigh = CInt(fleetinfo.Item("ac_mfr_year"))
                            End If

                            If CInt(fleetinfo.Item("ac_mfr_year")) < CInt(alllow) Then
                                alllow = CInt(fleetinfo.Item("ac_mfr_year"))
                            End If

                        End If
                    End If


                    If Not IsDBNull(fleetinfo.Item("ac_airframe_tot_Hrs")) Then
                        If IsNumeric(fleetinfo.Item("ac_airframe_tot_Hrs")) Then

                            If CInt(fleetinfo.Item("ac_airframe_tot_Hrs")) > CInt(aftt_high) Then
                                aftt_high = CInt(fleetinfo.Item("ac_airframe_tot_Hrs"))
                            End If

                            If CInt(fleetinfo.Item("ac_airframe_tot_Hrs")) < CInt(aftt_low) Then
                                aftt_low = CInt(fleetinfo.Item("ac_airframe_tot_Hrs"))
                            End If
                        End If
                    End If

                    If fleetinfo.Item("ac_forsale_flag") = "Y" Then
                        If Not IsDBNull(fleetinfo.Item("ac_mfr_year")) Then
                            If IsNumeric(fleetinfo.Item("ac_mfr_year")) Then

                                If CInt(fleetinfo.Item("ac_mfr_year")) > CInt(mfr_high_fs) Then
                                    mfr_high_fs = CInt(fleetinfo.Item("ac_mfr_year"))
                                End If

                                If CInt(fleetinfo.Item("ac_mfr_year")) < CInt(mfr_low_fs) Then
                                    mfr_low_fs = CInt(fleetinfo.Item("ac_mfr_year"))
                                End If

                                mfr_avg_fs = mfr_avg_fs + CInt(fleetinfo.Item("ac_mfr_year"))
                                mfr_count_fs = mfr_count_fs + 1
                            End If
                        End If

                        If Not IsDBNull(fleetinfo.Item("ac_airframe_tot_Hrs")) Then
                            If IsNumeric(fleetinfo.Item("ac_airframe_tot_Hrs")) Then

                                If CInt(fleetinfo.Item("ac_airframe_tot_Hrs")) > CInt(aftt_high_fs) Then
                                    aftt_high_fs = CInt(fleetinfo.Item("ac_airframe_tot_Hrs"))
                                End If

                                If CInt(fleetinfo.Item("ac_airframe_tot_Hrs")) < CInt(aftt_low_fs) Then
                                    aftt_low_fs = CInt(fleetinfo.Item("ac_airframe_tot_Hrs"))
                                End If

                                aftt_avg_fs = aftt_avg_fs + CInt(fleetinfo.Item("ac_airframe_tot_Hrs"))
                                aftt_count_fs = aftt_count_fs + 1
                            End If
                        End If
                    End If

                    totalcount = totalcount + 1

                    If fleetinfo.Item("ac_lifecycle_stage") = "3" And
                      (fleetinfo.Item("ac_ownership_type") = "S" Or fleetinfo.Item("ac_ownership_type") = "F" Or fleetinfo.Item("ac_ownership_type") = "W") Then
                        totalInOpcount = totalInOpcount + 1
                    End If

                    If fleetinfo.Item("ac_ownership_type") = "W" And fleetinfo.Item("ac_lifecycle_stage") = "3" Then
                        w_owner = w_owner + 1
                    End If

                    If fleetinfo.Item("ac_ownership_type") = "F" And fleetinfo.Item("ac_lifecycle_stage") = "3" Then
                        f_owner = f_owner + 1
                    End If

                    If fleetinfo.Item("ac_ownership_type") = "S" And fleetinfo.Item("ac_lifecycle_stage") = "3" Then
                        s_owner = s_owner + 1
                    End If

                    If fleetinfo.Item("ac_lifecycle_stage") = "1" Then
                        o_stage = o_stage + 1
                    End If

                    If fleetinfo.Item("ac_lifecycle_stage") = "2" Then
                        t_stage = t_stage + 1
                    End If

                    If fleetinfo.Item("ac_lifecycle_stage") = "3" And
                      (fleetinfo.Item("ac_ownership_type") = "S" Or fleetinfo.Item("ac_ownership_type") = "F" Or fleetinfo.Item("ac_ownership_type") = "W") Then
                        th_stage = th_stage + 1
                    End If

                    If fleetinfo.Item("ac_lifecycle_stage") = "4" Then
                        f_stage = f_stage + 1
                    End If

                    If fleetinfo.Item("ac_forsale_flag") = "Y" Then
                        ac_for_sale = ac_for_sale + 1

                        If Not IsDBNull(fleetinfo.Item("ac_asking_price")) Then


                            If CStr(fleetinfo.Item("ac_asking_price")) <> "" Then

                                If CDbl(fleetinfo.Item("ac_asking_price")) > CDbl(forsaleavghigh) Then
                                    forsaleavghigh = fleetinfo.Item("ac_asking_price")
                                End If

                                If CDbl(fleetinfo.Item("ac_asking_price")) < CDbl(forsaleavlow) Then
                                    forsaleavlow = fleetinfo.Item("ac_asking_price")
                                    num = False
                                End If

                                fs_total = fs_total + fleetinfo.Item("ac_asking_price")
                                fs_w_asking = fs_w_asking + 1

                            End If
                        End If
                    End If

                    If fleetinfo.Item("ac_exclusive_flag") = "Y" Then
                        ac_exclusive_sale = ac_exclusive_sale + 1
                    End If

                    If Not IsDBNull(fleetinfo.Item("ac_lease_flag")) Then
                        If fleetinfo.Item("ac_lease_flag") = "Y" Then
                            ac_lease = ac_lease + 1
                        End If
                    End If
                    'fleetinfo.Item.moveNext()
                Loop

                If fs_w_asking > 0 Then
                    forsaleavg = (fs_total / fs_w_asking)
                    forsaleavg = (CLng(forsaleavg) / 1000)
                    forsaleavg = FormatCurrency(CLng(forsaleavg), 0)
                    forsaleavg = forsaleavg & "k"
                End If
                fleetinfo.Close()

                If num = True Then
                    forsaleavlow = forsaleavghigh
                End If

                If aftt_avg_fs > 0 Then
                    aftt_avg_fs = CInt(aftt_avg_fs / aftt_count_fs)
                End If

                If (forsaleavlow > 0) Then
                    forsaleavlow = CDbl(forsaleavlow / 1000)
                    forsaleavlow = FormatCurrency(forsaleavlow, 0)
                    forsaleavlow = forsaleavlow & "k"
                End If

                If (forsaleavghigh > 0) Then
                    forsaleavghigh = CDbl(forsaleavghigh / 1000)
                    forsaleavghigh = FormatCurrency(forsaleavghigh, 0)
                    forsaleavghigh = forsaleavghigh & "k"
                End If

                If (ac_for_sale > 0 And th_stage > 0) Then

                    per = System.Math.Round(CDbl(ac_for_sale / th_stage * 100), 1)
                    ' per2 = System.Math.Round(CDbl(ac_exclusive_sale / ac_for_sale * 100))
                    per2 = ac_exclusive_sale / ac_for_sale * 100
                    per3 = System.Math.Round(CDbl(ac_lease / th_stage * 100), 1)

                    If daysonmarket > 0 Then
                        days = System.Math.Round(CLng(daysonmarket2) / CLng(daysonmarket))
                    Else
                        days = System.Math.Round(CLng(daysonmarket2))
                    End If

                End If

                If (alllow >= 0 And allhigh > 0) Then
                    For i = alllow To allhigh
                        avgyear = avgyear + i
                        count = count + 1
                    Next
                End If

                If avgyear > 0 And count > 0 Then
                    avgyear = CLng(avgyear / count)
                    avgyear = FormatNumber(avgyear, 0, False, True, False)
                End If

                If mfr_avg_fs > 0 Then
                    mfr_avg_fs = CInt(mfr_avg_fs / mfr_count_fs)
                End If

                'Response.write " ALLHIGH:" & allhigh
                'Response.write " ALLLOW:" & alllow
                'Response.write " FORSALEAVLOW:" & forsaleavlow
                'Response.write " FORSALEAVGHIGH:" & forsaleavghigh
                'Response.write " AVGMFRYEAR:" & avgyear
                'Response.write " COUNT:" & count
                total_in_op = totalInOpcount
                in_op_count = ((ac_for_sale / totalInOpcount) * 100)

            End If

            fleetinfo = Nothing
            GetFleetInfo = Nothing
        Catch ex As Exception
            GetFleetInfo = Nothing
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Build_FleetMarketSummary: " & ex.Message
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function
    Public Function Build_PerformanceSpecifications(ByVal bisReport As Boolean, ByVal optFormat As String, ByVal bHasManyAirFrames As Boolean, ByVal sAirframeType As String, ByRef foot_space_Performance_Specs As String, ByVal amod_id As Integer) As String
        Build_PerformanceSpecifications = ""

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim l_AdoRs As System.Data.SqlClient.SqlDataReader : l_AdoRs = Nothing
        Dim bIsFirstTime As Boolean = True
        Dim Query As String : Query = ""
        Try
            'Select Case Application.Item("webHostObject").evoWebHostType
            'Case eWebSiteTypes.LOCAL
            'SqlConn.ConnectionString = My.Settings.DEFAULT_LOCAL_MSSQL
            'Case Else
            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            ' End Select

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            Query = "SELECT * FROM Aircraft_Model WITH(NOLOCK) WHERE amod_id = " + amod_id.ToString



            If Not localCriteria.ViewCriteriaHasHelicopterFlag And Not localCriteria.ViewCriteriaHasBusinessFlag And Not localCriteria.ViewCriteriaHasCommercialFlag And localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_NONE Then
                localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_ALL ' use subscribers product code(s) for queries
            ElseIf localCriteria.ViewCriteriaHasHelicopterFlag And localCriteria.ViewCriteriaHasBusinessFlag And localCriteria.ViewCriteriaHasCommercialFlag And localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_NONE Then
                localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_ALL ' use subscribers product code(s) for queries
            End If

            If localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_ALL Then
                Query = Query & "  " + commonEvo.GenerateProductCodeSelectionQuery(HttpContext.Current.Session.Item("localPreferences"), False, True)
            Else
                Query = Query & "  " + commonEvo.BuildProductCodeCheckWhereClause(localCriteria.ViewCriteriaHasHelicopterFlag, localCriteria.ViewCriteriaHasBusinessFlag, localCriteria.ViewCriteriaHasCommercialFlag, False, False, False, True)
            End If






            SqlCommand.CommandText = Query

            Dim l_objBuilder As New StringBuilder
            Dim nNumberOfEngines As Integer = 0
            Dim nRememberModelID As Long = 0
            Dim nMAXEngines As Long = 0

            l_AdoRs = SqlCommand.ExecuteReader()
            Dim iLoop
            iLoop = 0
            l_AdoRs.Read()
            Build_PerformanceSpecifications = ""
            If CInt(l_AdoRs.Item("amod_id")) <> CInt(nRememberModelID) Then
                nNumberOfEngines = l_AdoRs.Item("amod_number_of_engines")
            End If
            If nMAXEngines < nNumberOfEngines Then
                nMAXEngines = nNumberOfEngines
            End If

            If Trim(l_AdoRs.Item("amod_airframe_type_code")) <> "" Then
                sAirframeType = l_AdoRs.Item("amod_airframe_type_code")
            Else
                sAirframeType = "F"
            End If


            If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                l_objBuilder.Append("<table align='center' cellpadding='2' cellspacing='0' width='" & word_width & "'>" & vbCrLf)
            Else
                l_objBuilder.Append("<table align='center' cellpadding='2' cellspacing='0' width='95%'>" & vbCrLf)
            End If



            ' tr start for Logo
            l_objBuilder.Append("<tr id='trInner_Content_AC_PIC' align='center' colspan='5'>" & vbCrLf)
            If Me.logo_check.Checked = True Then
                l_objBuilder.Append(get_company_images(real_make_model_name))
            Else
                l_objBuilder.Append("<td  id='tdInner_Content_AC_PIC' align='center' colspan='5'><img src='" & location_string & "images/marketpdfheader.jpg' />" & vbCrLf)
            End If



            ' get the AC pic

            l_objBuilder.Append("</td>")
            l_objBuilder.Append("</tr>")

            l_objBuilder.Append("<tr><td align='center' colspan='5'><strong>" & real_make_model_name & "&nbsp;Performance Specifications</strong></td></tr><tr>" & vbCrLf)


            For x As Integer = 0 To 1


                If bIsFirstTime Then
                    bIsFirstTime = False
                    'l_objBuilder.Append("<tr><th nowrap Colspan='5'>MODEL&nbsp;NAME</th></tr>" & vbCrLf)
                    l_objBuilder.Append("<td valign='top' align='left' class='Performance_Specs_Left_TD_1'>" & vbCrLf)

                    If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                        l_objBuilder.Append("<table cellpadding='2' cellspacing='0' width='" & word_1_4 & "'>" & vbCrLf)
                    Else
                        l_objBuilder.Append("<table cellpadding='2' cellspacing='0'>" & vbCrLf)
                    End If


                    l_objBuilder.Append("<tr><td nowrap><strong>Fuselage&nbsp;Dimensions</strong></td></tr><tr>" & vbCrLf)

                    If Session.Item("useMetricValues") Then
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Length (" & TranslateUSMetricUnitsShort("FT") & "):</td></tr><tr>" & vbCrLf)
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Height (" & TranslateUSMetricUnitsShort("FT") & "):</td></tr><tr>" & vbCrLf)

                        If sAirframeType = "F" And Not bHasManyAirFrames Then
                            l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Wing Span (" & TranslateUSMetricUnitsShort("FT") & "):</td></tr>" & vbCrLf)
                        ElseIf sAirframeType = "R" And Not bHasManyAirFrames Then
                            l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Width (" & TranslateUSMetricUnitsShort("FT") & "):</td></tr>" & vbCrLf)
                        ElseIf (sAirframeType = "F" Or sAirframeType = "R") And bHasManyAirFrames Then
                            l_objBuilder.Append("<td class='Label' valign='middle' align='right'>[F] Wing Span (" & TranslateUSMetricUnitsShort("FT") & ") / [R] Width (" & TranslateUSMetricUnitsShort("FT") & "):</td></tr>" & vbCrLf)
                        End If
                    Else
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Length (ft):</td></tr><tr>" & vbCrLf)
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Height (ft):</td></tr>" & vbCrLf)

                        If sAirframeType = "F" And Not bHasManyAirFrames Then
                            l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'>Wing Span (ft):</td></tr>" & vbCrLf)
                        ElseIf sAirframeType = "R" And Not bHasManyAirFrames Then
                            l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'>Width (ft):</td></tr>" & vbCrLf)
                        ElseIf (sAirframeType = "F" Or sAirframeType = "R") And bHasManyAirFrames Then
                            l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'>[F] Wing Span (ft) / [R] Width (ft):</td></tr>" & vbCrLf)
                        End If
                    End If

                    l_objBuilder.Append("<tr><td nowrap><strong>Cabin&nbsp;Dimensions</strong></td></tr><tr>" & vbCrLf)

                    If Session.Item("useMetricValues") Then
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Length (" & TranslateUSMetricUnitsShort("FT") & "):</td></tr><tr>" & vbCrLf)
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Height (" & TranslateUSMetricUnitsShort("FT") & "):</td></tr><tr>" & vbCrLf)
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Width (" & TranslateUSMetricUnitsShort("FT") & "):</td></tr>" & vbCrLf)
                    Else
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Length (ft)(inches):</td></tr><tr>" & vbCrLf)
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Height (ft)(inches):</td></tr><tr>" & vbCrLf)
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Width (ft)(inches):</td></tr>" & vbCrLf)
                    End If

                    l_objBuilder.Append("<tr><td><strong>Typical&nbsp;Configuration</strong></td></tr><tr>" & vbCrLf)

                    l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Crew:</td></tr><tr>" & vbCrLf)
                    l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Passengers:</td></tr>" & vbCrLf)

                    If Session.Item("useMetricValues") Then
                        If sAirframeType = "F" And Not bHasManyAirFrames Then
                            l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'>Pressurization&nbsp;(" & TranslateUSMetricUnitsShort("PSI") & "):</td></tr>" & vbCrLf)
                        ElseIf sAirframeType = "R" And Not bHasManyAirFrames Then
                            ' do nothing
                        ElseIf (sAirframeType = "F" Or sAirframeType = "R") And bHasManyAirFrames Then
                            l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'>[F] Pressurization&nbsp;(" & TranslateUSMetricUnitsShort("PSI") & "):</td></tr>" & vbCrLf)
                        End If
                    Else
                        If sAirframeType = "F" And Not bHasManyAirFrames Then
                            l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'>Pressurization&nbsp;(psi):</td></tr>" & vbCrLf)
                        ElseIf sAirframeType = "R" And Not bHasManyAirFrames Then
                            ' do nothing
                        ElseIf (sAirframeType = "F" Or sAirframeType = "R") And bHasManyAirFrames Then
                            l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'>[F] Pressurization&nbsp;(psi):</td></tr>" & vbCrLf)
                        End If
                    End If

                    l_objBuilder.Append("<tr><td><strong>Fuel Capacity</strong></td></tr><tr>")

                    If Session.Item("useMetricValues") Then
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Standard&nbsp;(" & TranslateUSMetricUnitsShort("lbs") & "):</td></tr><tr>" & vbCrLf)
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Standard&nbsp;(" & TranslateUSMetricUnitsShort("gal") & "):</td></tr><tr>" & vbCrLf)
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Optional&nbsp;(" & TranslateUSMetricUnitsShort("lbs") & "):</td></tr><tr>" & vbCrLf)
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Optional&nbsp;(" & TranslateUSMetricUnitsShort("gal") & "):</td></tr>" & vbCrLf)
                    Else
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Standard&nbsp;(lbs):</td></tr><tr>" & vbCrLf)
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Standard&nbsp;(gal):</td></tr><tr>" & vbCrLf)
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Optional&nbsp;(lbs):</td></tr><tr>" & vbCrLf)
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Optional&nbsp;(gal):</td></tr>" & vbCrLf)
                    End If

                    l_objBuilder.Append("<tr><td><strong>Weight</strong></td></tr><tr>" & vbCrLf)

                    If Session.Item("useMetricValues") Then
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Max.&nbsp;Ramp&nbsp;(" & TranslateUSMetricUnitsShort("lbs") & "):</td></tr><tr>" & vbCrLf)
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Max.&nbsp;Takeoff&nbsp;(" & TranslateUSMetricUnitsShort("lbs") & "):</td></tr><tr>" & vbCrLf)

                        If sAirframeType = "F" And Not bHasManyAirFrames Then
                            l_objBuilder.Append("<td nowrap class='Label' valign='middle' align='right'>Zero&nbsp;Fuel&nbsp;(" & TranslateUSMetricUnitsShort("lbs") & "):</td></tr><tr>" & vbCrLf)
                        ElseIf sAirframeType = "R" And Not bHasManyAirFrames Then
                            l_objBuilder.Append("<td nowrap class='Label' valign='middle' align='right'>Empty&nbsp;Operating&nbsp;Weight&nbsp;(EOW):</td></tr><tr>" & vbCrLf)
                        ElseIf (sAirframeType = "F" Or sAirframeType = "R") And bHasManyAirFrames Then
                            l_objBuilder.Append("<td nowrap class='Label' valign='middle' align='right'>[F] Zero&nbsp;Fuel&nbsp;(" & TranslateUSMetricUnitsShort("lbs") & ") / [R] Empty&nbsp;Operating&nbsp;Weight&nbsp;(" & TranslateUSMetricUnitsShort("lbs") & "):</td></tr><tr>" & vbCrLf)
                        End If
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Basic&nbsp;Operating&nbsp;(" & TranslateUSMetricUnitsShort("lbs") & "):</td></tr><tr>" & vbCrLf)
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Max.&nbsp;Landing&nbsp;(" & TranslateUSMetricUnitsShort("lbs") & "):</td></tr>" & vbCrLf)
                    Else
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Max.&nbsp;Ramp&nbsp;(lbs):</td></tr><tr>" & vbCrLf)
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Max.&nbsp;Takeoff&nbsp;(lbs):</td></tr><tr>" & vbCrLf)

                        If sAirframeType = "F" And Not bHasManyAirFrames Then
                            l_objBuilder.Append("<td nowrap class='Label' valign='middle' align='right'>Zero&nbsp;Fuel&nbsp;(lbs):</td></tr><tr>" & vbCrLf)
                        ElseIf sAirframeType = "R" And Not bHasManyAirFrames Then
                            l_objBuilder.Append("<td nowrap class='Label' valign='middle' align='right'>Empty&nbsp;Operating&nbsp;Weight&nbsp;(EOW):</td></tr><tr>" & vbCrLf)
                        ElseIf (sAirframeType = "F" Or sAirframeType = "R") And bHasManyAirFrames Then
                            l_objBuilder.Append("<td nowrap class='Label' valign='middle' align='right'>[F] Zero&nbsp;Fuel&nbsp;(lbs) / [R] Empty&nbsp;Operating&nbsp;Weight&nbsp;(lbs):</td></tr><tr>" & vbCrLf)
                        End If
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Basic&nbsp;Operating&nbsp;(lbs):</td></tr><tr>" & vbCrLf)
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Max.&nbsp;Landing&nbsp;(lbs):</td></tr>" & vbCrLf)
                    End If
                    l_objBuilder.Append("</table></td>" & vbCrLf)



                    'Do While Not l_AdoRs.Read
                    l_objBuilder.Append("<td valign='top' align='left'  class='Performance_Specs_Left_TD_2'>" & vbCrLf)
                    l_objBuilder.Append("<table cellpadding='2' cellspacing='0'>" & vbCrLf)

                    '''''''''''''''''''''''''''''''''''''''''''''''''''
                    ' Start left side
                    '''''''''''''''''''''''''''''''''''''''''''''''''''
                    l_objBuilder.Append("<tr><td>&nbsp;</td></tr><tr>" & vbCrLf)

                    If Session.Item("useMetricValues") Then
                        l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(ConvertUSToMetricValue("FT", CDbl(l_AdoRs.Item("amod_fuselage_length"))), 1, False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                        l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(ConvertUSToMetricValue("FT", CDbl(l_AdoRs.Item("amod_fuselage_height"))), 1, False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)

                        If sAirframeType = "F" Then
                            l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(ConvertUSToMetricValue("FT", CDbl(l_AdoRs.Item("amod_fuselage_wingspan"))), 1, False, True, False) & "&nbsp;</td></tr>" & vbCrLf)
                        ElseIf sAirframeType = "R" Then
                            l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(ConvertUSToMetricValue("FT", CDbl(l_AdoRs.Item("amod_fuselage_width"))), 1, False, True, False) & "&nbsp;</td></tr>" & vbCrLf)
                        End If
                    Else
                        l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_fuselage_length")), 1, False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                        l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_fuselage_height")), 1, False, True, False) & "&nbsp;</td></tr>" & vbCrLf)

                        If sAirframeType = "F" Then
                            l_objBuilder.Append("<tr><td valign='middle' align='left'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_fuselage_wingspan")), 1, False, True, False) & "&nbsp;</td></tr>" & vbCrLf)
                        ElseIf sAirframeType = "R" Then
                            l_objBuilder.Append("<tr><td valign='middle' align='left'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_fuselage_width")), 1, False, True, False) & "&nbsp;</td></tr>" & vbCrLf)
                        End If
                    End If

                    l_objBuilder.Append("<tr><td>&nbsp;</td></tr><tr>" & vbCrLf)

                    ' amod_cabinsize_height_feet , amod_cabinsize_height_inches
                    ' amod_cabinsize_width_feet , amod_cabinsize_width_inches
                    ' amod_cabinsize_length_feet , amod_cabinsize_length_inches

                    ' THIS IS FOR CABIN DIMENSIONS
                    If Session.Item("useMetricValues") Then

                        If Not IsDBNull(l_AdoRs.Item("amod_cabinsize_length_feet")) Then
                            If CDbl(l_AdoRs.Item("amod_cabinsize_length_feet")) > 0 Then
                                l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(ConvertUSToMetricValue("FT", CDbl(l_AdoRs.Item("amod_cabinsize_length_feet"))), 1, False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                            Else
                                l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(0, False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                            End If
                        Else
                            l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(0, False, False, True) & "&nbsp;</td></tr><tr>" & vbCrLf)
                        End If

                        If Not IsDBNull(l_AdoRs.Item("amod_cabinsize_height_feet")) Then
                            If CDbl(l_AdoRs.Item("amod_cabinsize_height_feet")) > 0 Then
                                l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(ConvertUSToMetricValue("FT", CDbl(l_AdoRs.Item("amod_cabinsize_height_feet"))), 1, False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                            Else
                                l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(0, False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                            End If
                        Else
                            l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(0, False, False, True) & "&nbsp;</td></tr><tr>" & vbCrLf)
                        End If

                        If Not IsDBNull(l_AdoRs.Item("amod_cabinsize_width_feet")) Then
                            If CDbl(l_AdoRs.Item("amod_cabinsize_width_feet")) > 0 Then
                                l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(ConvertUSToMetricValue("FT", CDbl(l_AdoRs.Item("amod_cabinsize_width_feet"))), 1, False, True, False) & "&nbsp;</td></tr>" & vbCrLf)
                            Else
                                l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(0, False, True, False) & "&nbsp;</td></tr>" & vbCrLf)
                            End If
                        Else
                            l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(0, False, False, True) & "&nbsp;</td></tr>" & vbCrLf)
                        End If

                    Else

                        If Not IsDBNull(l_AdoRs.Item("amod_cabinsize_length_feet")) Then
                            If CDbl(l_AdoRs.Item("amod_cabinsize_length_feet")) > 0 Then
                                l_objBuilder.Append("<td valign='middle' align='left'>" & l_AdoRs.Item("amod_cabinsize_length_feet") & "&#34; " & l_AdoRs.Item("amod_cabinsize_length_inches") & "'&nbsp;</td></tr><tr>" & vbCrLf)
                            Else
                                l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(0, False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                            End If
                        Else
                            l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(0, False, False, True) & "&nbsp;</td></tr><tr>" & vbCrLf)
                        End If

                        If Not IsDBNull(l_AdoRs.Item("amod_cabinsize_height_feet")) Then
                            If CDbl(l_AdoRs.Item("amod_cabinsize_height_feet")) > 0 Then
                                l_objBuilder.Append("<td valign='middle' align='left'>" & l_AdoRs.Item("amod_cabinsize_height_feet") & "&#34; " & l_AdoRs.Item("amod_cabinsize_height_inches") & "'&nbsp;</td></tr><tr>" & vbCrLf)
                            Else
                                l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(0, False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                            End If
                        Else
                            l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(0, False, False, True) & "&nbsp;</td></tr><tr>" & vbCrLf)
                        End If

                        If Not IsDBNull(l_AdoRs.Item("amod_cabinsize_width_feet")) Then
                            If CDbl(l_AdoRs.Item("amod_cabinsize_width_feet")) > 0 Then
                                l_objBuilder.Append("<td valign='middle' align='left'>" & l_AdoRs.Item("amod_cabinsize_width_feet") & "&#34; " & l_AdoRs.Item("amod_cabinsize_width_inches") & "'&nbsp;</td></tr>" & vbCrLf)
                            Else
                                l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(0, False, True, False) & "&nbsp;</td></tr>" & vbCrLf)
                            End If
                        Else
                            l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(0, False, False, True) & "&nbsp;</td></tr>" & vbCrLf)
                        End If

                    End If

                    l_objBuilder.Append("<tr><td>&nbsp;</td></tr><tr>" & vbCrLf)

                    l_objBuilder.Append("<td valign='middle' align='left'>" & l_AdoRs.Item("amod_number_of_crew") & "&nbsp;</td></tr><tr>" & vbCrLf)
                    l_objBuilder.Append("<td valign='middle' align='left'>" & l_AdoRs.Item("amod_number_of_passengers") & "&nbsp;</td></tr>" & vbCrLf)


                    ' THIS IS FOR PRESSURIZATION SECTION
                    If sAirframeType = "F" Then
                        If Session.Item("useMetricValues") Then
                            l_objBuilder.Append("<tr><td valign='middle' align='left'>" & FormatNumber(ConvertUSToMetricValue("PSI", CDbl(l_AdoRs.Item("amod_pressure"))), 1, False, True, False) & "&nbsp;</td></tr>" & vbCrLf)
                        Else
                            'l_objBuilder.Append("<tr><td valign='middle' align='left'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_pressure")), 0, False, True, False) & "&nbsp;</td></tr>" & vbCrLf)

                            l_objBuilder.Append("<tr><td valign='middle' align='left'>" & CDbl(l_AdoRs.Item("amod_pressure")) & "&nbsp;</td></tr>" & vbCrLf)

                        End If
                    ElseIf sAirframeType = "R" And bHasManyAirFrames Then
                        l_objBuilder.Append("<tr><td valign='middle' align='left'>" & crmWebClient.Constants.NOTAPPLICABLE_PLACEHOLDER & "&nbsp;</td></tr>" & vbCrLf)
                    End If

                    l_objBuilder.Append("<tr><td>&nbsp;</td></tr><tr>" & vbCrLf)

                    If Not IsDBNull(l_AdoRs.Item("amod_fuel_cap_std_weight")) Then
                        If CDbl(l_AdoRs.Item("amod_fuel_cap_std_weight")) > 0 Then
                            If Session.Item("useMetricValues") Then
                                l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(ConvertUSToMetricValue("LBS", CDbl(l_AdoRs.Item("amod_fuel_cap_std_weight"))), False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                            Else
                                l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_fuel_cap_std_weight")), False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                            End If
                        Else
                            l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(0, False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                        End If
                    Else
                        l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(0, False, False, True) & "&nbsp;</td></tr><tr>" & vbCrLf)
                    End If

                    If Not IsDBNull(l_AdoRs.Item("amod_fuel_cap_std_gal")) Then
                        If CDbl(l_AdoRs.Item("amod_fuel_cap_std_gal")) > 0 Then
                            If Session.Item("useMetricValues") Then
                                l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(ConvertUSToMetricValue("GAL", CDbl(l_AdoRs.Item("amod_fuel_cap_std_gal"))), False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                            Else
                                l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_fuel_cap_std_gal")), False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                            End If
                        Else
                            l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(0, False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                        End If
                    Else
                        l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(0, False, False, True) & "&nbsp;</td></tr><tr>" & vbCrLf)
                    End If

                    If Not IsDBNull(l_AdoRs.Item("amod_fuel_cap_opt_weight")) Then
                        If CDbl(l_AdoRs.Item("amod_fuel_cap_opt_weight")) > 0 Then
                            If Session.Item("useMetricValues") Then
                                l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(ConvertUSToMetricValue("LBS", CDbl(l_AdoRs.Item("amod_fuel_cap_opt_weight"))), False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                            Else
                                l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_fuel_cap_opt_weight")), False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                            End If
                        Else
                            l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(0, False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                        End If
                    Else
                        l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(0, False, False, True) & "&nbsp;</td></tr><tr>" & vbCrLf)
                    End If

                    If Not IsDBNull(l_AdoRs.Item("amod_fuel_cap_opt_gal")) Then
                        If CDbl(l_AdoRs.Item("amod_fuel_cap_opt_gal")) > 0 Then
                            If Session.Item("useMetricValues") Then
                                l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(ConvertUSToMetricValue("GAL", CDbl(l_AdoRs.Item("amod_fuel_cap_opt_gal"))), False, True, False) & "&nbsp;</td></tr>" & vbCrLf)
                            Else
                                l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_fuel_cap_opt_gal")), False, True, False) & "&nbsp;</td></tr>" & vbCrLf)
                            End If
                        Else
                            l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(0, False, True, False) & "&nbsp;</td></tr>" & vbCrLf)
                        End If
                    Else
                        l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(0, False, False, True) & "&nbsp;</td></tr>" & vbCrLf)
                    End If

                    l_objBuilder.Append("<tr><td>&nbsp;</td></tr><tr>" & vbCrLf)

                    If Session.Item("useMetricValues") Then
                        l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(ConvertUSToMetricValue("LBS", CDbl(l_AdoRs.Item("amod_max_ramp_weight"))), False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                    Else
                        l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_max_ramp_weight")), False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                    End If

                    If Session.Item("useMetricValues") Then
                        l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(ConvertUSToMetricValue("LBS", CDbl(l_AdoRs.Item("amod_max_takeoff_weight"))), False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                    Else
                        l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_max_takeoff_weight")), False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                    End If

                    If sAirframeType = "F" Then
                        If Session.Item("useMetricValues") Then
                            l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(ConvertUSToMetricValue("LBS", CDbl(l_AdoRs.Item("amod_zero_fuel_weight"))), False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                        Else
                            l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_zero_fuel_weight")), False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                        End If
                    ElseIf sAirframeType = "R" Then
                        If Session.Item("useMetricValues") Then
                            l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(ConvertUSToMetricValue("LBS", CDbl(l_AdoRs.Item("amod_weight_eow"))), False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                        Else
                            l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_weight_eow")), False, True, False) & "&nbsp;</td></tr><tr>")
                        End If
                    End If

                    If Session.Item("useMetricValues") Then
                        l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(ConvertUSToMetricValue("LBS", CDbl(l_AdoRs.Item("amod_basic_op_weight"))), False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                    Else
                        l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_basic_op_weight")), False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                    End If

                    If Session.Item("useMetricValues") Then
                        l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(ConvertUSToMetricValue("LBS", CDbl(l_AdoRs.Item("amod_max_landing_weight"))), False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                    Else
                        l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_max_landing_weight")), False, True, False) & "&nbsp;</td></tr>" & vbCrLf)
                    End If
                    '''''''''''''''''''''''''''''''''''''''''''''''''''
                    ' End the left column
                    '''''''''''''''''''''''''''''''''''''''''''''''''''
                    l_objBuilder.Append("</table></td>" & vbCrLf)




                Else

                    ''''''''''''''''''''''''''''''''''''''''''''
                    ' Break goes here
                    ''''''''''''''''''''''''''''''''''''''''''''
                    l_objBuilder.Append("<td  valign='top' align='left' class='Performance_Specs_Filler_TD_Middle'>&nbsp;" & vbCrLf)

                    l_objBuilder.Append("</td>" & vbCrLf)
                    l_objBuilder.Append("<td valign='top' align='left' class='Performance_Specs_Right_TD_1'>" & vbCrLf)

                    If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                        l_objBuilder.Append("<table cellpadding='2' cellspacing='0' width='" & word_1_4 & "'>" & vbCrLf)
                    Else
                        l_objBuilder.Append("<table cellpadding='2' cellspacing='0'>" & vbCrLf)
                    End If

                    If Session.Item("useMetricValues") Then
                        l_objBuilder.Append("<tr><td><strong>Speed&nbsp;" & TranslateUSMetricUnitsLong("KN") & "</strong></td></tr><tr>" & vbCrLf)
                    Else
                        l_objBuilder.Append("<tr><td><strong>Speed&nbsp;Knots</strong></td></tr><tr>" & vbCrLf)
                    End If

                    If sAirframeType = "F" And Not bHasManyAirFrames Then
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Vs&nbsp;Clean:</td></tr><tr>" & vbCrLf)
                    ElseIf sAirframeType = "R" And Not bHasManyAirFrames Then
                        ' do nothing
                    ElseIf (sAirframeType = "F" Or sAirframeType = "R") And bHasManyAirFrames Then
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>[F] Vs&nbsp;Clean:</td></tr><tr>" & vbCrLf)
                    End If

                    If sAirframeType = "F" And Not bHasManyAirFrames Then
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Vso&nbsp;Landing:</td></tr><tr>" & vbCrLf)
                    ElseIf sAirframeType = "R" And Not bHasManyAirFrames Then
                        ' do nothing
                    ElseIf (sAirframeType = "F" Or sAirframeType = "R") And bHasManyAirFrames Then
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>[F] Vso&nbsp;Landing:</td></tr><tr>" & vbCrLf)
                    End If
                    l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Normal&nbsp;Cruise&nbsp;TAS:</td></tr><tr>" & vbCrLf)
                    l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Vmo&nbsp;(Max&nbsp;Op)&nbsp;IAS:</td></tr>" & vbCrLf)

                    If sAirframeType = "F" And Not bHasManyAirFrames Then
                        ' do nothing
                    ElseIf sAirframeType = "R" And Not bHasManyAirFrames Then
                        l_objBuilder.Append("<tr><th nowrap>IFR Certification:</th></tr><tr>" & vbCrLf)
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>(IFR):</td></tr>" & vbCrLf)
                    ElseIf (sAirframeType = "F" Or sAirframeType = "R") And bHasManyAirFrames Then
                        l_objBuilder.Append("<tr><th nowrap>[R] IFR Certification:</th></tr><tr>" & vbCrLf)
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>[R] (IFR):</td></tr>" & vbCrLf)
                    End If

                    l_objBuilder.Append("<tr><td><strong>Climb</strong></td></tr><tr>")
                    If Session.Item("useMetricValues") Then
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Normal&nbsp;(" & TranslateUSMetricUnitsShort("FPM") & "):</td></tr><tr>" & vbCrLf)
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Engine&nbsp;Out&nbsp;(" & TranslateUSMetricUnitsShort("FPM") & "):</td></tr><tr>" & vbCrLf)
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Ceiling (" & TranslateUSMetricUnitsShort("FT") & "):</td></tr>" & vbCrLf)
                    Else
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Normal&nbsp;(fpm):</td></tr><tr>" & vbCrLf)
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Engine&nbsp;Out&nbsp;(fpm):</td></tr><tr>" & vbCrLf)
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Ceiling (ft):</td></tr>" & vbCrLf)
                    End If


                    If sAirframeType = "F" And Not bHasManyAirFrames Then
                        'do nothing
                    ElseIf sAirframeType = "R" And Not bHasManyAirFrames Then
                        l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'>(HOGE)&nbsp;Out&nbsp;of&nbsp;Ground&nbsp;Effect:</td></tr>" & vbCrLf)
                        l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'>(HIGE)&nbsp;In&nbsp;Ground&nbsp;Effect:</td></tr>" & vbCrLf)
                    ElseIf (sAirframeType = "F" Or sAirframeType = "R") And bHasManyAirFrames Then
                        l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'>[R] (HOGE)&nbsp;Out&nbsp;of&nbsp;Ground&nbsp;Effect:</td></tr>" & vbCrLf)
                        l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'>[R] (HIGE)&nbsp;In&nbsp;Ground&nbsp;Effect:</td></tr>" & vbCrLf)
                    End If

                    If sAirframeType = "F" And Not bHasManyAirFrames Then
                        l_objBuilder.Append("<tr><td><strong>Landing Performance</strong></td></tr><tr>")
                        If Session.Item("useMetricValues") Then
                            l_objBuilder.Append("<td class='Label' valign='middle' align='right'>FAA&nbsp;Field&nbsp;Length (" & TranslateUSMetricUnitsShort("FT") & "):</td></tr>" & vbCrLf)
                        Else
                            l_objBuilder.Append("<td class='Label' valign='middle' align='right'>FAA&nbsp;Field&nbsp;Length (ft):</td></tr>" & vbCrLf)
                        End If
                    ElseIf sAirframeType = "R" And Not bHasManyAirFrames Then
                        ' do nothing
                    ElseIf (sAirframeType = "F" Or sAirframeType = "R") And bHasManyAirFrames Then
                        l_objBuilder.Append("<tr><td><strong>[F] Landing Performance<strong></td></tr><tr>" & vbCrLf)
                        If Session.Item("useMetricValues") Then
                            l_objBuilder.Append("<td class='Label' valign='middle' align='right'>[F] FAA&nbsp;Field&nbsp;Length (" & TranslateUSMetricUnitsShort("FT") & "):</td></tr>" & vbCrLf)
                        Else
                            l_objBuilder.Append("<td class='Label' valign='middle' align='right'>[F] FAA&nbsp;Field&nbsp;Length (ft):</td></tr>" & vbCrLf)
                        End If
                    End If
                    'amod_field_length, amod_max_range_miles
                    l_objBuilder.Append("<tr><td><strong>Takeoff Performance</strong></td></tr><tr>" & vbCrLf)
                    l_objBuilder.Append("<td class='Label' valign='middle' align='right'>SL&nbsp;ISA&nbsp;BFL:</td></tr><tr>" & vbCrLf)
                    l_objBuilder.Append("<td class='Label' valign='middle' align='right'>5000'&nbsp;+20C&nbsp;BFL:</td></tr>" & vbCrLf)

                    If Session.Item("useMetricValues") Then
                        l_objBuilder.Append("<tr><td nowrap><strong>Range (" & TranslateUSMetricUnitsLong("NM") & ")</strong></td></tr>" & vbCrLf)

                        If sAirframeType = "F" And Not bHasManyAirFrames Then
                            l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'>Range&nbsp;(" & TranslateUSMetricUnitsShort("NM") & "):</td></tr>" & vbCrLf)
                        ElseIf sAirframeType = "R" And Not bHasManyAirFrames Then
                            l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'>Tanks&nbsp;Full&nbsp;(" & TranslateUSMetricUnitsShort("NM") & "):</td></tr><tr>" & vbCrLf)
                            l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'>Seats&nbsp;Full&nbsp;(" & TranslateUSMetricUnitsShort("NM") & "):</td></tr>" & vbCrLf)
                        ElseIf (sAirframeType = "F" Or sAirframeType = "R") And bHasManyAirFrames Then
                            l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'>[F] Range&nbsp;(" & TranslateUSMetricUnitsShort("NM") & ") / [R] Tanks&nbsp;Full&nbsp;(" & TranslateUSMetricUnitsShort("NM") & "):</td></tr><tr>" & vbCrLf)
                            l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'>[R] Seats&nbsp;Full&nbsp;(" & TranslateUSMetricUnitsShort("NM") & "):</td></tr>" & vbCrLf)
                        End If
                    Else
                        ' l_objBuilder.Append("<tr><td nowrap><strong>Landing Field Length (ft)</strong></td></tr>" & vbCrLf)
                        l_objBuilder.Append("<tr><td nowrap><strong>Range (Nautical Miles)</strong></td></tr>" & vbCrLf)

                        If sAirframeType = "F" And Not bHasManyAirFrames Then
                            l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'>Range&nbsp;(nm):</td></tr>" & vbCrLf)
                        ElseIf sAirframeType = "R" And Not bHasManyAirFrames Then
                            l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'>Tanks&nbsp;Full&nbsp;(nm):</td></tr>" & vbCrLf)
                            l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'>Seats&nbsp;Full&nbsp;(nm):</td></tr>" & vbCrLf)
                        ElseIf (sAirframeType = "F" Or sAirframeType = "R") And bHasManyAirFrames Then
                            l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'>[F] Range&nbsp;(nm) / [R] Tanks&nbsp;Full&nbsp;(nm):</td></tr>" & vbCrLf)
                            l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'>[R] Seats&nbsp;Full&nbsp;(nm):</td></tr>" & vbCrLf)
                        End If
                    End If

                    l_objBuilder.Append("<tr><td nowrap><strong>Engines</strong></td></tr><tr>" & vbCrLf)
                    l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Number&nbsp;of:</td></tr><tr>" & vbCrLf)
                    l_objBuilder.Append("<td class='Label' valign='top' align='right'>Model(s):" & vbCrLf)

                    GetEnginesNumberForSpace(amod_id, nMAXEngines)

                    For iLoop = 1 To number_of_engine_types - 1
                        l_objBuilder.Append("<br>&nbsp;" & vbCrLf)
                    Next

                    l_objBuilder.Append("</td></tr><tr>" & vbCrLf)

                    If Session.Item("useMetricValues") Then
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Thrust&nbsp;(" & TranslateUSMetricUnitsShort("LBS") & "&nbsp;per&nbsp;Engine):</td></tr><tr>" & vbCrLf)
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Shaft&nbsp;(" & TranslateUSMetricUnitsShort("HP") & "&nbsp;per&nbsp;Engine):</td></tr><tr>")
                    Else
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Thrust&nbsp;(lbs&nbsp;per&nbsp;Engine):</td></tr><tr>" & vbCrLf)
                        l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Shaft&nbsp;(hp&nbsp;per&nbsp;Engine):</td></tr><tr>" & vbCrLf)
                    End If

                    l_objBuilder.Append("<td class='Label' valign='middle' align='right'>Common&nbsp;TBO&nbsp;Hours:</td></tr>" & vbCrLf)
                    ''''''''''''''''''''''''''''''''''''''''''''''''''''
                    ' End the break here for the other column
                    ''''''''''''''''''''''''''''''''''''''''''''''''''''

                    l_objBuilder.Append("</table></td>" & vbCrLf)

                    '''''''''''''''''''''''''''''''''''''''''''''''''''
                    ' Start the right column
                    '''''''''''''''''''''''''''''''''''''''''''''''''''
                    l_objBuilder.Append("<td valign='top' align='left' class='Performance_Specs_Right_TD_2'>")
                    l_objBuilder.Append("<table cellpadding='2' cellspacing='0'>" & vbCrLf)

                    l_objBuilder.Append("<tr><td>&nbsp;</td></tr><tr>" & vbCrLf)

                    If sAirframeType = "F" Then
                        If Session.Item("useMetricValues") Then
                            If Not IsDBNull(l_AdoRs.Item("amod_stall_vs")) Then
                                If CDbl(l_AdoRs.Item("amod_stall_vs")) > 0 Then
                                    l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(ConvertUSToMetricValue("KN", CDbl(l_AdoRs.Item("amod_stall_vs"))), False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                                Else
                                    l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(0, False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                                End If
                            Else
                                l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(0, False, False, True) & "&nbsp;</td></tr><tr>" & vbCrLf)
                            End If
                        Else
                            If Not IsDBNull(l_AdoRs.Item("amod_stall_vs")) Then
                                If CDbl(l_AdoRs.Item("amod_stall_vs")) > 0 Then
                                    l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_stall_vs")), False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                                Else
                                    l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(0, False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                                End If
                            Else
                                l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(0, False, False, True) & "&nbsp;</td></tr><tr>" & vbCrLf)
                            End If
                        End If
                    ElseIf sAirframeType = "R" And bHasManyAirFrames Then
                        l_objBuilder.Append("<td valign='middle' align='left'>" & crmWebClient.Constants.NOTAPPLICABLE_PLACEHOLDER & "&nbsp;</td></tr><tr>" & vbCrLf)
                    End If

                    If sAirframeType = "F" Then
                        If Session.Item("useMetricValues") Then
                            If Not IsDBNull(l_AdoRs.Item("amod_stall_vso")) Then
                                If CDbl(l_AdoRs.Item("amod_stall_vso")) > 0 Then
                                    l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(ConvertUSToMetricValue("KN", CDbl(l_AdoRs.Item("amod_stall_vso"))), False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                                Else
                                    l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(0, False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                                End If
                            Else
                                l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(0, False, False, True) & "&nbsp;</td></tr><tr>" & vbCrLf)
                            End If
                        Else
                            If Not IsDBNull(l_AdoRs.Item("amod_stall_vso")) Then
                                If CDbl(l_AdoRs.Item("amod_stall_vso")) > 0 Then
                                    l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_stall_vso")), False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                                Else
                                    l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(0, False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                                End If
                            Else
                                l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(0, False, False, True) & "&nbsp;</td></tr><tr>" & vbCrLf)
                            End If
                        End If
                    ElseIf sAirframeType = "R" And bHasManyAirFrames Then
                        l_objBuilder.Append("<td valign='middle' align='left'>" & crmWebClient.Constants.NOTAPPLICABLE_PLACEHOLDER & "&nbsp;</td></tr><tr>" & vbCrLf)
                    End If

                    If Session.Item("useMetricValues") Then
                        l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(ConvertUSToMetricValue("KN", CDbl(l_AdoRs.Item("amod_cruis_speed"))), False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                        l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(ConvertUSToMetricValue("KN", CDbl(l_AdoRs.Item("amod_max_speed"))), False, True, False) & "&nbsp;</td></tr>" & vbCrLf)
                    Else
                        l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_cruis_speed")), False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                        l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_max_speed")), False, True, False) & "&nbsp;</td></tr>" & vbCrLf)
                    End If

                    If sAirframeType = "F" And bHasManyAirFrames Then

                        l_objBuilder.Append("<tr><td>&nbsp;</td></tr><tr>" & vbCrLf)
                        l_objBuilder.Append("<td valign='middle' align='left'>" & crmWebClient.Constants.NOTAPPLICABLE_PLACEHOLDER & "&nbsp;</td></tr>" & vbCrLf)
                    ElseIf sAirframeType = "R" Then

                        l_objBuilder.Append("<tr><td>&nbsp;</td></tr><tr>")

                        If Not IsDBNull(l_AdoRs.Item("amod_ifr_certification")) Then
                            l_objBuilder.Append("<td valign='middle' align='left'>" & l_AdoRs.Item("amod_ifr_certification") & "&nbsp;</td></tr>" & vbCrLf)
                        Else
                            l_objBuilder.Append("<td valign='middle' align='left'>Unknown</td></tr>" & vbCrLf)
                        End If
                    End If

                    l_objBuilder.Append("<tr><td>&nbsp;</td></tr><tr>" & vbCrLf)

                    If Session.Item("useMetricValues") Then
                        If CDbl(l_AdoRs.Item("amod_climb_normal_feet")) > 0 Then
                            l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(ConvertUSToMetricValue("FPM", CDbl(l_AdoRs.Item("amod_climb_normal_feet"))), 1, False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                        Else
                            l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(0, False, False, True) & "&nbsp;</td></tr><tr>" & vbCrLf)
                        End If

                        If CDbl(l_AdoRs.Item("amod_climb_engout_feet")) > 0 Then
                            l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(ConvertUSToMetricValue("FPM", CDbl(l_AdoRs.Item("amod_climb_engout_feet"))), 1, False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                        Else
                            l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(0, False, False, True) & "&nbsp;</td></tr><tr>" & vbCrLf)
                        End If

                        If CDbl(l_AdoRs.Item("amod_ceiling_feet")) > 0 Then
                            l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(ConvertUSToMetricValue("FT", CDbl(l_AdoRs.Item("amod_ceiling_feet"))), False, True, False) & "&nbsp;</td></tr>" & vbCrLf)
                        Else
                            l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(0, False, False, True) & "&nbsp;</td></tr>" & vbCrLf)
                        End If

                    Else
                        If CDbl(l_AdoRs.Item("amod_climb_normal_feet")) > 0 Then
                            l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_climb_normal_feet")), False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                        Else
                            l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(0, False, False, True) & "&nbsp;</td></tr><tr>" & vbCrLf)
                        End If

                        If CDbl(l_AdoRs.Item("amod_climb_engout_feet")) > 0 Then
                            l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_climb_engout_feet")), False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                        Else
                            l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(0, False, False, True) & "&nbsp;</td></tr><tr>" & vbCrLf)
                        End If

                        If CDbl(l_AdoRs.Item("amod_ceiling_feet")) > 0 Then
                            l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_ceiling_feet")), False, True, False) & "&nbsp;</td></tr>" & vbCrLf)
                        Else
                            l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(0, False, False, True) & "&nbsp;</td></tr>" & vbCrLf)
                        End If
                    End If

                    If sAirframeType = "F" And bHasManyAirFrames Then
                        l_objBuilder.Append("<tr><td valign='middle' align='left'>" & crmWebClient.Constants.NOTAPPLICABLE_PLACEHOLDER & "&nbsp;</td></tr>" & vbCrLf)
                        l_objBuilder.Append("<tr><td valign='middle' align='left'>" & crmWebClient.Constants.NOTAPPLICABLE_PLACEHOLDER & "&nbsp;</td></tr>" & vbCrLf)
                    ElseIf sAirframeType = "R" Then

                        If Not IsDBNull(l_AdoRs.Item("amod_climb_hoge")) Then
                            If Session.Item("useMetricValues") Then
                                l_objBuilder.Append("<tr><td valign='middle' align='left'>" & FormatNumber(ConvertUSToMetricValue("FT", CDbl(l_AdoRs.Item("amod_climb_hoge"))), False, True, False) & "&nbsp;</td></tr>" & vbCrLf)
                            Else
                                l_objBuilder.Append("<tr><td valign='middle' align='left'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_climb_hoge")), False, True, False) & "&nbsp;</td></tr>" & vbCrLf)
                            End If
                        Else
                            l_objBuilder.Append("<tr><td valign='middle' align='left'>&nbsp;</td></tr>")
                        End If

                        If Not IsDBNull(l_AdoRs.Item("amod_climb_hige")) Then
                            If Session.Item("useMetricValues") Then
                                l_objBuilder.Append("<tr><td valign='middle' align='left'>" & FormatNumber(ConvertUSToMetricValue("FT", CDbl(l_AdoRs.Item("amod_climb_hige"))), False, True, False) & "&nbsp;</td></tr>" & vbCrLf)
                            Else
                                l_objBuilder.Append("<tr><td valign='middle' align='left'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_climb_hige")), False, True, False) & "&nbsp;</td></tr>" & vbCrLf)
                            End If
                        Else
                            l_objBuilder.Append("<tr><td valign='middle' align='left'>&nbsp;</td></tr>")
                        End If

                    End If

                    If sAirframeType = "F" Then

                        l_objBuilder.Append("<tr><td>&nbsp;</td></tr><tr>" & vbCrLf)
                        If Session.Item("useMetricValues") Then
                            l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(ConvertUSToMetricValue("FT", CDbl(l_AdoRs.Item("amod_field_length"))), False, True, False) & "&nbsp;</td></tr>" & vbCrLf)
                        Else
                            l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(CLng(l_AdoRs.Item("amod_field_length")), False, True, False) & "&nbsp;</td></tr>" & vbCrLf)
                        End If
                    ElseIf sAirframeType = "R" And bHasManyAirFrames Then

                        l_objBuilder.Append("<tr><th>&nbsp;</th></tr><tr>")
                        l_objBuilder.Append("<td valign='middle' align='left'>" & crmWebClient.Constants.NOTAPPLICABLE_PLACEHOLDER & "&nbsp;</td></tr>" & vbCrLf)
                    End If

                    l_objBuilder.Append("<tr><td>&nbsp;</td></tr><tr>" & vbCrLf)

                    l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(CLng(l_AdoRs.Item("amod_takeoff_ali")), False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                    l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(CLng(l_AdoRs.Item("amod_takeoff_500")), False, True, False) & "&nbsp;</td></tr>" & vbCrLf)

                    '  l_objBuilder.Append("<tr><td>&nbsp;</td></tr><tr>" & vbCrLf)

                    'If sAirframeType = "F" Then
                    '  If Session.item("useMetricValues") Then
                    '    l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(ConvertUSToMetricValue("NM", CDbl(l_AdoRs.Item("amod_max_range_miles"))), False, True, False) & "&nbsp;</td></tr>" & vbCrLf)
                    '  Else
                    '    l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_max_range_miles")), False, True, False) & "&nbsp;</td></tr>" & vbCrLf)
                    '  End If
                    'ElseIf sAirframeType = "R" Then
                    '  If Session.item("useMetricValues") Then
                    '    l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(ConvertUSToMetricValue("NM", CDbl(l_AdoRs.Item("amod_range_tanks_full"))), False, True, False) & "&nbsp;</td></tr>" & vbCrLf)
                    '  Else
                    '    l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_range_tanks_full")), False, True, False) & "&nbsp;</td></tr>" & vbCrLf)
                    '  End If
                    'End If

                    If sAirframeType = "F" And bHasManyAirFrames Then
                        l_objBuilder.Append("<tr><td valign='middle' align='left'>" & crmWebClient.Constants.NOTAPPLICABLE_PLACEHOLDER & "&nbsp;</td></tr>" & vbCrLf)
                    ElseIf sAirframeType = "R" Then
                        If Session.Item("useMetricValues") Then
                            l_objBuilder.Append("<tr><td valign='middle' align='left'>" & FormatNumber(ConvertUSToMetricValue("NM", CDbl(l_AdoRs.Item("amod_range_seats_full"))), False, True, False) & "&nbsp;</td></tr>" & vbCrLf)
                        Else
                            l_objBuilder.Append("<tr><td valign='middle' align='left'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_range_seats_full")), False, True, False) & "&nbsp;</td></tr>" & vbCrLf)
                        End If
                    End If

                    ' THIS IS FOR LANDING FIELD LENGTH SECTION - OTHER SECTIONS ABOVE - THIS IS ALSO IN THEORY THE RANGE SECTION
                    '   l_objBuilder.Append("<tr><td>&nbsp;" & CLng(l_AdoRs.Item("amod_field_length")) & "</td></tr>" & vbCrLf)
                    l_objBuilder.Append("<tr><td>&nbsp;</td></tr><tr>" & vbCrLf)
                    l_objBuilder.Append("<tr><td>&nbsp;" & CLng(l_AdoRs.Item("amod_max_range_miles")) & "</td></tr>" & vbCrLf)
                    l_objBuilder.Append("<tr><td>&nbsp;</td></tr><tr>" & vbCrLf)

                    l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(CLng(l_AdoRs.Item("amod_number_of_engines")), False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                    l_objBuilder.Append("<td valign='middle' align='left' nowrap>" & GetEngines(l_AdoRs.Item("amod_id"), nMAXEngines) & "</td></tr><tr>" & vbCrLf)


                    If Session.Item("useMetricValues") Then
                        l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(CDbl(ConvertUSToMetricValue("LBS", l_AdoRs.Item("amod_engine_thrust_lbs"))), False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                        If Not IsDBNull(l_AdoRs.Item("amod_engine_shaft")) Then
                            If CDbl(l_AdoRs.Item("amod_engine_shaft")) > 0 Then
                                l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(CDbl(ConvertUSToMetricValue("HP", l_AdoRs.Item("amod_engine_shaft"))), False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                            Else
                                l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(0, False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                            End If
                        Else
                            l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(0, False, False, True) & "&nbsp;</td></tr><tr>" & vbCrLf)
                        End If
                    Else
                        l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_engine_thrust_lbs")), False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                        If Not IsDBNull(l_AdoRs.Item("amod_engine_shaft")) Then
                            If CDbl(l_AdoRs.Item("amod_engine_shaft")) > 0 Then
                                l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_engine_shaft")), False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                            Else
                                l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(0, False, True, False) & "&nbsp;</td></tr><tr>" & vbCrLf)
                            End If
                        Else
                            l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(0, False, False, True) & "&nbsp;</td></tr><tr>" & vbCrLf)
                        End If
                    End If

                    l_objBuilder.Append("<td valign='middle' align='left'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_engine_com_tbo_hrs")), False, True, False) & "&nbsp;</td></tr>" & vbCrLf)
                    '''''''''''''''''''''''''''''''''''''''''''''''''''
                    ' End the left column
                    '''''''''''''''''''''''''''''''''''''''''''''''''''

                    l_objBuilder.Append("</table></td>" & vbCrLf)

                End If
            Next
            ' add the spacer to move the footer down
            l_objBuilder.Append("</tr><tr>" & vbCrLf)
            l_objBuilder.Append("<td  align='center'  id='tdInnerTableSetup' colspan='1' >" & vbCrLf)
            l_objBuilder.Append("&nbsp;" & vbCrLf)
            l_objBuilder.Append("</td>" & vbCrLf)
            l_objBuilder.Append("</tr>" & vbCrLf)

            l_objBuilder.Append("</table>" & vbCrLf)

            l_AdoRs.Close()
            l_AdoRs = Nothing

            Build_PerformanceSpecifications = l_objBuilder.ToString()


        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Build_PerformanceSpecifications: " & ex.Message
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function
    Public Function Build_OperatingCosts(ByRef foot_space_op_costs As String, ByVal amod_id As Integer) As String
        Build_OperatingCosts = ""


        Dim DCRecCount, AFRecCount, ABRecCount, ANCH, nCount, sTitle

        Dim tmpCDblValue As Double = 0.0
        Dim TCND As Double = 0.0
        Dim TCSM As Double = 0.0
        Dim TCST As Double = 0.0

        Dim bFirstOne As Boolean = True
        Dim fuelTotCost As Double = 0.00
        Dim fuelGalCost As Double = 0.00
        Dim fuelAddCost As Double = 0.00
        Dim fuelBurnRate As Double = 0.00
        Dim avgBlockSpeed As Double = 0.00
        Dim totalCostPer As Double = 0.00
        Dim annualMiles As Double = 0.00
        Dim dfstatmilecost As Double = 0.00
        Dim dfseatcost As Double = 0.00
        Dim totalDirCostHR As Double = 0.00
        Dim annualHrs As Double = 0.00
        Dim totalFixedDirect As Double = 0.00
        Dim totalDirCostYR As Double = 0.00
        Dim dfhourcost As Double = 0.00
        Dim sCurrencyName = ""
        Dim sCurrencySymbol = ""
        Dim crewsalaries As Double = 0.00
        Dim hangercost As Double = 0.00
        Dim miscoverhead As Double = 0.00
        Dim depoverhead As Double = 0.00
        Dim totalfixedcost As Double = 0.00
        Dim insurancecost As Double = 0.00
        Dim totalmaintcost As Double = 0.00
        Dim miscflightcosts As Double = 0.00
        Dim overhaulcost As Double = 0.00
        Dim revoverhaulcost As Double = 0.00

        Dim sCurrencyDate = ""
        Dim nRememberSessionTimeout As Long = 0


        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim localAdoRs As System.Data.SqlClient.SqlDataReader : localAdoRs = Nothing

        Dim Query As String : Query = ""
        Try
            'Select Case Application.Item("webHostObject").evoWebHostType
            'Case eWebSiteTypes.LOCAL
            'SqlConn.ConnectionString = My.Settings.DEFAULT_LOCAL_MSSQL
            ' Case Else
            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            ' End Select

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            Query = "SELECT * FROM Aircraft_Model WITH(NOLOCK) WHERE amod_id = " + amod_id.ToString



            If Not localCriteria.ViewCriteriaHasHelicopterFlag And Not localCriteria.ViewCriteriaHasBusinessFlag And Not localCriteria.ViewCriteriaHasCommercialFlag And localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_NONE Then
                localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_ALL ' use subscribers product code(s) for queries
            ElseIf localCriteria.ViewCriteriaHasHelicopterFlag And localCriteria.ViewCriteriaHasBusinessFlag And localCriteria.ViewCriteriaHasCommercialFlag And localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_NONE Then
                localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_ALL ' use subscribers product code(s) for queries
            End If

            If localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_ALL Then
                Query = Query & "  " + commonEvo.GenerateProductCodeSelectionQuery(HttpContext.Current.Session.Item("localPreferences"), False, True)
            Else
                Query = Query & "  " + commonEvo.BuildProductCodeCheckWhereClause(localCriteria.ViewCriteriaHasHelicopterFlag, localCriteria.ViewCriteriaHasBusinessFlag, localCriteria.ViewCriteriaHasCommercialFlag, False, False, False, True)
            End If






            SqlCommand.CommandText = Query

            Dim l_objBuilder As New StringBuilder
            Dim nNumberOfEngines As Integer = 0
            Dim nRememberModelID As Long = 0
            Dim nMAXEngines As Long = 0
            Dim nRows As Long = 0
            localAdoRs = SqlCommand.ExecuteReader()

            If localAdoRs.HasRows Then
                ' EXTRA QUERY TAKEN OUT
                localAdoRs.Read()
                'End If
            Else
                Build_OperatingCosts = ""
                Exit Function
            End If
            TCND = 0.0
            TCSM = 0.0
            TCST = 0.0
            ANCH = 0.0

            tmpCDblValue = 0.0

            ' bFirstOne = False
            nCount = 3

            DCRecCount = 0
            AFRecCount = 0
            ABRecCount = 0


            If CDbl(Session.Item("localfuelPrice")) > 0 Then
                Session.Item("fuelPriceBase") = Session.Item("localfuelPrice")
            ElseIf CDbl(Session.Item("homebasefuelPrice")) > 0 Then
                Session.Item("fuelPriceBase") = Session.Item("homebasefuelPrice")
            End If

            If LCase(Session.Item("localPreferences").UseStandardOrMetric) = LCase("standard") Then
                sTitle = "US Standard"
            Else
                sTitle = "Metric"
            End If

            sCurrencyName = ""
            sCurrencyDate = CStr(Now())

            ' MSW THIS WAS ADDED IN TO DUMMY IN US

            If CLng(Session.Item("localPreferences").DefaultCurrency) <> 9 Then ' 9 = us dollar

                Session.Item("currencyExchangeRate") = GetForeignExchangeRate(Session.Item("localPreferences").DefaultCurrency, sCurrencyName, sCurrencyDate)

                If Trim(sCurrencyDate) <> "" Then
                    sTitle = sTitle & " <em>(" & sCurrencyName & ": " & Session.Item("currencyExchangeRate") & ") rate as of " & FormatDateTime(sCurrencyDate, vbShortDate) & "</em>]"
                End If

            Else
                Session.Item("currencyExchangeRate") = 0
                sCurrencySymbol = crmWebClient.Constants.cDollarSymbol
            End If

            If InStr(1, LCase(sCurrencyName), "euro") > 0 Then
                sCurrencySymbol = crmWebClient.Constants.cEuroSymbol
            ElseIf InStr(1, LCase(sCurrencyName), "dollar") > 0 Then
                sCurrencySymbol = crmWebClient.Constants.cDollarSymbol
            ElseIf InStr(1, LCase(sCurrencyName), "pound") > 0 Then
                sCurrencySymbol = crmWebClient.Constants.cPoundSymbol
            Else
                sCurrencySymbol = crmWebClient.Constants.cEmptyString
            End If


            ' BEGINNING SECTION HERE PICTURE AND TITLE-----------------------------------------------------------------------------
            Build_OperatingCosts = Build_OperatingCosts & "<table align='center' border='0' cellpadding='2' cellspacing='0' ><tr><td align='center' colspan='5'>"

            If Me.logo_check.Checked = True Then
                Build_OperatingCosts = Build_OperatingCosts & get_company_images(real_make_model_name)
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<img src='" & location_string & "images/marketpdfheader.jpg' height='100'/></td></tr>"
            End If
            Build_OperatingCosts = Build_OperatingCosts & "<tr><td colspan='5' align='center'><b>" & real_make_model_name & "&nbsp;Operating Costs (" & Trim(sTitle) & ")</b></td></tr>"
            ' BEGINNING SECTION HERE PICTURE AND TITLE-----------------------------------------------------------------------------


            ' THIS IS BEGGINNING OF LEFT COLUMN -----------------------------------------------------------------------------
            Build_OperatingCosts = Build_OperatingCosts & "<tr>"
            Build_OperatingCosts = Build_OperatingCosts & "<td colspan='2' width='49%' align='left' class='Operating_Costs_TD_Top_1'>"

            ' THIS IS BEGGINNING OF LEFT COLUMN -----------------------------------------------------------------------------

            '   ------------------------------------------------------- THIS IS THE BEGGINING OF THE LEFT SIDE INFO -----------------------------------------------------------------
            ''''''''''''''''''''''''''''''''''''''''
            ' Starts the DIRECT COSTS PER HOUR 
            ''''''''''''''''''''''''''''''''''''''''
            '   Build_OperatingCosts = Build_OperatingCosts & "<td valign='top' align='left'>"
            Build_OperatingCosts = Build_OperatingCosts & "<table border='0' cellpadding='2' width='100%' cellspacing='0'><tr valign='top' align='center'><td align=left>" & vbCrLf
            Build_OperatingCosts = Build_OperatingCosts & "<b>DIRECT COSTS PER HOUR</b></td></tr><tr>"

            ' Build_OperatingCosts = Build_OperatingCosts & "<td></td>"


            ' Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf


            Build_OperatingCosts = Build_OperatingCosts & "<td align='left' width='50%'><u>Fuel</u></td>" & vbCrLf

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"



            If Session.Item("useMetricValues") Then

                If Not IsDBNull(localAdoRs("amod_fuel_gal_cost")) And CDbl(Session.Item("fuelPriceBase")) = 0 Then
                    If CDbl(localAdoRs("amod_fuel_gal_cost")) Then
                        fuelGalCost = ConvertUSToMetricValue("PPG", CDbl(localAdoRs("amod_fuel_gal_cost")))
                    End If
                Else
                    If CDbl(Session.Item("fuelPriceBase")) > 0 Then
                        fuelGalCost = ConvertUSToMetricValue("PPG", CDbl(Session.Item("fuelPriceBase")))
                    End If
                End If

                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    fuelGalCost = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), fuelGalCost)
                End If
                fuelGalCost = System.Math.Round(fuelGalCost, 2)

                fuelAddCost = ConvertUSToMetricValue("PPG", CDbl(localAdoRs("amod_fuel_add_cost")))
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    fuelAddCost = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), fuelAddCost)
                End If

                fuelAddCost = System.Math.Round(fuelAddCost, 2)


                fuelBurnRate = ConvertUSToMetricValue("GAL", CDbl(localAdoRs("amod_fuel_burn_rate")))

                fuelBurnRate = System.Math.Round(fuelBurnRate, 2)


                fuelTotCost = CDbl((fuelGalCost + fuelAddCost) * fuelBurnRate)


            Else

                If Not IsDBNull(localAdoRs("amod_fuel_gal_cost")) And CDbl(Session.Item("fuelPriceBase")) = 0 Then
                    If CDbl(localAdoRs("amod_fuel_gal_cost")) Then
                        fuelGalCost = CDbl(localAdoRs("amod_fuel_gal_cost"))
                    End If
                Else
                    If CDbl(Session.Item("fuelPriceBase")) > 0 Then
                        fuelGalCost = CDbl(Session.Item("fuelPriceBase"))
                    End If
                End If

                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    ' exchange rate should always be set ? why always change 
                    fuelGalCost = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), fuelGalCost)
                End If
                fuelGalCost = System.Math.Round(fuelGalCost, 2)



                If Not IsDBNull(localAdoRs("amod_fuel_add_cost")) Then
                    fuelAddCost = CDbl(localAdoRs("amod_fuel_add_cost"))
                Else
                    fuelAddCost = CDbl(0)
                End If

                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    fuelAddCost = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), fuelAddCost)
                End If
                fuelAddCost = System.Math.Round(fuelAddCost, 2)

                If Not IsDBNull(localAdoRs("amod_fuel_burn_rate")) Then
                    fuelBurnRate = CDbl(localAdoRs("amod_fuel_burn_rate"))
                Else
                    fuelBurnRate = CDbl(0)
                End If

                fuelBurnRate = System.Math.Round(fuelBurnRate, 2)

                fuelTotCost = (fuelGalCost + fuelAddCost) * fuelBurnRate

            End If




            fuelTotCost = System.Math.Round(fuelTotCost, 2)



            tmpCDblValue = fuelTotCost
            'If CDbl(Session.item("currencyExchangeRate")) > 0 Then
            'tmpCDblValue = ConvertUSToForeignCurrency(Session.item("currencyExchangeRate"), tmpCDblValue)
            ' End If

            If Not IsDBNull(localAdoRs("amod_fuel_tot_cost")) Then
                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'><font color='red'>" & sCurrencySymbol & FormatNumber(tmpCDblValue, 2, True, False, True) & "</font></td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'>&nbsp;</td>" & vbCrLf
            End If
            '   End If

            Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf


            ' when changing from metric to US standard all lables have to change
            If Session.Item("useMetricValues") Then
                Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;&nbsp;&nbsp;&nbsp;Fuel Cost Per " & TranslateUSMetricUnitsLong("GAL") & "</td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;&nbsp;&nbsp;&nbsp;Fuel Cost Per Gallon</td>" & vbCrLf
            End If

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"

            If Not IsDBNull(localAdoRs("amod_fuel_gal_cost")) And CDbl(Session.Item("fuelPriceBase")) = 0 Then
                If CDbl(localAdoRs("amod_fuel_gal_cost")) > 0 Then


                    'If Session.item("useMetricValues") Then
                    '  fuelGalCost = ConvertUSToMetricValue("PPG", CDbl(localAdoRs("amod_fuel_gal_cost")))
                    'Else
                    '  fuelGalCost = CDbl(localAdoRs("amod_fuel_gal_cost"))
                    'End If



                    If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                        fuelGalCost = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), fuelGalCost)
                        fuelGalCost = System.Math.Round(fuelGalCost, 2)
                    End If


                    Build_OperatingCosts = Build_OperatingCosts & "<td align='right'>" & sCurrencySymbol & FormatNumber(fuelGalCost, 2, True, False, True) & "</td>" & vbCrLf
                    ' ok update the excell report with our item and value
                    'Call UpdateExcelReport(rngDirectCosts, "FuelCost", fuelGalCost)
                Else
                    Build_OperatingCosts = Build_OperatingCosts & "<td align='right'>&nbsp;</td>" & vbCrLf
                    ' ok update the excell report with our item and value
                    'Call UpdateExcelReport(rngDirectCosts, "FuelCost", 0)
                End If
            Else
                If CDbl(Session.Item("fuelPriceBase")) > 0 Then
                    'If Session.item("useMetricValues") Then
                    '  fuelGalCost = ConvertUSToMetricValue("PPG", CDbl(Session.Item("fuelPriceBase")))
                    'Else
                    '  fuelGalCost = CDbl(Session.Item("fuelPriceBase"))
                    'End If
                    ' If CDbl(Session.item("currencyExchangeRate")) > 0 Then
                    'fuelGalCost = ConvertUSToForeignCurrency(Session.item("currencyExchangeRate"), fuelGalCost)
                    ' End If
                    Build_OperatingCosts = Build_OperatingCosts & "<td align='right'>" & sCurrencySymbol & FormatNumber(fuelGalCost, 2, True, False, True) & "</td>" & vbCrLf
                    ' ok update the excell report with our item and value
                    'Call UpdateExcelReport(rngDirectCosts, "FuelCost", fuelGalCost)
                Else
                    Build_OperatingCosts = Build_OperatingCosts & "<td align='right'>&nbsp;</td>" & vbCrLf
                    ' ok update the excell report with our item and value
                    'Call UpdateExcelReport(rngDirectCosts, "FuelCost", 0)
                End If
            End If


            Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf


            If Session.Item("useMetricValues") Then
                Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;&nbsp;&nbsp;&nbsp;Additive&nbsp;Cost&nbsp;Per&nbsp;" & TranslateUSMetricUnitsLong("GAL") & "</td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;&nbsp;&nbsp;&nbsp;Additive&nbsp;Cost&nbsp;Per&nbsp;Gallon</td>" & vbCrLf
            End If

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"

            If Not IsDBNull(localAdoRs("amod_fuel_add_cost")) Then
                'If Session.item("useMetricValues") Then
                '  fuelAddCost = ConvertUSToMetricValue("PPG", CDbl(localAdoRs("amod_fuel_add_cost")))
                'Else
                '  fuelAddCost = CDbl(localAdoRs("amod_fuel_add_cost"))
                'End If
                '  If CDbl(Session.item("currencyExchangeRate")) > 0 Then
                'fuelAddCost = ConvertUSToForeignCurrency(Session.item("currencyExchangeRate"), fuelAddCost)
                'End If
                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'>" & sCurrencySymbol & FormatNumber(fuelAddCost, 2, True, False, True) & "</td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'>&nbsp;</td>" & vbCrLf
            End If


            Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf

            If Session.Item("useMetricValues") Then
                Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;&nbsp;&nbsp;&nbsp;Burn Rate (" & TranslateUSMetricUnitsLong("GAL") & "s Per Hour)</td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;&nbsp;&nbsp;&nbsp;Burn Rate (Gallons Per Hour)</td>" & vbCrLf
            End If

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"

            If Not IsDBNull(localAdoRs("amod_fuel_burn_rate")) Then
                'If Session.item("useMetricValues") Then
                '  fuelBurnRate = ConvertUSToMetricValue("GAL", CDbl(localAdoRs("amod_fuel_burn_rate")))
                'Else
                '  fuelBurnRate = CDbl(localAdoRs("amod_fuel_burn_rate"))
                'End If
                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'>" & FormatNumber(fuelBurnRate, 2, True, False, True) & "</td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'>&nbsp;</td>" & vbCrLf
            End If


            Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf


            Build_OperatingCosts = Build_OperatingCosts & "<td><u>Maintenance</u></td>" & vbCrLf

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"





            If Not IsDBNull(localAdoRs("amod_maint_tot_cost")) Then


                totalmaintcost = System.Math.Round(CDbl(localAdoRs("amod_maint_lab_cost")), 2) + System.Math.Round(CDbl(localAdoRs("amod_maint_parts_cost")), 2)

                totalmaintcost = System.Math.Round(totalmaintcost, 2)

                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    totalmaintcost = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), totalmaintcost)
                    totalmaintcost = System.Math.Round(totalmaintcost, 2)
                End If

                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'><font color='red'>" & sCurrencySymbol & FormatNumber(totalmaintcost, 2, True, False, True) & "</font></td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'>&nbsp;</td>" & vbCrLf
            End If


            Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf


            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;&nbsp;&nbsp;&nbsp;Labor Cost Per Hour</td>" & vbCrLf

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"
            If Not IsDBNull(localAdoRs("amod_maint_lab_cost")) Then
                tmpCDblValue = System.Math.Round(CDbl(localAdoRs("amod_maint_lab_cost")), 2)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    tmpCDblValue = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), tmpCDblValue)
                    tmpCDblValue = System.Math.Round(tmpCDblValue, 2)
                End If

                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'>" & sCurrencySymbol & FormatNumber(tmpCDblValue, 2, True, False, True) & "</td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'>&nbsp;</td>" & vbCrLf
            End If

            Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf


            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;&nbsp;&nbsp;&nbsp;Parts Per Hour Cost</td>" & vbCrLf

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"

            If Not IsDBNull(localAdoRs("amod_maint_parts_cost")) Then
                tmpCDblValue = System.Math.Round(CDbl(localAdoRs("amod_maint_parts_cost")), 2)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    tmpCDblValue = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), tmpCDblValue)
                    tmpCDblValue = System.Math.Round(tmpCDblValue, 2)
                End If

                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'>" & sCurrencySymbol & FormatNumber(tmpCDblValue, 2, True, False, True) & "</td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'>&nbsp;</td>" & vbCrLf
            End If


            Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf


            Build_OperatingCosts = Build_OperatingCosts & "<td>Engine Overhaul</td>" & vbCrLf

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"
            If Not IsDBNull(localAdoRs("amod_engine_ovh_cost")) Then
                overhaulcost = System.Math.Round(CDbl(localAdoRs("amod_engine_ovh_cost")), 2)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    overhaulcost = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), overhaulcost)
                    overhaulcost = System.Math.Round(overhaulcost, 2)
                End If

                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'>" & sCurrencySymbol & FormatNumber(overhaulcost, 2, True, False, True) & "</td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'>&nbsp;</td>" & vbCrLf
            End If


            Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf


            Build_OperatingCosts = Build_OperatingCosts & "<td>Thrust Reverse Overhaul</td>" & vbCrLf


            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"
            If Not IsDBNull(localAdoRs("amod_thrust_rev_ovh_cost")) Then
                revoverhaulcost = System.Math.Round(CDbl(localAdoRs("amod_thrust_rev_ovh_cost")), 2)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    revoverhaulcost = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), revoverhaulcost)
                    revoverhaulcost = System.Math.Round(revoverhaulcost, 2)
                End If
                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'>" & sCurrencySymbol & FormatNumber(revoverhaulcost, 2, True, False, True) & "</td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'>&nbsp;</td>" & vbCrLf
            End If


            Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf


            Build_OperatingCosts = Build_OperatingCosts & "<td><u>Miscellaneous&nbsp;Flight&nbsp;Expenses</u></td>" & vbCrLf

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"
            If Not IsDBNull(localAdoRs("amod_misc_flight_cost")) Then

                'tmpCDblValue = CDbl(localAdoRs("amod_misc_flight_cost"))
                miscflightcosts = System.Math.Round(CDbl(localAdoRs("amod_land_park_cost")), 2) + System.Math.Round(CDbl(localAdoRs("amod_crew_exp_cost")), 2) + System.Math.Round(CDbl(localAdoRs("amod_supplies_cost")), 2)
                miscflightcosts = System.Math.Round(miscflightcosts, 2)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    miscflightcosts = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), miscflightcosts)
                    miscflightcosts = System.Math.Round(miscflightcosts, 2)
                End If
                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'><font color=red>" & sCurrencySymbol & FormatNumber(miscflightcosts, 2, True, False, True) & "</font></td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'>&nbsp;</td>" & vbCrLf
            End If


            Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf


            Build_OperatingCosts = Build_OperatingCosts & "<td> &nbsp;&nbsp;&nbsp;&nbsp;Landing-Parking Fee</td>" & vbCrLf

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"
            If Not IsDBNull(localAdoRs("amod_land_park_cost")) Then
                tmpCDblValue = System.Math.Round(CDbl(localAdoRs("amod_land_park_cost")), 2)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    tmpCDblValue = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), tmpCDblValue)
                    tmpCDblValue = System.Math.Round(tmpCDblValue, 2)
                End If
                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'>" & sCurrencySymbol & FormatNumber(tmpCDblValue, 2, True, False, True) & "</td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'>&nbsp;</td>" & vbCrLf
            End If


            Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf


            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;&nbsp;&nbsp;&nbsp;Crew Expenses</td>" & vbCrLf

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"

            If Not IsDBNull(localAdoRs("amod_crew_exp_cost")) Then
                tmpCDblValue = System.Math.Round(CDbl(localAdoRs("amod_crew_exp_cost")), 2)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    tmpCDblValue = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), tmpCDblValue)
                    tmpCDblValue = System.Math.Round(tmpCDblValue, 2)
                End If
                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'>" & sCurrencySymbol & FormatNumber(tmpCDblValue, 2, True, False, True) & "</td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'>&nbsp;</td>" & vbCrLf
            End If


            Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf


            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;&nbsp;&nbsp;&nbsp;Supplies-Catering</td>" & vbCrLf

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"

            If Not IsDBNull(localAdoRs("amod_supplies_cost")) Then
                tmpCDblValue = System.Math.Round(CDbl(localAdoRs("amod_supplies_cost")), 2)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    tmpCDblValue = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), tmpCDblValue)
                    tmpCDblValue = System.Math.Round(tmpCDblValue, 2)
                End If
                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'>" & sCurrencySymbol & FormatNumber(tmpCDblValue, 2, True, False, True) & "</td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'>&nbsp;</td>" & vbCrLf

            End If


            Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf


            Build_OperatingCosts = Build_OperatingCosts & "<td><b>Total Direct Costs</b></td>" & vbCrLf

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"
            ' THIS IS FOR TOTAL DIRECT COSTS
            If Not IsDBNull(localAdoRs("amod_tot_hour_direct_cost")) Then
                '  If Session.item("useMetricValues") Then
                ' totalDirCostHR = CDbl(fuelTotCost) + CDbl(amod_maint_tot_cost) + CDbl(amod_misc_flight_cost) + CDbl(amod_engine_ovh_cost) + CDbl(amod_thrust_rev_ovh_cost) 
                totalDirCostHR = System.Math.Round(CDbl(fuelTotCost), 2) + totalmaintcost + miscflightcosts + overhaulcost + revoverhaulcost

                'Else
                '  totalDirCostHR = CDbl(localAdoRs.Item("amod_tot_hour_direct_cost"))
                '  End If
                totalDirCostHR = System.Math.Round(totalDirCostHR, 2)
                tmpCDblValue = totalDirCostHR
                ' If CDbl(Session.item("currencyExchangeRate")) > 0 Then
                'tmpCDblValue = ConvertUSToForeignCurrency(Session.item("currencyExchangeRate"), tmpCDblValue)
                'End If
                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'><font color='red'>" & sCurrencySymbol & FormatNumber(tmpCDblValue, 2, True, False, True) & "</font></td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'>&nbsp;</td>" & vbCrLf
            End If


            Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf


            If Session.Item("useMetricValues") Then
                Build_OperatingCosts = Build_OperatingCosts & "<td><br>Block&nbsp;Speed&nbsp;" & TranslateUSMetricUnitsLong("SM") & "s&nbsp;Per&nbsp;Hour</td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td><br>Block&nbsp;Speed&nbsp;Statute&nbsp;Miles&nbsp;Per&nbsp;Hour</td>" & vbCrLf
            End If

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"

            If Not IsDBNull(localAdoRs("amod_avg_block_speed")) Then
                If Session.Item("useMetricValues") Then
                    avgBlockSpeed = System.Math.Round(ConvertUSToMetricValue("SM", CDbl(localAdoRs("amod_avg_block_speed"))), 0)
                Else
                    avgBlockSpeed = System.Math.Round(CDbl(localAdoRs("amod_avg_block_speed")), 0)
                End If
                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'><br>" & FormatNumber(avgBlockSpeed, 0, True, False, True) & "</td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'>&nbsp;</td>" & vbCrLf
            End If


            Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf


            If Session.Item("useMetricValues") Then
                Build_OperatingCosts = Build_OperatingCosts & "<td>Total Cost Per " & TranslateUSMetricUnitsLong("SM") & "</td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td>Total Cost Per Statute Mile</td>" & vbCrLf
            End If

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"
            If Session.Item("useMetricValues") Then
                totalCostPer = CDbl(CDbl(totalDirCostHR) / CDbl(avgBlockSpeed))
            Else
                totalCostPer = CDbl(CDbl(totalDirCostHR) / CDbl(avgBlockSpeed))
                'totalCostPer = CDbl(localAdoRs("amod_tot_stat_mile_cost"))
            End If
            totalCostPer = System.Math.Round(totalCostPer, 2)
            tmpCDblValue = totalCostPer
            ' If CDbl(Session.item("currencyExchangeRate")) > 0 Then
            'tmpCDblValue = ConvertUSToForeignCurrency(Session.item("currencyExchangeRate"), tmpCDblValue)
            '  End If

            If Not IsDBNull(localAdoRs("amod_tot_stat_mile_cost")) Then
                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'><font color='red'>" & sCurrencySymbol & FormatNumber(tmpCDblValue, 2, True, False, True) & "</font></td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'>&nbsp;</td>" & vbCrLf
            End If


            Build_OperatingCosts = Build_OperatingCosts & "</tr>" & vbCrLf
            '  Build_OperatingCosts = Build_OperatingCosts & "</table><br>"




            ' Build_OperatingCosts = Build_OperatingCosts & "<tr><td>&nbsp;</td></tr>"
            ''''''''''''''''''''''''''''''''''''''''''
            ' End DIRECT COSTS PER HOUR 
            '''''''''''''''''''''''''''''''''''''''''
            ''''''''''''''''''''''''''''''''''''''''''
            ' End DIRECT COSTS PER HOUR 
            '''''''''''''''''''''''''''''''''''''''''
            ''''''''''''''''''''''''''''''''''''''''''
            ' End DIRECT COSTS PER HOUR 
            '''''''''''''''''''''''''''''''''''''''''































            ''''''''''''''''''''''''''''''''''''''''''
            ' START OF SECTION SECTION ON LEFT 
            '''''''''''''''''''''''''''''''''''''''''

            bFirstOne = False

            'Loop
            bFirstOne = True
            '''''''''''''''''''''''
            ' Start ANNUAL BUDGET 
            '''''''''''''''''''''''

            bFirstOne = True
            ' EXTRA QUERY TAKEN OUT RTW/MSW 8/23
            bFirstOne = True
            nCount = 3

            ' Build_OperatingCosts = Build_OperatingCosts & "<td valign=top align=left rowspan='3' class='Operating_Costs_TD_Bottom'>"


            bFirstOne = False


            '''''''''''''''''''''
            ' End Annual Budge
            '''''''''''''''''''''

            Build_OperatingCosts = Build_OperatingCosts & "<tr><td align='left' width='50%'><b>ANNUAL FIXED COSTS</b></td></tr><tr>"
            ' EXTRA QUERY TAKEN OUT RTW/MSW 8/23
            bFirstOne = True
            nCount = 3


            'Build_OperatingCosts = Build_OperatingCosts & "<td valign='top' align='left' class='Operating_Costs_TD_Bottom'>"
            '  Build_OperatingCosts = Build_OperatingCosts & "<td width='50%' colspan='3'><table border='0' cellpadding='2' cellspacing='0'><tr>" & vbCrLf


            'Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"


            '   Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf


            Build_OperatingCosts = Build_OperatingCosts & "<td width='50%'><u>Crew Salaries</u></td>" & vbCrLf

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"
            If Not IsDBNull(localAdoRs("amod_tot_crew_salary_cost")) Then



                'Dim crewsalaries = 0

                crewsalaries = System.Math.Round(CDbl(localAdoRs("amod_capt_salary_cost")), 0) + System.Math.Round(CDbl(localAdoRs("amod_cpilot_salary_cost")), 0) + System.Math.Round(CDbl(localAdoRs("amod_crew_benefit_cost")), 0)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    crewsalaries = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), crewsalaries)
                    crewsalaries = System.Math.Round(crewsalaries, 0)
                End If

                crewsalaries = System.Math.Round(crewsalaries, 0)
                Build_OperatingCosts = Build_OperatingCosts & "<td align=right><font color=red>" & sCurrencySymbol & FormatNumber(crewsalaries, 0, True, False, True) & "</font></td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td align=right>&nbsp;</td>" & vbCrLf
            End If


            Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;&nbsp;&nbsp;&nbsp;Capt. Salary</td>" & vbCrLf

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"
            If Not IsDBNull(localAdoRs("amod_capt_salary_cost")) Then
                tmpCDblValue = System.Math.Round(CDbl(localAdoRs("amod_capt_salary_cost")), 0)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    tmpCDblValue = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), tmpCDblValue)
                    tmpCDblValue = System.Math.Round(tmpCDblValue, 0)
                End If
                Build_OperatingCosts = Build_OperatingCosts & "<td align=right>" & sCurrencySymbol & FormatNumber(tmpCDblValue, 0, True, False, True) & "</td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td align=right>&nbsp;</td>" & vbCrLf
            End If


            Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf


            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;&nbsp;&nbsp;&nbsp;Co-pilot Salary</td>" & vbCrLf

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"
            If Not IsDBNull(localAdoRs("amod_cpilot_salary_cost")) Then
                tmpCDblValue = System.Math.Round(CDbl(localAdoRs("amod_cpilot_salary_cost")), 0)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    tmpCDblValue = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), tmpCDblValue)
                    tmpCDblValue = System.Math.Round(tmpCDblValue, 0)
                End If
                Build_OperatingCosts = Build_OperatingCosts & "<td align=right>" & sCurrencySymbol & FormatNumber(tmpCDblValue, 0, True, False, True) & "</td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td align=right>&nbsp;</td>" & vbCrLf
            End If

            Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf


            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;&nbsp;&nbsp;&nbsp;Benefits</td>" & vbCrLf

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"
            If Not IsDBNull(localAdoRs("amod_crew_benefit_cost")) Then
                tmpCDblValue = System.Math.Round(CDbl(localAdoRs("amod_crew_benefit_cost")), 0)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    tmpCDblValue = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), tmpCDblValue)
                    tmpCDblValue = System.Math.Round(tmpCDblValue, 0)
                End If
                Build_OperatingCosts = Build_OperatingCosts & "<td align=right>" & sCurrencySymbol & FormatNumber(tmpCDblValue, 0, True, False, True) & "</td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td align=right>&nbsp;</td>" & vbCrLf
            End If

            Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf


            Build_OperatingCosts = Build_OperatingCosts & "<td>Hangar Cost</td>" & vbCrLf

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"
            If Not IsDBNull(localAdoRs("amod_hangar_cost")) Then
                'Dim hangercost = 0

                hangercost = System.Math.Round(CDbl(localAdoRs("amod_hangar_cost")), 0)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    hangercost = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), hangercost)
                End If
                hangercost = System.Math.Round(hangercost, 0)

                Build_OperatingCosts = Build_OperatingCosts & "<td align=right>" & sCurrencySymbol & FormatNumber(hangercost, 0, True, False, True) & "</td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td align=right>&nbsp;</td>" & vbCrLf
            End If

            Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf


            Build_OperatingCosts = Build_OperatingCosts & "<td><u>Insurance</u></td>" & vbCrLf

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"
            If Not IsDBNull(localAdoRs("amod_insurance_cost")) Then
                insurancecost = System.Math.Round(CDbl(localAdoRs("amod_hull_insurance_cost")), 0) + System.Math.Round(CDbl(localAdoRs("amod_liability_insurance_cost")), 0)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    insurancecost = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), insurancecost)
                End If
                insurancecost = System.Math.Round(insurancecost, 0)
                Build_OperatingCosts = Build_OperatingCosts & "<td align=right><font color=red>" & sCurrencySymbol & FormatNumber(insurancecost, 0, True, False, True) & "</font></td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td align=right>&nbsp;</td>" & vbCrLf
            End If

            Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf


            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;&nbsp;&nbsp;&nbsp;Hull</td>" & vbCrLf

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"
            If Not IsDBNull(localAdoRs("amod_hull_insurance_cost")) Then
                tmpCDblValue = System.Math.Round(CDbl(localAdoRs("amod_hull_insurance_cost")), 0)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    tmpCDblValue = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), tmpCDblValue)
                    tmpCDblValue = System.Math.Round(tmpCDblValue, 0)
                End If
                Build_OperatingCosts = Build_OperatingCosts & "<td align=right>" & sCurrencySymbol & FormatNumber(tmpCDblValue, 0, True, False, True) & "</td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td align=right>&nbsp;</td>" & vbCrLf
            End If

            Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf


            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;&nbsp;&nbsp;&nbsp;Legal Liability</td>" & vbCrLf

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"
            If Not IsDBNull(localAdoRs("amod_liability_insurance_cost")) Then
                tmpCDblValue = System.Math.Round(CDbl(localAdoRs("amod_liability_insurance_cost")), 0)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    tmpCDblValue = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), tmpCDblValue)
                End If
                Build_OperatingCosts = Build_OperatingCosts & "<td align=right>" & sCurrencySymbol & FormatNumber(tmpCDblValue, 0, True, False, True) & "</td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td align=right>&nbsp;</td>" & vbCrLf
            End If

            Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf


            Build_OperatingCosts = Build_OperatingCosts & "<td><u>Misc. Overhead</u></td>" & vbCrLf

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"
            If Not IsDBNull(localAdoRs("amod_tot_misc_ovh_cost")) Then
                'Dim miscoverhead = 0
                miscoverhead = System.Math.Round(CDbl(localAdoRs("amod_misc_train_cost")), 0) + System.Math.Round(CDbl(localAdoRs("amod_misc_modern_cost")), 0) + System.Math.Round(CDbl(localAdoRs("amod_misc_naveq_cost")), 0)

                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    miscoverhead = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), miscoverhead)
                    miscoverhead = System.Math.Round(miscoverhead, 0)
                End If


                Build_OperatingCosts = Build_OperatingCosts & "<td align=right><font color=red>" & sCurrencySymbol & FormatNumber(miscoverhead, 0, True, False, True) & "</font></td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td align=right>&nbsp;</td>" & vbCrLf
            End If

            Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf


            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;&nbsp;&nbsp;&nbsp;Training</td>" & vbCrLf

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"
            If Not IsDBNull(localAdoRs("amod_misc_train_cost")) Then
                tmpCDblValue = System.Math.Round(CDbl(localAdoRs("amod_misc_train_cost")), 0)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    tmpCDblValue = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), tmpCDblValue)
                    tmpCDblValue = System.Math.Round(tmpCDblValue, 0)
                End If
                Build_OperatingCosts = Build_OperatingCosts & "<td align=right>" & sCurrencySymbol & FormatNumber(tmpCDblValue, 0, True, False, True) & "</td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td align=right>&nbsp;</td>" & vbCrLf
            End If

            Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf


            Build_OperatingCosts = Build_OperatingCosts & "<td> &nbsp;&nbsp;&nbsp;&nbsp;Modernization</td>" & vbCrLf

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"
            If Not IsDBNull(localAdoRs("amod_misc_modern_cost")) Then
                tmpCDblValue = System.Math.Round(CDbl(localAdoRs("amod_misc_modern_cost")), 0)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    tmpCDblValue = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), tmpCDblValue)
                    tmpCDblValue = System.Math.Round(tmpCDblValue, 0)
                End If
                Build_OperatingCosts = Build_OperatingCosts & "<td align=right>" & sCurrencySymbol & FormatNumber(tmpCDblValue, 0, True, False, True) & "</td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td align=right>&nbsp;</td>" & vbCrLf
            End If

            Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf


            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;&nbsp;&nbsp;&nbsp;Nav. Equipment</td>" & vbCrLf

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"
            If Not IsDBNull(localAdoRs("amod_misc_naveq_cost")) Then
                tmpCDblValue = System.Math.Round(CDbl(localAdoRs("amod_misc_naveq_cost")), 0)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    tmpCDblValue = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), tmpCDblValue)
                    tmpCDblValue = System.Math.Round(tmpCDblValue, 0)
                End If
                Build_OperatingCosts = Build_OperatingCosts & "<td align=right>" & sCurrencySymbol & FormatNumber(tmpCDblValue, 0, True, False, True) & "</td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td align=right>&nbsp;</td>" & vbCrLf
            End If

            Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf


            Build_OperatingCosts = Build_OperatingCosts & "<td>Depreciation</td>" & vbCrLf

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"
            If Not IsDBNull(localAdoRs("amod_deprec_cost")) Then
                'Dim depoverhead = 0
                depoverhead = System.Math.Round(CDbl(localAdoRs("amod_deprec_cost")), 0)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    depoverhead = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), depoverhead)
                End If
                depoverhead = System.Math.Round(depoverhead, 0)

                Build_OperatingCosts = Build_OperatingCosts & "<td align=right>" & sCurrencySymbol & FormatNumber(depoverhead, 0, True, False, True) & "</td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td align=right>&nbsp;</td>" & vbCrLf
            End If

            Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf


            Build_OperatingCosts = Build_OperatingCosts & "<td><b>Total Fixed Costs</b></td>" & vbCrLf

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"
            If Not IsDBNull(localAdoRs("amod_tot_fixed_cost")) Then

                totalfixedcost = crewsalaries + hangercost + miscoverhead + depoverhead + insurancecost

                totalfixedcost = System.Math.Round(totalfixedcost, 0)


                '   If CDbl(Session.item("currencyExchangeRate")) > 0 Then
                'tmpCDblValue = ConvertUSToForeignCurrency(Session.item("currencyExchangeRate"), tmpCDblValue)
                ' End If
                Build_OperatingCosts = Build_OperatingCosts & "<td align=right><font color=red>" & sCurrencySymbol & FormatNumber(totalfixedcost, 0, True, False, True) & "</font></td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td align=right>&nbsp;</td>" & vbCrLf
            End If



            Build_OperatingCosts = Build_OperatingCosts & "</tr></table>"
            '  Build_OperatingCosts = Build_OperatingCosts & "</td></tr></table>"
            '   ------------------------------------------------------- THIS IS THE END OF THE LEFT SIDE INFO -----------------------------------------------------------------
            '   ------------------------------------------------------- THIS IS THE END OF THE LEFT SIDE INFO -----------------------------------------------------------------
            '   ------------------------------------------------------- THIS IS THE END OF THE LEFT SIDE INFO -----------------------------------------------------------------























            Build_OperatingCosts = Build_OperatingCosts & "</td>"
            ' THIS IS THE MIDDLE COLUMN -------------------------------------------------------------------
            Build_OperatingCosts = Build_OperatingCosts & "<td width='1' rowspan='2' class='Operating_Costs_TD_Top_2'>&nbsp;</td>"
            ' THIS IS THE MIDDLE COLUMN -------------------------------------------------------------------







            ' THIS IS BEGGINNING OF RIGHT COLUMN ----------------------------------------------------------------------------
            Build_OperatingCosts = Build_OperatingCosts & "<td colspan='2' align='left'  width='49%' class='Operating_Costs_TD_Top_3' valign='top'>"
            ' THIS IS BEGGINNING OF RIGHT COLUMN -----------------------------------------------------------------------------


            Build_OperatingCosts = Build_OperatingCosts & "<table border=0 cellpadding=2 cellspacing=0 width='100%'><tr>" & vbCrLf


            ' Build_OperatingCosts = Build_OperatingCosts & "<td></td>"

            Build_OperatingCosts = Build_OperatingCosts & "<td><br />&nbsp;&nbsp;<b>ANNUAL&nbsp;BUDGET</b></td></tr><tr>" & vbCrLf


            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;&nbsp;&nbsp;&nbsp;Number of Seats</td>" & vbCrLf

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"
            If Not IsDBNull(localAdoRs("amod_number_of_seats")) Then
                Build_OperatingCosts = Build_OperatingCosts & "<td align=right>" & FormatNumber(System.Math.Round(CDbl(localAdoRs("amod_number_of_seats")), 0), 0, True, False, True) & "</td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td align=right>&nbsp;</td>" & vbCrLf
            End If

            Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf


            If Session.Item("useMetricValues") Then
                Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;&nbsp;&nbsp;&nbsp;" & TranslateUSMetricUnitsLong("M") & "s</td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;&nbsp;&nbsp;&nbsp;Miles</td>" & vbCrLf
            End If

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"
            If Not IsDBNull(localAdoRs("amod_annual_miles")) Then
                If Session.Item("useMetricValues") Then
                    annualMiles = ConvertUSToMetricValue("M", CDbl(localAdoRs("amod_annual_miles")))
                Else
                    annualMiles = CDbl(localAdoRs("amod_annual_miles"))
                End If
                annualMiles = System.Math.Round(annualMiles, 0)
                Build_OperatingCosts = Build_OperatingCosts & "<td align=right>" & FormatNumber(annualMiles, 0, True, False, True) & "</td>" & vbCrLf
            Else
                Response.Write("<td align=right>&nbsp;</td>" & vbCrLf)
            End If

            Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf


            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;&nbsp;&nbsp;&nbsp;Hours</td>" & vbCrLf

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"
            If Not IsDBNull(localAdoRs("amod_annual_hours")) Then
                'If Session.item("useMetricValues") Then
                ' annualHrs = Round(CDbl(annualMiles) / CDbl(avgBlockSpeed), 0)
                '  annualHrs = CDbl(localAdoRs("amod_annual_hours"))
                '   annualHrs = CDbl(annualMiles) / CDbl(avgBlockSpeed)
                ' Else
                annualHrs = CDbl(annualMiles) / CDbl(avgBlockSpeed)
                ' End If
                annualHrs = System.Math.Round(annualHrs, 0)

                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'><font color='red'>" & FormatNumber(annualHrs, 0, True, False, True) & "</font></td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'>&nbsp;</td>" & vbCrLf
            End If


            Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf
            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>" & vbCrLf
            Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf


            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;&nbsp;<b>Total Direct Costs</b></td>" & vbCrLf

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"
            If Not IsDBNull(localAdoRs("amod_tot_direct_cost")) Then


                ' CALCULATING EITHER WAY FOR ACCURATE VALUES
                ' If Not Session.item("useMetricValues") Then
                'totalDirCostYR = annualHrs * totalDirCostHR
                ' Else
                totalDirCostYR = annualHrs * totalDirCostHR
                '  End If


                totalDirCostYR = System.Math.Round(totalDirCostYR, 0)
                tmpCDblValue = totalDirCostYR
                ' If CDbl(Session.item("currencyExchangeRate")) > 0 Then
                'tmpCDblValue = ConvertUSToForeignCurrency(Session.item("currencyExchangeRate"), tmpCDblValue)
                ' End If
                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'><font color='red'>" & sCurrencySymbol & FormatNumber(tmpCDblValue, 0, True, False, True) & "</font></td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'>&nbsp;</td>" & vbCrLf
            End If

            Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf


            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;&nbsp;<b>Total Fixed Costs</b></td>" & vbCrLf

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"
            If Not IsDBNull(localAdoRs("amod_tot_fixed_cost")) Then
                'tmpCDblValue = System.Math.Round(CDbl(localAdoRs("amod_tot_fixed_cost")), 0)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    tmpCDblValue = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), tmpCDblValue)
                End If
                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'><font color='red'>" & sCurrencySymbol & FormatNumber(totalfixedcost, 0, True, False, True) & "</font></td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'>&nbsp;</td>" & vbCrLf
            End If

            Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf


            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;&nbsp;<b><u>Total Cost (Fixed & Direct)</u></b></td>" & vbCrLf

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"
            If Not IsDBNull(localAdoRs("amod_tot_df_annual_cost")) Then
                'If Session.item("useMetricValues") Then
                ' totalFixedDirect = CDbl(CDbl(totalDirCostYR) + CDbl(localAdoRs("amod_tot_fixed_cost")))
                totalFixedDirect = totalDirCostYR + totalfixedcost

                'Else
                ' totalFixedDirect = CDbl(CDbl(totalDirCostYR) + CDbl(localAdoRs("amod_tot_fixed_cost")))
                'totalFixedDirect = CDbl(localAdoRs("amod_tot_df_annual_cost"))
                ' CALCULATING EITHER WAY FOR MORE ACCURATE
                ' End If
                tmpCDblValue = totalFixedDirect
                'If CDbl(Session.item("currencyExchangeRate")) > 0 Then
                'tmpCDblValue = ConvertUSToForeignCurrency(Session.item("currencyExchangeRate"), tmpCDblValue)
                ' End If
                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'><font color='red'>" & sCurrencySymbol & FormatNumber(tmpCDblValue, 0, True, False, True) & "</font></td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td align=right>&nbsp;</td>" & vbCrLf
            End If

            Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf


            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;&nbsp;&nbsp;&nbsp;Cost/Hour</td>" & vbCrLf

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"
            If Not IsDBNull(localAdoRs("amod_tot_df_hour_cost")) Then
                If Session.Item("useMetricValues") Then
                    ' dfhourcost = dCDbl(CDbl(totalFixedDirect) / CDbl(annualHrs))
                    dfhourcost = totalFixedDirect / annualHrs
                Else
                    dfhourcost = totalFixedDirect / annualHrs
                    '  dfhourcost = CDbl(localAdoRs("amod_tot_df_hour_cost"))
                    ' CALCULATING EITHER WAY FOR MORE ACCURATE
                End If

                dfhourcost = System.Math.Round(dfhourcost, 0)
                tmpCDblValue = dfhourcost
                '  If CDbl(Session.item("currencyExchangeRate")) > 0 Then
                '      tmpCDblValue = ConvertUSToForeignCurrency(Session.item("currencyExchangeRate"), tmpCDblValue)
                'End If
                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'><font color='red'>" & sCurrencySymbol & FormatNumber(tmpCDblValue, 0, True, False, True) & "</font></td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td align=right>&nbsp;</td>" & vbCrLf
            End If

            Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf


            If Session.Item("useMetricValues") Then
                Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;&nbsp;&nbsp;&nbsp;Cost/" & TranslateUSMetricUnitsLong("SM") & "</td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;&nbsp;&nbsp;&nbsp;Cost/Statute Mile</td>" & vbCrLf
            End If

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"
            If Not IsDBNull(localAdoRs("amod_tot_df_statmile_cost")) Then
                If Session.Item("useMetricValues") Then
                    'dfstatmilecost = CDbl(CDbl(totalFixedDirect) / CDbl(annualMiles))
                    dfstatmilecost = totalFixedDirect / annualMiles
                Else
                    dfstatmilecost = totalFixedDirect / annualMiles
                    ' dfstatmilecost = CDbl(localAdoRs("amod_tot_df_statmile_cost"))
                End If
                dfstatmilecost = System.Math.Round(dfstatmilecost, 2)
                tmpCDblValue = dfstatmilecost
                '  If CDbl(Session.item("currencyExchangeRate")) > 0 Then
                'tmpCDblValue = ConvertUSToForeignCurrency(Session.item("currencyExchangeRate"), tmpCDblValue)
                '    End If
                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'><font color='red'>" & sCurrencySymbol & FormatNumber(tmpCDblValue, 2, True, False, True) & "</font></td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td align=right>&nbsp;</td>" & vbCrLf
            End If

            Build_OperatingCosts = Build_OperatingCosts & "  </tr><tr>" & vbCrLf


            If Session.Item("useMetricValues") Then
                Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;&nbsp;&nbsp;&nbsp;Cost/Seat " & TranslateUSMetricUnitsLong("M") & "</td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;&nbsp;&nbsp;&nbsp;Cost/Seat Mile</td>" & vbCrLf
            End If

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"
            If Not IsDBNull(localAdoRs("amod_tot_df_seat_cost")) Then
                '  If Session.item("useMetricValues") Then
                ' dfseatcost = CDbl(CDbl(dfstatmilecost) / CDbl(localAdoRs("amod_number_of_seats")))
                dfseatcost = dfstatmilecost / System.Math.Round(localAdoRs("amod_number_of_seats"), 0)
                ' Else
                '  dfseatcost = dfstatmilecost / CDbl(localAdoRs("amod_number_of_seats")))
                ' dfseatcost = CDbl(localAdoRs("amod_tot_df_seat_cost"))
                'End If
                dfseatcost = System.Math.Round(dfseatcost, 2)
                tmpCDblValue = dfseatcost
                '    If CDbl(Session.item("currencyExchangeRate")) > 0 Then
                'tmpCDblValue = ConvertUSToForeignCurrency(Session.item("currencyExchangeRate"), tmpCDblValue)
                '   End If
                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'><font color='red'>" & sCurrencySymbol & FormatNumber(tmpCDblValue, 2, True, False, True) & "</font></td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td align=right>&nbsp;</td>" & vbCrLf
            End If


            Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf
            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>" & vbCrLf
            Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf


            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;&nbsp;<b><u>Total Cost (No Depreciation)</u></b></td>" & vbCrLf

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"

            'If Session.item("useMetricValues") Then
            TCND = totalFixedDirect - depoverhead
            ' Else
            'TCND = CDbl(CDbl(localAdoRs("amod_tot_df_annual_cost")) - CDbl(localAdoRs("amod_deprec_cost")))
            'End If
            TCND = System.Math.Round(TCND, 0)
            tmpCDblValue = TCND
            '     If CDbl(Session.item("currencyExchangeRate")) > 0 Then
            'tmpCDblValue = ConvertUSToForeignCurrency(Session.item("currencyExchangeRate"), tmpCDblValue)
            '    End If

            If tmpCDblValue > 0 Then
                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'><font color='red'>" & sCurrencySymbol & FormatNumber(tmpCDblValue, 0, True, False, True) & "</font></td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'><font color='red'>" & sCurrencySymbol & "0.00</font></td>" & vbCrLf
            End If

            Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf


            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;&nbsp;&nbsp;&nbsp;Cost/Hour</td>" & vbCrLf

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"
            If Not IsDBNull(localAdoRs("amod_annual_hours")) Then
                If localAdoRs("amod_annual_hours") > 0 Then
                    ' If Session.item("useMetricValues") Then


                    ANCH = TCND / annualHrs
                    ' THIS IS CALCULATING THE TOTAL 

                    'Else
                    '  ANCH = CDbl(CDbl(TCND) / CDbl(localAdoRs("amod_annual_hours")))

                    ' End If
                    ANCH = System.Math.Round(ANCH, 0)
                    tmpCDblValue = ANCH
                    '   If CDbl(Session.item("currencyExchangeRate")) > 0 Then
                    'tmpCDblValue = ConvertUSToForeignCurrency(Session.item("currencyExchangeRate"), tmpCDblValue)
                    '   End If

                    Build_OperatingCosts = Build_OperatingCosts & "<td align='right'><font color='red'>" & sCurrencySymbol & FormatNumber(tmpCDblValue, 0, True, False, True) & "</font></td>" & vbCrLf
                Else
                    Build_OperatingCosts = Build_OperatingCosts & "<td align='right'><font color='red'>" & sCurrencySymbol & "0.00</font></td>" & vbCrLf
                End If
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'><font color='red'>" & sCurrencySymbol & "0.00</font></td>" & vbCrLf
            End If

            Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf


            If Session.Item("useMetricValues") Then
                Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;&nbsp;&nbsp;&nbsp;Cost/" & TranslateUSMetricUnitsLong("SM") & "</td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;&nbsp;&nbsp;&nbsp;Cost/Statute Mile</td>" & vbCrLf
            End If

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"

            If Not IsDBNull(localAdoRs("amod_annual_miles")) Then
                If localAdoRs("amod_annual_miles") > 0 Then
                    ' If Session.item("useMetricValues") Then
                    TCSM = TCND / annualMiles
                    'Else
                    '  TCSM = CDbl(CDbl(TCND) / CDbl(localAdoRs("amod_annual_miles")))
                    ' End If
                    TCSM = System.Math.Round(TCSM, 3)
                    tmpCDblValue = TCSM
                    ' If CDbl(Session.item("currencyExchangeRate")) > 0 Then
                    'tmpCDblValue = ConvertUSToForeignCurrency(Session.item("currencyExchangeRate"), tmpCDblValue)
                    '  End If

                    Build_OperatingCosts = Build_OperatingCosts & "<td align='right'><font color='red'>" & sCurrencySymbol & FormatNumber(tmpCDblValue, 2, True, False, True) & "</font></td>" & vbCrLf
                Else
                    Build_OperatingCosts = Build_OperatingCosts & "<td align='right'><font color='red'>" & sCurrencySymbol & "0.00</font></td>" & vbCrLf
                End If
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'><font color='red'>" & sCurrencySymbol & "0.00</font></td>" & vbCrLf
            End If

            Build_OperatingCosts = Build_OperatingCosts & "</tr><tr>" & vbCrLf


            If Session.Item("useMetricValues") Then
                Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;&nbsp;&nbsp;&nbsp;Cost/Seat " & TranslateUSMetricUnitsLong("M") & "</td>" & vbCrLf
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;&nbsp;&nbsp;&nbsp;Cost/Seat Mile</td>" & vbCrLf
            End If

            Build_OperatingCosts = Build_OperatingCosts & "<td>&nbsp;</td>"

            If Not IsDBNull(localAdoRs("amod_number_of_seats")) Then
                If localAdoRs("amod_number_of_seats") > 0 Then
                    TCST = TCSM / System.Math.Round(localAdoRs("amod_number_of_seats"), 0)
                    TCST = System.Math.Round(TCST, 2)
                    tmpCDblValue = TCST
                    '  If CDbl(Session.item("currencyExchangeRate")) > 0 Then
                    'tmpCDblValue = ConvertUSToForeignCurrency(Session.item("currencyExchangeRate"), tmpCDblValue)
                    '  End If
                    Build_OperatingCosts = Build_OperatingCosts & "<td align='right'><font color='red'>" & sCurrencySymbol & FormatNumber(tmpCDblValue, 2, True, False, True) & "</font></td>" & vbCrLf
                Else
                    Build_OperatingCosts = Build_OperatingCosts & "<td align='right'><font color='red'>" & sCurrencySymbol & "0.00</font></td>" & vbCrLf
                End If
            Else
                Build_OperatingCosts = Build_OperatingCosts & "<td align='right'><font color='red'>" & sCurrencySymbol & "0.00</font></td>" & vbCrLf
            End If


            Build_OperatingCosts = Build_OperatingCosts & "  </tr>" & vbCrLf

            'close annual budget table
            Build_OperatingCosts = Build_OperatingCosts & "</table></td>" & vbCrLf

            ' THIS ENDS THE INITIAL ROW CONTAINING ALL INFO AND THEN STARTS NEW ROW-------------------------------------------------------
            Build_OperatingCosts = Build_OperatingCosts & "</tr>"
            Build_OperatingCosts = Build_OperatingCosts & "<tr>"
            '-----------------------------------------------------------------------------------------------------------------------------

            ' THIS IS THE LAST COLUMN -------------------------------------------------------------------
            Build_OperatingCosts = Build_OperatingCosts & "<td colspan='5' class='Operating_Costs_TD_Bottom'>&nbsp;</td></tr></table>"
            'Build_OperatingCosts = Build_OperatingCosts & "<td colspan='5' class='Operating_Costs_TD_Top_1'>&nbsp;</td></tr></table>"
            ' THIS IS THE LAST COLUMN -------------------------------------------------------------------

            bFirstOne = False


        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Build_OperatingCosts: " & ex.Message
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function
    Public Function New_Build_PerformanceSpecifications(ByVal bisReport As Boolean, ByVal optFormat As String, ByVal bHasManyAirFrames As Boolean, ByVal sAirframeType As String, ByRef foot_space_Performance_Specs As String, ByVal amod_id As Integer) As String
        New_Build_PerformanceSpecifications = ""

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim l_AdoRs As System.Data.SqlClient.SqlDataReader : l_AdoRs = Nothing
        Dim bIsFirstTime As Boolean = True
        Dim Query As String : Query = ""
        Try
            'Select Case Application.Item("webHostObject").evoWebHostType
            'Case eWebSiteTypes.LOCAL
            'SqlConn.ConnectionString = My.Settings.DEFAULT_LOCAL_MSSQL
            'Case Else
            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            ' End Select

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            Query = "SELECT * FROM Aircraft_Model WITH(NOLOCK) WHERE amod_id = " + amod_id.ToString



            If Not localCriteria.ViewCriteriaHasHelicopterFlag And Not localCriteria.ViewCriteriaHasBusinessFlag And Not localCriteria.ViewCriteriaHasCommercialFlag And localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_NONE Then
                localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_ALL ' use subscribers product code(s) for queries
            ElseIf localCriteria.ViewCriteriaHasHelicopterFlag And localCriteria.ViewCriteriaHasBusinessFlag And localCriteria.ViewCriteriaHasCommercialFlag And localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_NONE Then
                localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_ALL ' use subscribers product code(s) for queries
            End If

            If localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_ALL Then
                Query = Query & "  " + commonEvo.GenerateProductCodeSelectionQuery(HttpContext.Current.Session.Item("localPreferences"), False, True)
            Else
                Query = Query & "  " + commonEvo.BuildProductCodeCheckWhereClause(localCriteria.ViewCriteriaHasHelicopterFlag, localCriteria.ViewCriteriaHasBusinessFlag, localCriteria.ViewCriteriaHasCommercialFlag, False, False, False, True)
            End If



            SqlCommand.CommandText = Query

            Dim l_objBuilder As New StringBuilder
            Dim nNumberOfEngines As Integer = 0
            Dim nRememberModelID As Long = 0
            Dim nMAXEngines As Long = 0

            l_AdoRs = SqlCommand.ExecuteReader()
            Dim iLoop
            iLoop = 0
            l_AdoRs.Read()
            New_Build_PerformanceSpecifications = ""
            If CInt(l_AdoRs.Item("amod_id")) <> CInt(nRememberModelID) Then
                nNumberOfEngines = l_AdoRs.Item("amod_number_of_engines")
            End If
            If nMAXEngines < nNumberOfEngines Then
                nMAXEngines = nNumberOfEngines
            End If

            If Trim(l_AdoRs.Item("amod_airframe_type_code")) <> "" Then
                sAirframeType = l_AdoRs.Item("amod_airframe_type_code")
            Else
                sAirframeType = "F"
            End If


            l_objBuilder.Append("<tr valign='top'><td valign='top' class=""valueSpecWhite"" colspan='10'>")
            l_objBuilder.Append("<table width=""100%"" border='0' cellpadding='4' cellspacing='0' valign='top' class=""large formatTable"" width=""100%"">")
            l_objBuilder.Append("<tr><td align='center' colspan='10'><font class='" & Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & real_make_model_name & "</strong>&nbsp;Performance Specifications</font></td></tr>" & vbCrLf)
            l_objBuilder.Append("</table>")
            l_objBuilder.Append("</td></tr>")

            l_objBuilder.Append("<tr valign='top'><td valign='top' class=""valueSpecWhite""><div class=""Box"">")

            l_objBuilder.Append("<table width=""100%"" border='0' cellpadding='4' cellspacing='0' valign='top' class=""large formatTable"" width=""100%"">")

            '-----------------------------------------------------------------------
            l_objBuilder.Append("<tr><td nowrap colspan=""2""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Fuselage Dimensions</font></td></tr>" & vbCrLf)

            If Session.Item("useMetricValues") Then
                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Length (" & TranslateUSMetricUnitsShort("FT") & "):</td>" & vbCrLf)
                l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConvertUSToMetricValue("FT", CDbl(l_AdoRs.Item("amod_fuselage_length"))), 1, False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)

                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Height (" & TranslateUSMetricUnitsShort("FT") & "):</font></td>" & vbCrLf)
                l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConvertUSToMetricValue("FT", CDbl(l_AdoRs.Item("amod_fuselage_height"))), 1, False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)

                If sAirframeType = "F" And Not bHasManyAirFrames Then
                    l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Wing Span (" & TranslateUSMetricUnitsShort("FT") & "):</font></td>" & vbCrLf)
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConvertUSToMetricValue("FT", CDbl(l_AdoRs.Item("amod_fuselage_wingspan"))), 1, False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                ElseIf sAirframeType = "R" And Not bHasManyAirFrames Then
                    l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Width (" & TranslateUSMetricUnitsShort("FT") & "):</font></td>" & vbCrLf)
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConvertUSToMetricValue("FT", CDbl(l_AdoRs.Item("amod_fuselage_width"))), 1, False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                ElseIf (sAirframeType = "F" Or sAirframeType = "R") And bHasManyAirFrames Then
                    l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>[F] Wing Span (" & TranslateUSMetricUnitsShort("FT") & ") / [R] Width (" & TranslateUSMetricUnitsShort("FT") & "):</font></td>" & vbCrLf)
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConvertUSToMetricValue("FT", CDbl(l_AdoRs.Item("amod_fuselage_wingspan"))), 1, False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                End If


                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Cabin Volume (" + ConversionFunctions.TranslateUSMetricUnitsShort("CBFT") + "):</font></td>" & vbCrLf)
                l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConversionFunctions.ConvertUSToMetricValue("CBFT", CDbl(l_AdoRs.Item("amod_cabin_volume").ToString)), 1, False, True, False) + "&nbsp;</font></td></tr>" & vbCrLf)

                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Baggage Volume (" + ConversionFunctions.TranslateUSMetricUnitsShort("CBFT") + "):</font></td>" & vbCrLf)
                l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConversionFunctions.ConvertUSToMetricValue("CBFT", CDbl(l_AdoRs.Item("amod_baggage_volume").ToString)), 1, False, True, False) + "&nbsp;</font></td></tr>" & vbCrLf)

            Else
                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Length (ft):</font></td>" & vbCrLf)
                l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_fuselage_length")), 1, False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)

                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Height (ft):</font></td>" & vbCrLf)
                l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_fuselage_height")), 1, False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)

                If sAirframeType = "F" And Not bHasManyAirFrames Then
                    l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Wing Span (ft):</font></td>" & vbCrLf)
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_fuselage_wingspan")), 1, False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                ElseIf sAirframeType = "R" And Not bHasManyAirFrames Then
                    l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Width (ft):</font></td>" & vbCrLf)
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_fuselage_width")), 1, False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                ElseIf (sAirframeType = "F" Or sAirframeType = "R") And bHasManyAirFrames Then
                    l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>[F] Wing Span (ft) / [R] Width (ft):</font></td>" & vbCrLf)
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_fuselage_wingspan")), 1, False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                End If

                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Cabin Volume (CBFT):</font></td>" & vbCrLf)
                l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_cabin_volume").ToString), 1) + "&nbsp;</font></td></tr>" & vbCrLf)

                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Baggage Volume (CBFT):</font></td>" & vbCrLf)
                l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_baggage_volume").ToString), 1) + "&nbsp;</font></td></tr>" & vbCrLf)

            End If



            l_objBuilder.Append("<tr><td nowrap colspan=""2""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Cabin&nbsp;Dimensions</font></td></tr>" & vbCrLf)


            If Session.Item("useMetricValues") Then
                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Length (" & TranslateUSMetricUnitsShort("FT") & "):</font></td>" & vbCrLf)
                If Not IsDBNull(l_AdoRs.Item("amod_cabinsize_length_feet")) Then
                    If CDbl(l_AdoRs.Item("amod_cabinsize_length_feet")) > 0 Then
                        l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConvertUSToMetricValue("FT", CDbl(l_AdoRs.Item("amod_cabinsize_length_feet"))), 1, False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                    Else
                        l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                    End If
                Else
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, False, True) & "&nbsp;</font></td></tr>" & vbCrLf)
                End If

                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Height (" & TranslateUSMetricUnitsShort("FT") & "):</font></td>" & vbCrLf)
                If Not IsDBNull(l_AdoRs.Item("amod_cabinsize_height_feet")) Then
                    If CDbl(l_AdoRs.Item("amod_cabinsize_height_feet")) > 0 Then
                        l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConvertUSToMetricValue("FT", CDbl(l_AdoRs.Item("amod_cabinsize_height_feet"))), 1, False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                    Else
                        l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                    End If
                Else
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, False, True) & "&nbsp;</font></td></tr>" & vbCrLf)
                End If

                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Width (" & TranslateUSMetricUnitsShort("FT") & "):</font></td>" & vbCrLf)
                If Not IsDBNull(l_AdoRs.Item("amod_cabinsize_width_feet")) Then
                    If CDbl(l_AdoRs.Item("amod_cabinsize_width_feet")) > 0 Then
                        l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConvertUSToMetricValue("FT", CDbl(l_AdoRs.Item("amod_cabinsize_width_feet"))), 1, False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                    Else
                        l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                    End If
                Else
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, False, True) & "&nbsp;</font></td></tr>" & vbCrLf)
                End If

            Else
                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Length (ft)(inches):</font></td>" & vbCrLf)
                If Not IsDBNull(l_AdoRs.Item("amod_cabinsize_length_feet")) Then
                    If CDbl(l_AdoRs.Item("amod_cabinsize_length_feet")) > 0 Then
                        l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & l_AdoRs.Item("amod_cabinsize_length_feet") & "&#34; " & l_AdoRs.Item("amod_cabinsize_length_inches") & "'&nbsp;</font></td></tr>" & vbCrLf)
                    Else
                        l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                    End If
                Else
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, False, True) & "&nbsp;</font></td></tr>" & vbCrLf)
                End If

                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Height (ft)(inches):</font></td>" & vbCrLf)

                If Not IsDBNull(l_AdoRs.Item("amod_cabinsize_height_feet")) Then
                    If CDbl(l_AdoRs.Item("amod_cabinsize_height_feet")) > 0 Then
                        l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & l_AdoRs.Item("amod_cabinsize_height_feet") & "&#34; " & l_AdoRs.Item("amod_cabinsize_height_inches") & "'&nbsp;</font></td></tr>" & vbCrLf)
                    Else
                        l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                    End If
                Else
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, False, True) & "&nbsp;</font></td></tr>" & vbCrLf)
                End If

                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Width (ft)(inches):</font></td>" & vbCrLf)

                If Not IsDBNull(l_AdoRs.Item("amod_cabinsize_width_feet")) Then
                    If CDbl(l_AdoRs.Item("amod_cabinsize_width_feet")) > 0 Then
                        l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & l_AdoRs.Item("amod_cabinsize_width_feet") & "&#34; " & l_AdoRs.Item("amod_cabinsize_width_inches") & "'&nbsp;</font></td></tr>" & vbCrLf)
                    Else
                        l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                    End If
                Else
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, False, True) & "&nbsp;</font></td></tr>" & vbCrLf)
                End If
            End If


            l_objBuilder.Append("<tr><td colspan=""2""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Typical&nbsp;Configuration</font></td></tr>" & vbCrLf)

            l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Crew:</font></td>" & vbCrLf)
            l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & l_AdoRs.Item("amod_number_of_crew") & "&nbsp;</font></td></tr>" & vbCrLf)

            l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Passengers:</font></td>" & vbCrLf)
            l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & l_AdoRs.Item("amod_number_of_passengers") & "&nbsp;</font></td></tr>" & vbCrLf)


            If Session.Item("useMetricValues") Then
                If sAirframeType = "F" And Not bHasManyAirFrames Then
                    l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Pressurization&nbsp;(" & TranslateUSMetricUnitsShort("PSI") & "):</font></td>" & vbCrLf)
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConvertUSToMetricValue("PSI", CDbl(l_AdoRs.Item("amod_pressure"))), 1, False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                ElseIf sAirframeType = "R" And Not bHasManyAirFrames Then
                    ' do nothing
                ElseIf (sAirframeType = "F" Or sAirframeType = "R") And bHasManyAirFrames Then
                    l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>[F] Pressurization&nbsp;(" & TranslateUSMetricUnitsShort("PSI") & "):</font></td>" & vbCrLf)
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConvertUSToMetricValue("PSI", CDbl(l_AdoRs.Item("amod_pressure"))), 1, False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                End If
            Else
                If sAirframeType = "F" And Not bHasManyAirFrames Then
                    l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Pressurization&nbsp;(psi):</font></td>" & vbCrLf)
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & CDbl(l_AdoRs.Item("amod_pressure")) & "&nbsp;</font></td></tr>" & vbCrLf)
                ElseIf sAirframeType = "R" And Not bHasManyAirFrames Then
                    ' do nothing
                ElseIf (sAirframeType = "F" Or sAirframeType = "R") And bHasManyAirFrames Then
                    l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>[F] Pressurization&nbsp;(psi):</font></td>" & vbCrLf)
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & CDbl(l_AdoRs.Item("amod_pressure")) & "&nbsp;</font></td></tr>" & vbCrLf)
                End If
            End If



            '---------------------------------------------------------------------------------
            l_objBuilder.Append("</div></table></td>")
            l_objBuilder.Append("<td style='border-left:1px solid lightgrey;' class=""valueSpecWhite"" width='1'></td>")

            l_objBuilder.Append("<td align='left' class=""valueSpecWhite""><div class=""Box""><table border='0'  width=""100%"" cellpadding='4' cellspacing='0' class=""large formatTable"">")
            '---------------------------------------------------------------------------------

            l_objBuilder.Append("<tr><td colspan=""2""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Fuel Capacity</font></td></tr>")

            If Session.Item("useMetricValues") Then
                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Standard&nbsp;(" & TranslateUSMetricUnitsShort("lbs") & "):</font></td>" & vbCrLf)
                If Not IsDBNull(l_AdoRs.Item("amod_fuel_cap_std_weight")) Then
                    If CDbl(l_AdoRs.Item("amod_fuel_cap_std_weight")) > 0 Then
                        l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConvertUSToMetricValue("LBS", CDbl(l_AdoRs.Item("amod_fuel_cap_std_weight"))), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                    Else
                        l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                    End If
                Else
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                End If

                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Standard&nbsp;(" & TranslateUSMetricUnitsShort("gal") & "):</font></td>" & vbCrLf)
                If Not IsDBNull(l_AdoRs.Item("amod_fuel_cap_std_gal")) Then
                    If CDbl(l_AdoRs.Item("amod_fuel_cap_std_gal")) > 0 Then
                        If Session.Item("useMetricValues") Then
                            l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConvertUSToMetricValue("GAL", CDbl(l_AdoRs.Item("amod_fuel_cap_std_gal"))), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                        Else
                            l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_fuel_cap_std_gal")), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                        End If
                    Else
                        l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                    End If
                Else
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, False, True) & "&nbsp;</font></td></tr>" & vbCrLf)
                End If

                If Not IsDBNull(l_AdoRs.Item("amod_fuel_cap_opt_weight")) Then
                    If CDbl(l_AdoRs.Item("amod_fuel_cap_opt_weight")) > 0 Then
                        If Session.Item("useMetricValues") Then
                            l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Optional&nbsp;(" & TranslateUSMetricUnitsShort("lbs") & "):</font></td>" & vbCrLf)
                            l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConvertUSToMetricValue("LBS", CDbl(l_AdoRs.Item("amod_fuel_cap_opt_weight"))), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                        Else
                            l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Optional&nbsp;(" & TranslateUSMetricUnitsShort("lbs") & "):</font></td>" & vbCrLf)
                            l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_fuel_cap_opt_weight")), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                        End If
                    Else
                        ' l_objBuilder.Append("<td valign='middle' align='left'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                    End If
                Else
                    'l_objBuilder.Append("<td valign='middle' align='left'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, False, True) & "&nbsp;</font></td></tr>" & vbCrLf)
                End If

                If Not IsDBNull(l_AdoRs.Item("amod_fuel_cap_opt_gal")) Then
                    If CDbl(l_AdoRs.Item("amod_fuel_cap_opt_gal")) > 0 Then
                        If Session.Item("useMetricValues") Then
                            l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Optional&nbsp;(" & TranslateUSMetricUnitsShort("gal") & "):</font></td>" & vbCrLf)
                            l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConvertUSToMetricValue("GAL", CDbl(l_AdoRs.Item("amod_fuel_cap_opt_gal"))), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                        Else
                            l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Optional&nbsp;(" & TranslateUSMetricUnitsShort("gal") & "):</font></td>" & vbCrLf)
                            l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_fuel_cap_opt_gal")), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                        End If
                    Else
                        ' l_objBuilder.Append("<td valign='middle' align='left'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                    End If
                Else
                    ' l_objBuilder.Append("<td valign='middle' align='left'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, False, True) & "&nbsp;</font></td></tr>" & vbCrLf)
                End If
            Else
                If Not IsDBNull(l_AdoRs.Item("amod_fuel_cap_std_weight")) Then
                    If CDbl(l_AdoRs.Item("amod_fuel_cap_std_weight")) > 0 Then
                        l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Standard&nbsp;(lbs):</font></td>" & vbCrLf)
                        l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_fuel_cap_std_weight")), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                    Else
                        '  l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Standard&nbsp;(lbs):</font></td>" & vbCrLf)
                        'l_objBuilder.Append("<td valign='middle' align='left'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                    End If
                Else
                    ' l_objBuilder.Append("<td valign='middle' align='left'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                End If

                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Standard&nbsp;(gal):</font></td>" & vbCrLf)
                If Not IsDBNull(l_AdoRs.Item("amod_fuel_cap_std_gal")) Then
                    If CDbl(l_AdoRs.Item("amod_fuel_cap_std_gal")) > 0 Then
                        If Session.Item("useMetricValues") Then
                            l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConvertUSToMetricValue("GAL", CDbl(l_AdoRs.Item("amod_fuel_cap_std_gal"))), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                        Else
                            l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_fuel_cap_std_gal")), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                        End If
                    Else
                        l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                    End If
                Else
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, False, True) & "&nbsp;</font></td></tr>" & vbCrLf)
                End If

                If Not IsDBNull(l_AdoRs.Item("amod_fuel_cap_opt_weight")) Then
                    If CDbl(l_AdoRs.Item("amod_fuel_cap_opt_weight")) > 0 Then
                        If Session.Item("useMetricValues") Then
                            l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Optional&nbsp;(lbs):</font></td>" & vbCrLf)
                            l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConvertUSToMetricValue("LBS", CDbl(l_AdoRs.Item("amod_fuel_cap_opt_weight"))), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                        Else
                            l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Optional&nbsp;(lbs):</font></td>" & vbCrLf)
                            l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_fuel_cap_opt_weight")), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                        End If
                    Else
                        '  l_objBuilder.Append("<td valign='middle' align='left'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                    End If
                Else
                    ' l_objBuilder.Append("<td valign='middle' align='left'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, False, True) & "&nbsp;</font></td></tr>" & vbCrLf)
                End If

                If Not IsDBNull(l_AdoRs.Item("amod_fuel_cap_opt_gal")) Then
                    If CDbl(l_AdoRs.Item("amod_fuel_cap_opt_gal")) > 0 Then
                        If Session.Item("useMetricValues") Then
                            l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Optional&nbsp;(gal):</font></td>" & vbCrLf)
                            l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConvertUSToMetricValue("GAL", CDbl(l_AdoRs.Item("amod_fuel_cap_opt_gal"))), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                        Else
                            l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Optional&nbsp;(gal):</font></td>" & vbCrLf)
                            l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_fuel_cap_opt_gal")), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                        End If
                    Else
                        ' l_objBuilder.Append("<td valign='middle' align='left'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                    End If
                Else
                    ' l_objBuilder.Append("<td valign='middle' align='left'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, False, True) & "&nbsp;</font></td></tr>" & vbCrLf)
                End If
            End If

            l_objBuilder.Append("<tr><td colspan=""2""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Weight</font></td></tr>" & vbCrLf)

            If Session.Item("useMetricValues") Then
                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Max.&nbsp;Ramp&nbsp;(" & TranslateUSMetricUnitsShort("lbs") & "):</font></td>" & vbCrLf)
                l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConvertUSToMetricValue("LBS", CDbl(l_AdoRs.Item("amod_max_ramp_weight"))), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)

                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Max.&nbsp;Takeoff&nbsp;(" & TranslateUSMetricUnitsShort("lbs") & "):</font></td>" & vbCrLf)
                l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConvertUSToMetricValue("LBS", CDbl(l_AdoRs.Item("amod_max_takeoff_weight"))), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)


                If sAirframeType = "F" And Not bHasManyAirFrames Then
                    l_objBuilder.Append("<tr><td nowrap class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Zero&nbsp;Fuel&nbsp;(" & TranslateUSMetricUnitsShort("lbs") & "):</font></td>" & vbCrLf)
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConvertUSToMetricValue("LBS", CDbl(l_AdoRs.Item("amod_zero_fuel_weight"))), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                ElseIf sAirframeType = "R" And Not bHasManyAirFrames Then
                    l_objBuilder.Append("<tr><td nowrap class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Empty&nbsp;Operating&nbsp;Weight&nbsp;(EOW):</font></td>" & vbCrLf)
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConvertUSToMetricValue("LBS", CDbl(l_AdoRs.Item("amod_weight_eow"))), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                ElseIf (sAirframeType = "F" Or sAirframeType = "R") And bHasManyAirFrames Then
                    l_objBuilder.Append("<tr><td nowrap class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>[F] Zero&nbsp;Fuel&nbsp;(" & TranslateUSMetricUnitsShort("lbs") & ") / [R] Empty&nbsp;Operating&nbsp;Weight&nbsp;(" & TranslateUSMetricUnitsShort("lbs") & "):</font></td>" & vbCrLf)
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConvertUSToMetricValue("LBS", CDbl(l_AdoRs.Item("amod_zero_fuel_weight"))), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                End If

                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Basic&nbsp;Operating&nbsp;(" & TranslateUSMetricUnitsShort("lbs") & "):</font></td>" & vbCrLf)
                l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConvertUSToMetricValue("LBS", CDbl(l_AdoRs.Item("amod_basic_op_weight"))), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)

                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Max.&nbsp;Landing&nbsp;(" & TranslateUSMetricUnitsShort("lbs") & "):</font></td>" & vbCrLf)
                l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConvertUSToMetricValue("LBS", CDbl(l_AdoRs.Item("amod_max_landing_weight"))), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
            Else
                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Max.&nbsp;Ramp&nbsp;(lbs):</font></td>" & vbCrLf)
                l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_max_ramp_weight")), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)

                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Max.&nbsp;Takeoff&nbsp;(lbs):</font></td>" & vbCrLf)
                l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_max_takeoff_weight")), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)


                If sAirframeType = "F" And Not bHasManyAirFrames Then
                    l_objBuilder.Append("<tr><td nowrap class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Zero&nbsp;Fuel&nbsp;(lbs):</font></td>" & vbCrLf)
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_zero_fuel_weight")), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                ElseIf sAirframeType = "R" And Not bHasManyAirFrames Then
                    l_objBuilder.Append("<tr><td nowrap class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Empty&nbsp;Operating&nbsp;Weight&nbsp;(EOW):</font></td>" & vbCrLf)
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_weight_eow")), False, True, False) & "&nbsp;</font></td></tr>")
                ElseIf (sAirframeType = "F" Or sAirframeType = "R") And bHasManyAirFrames Then
                    l_objBuilder.Append("<tr><td nowrap class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>[F] Zero&nbsp;Fuel&nbsp;(lbs) / [R] Empty&nbsp;Operating&nbsp;Weight&nbsp;(lbs):</font></td>" & vbCrLf)
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_zero_fuel_weight")), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                End If

                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Basic&nbsp;Operating&nbsp;(lbs):</font></td>" & vbCrLf)
                l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_basic_op_weight")), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)

                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Max.&nbsp;Landing&nbsp;(lbs):</font></td>" & vbCrLf)
                l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_max_landing_weight")), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
            End If





            If Session.Item("useMetricValues") Then
                l_objBuilder.Append("<tr><td colspan=""2""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Speed&nbsp;" & TranslateUSMetricUnitsLong("KN") & "</font></td></tr>" & vbCrLf)
            Else
                l_objBuilder.Append("<tr><td colspan=""2""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Speed&nbsp;Knots</font></td></tr>" & vbCrLf)
            End If

            If sAirframeType = "F" And Not bHasManyAirFrames Then
                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Vs&nbsp;Clean:</font></td>" & vbCrLf)
            ElseIf sAirframeType = "R" And Not bHasManyAirFrames Then
                ' do nothing
            ElseIf (sAirframeType = "F" Or sAirframeType = "R") And bHasManyAirFrames Then
                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>[F] Vs&nbsp;Clean:</font></td>" & vbCrLf)
            End If

            If sAirframeType = "F" Then
                If Session.Item("useMetricValues") Then
                    If Not IsDBNull(l_AdoRs.Item("amod_stall_vs")) Then
                        If CDbl(l_AdoRs.Item("amod_stall_vs")) > 0 Then
                            l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConvertUSToMetricValue("KN", CDbl(l_AdoRs.Item("amod_stall_vs"))), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                        Else
                            l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                        End If
                    Else
                        l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, False, True) & "&nbsp;</font></td></tr>" & vbCrLf)
                    End If
                Else
                    If Not IsDBNull(l_AdoRs.Item("amod_stall_vs")) Then
                        If CDbl(l_AdoRs.Item("amod_stall_vs")) > 0 Then
                            l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_stall_vs")), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                        Else
                            l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                        End If
                    Else
                        l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, False, True) & "&nbsp;</font></td></tr>" & vbCrLf)
                    End If
                End If
            ElseIf sAirframeType = "R" And bHasManyAirFrames Then
                l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & crmWebClient.Constants.NOTAPPLICABLE_PLACEHOLDER & "&nbsp;</font></td></tr>" & vbCrLf)
            End If



            If sAirframeType = "F" And Not bHasManyAirFrames Then
                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Vso&nbsp;Landing:</font></td>" & vbCrLf)
            ElseIf sAirframeType = "R" And Not bHasManyAirFrames Then
                ' do nothing
            ElseIf (sAirframeType = "F" Or sAirframeType = "R") And bHasManyAirFrames Then
                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>[F] Vso&nbsp;Landing:</font></td>" & vbCrLf)
            End If


            If sAirframeType = "F" Then
                If Session.Item("useMetricValues") Then
                    If Not IsDBNull(l_AdoRs.Item("amod_stall_vso")) Then
                        If CDbl(l_AdoRs.Item("amod_stall_vso")) > 0 Then
                            l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConvertUSToMetricValue("KN", CDbl(l_AdoRs.Item("amod_stall_vso"))), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                        Else
                            l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                        End If
                    Else
                        l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, False, True) & "&nbsp;</font></td></tr>" & vbCrLf)
                    End If
                Else
                    If Not IsDBNull(l_AdoRs.Item("amod_stall_vso")) Then
                        If CDbl(l_AdoRs.Item("amod_stall_vso")) > 0 Then
                            l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_stall_vso")), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                        Else
                            l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                        End If
                    Else
                        l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, False, True) & "&nbsp;</font></td></tr>" & vbCrLf)
                    End If
                End If
            ElseIf sAirframeType = "R" And bHasManyAirFrames Then
                l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & crmWebClient.Constants.NOTAPPLICABLE_PLACEHOLDER & "&nbsp;</font></td></tr>" & vbCrLf)
            End If


            l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Normal&nbsp;Cruise&nbsp;TAS:</font></td>" & vbCrLf)
            If Session.Item("useMetricValues") Then
                l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConvertUSToMetricValue("KN", CDbl(l_AdoRs.Item("amod_cruis_speed"))), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
            Else
                l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_cruis_speed")), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
            End If

            l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Vmo&nbsp;(Max&nbsp;Op)&nbsp;IAS:</font></td>" & vbCrLf)
            If Session.Item("useMetricValues") Then
                l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConvertUSToMetricValue("KN", CDbl(l_AdoRs.Item("amod_max_speed"))), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
            Else
                l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_max_speed")), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
            End If


            If Session.Item("useMetricValues") Then
                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right' nowrap='nowrap'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>V1 Takeoff&nbsp;(" + ConversionFunctions.TranslateUSMetricUnitsShort("KN") + "):</font></td>" & vbCrLf)
                l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConversionFunctions.ConvertUSToMetricValue("KN", CDbl(l_AdoRs.Item("amod_v1_takeoff_speed").ToString)), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
            Else
                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right' nowrap='nowrap'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>V1 Takeoff&nbsp;(KN):</font></td>" & vbCrLf)
                l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_v1_takeoff_speed")), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
            End If


            If Session.Item("useMetricValues") Then
                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right' nowrap='nowrap'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>VFE Max Flap Ext&nbsp;(" + ConversionFunctions.TranslateUSMetricUnitsShort("KN") + "):</font></td>" & vbCrLf)
                l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConversionFunctions.ConvertUSToMetricValue("KN", CDbl(l_AdoRs.Item("amod_vfe_max_flap_extended_speed").ToString)), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
            Else
                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right' nowrap='nowrap'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>VFE Max Flap Ext&nbsp;(KN):</font></td>" & vbCrLf)
                l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_vfe_max_flap_extended_speed")), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
            End If


            If Session.Item("useMetricValues") Then
                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right' nowrap='nowrap'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>VLE Max Land Gear Ext&nbsp;(" + ConversionFunctions.TranslateUSMetricUnitsShort("KN") + "):</font></td>" & vbCrLf)
                l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConversionFunctions.ConvertUSToMetricValue("KN", CDbl(l_AdoRs.Item("amod_vle_max_landing_gear_ext_speed").ToString)), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
            Else
                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right' nowrap='nowrap'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>VLE Max Land Gear Ext&nbsp;(KN):</font></td>" & vbCrLf)
                l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_vle_max_landing_gear_ext_speed")), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
            End If




            If sAirframeType = "F" And Not bHasManyAirFrames Then
                ' do nothing
            ElseIf sAirframeType = "R" And Not bHasManyAirFrames Then
                l_objBuilder.Append("<tr><th nowrap><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>IFR Certification:</font></th></tr><tr>" & vbCrLf)
                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>(IFR):</font></td>" & vbCrLf)
            ElseIf (sAirframeType = "F" Or sAirframeType = "R") And bHasManyAirFrames Then
                l_objBuilder.Append("<tr><th nowrap><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>[R] IFR Certification:</font></th>" & vbCrLf)
                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>[R] (IFR):</font></td>" & vbCrLf)
            End If


            If sAirframeType = "F" And bHasManyAirFrames Then
                l_objBuilder.Append("<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td></tr><tr>" & vbCrLf)
                l_objBuilder.Append("<tr><td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & crmWebClient.Constants.NOTAPPLICABLE_PLACEHOLDER & "&nbsp;</font></td></tr>" & vbCrLf)
            ElseIf sAirframeType = "R" Then
                l_objBuilder.Append("<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td></tr>")

                If Not IsDBNull(l_AdoRs.Item("amod_ifr_certification")) Then
                    l_objBuilder.Append("<tr><td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & l_AdoRs.Item("amod_ifr_certification") & "&nbsp;</font></td></tr>" & vbCrLf)
                Else
                    l_objBuilder.Append("<tr><td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Unknown</font></td></tr>" & vbCrLf)
                End If
            End If




            '---------------------------------------------------------------------------------
            l_objBuilder.Append("</div></table></td>")
            l_objBuilder.Append("<td style='border-left:1px solid lightgrey;' width='1'  class=""valueSpecWhite""></td>")

            l_objBuilder.Append("<td align='left' class=""valueSpecWhite""><div class=""Box""><table border='0' cellpadding='4' cellspacing='0' class=""large formatTable"" width=""100%"">")
            '---------------------------------------------------------------------------------

            l_objBuilder.Append("<tr><td colspan=""2""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Climb</font></td></tr>")

            If Session.Item("useMetricValues") Then
                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Normal&nbsp;(" & TranslateUSMetricUnitsShort("FPM") & "):</font></td>" & vbCrLf)
                If CDbl(l_AdoRs.Item("amod_climb_normal_feet")) > 0 Then
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConvertUSToMetricValue("FPM", CDbl(l_AdoRs.Item("amod_climb_normal_feet"))), 1, False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                Else
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, False, True) & "&nbsp;</font></td></tr>" & vbCrLf)
                End If

                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Engine&nbsp;Out&nbsp;(" & TranslateUSMetricUnitsShort("FPM") & "):</font></td>" & vbCrLf)
                If CDbl(l_AdoRs.Item("amod_climb_engout_feet")) > 0 Then
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConvertUSToMetricValue("FPM", CDbl(l_AdoRs.Item("amod_climb_engout_feet"))), 1, False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                Else
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, False, True) & "&nbsp;</font></td></tr>" & vbCrLf)
                End If

                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Ceiling (" & TranslateUSMetricUnitsShort("FT") & "):</font></td>" & vbCrLf)
                If CDbl(l_AdoRs.Item("amod_ceiling_feet")) > 0 Then
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConvertUSToMetricValue("FT", CDbl(l_AdoRs.Item("amod_ceiling_feet"))), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                Else
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, False, True) & "&nbsp;</font></td></tr>" & vbCrLf)
                End If
            Else
                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Normal&nbsp;(fpm):</font></td>" & vbCrLf)
                If CDbl(l_AdoRs.Item("amod_climb_normal_feet")) > 0 Then
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_climb_normal_feet")), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                Else
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, False, True) & "&nbsp;</font></td></tr>" & vbCrLf)
                End If

                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Engine&nbsp;Out&nbsp;(fpm):</font></td>" & vbCrLf)
                If CDbl(l_AdoRs.Item("amod_climb_engout_feet")) > 0 Then
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_climb_engout_feet")), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                Else
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, False, True) & "&nbsp;</font></td></tr>" & vbCrLf)
                End If

                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Ceiling (ft):</font></td>" & vbCrLf)
                If CDbl(l_AdoRs.Item("amod_ceiling_feet")) > 0 Then
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_ceiling_feet")), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                Else
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, False, True) & "&nbsp;</font></td></tr>" & vbCrLf)
                End If
            End If



            If sAirframeType = "F" And Not bHasManyAirFrames Then
                'do nothing
            ElseIf sAirframeType = "R" And Not bHasManyAirFrames Then
                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>(HOGE)&nbsp;Out&nbsp;of&nbsp;Ground&nbsp;Effect:</font></td>" & vbCrLf)
                If Not IsDBNull(l_AdoRs.Item("amod_climb_hoge")) Then
                    If Session.Item("useMetricValues") Then
                        l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConvertUSToMetricValue("FT", CDbl(l_AdoRs.Item("amod_climb_hoge"))), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                    Else
                        l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_climb_hoge")), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                    End If
                Else
                    l_objBuilder.Append("<td valign='middle' align='left'>&nbsp;</td></tr>")
                End If

                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>(HIGE)&nbsp;In&nbsp;Ground&nbsp;Effect:</font></td>" & vbCrLf)
                If Not IsDBNull(l_AdoRs.Item("amod_climb_hige")) Then
                    If Session.Item("useMetricValues") Then
                        l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConvertUSToMetricValue("FT", CDbl(l_AdoRs.Item("amod_climb_hige"))), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                    Else
                        l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_climb_hige")), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                    End If
                Else
                    l_objBuilder.Append("<td valign='middle' align='left'>&nbsp;</td></tr>")
                End If
            ElseIf (sAirframeType = "F" Or sAirframeType = "R") And bHasManyAirFrames Then
                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>[R] (HOGE)&nbsp;Out&nbsp;of&nbsp;Ground&nbsp;Effect:</font></td>" & vbCrLf)
                l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & crmWebClient.Constants.NOTAPPLICABLE_PLACEHOLDER & "&nbsp;</font></td></tr>" & vbCrLf)

                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>[R] (HIGE)&nbsp;In&nbsp;Ground&nbsp;Effect:</font></td>" & vbCrLf)
                l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & crmWebClient.Constants.NOTAPPLICABLE_PLACEHOLDER & "&nbsp;</font></td></tr>" & vbCrLf)
            End If




            If sAirframeType = "F" And Not bHasManyAirFrames Then
                'l_objBuilder.Append("<tr><td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Landing Performance</font></td></tr>")

                If Session.Item("useMetricValues") Then
                    l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>FAA&nbsp;Field&nbsp;Length (" & TranslateUSMetricUnitsShort("FT") & "):</font></td>" & vbCrLf)
                Else
                    l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>FAA&nbsp;Field&nbsp;Length (ft):</font></td>" & vbCrLf)
                End If
                If Session.Item("useMetricValues") Then
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConvertUSToMetricValue("FT", CDbl(l_AdoRs.Item("amod_field_length"))), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                Else
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CLng(l_AdoRs.Item("amod_field_length")), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                End If
            ElseIf sAirframeType = "R" And Not bHasManyAirFrames Then
                ' do nothing
            ElseIf (sAirframeType = "F" Or sAirframeType = "R") And bHasManyAirFrames Then
                l_objBuilder.Append("<tr><td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>[F] Landing Performance</font></td></tr>" & vbCrLf)
                If Session.Item("useMetricValues") Then
                    l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>[F] FAA&nbsp;Field&nbsp;Length (" & TranslateUSMetricUnitsShort("FT") & "):</font></td>" & vbCrLf)
                Else
                    l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>[F] FAA&nbsp;Field&nbsp;Length (ft):</font></td>" & vbCrLf)
                End If

                If Trim(sAirframeType) = "F" Then
                    If Session.Item("useMetricValues") Then
                        l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConvertUSToMetricValue("FT", CDbl(l_AdoRs.Item("amod_field_length"))), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                    Else
                        l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CLng(l_AdoRs.Item("amod_field_length")), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                    End If
                Else
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & crmWebClient.Constants.NOTAPPLICABLE_PLACEHOLDER & "&nbsp;</font></td></tr>" & vbCrLf)
                End If
            End If

            l_objBuilder.Append("<tr><td colspan=""2""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Takeoff Performance</font></td></tr>" & vbCrLf)

            l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>SL&nbsp;ISA&nbsp;BFL:</font></td>" & vbCrLf)
            l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CLng(l_AdoRs.Item("amod_takeoff_ali")), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)

            l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>5000'&nbsp;+20C&nbsp;BFL:</font></td>" & vbCrLf)
            l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CLng(l_AdoRs.Item("amod_takeoff_500")), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)


            If Session.Item("useMetricValues") Then
                l_objBuilder.Append("<tr><td nowrap><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Range (" & TranslateUSMetricUnitsLong("NM") & ")</font></td></tr>" & vbCrLf)

                If sAirframeType = "F" And Not bHasManyAirFrames Then
                    l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Range&nbsp;(" & TranslateUSMetricUnitsShort("NM") & "):</font></td>" & vbCrLf)   ' changed below to amod_max_range_miles
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConvertUSToMetricValue("NM", CDbl(l_AdoRs.Item("amod_max_range_miles"))), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)

                ElseIf sAirframeType = "R" And Not bHasManyAirFrames Then
                    l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Tanks&nbsp;Full&nbsp;(" & TranslateUSMetricUnitsShort("NM") & "):</font></td>" & vbCrLf)
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConvertUSToMetricValue("NM", CDbl(l_AdoRs.Item("amod_range_tanks_full"))), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)

                    l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Seats&nbsp;Full&nbsp;(" & TranslateUSMetricUnitsShort("NM") & "):</font></td>" & vbCrLf)
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConvertUSToMetricValue("NM", CDbl(l_AdoRs.Item("amod_range_seats_full"))), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)


                ElseIf (sAirframeType = "F" Or sAirframeType = "R") And bHasManyAirFrames Then
                    l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>[F] Range&nbsp;(" & TranslateUSMetricUnitsShort("NM") & ") / [R] Tanks&nbsp;Full&nbsp;(" & TranslateUSMetricUnitsShort("NM") & "):</font></td>" & vbCrLf)
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConvertUSToMetricValue("NM", CDbl(l_AdoRs.Item("amod_range_tanks_full"))), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)

                    If sAirframeType = "R" Then
                        l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>[R] Seats&nbsp;Full&nbsp;(" & TranslateUSMetricUnitsShort("NM") & "):</font></td>" & vbCrLf) '
                        l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConvertUSToMetricValue("NM", CDbl(l_AdoRs.Item("amod_range_seats_full"))), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                    Else

                    End If

                End If
            Else
                ' l_objBuilder.Append("<tr><td nowrap><strong>Landing Field Length (ft)</strong></td></tr>" & vbCrLf)
                l_objBuilder.Append("<tr><td nowrap colspan=""2""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Range (Nautical Miles)</font></td></tr>" & vbCrLf)

                If sAirframeType = "F" And Not bHasManyAirFrames Then
                    l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Range&nbsp;:</font></td>" & vbCrLf) ' changed below to say 
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & IIf(Not localCriteria.ViewCriteriaUseStatuteMiles, FormatNumber(ConversionFunctions.ConvertStatuteToNauticalMiles("SM", CDbl(l_AdoRs.Item("amod_max_range_miles").ToString)), False, True, False), FormatNumber(CDbl(l_AdoRs.Item("amod_max_range_miles").ToString), False, True, False)) + "&nbsp;" + IIf(localCriteria.ViewCriteriaUseStatuteMiles, "(sm)", "(nm)") & "&nbsp;</font></td></tr>" & vbCrLf)

                ElseIf sAirframeType = "R" And Not bHasManyAirFrames Then
                    l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Tanks&nbsp;Full&nbsp;:</font></td>" & vbCrLf)
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConversionFunctions.ConvertUSToMetricValue("NM", CDbl(l_AdoRs.Item("amod_range_tanks_full").ToString)), False, True, False) + "&nbsp;(" + ConversionFunctions.TranslateUSMetricUnitsShort("NM") + ")" & "&nbsp;</font></td></tr>" & vbCrLf)
                    l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Seats&nbsp;Full&nbsp;:</font></td>" & vbCrLf)
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & IIf(Not localCriteria.ViewCriteriaUseStatuteMiles, FormatNumber(ConversionFunctions.ConvertStatuteToNauticalMiles("SM", CDbl(l_AdoRs.Item("amod_range_seats_full").ToString)), False, True, False), FormatNumber(CDbl(l_AdoRs.Item("amod_range_seats_full").ToString), False, True, False)) + "&nbsp;" + IIf(localCriteria.ViewCriteriaUseStatuteMiles, "(sm)", "(nm)") & "&nbsp;</font></td></tr>" & vbCrLf)

                ElseIf (sAirframeType = "F" Or sAirframeType = "R") And bHasManyAirFrames Then
                    l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>[F] Range&nbsp; / [R] Tanks&nbsp;Full&nbsp;:</font></td>" & vbCrLf)
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(ConversionFunctions.ConvertUSToMetricValue("NM", CDbl(l_AdoRs.Item("amod_range_tanks_full").ToString)), False, True, False) + "&nbsp;(" + ConversionFunctions.TranslateUSMetricUnitsShort("NM") + ")" & "&nbsp;</font></td></tr>" & vbCrLf)

                    l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>[R] Seats&nbsp;Full&nbsp;:</font></td>" & vbCrLf)
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & IIf(Not localCriteria.ViewCriteriaUseStatuteMiles, FormatNumber(ConversionFunctions.ConvertStatuteToNauticalMiles("SM", CDbl(l_AdoRs.Item("amod_range_seats_full").ToString)), False, True, False), FormatNumber(CDbl(l_AdoRs.Item("amod_range_seats_full").ToString), False, True, False)) + "&nbsp;" + IIf(localCriteria.ViewCriteriaUseStatuteMiles, "(sm)", "(nm)") & "&nbsp;</font></td></tr>" & vbCrLf)

                End If
            End If

            If Session.Item("useMetricValues") Then

                If Not IsDBNull(l_AdoRs("amod_range_4_passenger")) Then
                    If CDbl(l_AdoRs.Item("amod_range_4_passenger").ToString) > 0 Then
                        l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Range (4 PAX) (" + ConversionFunctions.TranslateUSMetricUnitsShort("NM") + "):</font></td>" & vbCrLf)
                        l_objBuilder.Append("<td valign='middle' align='right' class=""right"">" + FormatNumber(ConversionFunctions.ConvertUSToMetricValue("NM", CDbl(l_AdoRs.Item("amod_range_4_passenger").ToString)), 1, False, True, False) + "&nbsp;</td></tr><tr>")
                    Else
                        l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Range (4 PAX) (" + ConversionFunctions.TranslateUSMetricUnitsShort("NM") + "):</font></td>" & vbCrLf)
                        l_objBuilder.Append("<td valign='middle' align='right' class=""right"">" + Constants.cHyphen + "</td></tr><tr>")
                    End If
                Else
                    l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Range (4 PAX) (" + ConversionFunctions.TranslateUSMetricUnitsShort("NM") + "):</font></td>" & vbCrLf)
                    l_objBuilder.Append("<td valign='middle' align='right' class=""right"">" + Constants.cHyphen + "</td></tr><tr>")
                End If

                If Not IsDBNull(l_AdoRs("amod_range_8_passenger")) Then
                    If CDbl(l_AdoRs.Item("amod_range_8_passenger").ToString) > 0 Then
                        l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Range (8 PAX) (" + ConversionFunctions.TranslateUSMetricUnitsShort("NM") + "):</font></td>" & vbCrLf)
                        l_objBuilder.Append("<td valign='middle' align='right' class=""right"">" + FormatNumber(ConversionFunctions.ConvertUSToMetricValue("NM", CDbl(l_AdoRs.Item("amod_range_8_passenger").ToString)), 1, False, True, False) + "&nbsp;</td></tr><tr>")
                    Else
                        ' commented out MSw - 6/20/20 to try and save space on some longer performance specs 
                        ' l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Range (8 PAX) (" + ConversionFunctions.TranslateUSMetricUnitsShort("NM") + "):</font></td>" & vbCrLf)
                        '  l_objBuilder.Append("<td valign='middle' align='right' class=""right"">" + Constants.cHyphen + "</td></tr><tr>")
                    End If
                Else
                    l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Range (8 PAX) (" + ConversionFunctions.TranslateUSMetricUnitsShort("NM") + "):</font></td>" & vbCrLf)
                    l_objBuilder.Append("<td valign='middle' align='right' class=""right"">" + Constants.cHyphen + "</td></tr><tr>")
                End If

            Else

                If Not IsDBNull(l_AdoRs("amod_range_4_passenger")) Then
                    If CDbl(l_AdoRs.Item("amod_range_4_passenger").ToString) > 0 Then
                        l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Range (4 PAX) (nm):</font></td>" & vbCrLf)
                        l_objBuilder.Append("<td valign='middle' align='right' class=""right"">" + FormatNumber(CDbl(l_AdoRs.Item("amod_range_4_passenger").ToString), False, True, False) + "&nbsp;(nm)</td></tr><tr>")
                    Else
                        l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Range (4 PAX) (nm):</font></td>" & vbCrLf)
                        l_objBuilder.Append("<td valign='middle' align='right' class=""right"">" + Constants.cHyphen + "</td></tr><tr>")
                    End If
                Else
                    l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Range (4 PAX) (nm):</font></td>" & vbCrLf)
                    l_objBuilder.Append("<td valign='middle' align='right' class=""right"">" + Constants.cHyphen + "</td></tr><tr>")
                End If

                If Not IsDBNull(l_AdoRs("amod_range_8_passenger")) Then
                    If CDbl(l_AdoRs.Item("amod_range_8_passenger").ToString) > 0 Then
                        l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Range (8 PAX) (nm):</font></td>" & vbCrLf)
                        l_objBuilder.Append("<td valign='middle' align='right' class=""right"">" + FormatNumber(CDbl(l_AdoRs.Item("amod_range_8_passenger").ToString), False, True, False) + "&nbsp;(nm)</td></tr><tr>")
                    Else
                        ' commented out MSw - 6/20/20 to try and save space on some longer performance specs 
                        '  l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Range (8 PAX) (nm):</font></td>" & vbCrLf)
                        '  l_objBuilder.Append("<td valign='middle' align='right' class=""right"">" + Constants.cHyphen + "</td></tr><tr>")
                    End If
                Else
                    l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Range (8 PAX) (nm):</font></td>" & vbCrLf)
                    l_objBuilder.Append("<td valign='middle' align='right' class=""right"">" + Constants.cHyphen + "</td></tr><tr>")
                End If
            End If


            l_objBuilder.Append("<tr><td nowrap colspan=""2""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Engines</font></td></tr>" & vbCrLf)
            l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Number&nbsp;of:</font></td>" & vbCrLf)
            l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CLng(l_AdoRs.Item("amod_number_of_engines")), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)

            l_objBuilder.Append("<tr valign='top'><td class='Label' valign='top' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Model(s):" & vbCrLf)
            l_objBuilder.Append("<td valign='middle' align='left' nowrap class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & GetEngines(l_AdoRs.Item("amod_id"), nMAXEngines) & "</font></td></tr>" & vbCrLf)




            If Session.Item("useMetricValues") Then
                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Thrust&nbsp;(" & TranslateUSMetricUnitsShort("LBS") & "&nbsp;per&nbsp;Engine):</font></td>" & vbCrLf)
                l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CDbl(ConvertUSToMetricValue("LBS", l_AdoRs.Item("amod_engine_thrust_lbs"))), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)

                If Not IsDBNull(l_AdoRs.Item("amod_engine_shaft")) Then
                    If CDbl(l_AdoRs.Item("amod_engine_shaft")) > 0 Then
                        l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Shaft&nbsp;(" & TranslateUSMetricUnitsShort("HP") & "&nbsp;per&nbsp;Engine):</font></td>")
                        l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CDbl(ConvertUSToMetricValue("HP", l_AdoRs.Item("amod_engine_shaft"))), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                    Else
                        ' l_objBuilder.Append("<td valign='middle' align='left'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                    End If
                Else
                    '   l_objBuilder.Append("<td valign='middle' align='left'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, False, True) & "&nbsp;</font></td></tr>" & vbCrLf)
                End If
            Else
                l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Thrust&nbsp;(lbs&nbsp;per&nbsp;Engine):</font></td>" & vbCrLf)
                l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_engine_thrust_lbs")), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)

                If Not IsDBNull(l_AdoRs.Item("amod_engine_shaft")) Then
                    If CDbl(l_AdoRs.Item("amod_engine_shaft")) > 0 Then
                        l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Shaft&nbsp;(hp&nbsp;per&nbsp;Engine):</font></td>" & vbCrLf)
                        l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_engine_shaft")), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                    Else
                        '  l_objBuilder.Append("<td valign='middle' align='left'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                    End If
                Else
                    ' l_objBuilder.Append("<td valign='middle' align='left'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(0, False, False, True) & "&nbsp;</font></td></tr>" & vbCrLf)
                End If
            End If

            If Not IsDBNull(l_AdoRs.Item("amod_engine_com_tbo_hrs")) Then
                If CInt(l_AdoRs.Item("amod_engine_com_tbo_hrs")) > 0 Then
                    l_objBuilder.Append("<tr><td class='Label' valign='middle' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Common&nbsp;TBO&nbsp;Hours:</font></td>" & vbCrLf)
                    l_objBuilder.Append("<td valign='middle' align='left' class=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(CDbl(l_AdoRs.Item("amod_engine_com_tbo_hrs")), False, True, False) & "&nbsp;</font></td></tr>" & vbCrLf)
                End If
            End If


            '---------------------------------------------------------------------------------
            l_objBuilder.Append("</table></div>")
            l_objBuilder.Append("</td></tr>")
            '---------------------------------------------------------------------------------


            ' add the spacer to move the footer down


            l_AdoRs.Close()
            l_AdoRs = Nothing

            New_Build_PerformanceSpecifications = l_objBuilder.ToString()


        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Build_PerformanceSpecifications: " & ex.Message
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function
    Public Function DisplayDescription(ByVal amodID As Long) As String
        Dim resultsString As String = ""
        resultsString += "<tr><td align='center' colspan='5'>"
        resultsString += "<font class='" & Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & real_make_model_name & "</strong>&nbsp;OVERVIEW</font>"
        resultsString += "<div class=""Box " & HttpContext.Current.Session("FONT_CLASS_TEXT") & """><table width=""100%"" cellpadding=""0"" cellspacing=""0"" class=""formatTable large""><tr><td align=""left"">"
        resultsString += Get_Aircraft_Model_Description(amodID)
        resultsString += "</td></tr></table></div><br clear=""all"" /></td></tr>"
        Return resultsString

    End Function

    Public Function DisplayAssettModel(ByVal amodID As Long) As String
        Dim resultsString As String = ""
        resultsString += "<tr><td align='center' colspan='5'>"
        resultsString += "<font class='" & Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & real_make_model_name & "</strong>&nbsp;OVERVIEW</font>"
        resultsString += "<div class=""Box " & HttpContext.Current.Session("FONT_CLASS_TEXT") & """><table width=""100%"" cellpadding=""0"" cellspacing=""0"" class=""formatTable large""><tr><td align=""left"">"
        resultsString += Get_Aircraft_Model_Description(amodID)
        resultsString += "</td></tr></table></div><br clear=""all"" /></td></tr>"
        Return resultsString

    End Function

    Public Function DisplayUtilizationTrends(ByVal amodID As Long) As String
        Dim resultsString As String = ""
        Dim ReturnString As String = ""
        resultsString += "<tr><td align=""left"" valign=""top"" colspan=""5""><font class='" & Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & real_make_model_name & "</strong>&nbsp;UTILIZATION TRENDS" & valueHeaderString & "<span>" & commonEvo.model_utilization_percentage(amodID).Trim & "</span></font></td></tr>"
        resultsString += "<tr><td align=""left"" colspan=""4"" valign=""top"">"
        resultsString += "<img src='" & valueGraphText32.Text & "' width='100%' align='center' />"

        resultsString += "</td><td align='center' valign=""top"" style=""width:360px;"">"
        resultsString += "<div class=""valueSpecWhite " & HttpContext.Current.Session("FONT_CLASS_TEXT") & """><table width=""100%"" cellpadding=""0"" cellspacing=""0"" class=""formatTable""><tr><td align=""left"">"
        ReturnString = ""
        Call util_view_functions.views_display_flight_activity(localCriteria, ReturnString, IIf(Trim(Session.Item("useFAAFlightData")) <> "" And Trim(Session.Item("useFAAFlightData")) <> "ARGUS", True, False), Session.Item("localSubscription").crmSubinst_FAA_data_date)
        resultsString += ReturnString
        resultsString += "</td></tr></table></div><br clear=""all"" /></td></tr>"
        Return resultsString

    End Function

    Public Function DisplayStandardEquipment(ByVal amodID As Long, ByVal shrink_text As String) As String
        Dim resultsString As String = ""
        Dim standardEQ As String = ""
        Dim countEq As Integer = 0
        Dim divisibleCount As Integer
        Dim DisplayTable As New DataTable
        resultsString += "<tr><td align='center' colspan='5'>"
        resultsString += "<font class='" & Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & real_make_model_name & "</strong>&nbsp;STANDARD EQUIPMENT</font>"


        DisplayTable = Get_Aircraft_Model_Standard_Equipment(amodID)
        If Not IsNothing(DisplayTable) Then
            If DisplayTable.Rows.Count > 0 Then
                standardEQ += "<table width=""100%"" cellpadding=""0"" cellspacing=""0"" class=""formatTable""><tr><td align=""left""><p><div class=""thirdSep"">"
                divisibleCount = DisplayTable.Rows.Count / 3
                For Each r As DataRow In DisplayTable.Rows
                    If countEq = divisibleCount Then
                        countEq = 0
                        standardEQ += "</div><div class=""thirdSep"">"
                    End If
                    countEq += 1

                    If Trim(shrink_text) = "Y" Then
                        standardEQ += "<span><font size='-1'>" & r("kfeat_name") & "</font></span>"
                    Else
                        standardEQ += "<span>" & r("kfeat_name") & "</span>"
                    End If


                Next
            End If
        End If

        If standardEQ <> "" Then
            resultsString += "<div class=""Box " & HttpContext.Current.Session("FONT_CLASS_TEXT") & """>"
            resultsString += standardEQ & "</div>"
            resultsString += "</p></td></tr></table></div><br clear=""all"" /></td></tr>"
        Else
            resultsString += "<table width=""100%"" cellpadding=""0"" cellspacing=""0"" class=""formatTable large""><tr><td align=""left"">There is no standard equipment for this model."
            resultsString += "</td></tr></table></td></tr>"
        End If

        Return resultsString

    End Function

    Public Function New_Build_OperatingCosts(ByRef foot_space_op_costs As String, ByVal amod_id As Integer) As String
        New_Build_OperatingCosts = ""


        Dim DCRecCount, AFRecCount, ABRecCount, ANCH, nCount, sTitle


        Dim tmpCDblValue As Double = 0.0
        Dim TCND As Double = 0.0
        Dim TCSM As Double = 0.0
        Dim TCST As Double = 0.0

        Dim bFirstOne As Boolean = True
        Dim fuelTotCost As Double = 0.00
        Dim fuelGalCost As Double = 0.00
        Dim fuelAddCost As Double = 0.00
        Dim fuelBurnRate As Double = 0.00
        Dim avgBlockSpeed As Double = 0.00
        Dim totalCostPer As Double = 0.00
        Dim annualMiles As Double = 0.00
        Dim dfstatmilecost As Double = 0.00
        Dim dfseatcost As Double = 0.00
        Dim totalDirCostHR As Double = 0.00
        Dim annualHrs As Double = 0.00
        Dim totalFixedDirect As Double = 0.00
        Dim totalDirCostYR As Double = 0.00
        Dim dfhourcost As Double = 0.00
        Dim sCurrencyName = ""
        Dim sCurrencySymbol = ""
        Dim crewsalaries As Double = 0.00
        Dim hangercost As Double = 0.00
        Dim miscoverhead As Double = 0.00
        Dim depoverhead As Double = 0.00
        Dim totalfixedcost As Double = 0.00
        Dim insurancecost As Double = 0.00
        Dim totalmaintcost As Double = 0.00
        Dim miscflightcosts As Double = 0.00
        Dim overhaulcost As Double = 0.00
        Dim revoverhaulcost As Double = 0.00

        Dim sCurrencyDate = ""
        Dim nRememberSessionTimeout As Long = 0


        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim localAdoRs As System.Data.SqlClient.SqlDataReader : localAdoRs = Nothing

        Dim Query As String : Query = ""
        Try
            'Select Case Application.Item("webHostObject").evoWebHostType
            'Case eWebSiteTypes.LOCAL
            'SqlConn.ConnectionString = My.Settings.DEFAULT_LOCAL_MSSQL
            ' Case Else
            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            ' End Select

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            Query = "SELECT * FROM Aircraft_Model WITH(NOLOCK) WHERE amod_id = " + amod_id.ToString



            If Not localCriteria.ViewCriteriaHasHelicopterFlag And Not localCriteria.ViewCriteriaHasBusinessFlag And Not localCriteria.ViewCriteriaHasCommercialFlag And localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_NONE Then
                localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_ALL ' use subscribers product code(s) for queries
            ElseIf localCriteria.ViewCriteriaHasHelicopterFlag And localCriteria.ViewCriteriaHasBusinessFlag And localCriteria.ViewCriteriaHasCommercialFlag And localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_NONE Then
                localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_ALL ' use subscribers product code(s) for queries
            End If

            If localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_ALL Then
                Query = Query & "  " + commonEvo.GenerateProductCodeSelectionQuery(HttpContext.Current.Session.Item("localPreferences"), False, True)
            Else
                Query = Query & "  " + commonEvo.BuildProductCodeCheckWhereClause(localCriteria.ViewCriteriaHasHelicopterFlag, localCriteria.ViewCriteriaHasBusinessFlag, localCriteria.ViewCriteriaHasCommercialFlag, False, False, False, True)
            End If


            SqlCommand.CommandText = Query

            Dim l_objBuilder As New StringBuilder
            Dim nNumberOfEngines As Integer = 0
            Dim nRememberModelID As Long = 0
            Dim nMAXEngines As Long = 0
            Dim nRows As Long = 0
            localAdoRs = SqlCommand.ExecuteReader()

            If localAdoRs.HasRows Then
                ' EXTRA QUERY TAKEN OUT
                localAdoRs.Read()
                'End If
            Else
                New_Build_OperatingCosts = ""
                Exit Function
            End If
            TCND = 0.0
            TCSM = 0.0
            TCST = 0.0
            ANCH = 0.0

            tmpCDblValue = 0.0

            ' bFirstOne = False
            nCount = 3

            DCRecCount = 0
            AFRecCount = 0
            ABRecCount = 0


            If CDbl(Session.Item("localfuelPrice")) > 0 Then
                Session.Item("fuelPriceBase") = Session.Item("localfuelPrice")
            ElseIf CDbl(Session.Item("homebasefuelPrice")) > 0 Then
                Session.Item("fuelPriceBase") = Session.Item("homebasefuelPrice")
            End If

            If LCase(Session.Item("localPreferences").UseStandardOrMetric) = LCase("standard") Then
                sTitle = "US Standard"
            Else
                sTitle = "Metric"
            End If

            sCurrencyName = ""
            sCurrencyDate = CStr(Now())

            ' MSW THIS WAS ADDED IN TO DUMMY IN US

            If CLng(Session.Item("localPreferences").DefaultCurrency) <> 9 Then ' 9 = us dollar

                Session.Item("currencyExchangeRate") = GetForeignExchangeRate(Session.Item("localPreferences").DefaultCurrency, sCurrencyName, sCurrencyDate)

                If Trim(sCurrencyDate) <> "" Then
                    sTitle = sTitle & " <em>(" & sCurrencyName & ": " & Session.Item("currencyExchangeRate") & ") rate as of " & FormatDateTime(sCurrencyDate, vbShortDate) & "</em>]"
                End If

            Else
                Session.Item("currencyExchangeRate") = 0
                sCurrencySymbol = crmWebClient.Constants.cDollarSymbol
                sCurrencyName = "Dollar"
            End If

            If InStr(1, LCase(sCurrencyName), "euro") > 0 Then
                sCurrencySymbol = crmWebClient.Constants.cEuroSymbol
            ElseIf InStr(1, LCase(sCurrencyName), "dollar") > 0 Then
                sCurrencySymbol = crmWebClient.Constants.cDollarSymbol
            ElseIf InStr(1, LCase(sCurrencyName), "pound") > 0 Then
                sCurrencySymbol = crmWebClient.Constants.cPoundSymbol
            ElseIf sCurrencySymbol <> "" Then
                sCurrencySymbol = crmWebClient.Constants.cEmptyString
            End If


            ' BEGINNING SECTION HERE PICTURE AND TITLE-----------------------------------------------------------------------------
            ' New_Build_OperatingCosts = New_Build_OperatingCosts & "<table align='center' border='0' cellpadding='2' cellspacing='0'><tr><td align='center' colspan='5'>"


            New_Build_OperatingCosts = New_Build_OperatingCosts & "<tr valign='top'><td valign='top' class=""valueSpecWhite"" colspan='10' align=""center"">"
            New_Build_OperatingCosts = New_Build_OperatingCosts & "<table width=""96%"" border='0' cellpadding='4' cellspacing='0' valign='top' class=""large formatTable"">"
            New_Build_OperatingCosts = New_Build_OperatingCosts & "<tr><td align='center' colspan='10'><font class='" & Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & real_make_model_name & "</strong>&nbsp;Operating Costs (" & Trim(sTitle) & ")" & valueEmptyHeaderString & "</font></td></tr>" & vbCrLf
            New_Build_OperatingCosts = New_Build_OperatingCosts & "</table>"
            New_Build_OperatingCosts = New_Build_OperatingCosts & "</td></tr>"


            ' BEGINNING SECTION HERE PICTURE AND TITLE-----------------------------------------------------------------------------


            ' THIS IS BEGGINNING OF LEFT COLUMN -----------------------------------------------------------------------------
            New_Build_OperatingCosts = New_Build_OperatingCosts & "<tr valign='top' class=""valueSpecWhite""><td valign='top' class=""valueSpecWhite"" colspan='10' align=""center""><table width=""96%"" border='0' cellpadding='4' cellspacing='0' valign='top'><tr>"


            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td width='30%' align='left' class='Operating_Costs_TD_Top_1'><div class=""Box removeTopPadding"">"

            ' THIS IS BEGGINNING OF LEFT COLUMN -----------------------------------------------------------------------------

            '   ------------------------------------------------------- THIS IS THE BEGGINING OF THE LEFT SIDE INFO -----------------------------------------------------------------
            ''''''''''''''''''''''''''''''''''''''''
            ' Starts the DIRECT COSTS PER HOUR 
            ''''''''''''''''''''''''''''''''''''''''
            '   New_Build_OperatingCosts = New_Build_OperatingCosts & "<td valign='top' align='left'>"
            New_Build_OperatingCosts = New_Build_OperatingCosts & "<table border='0' cellpadding='2'  cellspacing='0' width='90%' class=""formatTable""><tr valign='top' align='center'><td align='left' colspan='3'>" & vbCrLf
            New_Build_OperatingCosts = New_Build_OperatingCosts & "<font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>DIRECT COSTS PER HOUR</font></td></tr><tr>"

            ' New_Build_OperatingCosts = New_Build_OperatingCosts & "<td></td>"


            ' New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf





            If Session.Item("useMetricValues") Then

                If Not IsDBNull(localAdoRs("amod_fuel_gal_cost")) And CDbl(Session.Item("fuelPriceBase")) = 0 Then
                    If CDbl(localAdoRs("amod_fuel_gal_cost")) Then
                        fuelGalCost = ConvertUSToMetricValue("PPG", CDbl(localAdoRs("amod_fuel_gal_cost")))
                    End If
                Else
                    If CDbl(Session.Item("fuelPriceBase")) > 0 Then
                        fuelGalCost = ConvertUSToMetricValue("PPG", CDbl(Session.Item("fuelPriceBase")))
                    End If
                End If

                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    fuelGalCost = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), fuelGalCost)
                End If
                fuelGalCost = System.Math.Round(fuelGalCost, 2)

                fuelAddCost = ConvertUSToMetricValue("PPG", CDbl(localAdoRs("amod_fuel_add_cost")))
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    fuelAddCost = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), fuelAddCost)
                End If

                fuelAddCost = System.Math.Round(fuelAddCost, 2)


                fuelBurnRate = ConvertUSToMetricValue("GAL", CDbl(localAdoRs("amod_fuel_burn_rate")))

                fuelBurnRate = System.Math.Round(fuelBurnRate, 2)


                fuelTotCost = CDbl((fuelGalCost + fuelAddCost) * fuelBurnRate)


            Else

                If Not IsDBNull(localAdoRs("amod_fuel_gal_cost")) And CDbl(Session.Item("fuelPriceBase")) = 0 Then
                    If CDbl(localAdoRs("amod_fuel_gal_cost")) Then
                        fuelGalCost = CDbl(localAdoRs("amod_fuel_gal_cost"))
                    End If
                Else
                    If CDbl(Session.Item("fuelPriceBase")) > 0 Then
                        fuelGalCost = CDbl(Session.Item("fuelPriceBase"))
                    End If
                End If

                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    ' exchange rate should always be set ? why always change 
                    fuelGalCost = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), fuelGalCost)
                End If
                fuelGalCost = System.Math.Round(fuelGalCost, 2)



                If Not IsDBNull(localAdoRs("amod_fuel_add_cost")) Then
                    fuelAddCost = CDbl(localAdoRs("amod_fuel_add_cost"))
                Else
                    fuelAddCost = CDbl(0)
                End If

                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    fuelAddCost = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), fuelAddCost)
                End If
                fuelAddCost = System.Math.Round(fuelAddCost, 2)

                If Not IsDBNull(localAdoRs("amod_fuel_burn_rate")) Then
                    fuelBurnRate = CDbl(localAdoRs("amod_fuel_burn_rate"))
                Else
                    fuelBurnRate = CDbl(0)
                End If

                fuelBurnRate = System.Math.Round(fuelBurnRate, 2)

                fuelTotCost = (fuelGalCost + fuelAddCost) * fuelBurnRate

            End If




            fuelTotCost = System.Math.Round(fuelTotCost, 2)



            tmpCDblValue = fuelTotCost
            'If CDbl(Session.item("currencyExchangeRate")) > 0 Then
            'tmpCDblValue = ConvertUSToForeignCurrency(Session.item("currencyExchangeRate"), tmpCDblValue)
            ' End If


            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='left' width='50%' valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'><u>Fuel</u></font></td>" & vbCrLf

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"

            If Not IsDBNull(localAdoRs("amod_fuel_tot_cost")) Then
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right' valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font color='red' class=""emphasis"">" & sCurrencySymbol & FormatNumber(tmpCDblValue, 2, True, False, True) & "</font></font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right' valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
            End If
            '   End If

            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf


            ' when changing from metric to US standard all lables have to change
            If Session.Item("useMetricValues") Then
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;&nbsp;&nbsp;&nbsp;Fuel Cost Per " & TranslateUSMetricUnitsLong("GAL") & "</font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;&nbsp;&nbsp;&nbsp;Fuel Cost Per Gallon</font></td>" & vbCrLf
            End If

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"

            If Not IsDBNull(localAdoRs("amod_fuel_gal_cost")) And CDbl(Session.Item("fuelPriceBase")) = 0 Then
                If CDbl(localAdoRs("amod_fuel_gal_cost")) > 0 Then


                    'If Session.item("useMetricValues") Then
                    '  fuelGalCost = ConvertUSToMetricValue("PPG", CDbl(localAdoRs("amod_fuel_gal_cost")))
                    'Else
                    '  fuelGalCost = CDbl(localAdoRs("amod_fuel_gal_cost"))
                    'End If



                    If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                        fuelGalCost = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), fuelGalCost)
                        fuelGalCost = System.Math.Round(fuelGalCost, 2)
                    End If


                    New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & sCurrencySymbol & FormatNumber(fuelGalCost, 2, True, False, True) & "</font></td>" & vbCrLf
                    ' ok update the excell report with our item and value
                    'Call UpdateExcelReport(rngDirectCosts, "FuelCost", fuelGalCost)
                Else
                    New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
                    ' ok update the excell report with our item and value
                    'Call UpdateExcelReport(rngDirectCosts, "FuelCost", 0)
                End If
            Else
                If CDbl(Session.Item("fuelPriceBase")) > 0 Then
                    'If Session.item("useMetricValues") Then
                    '  fuelGalCost = ConvertUSToMetricValue("PPG", CDbl(Session.Item("fuelPriceBase")))
                    'Else
                    '  fuelGalCost = CDbl(Session.Item("fuelPriceBase"))
                    'End If
                    ' If CDbl(Session.item("currencyExchangeRate")) > 0 Then
                    'fuelGalCost = ConvertUSToForeignCurrency(Session.item("currencyExchangeRate"), fuelGalCost)
                    ' End If
                    New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & sCurrencySymbol & FormatNumber(fuelGalCost, 2, True, False, True) & "</font></td>" & vbCrLf
                    ' ok update the excell report with our item and value
                    'Call UpdateExcelReport(rngDirectCosts, "FuelCost", fuelGalCost)
                Else
                    New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
                    ' ok update the excell report with our item and value
                    'Call UpdateExcelReport(rngDirectCosts, "FuelCost", 0)
                End If
            End If


            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf


            If Session.Item("useMetricValues") Then
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;&nbsp;&nbsp;&nbsp;Additive&nbsp;Cost&nbsp;Per&nbsp;" & TranslateUSMetricUnitsLong("GAL") & "</font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;&nbsp;&nbsp;&nbsp;Additive&nbsp;Cost&nbsp;Per&nbsp;Gallon</font></td>" & vbCrLf
            End If

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"

            If Not IsDBNull(localAdoRs("amod_fuel_add_cost")) Then
                'If Session.item("useMetricValues") Then
                '  fuelAddCost = ConvertUSToMetricValue("PPG", CDbl(localAdoRs("amod_fuel_add_cost")))
                'Else
                '  fuelAddCost = CDbl(localAdoRs("amod_fuel_add_cost"))
                'End If
                '  If CDbl(Session.item("currencyExchangeRate")) > 0 Then
                'fuelAddCost = ConvertUSToForeignCurrency(Session.item("currencyExchangeRate"), fuelAddCost)
                'End If
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & sCurrencySymbol & FormatNumber(fuelAddCost, 2, True, False, True) & "</font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
            End If


            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf

            If Session.Item("useMetricValues") Then
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;&nbsp;&nbsp;&nbsp;Burn Rate (" & TranslateUSMetricUnitsLong("GAL") & "s/Hour)</font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;&nbsp;&nbsp;&nbsp;Burn Rate (Gallons/Hour)</font></td>" & vbCrLf
            End If

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"

            If Not IsDBNull(localAdoRs("amod_fuel_burn_rate")) Then
                'If Session.item("useMetricValues") Then
                '  fuelBurnRate = ConvertUSToMetricValue("GAL", CDbl(localAdoRs("amod_fuel_burn_rate")))
                'Else
                '  fuelBurnRate = CDbl(localAdoRs("amod_fuel_burn_rate"))
                'End If
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(fuelBurnRate, 2, True, False, True) & "</font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
            End If


            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf


            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'><u>Maintenance</u></font></td>" & vbCrLf

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"





            If Not IsDBNull(localAdoRs("amod_maint_tot_cost")) Then


                totalmaintcost = System.Math.Round(CDbl(localAdoRs("amod_maint_lab_cost")), 2) + System.Math.Round(CDbl(localAdoRs("amod_maint_parts_cost")), 2)

                totalmaintcost = System.Math.Round(totalmaintcost, 2)

                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    totalmaintcost = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), totalmaintcost)
                    totalmaintcost = System.Math.Round(totalmaintcost, 2)
                End If

                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right' valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font color='red' class=""emphasis"">" & sCurrencySymbol & FormatNumber(totalmaintcost, 2, True, False, True) & "</font></font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
            End If


            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf


            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;&nbsp;&nbsp;&nbsp;Labor Cost Per Hour</font></td>" & vbCrLf

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"
            If Not IsDBNull(localAdoRs("amod_maint_lab_cost")) Then
                tmpCDblValue = System.Math.Round(CDbl(localAdoRs("amod_maint_lab_cost")), 2)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    tmpCDblValue = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), tmpCDblValue)
                    tmpCDblValue = System.Math.Round(tmpCDblValue, 2)
                End If

                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & sCurrencySymbol & FormatNumber(tmpCDblValue, 2, True, False, True) & "</font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
            End If

            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf


            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;&nbsp;&nbsp;&nbsp;Parts Per Hour Cost</font></td>" & vbCrLf

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"

            If Not IsDBNull(localAdoRs("amod_maint_parts_cost")) Then
                tmpCDblValue = System.Math.Round(CDbl(localAdoRs("amod_maint_parts_cost")), 2)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    tmpCDblValue = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), tmpCDblValue)
                    tmpCDblValue = System.Math.Round(tmpCDblValue, 2)
                End If

                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & sCurrencySymbol & FormatNumber(tmpCDblValue, 2, True, False, True) & "</font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
            End If


            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf


            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Engine Overhaul</font></td>" & vbCrLf

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"
            If Not IsDBNull(localAdoRs("amod_engine_ovh_cost")) Then
                overhaulcost = System.Math.Round(CDbl(localAdoRs("amod_engine_ovh_cost")), 2)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    overhaulcost = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), overhaulcost)
                    overhaulcost = System.Math.Round(overhaulcost, 2)
                End If

                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & sCurrencySymbol & FormatNumber(overhaulcost, 2, True, False, True) & "</font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
            End If


            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf


            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Thrust Reverse Overhaul</font></td>" & vbCrLf


            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"
            If Not IsDBNull(localAdoRs("amod_thrust_rev_ovh_cost")) Then
                revoverhaulcost = System.Math.Round(CDbl(localAdoRs("amod_thrust_rev_ovh_cost")), 2)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    revoverhaulcost = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), revoverhaulcost)
                    revoverhaulcost = System.Math.Round(revoverhaulcost, 2)
                End If
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & sCurrencySymbol & FormatNumber(revoverhaulcost, 2, True, False, True) & "</font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
            End If


            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf


            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'><u>Misc Flight&nbsp;Expenses</u></font></td>" & vbCrLf

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"
            If Not IsDBNull(localAdoRs("amod_misc_flight_cost")) Then

                'tmpCDblValue = CDbl(localAdoRs("amod_misc_flight_cost"))
                miscflightcosts = System.Math.Round(CDbl(localAdoRs("amod_land_park_cost")), 2) + System.Math.Round(CDbl(localAdoRs("amod_crew_exp_cost")), 2) + System.Math.Round(CDbl(localAdoRs("amod_supplies_cost")), 2)
                miscflightcosts = System.Math.Round(miscflightcosts, 2)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    miscflightcosts = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), miscflightcosts)
                    miscflightcosts = System.Math.Round(miscflightcosts, 2)
                End If
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right' valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font color=""red"" class=""emphasis"">" & sCurrencySymbol & FormatNumber(miscflightcosts, 2, True, False, True) & "</font></font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
            End If


            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf


            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'> &nbsp;&nbsp;&nbsp;&nbsp;Landing-Parking Fee</font></td>" & vbCrLf

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"
            If Not IsDBNull(localAdoRs("amod_land_park_cost")) Then
                tmpCDblValue = System.Math.Round(CDbl(localAdoRs("amod_land_park_cost")), 2)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    tmpCDblValue = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), tmpCDblValue)
                    tmpCDblValue = System.Math.Round(tmpCDblValue, 2)
                End If
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & sCurrencySymbol & FormatNumber(tmpCDblValue, 2, True, False, True) & "</font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
            End If


            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf


            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;&nbsp;&nbsp;&nbsp;Crew Expenses</font></td>" & vbCrLf

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"

            If Not IsDBNull(localAdoRs("amod_crew_exp_cost")) Then
                tmpCDblValue = System.Math.Round(CDbl(localAdoRs("amod_crew_exp_cost")), 2)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    tmpCDblValue = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), tmpCDblValue)
                    tmpCDblValue = System.Math.Round(tmpCDblValue, 2)
                End If
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & sCurrencySymbol & FormatNumber(tmpCDblValue, 2, True, False, True) & "</font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
            End If


            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf


            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;&nbsp;&nbsp;&nbsp;Supplies-Catering</font></td>" & vbCrLf

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"

            If Not IsDBNull(localAdoRs("amod_supplies_cost")) Then
                tmpCDblValue = System.Math.Round(CDbl(localAdoRs("amod_supplies_cost")), 2)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    tmpCDblValue = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), tmpCDblValue)
                    tmpCDblValue = System.Math.Round(tmpCDblValue, 2)
                End If
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & sCurrencySymbol & FormatNumber(tmpCDblValue, 2, True, False, True) & "</font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf

            End If


            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf


            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Total Direct Costs</font></td>" & vbCrLf

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"
            ' THIS IS FOR TOTAL DIRECT COSTS
            If Not IsDBNull(localAdoRs("amod_tot_hour_direct_cost")) Then
                '  If Session.item("useMetricValues") Then
                ' totalDirCostHR = CDbl(fuelTotCost) + CDbl(amod_maint_tot_cost) + CDbl(amod_misc_flight_cost) + CDbl(amod_engine_ovh_cost) + CDbl(amod_thrust_rev_ovh_cost) 
                totalDirCostHR = System.Math.Round(CDbl(fuelTotCost), 2) + totalmaintcost + miscflightcosts + overhaulcost + revoverhaulcost

                'Else
                '  totalDirCostHR = CDbl(localAdoRs.Item("amod_tot_hour_direct_cost"))
                '  End If
                totalDirCostHR = System.Math.Round(totalDirCostHR, 2)
                tmpCDblValue = totalDirCostHR
                ' If CDbl(Session.item("currencyExchangeRate")) > 0 Then
                'tmpCDblValue = ConvertUSToForeignCurrency(Session.item("currencyExchangeRate"), tmpCDblValue)
                'End If
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right' valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font color='red' class=""emphasis"">" & sCurrencySymbol & FormatNumber(tmpCDblValue, 2, True, False, True) & "</font></font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
            End If


            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf


            If Session.Item("useMetricValues") Then
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><br>Block&nbsp;Speed&nbsp;" & TranslateUSMetricUnitsLong("SM") & "s/Hour</font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><br>Block&nbsp;Speed&nbsp;Statute&nbsp;Miles/Hour</font></td>" & vbCrLf
            End If

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"

            If Not IsDBNull(localAdoRs("amod_avg_block_speed")) Then
                If Session.Item("useMetricValues") Then
                    avgBlockSpeed = System.Math.Round(ConvertUSToMetricValue("SM", CDbl(localAdoRs("amod_avg_block_speed"))), 0)
                Else
                    avgBlockSpeed = System.Math.Round(CDbl(localAdoRs("amod_avg_block_speed")), 0)
                End If
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><br>" & FormatNumber(avgBlockSpeed, 0, True, False, True) & "</font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
            End If


            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf


            If Session.Item("useMetricValues") Then
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Total Cost Per " & TranslateUSMetricUnitsLong("SM") & "</font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Total Cost Per Statute Mile</font></td>" & vbCrLf
            End If

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"
            If Session.Item("useMetricValues") Then
                totalCostPer = CDbl(CDbl(totalDirCostHR) / CDbl(avgBlockSpeed))
            Else
                totalCostPer = CDbl(CDbl(totalDirCostHR) / CDbl(avgBlockSpeed))
                'totalCostPer = CDbl(localAdoRs("amod_tot_stat_mile_cost"))
            End If
            totalCostPer = System.Math.Round(totalCostPer, 2)
            tmpCDblValue = totalCostPer
            ' If CDbl(Session.item("currencyExchangeRate")) > 0 Then
            'tmpCDblValue = ConvertUSToForeignCurrency(Session.item("currencyExchangeRate"), tmpCDblValue)
            '  End If

            If Not IsDBNull(localAdoRs("amod_tot_stat_mile_cost")) Then
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right' valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font color='red' class=""emphasis"">" & sCurrencySymbol & FormatNumber(tmpCDblValue, 2, True, False, True) & "</font></font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
            End If


            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr>" & vbCrLf
            '  New_Build_OperatingCosts = New_Build_OperatingCosts & "</table><br>"




            ' New_Build_OperatingCosts = New_Build_OperatingCosts & "<tr><td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td></tr>"
            ''''''''''''''''''''''''''''''''''''''''''
            ' End DIRECT COSTS PER HOUR 
            '''''''''''''''''''''''''''''''''''''''''
            ''''''''''''''''''''''''''''''''''''''''''
            ' End DIRECT COSTS PER HOUR 
            '''''''''''''''''''''''''''''''''''''''''
            ''''''''''''''''''''''''''''''''''''''''''
            ' End DIRECT COSTS PER HOUR 
            '''''''''''''''''''''''''''''''''''''''''































            ''''''''''''''''''''''''''''''''''''''''''
            ' START OF SECTION SECTION ON LEFT 
            '''''''''''''''''''''''''''''''''''''''''

            bFirstOne = False

            'Loop
            bFirstOne = True
            '''''''''''''''''''''''
            ' Start ANNUAL BUDGET 
            '''''''''''''''''''''''

            bFirstOne = True
            ' EXTRA QUERY TAKEN OUT RTW/MSW 8/23
            bFirstOne = True
            nCount = 3

            ' New_Build_OperatingCosts = New_Build_OperatingCosts & "<td valign=top align=left rowspan='3' class='Operating_Costs_TD_Bottom'>"


            bFirstOne = False


            '''''''''''''''''''''
            ' End Annual Budge
            '''''''''''''''''''''

            New_Build_OperatingCosts = New_Build_OperatingCosts & "</table></div></td>"
            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td style='border-left:1px solid lightgrey;' width='1'></td><td width='30%' align='left'><div class=""Box removeTopPadding"">"

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<table border='0' cellpadding='2'  cellspacing='0' align='center' class=""formatTable"" width='98%'>"

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<tr><td align='left' colspan='3'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>ANNUAL FIXED COSTS</font></td></tr><tr>"
            ' EXTRA QUERY TAKEN OUT RTW/MSW 8/23
            bFirstOne = True
            nCount = 3


            'New_Build_OperatingCosts = New_Build_OperatingCosts & "<td valign='top' align='left' class='Operating_Costs_TD_Bottom'>"
            '  New_Build_OperatingCosts = New_Build_OperatingCosts & "<td width='50%' colspan='3'><table border='0' cellpadding='2' cellspacing='0'><tr>" & vbCrLf


            'New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"


            '   New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf


            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td width='50%' valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'><u>Crew Salaries</u></font></td>" & vbCrLf

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"
            If Not IsDBNull(localAdoRs("amod_tot_crew_salary_cost")) Then



                'Dim crewsalaries = 0

                crewsalaries = System.Math.Round(CDbl(localAdoRs("amod_capt_salary_cost")), 0) + System.Math.Round(CDbl(localAdoRs("amod_cpilot_salary_cost")), 0) + System.Math.Round(CDbl(localAdoRs("amod_crew_benefit_cost")), 0)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    crewsalaries = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), crewsalaries)
                    crewsalaries = System.Math.Round(crewsalaries, 0)
                End If

                crewsalaries = System.Math.Round(crewsalaries, 0)
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align=""right""  valign=""bottom""><font color=""red"" class=""emphasis""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & sCurrencySymbol & FormatNumber(crewsalaries, 0, True, False, True) & "</font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align=right>&nbsp;</td>" & vbCrLf
            End If


            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;&nbsp;&nbsp;&nbsp;Capt. Salary</font></td>" & vbCrLf

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"
            If Not IsDBNull(localAdoRs("amod_capt_salary_cost")) Then
                tmpCDblValue = System.Math.Round(CDbl(localAdoRs("amod_capt_salary_cost")), 0)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    tmpCDblValue = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), tmpCDblValue)
                    tmpCDblValue = System.Math.Round(tmpCDblValue, 0)
                End If
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align=right><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & sCurrencySymbol & FormatNumber(tmpCDblValue, 0, True, False, True) & "</font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align=right><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
            End If


            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf


            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;&nbsp;&nbsp;&nbsp;Co-pilot Salary</font></td>" & vbCrLf

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"
            If Not IsDBNull(localAdoRs("amod_cpilot_salary_cost")) Then
                tmpCDblValue = System.Math.Round(CDbl(localAdoRs("amod_cpilot_salary_cost")), 0)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    tmpCDblValue = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), tmpCDblValue)
                    tmpCDblValue = System.Math.Round(tmpCDblValue, 0)
                End If
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align=right><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & sCurrencySymbol & FormatNumber(tmpCDblValue, 0, True, False, True) & "</font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align=right><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
            End If

            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf


            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;&nbsp;&nbsp;&nbsp;Benefits</font></td>" & vbCrLf

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"
            If Not IsDBNull(localAdoRs("amod_crew_benefit_cost")) Then
                tmpCDblValue = System.Math.Round(CDbl(localAdoRs("amod_crew_benefit_cost")), 0)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    tmpCDblValue = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), tmpCDblValue)
                    tmpCDblValue = System.Math.Round(tmpCDblValue, 0)
                End If
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align=right><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & sCurrencySymbol & FormatNumber(tmpCDblValue, 0, True, False, True) & "</font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align=right><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
            End If

            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf


            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Hangar Cost</font></td>" & vbCrLf

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"
            If Not IsDBNull(localAdoRs("amod_hangar_cost")) Then
                'Dim hangercost = 0

                hangercost = System.Math.Round(CDbl(localAdoRs("amod_hangar_cost")), 0)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    hangercost = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), hangercost)
                End If
                hangercost = System.Math.Round(hangercost, 0)

                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align=right><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & sCurrencySymbol & FormatNumber(hangercost, 0, True, False, True) & "</font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align=right><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
            End If

            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf


            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'><u>Insurance</u></font></td>" & vbCrLf

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"
            If Not IsDBNull(localAdoRs("amod_insurance_cost")) Then
                insurancecost = System.Math.Round(CDbl(localAdoRs("amod_hull_insurance_cost")), 0) + System.Math.Round(CDbl(localAdoRs("amod_liability_insurance_cost")), 0)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    insurancecost = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), insurancecost)
                End If
                insurancecost = System.Math.Round(insurancecost, 0)
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td ""align=right"" valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font color=""red"" class=""emphasis"">" & sCurrencySymbol & FormatNumber(insurancecost, 0, True, False, True) & "</font></font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align=right><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
            End If

            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf


            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;&nbsp;&nbsp;&nbsp;Hull</font></td>" & vbCrLf

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"
            If Not IsDBNull(localAdoRs("amod_hull_insurance_cost")) Then
                tmpCDblValue = System.Math.Round(CDbl(localAdoRs("amod_hull_insurance_cost")), 0)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    tmpCDblValue = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), tmpCDblValue)
                    tmpCDblValue = System.Math.Round(tmpCDblValue, 0)
                End If
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align=right><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & sCurrencySymbol & FormatNumber(tmpCDblValue, 0, True, False, True) & "</font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align=right><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
            End If

            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf


            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;&nbsp;&nbsp;&nbsp;Legal Liability</font></td>" & vbCrLf

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"
            If Not IsDBNull(localAdoRs("amod_liability_insurance_cost")) Then
                tmpCDblValue = System.Math.Round(CDbl(localAdoRs("amod_liability_insurance_cost")), 0)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    tmpCDblValue = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), tmpCDblValue)
                End If
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align=right><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & sCurrencySymbol & FormatNumber(tmpCDblValue, 0, True, False, True) & "</font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align=right><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
            End If

            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf


            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'><u>Misc. Overhead</u></font></td>" & vbCrLf

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"
            If Not IsDBNull(localAdoRs("amod_tot_misc_ovh_cost")) Then
                'Dim miscoverhead = 0
                miscoverhead = System.Math.Round(CDbl(localAdoRs("amod_misc_train_cost")), 0) + System.Math.Round(CDbl(localAdoRs("amod_misc_modern_cost")), 0) + System.Math.Round(CDbl(localAdoRs("amod_misc_naveq_cost")), 0)

                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    miscoverhead = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), miscoverhead)
                    miscoverhead = System.Math.Round(miscoverhead, 0)
                End If


                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align=""right""  valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font color=""red"" class=""emphasis"">" & sCurrencySymbol & FormatNumber(miscoverhead, 0, True, False, True) & "</font></font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align=right><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
            End If

            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf


            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;&nbsp;&nbsp;&nbsp;Training</font></td>" & vbCrLf

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"
            If Not IsDBNull(localAdoRs("amod_misc_train_cost")) Then
                tmpCDblValue = System.Math.Round(CDbl(localAdoRs("amod_misc_train_cost")), 0)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    tmpCDblValue = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), tmpCDblValue)
                    tmpCDblValue = System.Math.Round(tmpCDblValue, 0)
                End If
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align=right><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & sCurrencySymbol & FormatNumber(tmpCDblValue, 0, True, False, True) & "</font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align=right><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
            End If

            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf


            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;&nbsp;&nbsp;&nbsp;Modernization</font></td>" & vbCrLf

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"
            If Not IsDBNull(localAdoRs("amod_misc_modern_cost")) Then
                tmpCDblValue = System.Math.Round(CDbl(localAdoRs("amod_misc_modern_cost")), 0)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    tmpCDblValue = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), tmpCDblValue)
                    tmpCDblValue = System.Math.Round(tmpCDblValue, 0)
                End If
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align=right><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & sCurrencySymbol & FormatNumber(tmpCDblValue, 0, True, False, True) & "</font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align=right><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
            End If

            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf


            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;&nbsp;&nbsp;&nbsp;Nav. Equipment</font></td>" & vbCrLf

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"
            If Not IsDBNull(localAdoRs("amod_misc_naveq_cost")) Then
                tmpCDblValue = System.Math.Round(CDbl(localAdoRs("amod_misc_naveq_cost")), 0)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    tmpCDblValue = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), tmpCDblValue)
                    tmpCDblValue = System.Math.Round(tmpCDblValue, 0)
                End If
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align=right><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & sCurrencySymbol & FormatNumber(tmpCDblValue, 0, True, False, True) & "</font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align=right><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
            End If

            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf


            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Depreciation</font></td>" & vbCrLf

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"
            If Not IsDBNull(localAdoRs("amod_deprec_cost")) Then
                'Dim depoverhead = 0
                depoverhead = System.Math.Round(CDbl(localAdoRs("amod_deprec_cost")), 0)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    depoverhead = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), depoverhead)
                End If
                depoverhead = System.Math.Round(depoverhead, 0)

                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align=right><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & sCurrencySymbol & FormatNumber(depoverhead, 0, True, False, True) & "</font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align=right><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
            End If

            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf


            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Total Fixed Costs</font></td>" & vbCrLf

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"
            If Not IsDBNull(localAdoRs("amod_tot_fixed_cost")) Then

                totalfixedcost = crewsalaries + hangercost + miscoverhead + depoverhead + insurancecost

                totalfixedcost = System.Math.Round(totalfixedcost, 0)


                '   If CDbl(Session.item("currencyExchangeRate")) > 0 Then
                'tmpCDblValue = ConvertUSToForeignCurrency(Session.item("currencyExchangeRate"), tmpCDblValue)
                ' End If
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align=""right"" valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font color=""red"" class=""emphasis"">" & sCurrencySymbol & FormatNumber(totalfixedcost, 0, True, False, True) & "</font></font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align=right><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
            End If



            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr></table>"
            '  New_Build_OperatingCosts = New_Build_OperatingCosts & "</td></tr></table>"
            '   ------------------------------------------------------- THIS IS THE END OF THE LEFT SIDE INFO -----------------------------------------------------------------
            '   ------------------------------------------------------- THIS IS THE END OF THE LEFT SIDE INFO -----------------------------------------------------------------
            '   ------------------------------------------------------- THIS IS THE END OF THE LEFT SIDE INFO -----------------------------------------------------------------























            New_Build_OperatingCosts = New_Build_OperatingCosts & "</div></td>"

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td style='border-left:1px solid lightgrey;' width='1'></td>"

            ' THIS IS BEGGINNING OF RIGHT COLUMN ----------------------------------------------------------------------------
            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='left'  width='30%' class='Operating_Costs_TD_Top_3' valign='top'><div class=""Box removeTopPadding"">"
            ' THIS IS BEGGINNING OF RIGHT COLUMN -----------------------------------------------------------------------------


            New_Build_OperatingCosts = New_Build_OperatingCosts & "<table border=0 cellpadding=2 cellspacing=0 width='98%' class=""formatTable""><tr>" & vbCrLf


            ' New_Build_OperatingCosts = New_Build_OperatingCosts & "<td></td>"

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td colspan='3'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>ANNUAL BUDGET</font></td></tr><tr>" & vbCrLf


            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;&nbsp;&nbsp;&nbsp;Number of Seats</font></td>" & vbCrLf

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"
            If Not IsDBNull(localAdoRs("amod_number_of_seats")) Then
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align=right><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(System.Math.Round(CDbl(localAdoRs("amod_number_of_seats")), 0), 0, True, False, True) & "</font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align=right><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
            End If

            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf


            If Session.Item("useMetricValues") Then
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;&nbsp;&nbsp;&nbsp;" & TranslateUSMetricUnitsLong("M") & "s</font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;&nbsp;&nbsp;&nbsp;Miles</font></td>" & vbCrLf
            End If

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"
            If Not IsDBNull(localAdoRs("amod_annual_miles")) Then
                If Session.Item("useMetricValues") Then
                    annualMiles = ConvertUSToMetricValue("M", CDbl(localAdoRs("amod_annual_miles")))
                Else
                    annualMiles = CDbl(localAdoRs("amod_annual_miles"))
                End If
                annualMiles = System.Math.Round(annualMiles, 0)
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align=right><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(annualMiles, 0, True, False, True) & "</font></td>" & vbCrLf
            Else
                Response.Write("<td align=right>&nbsp;</td>" & vbCrLf)
            End If

            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf


            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;&nbsp;&nbsp;&nbsp;Hours</font></td>" & vbCrLf

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"
            If Not IsDBNull(localAdoRs("amod_annual_hours")) Then
                'If Session.item("useMetricValues") Then
                ' annualHrs = Round(CDbl(annualMiles) / CDbl(avgBlockSpeed), 0)
                '  annualHrs = CDbl(localAdoRs("amod_annual_hours"))
                '   annualHrs = CDbl(annualMiles) / CDbl(avgBlockSpeed)
                ' Else
                annualHrs = CDbl(annualMiles) / CDbl(avgBlockSpeed)
                ' End If
                annualHrs = System.Math.Round(annualHrs, 0)

                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right' valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font color='red' class=""emphasis"">" & FormatNumber(annualHrs, 0, True, False, True) & "</font></font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
            End If


            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf
            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td colspan=""3""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf


            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>&nbsp;&nbsp;Total Direct Costs</font></td>" & vbCrLf

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"
            If Not IsDBNull(localAdoRs("amod_tot_direct_cost")) Then


                ' CALCULATING EITHER WAY FOR ACCURATE VALUES
                ' If Not Session.item("useMetricValues") Then
                'totalDirCostYR = annualHrs * totalDirCostHR
                ' Else
                totalDirCostYR = annualHrs * totalDirCostHR
                '  End If


                totalDirCostYR = System.Math.Round(totalDirCostYR, 0)
                tmpCDblValue = totalDirCostYR
                ' If CDbl(Session.item("currencyExchangeRate")) > 0 Then
                'tmpCDblValue = ConvertUSToForeignCurrency(Session.item("currencyExchangeRate"), tmpCDblValue)
                ' End If
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right' valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font color='red' class=""emphasis"">" & sCurrencySymbol & FormatNumber(tmpCDblValue, 0, True, False, True) & "</font></font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
            End If

            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf


            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>&nbsp;&nbsp;Total Fixed Costs</font></td>" & vbCrLf

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"
            If Not IsDBNull(localAdoRs("amod_tot_fixed_cost")) Then
                'tmpCDblValue = System.Math.Round(CDbl(localAdoRs("amod_tot_fixed_cost")), 0)
                If CDbl(Session.Item("currencyExchangeRate")) > 0 Then
                    tmpCDblValue = ConvertUSToForeignCurrency(Session.Item("currencyExchangeRate"), tmpCDblValue)
                End If
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right' valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font color='red' class=""emphasis"">" & sCurrencySymbol & FormatNumber(totalfixedcost, 0, True, False, True) & "</font></font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
            End If

            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf


            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>&nbsp;&nbsp;<u>Total Cost (Fixed & Direct)</u></font></td>" & vbCrLf

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"
            If Not IsDBNull(localAdoRs("amod_tot_df_annual_cost")) Then
                'If Session.item("useMetricValues") Then
                ' totalFixedDirect = CDbl(CDbl(totalDirCostYR) + CDbl(localAdoRs("amod_tot_fixed_cost")))
                totalFixedDirect = totalDirCostYR + totalfixedcost

                'Else
                ' totalFixedDirect = CDbl(CDbl(totalDirCostYR) + CDbl(localAdoRs("amod_tot_fixed_cost")))
                'totalFixedDirect = CDbl(localAdoRs("amod_tot_df_annual_cost"))
                ' CALCULATING EITHER WAY FOR MORE ACCURATE
                ' End If
                tmpCDblValue = totalFixedDirect
                'If CDbl(Session.item("currencyExchangeRate")) > 0 Then
                'tmpCDblValue = ConvertUSToForeignCurrency(Session.item("currencyExchangeRate"), tmpCDblValue)
                ' End If
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right' valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font color='red' class=""emphasis"">" & sCurrencySymbol & FormatNumber(tmpCDblValue, 0, True, False, True) & "</font></font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align=right><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
            End If

            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf


            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;&nbsp;&nbsp;&nbsp;Cost/Hour</font></td>" & vbCrLf

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"
            If Not IsDBNull(localAdoRs("amod_tot_df_hour_cost")) Then
                If Session.Item("useMetricValues") Then
                    ' dfhourcost = dCDbl(CDbl(totalFixedDirect) / CDbl(annualHrs))
                    dfhourcost = totalFixedDirect / annualHrs
                Else
                    dfhourcost = totalFixedDirect / annualHrs
                    '  dfhourcost = CDbl(localAdoRs("amod_tot_df_hour_cost"))
                    ' CALCULATING EITHER WAY FOR MORE ACCURATE
                End If

                dfhourcost = System.Math.Round(dfhourcost, 0)
                tmpCDblValue = dfhourcost
                '  If CDbl(Session.item("currencyExchangeRate")) > 0 Then
                '      tmpCDblValue = ConvertUSToForeignCurrency(Session.item("currencyExchangeRate"), tmpCDblValue)
                'End If
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right' valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font color='red' class=""emphasis"">" & sCurrencySymbol & FormatNumber(tmpCDblValue, 0, True, False, True) & "</font></font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align=right><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
            End If

            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf


            If Session.Item("useMetricValues") Then
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;&nbsp;&nbsp;&nbsp;Cost/" & TranslateUSMetricUnitsLong("SM") & "</font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;&nbsp;&nbsp;&nbsp;Cost/Statute Mile</font></td>" & vbCrLf
            End If

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"
            If Not IsDBNull(localAdoRs("amod_tot_df_statmile_cost")) Then
                If Session.Item("useMetricValues") Then
                    'dfstatmilecost = CDbl(CDbl(totalFixedDirect) / CDbl(annualMiles))
                    dfstatmilecost = totalFixedDirect / annualMiles
                Else
                    dfstatmilecost = totalFixedDirect / annualMiles
                    ' dfstatmilecost = CDbl(localAdoRs("amod_tot_df_statmile_cost"))
                End If
                dfstatmilecost = System.Math.Round(dfstatmilecost, 2)
                tmpCDblValue = dfstatmilecost
                '  If CDbl(Session.item("currencyExchangeRate")) > 0 Then
                'tmpCDblValue = ConvertUSToForeignCurrency(Session.item("currencyExchangeRate"), tmpCDblValue)
                '    End If
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right' valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font color='red' class=""emphasis"">" & sCurrencySymbol & FormatNumber(tmpCDblValue, 2, True, False, True) & "</font></font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align=right><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
            End If

            New_Build_OperatingCosts = New_Build_OperatingCosts & "  </tr><tr>" & vbCrLf


            If Session.Item("useMetricValues") Then
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;&nbsp;&nbsp;&nbsp;Cost/Seat " & TranslateUSMetricUnitsLong("M") & "</font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;&nbsp;&nbsp;&nbsp;Cost/Seat Mile</font></td>" & vbCrLf
            End If

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"
            If Not IsDBNull(localAdoRs("amod_tot_df_seat_cost")) Then
                '  If Session.item("useMetricValues") Then
                ' dfseatcost = CDbl(CDbl(dfstatmilecost) / CDbl(localAdoRs("amod_number_of_seats")))
                dfseatcost = dfstatmilecost / System.Math.Round(localAdoRs("amod_number_of_seats"), 0)
                ' Else
                '  dfseatcost = dfstatmilecost / CDbl(localAdoRs("amod_number_of_seats")))
                ' dfseatcost = CDbl(localAdoRs("amod_tot_df_seat_cost"))
                'End If
                dfseatcost = System.Math.Round(dfseatcost, 2)
                tmpCDblValue = dfseatcost
                '    If CDbl(Session.item("currencyExchangeRate")) > 0 Then
                'tmpCDblValue = ConvertUSToForeignCurrency(Session.item("currencyExchangeRate"), tmpCDblValue)
                '   End If
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right' valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font color='red' class=""emphasis"">" & sCurrencySymbol & FormatNumber(tmpCDblValue, 2, True, False, True) & "</font></font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align=right><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
            End If


            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf
            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td colspan=""3""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf


            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td nowrap='nowrap' valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>&nbsp;<u>Total Cost (No Depreciation)</u></font></td>" & vbCrLf

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"

            'If Session.item("useMetricValues") Then
            TCND = totalFixedDirect - depoverhead
            ' Else
            'TCND = CDbl(CDbl(localAdoRs("amod_tot_df_annual_cost")) - CDbl(localAdoRs("amod_deprec_cost")))
            'End If
            TCND = System.Math.Round(TCND, 0)
            tmpCDblValue = TCND
            '     If CDbl(Session.item("currencyExchangeRate")) > 0 Then
            'tmpCDblValue = ConvertUSToForeignCurrency(Session.item("currencyExchangeRate"), tmpCDblValue)
            '    End If

            If tmpCDblValue > 0 Then
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right' valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font color='red' class=""emphasis"">" & sCurrencySymbol & FormatNumber(tmpCDblValue, 0, True, False, True) & "</font></font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font color='red class=""emphasis""'>" & sCurrencySymbol & "0.00</font></font></td>" & vbCrLf
            End If

            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf


            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;&nbsp;&nbsp;&nbsp;Cost/Hour</font></td>" & vbCrLf

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"
            If Not IsDBNull(localAdoRs("amod_annual_hours")) Then
                If localAdoRs("amod_annual_hours") > 0 Then
                    ' If Session.item("useMetricValues") Then


                    ANCH = TCND / annualHrs
                    ' THIS IS CALCULATING THE TOTAL 

                    'Else
                    '  ANCH = CDbl(CDbl(TCND) / CDbl(localAdoRs("amod_annual_hours")))

                    ' End If
                    ANCH = System.Math.Round(ANCH, 0)
                    tmpCDblValue = ANCH
                    '   If CDbl(Session.item("currencyExchangeRate")) > 0 Then
                    'tmpCDblValue = ConvertUSToForeignCurrency(Session.item("currencyExchangeRate"), tmpCDblValue)
                    '   End If

                    New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right' valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font color='red' class=""emphasis"">" & sCurrencySymbol & FormatNumber(tmpCDblValue, 0, True, False, True) & "</font></font></td>" & vbCrLf
                Else
                    New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right' valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font color='red' class=""emphasis"">" & sCurrencySymbol & "0.00</font></font></td>" & vbCrLf
                End If
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right' valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font color='red' class=""emphasis"">" & sCurrencySymbol & "0.00</font></font></td>" & vbCrLf
            End If

            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf


            If Session.Item("useMetricValues") Then
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;&nbsp;&nbsp;&nbsp;Cost/" & TranslateUSMetricUnitsLong("SM") & "</font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;&nbsp;&nbsp;&nbsp;Cost/Statute Mile</font></td>" & vbCrLf
            End If

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"

            If Not IsDBNull(localAdoRs("amod_annual_miles")) Then
                If localAdoRs("amod_annual_miles") > 0 Then
                    ' If Session.item("useMetricValues") Then
                    TCSM = TCND / annualMiles
                    'Else
                    '  TCSM = CDbl(CDbl(TCND) / CDbl(localAdoRs("amod_annual_miles")))
                    ' End If
                    TCSM = System.Math.Round(TCSM, 3)
                    tmpCDblValue = TCSM
                    ' If CDbl(Session.item("currencyExchangeRate")) > 0 Then
                    'tmpCDblValue = ConvertUSToForeignCurrency(Session.item("currencyExchangeRate"), tmpCDblValue)
                    '  End If

                    New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right' valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font color='red' class=""emphasis"">" & sCurrencySymbol & FormatNumber(tmpCDblValue, 2, True, False, True) & "</font></font></td>" & vbCrLf
                Else
                    New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right' valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font color='red' class=""emphasis"">" & sCurrencySymbol & "0.00</font></font></td>" & vbCrLf
                End If
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right' valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font color='red' class=""emphasis"">" & sCurrencySymbol & "0.00</font></font></td>" & vbCrLf
            End If

            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr><tr>" & vbCrLf


            If Session.Item("useMetricValues") Then
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;&nbsp;&nbsp;&nbsp;Cost/Seat " & TranslateUSMetricUnitsLong("M") & "</font></td>" & vbCrLf
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;&nbsp;&nbsp;&nbsp;Cost/Seat Mile</font></td>" & vbCrLf
            End If

            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>"

            If Not IsDBNull(localAdoRs("amod_number_of_seats")) Then
                If localAdoRs("amod_number_of_seats") > 0 Then
                    TCST = TCSM / System.Math.Round(localAdoRs("amod_number_of_seats"), 0)
                    TCST = System.Math.Round(TCST, 2)
                    tmpCDblValue = TCST
                    '  If CDbl(Session.item("currencyExchangeRate")) > 0 Then
                    'tmpCDblValue = ConvertUSToForeignCurrency(Session.item("currencyExchangeRate"), tmpCDblValue)
                    '  End If
                    New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right' valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font color='red' class=""emphasis"">" & sCurrencySymbol & FormatNumber(tmpCDblValue, 2, True, False, True) & "</font></font></td>" & vbCrLf
                Else
                    New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right' valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font color='red' class=""emphasis"">" & sCurrencySymbol & "0.00</font></font></td>" & vbCrLf
                End If
            Else
                New_Build_OperatingCosts = New_Build_OperatingCosts & "<td align='right' valign=""bottom""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font color='red' class=""emphasis"">" & sCurrencySymbol & "0.00</font></font></td>" & vbCrLf
            End If


            New_Build_OperatingCosts = New_Build_OperatingCosts & "  </tr>" & vbCrLf

            'close annual budget table
            New_Build_OperatingCosts = New_Build_OperatingCosts & "</table></div></td>" & vbCrLf

            ' THIS ENDS THE INITIAL ROW CONTAINING ALL INFO AND THEN STARTS NEW ROW-------------------------------------------------------
            New_Build_OperatingCosts = New_Build_OperatingCosts & "</tr>"
            New_Build_OperatingCosts = New_Build_OperatingCosts & "<tr>"
            '-----------------------------------------------------------------------------------------------------------------------------

            ' THIS IS THE LAST COLUMN -------------------------------------------------------------------
            New_Build_OperatingCosts = New_Build_OperatingCosts & "<td colspan='5' class='Operating_Costs_TD_Bottom'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td></tr></table></td></tr>"
            'New_Build_OperatingCosts = New_Build_OperatingCosts & "<td colspan='5' class='Operating_Costs_TD_Top_1'>&nbsp;</td></tr></table>"
            ' THIS IS THE LAST COLUMN -------------------------------------------------------------------

            bFirstOne = False


        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in New_Build_OperatingCosts: " & ex.Message
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function
    Public Function Build_AircraftForSale(ByVal inModelID As Integer, ByVal InSortBy As String, ByVal bUseHeight As Boolean, ByVal table_height As String, ByRef foot_space_ac_for_sale As String) As String
        Build_AircraftForSale = ""

        Dim outStr As String = ""
        Dim forSaleCount As Long = 0
        Dim bHadStatus As Boolean

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim adors As System.Data.SqlClient.SqlDataReader : adors = Nothing
        Dim adoOwnerRs As System.Data.DataSet
        Dim query As String : query = ""
        Dim top_comp_id As Long = 0


        Dim adUseClient As Integer = 0
        Dim adUseServer As Integer = 0
        outStr = ""
        forSaleCount = 0
        Dim GetForSaleInfo As String = ""
        Dim page_break_count As Integer = 42



        Try

            GetForSaleInfo = "No ForSale Information at this time, for this Make/Model ..."


            query = "SELECT ac_ser_no_full, ac_ser_no_sort, ac_reg_no, ac_mfr_year, ac_airframe_tot_hrs, ac_status, ac_asking, ac_asking_price, ac_id, ac_journ_id, amod_make_name, "

            query = query & " (select top 1  comp_id  FROM company"
            query = query & " INNER JOIN aircraft_reference WITH(NOLOCK) ON comp_id = cref_comp_id AND comp_journ_id = cref_journ_id"
            query = query & " WHERE cref_ac_id = ac_id AND cref_journ_id = 0 AND cref_contact_type IN ('99','93','00', '08') ORDER BY cref_contact_type DESC, cref_transmit_seq_no asc) AS displaycompany"


            query = query & " FROM Aircraft WITH(NOLOCK) INNER JOIN Aircraft_Model WITH(NOLOCK) ON ac_amod_id = amod_id WHERE amod_id = " & CStr(inModelID) & " AND ac_journ_id = 0"
            'query = query & commonEVO.GenerateProductCodeSelectionQuery("", "", False, False, False)
            query = query & " AND ac_forsale_flag = 'Y'"



            If Not localCriteria.ViewCriteriaHasHelicopterFlag And Not localCriteria.ViewCriteriaHasBusinessFlag And Not localCriteria.ViewCriteriaHasCommercialFlag And localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_NONE Then
                localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_ALL ' use subscribers product code(s) for queries
            ElseIf localCriteria.ViewCriteriaHasHelicopterFlag And localCriteria.ViewCriteriaHasBusinessFlag And localCriteria.ViewCriteriaHasCommercialFlag And localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_NONE Then
                localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_ALL ' use subscribers product code(s) for queries
            End If

            If localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_ALL Then
                query = query & "  " + commonEvo.GenerateProductCodeSelectionQuery(HttpContext.Current.Session.Item("localPreferences"), False, True)
            Else
                query = query & "  " + commonEvo.BuildProductCodeCheckWhereClause(localCriteria.ViewCriteriaHasHelicopterFlag, localCriteria.ViewCriteriaHasBusinessFlag, localCriteria.ViewCriteriaHasCommercialFlag, False, False, False, False)
            End If






            Select Case (InSortBy)
                Case "serno"
                    query = query & " ORDER BY ac_ser_no_sort, ac_reg_no, ac_airframe_tot_hrs, ac_mfr_year"

                Case "regno"
                    query = query & " ORDER BY ac_reg_no, ac_ser_no_sort, ac_airframe_tot_hrs, ac_mfr_year"

                Case "aftt"
                    query = query & " ORDER BY ac_airframe_tot_hrs, ac_ser_no_sort, ac_reg_no, ac_mfr_year"

                Case "mfryear"
                    query = query & " ORDER BY ac_mfr_year, ac_ser_no_sort, ac_reg_no, ac_airframe_tot_hrs"

                Case Else
                    query = query & " ORDER BY ac_ser_no_sort, ac_reg_no, ac_airframe_tot_hrs, ac_mfr_year"

            End Select
            GetForSaleInfo = ""

            If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                If Not bUseHeight Then
                    GetForSaleInfo = GetForSaleInfo & "<table id='forSaleOuterTable' width='" & word_width & "' cellspacing='0' cellpadding='1'>"
                Else
                    GetForSaleInfo = GetForSaleInfo & "<table id='forSaleOuterTable' width='" & word_width & "' height='" & table_height & "' cellspacing='0' cellpadding='1' class='leftside_right'>"
                End If
            Else
                If Not bUseHeight Then
                    GetForSaleInfo = GetForSaleInfo & "<table id='forSaleOuterTable' width='100%' cellspacing='0' cellpadding='1'>"
                Else
                    GetForSaleInfo = GetForSaleInfo & "<table id='forSaleOuterTable' width='100%' height='" & table_height & "' cellspacing='0' cellpadding='1' class='leftside_right'>"
                End If
            End If



            If Me.logo_check.Checked = True Then
                GetForSaleInfo = GetForSaleInfo & "<tr class='table_specs'><td valign='top' align='center'>"
                GetForSaleInfo = GetForSaleInfo & get_company_images(real_make_model_name)
                GetForSaleInfo = GetForSaleInfo & "</td></tr>"
            Else
                GetForSaleInfo = GetForSaleInfo & "<tr class='table_specs'><td valign='top' align='center'><img src='" & location_string & "images/marketpdfheader.jpg'/></td></tr>"
            End If

            GetForSaleInfo = GetForSaleInfo & "<tr><td valign='top' align='center'><strong>" & real_make_model_name & " Aircraft For Sale</strong></td></tr>"

            'GetForSaleInfo = GetForSaleInfo & "<td class='border_bottom' width='20%' align='center'>&nbsp;</td>"

            If Session.Item("debug") And Session.Item("convertToPDFPath") = "" Then
                Response.Write("<b>getForSaleInfo : " & Server.HtmlEncode(query) & "</b><br /><br />")
            End If

            'Select Case Application.Item("webHostObject").evoWebHostType
            'Case eWebSiteTypes.LOCAL
            'SqlConn.ConnectionString = My.Settings.DEFAULT_LOCAL_MSSQL
            ' Case Else
            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            ' End Select

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = query

            adors = SqlCommand.ExecuteReader()


            If adors.HasRows Then
                If adors.HasRows Then
                    Do While adors.Read
                        forSaleCount = forSaleCount + 1
                    Loop
                    If forSaleCount = 0 Then
                        Exit Function
                    Else
                        adors.Close()
                        SqlCommand.CommandText = query
                        adors = SqlCommand.ExecuteReader()
                        'adors.Read()
                    End If
                Else
                    Exit Function
                End If

                outStr = "<table border='1' id='forSaleInnerTable' width='99%' cellpadding='1' cellspacing='0' align='center'><tr><td class='table_specs' width='15%'><strong>Serial#</strong></td><td class='table_specs'><strong>Reg#</strong></td><td class='table_specs' width='4%'><strong>Year MFR</strong></td><td class='table_specs' nowrap='nowrap'><strong>For Sale Status</strong></td><td class='table_specs' width='4%'><strong>Hours</strong></td><td class='table_specs'><strong>Owner/Exclusive Broker </strong></td></tr>" & vbCrLf
                Dim current_row As Integer = 0
                ' approximately limit 50 cells per page
                Do While adors.Read

                    bHadStatus = False

                    outStr = outStr & "<tr><td align='left' valign='top' class='table_specs'>" & vbCrLf
                    If Not IsDBNull(adors.Item("ac_ser_no_full")) Then

                        If adors.Item("ac_ser_no_full") <> "" Then
                            'outStr = outStr & "<font size='-1'>"
                            outStr = outStr & adors.Item("ac_ser_no_full") & "</td><td class='table_specs'>"
                        Else
                            outStr = outStr & "&nbsp;</td><td class='table_specs'>"
                        End If
                    Else
                        outStr = outStr & "&nbsp;</td><td class='table_specs'>"
                    End If

                    If Not IsDBNull(adors.Item("ac_reg_no")) Then
                        If adors.Item("ac_reg_no") <> "" Then
                            outStr = outStr & adors.Item("ac_reg_no") & "</td><td class='table_specs'>" & vbCrLf
                        Else
                            outStr = outStr & "&nbsp;</td><td class='table_specs'>" & vbCrLf
                        End If
                    Else
                        outStr = outStr & "&nbsp;</td><td class='table_specs'>" & vbCrLf
                    End If

                    'outStr = outStr & adors.Item("ac_ser_no_full") & "</td><td>" & adors.Item("ac_reg_no") & "</td><td>" & vbCrLf

                    If Not IsDBNull(adors.Item("ac_mfr_year")) Then
                        If CDbl(adors.Item("ac_mfr_year")) = 0 Then
                            outStr = outStr & "&nbsp;</td><td class='table_specs' nowrap='nowrap'>" & vbCrLf
                        Else
                            outStr = outStr & CStr(adors.Item("ac_mfr_year")) & "</td><td class='table_specs' nowrap='nowrap'>" & vbCrLf
                        End If
                    Else
                        outStr = outStr & "&nbsp;</td><td class='table_specs' nowrap='nowrap'>" & vbCrLf
                    End If

                    If Not IsDBNull(adors.Item("ac_Status")) Then
                        If Trim(adors.Item("ac_Status")) <> "" Then
                            If LCase(adors.Item("ac_Status")) <> LCase("For Sale") Then

                                If Trim(adors.Item("ac_Status")) = "For Sale/Lease" Or Trim(adors.Item("ac_Status")) = "For Sale/Trade" Then
                                    outStr = outStr & "<font size='-2'>" & Trim(adors.Item("ac_Status")) & "</font>"
                                Else
                                    outStr = outStr & Trim(adors.Item("ac_Status")) & " "
                                End If

                                bHadStatus = True
                            End If
                        End If
                    End If

                    If Not IsDBNull(adors.Item("ac_asking")) Then
                        If Trim(adors.Item("ac_asking")) <> "Price" Then

                            If Trim(adors.Item("ac_asking")) = "Sale/Lease" Or Trim(adors.Item("ac_asking")) = "Sale/Trade" Then
                                If bHadStatus Then
                                    outStr = outStr & "<font size='-2'> " & Trim(adors.Item("ac_asking")) & "</font></td><td class='table_specs'>" & vbCrLf
                                Else
                                    outStr = outStr & "<font size='-2'> " & Trim(adors.Item("ac_asking")) & "</font></td><td class='table_specs'>" & vbCrLf
                                End If
                            Else
                                If bHadStatus Then
                                    outStr = outStr & Trim(adors.Item("ac_asking")) & "</td><td class='table_specs'>" & vbCrLf
                                Else
                                    outStr = outStr & Trim(adors.Item("ac_asking")) & "</td><td class='table_specs'>" & vbCrLf
                                End If
                            End If


                        Else
                            If Not IsDBNull(adors.Item("ac_asking_price")) Then
                                If CDbl(adors.Item("ac_asking_price")) > 0 Then
                                    If bHadStatus Then
                                        outStr = outStr & "$" & FormatNumber((adors.Item("ac_asking_price") / 1000), 0) & "k" & "</td><td class='table_specs'>" & vbCrLf
                                    Else
                                        outStr = outStr & "$" & FormatNumber((adors.Item("ac_asking_price") / 1000), 0) & "k" & "</td><td class='table_specs'>" & vbCrLf
                                    End If
                                End If
                            End If
                        End If
                    Else
                        outStr = outStr & "&nbsp;</td><td class='table_specs'>" & vbCrLf
                    End If

                    If Not IsDBNull(adors("ac_airframe_tot_hrs")) Then
                        If CDbl(adors.Item("ac_airframe_tot_hrs")) = 0 Then
                            outStr = outStr & "<em>0&nbsp;</em>" & "</td><td class='table_specs'>" & vbCrLf
                        Else
                            outStr = outStr & FormatNumber(adors.Item("ac_airframe_tot_hrs"), 0) & "&nbsp;" & "</td><td class='table_specs'>" & vbCrLf
                        End If
                    Else
                        outStr = outStr & "<em>-&nbsp;</em>" & "</td><td class='table_specs'>" & vbCrLf
                    End If

                    If IsDBNull(adors.Item("displaycompany")) Then
                        top_comp_id = 0
                    Else
                        top_comp_id = adors.Item("displaycompany")
                    End If

                    Dim tmp_type As String
                    ' exclusive info or show sequence 1 info
                    adoOwnerRs = GetOwnerInfo(adors.Item("ac_id"), adors.Item("ac_journ_id"), True, top_comp_id)

                    'adoOwnerRs.Read()
                    If Not IsDBNull(adoOwnerRs) Then
                        If adoOwnerRs.Tables(0).Rows.Count > 0 Then
                            tmp_type = GetContactTypeForContactID(adoOwnerRs.Tables(0).Rows(0).Item("cref_contact_type")).ToString.ToLower
                            tmp_type = Char.ToUpper(tmp_type) + tmp_type.ToString.Substring(1)
                            tmp_type = Replace(tmp_type, "b", "B")
                            If Trim(tmp_type) = "Exclusive Broker" Then
                                tmp_type = "Excl Broker"
                            End If
                            outStr = outStr & tmp_type & ": "

                            outStr = outStr & Trim(adoOwnerRs.Tables(0).Rows(0).Item("comp_name")) & vbCrLf
                        Else
                            adoOwnerRs = GetOwnerInfo(adors.Item("ac_id"), adors.Item("ac_journ_id"), False, top_comp_id)

                            If Not IsDBNull(adoOwnerRs) Then
                                If adoOwnerRs.Tables(0).Rows.Count > 0 Then
                                    tmp_type = GetContactTypeForContactID(adoOwnerRs.Tables(0).Rows(0).Item("cref_contact_type")).ToString.ToLower
                                    tmp_type = Char.ToUpper(tmp_type) + tmp_type.ToString.Substring(1)
                                    tmp_type = Replace(tmp_type, "b", "B")
                                    outStr = outStr & tmp_type & ": "
                                    outStr = outStr & Trim(adoOwnerRs.Tables(0).Rows(0).Item("comp_name")) & vbCrLf


                                End If
                            End If
                        End If
                    Else
                        adoOwnerRs = GetOwnerInfo(adors.Item("ac_id"), adors.Item("ac_journ_id"), False, top_comp_id)

                        If Not IsDBNull(adoOwnerRs) Then
                            If adoOwnerRs.Tables(0).Rows.Count > 0 Then
                                tmp_type = GetContactTypeForContactID(adoOwnerRs.Tables(0).Rows(0).Item("cref_contact_type")).ToString.ToLower
                                tmp_type = Char.ToUpper(tmp_type) + tmp_type.ToString.Substring(1)
                                tmp_type = Replace(tmp_type, "b", "B")
                                outStr = outStr & tmp_type & ": "
                                outStr = outStr & Trim(adoOwnerRs.Tables(0).Rows(0).Item("comp_name")) & vbCrLf
                            End If
                        End If
                    End If

                    adoOwnerRs = Nothing

                    outStr = outStr & "</td></tr>" & vbCrLf



                    current_row = current_row + 1
                    '------------------------------------------------- THIS SECTION IS FOR ENDING OF PAGE---------------------
                    If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                        page_break_count = 38
                    Else
                        page_break_count = 42
                    End If

                    If current_row > page_break_count Then

                        'outStr = outStr & "</table><tr><td  align='center'  id='tdInnerTableSetup' colspan='1' >" & vbCrLf
                        '  outStr = outStr & "&nbsp;" & vbCrLf
                        outStr = outStr & Insert_Page_Break_PDF()
                        outStr = outStr & "</td>" & vbCrLf
                        outStr = outStr & "</tr></table>" & vbCrLf

                        ' build header for second page
                        If Not bUseHeight Then
                            outStr = outStr & "<table id='forSaleOuterTable' width='95%' cellspacing='0' cellpadding='1'>"
                        Else
                            outStr = outStr & "<table id='forSaleOuterTable' width='95%' height='" & table_height & "' cellspacing='0' cellpadding='1' class='leftside_right'>"
                        End If

                        If Me.logo_check.Checked = True Then
                            outStr = outStr & "<tr class='table_specs'><td valign='top' align='center'>"
                            outStr = outStr & get_company_images(real_make_model_name)
                            outStr = outStr & "</td></tr>"
                        Else
                            outStr = outStr & "<tr class='table_specs'><td valign='top' align='center'><img src='" & location_string & "images/marketpdfheader.jpg'/></td></tr>"
                        End If

                        outStr = outStr & "<tr><td valign='top' align='center'><strong>" & real_make_model_name & " Aircraft For Sale (Continued)</strong></td></tr>"

                        'build the data rows now
                        outStr = outStr & "<table align='center' border='1' id='forSaleInnerTable' width='99%' cellpadding='1' cellspacing='0'><tr><td class='table_specs' width='15%'><strong>Serial#</strong></td><td class='table_specs'><strong>Reg#</strong></td><td class='table_specs' width='4%'><strong>Year MFR</strong></td><td class='table_specs'><strong>For Sale Status</strong></td><td class='table_specs'><strong>Hours</strong></td><td class='table_specs'><strong>Owner</strong></td></tr>" & vbCrLf

                        current_row = 0
                        '------------------------------------------------- THIS SECTION IS FOR ENDING OF PAGE---------------------

                    End If
                Loop
                'foot_space_ac_for_sale
                ' add the spacer to move the footer down
                'outStr = outStr & "</td></tr><tr>" & vbCrLf
                ' outStr = outStr & "<td  align='center'  id='tdInnerTableSetup' colspan='1'>" & vbCrLf
                'outStr = outStr & "&nbsp;" & vbCrLf
                If forSaleCount <= page_break_count Then
                    outStr = outStr & "</table>"
                    'outStr = outStr & Insert_Page_Break_PDF()
                End If
                'outStr = outStr & "</td>" & vbCrLf
                ' outStr = outStr & "</tr>" & vbCrLf
                ' outStr = outStr & "</table>" & vbCrLf

            Else
                outStr = "<table align='center' border='1' id='forSaleInnerTable' width='90%' cellpadding='1' cellspacing='0'><tr><td class='table_specs'><strong>Serial#</strong></td><td class='table_specs'><strong>Reg#</strong></td><td class='table_specs'><strong>Year MFR</strong></td><td class='table_specs'><strong>For Sale Status</strong></td><td class='table_specs' width='4%'><strong>Hours</strong></td><td class='table_specs'><strong>Owner</strong></td>" & vbCrLf
                outStr = outStr & "</tr></table><tr><td align='center'>No " & real_make_model_name & " Aircraft For Sale" & vbCrLf
                outStr = outStr & "<td  align='center'  id='tdInnerTableSetup' colspan='1' >" & vbCrLf
                outStr = outStr & "&nbsp;" & vbCrLf
                outStr = outStr & "</td>" & vbCrLf
                outStr = outStr & "</tr>" & vbCrLf
            End If

            If Not bUseHeight Then
                ' if more than 20 use big table
                If forSaleCount > page_break_count Then
                    GetForSaleInfo = GetForSaleInfo & "<tr class='table_specs'><td align='center' colspan='3' class='table_specs'><p>" & outStr & "</td></tr></table>" & vbCrLf
                Else
                    GetForSaleInfo = GetForSaleInfo & "<tr class='table_specs'><td align='center' colspan='3' class='table_specs'><p>" & outStr & "</td></tr></table>" & vbCrLf
                End If
            Else
                GetForSaleInfo = GetForSaleInfo & "<tr class='table_specs'><td align='center' colspan='3' class='table_specs'><p>" & outStr & "</td></tr></table>" & vbCrLf
            End If

            foot_space_ac_for_sale = "990"
            Build_AircraftForSale = GetForSaleInfo
        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Build_OperatingCosts: " & ex.Message
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function
    Public Function NEW_Build_AircraftForSale(ByVal inModelID As Integer, ByVal InSortBy As String, ByVal bUseHeight As Boolean, ByVal table_height As String, ByRef foot_space_ac_for_sale As String, ByVal variantListString As String, ByVal forsaleFlag As String, ByVal yearOne As String, ByVal yearTwo As String, ByVal afttStart As String, ByVal afttEnd As String, ByVal regType As String, ByVal Startdate As String, ByVal EndDate As String, ByVal AirframeTypeCode As String, ByVal AmodTypeCode As String, ByVal AmodWeightClass As String, ByVal View_Type As Long) As String
        NEW_Build_AircraftForSale = ""

        Dim forSaleCount As Long = 0
        Dim bHadStatus As Boolean

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        ' Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim adors As System.Data.SqlClient.SqlDataReader : adors = Nothing
        Dim adoOwnerRs As System.Data.DataSet
        Dim query As String : query = ""
        Dim top_comp_id As Long = 0


        Dim adUseClient As Integer = 0
        Dim adUseServer As Integer = 0

        forSaleCount = 0
        Dim GetForSaleInfo As String = ""
        Dim page_break_count As Integer = 42
        Dim htmlOut = New StringBuilder()
        Dim results_table As New DataTable
        Dim jetnettable As New DataTable
        Dim clienttable As New DataTable
        Dim JetnetExtraCriteria As String = ""
        Dim ClientExtraCriteria As String = ""
        Dim jetnet_string As String = ""
        Dim client_string As String = ""
        Dim order_by_string As String = ""
        Dim FullClientIDstoExclude As String = ""
        Dim rows_exist As Boolean = False
        Dim temp_ac_id As Long = 0

        Try

            Dim tmpStr As String = ""


            If Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then

                JetnetExtraCriteria &= " and ac_amod_id in (" & inModelID & ")"
                ClientExtraCriteria &= " and cliamod_jetnet_amod_id IN (" & inModelID & ")"

                If forsaleFlag = "Y" Then
                    JetnetExtraCriteria &= " and ac_forsale_flag = 'Y' "
                    ClientExtraCriteria &= " and cliaircraft_forsale_flag = 'Y' "
                End If

                '-- YEAR RANGE
                If Trim(yearOne) <> "" Or Trim(yearTwo) <> "" Then
                    JetnetExtraCriteria &= " and ac_mfr_year between " & Trim(yearOne) & " and " & Trim(yearTwo) & " "
                    ClientExtraCriteria &= " and cliaircraft_year_mfr between " & Trim(yearOne) & " and " & Trim(yearTwo) & " "
                End If

                '-- AFTT
                If afttStart = 0 And afttEnd = 0 Then
                Else
                    If afttStart = 0 Then
                        JetnetExtraCriteria &= " and ((ac_airframe_tot_hrs between " & afttStart & " and " & afttEnd & ") or (ac_airframe_tot_hrs is NULL))"
                        ClientExtraCriteria &= "  and ((cliaircraft_airframe_total_hours between " & afttStart & " and " & afttEnd & ") or (cliaircraft_airframe_total_hours is NULL))"
                    Else
                        JetnetExtraCriteria &= " and ac_airframe_tot_hrs between " & afttStart & " and " & afttEnd & ""
                        ClientExtraCriteria &= "  and ((cliaircraft_airframe_total_hours between " & afttStart & " and " & afttEnd & ") or (cliaircraft_airframe_total_hours is NULL))"
                    End If
                End If
            End If



            GetForSaleInfo = "No ForSale Information at this time, for this Make/Model ..."


            If NEW_CRMViewActive = True Then
                'This grabs the data for the jetnet aircraft for sale
                jetnettable = localdatalayer.get_model_forsale_info2(localCriteria, jetnet_string, order_by_string, JetnetExtraCriteria)

                'This grabs the client side aircraft for sale
                clienttable = crmViewDataLayer.get_client_model_forsale_info(localCriteria, client_string, order_by_string, ClientExtraCriteria)

                Dim str As String = "For Sale Page Report: "

                Dim database_display As Array = Split(LCase(HttpContext.Current.Session.Item("jetnetServerNotesDatabase")), ";password")
                If UBound(database_display) > 0 Then
                    str += "Client Connection: " + database_display(0).ToString + " "
                End If

                Dim database_display2 As Array = Split(LCase(localdatalayer.clientConnectStr()), ";password")
                If UBound(database_display2) > 0 Then
                    str += ", Jetnet Connection: " + database_display2(0).ToString
                End If

                Call commonLogFunctions.Log_User_Event_Data("UserStatistics", str, Nothing, View_Type, 0, 0, 0, 0, 0, 0, 0)


                str = str
                If Not IsNothing(clienttable) Then
                    For Each drRow As DataRow In clienttable.Rows
                        If FullClientIDstoExclude <> "" Then
                            FullClientIDstoExclude += ", "
                        End If
                        FullClientIDstoExclude += drRow("client_jetnet_ac_id").ToString
                    Next
                End If

                'This takes those two datatables, excludes the jetnet ones we have client aircraft for, adds the extra fields to make
                'The schemas match and then merges them into results table.
                results_table = crmViewDataLayer.ModifyAndCombineJetnetClientDataForSale(clienttable, jetnettable, localCriteria, FullClientIDstoExclude, order_by_string, "N")

                If results_table.Rows.Count > 0 Then
                    rows_exist = True
                End If

            Else

                query = "SELECT ac_ser_no_full, ac_ser_no_sort, ac_reg_no, ac_mfr_year, ac_airframe_tot_hrs, ac_status, ac_asking, ac_asking_price, ac_id, ac_journ_id, amod_make_name, 'JETNET' as source, "

                query = query & " (select top 1  comp_id  FROM company"
                query = query & " INNER JOIN aircraft_reference WITH(NOLOCK) ON comp_id = cref_comp_id AND comp_journ_id = cref_journ_id"
                query = query & " WHERE cref_ac_id = ac_id AND cref_journ_id = 0 AND cref_contact_type IN ('99','93','00', '08') ORDER BY cref_contact_type DESC, cref_transmit_seq_no asc) AS displaycompany"


                If HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag Then
                    query += ", (select top 1 ac_sale_price From Aircraft b with (NOLOCK)"
                    query += " inner join Journal with (NOLOCK) on journ_id = ac_journ_id and ac_id = journ_ac_id"
                    query += " where(aircraft.ac_id = b.ac_id)"
                    query += " and ac_sale_price > 0  and ac_sale_price_display_flag = 'Y' and journ_subcat_code_part1='WS' AND journ_internal_trans_flag='N' "
                    query += " and journ_subcat_code_part3 NOT IN ('DB','DS','FI','FY','IT','MF','RE','CC','LS', 'RM')"
                    query += " order by journ_date desc) as  LASTSALEPRICE"
                Else
                    query += ", NULL as LASTSALEPRICE "
                End If

                If HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag Then
                    query += ", (select top 1 journ_date From Aircraft b with (NOLOCK)"
                    query += " inner join Journal with (NOLOCK) on journ_id = ac_journ_id and ac_id = journ_ac_id"
                    query += " where aircraft.ac_id = b.ac_id and ac_sale_price > 0 and ac_sale_price_display_flag = 'Y' and journ_subcat_code_part1='WS'"
                    query += " AND journ_internal_trans_flag='N' "
                    query += " and journ_subcat_code_part3 NOT IN ('DB','DS','FI','FY','IT','MF','RE','CC','LS', 'RM')"
                    query += " order by journ_date desc) as  LASTSALEPRICEDATE"
                Else
                    query += ", NULL as LASTSALEPRICEDATE "
                End If

                query = query & " FROM Aircraft WITH(NOLOCK) INNER JOIN Aircraft_Model WITH(NOLOCK) ON ac_amod_id = amod_id WHERE amod_id = " & CStr(inModelID) & " AND ac_journ_id = 0"
                'query = query & commonEVO.GenerateProductCodeSelectionQuery("", "", False, False, False)
                query = query & " AND ac_forsale_flag = 'Y'"



                If Not localCriteria.ViewCriteriaHasHelicopterFlag And Not localCriteria.ViewCriteriaHasBusinessFlag And Not localCriteria.ViewCriteriaHasCommercialFlag And localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_NONE Then
                    localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_ALL ' use subscribers product code(s) for queries
                ElseIf localCriteria.ViewCriteriaHasHelicopterFlag And localCriteria.ViewCriteriaHasBusinessFlag And localCriteria.ViewCriteriaHasCommercialFlag And localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_NONE Then
                    localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_ALL ' use subscribers product code(s) for queries
                End If

                If localCriteria.ViewCriteriaProductType = Constants.PRODUCT_CODE_ALL Then
                    query = query & "  " + commonEvo.GenerateProductCodeSelectionQuery(HttpContext.Current.Session.Item("localPreferences"), False, True)
                Else
                    query = query & "  " + commonEvo.BuildProductCodeCheckWhereClause(localCriteria.ViewCriteriaHasHelicopterFlag, localCriteria.ViewCriteriaHasBusinessFlag, localCriteria.ViewCriteriaHasCommercialFlag, False, False, False, False)
                End If

                If Trim(ac_id_list) <> "" Then
                    query = query & " AND ac_id in (" & ac_id_list & ") "
                End If


                If Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then

                    If Not String.IsNullOrEmpty(variantListString) Then
                        query += " and ac_amod_id in (" & amod_id & "," & variantListString & ")"
                    Else
                        query += " and ac_amod_id = @amodID"
                    End If

                    If forsaleFlag = "Y" Then
                        query += " and ac_forsale_flag = 'Y' "
                    End If

                    ''-- ADD TRANSACTION DATE RANGE
                    'If Trim(Startdate) <> "" Or Trim(EndDate) <> "" Then
                    '  query += " and journ_date between @StartDate and @EndDate"
                    'End If

                    '-- YEAR RANGE
                    If Trim(yearOne) <> "" Or Trim(yearTwo) <> "" Then
                        query += " and ac_mfr_year between @yearOne and @yearTwo"
                    End If

                    '-- WITH OR WITHOUT SALE PRICES

                    'reg Type
                    If regType = "N" Then
                        query += " and ac_reg_no like 'N%' "
                    ElseIf regType = "I" Then
                        query += " and ac_reg_no not like 'N%' "
                    End If

                    '-- AFTT
                    If afttStart = 0 And afttEnd = 0 Then
                    Else
                        If afttStart = 0 Then
                            query += " and ((ac_airframe_tot_hrs between @startAFTT and @endAFTT) or (ac_airframe_tot_hrs is NULL))"
                        Else
                            query += " and ac_airframe_tot_hrs between @startAFTT and @endAFTT"
                        End If
                    End If
                End If



                Select Case (InSortBy)
                    Case "serno"
                        query = query & " ORDER BY ac_ser_no_sort, ac_reg_no, ac_airframe_tot_hrs, ac_mfr_year"

                    Case "regno"
                        query = query & " ORDER BY ac_reg_no, ac_ser_no_sort, ac_airframe_tot_hrs, ac_mfr_year"

                    Case "aftt"
                        query = query & " ORDER BY ac_airframe_tot_hrs, ac_ser_no_sort, ac_reg_no, ac_mfr_year"

                    Case "mfryear"
                        query = query & " ORDER BY ac_mfr_year, ac_ser_no_sort, ac_reg_no, ac_airframe_tot_hrs"

                    Case Else
                        query = query & " ORDER BY ac_ser_no_sort, ac_reg_no, ac_airframe_tot_hrs, ac_mfr_year"

                End Select

                If Session.Item("debug") And Session.Item("convertToPDFPath") = "" Then
                    Response.Write("<b>getForSaleInfo : " & Server.HtmlEncode(query) & "</b><br /><br />")
                End If

                'Select Case Application.Item("webHostObject").evoWebHostType
                'Case eWebSiteTypes.LOCAL
                'SqlConn.ConnectionString = My.Settings.DEFAULT_LOCAL_MSSQL
                ' Case Else
                SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
                ' End Select

                SqlConn.Open()

                'SqlCommand.Connection = SqlConn
                'SqlCommand.CommandType = System.Data.CommandType.Text
                'SqlCommand.CommandTimeout = 60
                'SqlCommand.CommandText = query

                'adors = SqlCommand.ExecuteReader()


                Dim SqlCommand As New SqlClient.SqlCommand(query, SqlConn)
                If Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                    SqlCommand.Parameters.AddWithValue("amodID", inModelID)
                    SqlCommand.Parameters.AddWithValue("yearOne", yearOne)
                    SqlCommand.Parameters.AddWithValue("yearTwo", yearTwo)
                    '   SqlCommand.Parameters.AddWithValue("StartDate", Startdate)
                    '   SqlCommand.Parameters.AddWithValue("EndDate", EndDate)
                    SqlCommand.Parameters.AddWithValue("startAFTT", afttStart)
                    SqlCommand.Parameters.AddWithValue("endAFTT", afttEnd)
                End If

                adors = SqlCommand.ExecuteReader()
                If adors.HasRows Then
                    If adors.HasRows Then
                        Do While adors.Read
                            forSaleCount = forSaleCount + 1
                        Loop
                        If forSaleCount = 0 Then
                            Exit Function
                        Else
                            adors.Close()
                            SqlCommand.CommandText = query
                            adors = SqlCommand.ExecuteReader()
                            'adors.Read()
                        End If
                    Else
                        Exit Function
                    End If
                    rows_exist = True
                    results_table.Load(adors)
                End If
            End If



            GetForSaleInfo = ""

            GetForSaleInfo = GetForSaleInfo & "<tr><td valign='top' align='left'><font class='" & Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & real_make_model_name & "</strong> Aircraft For Sale" & valueHeaderString & "</font></td></tr>"


            'If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
            '  If Not bUseHeight Then
            '    GetForSaleInfo = GetForSaleInfo & "<table id='forSaleOuterTable' width='" & word_width & "' cellspacing='0' cellpadding='1'>"
            '  Else
            '    GetForSaleInfo = GetForSaleInfo & "<table id='forSaleOuterTable' width='" & word_width & "' height='" & table_height & "' cellspacing='0' cellpadding='1' class='leftside_right'>"
            '  End If
            'Else
            '  If Not bUseHeight Then
            '    GetForSaleInfo = GetForSaleInfo & "<table id='forSaleOuterTable' width='95%' cellspacing='0' cellpadding='1'>"
            '  Else
            '    GetForSaleInfo = GetForSaleInfo & "<table id='forSaleOuterTable' width='95%' height='" & table_height & "' cellspacing='0' cellpadding='1' class='leftside_right'>"
            '  End If
            'End If


            'GetForSaleInfo = GetForSaleInfo & "<td class='border_bottom' width='20%' align='center'>&nbsp;</td>"





            If Not IsNothing(results_table) Then

                If results_table.Rows.Count > 0 Then


                    If Trim(Request("ViewID")) = "997" Or Trim(Request("viewID")) = "998" Then
                        htmlOut.Append("<div class=""Box""><table id='forSaleInnerTable' cellpadding='6' cellspacing='0' align='center' width='100%' class='formatTable large " & table_color & "'><thead><tr><th class='table_specs'>Serial#</th><th class='table_specs'>Reg#</th><th class='table_specs' width='4%'>Year MFR</th><th class='table_specs' nowrap='nowrap'>Status</th><th class='table_specs right' width='4%'>Hours</th><th class='table_specs'>Owner/Exclusive Broker </th></tr>" & vbCrLf)    ' <th class='table_specs'>Last Sale</th>
                    Else
                        htmlOut.Append("<div class=""Box""><table id='forSaleInnerTable' cellpadding='6' cellspacing='0' align='center' width='100%' class='formatTable large " & table_color & "'><thead><tr><th class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Serial#</font></th><th class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Reg#</font></th><th class='table_specs' width='4%'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Year MFR</font></th><th class='table_specs' nowrap='nowrap'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>For Sale Status</font></th><th class='table_specs' width='4%'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Hours</font></th><th class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Owner/Exclusive Broker </font></th></tr>" & vbCrLf)
                    End If
                    htmlOut.Append("</thead><tbody>")

                    Dim current_row As Integer = 0
                    ' approximately limit 50 cells per page
                    For Each r As DataRow In results_table.Rows

                        If NEW_CRMViewActive = True And Trim(r.Item("source")) = "CLIENT" Then '
                            temp_ac_id = Trim(r.Item("client_jetnet_ac_id"))
                        Else
                            temp_ac_id = Trim(r.Item("ac_id"))
                        End If

                        bHadStatus = False

                        '------------------------------------------------- THIS SECTION IS FOR ENDING OF PAGE---------------------
                        If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                            page_break_count = 34
                        Else
                            page_break_count = 34
                        End If

                        If current_row > page_break_count Then
                            current_row = 0

                            htmlOut.Append("</table></td></tr></table>")
                            htmlOut.Append(comp_functions.NEW_Insert_Page_Break_PDF(0, WD.SelectedValue))
                            htmlOut.Append(temp_pdf_header)
                            If bWordReport = True Then
                                htmlOut.Append("<table width='" & word_width & "' align='center' cellpadding='3'><thead>")
                            Else
                                htmlOut.Append("<table width='" & pdf_html_width & "' align='center' cellpadding='3'><thead>")
                            End If
                            htmlOut.Append("<tr><th valign='top' align='center'><font class='" & Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & real_make_model_name & "</strong> Aircraft For Sale" & valueHeaderString & "</font></td></tr>")
                            htmlOut.Append("</thead><tbody><tr><td valign=""top"">")
                            htmlOut.Append("<div class=""Box""><table border='0' id='forSaleInnerTable' cellpadding='6' class=""formatTable large " & table_color & """ cellspacing='0' align='center' width='100%'><thead><tr><th class='table_specs' width='15%'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Serial#</font></th><th class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Reg#</font></th><th class='table_specs' width='4%'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Year MFR</font></th><th class='table_specs' nowrap='nowrap'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>For Sale Status</font></th><th class='table_specs' width='4%'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Hours</font></th><th class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Owner/Exclusive Broker </font></th></tr></thead>" & vbCrLf)
                        End If


                        If Not IsDBNull(r.Item("ac_id")) Then
                            If (temp_ac_id = new_PDF_AC_ID) And achigh_check.Checked = True Then
                                htmlOut.Append("<tr class=""highlight"">")
                            Else
                                htmlOut.Append("<tr>")
                            End If
                        Else
                            htmlOut.Append("<tr>")
                        End If


                        htmlOut.Append("<td align='left' valign='top' class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf)
                        If Not IsDBNull(r.Item("ac_ser_no_full")) Then

                            If r.Item("ac_ser_no_full") <> "" Then
                                'outStr = outStr & "<font size='-1'>"
                                htmlOut.Append(r.Item("ac_ser_no_full") & "</font></td><td class='table_specs' nowrap='nowrap'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>")
                            Else
                                htmlOut.Append("&nbsp;</font></td><td class='table_specs' nowrap='nowrap'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>")
                            End If
                        Else
                            htmlOut.Append("&nbsp;</font></td><td class='table_specs' nowrap='nowrap'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>")
                        End If

                        If Not IsDBNull(r.Item("ac_reg_no")) Then
                            If r.Item("ac_reg_no") <> "" Then
                                htmlOut.Append(r.Item("ac_reg_no") & "</font></td><td class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf)
                            Else
                                htmlOut.Append("&nbsp;</font></td><td class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf)
                            End If
                        Else
                            htmlOut.Append("&nbsp;</font></td><td class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf)
                        End If

                        'outStr = outStr & r.Item("ac_ser_no_full") & "</td><td>" & r.Item("ac_reg_no") & "</td><td>" & vbCrLf

                        If Not IsDBNull(r.Item("ac_mfr_year")) Then
                            If CDbl(r.Item("ac_mfr_year")) = 0 Then
                                htmlOut.Append("&nbsp;</font></td><td class='table_specs' nowrap='nowrap'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf)
                            Else
                                htmlOut.Append(CStr(r.Item("ac_mfr_year")) & "</font></td><td class='table_specs' nowrap='nowrap'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf)
                            End If
                        Else
                            htmlOut.Append("&nbsp;</font></td><td class='table_specs' nowrap='nowrap'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf)
                        End If

                        If Not IsDBNull(r.Item("ac_Status")) Then
                            If Trim(r.Item("ac_Status")) <> "" Then
                                If LCase(r.Item("ac_Status")) <> LCase("For Sale") Then

                                    If Trim(r.Item("ac_Status")) = "For Sale/Lease" Or Trim(r.Item("ac_Status")) = "For Sale/Trade" Then
                                        htmlOut.Append("<font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & Trim(r.Item("ac_Status")) & "</font> ")   ' was font size  size='-2'
                                    Else
                                        htmlOut.Append(Trim(r.Item("ac_Status")) & " ")
                                    End If

                                    bHadStatus = True
                                End If
                            End If
                        End If

                        If Not IsDBNull(r.Item("ac_asking")) Then
                            If Trim(r.Item("ac_asking")) <> "Price" Then

                                If Trim(r.Item("ac_asking")) = "Sale/Lease" Or Trim(r.Item("ac_asking")) = "Sale/Trade" Then
                                    If bHadStatus Then
                                        ' outStr = outStr & "<font size='-2'> " & Trim(r.Item("ac_asking")) & "</font>"
                                        htmlOut.Append("</font></td><td class='table_specs right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf)
                                    Else
                                        htmlOut.Append("<font size='-2'> " & Trim(r.Item("ac_asking")) & "</font></font></td><td class='table_specs right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf)
                                    End If
                                Else
                                    If bHadStatus Then
                                        htmlOut.Append(Trim(r.Item("ac_asking")))
                                        htmlOut.Append("</font></td><td class='table_specs right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf)
                                    Else
                                        htmlOut.Append(Trim(r.Item("ac_asking")) & "</font></td><td class='table_specs right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf)
                                    End If
                                End If


                            Else
                                If Not IsDBNull(r.Item("ac_asking_price")) Then
                                    If CDbl(r.Item("ac_asking_price")) > 0 Then
                                        If bHadStatus Then
                                            htmlOut.Append("$" & FormatNumber((r.Item("ac_asking_price") / 1000), 0) & "k" & "</font></td><td class='table_specs right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf)
                                        Else
                                            htmlOut.Append("$" & FormatNumber((r.Item("ac_asking_price") / 1000), 0) & "k" & "</font></td><td class='table_specs right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf)
                                        End If
                                    Else
                                        htmlOut.Append("&nbsp;</font></td><td class='table_specs right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf)
                                    End If
                                Else
                                    htmlOut.Append("&nbsp;</font></td><td class='table_specs right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf)
                                End If
                            End If
                        Else
                            htmlOut.Append("&nbsp;</font></td><td class='table_specs right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf)
                        End If


                        'If Trim(Request("viewID")) = "998" Then
                        '  If Not IsDBNull(adors("LASTSALEPRICE")) Then
                        '    If CDbl(r.Item("LASTSALEPRICE")) = 0 Then
                        '      outStr = outStr & "<em>0&nbsp;</em>" & "</font></td><td class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf
                        '    Else
                        '      outStr = outStr & DisplayFunctions.TextToImage("" & FormatNumber((r.Item("LASTSALEPRICE").ToString / 1000), 0), 9, "", "60", "Reported Sale Price Displayed with Permission from Source.")

                        '      If Not IsDBNull(adors("LASTSALEPRICEDATE")) Then
                        '        outStr = outStr & "("
                        '        outStr = outStr & r.Item("LASTSALEPRICEDATE")
                        '        outStr = outStr & ")"
                        '      End If
                        '      outStr = outStr & "</font></td><td class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf
                        '    End If
                        '  Else
                        '    outStr = outStr & "<em>-&nbsp;</em>" & "</font></td><td class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf
                        '  End If

                        'End If

                        If Not IsDBNull(r.Item("ac_airframe_tot_hrs")) Then
                            If CDbl(r.Item("ac_airframe_tot_hrs")) = 0 Then
                                htmlOut.Append("<em>0&nbsp;</em>" & "</font></td><td class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf)
                            Else
                                htmlOut.Append(FormatNumber(r.Item("ac_airframe_tot_hrs"), 0) & "&nbsp;" & "</font></td><td class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf)
                            End If
                        Else
                            htmlOut.Append("<em>-&nbsp;</em>" & "</font></td><td class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf)
                        End If

                        If IsDBNull(r.Item("displaycompany")) Then
                            top_comp_id = 0
                        Else
                            top_comp_id = r.Item("displaycompany")
                        End If

                        Dim tmp_type As String
                        ' exclusive info or show sequence 1 info
                        adoOwnerRs = GetOwnerInfo(temp_ac_id, r.Item("ac_journ_id"), True, top_comp_id)

                        'adoOwnerRs.Read()
                        If Not IsDBNull(adoOwnerRs) Then
                            If adoOwnerRs.Tables(0).Rows.Count > 0 Then
                                tmp_type = GetContactTypeForContactID(adoOwnerRs.Tables(0).Rows(0).Item("cref_contact_type")).ToString.ToLower
                                tmp_type = Char.ToUpper(tmp_type) + tmp_type.ToString.Substring(1)
                                tmp_type = Replace(tmp_type, "b", "B")
                                If Trim(tmp_type) = "Exclusive Broker" Then
                                    tmp_type = "Excl Broker"
                                End If
                                htmlOut.Append("<font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & tmp_type & ": ")

                                htmlOut.Append(Trim(adoOwnerRs.Tables(0).Rows(0).Item("comp_name")) & vbCrLf)
                            Else
                                adoOwnerRs = GetOwnerInfo(temp_ac_id, r.Item("ac_journ_id"), False, top_comp_id)

                                If Not IsDBNull(adoOwnerRs) Then
                                    If adoOwnerRs.Tables(0).Rows.Count > 0 Then
                                        tmp_type = GetContactTypeForContactID(adoOwnerRs.Tables(0).Rows(0).Item("cref_contact_type")).ToString.ToLower
                                        tmp_type = Char.ToUpper(tmp_type) + tmp_type.ToString.Substring(1)
                                        tmp_type = Replace(tmp_type, "b", "B")
                                        htmlOut.Append(tmp_type & ": ")
                                        htmlOut.Append(Trim(adoOwnerRs.Tables(0).Rows(0).Item("comp_name")) & vbCrLf)


                                    End If
                                End If
                            End If
                        Else
                            adoOwnerRs = GetOwnerInfo(temp_ac_id, r.Item("ac_journ_id"), False, top_comp_id)

                            If Not IsDBNull(adoOwnerRs) Then
                                If adoOwnerRs.Tables(0).Rows.Count > 0 Then
                                    tmp_type = GetContactTypeForContactID(adoOwnerRs.Tables(0).Rows(0).Item("cref_contact_type")).ToString.ToLower
                                    tmp_type = Char.ToUpper(tmp_type) + tmp_type.ToString.Substring(1)
                                    tmp_type = Replace(tmp_type, "b", "B")
                                    htmlOut.Append(tmp_type & ": ")
                                    htmlOut.Append(Trim(adoOwnerRs.Tables(0).Rows(0).Item("comp_name")) & vbCrLf)
                                End If
                            End If
                        End If

                        adoOwnerRs = Nothing

                        htmlOut.Append("</td></tr>" & vbCrLf)



                        current_row = current_row + 1

                    Next
                    'foot_space_ac_for_sale
                    ' add the spacer to move the footer down
                    'outStr = outStr & "</td></tr><tr>" & vbCrLf
                    ' outStr = outStr & "<td  align='center'  id='tdInnerTableSetup' colspan='1'>" & vbCrLf
                    'outStr = outStr & "&nbsp;" & vbCrLf
                    ' If forSaleCount <= page_break_count Then

                    'outStr = outStr & Insert_Page_Break_PDF()
                    'End If
                    'outStr = outStr & "</td>" & vbCrLf
                    ' outStr = outStr & "</tr>" & vbCrLf
                    ' outStr = outStr & "</table>" & vbCrLf

                Else
                    htmlOut.Append("<table border='1' id='forSaleInnerTable'cellpadding='1' cellspacing='0' align='center'><tr><td class='table_specs' width='15%'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Serial#</font></td><td class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Reg#</font></td><td class='table_specs' width='4%'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Year MFR</font></td><td class='table_specs' nowrap='nowrap'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>For Sale Status</font></td><td class='table_specs' width='4%'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Hours</font></td><td class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Owner/Exclusive Broker </font></td></tr>" & vbCrLf)
                    htmlOut.Append("</tr></table><tr><td align='center'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>No " & real_make_model_name & " Aircraft For Sale</font>" & vbCrLf)
                    htmlOut.Append("<td  align='center'  id='tdInnerTableSetup' colspan='1' >" & vbCrLf)
                    htmlOut.Append("&nbsp;" & vbCrLf)
                    htmlOut.Append("</td>" & vbCrLf)
                    htmlOut.Append("</tr>" & vbCrLf)
                End If

                If Not bUseHeight Then
                    ' if more than 20 use big table
                    If forSaleCount > page_break_count Then
                        GetForSaleInfo = GetForSaleInfo & "<tr class='table_specs'><td align='center' colspan='3' class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & htmlOut.ToString & "</font></td></tr>" & vbCrLf
                    Else
                        GetForSaleInfo = GetForSaleInfo & "<tr class='table_specs'><td align='center' colspan='3' class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & htmlOut.ToString & "</font></td></tr>" & vbCrLf
                    End If
                Else
                    GetForSaleInfo = GetForSaleInfo & "<tr class='table_specs'><td align='center' colspan='3' class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><p>" & htmlOut.ToString & "</font></td></tr>" & vbCrLf
                End If
            End If

            GetForSaleInfo = GetForSaleInfo & "</tbody></table></div>"
            GetForSaleInfo = GetForSaleInfo & "</td></tr>"


            foot_space_ac_for_sale = "990"
            NEW_Build_AircraftForSale = GetForSaleInfo
        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Build_OperatingCosts: " & ex.Message
        Finally
            'SqlCommand.Dispose()
            SqlConn.Close()

            SqlConn.Dispose()
        End Try
    End Function
    Public Function NEW_Build_RecentRetailSales(ByVal inModelID As Integer, ByRef foot_space_recent_retail_sales As String, ByVal variantListString As String, ByVal forsaleFlag As String, ByVal yearOne As String, ByVal yearTwo As String, ByVal afttStart As String, ByVal afttEnd As String, ByVal regType As String, ByVal Startdate As String, ByVal EndDate As String, ByVal AirframeTypeCode As String, ByVal AmodTypeCode As String, ByVal AmodWeightClass As String, ByVal results_table As DataTable) As String
        NEW_Build_RecentRetailSales = ""

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        ' Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim adors As System.Data.SqlClient.SqlDataReader : adors = Nothing
        Dim Query As String : Query = ""

        Dim nRememberTimeout As Integer = 0
        Dim adUseClient As Integer = 0
        Dim adUseServer As Integer = 0
        Dim GetRetailSalesInfo As String = ""
        Dim temp_count As Integer = 0

        Dim preownedSales_Only As Boolean = False
        Dim check_retail_sales As Boolean = False
        Dim check_include_internal As Boolean = False
        ' http://newevonet/viewtopdf.aspx?viewID=998&ctl00_WelcomeUser1_searchBoxText=&ctl00_WelcomeUser1_isMobileVersion=&chkHelicopterFilterID=true&chkBusinessFilterID=true&chkCommercialFilterID=true&chkRegionalFilterID=false&cboAircraftViewTypeID=251&cboAircraftViewMakeID=288&cboAircraftViewModelID=318&selectViewTimeSpan=12&valuesCheckbox=true&year_start=2014&hidden_year_start=2014&hidden_year_end=2019&year_end=2019&hidden_aftt_start=0&hidden_aftt_end=2659&aftt_start=0&aftt_end=2659&viewApplyID=Search&ViewClearID=Clear+Selections&tabs_container_variantTabPanel_VariantList=&for_sale_tab_tabReorder=&for_sale_tab_fullSaleCurrentIDs=&retail_tab_EvoRetailSalesIDsCurrent=&retail_tab_check_include_internals2=false&retail_tab_check_retail_sales2=true&retail_tab_preownedSales_Only=true&wanted_tab_SoldSurveyCurrentID=&spi_tab_valueEstimateCurrentID=&range_tab_range_search_text=&range_tab_first_model=&range_tab_second_model=&btn_show_mapID=Expand+Range+Tab&acKeepRemove=remove&view_name_text=Model+Market+Summary&view_id_text=1&hiddenAftt_start=&hiddenAftt_end=&hiddenYear_start=&hiddenYear_end=&afttFilter=true&yearFilter=true
        If Not IsNothing(Request("retail_tab_preownedSales_Only")) Then
            If Trim(Request("retail_tab_preownedSales_Only")) = "true" Then
                preownedSales_Only = True
            End If
        End If

        If Not IsNothing(Request("retail_tab_check_retail_sales2")) Then
            If Trim(Request("retail_tab_check_retail_sales2")) = "true" Then
                check_retail_sales = True
            End If
        End If

        If Not IsNothing(Request("retail_tab_check_include_internals2")) Then
            If Trim(Request("retail_tab_check_include_internals2")) = "true" Then
                check_include_internal = True
            End If
        End If
        Try
            GetRetailSalesInfo = "No Sales at this time, for this Make/Model ..."

            Dim table_exists As Boolean = False

            If IsNothing(results_table) Then
                table_exists = False
                Dim dummy_table As New DataTable
                results_table = dummy_table
                dummy_table = Nothing
            Else
                If results_table.Rows.Count > 0 Then
                    table_exists = True
                Else
                    table_exists = False
                End If
            End If

            If table_exists = True Then
            Else
                Query = "SELECT journ_id, journ_subcategory_code, journ_date, journ_subject, ac_ser_no_full, ac_reg_no, ac_mfr_year, ac_id, amod_make_name, ac_asking_price, ac_asking "

                If Session.Item("localPreferences").UserSPIViewFlag = True Then
                    If MMS_Sale_Prices.Checked = True Then
                        Query = Query & ", ac_sale_price, ac_sale_price_display_flag "
                    End If
                End If

                Query = Query & " FROM Aircraft WITH(NOLOCK) INNER JOIN Aircraft_Model WITH(NOLOCK) ON ac_amod_id = amod_id INNER JOIN journal WITH(NOLOCK) ON ac_journ_id = journ_id"
                Query = Query & " INNER JOIN journal_category WITH(NOLOCK) ON journ_subcategory_code = jcat_subcategory_code WHERE amod_id = " & inModelID
                'Query = Query & " AND (jcat_category_code = 'AH') "
                Query = Query & " AND (journ_subcategory_code LIKE 'WS%') " ' AND (RIGHT(journ_subcategory_code,2) NOT IN ('DB','DS','FI','MF','FY','RE','IT'))"
                'Query = Query & " AND (RIGHT(journ_subcategory_code,4) <> 'CORR') AND (RIGHT(journ_subcategory_code,2) <> 'IT')"
                ' Query = Query & commonEVO.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, True)
                Query = Query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, True)


                'http://newevonet/viewtopdf.aspx?viewID=998&ctl00_WelcomeUser1_searchBoxText=&ctl00_WelcomeUser1_isMobileVersion=&chkHelicopterFilterID=true&chkBusinessFilterID=true&chkCommercialFilterID=true&chkRegionalFilterID=false&cboAircraftViewTypeID=251&cboAircraftViewMakeID=288&cboAircraftViewModelID=318&selectViewTimeSpan=12&valuesCheckbox=true&year_start=2014&hidden_year_start=2014&hidden_year_end=2019&year_end=2019&hidden_aftt_start=0&hidden_aftt_end=2659&aftt_start=0&aftt_end=2659&viewApplyID=Search&ViewClearID=Clear+Selections&tabs_container_variantTabPanel_VariantList=&for_sale_tab_tabReorder=&for_sale_tab_fullSaleCurrentIDs=&retail_tab_EvoRetailSalesIDsCurrent=&retail_tab_check_include_internals2=false&retail_tab_check_retail_sales2=false&retail_tab_preownedSales_Only=false&wanted_tab_SoldSurveyCurrentID=&spi_tab_valueEstimateCurrentID=&range_tab_range_search_text=&range_tab_first_model=&range_tab_second_model=&btn_show_mapID=Expand+Range+Tab&acKeepRemove=remove&view_name_text=Model+Market+Summary&view_id_text=1&hiddenAftt_start=&hiddenAftt_end=&hiddenYear_start=&hiddenYear_end=&afttFilter=true&yearFilter=true

                '

                If preownedSales_Only Then
                    Query = Query & " AND journ_newac_flag = 'N' "
                End If

                If check_include_internal Then
                    Query = Query & " AND  journ_internal_trans_flag = 'N' "
                End If

                If check_retail_sales Then
                    Query = Query & " AND NOT (journ_subcat_code_part3 IN ('DB', 'DS', 'FI', 'FY', 'IT', 'MF', 'RE', 'CC', 'LS', 'RM')) "
                End If

                If Trim(journ_id_list) <> "" Then
                    Query = Query & " AND journ_id in (" & journ_id_list & ") "
                End If

                If Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                    If Not String.IsNullOrEmpty(variantListString) Then
                        Query += " and ac_amod_id in (" & amod_id & "," & variantListString & ")"
                    Else
                        Query += " and ac_amod_id = @amodID"
                    End If

                    If forsaleFlag = "Y" Then
                        Query += " and ac_forsale_flag = 'Y' "
                    End If

                    '-- ADD TRANSACTION DATE RANGE
                    If Trim(Startdate) <> "" Or Trim(EndDate) <> "" Then
                        Query += " and journ_date between @StartDate and @EndDate"
                    End If

                    '-- YEAR RANGE
                    If Trim(yearOne) <> "" Or Trim(yearTwo) <> "" Then
                        Query += " and ac_mfr_year between @yearOne and @yearTwo"
                    End If

                    '-- WITH OR WITHOUT SALE PRICES

                    'reg Type
                    If regType = "N" Then
                        Query += " and ac_reg_no like 'N%' "
                    ElseIf regType = "I" Then
                        Query += " and ac_reg_no not like 'N%' "
                    End If

                    '-- AFTT
                    If afttStart = 0 And afttEnd = 0 Then
                    Else
                        If afttStart = 0 Then
                            Query += " and ((ac_airframe_tot_hrs between @startAFTT and @endAFTT) or (ac_airframe_tot_hrs is NULL))"
                        Else
                            Query += " and ac_airframe_tot_hrs between @startAFTT and @endAFTT"
                        End If
                    End If
                Else
                    If localCriteria.ViewCriteriaTimeSpan > 0 Then
                        Query = Query & " and journ_date > '" & DateAdd(DateInterval.Month, -localCriteria.ViewCriteriaTimeSpan, Date.Now()) & "' "
                    End If
                End If


                Query = Query & " ORDER BY journ_date DESC"


                'Select Case Application.Item("webHostObject").evoWebHostType
                'Case eWebSiteTypes.LOCAL
                'SqlConn.ConnectionString = My.Settings.DEFAULT_LOCAL_MSSQL
                'Case Else
                SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
                ' End Select

                SqlConn.Open()

                Dim SqlCommand As New SqlClient.SqlCommand(Query, SqlConn)
                If Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                    SqlCommand.Parameters.AddWithValue("amodID", inModelID)
                    SqlCommand.Parameters.AddWithValue("yearOne", yearOne)
                    SqlCommand.Parameters.AddWithValue("yearTwo", yearTwo)
                    SqlCommand.Parameters.AddWithValue("StartDate", Startdate)
                    SqlCommand.Parameters.AddWithValue("EndDate", EndDate)
                    SqlCommand.Parameters.AddWithValue("startAFTT", afttStart)
                    SqlCommand.Parameters.AddWithValue("endAFTT", afttEnd)
                End If
                adors = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

                results_table.Load(adors)
            End If


            If Not IsNothing(results_table) Then

                If results_table.Rows.Count > 0 Then


                    GetRetailSalesInfo = "<tr><td align='center' colspan='6'><font class='" & Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & real_make_model_name & "</strong> Recent Retail Sales<span>Last " & localCriteria.ViewCriteriaTimeSpan & " Months</span>" & valueHeaderString & "</b></td></tr>" & vbCrLf
                    GetRetailSalesInfo = GetRetailSalesInfo & "<tr><td valign=""top""><div class=""Box""><table align='center' id='forSaleInnerTable'  cellpadding='6' cellspacing='0' width='100%' class='formatTable " & table_color & "'><thead><tr><th>Date</th><th class='table_specs'>Transaction Info</th><th class='table_specs'>Serial #</th>"
                    If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = False Then
                        GetRetailSalesInfo = GetRetailSalesInfo & "<th class='table_specs right'>Asking ($k)</th>"
                    End If
                    If Session.Item("localPreferences").UserSPIViewFlag = True Then
                        If MMS_Sale_Prices.Checked = True Then
                            GetRetailSalesInfo = GetRetailSalesInfo & "<th class='table_specs right'>Sale Price ($k)</th>"
                        End If
                    End If


                    GetRetailSalesInfo = GetRetailSalesInfo & "<th class='table_specs'>Reg #</th><th class='table_specs'>Year MFR</th></tr>" & vbCrLf
                    GetRetailSalesInfo = GetRetailSalesInfo & "</thead><tbody>"

                    For Each r As DataRow In results_table.Rows

                        If temp_count > 37 Then
                            temp_count = 0

                            GetRetailSalesInfo = GetRetailSalesInfo & "</table></td></tr></table>"
                            GetRetailSalesInfo = GetRetailSalesInfo & comp_functions.NEW_Insert_Page_Break_PDF(0, WD.SelectedValue)
                            GetRetailSalesInfo = GetRetailSalesInfo & temp_pdf_header
                            If bWordReport = True Then
                                GetRetailSalesInfo = GetRetailSalesInfo & "<table width='" & word_width & "' align='center' cellpadding='3'>"
                            Else
                                GetRetailSalesInfo = GetRetailSalesInfo & "<table width='" & pdf_html_width & "' align='center' cellpadding='3'>"
                            End If
                            GetRetailSalesInfo = GetRetailSalesInfo & "<tr><td align='center' colspan='6'><font class='" & Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & real_make_model_name & "</strong> Recent Retail Sales<span>Last " & localCriteria.ViewCriteriaTimeSpan & " Months</span>" & valueHeaderString & "</b></td></tr>" & vbCrLf
                            GetRetailSalesInfo = GetRetailSalesInfo & "<tr><td><div class=""Box""><table align='center' id='forSaleInnerTable'  cellpadding='6' cellspacing='0' width='100%' class='formatTable " & table_color & "'><thead><thead><tr><th>Date</th><th>Transaction Info</th><th>Serial #</th>"
                            If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = False Then
                                GetRetailSalesInfo = GetRetailSalesInfo & "<th class=""right"">Asking ($k)</th>"
                            End If

                            If Session.Item("localPreferences").UserSPIViewFlag = True Then
                                If MMS_Sale_Prices.Checked = True Then
                                    GetRetailSalesInfo = GetRetailSalesInfo & "<th class=""right"">Sale Price ($k)</th>"
                                End If
                            End If

                            GetRetailSalesInfo = GetRetailSalesInfo & "<th>Reg #</th><th>Year MFR</th></tr></thead><tbody>" & vbCrLf

                        End If
                        temp_count = temp_count + 1

                        GetRetailSalesInfo = GetRetailSalesInfo & "<tr>" & vbCrLf
                        GetRetailSalesInfo = GetRetailSalesInfo & "<td align='left' valign='top' nowrap='nowrap' class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & clsGeneral.clsGeneral.TwoPlaceYear(r.Item("journ_date")) & "</td>" & vbCrLf

                        If Trim(Request("ViewID")) = "997" Or Trim(Request("viewID")) = "998" Then
                            GetRetailSalesInfo = GetRetailSalesInfo & "<td nowrap='nowrap' class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & Replace(Left(r.Item("journ_subject"), 70), "Sold from ", "") & "</td>" & vbCrLf
                        Else
                            GetRetailSalesInfo = GetRetailSalesInfo & "<td nowrap='nowrap' class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & Left(r.Item("journ_subject"), 70) & "</td>" & vbCrLf
                        End If

                        GetRetailSalesInfo = GetRetailSalesInfo & "<td class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & r.Item("ac_ser_no_full") & "</td>" & vbCrLf
                        If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = False Then
                            If Not IsDBNull(r.Item("ac_asking_price")) Then
                                GetRetailSalesInfo = GetRetailSalesInfo & "<td nowrap='nowrap' class='table_specs' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>$" & FormatNumber((r.Item("ac_asking_price") / 1000), 0) & "</td>" & vbCrLf
                            ElseIf Not IsDBNull(r.Item("ac_asking")) Then
                                If Trim(r.Item("ac_asking")) = "" Then
                                    GetRetailSalesInfo = GetRetailSalesInfo & "<td nowrap='nowrap' class='table_specs' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Off Mrk</td>" & vbCrLf
                                Else
                                    GetRetailSalesInfo = GetRetailSalesInfo & "<td nowrap='nowrap' class='table_specs' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & r.Item("ac_asking") & "</td>" & vbCrLf
                                End If
                            Else
                                GetRetailSalesInfo = GetRetailSalesInfo & "<td nowrap='nowrap' class='table_specs' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>Off Mrk</td>" & vbCrLf
                            End If
                        End If

                        If Session.Item("localPreferences").UserSPIViewFlag = True Then
                            If MMS_Sale_Prices.Checked = True Then
                                If Not IsDBNull(r.Item("ac_sale_price")) And Trim(r.Item("ac_sale_price_display_flag")) = "Y" Then
                                    GetRetailSalesInfo = GetRetailSalesInfo & "<td nowrap='nowrap' class='table_specs' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & DisplayFunctions.TextToImage("$" & FormatNumber((r.Item("ac_sale_price").ToString / 1000), 0), 8, "Arial", "", "Reported Sale Price Displayed with Permission from Source.", "", False, True) & "</td>" & vbCrLf
                                Else
                                    GetRetailSalesInfo = GetRetailSalesInfo & "<td nowrap='nowrap' class='table_specs' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</td>" & vbCrLf
                                End If
                            End If
                        End If

                        GetRetailSalesInfo = GetRetailSalesInfo & "<td nowrap='nowrap' class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & r.Item("ac_reg_no") & "</td>" & vbCrLf
                        GetRetailSalesInfo = GetRetailSalesInfo & "<td nowrap='nowrap' class='table_specs' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & r.Item("ac_mfr_year") & "</td>" & vbCrLf
                        GetRetailSalesInfo = GetRetailSalesInfo & "</tr>" & vbCrLf
                    Next

                    ' add the spacer to move the footer down
                    GetRetailSalesInfo = GetRetailSalesInfo & "</table></td></tr><tr>" & vbCrLf
                    GetRetailSalesInfo = GetRetailSalesInfo & "<td  align='center'  id='tdInnerTableSetup' colspan='1' >" & vbCrLf
                    GetRetailSalesInfo = GetRetailSalesInfo & "&nbsp;" & vbCrLf
                    GetRetailSalesInfo = GetRetailSalesInfo & "</td>" & vbCrLf
                    GetRetailSalesInfo = GetRetailSalesInfo & "</tr>" & vbCrLf

                    GetRetailSalesInfo = GetRetailSalesInfo & "</tbody></table></div>" & vbCrLf
                Else
                    GetRetailSalesInfo = "<table  align='center' cellpadding='1' cellpadding='1' class='formatTable " & table_color & "'>" '<tr><td align='center' colspan='6'>"

                    'If Me.logo_check.Checked = True Then
                    '  GetRetailSalesInfo = GetRetailSalesInfo & get_company_images(real_make_model_name)
                    'Else
                    '  GetRetailSalesInfo = GetRetailSalesInfo & "<img src='" & location_string & "images/marketpdfheader.jpg' />"

                    'End If

                    'GetRetailSalesInfo += "</td></tr>"

                    GetRetailSalesInfo = GetRetailSalesInfo & "<tr class=""noBorder""><td align='center' colspan='6'><b>" & real_make_model_name & " Recent Retail Sales</b></td></tr><tr class=""noBorder""><td align='center' colspan='6'>&nbsp;</td></tr>" & vbCrLf
                    GetRetailSalesInfo = GetRetailSalesInfo & "<tr class=""noBorder""><td align='center'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>No " & real_make_model_name & " Recent Retail Sales Available" & vbCrLf
                    GetRetailSalesInfo = GetRetailSalesInfo & "<td  align='center'  id='tdInnerTableSetup' colspan='1' >" & vbCrLf
                    GetRetailSalesInfo = GetRetailSalesInfo & "&nbsp;" & vbCrLf
                    GetRetailSalesInfo = GetRetailSalesInfo & "</td>" & vbCrLf
                    GetRetailSalesInfo = GetRetailSalesInfo & "</tr>" & vbCrLf
                End If
            Else

                GetRetailSalesInfo = "<table  align='center' cellpadding='1' cellpadding='1' class='formatTable " & table_color & "'>" '<tr><td align='center' colspan='6'>"

                'If Me.logo_check.Checked = True Then
                '  GetRetailSalesInfo = GetRetailSalesInfo & get_company_images(real_make_model_name)
                'Else
                '  GetRetailSalesInfo = GetRetailSalesInfo & "<img src='" & location_string & "images/marketpdfheader.jpg' />"

                'End If

                'GetRetailSalesInfo += "</td></tr>"

                GetRetailSalesInfo = GetRetailSalesInfo & "<tr class=""noBorder""><td align='center' colspan='6'><b>" & real_make_model_name & " Recent Retail Sales</b></td></tr><tr class=""noBorder""><td align='center' colspan='6'>&nbsp;</td></tr>" & vbCrLf
                GetRetailSalesInfo = GetRetailSalesInfo & "<tr class=""noBorder""><td align='center'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>No " & real_make_model_name & " Recent Retail Sales Available" & vbCrLf
                GetRetailSalesInfo = GetRetailSalesInfo & "<td  align='center'  id='tdInnerTableSetup' colspan='1' >" & vbCrLf
                GetRetailSalesInfo = GetRetailSalesInfo & "&nbsp;" & vbCrLf
                GetRetailSalesInfo = GetRetailSalesInfo & "</td>" & vbCrLf
                GetRetailSalesInfo = GetRetailSalesInfo & "</tr>" & vbCrLf
            End If


            adors = Nothing
            NEW_Build_RecentRetailSales = GetRetailSalesInfo
        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Build_RecentSalesTrends: " & ex.Message
        Finally
            '  SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function
    Public Function Build_RecentRetailSales(ByVal inModelID As Integer, ByRef foot_space_recent_retail_sales As String) As String
        Build_RecentRetailSales = ""

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim adors As System.Data.SqlClient.SqlDataReader : adors = Nothing
        Dim Query As String : Query = ""

        Dim nRememberTimeout As Integer = 0
        Dim adUseClient As Integer = 0
        Dim adUseServer As Integer = 0
        Dim GetRetailSalesInfo As String = ""

        Try
            GetRetailSalesInfo = "No Sales at this time, for this Make/Model ..."

            Query = "SELECT TOP 30 journ_id, journ_subcategory_code, journ_date, journ_subject, ac_ser_no_full, ac_reg_no, ac_mfr_year, ac_id, amod_make_name"
            Query = Query & " FROM Aircraft WITH(NOLOCK) INNER JOIN Aircraft_Model WITH(NOLOCK) ON ac_amod_id = amod_id INNER JOIN journal WITH(NOLOCK) ON ac_journ_id = journ_id"
            Query = Query & " INNER JOIN journal_category WITH(NOLOCK) ON journ_subcategory_code = jcat_subcategory_code WHERE amod_id = " & inModelID
            Query = Query & " AND (jcat_category_code = 'AH') AND (journ_subcategory_code LIKE 'WS%') AND (RIGHT(journ_subcategory_code,2) NOT IN ('DB','DS','FI','MF','FY','RE','IT'))"
            Query = Query & " AND (RIGHT(journ_subcategory_code,4) <> 'CORR') AND (RIGHT(journ_subcategory_code,2) <> 'IT')"
            ' Query = Query & commonEVO.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, True)
            Query = Query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, True)

            Query = Query & " ORDER BY journ_date DESC"


            'Select Case Application.Item("webHostObject").evoWebHostType
            'Case eWebSiteTypes.LOCAL
            'SqlConn.ConnectionString = My.Settings.DEFAULT_LOCAL_MSSQL
            'Case Else
            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            ' End Select

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = Query

            adors = SqlCommand.ExecuteReader()

            If adors.HasRows Then

                GetRetailSalesInfo = "<table  align='center' cellpadding='3'><tr><td align='center' colspan='6'>"


                If Me.logo_check.Checked = True Then
                    GetRetailSalesInfo = GetRetailSalesInfo & get_company_images(real_make_model_name)
                Else
                    GetRetailSalesInfo = GetRetailSalesInfo & "<img src='" & location_string & "images/marketpdfheader.jpg' />"
                End If



                GetRetailSalesInfo = GetRetailSalesInfo & "</td></tr><tr><td align='center' colspan='6'><b>" & real_make_model_name & " Recent Retail Sales (Last 30)</b></td></tr><tr><td align='center' colspan='6'>&nbsp;</td></tr>" & vbCrLf
                GetRetailSalesInfo = GetRetailSalesInfo & "<tr><td><table align='center' border='1' id='forSaleInnerTable' width='90%' cellpadding='1' cellspacing='0'><tr><td class='table_specs'><strong>Date</strong></td><td class='table_specs'><strong>Transaction Info</strong></td><td class='table_specs'><strong>Serial #</strong></td><td class='table_specs'><strong>Reg #</strong></td><td class='table_specs'><strong>Year MFR</strong></td></tr>" & vbCrLf

                Do While adors.Read
                    GetRetailSalesInfo = GetRetailSalesInfo & "<tr>" & vbCrLf
                    GetRetailSalesInfo = GetRetailSalesInfo & "<td align='left' valign='top' nowrap='nowrap' class='table_specs'><em>" & adors.Item("journ_date") & "</em></td>" & vbCrLf
                    GetRetailSalesInfo = GetRetailSalesInfo & "<td nowrap='nowrap' class='table_specs'>" & Left(adors.Item("journ_subject"), 70) & "</td>" & vbCrLf
                    GetRetailSalesInfo = GetRetailSalesInfo & "<td nowrap='nowrap' class='table_specs'>" & adors.Item("ac_ser_no_full") & "</td>" & vbCrLf
                    GetRetailSalesInfo = GetRetailSalesInfo & "<td nowrap='nowrap' class='table_specs'>" & adors.Item("ac_reg_no") & "</td>" & vbCrLf
                    GetRetailSalesInfo = GetRetailSalesInfo & "<td nowrap='nowrap' class='table_specs'>" & adors.Item("ac_mfr_year") & "</td>" & vbCrLf
                    GetRetailSalesInfo = GetRetailSalesInfo & "</tr>" & vbCrLf
                Loop

                ' add the spacer to move the footer down
                GetRetailSalesInfo = GetRetailSalesInfo & "</table></td></tr><tr>" & vbCrLf
                GetRetailSalesInfo = GetRetailSalesInfo & "<td  align='center'  id='tdInnerTableSetup' colspan='1' >" & vbCrLf
                GetRetailSalesInfo = GetRetailSalesInfo & "&nbsp;" & vbCrLf
                GetRetailSalesInfo = GetRetailSalesInfo & "</td>" & vbCrLf
                GetRetailSalesInfo = GetRetailSalesInfo & "</tr>" & vbCrLf

                GetRetailSalesInfo = GetRetailSalesInfo & "</table>" & vbCrLf
            Else

                GetRetailSalesInfo = "<table width='90%' align='center' cellpadding='1' cellpadding='1'><tr><td align='center' colspan='6'>"

                If Me.logo_check.Checked = True Then
                    GetRetailSalesInfo = GetRetailSalesInfo & get_company_images(real_make_model_name)
                Else
                    GetRetailSalesInfo = GetRetailSalesInfo & "<img src='" & location_string & "images/marketpdfheader.jpg' />"
                End If


                GetRetailSalesInfo = GetRetailSalesInfo & "</td></tr><tr><td align='center' colspan='6'><b>" & real_make_model_name & " Recent Retail Sales</b></td></tr><tr><td align='center' colspan='6'>&nbsp;</td></tr>" & vbCrLf
                ' GetRetailSalesInfo = GetRetailSalesInfo & "<tr><td><table align='center' border='1' id='forSaleInnerTable' width='90%' cellpadding='1' cellspacing='0' align='center'><tr><td class='table_specs'><strong>Date</strong></td><td class='table_specs'><strong>Transaction Info</strong></td><td class='table_specs'><strong>Serial #</strong></td><td class='table_specs'><strong>Reg #</strong></td><td class='table_specs'><strong>Year MFR</strong></td></tr>" & vbCrLf
                ' GetRetailSalesInfo = GetRetailSalesInfo & "</table></td></tr><tr><td align='center'>No " & real_make_model_name & " Recent Retail Sales Available" & vbCrLf
                GetRetailSalesInfo = GetRetailSalesInfo & "<tr><td align='center'>No " & real_make_model_name & " Recent Retail Sales Available" & vbCrLf
                GetRetailSalesInfo = GetRetailSalesInfo & "<td  align='center'  id='tdInnerTableSetup' colspan='1' >" & vbCrLf
                GetRetailSalesInfo = GetRetailSalesInfo & "&nbsp;" & vbCrLf
                GetRetailSalesInfo = GetRetailSalesInfo & "</td>" & vbCrLf
                GetRetailSalesInfo = GetRetailSalesInfo & "</tr>" & vbCrLf

                GetRetailSalesInfo = GetRetailSalesInfo & "</table>" & vbCrLf
            End If

            adors = Nothing
            Build_RecentRetailSales = GetRetailSalesInfo
        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Build_RecentSalesTrends: " & ex.Message
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function
    Public Function NEW_Build_RecentMarketActivity(ByVal singleViewModelID As Integer, ByRef foot_space_market_activity As String) As String
        NEW_Build_RecentMarketActivity = ""
        Try
            Dim objBuilder As New StringBuilder

            '   If Me.logo_check.Checked = True Then

            If HttpContext.Current.Session.Item("localPreferences").AerodexFlag Then ' NOTE : need to update clause if new market status types are added
                objBuilder.Append("<tr><td valign='top' align='center' colspan='7'><font class='" & Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & real_make_model_name & "</strong> Recent Events <span>Last 30 Events</span>" & valueEmptyHeaderString & "</font> </td></tr>" & vbCrLf) '<em>(last 20 events)</em>
            Else
                objBuilder.Append("<tr><td valign='top' align='center' colspan='7'><font class='" & Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & real_make_model_name & "</strong> Recent Market Activity <span>Last 30 Events</span>" & valueHeaderString & "</font> </td></tr>" & vbCrLf) '<em>(last 20 events)</em>
            End If

            'Else
            '  If HttpContext.Current.Session.Item("localPreferences").AerodexFlag Then ' NOTE : need to update clause if new market status types are added
            '    objBuilder.Append("<tr><td align='center' colspan='7'><img src='" & location_string & "images/marketpdfheader.jpg' /></td></tr><tr><td valign='top' align='center' colspan='7'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & " mainHeading'><strong>" & real_make_model_name & "</strong> Recent Events  <span>Last 30</span>" & valueEmptyHeaderString & "</font> </td></tr>" & vbCrLf) '<em>(last 20 events)</em>
            '  Else
            '    objBuilder.Append("<tr><td align='center' colspan='7'><img src='" & location_string & "images/marketpdfheader.jpg' /></td></tr><tr><td valign='top' align='center' colspan='7'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & " mainHeading'><strong>" & real_make_model_name & "<strong> Recent Market Activity  <span>Last 30</span>" & valueEmptyHeaderString & "</font> </td></tr>" & vbCrLf) '<em>(last 20 events)</em>
            '  End If
            'End If

            objBuilder.Append("<tr><td align='center' colspan='7' valign=""top""><div class=""Box removeTopPadding"">" & NEW_GetModelEventsInfo(singleViewModelID))

            objBuilder.Append("</div></td></tr>" & vbCrLf)
            NEW_Build_RecentMarketActivity = objBuilder.ToString
        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Build_RecentMarketActivity: " & ex.Message
        End Try
    End Function
    Public Function Build_RecentMarketActivity(ByVal singleViewModelID As Integer, ByRef foot_space_market_activity As String) As String
        Build_RecentMarketActivity = ""
        Try
            Dim objBuilder As New StringBuilder
            objBuilder.Append("<table align='center'  id='forSaleInnerTable' width='90%' cellpadding='1' cellspacing='0'>")

            If Me.logo_check.Checked = True Then
                objBuilder.Append("<tr><td align='center' colspan='7'>")
                objBuilder.Append(get_company_images(real_make_model_name))
                If HttpContext.Current.Session.Item("localPreferences").AerodexFlag Then ' NOTE : need to update clause if new market status types are added
                    objBuilder.Append("</td></tr><tr><td valign='top' align='center' colspan='7'><strong>" & real_make_model_name & " Recent Events (Last 30)</strong> </td></tr><tr><td align='center' colspan='6'>&nbsp;</td></tr>" & vbCrLf) '<em>(last 20 events)</em>
                Else
                    objBuilder.Append("</td></tr><tr><td valign='top' align='center' colspan='7'><strong>" & real_make_model_name & " Recent Market Activity (Last 30)</strong> </td></tr><tr><td align='center' colspan='6'>&nbsp;</td></tr>" & vbCrLf) '<em>(last 20 events)</em>
                End If

            Else
                If HttpContext.Current.Session.Item("localPreferences").AerodexFlag Then ' NOTE : need to update clause if new market status types are added
                    objBuilder.Append("<tr><td align='center' colspan='7'><img src='" & location_string & "images/marketpdfheader.jpg' /></td></tr><tr><td valign='top' align='center' colspan='7'><strong>" & real_make_model_name & " Recent Events (Last 30)</strong> </td></tr><tr><td align='center' colspan='6'>&nbsp;</td></tr>" & vbCrLf) '<em>(last 20 events)</em>
                Else
                    objBuilder.Append("<tr><td align='center' colspan='7'><img src='" & location_string & "images/marketpdfheader.jpg' /></td></tr><tr><td valign='top' align='center' colspan='7'><strong>" & real_make_model_name & " Recent Market Activity (Last 30)</strong> </td></tr><tr><td align='center' colspan='6'>&nbsp;</td></tr>" & vbCrLf) '<em>(last 20 events)</em>
                End If
            End If

            'objBuilder.Append("<tr><td width='15.6%'>Date:</td><td width='15.6%'>Status</td><td width='15.6%'>Serial#</td><td width='15.6%'>Reg#</td><td width='15.6%'>Year MFR</td><td width='15.6%'>Event Desc</td><tr>" & vbCrLf)
            objBuilder.Append("<tr><td align='center' colspan='7' >" & vbCrLf & "<p>" & GetModelEventsInfo(singleViewModelID) & "</p>" & vbCrLf)
            ' add the spacer to move the footer down
            ' objBuilder.Append("</p></td></tr><tr><td>" & vbCrLf)

            objBuilder.Append("</td></tr>" & vbCrLf)
            objBuilder.Append("</table>" & vbCrLf)
            Build_RecentMarketActivity = objBuilder.ToString
        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Build_RecentMarketActivity: " & ex.Message
        End Try
    End Function
    Public Function Build_String_To_HTML(ByVal report_name As String, ByVal ViewToPDF As String) As Boolean
        Build_String_To_HTML = False
        Try
            Build_String_To_HTML = True
            ' create a file to dump the PDF report to
            ' create a streamwriter variable
            Dim swPDF As System.IO.StreamWriter
            ' create the html file

            'Temp Hold MSW


            swPDF = IO.File.CreateText(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" + report_name)
            ' write to the file
            swPDF.WriteLine(ViewToPDF)
            'close the streamwriter
            swPDF.Close()
            ' call the webgrabber info
            Response.Write("Page:<br>" & ViewToPDF)




        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Build_String_To_HTML: " & ex.Message
        End Try
    End Function
    Public Function TranslateUSMetricUnitsShort(ByVal in_StrToTranslate)

        Select Case (UCase(in_StrToTranslate))

            Case "FT"
                TranslateUSMetricUnitsShort = "m"
            Case "NM"
                TranslateUSMetricUnitsShort = "km"
            Case "M"
                TranslateUSMetricUnitsShort = "km"
            Case "SM"
                TranslateUSMetricUnitsShort = "km"
            Case "KN"
                TranslateUSMetricUnitsShort = "kph"
            Case "FPM"
                TranslateUSMetricUnitsShort = "mps"
            Case "PSI"
                TranslateUSMetricUnitsShort = "torr"
            Case "LBS"
                TranslateUSMetricUnitsShort = "kg"
            Case "GAL"
                TranslateUSMetricUnitsShort = "l"
            Case "HP"
                TranslateUSMetricUnitsShort = "mhp"
            Case Else
                TranslateUSMetricUnitsShort = UCase(in_StrToTranslate)

        End Select

    End Function
    Public Function TranslateUSMetricUnitsLong(ByVal in_StrToTranslate)

        Select Case (UCase(in_StrToTranslate))

            Case "FT"
                TranslateUSMetricUnitsLong = "Meter"
            Case "NM"
                TranslateUSMetricUnitsLong = "Kilometer"
            Case "M"
                TranslateUSMetricUnitsLong = "Kilometer"
            Case "SM"
                TranslateUSMetricUnitsLong = "Kilometer"
            Case "KN"
                TranslateUSMetricUnitsLong = "Kilometers Per Hour"
            Case "FPM"
                TranslateUSMetricUnitsLong = "Meters Per Second"
            Case "PSI"
                TranslateUSMetricUnitsLong = "Milimeter of Mercury"
            Case "LB"
                TranslateUSMetricUnitsLong = "Kilogram"
            Case "GAL"
                TranslateUSMetricUnitsLong = "Liter"
            Case "HP"
                TranslateUSMetricUnitsLong = "Metric Horsepower"
            Case Else
                TranslateUSMetricUnitsLong = UCase(in_StrToTranslate)

        End Select

    End Function
    Public Function ConvertUSToMetricValue(ByVal in_convertWhat, ByVal in_valToConvert)

        Select Case (UCase(in_convertWhat))

            Case "FT"
                ConvertUSToMetricValue = CDbl(ConversionFunctions.ConvertFeetToMeter(in_valToConvert))
            Case "NM"
                ConvertUSToMetricValue = CDbl(ConversionFunctions.ConvertNauticalMileToKilometer(in_valToConvert))
            Case "M"
                ConvertUSToMetricValue = CDbl(ConversionFunctions.ConvertMileToKilometer(in_valToConvert))
            Case "SM"
                ConvertUSToMetricValue = CDbl(ConversionFunctions.ConvertStatuteMileToKilometer(in_valToConvert))
            Case "KN"
                ConvertUSToMetricValue = CDbl(ConversionFunctions.ConvertKnotsToKPH(in_valToConvert))
            Case "FPM"
                ConvertUSToMetricValue = CDbl(ConversionFunctions.ConvertFPMToMPS(in_valToConvert))
            Case "PSI"
                ConvertUSToMetricValue = CDbl(ConversionFunctions.ConvertPSIToHG(in_valToConvert))
            Case "LBS"
                ConvertUSToMetricValue = CDbl(ConversionFunctions.ConvertPoundToKilogram(in_valToConvert))
            Case "GAL"
                ConvertUSToMetricValue = CDbl(ConversionFunctions.ConvertGallonToLiter(in_valToConvert))
            Case "PPG"
                ConvertUSToMetricValue = CDbl(ConversionFunctions.ConvertCostGallonToCostLiter(in_valToConvert))
            Case Else
                ConvertUSToMetricValue = CDbl(in_valToConvert)

        End Select

    End Function


    Public Function GetEngines(ByVal inModelID, ByVal nMAXEngines) As String
        Dim tmpString As String = ""
        Dim adoRs As System.Data.SqlClient.SqlDataReader : adoRs = Nothing
        Dim Query As String : Query = ""
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Try

            'Select Case Application.Item("webHostObject").evoWebHostType
            'Case eWebSiteTypes.LOCAL
            'SqlConn.ConnectionString = My.Settings.DEFAULT_LOCAL_MSSQL
            'Case Else
            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            'End Select

            SqlConn.Open()

            Dim nLoop As Long = 0
            Dim nCurrentNumber As Integer = 0
            tmpString = ""
            Dim sSeparator As String = ""

            Query = "SELECT ameng_engine_name, ameng_seq_no"
            Query = Query & " FROM Aircraft_Model_Engine WITH(NOLOCK) WHERE ameng_amod_id = " & CStr(inModelID)
            Query = Query & " GROUP BY ameng_seq_no, ameng_engine_name ORDER BY ameng_seq_no, ameng_engine_name"

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60

            SqlCommand.CommandText = Query

            adoRs = SqlCommand.ExecuteReader()

            If (adoRs.HasRows) Then
                Do While adoRs.Read
                    tmpString = tmpString & sSeparator & Trim(adoRs("ameng_engine_name")) & crmWebClient.Constants.cHTMLnbsp
                    sSeparator = "<br>"
                    nCurrentNumber = nCurrentNumber + 1
                    'adoRs.Read()
                Loop
                adoRs.Close()
            End If

            If Len(Trim(tmpString)) > 55 Then
                tmpString = "<font size='-1'>" & tmpString & "</font>"
            End If

            adoRs = Nothing
            '    If nCurrentNumber <> nMAXEngines Then
            ' For nLoop = nCurrentNumber To nMAXEngines
            '  If nLoop < nMAXEngines Then
            '  tmpString = tmpString & "<br>&nbsp;"
            '  Else
            '   Exit For
            '  End If
            ' Next
            '  End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in GetEngines: " & ex.Message
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
        Return tmpString
    End Function
    Public Function GetEnginesNumberForSpace(ByVal inModelID, ByVal nMAXEngines) As String
        Dim tmpString As String = ""
        Dim adoRs As System.Data.SqlClient.SqlDataReader : adoRs = Nothing
        Dim Query As String : Query = ""
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Try

            ' THIS FUNCTION WAS CREATED TO RUN ON THE RIGHT COLUMN TO MAKE IT LINE UP WITH THE LEFT
            ' IT RUNS THE SAME QUERY AS GETENGINES FUNCTION BUT ONLY ADJUSTS VARIABLE NUMBER_OF_ENGINE_TYPES WHICH IS THEN LOOPED THROUGH
            ' MSW 8/30/10

            'Select Case Application.Item("webHostObject").evoWebHostType
            'Case eWebSiteTypes.LOCAL
            'SqlConn.ConnectionString = My.Settings.DEFAULT_LOCAL_MSSQL
            ' Case Else
            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            'End Select

            SqlConn.Open()

            Dim nLoop As Long = 0
            Dim nCurrentNumber As Integer = 0
            tmpString = ""
            Dim sSeparator As String = ""

            Query = "SELECT ameng_engine_name, ameng_seq_no"
            Query = Query & " FROM Aircraft_Model_Engine WITH(NOLOCK) WHERE ameng_amod_id = " & CStr(inModelID)
            Query = Query & " GROUP BY ameng_seq_no, ameng_engine_name ORDER BY ameng_seq_no, ameng_engine_name"

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60

            SqlCommand.CommandText = Query

            adoRs = SqlCommand.ExecuteReader()

            If (adoRs.HasRows) Then
                Do While adoRs.Read
                    number_of_engine_types = number_of_engine_types + 1
                Loop
                adoRs.Close()
            End If

            adoRs = Nothing
        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in GetEnginesNumberForSpace: " & ex.Message
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
        Return tmpString
    End Function

    Public Function GetForeignExchangeRate(ByVal in_CurrencyID, ByRef out_CurrencyName, ByRef out_CurrencyDate) As Double

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim adoRs As System.Data.SqlClient.SqlDataReader : adoRs = Nothing
        Dim Query As String : Query = ""
        Try
            'Select Case Application.Item("webHostObject").evoWebHostType
            'Case eWebSiteTypes.LOCAL
            'SqlConn.ConnectionString = My.Settings.DEFAULT_LOCAL_MSSQL
            '    Case Else
            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            '   End Select

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            out_CurrencyName = ""
            out_CurrencyDate = ""
            GetForeignExchangeRate = CDbl(1)

            Query = "SELECT currency_exchange_rate, currency_name, currency_exchange_rate_date FROM Currency WITH(NOLOCK) WHERE currency_id = " & in_CurrencyID
            SqlCommand.CommandText = Query
            adoRs = SqlCommand.ExecuteReader()

            If adoRs.HasRows Then
                adoRs.Read()
                If Not IsDBNull(adoRs.Item("currency_exchange_rate")) Then
                    GetForeignExchangeRate = CDbl(adoRs.Item("currency_exchange_rate"))
                End If

                If Not IsDBNull(adoRs.Item("currency_exchange_rate")) Then
                    If CLng(Trim(adoRs.Item("currency_exchange_rate"))) > 0 Then
                        GetForeignExchangeRate = CDbl(adoRs.Item("currency_exchange_rate"))
                    End If
                End If

                If Not IsDBNull(adoRs.Item("currency_name")) Then
                    If Trim(Trim(adoRs.Item("currency_name"))) <> "" Then
                        out_CurrencyName = Trim(adoRs.Item("currency_name"))
                    End If
                End If

                If Not IsDBNull(adoRs.Item("currency_exchange_rate_date")) Then
                    If Trim(Trim(adoRs.Item("currency_exchange_rate_date"))) <> "" Then
                        out_CurrencyDate = Trim(adoRs.Item("currency_exchange_rate_date"))
                    End If
                End If

                adoRs.Close()

            End If

            adoRs = Nothing
            SqlConn.Close()
        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in GetForeignExchangeRate: " & ex.Message
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
        Return GetForeignExchangeRate
    End Function

    Public Function ConvertUSToForeignCurrency(ByVal in_ExchangeRate, ByVal in_valToConvert)
        ConvertUSToForeignCurrency = CDbl(CDbl(in_ExchangeRate) * CDbl(in_valToConvert))
    End Function

    Public Function GetOwnerInfo(ByVal nAircraftID As Long, ByVal nAircraftJournalID As Long, ByVal bGetExclusive As Boolean, ByVal comp_id As Long) As DataSet

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim adors As System.Data.SqlClient.SqlDataReader : adors = Nothing
        Dim adoOwnerRs As New System.Data.SqlClient.SqlDataAdapter ': adoOwnerRs = Nothing
        Dim Query As String : Query = ""
        Try
            'Select Case Application.Item("webHostObject").evoWebHostType
            'Case eWebSiteTypes.LOCAL
            'SqlConn.ConnectionString = My.Settings.DEFAULT_LOCAL_MSSQL
            ' Case Else
            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            'End Select

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = Query

            GetOwnerInfo = Nothing

            Query = "SELECT * FROM Company WITH(NOLOCK)"
            Query = Query & " INNER JOIN Aircraft_Reference WITH(NOLOCK) ON (comp_id = cref_comp_id AND comp_journ_id = cref_journ_id)"
            Query = Query & " LEFT OUTER JOIN Contact WITH(NOLOCK) ON (cref_contact_id = contact_id AND cref_journ_id = contact_journ_id)"
            Query = Query & " WHERE (cref_ac_id = " & CStr(nAircraftID) & " AND cref_journ_id = " & CStr(nAircraftJournalID)

            If Not bGetExclusive Then
                Query = Query & " AND cref_transmit_seq_no = 1 AND cref_contact_type <> '71'"
            Else
                Query = Query & " AND ((cref_contact_type = '99') OR (cref_contact_type = '93') OR (cref_transmit_seq_no = 4))"
            End If

            If nAircraftJournalID = 0 Then
                Query = Query & " AND comp_active_flag = 'Y'"
            End If

            If comp_id > 0 Then
                Query = Query & " AND comp_id = " & comp_id & " "
            End If

            Query = Query & " AND comp_hide_flag = 'N')"
            Query = Query & MakeCompanyProductCodeClause(False)
            SqlCommand.CommandText = Query
            Dim x As New System.Data.DataSet
            adoOwnerRs.SelectCommand = SqlCommand
            adoOwnerRs.Fill(x) 'SqlCommand.BeginExecuteNonQuery
            GetOwnerInfo = x
            x.Dispose()
            x = Nothing

        Catch ex As Exception
            GetOwnerInfo = Nothing
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in GetOwnerInfo: " & ex.Message
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function

    Public Function MakeCompanyProductCodeClause(ByVal bIgnoreFilter) As String
        MakeCompanyProductCodeClause = ""


    End Function

    Function GetContactTypeForContactID(ByVal inContactType)

        Dim adors As System.Data.SqlClient.SqlDataReader : adors = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim Query As String = ""
        Try
            Query = "SELECT actype_name FROM Aircraft_Contact_Type WITH(NOLOCK) WHERE (actype_code = '" & inContactType & "'"

            ' Hide Exclusive Brokers and Representatives and Dealers from Aerodex users
            If HttpContext.Current.Session.Item("localPreferences").AerodexFlag Then
                Query = Query & " AND actype_code NOT IN ('93','98','99','67','68','02'))"
            Else
                Query = Query & " AND actype_code NOT IN ('67','68','02'))"
            End If

            'Select Case Application.Item("webHostObject").evoWebHostType
            'Case eWebSiteTypes.LOCAL
            'SqlConn.ConnectionString = My.Settings.DEFAULT_LOCAL_MSSQL
            '   Case Else
            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            '  End Select

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = Query

            adors = SqlCommand.ExecuteReader()

            If adors.HasRows Then
                adors.Read()
                GetContactTypeForContactID = Replace(Trim(adors.Item("actype_name")), "Additional Contact1", "Additional Company")
                adors.Close()
            Else
                GetContactTypeForContactID = ""
            End If

            adors = Nothing
        Catch ex As Exception
            GetContactTypeForContactID = ""
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in GetContactTypeForContactID: " & ex.Message
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function


    Function GetModelEventsInfo(ByVal inModelID)

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim adors As System.Data.SqlClient.SqlDataReader : adors = Nothing
        Dim query As String : query = ""
        Dim adUseClient As Integer = 0
        Dim adUseServer As Integer = 0
        Try

            If HttpContext.Current.Session.Item("localPreferences").AerodexFlag Then ' NOTE : need to update clause if new market status types are added
                GetModelEventsInfo = "No Events at this time, for this Make/Model ..."
            Else
                GetModelEventsInfo = "No Market Status Events at this time, for this Make/Model ..."
            End If


            query = "SELECT TOP 30 priorev_entry_date, ac_mfr_year, ac_ser_no_full, ac_reg_no, ac_id, priorev_subject, priorev_description, amod_make_name FROM Priority_Events WITH(NOLOCK)"
            query = query & " INNER JOIN Priority_Events_category WITH(NOLOCK) ON priorevcat_category_code = priorev_category_code INNER JOIN aircraft WITH(NOLOCK) ON"
            query = query & " priorev_ac_id = ac_id AND ac_journ_id = 0 INNER JOIN Aircraft_Model WITH(NOLOCK) ON ac_amod_id = amod_id"
            query = query & " WHERE amod_id = " & inModelID & " "

            If HttpContext.Current.Session.Item("localPreferences").AerodexFlag Then ' NOTE : need to update clause if new market status types are added
                query = query & " AND priorevcat_category <> 'Market Status' AND priorev_category_code NOT IN ('CA','EXOFF','EXON','MA','OM','OMNS','SALEP','SC','SPTOIM', 'ACOEX')"
            Else
                query = query & " AND priorevcat_category = 'Market Status' "
            End If


            ' if line is taken out, seems to have no effect, but leaving in 
            '  query = query & commonEVO.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, False)
            query = query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, True)

            query = query & " ORDER BY priorev_id DESC"

            'Select Case Application.Item("webHostObject").evoWebHostType
            'Case eWebSiteTypes.LOCAL
            'SqlConn.ConnectionString = My.Settings.DEFAULT_LOCAL_MSSQL
            '  Case Else
            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            ' End Select

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = query

            adors = SqlCommand.ExecuteReader()
            'Dim temp_trim_desc As String

            If adors.HasRows Then
                GetModelEventsInfo = vbCrLf & "<table  align='center' border='1' id='forSaleInnerTable' width='90%' cellpadding='1' cellspacing='0'>"
                GetModelEventsInfo = GetModelEventsInfo & vbCrLf & "<tr><td class='table_specs'><b>Date:</b></td><td class='table_specs'><b>Status</b></td><td class='table_specs'><b>Serial#</b></td><td class='table_specs'><b>Reg#</b></td><td class='table_specs'><b>Year MFR</b></td><td class='table_specs'><b>Event Desc</b></td></tr>" & vbCrLf

                Do While adors.Read
                    GetModelEventsInfo = GetModelEventsInfo & "<tr>"
                    If Not IsDBNull(adors.Item("priorev_entry_date")) Then
                        GetModelEventsInfo = GetModelEventsInfo & "<td align='left' valign='top' nowrap='nowrap' class='table_specs'><em>" & FormatDateTime(adors.Item("priorev_entry_date"), 2) & "</em></td>" & vbCrLf
                    Else
                        GetModelEventsInfo = GetModelEventsInfo & "<td align='left' valign='top' nowrap='nowrap' class='table_specs'><em>&nbsp;</em></td>" & vbCrLf
                    End If
                    If Not IsDBNull(adors.Item("priorev_subject")) Then
                        GetModelEventsInfo = GetModelEventsInfo & "<td align='left' valign='top' nowrap='nowrap' class='table_specs'>" & adors.Item("priorev_subject") & "</td>" & vbCrLf
                    Else
                        GetModelEventsInfo = GetModelEventsInfo & "<td align='left' valign='top' nowrap='nowrap' class='table_specs'>&nbsp;</td>" & vbCrLf
                    End If
                    If Not IsDBNull(adors.Item("ac_ser_no_full")) Then
                        GetModelEventsInfo = GetModelEventsInfo & "<td align='left' valign='top' nowrap='nowrap' class='table_specs'>" & adors.Item("ac_ser_no_full") & "</td>" & vbCrLf
                    Else
                        GetModelEventsInfo = GetModelEventsInfo & "<td align='left' valign='top' nowrap='nowrap' class='table_specs'>&nbsp;</td>" & vbCrLf
                    End If
                    If Not IsDBNull(adors.Item("ac_reg_no")) Then
                        GetModelEventsInfo = GetModelEventsInfo & "<td align='left' valign='top' nowrap='nowrap' class='table_specs'>" & adors.Item("ac_reg_no") & "</td>" & vbCrLf
                    Else
                        GetModelEventsInfo = GetModelEventsInfo & "<td align='left' valign='top' nowrap='nowrap' class='table_specs'>&nbsp;</td>" & vbCrLf
                    End If
                    If Not IsDBNull(adors.Item("ac_mfr_year")) Then
                        GetModelEventsInfo = GetModelEventsInfo & "<td align='left' valign='top' nowrap='nowrap' class='table_specs'>" & adors.Item("ac_mfr_year") & "</td>" & vbCrLf
                    Else
                        GetModelEventsInfo = GetModelEventsInfo & "<td align='left' valign='top' nowrap='nowrap' class='table_specs'>&nbsp;</td>" & vbCrLf
                    End If
                    If Not IsDBNull(adors.Item("priorev_description")) Then
                        GetModelEventsInfo = GetModelEventsInfo & "<td align='left' valign='top' nowrap='nowrap' class='table_specs'>" & Left(adors.Item("priorev_description").ToString, 45).ToString & "</td></tr>" & vbCrLf
                        'GetModelEventsInfo = GetModelEventsInfo & "<td align='left' valign='top' nowrap='nowrap' class='table_specs'>&nbsp;</td></tr>" & vbCrLf
                    Else
                        GetModelEventsInfo = GetModelEventsInfo & "<td align='left' valign='top' nowrap='nowrap' class='table_specs'>&nbsp;</td></tr>" & vbCrLf
                    End If

                Loop
                adors = Nothing

                GetModelEventsInfo = GetModelEventsInfo & "</table>"

            End If
        Catch ex As Exception
            GetModelEventsInfo = ""
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in GetModelEventsInfo: " & ex.Message
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function
    Function NEW_GetModelEventsInfo(ByVal inModelID)

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim adors As System.Data.SqlClient.SqlDataReader : adors = Nothing
        Dim query As String : query = ""
        Dim adUseClient As Integer = 0
        Dim adUseServer As Integer = 0
        Try

            If HttpContext.Current.Session.Item("localPreferences").AerodexFlag Then ' NOTE : need to update clause if new market status types are added
                NEW_GetModelEventsInfo = "No Events at this time, for this Make/Model ..."
            Else
                NEW_GetModelEventsInfo = "No Market Status Events at this time, for this Make/Model ..."
            End If


            query = "SELECT TOP 40 priorev_entry_date, ac_mfr_year, ac_ser_no_full, ac_reg_no, ac_id, priorev_subject, priorev_description, amod_make_name FROM Priority_Events WITH(NOLOCK)"
            query = query & " INNER JOIN Priority_Events_category WITH(NOLOCK) ON priorevcat_category_code = priorev_category_code INNER JOIN aircraft WITH(NOLOCK) ON"
            query = query & " priorev_ac_id = ac_id AND ac_journ_id = 0 INNER JOIN Aircraft_Model WITH(NOLOCK) ON ac_amod_id = amod_id"
            query = query & " WHERE amod_id = " & inModelID & " "

            If HttpContext.Current.Session.Item("localPreferences").AerodexFlag Then ' NOTE : need to update clause if new market status types are added
                query = query & " AND priorevcat_category <> 'Market Status' AND priorev_category_code NOT IN ('CA','EXOFF','EXON','MA','OM','OMNS','SALEP','SC','SPTOIM', 'ACOEX')"
            Else
                query = query & " AND priorevcat_category = 'Market Status' "
            End If

            If localCriteria.ViewCriteriaAFTTStart > 0 Then
                query = query & (Constants.cAndClause + " ((ac_airframe_tot_hrs >= " & localCriteria.ViewCriteriaAFTTStart & ") or (ac_airframe_tot_hrs IS NULL))")
            End If

            If localCriteria.ViewCriteriaAFTTEnd > 0 Then
                query = query & (Constants.cAndClause + " ((ac_airframe_tot_hrs <= " & localCriteria.ViewCriteriaAFTTEnd & ") or (ac_airframe_tot_hrs IS NULL))")
            End If

            If localCriteria.ViewCriteriaYearStart > 0 Then
                query = query & (Constants.cAndClause + " ac_mfr_year >= " & localCriteria.ViewCriteriaYearStart)
            End If

            If localCriteria.ViewCriteriaYearEnd > 0 Then
                query = query & (Constants.cAndClause + " ac_mfr_year <=  " & localCriteria.ViewCriteriaYearEnd)
            End If


            ' if line is taken out, seems to have no effect, but leaving in 
            '  query = query & commonEVO.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, False)
            query = query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, True)

            query = query & " ORDER BY priorev_id DESC"

            'Select Case Application.Item("webHostObject").evoWebHostType
            'Case eWebSiteTypes.LOCAL
            'SqlConn.ConnectionString = My.Settings.DEFAULT_LOCAL_MSSQL
            '  Case Else
            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            ' End Select

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = query

            adors = SqlCommand.ExecuteReader()
            'Dim temp_trim_desc As String

            If adors.HasRows Then
                NEW_GetModelEventsInfo = vbCrLf & "<table  align='center' id='forSaleInnerTable'  bordercolor='lightgrey' border='1' cellpadding='6' cellspacing='0' width='100%' class=""formatTable smallText"">"
                NEW_GetModelEventsInfo = NEW_GetModelEventsInfo & vbCrLf & "<tr><td class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Date</strong></td><td class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Status</font></td><td class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Serial#</font></td><td class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Reg#</font></td><td class='table_specs right margin_right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Year MFR</font></td><td class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Event Description</font></td></tr>" & vbCrLf

                Do While adors.Read
                    NEW_GetModelEventsInfo = NEW_GetModelEventsInfo & "<tr>"
                    If Not IsDBNull(adors.Item("priorev_entry_date")) Then
                        NEW_GetModelEventsInfo = NEW_GetModelEventsInfo & "<td align='left' valign='top' nowrap='nowrap' class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatDateTime(adors.Item("priorev_entry_date"), 2) & "</font></td>" & vbCrLf
                    Else
                        NEW_GetModelEventsInfo = NEW_GetModelEventsInfo & "<td align='left' valign='top' nowrap='nowrap' class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'></font></td>" & vbCrLf
                    End If
                    If Not IsDBNull(adors.Item("priorev_subject")) Then
                        NEW_GetModelEventsInfo = NEW_GetModelEventsInfo & "<td align='left' valign='top' nowrap='nowrap' class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & adors.Item("priorev_subject") & "</font></td>" & vbCrLf
                    Else
                        NEW_GetModelEventsInfo = NEW_GetModelEventsInfo & "<td align='left' valign='top' nowrap='nowrap' class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
                    End If
                    If Not IsDBNull(adors.Item("ac_ser_no_full")) Then
                        NEW_GetModelEventsInfo = NEW_GetModelEventsInfo & "<td align='left' valign='top' nowrap='nowrap' class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & adors.Item("ac_ser_no_full") & "</font></td>" & vbCrLf
                    Else
                        NEW_GetModelEventsInfo = NEW_GetModelEventsInfo & "<td align='left' valign='top' nowrap='nowrap' class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
                    End If
                    If Not IsDBNull(adors.Item("ac_reg_no")) Then
                        NEW_GetModelEventsInfo = NEW_GetModelEventsInfo & "<td align='left' valign='top' nowrap='nowrap' class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & adors.Item("ac_reg_no") & "</font></td>" & vbCrLf
                    Else
                        NEW_GetModelEventsInfo = NEW_GetModelEventsInfo & "<td align='left' valign='top' nowrap='nowrap' class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
                    End If
                    If Not IsDBNull(adors.Item("ac_mfr_year")) Then
                        NEW_GetModelEventsInfo = NEW_GetModelEventsInfo & "<td align='right' valign='top' nowrap='nowrap' class='table_specs  margin_right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & adors.Item("ac_mfr_year") & "</font></td>" & vbCrLf
                    Else
                        NEW_GetModelEventsInfo = NEW_GetModelEventsInfo & "<td align='right' valign='top' nowrap='nowrap' class='table_specs margin_right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td>" & vbCrLf
                    End If
                    If Not IsDBNull(adors.Item("priorev_description")) Then
                        NEW_GetModelEventsInfo = NEW_GetModelEventsInfo & "<td align='left' valign='top' nowrap='nowrap' class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & Left(adors.Item("priorev_description").ToString, 45).ToString & "</font></td></tr>" & vbCrLf
                        'NEW_GetModelEventsInfo = NEW_GetModelEventsInfo & "<td align='left' valign='top' nowrap='nowrap' class='table_specs'>&nbsp;</td></tr>" & vbCrLf
                    Else
                        NEW_GetModelEventsInfo = NEW_GetModelEventsInfo & "<td align='left' valign='top' nowrap='nowrap' class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td></tr>" & vbCrLf
                    End If

                Loop
                adors = Nothing

                NEW_GetModelEventsInfo = NEW_GetModelEventsInfo & "</table>"

            End If
        Catch ex As Exception
            NEW_GetModelEventsInfo = ""
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in NEW_GetModelEventsInfo: " & ex.Message
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function


    Public Function Convert_To_PDF(ByVal report_name As String, ByVal view_Type As Integer) As Boolean

        Dim reportFolder As String = HttpContext.Current.Server.MapPath(HttpContext.Current.Session.Item("MarketSummaryFolderVirtualPath").ToString)
        Dim bReturnValue As Boolean = False
        Dim varURL As String = ""
        Dim varTimeout As Integer = 0

        Dim htmlToPdfConverter As New EvoPdf.HtmlToPdfConverter()

        Try

            varURL = reportFolder + "\" + report_name
            varTimeout = 60

            ' Set license key received after purchase to use the converter in licensed mode
            ' Leave it not set to use the converter in demo mode
            ' htmlToPdfConverter.LicenseKey = "" '"4W9+bn19bn5ue2B+bn1/YH98YHd3d3c="
            ' htmlToPdfConverter.LicenseKey = "31FCUEVAUEJCSFBGXkBQQ0FeQUJeSUlJSVBA"
            htmlToPdfConverter.LicenseKey = "9Xtoem9qemp6bXRqemlrdGtodGNjY2N6ag=="

            ' Set HTML Viewer width in pixels which is the equivalent in converter of the browser window width
            htmlToPdfConverter.HtmlViewerWidth = 1024

            ' Set HTML viewer height in pixels to convert the top part of a HTML page 
            ' Leave it not set to convert the entire HTML
            htmlToPdfConverter.HtmlViewerHeight = 0

            ' Set PDF page size which can be a predefined size like A4 or a custom size in points 
            ' Leave it not set to have a default A4 PDF page
            If view_Type = 997 Or view_Type = 998 Then
                htmlToPdfConverter.PdfDocumentOptions.PdfPageSize = EvoPdf.PdfPageSize.Letter
            Else
                htmlToPdfConverter.PdfDocumentOptions.PdfPageSize = EvoPdf.PdfPageSize.A4
            End If


            ' Set PDF page orientation to Portrait or Landscape
            ' Leave it not set to have a default Portrait orientation for PDF page
            htmlToPdfConverter.PdfDocumentOptions.PdfPageOrientation = EvoPdf.PdfPageOrientation.Portrait

            ' Set the maximum time in seconds to wait for HTML page to be loaded 
            ' Leave it not set for a default 60 seconds maximum wait time
            htmlToPdfConverter.NavigationTimeout = varTimeout

            ' Set an adddional delay in seconds to wait for JavaScript or AJAX calls after page load completed
            ' Set this property to 0 if you don't need to wait for such asynchcronous operations to finish
            htmlToPdfConverter.ConversionDelay = 0

            htmlToPdfConverter.ConvertUrlToFile(varURL, reportFolder + "\" + commonEvo.GenerateFileName(report_name, ".pdf", True))

            bReturnValue = True

        Catch ex As Exception

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "error in convert_to_pdf: " + ex.Message

        Finally

            ' Clear Objects
            htmlToPdfConverter = Nothing

        End Try

        Return bReturnValue

    End Function

    Public Function GenerateFileName(ByVal s_filename As String, ByVal s_filetype As String, ByVal b_replace_filetype As Boolean) As String
        GenerateFileName = ""

        Dim s_seperator As String = ""
        Dim s_tmpFileName As String = ""
        Try
            GenerateFileName = ""
            s_seperator = "_"

            If Not b_replace_filetype Then

                Dim s_day As String
                Dim s_month As String
                Dim s_year As String
                Dim n_hour As Integer
                Dim s_minute As String
                Dim s_second As String
                Dim s_ampm As String = Chr(38)

                s_day = Day(Now())
                s_month = Month(Now())
                s_year = Year(Now())
                n_hour = CInt(Hour(Now()))
                s_minute = Minute(Now())
                s_second = Second(Now())

                Select Case n_hour

                    Case 0
                        s_ampm = "AM"
                        n_hour = 12
                    Case 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11
                        s_ampm = "AM"
                    Case 12
                        s_ampm = "PM"
                    Case 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23
                        s_ampm = "PM"
                        n_hour = n_hour - 12

                End Select

                s_tmpFileName = s_month & s_seperator & s_day & s_seperator & s_year &
                              s_seperator & CStr(n_hour) & s_seperator & s_minute & s_seperator & s_second &
                              s_seperator & s_ampm

                If s_filename <> "" Then
                    s_tmpFileName = s_filename & s_seperator & s_tmpFileName
                End If

                If s_filetype <> "" Then
                    s_tmpFileName = s_tmpFileName & s_filetype
                End If

            Else
                Dim pos
                pos = InStr(1, s_filename, ".")

                If pos > 0 Then
                    s_tmpFileName = Left(s_filename, pos - 1) & s_filetype
                Else
                    s_tmpFileName = s_filename & s_filetype
                End If

            End If

            GenerateFileName = s_tmpFileName

        Catch ex As Exception
            Response.Write("error in conveter_to_pdf: " & ex.Message)
        End Try
    End Function

    Public Function Build_MarketSummaryGraph(ByVal Data As Object, ByVal HideLast As Object, ByVal leftTitle As Object, ByVal BottomTitle As Object, ByVal Labels As Object) As String
        Build_MarketSummaryGraph = ""
        Try
            Dim objBuilder As New StringBuilder
            objBuilder.Append("<table align='center' width='90%' cellpadding='1' cellspacing='0'>")
            objBuilder.Append("<tr><td>Recent Sales Trends" & vbCrLf)
            objBuilder.Append("JETNET - Market Summary Graph -" & Replace(leftTitle, ";", "'"))

            'objBuilder.Append("<asp:Chart ID='Chart1' runat='server'><series>1<asp:Series Name='Series1'>2</asp:Series>3</series>4<chartareas><asp:ChartArea Name='ChartArea1'>5</asp:ChartArea>6</chartareas>7</asp:Chart>")

            'objBuilder.Append("<asp:Chart ID='chtNBAChampionships' runat='server'><Series>")
            'objBuilder.Append("<asp:Series Name='Championships' YValueType='Int32' ChartType='Column' ChartArea='MainChartArea'>")
            'objBuilder.Append("<Points><asp:DataPoint AxisLabel='Celtics' YValues='17' /><asp:DataPoint AxisLabel='Lakers' YValues='15' />")
            'objBuilder.Append("<asp:DataPoint AxisLabel='Bulls' YValues='6' /><asp:DataPoint AxisLabel='Spurs' YValues='4' />")
            'objBuilder.Append("<asp:DataPoint AxisLabel='76ers' YValues='3' /><asp:DataPoint AxisLabel='Pistons' YValues='3' />")
            'objBuilder.Append("<asp:DataPoint AxisLabel='Warriors' YValues='3' /></Points></asp:Series></Series>")
            'objBuilder.Append("<ChartAreas><asp:ChartArea Name='MainChartArea'></asp:ChartArea></ChartAreas></asp:Chart>")





            ' objBuilder.Append(Replace(



            ' objBuilder.Append(Replace(TopTitle, ";", "'"))

            ' THIS IS WHERE THE INSERTED CODE ENDS -------------------------------------------------
            'objBuilder.Append("<meta http-equiv='Content-Language' content='en-us'>")
            'objBuilder.Append(" <meta http-equiv='Content-Type' content='text/html; charset=windows-1252'>")
            'objBuilder.Append("<link rel='stylesheet' type='text/css' href='common/jetnet.css'>")

            'If Session("Aerodex") Then
            '  objBuilder.Append("<img src='images/Aerodex/MarketSummaryGraphHeader.gif'>")
            'Else
            '  objBuilder.Append("<img src='images/MarketSummaryGraphHeader.gif'>")
            'End If

            'objBuilder.Append("<form name='frmGraph' method='post' action='MarketSummaryGraph.asp'>")

            'objBuilder.Append("<input type='hidden' name='TopTitle' value='TopTitle' />")
            'objBuilder.Append("<input type='hidden' name='BottomTitle' value='BottomTitle' />")
            'objBuilder.Append("<input type='hidden' name='LeftTitle' value='LeftTitle' />")

            'objBuilder.Append("<input type='hidden' name='Labels' value='Labels' />")
            'objBuilder.Append("<input type='hidden' name='Data' value='Data' />")
            'objBuilder.Append("<input type='hidden' name='Data2' value='Data2%>' />")
            'objBuilder.Append("<input type='hidden' name='HideLast' value='HideLast%>' />")

            'objBuilder.Append("<input type='hidden' name='GraphType' value='' />")
            'objBuilder.Append(" </form>")
            ' THIS IS WHERE THE INSERTED CODE STARTS -----------------------------------------------
            objBuilder.Append("</td></tr>" & vbCrLf)
            objBuilder.Append("</table>" & vbCrLf)

            'ViewToPDF = ViewToPDF & Build_MarketSummaryGraph("76,77,75,68,69,67" , "BUSINESS+AIRCRAFT+TYPES+EQUALS+JETS+MAKE%5BS%5D+EQUALS+%27CHALLENGER%27+MODEL%5BS%5D+EQUALS+600++MODEL%5BS%5D+EQUALS+601%2D1A++MODEL%5BS%5D+EQUALS+300+", "Aircraft For Sale" , "6 Months" , "2/2010,3/2010,4/2010,5/2010,6/2010,7/2010",'MSGraphFS'")


            Build_MarketSummaryGraph = objBuilder.ToString
        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Build_RecentMarketActivity: " & ex.Message
        End Try
    End Function

    '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
    ' Function name: Get_Aircraft_Model_Description
    ' Purpose: to connect to the Aircraft_Model table and select the amod_description based on the amod_id
    ' Parameters: amod_id
    ' Return: 
    '       String - the amod_description for the ac model based on the passed amod_id
    ' Change Log
    '           05/27/2010    - Created By: Tom Jones
    ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
    Public Function Get_Aircraft_Model_Description(ByVal amod_id As Integer) As String

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlDataReader As System.Data.SqlClient.SqlDataReader : SqlDataReader = Nothing

        Dim tmpStr As String : tmpStr = ""

        Dim Query As String : Query = ""
        Query = "SELECT DISTINCT amod_description FROM Aircraft_Model WITH(NOLOCK) WHERE amod_id = " + amod_id.ToString
        ' Query &= " " + commonEVO.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, False)
        Query = Query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, False)

        Try

            'Select Case Application.Item("webHostObject").evoWebHostType
            'Case eWebSiteTypes.LOCAL
            'SqlConn.ConnectionString = My.Settings.DEFAULT_LOCAL_MSSQL
            '  Case Else
            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            'End Select

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandTimeout = 1000
            SqlCommand.CommandText = Query.ToString

            SqlDataReader = SqlCommand.ExecuteReader()

            If SqlDataReader.HasRows Then
                SqlDataReader.Read()
                If Not (IsDBNull(SqlDataReader("amod_description"))) Then
                    tmpStr = SqlDataReader("amod_description").ToString


                    If Len(Trim(tmpStr)) > 1200 Then
                        tmpStr = Replace(tmpStr, " foot ", " ft ")
                        tmpStr = Replace(tmpStr, " feet ", " ft ")
                        tmpStr = Replace(tmpStr, " feet.", " ft.")
                        tmpStr = Replace(tmpStr, " feet,", " ft,")
                        tmpStr = Replace(tmpStr, "twenty-three", "23")
                        tmpStr = Replace(tmpStr, "â€™", "'")
                        tmpStr = Replace(tmpStr, "eighteen", "18")
                        tmpStr = Replace(tmpStr, "fourteen ", "14 ")
                        tmpStr = Replace(tmpStr, " Two ", " 2 ")

                        If Len(Trim(tmpStr)) > 1300 Then
                            tmpStr = Replace(tmpStr, "requirements", "rqmts")
                            tmpStr = "<font size='-1'>" & tmpStr & "</font>"
                        End If
                    End If
                    End If
            End If

        Catch SqlException

            SqlConn.Dispose()
            SqlCommand.Dispose()

            Return ""

        Finally

            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()

        End Try

        Return tmpStr

    End Function
    Public Function Get_Assett_Insight_Model_Maint_Counts(ByVal amod_id As Integer, ByVal amod_string As String) As String

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlDataReader As System.Data.SqlClient.SqlDataReader : SqlDataReader = Nothing

        Dim tmpStr As String : tmpStr = ""

        Dim htmlOut = New StringBuilder()


        Dim Query As String : Query = ""

        Query = " Select distinct  aiinspect_description as AI_INSPECTION_NAME, aimaint_jetnet_item_id As JETNETID,  "
        Query &= " Case when mitem_name Is NULL then 'NOT MAPPED' else mitem_name end as JETNETNAME, "
        Query &= " count(distinct amod_id) As MODEL_COUNT, "
        Query &= " count(distinct aiinspect_ac_id) As AIRCRAFT "

        Query &= " From Asset_Insight_Aircraft_Inspections "
        Query &= " inner Join Aircraft_fmv with (NOLOCK) on afmv_source_id =aiinspect_analysis_id And afmv_latest_flag='Y' and afmv_status='Y' "
        Query &= " inner Join Aircraft with (NOLOCK) on ac_id = aiinspect_ac_id And ac_journ_id = 0  "
        Query &= " inner Join aircraft_Model with (NOLOCK) on ac_amod_id = amod_id "
        Query &= " Left outer join Asset_Insight_Maintenance_Item with (NOLOCK) on aiinspect_description=aimaint_description "
        Query &= " Left outer join Maintenance_Item with (NOLOCK) on aimaint_jetnet_item_id = mitem_id "
        Query &= " where aiinspect_description Not in ('Airframe Total Time','Exterior Repaint','Interior Refurbishment / Replacement') and aiinspect_description is not null "
        '--where aimaint_jetnet_item_id Is NULL
        '--where Asset_Insight_Aircraft_Inspections.aiinspect_description = '1 B Inspection'

        If amod_id > 0 Then
            Query &= " and amod_id = " & amod_id
        ElseIf Trim(amod_string) <> "" Then
            Query &= " and amod_id in (" & Trim(amod_string) & ") "
        End If

        Query &= " Group BY aiinspect_description, aimaint_jetnet_item_id, mitem_name "
        Query &= " order by aiinspect_description "





        Try
            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandTimeout = 1000
            SqlCommand.CommandText = Query.ToString

            SqlDataReader = SqlCommand.ExecuteReader()

            Dim resultsString As String = ""


            htmlOut.Append("<tr><td align='center' colspan='5'>")
            htmlOut.Append("<font class='" & Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & real_make_model_name & "</strong>&nbsp;ASSET INSIGHT MAINTENANCE ITEMS</font>")


            htmlOut.Append("<div class=""Box " & HttpContext.Current.Session("FONT_CLASS_TEXT") & """><table width=""100%"" cellpadding=""0"" cellspacing=""0"" class=""formatTable large"">")


            htmlOut.Append("<tr>")
            htmlOut.Append("<td align=""left"">Maintenance Item Name</td>")
            htmlOut.Append("</tr>")

            If SqlDataReader.HasRows Then

                Do While SqlDataReader.Read

                    htmlOut.Append("<tr><td>")

                    If Not (IsDBNull(SqlDataReader("AI_INSPECTION_NAME"))) Then
                        htmlOut.Append(SqlDataReader("AI_INSPECTION_NAME").ToString)
                    End If

                    '  If Not (IsDBNull(SqlDataReader("AIRCRAFT"))) Then
                    '  htmlOut.Append(" (" & SqlDataReader("AIRCRAFT").ToString & ")")
                    'End If 

                    htmlOut.Append("</td></tr>")

                Loop
            End If

            htmlOut.Append("</table></div><br clear=""all"" /></td></tr>")


        Catch ex As Exception

            SqlConn.Dispose()
            SqlCommand.Dispose()

            Return ""

        Finally

            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()

        End Try

        Return htmlOut.ToString

    End Function

    Public Function Get_Assett_Insight_Model_Features_Counts(ByVal amod_id As Integer, ByVal amod_string As String) As String

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlDataReader As System.Data.SqlClient.SqlDataReader : SqlDataReader = Nothing

        Dim tmpStr As String : tmpStr = ""

        Dim htmlOut = New StringBuilder()


        Dim Query As String : Query = ""

        Query = "select DISTINCT aimodif_description as ASSETNAME, aimodif_item_id AS ASSETID,  "
        Query &= " CASE when acatt_name is NULL then 'NOT MAPPED' else acatt_name end as JETNETATTRIBUTE, acatt_id AS JETNETATTID, count(distinct aiacmod_ac_id) as AIRCRAFT "
        Query &= " from Asset_Insight_Model_Modifications with (NOLOCK)  "
        Query &= " inner join Asset_Insight_Modifications with (NOLOCK) on aimodif_item_id = aimodmod_item_id  "
        Query &= " inner join Asset_Insight_Aircraft_Modifications with (NOLOCK) on aiacmod_ac_item_id = aimodmod_item_id "
        Query &= " left outer join Aircraft with (NOLOCK) on ac_id = aiacmod_ac_id and ac_journ_id = 0 "
        Query &= " left outer join Aircraft_Model with (NOLOCK) on ac_amod_id = amod_id "
        Query &= " left outer join [Homebase].jetnet_ra.dbo.aircraft_attribute with (NOLOCK) on acatt_id = aimodif_acatt_id  "

        If amod_id > 0 Then
            Query &= " where ac_amod_id = " & amod_id
        ElseIf Trim(amod_string) <> "" Then
            Query &= " where  ac_amod_id in (" & Trim(amod_string) & ") "
        End If


        Query &= " group by aimodif_description, aimodif_item_id, CASE when acatt_name is NULL then 'NOT MAPPED' else acatt_name end, acatt_id "
        Query &= " order by aimodif_description "


        Try
            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandTimeout = 1000
            SqlCommand.CommandText = Query.ToString

            SqlDataReader = SqlCommand.ExecuteReader()

            htmlOut.Append("<tr><td align='center' colspan='5'>")
            htmlOut.Append("<font class='" & Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & real_make_model_name & "</strong>&nbsp;ASSET INSIGHT FEATURES</font>")

            htmlOut.Append("<div class=""Box " & HttpContext.Current.Session("FONT_CLASS_TEXT") & """><table width=""100%"" cellpadding=""0"" cellspacing=""0"" class=""formatTable large"">")


            htmlOut.Append("<tr>")
            htmlOut.Append("<td>Feature Name</td>")
            htmlOut.Append("</tr>")

            If SqlDataReader.HasRows Then

                Do While SqlDataReader.Read

                    htmlOut.Append("<tr><td>")

                    If Not (IsDBNull(SqlDataReader("ASSETNAME"))) Then
                        htmlOut.Append(SqlDataReader("ASSETNAME").ToString)
                    End If


                    '   If Not (IsDBNull(SqlDataReader("AIRCRAFT"))) Then
                    '       htmlOut.Append(" (" & SqlDataReader("AIRCRAFT").ToString & ")")
                    'nd If


                    htmlOut.Append("</td></tr>")

                Loop
            End If

            htmlOut.Append("</table></div><br clear=""all"" /></td></tr>")

        Catch ex As Exception

            SqlConn.Dispose()
            SqlCommand.Dispose()

            Return ""

        Finally

            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()

        End Try

        Return htmlOut.ToString

    End Function



    Public Function Get_Aircraft_Model_Standard_Equipment(ByVal modelID As Long) As DataTable
        Dim sql As String = ""
        Dim aTempTable As New DataTable
        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing

        Try

            sql = "SELECT distinct kfeat_name FROM Aircraft_Model_Key_Feature WITH(NOLOCK) inner join Key_Feature WITH(NOLOCK) on amfeat_feature_code = kfeat_code"
            sql += "	WHERE kfeat_inactive_date IS NULL "
            sql += "	AND amfeat_amod_id = " + modelID.ToString
            sql += "	and amfeat_standard_equip='Y'"
            sql += "	ORDER BY kfeat_name"

            clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            SqlConn.Open()
            SqlCommand.Connection = SqlConn


            SqlCommand.CommandText = sql
            SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 60


            Try
                aTempTable.Load(SqlReader)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
            End Try

            Return aTempTable
        Catch ex As Exception
            Get_Aircraft_Model_Standard_Equipment = Nothing
        Finally
            SqlReader = Nothing

            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing
        End Try

    End Function



    Public Function GetUSBasedByModel(ByVal modelID As Long) As Long
        Dim sql As String = ""
        Dim aTempTable As New DataTable
        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing
        Dim totalCount As Long = 0
        Try

            sql = "SELECT count(*) as tcount"
            sql += " FROM Aircraft WITH(NOLOCK) "
            sql += " inner join Country with (NOLOCK) on ac_aport_country = country_name"
            sql += " WHERE(ac_lifecycle_stage = 3)"
            sql += " AND ac_amod_id = " & modelID.ToString
            sql += " and ac_journ_id = 0"
            sql += " AND not (ac_aport_country IS NULL)"

            If localCriteria.ViewCriteriaAFTTStart > 0 Then
                sql += (Constants.cAndClause + " ((ac_airframe_tot_hrs >= " & localCriteria.ViewCriteriaAFTTStart & ") or (ac_airframe_tot_hrs IS NULL))")
            End If

            If localCriteria.ViewCriteriaAFTTEnd > 0 Then
                sql += (Constants.cAndClause + " ((ac_airframe_tot_hrs <= " & localCriteria.ViewCriteriaAFTTEnd & ") or (ac_airframe_tot_hrs IS NULL))")
            End If

            If localCriteria.ViewCriteriaYearStart > 0 Then
                sql += (Constants.cAndClause + " ac_mfr_year >= " & localCriteria.ViewCriteriaYearStart)
            End If

            If localCriteria.ViewCriteriaYearEnd > 0 Then
                sql += (Constants.cAndClause + " ac_mfr_year <=  " & localCriteria.ViewCriteriaYearEnd)
            End If




            sql += " and ("


            If HttpContext.Current.Session.Item("localSubscription").crmBusiness_Flag = True Then
                sql += " ac_product_business_flag = 'Y' "
            End If

            If HttpContext.Current.Session.Item("localSubscription").crmBusiness_Flag = True And HttpContext.Current.Session.Item("localSubscription").crmCommercial_Flag = True Then
                sql += " or "
            End If

            If HttpContext.Current.Session.Item("localSubscription").crmCommercial_Flag = True Then
                sql += " ac_product_commercial_flag = 'Y' "
            End If

            If (HttpContext.Current.Session.Item("localSubscription").crmHelicopter_Flag = True And HttpContext.Current.Session.Item("localSubscription").crmCommercial_Flag = True) Or (HttpContext.Current.Session.Item("localSubscription").crmHelicopter_Flag = True And HttpContext.Current.Session.Item("localSubscription").crmBusiness_Flag = True) Then
                sql += " or "
            End If

            If HttpContext.Current.Session.Item("localSubscription").crmHelicopter_Flag = True Then
                sql += " ac_product_helicopter_flag = 'Y'"
            End If

            sql += ")"


            sql += " and ac_aport_country='United States'"


            clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            SqlConn.Open()
            SqlCommand.Connection = SqlConn


            SqlCommand.CommandText = sql
            SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
            SqlCommand.CommandType = CommandType.Text
            SqlCommand.CommandTimeout = 60


            Try
                aTempTable.Load(SqlReader)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
            End Try

            If Not IsNothing(aTempTable) Then
                If aTempTable.Rows.Count > 0 Then
                    totalCount = aTempTable.Rows(0).Item("tcount")
                End If
            End If

            Return totalCount
        Catch ex As Exception
            GetUSBasedByModel = Nothing
        Finally
            SqlReader = Nothing

            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing
        End Try

    End Function


    Public Function FillCurrencyList2() As String
        FillCurrencyList2 = ""

        Dim fCurrency_name As String = ""
        Dim fCurrency_ID As Integer = 0
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim SqlDataReader As System.Data.SqlClient.SqlDataReader : SqlDataReader = Nothing
        Dim Query As String = ""
        Dim tmpString As String = ""

        Try
            ' 'Select Case Application.Item("webHostObject").evoWebHostType
            '   'Case eWebSiteTypes.LOCAL
            '    'SqlConn.ConnectionString = My.Settings.DEFAULT_LOCAL_MSSQL
            ' Case Else
            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            ' End Select

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60

            Query = "SELECT currency_id, currency_name FROM Currency WITH(NOLOCK) WHERE currency_exchange_rate IS NOT NULL"
            Query = Query & " AND currency_exchange_rate_date IS NOT NULL ORDER BY currency_name"

            SqlCommand.CommandText = Query
            SqlDataReader = SqlCommand.ExecuteReader()

            If SqlDataReader.HasRows Then
                Do While SqlDataReader.Read

                    If Not IsDBNull(SqlDataReader.Item("currency_name")) Then
                        If Not String.IsNullOrEmpty(SqlDataReader.Item("currency_name").ToString) Then
                            fCurrency_name = SqlDataReader.Item("currency_name").ToString.Trim
                        Else
                            fCurrency_name = ""
                        End If
                    End If

                    If Not IsDBNull(SqlDataReader.Item("currency_id")) Then
                        If Not String.IsNullOrEmpty(SqlDataReader.Item("currency_id").ToString) Then
                            fCurrency_ID = CLng(SqlDataReader.Item("currency_id").ToString)
                        Else
                            fCurrency_ID = 0
                        End If
                    End If

                    If CLng(Session.Item("localPreferences").DefaultCurrency) = CLng(fCurrency_ID) Then
                        tmpString &= "<option selected value='" & fCurrency_ID.ToString & "'>" & fCurrency_name.Trim & "</option>" & vbCrLf
                    Else
                        tmpString &= "<option value='" & fCurrency_ID.ToString & "'>" & fCurrency_name.Trim & "</option>" & vbCrLf
                    End If

                Loop

                SqlDataReader.Close()

            End If

            SqlDataReader.Dispose()

            FillCurrencyList2 = tmpString.Trim

        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function

    Function displayAircraft_to_and_from_path(ByVal aMaxDate As Date, ByVal amod_id As Integer) As String

        displayAircraft_to_and_from_path = ""
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn2 As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand2 As New System.Data.SqlClient.SqlCommand
        Dim adoRs As System.Data.SqlClient.SqlDataReader : adoRs = Nothing
        Dim Query As String : Query = ""
        Dim htmlOutput As String = ""
        Dim ac5_make As String = ""
        Dim ac5_model As String = ""
        Dim bolnoData As Boolean
        Dim rs As System.Data.SqlClient.SqlDataReader : rs = Nothing
        Dim bolAll As Boolean
        Dim ac12_make As String = ""
        Dim ac12_model As String = ""
        Dim bolfirstRun As Boolean
        Dim first_time As Integer = 1


        Try
            SqlConn2.ConnectionString = Session.Item("localPreferences").STARDatabaseConn
            SqlConn2.Open()

            SqlCommand2.Connection = SqlConn2
            SqlCommand2.CommandType = System.Data.CommandType.Text
            SqlCommand2.CommandTimeout = 60

            Query = "SELECT ac5_make, ac5_model, ac5_total_sold, ac5_total_upgrades, ac5_percentage_with_upgrade, "
            Query = Query & "ac5_upgrade_to_make, ac5_upgrade_to_model, ac5_upgrade_to_total_upgrades, "
            Query = Query & "ac5_upgrade_to_percentage_with_upgrade, ac5_upgrade_to_aircraft_for_sale, "
            Query = Query & "ac5_upgrade_to_percentage_for_sale "
            Query = Query & "FROM dbo.Aircraft_5 "
            Query = Query & "WHERE (ac5_amod_id = '" + amod_id.ToString + "') AND (ac5_start_date = '" & aMaxDate & "')"

            SqlCommand2.CommandText = Query
            rs = SqlCommand2.ExecuteReader()

            ' rs.Read()

            ' check for an empty record set
            ' this report can generate an empty record set
            If (rs.HasRows) Then


                Do While rs.Read

                    If first_time = 1 Then
                        first_time = 2
                        ac5_make = rs("ac5_make").ToString
                        ac5_model = rs("ac5_model").ToString

                        htmlOutput = "<th class='th_title' align='center' colspan='10'>Upgrade To Path Model" & vbCrLf
                        htmlOutput = htmlOutput & "<br>Based on End User Transactions" & vbCrLf
                        htmlOutput = htmlOutput & "<br>" & ac5_make & " " & ac5_model & vbCrLf
                        htmlOutput = htmlOutput & "</th>"

                        htmlOutput = htmlOutput & "</tr>" & vbCrLf
                        htmlOutput = htmlOutput & "<TR>" & vbCrLf
                        htmlOutput = htmlOutput & "<TH class='beige' align='middle' colSpan='3'>AN OWNER OF " & ac5_make & " " & ac5_model & "</TH>" & vbCrLf
                        htmlOutput = htmlOutput & "<TH class='beige' align='middle' colSpan='6'>WILL MOST LIKELY BUY</TH>" & vbCrLf
                        htmlOutput = htmlOutput & "</TR>" & vbCrLf
                        htmlOutput = htmlOutput & "<TR>" & vbCrLf
                        'htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap colSpan='2'>STARTED WITH</TH>" & vbCrLf
                        htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap rowSpan='2'>TOTAL<BR>SOLD</TH>" & vbCrLf
                        htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap rowSpan='2'>TOTAL<BR>UPGRADES</TH>" & vbCrLf
                        htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap rowSpan='2'>PERCENT<BR>WITH<BR>UPGRADE<BR>PATH</TH>" & vbCrLf
                        htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap colSpan='2'>UPGRADED TO</TH>" & vbCrLf
                        htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap colSpan='2'>UPGRADES</TH>" & vbCrLf
                        htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap colSpan='2'>FOR SALE</TH>" & vbCrLf
                        htmlOutput = htmlOutput & "</TR>" & vbCrLf
                        htmlOutput = htmlOutput & "<TR>" & vbCrLf
                        'htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap>MAKE</TH>" & vbCrLf
                        'htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap>MODEL</TH>" & vbCrLf
                        htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap>MAKE</TH>" & vbCrLf
                        htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap>MODEL</TH>" & vbCrLf
                        htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap>TOTAL</TH>" & vbCrLf
                        htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap>PERCENT</TH>" & vbCrLf
                        htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap>TOTAL</TH>" & vbCrLf
                        htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap>PERCENT</TH>" & vbCrLf
                        htmlOutput = htmlOutput & "</TR>" & vbCrLf

                        htmlOutput = htmlOutput & "<TR>" & vbCrLf
                        ' htmlOutput = htmlOutput & "<TH class='beige' title='Make' noWrap align='left' rowSpan='5'>&nbsp;" & ac5_make & "</TH>" & vbCrLf
                        ' htmlOutput = htmlOutput & "<TH class='beige2' title='Model' noWrap align='center' rowSpan='5'>&nbsp;" & ac5_model & "</TH>" & vbCrLf
                        htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac5_make & " " & ac5_model & "- Total Number Of Sold Reports' noWrap align='right' rowSpan='5'><font size='-1'>" & vbCrLf
                        htmlOutput = htmlOutput & rs("ac5_total_sold").ToString & vbCrLf
                        htmlOutput = htmlOutput & "</font></TD>" & vbCrLf
                        htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac5_make & " " & ac5_model & "- Total Number Of Upgrades Found' noWrap align='right' rowSpan='5'><font size='-1'>" & vbCrLf
                        htmlOutput = htmlOutput & rs("ac5_total_upgrades").ToString & vbCrLf
                        htmlOutput = htmlOutput & "</font></TD>" & vbCrLf
                        htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac5_make & " " & ac5_model & " - Percentage Of Sold Reports With An Upgrade Path' noWrap align='right' rowSpan='5'><font size='-1'>" & vbCrLf
                        ' check to see if there is no data for for the percentage with upgrade
                        ' if = 0 then set the htmlOuptut to 0 if not set the value


                        If rs("ac5_percentage_with_upgrade") = 0 Then
                            htmlOutput = htmlOutput & "N/A" & vbCrLf
                            bolnoData = True
                        Else
                            htmlOutput = htmlOutput & rs("ac5_percentage_with_upgrade").ToString & "%" & vbCrLf
                            bolnoData = False
                        End If
                        htmlOutput = htmlOutput & "</font></TD>" & vbCrLf

                    End If


                    ' check and see if the boolean for noData is true
                    ' if true we set the left field to No Aircraft Upgrades Found if not run the loop and build the output
                    If bolnoData = True Then

                        htmlOutput = htmlOutput & "<TD class='lightgrey' title='" & ac5_make & " " & rs("ac5_model").ToString & "Percentage Of Sold Reports With An Upgrade Path' noWrap align='middle' colSpan='6'>" & vbCrLf
                        htmlOutput = htmlOutput & "No Aircraft Upgrades Found" & vbCrLf
                        htmlOutput = htmlOutput & "</TD>" & vbCrLf

                        Exit Do

                    Else

                        htmlOutput = htmlOutput & "<TD class='lightcyan' title='" & rs("ac5_upgrade_to_make").ToString & " " & rs("ac5_upgrade_to_model").ToString & "- Upgraded To Make' noWrap align='left'>" & vbCrLf
                        htmlOutput = htmlOutput & "&nbsp;<font size='-1'>" & rs("ac5_upgrade_to_make").ToString & vbCrLf
                        htmlOutput = htmlOutput & "</font></TD>" & vbCrLf
                        htmlOutput = htmlOutput & "<TD class='lightcyan' title='" & rs("ac5_upgrade_to_make").ToString & " " & rs("ac5_upgrade_to_model").ToString & "- Upgraded To Model' noWrap align='center'>" & vbCrLf
                        htmlOutput = htmlOutput & "&nbsp;<font size='-1'>" & rs("ac5_upgrade_to_model").ToString & vbCrLf
                        htmlOutput = htmlOutput & "</font></TD>" & vbCrLf
                        htmlOutput = htmlOutput & "<TD class='beige3' title='" & rs("ac5_upgrade_to_make").ToString & " " & rs("ac5_upgrade_to_model").ToString & "- Total Upgrades Found Per Model' noWrap align='right'>" & vbCrLf
                        htmlOutput = htmlOutput & "&nbsp;<font size='-1'>" & rs("ac5_upgrade_to_total_upgrades").ToString & vbCrLf
                        htmlOutput = htmlOutput & "</font></TD>" & vbCrLf
                        htmlOutput = htmlOutput & "<TD class='beige3' title='" & rs("ac5_upgrade_to_make").ToString & " " & rs("ac5_upgrade_to_model").ToString & "- Percentage Of Upgrades vs Sold Reports Found' noWrap align='right'>" & vbCrLf
                        htmlOutput = htmlOutput & "&nbsp;<font size='-1'>" & rs("ac5_upgrade_to_percentage_with_upgrade").ToString & "%" & vbCrLf
                        htmlOutput = htmlOutput & "</font></TD>" & vbCrLf
                        htmlOutput = htmlOutput & "<TD class='beige4' title='" & rs("ac5_upgrade_to_make").ToString & " " & rs("ac5_upgrade_to_model").ToString & "- Total Number For Sale' noWrap align='right'>" & vbCrLf
                        htmlOutput = htmlOutput & "&nbsp;<font size='-1'>" & rs("ac5_upgrade_to_aircraft_for_sale").ToString & vbCrLf
                        htmlOutput = htmlOutput & "</font></TD>" & vbCrLf
                        htmlOutput = htmlOutput & "<TD class='beige4' title='" & rs("ac5_upgrade_to_make").ToString & " " & rs("ac5_upgrade_to_model").ToString & "- Total Number For Sale' noWrap align='right'>" & vbCrLf
                        htmlOutput = htmlOutput & "&nbsp;<font size='-1'>" & rs("ac5_upgrade_to_percentage_for_sale").ToString & "%" & vbCrLf
                        htmlOutput = htmlOutput & "</font></TD>" & vbCrLf
                        htmlOutput = htmlOutput & "</TR>" & vbCrLf

                    End If
                    'aewr()
                Loop
            Else
                htmlOutput = htmlOutput & "<tr><td colspan='10' align='center'>No data available for the model you have selected</td></tr>"
            End If
            ' If bolAll = True Then
            htmlOutput = htmlOutput & "</table>"
            htmlOutput = htmlOutput & "<table cellspacing='0' cellpadding='2' align='center' width='600' border='0'>" & vbCrLf
            htmlOutput = htmlOutput & "<tr><td>" & vbCrLf
            'End If
            displayAircraft_to_and_from_path = displayAircraft_to_and_from_path & htmlOutput
            'Response.Write(htmlOutput)
            rs.Close()
            ' Else
            htmlOutput = "No data available for the model you have selected</TR><TR>"
            ' Response.Write(htmlOutput)
            ' End If

            rs = Nothing
            first_time = 1

            Query = "SELECT ac12_started_with_make, ac12_started_with_model, ac12_started_with_total_upgrades, "
            Query = Query & "ac12_started_with_total_upgrades_to_model, ac12_started_with_percentage_with_upgrade, "
            Query = Query & "ac12_upgrade_to_make, ac12_upgrade_to_model, ac12_upgrade_to_total_upgrades, "
            Query = Query & "ac12_upgrade_to_aircraft_for_sale, ac12_upgrade_to_percentage_for_sale "
            Query = Query & "FROM Aircraft_12 WITH(NOLOCK)"
            Query = Query & "WHERE (ac12_upgrade_to_amod_id   = '" + amod_id.ToString + "') AND (ac12_start_date = '" & aMaxDate & "')"
            SqlCommand2.CommandText = Query
            rs = SqlCommand2.ExecuteReader()

            ' rs.Read()
            ' check for an empty record set
            ' this report can generate an empty record set
            If (rs.HasRows) Then



                ' check to see if there is no data for for the percentage with upgrade
                ' if = 0 then set the htmlOuptut to 0 if not set the value


                ' If rs.Read = True Then

                Do While rs.Read

                    If first_time = 1 Then
                        first_time = 2
                        ac12_make = rs("ac12_upgrade_to_make").ToString
                        ac12_model = rs("ac12_upgrade_to_model").ToString

                        If rs("ac12_started_with_total_upgrades") = 0 Then
                            bolnoData = True
                        Else
                            bolnoData = False
                        End If
                        'ac12_make = server.htmlencode(rs("ac12_upgrade_to_make") & "/")
                        'ac12_model = server.htmlencode(rs("ac12_upgrade_to_model") & " ")

                        htmlOutput = "<th class='th_title' align='center' colspan='8'>Upgrade From Path by Model" & vbCrLf
                        htmlOutput = htmlOutput & "<br>Based on End User Transactions" & vbCrLf
                        htmlOutput = htmlOutput & "<br>" & ac12_make & " " & ac12_model & vbCrLf
                        htmlOutput = htmlOutput & "</th>" & vbCrLf
                        htmlOutput = htmlOutput & "</TR>" & vbCrLf

                        htmlOutput = htmlOutput & "<TR>" & vbCrLf
                        htmlOutput = htmlOutput & "<TH class='beige' align='middle' colSpan='5'>OWNER(S) OF</TH>" & vbCrLf
                        htmlOutput = htmlOutput & "<TH class='beige' align='middle' colSpan='5'>WILL MOST LIKELY BUY " & ac12_make & " " & ac12_model & "</TH>" & vbCrLf
                        htmlOutput = htmlOutput & "</TR>" & vbCrLf
                        htmlOutput = htmlOutput & "<TR>" & vbCrLf
                        htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap colSpan='2'>STARTED WITH</TH>" & vbCrLf
                        htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap rowSpan='2'>TOTAL<BR>UPGRADES</TH>" & vbCrLf
                        htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap rowSpan='2'>TOTAL<BR>UPGRADES<BR>TO MODEL</TH>" & vbCrLf
                        htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap rowSpan='2'>PERCENT<BR>WITH<BR>UPGRADE<BR>PATH</TH>" & vbCrLf
                        ' htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap colSpan='2'>UPGRADED TO</TH>" & vbCrLf
                        htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap rowSpan='2'>TOTAL<BR>UPGRADES<BR>TO</TH>" & vbCrLf
                        htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap colSpan='2'>FOR SALE</TH>" & vbCrLf
                        htmlOutput = htmlOutput & "</TR>" & vbCrLf
                        htmlOutput = htmlOutput & "<TR>" & vbCrLf
                        htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap>MAKE</TH>" & vbCrLf
                        htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap>MODEL</TH>" & vbCrLf
                        'htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap>MAKE</TH>" & vbCrLf
                        ' htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap>MODEL</TH>" & vbCrLf
                        htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap>TOTAL</TH>" & vbCrLf
                        htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap>PERCENT</TH>" & vbCrLf
                        htmlOutput = htmlOutput & "</TR>" & vbCrLf
                    End If

                    ' check and see if the boolean for noData is true
                    ' if true we set the left field to No Aircraft Upgrades Found if not run the loop and build the output
                    If bolnoData = True Then

                        htmlOutput = htmlOutput & "<TD class='lightgrey' title='" & ac12_make & " " & rs("ac12_started_with_model").ToString & "' noWrap align='middle' colSpan='5'>" & vbCrLf
                        htmlOutput = htmlOutput & "No Aircraft Upgrades Found" & vbCrLf
                        htmlOutput = htmlOutput & "</TD>" & vbCrLf
                        htmlOutput = htmlOutput & "<TH class='lightcyan' title='" & ac12_make & " " & ac12_model & "- Make Upgraded To' noWrap align='left' rowSpan='5'>" & vbCrLf
                        htmlOutput = htmlOutput & ac12_make & vbCrLf
                        htmlOutput = htmlOutput & "</TH>" & vbCrLf
                        htmlOutput = htmlOutput & "<TH class='beige2' title='" & ac12_make & " " & ac12_model & "- Model Upgraded To' noWrap align='center' rowSpan='5'>" & vbCrLf
                        htmlOutput = htmlOutput & ac12_model & vbCrLf
                        htmlOutput = htmlOutput & "</TH>" & vbCrLf
                        htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac12_make & " " & ac12_model & " - Total Upgrades To Found' noWrap align='right' rowSpan='5'>" & vbCrLf
                        htmlOutput = htmlOutput & rs("ac12_upgrade_to_total_upgrades").ToString & vbCrLf
                        htmlOutput = htmlOutput & "</TD>" & vbCrLf
                        htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac12_make & " " & ac12_model & " - Total Active Fleet For Sale' noWrap align='right' rowSpan='5'>" & vbCrLf
                        htmlOutput = htmlOutput & rs("ac12_upgrade_to_aircraft_for_sale").ToString & vbCrLf
                        htmlOutput = htmlOutput & "</TD>" & vbCrLf
                        htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac12_make & " " & ac12_model & " - Percentange Of Active Fleet For Sale' noWrap align='right' rowSpan='5'>" & vbCrLf
                        htmlOutput = htmlOutput & rs("ac12_upgrade_to_percentage_for_sale").ToString & "%" & vbCrLf
                        htmlOutput = htmlOutput & "</TD>" & vbCrLf
                        htmlOutput = htmlOutput & "</TR>" & vbCrLf
                        Exit Do

                    Else
                        If bolfirstRun = False Then
                            bolfirstRun = True

                            htmlOutput = htmlOutput & "<TR>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD class='lightcyan' title='" & rs("ac12_started_with_make").ToString & " " & rs("ac12_started_with_model").ToString & "- Started With Make' noWrap align='left'>" & vbCrLf
                            htmlOutput = htmlOutput & "&nbsp;<font size='-1'>" & rs("ac12_started_with_make").ToString & vbCrLf
                            htmlOutput = htmlOutput & "</TD>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD class='beige2' title='" & rs("ac12_started_with_make").ToString & " " & rs("ac12_started_with_model").ToString & "- Started With Model' noWrap align='center'>" & vbCrLf
                            htmlOutput = htmlOutput & "&nbsp;<font size='-1'>" & rs("ac12_started_with_model").ToString & vbCrLf
                            htmlOutput = htmlOutput & "</TD>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD class='beige3' title='" & rs("ac12_started_with_make").ToString & " " & rs("ac12_started_with_model").ToString & "-  Total Aircraft Upgrades Found' noWrap align='right'>" & vbCrLf
                            htmlOutput = htmlOutput & "&nbsp;<font size='-1'>" & rs("ac12_started_with_total_upgrades").ToString & vbCrLf
                            htmlOutput = htmlOutput & "</TD>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD class='beige3' title='" & rs("ac12_started_with_make").ToString & " " & rs("ac12_started_with_model").ToString & "- Total Aircraft Upgrades To Model Found' noWrap align='right'>" & vbCrLf
                            htmlOutput = htmlOutput & "&nbsp;<font size='-1'>" & rs("ac12_started_with_total_upgrades_to_model").ToString & vbCrLf
                            htmlOutput = htmlOutput & "</TD>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD class='beige4' title='" & rs("ac12_started_with_make").ToString & " " & rs("ac12_started_with_model").ToString & "- Percentange Of Upgrades To Model' noWrap align='right'>" & vbCrLf
                            htmlOutput = htmlOutput & "&nbsp;<font size='-1'>" & rs("ac12_started_with_percentage_with_upgrade").ToString & "%" & vbCrLf
                            htmlOutput = htmlOutput & "</TD>" & vbCrLf

                            'htmlOutput = htmlOutput & "<TH class='lightcyan' title='" & ac12_make & " " & ac12_model & "- Make Upgraded To' noWrap align='left' rowSpan='5'>" & vbCrLf
                            'htmlOutput = htmlOutput & ac12_make & vbCrLf
                            'htmlOutput = htmlOutput & "</TH>" & vbCrLf
                            'htmlOutput = htmlOutput & "<TH class='beige2' title='" & ac12_make & " " & ac12_model & "- Model Upgraded To' noWrap align='center' rowSpan='5'>" & vbCrLf
                            'htmlOutput = htmlOutput & ac12_model & vbCrLf
                            'htmlOutput = htmlOutput & "</TH>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac12_make & " " & ac12_model & " - Total Upgrades To Found' noWrap align='right' rowSpan='5'><font size='-1'>" & vbCrLf
                            htmlOutput = htmlOutput & rs("ac12_upgrade_to_total_upgrades").ToString & vbCrLf
                            htmlOutput = htmlOutput & "</TD>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac12_make & " " & ac12_model & " - Total Active Fleet For Sale' noWrap align='right' rowSpan='5'><font size='-1'>" & vbCrLf
                            htmlOutput = htmlOutput & rs("ac12_upgrade_to_aircraft_for_sale").ToString & vbCrLf
                            htmlOutput = htmlOutput & "</TD>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac12_make & " " & ac12_model & " - Percentange Of Active Fleet For Sale' noWrap align='right' rowSpan='5'><font size='-1'>" & vbCrLf
                            htmlOutput = htmlOutput & rs("ac12_upgrade_to_percentage_for_sale").ToString & "%" & vbCrLf
                            htmlOutput = htmlOutput & "</TD>" & vbCrLf
                            htmlOutput = htmlOutput & "</TR>" & vbCrLf

                        Else

                            htmlOutput = htmlOutput & "<TR>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD class='lightcyan' title='" & rs("ac12_started_with_make").ToString & " " & rs("ac12_started_with_model").ToString & "- Started With Make' noWrap align='left'>" & vbCrLf
                            htmlOutput = htmlOutput & "&nbsp;<font size='-1'>" & rs("ac12_started_with_make").ToString & vbCrLf
                            htmlOutput = htmlOutput & "</font></TD>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD class='beige2' title='" & rs("ac12_started_with_make").ToString & " " & rs("ac12_started_with_model").ToString & "- Started With Model' noWrap align='center'>" & vbCrLf
                            htmlOutput = htmlOutput & "&nbsp;<font size='-1'>" & rs("ac12_started_with_model").ToString & vbCrLf
                            htmlOutput = htmlOutput & "</font></TD>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD class='beige3' title='" & rs("ac12_started_with_make").ToString & " " & rs("ac12_started_with_model").ToString & "-  Total Aircraft Upgrades Found' noWrap align='right'>" & vbCrLf
                            htmlOutput = htmlOutput & "&nbsp;<font size='-1'>" & rs("ac12_started_with_total_upgrades").ToString & vbCrLf
                            htmlOutput = htmlOutput & "</font></TD>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD class='beige3' title='" & rs("ac12_started_with_make").ToString & " " & rs("ac12_started_with_model").ToString & "- Total Aircraft Upgrades To Model Found' noWrap align='right'>" & vbCrLf
                            htmlOutput = htmlOutput & "&nbsp;<font size='-1'>" & rs("ac12_started_with_total_upgrades_to_model").ToString & vbCrLf
                            htmlOutput = htmlOutput & "</font></TD>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD class='beige4' title='" & rs("ac12_started_with_make").ToString & " " & rs("ac12_started_with_model").ToString & "- Percentange Of Upgrades To Model' noWrap align='right'>" & vbCrLf
                            htmlOutput = htmlOutput & "&nbsp;<font size='-1'>" & rs("ac12_started_with_percentage_with_upgrade").ToString & "%" & vbCrLf
                            htmlOutput = htmlOutput & "</font></TD>" & vbCrLf
                            htmlOutput = htmlOutput & "</TR>" & vbCrLf

                        End If

                    End If


                Loop
                'Else
                'htmlOutput = htmlOutput & "<tr><td colspan='10' align='center'>No data available for the modelAverage Age of Fleet  you have selected</td></tr>"
                ' End If
                If bolAll = True Then

                    htmlOutput = htmlOutput & "</table>"
                    htmlOutput = htmlOutput & "<table cellspacing='0' cellpadding='2' align='center' width='600' border='1'>" & vbCrLf
                    htmlOutput = htmlOutput & "<tr>" & vbCrLf
                Else
                    htmlOutput = htmlOutput & "</table>"
                End If

                'Response.Write(htmlOutput)
                rs.Close()
            Else
                htmlOutput = "No data available for the model you have selected</TR><TR>"
                'response.write(htmlOutput)
                'Return htmlOutput
            End If
            displayAircraft_to_and_from_path = displayAircraft_to_and_from_path & "<table cellspacing='0' cellpadding='2' align='center' width='600' border='1'><tr>&nbsp;</tr><tr>" & htmlOutput
            rs = Nothing
        Catch ex As Exception
        Finally
            SqlCommand2.Dispose()
            SqlConn2.Close()
            SqlConn2.Dispose()
        End Try
    End Function
    Function NEW_displayAircraft_to_and_from_path(ByVal aMaxDate As Date, ByVal amod_id As Integer, Optional ByVal viewHeader As Boolean = False, Optional ByRef graph19 As String = "", Optional ByRef graph21 As String = "") As String

        NEW_displayAircraft_to_and_from_path = ""
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn2 As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand2 As New System.Data.SqlClient.SqlCommand
        Dim adoRs As System.Data.SqlClient.SqlDataReader : adoRs = Nothing
        Dim Query As String : Query = ""
        Dim htmlOutput As String = ""
        Dim ac5_make As String = ""
        Dim ac5_model As String = ""
        Dim bolnoData As Boolean
        Dim rs As System.Data.SqlClient.SqlDataReader : rs = Nothing
        '    Dim bolAll As Boolean
        Dim ac12_make As String = ""
        Dim ac12_model As String = ""
        Dim bolfirstRun As Boolean
        Dim first_time As Integer = 1
        Dim upgradeText As String = ""

        Try

            SqlConn2.ConnectionString = Session.Item("localPreferences").STARDatabaseConn
            SqlConn2.Open()

            SqlCommand2.Connection = SqlConn2
            SqlCommand2.CommandType = System.Data.CommandType.Text
            SqlCommand2.CommandTimeout = 60

            Query = "SELECT ac5_make, ac5_model, ac5_total_sold, ac5_total_upgrades, ac5_percentage_with_upgrade, "
            Query = Query & "ac5_upgrade_to_make, ac5_upgrade_to_model, ac5_upgrade_to_total_upgrades, "
            Query = Query & "ac5_upgrade_to_percentage_with_upgrade, ac5_upgrade_to_aircraft_for_sale, "
            Query = Query & "ac5_upgrade_to_percentage_for_sale "
            Query = Query & "FROM dbo.Aircraft_5 "
            Query = Query & "WHERE (ac5_amod_id = '" + amod_id.ToString + "') AND (ac5_start_date = '" & aMaxDate & "')"

            SqlCommand2.CommandText = Query
            rs = SqlCommand2.ExecuteReader()





            If Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                htmlOutput = htmlOutput & "<tr class=""noBorder""><td align=""center"" colspan=""10"" class=""Box removeTopPadding noBorder"">upgradeTextReplace</td></tr><tr><td align='center' colspan='10' valign=""top"" class=""Box removeTopPadding""><table cellspacing='0' cellpadding='6' border=""0"" class=""formatTable large " & table_color & """ width='100%'><tr><td valign=""top"">"
            Else
                htmlOutput = htmlOutput & "<tr><td align='center' colspan='10' class=""Box"">"
            End If

            If viewHeader = False Then
                htmlOutput = htmlOutput & "<table cellspacing='0' cellpadding='6' bordercolor='lightgrey'  align='center' border='1' width='100%'><tr>"
            Else
                htmlOutput = htmlOutput & "<table cellspacing='0' cellpadding='6' border=""0"" class=""formatTable large " & table_color & """ width='100%'>"
            End If



            ' check for an empty record set
            ' this report can generate an empty record set
            If (rs.HasRows) Then


                Do While rs.Read

                    If first_time = 1 Then
                        first_time = 2
                        ac5_make = rs("ac5_make").ToString
                        ac5_model = rs("ac5_model").ToString


                        ' htmlOutput = htmlOutput & "</tr>" & vbCrLf
                        htmlOutput = htmlOutput & "<TR class=""noBorder"" valign='bottom'>" & vbCrLf
                        If viewHeader = True Then
                            upgradeText = "<font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & " gray remove_margin'>Based on " & rs("ac5_total_upgrades").ToString & " " & ac5_make & " " & ac5_model & " retail owners (" & rs("ac5_percentage_with_upgrade").ToString & "%" & ") who purchased another aircraft after they sold their " & ac5_make & " " & ac5_model & "."
                            htmlOutput = Replace(htmlOutput, "upgradeTextReplace", upgradeText)
                            ' htmlOutput = htmlOutput & "<TH class='beige' align='middle' colSpan='9'></TH>" & vbCrLf
                        Else
                            htmlOutput = htmlOutput & "<TH class='beige' align='middle' colSpan='3'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>AN OWNER OF " & ac5_make & " " & ac5_model & "</TH>" & vbCrLf
                            htmlOutput = htmlOutput & "<TH class='beige' align='middle' colSpan='6'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>WILL MOST LIKELY BUY</TH>" & vbCrLf
                        End If

                        htmlOutput = htmlOutput & "</TR>" & vbCrLf
                        If viewHeader = False Then
                            htmlOutput = htmlOutput & "<TR>" & vbCrLf
                            'htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap colSpan='2'>STARTED WITH</TH>" & vbCrLf
                            htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap rowSpan='2'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>TOTAL<BR>SOLD</TH>" & vbCrLf
                            htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap rowSpan='2'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>TOTAL<BR>UPGRADES</TH>" & vbCrLf
                            htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap rowSpan='2'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>PERCENT<BR>WITH<BR>UPGRADE<BR>PATH</TH>" & vbCrLf
                            htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap colSpan='2'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>UPGRADED TO</TH>" & vbCrLf
                            htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap colSpan='2'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>UPGRADES</TH>" & vbCrLf
                            htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap colSpan='2'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>FOR SALE</TH>" & vbCrLf
                            htmlOutput = htmlOutput & "</TR>" & vbCrLf
                        End If

                        htmlOutput = htmlOutput & "<TR>" & vbCrLf
                        If viewHeader = False Then
                            htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>MAKE</TH>" & vbCrLf
                            htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>MODEL</TH>" & vbCrLf
                            htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>TOTAL</TH>" & vbCrLf
                            htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>PERCENT</TH>" & vbCrLf
                            htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>TOTAL</TH>" & vbCrLf
                            htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>PERCENT</TH>" & vbCrLf
                        Else
                            htmlOutput = htmlOutput & "<TH class='th_title_details' align=""left""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>MODELS</TH>" & vbCrLf
                            htmlOutput = htmlOutput & "<TH class='th_title_details right' align=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>TOTAL PURCHASES</TH>" & vbCrLf
                            htmlOutput = htmlOutput & "<TH class='th_title_details right' align=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>AVAILABLE FOR SALE</TH>" & vbCrLf
                        End If
                        htmlOutput = htmlOutput & "</TR>" & vbCrLf
                        htmlOutput = htmlOutput & "<TR>" & vbCrLf
                        ' htmlOutput = htmlOutput & "<TH class='beige' title='Make' noWrap align='left' rowSpan='5'>&nbsp;" & ac5_make & "</TH>" & vbCrLf
                        ' htmlOutput = htmlOutput & "<TH class='beige2' title='Model' noWrap align='center' rowSpan='5'>&nbsp;" & ac5_model & "</TH>" & vbCrLf
                        If viewHeader = False Then
                            htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac5_make & " " & ac5_model & "- Total Number Of Sold Reports' noWrap align='right' rowSpan='5'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'><font size='-1'>" & vbCrLf
                            htmlOutput = htmlOutput & rs("ac5_total_sold").ToString & vbCrLf
                            htmlOutput = htmlOutput & "</font></TD>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac5_make & " " & ac5_model & "- Total Number Of Upgrades Found' noWrap align='right' rowSpan='5'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'><font size='-1'>" & vbCrLf
                            htmlOutput = htmlOutput & rs("ac5_total_upgrades").ToString & vbCrLf
                            htmlOutput = htmlOutput & "</font></TD>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac5_make & " " & ac5_model & " - Percentage Of Sold Reports With An Upgrade Path' noWrap align='right' rowSpan='5'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'><font size='-1'>" & vbCrLf

                            ' check to see if there is no data for for the percentage with upgrade
                            ' if = 0 then set the htmlOuptut to 0 if not set the value


                            If rs("ac5_percentage_with_upgrade") = 0 Then
                                htmlOutput = htmlOutput & "N/A" & vbCrLf
                                bolnoData = True
                            Else
                                htmlOutput = htmlOutput & rs("ac5_percentage_with_upgrade").ToString & "%" & vbCrLf
                                bolnoData = False
                            End If
                            htmlOutput = htmlOutput & "</font></TD>" & vbCrLf
                        End If
                    End If


                    ' check and see if the boolean for noData is true
                    ' if true we set the left field to No Aircraft Upgrades Found if not run the loop and build the output
                    If bolnoData = True Then

                        htmlOutput = htmlOutput & "<TD class='lightgrey' title='" & ac5_make & " " & rs("ac5_model").ToString & "Percentage Of Sold Reports With An Upgrade Path' noWrap align='middle' colSpan='6'>" & vbCrLf
                        htmlOutput = htmlOutput & "No Aircraft Upgrades Found" & vbCrLf
                        htmlOutput = htmlOutput & "</TD>" & vbCrLf

                        Exit Do

                    Else

                        If viewHeader = False Then
                            htmlOutput = htmlOutput & "<TD class='lightcyan' title='" & rs("ac5_upgrade_to_make").ToString & " " & rs("ac5_upgrade_to_model").ToString & "- Upgraded To Make' noWrap align='left'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf
                            htmlOutput = htmlOutput & "&nbsp;<font size='-1'>" & rs("ac5_upgrade_to_make").ToString & vbCrLf
                            htmlOutput = htmlOutput & "</font></TD>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD class='lightcyan' title='" & rs("ac5_upgrade_to_make").ToString & " " & rs("ac5_upgrade_to_model").ToString & "- Upgraded To Model' noWrap align='center'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf
                            htmlOutput = htmlOutput & "&nbsp;<font size='-1'>" & rs("ac5_upgrade_to_model").ToString & vbCrLf
                            htmlOutput = htmlOutput & "</font></TD>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD class='beige3' title='" & rs("ac5_upgrade_to_make").ToString & " " & rs("ac5_upgrade_to_model").ToString & "- Total Upgrades Found Per Model' noWrap align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf
                            htmlOutput = htmlOutput & "&nbsp;<font size='-1'>" & rs("ac5_upgrade_to_total_upgrades").ToString & vbCrLf
                            htmlOutput = htmlOutput & "</font></TD>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD class='beige3' title='" & rs("ac5_upgrade_to_make").ToString & " " & rs("ac5_upgrade_to_model").ToString & "- Percentage Of Upgrades vs Sold Reports Found' noWrap align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf
                            htmlOutput = htmlOutput & "&nbsp;<font size='-1'>" & rs("ac5_upgrade_to_percentage_with_upgrade").ToString & "%" & vbCrLf
                            htmlOutput = htmlOutput & "</font></TD>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD class='beige4' title='" & rs("ac5_upgrade_to_make").ToString & " " & rs("ac5_upgrade_to_model").ToString & "- Total Number For Sale' noWrap align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf
                            htmlOutput = htmlOutput & "&nbsp;<font size='-1'>" & rs("ac5_upgrade_to_aircraft_for_sale").ToString & vbCrLf
                            htmlOutput = htmlOutput & "</font></TD>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD class='beige4' title='" & rs("ac5_upgrade_to_make").ToString & " " & rs("ac5_upgrade_to_model").ToString & "- Total Number For Sale' noWrap align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf
                            htmlOutput = htmlOutput & "&nbsp;<font size='-1'>" & rs("ac5_upgrade_to_percentage_for_sale").ToString & "%" & vbCrLf
                            htmlOutput = htmlOutput & "</font></TD>" & vbCrLf
                        Else
                            htmlOutput = htmlOutput & "<TD class='lightcyan' title='" & rs("ac5_upgrade_to_make").ToString & " " & rs("ac5_upgrade_to_model").ToString & "- Upgraded To Make' noWrap align='left'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf
                            htmlOutput = htmlOutput & "" & rs("ac5_upgrade_to_make").ToString & vbCrLf
                            htmlOutput = htmlOutput & "&nbsp;" & rs("ac5_upgrade_to_model").ToString & vbCrLf
                            htmlOutput = htmlOutput & "</TD>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD class='beige3' title='" & rs("ac5_upgrade_to_make").ToString & " " & rs("ac5_upgrade_to_model").ToString & "- Total Upgrades Found Per Model' noWrap align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf
                            htmlOutput = htmlOutput & "" & rs("ac5_upgrade_to_total_upgrades").ToString & vbCrLf
                            ' htmlOutput = htmlOutput & "</font></TD>" & vbCrLf
                            'htmlOutput = htmlOutput & "<TD class='beige3' title='" & rs("ac5_upgrade_to_make").ToString & " " & rs("ac5_upgrade_to_model").ToString & "- Percentage Of Upgrades vs Sold Reports Found' noWrap align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf
                            htmlOutput = htmlOutput & "&nbsp;(" & rs("ac5_upgrade_to_percentage_with_upgrade").ToString & "%)" & vbCrLf
                            htmlOutput = htmlOutput & "</font></TD>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD class='beige4' title='" & rs("ac5_upgrade_to_make").ToString & " " & rs("ac5_upgrade_to_model").ToString & "- Total Number For Sale' noWrap align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf
                            htmlOutput = htmlOutput & "" & rs("ac5_upgrade_to_aircraft_for_sale").ToString & vbCrLf
                            'htmlOutput = htmlOutput & "</font></TD>" & vbCrLf
                            'htmlOutput = htmlOutput & "<TD class='beige4' title='" & rs("ac5_upgrade_to_make").ToString & " " & rs("ac5_upgrade_to_model").ToString & "- Total Number For Sale' noWrap align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf
                            htmlOutput = htmlOutput & "&nbsp;(" & rs("ac5_upgrade_to_percentage_for_sale").ToString & "%)" & vbCrLf
                            htmlOutput = htmlOutput & "</TD>" & vbCrLf

                            If Trim(graph19) <> "" Then
                                graph19 &= ", "
                            End If

                            graph19 += "['" & (rs("ac5_upgrade_to_make").ToString & " " & rs("ac5_upgrade_to_model").ToString) & "'," & rs("ac5_upgrade_to_total_upgrades").ToString & "]"

                        End If

                        htmlOutput = htmlOutput & "</TR>" & vbCrLf

                    End If
                    'aewr()
                Loop
            Else
                htmlOutput = htmlOutput & "<tr><td colspan='10' align='center'>No data available for the model you have selected</td></tr>"
            End If
            ' If bolAll = True Then
            htmlOutput = htmlOutput & "</table>"

            htmlOutput = htmlOutput & "</td>"  '' this is for the row 



            If Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                htmlOutput = htmlOutput & "<td align='center' valign='bottom' class=""valueSpecWhite""  width=""420"">&nbsp;"
                htmlOutput = htmlOutput & "<img src='" & valueGraphText19.Text & "' width='100%' /></td></tr></table>"
            Else
                htmlOutput = htmlOutput & "<td align='center' valign='bottom' class=""valueSpecWhite"" colspan=""6"">&nbsp;"
            End If
            htmlOutput = htmlOutput & "</td></tr>" & vbCrLf

            htmlOutput = htmlOutput & "<tr><td align='center' colspan='8'>&nbsp;"
            htmlOutput = htmlOutput & "</td>" & vbCrLf
            htmlOutput = htmlOutput & "</TR>" & vbCrLf

            'End If
            NEW_displayAircraft_to_and_from_path = NEW_displayAircraft_to_and_from_path & htmlOutput
            'Response.Write(htmlOutput)
            rs.Close()
            ' Else
            htmlOutput = "No data available for the model you have selected</TR><TR>"
            ' Response.Write(htmlOutput)
            ' End If

            rs = Nothing
            first_time = 1

            Query = "SELECT ac12_started_with_make, ac12_started_with_model, ac12_started_with_total_upgrades, "
            Query = Query & "ac12_started_with_total_upgrades_to_model, ac12_started_with_percentage_with_upgrade, "
            Query = Query & "ac12_upgrade_to_make, ac12_upgrade_to_model, ac12_upgrade_to_total_upgrades, "
            Query = Query & "ac12_upgrade_to_aircraft_for_sale, ac12_upgrade_to_percentage_for_sale "
            Query = Query & "FROM Aircraft_12 WITH(NOLOCK)"
            Query = Query & "WHERE (ac12_upgrade_to_amod_id  = '" + amod_id.ToString + "') AND (ac12_start_date = '" & aMaxDate & "')"
            SqlCommand2.CommandText = Query
            rs = SqlCommand2.ExecuteReader()

            ' rs.Read()
            ' check for an empty record set
            ' this report can generate an empty record set
            If (rs.HasRows) Then



                ' check to see if there is no data for for the percentage with upgrade
                ' if = 0 then set the htmlOuptut to 0 if not set the value


                ' If rs.Read = True Then
                upgradeText = ""
                Do While rs.Read

                    If first_time = 1 Then
                        first_time = 2
                        ac12_make = rs("ac12_upgrade_to_make").ToString
                        ac12_model = rs("ac12_upgrade_to_model").ToString

                        If rs("ac12_started_with_total_upgrades") = 0 Then
                            bolnoData = True
                        Else
                            bolnoData = False
                        End If
                        'ac12_make = server.htmlencode(rs("ac12_upgrade_to_make") & "/")
                        'ac12_model = server.htmlencode(rs("ac12_upgrade_to_model") & " ")
                        htmlOutput = "<TR class=""noBorder"" valign='bottom'>" & vbCrLf
                        If viewHeader = True Then
                            upgradeText = "Based on " & rs("ac12_upgrade_to_total_upgrades").ToString & " " & ac12_make & " " & ac12_model & " retail buyers who previously owned another aircraft."
                            'htmlOutput = htmlOutput & "<TH class='beige' align='top' colSpan='5'>" & vbCrLf
                        Else

                            htmlOutput = htmlOutput & "<TH class='beige' align='middle' colSpan='5'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>OWNER(S) OF</TH>" & vbCrLf
                            htmlOutput = htmlOutput & "<TH class='beige' align='middle' colSpan='5'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>WILL MOST LIKELY BUY " & ac12_make & " " & ac12_model & "</TH>" & vbCrLf

                        End If
                        htmlOutput = htmlOutput & "</TR>" & vbCrLf


                        If viewHeader = False Then
                            htmlOutput = htmlOutput & "<TR>" & vbCrLf
                            htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap colSpan='2'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>STARTED WITH</TH>" & vbCrLf
                            htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap rowSpan='2'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>TOTAL<BR>UPGRADES</TH>" & vbCrLf
                            htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap rowSpan='2'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>TOTAL<BR>UPGRADES<BR>TO MODEL</TH>" & vbCrLf
                            htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap rowSpan='2'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>PERCENT<BR>WITH<BR>UPGRADE<BR>PATH</TH>" & vbCrLf
                            ' htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap colSpan='2'>UPGRADED TO</TH>" & vbCrLf
                            htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap rowSpan='2'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>TOTAL<BR>UPGRADES<BR>TO</TH>" & vbCrLf
                            htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap colSpan='2'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>FOR SALE</TH>" & vbCrLf
                            htmlOutput = htmlOutput & "</TR>" & vbCrLf

                            htmlOutput = htmlOutput & "<TR>" & vbCrLf
                            htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>MAKE</TH>" & vbCrLf
                            htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>MODEL</TH>" & vbCrLf
                            'htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap>MAKE</TH>" & vbCrLf
                            ' htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap>MODEL</TH>" & vbCrLf
                            htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>TOTAL</TH>" & vbCrLf
                            htmlOutput = htmlOutput & "<TH class='th_title_details' noWrap><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>PERCENT</TH>" & vbCrLf
                            htmlOutput = htmlOutput & "</TR>" & vbCrLf
                        Else
                            htmlOutput = htmlOutput & "<TR>" & vbCrLf
                            htmlOutput = htmlOutput & "<TH class='th_title_details left' noWrap><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>MODELS</TH>" & vbCrLf
                            htmlOutput = htmlOutput & "<TH class='th_title_details right' noWrap><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>TOTAL PURCHASES</TH>" & vbCrLf
                            htmlOutput = htmlOutput & "</TR>" & vbCrLf
                        End If

                    End If

                    ' check and see if the boolean for noData is true
                    ' if true we set the left field to No Aircraft Upgrades Found if not run the loop and build the output
                    If bolnoData = True Then

                        htmlOutput = htmlOutput & "<TD class='lightgrey' title='" & ac12_make & " " & rs("ac12_started_with_model").ToString & "' noWrap align='middle' colSpan='5'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>" & vbCrLf
                        htmlOutput = htmlOutput & "No Aircraft Upgrades Found" & vbCrLf
                        htmlOutput = htmlOutput & "</TD>" & vbCrLf
                        htmlOutput = htmlOutput & "<TH class='lightcyan' title='" & ac12_make & " " & ac12_model & "- Make Upgraded To' noWrap align='left' rowSpan='5'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>" & vbCrLf
                        htmlOutput = htmlOutput & ac12_make & vbCrLf
                        If viewHeader = False Then
                            htmlOutput = htmlOutput & "</TH>" & vbCrLf
                            htmlOutput = htmlOutput & "<TH class='beige2' title='" & ac12_make & " " & ac12_model & "- Model Upgraded To' noWrap align='center' rowSpan='5'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>" & vbCrLf

                            htmlOutput = htmlOutput & ac12_model & vbCrLf
                            htmlOutput = htmlOutput & "</TH>" & vbCrLf

                            htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac12_make & " " & ac12_model & " - Total Upgrades To Found' noWrap align='right' rowSpan='5'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>" & vbCrLf
                            htmlOutput = htmlOutput & rs("ac12_upgrade_to_total_upgrades").ToString & vbCrLf
                            htmlOutput = htmlOutput & "</TD>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac12_make & " " & ac12_model & " - Total Active Fleet For Sale' noWrap align='right' rowSpan='5'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>" & vbCrLf
                            htmlOutput = htmlOutput & rs("ac12_upgrade_to_aircraft_for_sale").ToString & vbCrLf
                            htmlOutput = htmlOutput & "</TD>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac12_make & " " & ac12_model & " - Percentange Of Active Fleet For Sale' noWrap align='right' rowSpan='5'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>" & vbCrLf
                            htmlOutput = htmlOutput & rs("ac12_upgrade_to_percentage_for_sale").ToString & "%" & vbCrLf
                            htmlOutput = htmlOutput & "</TD>" & vbCrLf

                        Else
                            htmlOutput = htmlOutput & ac12_model & vbCrLf
                            htmlOutput = htmlOutput & "</TH>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac12_make & " " & ac12_model & " - Total Active Fleet For Sale' noWrap align='right' rowSpan='5'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>" & vbCrLf
                            htmlOutput = htmlOutput & rs("ac12_upgrade_to_aircraft_for_sale").ToString & vbCrLf
                            htmlOutput = htmlOutput & rs("ac12_upgrade_to_percentage_for_sale").ToString & "%" & vbCrLf
                            htmlOutput = htmlOutput & "</TD>" & vbCrLf
                        End If


                        htmlOutput = htmlOutput & "</TR>" & vbCrLf
                        Exit Do

                    Else
                        If bolfirstRun = False Then
                            bolfirstRun = True

                            htmlOutput = htmlOutput & "<TR>" & vbCrLf

                            If viewHeader = False Then
                                htmlOutput = htmlOutput & "<TD class='lightcyan' title='" & rs("ac12_started_with_make").ToString & " " & rs("ac12_started_with_model").ToString & "- Started With Make' noWrap align='left'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf
                                htmlOutput = htmlOutput & "&nbsp;<font size='-1'>" & rs("ac12_started_with_make").ToString & vbCrLf
                                htmlOutput = htmlOutput & "</TD>" & vbCrLf
                                htmlOutput = htmlOutput & "<TD class='beige2' title='" & rs("ac12_started_with_make").ToString & " " & rs("ac12_started_with_model").ToString & "- Started With Model' noWrap align='center'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf
                                htmlOutput = htmlOutput & "&nbsp;<font size='-1'>" & rs("ac12_started_with_model").ToString & vbCrLf
                                htmlOutput = htmlOutput & "</TD>" & vbCrLf

                                htmlOutput = htmlOutput & "<TD class='beige3' title='" & rs("ac12_started_with_make").ToString & " " & rs("ac12_started_with_model").ToString & "-  Total Aircraft Upgrades Found' noWrap align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf
                                htmlOutput = htmlOutput & "&nbsp;<font size='-1'>" & rs("ac12_started_with_total_upgrades").ToString & vbCrLf
                                htmlOutput = htmlOutput & "</TD>" & vbCrLf
                                htmlOutput = htmlOutput & "<TD class='beige3' title='" & rs("ac12_started_with_make").ToString & " " & rs("ac12_started_with_model").ToString & "- Total Aircraft Upgrades To Model Found' noWrap align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf
                                htmlOutput = htmlOutput & "&nbsp;<font size='-1'>" & rs("ac12_started_with_total_upgrades_to_model").ToString & vbCrLf
                                htmlOutput = htmlOutput & "</TD>" & vbCrLf
                                htmlOutput = htmlOutput & "<TD class='beige4' title='" & rs("ac12_started_with_make").ToString & " " & rs("ac12_started_with_model").ToString & "- Percentange Of Upgrades To Model' noWrap align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf
                                htmlOutput = htmlOutput & "&nbsp;<font size='-1'>" & rs("ac12_started_with_percentage_with_upgrade").ToString & "%" & vbCrLf
                                htmlOutput = htmlOutput & "</TD>" & vbCrLf

                                htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac12_make & " " & ac12_model & " - Total Upgrades To Found' noWrap align='right' rowSpan='5'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & vbCrLf
                                htmlOutput = htmlOutput & rs("ac12_upgrade_to_total_upgrades").ToString & vbCrLf
                                htmlOutput = htmlOutput & "</TD>" & vbCrLf
                                htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac12_make & " " & ac12_model & " - Total Active Fleet For Sale' noWrap align='right' rowSpan='5'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & vbCrLf
                                htmlOutput = htmlOutput & rs("ac12_upgrade_to_aircraft_for_sale").ToString & vbCrLf
                                htmlOutput = htmlOutput & "</TD>" & vbCrLf
                                htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac12_make & " " & ac12_model & " - Percentange Of Active Fleet For Sale' noWrap align='right' rowSpan='5'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & vbCrLf
                                htmlOutput = htmlOutput & rs("ac12_upgrade_to_percentage_for_sale").ToString & "%" & vbCrLf
                                htmlOutput = htmlOutput & "</TD>" & vbCrLf
                            Else
                                htmlOutput = htmlOutput & "<TD class='lightcyan' title='" & rs("ac12_started_with_make").ToString & " " & rs("ac12_started_with_model").ToString & "- Started With Make' noWrap align='left'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf
                                htmlOutput = htmlOutput & "" & rs("ac12_started_with_make").ToString & vbCrLf
                                htmlOutput = htmlOutput & "&nbsp;" & rs("ac12_started_with_model").ToString & vbCrLf
                                htmlOutput = htmlOutput & "</TD>" & vbCrLf

                                If Trim(graph21) <> "" Then
                                    graph21 &= ", "
                                End If

                                graph21 += "['" & (rs("ac12_started_with_make").ToString & " " & rs("ac12_started_with_model").ToString) & "'," & rs("ac12_started_with_total_upgrades_to_model").ToString & " ]"

                                htmlOutput = htmlOutput & "<TD class='beige3' title='" & rs("ac12_started_with_make").ToString & " " & rs("ac12_started_with_model").ToString & "- Total Aircraft Upgrades To Model Found' noWrap align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf
                                htmlOutput = htmlOutput & "" & rs("ac12_started_with_total_upgrades_to_model").ToString & vbCrLf
                                htmlOutput = htmlOutput & "&nbsp;(" & rs("ac12_started_with_percentage_with_upgrade").ToString & "%)" & vbCrLf
                                htmlOutput = htmlOutput & "</TD>" & vbCrLf
                            End If


                            htmlOutput = htmlOutput & "</TR>" & vbCrLf

                        Else

                            If viewHeader = False Then
                                htmlOutput = htmlOutput & "<TR>" & vbCrLf
                                htmlOutput = htmlOutput & "<TD class='lightcyan' title='" & rs("ac12_started_with_make").ToString & " " & rs("ac12_started_with_model").ToString & "- Started With Make' noWrap align='left'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf
                                htmlOutput = htmlOutput & "&nbsp;<font size='-1'>" & rs("ac12_started_with_make").ToString & vbCrLf
                                htmlOutput = htmlOutput & "</font></TD>" & vbCrLf
                                htmlOutput = htmlOutput & "<TD class='beige2' title='" & rs("ac12_started_with_make").ToString & " " & rs("ac12_started_with_model").ToString & "- Started With Model' noWrap align='center'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf
                                htmlOutput = htmlOutput & "&nbsp;<font size='-1'>" & rs("ac12_started_with_model").ToString & vbCrLf
                                htmlOutput = htmlOutput & "</font></TD>" & vbCrLf
                                htmlOutput = htmlOutput & "<TD class='beige3' title='" & rs("ac12_started_with_make").ToString & " " & rs("ac12_started_with_model").ToString & "-  Total Aircraft Upgrades Found' noWrap align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf
                                htmlOutput = htmlOutput & "&nbsp;<font size='-1'>" & rs("ac12_started_with_total_upgrades").ToString & vbCrLf
                                htmlOutput = htmlOutput & "</font></TD>" & vbCrLf
                                htmlOutput = htmlOutput & "<TD class='beige3' title='" & rs("ac12_started_with_make").ToString & " " & rs("ac12_started_with_model").ToString & "- Total Aircraft Upgrades To Model Found' noWrap align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf
                                htmlOutput = htmlOutput & "&nbsp;<font size='-1'>" & rs("ac12_started_with_total_upgrades_to_model").ToString & vbCrLf
                                htmlOutput = htmlOutput & "</font></TD>" & vbCrLf
                                htmlOutput = htmlOutput & "<TD class='beige4' title='" & rs("ac12_started_with_make").ToString & " " & rs("ac12_started_with_model").ToString & "- Percentange Of Upgrades To Model' noWrap align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf
                                htmlOutput = htmlOutput & "&nbsp;<font size='-1'>" & rs("ac12_started_with_percentage_with_upgrade").ToString & "%" & vbCrLf
                                htmlOutput = htmlOutput & "</font></TD>" & vbCrLf
                                htmlOutput = htmlOutput & "</TR>" & vbCrLf
                            Else
                                htmlOutput = htmlOutput & "<TR>" & vbCrLf
                                htmlOutput = htmlOutput & "<TD class='lightcyan' title='" & rs("ac12_started_with_make").ToString & " " & rs("ac12_started_with_model").ToString & "- Started With Make' noWrap align='left'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf
                                htmlOutput = htmlOutput & "" & rs("ac12_started_with_make").ToString & vbCrLf
                                htmlOutput = htmlOutput & "&nbsp;" & rs("ac12_started_with_model").ToString & vbCrLf
                                htmlOutput = htmlOutput & "</TD>" & vbCrLf
                                htmlOutput = htmlOutput & "<TD class='beige3' title='" & rs("ac12_started_with_make").ToString & " " & rs("ac12_started_with_model").ToString & "- Total Aircraft Upgrades To Model Found' noWrap align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf
                                htmlOutput = htmlOutput & "" & rs("ac12_started_with_total_upgrades_to_model").ToString & vbCrLf
                                htmlOutput = htmlOutput & "&nbsp;(" & rs("ac12_started_with_percentage_with_upgrade").ToString & "%)" & vbCrLf
                                htmlOutput = htmlOutput & "</TD>" & vbCrLf
                                htmlOutput = htmlOutput & "</TR>" & vbCrLf

                                If Trim(graph21) <> "" Then
                                    graph21 &= ", "
                                End If

                                graph21 += "['" & (rs("ac12_started_with_make").ToString & " " & rs("ac12_started_with_model").ToString) & "'," & rs("ac12_started_with_total_upgrades_to_model").ToString & " ]"


                            End If


                        End If

                    End If


                Loop

                htmlOutput = htmlOutput & "</td></tr></table>"
                htmlOutput = htmlOutput & "</td>"

                If Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                    htmlOutput = htmlOutput & "<td valign='top' class=""valueSpecWhite"" width=""420""><img src='" & valueGraphText21.Text & "'  width=""100%"" /></td>"
                End If

                htmlOutput = htmlOutput & "</TR>"


                graph19 = " data20.addColumn('string', 'Make/Model'); data20.addColumn('number', 'Purcahses'); data20.addRows([ " & graph19

                graph21 = " data21.addColumn('string', 'Make/Model'); data21.addColumn('number', 'Purcahses'); data21.addRows([ " & graph21



                'Response.Write(htmlOutput)
                rs.Close()
            Else
                htmlOutput = "No data available for the model you have selected</TR><TR>"
                'response.write(htmlOutput)
                'Return htmlOutput
            End If

            If Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then

                If viewHeader = True Then
                    NEW_displayAircraft_to_and_from_path += "<tr class=""noBorder""><td colspan=""10"" align=""center"" valign=""top"" class=""Box removeTopPadding noBorder"">"
                    If viewHeader = True Then
                        NEW_displayAircraft_to_and_from_path += "<font class='" & Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & real_make_model_name & "</strong> Buyers Most Likely Owned" & vbCrLf
                        NEW_displayAircraft_to_and_from_path += valueEmptyHeaderString & "</font>" & vbCrLf
                    Else
                        NEW_displayAircraft_to_and_from_path += "<font class='" & Session("FONT_CLASS_HEADER") & "'>Upgrade From Path by Model" & vbCrLf
                        NEW_displayAircraft_to_and_from_path += "<br>Based on End User Transactions" & vbCrLf
                        NEW_displayAircraft_to_and_from_path += "<br>" & ac12_make & " " & ac12_model & vbCrLf
                    End If
                    ' NEW_displayAircraft_to_and_from_path += "<br/>" & vbCrLf

                    NEW_displayAircraft_to_and_from_path += "<font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & " gray remove_margin'>" & upgradeText & "</td></tr>"
                Else

                    NEW_displayAircraft_to_and_from_path += "<tr><td align='center' colspan='8'><div class='Box'>"
                    If viewHeader = True Then
                        NEW_displayAircraft_to_and_from_path += "<font class='" & Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & real_make_model_name & "</strong> Buyers Most Likely Owned" & vbCrLf
                        NEW_displayAircraft_to_and_from_path += valueEmptyHeaderString & "</font>" & vbCrLf
                    Else
                        NEW_displayAircraft_to_and_from_path += "<font class='" & Session("FONT_CLASS_HEADER") & "'>Upgrade From Path by Model" & vbCrLf
                        NEW_displayAircraft_to_and_from_path += "<br>Based on End User Transactions" & vbCrLf
                        NEW_displayAircraft_to_and_from_path += "<br>" & ac12_make & " " & ac12_model & vbCrLf
                    End If
                    NEW_displayAircraft_to_and_from_path += "</div></td>" & vbCrLf
                    NEW_displayAircraft_to_and_from_path += "</TR>" & vbCrLf

                End If
                NEW_displayAircraft_to_and_from_path += "<tr><td colspan='10' class=""Box removeTopPadding"" valign=""top""><table cellspacing='0' cellpadding='6' border=""0"" class=""formatTable large " & table_color & """ width='100%'><tr><td valign=""top""><table cellspacing='0' cellpadding='6' " & IIf(viewHeader = False, "align='center' border='1' bordercolor='lightgrey' width='100%'", " class=""formatTable large " & table_color & """ width='100%'") & ">" & htmlOutput & "</table></td></tr>"
            Else


                htmlOutput = htmlOutput & "<tr><td align='center' colspan='8'><div class='Box'>"
                If viewHeader = True Then
                    htmlOutput = htmlOutput & "<font class='" & Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & real_make_model_name & "</strong> Buyers Most Likely Owned" & vbCrLf
                    htmlOutput = htmlOutput & valueEmptyHeaderString & "</font>" & vbCrLf
                Else
                    htmlOutput = htmlOutput & "<font class='" & Session("FONT_CLASS_HEADER") & "'>Upgrade From Path by Model" & vbCrLf
                    htmlOutput = htmlOutput & "<br>Based on End User Transactions" & vbCrLf
                    htmlOutput = htmlOutput & "<br>" & ac12_make & " " & ac12_model & vbCrLf
                End If
                htmlOutput = htmlOutput & "</div></td>" & vbCrLf
                htmlOutput = htmlOutput & "</TR>" & vbCrLf

                NEW_displayAircraft_to_and_from_path = NEW_displayAircraft_to_and_from_path & "<tr><td colspan='10' class=""Box"" valign=""top""><table cellspacing='0' cellpadding='6' " & IIf(viewHeader = False, "align='center' border='1' bordercolor='lightgrey' width='100%'", " class=""formatTable large " & table_color & """ width='50%'") & ">" & htmlOutput & "</td></tr>"
            End If

            rs = Nothing
        Catch ex As Exception
        Finally
            SqlCommand2.Dispose()
            SqlConn2.Close()
            SqlConn2.Dispose()
        End Try
    End Function

    Function Show_Average_Year(ByVal amod_id As Integer) As String

        Show_Average_Year = ""
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn3 As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand3 As New System.Data.SqlClient.SqlCommand
        Dim SqlCommand4 As New System.Data.SqlClient.SqlCommand
        Dim SqlConn4 As New System.Data.SqlClient.SqlConnection
        Dim adoRs As System.Data.SqlClient.SqlDataReader : adoRs = Nothing
        Dim Query As String : Query = ""
        Dim htmlOutput As String = ""
        Dim ac9_make As String = ""
        Dim ac9_model As String = ""
        Dim rs As System.Data.SqlClient.SqlDataReader : rs = Nothing
        Dim rs2 As System.Data.SqlClient.SqlDataReader : rs2 = Nothing
        Dim bolAll As Boolean
        Dim ac19_make As String = ""
        Dim ac19_model As String = ""
        Dim aMaxDate As Date
        Dim ac8_make As String = ""
        Dim ac8_model As String = ""
        Dim rcCount As Integer = 0
        Dim NewInfo As String = ""

        Try

            Try
                SqlConn3.ConnectionString = Session.Item("localPreferences").STARDatabaseConn
                SqlConn3.Open()

                SqlCommand3.Connection = SqlConn3
                SqlCommand3.CommandType = System.Data.CommandType.Text
                SqlCommand3.CommandTimeout = 60
            Catch Sqlex As SqlClient.SqlException
                Response.Write(Sqlex.Message)
            End Try

            Try
                SqlConn4.ConnectionString = Session.Item("localPreferences").STARDatabaseConn
                SqlConn4.Open()

                SqlCommand4.Connection = SqlConn4
                SqlCommand4.CommandType = System.Data.CommandType.Text
                SqlCommand4.CommandTimeout = 60
            Catch Sqlex As SqlClient.SqlException
                Response.Write(Sqlex.Message)
            End Try


            Query = "SELECT MAX(ac1_start_date) AS ac1_start_date FROM dbo.Aircraft_1 WHERE (ac1_amod_id = '" + amod_id.ToString + "')"
            SqlCommand3.CommandText = Query
            adoRs = SqlCommand3.ExecuteReader() 'aDBconn.execute(Query) '

            If (adoRs.HasRows) Then
                adoRs.Read()
                If Not IsDBNull(adoRs.Item("ac1_start_date")) Then
                    aMaxDate = FormatDateTime(adoRs.Item("ac1_start_date").ToString, DateFormat.ShortDate)
                End If
                adoRs.Close()
            Else
                aMaxDate = "that timeframe"
                adoRs.Close()
            End If


            Query = "SELECT ac9_make, ac9_model, ac9_total_fleet, ac9_aircraft_forsale, ac9_percentage_forsale, ac9_0_5_aircraft_in_operation, ac9_0_5_aircraft_forsale, "
            Query = Query & "ac9_0_5_percentage_forsale, ac9_6_10_aircraft_in_operation, ac9_6_10_aircraft_forsale, ac9_6_10_percentage_forsale, ac9_11_15_aircraft_in_operation, "
            Query = Query & "ac9_11_15_aircraft_forsale, ac9_11_15_percentage_forsale, ac9_16_20_aircraft_in_operation, ac9_16_20_aircraft_forsale, ac9_16_20_percentage_forsale, "
            Query = Query & "ac9_21_25_aircraft_in_operation, ac9_21_25_aircraft_forsale, ac9_21_25_percentage_forsale, ac9_26_30_aircraft_in_operation, ac9_26_30_aircraft_forsale, "
            Query = Query & "ac9_26_30_percentage_forsale, ac9_30_plus_aircraft_in_operation, ac9_30_plus_aircraft_forsale, ac9_30_plus_percentage_forsale, ac9_average_year "
            Query = Query & "FROM Aircraft_9 WITH(NOLOCK)"
            Query = Query & "WHERE (ac9_amod_id = '" + amod_id.ToString + "') AND (ac9_start_date = '" & aMaxDate & "')"


            SqlCommand3.CommandText = Query
            rs = SqlCommand3.ExecuteReader()

            rs.Read()
            ' check for an empty record set
            ' this report can generate an empty record set
            If (rs.HasRows) Then

                ac9_make = rs("ac9_make").ToString
                ac9_model = rs("ac9_model").ToString
            End If

            '------------------------------------------- INFO FOR NEW HERE----------------

            Query = "SELECT ac8_make, ac8_model, ac8_total_fleet, ac8_aircraft_forsale, ac8_percentage_forsale, ac8_0_5_aircraft_in_operation, ac8_0_5_aircraft_forsale, "
            Query = Query & "ac8_0_5_percentage_forsale, ac8_6_10_aircraft_in_operation, ac8_6_10_aircraft_forsale, ac8_6_10_percentage_forsale, ac8_11_15_aircraft_in_operation, "
            Query = Query & "ac8_11_15_aircraft_forsale, ac8_11_15_percentage_forsale, ac8_16_20_aircraft_in_operation, ac8_16_20_aircraft_forsale, ac8_16_20_percentage_forsale, "
            Query = Query & "ac8_21_25_aircraft_in_operation, ac8_21_25_aircraft_forsale, ac8_21_25_percentage_forsale, ac8_26_30_aircraft_in_operation, ac8_26_30_aircraft_forsale, "
            Query = Query & "ac8_26_30_percentage_forsale, ac8_30_plus_aircraft_in_operation, ac8_30_plus_aircraft_forsale, ac8_30_plus_percentage_forsale, ac8_average_year "
            Query = Query & "FROM  dbo.Aircraft_8 "
            Query = Query & "WHERE (ac8_amod_id = '" + amod_id.ToString + "') AND (ac8_start_date = '" & aMaxDate & "')"


            SqlCommand4.CommandText = Query
            rs2 = SqlCommand4.ExecuteReader()

            rs2.Read()


            ' check for an empty record set
            ' this report can generate an empty record set
            If (rs2.HasRows) Then


                ac8_make = rs2("ac8_make").ToString
                ac8_model = rs2("ac8_model").ToString
            End If

            htmlOutput = htmlOutput & "<table align='center'><tr><td><strong><br>" & ac8_make & " " & ac8_model & " Average Age of Fleet ( In Operation Aircraft )<br></strong></td></tr></table>"

            If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                htmlOutput = htmlOutput & "<table border='1' cellspacing='0' cellpadding='3' align='center'>"
            Else
                htmlOutput = htmlOutput & "<table border='1px' cellspacing='0' cellpadding='3' align='center'>"
            End If



            'htmlOutput = htmlOutput & "<tr>"
            'htmlOutput = htmlOutput & "<th class='th_title' align='center'  colspan='9'>Average Age of Fleet for " & ac8_make & " " & ac8_model
            'htmlOutput = htmlOutput & "<BR> WHOLLY OWNED AIRCRAFT" & vbCrLf
            'htmlOutput = htmlOutput & "</th>" & vbCrLf
            ''htmlOutput = htmlOutput & "<th class='th_title' align='center' colSpan='36'>&nbsp;</th>"
            'htmlOutput = htmlOutput & "</TR>" & vbCrLf


            ' HERE WILL BE ACTIVE STUFF
            htmlOutput = htmlOutput & "<TR>" & vbCrLf
            'htmlOutput = htmlOutput & "<td><table><tr>" & vbCrLf
            'htmlOutput = htmlOutput & "<TH class='separateheader'>&nbsp;</TH>" & vbCrLf.
            htmlOutput = htmlOutput & "<TH  class='th_title_details' align='center' colspan='3'>&nbsp;&nbsp;</TH>" & vbCrLf
            htmlOutput = htmlOutput & "<TH  class='th_title_details' align='center' colspan='3'>&nbsp;FACTORY NEW OWNED&nbsp;</TH2>" & vbCrLf
            htmlOutput = htmlOutput & "<Th  class='th_title_details' align='center' colspan='3'>&nbsp;PREVIOUSLY OWNED&nbsp;</TH></tr>" & vbCrLf





            htmlOutput = htmlOutput & "<tr><TH  class='th_title_details' align='center' colspan='3'>&nbsp;YEAR RANGES&nbsp;<br>&nbsp;</TH>" & vbCrLf
            htmlOutput = htmlOutput & "<TH  class='th_title_details' align='center' width='50'>ACTIVE<BR>FLEET</TH>" & vbCrLf
            htmlOutput = htmlOutput & "<TH  class='th_title_details' align='center' width='50'>FOR<BR>SALE</TH>" & vbCrLf
            htmlOutput = htmlOutput & "<TH  class='th_title_details' nowrap align='center' width='50'>% FOR<BR>SALE</TH>" & vbCrLf
            htmlOutput = htmlOutput & "<TH  class='th_title_details' align='center' width='50'>ACTIVE<BR>FLEET</TH>" & vbCrLf
            htmlOutput = htmlOutput & "<TH  class='th_title_details' align='center' width='50'>FOR<BR>SALE</TH>" & vbCrLf
            htmlOutput = htmlOutput & "<TH  class='th_title_details' nowrap align='center' width='50'>% FOR<BR>SALE</TH></tr>" & vbCrLf



            htmlOutput = htmlOutput & "<tr><TH  class='th_title_details' nowrap align='center' colspan='3'>TOTAL AIRCRAFT<BR>ALL YEARS</TH>" & vbCrLf
            If (rs2.HasRows) Then
                htmlOutput = htmlOutput & "<TD  class='mistyrose' title='" & ac8_make & " " & ac8_model & " - TOTAL AIRCRAFT ALL YEARS Total Active Fleet' align='right'><font size='-1'>" & rs2("ac8_total_fleet").ToString & "</TD>" & vbCrLf
                htmlOutput = htmlOutput & "<TD  class='mistyrose' title='" & ac8_make & " " & ac8_model & " - TOTAL AIRCRAFT ALL YEARS Total For Sale' align='right'><font size='-1'>" & rs2("ac8_aircraft_forsale").ToString & "</TD>" & vbCrLf
                htmlOutput = htmlOutput & "<TD  class='mistyrose' title='" & ac8_make & " " & ac8_model & " - TOTAL AIRCRAFT ALL YEARS Percentage For Sale' align='right'><font size='-1'>" & rs2("ac8_percentage_forsale").ToString & "%</TD>" & vbCrLf
            End If
            If (rs.HasRows) Then
                htmlOutput = htmlOutput & "<TD  class='mistyrose' title='" & ac9_make & " " & ac9_model & " - TOTAL AIRCRAFT ALL YEARS Total Active Fleet' align='right'><font size='-1'>" & rs("ac9_total_fleet").ToString & "</TD>" & vbCrLf
                htmlOutput = htmlOutput & "<TD  class='mistyrose' title='" & ac9_make & " " & ac9_model & " - TOTAL AIRCRAFT ALL YEARS Total For Sale' align='right'><font size='-1'>" & rs("ac9_aircraft_forsale").ToString & "</TD>" & vbCrLf
                htmlOutput = htmlOutput & "<TD  class='mistyrose' title='" & ac9_make & " " & ac9_model & " - TOTAL AIRCRAFT ALL YEARS Percentage For Sale' align='right'><font size='-1'>" & rs("ac9_percentage_forsale").ToString & "%</TD></tr>" & vbCrLf
                'htmlOutput = htmlOutput & "<TH class='separateheader'>&nbsp;</TH>" & vbCrLf
            End If





            htmlOutput = htmlOutput & "<tr><TH  class='th_title_details' nowrap align='center' colspan='3'>0 - 5 YEARS<BR>2009 to 2005</TH>" & vbCrLf
            If (rs2.HasRows) Then
                If rs2("ac8_0_5_aircraft_in_operation") = 0 And rs2("ac8_0_5_aircraft_forsale") = 0 And rs2("ac8_0_5_percentage_forsale") = 0 Then
                    htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                Else
                    htmlOutput = htmlOutput & "<TD  class='powderblue' title='" & ac8_make & " " & ac8_model & " - 0 - 5 YEARS 2009 to 2005 Total Active Fleet' align='right'><font size='-1'>" & rs2("ac8_0_5_aircraft_in_operation").ToString & "</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='powderblue' title='" & ac8_make & " " & ac8_model & " - 0 - 5 YEARS 2009 to 2005 Total For Sale' align='right'><font size='-1'>" & rs2("ac8_0_5_aircraft_forsale").ToString & "</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='powderblue' title='" & ac8_make & " " & ac8_model & " - 0 - 5 YEARS 2009 to 2005 Percentage For Sale' align='right'><font size='-1'>" & rs2("ac8_0_5_percentage_forsale").ToString & "%</TD>" & vbCrLf
                End If
            Else
                htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
            End If
            If (rs.HasRows) Then
                If rs("ac9_0_5_aircraft_in_operation") = 0 And rs("ac9_0_5_aircraft_forsale") = 0 And rs("ac9_0_5_percentage_forsale") = 0 Then
                    ' htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='3'>&nbsp;</TD>" & vbCrLf
                    ' htmlOutput = htmlOutput & "<TH class='separateheader'>&nbsp;</TH>" & vbCrLf
                    htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                    htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                    htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                Else
                    htmlOutput = htmlOutput & "<TD  class='powderblue' title='" & ac9_make & " " & ac9_model & " - 0 - 5 YEARS 2009 to 2005 Total Active Fleet' align='right'><font size='-1'>" & rs("ac9_0_5_aircraft_in_operation").ToString & "</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='powderblue' title='" & ac9_make & " " & ac9_model & " - 0 - 5 YEARS 2009 to 2005 Total For Sale' align='right'><font size='-1'>" & rs("ac9_0_5_aircraft_forsale").ToString & "</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='powderblue' title='" & ac9_make & " " & ac9_model & " - 0 - 5 YEARS 2009 to 2005 Percentage For Sale' align='right'><font size='-1'>" & rs("ac9_0_5_percentage_forsale").ToString & "%</TD>" & vbCrLf
                    'htmlOutput = htmlOutput & "<TH class='separateheader'>&nbsp;</TH>" & vbCrLf
                End If
            Else
                htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
            End If













            htmlOutput = htmlOutput & "</tr><tr><TH  class='th_title_details' nowrap align='center' colspan='3'>6 - 10 YEARS<BR>2004 to 2000</TH>" & vbCrLf
            If (rs2.HasRows) Then
                If rs2("ac8_6_10_aircraft_in_operation") = 0 And rs2("ac8_6_10_aircraft_forsale") = 0 And rs2("ac8_6_10_percentage_forsale") = 0 Then
                    htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                Else
                    htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac8_make & " " & ac8_model & " - 6 - 10 YEARS 2009 to 2005 Total Active Fleet' align='right'><font size='-1'>" & rs2("ac8_6_10_aircraft_in_operation").ToString & "</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac8_make & " " & ac8_model & " - 6 - 10 YEARS 2009 to 2005 Total For Sale' align='right'><font size='-1'>" & rs2("ac8_6_10_aircraft_forsale").ToString & "</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac8_make & " " & ac8_model & " - 6 - 10 YEARS 2009 to 2005 Percentage For Sale' align='right'><font size='-1'>" & rs2("ac8_6_10_percentage_forsale").ToString & "%</TD>" & vbCrLf
                End If
            Else
                htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
            End If


            If (rs.HasRows) Then
                If rs("ac9_6_10_aircraft_in_operation") = 0 And rs("ac9_6_10_aircraft_forsale") = 0 And rs("ac9_6_10_percentage_forsale") = 0 Then
                    'htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='3'>&nbsp;</TD>" & vbCrLf
                    ' htmlOutput = htmlOutput & "<TH class='separateheader'>&nbsp;</TH>" & vbCrLf
                    htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                    htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                    htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                Else
                    htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac9_make & " " & ac9_model & " - 6 - 10 YEARS 2009 to 2005 Total Active Fleet' align='right'><font size='-1'>" & rs("ac9_6_10_aircraft_in_operation").ToString & "</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac9_make & " " & ac9_model & " - 6 - 10 YEARS 2009 to 2005 Total For Sale' align='right'><font size='-1'>" & rs("ac9_6_10_aircraft_forsale").ToString & "</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac9_make & " " & ac9_model & " - 6 - 10 YEARS 2009 to 2005 Percentage For Sale' align='right'><font size='-1'>" & rs("ac9_6_10_percentage_forsale").ToString & "%</TD>" & vbCrLf
                    ' htmlOutput = htmlOutput & "<TH class='separateheader'>&nbsp;</TH>" & vbCrLf
                End If
            Else
                htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
            End If







            htmlOutput = htmlOutput & "</tr><tr><TH  class='th_title_details' nowrap align='center' colspan='3'>11 - 15 YEARS<BR>1999 to 1995</TH>" & vbCrLf
            If (rs2.HasRows) Then
                If rs2("ac8_11_15_aircraft_in_operation") = 0 And rs2("ac8_11_15_aircraft_forsale") = 0 And rs2("ac8_11_15_percentage_forsale") = 0 Then
                    htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf

                Else
                    htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac8_make & " " & ac8_model & " - 11 - 15 YEARS 2009 to 2005 Total Active Fleet' align='right'><font size='-1'>" & rs2("ac8_11_15_aircraft_in_operation").ToString & "</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac8_make & " " & ac8_model & " - 11 - 15 YEARS 2009 to 2005 Total For Sale' align='right'><font size='-1'>" & rs2("ac8_11_15_aircraft_forsale").ToString & "</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac8_make & " " & ac8_model & " - 11 - 15 YEARS 2009 to 2005 Percentage For Sale' align='right'><font size='-1'>" & rs2("ac8_11_15_percentage_forsale").ToString & "%</TD>" & vbCrLf
                End If
            Else
                htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
            End If
            If (rs.HasRows) Then
                If rs("ac9_11_15_aircraft_in_operation") = 0 And rs("ac9_11_15_aircraft_forsale") = 0 And rs("ac9_11_15_percentage_forsale") = 0 Then
                    'htmlOutput = htmlOutput & "<TD class='blankline' align='right' colSpan='3'>&nbsp;</TD>" & vbCrLf
                    'htmlOutput = htmlOutput & "<TH class='separateheader'>&nbsp;</TH>" & vbCrLf
                    htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                    htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                    htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                Else
                    htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac9_make & " " & ac9_model & " - 11 - 15 YEARS 2009 to 2005 Total Active Fleet' align='right'><font size='-1'>" & rs("ac9_11_15_aircraft_in_operation").ToString & "</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac9_make & " " & ac9_model & " - 11 - 15 YEARS 2009 to 2005 Total For Sale' align='right'><font size='-1'>" & rs("ac9_11_15_aircraft_forsale").ToString & "</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac9_make & " " & ac9_model & " - 11 - 15 YEARS 2009 to 2005 Percentage For Sale' align='right'><font size='-1'>" & rs("ac9_11_15_percentage_forsale").ToString & "%</TD>" & vbCrLf
                    ' htmlOutput = htmlOutput & "<TH class='separateheader'>&nbsp;</TH>" & vbCrLf
                End If
            Else
                htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
            End If




            htmlOutput = htmlOutput & "</tr><tr><TH  class='th_title_details' nowrap align='center' colspan='3'>16 - 20 YEARS<BR>1994 to 1990</TH>" & vbCrLf
            If (rs2.HasRows) Then
                If rs2("ac8_16_20_aircraft_in_operation") = 0 And rs2("ac8_16_20_aircraft_forsale") = 0 And rs2("ac8_16_20_percentage_forsale") = 0 Then
                    htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf

                Else
                    htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac8_make & " " & ac8_model & " - 11 - 15 YEARS 2009 to 2005 Total Active Fleet' align='right'><font size='-1'>" & rs2("ac8_16_20_aircraft_in_operation").ToString & "</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac8_make & " " & ac8_model & " - 11 - 15 YEARS 2009 to 2005 Total For Sale' align='right'><font size='-1'>" & rs2("ac8_16_20_aircraft_forsale").ToString & "</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac8_make & " " & ac8_model & " - 11 - 15 YEARS 2009 to 2005 Percentage For Sale' align='right'><font size='-1'>" & rs2("ac8_16_20_percentage_forsale").ToString & "%</TD>" & vbCrLf
                End If
            Else
                htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
            End If
            If (rs.HasRows) Then
                If rs("ac9_16_20_aircraft_in_operation") = 0 And rs("ac9_16_20_aircraft_forsale") = 0 And rs("ac9_16_20_percentage_forsale") = 0 Then
                    'htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='3'>&nbsp;</TD>" & vbCrLf
                    ' htmlOutput = htmlOutput & "<TH class='separateheader'>&nbsp;</TH>" & vbCrLf
                    htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                    htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                    htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                Else
                    htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac9_make & " " & ac9_model & " - 11 - 15 YEARS 2009 to 2005 Total Active Fleet' align='right'><font size='-1'>" & rs("ac9_16_20_aircraft_in_operation").ToString & "</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac9_make & " " & ac9_model & " - 11 - 15 YEARS 2009 to 2005 Total For Sale' align='right'><font size='-1'>" & rs("ac9_16_20_aircraft_forsale").ToString & "</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac9_make & " " & ac9_model & " - 11 - 15 YEARS 2009 to 2005 Percentage For Sale' align='right'><font size='-1'>" & rs("ac9_16_20_percentage_forsale").ToString & "%</TD>" & vbCrLf
                    ' htmlOutput = htmlOutput & "<TH class='separateheader'>&nbsp;</TH>" & vbCrLf
                End If
            Else
                htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
            End If

            htmlOutput = htmlOutput & "</tr><tr><TH  class='th_title_details' nowrap align='center' colspan='3'>21 - 25 YEARS<BR>1989 to 1985</TH>" & vbCrLf
            If (rs2.HasRows) Then
                If rs2("ac8_21_25_aircraft_in_operation") = 0 And rs2("ac8_21_25_aircraft_forsale") = 0 And rs2("ac8_21_25_percentage_forsale") = 0 Then
                    htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf

                Else
                    htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac8_make & " " & ac8_model & " - 11 - 15 YEARS 2009 to 2005 Total Active Fleet' align='right'><font size='-1'>" & rs2("ac8_21_25_aircraft_in_operation").ToString & "</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac8_make & " " & ac8_model & " - 11 - 15 YEARS 2009 to 2005 Total For Sale' align='right'><font size='-1'>" & rs2("ac8_21_25_aircraft_forsale").ToString & "</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac8_make & " " & ac8_model & " - 11 - 15 YEARS 2009 to 2005 Percentage For Sale' align='right'><font size='-1'>" & rs2("ac8_21_25_percentage_forsale").ToString & "%</TD>" & vbCrLf
                End If
            Else
                htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
            End If
            If (rs.HasRows) Then
                If rs("ac9_21_25_aircraft_in_operation") = 0 And rs("ac9_21_25_aircraft_forsale") = 0 And rs("ac9_21_25_percentage_forsale") = 0 Then
                    'htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='3'>&nbsp;</TD>" & vbCrLf
                    ' htmlOutput = htmlOutput & "<TH class='separateheader'>&nbsp;</TH>" & vbCrLf
                    htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                    htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                    htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                Else
                    htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac9_make & " " & ac9_model & " - 11 - 15 YEARS 2009 to 2005 Total Active Fleet' align='right'><font size='-1'>" & rs("ac9_21_25_aircraft_in_operation").ToString & "</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac9_make & " " & ac9_model & " - 11 - 15 YEARS 2009 to 2005 Total For Sale' align='right'><font size='-1'>" & rs("ac9_21_25_aircraft_forsale").ToString & "</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac9_make & " " & ac9_model & " - 11 - 15 YEARS 2009 to 2005 Percentage For Sale' align='right'><font size='-1'>" & rs("ac9_21_25_percentage_forsale").ToString & "%</TD>" & vbCrLf
                    ' htmlOutput = htmlOutput & "<TH class='separateheader'>&nbsp;</TH>" & vbCrLf
                End If
            Else
                htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
            End If

            htmlOutput = htmlOutput & "</tr><tr><TH  class='th_title_details' nowrap align='center' colspan='3'>26 - 30 YEARS<BR>1984 to 1980</TH>" & vbCrLf
            If (rs2.HasRows) Then
                If rs2("ac8_26_30_aircraft_in_operation") = 0 And rs2("ac8_26_30_aircraft_forsale") = 0 And rs2("ac8_26_30_percentage_forsale") = 0 Then
                    htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf

                Else
                    htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac8_make & " " & ac8_model & " - 11 - 15 YEARS 2009 to 2005 Total Active Fleet' align='right'><font size='-1'>" & rs2("ac8_26_30_aircraft_in_operation").ToString & "</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac8_make & " " & ac8_model & " - 11 - 15 YEARS 2009 to 2005 Total For Sale' align='right'><font size='-1'>" & rs2("ac8_26_30_aircraft_forsale").ToString & "</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac8_make & " " & ac8_model & " - 11 - 15 YEARS 2009 to 2005 Percentage For Sale' align='right'><font size='-1'>" & rs2("ac8_26_30_percentage_forsale").ToString & "%</TD>" & vbCrLf
                End If
            Else
                htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
            End If
            If (rs.HasRows) Then
                If rs("ac9_26_30_aircraft_in_operation") = 0 And rs("ac9_26_30_aircraft_forsale") = 0 And rs("ac9_26_30_percentage_forsale") = 0 Then
                    'htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='3'>&nbsp;</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                    htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                    htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                Else
                    htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac9_make & " " & ac9_model & " - 11 - 15 YEARS 2009 to 2005 Total Active Fleet' align='right'><font size='-1'>" & rs("ac9_26_30_aircraft_in_operation").ToString & "</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac9_make & " " & ac9_model & " - 11 - 15 YEARS 2009 to 2005 Total For Sale' align='right'><font size='-1'>" & rs("ac9_26_30_aircraft_forsale").ToString & "</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac9_make & " " & ac9_model & " - 11 - 15 YEARS 2009 to 2005 Percentage For Sale' align='right'><font size='-1'>" & rs("ac9_26_30_percentage_forsale").ToString & "%</TD>" & vbCrLf
                    ' htmlOutput = htmlOutput & "<TH class='separateheader'>&nbsp;</TH>" & vbCrLf
                End If
            Else
                htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
            End If

            htmlOutput = htmlOutput & "</tr><tr><TH  class='th_title_details' nowrap align='center' colspan='3'>30 PLUS YEARS<BR>1979-BACK</TH>" & vbCrLf
            If (rs2.HasRows) Then
                If rs2("ac8_30_plus_aircraft_in_operation") = 0 And rs2("ac8_30_plus_aircraft_forsale") = 0 And rs2("ac8_30_plus_percentage_forsale") = 0 Then
                    htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf

                Else
                    htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac8_make & " " & ac8_model & " - 11 - 15 YEARS 2009 to 2005 Total Active Fleet' align='right'><font size='-1'>" & rs2("ac8_30_plus_aircraft_in_operation").ToString & "</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac8_make & " " & ac8_model & " - 11 - 15 YEARS 2009 to 2005 Total For Sale' align='right'><font size='-1'>" & rs2("ac8_30_plus_aircraft_forsale").ToString & "</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac8_make & " " & ac8_model & " - 11 - 15 YEARS 2009 to 2005 Percentage For Sale' align='right'><font size='-1'>" & rs2("ac8_30_plus_percentage_forsale").ToString & "%</TD>" & vbCrLf
                End If
            Else
                htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
            End If
            If (rs.HasRows) Then
                If rs("ac9_30_plus_aircraft_in_operation") = 0 And rs("ac9_30_plus_aircraft_forsale") = 0 And rs("ac9_30_plus_percentage_forsale") = 0 Then
                    ' htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='3'>&nbsp;</TD>" & vbCrLf
                    'htmlOutput = htmlOutput & "<TH class='separateheader'>&nbsp;</TH>" & vbCrLf
                    htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                    htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                    htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                Else
                    htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac9_make & " " & ac9_model & " - 11 - 15 YEARS 2009 to 2005 Total Active Fleet' align='right'><font size='-1'>" & rs("ac9_30_plus_aircraft_in_operation").ToString & "</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac9_make & " " & ac9_model & " - 11 - 15 YEARS 2009 to 2005 Total For Sale' align='right'><font size='-1'>" & rs("ac9_30_plus_aircraft_forsale").ToString & "</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac9_make & " " & ac9_model & " - 11 - 15 YEARS 2009 to 2005 Percentage For Sale' align='right'><font size='-1'>" & rs("ac9_30_plus_percentage_forsale").ToString & "%</TD>" & vbCrLf
                    ' htmlOutput = htmlOutput & "<TH class='separateheader'>&nbsp;</TH>" & vbCrLf
                End If
            Else
                htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
            End If

            If bolAll = True Then
                htmlOutput = htmlOutput & "</table><br>"
                htmlOutput = htmlOutput & "<table cellspacing='0' cellpadding='2' width='800' border='1'>" & vbCrLf
                htmlOutput = htmlOutput & "<tr>" & vbCrLf
            End If
            rs.Close()

            If bolAll = True Then
                htmlOutput = htmlOutput & "</table><br>"
                htmlOutput = htmlOutput & "<table cellspacing='0' cellpadding='2' width='800' border='1'>" & vbCrLf
                htmlOutput = htmlOutput & "<tr>" & vbCrLf
            End If
            rs2.Close()

            rs2 = Nothing
            htmlOutput = htmlOutput & "</tr></table>"

            Show_Average_Year = htmlOutput

            rs = Nothing
        Catch ex As Exception
        Finally
            SqlCommand3.Dispose()
            SqlConn3.Close()
            SqlConn3.Dispose()

            SqlCommand4.Dispose()
            SqlConn4.Close()
            SqlConn4.Dispose()
        End Try
    End Function
    Function NEW_Show_Average_Year(ByVal amod_id As Integer, ByRef searchCriteria As viewSelectionCriteriaClass) As String

        NEW_Show_Average_Year = ""
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn3 As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand3 As New System.Data.SqlClient.SqlCommand
        Dim SqlCommand4 As New System.Data.SqlClient.SqlCommand
        Dim SqlConn4 As New System.Data.SqlClient.SqlConnection
        Dim adoRs As System.Data.SqlClient.SqlDataReader : adoRs = Nothing
        Dim Query As String : Query = ""
        Dim htmlOutput As String = ""
        Dim ac9_make As String = ""
        Dim ac9_model As String = ""
        Dim rs As System.Data.SqlClient.SqlDataReader : rs = Nothing
        Dim rs2 As System.Data.SqlClient.SqlDataReader : rs2 = Nothing
        '  Dim bolAll As Boolean
        Dim ac19_make As String = ""
        Dim ac19_model As String = ""
        Dim aMaxDate As Date
        Dim ac8_make As String = ""
        Dim ac8_model As String = ""
        Dim rcCount As Integer = 0
        Dim NewInfo As String = ""
        Dim skip_this_section As Boolean = False

        Try

            Try
                SqlConn3.ConnectionString = Session.Item("localPreferences").STARDatabaseConn
                SqlConn3.Open()

                SqlCommand3.Connection = SqlConn3
                SqlCommand3.CommandType = System.Data.CommandType.Text
                SqlCommand3.CommandTimeout = 60
            Catch Sqlex As SqlClient.SqlException
                Response.Write(Sqlex.Message)
            End Try

            Try
                SqlConn4.ConnectionString = Session.Item("localPreferences").STARDatabaseConn
                SqlConn4.Open()

                SqlCommand4.Connection = SqlConn4
                SqlCommand4.CommandType = System.Data.CommandType.Text
                SqlCommand4.CommandTimeout = 60
            Catch Sqlex As SqlClient.SqlException
                Response.Write(Sqlex.Message)
            End Try


            Query = "SELECT MAX(ac1_start_date) AS ac1_start_date FROM dbo.Aircraft_1 WHERE (ac1_amod_id = '" + amod_id.ToString + "')"
            SqlCommand3.CommandText = Query
            adoRs = SqlCommand3.ExecuteReader() 'aDBconn.execute(Query) '

            If (adoRs.HasRows) Then
                adoRs.Read()
                If Not IsDBNull(adoRs.Item("ac1_start_date")) Then
                    aMaxDate = FormatDateTime(adoRs.Item("ac1_start_date").ToString, DateFormat.ShortDate)
                End If
                adoRs.Close()
            Else
                aMaxDate = "that timeframe"
                adoRs.Close()
            End If


            Query = "SELECT ac9_make, ac9_model, ac9_total_fleet, ac9_aircraft_forsale, ac9_percentage_forsale, ac9_0_5_aircraft_in_operation, ac9_0_5_aircraft_forsale, "
            Query = Query & "ac9_0_5_percentage_forsale, ac9_6_10_aircraft_in_operation, ac9_6_10_aircraft_forsale, ac9_6_10_percentage_forsale, ac9_11_15_aircraft_in_operation, "
            Query = Query & "ac9_11_15_aircraft_forsale, ac9_11_15_percentage_forsale, ac9_16_20_aircraft_in_operation, ac9_16_20_aircraft_forsale, ac9_16_20_percentage_forsale, "
            Query = Query & "ac9_21_25_aircraft_in_operation, ac9_21_25_aircraft_forsale, ac9_21_25_percentage_forsale, ac9_26_30_aircraft_in_operation, ac9_26_30_aircraft_forsale, "
            Query = Query & "ac9_26_30_percentage_forsale, ac9_30_plus_aircraft_in_operation, ac9_30_plus_aircraft_forsale, ac9_30_plus_percentage_forsale, ac9_average_year "
            Query = Query & "FROM Aircraft_9 WITH(NOLOCK)"
            Query = Query & "WHERE (ac9_amod_id = '" + amod_id.ToString + "') AND (ac9_start_date = '" & aMaxDate & "')"


            SqlCommand3.CommandText = Query
            rs = SqlCommand3.ExecuteReader()

            rs.Read()
            ' check for an empty record set
            ' this report can generate an empty record set
            If (rs.HasRows) Then

                ac9_make = rs("ac9_make").ToString
                ac9_model = rs("ac9_model").ToString
            End If

            '------------------------------------------- INFO FOR NEW HERE----------------

            Query = "SELECT ac8_make, ac8_model, ac8_total_fleet, ac8_aircraft_forsale, ac8_percentage_forsale, ac8_0_5_aircraft_in_operation, ac8_0_5_aircraft_forsale, "
            Query = Query & "ac8_0_5_percentage_forsale, ac8_6_10_aircraft_in_operation, ac8_6_10_aircraft_forsale, ac8_6_10_percentage_forsale, ac8_11_15_aircraft_in_operation, "
            Query = Query & "ac8_11_15_aircraft_forsale, ac8_11_15_percentage_forsale, ac8_16_20_aircraft_in_operation, ac8_16_20_aircraft_forsale, ac8_16_20_percentage_forsale, "
            Query = Query & "ac8_21_25_aircraft_in_operation, ac8_21_25_aircraft_forsale, ac8_21_25_percentage_forsale, ac8_26_30_aircraft_in_operation, ac8_26_30_aircraft_forsale, "
            Query = Query & "ac8_26_30_percentage_forsale, ac8_30_plus_aircraft_in_operation, ac8_30_plus_aircraft_forsale, ac8_30_plus_percentage_forsale, ac8_average_year "
            Query = Query & "FROM  dbo.Aircraft_8 "
            Query = Query & "WHERE (ac8_amod_id = '" + amod_id.ToString + "') AND (ac8_start_date = '" & aMaxDate & "')"


            SqlCommand4.CommandText = Query
            rs2 = SqlCommand4.ExecuteReader()

            rs2.Read()


            ' check for an empty record set
            ' this report can generate an empty record set
            If (rs2.HasRows) Then


                ac8_make = rs2("ac8_make").ToString
                ac8_model = rs2("ac8_model").ToString
            End If




            If Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                'htmlOutput = htmlOutput & "<tr><td><font class='" & Session("FONT_CLASS_HEADER") & "'><br>" & ac8_make & " " & ac8_model & " AGE OF IN OPERATION FLEET<br></font></td></tr>"
                htmlOutput = htmlOutput & "<tr><td align='left'><font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>AGE OF IN OPERATION FLEET<br></font></td></tr>"

                htmlOutput = htmlOutput & "<tr><td>"
                htmlOutput = htmlOutput & "<table cellspacing='0' cellpadding='4' align='center' width='100%' class='formatTable " & table_color & " large'><thead>"
            ElseIf Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                htmlOutput = htmlOutput & "<tr><td><font class='" & Session("FONT_CLASS_HEADER") & "'><br>" & ac8_make & " " & ac8_model & " Average Age of Fleet ( In Operation )<br></font></td></tr>"
                htmlOutput = htmlOutput & "<tr><td>"
                htmlOutput = htmlOutput & "<table border='1' bordercolor='lightgrey' cellspacing='0' cellpadding='6' align='center' width='100%'>"
            Else
                htmlOutput = htmlOutput & "<tr><td><font class='" & Session("FONT_CLASS_HEADER") & "'><br>" & ac8_make & " " & ac8_model & " Average Age of Fleet ( In Operation )<br></font></td></tr>"
                htmlOutput = htmlOutput & "<tr><td>"
                htmlOutput = htmlOutput & "<table border='1px' bordercolor='lightgrey' cellspacing='0' cellpadding='6' align='center' width='100%'>"
            End If



            'htmlOutput = htmlOutput & "<tr>"
            'htmlOutput = htmlOutput & "<th class='th_title' align='center'  colspan='9'>Average Age of Fleet for " & ac8_make & " " & ac8_model
            'htmlOutput = htmlOutput & "<BR> WHOLLY OWNED AIRCRAFT" & vbCrLf
            'htmlOutput = htmlOutput & "</th>" & vbCrLf
            ''htmlOutput = htmlOutput & "<th class='th_title' align='center' colSpan='36'>&nbsp;</th>"
            'htmlOutput = htmlOutput & "</TR>" & vbCrLf


            ' HERE WILL BE ACTIVE STUFF
            htmlOutput = htmlOutput & "<TR>" & vbCrLf
            'htmlOutput = htmlOutput & "<td><table><tr>" & vbCrLf
            'htmlOutput = htmlOutput & "<TH class='separateheader'>&nbsp;</TH>" & vbCrLf.


            If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Then
                htmlOutput = htmlOutput & "<TH class='left' colspan='3'>YEAR<br/>RANGES&nbsp;&nbsp;</TH>" & vbCrLf
                htmlOutput = htmlOutput & "<TH class='right' colspan='1'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>&nbsp;FACTORY NEW OWNED&nbsp;</font></TH2>" & vbCrLf
                htmlOutput = htmlOutput & "<Th class='right' colspan='1'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>&nbsp;PREVIOUSLY OWNED&nbsp;</font></TH></tr>" & vbCrLf
                htmlOutput = htmlOutput & "</tr>"
            ElseIf Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                htmlOutput = htmlOutput & "<TH class='left' colspan='3'>YEAR<br/>RANGES&nbsp;&nbsp;</TH>" & vbCrLf
                htmlOutput = htmlOutput & "<TH class='right' colspan='1'>&nbsp;FACTORY NEW OWNED&nbsp;</TH2>" & vbCrLf
                htmlOutput = htmlOutput & "<Th class='right' colspan='1'>&nbsp;PREVIOUSLY OWNED&nbsp;</TH></tr>" & vbCrLf
                htmlOutput = htmlOutput & "</tr>"
            Else
                htmlOutput = htmlOutput & "<TH  class='th_title_details' align='center' colspan='3'>&nbsp;&nbsp;</TH>" & vbCrLf
                htmlOutput = htmlOutput & "<TH  class='th_title_details' align='center' colspan='3'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>&nbsp;FACTORY NEW OWNED&nbsp;</font></TH2>" & vbCrLf
                htmlOutput = htmlOutput & "<Th  class='th_title_details' align='center' colspan='3'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>&nbsp;PREVIOUSLY OWNED&nbsp;</font></TH></tr>" & vbCrLf
                htmlOutput = htmlOutput & "<tr><TH  class='th_title_details' align='center' colspan='3'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>&nbsp;YEAR RANGES&nbsp;<br>&nbsp;</font></TH>" & vbCrLf
                htmlOutput = htmlOutput & "<TH  class='th_title_details' align='center' width='50'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>ACTIVE FLEET</font></TH>" & vbCrLf
                htmlOutput = htmlOutput & "<TH  class='th_title_details' align='center' width='50'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>FOR SALE</font></TH>" & vbCrLf
                htmlOutput = htmlOutput & "<TH  class='th_title_details' nowrap align='center' width='50'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>% FOR SALE</font></TH>" & vbCrLf
                htmlOutput = htmlOutput & "<TH  class='th_title_details' align='center' width='50'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>ACTIVE FLEET</font></TH>" & vbCrLf
                htmlOutput = htmlOutput & "<TH  class='th_title_details' align='center' width='50'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>FOR SALE</font></TH>" & vbCrLf
                htmlOutput = htmlOutput & "<TH  class='th_title_details' nowrap align='center' width='50'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>% FOR SALE</font></TH></tr>" & vbCrLf
            End If

            If Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                htmlOutput = htmlOutput & "</thead><tbody>"
                htmlOutput = htmlOutput & "<tr><td class='left  titleCase' nowrap align='center' colspan='3'>Total</Td>" & vbCrLf
            Else
                htmlOutput = htmlOutput & "<tr><TH  class='th_title_details' nowrap align='center' colspan='3'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>TOTAL AIRCRAFT - ALL YEARS</font></TH>" & vbCrLf
            End If




            If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Then
                If (rs2.HasRows) Then
                    htmlOutput = htmlOutput & "<TD  class='mistyrose' title='" & ac8_make & " " & ac8_model & " - TOTAL AIRCRAFT ALL YEARS Total Active Fleet' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs2("ac8_total_fleet").ToString & "</font></TD>" & vbCrLf
                End If
                If (rs.HasRows) Then
                    htmlOutput = htmlOutput & "<TD  class='mistyrose' title='" & ac9_make & " " & ac9_model & " - TOTAL AIRCRAFT ALL YEARS Total Active Fleet' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs("ac9_total_fleet").ToString & "</font></TD>" & vbCrLf
                    htmlOutput = htmlOutput & "</tr>"
                End If
            ElseIf Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                If (rs2.HasRows) Then
                    htmlOutput = htmlOutput & "<TD  class='mistyrose' title='" & ac8_make & " " & ac8_model & " - TOTAL AIRCRAFT ALL YEARS Total Active Fleet' align='right'>" & rs2("ac8_total_fleet").ToString & "</TD>" & vbCrLf
                End If
                If (rs.HasRows) Then
                    htmlOutput = htmlOutput & "<TD  class='mistyrose' title='" & ac9_make & " " & ac9_model & " - TOTAL AIRCRAFT ALL YEARS Total Active Fleet' align='right'>" & rs("ac9_total_fleet").ToString & "</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "</tr>"
                End If
            Else
                If (rs2.HasRows) Then
                    htmlOutput = htmlOutput & "<TD  class='mistyrose' title='" & ac8_make & " " & ac8_model & " - TOTAL AIRCRAFT ALL YEARS Total Active Fleet' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs2("ac8_total_fleet").ToString & "</font></TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='mistyrose' title='" & ac8_make & " " & ac8_model & " - TOTAL AIRCRAFT ALL YEARS Total For Sale' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs2("ac8_aircraft_forsale").ToString & "</font></TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='mistyrose' title='" & ac8_make & " " & ac8_model & " - TOTAL AIRCRAFT ALL YEARS Percentage For Sale' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs2("ac8_percentage_forsale").ToString & "%</font></TD>" & vbCrLf
                End If
                If (rs.HasRows) Then
                    htmlOutput = htmlOutput & "<TD  class='mistyrose' title='" & ac9_make & " " & ac9_model & " - TOTAL AIRCRAFT ALL YEARS Total Active Fleet' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs("ac9_total_fleet").ToString & "</font></TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='mistyrose' title='" & ac9_make & " " & ac9_model & " - TOTAL AIRCRAFT ALL YEARS Total For Sale' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs("ac9_aircraft_forsale").ToString & "</font></TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='mistyrose' title='" & ac9_make & " " & ac9_model & " - TOTAL AIRCRAFT ALL YEARS Percentage For Sale' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs("ac9_percentage_forsale").ToString & "%</font></TD></tr>" & vbCrLf
                    'htmlOutput = htmlOutput & "<TH class='separateheader'>&nbsp;</TH>" & vbCrLf
                End If
            End If







            If Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                htmlOutput = htmlOutput & "<tr><Td  class='left titleCase' nowrap  colspan='3'>0 - 5 Years</Td>" & vbCrLf
            Else
                htmlOutput = htmlOutput & "<tr><Td  class='left' nowrap  colspan='3'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>0 - 5 YEARS</font></Td>" & vbCrLf
            End If

            If (rs2.HasRows) Then
                If rs2("ac8_0_5_aircraft_in_operation") = 0 And rs2("ac8_0_5_aircraft_forsale") = 0 And rs2("ac8_0_5_percentage_forsale") = 0 Then
                    htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                    If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Or Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                    Else
                        htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                        htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                    End If

                Else
                    htmlOutput = htmlOutput & "<TD  class='powderblue' title='" & ac8_make & " " & ac8_model & " - 0 - 5 YEARS Total Active Fleet' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs2("ac8_0_5_aircraft_in_operation").ToString & "</font></TD>" & vbCrLf
                    If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Or Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                    Else
                        htmlOutput = htmlOutput & "<TD  class='powderblue' title='" & ac8_make & " " & ac8_model & " - 0 - 5 YEARS Total For Sale' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs2("ac8_0_5_aircraft_forsale").ToString & "</font></TD>" & vbCrLf
                        htmlOutput = htmlOutput & "<TD  class='powderblue' title='" & ac8_make & " " & ac8_model & " - 0 - 5 YEARS Percentage For Sale' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs2("ac8_0_5_percentage_forsale").ToString & "%</font></TD>" & vbCrLf
                    End If
                End If
            Else
                htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Or Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                Else
                    htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                End If
            End If
            If (rs.HasRows) Then
                If rs("ac9_0_5_aircraft_in_operation") = 0 And rs("ac9_0_5_aircraft_forsale") = 0 And rs("ac9_0_5_percentage_forsale") = 0 Then
                    ' htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='3'>&nbsp;</TD>" & vbCrLf
                    ' htmlOutput = htmlOutput & "<TH class='separateheader'>&nbsp;</TH>" & vbCrLf
                    htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                    If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Or Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                    Else
                        htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                        htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                    End If
                Else


                    htmlOutput = htmlOutput & "<TD  class='powderblue' title='" & ac9_make & " " & ac9_model & " - 0 - 5 YEARS Total Active Fleet' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs("ac9_0_5_aircraft_in_operation").ToString & "</font></TD>" & vbCrLf
                    If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Or Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                    Else
                        htmlOutput = htmlOutput & "<TD  class='powderblue' title='" & ac9_make & " " & ac9_model & " - 0 - 5 YEARS Total For Sale' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs("ac9_0_5_aircraft_forsale").ToString & "</font></TD>" & vbCrLf
                        htmlOutput = htmlOutput & "<TD  class='powderblue' title='" & ac9_make & " " & ac9_model & " - 0 - 5 YEARS Percentage For Sale' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs("ac9_0_5_percentage_forsale").ToString & "%</font></TD>" & vbCrLf
                    End If
                    'htmlOutput = htmlOutput & "<TH class='separateheader'>&nbsp;</TH>" & vbCrLf
                End If
            Else
                htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Then
                Else
                    htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                    htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                End If
            End If












            skip_this_section = False
            If (rs2.HasRows) Then
                If rs2("ac8_6_10_aircraft_forsale") = 0 And rs2("ac8_6_10_aircraft_forsale") = 0 And rs2("ac8_6_10_aircraft_forsale") = 0 Then
                    skip_this_section = True  ' if it doesnt have rows, or they are all blank, then skip
                End If
            Else
                skip_this_section = True
            End If

            If (rs.HasRows) Then
                If rs("ac9_6_10_aircraft_forsale") = 0 And rs("ac9_6_10_aircraft_forsale") = 0 And rs("ac9_6_10_aircraft_forsale") = 0 Then
                    ' if the first section has nothing 
                Else
                    skip_this_section = False  ' only if this section has rows and is not blank will we not skip 
                End If
            End If

            If skip_this_section = False Then
                If Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                    htmlOutput = htmlOutput & "</tr><tr><Td  class='left  titleCase' nowrap  colspan='3'>6 - 10 Years</Td>" & vbCrLf
                Else
                    htmlOutput = htmlOutput & "</tr><tr><Td  class='left' nowrap  colspan='3'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>6 - 10 YEARS</font></Td>" & vbCrLf
                End If

                If (rs2.HasRows) Then
                    If rs2("ac8_6_10_aircraft_in_operation") = 0 And rs2("ac8_6_10_aircraft_forsale") = 0 And rs2("ac8_6_10_percentage_forsale") = 0 Then
                        htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                        If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Or Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                        Else
                            htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                        End If
                    Else
                        htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac8_make & " " & ac8_model & " - 6 - 10 YEARS Total Active Fleet' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs2("ac8_6_10_aircraft_in_operation").ToString & "</font></TD>" & vbCrLf
                        If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Or Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                        Else
                            htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac8_make & " " & ac8_model & " - 6 - 10 YEARS Total For Sale' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs2("ac8_6_10_aircraft_forsale").ToString & "</font></TD>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac8_make & " " & ac8_model & " - 6 - 10 YEARS Percentage For Sale' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs2("ac8_6_10_percentage_forsale").ToString & "%</font></TD>" & vbCrLf
                        End If
                    End If
                Else
                    htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                    If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Or Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                    Else
                        htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                        htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                    End If
                End If


                If (rs.HasRows) Then
                    If rs("ac9_6_10_aircraft_in_operation") = 0 And rs("ac9_6_10_aircraft_forsale") = 0 And rs("ac9_6_10_percentage_forsale") = 0 Then
                        'htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='3'>&nbsp;</TD>" & vbCrLf
                        ' htmlOutput = htmlOutput & "<TH class='separateheader'>&nbsp;</TH>" & vbCrLf
                        htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                        If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Or Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                        Else
                            htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                            htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                        End If
                    Else
                        htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac9_make & " " & ac9_model & " - 6 - 10 YEARS Total Active Fleet' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs("ac9_6_10_aircraft_in_operation").ToString & "</font></TD>" & vbCrLf
                        If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Or Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                        Else
                            htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac9_make & " " & ac9_model & " - 6 - 10 YEARS Total For Sale' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs("ac9_6_10_aircraft_forsale").ToString & "</font></TD>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac9_make & " " & ac9_model & " - 6 - 10 YEARS Percentage For Sale' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs("ac9_6_10_percentage_forsale").ToString & "%</font></TD>" & vbCrLf
                        End If
                        ' htmlOutput = htmlOutput & "<TH class='separateheader'>&nbsp;</TH>" & vbCrLf
                    End If
                Else
                    htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                    If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Or Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                    Else
                        htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                        htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                    End If
                End If
            End If




            skip_this_section = False
            If (rs2.HasRows) Then
                If rs2("ac8_11_15_aircraft_in_operation") = 0 And rs2("ac8_11_15_aircraft_in_operation") = 0 And rs2("ac8_11_15_aircraft_in_operation") = 0 Then
                    skip_this_section = True  ' if it doesnt have rows, or they are all blank, then skip
                End If
            Else
                skip_this_section = True
            End If

            If (rs.HasRows) Then
                If rs("ac9_11_15_aircraft_in_operation") = 0 And rs("ac9_11_15_aircraft_in_operation") = 0 And rs("ac9_11_15_aircraft_in_operation") = 0 Then
                    ' if the first section has nothing 
                Else
                    skip_this_section = False  ' only if this section has rows and is not blank will we not skip 
                End If
            End If

            If skip_this_section = False Then
                If Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                    htmlOutput = htmlOutput & "</tr><tr><Td class='left titleCase' nowrap  colspan='3'>11-15 Years</font>" & vbCrLf
                Else
                    htmlOutput = htmlOutput & "</tr><tr><Td class='left' nowrap  colspan='3'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>11 - 15 YEARS</font></Td>" & vbCrLf
                End If

                If (rs2.HasRows) Then
                    If rs2("ac8_11_15_aircraft_in_operation") = 0 And rs2("ac8_11_15_aircraft_forsale") = 0 And rs2("ac8_11_15_percentage_forsale") = 0 Then
                        htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                        If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Or Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                        Else
                            htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                        End If
                    Else
                        htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac8_make & " " & ac8_model & " - 11 - 15 YEARS Total Active Fleet' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs2("ac8_11_15_aircraft_in_operation").ToString & "</font></TD>" & vbCrLf
                        If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Or Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                        Else
                            htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac8_make & " " & ac8_model & " - 11 - 15 YEARS Total For Sale' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs2("ac8_11_15_aircraft_forsale").ToString & "</font></TD>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac8_make & " " & ac8_model & " - 11 - 15 YEARS Percentage For Sale' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs2("ac8_11_15_percentage_forsale").ToString & "%</font></TD>" & vbCrLf
                        End If
                    End If
                Else
                    htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                    If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Or Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                    Else
                        htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                        htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                    End If
                End If
                If (rs.HasRows) Then
                    If rs("ac9_11_15_aircraft_in_operation") = 0 And rs("ac9_11_15_aircraft_forsale") = 0 And rs("ac9_11_15_percentage_forsale") = 0 Then
                        'htmlOutput = htmlOutput & "<TD class='blankline' align='right' colSpan='3'>&nbsp;</TD>" & vbCrLf
                        'htmlOutput = htmlOutput & "<TH class='separateheader'>&nbsp;</TH>" & vbCrLf
                        htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                        If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Or Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                        Else
                            htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                            htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                        End If
                    Else
                        htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac9_make & " " & ac9_model & " - 11 - 15 YEARS Total Active Fleet' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs("ac9_11_15_aircraft_in_operation").ToString & "</font></TD>" & vbCrLf
                        If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Or Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                        Else
                            htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac9_make & " " & ac9_model & " - 11 - 15 YEARS Total For Sale' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs("ac9_11_15_aircraft_forsale").ToString & "</font></TD>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac9_make & " " & ac9_model & " - 11 - 15 YEARS Percentage For Sale' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs("ac9_11_15_percentage_forsale").ToString & "%</font></TD>" & vbCrLf
                        End If
                        ' htmlOutput = htmlOutput & "<TH class='separateheader'>&nbsp;</TH>" & vbCrLf
                    End If
                Else
                    htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                    If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Or Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                    Else
                        htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                        htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                    End If
                End If
            End If



            skip_this_section = False
            If (rs2.HasRows) Then
                If rs2("ac8_16_20_aircraft_in_operation") = 0 And rs2("ac8_16_20_aircraft_forsale") = 0 And rs2("ac8_16_20_percentage_forsale") = 0 Then
                    skip_this_section = True  ' if it doesnt have rows, or they are all blank, then skip
                End If
            Else
                skip_this_section = True
            End If

            If (rs.HasRows) Then
                If rs("ac9_16_20_aircraft_in_operation") = 0 And rs("ac9_16_20_aircraft_forsale") = 0 And rs("ac9_16_20_percentage_forsale") = 0 Then
                    ' if the first section has nothing 
                Else
                    skip_this_section = False  ' only if this section has rows and is not blank will we not skip 
                End If
            End If

            If skip_this_section = False Then

                If Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                    htmlOutput = htmlOutput & "</tr><tr><Td  class='left titleCase' nowrap  colspan='3'>16 - 20 Years</Td>" & vbCrLf
                Else
                    htmlOutput = htmlOutput & "</tr><tr><Td  class='left' nowrap  colspan='3'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>16 - 20 YEARS</font></Td>" & vbCrLf
                End If

                If (rs2.HasRows) Then
                    If rs2("ac8_16_20_aircraft_in_operation") = 0 And rs2("ac8_16_20_aircraft_forsale") = 0 And rs2("ac8_16_20_percentage_forsale") = 0 Then
                        htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                        If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Or Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                        Else
                            htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                        End If
                    Else
                        htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac8_make & " " & ac8_model & " - 11 - 15 YEARS Total Active Fleet' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs2("ac8_16_20_aircraft_in_operation").ToString & "</font></TD>" & vbCrLf
                        If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Or Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                        Else
                            htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac8_make & " " & ac8_model & " - 11 - 15 YEARS Total For Sale' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs2("ac8_16_20_aircraft_forsale").ToString & "</font></TD>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac8_make & " " & ac8_model & " - 11 - 15 YEARS Percentage For Sale' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs2("ac8_16_20_percentage_forsale").ToString & "%</font></TD>" & vbCrLf
                        End If
                    End If
                Else
                    htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                    If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Or Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                    Else
                        htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                        htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                    End If
                End If
                If (rs.HasRows) Then
                    If rs("ac9_16_20_aircraft_in_operation") = 0 And rs("ac9_16_20_aircraft_forsale") = 0 And rs("ac9_16_20_percentage_forsale") = 0 Then
                        'htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='3'>&nbsp;</TD>" & vbCrLf
                        ' htmlOutput = htmlOutput & "<TH class='separateheader'>&nbsp;</TH>" & vbCrLf
                        htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                        If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Or Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                        Else
                            htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                            htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                        End If
                    Else
                        htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac9_make & " " & ac9_model & " - 11 - 15 YEARS Total Active Fleet' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs("ac9_16_20_aircraft_in_operation").ToString & "</font></TD>" & vbCrLf
                        If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Or Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                        Else
                            htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac9_make & " " & ac9_model & " - 11 - 15 YEARS Total For Sale' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs("ac9_16_20_aircraft_forsale").ToString & "</font></TD>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac9_make & " " & ac9_model & " - 11 - 15 YEARS Percentage For Sale' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs("ac9_16_20_percentage_forsale").ToString & "%</font></TD>" & vbCrLf
                        End If
                        ' htmlOutput = htmlOutput & "<TH class='separateheader'>&nbsp;</TH>" & vbCrLf
                    End If
                Else
                    htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                    If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Or Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                    Else
                        htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                        htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                    End If
                End If
            End If


            skip_this_section = False
            If (rs2.HasRows) Then
                If rs2("ac8_21_25_aircraft_in_operation") = 0 And rs2("ac8_21_25_aircraft_in_operation") = 0 And rs2("ac8_21_25_aircraft_in_operation") = 0 Then
                    skip_this_section = True  ' if it doesnt have rows, or they are all blank, then skip
                End If
            Else
                skip_this_section = True
            End If

            If (rs.HasRows) Then
                If rs("ac9_21_25_aircraft_in_operation") = 0 And rs("ac9_21_25_aircraft_in_operation") = 0 And rs("ac9_21_25_aircraft_in_operation") = 0 Then
                    ' if the first section has nothing 
                Else
                    skip_this_section = False  ' only if this section has rows and is not blank will we not skip 
                End If
            End If

            If skip_this_section = False Then

                If Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                    htmlOutput = htmlOutput & "</tr><tr><Td  class='left titleCase' nowrap colspan='3'>21 - 25 Years</Td>" & vbCrLf
                Else
                    htmlOutput = htmlOutput & "</tr><tr><Td  class='left' nowrap colspan='3'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>21 - 25 YEARS</font></Td>" & vbCrLf
                End If

                If (rs2.HasRows) Then
                    If rs2("ac8_21_25_aircraft_in_operation") = 0 And rs2("ac8_21_25_aircraft_forsale") = 0 And rs2("ac8_21_25_percentage_forsale") = 0 Then
                        htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                        If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Or Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                        Else
                            htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                        End If
                    Else
                        htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac8_make & " " & ac8_model & " - 11 - 15 YEARS Total Active Fleet' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs2("ac8_21_25_aircraft_in_operation").ToString & "</font></TD>" & vbCrLf
                        If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Or Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                        Else
                            htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac8_make & " " & ac8_model & " - 11 - 15 YEARS Total For Sale' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs2("ac8_21_25_aircraft_forsale").ToString & "</font></TD>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac8_make & " " & ac8_model & " - 11 - 15 YEARS Percentage For Sale' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs2("ac8_21_25_percentage_forsale").ToString & "%</font></TD>" & vbCrLf
                        End If
                    End If
                Else
                    htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                    If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Or Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                    Else
                        htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                        htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                    End If
                End If
                If (rs.HasRows) Then
                    If rs("ac9_21_25_aircraft_in_operation") = 0 And rs("ac9_21_25_aircraft_forsale") = 0 And rs("ac9_21_25_percentage_forsale") = 0 Then
                        'htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='3'>&nbsp;</TD>" & vbCrLf
                        ' htmlOutput = htmlOutput & "<TH class='separateheader'>&nbsp;</TH>" & vbCrLf
                        htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                        If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Or Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                        Else
                            htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                            htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                        End If
                    Else
                        htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac9_make & " " & ac9_model & " - 11 - 15 YEARS Total Active Fleet' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs("ac9_21_25_aircraft_in_operation").ToString & "</font></TD>" & vbCrLf
                        If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Or Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                        Else
                            htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac9_make & " " & ac9_model & " - 11 - 15 YEARS Total For Sale' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs("ac9_21_25_aircraft_forsale").ToString & "</font></TD>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac9_make & " " & ac9_model & " - 11 - 15 YEARS Percentage For Sale' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs("ac9_21_25_percentage_forsale").ToString & "%</font></TD>" & vbCrLf
                        End If
                        ' htmlOutput = htmlOutput & "<TH class='separateheader'>&nbsp;</TH>" & vbCrLf
                    End If
                Else
                    htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                    If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Or Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                    Else
                        htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                        htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                    End If
                End If
            End If


            skip_this_section = False
            If (rs2.HasRows) Then
                If rs2("ac8_26_30_aircraft_in_operation") = 0 And rs2("ac8_26_30_aircraft_in_operation") = 0 And rs2("ac8_26_30_aircraft_in_operation") = 0 Then
                    skip_this_section = True  ' if it doesnt have rows, or they are all blank, then skip
                End If
            Else
                skip_this_section = True
            End If

            If (rs.HasRows) Then
                If rs("ac9_26_30_aircraft_in_operation") = 0 And rs("ac9_26_30_aircraft_in_operation") = 0 And rs("ac9_26_30_aircraft_in_operation") = 0 Then
                    ' if the first section has nothing 
                Else
                    skip_this_section = False  ' only if this section has rows and is not blank will we not skip 
                End If
            End If

            If skip_this_section = False Then
                If Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                    htmlOutput = htmlOutput & "</tr><tr><Td  class='left titleCase' nowrap  colspan='3'>26 - 30 Years</Td>" & vbCrLf
                Else
                    htmlOutput = htmlOutput & "</tr><tr><Td  class='left' nowrap  colspan='3'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>26 - 30 YEARS</font></Td>" & vbCrLf
                End If

                If (rs2.HasRows) Then
                    If rs2("ac8_26_30_aircraft_in_operation") = 0 And rs2("ac8_26_30_aircraft_forsale") = 0 And rs2("ac8_26_30_percentage_forsale") = 0 Then
                        htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                        If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Or Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                        Else
                            htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                        End If

                    Else
                        htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac8_make & " " & ac8_model & " - 11 - 15 YEARS Total Active Fleet' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs2("ac8_26_30_aircraft_in_operation").ToString & "</font></TD>" & vbCrLf
                        If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Or Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                        Else
                            htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac8_make & " " & ac8_model & " - 11 - 15 YEARS Total For Sale' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs2("ac8_26_30_aircraft_forsale").ToString & "</font></TD>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac8_make & " " & ac8_model & " - 11 - 15 YEARS Percentage For Sale' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs2("ac8_26_30_percentage_forsale").ToString & "%</font></TD>" & vbCrLf
                        End If
                    End If
                Else
                    htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                    If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Or Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                    Else
                        htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                        htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                    End If
                End If
                If (rs.HasRows) Then
                    If rs("ac9_26_30_aircraft_in_operation") = 0 And rs("ac9_26_30_aircraft_forsale") = 0 And rs("ac9_26_30_percentage_forsale") = 0 Then
                        'htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='3'>&nbsp;</TD>" & vbCrLf
                        htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                        If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Or Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                        Else
                            htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                            htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                        End If
                    Else
                        htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac9_make & " " & ac9_model & " - 11 - 15 YEARS Total Active Fleet' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs("ac9_26_30_aircraft_in_operation").ToString & "</font></TD>" & vbCrLf
                        If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Or Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                        Else
                            htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac9_make & " " & ac9_model & " - 11 - 15 YEARS Total For Sale' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs("ac9_26_30_aircraft_forsale").ToString & "</font></TD>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac9_make & " " & ac9_model & " - 11 - 15 YEARS Percentage For Sale' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs("ac9_26_30_percentage_forsale").ToString & "%</font></TD>" & vbCrLf
                        End If
                        ' htmlOutput = htmlOutput & "<TH class='separateheader'>&nbsp;</TH>" & vbCrLf
                    End If
                Else
                    htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                    If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Or Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                    Else
                        htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                        htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                    End If
                End If
            End If

            If skip_this_section = False Then
                If Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                    htmlOutput = htmlOutput & "</tr><tr><Td  class='th_title_details titleCase' nowrap align='center' colspan='3'>30 Plus Years</Td>" & vbCrLf
                Else
                    htmlOutput = htmlOutput & "</tr><tr><TH  class='th_title_details' nowrap align='center' colspan='3'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>30 PLUS YEARS<font></TH>" & vbCrLf
                End If

                If (rs2.HasRows) Then
                    If rs2("ac8_30_plus_aircraft_in_operation") = 0 And rs2("ac8_30_plus_aircraft_forsale") = 0 And rs2("ac8_30_plus_percentage_forsale") = 0 Then
                        htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                        If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Or Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                        Else
                            htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='1'>&nbsp;</TD>" & vbCrLf
                        End If
                    Else
                        htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac8_make & " " & ac8_model & " - 11 - 15 YEARS Total Active Fleet' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs2("ac8_30_plus_aircraft_in_operation").ToString & "</font></TD>" & vbCrLf
                        If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Or Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                        Else
                            htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac8_make & " " & ac8_model & " - 11 - 15 YEARS Total For Sale' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs2("ac8_30_plus_aircraft_forsale").ToString & "</font></TD>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac8_make & " " & ac8_model & " - 11 - 15 YEARS Percentage For Sale' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs2("ac8_30_plus_percentage_forsale").ToString & "%</font></TD>" & vbCrLf
                        End If
                    End If
                Else
                    htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                    If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Or Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                    Else
                        htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                        htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                    End If
                End If
                If (rs.HasRows) Then
                    If rs("ac9_30_plus_aircraft_in_operation") = 0 And rs("ac9_30_plus_aircraft_forsale") = 0 And rs("ac9_30_plus_percentage_forsale") = 0 Then
                        ' htmlOutput = htmlOutput & "<TD  class='blankline' align='right' colSpan='3'>&nbsp;</TD>" & vbCrLf
                        'htmlOutput = htmlOutput & "<TH class='separateheader'>&nbsp;</TH>" & vbCrLf
                        htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                        If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Or Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                        Else
                            htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                            htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                        End If
                    Else
                        htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac9_make & " " & ac9_model & " - 11 - 15 YEARS Total Active Fleet' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs("ac9_30_plus_aircraft_in_operation").ToString & "</font></TD>" & vbCrLf
                        If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Or Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                        Else
                            htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac9_make & " " & ac9_model & " - 11 - 15 YEARS Total For Sale' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs("ac9_30_plus_aircraft_forsale").ToString & "</font></TD>" & vbCrLf
                            htmlOutput = htmlOutput & "<TD  class='mintcream' title='" & ac9_make & " " & ac9_model & " - 11 - 15 YEARS Percentage For Sale' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><font size='-1'>" & rs("ac9_30_plus_percentage_forsale").ToString & "%</font></TD>" & vbCrLf
                        End If
                        ' htmlOutput = htmlOutput & "<TH class='separateheader'>&nbsp;</TH>" & vbCrLf
                    End If
                Else
                    htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                    If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Or Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                    Else
                        htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                        htmlOutput = htmlOutput & "<td class='blankline' >&nbsp;</td>" & vbCrLf
                    End If
                End If
            End If





            rs2 = Nothing
            htmlOutput = htmlOutput & "</tr>"
            htmlOutput = htmlOutput & "</table>"
            htmlOutput = htmlOutput & "</td></tr>"

            If Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                htmlOutput = Replace(htmlOutput, "class='th_title_details'", "")
                htmlOutput = Replace(htmlOutput, "class='blankline'", "")
                htmlOutput = Replace(htmlOutput, "class='mintcream'", "")
                htmlOutput = Replace(htmlOutput, "class='powderblue'", "")
                htmlOutput = Replace(htmlOutput, "<font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>", "")
                htmlOutput = Replace(htmlOutput, "<font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>", "")
                htmlOutput = Replace(htmlOutput, "</font>", "")
                htmlOutput = Replace(htmlOutput, "<font size='-1'>", "")

            End If


            NEW_Show_Average_Year = htmlOutput

            rs = Nothing
        Catch ex As Exception
        Finally
            SqlCommand3.Dispose()
            SqlConn3.Close()
            SqlConn3.Dispose()

            SqlCommand4.Dispose()
            SqlConn4.Close()
            SqlConn4.Dispose()
        End Try
    End Function
    Function Get_FirstMonth_For_Quarter_Server(ByVal in_Quarter) As String
        Get_FirstMonth_For_Quarter_Server = ""

        Select Case (in_Quarter)

            Case "Q1"
                Get_FirstMonth_For_Quarter_Server = 1
            Case "Q2"
                Get_FirstMonth_For_Quarter_Server = 4
            Case "Q3"
                Get_FirstMonth_For_Quarter_Server = 7
            Case "Q4"
                Get_FirstMonth_For_Quarter_Server = 10

        End Select

    End Function

    Function Get_Quarter_For_Month_Server(ByVal in_Month) As String
        Get_Quarter_For_Month_Server = ""
        Select Case (CInt(in_Month))

            Case 1, 2, 3
                Get_Quarter_For_Month_Server = "Q1"
            Case 4, 5, 6
                Get_Quarter_For_Month_Server = "Q2"
            Case 7, 8, 9
                Get_Quarter_For_Month_Server = "Q3"
            Case 10, 11, 12
                Get_Quarter_For_Month_Server = "Q4"

        End Select

    End Function
    Public Sub DocViewDateRange(ByRef dtEndDate, ByRef dtStartDate, ByVal sTimeScale, ByRef nScaleSets, ByVal nLastScale, ByVal isHeliOnly)

        Dim dtTempDate, nDisplayRange, nMaxRange, bShiftStartDate
        Dim dtMonthBottom, dtHeliMonthBottom
        Dim dtYearBottom, dtHeliYearBottom
        Dim dtSelected As String = ""

        dtMonthBottom = CDate("10/01/1989")
        dtYearBottom = CDate("1/01/1990")

        dtHeliMonthBottom = CDate("01/01/2006")
        dtHeliYearBottom = CDate("01/01/2006")

        bShiftStartDate = False

        If nScaleSets > nLastScale Then
            bShiftStartDate = True

            Select Case (sTimeScale)
                Case "Years"
                    dtSelected = DateAdd("yyyy", (-1 * (nScaleSets)), dtEndDate)
                Case "Months"
                    dtSelected = DateAdd("m", (-1 * (nScaleSets)), dtEndDate)
                Case "Quarters"
                    dtSelected = DateAdd("q", (-1 * (nScaleSets)), CDate(Get_FirstMonth_For_Quarter_Server(Get_Quarter_For_Month_Server(Month(dtEndDate))) & "/01/" & Year(dtEndDate)))
                Case "Days"
                    dtSelected = DateAdd("d", (-1 * (nScaleSets)), dtEndDate)
            End Select
        End If

        If dtSelected <> "" And bShiftStartDate Then

            ' we need to check to make sure we dont go past our bottom limit
            Select Case (LCase(sTimeScale))

                Case "years", "quarters"
                    If isHeliOnly Then
                        If CDbl(Year(dtHeliYearBottom)) >= CDbl(Year(dtSelected)) And
                           CDbl(Month(dtHeliYearBottom)) >= CDbl(Month(dtSelected)) Then
                            dtSelected = CDate(dtHeliYearBottom)
                        End If
                    Else
                        If CDbl(Year(dtYearBottom)) >= CDbl(Year(dtSelected)) And
                           CDbl(Month(dtYearBottom)) >= CDbl(Month(dtSelected)) Then
                            dtSelected = CDate(dtYearBottom)
                        End If
                    End If
                Case Else
                    If isHeliOnly Then
                        If CDbl(Year(dtHeliYearBottom)) >= CDbl(Year(dtSelected)) And
                           CDbl(Month(dtHeliYearBottom)) >= CDbl(Month(dtSelected)) Then
                            dtSelected = CDate(dtHeliYearBottom)
                        End If
                    Else
                        If CDbl(Year(dtYearBottom)) >= CDbl(Year(dtSelected)) And
                           CDbl(Month(dtYearBottom)) >= CDbl(Month(dtSelected)) Then
                            dtSelected = CDate(dtYearBottom)
                        End If
                    End If

            End Select

            dtStartDate = dtSelected

        End If

        If sTimeScale = "Months" Then

            dtTempDate = CDate(DateAdd("m", nScaleSets, CDate(dtStartDate)))

            If CDate(dtTempDate) < CDate(dtEndDate) Then
                dtEndDate = CDate(Month(dtTempDate) & "/01/" & Year(dtTempDate))
            Else
                dtEndDate = CDate(Month(dtEndDate) & "/01/" & Year(dtEndDate))
            End If

            nDisplayRange = DateDiff("m", dtStartDate, dtEndDate)
            nMaxRange = ReturnTotalRange_Server(sTimeScale)

            If nDisplayRange < nScaleSets Then
                nScaleSets = nDisplayRange
            Else
                If nDisplayRange < nMaxRange Then
                    nScaleSets = nDisplayRange
                Else
                    nScaleSets = nMaxRange
                End If
            End If

        End If

        If sTimeScale = "Years" Then
            dtTempDate = CDate(DateAdd("yyyy", nScaleSets, CDate(dtStartDate)))
            If CDate(dtTempDate) < CDate(dtEndDate) Then
                dtEndDate = CDate("01/01/" & Year(dtTempDate))
            Else
                dtEndDate = CDate("01/01/" & Year(dtEndDate))
            End If

            nDisplayRange = DateDiff("yyyy", dtStartDate, dtEndDate)
            nMaxRange = ReturnTotalRange_Server(sTimeScale)

            If nDisplayRange < nScaleSets Then
                nScaleSets = nDisplayRange
            Else
                If nDisplayRange < nMaxRange Then
                    nScaleSets = nDisplayRange
                Else
                    nScaleSets = nMaxRange
                End If
            End If

        End If

        If sTimeScale = "Quarters" Then
            dtTempDate = CDate(DateAdd("q", nScaleSets, CDate(dtStartDate)))
            If CDate(dtTempDate) < CDate(dtEndDate) Then
                dtEndDate = CDate(Month(dtTempDate) & "/01/" & Year(dtTempDate))
            Else
                dtEndDate = CDate(Month(dtEndDate) & "/01/" & Year(dtEndDate))
            End If

            nDisplayRange = DateDiff("q", dtStartDate, dtEndDate)
            nMaxRange = ReturnTotalRange_Server(sTimeScale)

            If nDisplayRange < nScaleSets Then
                nScaleSets = nDisplayRange
            Else
                If nDisplayRange < nMaxRange Then
                    nScaleSets = nDisplayRange
                Else
                    nScaleSets = nMaxRange
                End If
            End If

        End If

        If sTimeScale = "Days" Then
            dtTempDate = CDate(DateAdd("d", nScaleSets, CDate(dtStartDate)))
            If CDate(dtTempDate) < CDate(dtEndDate) Then
                dtEndDate = CDate(dtTempDate)
            End If

            nDisplayRange = DateDiff("d", dtStartDate, dtEndDate)
            nMaxRange = ReturnTotalRange_Server(sTimeScale)

            If nDisplayRange < nScaleSets Then
                nScaleSets = nDisplayRange
            Else
                If nDisplayRange < nMaxRange Then
                    nScaleSets = nDisplayRange
                Else
                    nScaleSets = nMaxRange
                End If
            End If

        End If

    End Sub
    Function ReturnTotalRange_Server(ByVal sTimeScale)

        Select Case (sTimeScale)
            Case "Years"
                ReturnTotalRange_Server = 10
            Case "Months"
                ReturnTotalRange_Server = 12
            Case "Days"
                ReturnTotalRange_Server = 31
            Case "Quarters"
                ReturnTotalRange_Server = 12
            Case Else
                ReturnTotalRange_Server = 12
        End Select

    End Function
    Public Function Build_PDF_Upgrade(ByVal amod_id As Integer, ByVal real_make_model_name As String) As String
        Build_PDF_Upgrade = ""
        Build_PDF_Upgrade = Build_PDF_Upgrade & ""
        Dim aMaxDate As Date


        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn2 As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand2 As New System.Data.SqlClient.SqlCommand
        Dim adoRs As System.Data.SqlClient.SqlDataReader : adoRs = Nothing
        Dim Query As String : Query = ""

        Try
            SqlConn2.ConnectionString = Session.Item("localPreferences").STARDatabaseConn
            SqlConn2.Open()

            SqlCommand2.Connection = SqlConn2
            SqlCommand2.CommandType = System.Data.CommandType.Text
            SqlCommand2.CommandTimeout = 60


            Build_PDF_Upgrade = Build_PDF_Upgrade & "<table align='center'><tr><td>" & real_make_model_name & " Upgrade To/From Path</font><br></td></tr></table>"

            ' check the request variables
            ' If (srID.Trim = "") Then
            'Build_PDF_Upgrade = Build_PDF_Upgrade & "We apologize for the inconvenience but we are unable to process your request at this time"
            '   Build_PDF_Upgrade = Build_PDF_Upgrade & "<br> Missing Star Report ID"
            '   Else
            If (amod_id = 0) Then
                Build_PDF_Upgrade = Build_PDF_Upgrade & "We apologize for the inconvenience but we are unable to process your request at this time"
                Build_PDF_Upgrade = Build_PDF_Upgrade & "<br> Missing Aircraft Model ID"
            Else
                ' set the amod_id


                ' create the query string
                Query = "SELECT MAX(ac1_start_date) AS ac1_start_date FROM dbo.Aircraft_1 WHERE (ac1_amod_id = '" + amod_id.ToString + "')"
                SqlCommand2.CommandText = Query
                adoRs = SqlCommand2.ExecuteReader() 'aDBconn.execute(Query) '

                If (adoRs.HasRows) Then
                    adoRs.Read()
                    If Not IsDBNull(adoRs.Item("ac1_start_date")) Then
                        aMaxDate = FormatDateTime(adoRs.Item("ac1_start_date").ToString, DateFormat.ShortDate)
                    End If
                    adoRs.Close()
                Else
                    aMaxDate = "that timeframe"
                    adoRs.Close()
                End If



            End If
            '  End If


            Build_PDF_Upgrade = Build_PDF_Upgrade & "<table cellspacing='0' cellpadding='2' align='center'  bgcolor='#ffffff'>"
            'Build_PDF_Upgrade = Build_PDF_Upgrade & "<tr><td align='center'>" & aMaxDate & "<img src='images/Star_Report_img.jpg' alt='' border='0'/></td></tr>"
            Build_PDF_Upgrade = Build_PDF_Upgrade & "<tr><td align='left'><i> <font size='-2'>Note that data in the reports on this page was compiled on " & aMaxDate & " and therefore may not be a direct match to live data summaries</i></font></font></td></tr></table>"
            ' Build_PDF_Upgrade = Build_PDF_Upgrade & "<tr><td align='center'>&nbsp;</td></tr></table>"



            Build_PDF_Upgrade = Build_PDF_Upgrade & "<table cellspacing='0' cellpadding='2'  align='center' border='1'><tr>"
            '' determine which report to display first based on the request variable for srID
            '' srID is star report ID i.e. aircraft_"X"
            ' display the aircraft_5 report 1st then the others

            Build_PDF_Upgrade = Build_PDF_Upgrade & displayAircraft_to_and_from_path(aMaxDate, amod_id)
            'bolAll = False
            ' display the aircraft_12 report 1st then the others
            'Call displayAircraft_12()


            'aDBconn.close()
            'aDBconn = Nothing

            '  Build_PDF_Upgrade = Build_PDF_Upgrade & "</td></tr></table></div></body>"

            '  Build_PDF_Upgrade = Build_PDF_Upgrade & "</div></body>"

        Catch Sqlex As SqlClient.SqlException
            Response.Write(Sqlex.Message)
        Finally
            SqlCommand2.Dispose()
            SqlConn2.Close()
            SqlConn2.Dispose()
        End Try


    End Function
    Public Function NEW_Build_PDF_Upgrade(ByVal amod_id As Integer, ByVal real_make_model_name As String, Optional ByVal viewHeader As Boolean = False, Optional ByRef maxDateReturn As String = "", Optional ByRef graph19 As String = "", Optional ByRef graph21 As String = "") As String
        NEW_Build_PDF_Upgrade = ""
        NEW_Build_PDF_Upgrade = NEW_Build_PDF_Upgrade & ""
        Dim aMaxDate As Date


        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn2 As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand2 As New System.Data.SqlClient.SqlCommand
        Dim adoRs As System.Data.SqlClient.SqlDataReader : adoRs = Nothing
        Dim Query As String : Query = ""

        Try
            SqlConn2.ConnectionString = Session.Item("localPreferences").STARDatabaseConn
            SqlConn2.Open()

            SqlCommand2.Connection = SqlConn2
            SqlCommand2.CommandType = System.Data.CommandType.Text
            SqlCommand2.CommandTimeout = 60


            'NEW_Build_PDF_Upgrade = NEW_Build_PDF_Upgrade & "<table align='center'><tr><td><font class='" & Session("FONT_CLASS_HEADER") & "'>" & real_make_model_name & " Upgrade To/From Path</font><br></td></tr></table>"

            ' check the request variables
            ' If (srID.Trim = "") Then
            'Build_PDF_Upgrade = Build_PDF_Upgrade & "We apologize for the inconvenience but we are unable to process your request at this time"
            '   Build_PDF_Upgrade = Build_PDF_Upgrade & "<br> Missing Star Report ID"
            '   Else
            If (amod_id = 0) Then
                NEW_Build_PDF_Upgrade = NEW_Build_PDF_Upgrade & "We apologize for the inconvenience but we are unable to process your request at this time"
                NEW_Build_PDF_Upgrade = NEW_Build_PDF_Upgrade & "<br> Missing Aircraft Model ID"
            Else
                ' set the amod_id


                ' create the query string
                ' CHANGED FROM aircraft 1 to aircraft 5 - dates were run on different days
                'Query = "SELECT MAX(ac1_start_date) AS ac1_start_date FROM dbo.Aircraft_1 WHERE (ac1_amod_id = '" + amod_id.ToString + "')"
                'SqlCommand2.CommandText = Query
                'adoRs = SqlCommand2.ExecuteReader() 'aDBconn.execute(Query) '

                'If (adoRs.HasRows) Then
                '    adoRs.Read()
                '    If Not IsDBNull(adoRs.Item("ac1_start_date")) Then
                '        aMaxDate = FormatDateTime(adoRs.Item("ac1_start_date").ToString, DateFormat.ShortDate)
                '        maxDateReturn = adoRs.Item("ac1_start_date").ToString
                '    End If
                '    adoRs.Close()
                'Else
                '    aMaxDate = "that timeframe"
                '    adoRs.Close()
                'End If

                Query = "SELECT MAX(ac5_start_date) AS ac5_start_date FROM dbo.Aircraft_5 WHERE (ac5_amod_id = '" + amod_id.ToString + "')"
                SqlCommand2.CommandText = Query
                adoRs = SqlCommand2.ExecuteReader() 'aDBconn.execute(Query) '

                If (adoRs.HasRows) Then
                    adoRs.Read()
                    If Not IsDBNull(adoRs.Item("ac5_start_date")) Then
                        aMaxDate = FormatDateTime(adoRs.Item("ac5_start_date").ToString, DateFormat.ShortDate)
                        maxDateReturn = adoRs.Item("ac5_start_date").ToString
                    End If
                    adoRs.Close()
                Else
                    aMaxDate = "that timeframe"
                    adoRs.Close()
                End If


            End If

            '  End If
            If viewHeader = True Then
                NEW_Build_PDF_Upgrade = NEW_Build_PDF_Upgrade & "<tr><td align='center' colspan='10'><font class='" & Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & real_make_model_name & "</strong> Owners will Most Likely Buy" & vbCrLf
                NEW_Build_PDF_Upgrade = NEW_Build_PDF_Upgrade & valueEmptyHeaderString & vbCrLf
                NEW_Build_PDF_Upgrade = NEW_Build_PDF_Upgrade & "</td></tr>"
            Else
                NEW_Build_PDF_Upgrade = NEW_Build_PDF_Upgrade & "<tr><td align='center colspan='10'><font class='" & Session("FONT_CLASS_HEADER") & "'>Upgrade To Path Model" & vbCrLf
                NEW_Build_PDF_Upgrade = NEW_Build_PDF_Upgrade & "<br>Based on End User Transactions" & vbCrLf
                NEW_Build_PDF_Upgrade = NEW_Build_PDF_Upgrade & "<br>" & real_make_model_name & vbCrLf
                NEW_Build_PDF_Upgrade = NEW_Build_PDF_Upgrade & "</td></tr>"
            End If

            NEW_Build_PDF_Upgrade = NEW_Build_PDF_Upgrade & "<tr><td align='center' colspan='10'>"
            NEW_Build_PDF_Upgrade = NEW_Build_PDF_Upgrade & "<br/><table cellspacing='0' width=""100%"" cellpadding='2' align='center'  bgcolor='#ffffff' class=""large formatTable"">"
            'Build_PDF_Upgrade = Build_PDF_Upgrade & "<tr><td align='center'>" & aMaxDate & "<img src='images/Star_Report_img.jpg' alt='' border='0'/></td></tr>"
            NEW_Build_PDF_Upgrade = NEW_Build_PDF_Upgrade & "<tr><td align='left'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><i> <font size='-2'>Note that data in the reports on this page was compiled on " & aMaxDate & " and therefore may not be a direct match to live data summaries</i></font></font></td></tr></table>"
            ' Build_PDF_Upgrade = Build_PDF_Upgrade & "<tr><td align='center'>&nbsp;</td></tr></table>"
            NEW_Build_PDF_Upgrade = NEW_Build_PDF_Upgrade & "</td></tr>"


            '' determine which report to display first based on the request variable for srID
            '' srID is star report ID i.e. aircraft_"X"
            ' display the aircraft_5 report 1st then the others

            NEW_Build_PDF_Upgrade = NEW_Build_PDF_Upgrade & NEW_displayAircraft_to_and_from_path(aMaxDate, amod_id, viewHeader, graph19, graph21)

            'bolAll = False
            ' display the aircraft_12 report 1st then the others
            'Call displayAircraft_12()


            'aDBconn.close()
            'aDBconn = Nothing

            '  Build_PDF_Upgrade = Build_PDF_Upgrade & "</td></tr></table></div></body>"

            '  Build_PDF_Upgrade = Build_PDF_Upgrade & "</div></body>"

        Catch Sqlex As SqlClient.SqlException
            Response.Write(Sqlex.Message)
        Finally
            SqlCommand2.Dispose()
            SqlConn2.Close()
            SqlConn2.Dispose()
        End Try


    End Function
    Function aircraft_sales_by_year(ByVal amod_id As Integer) As String
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn2 As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand2 As New System.Data.SqlClient.SqlCommand
        Dim adoRs As System.Data.SqlClient.SqlDataReader : adoRs = Nothing
        Dim Query As String : Query = ""
        Dim ac13_make As String = ""
        Dim ac13_model As String = ""
        aircraft_sales_by_year = ""
        Dim htmlOutput = ""
        Dim sUnknownString
        Dim rc As Integer = 1
        Dim aMaxDate As Date
        Dim first_time As Integer = 0
        Dim totals_row As String = ""
        Dim total_fleet As Integer = 0
        Dim total_fs As Integer = 0
        Dim percent_fs As Double = 0
        Dim average_asking As Integer = 0
        Dim high_asking As Integer = 0
        Dim low_asking As Integer = 0
        Dim average_asking_counter As Integer = 0
        Dim average_total_counter As Integer = 0
        Dim SqlException2 As System.Data.SqlClient.SqlException : SqlException2 = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim adors2 As System.Data.SqlClient.SqlDataReader : adors2 = Nothing
        Dim adoOwnerRs As New System.Data.SqlClient.SqlDataAdapter ': adoOwnerRs = Nothing
        Dim Query2 As String : Query2 = ""

        'Select Case Application.Item("webHostObject").evoWebHostType
        'Case eWebSiteTypes.LOCAL
        'SqlConn.ConnectionString = My.Settings.DEFAULT_LOCAL_MSSQL
        '  Case Else
        SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
        ' End Select

        SqlConn.Open()

        SqlCommand.Connection = SqlConn
        SqlCommand.CommandType = System.Data.CommandType.Text
        SqlCommand.CommandTimeout = 60
        SqlCommand.CommandText = Query
        sUnknownString = ""

        Try
            SqlConn2.ConnectionString = Session.Item("localPreferences").STARDatabaseConn
            SqlConn2.Open()

            SqlCommand2.Connection = SqlConn2
            SqlCommand2.CommandType = System.Data.CommandType.Text
            SqlCommand2.CommandTimeout = 60
        Catch Sqlex As SqlClient.SqlException
            Response.Write(Sqlex.Message)
        End Try

        Try
            Query = "SELECT MAX(ac1_start_date) AS ac1_start_date FROM dbo.Aircraft_1 WHERE (ac1_amod_id = '" + amod_id.ToString + "')"
            SqlCommand2.CommandText = Query
            adoRs = SqlCommand2.ExecuteReader() 'aDBconn.execute(Query) '

            If (adoRs.HasRows) Then
                adoRs.Read()
                If Not IsDBNull(adoRs.Item("ac1_start_date")) Then
                    aMaxDate = FormatDateTime(adoRs.Item("ac1_start_date").ToString, DateFormat.ShortDate)
                End If
                adoRs.Close()
            Else
                aMaxDate = "that timeframe"
                adoRs.Close()
            End If






            Query = "SELECT ac13_make, ac13_model, ac13_year_mfr, ac13_all_total_fleet, ac13_all_for_sale, ac13_all_percent_for_sale, ac13_all_average_asking_price,"
            Query = Query & " ac13_all_high_asking_price, ac13_all_low_asking_price, ac13_new_total_fleet, ac13_new_for_sale, ac13_new_percent_for_sale, ac13_new_average_asking_price,"
            Query = Query & " ac13_new_high_asking_price, ac13_new_low_asking_price, ac13_used_total_fleet, ac13_used_for_sale, ac13_used_percent_for_sale,"
            Query = Query & " ac13_used_average_asking_price, ac13_used_high_asking_price, ac13_used_low_asking_price"
            Query = Query & " FROM Aircraft_13 WITH(NOLOCK)"
            Query = Query & " WHERE (ac13_amod_id = " + amod_id.ToString + ") AND (ac13_start_date = '" & aMaxDate & "')"


            Query = Query & " ORDER BY ac13_start_date DESC, ac13_year_mfr"

            SqlCommand2.CommandText = Query
            adoRs = SqlCommand2.ExecuteReader()

            If (adoRs.HasRows) Then
                adoRs.Read()

                ac13_make = Server.HtmlEncode(adoRs("ac13_make") & "/")
                ac13_model = Server.HtmlEncode(adoRs("ac13_model")) & " "

                If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                    htmlOutput = "<table border='1' align='center' cellpadding='3' cellspacing='0' width='" & word_width & "'>"
                Else
                    htmlOutput = "<table border='1px' align='center' cellpadding='3' cellspacing='0' width='95%'>"
                End If

                htmlOutput = htmlOutput & "<tr><TH class='th_title' align='center' colspan='11'>" & ac13_make & ac13_model & vbCrLf
                htmlOutput = htmlOutput & "<br>Aircraft For Sale Statistics By Year of Manufacture" & vbCrLf
                htmlOutput = htmlOutput & "<br>(All/New/Used) - In Operation" & vbCrLf
                htmlOutput = htmlOutput & "</TH>" & vbCrLf
                'htmlOutput = htmlOutput & "<td class='th_title' colSpan='13'>&nbsp;</td>" & vbCrLf
                htmlOutput = htmlOutput & "</tr>" & vbCrLf
                htmlOutput = htmlOutput & "<TR align='center'>" & vbCrLf
                ' htmlOutput = htmlOutput & "<td class='lightcyan' colSpan='3'></td>" & vbCrLf
                htmlOutput = htmlOutput & "<TH class='separateheader' align='center'>&nbsp;</TH>" & vbCrLf
                htmlOutput = htmlOutput & "<TH class='th_title_details' colSpan='6'>All Aircraft</TH>" & vbCrLf
                htmlOutput = htmlOutput & "<TH class='separateheader'>&nbsp;</TH>" & vbCrLf
                'htmlOutput = htmlOutput & "<td class='lightcyan' colSpan='6'>New Aircraft</td>" & vbCrLf
                htmlOutput = htmlOutput & "<TH class='separateheader'>&nbsp;</TH>" & vbCrLf
                'htmlOutput = htmlOutput & "<td class='th_title_details' colSpan='6'>Used Aircraft</td>" & vbCrLf
                htmlOutput = htmlOutput & "</TR>" & vbCrLf

                htmlOutput = htmlOutput & "<TR>" & vbCrLf
                htmlOutput = htmlOutput & "<TH class='th_title_details' align='center'>Make</TH>" & vbCrLf
                htmlOutput = htmlOutput & "<TH class='th_title_details' align='center'>Model</TH>" & vbCrLf
                htmlOutput = htmlOutput & "<TH class='th_title_details' align='center'>Year<br>Of Mfr</TH>" & vbCrLf
                '  htmlOutput = htmlOutput & "<td class='separateheader'>&nbsp;</td>" & vbCrLf
                htmlOutput = htmlOutput & "<TH class='th_title_details' align='center'>Total<BR>Fleet</TH>" & vbCrLf
                htmlOutput = htmlOutput & "<TH class='th_title_details' align='center'>Number<BR>For Sale</TH>" & vbCrLf
                htmlOutput = htmlOutput & "<TH class='th_title_details' align='center'>Percent<BR>For Sale</TH>" & vbCrLf
                htmlOutput = htmlOutput & "<TH class='th_title_details' align='center'>Average<BR>Asking<BR>Price</TH>" & vbCrLf
                htmlOutput = htmlOutput & "<TH class='th_title_details' align='center'>High<BR>Asking<BR>Price</TH>" & vbCrLf
                htmlOutput = htmlOutput & "<TH class='th_title_details' align='center'>Low<BR>Asking<BR>Price</TH>" & vbCrLf
                'htmlOutput = htmlOutput & "<td class='separateheader'>&nbsp;</td>" & vbCrLf
                'htmlOutput = htmlOutput & "<td class='th_title_details' align='center'>Total<BR>Fleet</td>" & vbCrLf
                'htmlOutput = htmlOutput & "<td class='th_title_details' align='center'>Number<BR>For Sale</td>" & vbCrLf
                'htmlOutput = htmlOutput & "<td class='th_title_details' align='center'>Percent<BR>For Sale</td>" & vbCrLf
                'htmlOutput = htmlOutput & "<td class='th_title_details' align='center'>Average<BR>Asking<BR>Price</td>" & vbCrLf
                'htmlOutput = htmlOutput & "<td class='th_title_details' align='center'>High<BR>Asking<BR>Price</td>" & vbCrLf
                'htmlOutput = htmlOutput & "<td class='th_title_details' align='center'>Low<BR>Asking<BR>Price</td>" & vbCrLf
                'htmlOutput = htmlOutput & "<td class='separateheader'>&nbsp;</td>" & vbCrLf
                'htmlOutput = htmlOutput & "<td class='th_title_details' align='center'>Total<BR>Fleet</td>" & vbCrLf
                'htmlOutput = htmlOutput & "<td class='th_title_details' align='center'>Number<BR>For Sale</td>" & vbCrLf
                'htmlOutput = htmlOutput & "<td class='th_title_details' align='center'>Percent<BR>For Sale</td>" & vbCrLf
                'htmlOutput = htmlOutput & "<td class='th_title_details' align='center'>Average<BR>Asking<BR>Price</td>" & vbCrLf
                'htmlOutput = htmlOutput & "<td class='th_title_details' align='center'>High<BR>Asking<BR>Price</td>" & vbCrLf
                'htmlOutput = htmlOutput & "<td class='th_title_details' align='center'>Low<BR>Asking<BR>Price</td>" & vbCrLf
                htmlOutput = htmlOutput & "</TR>" & vbCrLf
                rc = 25
                htmlOutput = htmlOutput & "<TR>" & vbCrLf
                htmlOutput = htmlOutput & "<TH class='beige' title='Make' vAlign='center' noWrap align='center' rowSpan='" & rc & "'>" & Trim(Replace(ac13_make, "/", "")) & "</TH>" & vbCrLf
                htmlOutput = htmlOutput & "<TH class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac13_year_mfr")) & " Model' vAlign='center' noWrap align='center' rowSpan='" & rc & "'>" & Trim(ac13_model) & "</TH>" & vbCrLf
                htmlOutput = htmlOutput & "<td class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac13_year_mfr")) & " Year Of Manufacture' vAlign='center' noWrap align='center'>" & Trim(adoRs("ac13_year_mfr")) & "</td>" & vbCrLf
                '  htmlOutput = htmlOutput & "<td class='separateheader'>&nbsp;</td>" & vbCrLf


                If adoRs("ac13_all_total_fleet") = 0 Then
                    htmlOutput = htmlOutput & "<TD class='blankline' align='right' colSpan='6'>&nbsp;</TD>" & vbCrLf
                Else
                    htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac13_year_mfr")) & " - Total Active Fleet - All Aircraft' align='right'>" & adoRs("ac13_all_total_fleet") & "</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac13_year_mfr")) & " - Total Active Fleet For Sale - All Aircraft' align='right'>" & adoRs("ac13_all_for_sale") & "</TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac13_year_mfr")) & " - Percent Of Active Flag For Sale - All Aircrdaft' align='right'>" & adoRs("ac13_all_percent_for_sale") & "%</TD>" & vbCrLf

                    total_fleet = total_fleet + adoRs("ac13_all_total_fleet")
                    total_fs = total_fs + adoRs("ac13_all_for_sale")


                    If adoRs("ac13_all_average_asking_price") = 0 Then
                        htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac13_year_mfr")) & " - Average Asking Price - All Aircraft' align='right'>N/A</TD>" & vbCrLf
                    Else
                        htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac13_year_mfr")) & " - Average Asking Price - All Aircraft' align='right'>$" & FormatNumber(adoRs("ac13_all_average_asking_price"), 0) & "</TD>" & vbCrLf
                    End If

                    If adoRs("ac13_all_high_asking_price") = 0 Then
                        htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac13_year_mfr")) & " - High Asking Price - All Aircraft' align='right'>N/A</TD>" & vbCrLf
                    Else
                        htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac13_year_mfr")) & " - High Asking Price - All Aircraft' align='right'>$" & FormatNumber(adoRs("ac13_all_high_asking_price"), 0) & "</TD>" & vbCrLf
                        If FormatNumber(adoRs("ac13_all_high_asking_price"), 0) > high_asking Then
                            high_asking = FormatNumber(adoRs("ac13_all_high_asking_price"), 0)
                        End If
                    End If

                    If adoRs("ac13_all_low_asking_price") = 0 Then
                        htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac13_year_mfr")) & " - High Asking Price - All Aircraft' align='right'>N/A</TD>" & vbCrLf
                    Else
                        htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac13_year_mfr")) & " - Low Asking Price - All Aircraft' align='right'>$" & FormatNumber(adoRs("ac13_all_low_asking_price"), 0) & "</TD>" & vbCrLf
                        If FormatNumber(adoRs("ac13_all_low_asking_price"), 0) < low_asking Then
                            low_asking = FormatNumber(adoRs("ac13_all_low_asking_price"), 0)
                        ElseIf (low_asking = 0) Then
                            low_asking = FormatNumber(adoRs("ac13_all_low_asking_price"), 0)
                        End If
                    End If

                    htmlOutput = htmlOutput & "</tr>"

                End If

            End If
            Do While adoRs.Read

                htmlOutput = htmlOutput & "<tr>"

                If LCase(Trim(adoRs("ac13_year_mfr"))) <> LCase("ALL") Then

                    'Response.write("MFR YR VAL " & trim(rs("ac13_year_mfr").Value) & "<br>")

                    htmlOutput = htmlOutput & "<td class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac13_year_mfr")) & " Year Of Manufacture' vAlign='center' noWrap align='center'>" & Trim(adoRs("ac13_year_mfr")) & "</td>" & vbCrLf
                    '  htmlOutput = htmlOutput & "<td class='separateheader'>&nbsp;</td>" & vbCrLf


                    If adoRs("ac13_all_total_fleet") = 0 Then
                        htmlOutput = htmlOutput & "<TD class='blankline' align='right' colSpan='6'>&nbsp;</TD>" & vbCrLf
                    Else
                        htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac13_year_mfr")) & " - Total Active Fleet - All Aircraft' align='right'>" & adoRs("ac13_all_total_fleet") & "</TD>" & vbCrLf
                        htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac13_year_mfr")) & " - Total Active Fleet For Sale - All Aircraft' align='right'>" & adoRs("ac13_all_for_sale") & "</TD>" & vbCrLf
                        htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac13_year_mfr")) & " - Percent Of Active Flag For Sale - All Aircrdaft' align='right'>" & adoRs("ac13_all_percent_for_sale") & "%</TD>" & vbCrLf

                        total_fleet = total_fleet + adoRs("ac13_all_total_fleet")
                        total_fs = total_fs + adoRs("ac13_all_for_sale")

                        If adoRs("ac13_all_average_asking_price") = 0 Then
                            htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac13_year_mfr")) & " - Average Asking Price - All Aircraft' align='right'>N/A</TD>" & vbCrLf
                        Else
                            htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac13_year_mfr")) & " - Average Asking Price - All Aircraft' align='right'>$" & FormatNumber(adoRs("ac13_all_average_asking_price"), 0) & "</TD>" & vbCrLf
                        End If

                        If adoRs("ac13_all_high_asking_price") = 0 Then
                            htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac13_year_mfr")) & " - High Asking Price - All Aircraft' align='right'>N/A</TD>" & vbCrLf
                        Else
                            htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac13_year_mfr")) & " - High Asking Price - All Aircraft' align='right'>$" & FormatNumber(adoRs("ac13_all_high_asking_price"), 0) & "</TD>" & vbCrLf
                            If FormatNumber(adoRs("ac13_all_high_asking_price"), 0) > high_asking Then
                                high_asking = FormatNumber(adoRs("ac13_all_high_asking_price"), 0)
                            End If
                        End If

                        If adoRs("ac13_all_low_asking_price") = 0 Then
                            htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac13_year_mfr")) & " - High Asking Price - All Aircraft' align='right'>N/A</TD>" & vbCrLf
                        Else
                            htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac13_year_mfr")) & " - Low Asking Price - All Aircraft' align='right'>$" & FormatNumber(adoRs("ac13_all_low_asking_price"), 0) & "</TD>" & vbCrLf
                            If FormatNumber(adoRs("ac13_all_low_asking_price"), 0) < low_asking Then
                                low_asking = FormatNumber(adoRs("ac13_all_low_asking_price"), 0)
                            ElseIf (low_asking = 0) Then
                                low_asking = FormatNumber(adoRs("ac13_all_low_asking_price"), 0)
                            End If
                        End If




                    End If
                    percent_fs = (total_fs / total_fleet) * 100
                    percent_fs = FormatNumber(percent_fs, 3)


                End If


                htmlOutput = htmlOutput & "</tr>"
            Loop

            adoRs.Close()

            Query2 = "select ac_journ_id, ac_asking_price, ac_amod_id, amod_id from Aircraft_Model, Aircraft where ac_amod_id = '" + amod_id.ToString + "' and ac_amod_id = amod_id and ac_journ_id = 0 and ac_asking_price > 0"
            SqlCommand.CommandText = Query2
            adors2 = SqlCommand.ExecuteReader() 'aDBconn.execute(Query) '

            If (adors2.HasRows) Then
                'adoRs.Read()
                Do While adors2.Read()
                    average_total_counter = average_total_counter + adors2("ac_asking_price")
                    average_asking_counter = average_asking_counter + 1
                Loop

                'adoRs.Close()
            Else
                adors2.Close()
            End If

            If average_total_counter > 0 And average_asking_counter > 0 Then
                average_asking = (average_total_counter / average_asking_counter)
            End If

            htmlOutput = htmlOutput & "<TR>" & vbCrLf
            htmlOutput = htmlOutput & "<TD>Totals: </TD>" & vbCrLf
            htmlOutput = htmlOutput & "<TD class='th_title_details' title='Total Active Fleet - All Aircraft' align='right'>" & total_fleet & "</TD>" & vbCrLf
            htmlOutput = htmlOutput & "<TD class='th_title_details' title='Total Active Fleet For Sale - All Aircraft' align='right'>" & total_fs & "</TD>" & vbCrLf
            htmlOutput = htmlOutput & "<TD class='th_title_details' title='Percent Of Active Flag For Sale - All Aircrdaft' align='right'>" & percent_fs & "%</TD>" & vbCrLf
            htmlOutput = htmlOutput & "<TD class='th_title_details' title='Average Asking Price - New Aircraft' align='right'>$" & FormatNumber(average_asking, 0) & "</TD>" & vbCrLf
            htmlOutput = htmlOutput & "<TD class='th_title_details' title='High Asking Price - All Aircraft' align='right'>$" & FormatNumber(high_asking, 0) & "</TD>" & vbCrLf
            htmlOutput = htmlOutput & "<TD class='th_title_details' title='Low Asking Price - All Aircraft' align='right'>$" & FormatNumber(low_asking, 0) & "</TD>" & vbCrLf
            htmlOutput = htmlOutput & "</TR>" & vbCrLf
            htmlOutput = htmlOutput & "</table>"
            '------------------------------------------------------------------- totals section

            aircraft_sales_by_year = htmlOutput


        Catch Sqlex As SqlClient.SqlException
            Response.Write(Sqlex.Message)
        Finally
            SqlCommand2.Dispose()
            SqlConn2.Close()
            SqlConn2.Dispose()
        End Try
    End Function

    Public Function display_avg_price_by_month_graph(ByVal inModelID As Long, ByVal graphID As DataVisualization.Charting.Chart, ByVal days As Long, ByVal months As Long, ByRef searchCriteria As viewSelectionCriteriaClass, ByRef graph_string As String) As String

        Dim htmlOutput As String = ""
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim adoRSAircraft As System.Data.SqlClient.SqlDataReader : adoRSAircraft = Nothing
        Dim outstring As String = ""
        Dim x As Integer = 0
        Dim nRememberSQLTimeout As Integer = 0
        Dim adUseClient As Integer = 0
        Dim adUseServer As Integer = 0
        'Dim adoRs = Nothing
        Dim this_counter As Integer = 1
        Dim high_number As Integer = 0
        Dim low_number As Integer = 100000000
        Dim starting_point As Integer = 0
        Dim interval_point As Integer = 1
        Dim type_of_subscription As String = ""
        Dim ending_point As Integer = 0
        Dim temp_average As Double = 0.0
        Dim market_functions As New market_model_functions
        Dim results_table As New DataTable

        outstring = ""
        display_avg_price_by_month_graph = ""
        x = 0
        Try
            market_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            market_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            market_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            market_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            market_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

            results_table = market_functions.get_avg_price_by_month_info(searchCriteria)


            'query = "SELECT DISTINCT mtrend_year, mtrend_month, mtrend_total_aircraft_for_sale, mtrend_avg_asking_price"
            'query = query & " FROM Aircraft_Model_Trend WITH(NOLOCK) WHERE mtrend_amod_id = " & CStr(inModelID)
            ''query = query & " AND (( mtrend_year = year(getdate()-" & days & ") AND mtrend_month >= month(getdate()-" & days & ") ) OR"
            ''query = query & " ( mtrend_year = year(getdate()) AND mtrend_month <= month(getdate()) ))"
            'query = query & "and "


            'query = query & "(((mtrend_year >= year(CONVERT(DATETIME, '" + DateAdd("m", (-1) * months, Now()).ToString + "',102)))"
            'query = query & (Constants.cAndClause & "(mtrend_month >= month(CONVERT(DATETIME, '" + DateAdd("m", (-1) * months, Now()).ToString + "',102))))")


            'Dim sClause As String = ""
            'If Year(DateAdd("m", (-1) * months, Now())) <> Year(Now()) Then
            '  sClause = " OR "
            'Else
            '  sClause = " AND "
            'End If

            'query = query & (sClause & "((mtrend_year = year(CONVERT(DATETIME, '" + Now.ToString + "',102)))" + Constants.cAndClause + "(mtrend_month <= month(CONVERT(DATETIME, '" + Now.ToString + "',102)))))")


            ''query = query & "("
            ''query = query & "(mtrend_year = year(getdate()-" & days & ") AND mtrend_month >= month(getdate()-" & days & ")) "
            ''query = query & "or "
            ''query = query & "(mtrend_year > year(getdate()-" & days & ") and mtrend_year < year(getdate()))"
            ''query = query & "or "
            ''query = query & "(mtrend_year = year(getdate()) AND mtrend_month <= month(getdate()))"
            ''query = query & ")"



            'If Not IsNothing(Session.Item("localSubscription").crmBusiness_Flag) Then
            '  If Session.Item("localSubscription").crmBusiness_Flag = True Then
            '    type_of_subscription = "B"
            '  ElseIf Session.Item("localSubscription").crmCommercial_Flag = True Then
            '    type_of_subscription = "C"
            '  ElseIf Session.Item("localSubscription").crmHelicopter_Flag = True Then
            '    type_of_subscription = "H"
            '  Else
            '    type_of_subscription = "B"
            '  End If

            '  query = query & " and mtrend_product_type = '" & type_of_subscription & "' "
            'End If

            'query = query & " ORDER BY mtrend_year ASC, mtrend_month ASC"

            ''Select Case Application.Item("webHostObject").evoWebHostType
            ''Case eWebSiteTypes.LOCAL
            ''SqlConn.ConnectionString = My.Settings.DEFAULT_LOCAL_MSSQL
            ''Case Else
            'SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            '' End Select

            '' End Select
            'SqlConn.Open()

            'SqlCommand.Connection = SqlConn
            'SqlCommand.CommandType = System.Data.CommandType.Text
            'SqlCommand.CommandTimeout = 60
            'SqlCommand.CommandText = query

            'adoRs = SqlCommand.ExecuteReader()


            If results_table.Rows.Count > 0 Then
                Me.AVG_PRICE_MONTH.Series.Clear()
                Me.AVG_PRICE_MONTH.Series.Add("AVG_PRICE").ChartType = UI.DataVisualization.Charting.SeriesChartType.Spline
                Me.AVG_PRICE_MONTH.Series("AVG_PRICE").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32
                Me.AVG_PRICE_MONTH.Series("AVG_PRICE").LabelForeColor = Drawing.Color.Blue
                Me.AVG_PRICE_MONTH.ChartAreas("ChartArea1").AxisY.Title = "Average Asking Price - US $"
                Me.AVG_PRICE_MONTH.Series("AVG_PRICE").Color = Drawing.Color.Blue
                Me.AVG_PRICE_MONTH.Series("AVG_PRICE").BorderWidth = 2
                Me.AVG_PRICE_MONTH.Series("AVG_PRICE").MarkerSize = 5
                Me.AVG_PRICE_MONTH.Series("AVG_PRICE").MarkerStyle = UI.DataVisualization.Charting.MarkerStyle.Circle
                '  Me.AVG_PRICE_MONTH.BorderlineWidth = 10
                Me.AVG_PRICE_MONTH.Series("AVG_PRICE").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32
                'Me.AVG_PRICE_MONTH.Series("AVG_PRICE").SmartLabelStyle.Enabled = False
                'Me.AVG_PRICE_MONTH.Series("AVG_PRICE").LabelAngle = 45

                If Trim(Request("new_PDF")) = "Y" Then
                    If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                        Me.AVG_PRICE_MONTH.Width = 250
                        Me.AVG_PRICE_MONTH.Height = 215
                    Else
                        Me.AVG_PRICE_MONTH.Width = 475
                        Me.AVG_PRICE_MONTH.Height = 325
                    End If
                Else
                    If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                        Me.AVG_PRICE_MONTH.Width = 250
                        Me.AVG_PRICE_MONTH.Height = 215
                    End If
                End If


                For Each adoRs As DataRow In results_table.Rows
                    If Not IsDBNull(adoRs("mtrend_year")) Then
                        If adoRs("mtrend_year").ToString <> "" Then
                            If Not IsDBNull(adoRs("mtrend_month")) Then
                                If adoRs("mtrend_month").ToString <> "" Then
                                    this_counter = adoRs("mtrend_year")
                                    'outstring = outstring & " data.setValue(" & x & ", 0, '" & CStr(adoRs("mtrend_month")) & "-" & CStr(adoRs("mtrend_year")) & "');" & vbCrLf
                                    If Not IsDBNull(adoRs("avgPrice")) Then
                                        If CDbl(adoRs("avgPrice")) > 0 Then


                                            temp_average = CDbl(adoRs("avgPrice").ToString)
                                            If temp_average > 0 Then
                                                temp_average = CDbl(temp_average / 1000)
                                            End If

                                            If CDbl(temp_average) > high_number Then
                                                high_number = temp_average
                                            End If
                                            If CDbl(temp_average) < low_number Then
                                                low_number = temp_average
                                            End If

                                            If Trim(graph_string) <> "" Then
                                                graph_string &= ", "
                                            End If
                                            graph_string += "['" & (adoRs("mtrend_month") & "-" & adoRs("mtrend_year")) & "'," & temp_average & " ]"

                                            Me.AVG_PRICE_MONTH.Series("AVG_PRICE").Points.AddXY((adoRs("mtrend_month") & "-" & adoRs("mtrend_year")), temp_average)
                                            '   Me.AVG_PRICE_MONTH.Series("AVG_PRICE").Points.Item(x).Label = adoRs("mtrend_avg_asking_price")

                                            'outstring = outstring & " data.setValue(" & x & ", 1, " & Format(adoRs("mtrend_avg_asking_price"), 2) & ");" & vbCrLf
                                        Else
                                            'outstring = outstring & " data.setValue(" & x & ", 1, 0);" & vbCrLf
                                        End If
                                    Else
                                        'outstring = outstring & " data.setValue(" & x & ", 1, 0);" & vbCrLf
                                    End If
                                    x = x + 1
                                End If
                            End If
                        End If
                    End If

                Next


                commonEvo.set_ranges_for_vsCharts(low_number, high_number, interval_point, starting_point, ending_point)

                AVG_PRICE_MONTH.ChartAreas("ChartArea1").AxisY.Maximum = ending_point
                AVG_PRICE_MONTH.ChartAreas("ChartArea1").AxisY.Minimum = IIf(starting_point > 0, starting_point, 0)
                AVG_PRICE_MONTH.ChartAreas("ChartArea1").AxisY.Interval = interval_point

            Else
                outstring = ""
            End If

            If IsNumeric(forsaleavg) = True Then
                If forsaleavg > 0 Then
                    If Trim(graph_string) <> "" Then
                        graph_string &= ", "
                    End If
                    graph_string += "['" & (Month(Date.Now()) & "-" & Year(Date.Now())) & "'," & forsaleavg & " ]"

                End If
            End If


            graph_string = " data15.addColumn('string', 'Month/Year'); data15.addColumn('number', 'Average'); data15.addRows([ " & graph_string


            outstring = "Avg Price By Month (past " & months & " months)"


            display_avg_price_by_month_graph = Trim(outstring)
        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function

    Public Function display_avg_price_by_month_graph_compare(ByVal inModelID, ByVal months) As String

        Dim htmlOutput As String = ""
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim adoRSAircraft As System.Data.SqlClient.SqlDataReader : adoRSAircraft = Nothing
        Dim outstring, query, x
        Dim nRememberSQLTimeout As Integer = 0
        Dim adUseClient As Integer = 0
        Dim adUseServer As Integer = 0
        Dim adoRs = Nothing
        Dim this_counter As Integer = 1
        Dim high_number As Integer = 0
        Dim low_number As Integer = 100000000
        Dim starting_point As Integer = 0
        Dim interval_point As Integer = 1
        Dim sized_down_number As Double = 0
        outstring = ""
        display_avg_price_by_month_graph_compare = ""
        x = 0


        Try


            query = "SELECT DISTINCT mtrend_year, mtrend_month, mtrend_total_aircraft_for_sale, mtrend_avg_asking_price"
            query = query & " FROM Aircraft_Model_Trend WITH(NOLOCK) WHERE mtrend_amod_id = " & CStr(inModelID)

            '  query = query & " AND (( mtrend_year = year(getdate()-182) AND mtrend_month >= month(getdate()-182) ) OR"
            ' query = query & " ( mtrend_year = year(getdate()) AND mtrend_month <= month(getdate()) ))"

            '
            query = query & " AND (((mtrend_year = '" & Year(DateAdd("m", (-1) * months, Now)) & "')"
            query = query & " AND (mtrend_month < '" & Month(Now) & "' and mtrend_month > '" & Month(Now) - months - 1 & "')) "
            query = query & " OR (mtrend_year = '" & Year(DateAdd("m", (-1) * months, Now)) - 1 & "')"
            query = query & " AND (mtrend_month > '" & Month(Now) + months & "'))"
            ' query = query & " OR "

            query = query & " ORDER BY mtrend_year ASC, mtrend_month ASC"

            'Select Case Application.Item("webHostObject").evoWebHostType
            'Case eWebSiteTypes.LOCAL
            'SqlConn.ConnectionString = My.Settings.DEFAULT_LOCAL_MSSQL
            '  Case Else
            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            ' End Select

            ' End Select
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = query

            adoRs = SqlCommand.ExecuteReader()


            If adoRs.HasRows Then
                Me.AVG_PRICE_MONTH.Series.Clear()
                Me.AVG_PRICE_MONTH.Series.Add("AVG_PRICE").ChartType = UI.DataVisualization.Charting.SeriesChartType.Spline
                Me.AVG_PRICE_MONTH.Series("AVG_PRICE").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32
                Me.AVG_PRICE_MONTH.Series("AVG_PRICE").LabelForeColor = Drawing.Color.Blue
                Me.AVG_PRICE_MONTH.ChartAreas("ChartArea1").AxisY.Title = "Average Asking Price - US $"
                Me.AVG_PRICE_MONTH.Series("AVG_PRICE").Color = Drawing.Color.Blue
                Me.AVG_PRICE_MONTH.Series("AVG_PRICE").BorderWidth = 2
                Me.AVG_PRICE_MONTH.Series("AVG_PRICE").MarkerSize = 6
                Me.AVG_PRICE_MONTH.Series("AVG_PRICE").MarkerStyle = UI.DataVisualization.Charting.MarkerStyle.Circle
                '  Me.AVG_PRICE_MONTH.BorderlineWidth = 10
                Me.AVG_PRICE_MONTH.Series("AVG_PRICE").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32
                'Me.AVG_PRICE_MONTH.Series("AVG_PRICE").SmartLabelStyle.Enabled = False
                'Me.AVG_PRICE_MONTH.Series("AVG_PRICE").LabelAngle = 45
                If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                    Me.AVG_PRICE_MONTH.Width = 250
                    Me.AVG_PRICE_MONTH.Height = 250
                End If

                Do While adoRs.Read
                    If Not IsDBNull(adoRs("mtrend_year")) Then
                        If adoRs("mtrend_year").ToString <> "" Then
                            If Not IsDBNull(adoRs("mtrend_month")) Then
                                If adoRs("mtrend_month").ToString <> "" Then
                                    this_counter = adoRs("mtrend_year")
                                    'outstring = outstring & " data.setValue(" & x & ", 0, '" & CStr(adoRs("mtrend_month")) & "-" & CStr(adoRs("mtrend_year")) & "');" & vbCrLf
                                    If Not IsDBNull(adoRs("mtrend_avg_asking_price")) Then
                                        If CDbl(adoRs("mtrend_avg_asking_price")) >= 0 Then

                                            sized_down_number = (adoRs("mtrend_avg_asking_price") / 1000)

                                            If CDbl(sized_down_number) > high_number Then
                                                high_number = sized_down_number
                                            End If
                                            If CDbl(sized_down_number) < low_number Then
                                                low_number = sized_down_number
                                            End If


                                            Me.AVG_PRICE_MONTH.Series("AVG_PRICE").Points.AddXY((adoRs("mtrend_month") & "-" & adoRs("mtrend_year")), sized_down_number)

                                            '   Me.AVG_PRICE_MONTH.Series("AVG_PRICE").Points.Item(x).Label = adoRs("mtrend_avg_asking_price")

                                            'outstring = outstring & " data.setValue(" & x & ", 1, " & Format(adoRs("mtrend_avg_asking_price"), 2) & ");" & vbCrLf
                                        Else
                                            'outstring = outstring & " data.setValue(" & x & ", 1, 0);" & vbCrLf
                                        End If
                                    Else
                                        'outstring = outstring & " data.setValue(" & x & ", 1, 0);" & vbCrLf
                                    End If
                                    x = x + 1
                                End If
                            End If
                        End If
                    End If

                Loop


                If high_number - low_number > 1000 And high_number - low_number < 10000 Then ' one million - count by 500 thousand
                    interval_point = 500
                    starting_point = (low_number / interval_point) - 1
                    starting_point = starting_point * interval_point
                ElseIf high_number - low_number > 10000 And high_number - low_number < 50000 Then ' ten million to 50 million count by 5 million
                    interval_point = 5000
                    starting_point = (low_number / interval_point) - 1
                    starting_point = starting_point * interval_point
                ElseIf high_number - low_number > 50000 Then ' gap greater then 50 million count by 10 million
                    interval_point = 10000
                    starting_point = (low_number / interval_point) - 1
                    starting_point = starting_point * interval_point
                ElseIf high_number - low_number < 100 Then ' one hundred thousand - count by 10 thousand 
                    interval_point = 10
                    starting_point = (low_number / interval_point) - 1
                    starting_point = starting_point * interval_point
                Else
                    interval_point = 200   ' inbetween 100 thousand and one million gap  - to be determined later
                    starting_point = (low_number / interval_point) - 1
                    starting_point = starting_point * interval_point
                End If

                'If high_number - low_number > 1000000 And high_number - low_number < 10000000 Then ' one million - count by 500 thousand
                '    interval_point = 500000
                '    starting_point = (low_number / interval_point) - 1
                '    starting_point = starting_point * interval_point
                'ElseIf high_number - low_number > 10000000 And high_number - low_number < 50000000 Then ' ten million to 50 million count by 5 million
                '    interval_point = 5000000
                '    starting_point = (low_number / interval_point) - 1
                '    starting_point = starting_point * interval_point
                'ElseIf high_number - low_number > 50000000 Then ' gap greater then 50 million count by 10 million
                '    interval_point = 10000000
                '    starting_point = (low_number / interval_point) - 1
                '    starting_point = starting_point * interval_point
                'ElseIf high_number - low_number < 100000 Then ' one hundred thousand - count by 10 thousand 
                '    interval_point = 10000
                '    starting_point = (low_number / interval_point) - 1
                '    starting_point = starting_point * interval_point
                'Else
                '    interval_point = 200000   ' inbetween 100 thousand and one million gap  - to be determined later
                '    starting_point = (low_number / interval_point) - 1
                '    starting_point = starting_point * interval_point
                'End If

                If high_number = 0 And low_number = 0 Then
                    Me.AVG_PRICE_MONTH.ChartAreas("ChartArea1").AxisY.Maximum = 1
                    Me.AVG_PRICE_MONTH.ChartAreas("ChartArea1").AxisY.Minimum = 0
                    Me.AVG_PRICE_MONTH.ChartAreas("ChartArea1").AxisY.Interval = 1
                Else
                    Me.AVG_PRICE_MONTH.ChartAreas("ChartArea1").AxisY.Maximum = high_number + interval_point

                    If low_number = 0 Then
                        Me.AVG_PRICE_MONTH.ChartAreas("ChartArea1").AxisY.Minimum = 0
                    Else
                        Me.AVG_PRICE_MONTH.ChartAreas("ChartArea1").AxisY.Minimum = starting_point
                    End If
                    Me.AVG_PRICE_MONTH.ChartAreas("ChartArea1").AxisY.Interval = interval_point

                    Me.AVG_PRICE_MONTH.ChartAreas("ChartArea1").AxisY.LabelStyle.Format = "#,###"
                End If

                'Me.AVG_PRICE_MONTH.ChartAreas("ChartArea1").AxisY.Minimum = 0

            Else
                outstring = ""
            End If

            outstring = "Avg Price By Month in Thousands (past 6 months)"


            display_avg_price_by_month_graph_compare = Trim(outstring)
        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function

    Public Function display_for_sale_by_month_graph(ByVal inModelID As Long, ByVal graphID As DataVisualization.Charting.Chart, ByVal days As Long, ByVal months As Long, ByVal searchCriteria As viewSelectionCriteriaClass, ByRef graph_string As String) As String

        Dim htmlOutput As String = ""
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim adoRSAircraft As System.Data.SqlClient.SqlDataReader : adoRSAircraft = Nothing
        Dim outstring As String = ""
        Dim x As Integer = 0
        Dim nRememberSQLTimeout As Integer = 0
        Dim adUseClient As Integer = 0
        Dim adUseServer As Integer = 0
        Dim high_number As Integer = 0
        Dim low_number As Integer = 100000000
        Dim starting_point As Integer = 0
        Dim interval_point As Integer = 1
        Dim type_of_subscription As String = ""
        Dim results_table As New DataTable
        Dim market_functions As New market_model_functions

        outstring = ""
        display_for_sale_by_month_graph = ""
        x = 0
        Try
            market_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            market_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            market_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            market_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            market_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

            'query = "SELECT DISTINCT mtrend_year, mtrend_month, mtrend_total_aircraft_for_sale"
            'query = query & " FROM Aircraft_Model_Trend WITH(NOLOCK) WHERE mtrend_amod_id = " & CStr(inModelID)
            ''  query = query & " AND ( (mtrend_year = year(getdate()-" & days & ") AND mtrend_month >= month(getdate()-" & days & ")) OR"
            ''  query = query & " (mtrend_year = year(getdate()) AND mtrend_month <= month(getdate())) )"
            'query = query & "and "
            'query = query & "("
            'query = query & "(mtrend_year = year(getdate()-" & days & ") AND mtrend_month >= month(getdate()-" & days & ")) "
            'query = query & "or "
            'query = query & "(mtrend_year > year(getdate()-" & days & ") and mtrend_year < year(getdate()))"
            'query = query & "or "
            'query = query & "(mtrend_year = year(getdate()) AND mtrend_month <= month(getdate()))"
            'query = query & ")"

            'If Not IsNothing(Session.Item("localSubscription").crmBusiness_Flag) Then
            '  If Session.Item("localSubscription").crmBusiness_Flag = True Then
            '    type_of_subscription = "B"
            '  ElseIf Session.Item("localSubscription").crmCommercial_Flag = True Then
            '    type_of_subscription = "C"
            '  ElseIf Session.Item("localSubscription").crmHelicopter_Flag = True Then
            '    type_of_subscription = "H"
            '  Else
            '    type_of_subscription = "B"
            '  End If

            '  query = query & " and mtrend_product_type = '" & type_of_subscription & "' "
            'End If

            'query = query & " ORDER BY mtrend_year ASC, mtrend_month ASC"

            ''Select Case Application.Item("webHostObject").evoWebHostType
            ''Case eWebSiteTypes.LOCAL
            ''SqlConn.ConnectionString = My.Settings.DEFAULT_LOCAL_MSSQL
            ''  Case Else
            'SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            ''  End Select

            '' End Select
            'SqlConn.Open()

            'SqlCommand.Connection = SqlConn
            'SqlCommand.CommandType = System.Data.CommandType.Text
            'SqlCommand.CommandTimeout = 60
            'SqlCommand.CommandText = query

            'adoRs = SqlCommand.ExecuteReader()


            results_table = market_functions.get_for_sale_by_month_info(localCriteria)

            If Not IsNothing(results_table) Then

                If results_table.Rows.Count > 0 Then


                    Me.FOR_SALE.Series.Add("FOR_SALE")
                    Me.FOR_SALE.Series("FOR_SALE").ChartType = UI.DataVisualization.Charting.SeriesChartType.Spline
                    Me.FOR_SALE.ChartAreas("ChartArea1").AxisY.Title = "Aircraft For Sale"

                    Me.FOR_SALE.Series("FOR_SALE").Color = Drawing.Color.Blue
                    Me.FOR_SALE.Series("FOR_SALE").BorderWidth = 1
                    Me.FOR_SALE.Series("FOR_SALE").MarkerSize = 5
                    Me.FOR_SALE.Series("FOR_SALE").MarkerStyle = UI.DataVisualization.Charting.MarkerStyle.Circle
                    Me.FOR_SALE.BorderlineWidth = 10
                    Me.FOR_SALE.Series("FOR_SALE").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32

                    If Trim(Request("new_PDF")) = "Y" Then
                        If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                            Me.FOR_SALE.Width = 250
                            Me.FOR_SALE.Height = 215
                        Else
                            Me.FOR_SALE.Width = 475
                            Me.FOR_SALE.Height = 325
                        End If
                    Else
                        If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                            Me.FOR_SALE.Width = 250
                            Me.FOR_SALE.Height = 215
                        End If
                    End If


                    For Each adoRs As DataRow In results_table.Rows

                        If Not IsDBNull(adoRs("mtrend_year")) Then
                            If adoRs("mtrend_year").ToString <> "" Then
                                If Not IsDBNull(adoRs("mtrend_month")) Then
                                    If adoRs("mtrend_month").ToString <> "" Then

                                        ' outstring = outstring & "data.setValue(" & x & ", 0, '" & CStr(adoRs("mtrend_month")) & "-" & CStr(adoRs("mtrend_year")) & "');" & vbCrLf
                                        If Not IsDBNull(adoRs("mtrend_total_aircraft_for_sale")) Then
                                            If CDbl(adoRs("mtrend_total_aircraft_for_sale")) >= 0 Then

                                                If CDbl(adoRs("mtrend_total_aircraft_for_sale")) > high_number Then
                                                    high_number = adoRs("mtrend_total_aircraft_for_sale")
                                                End If
                                                If CDbl(adoRs("mtrend_total_aircraft_for_sale")) < low_number Then
                                                    low_number = adoRs("mtrend_total_aircraft_for_sale")
                                                End If


                                                If Trim(graph_string) <> "" Then
                                                    graph_string &= ", "
                                                End If
                                                graph_string += "['" & (adoRs("mtrend_month") & "-" & adoRs("mtrend_year")) & "'," & adoRs("mtrend_total_aircraft_for_sale") & " ]"

                                                ' Me.FOR_SALE.Series("FOR_SALE").Points.AddXY(adoRs("mtrend_year"), adoRs("mtrend_total_aircraft_for_sale"))
                                                Me.FOR_SALE.Series("FOR_SALE").Points.AddXY((adoRs("mtrend_month") & "-" & adoRs("mtrend_year")), adoRs("mtrend_total_aircraft_for_sale"))
                                                '  outstring = outstring & "data.setValue(" & x & ", 1, " & Format(adoRs("mtrend_total_aircraft_for_sale")) & ");" & vbCrLf
                                            Else
                                                'outstring = outstring & "data.setValue(" & x & ", 1, 0);" & vbCrLf
                                            End If
                                        Else
                                            ' outstring = outstring & "data.setValue(" & x & ", 1, 0);" & vbCrLf
                                        End If
                                        x = x + 1
                                    End If
                                End If
                            End If
                        End If

                    Next

                    If IsNumeric(ac_for_sale) = True Then
                        If ac_for_sale > 0 Then
                            If Trim(graph_string) <> "" Then
                                graph_string &= ", "
                            End If
                            graph_string += "['" & (Month(Date.Now()) & "-" & Year(Date.Now())) & "'," & ac_for_sale.ToString & " ]"
                        End If
                    End If



                    If low_number > 5 Then
                        starting_point = (low_number / 5) - 1
                        starting_point = starting_point * 5
                    End If



                    Me.FOR_SALE.ChartAreas("ChartArea1").AxisY.Maximum = high_number + 1
                    Me.FOR_SALE.ChartAreas("ChartArea1").AxisY.Minimum = low_number - 1
                    Me.FOR_SALE.ChartAreas("ChartArea1").AxisY.Interval = interval_point
                    'Me.FOR_SALE.ChartAreas("ChartArea1").AxisY.Minimum = 0

                Else
                    outstring = ""
                End If
            End If


            graph_string = " data16.addColumn('string', 'Month/Year'); data16.addColumn('number', 'Average'); data16.addRows([ " & graph_string

            outstring = "For Sale By Month (past " & months & " months)"

            display_for_sale_by_month_graph = Trim(outstring)
        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function

    Public Function display_for_sale_by_month_graph_compare(ByVal inModelID, ByVal graphID, ByVal months) As String

        Dim htmlOutput As String = ""
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim adoRSAircraft As System.Data.SqlClient.SqlDataReader : adoRSAircraft = Nothing
        Dim outstring, query, x
        Dim nRememberSQLTimeout As Integer = 0
        Dim adUseClient As Integer = 0
        Dim adUseServer As Integer = 0
        Dim adoRs = Nothing
        Dim high_number As Integer = 0
        Dim low_number As Integer = 100000000
        Dim starting_point As Integer = 0
        Dim interval_point As Integer = 1
        outstring = ""
        display_for_sale_by_month_graph_compare = ""
        x = 0

        Try


            query = "SELECT DISTINCT mtrend_year, mtrend_month, mtrend_total_aircraft_for_sale"
            query = query & " FROM Aircraft_Model_Trend WITH(NOLOCK) WHERE mtrend_amod_id = " & CStr(inModelID)

            query = query & " AND (((mtrend_year = '" & Year(DateAdd("m", (-1) * months, Now)) & "')"
            query = query & " AND (mtrend_month < '" & Month(Now) & "' and mtrend_month > '" & Month(Now) - months - 1 & "')) "
            query = query & " OR (mtrend_year = '" & Year(DateAdd("m", (-1) * months, Now)) - 1 & "')"
            query = query & " AND (mtrend_month > '" & Month(Now) + months & "'))"

            query = query & " ORDER BY mtrend_year ASC, mtrend_month ASC"

            'Select Case Application.Item("webHostObject").evoWebHostType
            'Case eWebSiteTypes.LOCAL
            'SqlConn.ConnectionString = My.Settings.DEFAULT_LOCAL_MSSQL
            '  Case Else
            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            '  End Select

            ' End Select
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = query

            adoRs = SqlCommand.ExecuteReader()


            If adoRs.HasRows Then
                Me.FOR_SALE.Series.Clear()
                Me.FOR_SALE.Series.Add("FOR_SALE")
                Me.FOR_SALE.Series("FOR_SALE").ChartType = UI.DataVisualization.Charting.SeriesChartType.Spline
                Me.FOR_SALE.ChartAreas("ChartArea1").AxisY.Title = "Aircraft For Sale"

                Me.FOR_SALE.Series("FOR_SALE").Color = Drawing.Color.Blue
                Me.FOR_SALE.Series("FOR_SALE").BorderWidth = 2
                Me.FOR_SALE.Series("FOR_SALE").MarkerSize = 6
                Me.FOR_SALE.Series("FOR_SALE").MarkerStyle = UI.DataVisualization.Charting.MarkerStyle.Circle
                Me.FOR_SALE.BorderlineWidth = 10
                Me.FOR_SALE.Series("FOR_SALE").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32
                If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                    Me.FOR_SALE.Width = 250
                    Me.FOR_SALE.Height = 250
                End If


                Do While adoRs.Read
                    If Not IsDBNull(adoRs("mtrend_year")) Then
                        If adoRs("mtrend_year").ToString <> "" Then
                            If Not IsDBNull(adoRs("mtrend_month")) Then
                                If adoRs("mtrend_month").ToString <> "" Then

                                    ' outstring = outstring & "data.setValue(" & x & ", 0, '" & CStr(adoRs("mtrend_month")) & "-" & CStr(adoRs("mtrend_year")) & "');" & vbCrLf
                                    If Not IsDBNull(adoRs("mtrend_total_aircraft_for_sale")) Then
                                        If CDbl(adoRs("mtrend_total_aircraft_for_sale")) >= 0 Then

                                            If CDbl(adoRs("mtrend_total_aircraft_for_sale")) > high_number Then
                                                high_number = adoRs("mtrend_total_aircraft_for_sale")
                                            End If
                                            If CDbl(adoRs("mtrend_total_aircraft_for_sale")) < low_number Then
                                                low_number = adoRs("mtrend_total_aircraft_for_sale")
                                            End If

                                            ' Me.FOR_SALE.Series("FOR_SALE").Points.AddXY(adoRs("mtrend_year"), adoRs("mtrend_total_aircraft_for_sale"))
                                            Me.FOR_SALE.Series("FOR_SALE").Points.AddXY((adoRs("mtrend_month") & "-" & adoRs("mtrend_year")), adoRs("mtrend_total_aircraft_for_sale"))
                                            '  outstring = outstring & "data.setValue(" & x & ", 1, " & Format(adoRs("mtrend_total_aircraft_for_sale")) & ");" & vbCrLf
                                        Else
                                            'outstring = outstring & "data.setValue(" & x & ", 1, 0);" & vbCrLf
                                        End If
                                    Else
                                        ' outstring = outstring & "data.setValue(" & x & ", 1, 0);" & vbCrLf
                                    End If
                                    x = x + 1
                                End If
                            End If
                        End If
                    End If

                Loop


                If low_number > 5 Then
                    starting_point = (low_number / 5) - 1
                    starting_point = starting_point * 5
                End If

                If high_number = 0 And low_number = 0 Then
                    Me.FOR_SALE.ChartAreas("ChartArea1").AxisY.Maximum = 1
                    Me.FOR_SALE.ChartAreas("ChartArea1").AxisY.Minimum = 0
                Else
                    Me.FOR_SALE.ChartAreas("ChartArea1").AxisY.Maximum = high_number + 1
                    Me.FOR_SALE.ChartAreas("ChartArea1").AxisY.Minimum = low_number - 1
                    Me.FOR_SALE.ChartAreas("ChartArea1").AxisY.Interval = interval_point
                End If

                'Me.FOR_SALE.ChartAreas("ChartArea1").AxisY.Minimum = 0

            Else
                outstring = ""
            End If

            outstring = "For Sale By Month (past 6 months)"

            display_for_sale_by_month_graph_compare = Trim(outstring)
        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function
    Public Function display_sold_per_month_graph(ByVal bIsAcContactTypeView, ByVal isMarketView, ByVal inModelID, ByVal graphID, ByVal months, ByVal show_future, ByRef graph_string, Optional ByVal model_list = "") As String

        Dim htmlOutput As String = ""
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim adoRSAircraft As System.Data.SqlClient.SqlDataReader : adoRSAircraft = Nothing

        Dim outstring, query, x, monthHeader
        monthHeader = ""
        Dim nRememberSQLTimeout As Integer = 0
        Dim adUseClient As Integer = 0
        Dim adUseServer As Integer = 0
        outstring = ""
        display_sold_per_month_graph = ""
        x = 0
        Dim adoRs = Nothing
        Dim high_number As Integer = 0
        Dim low_number As Integer = 100000000
        Dim current_month_to_show As Boolean = False
        Try


            If bIsAcContactTypeView Then   ' go back to the first of the month we are in then subtract amount of days

                query = "SELECT year(journ_date) as tyear, month(journ_date) as tmonth, count(*) as tcount "
                query = query & " FROM Journal WITH(NOLOCK)"
                query = query & " INNER JOIN aircraft WITH(NOLOCK) ON journ_ac_id = ac_id AND journ_id = ac_journ_id"

                If Trim(model_list) <> "" And inModelID = 0 Then
                    query = query & "  WHERE  ac_amod_id in (" & CStr(Trim(model_list)) & ")  AND ac_lifecycle_stage < 4"
                Else
                    query = query & " WHERE ac_amod_id = " & inModelID & " AND ac_lifecycle_stage < 4"
                End If

                query = query & " AND ac_id IN (SELECT DISTINCT cref_ac_id FROM aircraft_reference WHERE (cref_contact_type IN ('94','33') OR cref_business_type in ('CH')))"

                query = query & " AND ((journ_date >= '" & Month(DateAdd("m", (-1) * months, Now)) & "/01/" & Year(DateAdd("m", (-1) * months, Now)) & "')"
                query = query & " AND (journ_date < '" & Month(Now)
                query = query & "/01/"
                query = query & Year(Now) & "'))"
                monthHeader = months

            ElseIf isMarketView Then

                query = "SELECT year(journ_date) as tyear, month(journ_date) as tmonth, count(*) as tcount FROM Journal WITH(NOLOCK) "
                query = query & " INNER JOIN Aircraft WITH(NOLOCK) ON journ_ac_id = ac_id AND journ_id = ac_journ_id"

                If Trim(model_list) <> "" And inModelID = 0 Then
                    query = query & "  WHERE  ac_amod_id in ( " & CStr(Trim(model_list)) & ") "
                Else
                    query = query & "  WHERE  ac_amod_id = " & CStr(inModelID)
                End If



                If CInt(Session.Item("marketViewTimeSpan")) = crmWebClient.Constants.VIEW_6MONTHS Then
                    query = query & " AND ((journ_date >= '" & Month(DateAdd("m", (-1) * months, Now)) & "/01/" & Year(DateAdd("m", (-1) * months, Now)) & "')"
                    query = query & " AND (journ_date < '" & Month(Now) & "/01/" & Year(Now) & "'))"
                    monthHeader = months
                End If

                If CInt(Session.Item("marketViewTimeSpan")) = crmWebClient.Constants.VIEW_12MONTHS Then
                    query = query & " AND ((journ_date >= '" & Month(DateAdd("m", (-1) * months, Now)) & "/01/" & Year(DateAdd("m", (-1) * months, Now)) & "')"
                    query = query & " AND (journ_date < '" & Month(Now) & "/01/" & Year(Now) & "'))"
                    monthHeader = months
                End If

            Else

                If (Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998") And HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag Then
                    If inModelID > 0 Then
                        query = "SELECT year(journ_date) as tyear, month(journ_date) as tmonth, sum(case when ac_amod_id = " & inModelID & " then 1 else 0 end) as tcount "
                    Else
                        query = "SELECT year(journ_date) as tyear, month(journ_date) as tmonth, count(*) as tcount "
                    End If
                Else
                    query = "SELECT year(journ_date) as tyear, month(journ_date) as tmonth, count(*) as tcount "
                End If


                If (Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998") And HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag Then
                    If Trim(model_list) <> "" And inModelID = 0 Then
                        query = query & ", (select  sum(mtrend_total_aircraft_for_sale) FROM Aircraft_Model_Trend WITH(NOLOCK) "
                        query = query & " where mtrend_year = Year(journ_date) And mtrend_month = Month(journ_date) "
                        query = query & " and mtrend_amod_id in ( " & CStr(Trim(model_list)) & ")) as fscount"
                    ElseIf inModelID > 0 Then
                        query = query & ", (select top 1 mtrend_total_aircraft_for_sale FROM Aircraft_Model_Trend WITH(NOLOCK) "
                        query = query & " where mtrend_year = Year(journ_date) And mtrend_month = Month(journ_date) "
                        query = query & " and mtrend_amod_id = " & inModelID & ") as fscount"
                    Else
                        query = query & ", (select top 1 mtrend_total_aircraft_for_sale FROM Aircraft_Model_Trend WITH(NOLOCK) "
                        query = query & " where mtrend_year = Year(journ_date) And mtrend_month = Month(journ_date) "
                        query = query & " and mtrend_amod_id = ac_amod_id) as fscount"
                    End If
                End If

                query = query & " FROM Journal WITH(NOLOCK)"
                query = query & " INNER JOIN Aircraft WITH(NOLOCK) ON journ_ac_id = ac_id AND journ_id = ac_journ_id  "

                If Trim(model_list) <> "" And inModelID = 0 Then
                    query = query & "  WHERE  ac_amod_id in ( " & CStr(Trim(model_list)) & ") "
                Else
                    '   query = query & "  WHERE  ac_amod_id = " & CStr(inModelID) ' changed MSW - to get them all - counts will be done in sub selects 
                    query = query & "  WHERE  ac_amod_id > 0 "
                End If

                query = query & " AND ((journ_date >= '" & Month(DateAdd("m", (-1) * months, Now)) & "/01/" & Year(DateAdd("m", (-1) * months, Now)) & "')"
                query = query & " AND (journ_date < '" & Month(Now)
                If show_future = True Then
                    query = query & "/" & Day(Now) & "/"
                Else
                    query = query & " /01/"
                End If
                query = query & Year(Now) & "'))"

                monthHeader = months




            End If

            query = query & " AND journ_subcategory_code like 'WS%' AND right(journ_subcategory_code,4) <> 'CORR' AND right(journ_subcategory_code,2) <> 'IT'"
            query = query & "  and journ_internal_trans_flag = 'N' and  journ_subcat_code_part3 NOT IN ('DB','DS','FI','FY','IT','MF','RE','CC','LS', 'RM')   "


            If Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998" Then
                If Trim(model_list) <> "" And inModelID = 0 Then
                    query = query & " GROUP BY year(journ_date), month(journ_date) "
                Else
                    'query = query & " GROUP BY year(journ_date), month(journ_date), ac_amod_id "  ' commented out MSW 5/18/20
                    query = query & " GROUP BY year(journ_date), month(journ_date)  "
                End If
                query = query & " ORDER BY year(journ_date), month(journ_date)"
            Else
                query = query & " GROUP BY year(journ_date), month(journ_date) ORDER BY year(journ_date), month(journ_date)"
            End If


            'Select Case Application.Item("webHostObject").evoWebHostType
            'Case eWebSiteTypes.LOCAL
            'SqlConn.ConnectionString = My.Settings.DEFAULT_LOCAL_MSSQL
            ' Case Else
            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            '  End Select

            ' End Select
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = query

            adoRs = SqlCommand.ExecuteReader()

            If adoRs.HasRows Then
                Me.PER_MONTH.Series.Clear()
                Me.PER_MONTH.Series.Add("PER_MONTH").ChartType = UI.DataVisualization.Charting.SeriesChartType.Spline
                Me.PER_MONTH.ChartAreas("ChartArea1").AxisY.Title = "Aircraft Sold"


                Me.PER_MONTH.Series("PER_MONTH").Color = Drawing.Color.Blue
                Me.PER_MONTH.Series("PER_MONTH").BorderWidth = 1
                Me.PER_MONTH.Series("PER_MONTH").MarkerSize = 5
                Me.PER_MONTH.Series("PER_MONTH").MarkerStyle = UI.DataVisualization.Charting.MarkerStyle.Circle
                Me.PER_MONTH.BorderlineWidth = 10
                Me.PER_MONTH.Series("PER_MONTH").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32
                If Trim(Request("new_PDF")) = "Y" Then
                    If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                        Me.PER_MONTH.Width = 250
                        Me.PER_MONTH.Height = 215
                    Else
                        Me.PER_MONTH.Width = 475
                        Me.PER_MONTH.Height = 325
                    End If
                Else
                    If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                        Me.PER_MONTH.Width = 250
                        Me.PER_MONTH.Height = 215
                    End If
                End If


                'Me.FOR_SALE.Series("PER_MONTH").ChartType = UI.DataVisualization.Charting.SeriesChartType.Line
                Do While adoRs.Read
                    If Not IsDBNull(adoRs("tyear")) Then
                        If adoRs("tyear").ToString <> "" Then
                            If Not IsDBNull(adoRs("tmonth")) Then
                                If adoRs("tmonth").ToString <> "" Then
                                    'outstring = outstring & "data.setValue(" & x & ", 0, '" & CStr(adoRs("tmonth")) & "-" & CStr(adoRs("tyear")) & "');" & vbCrLf
                                    If Not IsDBNull(adoRs("tcount")) Then
                                        If CDbl(adoRs("tcount")) >= 0 Then


                                            If CDbl(adoRs("tcount")) > high_number Then
                                                high_number = adoRs("tcount")
                                            End If
                                            If CDbl(adoRs("tcount")) < low_number Then
                                                low_number = adoRs("tcount")
                                            End If

                                            If adoRs("tmonth") = Month(Now) Then
                                                current_month_to_show = True
                                            End If
                                            Me.PER_MONTH.Series("PER_MONTH").Points.AddXY((adoRs("tmonth") & "-" & adoRs("tyear")), adoRs("tcount"))


                                            If Trim(graph_string) <> "" Then
                                                graph_string &= ", "
                                            End If
                                            If (Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998") And HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag Then
                                                If Not IsDBNull(adoRs("fscount")) Then
                                                    graph_string += "['" & (adoRs("tmonth") & "-" & adoRs("tyear")) & "'," & adoRs("tcount") & "," & adoRs("fscount") & " ]"
                                                Else
                                                    graph_string += "['" & (adoRs("tmonth") & "-" & adoRs("tyear")) & "'," & adoRs("tcount") & ", null ]"
                                                End If
                                            Else
                                                graph_string += "['" & (adoRs("tmonth") & "-" & adoRs("tyear")) & "'," & adoRs("tcount") & " ]"
                                            End If

                                            'Me.AVG_PER_MONTH.Series("PER_MONTH").Points.AddXY(x, adoRs("tcount"))
                                            '  outstring = outstring & "data.setValue(" & x & ", 1, " & Format(adoRs("tcount"), 0) & ");" & vbCrLf
                                        Else
                                            ' outstring = outstring & "data.setValue(" & x & ", 1, 0);" & vbCrLf
                                        End If
                                    Else
                                        ' outstring = outstring & "data.setValue(" & x & ", 1, 0);" & vbCrLf
                                    End If
                                    x = x + 1
                                End If
                            End If
                        End If
                    End If
                Loop

                If show_future = True And current_month_to_show Then
                    Me.PER_MONTH.Series("PER_MONTH").Points.Last.Color = Drawing.Color.Black
                    Me.PER_MONTH.Series("PER_MONTH").Points.Last.BorderDashStyle = DataVisualization.Charting.ChartDashStyle.Dash

                End If


                Me.PER_MONTH.ChartAreas("ChartArea1").AxisY.Maximum = high_number + 1
                Me.AVG_DAYS_ON.ChartAreas("ChartArea1").AxisY.Minimum = low_number - 1
                'Me.PER_MONTH.ChartAreas("ChartArea1").AxisY.Minimum = 0


            Else
                outstring = ""
            End If

            If (Trim(Request("ViewID")) = "997" Or Trim(Request("ViewID")) = "998") And HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag Then
                graph_string = " data18.addColumn('string', 'Month/Year'); data18.addColumn('number', 'Sold'); data18.addColumn('number', 'ForSale'); data18.addRows([ " & graph_string
            Else
                graph_string = " data18.addColumn('string', 'Month/Year'); data18.addColumn('number', 'Count'); data18.addRows([ " & graph_string
            End If

            outstring = "Sold Per Month (past " & monthHeader & " months)"


            display_sold_per_month_graph = Trim(outstring)
        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try

    End Function
    Public Function NEW_display_by_mft_year(ByVal amod_id As Long, ByRef graph_string As String) As String

        Dim htmlOutput As String = ""
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim adoRSAircraft As System.Data.SqlClient.SqlDataReader : adoRSAircraft = Nothing

        Dim outstring, query, x, monthHeader
        monthHeader = ""
        Dim nRememberSQLTimeout As Integer = 0
        Dim adUseClient As Integer = 0
        Dim adUseServer As Integer = 0
        outstring = ""
        NEW_display_by_mft_year = ""
        x = 0
        Dim adoRs = Nothing
        Dim high_number As Integer = 0
        Dim low_number As Integer = 100000000
        Dim current_month_to_show As Boolean = False
        Try


            query = "  select distinct ac_mfr_Year, COUNT(*) as tcount "
            query &= "  from aircraft with (NOLOCK) "
            query &= "  where ac_journ_id = 0 And ac_amod_id = " & amod_id & " And ac_lifecycle_stage = 3 "

            If localCriteria.ViewCriteriaAFTTStart > 0 Then
                query &= (Constants.cAndClause + " ((ac_airframe_tot_hrs >= " & localCriteria.ViewCriteriaAFTTStart & ") or (ac_airframe_tot_hrs IS NULL))")
            End If

            If localCriteria.ViewCriteriaAFTTEnd > 0 Then
                query &= (Constants.cAndClause + " ((ac_airframe_tot_hrs <= " & localCriteria.ViewCriteriaAFTTEnd & ") or (ac_airframe_tot_hrs IS NULL))")
            End If


            If localCriteria.ViewCriteriaYearStart > 0 Then
                query &= (Constants.cAndClause + " ac_mfr_year >= " & localCriteria.ViewCriteriaYearStart)
            End If

            If localCriteria.ViewCriteriaYearEnd > 0 Then
                query &= (Constants.cAndClause + " ac_mfr_year <=  " & localCriteria.ViewCriteriaYearEnd)
            End If

            query &= " group by ac_mfr_Year"
            query &= " order by ac_mfr_Year asc "

            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = query

            adoRs = SqlCommand.ExecuteReader()

            If adoRs.HasRows Then
                Me.PER_MONTH.Series.Clear()
                Me.PER_MONTH.Series.Add("PER_MONTH").ChartType = UI.DataVisualization.Charting.SeriesChartType.Column
                Me.PER_MONTH.ChartAreas("ChartArea1").AxisY.Title = "# of Aircraft"

                Me.PER_MONTH.Series("PER_MONTH").Color = Drawing.Color.Blue
                Me.PER_MONTH.Series("PER_MONTH").BorderWidth = 1
                Me.PER_MONTH.Series("PER_MONTH").MarkerSize = 5
                Me.PER_MONTH.Series("PER_MONTH").MarkerStyle = UI.DataVisualization.Charting.MarkerStyle.Circle
                Me.PER_MONTH.BorderlineWidth = 10
                Me.PER_MONTH.Series("PER_MONTH").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32
                If Trim(Request("new_PDF")) = "Y" Then
                    If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                        Me.PER_MONTH.Width = 250
                        Me.PER_MONTH.Height = 250
                    Else
                        Me.PER_MONTH.Width = 900
                        Me.PER_MONTH.Height = 500
                    End If
                Else
                    If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                        Me.PER_MONTH.Width = 250
                        Me.PER_MONTH.Height = 250
                    End If
                End If


                'Me.FOR_SALE.Series("PER_MONTH").ChartType = UI.DataVisualization.Charting.SeriesChartType.Line
                Do While adoRs.Read


                    If Not IsDBNull(adoRs("ac_mfr_Year")) Then
                        If adoRs("ac_mfr_Year").ToString <> "" Then

                            If CDbl(adoRs("tcount")) > high_number Then
                                high_number = adoRs("tcount")
                            End If
                            If CDbl(adoRs("tcount")) < low_number Then
                                low_number = adoRs("tcount")
                            End If

                            If Trim(graph_string) <> "" Then
                                graph_string &= ", "
                            End If
                            graph_string += "['" & adoRs("ac_mfr_Year") & "'," & adoRs("tcount") & " ]"



                            Me.PER_MONTH.Series("PER_MONTH").Points.AddXY((adoRs("ac_mfr_Year")), adoRs("tcount"))
                        End If
                    End If
                Loop


                If (high_number - low_number) < 18 Then
                    Me.PER_MONTH.ChartAreas("ChartArea1").AxisY.Interval = 1
                ElseIf (high_number - low_number) < 30 Then
                    Me.PER_MONTH.ChartAreas("ChartArea1").AxisY.Interval = 2
                ElseIf (high_number - low_number) < 100 Then
                    Me.PER_MONTH.ChartAreas("ChartArea1").AxisY.Interval = 5
                ElseIf (high_number - low_number) < 200 Then
                    Me.PER_MONTH.ChartAreas("ChartArea1").AxisY.Interval = 10
                Else
                    Me.PER_MONTH.ChartAreas("ChartArea1").AxisY.Interval = 25
                End If

                Me.PER_MONTH.ChartAreas("ChartArea1").AxisX.Interval = 2

                Me.PER_MONTH.ChartAreas("ChartArea1").AxisY.Maximum = high_number + 1
                Me.AVG_DAYS_ON.ChartAreas("ChartArea1").AxisY.Minimum = low_number - 1
                'Me.PER_MONTH.ChartAreas("ChartArea1").AxisY.Minimum = 0


            Else
                outstring = ""
            End If

            graph_string = " data17.addColumn('string', 'Year'); data17.addColumn('number', 'Count'); data17.addRows([ " & graph_string

            outstring = "Age of Fleet by MFR Year"


            NEW_display_by_mft_year = Trim(outstring)
        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try

    End Function
    Public Function display_sold_per_month_graph_compare(ByVal bIsAcContactTypeView, ByVal isMarketView, ByVal inModelID, ByVal graphID, ByVal months, ByVal show_future) As String

        Dim htmlOutput As String = ""
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim adoRSAircraft As System.Data.SqlClient.SqlDataReader : adoRSAircraft = Nothing

        Dim outstring, query, x, monthHeader
        monthHeader = ""
        Dim nRememberSQLTimeout As Integer = 0
        Dim adUseClient As Integer = 0
        Dim adUseServer As Integer = 0
        outstring = ""
        display_sold_per_month_graph_compare = ""
        x = 0
        Dim adoRs = Nothing
        Dim high_number As Integer = 0
        Dim low_number As Integer = 100000000
        Dim current_month_to_show As Boolean = False

        Try



            If bIsAcContactTypeView Then   ' go back to the first of the month we are in then subtract amount of days

                query = "SELECT year(journ_date) as tyear, month(journ_date) as tmonth, count(*) as tcount FROM Journal WITH(NOLOCK)"
                query = query & " INNER JOIN aircraft WITH(NOLOCK) ON journ_ac_id = ac_id AND journ_id = ac_journ_id"
                query = query & " WHERE ac_amod_id = " & inModelID & " AND ac_lifecycle_stage < 4"
                query = query & " AND ac_id IN (SELECT DISTINCT cref_ac_id FROM aircraft_reference WHERE (cref_contact_type IN ('94','33') OR cref_business_type in ('CH')))"

                query = query & " AND ((journ_date >= '" & Month(DateAdd("m", (-1) * months, Now)) & "/01/" & Year(DateAdd("m", (-1) * months, Now)) & "')"
                query = query & " AND (journ_date < '" & Month(Now)
                query = query & "/01/"
                query = query & Year(Now) & "'))"
                monthHeader = months

            ElseIf isMarketView Then

                query = "SELECT year(journ_date) as tyear, month(journ_date) as tmonth, count(*) as tcount FROM Journal WITH(NOLOCK)"
                query = query & " INNER JOIN Aircraft WITH(NOLOCK) ON journ_ac_id = ac_id AND journ_id = ac_journ_id WHERE ac_amod_id = " & CStr(inModelID)

                If CInt(Session.Item("marketViewTimeSpan")) = crmWebClient.Constants.VIEW_6MONTHS Then
                    query = query & " AND ((journ_date >= '" & Month(DateAdd("m", (-1) * months, Now)) & "/01/" & Year(DateAdd("m", (-1) * months, Now)) & "')"
                    query = query & " AND (journ_date < '" & Month(Now) & "/01/" & Year(Now) & "'))"
                    monthHeader = months
                End If

                If CInt(Session.Item("marketViewTimeSpan")) = crmWebClient.Constants.VIEW_12MONTHS Then
                    query = query & " AND ((journ_date >= '" & Month(DateAdd("m", (-1) * months, Now)) & "/01/" & Year(DateAdd("m", (-1) * months, Now)) & "')"
                    query = query & " AND (journ_date < '" & Month(Now) & "/01/" & Year(Now) & "'))"
                    monthHeader = months
                End If

            Else

                query = "SELECT year(journ_date) as tyear, month(journ_date) as tmonth, count(*) as tcount FROM Journal WITH(NOLOCK)"
                query = query & " INNER JOIN Aircraft WITH(NOLOCK) ON journ_ac_id = ac_id AND journ_id = ac_journ_id WHERE ac_amod_id = " & CStr(inModelID)

                query = query & " AND ((journ_date >= '" & Month(DateAdd("m", (-1) * months, Now)) & "/01/" & Year(DateAdd("m", (-1) * months, Now)) & "')"
                query = query & " AND (journ_date < '" & Month(Now)
                If show_future = True Then
                    query = query & "/" & Day(Now) & "/"
                Else
                    query = query & " /01/"
                End If
                query = query & Year(Now) & "'))"

                monthHeader = months

            End If

            query = query & " AND journ_subcategory_code like 'WS%' AND right(journ_subcategory_code,4) <> 'CORR' AND right(journ_subcategory_code,2) <> 'IT'"
            query = query & " GROUP BY year(journ_date), month(journ_date) ORDER BY year(journ_date), month(journ_date)"

            'Select Case Application.Item("webHostObject").evoWebHostType
            'Case eWebSiteTypes.LOCAL
            'SqlConn.ConnectionString = My.Settings.DEFAULT_LOCAL_MSSQL
            '  Case Else
            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            '  End Select

            ' End Select
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = query

            adoRs = SqlCommand.ExecuteReader()

            If adoRs.HasRows Then
                Me.PER_MONTH.Series.Clear()
                Me.PER_MONTH.Series.Add("PER_MONTH").ChartType = UI.DataVisualization.Charting.SeriesChartType.Spline
                Me.PER_MONTH.ChartAreas("ChartArea1").AxisY.Title = "Aircraft Sold"


                Me.PER_MONTH.Series("PER_MONTH").Color = Drawing.Color.Blue
                Me.PER_MONTH.Series("PER_MONTH").BorderWidth = 2
                Me.PER_MONTH.Series("PER_MONTH").MarkerSize = 6
                Me.PER_MONTH.Series("PER_MONTH").MarkerStyle = UI.DataVisualization.Charting.MarkerStyle.Circle
                Me.PER_MONTH.BorderlineWidth = 10
                Me.PER_MONTH.Series("PER_MONTH").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32
                If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                    Me.PER_MONTH.Width = 250
                    Me.PER_MONTH.Height = 250
                End If


                'Me.FOR_SALE.Series("PER_MONTH").ChartType = UI.DataVisualization.Charting.SeriesChartType.Line
                Do While adoRs.Read
                    If Not IsDBNull(adoRs("tyear")) Then
                        If adoRs("tyear").ToString <> "" Then
                            If Not IsDBNull(adoRs("tmonth")) Then
                                If adoRs("tmonth").ToString <> "" Then
                                    'outstring = outstring & "data.setValue(" & x & ", 0, '" & CStr(adoRs("tmonth")) & "-" & CStr(adoRs("tyear")) & "');" & vbCrLf
                                    If Not IsDBNull(adoRs("tcount")) Then
                                        If CDbl(adoRs("tcount")) >= 0 Then


                                            If CDbl(adoRs("tcount")) > high_number Then
                                                high_number = adoRs("tcount")
                                            End If
                                            If CDbl(adoRs("tcount")) < low_number Then
                                                low_number = adoRs("tcount")
                                            End If

                                            If adoRs("tmonth") = Month(Now) Then
                                                current_month_to_show = True
                                            End If
                                            Me.PER_MONTH.Series("PER_MONTH").Points.AddXY((adoRs("tmonth") & "-" & adoRs("tyear")), adoRs("tcount"))

                                            'Me.AVG_PER_MONTH.Series("PER_MONTH").Points.AddXY(x, adoRs("tcount"))
                                            '  outstring = outstring & "data.setValue(" & x & ", 1, " & Format(adoRs("tcount"), 0) & ");" & vbCrLf
                                        Else
                                            ' outstring = outstring & "data.setValue(" & x & ", 1, 0);" & vbCrLf
                                        End If
                                    Else
                                        ' outstring = outstring & "data.setValue(" & x & ", 1, 0);" & vbCrLf
                                    End If
                                    x = x + 1
                                End If
                            End If
                        End If
                    End If
                Loop

                If show_future = True And current_month_to_show Then
                    Me.PER_MONTH.Series("PER_MONTH").Points.Last.Color = Drawing.Color.Black
                    Me.PER_MONTH.Series("PER_MONTH").Points.Last.BorderDashStyle = DataVisualization.Charting.ChartDashStyle.Dash
                End If


                If high_number = 0 And low_number = 0 Then
                    Me.PER_MONTH.ChartAreas("ChartArea1").AxisY.Maximum = 1
                    Me.PER_MONTH.ChartAreas("ChartArea1").AxisY.Minimum = 0
                Else
                    Me.PER_MONTH.ChartAreas("ChartArea1").AxisY.Maximum = high_number + 1
                    Me.PER_MONTH.ChartAreas("ChartArea1").AxisY.Minimum = low_number - 1
                End If



                'Me.PER_MONTH.ChartAreas("ChartArea1").AxisY.Minimum = 0
                outstring = "Sold Per Month (past " & monthHeader & " months)"

            Else
                outstring = "No Information: Sold Per Month (past " & monthHeader & " months)"
            End If





            display_sold_per_month_graph_compare = Trim(outstring)
        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function

    Function display_leases_sold_by_month(ByVal in_HeaderText, ByVal table_height, ByVal real_company_name, ByVal real_model_name, ByVal lease_model_id, ByVal lease_comp_id, ByVal airframe_type, ByVal business_type)
        Dim type_of_product_view As String = ""
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim localAdoRs2 As System.Data.SqlClient.SqlDataReader : localAdoRs2 = Nothing
        Dim outstring, query, x, record_count
        Dim VIEW_6MONTHS As Integer = 24
        Dim high_count As Integer = 0
        Dim low_count As Integer = 10000
        x = 0
        record_count = 0
        outstring = ""
        display_leases_sold_by_month = ""

        Try


            query = "SELECT YEAR(journ_date) AS tyear, MONTH(journ_date) AS tmonth, count(*) AS tcount"
            query = query & " FROM Journal WITH(NOLOCK) INNER JOIN Aircraft WITH(NOLOCK) ON journ_ac_id = ac_id and journ_id = ac_journ_id"
            query = query & " INNER JOIN Aircraft_Model WITH(NOLOCK) ON ac_amod_id = amod_id"
            query = query & " INNER JOIN aircraft_reference WITH(NOLOCK) ON ac_id=cref_ac_id and ac_journ_id = cref_journ_id"

            query = query & " WHERE journ_subcategory_code like 'L%' and right(journ_subcategory_code,4) <> 'CORR' and right(journ_subcategory_code,2) <> 'IT'"

            '  query = query & commonEVO.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, True)
            query = query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, True)

            query = query & " AND cref_contact_type in ('13', '57')"

            If Trim(airframe_type) <> "" Then
                query = query & " AND amod_airframe_type_code = '" & Trim(airframe_type) & "'"
            End If

            If business_type.ToString.Trim <> "" Then
                If business_type.ToString.Trim = "B" Then
                    query = query & " and ac_product_business_flag = 'Y' "
                ElseIf business_type.ToString.Trim = "H" Then
                    query = query & " and ac_product_helicopter_flag = 'Y' "
                ElseIf business_type.ToString.Trim = "C" Then
                    query = query & " and ac_product_commercial_flag = 'Y' "
                End If
            End If

            If CLng(lease_comp_id) > 0 Then
                query = query & " AND cref_comp_id = " & CLng(lease_comp_id)
            End If

            If CLng(lease_model_id) > 0 Then
                query = query & " AND amod_id = " & CStr(lease_model_id)
            End If

            query = query & " AND (journ_date >= '" & Month(DateAdd("m", (-1) * CInt(VIEW_6MONTHS), Now)) & "/01/" & Year(DateAdd("m", (-1) * CInt(VIEW_6MONTHS), Now)) & "')"
            query = query & " AND (journ_date < '" & Month(Now) & "/01/" & Year(Now) & "')"



            query = query & " GROUP BY YEAR(journ_date), month(journ_date) ORDER BY YEAR(journ_date), month(journ_date)"

            If Session("debug") Then
                Response.Write("<b>display_leases_sold_by_month:" & Server.HtmlEncode(query) & "</b><br /><br />")
            End If

            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = query
            localAdoRs2 = SqlCommand.ExecuteReader()

            If localAdoRs2.HasRows Then



                Me.AVG_SOLD_PER_MONTH.Series.Add("AVG").ChartType = UI.DataVisualization.Charting.SeriesChartType.SplineArea
                Me.AVG_SOLD_PER_MONTH.ChartAreas("ChartArea1").AxisY.Title = "Leasses"
                Me.AVG_SOLD_PER_MONTH.ChartAreas("ChartArea1").AxisX.Title = "Month"
                Me.AVG_SOLD_PER_MONTH.Series("AVG").Color = Drawing.Color.Blue
                Me.AVG_SOLD_PER_MONTH.Series("AVG").BorderWidth = 1
                Me.AVG_SOLD_PER_MONTH.Series("AVG").MarkerSize = 5
                Me.AVG_SOLD_PER_MONTH.Series("AVG").MarkerStyle = UI.DataVisualization.Charting.MarkerStyle.Circle

                Me.AVG_SOLD_PER_MONTH.Series("AVG").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32


                Do While localAdoRs2.Read

                    If localAdoRs2("tcount") > 0 Then

                        Me.AVG_SOLD_PER_MONTH.Series("AVG").Points.AddXY((localAdoRs2("tmonth") & "-" & localAdoRs2("tYear")), localAdoRs2("tcount"))

                        If localAdoRs2("tcount") > high_count Then
                            high_count = localAdoRs2("tcount")
                        End If

                        If localAdoRs2("tcount") < low_count Then
                            low_count = localAdoRs2("tcount")
                        End If


                        x = x + 1
                    End If

                Loop
                localAdoRs2.Close()
                localAdoRs2 = Nothing

            Else
                outstring = ""
            End If



            If high_count > 0 Then
                outstring = outstring & "Leases Per Month Last 24 Months"
            End If


            If high_count > 0 Then

                If high_count > 50 Then
                    high_count = 100
                ElseIf high_count > 20 And high_count < 50 Then
                    high_count = 50
                ElseIf high_count < 20 And high_count > 10 Then
                    high_count = 20
                Else
                    high_count = 10
                End If


                Me.AVG_SOLD_PER_MONTH.ChartAreas("ChartArea1").AxisY.Maximum = high_count 'high_number + interval_point
                Me.AVG_SOLD_PER_MONTH.ChartAreas("ChartArea1").AxisY.Minimum = 0
                Me.AVG_SOLD_PER_MONTH.ChartAreas("ChartArea1").AxisY.Interval = (high_count / 10) 'interval_point

            End If

            display_leases_sold_by_month = Trim(outstring)
        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function

    Function display_leases_due_to_expire(ByVal in_HeaderText, ByVal real_company_name, ByVal real_make_model_name, ByVal lease_model_id, ByVal lease_comp_id, ByVal IsGetNextExpiring, ByVal airframe_type, ByVal business_type, ByVal months_count, ByVal sub_info, ByVal sub_type, ByVal make_name, ByVal make_item_to_pass_to_header)

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim localAdoRs2 As System.Data.SqlClient.SqlDataReader : localAdoRs2 = Nothing
        Dim query, outstring, record_count
        Dim QUOTE As String = "&quot;"
        Dim VIEW_6MONTHS As Integer = 6
        Dim counter1 As Integer = 0
        Dim hidden_counter As Integer = 0
        Dim type_of_product_view As String = ""
        outstring = ""
        display_leases_due_to_expire = ""
        record_count = 0


        Try


            If IsGetNextExpiring Then
                query = "SELECT top 1 journ_subject, amod_make_name, amod_model_name, ac_ser_no_full, ac_reg_no, ac_id, aclease_expiration_date, amod_id, journ_id, comp_name, comp_city, comp_state, comp_id, cref_contact_type"
            Else
                query = "SELECT journ_subject, amod_make_name, amod_model_name, ac_ser_no_full, ac_reg_no, ac_id, aclease_expiration_date, amod_id, journ_id, comp_name, comp_city, comp_state, comp_id, cref_contact_type"
            End If


            query = query & " FROM aircraft WITH(NOLOCK) INNER JOIN Aircraft_Lease WITH(NOLOCK) ON ac_id = aclease_ac_id AND ac_journ_id = aclease_journ_id"
            query = query & " INNER JOIN aircraft_model WITH(NOLOCK) ON ac_amod_id = amod_id"
            query = query & " INNER JOIN aircraft_reference WITH(NOLOCK) ON ac_id = cref_ac_id and ac_journ_id = cref_journ_id"
            query = query & " LEFT OUTER JOIN company WITH(NOLOCK) ON cref_comp_id = comp_id and cref_journ_id = comp_journ_id"


            query = query & " INNER JOIN journal WITH(NOLOCK) ON ac_journ_id = journ_id "
            query = query & " WHERE ac_journ_id > 0 AND aclease_expired = 'N' AND cref_contact_type in ('13', '57')"


            If IsGetNextExpiring Then
                query = query & " AND aclease_expiration_date > '" & Month(Now) & "/01/" & Year(Now) & "'"
            Else
                query = query & " AND (aclease_expiration_date >= '" & Month(Now) & "/01/" & Year(Now) & "'"
                query = query & " AND aclease_expiration_date < '" & Month(DateAdd("m", months_count, Now)) & "/01/" & Year(DateAdd("m", months_count, Now)) & "') "
            End If

            '  query &= " " + commonEVO.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, True)
            query = query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, True)

            If CLng(lease_comp_id) > 0 Then
                query = query & " AND comp_id = " & CLng(lease_comp_id)
            End If

            If CLng(lease_model_id) > 0 Then
                query = query & " AND amod_id = " & CStr(lease_model_id)
            End If

            If Trim(airframe_type) <> "" Then
                If Trim(airframe_type) = "F" Or Trim(airframe_type) = "R" Then
                    query = query & " AND amod_airframe_type_code = '" & Trim(airframe_type) & "'"
                Else
                    query = query & " AND amod_type_code = '" & Trim(airframe_type) & "'"
                End If
            End If

            If Trim(make_name) <> "" Then
                query = query & " and amod_make_name = '" & make_name & "' "
            End If

            If business_type.ToString.Trim <> "" Then
                If business_type.ToString.Trim = "B" Then
                    query = query & " and ac_product_business_flag = 'Y' "
                ElseIf business_type.ToString.Trim = "H" Then
                    query = query & " and ac_product_helicopter_flag = 'Y' "
                ElseIf business_type.ToString.Trim = "C" Then
                    query = query & " and ac_product_commercial_flag = 'Y' "
                End If
            End If

            If IsGetNextExpiring Then
                If amod_id > 0 Then
                    in_HeaderText = in_HeaderText & real_make_model_name
                ElseIf Trim(make_name) <> "" Then
                    in_HeaderText = in_HeaderText & make_name.ToString.ToUpper
                Else
                    in_HeaderText = in_HeaderText & "ALL MAKES/MODELS"
                End If
                in_HeaderText = in_HeaderText & "<br />No Leases Expiring in Next " & months_count & " Month(s). Next Lease To Expire Is:"
                query = query & " ORDER BY aclease_expiration_date ASC, amod_make_name, amod_model_name"
            Else
                If amod_id > 0 Then
                    in_HeaderText = in_HeaderText & real_make_model_name
                ElseIf Trim(make_name) <> "" Then
                    in_HeaderText = in_HeaderText & make_name.ToString.ToUpper
                Else
                    in_HeaderText = in_HeaderText & "ALL MAKES/MODELS"
                End If
                in_HeaderText = in_HeaderText & "<br />From: " & Month(Now) & "/01/" & Year(Now) & " Up to: " & Month(DateAdd("m", months_count, Now)) & "/01/" & Year(DateAdd("m", months_count, Now))
                query = query & " ORDER BY aclease_expiration_date ASC, amod_make_name, amod_model_name"
            End If



            If Session("debug") Then
                Response.Write("<b>display_leases_due_to_expire:" & Server.HtmlEncode(query) & "</b><br /><br />")
            End If


            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = query
            localAdoRs2 = SqlCommand.ExecuteReader()


            outstring = outstring & "<tr><td valign='top' align='left'><table id='leasesDueToExpireInnerTable' width='100%' cellpadding='1' cellspacing='0'>"
            outstring = outstring & "<tr><td valign='top' align='left' class='tabheader'><strong>" & in_HeaderText & "</strong></td><td class='border_bottom' width='20%'>&nbsp;</td></tr>"
            outstring = outstring & "<tr><td colspan='2' class='rightside'>"
            outstring = outstring & "<table id='leasesDueToExpireDataTable' width='100%' cellpadding='4' cellspacing='0'>"

            If localAdoRs2.HasRows Then
                Do While localAdoRs2.Read

                    If hidden_counter > 25 Then

                        outstring = outstring & "</table></td></tr></table></td></tr></table>"
                        outstring = outstring & Build_PDF_Template_Footer()
                        outstring = outstring & Insert_Page_Break_PDF()
                        outstring = outstring & Build_PDF_Header_Final("Financial Report", sub_info, make_item_to_pass_to_header, real_company_name, sub_type, "", "", "", True)
                        outstring = outstring & "<table id='leasesDueToExpireOuterTable' width='100%' height='' cellpadding='1' cellspacing='0' class='module'>"
                        outstring = outstring & "<tr><td valign='top' align='left' class='header' style='padding-left:3px;'>LEASES DUE TO EXPIRE ((<em>next " & months_count & " month(s)</em>) Continued)</td></tr>"
                        outstring = outstring & "<tr><td valign='top' align='left'><table id='leasesDueToExpireInnerTable' width='100%' cellpadding='1' cellspacing='0'>"
                        outstring = outstring & "<tr><td valign='top' align='left' class='tabheader'><strong>" & in_HeaderText & "</strong></td><td class='border_bottom' width='20%'>&nbsp;</td></tr>"
                        outstring = outstring & "<tr><td colspan='2' class='rightside'>"
                        outstring = outstring & "<table id='leasesDueToExpireDataTable' width='100%' cellpadding='4' cellspacing='0'>"
                        hidden_counter = 0
                    End If

                    outstring = outstring & "<tr><td valign='top' align='left' width='5%' class='seperator'><img src='" & location_string & "images/ch_red.jpg' class='bullet'/></td>"
                    outstring = outstring & "<td valign='top' align='left' class='seperator'><font size='-4'><em>" & localAdoRs2("amod_make_name") & " " & localAdoRs2("amod_model_name") & "</em>, "
                    outstring = outstring & " Serial# " & localAdoRs2("ac_ser_no_full") & ", Reg# " & localAdoRs2("ac_reg_no") & " &nbsp;-&nbsp;<b>Expires on: " & FormatDateTime(localAdoRs2("aclease_expiration_date"), 2) & "</b><br />"
                    outstring = outstring & localAdoRs2("journ_subject") & "</font></td></tr>"

                    counter1 = counter1 + 1
                    hidden_counter = hidden_counter + 1
                Loop
            Else

                If IsGetNextExpiring Then
                    outstring = outstring & "<tr><td valign='top' align='left' class='seperator'>No leases could be found that meet your search criteria</td></tr>"
                Else
                    outstring = display_leases_due_to_expire("", real_company_name, real_make_model_name, lease_model_id, lease_comp_id, True, airframe_type, business_type, months_count, sub_info, sub_type, make_name, make_item_to_pass_to_header)
                End If

            End If


            If Not IsGetNextExpiring Then

                outstring = outstring & "</table></td></tr></table></td></tr></table>"

                record_count = counter1

                If record_count > 0 Then
                    outstring = "<tr><td valign='top' align='left' class='header' style='padding-left:3px;'>LEASES DUE TO EXPIRE (<em>next " & months_count & " month(s)</em> (" & CStr(record_count) & "))</td></tr>" & outstring
                Else
                    outstring = "<tr><td valign='top' align='left' class='header' style='padding-left:3px;'>NO LEASES DUE TO EXPIRE (<em>next " & months_count & " month(s)</em>)</td></tr>" & outstring
                End If

                outstring = "<table id='leasesDueToExpireOuterTable' width='100%' height='' cellpadding='1' cellspacing='0' class='module'>" & outstring
            End If

            display_leases_due_to_expire = Trim(outstring)
        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function

    Function display_leases_expired(ByVal in_HeaderText, ByVal real_company_name, ByVal real_make_model_name, ByVal lease_model_id, ByVal lease_comp_id, ByVal IsGetLastExpired, ByVal airframe_type, ByVal sub_info, ByVal airframe_limitations_for_header, ByVal business_type, ByVal months_amount, ByVal make_name, ByVal make_item_to_pass_to_header)

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim localAdoRs2 As System.Data.SqlClient.SqlDataReader : localAdoRs2 = Nothing
        Dim query, outstring, record_count
        Dim QUOTE As String = "&quot;"
        Dim VIEW_6MONTHS As Integer = 6
        Dim counter1 As Integer = 0
        Dim hidden_counter As Integer = 1
        Dim type_of_product_view As String = ""
        outstring = ""
        display_leases_expired = ""
        record_count = 0
        in_HeaderText = ""

        Try


            If IsGetLastExpired Then
                query = "SELECT Top 1 amod_make_name, amod_model_name, ac_ser_no_full, ac_reg_no, ac_id, aclease_expiration_date, amod_id, journ_subject, journ_id"
            Else
                query = "SELECT amod_make_name, amod_model_name, ac_ser_no_full, ac_reg_no, ac_id, aclease_expiration_date, amod_id, journ_subject, journ_id"
            End If


            query = query & " FROM aircraft WITH(NOLOCK) INNER JOIN Aircraft_Lease WITH(NOLOCK) ON ac_id = aclease_ac_id and ac_journ_id = aclease_journ_id"
            query = query & " INNER JOIN aircraft_model WITH(NOLOCK) ON ac_amod_id = amod_id"
            query = query & " INNER JOIN aircraft_reference WITH(NOLOCK) ON ac_id=cref_ac_id and ac_journ_id = cref_journ_id"
            query = query & " LEFT OUTER JOIN company WITH(NOLOCK) ON cref_comp_id = comp_id and cref_journ_id = comp_journ_id"


            query = query & " INNER JOIN journal WITH(NOLOCK) ON ac_journ_id = journ_id "
            query = query & " WHERE ac_journ_id > 0 AND aclease_expired = 'Y' AND cref_contact_type in ('13', '57')"

            ' query = query & " " + commonEVO.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, True)
            query = query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, True)


            If IsGetLastExpired Then
                query = query & " AND (aclease_expiration_date < '" & Month(Now) & "/01/" & Year(Now) & "')"
            Else
                query = query & " AND (aclease_expiration_date >= '" & Month(DateAdd("m", (-1) * months_amount, Now)) & "/01/" & Year(DateAdd("m", (-1) * months_amount, Now)) & "')"
                query = query & " AND (aclease_expiration_date < '" & Month(Now) & "/01/" & Year(Now) & "')"
            End If

            If CLng(lease_comp_id) > 0 Then
                query = query & " AND comp_id = " & CLng(lease_comp_id)
            End If

            If CLng(lease_model_id) > 0 Then
                query = query & " AND amod_id = " & CStr(lease_model_id)
            End If

            If Trim(airframe_type) <> "" Then
                If Trim(airframe_type) = "F" Or Trim(airframe_type) = "R" Then
                    query = query & " AND amod_airframe_type_code = '" & Trim(airframe_type) & "'"
                Else
                    query = query & " AND amod_type_code = '" & Trim(airframe_type) & "'"
                End If
            End If

            If Trim(make_name) <> "" Then
                query = query & " and amod_make_name = '" & make_name & "' "
            End If

            If business_type.ToString.Trim <> "" Then
                If business_type.ToString.Trim = "B" Then
                    query = query & " and ac_product_business_flag = 'Y' "
                ElseIf business_type.ToString.Trim = "H" Then
                    query = query & " and ac_product_helicopter_flag = 'Y' "
                ElseIf business_type.ToString.Trim = "C" Then
                    query = query & " and ac_product_commercial_flag = 'Y' "
                End If
            End If

            If IsGetLastExpired Then
                in_HeaderText = "No Leases Expired In Last " & months_amount & " Months. Last Lease To Expire Was:"
                query = query & " ORDER BY aclease_expiration_date desc, amod_make_name, amod_model_name "
            Else
                If amod_id > 0 Then
                    in_HeaderText = in_HeaderText & real_make_model_name
                ElseIf Trim(make_name) <> "" Then
                    in_HeaderText = in_HeaderText & make_name.ToString.ToUpper
                Else
                    in_HeaderText = in_HeaderText & "ALL MAKES/MODELS"
                End If
                in_HeaderText = in_HeaderText & "<br />From: " & Month(DateAdd("m", (-1) * months_amount, Now)) & "/01/" & Year(DateAdd("m", (-1) * months_amount, Now)) & " Up to: " & Month(Now) & "/01/" & Year(Now)
                query = query & " ORDER BY aclease_expiration_date ASC, ac_ser_no_full, amod_make_name, amod_model_name "
            End If




            If Session("debug") Then
                Response.Write("<b>display_leases_expired:" & Server.HtmlEncode(query) & "</b><br /><br />")
            End If


            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = query
            localAdoRs2 = SqlCommand.ExecuteReader()


            outstring = outstring & "<tr><td valign='top' align='left'><table id='displayExpiredLeasesInnerTable' width='100%' cellpadding='1' cellspacing='0'>"
            outstring = outstring & "<tr><td valign='top' align='left' class='tabheader'><strong>" & in_HeaderText & "</strong></td><td class='border_bottom' width='20%'>&nbsp;</td></tr>"
            outstring = outstring & "<tr><td class='rightside' colspan='2'>"
            outstring = outstring & "<table id='displayExpiredLeasesDataTable' width='100%' cellpadding='4' cellspacing='0'>"

            If localAdoRs2.HasRows Then



                Do While localAdoRs2.Read


                    If hidden_counter > 25 Then

                        outstring = outstring & Build_PDF_Template_Footer()
                        outstring = outstring & Insert_Page_Break_PDF()
                        outstring = outstring & Build_PDF_Header_Final("Leased Aircraft", sub_info, make_item_to_pass_to_header, real_company_name, airframe_limitations_for_header, "", "", "", True)
                        outstring = outstring & "<table id='displayExpiredLeasesOuterTable' width='100%' height='' cellpadding='1' cellspacing='0' class='module'>"
                        outstring = outstring & "<tr><td valign='top' colspan='2' align='left' class='header' style='padding-left:3px;'>LEASES EXPIRED (<em>last " & months_amount & " months</em> (Continued))</td></tr>"
                        outstring = outstring & "<tr><td valign='top' align='left'><table id='displayExpiredLeasesInnerTable' width='100%' cellpadding='1' cellspacing='0'>"
                        outstring = outstring & "<tr><td valign='top' align='left' class='tabheader'><strong>" & in_HeaderText & "</strong></td><td class='border_bottom' width='20%'>&nbsp;</td></tr>"
                        outstring = outstring & "<tr><td class='rightside' colspan='2'>"
                        outstring = outstring & "<table id='displayExpiredLeasesDataTable' width='100%' cellpadding='4' cellspacing='0'>"

                        hidden_counter = 0
                    End If


                    If IsGetLastExpired Then
                        outstring = outstring & "<tr><td valign='top' align='left' width='5%' class='seperator'><img src='" & location_string & "images/ch_red.jpg' class='bullet'/></td>"
                        outstring = outstring & "<td valign='top' align='left' class='seperator'><font size='-4'><em>" & localAdoRs2("amod_make_name") & " " & localAdoRs2("amod_model_name") & "</em>, "
                        outstring = outstring & " Serial# " & localAdoRs2("ac_ser_no_full") & ", Reg# " & localAdoRs2("ac_reg_no") & " &nbsp;-&nbsp;<b>Expired on: " & FormatDateTime(localAdoRs2("aclease_expiration_date"), 2) & "</b>"
                        outstring = outstring & "<br />"
                        outstring = outstring & localAdoRs2("journ_subject") & "</font></td></tr>"
                    Else
                        outstring = outstring & "<tr><td valign='top' align='left' width='5%' class='seperator'><img src='" & location_string & "images/ch_red.jpg' class='bullet'/></td>"
                        outstring = outstring & "<td valign='top' align='left' class='seperator'><font size='-4'><em>" & localAdoRs2("amod_make_name") & " " & localAdoRs2("amod_model_name") & "</em>, "
                        outstring = outstring & " Serial# " & localAdoRs2("ac_ser_no_full") & ", Reg# " & localAdoRs2("ac_reg_no") & " &nbsp;-&nbsp;<b>Expired on: " & FormatDateTime(localAdoRs2("aclease_expiration_date"), 2) & "</b>"
                        outstring = outstring & "<br />"
                        outstring = outstring & localAdoRs2("journ_subject") & "</font></td></tr>"

                        hidden_counter = hidden_counter + 1
                        counter1 = counter1 + 1
                    End If


                Loop



            Else

                If IsGetLastExpired Then
                    outstring = outstring & "<tr><td valign='top' align='left' class='seperator'>No leases could be found that meet your search criteria</td></tr>"
                Else
                    outstring = display_leases_expired("", real_company_name, make_item_to_pass_to_header, lease_model_id, lease_comp_id, True, airframe_type, sub_info, airframe_limitations_for_header, business_type, months_amount, "", make_item_to_pass_to_header)
                End If



            End If

            If Not IsGetLastExpired Then
                outstring = outstring & "</table></td></tr></table></td></tr></table>"

                record_count = counter1


                If record_count > 0 Then
                    outstring = "<tr><td valign='top' align='left' colspan='2' class='header' style='padding-left:3px;'>LEASES EXPIRED (<em>last " & months_amount & " months</em> (" & CStr(record_count) & "))</td></tr>" & outstring
                Else
                    outstring = "<tr><td valign='top' align='left' colspan='2' class='header' style='padding-left:3px;'>NO LEASES HAVE EXPIRED (<em>last " & months_amount & " months</em>)</td></tr>" & outstring
                End If

                outstring = "<table id='displayExpiredLeasesOuterTable' width='100%' height='' cellpadding='1' cellspacing='0' class='module'>" & outstring
            End If

            display_leases_expired = Trim(outstring)
        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function

    Function lease_market_status_block(ByVal lease_comp_name, ByVal lease_model_name, ByVal lease_model_id, ByVal lease_comp_id, ByVal airframe_type, ByVal business_type)

        lease_market_status_block = ""

        Dim lease_total, overall_total, htmlOut
        Dim type_of_product_view As String = ""
        Dim Query
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim localAdoRs2 As System.Data.SqlClient.SqlDataReader : localAdoRs2 = Nothing
        Dim percent_of_total As Double
        htmlOut = ""

        percent_of_total = 0.0
        lease_total = 0
        overall_total = 0

        Try

            Query = "SELECT count(distinct ac_id) AS totac"
            Query = Query & " FROM Aircraft_Summary WITH(NOLOCK)"
            Query = Query & " WHERE (ac_lifecycle_stage = 3)"

            If CLng(lease_model_id) > 0 Then
                Query = Query & " AND amod_id =" & CLng(lease_model_id)
            End If

            If CLng(lease_comp_id) > 0 Then
                Query = Query & " AND comp_id =" & CLng(lease_comp_id)
            End If

            If Trim(airframe_type) <> "" Then
                Query = Query & " AND amod_airframe_type_code = '" & Trim(airframe_type) & "'"
            End If

            If business_type.ToString.Trim <> "" Then
                If business_type.ToString.Trim = "B" Then
                    Query = Query & " and ac_product_business_flag = 'Y' "
                ElseIf business_type.ToString.Trim = "H" Then
                    Query = Query & " and ac_product_helicopter_flag = 'Y' "
                ElseIf business_type.ToString.Trim = "C" Then
                    Query = Query & " and ac_product_commercial_flag = 'Y' "
                End If
            End If

            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = Query
            localAdoRs2 = SqlCommand.ExecuteReader()
            If localAdoRs2.HasRows Then
                localAdoRs2.Read()
                overall_total = CLng(localAdoRs2("totac"))
                localAdoRs2.Close()
            End If

            Query = "SELECT count(distinct ac_id) as totac"
            Query = Query & " FROM Aircraft_Summary WITH(NOLOCK)"
            Query = Query & " WHERE (ac_lifecycle_stage = 3) AND (ac_lease_flag = 'Y')"

            If CLng(lease_model_id) > 0 Then
                Query = Query & " AND amod_id = " & CLng(lease_model_id)
            End If

            If CLng(lease_comp_id) > 0 Then
                Query = Query & " AND comp_id = " & CLng(lease_comp_id)
            End If

            If business_type.ToString.Trim <> "" Then
                If business_type.ToString.Trim = "B" Then
                    Query = Query & " and ac_product_business_flag = 'Y' "
                ElseIf business_type.ToString.Trim = "H" Then
                    Query = Query & " and ac_product_helicopter_flag = 'Y' "
                ElseIf business_type.ToString.Trim = "C" Then
                    Query = Query & " and ac_product_commercial_flag = 'Y' "
                End If
            End If


            If Trim(airframe_type) <> "" Then
                Query = Query & " AND amod_airframe_type_code = '" & Trim(airframe_type) & "'"
            End If
            ' Query = Query & commonEVO.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, True)
            Query = Query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, True)


            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = Query
            localAdoRs2 = SqlCommand.ExecuteReader()

            If localAdoRs2.HasRows Then
                localAdoRs2.Read()
                lease_total = CLng(localAdoRs2("totac").ToString)
                localAdoRs2.Close()
            End If

            If CLng(lease_total) > 0 And CLng(overall_total) > 0 Then
                percent_of_total = CDbl((lease_total / overall_total) * 100)
            End If

            htmlOut = "<table id='leaseMarketStatusOuterTable' width='100%' cellspacing='0' cellpadding='1' class='module'>"
            htmlOut = htmlOut & "<tr><td align='left' valign='middle' class='header' style='padding-left:3px;'>LEASE MARKET STATUS for "

            If lease_comp_name <> "" And lease_model_name <> "" Then
                htmlOut = htmlOut & lease_comp_name & " and " & lease_model_name
            ElseIf lease_model_name <> "" Then
                htmlOut = htmlOut & lease_model_name
            ElseIf lease_comp_name <> "" Then
                htmlOut = htmlOut & lease_comp_name
            Else
                htmlOut = htmlOut & "ALL Leased Aircraft"
            End If

            htmlOut = htmlOut & "</td></tr>"
            htmlOut = htmlOut & "<tr><td colspan='4' class='border_bottom_right'>"

            htmlOut = htmlOut & "<table id='leaseMarketStatusInnerTable' width='100%' cellpadding='2' cellspacing='0' border='0'><tr>"
            htmlOut = htmlOut & "<td valign='top'  bgcolor='#EEEEEE' align='left' width='35%'><strong>In Operation</strong></td>"
            htmlOut = htmlOut & "<td valign='top' align='right'><strong>&nbsp;&nbsp;" & FormatNumber(overall_total, 0) & "</strong></td><td>&nbsp;"
            htmlOut = htmlOut & "</tr><tr>"
            htmlOut = htmlOut & "<td valign='top' bgcolor='#EEEEEE' align='left' width='35%'><strong>Leased</strong></td>"
            htmlOut = htmlOut & "<td valign='top' align='right'><strong>&nbsp;&nbsp;" & FormatNumber(lease_total, 0) & " </td><td align='left'><strong>( " & FormatNumber(percent_of_total, 1) & "% of In Operation ) </strong></td>"

            htmlOut = htmlOut & "</tr></table></td></tr></table>"
            lease_market_status_block = htmlOut
        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function


    Function most_recent_lease_trans(ByVal lease_comp_name, ByVal lease_model_name, ByVal lease_model_id, ByVal lease_comp_id, ByVal sub_info, ByVal sub_type, ByVal airframe_type, ByVal temp_business_type, ByVal business_type)
        most_recent_lease_trans = ""

        Dim QUOTE As String = ""
        Dim Query, bgcolor, leasing_comp, htmlOut
        Dim type_of_product_view As String = ""
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim localAdoRs2 As System.Data.SqlClient.SqlDataReader : localAdoRs2 = Nothing
        Dim counter1 As Integer = 1
        Dim starter_string As String = ""
        Try

            htmlOut = ""
            QUOTE = "&quot;"
            leasing_comp = ""

            Query = "SELECT top 50 journ_date, journ_id, journ_comp_id, journ_subject, ac_ser_no_full, amod_make_name, amod_model_name,"
            Query = Query & " ac_id, comp_id, amod_id, ac_reg_no, ac_amod_id, journ_subcategory_code, comp_city, comp_state, comp_name"
            Query = Query & " FROM Aircraft WITH(NOLOCK)"
            Query = Query & " INNER JOIN Aircraft_Model WITH(NOLOCK) ON ac_amod_id = amod_id"
            Query = Query & " INNER JOIN Aircraft_Reference WITH(NOLOCK) on cref_ac_id = ac_id and cref_journ_id = ac_journ_id and cref_contact_type in ('13','57')"
            Query = Query & " INNER JOIN Journal WITH(NOLOCK) on ac_journ_id = journ_id"
            Query = Query & " INNER JOIN Company WITH(NOLOCK) on comp_id = cref_comp_id and comp_journ_id = cref_journ_id "
            Query = Query & " where cref_contact_type in ('13','57') "
            '   Query = Query & commonEVO.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, True)
            Query = Query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, True)

            If CLng(lease_model_id) > 0 Then
                Query = Query & " and amod_id =" & CLng(lease_model_id)
            End If

            If CLng(lease_comp_id) > 0 Then
                Query = Query & " and comp_id =" & CLng(lease_comp_id)
            End If

            If CLng(lease_comp_id) = 0 And CLng(lease_model_id) = 0 Then
                Query = Query & " and journ_date > '" & DateAdd(DateInterval.Month, -3, Date.Now.Date) & "'"
            End If

            If business_type.ToString.Trim <> "" Then
                If business_type.ToString.Trim = "B" Then
                    Query = Query & " and ac_product_business_flag = 'Y' "
                ElseIf business_type.ToString.Trim = "H" Then
                    Query = Query & " and ac_product_helicopter_flag = 'Y' "
                ElseIf business_type.ToString.Trim = "C" Then
                    Query = Query & " and ac_product_commercial_flag = 'Y' "
                End If
            End If

            If Trim(airframe_type) <> "" Then
                Query = Query & " AND amod_airframe_type_code = '" & Trim(airframe_type) & "'"
            End If


            Query = Query & " AND right(journ_subcategory_code,4) <> 'CORR'"
            Query = Query & " AND journ_subcategory_code like 'L%'"
            Query = Query & " AND journ_subcategory_code not like '%IT'"
            Query = Query & " order by journ_date desc"


            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = Query
            localAdoRs2 = SqlCommand.ExecuteReader()

            starter_string = "<table id='mostRecentLeaseOuterTable' width='100%' cellspacing='0' cellpadding='1' class='module'>"
            starter_string = starter_string & "<tr><td align='left' valign='middle' class='header' style='padding-left:3px;'>50 MOST RECENT LEASE TRANSACTIONS"
            starter_string = starter_string & "</td></tr>"

            starter_string = starter_string & "<tr><td class='border_bottom_right'>"


            starter_string = starter_string & "<table id='mostRecentLeaseInnerTable' width='100%' cellpadding='0' cellspacing='0' border='0'>"
            starter_string = starter_string & "<tr bgcolor='#EEEEEE'><td valign='top' colspan='3' align='left'><strong>"

            If Trim(lease_comp_name) <> "" And Trim(lease_model_name) <> "0" Then
                starter_string = starter_string & lease_comp_name & ": " & lease_model_name
            ElseIf Trim(lease_comp_name <> "") Then
                starter_string = starter_string & lease_comp_name
            ElseIf Trim(lease_model_name <> "0") Then
                starter_string = starter_string & lease_model_name
            Else
                starter_string = starter_string & "LEASE INFORMATION"
            End If

            starter_string = starter_string & "</strong></td></tr><tr><td>&nbsp;</td></tr>"

            If localAdoRs2.HasRows Then


                bgcolor = "#F6F6F6"

                Do While localAdoRs2.Read

                    If counter1 > 25 Then
                        htmlOut = htmlOut & "</td></tr></table>"
                        htmlOut = htmlOut & Build_PDF_Template_Footer()
                        htmlOut = htmlOut & Insert_Page_Break_PDF()
                        htmlOut = htmlOut & Build_PDF_Header_Final("Leased Aircraft", sub_info, lease_model_name, lease_comp_name, temp_business_type, "", "", "", True)
                        htmlOut = htmlOut & Replace(starter_string, "TRANSACTIONS", "TRANSACTIONS (Continued)").ToString
                        counter1 = 1
                    End If


                    If bgcolor = "#ffffff" Then
                        bgcolor = "#F6F6F6"
                    Else
                        bgcolor = "#ffffff"
                    End If

                    htmlOut = htmlOut & "<tr bgcolor='" & bgcolor & "' valign='top'><td width='100%'><table width='100%' cellpadding='0' cellspacing='0'><tr valign='top'>"
                    htmlOut = htmlOut & "<td valign='top' align='left' width='5%'><img src='" & location_string & "images/ch_red.jpg'/></td>"
                    htmlOut = htmlOut & "<td align='right' valign='top' width='5%'>"
                    htmlOut = htmlOut & "<font size='-4'>"
                    htmlOut = htmlOut & localAdoRs2("journ_date") & "</font></td><td width='80%'><font size='-4'>&nbsp;&nbsp;"

                    If CLng(lease_model_id) = 0 Then
                        htmlOut = htmlOut & localAdoRs2("amod_make_name") & " " & localAdoRs2("amod_model_name") & ", "
                    Else
                        htmlOut = htmlOut & localAdoRs2("amod_make_name") & " " & localAdoRs2("amod_model_name") & ", "
                    End If

                    If Trim(localAdoRs2("ac_ser_no_full")) <> "" Then
                        htmlOut = htmlOut & "Serial# " & localAdoRs2("ac_ser_no_full") & ", "
                    End If

                    If Trim(localAdoRs2("ac_reg_no")) <> "" Then
                        htmlOut = htmlOut & "Reg# " & localAdoRs2("ac_reg_no") & ", "
                    End If

                    htmlOut = htmlOut & localAdoRs2("journ_subject")
                    htmlOut = htmlOut & "</td></tr></table><hr /></td></tr>"

                    counter1 = counter1 + 1

                Loop

            Else

                htmlOut = htmlOut & "<tr><td colspan='2'>NO RECENT DATA</td></tr></table>"

            End If

            htmlOut = htmlOut & "</table>"
            htmlOut = htmlOut & "</td></tr></table>"


            most_recent_lease_trans = starter_string & htmlOut
        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function


    Function displayLeasedAircraft(ByVal lease_model_id, ByVal lease_comp_id, ByVal sub_info, ByVal real_make_model_name, ByVal real_company_name, ByVal sub_type, ByVal airframe_type, ByVal temp_business_type, ByVal business_type)
        Dim type_of_product_view As String = ""
        Dim Query, tmp_title_variable, htmlOut
        Dim acCount As Integer = 0
        Dim QUOTE As String = "&quot;"
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim localAdoRs2 As System.Data.SqlClient.SqlDataReader : localAdoRs2 = Nothing
        Dim strBuilder
        Dim count1 As Integer = 1
        Dim hidden_counter As Integer = 1
        strBuilder = New StringBuilder
        tmp_title_variable = ""
        htmlOut = ""
        displayLeasedAircraft = ""

        Try



            Query = "SELECT DISTINCT ac_ser_no_full, amod_make_name, amod_model_name, ac_id, amod_id, ac_reg_no, comp_name as lessor,comp_id, comp_country, "
            Query = Query & "(select distinct top 1 comp_name from aircraft_summary b where a.ac_id= b.ac_id and cref_contact_type='12') as lessee, cref_contact_type "
            Query = Query & "FROM Aircraft_Summary a WITH(NOLOCK) "

            Query = Query & "WHERE ac_lifecycle_stage=3 and ac_lease_flag='Y' "

            If Trim(airframe_type) <> "" Then
                Query = Query & " AND amod_airframe_type_code = '" & Trim(airframe_type) & "'"
            End If

            If business_type.ToString.Trim <> "" Then
                If business_type.ToString.Trim = "B" Then
                    Query = Query & " and ac_product_business_flag = 'Y' "
                ElseIf business_type.ToString.Trim = "H" Then
                    Query = Query & " and ac_product_helicopter_flag = 'Y' "
                ElseIf business_type.ToString.Trim = "C" Then
                    Query = Query & " and ac_product_commercial_flag = 'Y' "
                End If
            End If

            Query = Query & " and cref_contact_type in ('13', '57')"

            If CLng(lease_comp_id) > 0 Then
                Query = Query & " and comp_id = " & CLng(lease_comp_id)
            End If

            If CLng(lease_model_id) > 0 Then
                Query = Query & " and amod_id=" & CLng(lease_model_id)
            End If

            '    Query = Query & commonEVO.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, True)
            Query = Query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, True)
            Query = Query & " ORDER BY ac_ser_no_full"

            If Session("debug") Then
                Response.Write("<b>displayLeasedAircraft : " & Server.HtmlEncode(Query) & "</b><br /><br />")
            End If


            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = Query
            localAdoRs2 = SqlCommand.ExecuteReader()

            htmlOut = "<table id='leasedAircraftOuterTable' width='100%' cellspacing='0' cellpadding='1' class='module'>"

            If localAdoRs2.HasRows Then


                strBuilder.Append("<table id='leasedAircraftInnerTable' width='100%' cellpadding='2' cellspacing='0' border='0'>")
                strBuilder.Append("<tr bgcolor='#EEEEEE'>")
                strBuilder.Append("<td valign='top'colspan='2' align='left'><strong>")



                Do While localAdoRs2.Read

                    ' if need of new page
                    If hidden_counter > 20 Then
                        strBuilder.Append("</td></tr></table>")
                        strBuilder.Append("</td></tr></table>")
                        strBuilder.Append(Build_PDF_Template_Footer())
                        strBuilder.Append(Insert_Page_Break_PDF())
                        strBuilder.Append(Build_PDF_Header_Final("Leased Aircraft", sub_info, real_make_model_name, real_company_name, temp_business_type, "", "", "", True))
                        strBuilder.Append("<table id='leasedAircraftOuterTable' width='100%' cellspacing='0' cellpadding='1' class='module'>")
                        strBuilder.Append("<tr><td align='left' valign='middle' class='header' style='padding-left:3px;'>ACTIVE LEASES&nbsp;<em>(Continued)</em>")
                        strBuilder.Append("<br>(Single Aircraft May Have Multiple Active Leases)</td></tr>")
                        strBuilder.Append("<tr><td class='border_bottom_right'>")
                        strBuilder.Append("<table id='leasedAircraftInnerTable' width='100%' cellpadding='2' cellspacing='0' border='0'>")
                        strBuilder.Append("<tr bgcolor='#EEEEEE'>")
                        strBuilder.Append("<td valign='top'colspan='2' align='left'><strong>")
                        count1 = 1
                        hidden_counter = 0
                    End If

                    If count1 = 1 Then
                        If CLng(lease_model_id) > 0 And CLng(lease_comp_id) > 0 Then
                            strBuilder.Append(Trim(localAdoRs2("lessor")) & ": <br> " & Trim(localAdoRs2("amod_make_name")) & " " & Trim(localAdoRs2("amod_model_name")) & tmp_title_variable)
                        ElseIf CLng(lease_comp_id) > 0 Then
                            strBuilder.Append(Trim(localAdoRs2("lessor")) & tmp_title_variable)
                        ElseIf CLng(lease_model_id) > 0 Then
                            strBuilder.Append(Trim(localAdoRs2("amod_make_name")) & " " & Trim(localAdoRs2("amod_model_name")) & tmp_title_variable)
                        End If

                        strBuilder.Append("</td></tr>")
                        count1 = count1 + 1
                    End If



                    strBuilder.Append("<tr><td align='left' valign='top'><img src='" & location_string & "images/ch_red.jpg' class='bullet'/></td><td align='left' valign='top'>")
                    strBuilder.Append("<font size='-4'>")
                    strBuilder.Append("Serial# " & localAdoRs2("ac_ser_no_full") & "</a>, Reg# " & localAdoRs2("ac_reg_no"))
                    strBuilder.Append(" " & localAdoRs2("amod_make_name") & "/" & localAdoRs2("amod_model_name") & ", ")

                    strBuilder.Append("<br />")
                    If Trim(localAdoRs2("cref_contact_type")) = "57" Then
                        strBuilder.Append(" Sub")
                    End If

                    strBuilder.Append(" Leased From: ")
                    strBuilder.Append(Trim(localAdoRs2("lessor").ToString) & " <font size='-2'>(" & Trim(localAdoRs2("comp_country").ToString) & ")</font>")
                    strBuilder.Append(" To: " & Trim(localAdoRs2("lessee").ToString) & "<hr /></font></td></tr>")

                    hidden_counter = hidden_counter + 1
                    acCount = acCount + 1
                Loop

                strBuilder.Append("</table>")

                localAdoRs2.Close()

                htmlOut = htmlOut & "<tr><td align='left' valign='middle' class='header' style='padding-left:3px;'>ACTIVE LEASES&nbsp;<em>(" & FormatNumber(acCount, 0, True, False, True) & ")</em>"
                htmlOut = htmlOut & "<br>(Single Aircraft May Have Multiple Active Leases)</td></tr>"

            Else
                htmlOut = htmlOut & "<tr><td align='left' valign='middle' class='header' style='padding-left:3px;'>ACTIVE LEASES&nbsp;<em>(" & FormatNumber(acCount, 0, True, False, True) & ")</em>"
                htmlOut = htmlOut & "<br>(Single Aircraft May Have Multiple Active Leases)</td></tr>"

                htmlOut = htmlOut & "<tr><td align='left' valign='middle' class='header' style='padding-left:3px;'>NO LEASED AIRCRAFT&nbsp;<em>(0)</em></td></tr>"
            End If

            localAdoRs2 = Nothing


            htmlOut = htmlOut & "<tr><td class='border_bottom_right'>" & strBuilder.ToString() & "</td></tr></table>"


            strBuilder = Nothing

            displayLeasedAircraft = htmlOut
        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function

    Public Function check_model_pic_exists(ByVal amod_id, ByVal picture_width) As String

        check_model_pic_exists = ""

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim localAdoRs2 As System.Data.SqlClient.SqlDataReader : localAdoRs2 = Nothing
        Dim Query As String = ""
        Dim imgFolder As String = HttpContext.Current.Server.MapPath(Session.Item("ModelPicturesFolderVirtualPath"))
        Dim imgDisplayFolder As String = Application.Item("crmClientSiteData").ClientFullHostName & Session.Item("ModelPicturesFolderVirtualPath")

        Dim imgFileName As String = amod_id.ToString.Trim + ".jpg"
        Dim fApicSubject As String = ""

        Try



            check_model_pic_exists = ""
            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60

            Query = "SELECT amod_picture_exists_flag, amod_make_name, amod_model_name FROM Aircraft_model WITH(NOLOCK) WHERE amod_id = " + amod_id.ToString
            '  Query &= " " & commonEVO.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, True)
            Query = Query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, False)

            SqlCommand.CommandText = Query
            localAdoRs2 = SqlCommand.ExecuteReader()

            If localAdoRs2.HasRows Then
                localAdoRs2.Read()

                If Not (IsDBNull(localAdoRs2("amod_picture_exists_flag"))) Then
                    fApicSubject = localAdoRs2.Item("amod_make_name").ToString.Trim + " " + localAdoRs2.Item("amod_model_name").ToString.Trim
                End If

                If localAdoRs2("amod_picture_exists_flag") = "Y" Then
                    If System.IO.File.Exists(imgFolder.Trim + "\" + imgFileName.Trim) Then
                        check_model_pic_exists = "<img Title='" + fApicSubject.Trim + "' alt='" + fApicSubject.Trim + "' src='" + imgDisplayFolder.Trim + "/" + imgFileName.Trim + "' width='" & picture_width & "' />" & vbCrLf
                    Else
                        check_model_pic_exists = "No Image Exists For This Model"
                    End If
                Else
                    check_model_pic_exists = "No Image Exists For This Model"
                End If

            Else
                check_model_pic_exists = "No Image Exists For This Model"
            End If

        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function

    Function display_models_leased_list(ByVal real_company_name, ByVal real_model_name, ByVal lease_model_id, ByVal lease_comp_id, ByVal airframe_type, ByVal business_type)

        display_models_leased_list = ""

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim localAdoRs2 As System.Data.SqlClient.SqlDataReader : localAdoRs2 = Nothing

        Dim bgcolor, htmlOut, Query
        Dim type_of_product_view As String = ""
        Dim counter11 As Integer = 1
        Dim counter_to_show As Integer = 1

        htmlOut = ""

        Try
            If CLng(lease_model_id) > 0 Or CLng(lease_comp_id) > 0 Then
                Query = "SELECT DISTINCT amod_make_name, amod_model_name,amod_id, count(distinct ac_id) as account "
            Else
                Query = "SELECT DISTINCT top 100 amod_make_name, amod_model_name, amod_id, count(distinct ac_id) as account "
            End If

            Query = Query & "FROM Aircraft WITH(NOLOCK) "
            Query = Query & "INNER JOIN Aircraft_Model WITH(NOLOCK) ON ac_amod_id = amod_id "
            Query = Query & "INNER JOIN Aircraft_Reference WITH(NOLOCK) on ac_id=cref_ac_id and ac_journ_id = cref_journ_id "
            Query = Query & "inner join company on comp_id = cref_comp_id and comp_journ_id = cref_journ_id "
            Query = Query & "WHERE (ac_journ_id = 0) AND (comp_active_flag='Y') and ac_lifecycle_stage=3 and (ac_lease_flag='Y') "

            If Trim(airframe_type) <> "" Then
                Query = Query & " AND amod_airframe_type_code = '" & Trim(airframe_type) & "'"
            End If


            '   Query = Query & commonEVO.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, True)
            Query = Query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, True)

            If CLng(lease_model_id) > 0 Then
                Query = Query & "and amod_id =" & CLng(lease_model_id)
            End If

            If CLng(lease_comp_id) > 0 Then
                Query = Query & "and comp_id =" & CLng(lease_comp_id)
            End If

            If business_type.ToString.Trim <> "" Then
                If business_type.ToString.Trim = "B" Then
                    Query = Query & " and ac_product_business_flag = 'Y' "
                ElseIf business_type.ToString.Trim = "H" Then
                    Query = Query & " and ac_product_helicopter_flag = 'Y' "
                ElseIf business_type.ToString.Trim = "C" Then
                    Query = Query & " and ac_product_commercial_flag = 'Y' "
                End If
            End If

            Query = Query & "and cref_contact_type in ('13', '57') "
            Query = Query & "GROUP BY amod_make_name, amod_model_name, amod_id "
            Query = Query & "ORDER BY count(distinct ac_id) desc"


            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = Query
            localAdoRs2 = SqlCommand.ExecuteReader()

            htmlOut = "<table id='displayModelsLeasedOuterTable' width='100%' cellspacing='0' cellpadding='1' class='module'>"

            If CLng(lease_model_id) > 0 And CLng(lease_comp_id) > 0 Then
                htmlOut = htmlOut & "<tr><td align='left' valign='middle' class='header' style='padding-left:3px;' colspan='3'>" & real_model_name & " LEASED: " & real_company_name & "</td></tr>"
            ElseIf CLng(lease_comp_id) > 0 Then
                htmlOut = htmlOut & "<tr><td align='left' valign='middle' class='header' style='padding-left:3px;' colspan='3'>MODELS LEASED: " & real_company_name & "</td></tr>"
            ElseIf CLng(lease_model_id) > 0 Then
                htmlOut = htmlOut & "<tr><td align='left' valign='middle' class='header' style='padding-left:3px;' colspan='3'>" & real_model_name & " LEASED</td></tr>"
            Else
                htmlOut = htmlOut & "<tr><td align='left' valign='middle' class='header' style='padding-left:3px;' colspan='3'>TOP 100 MODELS LEASED</td></tr>"
            End If

            htmlOut = htmlOut & "<tr valign='top'><td colspan='1'  width='49%'>"
            htmlOut = htmlOut & "<table id='displayModelsLeasedInnerTable' width='100%' cellpadding='2' cellspacing='0' border='0'>"
            htmlOut = htmlOut & "<tr bgcolor='#EEEEEE' valign='top'><td align='right' width='10'><strong>#</strong></td>"
            htmlOut = htmlOut & "<td valign='top' align='left' width='80%'><strong>Model&nbsp;Name</strong></td>"
            htmlOut = htmlOut & "<td valign='top' align='right' width='20%'><strong># AC Leased</strong></td></tr>"



            If localAdoRs2.HasRows Then

                bgcolor = "#F6F6F6"

                Do While localAdoRs2.Read

                    If bgcolor = "#ffffff" Then
                        bgcolor = "#F6F6F6"
                    Else
                        bgcolor = "#ffffff"
                    End If

                    If counter11 > 50 Then
                        htmlOut = htmlOut & "</table></td><td bgcolor='#EEEEEE' width='2%'></td><td width='49%' valign='top'>" ' color

                        htmlOut = htmlOut & "<table id='displayTopLessorsInnerTable' width='100%'  cellpadding='2' cellspacing='0' border='0'>"
                        htmlOut = htmlOut & "<tr bgcolor='#EEEEEE'><td align='right' width='10'><strong>#</strong></td>"
                        htmlOut = htmlOut & "<td valign='top' align='left' width='80%'><strong>Model&nbsp;Name</strong></td>"
                        htmlOut = htmlOut & "<td valign='top' align='right' width='20%'><strong># AC Leased</strong></td>"
                        htmlOut = htmlOut & "</tr>"
                        counter11 = 1
                    Else
                        counter11 = counter11 + 1
                    End If


                    htmlOut = htmlOut & "<tr bgcolor='" & bgcolor & "'><td align='right'>"
                    htmlOut = htmlOut & "<font size='-4'>(" & counter_to_show & ")</td><td align='left'><font size='-4'>&nbsp;"
                    htmlOut = htmlOut & localAdoRs2("amod_make_name").ToString & " " & localAdoRs2("amod_model_name").ToString
                    htmlOut = htmlOut & "</font>"
                    htmlOut = htmlOut & "</td><td align='right'>"
                    htmlOut = htmlOut & "<font size='-4'>"
                    htmlOut = htmlOut & localAdoRs2("account").ToString
                    htmlOut = htmlOut & "</td></tr>"
                    counter_to_show = counter_to_show + 1
                Loop

            Else
                htmlOut = htmlOut & "<tr><td colspan='2'> No model lease info found </td></tr>"
            End If
            localAdoRs2.Close()
            htmlOut = htmlOut & "</table>"
            htmlOut = htmlOut & "</td></tr></table>"

            display_models_leased_list = htmlOut
        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function

    Function display_top_lessors(ByVal real_company_name, ByVal real_model_name, ByVal lease_model_id, ByVal lease_comp_id, ByVal airframe_type, ByVal business_type)

        display_top_lessors = ""

        Dim Query, bgcolor, htmlOut
        Dim type_of_product_view As String = ""

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim localAdoRs2 As System.Data.SqlClient.SqlDataReader : localAdoRs2 = Nothing
        Dim counter11 As Integer = 1
        Dim counter_to_show As Integer = 1
        Try
            htmlOut = ""

            If CLng(lease_model_id) > 0 Then
                Query = "SELECT DISTINCT comp_name, comp_id, count(distinct ac_id) as account "
            Else
                Query = "SELECT DISTINCT top 100 comp_name, comp_id, count(distinct ac_id) as account "
            End If

            Query = Query & "FROM Aircraft_summary WITH(NOLOCK) "
            Query = Query & "WHERE ac_lifecycle_stage=3 and (ac_lease_flag='Y') "
            Query = Query & "and cref_contact_type in ('13', '57') "


            If Trim(airframe_type) <> "" Then
                Query = Query & " AND amod_airframe_type_code = '" & Trim(airframe_type) & "'"
            End If


            '   Query = Query & commonEVO.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, False)
            Query = Query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, True)

            If CLng(lease_model_id) > 0 Then
                Query = Query & "and amod_id =" & CLng(lease_model_id)
            End If

            If CLng(lease_comp_id) > 0 Then
                Query = Query & "and comp_id =" & CLng(lease_comp_id)
            End If

            If business_type.ToString.Trim <> "" Then
                If business_type.ToString.Trim = "B" Then
                    Query = Query & " and ac_product_business_flag = 'Y' "
                ElseIf business_type.ToString.Trim = "H" Then
                    Query = Query & " and ac_product_helicopter_flag = 'Y' "
                ElseIf business_type.ToString.Trim = "C" Then
                    Query = Query & " and ac_product_commercial_flag = 'Y' "
                End If
            End If

            Query = Query & "GROUP BY comp_name, comp_id "
            Query = Query & "ORDER BY count(distinct ac_id) desc"

            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = Query
            localAdoRs2 = SqlCommand.ExecuteReader()

            htmlOut = "<table id='displayTopLessorsOuterTable' width='100%' cellspacing='0' cellpadding='1' class='module'>"

            If CLng(lease_comp_id) > 0 And CLng(lease_model_id) > 0 Then
                htmlOut = htmlOut & "<tr><td align='left' valign='middle' colspan='3' class='header' style='padding-left:3px;'>" & real_company_name & " - " & real_model_name & "</td></tr>"
            ElseIf CLng(lease_comp_id) > 0 Then
                htmlOut = htmlOut & "<tr><td align='left' valign='middle'  colspan='3' class='header' style='padding-left:3px;'>LESSOR: " & real_company_name & "</td></tr>"
            ElseIf CLng(lease_model_id) > 0 Then
                htmlOut = htmlOut & "<tr><td align='left' valign='middle' colspan='3'  class='header' style='padding-left:3px;'>LESSOR: " & real_model_name & "</td></tr>"
            Else
                htmlOut = htmlOut & "<tr><td align='left' valign='middle'  colspan='3' class='header' style='padding-left:3px;'>TOP 100 LESSORS</td></tr>"
            End If


            If localAdoRs2.HasRows Then

                bgcolor = "#F6F6F6"

                htmlOut = htmlOut & "<tr><td colspan='1'  width='49%'>"

                htmlOut = htmlOut & "<table id='displayTopLessorsInnerTable' width='100%' cellpadding='2' cellspacing='0' border='0'>"
                htmlOut = htmlOut & "<tr bgcolor='#EEEEEE' valign='top'><td align='right' width='10'><strong>#</strong></td>"
                htmlOut = htmlOut & "<td valign='top' align='left' width='80%'><strong>Lessor&nbsp;Name</strong></td>"
                htmlOut = htmlOut & "<td valign='top' align='right' width='20%'><strong># AC Leased</strong></td>"
                htmlOut = htmlOut & "</tr>"


                Do While localAdoRs2.Read


                    If bgcolor = "#ffffff" Then
                        bgcolor = "#F6F6F6"
                    Else
                        bgcolor = "#ffffff"
                    End If

                    If counter11 > 50 Then
                        htmlOut = htmlOut & "</table></td><td bgcolor='#EEEEEE' width='2%'></td><td width='49%' valign='top'>" ' color

                        htmlOut = htmlOut & "<table id='displayTopLessorsInnerTable' width='100%'  cellpadding='2' cellspacing='0' border='0'>"
                        htmlOut = htmlOut & "<tr bgcolor='#EEEEEE' valign='top'><td align='right' width='10'><strong>#</strong></td>"
                        htmlOut = htmlOut & "<td valign='top' align='left' width='80%'><strong>Lessor&nbsp;Name</strong></td>"
                        htmlOut = htmlOut & "<td valign='top' align='right' width='20%'><strong># AC Leased</strong></td>"
                        htmlOut = htmlOut & "</tr>"
                        counter11 = 1
                    Else
                        counter11 = counter11 + 1
                    End If

                    htmlOut = htmlOut & "<tr bgcolor='" & bgcolor & "'><td align='right'>"
                    htmlOut = htmlOut & "<font size='-4'>(" & counter_to_show & ")</td><td align='left'><font size='-4'>&nbsp;"
                    htmlOut = htmlOut & localAdoRs2("comp_name") & "</font></td><td align='right'>"
                    htmlOut = htmlOut & "<font size='-4'>"
                    htmlOut = htmlOut & localAdoRs2("account").ToString
                    htmlOut = htmlOut & "</td></tr>"

                    counter_to_show = counter_to_show + 1
                Loop
            Else
                htmlOut = htmlOut & "<tr><td colspan='2'> No lessor info found </td></tr>"
            End If
            htmlOut = htmlOut & "</table></td></tr>"
            htmlOut = htmlOut & "</table>"
            htmlOut = htmlOut & "</td></tr></table>"

            display_top_lessors = htmlOut
        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function
    Public Function display_average_days_on_market_graph(ByVal inModelID, ByVal graphID, ByVal days, ByVal months) As String

        Dim htmlOutput As String = ""
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim adoRSAircraft As System.Data.SqlClient.SqlDataReader : adoRSAircraft = Nothing

        Dim outstring, query, x
        Dim nRememberSQLTimeout As Integer = 0
        Dim adUseClient As Integer = 0
        Dim adUseServer As Integer = 0
        outstring = ""
        display_average_days_on_market_graph = ""
        x = 0
        Dim adoRs = Nothing
        Dim counter1 As Integer = 1
        Dim high_number As Integer = 0
        Dim low_number As Integer = 100000000
        Dim starting_point As Integer = 0
        Dim interval_point As Integer = 1


        Try
            query = "SELECT DISTINCT mtrend_year, mtrend_month, mtrend_avg_market_days"
            query = query & " FROM Aircraft_Model_Trend WITH(NOLOCK) WHERE mtrend_amod_id = " & CStr(inModelID)


            query = query & "and "
            query = query & "("
            query = query & "(mtrend_year = year(getdate()-" & days & ") AND mtrend_month >= month(getdate()-" & days & ")) "
            query = query & "or "
            query = query & "(mtrend_year > year(getdate()-" & days & ") and mtrend_year < year(getdate()))"
            query = query & "or "
            query = query & "(mtrend_year = year(getdate()) AND mtrend_month <= month(getdate()))"
            query = query & ")"

            query = query & " ORDER BY mtrend_year ASC, mtrend_month ASC"

            'Select Case Application.Item("webHostObject").evoWebHostType
            'Case eWebSiteTypes.LOCAL
            'SqlConn.ConnectionString = My.Settings.DEFAULT_LOCAL_MSSQL
            ' Case Else
            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            ' End Select

            ' End Select
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = query

            adoRs = SqlCommand.ExecuteReader()

            If adoRs.HasRows Then

                Me.AVG_DAYS_ON.Series.Add("AVG_DAYS").ChartType = UI.DataVisualization.Charting.SeriesChartType.Spline
                Me.AVG_DAYS_ON.ChartAreas("ChartArea1").AxisY.Title = "Sold - Avg Days On Market"

                Me.AVG_DAYS_ON.Series("AVG_DAYS").Color = Drawing.Color.Blue
                Me.AVG_DAYS_ON.Series("AVG_DAYS").BorderWidth = 1
                Me.AVG_DAYS_ON.Series("AVG_DAYS").MarkerSize = 5
                Me.AVG_DAYS_ON.Series("AVG_DAYS").MarkerStyle = UI.DataVisualization.Charting.MarkerStyle.Circle
                Me.AVG_DAYS_ON.BorderlineWidth = 10
                Me.AVG_DAYS_ON.Series("AVG_DAYS").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32
                If Trim(Request("new_PDF")) = "Y" Then
                    If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                        Me.AVG_DAYS_ON.Width = 250
                        Me.AVG_DAYS_ON.Height = 215
                    Else
                        Me.AVG_DAYS_ON.Width = 475
                        Me.AVG_DAYS_ON.Height = 325
                    End If
                Else
                    If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                        Me.AVG_DAYS_ON.Width = 250
                        Me.AVG_DAYS_ON.Height = 215
                    End If
                End If

                Do While adoRs.Read
                    If Not IsDBNull(adoRs("mtrend_year")) Then
                        If adoRs("mtrend_year").ToString <> "" Then
                            If Not IsDBNull(adoRs("mtrend_month")) Then
                                If adoRs("mtrend_month").ToString <> "" Then
                                    ' outstring = outstring & "data.setValue(" & x & ", 0, '" & CStr(adoRs("mtrend_month")) & "-" & CStr(adoRs("mtrend_year")) & "');" & vbCrLf
                                    counter1 = adoRs("mtrend_year")
                                    If Not IsDBNull(adoRs("mtrend_avg_market_days")) Then
                                        If CDbl(adoRs("mtrend_avg_market_days")) > 0 Then

                                            If CDbl(adoRs("mtrend_avg_market_days")) > high_number Then
                                                high_number = adoRs("mtrend_avg_market_days")
                                            End If

                                            If CDbl(adoRs("mtrend_avg_market_days")) < low_number Then
                                                low_number = adoRs("mtrend_avg_market_days")
                                            End If



                                            Me.AVG_DAYS_ON.Series("AVG_DAYS").Points.AddXY((adoRs("mtrend_month") & "-" & adoRs("mtrend_year")), adoRs("mtrend_avg_market_days"))
                                            'outstring = outstring & "data.setValue(" & x & ", 1, " & Format(adoRs("mtrend_avg_market_days"), 0) & ");" & vbCrLf
                                        Else
                                            'outstring = outstring & "data.setValue(" & x & ", 1, 0);" & vbCrLf
                                        End If
                                    Else
                                        'outstring = outstring & "data.setValue(" & x & ", 1, 0);" & vbCrLf
                                    End If
                                    x = x + 1
                                End If
                            End If
                        End If
                    End If

                Loop

                If low_number > 200 Then
                    starting_point = (low_number / 200) - 1
                    starting_point = starting_point * 200
                Else
                    starting_point = 0
                End If

                If low_number < 400 Then
                    interval_point = 100
                Else
                    interval_point = 200
                End If


                Me.AVG_DAYS_ON.ChartAreas("ChartArea1").AxisY.Maximum = high_number + 100
                Me.AVG_DAYS_ON.ChartAreas("ChartArea1").AxisY.Minimum = starting_point
                Me.AVG_DAYS_ON.ChartAreas("ChartArea1").AxisY.Interval = interval_point


                'Me.AVG_DAYS_ON.ChartAreas("ChartArea1").AxisY.Maximum = high_number
                'Me.AVG_DAYS_ON.ChartAreas("ChartArea1").AxisY.Minimum = low_number
                'Me.AVG_DAYS_ON.ChartAreas("ChartArea1").AxisY.Minimum = 0

                adoRs.close()
                adoRs = Nothing
                'outstring = outstring & "var chart = new google.visualization.LineChart(document.getElementById('visualization" & graphID & "'));" & vbCrLf
                'outstring = outstring & "chart.draw(data, {titleY: 'Days on Market', smoothLine: true, legend: 'none'});" & vbCrLf
                'outstring = outstring & "}" & vbCrLf
                'outstring = outstring & "</script>" & vbCrLf
            Else
                outstring = ""
            End If

            outstring = "Average Days on Market for Sales (past " & months & " months)"

            display_average_days_on_market_graph = Trim(outstring)
        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function
    Public Function display_average_days_on_market_graph_compare(ByVal inModelID, ByVal graphID, ByVal months) As String

        Dim htmlOutput As String = ""
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim adoRSAircraft As System.Data.SqlClient.SqlDataReader : adoRSAircraft = Nothing

        Dim outstring, query, x
        Dim nRememberSQLTimeout As Integer = 0
        Dim adUseClient As Integer = 0
        Dim adUseServer As Integer = 0
        outstring = ""
        display_average_days_on_market_graph_compare = ""
        x = 0
        Dim adoRs = Nothing
        Dim counter1 As Integer = 1
        Dim high_number As Integer = 0
        Dim low_number As Integer = 100000000
        Dim starting_point As Integer = 0
        Dim interval_point As Integer = 1
        Dim sized_down_number As Double = 0
        Dim type_of_subscription As String = ""


        Try
            query = "SELECT DISTINCT mtrend_year, mtrend_month, mtrend_avg_market_days"
            query = query & " FROM Aircraft_Model_Trend WITH(NOLOCK) WHERE mtrend_amod_id = " & CStr(inModelID)
            query = query & " AND (((mtrend_year = '" & Year(DateAdd("m", (-1) * months, Now)) & "')"
            query = query & " AND (mtrend_month < '" & Month(Now) & "' and mtrend_month > '" & Month(Now) - months - 1 & "')) "
            query = query & " OR (mtrend_year = '" & Year(DateAdd("m", (-1) * months, Now)) - 1 & "')"
            query = query & " AND (mtrend_month > '" & Month(Now) + months & "'))"


            If Session.Item("localSubscription").crmBusiness_Flag = True Then
                type_of_subscription = "B"
            ElseIf Session.Item("localSubscription").crmCommercial_Flag = True Then
                type_of_subscription = "C"
            ElseIf Session.Item("localSubscription").crmHelicopter_Flag = True Then
                type_of_subscription = "H"
            Else
                type_of_subscription = "B"
            End If

            query = query & " and mtrend_product_type = '" & type_of_subscription & "' "



            query = query & " ORDER BY mtrend_year ASC, mtrend_month ASC"

            'Select Case Application.Item("webHostObject").evoWebHostType
            'Case eWebSiteTypes.LOCAL
            'SqlConn.ConnectionString = My.Settings.DEFAULT_LOCAL_MSSQL
            '   Case Else
            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            ' End Select

            ' End Select
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = query

            adoRs = SqlCommand.ExecuteReader()

            If adoRs.HasRows Then
                Me.AVG_DAYS_ON.Series.Clear()
                Me.AVG_DAYS_ON.Series.Add("AVG_DAYS").ChartType = UI.DataVisualization.Charting.SeriesChartType.Spline
                Me.AVG_DAYS_ON.ChartAreas("ChartArea1").AxisY.Title = "Days On Market"

                Me.AVG_DAYS_ON.Series("AVG_DAYS").Color = Drawing.Color.Blue
                Me.AVG_DAYS_ON.Series("AVG_DAYS").BorderWidth = 2
                Me.AVG_DAYS_ON.Series("AVG_DAYS").MarkerSize = 6
                Me.AVG_DAYS_ON.Series("AVG_DAYS").MarkerStyle = UI.DataVisualization.Charting.MarkerStyle.Circle
                Me.AVG_DAYS_ON.BorderlineWidth = 10
                Me.AVG_DAYS_ON.Series("AVG_DAYS").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32
                If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                    Me.AVG_DAYS_ON.Width = 250
                    Me.AVG_DAYS_ON.Height = 250
                End If

                Do While adoRs.Read
                    If Not IsDBNull(adoRs("mtrend_year")) Then
                        If adoRs("mtrend_year").ToString <> "" Then
                            If Not IsDBNull(adoRs("mtrend_month")) Then
                                If adoRs("mtrend_month").ToString <> "" Then
                                    ' outstring = outstring & "data.setValue(" & x & ", 0, '" & CStr(adoRs("mtrend_month")) & "-" & CStr(adoRs("mtrend_year")) & "');" & vbCrLf
                                    counter1 = adoRs("mtrend_year")
                                    If Not IsDBNull(adoRs("mtrend_avg_market_days")) Then
                                        If CDbl(adoRs("mtrend_avg_market_days")) >= 0 Then

                                            sized_down_number = (adoRs("mtrend_avg_market_days"))

                                            If CDbl(sized_down_number) > high_number Then
                                                high_number = sized_down_number
                                            End If

                                            If CDbl(sized_down_number) < low_number Then
                                                low_number = sized_down_number
                                            End If



                                            Me.AVG_DAYS_ON.Series("AVG_DAYS").Points.AddXY((adoRs("mtrend_month") & "-" & adoRs("mtrend_year")), sized_down_number)


                                            'outstring = outstring & "data.setValue(" & x & ", 1, " & Format(adoRs("mtrend_avg_market_days"), 0) & ");" & vbCrLf
                                        Else
                                            'outstring = outstring & "data.setValue(" & x & ", 1, 0);" & vbCrLf
                                        End If
                                    Else
                                        'outstring = outstring & "data.setValue(" & x & ", 1, 0);" & vbCrLf
                                    End If
                                    x = x + 1
                                End If
                            End If
                        End If
                    End If

                Loop

                If low_number > 200 Then
                    starting_point = (low_number / 200) - 1
                    starting_point = starting_point * 200
                Else
                    starting_point = 0
                End If

                If low_number < 400 Then
                    interval_point = 100
                Else
                    interval_point = 200
                End If

                If high_number - low_number > 3000 Then
                    interval_point = (interval_point * 4)
                ElseIf high_number - low_number > 2000 Then
                    interval_point = (interval_point * 3)
                ElseIf high_number - low_number > 1000 Then
                    interval_point = (interval_point * 2)
                End If

                If high_number = 0 And low_number = 0 Then
                    Me.AVG_DAYS_ON.ChartAreas("ChartArea1").AxisY.Maximum = 1
                    Me.AVG_DAYS_ON.ChartAreas("ChartArea1").AxisY.Minimum = 0
                    Me.AVG_DAYS_ON.ChartAreas("ChartArea1").AxisY.Interval = 1
                Else
                    Me.AVG_DAYS_ON.ChartAreas("ChartArea1").AxisY.Maximum = high_number + 100
                    Me.AVG_DAYS_ON.ChartAreas("ChartArea1").AxisY.Minimum = starting_point
                    Me.AVG_DAYS_ON.ChartAreas("ChartArea1").AxisY.Interval = interval_point
                    Me.AVG_DAYS_ON.ChartAreas("ChartArea1").AxisY.LabelStyle.Format = "#,###"
                End If


                'Me.AVG_DAYS_ON.ChartAreas("ChartArea1").AxisY.Maximum = high_number
                'Me.AVG_DAYS_ON.ChartAreas("ChartArea1").AxisY.Minimum = low_number
                'Me.AVG_DAYS_ON.ChartAreas("ChartArea1").AxisY.Minimum = 0

                adoRs.close()
                adoRs = Nothing
                'outstring = outstring & "var chart = new google.visualization.LineChart(document.getElementById('visualization" & graphID & "'));" & vbCrLf
                'outstring = outstring & "chart.draw(data, {titleY: 'Days on Market', smoothLine: true, legend: 'none'});" & vbCrLf
                'outstring = outstring & "}" & vbCrLf
                'outstring = outstring & "</script>" & vbCrLf
            Else
                outstring = ""
            End If

            outstring = "Average Days on Market for Sales (past 6 months)"

            display_average_days_on_market_graph_compare = Trim(outstring)
        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function
    Function Build_Model_Comparison_PDF(ByVal amod_id, ByVal real_make_model_name, ByVal amod_id2, ByVal amod_id3, ByVal make_model_name2, ByVal make_model_name3, ByVal sub_info, ByVal sub_type, ByVal real_company_name, ByVal airframe, ByVal months) As String
        Build_Model_Comparison_PDF = ""
        Dim page_total As Integer = 0
        Dim mode1_page1 As String = ""
        Dim mode2_page1 As String = ""
        Dim mode3_page1 As String = ""

        If months = 0 Then
            months = 6
        End If

        Build_Model_Comparison_PDF = Build_PDF_Template_Header_Final(WD).ToString ' style information



        If Me.MCOMP_FMS.Checked Then
            mode1_page1 = mode1_page1 & Build_FleetMarketSummary_For_Compare(amod_id, False, real_make_model_name, 2, "Y", localCriteria)
            mode2_page1 = mode2_page1 & Build_FleetMarketSummary_For_Compare(amod_id2, False, make_model_name2, 2, "Y", localCriteria)
            If amod_id3 > 0 Then
                mode3_page1 = mode3_page1 & Build_FleetMarketSummary_For_Compare(amod_id3, False, make_model_name3, 2, "Y", localCriteria)
            End If
            If page_total > 0 Then
                Build_Model_Comparison_PDF += Insert_Page_Break_PDF()
            End If
            page_total = page_total + 1

            Build_Model_Comparison_PDF += Build_PDF_Header_Final("Model Comparison Report", sub_info, real_make_model_name, real_company_name, sub_type, "", "", airframe, False)

            If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                Build_Model_Comparison_PDF += "<table width='" & word_width & "' align='center'><tr>"
                Build_Model_Comparison_PDF += "<td width='" & word_32 & "' align='center'>"
            Else
                Build_Model_Comparison_PDF += "<table width='96%' align='center'><tr>"
                Build_Model_Comparison_PDF += "<td width='32%' align='center'>"
            End If




            Build_Model_Comparison_PDF += "<table height='210' valign='top'  align='center'><tr valign='top'><td valign='top'>" & check_model_pic_exists(amod_id, 200) & "</td></tr></table>"
            Build_Model_Comparison_PDF += "<br>" & real_make_model_name & "<br>"
            Build_Model_Comparison_PDF += mode1_page1
            Build_Model_Comparison_PDF += "</td>"

            If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                Build_Model_Comparison_PDF += "<td width='" & word_32 & "' align='center'>"
            Else
                Build_Model_Comparison_PDF += "<td width='32%' align='center'>"
            End If



            Build_Model_Comparison_PDF += "<table height='210' valign='top' align='center'><tr valign='top'><td valign='top'>" & check_model_pic_exists(amod_id2, 200) & "</td></tr></table>"
            Build_Model_Comparison_PDF += "<br>" & make_model_name2 & "<br>"
            Build_Model_Comparison_PDF += mode2_page1
            Build_Model_Comparison_PDF += "</td>"
            If amod_id3 > 0 Then
                If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                    Build_Model_Comparison_PDF += "<td width='" & word_32 & "' align='center'>"
                Else
                    Build_Model_Comparison_PDF += "<td width='32%' align='center'>"
                End If

                Build_Model_Comparison_PDF += "<table height='210' valign='top' align='center'><tr valign='top'><td valign='top'>" & check_model_pic_exists(amod_id3, 200) & "</td></tr></table>"
                Build_Model_Comparison_PDF += "<br>" & make_model_name3 & "<br>"
                Build_Model_Comparison_PDF += mode3_page1
                Build_Model_Comparison_PDF += "</td>"
            End If
            Build_Model_Comparison_PDF += "</tr></table>"
            Build_Model_Comparison_PDF += Build_PDF_Template_Footer()
        End If



        If Me.MC_AVG_PRICE.Checked Then

            If page_total > 0 Then
                Build_Model_Comparison_PDF += Insert_Page_Break_PDF()
            End If
            page_total = page_total + 1
            Build_Model_Comparison_PDF += Build_PDF_Header_Final("Model Comparison Report", sub_info, real_make_model_name, real_company_name, sub_type, "", "", airframe, False)
            Build_Model_Comparison_PDF += "<table width='100%' align='center'><tr><td align='center'>"
            Me.AVG_PRICE_MONTH.Titles.Add(display_avg_price_by_month_graph_compare(amod_id, months))
            Me.AVG_PRICE_MONTH.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
            Me.AVG_PRICE_MONTH.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "_AVG_PRICE_MONTH.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
            Build_Model_Comparison_PDF += "<table width='80%' align='center'><tr><td width='50%'>" & real_make_model_name & "</td><td><img src='" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "_AVG_PRICE_MONTH.jpg'><br></td></tr></table>"
            Build_Model_Comparison_PDF += "</td></tr><tr><td align='center'>"
            Me.AVG_PRICE_MONTH.Titles.Clear()
            Me.AVG_PRICE_MONTH.Series.Clear()
            Me.AVG_PRICE_MONTH.Titles.Add(display_avg_price_by_month_graph_compare(amod_id2, months))
            Me.AVG_PRICE_MONTH.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
            Me.AVG_PRICE_MONTH.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id2.ToString + "_AVG_PRICE_MONTH.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
            Build_Model_Comparison_PDF += "<table width='80%' align='center'><tr><td width='50%'>" & make_model_name2 & "</td><td><img src='" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id2.ToString + "_AVG_PRICE_MONTH.jpg'><br></td></tr></table>"
            Build_Model_Comparison_PDF += "</td></tr><tr><td align='center'>"
            Me.AVG_PRICE_MONTH.Titles.Clear()
            Me.AVG_PRICE_MONTH.Series.Clear()
            If amod_id3 > 0 Then
                Me.AVG_PRICE_MONTH.Titles.Add(display_avg_price_by_month_graph_compare(amod_id3, months))
                Me.AVG_PRICE_MONTH.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                Me.AVG_PRICE_MONTH.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id3.ToString + "_AVG_PRICE_MONTH.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
                Build_Model_Comparison_PDF += "<table width='80%' align='center'><tr><td width='50%'>" & make_model_name3 & "</td><td><img src='" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id3.ToString + "_AVG_PRICE_MONTH.jpg'><br></td></tr></table>"
            End If
            Build_Model_Comparison_PDF += "</td></tr></table>"
            Build_Model_Comparison_PDF += Build_PDF_Template_Footer()
        End If


        If Me.MC_FSBM.Checked Then

            If page_total > 0 Then
                Build_Model_Comparison_PDF += Insert_Page_Break_PDF()
            End If
            page_total = page_total + 1
            Build_Model_Comparison_PDF += Build_PDF_Header_Final("Model Comparison Report", sub_info, real_make_model_name, real_company_name, sub_type, "", "", airframe, False)
            Build_Model_Comparison_PDF += "<table width='100%'><tr><td align='center'>"
            Me.FOR_SALE.Titles.Add(display_for_sale_by_month_graph_compare(amod_id, FOR_SALE, months))
            Me.FOR_SALE.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
            Me.FOR_SALE.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "_FOR_SALE.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
            Build_Model_Comparison_PDF += "<table width='80%'><tr><td width='50%'>" & real_make_model_name & "</td><td><img src='" & location_string & "tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "_FOR_SALE.jpg'><br></td></tr></table>"
            Build_Model_Comparison_PDF += "</td></tr><tr><td align='center'>"
            Me.FOR_SALE.Titles.Clear()
            Me.FOR_SALE.Series.Clear()
            Me.FOR_SALE.Titles.Add(display_for_sale_by_month_graph_compare(amod_id2, FOR_SALE, months))
            Me.FOR_SALE.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
            Me.FOR_SALE.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id2.ToString + "_FOR_SALE.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
            Build_Model_Comparison_PDF += "<table width='80%'><tr><td width='50%'>" & make_model_name2 & "</td><td><img src='" & location_string & "tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id2.ToString + "_FOR_SALE.jpg'><br></td></tr></table>"
            Build_Model_Comparison_PDF += "</td></tr><tr><td align='center'>"
            Me.FOR_SALE.Titles.Clear()
            Me.FOR_SALE.Series.Clear()
            If amod_id3 > 0 Then
                Me.FOR_SALE.Titles.Add(display_for_sale_by_month_graph_compare(amod_id3, FOR_SALE, months))
                Me.FOR_SALE.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                Me.FOR_SALE.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id3.ToString + "_FOR_SALE.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
                Build_Model_Comparison_PDF += "<table width='80%'><tr><td width='50%'>" & make_model_name3 & "</td><td><img src='" & location_string & "tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id3.ToString + "_FOR_SALE.jpg'><br></td></tr></table>"
            End If
            Build_Model_Comparison_PDF += "</td></tr></table>"
            Build_Model_Comparison_PDF += Build_PDF_Template_Footer()
        End If


        If Me.MC_SOLD_PM.Checked Then

            If page_total > 0 Then
                Build_Model_Comparison_PDF += Insert_Page_Break_PDF()
            End If
            page_total = page_total + 1
            Build_Model_Comparison_PDF += Build_PDF_Header_Final("Model Comparison Report", sub_info, real_make_model_name, real_company_name, sub_type, "", "", airframe, False)
            Build_Model_Comparison_PDF += "<table width='100%'><tr><td align='center'>"
            Me.PER_MONTH.Titles.Add(display_sold_per_month_graph_compare(False, False, amod_id, PER_MONTH, months, False))
            Me.PER_MONTH.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
            Me.PER_MONTH.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "_PER_MONTH.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
            Build_Model_Comparison_PDF += "<table width='80%'><tr><td width='50%'>" & real_make_model_name & "</td><td><img src='" & location_string & "tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "_PER_MONTH.jpg'><br></td></tr></table>"
            Build_Model_Comparison_PDF += "</td></tr><tr><td align='center'>"
            Me.PER_MONTH.Titles.Clear()
            Me.PER_MONTH.Series.Clear()
            Me.PER_MONTH.Titles.Add(display_sold_per_month_graph_compare(False, False, amod_id2, PER_MONTH, months, False))
            Me.PER_MONTH.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
            Me.PER_MONTH.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id2.ToString + "_PER_MONTH.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
            Build_Model_Comparison_PDF += "<table width='80%'><tr><td width='50%'>" & make_model_name2 & "</td><td><img src='" & location_string & "tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id2.ToString + "_PER_MONTH.jpg'><br></td></tr></table>"
            Build_Model_Comparison_PDF += "</td></tr><tr><td align='center'>"
            Me.PER_MONTH.Titles.Clear()
            Me.PER_MONTH.Series.Clear()
            If amod_id3 > 0 Then
                Me.PER_MONTH.Titles.Add(display_sold_per_month_graph_compare(False, False, amod_id3, PER_MONTH, months, False))
                Me.PER_MONTH.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                Me.PER_MONTH.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id3.ToString + "_PER_MONTH.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
                Build_Model_Comparison_PDF += "<table width='80%'><tr><td width='50%'>" & make_model_name3 & "</td><td><img src='" & location_string & "tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id3.ToString + "_PER_MONTH.jpg'><br></td></tr></table>"
            End If
            Build_Model_Comparison_PDF += "</td></tr></table>"
            Build_Model_Comparison_PDF += Build_PDF_Template_Footer()
        End If

        If Me.MC_AVG_DOM.Checked Then
            If page_total > 0 Then
                Build_Model_Comparison_PDF += Insert_Page_Break_PDF()
            End If
            page_total = page_total + 1
            Build_Model_Comparison_PDF += Build_PDF_Header_Final("Model Comparison Report", sub_info, real_make_model_name, real_company_name, sub_type, "", "", airframe, False)
            Build_Model_Comparison_PDF += "<table width='100%'><tr><td align='center'>"
            Me.AVG_DAYS_ON.Titles.Add(display_average_days_on_market_graph_compare(amod_id, AVG_DAYS_ON, months))
            Me.AVG_DAYS_ON.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
            Me.AVG_DAYS_ON.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) & "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix & amod_id.ToString & "_AVG_DAYS_ON.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
            Build_Model_Comparison_PDF += "<table width='80%'><tr><td width='50%'>" & real_make_model_name & "</td><td><img src='" & location_string & "tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix & amod_id.ToString & "_AVG_DAYS_ON.jpg'><br></td></tr></table>"
            Build_Model_Comparison_PDF += "</td></tr><tr><td align='center'>"
            Me.AVG_DAYS_ON.Titles.Clear()
            Me.AVG_DAYS_ON.Series.Clear()
            Me.AVG_DAYS_ON.Titles.Add(display_average_days_on_market_graph_compare(amod_id2, AVG_DAYS_ON, months))
            Me.AVG_DAYS_ON.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
            Me.AVG_DAYS_ON.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) & "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix & amod_id2.ToString & "_AVG_DAYS_ON.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
            Build_Model_Comparison_PDF += "<table width='80%'><tr><td width='50%'>" & make_model_name2 & "</td><td><img src='" & location_string & "tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix & amod_id2.ToString & "_AVG_DAYS_ON.jpg'><br></td></tr></table>"
            Build_Model_Comparison_PDF += "</td></tr><tr><td align='center'>"
            Me.AVG_DAYS_ON.Titles.Clear()
            Me.AVG_DAYS_ON.Series.Clear()
            If amod_id3 > 0 Then
                Me.AVG_DAYS_ON.Titles.Add(display_average_days_on_market_graph_compare(amod_id3, AVG_DAYS_ON, months))
                Me.AVG_DAYS_ON.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                Me.AVG_DAYS_ON.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) & "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix & amod_id3.ToString & "_AVG_DAYS_ON.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
                Build_Model_Comparison_PDF += "<table width='80%'><tr><td width='50%'>" & make_model_name3 & "</td><td><img src='" & location_string & "tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix & amod_id3.ToString & "_AVG_DAYS_ON.jpg'><br></td></tr></table>"
            End If
            Build_Model_Comparison_PDF += "</td></tr></table>"
            Build_Model_Comparison_PDF += Build_PDF_Template_Footer()
        End If




        Build_Model_Comparison_PDF = Replace(Build_Model_Comparison_PDF, "<img src='" & location_string & "images/marketpdfheader.jpg' />", "")

    End Function
    Public Sub Load_Values_Variables()

        If Trim(Request("year_start")) <> "" Then
            year_start.Text = Trim(Request("year_start"))
            localCriteria.ViewCriteriaYearStart = year_start.Text
        Else
            year_start.Text = ""
        End If


        If Trim(Request("year_end")) <> "" Then
            year_end.Text = Trim(Request("year_end"))
            localCriteria.ViewCriteriaYearEnd = year_end.Text
        Else
            year_end.Text = ""
        End If


        If Trim(Request("aftt_start")) <> "" Then
            aftt_start.Text = Trim(Request("aftt_start"))
            localCriteria.ViewCriteriaAFTTStart = aftt_start.Text
        Else
            aftt_start.Text = "0"
        End If


        If Trim(Request("aftt_end")) <> "" Then
            aftt_end.Text = Trim(Request("aftt_end"))
            localCriteria.ViewCriteriaAFTTEnd = aftt_end.Text
        Else
            aftt_end.Text = "0"
        End If



        If Not IsNothing(Request.Item("yearFilter")) Then
            If Not String.IsNullOrEmpty(Request.Item("yearFilter").ToString) Then
                If Request.Item("yearFilter") = "true" Then
                    yearFilter = True
                    valueHeaderString += year_start.Text & "-" & year_end.Text
                End If '
            End If
        End If

        If Not IsNothing(Request.Item("afttFilter")) Then
            If Not String.IsNullOrEmpty(Request.Item("afttFilter").ToString) Then
                If Request.Item("afttFilter") = "true" Then
                    afttFilter = True
                    valueHeaderString += " MODELS WITH AFTT FROM " & aftt_start.Text & " to " & aftt_end.Text
                End If '
            End If
        End If

        If afttFilter = False And yearFilter = True Then
            valueHeaderString += " MODELS"
        End If

        If yearFilter = True Or afttFilter = True Then
            valueHeaderString = "<span>" & valueHeaderString & "</span>"
            valueEmptyHeaderString = "<span>Entire Fleet</span>"
        End If


        'If Trim(Request("aircraft_registration")) <> "" Then
        '  aircraft_registration.Text = ""
        'Else
        '  aircraft_registration.Text = ""
        'End If


        If Trim(Request("start_date")) <> "" Then
            start_date.Text = Trim(Request("start_date"))
        Else
            start_date.Text = localCriteria.ViewCriteriaDocumentsStartDate

        End If
        If Trim(Request("end_date")) <> "" Then
            end_date.Text = Trim(Request("end_date"))
        Else
            end_date.Text = localCriteria.ViewCriteriaDocumentsEndDate
        End If

        If Trim(Request("VariantList")) <> "" Then
            VariantList.Text = Trim(Request("VariantList"))
        Else
            VariantList.Text = ""
        End If

        Dim CurrentTransactionTable As New DataTable
        CurrentTransactionTable = GetTransactionAircraftStartingTable(NEW_PDF_AMOD_ID, "", "", 1)
        ' clsGeneral.clsGeneral.ExtractSelectedStringFromListboxDropdown(VariantList, False, 0, True)
        GrabCurrentModelInformation(CurrentTransactionTable, 1)

        CurrentTransactionTable = GetTransactionAircraftStartingTable(NEW_PDF_AMOD_ID, "", "", 2)
        ' clsGeneral.clsGeneral.ExtractSelectedStringFromListboxDropdown(VariantList, False, 0, True)
        GrabCurrentModelInformation(CurrentTransactionTable, 2)

        'If Trim(Request("modelAirframeTypeCode")) <> "" Then
        '  modelAirframeTypeCode.Text = Trim(Request("modelAirframeTypeCode"))
        'Else
        '  modelAirframeTypeCode.Text = "F"
        'End If
        'If Trim(Request("ModelTypeCode")) <> "" Then
        '  ModelTypeCode.Text = Trim(Request("ModelTypeCode"))
        'Else
        '  ModelTypeCode.Text = "J"
        'End If
        'If Trim(Request("ModelWeightClass")) <> "" Then
        '  ModelWeightClass.Text = Trim(Request("ModelWeightClass"))
        'Else
        '  ModelWeightClass.Text = "H"
        'End If


    End Sub

    Public Sub SetUpJavascriptOnClickGoogleGraph_Residual()
        Dim jScript As String = ""
        jScript = ""
        jScript = "$(""#" & btnRunReport.ClientID & """).click(function() {"
        jScript += "$(""#" & valueGraphText7.ClientID & """).val($('#" & png7.ClientID & " img').prop('src'));"
        jScript += "});"
        System.Web.UI.ScriptManager.RegisterStartupScript(Me, Me.GetType(), "btnReportOnClickEvent", jScript.ToString, True)
    End Sub
    Public Sub SetUpJavascriptOnClickGoogleGraph()
        Dim jScript As String = ""
        jScript = ""
        jScript = "$(""#" & btnRunReport.ClientID & """).click(function() {"
        jScript += "$(""#" & valueGraphText.ClientID & """).val($('#" & png2.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valueGraphText4.ClientID & """).val($('#" & png4.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valueGraphText5.ClientID & """).val($('#" & png5.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valueGraphText6.ClientID & """).val($('#" & png6.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valueGraphText7.ClientID & """).val($('#" & png7.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valueGraphText8.ClientID & """).val($('#" & png8.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valueGraphText9.ClientID & """).val($('#" & png9.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valueGraphText10.ClientID & """).val($('#" & png10.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valueGraphText11.ClientID & """).val($('#" & png11.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valueGraphText12.ClientID & """).val($('#" & png12.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valueGraphText13.ClientID & """).val($('#" & png13.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valueGraphText14.ClientID & """).val($('#" & png14.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valueGraphText15.ClientID & """).val($('#" & png15.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valueGraphText16.ClientID & """).val($('#" & png16.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valueGraphText17.ClientID & """).val($('#" & png17.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valueGraphText18.ClientID & """).val($('#" & png18.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valueGraphText19.ClientID & """).val($('#" & png19.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valueGraphText21.ClientID & """).val($('#" & png21.ClientID & " img').prop('src'));"
        jScript += "$(""#" & ValueGraphText22.ClientID & """).val($('#" & png22.ClientID & " img').prop('src'));"
        jScript += "$(""#" & ValueGraphText23.ClientID & """).val($('#" & png23.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valueGraphText24.ClientID & """).val($('#" & png24.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valueGraphText25.ClientID & """).val($('#" & png25.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valueGraphText26.ClientID & """).val($('#" & png26.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valueGraphTextGuage1.ClientID & """).val($('#" & pngGuage1.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valueGraphTextGuageUS.ClientID & """).val($('#" & pngGuageUS.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valueGraphTextGuageForeign.ClientID & """).val($('#" & pngGuageForeign.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valueGraphTextGuage2.ClientID & """).val($('#" & pngGuage2.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valueGraphTextGauge3.ClientID & """).val($('#" & pngGauge3.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valueGraphTextGauge4.ClientID & """).val($('#" & pngGauge4.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valueGraphTextGauge5.ClientID & """).val($('#" & pngGauge5.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valueGraphTextGauge6.ClientID & """).val($('#" & pngGauge6.ClientID & " img').prop('src'));"
        jScript += "$(""#" & visualizationGraphText.ClientID & """).val($('#" & visualizationPNG1.ClientID & " img').prop('src'));"
        ' jScript += "$(""#" & valueGraphText20.ClientID & """).val($('#" & png20.ClientID & " img').prop('src'));"

        jScript += "$(""#" & features1text.ClientID & """).val($('#" & features1image.ClientID & " img').prop('src'));"
        jScript += "$(""#" & features2text.ClientID & """).val($('#" & features2image.ClientID & " img').prop('src'));"
        jScript += "$(""#" & features3text.ClientID & """).val($('#" & features3image.ClientID & " img').prop('src'));"
        jScript += "$(""#" & features4text.ClientID & """).val($('#" & features4image.ClientID & " img').prop('src'));"
        jScript += "$(""#" & features5text.ClientID & """).val($('#" & features5image.ClientID & " img').prop('src'));"
        jScript += "$(""#" & features6text.ClientID & """).val($('#" & features6image.ClientID & " img').prop('src'));"


        jScript += "$(""#" & valuuationGraph1.ClientID & """).val($('#" & pngValuation1.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valuuationGraph2.ClientID & """).val($('#" & pngValuation2.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valuuationGraph3.ClientID & """).val($('#" & pngValuation3.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valuuationGraph4.ClientID & """).val($('#" & pngValuation4.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valuuationGraph5.ClientID & """).val($('#" & pngValuation5.ClientID & " img').prop('src'));"


        jScript += "$(""#" & valueGraphText32.ClientID & """).val($('#" & png32.ClientID & " img').prop('src'));"
        jScript += "$(""#" & valueGraphText33.ClientID & """).val($('#" & png33.ClientID & " img').prop('src'));"


        'jScript += "$(""#" & program1text.ClientID & """).val($('#" & program1image.ClientID & " img').prop('src'));"
        'jScript += "$(""#" & program2text.ClientID & """).val($('#" & program2image.ClientID & " img').prop('src'));"
        'jScript += "$(""#" & program3text.ClientID & """).val($('#" & program3image.ClientID & " img').prop('src'));"



        jScript += "});"
        System.Web.UI.ScriptManager.RegisterStartupScript(Me, Me.GetType(), "btnReportOnClickEvent", jScript.ToString, True)
    End Sub
    Public Function create_graph_color(ByVal table_color) As String
        create_graph_color = ""

        If Trim(table_color) = "light_blue" Then
            create_graph_color = "lightBlue"
        Else
            create_graph_color = table_color
        End If

    End Function

    Public Function Build_VALUES_Summary_PDF_Standard(ByVal amod_id As Long, ByVal real_make_model_name As String, ByVal months As Long, Optional ByVal amod_string As String = "", Optional ByVal view_id As Long = 998) As String

        Session("FONT_CLASS_TEXT") = ""
        Session("FONT_CLASS_TEXT_TITLE") = ""
        Session("FONT_CLASS_HEADER") = ""
        Session("FONT_CLASS_HEADER_BIG") = ""

        Dim htmlOut = New StringBuilder()


        Try

            ' HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag = False



            If WD.SelectedValue = "Word" Then
                bWordReport = True
            End If

            If Not IsNothing(Request.Item("word_width")) Then
                If Not String.IsNullOrEmpty(Request.Item("word_width").ToString.Trim) Then
                    word_width = Request.Item("word_width").ToString.ToUpper.Contains("Y")
                End If
            End If

            table_color = market_color.SelectedValue
            graph_color_new = create_graph_color(table_color)
            HttpContext.Current.Session.Item("graph_color") = graph_color_new  ' table_color

            'If Not IsNothing(Request.Item("pdf_html_width")) Then
            '  If Not String.IsNullOrEmpty(Request.Item("pdf_html_width").ToString.Trim) Then
            '    pdf_html_width = Request.Item("pdf_html_width").ToString.ToUpper.Contains("Y")
            '  End If
            'End If

            localdatalayer = New viewsDataLayer
            localdatalayer.adminConnectStr = Application.Item("crmClientSiteData").AdminDatabaseConn
            localdatalayer.clientConnectStr = Session.Item("localPreferences").UserDatabaseConn
            localdatalayer.starConnectStr = Session.Item("localPreferences").STARDatabaseConn
            localdatalayer.serverConnectStr = Session.Item("localPreferences").ServerNotesDatabaseConn

            util_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            util_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            util_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            util_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            util_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

            util_view_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            util_view_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            util_view_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            util_view_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            util_view_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

            market_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            market_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            market_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            market_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            market_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

            localCriteria.ViewCriteriaAmodID = amod_id

            If Trim(month_timeframe.SelectedValue.Trim) <> "" Then
                localCriteria.ViewCriteriaTimeSpan = Trim(month_timeframe.SelectedValue.Trim)
            Else
                localCriteria.ViewCriteriaTimeSpan = 12
            End If


            localCriteria.ViewCriteriaDocumentsStartDate = FormatDateTime(DateAdd(DateInterval.Month, -localCriteria.ViewCriteriaTimeSpan, Now()), DateFormat.ShortDate)
            localCriteria.ViewCriteriaDocumentsEndDate = FormatDateTime(Now(), DateFormat.ShortDate)

            NEW_PDF_AMOD_ID = amod_id

            If Trim(Request("year_start")) <> "" Then
                Call Load_Values_Variables_From_ViewMaster()
            Else
                Call Load_Values_Variables()
            End If

            htmlOut.Append("<html><head><meta charset=""UTF-8"">")
            htmlOut.Append(comp_functions.NEW_build_style_page_full_spec(bWordReport, False, 998, table_color))

            If Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CRM Then
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='" & Application.Item("crmClientSiteData").ClientFullHostName & "EvoStyles/stylesheets/tableThemes.css' />")
            ElseIf InStr(Application.Item("crmClientSiteData").ClientFullHostName, "https://") > 0 Or InStr(Application.Item("crmClientSiteData").ClientFullHostName, "testjetnet") > 0 Or Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CUSTOMER_CENTER Then   ' added customer center here to get style from evo 
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='http://www.jetnetevolution.com/EvoStyles/stylesheets/tableThemes.css' />")
            Else
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='" & Application.Item("crmClientSiteData").ClientFullHostName & "EvoStyles/stylesheets/tableThemes.css' />")
            End If


            htmlOut.Append("</head><body " & IIf(Me.CP.Checked = False, "class=""withoutCover""", "") & ">")


            If view_id = 997 Then

                If Me.MR_CMS.Checked = True Then
                    Call NEW_VALUES_CREATE_PDF_SPEC_PAGE("current_market", htmlOut, amod_id, amod_string)
                End If


            Else



                If Me.CP.Checked And (view_id = 997 Or view_id = 998) Then
                    Dim companyName As String = ""

                    htmlOut.Append(comp_functions.NEW_build_style_page_full_spec(bWordReport, True, 998, table_color))

                    Call comp_functions.CompanyInformationHeaderWithPNG(0, "", comp_address, comp_logo, invisible_label_parent_image, logo_check, bWordReport, companyName, "PDF", Me.chk_alt_name.Checked)

                    If chk_header.Checked = True Or logo_check.Checked = True Then
                        temp_pdf_header = comp_functions.NEW_build_full_spec_page_header(0, "", comp_address, comp_logo, amod_id, 0, bWordReport, word_width_new, pdf_html_width, check_prepared_for, Nothing, prepared_for, "", True, chk_header.Checked, logo_check.Checked)
                    Else
                        temp_pdf_header = ""
                    End If

                    Dim imgFolder As String = HttpContext.Current.Server.MapPath(Session.Item("ModelPicturesFolderVirtualPath"))
                    '  Dim imgDisplayFolder As String = Application.Item("crmClientSiteData").ClientFullHostName & Session.Item("ModelPicturesFolderVirtualPath")
                    Dim imgDisplayFolder As String = Session.Item("ModelPicturesFolderVirtualPath")
                    Dim imgDisplayFolder_AC As String = HttpContext.Current.Server.MapPath(Session.Item("AircraftPicturesFolderVirtualPath"))


                    'http://www.jetnetevolution.com/pictures/model/


                    Dim imgFileName As String = amod_id.ToString.Trim + ".jpg"
                    Dim temp_header1 As String = ""

                    If Me.no_back_check.Checked = True Then
                        If Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CRM Then
                            temp_header1 &= ("<table width='100%' height='1324' cellpadding=""0"" cellspacing=""0"" style=""background-size:100% 1449px;""><tr><td valign=""bottom"">")
                        Else
                            temp_header1 &= ("<table width='100%' height='1324' cellpadding=""0"" cellspacing=""0"" style=""background-size:100% 1449px;""><tr><td valign=""bottom"">")
                        End If
                    Else
                        If Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CRM Then
                            temp_header1 &= ("<table width='100%' height='1324' cellpadding=""0"" cellspacing=""0"" style=""background-color:#d4d4d4;background-size:100% 1449px;background-image:url('" & Application.Item("crmClientSiteData").ClientFullHostName & "/images/background/wordBackground.jpg');""><tr><td valign=""bottom"">")
                        Else
                            temp_header1 &= ("<table width='100%' height='1324' cellpadding=""0"" cellspacing=""0"" style=""background-color:#d4d4d4;background-size:100% 1449px;background-image:url('http://www.jetnetevolution.com/images/background/wordBackground.jpg');""><tr><td valign=""bottom"">")
                        End If
                    End If




                    temp_header1 &= ("<table cellspacing='0' cellpadding='0' border='0' width='100%' cellpadding=""0"" cellspacing=""0"" class=""viewValueExport"">")


                    temp_header1 &= ("<tr><td nowrap='nowrap'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td align='left' width='65%' height='1100'><table align='right' width='100%' cellpadding=""0"" cellspacing=""0""><tr><td style='border-bottom-style:solid; border-bottom-width:2px; border-color:#fff' align='left'><font face='arial' style='padding-bottom:15px;display:inline-block;font-size:36px;color:#e1e1e1;'><strong>MARKET REPORT</strong></td></tr>")

                    ' if u check either of the report options from an aircraft, then it will list it, otherwise, it is like it was ran from a model
                    If new_PDF_AC_ID > 0 And (achigh_check.Checked = True Or acpic_cover.Checked = True) Then
                        temp_header1 &= ("<tr><td align='left'><font color='#fff' face='arial' class=""makeModel""><strong>" & commonEvo.GetAircraftInfo(new_PDF_AC_ID, False, True, True) & "</strong></font><br />")
                    Else
                        temp_header1 &= ("<tr><td align='left'><font color='#fff' face='arial' class=""makeModel""><strong>" & real_make_model_name & "</strong></font><br />")
                    End If


                    If check_prepared_for.Checked = True Then
                        If prepared_for.Text <> "" Then
                            temp_header1 &= ("<font face='arial' color='#fff' class=""dateName"">PREPARED FOR: </b>" & Trim(prepared_for.Text) & "</font><br />")
                        End If
                    End If

                    temp_header1 &= ("<font face='arial' color='#fff' class=""dateName"">" & MonthName(Month(Now())) & " " & Day(Now()) & ", " & Year(Now()) & "</font>")
                    temp_header1 &= ("</td></tr></table></td><td align='left' width='15%'>")

                    If Me.no_back_check.Checked = True Then
                        ' temp_header1 = Replace(temp_header1, "#fff", "#000000")
                        ' temp_header1 = Replace(temp_header1, "#e1e1e1", "#000000")
                        temp_header1 = Replace(temp_header1, "#fff", "#6E6E6E")
                        temp_header1 = Replace(temp_header1, "#e1e1e1", "#6E6E6E")
                    End If

                    htmlOut.Append(temp_header1)

                    If Me.acpic_cover.Checked = True Then

                        Dim sqlReaderTemp As System.Data.SqlClient.SqlDataReader = Nothing
                        Dim sqlReader As System.Data.SqlClient.SqlDataReader = Nothing

                        Dim SqlConn As New System.Data.SqlClient.SqlConnection
                        Dim SqlConn2 As New System.Data.SqlClient.SqlConnection
                        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
                        Dim SqlCommand2 As New System.Data.SqlClient.SqlCommand

                        Dim fApicSubject As String = ""
                        Dim fAcpic_image_type As String = ""
                        Dim fAcpic_id As Integer = 0
                        Dim pic_seq_num As Integer = 0
                        Dim Query As String = ""
                        Dim ac_image_file As String = ""
                        Dim temp_height As Integer = 0
                        Dim temp_width As Integer = 0
                        Dim desired_width As Integer = 360
                        Dim desired_height As Integer = 140
                        Dim zimage2 As System.Drawing.Image
                        '    Dim zimage3 As System.Drawing.Image
                        Dim temp_percent1 As Double = 0.0
                        Dim temp_percent2 As Double = 0.0

                        Try

                            SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
                            SqlConn.Open()


                            SqlCommand.Connection = SqlConn
                            SqlCommand.CommandType = System.Data.CommandType.Text
                            SqlCommand.CommandTimeout = 90

                            Query = "SELECT TOP 1 * FROM Aircraft_Pictures WITH(NOLOCK)"
                            Query += " WHERE acpic_ac_id = " & new_PDF_AC_ID
                            Query += " AND acpic_journ_id = 0 "
                            Query += " AND acpic_seq_no > 0"
                            Query += " AND acpic_image_type = 'JPG'"
                            Query += " AND acpic_hide_flag = 'N'"
                            Query += " ORDER BY acpic_seq_no"

                            SqlCommand.CommandText = Query
                            sqlReaderTemp = SqlCommand.ExecuteReader()

                            If sqlReaderTemp.HasRows Then

                                sqlReaderTemp.Read()

                                pic_seq_num = CInt(sqlReaderTemp.Item("acpic_seq_no").ToString)

                                If Not IsDBNull(sqlReaderTemp("acpic_image_type")) Then
                                    fAcpic_image_type = sqlReaderTemp.Item("acpic_image_type").ToString.ToLower.Trim
                                End If

                                If Not IsDBNull(sqlReaderTemp("acpic_id")) Then
                                    fAcpic_id = CInt(sqlReaderTemp.Item("acpic_id").ToString.Trim)
                                End If

                                If Not (IsDBNull(sqlReaderTemp("acpic_subject"))) Then
                                    fApicSubject = sqlReaderTemp.Item("acpic_subject").ToString.Trim
                                End If



                                imgFileName = new_PDF_AC_ID & Constants.cHyphen & "0" & Constants.cHyphen & fAcpic_id.ToString & Constants.cDot & fAcpic_image_type.ToLower.Trim



                                Try
                                    ac_image_file = HttpContext.Current.Server.MapPath("pictures\aircraft\") & imgFileName
                                    zimage2 = System.Drawing.Image.FromFile(ac_image_file)
                                    temp_width = zimage2.Width
                                    temp_height = zimage2.Height



                                    ' if the width minus a little is still greater than the height, then can increase a little
                                    ' if height is not close to width, then we can increase size a little 
                                    If ((temp_width - 50) > temp_height) And (temp_width > 300) Then
                                        ' if the height is greater than the width, desired_width currrently = 378 
                                        desired_width = 390   ' can make it a little wider
                                    End If

                                    If bWordReport Then
                                        desired_width = 400
                                    End If

                                    ' if the image is wider then the desired image width, then shirnk down to size.
                                    If temp_width > desired_width Then
                                        temp_percent1 = CDbl(CDbl(desired_width) / CDbl(temp_width))
                                        temp_width = CDbl(CDbl(temp_width) * CDbl(temp_percent1))
                                        temp_height = CDbl(CDbl(temp_height) * CDbl(temp_percent1))
                                    End If

                                    'assuming generally that a square is fine
                                    If temp_height > temp_width Then
                                        temp_percent1 = CDbl(CDbl(temp_width) / CDbl(temp_height))
                                        temp_width = CDbl(CDbl(temp_width) * CDbl(temp_percent1))
                                        temp_height = CDbl(CDbl(temp_height) * CDbl(temp_percent1))
                                    End If


                                    '  If bWordReport Then
                                    ' htmlOut.Append("<img Title='" + fApicSubject.Trim + "' alt='" + fApicSubject.Trim + "' src='" + imgDisplayFolder.Trim + "/" + imgFileName.Trim + "' width='" + temp_width.ToString + "' height='" + temp_height.ToString + "'/></td>")
                                    ' Else
                                    htmlOut.Append("<img Title='" & fApicSubject.Trim & "' alt='" & fApicSubject.Trim & "' src='" & imgDisplayFolder_AC.Trim & "/" & imgFileName.Trim & "' width='" & temp_width.ToString & "' style='border-width:2px;border-style: solid;border-color:#fff;'/></td>")
                                    ' End If

                                Catch ex As Exception
                                    htmlOut.Append("<img Title='" & fApicSubject.Trim & "' alt='" & fApicSubject.Trim & "' src='" & imgDisplayFolder.Trim & "/" & imgFileName.Trim & "' width='200'/></td>")
                                End Try

                            End If

                            sqlReaderTemp.Close()

                        Catch ex As Exception

                        End Try
                    Else
                        htmlOut.Append(Replace(NEW_build_model_spec_first_picture(imgFileName, True), "Title=''", " Title='' style='border-width:2px;border-style: solid;border-color:#fff;'"))
                    End If

                    htmlOut.Append("</td><td nowrap='nowrap'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>")
                    If chk_header.Checked = True Then
                        htmlOut.Append("<tr valign='middle'><td height='200' width='700' align='left' valign=""bottom"" colspan=""4""><table align='right' width='100%' cellpadding=""0"" cellspacing=""0"" class=""overlaySep""><tr><td align='left' valign=""bottom""><span class=""companyName"">" & UCase(companyName) & "</td><td rowspan=""2"" align=""right"">" & comp_logo & "</td></tr><tr><td align='left' valign=""top""><Table align='left' cellpadding=""0"" cellspacing=""0"">" & Replace(comp_address, " class='sub_text'", " style=""font-family:Arial;font-size:18px;color:#737373""") & "</table></td></tr></table></font></td></tr>")
                    ElseIf logo_check.Checked = True Then
                        htmlOut.Append("<tr valign='middle'><td height='200' width='700' align='left' valign=""bottom"" colspan=""4""><table align='right' width='100%' cellpadding=""0"" cellspacing=""0"" class=""overlaySep""><tr><td align='left' valign=""bottom""><span class=""companyName"">&nbsp;</td><td rowspan=""2"" align=""right"">" & comp_logo & "</td></tr><tr><td align='left' valign=""top""><Table align='left' cellpadding=""0"" cellspacing=""0"">&nbsp;</table></td></tr></table></font></td></tr>")
                    End If
                    htmlOut.Append("</table>")

                    htmlOut.Append("</td></tr></table>")
                    made_first_page = True
                    'body {margin: 0%;width: 100%;height: 100%;} ' needed  
                End If




                ' htmlOut.Append("<link rel='stylesheet' type='text/css' href='" & Application.Item("crmClientSiteData").ClientFullHostName & "EvoStyles/stylesheets/additional_styles.css' />")

                ' <link rel=""stylesheet"" href=""/EvoStyles/stylesheets/.css"" />
                'htmlOut.Append("<link rel='stylesheet' type='text/css' href='../EvoStyles/stylesheets/tableThemes.css' />")

                Call comp_functions.CompanyInformationHeaderWithPNG(0, "", comp_address, comp_logo, invisible_label_parent_image, logo_check, bWordReport, "", "PDF", Me.chk_alt_name.Checked)

                'temp_pdf_header = "</div><div class=""valueSpec viewValueExport Simplistic " & table_color & """>" & comp_functions.NEW_build_full_spec_page_header(0, "", comp_address, comp_logo, amod_id, 0, bWordReport, word_width_new, pdf_html_width, check_prepared_for, Nothing, prepared_for)
                'temp_pdf_header = "" & comp_functions.NEW_build_full_spec_page_header(0, "", comp_address, comp_logo, amod_id, 0, bWordReport, word_width_new, pdf_html_width, check_prepared_for, Nothing, prepared_for)
                'temp_pdf_footer = ""


                If Me.no_back_check.Checked = True Then
                    If chk_header.Checked = True Or logo_check.Checked = True Then
                        temp_pdf_header = "</div><div class=""valueSpec viewValueExport Simplistic " & table_color & """ style=""background-image:url('/images/background/white_background.png');"">" & comp_functions.NEW_build_full_spec_page_header(0, "", comp_address, comp_logo, amod_id, 0, bWordReport, word_width_new, pdf_html_width, check_prepared_for, Nothing, prepared_for, "", True, chk_header.Checked, logo_check.Checked)
                    Else
                        temp_pdf_header = "</div><div class=""valueSpec viewValueExport Simplistic " & table_color & """ style=""background-image:url('/images/background/white_background.png');"">"

                        If bWordReport = True Then
                            temp_pdf_header &= ("<table width='" & word_width & "' align='center'><Tr><Td>&nbsp;</td></tr></table>")
                        Else
                            temp_pdf_header &= ("<div class=""viewValueExport overlaySep""><table width='100%' align='center' cellpadding=""0"" cellspacing=""0""><tr><td>&nbsp;</td></tr></table></div>")
                        End If
                    End If
                Else
                    If chk_header.Checked = True Or logo_check.Checked = True Then
                        temp_pdf_header = "</div><div class=""valueSpec viewValueExport Simplistic " & table_color & """>" & comp_functions.NEW_build_full_spec_page_header(0, "", comp_address, comp_logo, amod_id, 0, bWordReport, word_width_new, pdf_html_width, check_prepared_for, Nothing, prepared_for, "", True, chk_header.Checked, logo_check.Checked)
                    Else
                        temp_pdf_header = "</div><div class=""valueSpec viewValueExport Simplistic " & table_color & """>"

                        If bWordReport = True Then
                            temp_pdf_header &= ("<table width='" & word_width & "' align='center'><Tr><Td>&nbsp;</td></tr></table>")
                        Else
                            temp_pdf_header &= ("<div class=""viewValueExport overlaySep""><table width='100%' align='center' cellpadding=""0"" cellspacing=""0""><tr><td>&nbsp;</td></tr></table></div>")
                        End If
                    End If
                End If



                ' If Me.CP.Checked Then
                ' temp_pdf_header = "</div><div class=""valueSpec viewValueExport Simplistic " & table_color & """>" & comp_functions.NEW_build_full_spec_page_header(0, "", comp_address, comp_logo, amod_id, 0, bWordReport, word_width_new, pdf_html_width, check_prepared_for, Nothing, prepared_for)
                ' Else
                ' temp_pdf_header = "<div class=""valueSpec viewValueExport Simplistic " & table_color & """>" & comp_functions.NEW_build_full_spec_page_header(0, "", comp_address, comp_logo, amod_id, 0, bWordReport, word_width_new, pdf_html_width, check_prepared_for, Nothing, prepared_for)
                '  End If
                ' temp_pdf_header = "<div class=""valueSpec viewValueExport Simplistic " & table_color & """>" & comp_functions.NEW_build_full_spec_page_header(0, "", comp_address, comp_logo, amod_id, 0, bWordReport, word_width_new, pdf_html_width, check_prepared_for, Nothing, prepared_for)

                ' temp_pdf_header = comp_functions.NEW_build_full_spec_page_header(0, "", comp_address, comp_logo, amod_id, 0, bWordReport, word_width_new, pdf_html_width, check_prepared_for, Nothing, prepared_for)




                '------------------------- THIS IS THE START OF THE MODEL/FLEET INFO SECTION----------------------------- 
                If MR_DESC_SPECS.Checked = True Then
                    Call NEW_VALUES_CREATE_PDF_SPEC_PAGE("performance_specs_op_costs", htmlOut, amod_id, amod_string)
                End If

                'If Me.CP.Checked Then
                '  temp_pdf_header = "</div><div class=""valueSpec viewValueExport Simplistic " & table_color & """>" & comp_functions.NEW_build_full_spec_page_header(0, "", comp_address, comp_logo, amod_id, 0, bWordReport, word_width_new, pdf_html_width, check_prepared_for, Nothing, prepared_for)
                'End If

                If MR_OPERATING_COSTS.Checked = True Then
                    Call NEW_VALUES_CREATE_PDF_SPEC_PAGE("op_costs", htmlOut, amod_id, amod_string)
                End If

                If Me.MR_Fleet.Checked = True Then
                    Call NEW_VALUES_CREATE_PDF_SPEC_PAGE("fleet_summary", htmlOut, amod_id, amod_string)
                End If

                If MR_LOCATIONS.Checked = True Then
                    Call NEW_VALUES_CREATE_PDF_SPEC_PAGE("locations", htmlOut, amod_id, amod_string)
                End If

                If MR_UTILIZATION.Checked = True Then
                    Call NEW_VALUES_CREATE_PDF_SPEC_PAGE("utilization", htmlOut, amod_id, amod_string)
                End If


                '------------------------- RANGE -----------------------------

                If MMS_RM.Checked Then
                    Call NEW_VALUES_CREATE_PDF_SPEC_PAGE("range", htmlOut, amod_id, amod_string)
                End If

                '------------------------- THIS IS THE END OF THE MODEL/FLEET INFO SECTION-----------------------------



                '------------------------- THIS IS THE START OF THE CURRENT MARKET SECTION-----------------------------
                If Me.current_market_panel.Visible = True Then


                    If Me.MR_CMS.Checked = True Then
                        Call NEW_VALUES_CREATE_PDF_SPEC_PAGE("current_market", htmlOut, amod_id, amod_string)
                    End If


                    If Me.MR_CMACFORSALE.Checked = True Then
                        Call NEW_VALUES_CREATE_PDF_SPEC_PAGE("for_sale", htmlOut, amod_id, amod_string)
                    End If


                    If MR_MARKET_CHARACTERISTICS.Checked = True Then
                        Call NEW_VALUES_CREATE_PDF_SPEC_PAGE("characteristics", htmlOut, amod_id, amod_string)
                    End If

                    If Me.MR_DOM.Checked = True Then
                        Call NEW_VALUES_CREATE_PDF_SPEC_PAGE("DaysOnMarket", htmlOut, amod_id, amod_string)
                    End If


                    If MR_RECENT_MARKET.Checked = True Then
                        Call NEW_VALUES_CREATE_PDF_SPEC_PAGE("recent_market", htmlOut, amod_id, amod_string)
                    End If


                    If Me.MR_FSS.Checked = True Then
                        Call NEW_VALUES_CREATE_PDF_SPEC_PAGE("ForSaleStats", htmlOut, amod_id, amod_string)
                    End If
                End If
                '------------------------- THIS IS THE END OF THE CURRENT MARKET SECTION-----------------------------

                '' moved up to first page, under recet retail sales 
                '' Call NEW_VALUES_CREATE_PDF_SPEC_PAGE("Values_Summary", htmlOut, amod_id)


                '------------------------- THIS IS THE END OF THE SALES----------------------------- 
                If Me.sales_panel.Visible = True Then
                    ' THIS SECTION CALLS 2 SECTIONS
                    If Me.MR_SITRENS.Checked = True Or Me.MR_RRS.Checked = True Then
                        Call NEW_VALUES_CREATE_PDF_SPEC_PAGE("recent_retail", htmlOut, amod_id, amod_string)
                    End If

                    If MR_UPGRADE.Checked = True Then
                        Call NEW_VALUES_CREATE_PDF_SPEC_PAGE("upgrade", htmlOut, amod_id, amod_string)
                    End If

                    If Me.MR_STBM.Checked = True Then
                        Call NEW_VALUES_CREATE_PDF_SPEC_PAGE("Quarter", htmlOut, amod_id, amod_string)
                    End If

                    If Me.MR_STBMFR.Checked = True Then
                        Call NEW_VALUES_CREATE_PDF_SPEC_PAGE("Vintage", htmlOut, amod_id, amod_string)
                    End If

                    If Me.MR_STBAFTT.Checked = True Then
                        Call NEW_VALUES_CREATE_PDF_SPEC_PAGE("AFTT", htmlOut, amod_id, amod_string)
                    End If

                    If Me.MR_STBWC.Checked = True Then
                        Call NEW_VALUES_CREATE_PDF_SPEC_PAGE("Weight", htmlOut, amod_id, amod_string)
                    End If
                End If
                '------------------------- THIS IS THE END OF THE SALES-----------------------------

                If HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag = True Then
                    If Me.valuation_panel.Visible = True Then

                        If Me.current_market_check.Checked = True Then
                            Call NEW_VALUES_CREATE_PDF_SPEC_PAGE("Current_Market_Valuation", htmlOut, amod_id, amod_string)
                        End If

                        If Me.mfr_year_check.Checked = True Then
                            Call NEW_VALUES_CREATE_PDF_SPEC_PAGE("Values_By_Year_DLV", htmlOut, amod_id, amod_string)
                        End If

                        If Me.by_month_check.Checked = True Then
                            Call NEW_VALUES_CREATE_PDF_SPEC_PAGE("Values_By_Month", htmlOut, amod_id, amod_string)
                        End If

                        If Me.residual_check.Checked = True Then
                            Call NEW_VALUES_CREATE_PDF_SPEC_PAGE("Residuals", htmlOut, amod_id, amod_string)
                        End If

                        If Me.aftt_check.Checked = True Then
                            Call NEW_VALUES_CREATE_PDF_SPEC_PAGE("MFRAFTT", htmlOut, amod_id, amod_string)
                        End If
                    End If
                End If


                htmlOut.Replace("<table width='100%' align='center' class='break'><tr><td>&nbsp;</td></tr></table>", "")

                ' htmlOut.Append("</body></html>") 
            End If
        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in create_aircraft_full_spec_sheet(ByVal item_string As Array) As String" + ex.Message
        End Try

        Return htmlOut.ToString

        htmlOut = Nothing
    End Function


    Public Function Build_Assett_Inisght_Model_Function_2(ByVal amod_id As Long, ByVal real_make_model_name As String, ByVal months As Long, Optional ByVal amod_string As String = "", Optional ByVal view_id As Long = 998) As String

        Session("FONT_CLASS_TEXT") = ""
        Session("FONT_CLASS_TEXT_TITLE") = ""
        Session("FONT_CLASS_HEADER") = ""
        Session("FONT_CLASS_HEADER_BIG") = ""

        Dim htmlOut = New StringBuilder()


        Try

            ' HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag = False



            If WD.SelectedValue = "Word" Then
                bWordReport = True
            End If

            If Not IsNothing(Request.Item("word_width")) Then
                If Not String.IsNullOrEmpty(Request.Item("word_width").ToString.Trim) Then
                    word_width = Request.Item("word_width").ToString.ToUpper.Contains("Y")
                End If
            End If

            table_color = market_color.SelectedValue
            graph_color_new = create_graph_color(table_color)
            HttpContext.Current.Session.Item("graph_color") = graph_color_new  ' table_color

            'If Not IsNothing(Request.Item("pdf_html_width")) Then
            '  If Not String.IsNullOrEmpty(Request.Item("pdf_html_width").ToString.Trim) Then
            '    pdf_html_width = Request.Item("pdf_html_width").ToString.ToUpper.Contains("Y")
            '  End If
            'End If

            localdatalayer = New viewsDataLayer
            localdatalayer.adminConnectStr = Application.Item("crmClientSiteData").AdminDatabaseConn
            localdatalayer.clientConnectStr = Session.Item("localPreferences").UserDatabaseConn
            localdatalayer.starConnectStr = Session.Item("localPreferences").STARDatabaseConn
            localdatalayer.serverConnectStr = Session.Item("localPreferences").ServerNotesDatabaseConn

            util_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            util_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            util_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            util_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            util_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

            util_view_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            util_view_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            util_view_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            util_view_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            util_view_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

            market_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            market_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            market_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            market_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            market_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

            localCriteria.ViewCriteriaAmodID = amod_id

            If Trim(month_timeframe.SelectedValue.Trim) <> "" Then
                localCriteria.ViewCriteriaTimeSpan = Trim(month_timeframe.SelectedValue.Trim)
            Else
                localCriteria.ViewCriteriaTimeSpan = 12
            End If


            localCriteria.ViewCriteriaDocumentsStartDate = FormatDateTime(DateAdd(DateInterval.Month, -localCriteria.ViewCriteriaTimeSpan, Now()), DateFormat.ShortDate)
            localCriteria.ViewCriteriaDocumentsEndDate = FormatDateTime(Now(), DateFormat.ShortDate)

            NEW_PDF_AMOD_ID = amod_id

            If Trim(Request("year_start")) <> "" Then
                Call Load_Values_Variables_From_ViewMaster()
            Else
                Call Load_Values_Variables()
            End If

            htmlOut.Append("<html><head>")
            htmlOut.Append(comp_functions.NEW_build_style_page_full_spec(bWordReport, False, 998, table_color))

            If Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CRM Then
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='" & Application.Item("crmClientSiteData").ClientFullHostName & "EvoStyles/stylesheets/tableThemes.css' />")
            ElseIf InStr(Application.Item("crmClientSiteData").ClientFullHostName, "https://") > 0 Or InStr(Application.Item("crmClientSiteData").ClientFullHostName, "testjetnet") > 0 Or Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CUSTOMER_CENTER Then   ' added customer center here to get style from evo 
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='http://www.jetnetevolution.com/EvoStyles/stylesheets/tableThemes.css' />")
            Else
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='" & Application.Item("crmClientSiteData").ClientFullHostName & "EvoStyles/stylesheets/tableThemes.css' />")
            End If



            htmlOut.Append("</head><body " & IIf(Me.CP.Checked = False, "class=""withoutCover""", "") & ">")





            Dim companyName As String = ""

            htmlOut.Append(comp_functions.NEW_build_style_page_full_spec(bWordReport, True, 998, table_color))

            Call comp_functions.CompanyInformationHeaderWithPNG(0, "", comp_address, comp_logo, invisible_label_parent_image, logo_check, bWordReport, companyName, "PDF", Me.chk_alt_name.Checked)

            If chk_header.Checked = True Or logo_check.Checked = True Then
                temp_pdf_header = comp_functions.NEW_build_full_spec_page_header(0, "", comp_address, comp_logo, amod_id, 0, bWordReport, word_width_new, pdf_html_width, check_prepared_for, Nothing, prepared_for, "", True, chk_header.Checked, logo_check.Checked)
            Else
                temp_pdf_header = ""
            End If

            Dim imgFolder As String = HttpContext.Current.Server.MapPath(Session.Item("ModelPicturesFolderVirtualPath"))
            '  Dim imgDisplayFolder As String = Application.Item("crmClientSiteData").ClientFullHostName & Session.Item("ModelPicturesFolderVirtualPath")
            Dim imgDisplayFolder As String = Session.Item("ModelPicturesFolderVirtualPath")
            Dim imgDisplayFolder_AC As String = HttpContext.Current.Server.MapPath(Session.Item("AircraftPicturesFolderVirtualPath"))




            Dim imgFileName As String = amod_id.ToString.Trim + ".jpg"
            Dim temp_header1 As String = ""

            If Me.no_back_check.Checked = True Then
                If Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CRM Then
                    temp_header1 &= ("<table width='100%' height='1324' cellpadding=""0"" cellspacing=""0"" style=""background-size:100% 1449px;""><tr><td valign=""bottom"">")
                Else
                    temp_header1 &= ("<table width='100%' height='1324' cellpadding=""0"" cellspacing=""0"" style=""background-size:100% 1449px;""><tr><td valign=""bottom"">")
                End If
            Else
                If Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CRM Then
                    temp_header1 &= ("<table width='100%' height='1324' cellpadding=""0"" cellspacing=""0"" style=""background-color:#d4d4d4;background-size:100% 1449px;background-image:url('" & Application.Item("crmClientSiteData").ClientFullHostName & "/images/background/wordBackground.jpg');""><tr><td valign=""bottom"">")
                Else
                    temp_header1 &= ("<table width='100%' height='1324' cellpadding=""0"" cellspacing=""0"" style=""background-color:#d4d4d4;background-size:100% 1449px;background-image:url('http://www.jetnetevolution.com/images/background/wordBackground.jpg');""><tr><td valign=""bottom"">")
                End If
            End If




            temp_header1 &= ("<table cellspacing='0' cellpadding='0' border='0' width='100%' cellpadding=""0"" cellspacing=""0"" class=""viewValueExport"">")


            temp_header1 &= ("<tr><td nowrap='nowrap'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td align='left' width='65%' height='1100'><table align='right' width='100%' cellpadding=""0"" cellspacing=""0""><tr><td style='border-bottom-style:solid; border-bottom-width:2px; border-color:#fff' align='left'><font face='arial' style='padding-bottom:15px;display:inline-block;font-size:36px;color:#e1e1e1;'><strong>MARKET REPORT</strong></td></tr>")

            ' if u check either of the report options from an aircraft, then it will list it, otherwise, it is like it was ran from a model
            If new_PDF_AC_ID > 0 And (achigh_check.Checked = True Or acpic_cover.Checked = True) Then
                temp_header1 &= ("<tr><td align='left'><font color='#fff' face='arial' class=""makeModel""><strong>" & commonEvo.GetAircraftInfo(new_PDF_AC_ID, False, True, True) & "</strong></font><br />")
            Else
                temp_header1 &= ("<tr><td align='left'><font color='#fff' face='arial' class=""makeModel""><strong>" & real_make_model_name & "</strong></font><br />")
            End If


            If check_prepared_for.Checked = True Then
                If prepared_for.Text <> "" Then
                    temp_header1 &= ("<font face='arial' color='#fff' class=""dateName"">PREPARED FOR: </b>" & Trim(prepared_for.Text) & "</font><br />")
                End If
            End If

            temp_header1 &= ("<font face='arial' color='#fff' class=""dateName"">" & MonthName(Month(Now())) & " " & Day(Now()) & ", " & Year(Now()) & "</font>")
            temp_header1 &= ("</td></tr></table></td><td align='left' width='15%'>")

            If Me.no_back_check.Checked = True Then
                ' temp_header1 = Replace(temp_header1, "#fff", "#000000")
                ' temp_header1 = Replace(temp_header1, "#e1e1e1", "#000000")
                temp_header1 = Replace(temp_header1, "#fff", "#6E6E6E")
                temp_header1 = Replace(temp_header1, "#e1e1e1", "#6E6E6E")
            End If

            htmlOut.Append(temp_header1)

            If Me.acpic_cover.Checked = True Then

                Dim sqlReaderTemp As System.Data.SqlClient.SqlDataReader = Nothing
                Dim sqlReader As System.Data.SqlClient.SqlDataReader = Nothing

                Dim SqlConn As New System.Data.SqlClient.SqlConnection
                Dim SqlConn2 As New System.Data.SqlClient.SqlConnection
                Dim SqlCommand As New System.Data.SqlClient.SqlCommand
                Dim SqlCommand2 As New System.Data.SqlClient.SqlCommand

                Dim fApicSubject As String = ""
                Dim fAcpic_image_type As String = ""
                Dim fAcpic_id As Integer = 0
                Dim pic_seq_num As Integer = 0
                Dim Query As String = ""
                Dim ac_image_file As String = ""
                Dim temp_height As Integer = 0
                Dim temp_width As Integer = 0
                Dim desired_width As Integer = 360
                Dim desired_height As Integer = 140
                Dim zimage2 As System.Drawing.Image
                '    Dim zimage3 As System.Drawing.Image
                Dim temp_percent1 As Double = 0.0
                Dim temp_percent2 As Double = 0.0

                Try

                    SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
                    SqlConn.Open()


                    SqlCommand.Connection = SqlConn
                    SqlCommand.CommandType = System.Data.CommandType.Text
                    SqlCommand.CommandTimeout = 90

                    Query = "SELECT TOP 1 * FROM Aircraft_Pictures WITH(NOLOCK)"
                    Query += " WHERE acpic_ac_id = " & new_PDF_AC_ID
                    Query += " AND acpic_journ_id = 0 "
                    Query += " AND acpic_seq_no > 0"
                    Query += " AND acpic_image_type = 'JPG'"
                    Query += " AND acpic_hide_flag = 'N'"
                    Query += " ORDER BY acpic_seq_no"

                    SqlCommand.CommandText = Query
                    sqlReaderTemp = SqlCommand.ExecuteReader()

                    If sqlReaderTemp.HasRows Then

                        sqlReaderTemp.Read()

                        pic_seq_num = CInt(sqlReaderTemp.Item("acpic_seq_no").ToString)

                        If Not IsDBNull(sqlReaderTemp("acpic_image_type")) Then
                            fAcpic_image_type = sqlReaderTemp.Item("acpic_image_type").ToString.ToLower.Trim
                        End If

                        If Not IsDBNull(sqlReaderTemp("acpic_id")) Then
                            fAcpic_id = CInt(sqlReaderTemp.Item("acpic_id").ToString.Trim)
                        End If

                        If Not (IsDBNull(sqlReaderTemp("acpic_subject"))) Then
                            fApicSubject = sqlReaderTemp.Item("acpic_subject").ToString.Trim
                        End If



                        imgFileName = new_PDF_AC_ID & Constants.cHyphen & "0" & Constants.cHyphen & fAcpic_id.ToString & Constants.cDot & fAcpic_image_type.ToLower.Trim



                        Try
                            ac_image_file = HttpContext.Current.Server.MapPath("pictures\aircraft\") & imgFileName
                            zimage2 = System.Drawing.Image.FromFile(ac_image_file)
                            temp_width = zimage2.Width
                            temp_height = zimage2.Height



                            ' if the width minus a little is still greater than the height, then can increase a little
                            ' if height is not close to width, then we can increase size a little 
                            If ((temp_width - 50) > temp_height) And (temp_width > 300) Then
                                ' if the height is greater than the width, desired_width currrently = 378 
                                desired_width = 390   ' can make it a little wider
                            End If

                            If bWordReport Then
                                desired_width = 400
                            End If

                            ' if the image is wider then the desired image width, then shirnk down to size.
                            If temp_width > desired_width Then
                                temp_percent1 = CDbl(CDbl(desired_width) / CDbl(temp_width))
                                temp_width = CDbl(CDbl(temp_width) * CDbl(temp_percent1))
                                temp_height = CDbl(CDbl(temp_height) * CDbl(temp_percent1))
                            End If

                            'assuming generally that a square is fine
                            If temp_height > temp_width Then
                                temp_percent1 = CDbl(CDbl(temp_width) / CDbl(temp_height))
                                temp_width = CDbl(CDbl(temp_width) * CDbl(temp_percent1))
                                temp_height = CDbl(CDbl(temp_height) * CDbl(temp_percent1))
                            End If


                            '  If bWordReport Then
                            ' htmlOut.Append("<img Title='" + fApicSubject.Trim + "' alt='" + fApicSubject.Trim + "' src='" + imgDisplayFolder.Trim + "/" + imgFileName.Trim + "' width='" + temp_width.ToString + "' height='" + temp_height.ToString + "'/></td>")
                            ' Else
                            htmlOut.Append("<img Title='" & fApicSubject.Trim & "' alt='" & fApicSubject.Trim & "' src='" & imgDisplayFolder_AC.Trim & "/" & imgFileName.Trim & "' width='" & temp_width.ToString & "' style='border-width:2px;border-style: solid;border-color:#fff;'/></td>")
                            ' End If

                        Catch ex As Exception
                            htmlOut.Append("<img Title='" & fApicSubject.Trim & "' alt='" & fApicSubject.Trim & "' src='" & imgDisplayFolder.Trim & "/" & imgFileName.Trim & "' width='200'/></td>")
                        End Try

                    End If

                    sqlReaderTemp.Close()

                Catch ex As Exception

                End Try
            Else
                htmlOut.Append(Replace(NEW_build_model_spec_first_picture(imgFileName, True), "Title=''", " Title='' style='border-width:2px;border-style: solid;border-color:#fff;'"))
            End If

            htmlOut.Append("</td><td nowrap='nowrap'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>")
            If chk_header.Checked = True Then
                htmlOut.Append("<tr valign='middle'><td height='200' width='700' align='left' valign=""bottom"" colspan=""4""><table align='right' width='100%' cellpadding=""0"" cellspacing=""0"" class=""overlaySep""><tr><td align='left' valign=""bottom""><span class=""companyName"">" & UCase(companyName) & "</td><td rowspan=""2"" align=""right"">" & comp_logo & "</td></tr><tr><td align='left' valign=""top""><Table align='left' cellpadding=""0"" cellspacing=""0"">" & Replace(comp_address, " class='sub_text'", " style=""font-family:Arial;font-size:18px;color:#737373""") & "</table></td></tr></table></font></td></tr>")
            ElseIf logo_check.Checked = True Then
                htmlOut.Append("<tr valign='middle'><td height='200' width='700' align='left' valign=""bottom"" colspan=""4""><table align='right' width='100%' cellpadding=""0"" cellspacing=""0"" class=""overlaySep""><tr><td align='left' valign=""bottom""><span class=""companyName"">&nbsp;</td><td rowspan=""2"" align=""right"">" & comp_logo & "</td></tr><tr><td align='left' valign=""top""><Table align='left' cellpadding=""0"" cellspacing=""0"">&nbsp;</table></td></tr></table></font></td></tr>")
            End If
            htmlOut.Append("</table>")

            htmlOut.Append("</td></tr></table>")
            made_first_page = True
            'body {margin: 0%;width: 100%;height: 100%;} ' needed  





            ' htmlOut.Append("<link rel='stylesheet' type='text/css' href='" & Application.Item("crmClientSiteData").ClientFullHostName & "EvoStyles/stylesheets/additional_styles.css' />")

            ' <link rel=""stylesheet"" href=""/EvoStyles/stylesheets/.css"" />
            'htmlOut.Append("<link rel='stylesheet' type='text/css' href='../EvoStyles/stylesheets/tableThemes.css' />")

            Call comp_functions.CompanyInformationHeaderWithPNG(0, "", comp_address, comp_logo, invisible_label_parent_image, logo_check, bWordReport, "", "PDF", Me.chk_alt_name.Checked)

            'temp_pdf_header = "</div><div class=""valueSpec viewValueExport Simplistic " & table_color & """>" & comp_functions.NEW_build_full_spec_page_header(0, "", comp_address, comp_logo, amod_id, 0, bWordReport, word_width_new, pdf_html_width, check_prepared_for, Nothing, prepared_for)
            'temp_pdf_header = "" & comp_functions.NEW_build_full_spec_page_header(0, "", comp_address, comp_logo, amod_id, 0, bWordReport, word_width_new, pdf_html_width, check_prepared_for, Nothing, prepared_for)
            'temp_pdf_footer = ""


            If Me.no_back_check.Checked = True Then
                If chk_header.Checked = True Or logo_check.Checked = True Then
                    temp_pdf_header = "</div><div class=""valueSpec viewValueExport Simplistic " & table_color & """ style=""background-image:url('/images/background/white_background.png');"">" & comp_functions.NEW_build_full_spec_page_header(0, "", comp_address, comp_logo, amod_id, 0, bWordReport, word_width_new, pdf_html_width, check_prepared_for, Nothing, prepared_for, "", True, chk_header.Checked, logo_check.Checked)
                Else
                    temp_pdf_header = "</div><div class=""valueSpec viewValueExport Simplistic " & table_color & """ style=""background-image:url('/images/background/white_background.png');"">"

                    If bWordReport = True Then
                        temp_pdf_header &= ("<table width='" & word_width & "' align='center'><Tr><Td>&nbsp;</td></tr></table>")
                    Else
                        temp_pdf_header &= ("<div class=""viewValueExport overlaySep""><table width='100%' align='center' cellpadding=""0"" cellspacing=""0""><tr><td>&nbsp;</td></tr></table></div>")
                    End If
                End If
            Else
                If chk_header.Checked = True Or logo_check.Checked = True Then
                    temp_pdf_header = "</div><div class=""valueSpec viewValueExport Simplistic " & table_color & """>" & comp_functions.NEW_build_full_spec_page_header(0, "", comp_address, comp_logo, amod_id, 0, bWordReport, word_width_new, pdf_html_width, check_prepared_for, Nothing, prepared_for, "", True, chk_header.Checked, logo_check.Checked)
                Else
                    temp_pdf_header = "</div><div class=""valueSpec viewValueExport Simplistic " & table_color & """>"

                    If bWordReport = True Then
                        temp_pdf_header &= ("<table width='" & word_width & "' align='center'><Tr><Td>&nbsp;</td></tr></table>")
                    Else
                        temp_pdf_header &= ("<div class=""viewValueExport overlaySep""><table width='100%' align='center' cellpadding=""0"" cellspacing=""0""><tr><td>&nbsp;</td></tr></table></div>")
                    End If
                End If
            End If




            Call NEW_ASSETT_MODEL_SPEC_PAGE("Maintenance_List", htmlOut, amod_id, amod_string)


            Call NEW_ASSETT_MODEL_SPEC_PAGE("Features_List", htmlOut, amod_id, amod_string)


            htmlOut.Replace("<table width='100%' align='center' class='break'><tr><td>&nbsp;</td></tr></table>", "")

            ' htmlOut.Append("</body></html>") 

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in create_aircraft_full_spec_sheet(ByVal item_string As Array) As String" + ex.Message
        End Try

        Return htmlOut.ToString

        htmlOut = Nothing
    End Function

    Public Sub Load_Values_Variables_From_ViewMaster()
        Dim is_filter As Boolean = False

        If Trim(Request("year_start")) <> "" Then

            ' If Trim(Request("year_start")) <> Trim(Request("hidden_year_start")) Then
            year_start.Text = Trim(Request("year_start"))
            localCriteria.ViewCriteriaYearStart = year_start.Text
            'Else
            '   year_start.Text = ""
            '  End If 

            If Trim(Request("hidden_year_start")) <> "" Then
                If (Trim(Request("year_start")) = Trim(Request("hidden_year_start"))) And Trim(Request("year_start")) <> "" And Trim(Request("hidden_year_start") <> "") Then
                    year_start.Text = ""
                    localCriteria.ViewCriteriaYearStart = 0
                    ' if they are both not blank and both the same, then clear them out 
                Else
                    is_filter = True
                End If
            Else
                is_filter = True
            End If

        Else
            year_start.Text = ""
        End If

        If Trim(Request("year_end")) <> "" Then
            '  If Trim(Request("year_end")) <> Trim(Request("hidden_year_end")) Then
            year_end.Text = Trim(Request("year_end"))
            localCriteria.ViewCriteriaYearEnd = year_end.Text

            'Else
            '   year_start.Text = ""
            'End If


            If Trim(Request("hidden_year_end")) <> "" Then
                If (Trim(Request("year_end")) = Trim(Request("hidden_year_end"))) And Trim(Request("year_end")) <> "" And Trim(Request("hidden_year_end") <> "") Then
                    year_end.Text = ""
                    localCriteria.ViewCriteriaYearEnd = 0
                    ' if they are both not blank and both the same, then clear them out 
                Else
                    is_filter = True
                End If
            Else
                is_filter = True
            End If

        Else
            year_end.Text = ""
        End If


        If Trim(Request("aftt_start")) <> "" Then
            ' If Trim(Request("hidden_aftt_start")) <> Trim(Request("aftt_start")) Then
            aftt_start.Text = Trim(Request("aftt_start"))
            localCriteria.ViewCriteriaAFTTStart = aftt_start.Text
            is_filter = True
            'Else
            '  aftt_start.Text = "0"
            '  End If
        Else
            aftt_start.Text = "0"
        End If

        If Trim(Request("aftt_end")) <> "" Then
            ' If Trim(Request("hidden_aftt_end")) <> Trim(Request("aftt_end")) Then
            aftt_end.Text = Trim(Request("aftt_end"))
            localCriteria.ViewCriteriaAFTTEnd = aftt_end.Text
            is_filter = True
            'Else
            '  aftt_end.Text = "0"
            ' End If
        Else
            aftt_end.Text = "0"
        End If
        valueHeaderString = ""


        If Not IsNothing(Request.Item("yearFilter")) Then
            If Not String.IsNullOrEmpty(Request.Item("yearFilter").ToString) Then
                If Request.Item("yearFilter") = "true" Then
                    yearFilter = True
                    If IsNumeric(year_start.Text) And IsNumeric(year_end.Text) Then
                        If year_start.Text > 0 And year_end.Text > 0 Then
                            valueHeaderString += year_start.Text & "-" & year_end.Text
                        End If
                    End If
                End If '
            End If
        End If

        If Not IsNothing(Request.Item("afttFilter")) Then
            If Not String.IsNullOrEmpty(Request.Item("afttFilter").ToString) Then
                If Request.Item("afttFilter") = "true" Then
                    afttFilter = True
                    If Trim(aftt_start.Text) <> "" And Trim(aftt_start.Text) <> "0" And Trim(aftt_end.Text) <> "" And Trim(aftt_end.Text) <> "0" Then
                        valueHeaderString += " MODELS WITH AFTT FROM " & aftt_start.Text & " to " & aftt_end.Text
                    End If
                End If '
            End If
        End If

        If afttFilter = False And yearFilter = True Then
            valueHeaderString += " MODELS"
        End If

        If yearFilter = True Or afttFilter = True Then
            valueHeaderString = "<span>" & valueHeaderString & "</span>"
            valueEmptyHeaderString = "<span>Entire Fleet</span>"
        End If



        If Trim(Request("start_date")) <> "" Then
            start_date.Text = Trim(Request("start_date"))
        Else
            start_date.Text = localCriteria.ViewCriteriaDocumentsStartDate

        End If
        If Trim(Request("end_date")) <> "" Then
            end_date.Text = Trim(Request("end_date"))
        Else
            end_date.Text = localCriteria.ViewCriteriaDocumentsEndDate
        End If

        If Trim(Request("VariantList")) <> "" Then
            VariantList.Text = Trim(Request("VariantList"))
        Else
            VariantList.Text = ""
        End If

        Dim CurrentTransactionTable As New DataTable
        CurrentTransactionTable = GetTransactionAircraftStartingTable(NEW_PDF_AMOD_ID, "", "", 3)
        '  clsGeneral  clsGeneral   ExtractSelectedStringFromListboxDropdown VariantList, False, 0, True 

        ' if there hasnt been a filter used then go make the aftt for the COMPARATIVE MODEL SALES page  
        If is_filter = True Then
            GrabCurrentModelInformation(CurrentTransactionTable, 0)
        Else
            GrabCurrentModelInformation(CurrentTransactionTable, 1)
            GrabCurrentModelInformation(CurrentTransactionTable, 2)
        End If




    End Sub

    Function Build_Assett_Inisght_Model_Function(ByVal amod_id As String, ByVal real_make_model_name As String) As String

        Session("FONT_CLASS_TEXT") = ""
        Session("FONT_CLASS_TEXT_TITLE") = ""
        Session("FONT_CLASS_HEADER") = ""
        Session("FONT_CLASS_HEADER_BIG") = ""

        Dim htmlOut = New StringBuilder()
        Dim amod_string As String = ""


        Try

            If WD.SelectedValue = "Word" Then
                bWordReport = True
            End If



            'End If

            localdatalayer = New viewsDataLayer
            localdatalayer.adminConnectStr = Application.Item("crmClientSiteData").AdminDatabaseConn
            localdatalayer.clientConnectStr = Session.Item("localPreferences").UserDatabaseConn
            localdatalayer.starConnectStr = Session.Item("localPreferences").STARDatabaseConn

            localdatalayer.serverConnectStr = Session.Item("localPreferences").ServerNotesDatabaseConn



            htmlOut.Append("<html><head>")
            htmlOut.Append(comp_functions.NEW_build_style_page_full_spec(bWordReport, False, 998, table_color))

            If Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CRM Then
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='" & Application.Item("crmClientSiteData").ClientFullHostName & "EvoStyles/stylesheets/tableThemes.css' />")
            ElseIf InStr(Application.Item("crmClientSiteData").ClientFullHostName, "https://") > 0 Or InStr(Application.Item("crmClientSiteData").ClientFullHostName, "testjetnet") > 0 Or Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CUSTOMER_CENTER Then
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='http://www.jetnetevolution.com/EvoStyles/stylesheets/tableThemes.css' />")
            Else
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='" & Application.Item("crmClientSiteData").ClientFullHostName & "EvoStyles/stylesheets/tableThemes.css' />")
            End If



            htmlOut.Append("</head><body " & IIf(Me.CP.Checked = False, "class=""withoutCover""", "") & ">")



            Dim companyName As String = ""

            htmlOut.Append(comp_functions.NEW_build_style_page_full_spec(bWordReport, True, 998, table_color))

            Call comp_functions.CompanyInformationHeaderWithPNG(0, "", comp_address, comp_logo, invisible_label_parent_image, logo_check, bWordReport, companyName, "PDF", Me.chk_alt_name.Checked)

            If chk_header.Checked = True Or logo_check.Checked = True Then
                temp_pdf_header = comp_functions.NEW_build_full_spec_page_header(0, "", comp_address, comp_logo, amod_id, 0, bWordReport, word_width_new, pdf_html_width, check_prepared_for, Nothing, prepared_for, "", True, chk_header.Checked, logo_check.Checked)
            Else
                temp_pdf_header = ""
            End If

            Dim imgFolder As String = HttpContext.Current.Server.MapPath(Session.Item("ModelPicturesFolderVirtualPath"))
            '  Dim imgDisplayFolder As String = Application.Item("crmClientSiteData").ClientFullHostName & Session.Item("ModelPicturesFolderVirtualPath")
            Dim imgDisplayFolder As String = Session.Item("ModelPicturesFolderVirtualPath")
            Dim imgDisplayFolder_AC As String = HttpContext.Current.Server.MapPath(Session.Item("AircraftPicturesFolderVirtualPath"))


            Dim imgFileName As String = amod_id.ToString.Trim + ".jpg"
            Dim temp_header1 As String = ""

            If Me.no_back_check.Checked = True Then
                If Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CRM Then
                    temp_header1 &= ("<table width='100%' height='1324' cellpadding=""0"" cellspacing=""0"" style=""background-size:100% 1449px;""><tr><td valign=""bottom"">")
                Else
                    temp_header1 &= ("<table width='100%' height='1324' cellpadding=""0"" cellspacing=""0"" style=""background-size:100% 1449px;""><tr><td valign=""bottom"">")
                End If
            Else
                If Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CRM Then
                    temp_header1 &= ("<table width='100%' height='1324' cellpadding=""0"" cellspacing=""0"" style=""background-color:#d4d4d4;background-size:100% 1449px;background-image:url('" & Application.Item("crmClientSiteData").ClientFullHostName & "/images/background/wordBackground.jpg');""><tr><td valign=""bottom"">")
                Else
                    temp_header1 &= ("<table width='100%' height='1324' cellpadding=""0"" cellspacing=""0"" style=""background-color:#d4d4d4;background-size:100% 1449px;background-image:url('http://www.jetnetevolution.com/images/background/wordBackground.jpg');""><tr><td valign=""bottom"">")
                End If
            End If




            temp_header1 &= ("<table cellspacing='0' cellpadding='0' border='0' width='100%' cellpadding=""0"" cellspacing=""0"" class=""viewValueExport"">")


            temp_header1 &= ("<tr><td nowrap='nowrap'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td align='left' width='65%' height='1100'><table align='right' width='100%' cellpadding=""0"" cellspacing=""0""><tr><td style='border-bottom-style:solid; border-bottom-width:2px; border-color:#fff' align='left'><font face='arial' style='padding-bottom:15px;display:inline-block;font-size:36px;color:#e1e1e1;'><strong>MARKET REPORT</strong></td></tr>")

            ' if u check either of the report options from an aircraft, then it will list it, otherwise, it is like it was ran from a model
            If new_PDF_AC_ID > 0 And (achigh_check.Checked = True Or acpic_cover.Checked = True) Then
                temp_header1 &= ("<tr><td align='left'><font color='#fff' face='arial' class=""makeModel""><strong>" & commonEvo.GetAircraftInfo(new_PDF_AC_ID, False, True, True) & "</strong></font><br />")
            Else
                temp_header1 &= ("<tr><td align='left'><font color='#fff' face='arial' class=""makeModel""><strong>" & real_make_model_name & "</strong></font><br />")
            End If


            If check_prepared_for.Checked = True Then
                If prepared_for.Text <> "" Then
                    temp_header1 &= ("<font face='arial' color='#fff' class=""dateName"">PREPARED FOR: </b>" & Trim(prepared_for.Text) & "</font><br />")
                End If
            End If

            temp_header1 &= ("<font face='arial' color='#fff' class=""dateName"">" & MonthName(Month(Now())) & " " & Day(Now()) & ", " & Year(Now()) & "</font>")
            temp_header1 &= ("</td></tr></table></td><td align='left' width='15%'>")

            If Me.no_back_check.Checked = True Then
                ' temp_header1 = Replace(temp_header1, "#fff", "#000000")
                ' temp_header1 = Replace(temp_header1, "#e1e1e1", "#000000")
                temp_header1 = Replace(temp_header1, "#fff", "#6E6E6E")
                temp_header1 = Replace(temp_header1, "#e1e1e1", "#6E6E6E")
            End If


            htmlOut.Append(temp_header1)


            If Me.acpic_cover.Checked = True Then

                Dim sqlReaderTemp As System.Data.SqlClient.SqlDataReader = Nothing
                Dim sqlReader As System.Data.SqlClient.SqlDataReader = Nothing

                Dim SqlConn As New System.Data.SqlClient.SqlConnection
                Dim SqlConn2 As New System.Data.SqlClient.SqlConnection
                Dim SqlCommand As New System.Data.SqlClient.SqlCommand
                Dim SqlCommand2 As New System.Data.SqlClient.SqlCommand

                Dim fApicSubject As String = ""
                Dim fAcpic_image_type As String = ""
                Dim fAcpic_id As Integer = 0
                Dim pic_seq_num As Integer = 0
                Dim Query As String = ""
                Dim ac_image_file As String = ""
                Dim temp_height As Integer = 0
                Dim temp_width As Integer = 0
                Dim desired_width As Integer = 360
                Dim desired_height As Integer = 140
                Dim zimage2 As System.Drawing.Image
                '    Dim zimage3 As System.Drawing.Image
                Dim temp_percent1 As Double = 0.0
                Dim temp_percent2 As Double = 0.0

                Try

                    SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
                    SqlConn.Open()


                    SqlCommand.Connection = SqlConn
                    SqlCommand.CommandType = System.Data.CommandType.Text
                    SqlCommand.CommandTimeout = 90

                    Query = "SELECT TOP 1 * FROM Aircraft_Pictures WITH(NOLOCK)"
                    Query += " WHERE acpic_ac_id = " & new_PDF_AC_ID
                    Query += " AND acpic_journ_id = 0 "
                    Query += " AND acpic_seq_no > 0"
                    Query += " AND acpic_image_type = 'JPG'"
                    Query += " AND acpic_hide_flag = 'N'"
                    Query += " ORDER BY acpic_seq_no"

                    SqlCommand.CommandText = Query
                    sqlReaderTemp = SqlCommand.ExecuteReader()

                    If sqlReaderTemp.HasRows Then

                        sqlReaderTemp.Read()

                        pic_seq_num = CInt(sqlReaderTemp.Item("acpic_seq_no").ToString)

                        If Not IsDBNull(sqlReaderTemp("acpic_image_type")) Then
                            fAcpic_image_type = sqlReaderTemp.Item("acpic_image_type").ToString.ToLower.Trim
                        End If

                        If Not IsDBNull(sqlReaderTemp("acpic_id")) Then
                            fAcpic_id = CInt(sqlReaderTemp.Item("acpic_id").ToString.Trim)
                        End If

                        If Not (IsDBNull(sqlReaderTemp("acpic_subject"))) Then
                            fApicSubject = sqlReaderTemp.Item("acpic_subject").ToString.Trim
                        End If



                        imgFileName = new_PDF_AC_ID & Constants.cHyphen & "0" & Constants.cHyphen & fAcpic_id.ToString & Constants.cDot & fAcpic_image_type.ToLower.Trim



                        Try
                            ac_image_file = HttpContext.Current.Server.MapPath("pictures\aircraft\") & imgFileName
                            zimage2 = System.Drawing.Image.FromFile(ac_image_file)
                            temp_width = zimage2.Width
                            temp_height = zimage2.Height



                            ' if the width minus a little is still greater than the height, then can increase a little
                            ' if height is not close to width, then we can increase size a little 
                            If ((temp_width - 50) > temp_height) And (temp_width > 300) Then
                                ' if the height is greater than the width, desired_width currrently = 378 
                                desired_width = 390   ' can make it a little wider
                            End If

                            If bWordReport Then
                                desired_width = 400
                            End If

                            ' if the image is wider then the desired image width, then shirnk down to size.
                            If temp_width > desired_width Then
                                temp_percent1 = CDbl(CDbl(desired_width) / CDbl(temp_width))
                                temp_width = CDbl(CDbl(temp_width) * CDbl(temp_percent1))
                                temp_height = CDbl(CDbl(temp_height) * CDbl(temp_percent1))
                            End If

                            'assuming generally that a square is fine
                            If temp_height > temp_width Then
                                temp_percent1 = CDbl(CDbl(temp_width) / CDbl(temp_height))
                                temp_width = CDbl(CDbl(temp_width) * CDbl(temp_percent1))
                                temp_height = CDbl(CDbl(temp_height) * CDbl(temp_percent1))
                            End If


                            '  If bWordReport Then
                            ' htmlOut.Append("<img Title='" + fApicSubject.Trim + "' alt='" + fApicSubject.Trim + "' src='" + imgDisplayFolder.Trim + "/" + imgFileName.Trim + "' width='" + temp_width.ToString + "' height='" + temp_height.ToString + "'/></td>")
                            ' Else
                            htmlOut.Append("<img Title='" & fApicSubject.Trim & "' alt='" & fApicSubject.Trim & "' src='" & imgDisplayFolder_AC.Trim & "/" & imgFileName.Trim & "' width='" & temp_width.ToString & "' style='border-width:2px;border-style: solid;border-color:#fff;'/></td>")
                            ' End If

                        Catch ex As Exception
                            htmlOut.Append("<img Title='" & fApicSubject.Trim & "' alt='" & fApicSubject.Trim & "' src='" & imgDisplayFolder.Trim & "/" & imgFileName.Trim & "' width='200'/></td>")
                        End Try

                    End If

                    sqlReaderTemp.Close()

                Catch ex As Exception

                End Try
            Else
                htmlOut.Append(Replace(NEW_build_model_spec_first_picture(imgFileName, True), "Title=''", " Title='' style='border-width:2px;border-style: solid;border-color:#fff;'"))
            End If



            Call comp_functions.CompanyInformationHeaderWithPNG(0, "", comp_address, comp_logo, invisible_label_parent_image, logo_check, bWordReport, "", "PDF", Me.chk_alt_name.Checked)


            If Me.no_back_check.Checked = True Then
                If chk_header.Checked = True Or logo_check.Checked = True Then
                    temp_pdf_header = "</div><div class=""valueSpec viewValueExport Simplistic " & table_color & """ style=""background-image:url('/images/background/white_background.png');"">" & comp_functions.NEW_build_full_spec_page_header(0, "", comp_address, comp_logo, amod_id, 0, bWordReport, word_width_new, pdf_html_width, check_prepared_for, Nothing, prepared_for, "", True, chk_header.Checked, logo_check.Checked)
                Else
                    temp_pdf_header = "</div><div class=""valueSpec viewValueExport Simplistic " & table_color & """ style=""background-image:url('/images/background/white_background.png');"">"

                    If bWordReport = True Then
                        temp_pdf_header &= ("<table width='" & word_width & "' align='center'><Tr><Td>&nbsp;</td></tr></table>")
                    Else
                        temp_pdf_header &= ("<div class=""viewValueExport overlaySep""><table width='100%' align='center' cellpadding=""0"" cellspacing=""0""><tr><td>&nbsp;</td></tr></table></div>")
                    End If
                End If
            Else
                If chk_header.Checked = True Or logo_check.Checked = True Then
                    temp_pdf_header = "</div><div class=""valueSpec viewValueExport Simplistic " & table_color & """>" & comp_functions.NEW_build_full_spec_page_header(0, "", comp_address, comp_logo, amod_id, 0, bWordReport, word_width_new, pdf_html_width, check_prepared_for, Nothing, prepared_for, "", True, chk_header.Checked, logo_check.Checked)
                Else
                    temp_pdf_header = "</div><div class=""valueSpec viewValueExport Simplistic " & table_color & """>"

                    If bWordReport = True Then
                        temp_pdf_header &= ("<table width='" & word_width & "' align='center'><Tr><Td>&nbsp;</td></tr></table>")
                    Else
                        temp_pdf_header &= ("<div class=""viewValueExport overlaySep""><table width='100%' align='center' cellpadding=""0"" cellspacing=""0""><tr><td>&nbsp;</td></tr></table></div>")
                    End If
                End If
            End If


            htmlOut.Append("</td><td nowrap='nowrap'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>")
            If chk_header.Checked = True Then
                htmlOut.Append("<tr valign='middle'><td height='200' width='700' align='left' valign=""bottom"" colspan=""4""><table align='right' width='100%' cellpadding=""0"" cellspacing=""0"" class=""overlaySep""><tr><td align='left' valign=""bottom""><span class=""companyName"">" & UCase(companyName) & "</td><td rowspan=""2"" align=""right"">" & comp_logo & "</td></tr><tr><td align='left' valign=""top""><Table align='left' cellpadding=""0"" cellspacing=""0"">" & Replace(comp_address, " class='sub_text'", " style=""font-family:Arial;font-size:18px;color:#737373""") & "</table></td></tr></table></font></td></tr>")
            ElseIf logo_check.Checked = True Then
                htmlOut.Append("<tr valign='middle'><td height='200' width='700' align='left' valign=""bottom"" colspan=""4""><table align='right' width='100%' cellpadding=""0"" cellspacing=""0"" class=""overlaySep""><tr><td align='left' valign=""bottom""><span class=""companyName"">&nbsp;</td><td rowspan=""2"" align=""right"">" & comp_logo & "</td></tr><tr><td align='left' valign=""top""><Table align='left' cellpadding=""0"" cellspacing=""0"">&nbsp;</table></td></tr></table></font></td></tr>")
            End If
            htmlOut.Append("</table>")

            htmlOut.Append("</td></tr></table>")
            made_first_page = True
            'body {margin: 0%;width: 100%;height: 100%;} ' needed   




            '    htmlOut.Append(comp_functions.NEW_Insert_Page_Break_PDF(0, WD.SelectedValue))
            '   htmlOut.Append(temp_pdf_header)

            '    htmlOut.Append(DisplayDescription(amod_id))



            Call NEW_ASSETT_MODEL_SPEC_PAGE("Maintenance_List", htmlOut, amod_id, amod_string)

            Call NEW_ASSETT_MODEL_SPEC_PAGE("Features_List", htmlOut, amod_id, amod_string)


        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in create_aircraft_full_spec_sheet(ByVal item_string As Array) As String" + ex.Message
        End Try

        Return htmlOut.ToString

        htmlOut = Nothing
    End Function


    Function Build_Model_Market_Summary_PDF_Standard(ByVal amod_id, ByVal real_make_model_name, ByVal months) As String

        Session("FONT_CLASS_TEXT") = ""
        Session("FONT_CLASS_TEXT_TITLE") = ""
        Session("FONT_CLASS_HEADER") = ""
        Session("FONT_CLASS_HEADER_BIG") = ""

        Dim htmlOut = New StringBuilder()



        Try

            If WD.SelectedValue = "Word" Then
                bWordReport = True
            End If

            If Not IsNothing(Request.Item("word_width")) Then
                If Not String.IsNullOrEmpty(Request.Item("word_width").ToString.Trim) Then
                    word_width = Request.Item("word_width").ToString.ToUpper.Contains("Y")
                End If
            End If

            'If Not IsNothing(Request.Item("pdf_html_width")) Then
            '  If Not String.IsNullOrEmpty(Request.Item("pdf_html_width").ToString.Trim) Then
            '    pdf_html_width = Request.Item("pdf_html_width").ToString.ToUpper.Contains("Y")
            '  End If
            'End If

            localdatalayer = New viewsDataLayer
            localdatalayer.adminConnectStr = Application.Item("crmClientSiteData").AdminDatabaseConn
            localdatalayer.clientConnectStr = Session.Item("localPreferences").UserDatabaseConn
            localdatalayer.starConnectStr = Session.Item("localPreferences").STARDatabaseConn
            localdatalayer.serverConnectStr = Session.Item("localPreferences").ServerNotesDatabaseConn

            localCriteria.ViewCriteriaAmodID = amod_id
            If Trim(Request("months")) <> "" Then
                localCriteria.ViewCriteriaTimeSpan = Trim(Request("months"))
            Else
                localCriteria.ViewCriteriaTimeSpan = 6
            End If



            htmlOut.Append("<html><body>")
            htmlOut.Append(comp_functions.NEW_build_style_page_full_spec(bWordReport))
            Call comp_functions.NEW_Header_Comp_Info(0, "", comp_address, comp_logo, invisible_label_parent_image, logo_check, bWordReport, "", "PDF")


            temp_pdf_header = comp_functions.NEW_build_full_spec_page_header(0, "", comp_address, comp_logo, amod_id, 0, bWordReport, word_width_new, pdf_html_width, check_prepared_for, Nothing, prepared_for)


            If Trim(Request("clouds")) = "Y" Then
                htmlOut.Append("<table width='100%' height='100%'><tr><td><img src='http://www.jetnetevolution.com/images/background/62.jpg' width='1000' height='1425'></td></tr></table>")
                made_first_page = True
            ElseIf Trim(Request("clouds2")) = "Y" Then
                htmlOut.Append("<table width='100%' height='100%' background='http://www.jetnetevolution.com/images/background/report1.png'><tr><td>")
                htmlOut.Append("<table height='1443'><tr><td>test1<br><br><br><br></td></tr></table></td></tr></table>")
                made_first_page = True
            ElseIf Trim(Request("clouds3")) = "Y" Then

                Dim imgFolder As String = HttpContext.Current.Server.MapPath(Session.Item("ModelPicturesFolderVirtualPath"))
                '  Dim imgDisplayFolder As String = Application.Item("crmClientSiteData").ClientFullHostName & Session.Item("ModelPicturesFolderVirtualPath")
                Dim imgDisplayFolder As String = Session.Item("ModelPicturesFolderVirtualPath")
                Dim imgFileName As String = amod_id.ToString.Trim + ".jpg"
                Dim company_name As String = "JETNET LLC"


                htmlOut.Append("<table width='1050' height='1485' background='http://www.jetnetevolution.com/images/background/60_report11.jpg'><tr><td>")

                htmlOut.Append("<table cellspacing='0' cellpadding='0' border='0' width='98%'>")

                htmlOut.Append("<tr><td align='right' colspan='2'>" & Date.Now() & "</td></tr>")
                htmlOut.Append("<tr><td align='right' width='50%'>MARKET SUMMARY<br/>" & real_make_model_name & "</td><td align='left' width='50%'>" & NEW_build_model_spec_first_picture(imgFileName, False) & "'</td></tr>")
                htmlOut.Append("<tr><td align='left'>" & company_name & "<br/><Table>" & comp_address & "</table></td><td align='right'>" & comp_logo & "</td></tr>")

                htmlOut.Append("</table>")

                htmlOut.Append("</td></tr></table>")
                made_first_page = True
            Else



                If Me.CP.Checked Then
                    Call NEW_CREATE_PDF_SPEC_PAGE("cover", htmlOut, amod_id)
                End If


                If Me.MMS_CHARTS.Checked Or MMS_FMS.Checked Then
                    Call NEW_CREATE_PDF_SPEC_PAGE("ownership_status", htmlOut, amod_id)
                End If

                If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = False Then
                    If Me.MMS_STAT.Checked = True And MMS_STAT.Visible = True Then
                        Call NEW_CREATE_PDF_SPEC_PAGE("ac_forsale_byyear", htmlOut, amod_id)
                    End If
                End If


                If MMS_BPS.Checked Or MMS_BOC.Checked Then
                    Call NEW_CREATE_PDF_SPEC_PAGE("performance_specs_op_costs", htmlOut, amod_id)
                End If

                If MMS_BAFS.Checked And MMS_BAFS.Visible = True Then
                    Call NEW_CREATE_PDF_SPEC_PAGE("for_sale", htmlOut, amod_id)
                End If

                If MMS_BRRS.Checked And MMS_BRRS.Visible = True Then
                    Call NEW_CREATE_PDF_SPEC_PAGE("recent_retail", htmlOut, amod_id)
                End If

                If Me.MMS_UP.Checked Or Me.MMS_AA.Checked Then
                    Call NEW_CREATE_PDF_SPEC_PAGE("upgrade", htmlOut, amod_id)
                End If

                If MMS_BRMA.Checked And MMS_BRMA.Visible = True Then
                    Call NEW_CREATE_PDF_SPEC_PAGE("recent_market", htmlOut, amod_id)
                End If

                If Me.CRM_Wanteds.Checked And Me.CRM_Wanteds.Visible = True Then
                    Call NEW_CREATE_PDF_SPEC_PAGE("display_wanteds", htmlOut, amod_id)
                End If

            End If

            ' htmlOut.Append("</body></html>")

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in create_aircraft_full_spec_sheet(ByVal item_string As Array) As String" + ex.Message
        End Try

        Return htmlOut.ToString

        htmlOut = Nothing
    End Function

    Public Sub NEW_ASSETT_MODEL_SPEC_PAGE(ByVal page_name As String, ByRef htmlOut As StringBuilder, ByVal amod_id As Long, ByVal amod_string As String)

        Dim page_total As Integer = 0
        Dim chart_text As String = ""
        Dim temp_string As String = ""
        Dim record_count_inner As Long = 0

        Try


            If clsGeneral.clsGeneral.isCrmDisplayMode() Then
                NEW_CRMViewActive = True
            End If

            If made_first_page = False Then
            Else
                htmlOut.Append(comp_functions.NEW_Insert_Page_Break_PDF(0, WD.SelectedValue))
            End If

            NEW_PDF_AMOD_ID = amod_id


            htmlOut.Append(temp_pdf_header)

            made_first_page = True



            If bWordReport = True Then
                htmlOut.Append("<table width='" & word_width & "' align='center' cellpadding='3'>")
            Else
                htmlOut.Append("<table width='" & pdf_html_width & "' align='center' cellpadding='3'>")
            End If



            If Trim(page_name) = "Maintenance_List" Then
                page_total = page_total + 1
                htmlOut.Append(Get_Assett_Insight_Model_Maint_Counts(amod_id, amod_string))
            End If

            If Trim(page_name) = "Features_List" Then
                page_total = page_total + 1
                htmlOut.Append(Get_Assett_Insight_Model_Features_Counts(amod_id, amod_string))
            End If


            htmlOut.Append("</table>")

            ' comp_functions.create_value_with_label("Damage History", "Y", True, True, Counter_For_PDF, spacer_width)

        Catch ex As Exception

        End Try

    End Sub




    Public Sub NEW_VALUES_CREATE_PDF_SPEC_PAGE(ByVal page_name As String, ByRef htmlOut As StringBuilder, ByVal amod_id As Long, ByVal amod_string As String)

        Dim page_total As Integer = 0
        Dim chart_text As String = ""
        Dim temp_string As String = ""
        Dim record_count_inner As Long = 0

        Try


            If clsGeneral.clsGeneral.isCrmDisplayMode() Then
                NEW_CRMViewActive = True
            End If

            If made_first_page = False Then
            Else
                htmlOut.Append(comp_functions.NEW_Insert_Page_Break_PDF(0, WD.SelectedValue))
            End If

            NEW_PDF_AMOD_ID = amod_id

            'If page_name = "recent_retail" Or page_name = "current_market" Or page_name = "for_sale" Then
            '  htmlOut.Append(Replace(temp_pdf_header, "viewValueExport", "viewValueExport Simplistic"))
            'Else
            htmlOut.Append(temp_pdf_header)
            'End If

            made_first_page = True

            '   If Trim(table_color) <> "" Then
            '  If bWordReport = True Then
            '          htmlOut.Append("<table width='" & word_width & "'  class=""formatTable large " & table_color & """ align='center' cellpadding='3'>")
            '      Else
            '           htmlOut.Append("<table width='" & pdf_html_width & "'  class=""formatTable large " & table_color & """ align='center' cellpadding='3'>")
            '  End If
            '    Else
            If bWordReport = True Then
                htmlOut.Append("<table width='" & word_width & "' align='center' cellpadding='3'>")
            Else
                htmlOut.Append("<table width='" & pdf_html_width & "' align='center' cellpadding='3'>")
            End If


            ' class='formatTable " & table_color & "'




            'If Trim(page_name) = "Sales_Tab" Then
            '  Dim VariantList As String = ""
            '  Dim CurrentTransactionTable As New DataTable
            '  CurrentTransactionTable = GetTransactionAircraftStartingTable(NEW_PDF_AMOD_ID, "", "")   ''', clsGeneral.clsGeneral.ExtractSelectedStringFromListboxDropdown(VariantList, False, 0, True)
            '  ' GrabCurrentModelInformation(CurrentTransactionTable)
            '  '  WriteTransactionAircraftStartingTableJS(CurrentTransactionTable)

            '  Build_Sales_Tab(CurrentTransactionTable)

            'End If


            If Trim(page_name) = "performance_specs_op_costs" Then
                If MR_DESC_SPECS.Checked = True Then
                    page_total = page_total + 1
                    Dim temp_desc As String = ""
                    temp_desc = DisplayDescription(NEW_PDF_AMOD_ID)
                    htmlOut.Append(temp_desc)

                    If InStr(temp_desc, "<font size='-1'>") > 0 Then
                        htmlOut.Append(DisplayStandardEquipment(NEW_PDF_AMOD_ID, "Y"))
                    Else
                        htmlOut.Append(DisplayStandardEquipment(NEW_PDF_AMOD_ID, "N"))
                    End If

                    htmlOut.Append(New_Build_PerformanceSpecifications(False, "", False, "", "", NEW_PDF_AMOD_ID))
                    End If
                End If

            If Trim(page_name) = "op_costs" Then
                If MR_OPERATING_COSTS.Checked = True Then
                    page_total = page_total + 1
                    htmlOut.Append(New_Build_OperatingCosts("", NEW_PDF_AMOD_ID))
                End If
            End If

            If Trim(page_name) = "utilization" Then
                If MR_UTILIZATION.Checked = True Then
                    Dim ReturnString As String = ""
                    page_total = page_total + 1

                    util_functions.Airport_ID_OVERALL = 0

                    htmlOut.Append(DisplayUtilizationTrends(NEW_PDF_AMOD_ID))

                    Call util_functions.MostCommonOriginsJSArray(localCriteria, ReturnString, "", 0, True, True, 0, "valpdf", table_color, temp_pdf_header, 10, "<strong>" & real_make_model_name & "</strong> TOP ROUTES" & valueHeaderString)
                    htmlOut.Append("<tr><td colspan=""5"" align=""left"" valign=""top""><table width=""100%"" cellpadding=""0"" cellspacing=""0"">")
                    htmlOut.Append(ReturnString)
                    htmlOut.Append("</table></td></tr>")

                    ReturnString = ""
                    Call util_functions.Build_Operators_Array(localCriteria, "valpdf", 0, ReturnString, "", 0, 0, table_color, temp_pdf_header, 10, "<strong>" & real_make_model_name & "</strong> TOP OPERATORS" & valueHeaderString)
                    htmlOut.Append("<tr><td colspan=""5"" align=""left"" valign=""top""><table width=""100%"" cellpadding=""0"" cellspacing=""0"">")
                    htmlOut.Append(ReturnString)
                    htmlOut.Append("</table></td></tr>")

                End If
            End If

            If Trim(page_name) = "locations" Then
                If MR_LOCATIONS.Checked = True Then
                    page_total += 1
                    htmlOut.Append(BuildLocationsSection(NEW_PDF_AMOD_ID))
                End If
            End If


            If Trim(page_name) = "range" Then
                page_total += 1
                Dim comparisonText As String = ""



                comparisonText = "<span>RANGE FROM " & Mid(destination.Text, 1, destination.Text.LastIndexOf("(") - 1) & "</span>"

                htmlOut.Append("<tr><td align='center'><font class='" & Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & real_make_model_name & "</strong>&nbsp;Model Range" & comparisonText & "</font></td></tr>")
                htmlOut.Append("<tr class='" & Session("ROW_CLASS_BOTTOM") & " noBorders' valign='top'><td>")


                htmlOut.Append("<div class=""Box""><table width=""100%"" cellpadding=""3"" cellspacing=""0"" class=""formatTable large " & table_color & """>")
                If first_model.SelectedValue <> "" Then
                    htmlOut.Append("<thead><tr><td align=""left""><font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER_NOALIGN") & "'>Model</font></td><td align=""left"" valign=""top""><font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER_NOALIGN") & "'>Range (nm)</font></td><td align=""left"" valign=""top""><font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER_NOALIGN") & "'>Range Color</font></td></tr></thead>")
                End If
                htmlOut.Append("<tbody>")
                htmlOut.Append(BuildRangeTable(New DropDownList, NEW_PDF_AMOD_ID, "#ff0000"))
                htmlOut.Append(BuildRangeTable(first_model, 0, "#00CD00"))
                htmlOut.Append(BuildRangeTable(second_model, 0, "#0276FD"))
                htmlOut.Append("</tbody></table></div>")


                htmlOut.Append("<div class=""Box""><img src=""" & mapText.Text & """ /><p align=""center""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'><em>Range values predominantly expressed under the requirements for NBAA IFR Reserves and 0 wind</em></font></p></div></td></tr>")
            End If

            If Trim(page_name) = "upgrade" Then
                If MR_UPGRADE.Checked = True Then
                    page_total += 1
                    htmlOut.Append(BuildAverageLengthOfOwnershipSection)
                    htmlOut.Append(NEW_Build_PDF_Upgrade(NEW_PDF_AMOD_ID, real_make_model_name, True, localCriteria.ViewCriteriaStarReportDate))
                End If
            End If


            If Trim(page_name) = "DaysOnMarket" Then
                htmlOut.Append(DisplayDaysOnMarket(localCriteria.ViewCriteriaTimeSpan, "", localCriteria))
            End If

            If Trim(page_name) = "recent_market" Then
                If MR_RECENT_MARKET.Checked = True Then
                    page_total += 1
                    htmlOut.Append(Replace(NEW_Build_RecentMarketActivity(NEW_PDF_AMOD_ID, ""), "bordercolor='lightgrey' border='1'", ""))
                End If
            End If

            If Trim(page_name) = "fleet_summary" Then
                '  If Me.CP.Checked Then
                ' htmlOut.Append(NEW_Build_PDF_Cover(True))
                page_total = page_total + 1
                made_first_page = True

                If Me.MR_Fleet.Checked = True Then
                    htmlOut.Append(NEW_Build_FleetMarketSummary(NEW_PDF_AMOD_ID, False, real_make_model_name, "", "N", "", localCriteria))
                End If

                ' htmlOut.Append("<tr><td align='center' colspan='10'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>")
                '  htmlOut.Append("Report Date: " & System.DateTime.Now.ToShortDateString)
                ' htmlOut.Append("</td></tr>")
            End If



            If Trim(page_name) = "current_market" Then
                If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = False Then
                    htmlOut.Append(NEW_Build_MarketStatus(NEW_PDF_AMOD_ID, False, real_make_model_name, "", "N", "", localCriteria))
                End If
            End If



            If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = False Then
                If Trim(page_name) = "for_sale" Then
                    '   If MMS_BAFS.Checked Then
                    page_total = page_total + 1


                    htmlOut.Append(NEW_Build_AircraftForSale(NEW_PDF_AMOD_ID, "", False, "", "", "", ac_market.Text, year_start.Text, year_end.Text, aftt_start.Text, aftt_end.Text, aircraft_registration.SelectedValue, start_date.Text, end_date.Text, "", "", "", 998))

                    '  End If
                End If
            End If



            If Trim(page_name) = "characteristics" Then
                page_total = page_total + 1
                If Me.MR_Fleet.Checked = False Then
                    ' run this so i can get an ac_for_sale variable to run for this page 
                    Call NEW_Build_FleetMarketSummary(NEW_PDF_AMOD_ID, False, real_make_model_name, "", "N", "", localCriteria)
                End If

                htmlOut.Append(BuildMarketCharacteristics)
            End If



            If Trim(page_name) = "recent_retail" Then


                '  htmlOut.Append("<tr><td valign='top' align='center' colspan='10'><font class='" & Session("FONT_CLASS_HEADER") & "'> Sales Overview</font></td></tr>")

                ' htmlOut.Append("<tr><td valign='middle' align='center' colspan='10' height='1' style='border-bottom:1px solid lightgrey;'>&nbsp;</td></tr>")

                If MR_SITRENS.Checked = True Then


                    htmlOut.Append("<tr><td valign='middle' class='left' colspan='10'><font class='" & Session("FONT_CLASS_HEADER") & "  mainHeading'><strong>" & real_make_model_name & "</strong> Sales Insight" & valueEmptyHeaderString & "</font></td></tr>")


                    htmlOut.Append("<Tr><td align='center' valign=""top""><div class=""Box"">")
                    htmlOut.Append("<font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>Retail Sales Per Month<strong>Past " & localCriteria.ViewCriteriaTimeSpan & " Months</strong></font><img src='" & valueGraphText18.Text & "' width='100%' />")
                    htmlOut.Append("</div></td><td>&nbsp;</td><td align='center' valign=""top"" width=""485""><div class=""Box"">")

                    htmlOut.Append(make_sold_table_values(amod_id))

                    htmlOut.Append("</div></td></tr>")


                    If localCriteria.ViewCriteriaTimeSpan > 12 Then
                        htmlOut.Append("</table></td></tr></table>")
                        htmlOut.Append(comp_functions.NEW_Insert_Page_Break_PDF(0, WD.SelectedValue))

                        htmlOut.Append(temp_pdf_header)

                        If bWordReport = True Then
                            htmlOut.Append("<table width='" & word_width & "' align='center' cellpadding='3'>")
                        Else
                            htmlOut.Append("<table width='" & pdf_html_width & "' align='center' cellpadding='3'>")
                        End If
                    End If


                    ' htmlOut.Append("<tr><td valign='middle' align='center' colspan='10' height='1' style='border-bottom:1px solid lightgrey;'>&nbsp;</td></tr>") 
                    htmlOut.Append("<tr><td valign='middle' align='center' colspan='10'>&nbsp;</td></tr>")

                    htmlOut.Append("<tr><td valign='middle' class='left' colspan='10'><div class=""Box""><font class='" & Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & real_make_model_name & "</strong> Sales Trends" & valueHeaderString & "</font></div></td></tr>")

                    htmlOut.Append("<Tr><td align='center' valign=""top""><div class=""Box"">")

                    If HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag Then
                        htmlOut.Append("<font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>AVG ASKING VS SELLING PRICE($K)<strong>Past " & localCriteria.ViewCriteriaTimeSpan & " Months</strong></font><img src='" & valueGraphText8.Text & "' width='100%' />")
                    Else
                        htmlOut.Append("<font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>AVG ASKING PRICE($K)<strong>Past " & localCriteria.ViewCriteriaTimeSpan & " Months</strong></font><img src='" & valueGraphText8.Text & "' width='100%' />")
                    End If

                    htmlOut.Append("</div></td><td>&nbsp;</td><td align='center' valign=""top""><div class=""Box"">")

                    Call DisplayValueVintageTable(False, False, value_summary, "", "")
                    htmlOut.Append(value_summary)

                    htmlOut.Append("</div>")

                    If HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag Then
                        htmlOut.Append("<Br/><div class=""Box gaugeImage""><font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>AVERAGE SALES</font><img src='" & valueGraphTextGauge3.Text & "' width='320' align='center' /></div>")
                    Else
                        htmlOut.Append("<Br/><div class=""Box gaugeImage""><font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>AVERAGE ASKING</font><img src='" & valueGraphTextGuage2.Text & "' width='320' align='center' /></div>")
                    End If


                    htmlOut.Append("</td></tr>")
                    htmlOut.Append("</table>")

                    If MR_RRS.Checked Then
                        htmlOut.Append(comp_functions.NEW_Insert_Page_Break_PDF(0, WD.SelectedValue))

                        htmlOut.Append(temp_pdf_header)

                        If bWordReport = True Then
                            htmlOut.Append("<table width='" & word_width & "' align='center' cellpadding='3'>")
                        Else
                            htmlOut.Append("<table width='" & pdf_html_width & "' align='center' cellpadding='3'>")
                        End If
                    End If
                End If


                ' htmlOut.Append("<tr class='" & Session("ROW_CLASS_BOTTOM") & "' valign='top'><td colspan='10'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td></tr>")

                If MR_RRS.Checked Then

                    Dim preownedSales_Only As Boolean = False
                    Dim check_retail_sales As Boolean = False
                    Dim check_include_internal As Boolean = False

                    If Not IsNothing(Request("retail_tab_preownedSales_Only")) Then
                        If Trim(Request("retail_tab_preownedSales_Only")) = "true" Then
                            preownedSales_Only = True
                        End If
                    End If

                    If Not IsNothing(Request("retail_tab_check_retail_sales2")) Then
                        If Trim(Request("retail_tab_check_retail_sales2")) = "true" Then
                            check_retail_sales = True
                        End If
                    End If

                    If Not IsNothing(Request("retail_tab_check_include_internals2")) Then
                        If Trim(Request("retail_tab_check_include_internals2")) = "true" Then
                            check_include_internal = True
                        End If
                    End If


                    Dim temp_table As New DataTable
                    Dim sRetailSales As String = ""


                    page_total = page_total + 1
                    If NEW_CRMViewActive Then
                        temp_table = Nothing
                        crmViewDataLayer.Combined_views_display_recent_retail_sales(localCriteria, sRetailSales, localdatalayer, NEW_CRMViewActive, False, temp_table, IIf(check_include_internal, "Y", "N"), IIf(check_retail_sales, "Y", "N"), False, 0, 0, "", 0, 0, "", True, "", "", "", "", "", "", "", "", "", 0, "", 0, 0, "", "", "", "", "", "", "", "", "", "", "", preownedSales_Only)
                        made_first_page = True
                        ' htmlOut.Append(sRetailSales) 
                    End If

                    htmlOut.Append(NEW_Build_RecentRetailSales(NEW_PDF_AMOD_ID, "", "", ac_market.Text, year_start.Text, year_end.Text, aftt_start.Text, aftt_end.Text, aircraft_registration.SelectedValue, localCriteria.ViewCriteriaDocumentsStartDate, localCriteria.ViewCriteriaDocumentsEndDate, "", "", "", temp_table))

                End If


            End If


            'If Trim(page_name) = "Values_Summary" Then
            '  Call DisplayValueVintageTable(False, False, value_summary)
            '  htmlOut.Append(value_summary)
            'End If

            If Trim(page_name) = "Vintage" Then
                htmlOut.Append(DisplayValueVintageTable(False, False, "", "", ""))
            End If

            If Trim(page_name) = "Quarter" Then
                htmlOut.Append(DisplayQuarterTable("", "", "", "", "", ""))
            End If


            If Trim(page_name) = "AFTT" Then
                htmlOut.Append(DisplayAFTTTable("", ""))
            End If


            If Trim(page_name) = "Weight" Then
                htmlOut.Append(DisplayWeightTable("", ""))
            End If

            If clsGeneral.clsGeneral.isEValuesAvailable() = True And clsGeneral.clsGeneral.isShowingEvalues() = True Then
                If Trim(page_name) = "Current_Market_Valuation" Then
                    htmlOut.Append(Display_Current_Market_Trend())
                End If

                If Trim(page_name) = "Values_By_Year_DLV" Then
                    htmlOut.Append(Display_Values_By_MFR_Year_Graph())
                End If

                If Trim(page_name) = "Values_By_Month" Then
                    htmlOut.Append(Display_Values_By_Month_Graph())
                End If

                If Trim(page_name) = "Residuals" Then
                    htmlOut.Append(Display_Residual_Values_By_Year_MFR_Graph())
                End If

                If Trim(page_name) = "MFRAFTT" Then
                    htmlOut.Append(Display_Model_By_AFTT())
                End If
            End If


            If Trim(page_name) = "ForSaleStats" Then

                Try
                    star_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
                    star_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
                    star_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
                    star_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
                    star_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim
                    temp_string = ""
                    Dim results_table As New DataTable
                    results_table = star_functions.get_max_star_report_date(localCriteria)

                    If Not IsNothing(results_table) Then
                        If results_table.Rows.Count > 0 Then
                            For Each r As DataRow In results_table.Rows

                                If Not IsDBNull(r.Item("ac1_start_date")) Then
                                    If Not String.IsNullOrEmpty(r.Item("ac1_start_date").ToString.Trim) Then
                                        localCriteria.ViewCriteriaStarReportDate = CDate(r.Item("ac1_start_date").ToString)
                                    Else
                                    End If
                                End If

                            Next
                        Else
                        End If
                    Else
                    End If

                    htmlOut.Append("<tr><td valign='top' align='left' colspan='10'><font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & real_make_model_name & " </strong>MARKET BY AGE OF FLEET" & valueEmptyHeaderString & "</font></td></tr>")

                    htmlOut.Append("<tr><td valign='top'><div class=""Box""><table id=""weightTable"" cellpadding='3'  cellspacing='0' width='100%' class='formatTable " & table_color & "'><thead>")
                    star_functions.views_display_live_star_aircraft_13(localCriteria, temp_string, True, "", "", record_count_inner)

                    temp_string = Replace(temp_string, "class='th_title_details'", "")
                    temp_string = Replace(temp_string, "class='th_title' ", "")
                    temp_string = Replace(temp_string, "class='separateheader'", "")
                    temp_string = Replace(temp_string, "class='lightcyan' ", "")
                    temp_string = Replace(temp_string, "class='beige'", "")
                    temp_string = Replace(temp_string, "class='beige2'", "")
                    temp_string = Replace(temp_string, "", "")


                    htmlOut.Append(temp_string)

                    htmlOut.Append("</td></tr>")


                    htmlOut.Append("<tr><td colspan=""10"">&nbsp;</td></tr>")


                    If record_count_inner > 25 Then
                        htmlOut.Append("</table>")
                        htmlOut.Append("</div></tr></table>")
                        htmlOut.Append("</div></td></tr></table>")

                        htmlOut.Append(comp_functions.NEW_Insert_Page_Break_PDF(0, WD.SelectedValue))

                        htmlOut.Append(temp_pdf_header)

                        If bWordReport = True Then
                            htmlOut.Append("<table width='" & word_width & "' align='center' cellpadding='3'>")
                        Else
                            htmlOut.Append("<table width='" & pdf_html_width & "' align='center' cellpadding='3'>")
                        End If

                    End If

                    htmlOut.Append("<tr><td valign=""top"" colspan=""10"" ><table cellspacing='0' cellpadding='0' border='0' width='100%'><tr>")
                    htmlOut.Append("<td align='center' width='43%'><div class=""Box"">")
                    htmlOut.Append("<div style=""width:450px;"" class=""marginAuto""><font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER_NOALIGN") & "'>FOR SALE BY MFR YEAR</font><img src='" & valueGraphText25.Text & "' width='100%' align='center'  class=""marginAuto""/></div>")
                    htmlOut.Append("</div></td>")
                    htmlOut.Append("<td>&nbsp;</td>")
                    htmlOut.Append("<td align='center' width='43%'><div class=""Box"">")
                    htmlOut.Append("<div style=""width:450px;"" class=""marginAuto""><font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER_NOALIGN") & "'>AVERAGE ASKING BY MFR YEAR</font><img src='" & valueGraphText26.Text & "' width='100%' align='center'  class=""marginAuto""/></div>")
                    htmlOut.Append("</div></td>")

                    htmlOut.Append("</tr></table>")
                    htmlOut.Append("</td></tr>")

                Catch ex As Exception

                End Try

            End If



            htmlOut.Append("</table>")

            ' comp_functions.create_value_with_label("Damage History", "Y", True, True, Counter_For_PDF, spacer_width)

        Catch ex As Exception

        End Try

    End Sub

    Public Function BuildRangeTable(ByVal model_Dropdown As DropDownList, ByVal amodID As Long, ByVal colorStr As String) As String
        Dim passSearch As New viewSelectionCriteriaClass
        Dim htmlOut As New StringBuilder
        Dim ModelID As Long = 0
        Dim ModelName As String = ""

        If amodID > 0 Then
            ModelID = amodID
            ModelName = real_make_model_name
        ElseIf model_Dropdown.SelectedValue <> "" Then
            Dim tempArray As String() = Split(model_Dropdown.SelectedValue, "|")
            ModelID = CLng(tempArray(0))
            ModelName = model_Dropdown.SelectedItem.Text
        End If
        passSearch.ViewCriteriaAmodID = CLng(ModelID)

        If ModelID > 0 Then

            RangeOfModel(passSearch, 0)
            Select Case CInt(passSearch.ViewCriteriaAirframeType)
                Case Constants.VIEW_HELICOPTERS
                    passSearch.ViewCriteriaAircraftRange = passSearch.ViewCriteriaHeliRangeTanksFull
                Case Else
                    passSearch.ViewCriteriaAircraftRange = passSearch.ViewCriteriaAircraftRange
            End Select

            htmlOut.Append("<tr><td align=""left"">" & ModelName & "</td><td align=""left"" valign=""top"">" & FormatNumber(passSearch.ViewCriteriaAircraftRange, 0) & "</td><td align=""left"" valign=""top""><div style=""width:25px;height:25px;display:block;background-color:" & colorStr & """></div></td></tr>")

        End If
        Return htmlOut.ToString
    End Function
    Public Function BuildMarketCharacteristics() As String
        Dim returnString As String = ""
        returnString = "<tr><td valign='middle' class='left' colspan='2'><font class='" & Session("FONT_CLASS_HEADER") & "  mainHeading'><strong>" & real_make_model_name & "</strong> MARKET CHARACTERISTICS" & valueEmptyHeaderString & "</font></td></tr>"
        returnString += "<tr><td valign='middle' colspan='2' class=""center""><span class='" & Session("FONT_CLASS_TEXT_TITLE") & "'>THE CHARACTERISTICS ON THIS PAGE RELATE ONLY TO CURRENT AIRCRAFT ON MARKET</span></td></tr>"
        returnString += "<tr><td valign='middle' colspan='2'><br /><div  class=""Box gaugeImage Special"">"
        'Gauge Holders
        returnString += "<table width=""100%"" cellspacing=""0"" cellpadding=""0"">"
        returnString += "<tr>"
        Dim counter As Integer = 1
        Dim total_counter As Integer = 0
        Dim results_Table As New DataTable
        Dim LocationTable As New DataTable
        LocationTable = GetContinents(NEW_PDF_AMOD_ID, year_start.Text, year_end.Text, aftt_start.Text, aftt_end.Text, aircraft_registration.SelectedValue, localCriteria.ViewCriteriaDocumentsStartDate, localCriteria.ViewCriteriaDocumentsEndDate, True)

        results_Table = GetTopFeatures(NEW_PDF_AMOD_ID)

        total_counter = results_Table.Rows.Count

        For Each r As DataRow In results_Table.Rows
            If counter < 7 And total_counter > 1 Then
                Dim variableTextbox As New TextBox
                If Not IsNothing(featuresGaugePanel.FindControl("features" & counter.ToString & "text")) Then
                    variableTextbox = featuresGaugePanel.FindControl("features" & counter.ToString & "text")
                End If

                If counter = 4 Then
                    returnString += "</tr><tr>"
                End If
                returnString += "<td align=""left"" valign=""top"" width=""33%""><font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>" & r("kfeat_name") & "<strong>" & FormatNumber((r("ACFEATYES") / ac_for_sale) * 100, 0) & "% (" & r("ACFEATYES") & ")</font><img src='" & variableTextbox.Text & "' width='100%' align='center' /></td>"
                counter += 1
            ElseIf total_counter = 1 Then
                Dim variableTextbox As New TextBox
                If Not IsNothing(featuresGaugePanel.FindControl("features" & counter.ToString & "text")) Then
                    variableTextbox = featuresGaugePanel.FindControl("features" & counter.ToString & "text")
                End If
                returnString += "<td align=""left"" valign=""top""><font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>" & r("kfeat_name") & "<strong>" & FormatNumber((r("ACFEATYES") / ac_for_sale) * 100, 0) & "% (" & r("ACFEATYES") & ")</font><div style=""width:300px;"" class=""marginAuto""><img src='" & variableTextbox.Text & "' align='center' /></div></td><td>&nbsp;</td><td>&nbsp;</td>"
                counter += 1
            End If
        Next

        returnString += "</tr></table></div></td></tr>"

        results_Table = New DataTable
        results_Table = GetTopProgramName(NEW_PDF_AMOD_ID)

        returnString += "<tr>"
        returnString += "<td valign='top' width=""50%""><div  class=""Box"">"

        If Not IsNothing(results_Table) Then
            If results_Table.Rows.Count > 0 Then

                returnString += "<table width=""100%"" cellpadding=""0"" cellspacing=""0"" class=""formatTable large " & table_color & """>"
                returnString += "<thead><tr><th>ENGINE MAINTENANCE</th><th class=""right"">% FOR SALE</th></tr></thead>"
                returnString += "<tbody>"
                For Each r As DataRow In results_Table.Rows
                    returnString += "<tr><td>" & r("ENGPROGNAME") & "</td>"
                    returnString += "<td class=""right"">" & FormatNumber((r("tcount") / ac_for_sale) * 100, 0) & "% (" & r("tcount") & ")</td></tr>"
                Next
                returnString += "</tbody>"
                returnString += "</table>"
            End If
        End If

        returnString += "</div></td><td valign='top' width=""50%""><div class=""Box""><!--<font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>AVERAGE SALES</font>--><img src='" & ValueGraphText22.Text & "' width='100%' align='center' /></div></td></tr>"
        returnString += "<tr><td valign='top'><div  class=""Box"">"

        If Not IsNothing(LocationTable) Then
            If LocationTable.Rows.Count > 0 Then

                returnString += "<table width=""100%"" cellpadding=""0"" cellspacing=""0"" class=""formatTable large " & table_color & """>"
                returnString += "<thead><tr><th>LOCATION</th><th class=""right"">% FOR SALE</th></tr></thead>"
                returnString += "<tbody>"
                For Each r As DataRow In LocationTable.Rows
                    returnString += "<tr><td>" & r("country_continent_name") & "</td>"
                    returnString += "<td class=""right"">" & FormatNumber((r("tcount") / ac_for_sale) * 100, 0) & "% (" & r("tcount") & ")</td></tr>"
                Next
                returnString += "</tbody>"
                returnString += "</table>"
            End If
        End If

        returnString += "</div></td><td valign='top'><div class=""Box""><!--<font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>AVERAGE SALES</font>--><img src='" & ValueGraphText23.Text & "' width='100%' align='center' /></div></td>"
        returnString += "</tr>"
        'returnString += "<tr><td valign='middle' class='left' colspan='10'><font class='" & Session("FONT_CLASS_HEADER") & "  mainHeading'><strong>" & real_make_model_name & "</strong> MARKET ENGINE PROGRAMS" & valueEmptyHeaderString & "</font></td></tr>"

        'returnString += "<tr><td valign='middle' colspan='2'><div  class=""Box gaugeImage Special"">"
        ''Gauge Holders
        'returnString += "<table width=""100%"" cellspacing=""0"" cellpadding=""0"">"
        'returnString += "<tr>"
        'counter = 1

        'For Each r As DataRow In results_Table.Rows
        '  If counter < 4 Then
        '    Dim variableTextbox As New TextBox
        '    If Not IsNothing(featuresGaugePanel.FindControl("program" & counter.ToString & "text")) Then
        '      variableTextbox = featuresGaugePanel.FindControl("program" & counter.ToString & "text")
        '    End If

        '    returnString += "<td align=""left"" valign=""top"" width=""33%""><font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>" & r("ENGPROGNAME") & "<strong>" & FormatNumber((r("tcount") / ac_for_sale) * 100, 0) & "% (" & r("tcount") & ")</strong></font><img src='" & variableTextbox.Text & "' width='100%' align='center' /></td>"
        '    counter += 1
        '  End If
        'Next

        'If counter < 4 Then
        '  For i = counter To 3
        '    returnString += "<td align=""left"" valign=""top"" width=""33%""></td>"
        '  Next
        'End If
        'returnString += "</tr></table></div></td></tr>"


        Return returnString
    End Function
    Public Function BuildLocationsSection(ByRef amodID As Long) As String
        Dim returnString As String = ""
        Dim locationTable As New DataTable
        returnString = "<tr><td valign='middle' class='left' colspan='10'><font class='" & Session("FONT_CLASS_HEADER") & "  mainHeading'><strong>" & real_make_model_name & "</strong> LOCATIONS (US VS NON-US)" & valueHeaderString & "</font></td></tr>"

        returnString += "<tr><td valign='top' class='left' colspan='5'><div class=""Box gaugeImage""><font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>U.S. BASED</font><img src='" & valueGraphTextGuageUS.Text & "' width='100%' align='center' /></div>"

        returnString += "</td><td valign='top' class='left' colspan='5'><div class=""Box gaugeImage""><font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>NON-U.S. BASED</font><img src='" & valueGraphTextGuageForeign.Text & "' width='100%' align='center' /></div></td></tr>"

        returnString += "<tr><td valign='middle' class='left' colspan='10'><font class='" & Session("FONT_CLASS_HEADER") & "  mainHeading'><strong>" & real_make_model_name & "</strong> LOCATIONS BY CONTINENT/COUNTRY" & valueHeaderString & "</font></td></tr>"
        locationTable = GetContinents(amodID, year_start.Text, year_end.Text, aftt_start.Text, aftt_end.Text, aircraft_registration.SelectedValue, localCriteria.ViewCriteriaDocumentsStartDate, localCriteria.ViewCriteriaDocumentsEndDate, False)
        returnString += "<tr><td valign='top' class='left' colspan='5'><div class=""Box"">"
        If Not IsNothing(locationTable) Then
            If locationTable.Rows.Count > 0 Then
                returnString += "<table width=""100%"" cellpadding=""3"" class=""formatTable large " & table_color & """>"
                returnString += "<thead><tr><th>CONTINENTS</th><th class=""right"">FLEET</th></tr></thead>"
                returnString += "<tbody>"
                For Each r As DataRow In locationTable.Rows
                    returnString += "<tr>"
                    returnString += "<td>"
                    If Not IsDBNull(r("country_continent_name")) Then
                        returnString += r("country_continent_name")
                    End If
                    returnString += "</td>"
                    returnString += "<td class=""right"">"
                    If Not IsDBNull(r("tcount")) Then
                        returnString += r("tcount").ToString
                    End If
                    returnString += "</td>"
                    returnString += "</tr>"
                Next
                returnString += "</tbody>"
                returnString += "</table>"
            End If
        End If
        returnString += "</div></td>"
        locationTable = New DataTable
        returnString += "<td valign='top' class='left' colspan='5'><div class=""Box"">"
        locationTable = GetTopCountries(amodID, year_start.Text, year_end.Text, aftt_start.Text, aftt_end.Text, aircraft_registration.SelectedValue, localCriteria.ViewCriteriaDocumentsStartDate, localCriteria.ViewCriteriaDocumentsEndDate)

        If Not IsNothing(locationTable) Then
            If locationTable.Rows.Count > 0 Then
                returnString += "<table width=""100%"" cellpadding=""3"" class=""formatTable large " & table_color & """>"
                returnString += "<thead><tr><th>TOP COUNTRIES</th><th class=""right"">FLEET</th></tr></thead>"
                returnString += "<tbody>"
                For Each r As DataRow In locationTable.Rows
                    returnString += "<tr>"
                    returnString += "<td>"
                    If Not IsDBNull(r("country_name")) Then
                        returnString += r("country_name")
                    End If
                    returnString += "</td>"
                    returnString += "<td class=""right"">"
                    If Not IsDBNull(r("tcount")) Then
                        returnString += r("tcount").ToString
                    End If
                    returnString += "</td>"
                    returnString += "</tr>"
                Next
                returnString += "</tbody>"
                returnString += "</table>"
            End If
        End If

        returnString += "</div></td></tr>"
        Return returnString

    End Function


    Public Function BuildAverageLengthOfOwnershipSection() As String
        Dim returnString As String = ""
        'Dim Results_Table As New DataTable
        ''Get max date:
        'localCriteria.ViewCriteriaStarReportDate = localCriteria.ViewCriteriaStarReportDate
        'Results_Table = star_functions.get_max_star_report_date(searchCriteria)

        'If Not IsNothing(Results_Table) Then
        '  If Results_Table.Rows.Count > 0 Then
        '    For Each r As DataRow In Results_Table.Rows

        '      If Not IsDBNull(r.Item("ac1_start_date")) Then
        '        If Not String.IsNullOrEmpty(r.Item("ac1_start_date").ToString.Trim) Then
        '          searchCriteria.ViewCriteriaStarReportDate = CDate(r.Item("ac1_start_date").ToString)
        '        End If
        '      End If
        '    Next
        '  End If
        'End If


        returnString = "<tr><td valign='middle' class='left' colspan='10'><font class='" & Session("FONT_CLASS_HEADER") & "  mainHeading'><strong>" & real_make_model_name & "</strong> AVERAGE LENGTH OF OWNERSHIP" & valueEmptyHeaderString & "</font></td></tr>"
        returnString += "<tr><td valign='middle' class='left' colspan=""5""><div class=""Box gaugeImage""><font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>Factory New</font><img src='" & valueGraphTextGauge4.Text & "' width='100%' style=""margin-bottom:-110px"" /></div></td><td valign='middle' class='left' colspan=""5""><div class=""Box gaugeImage""><font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>Pre-Owned</font><img src='" & valueGraphTextGauge5.Text & "' style=""margin-bottom:-110px"" width='100%' /></div></td></tr>"

        Return returnString

    End Function
    Public Function make_sold_table_values(ByVal amod_id As Long)

        make_sold_table_values = ""

        Dim rtable As New DataTable
        Dim htmlout As New StringBuilder

        Try

            rtable = GET_SOLD_PER_MONTH_MTREND(amod_id, localCriteria.ViewCriteriaTimeSpan, "")

            If rtable.Rows.Count > 0 Then
                If rtable.Rows.Count > (localCriteria.ViewCriteriaTimeSpan + 2) Then
                    rtable.Clear()
                    rtable = GET_SOLD_PER_MONTH_MTREND(amod_id, localCriteria.ViewCriteriaTimeSpan, "B")

                    If rtable.Rows.Count = 0 Then
                        rtable = GET_SOLD_PER_MONTH_MTREND(amod_id, localCriteria.ViewCriteriaTimeSpan, "H")
                        If rtable.Rows.Count = 0 Then
                            rtable = GET_SOLD_PER_MONTH_MTREND(amod_id, localCriteria.ViewCriteriaTimeSpan, "C")
                        End If
                    End If
                End If
            End If


            If rtable.Rows.Count > 0 Then

                htmlout.Append("<table cellpadding='4' cellspacing='0' width='100%' class='formatTable large " & table_color & "'><thead>")
                htmlout.Append("<tr><th class='upperCase left'>Month</th><th class='upperCase right'>FOR<br/>SALE</th><th class='upperCase right'>SOLD</th><th class='upperCase right'>AVG<br/>ASK PRICE</th><th class='upperCase right'>DAYS ON<br/>MARKET</th></tr>")
                htmlout.Append("</thead><tbody>")

                For Each r As DataRow In rtable.Rows

                    htmlout.Append("<tr><td class='upperCase'>" & r.Item("mtrend_month") & "/" & r.Item("mtrend_year") & "</font></td><td align='right'>" & r.Item("FORSALE") & "</td><td align='right'>" & r.Item("NUMSOLD") & "</td>")

                    If Not IsDBNull(r.Item("AVGASKPRICE")) Then
                        htmlout.Append("<td align='right'>$" & FormatNumber((r.Item("AVGASKPRICE") / 1000), 0) & "k</td>")
                    Else
                        htmlout.Append("<td align='right'>&nbsp;</td>")
                    End If

                    htmlout.Append("<td align='right'>" & r.Item("AVGDAYSONMARKET") & "</td></tr>")

                Next
            End If

            htmlout.Append("</tbody></table>")

            make_sold_table_values = htmlout.ToString

        Catch ex As Exception

        End Try
    End Function
    Private Function DisplayQuarterTable(ByRef Graph5 As String, ByRef Graph6 As String, ByRef Graph7 As String, ByRef Graph8 As String, ByRef Graph9 As String, ByRef Graph10 As String) As String
        DisplayQuarterTable = ""
        Dim ValueQuarterTable As New DataTable


        If HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag Then
            ValueQuarterTable = GetValuesTrendsByQuarter(NEW_PDF_AMOD_ID, "", year_start.Text, year_end.Text, aftt_start.Text, aftt_end.Text, aircraft_registration.SelectedValue, localCriteria.ViewCriteriaDocumentsStartDate, localCriteria.ViewCriteriaDocumentsEndDate, False, True, 0) ' clsGeneral.clsGeneral.ExtractSelectedStringFromListboxDropdown(VariantList, False, 0, True)
        Else
            ValueQuarterTable = GetValuesTrendsByQuarter(NEW_PDF_AMOD_ID, "", year_start.Text, year_end.Text, aftt_start.Text, aftt_end.Text, aircraft_registration.SelectedValue, localCriteria.ViewCriteriaDocumentsStartDate, localCriteria.ViewCriteriaDocumentsEndDate, True, True, 0) ' clsGeneral.clsGeneral.ExtractSelectedStringFromListboxDropdown(VariantList, False, 0, True)
            ' changed the all asking parameter to true so it gets everything - MSW - 1/22/19
        End If


        DisplayQuarterTable = DisplayValueQuarterTable(ValueQuarterTable, Graph7, Graph5, Graph6)

        Me.VALUES_CHART.Titles.Add("")
        Me.VALUES_CHART.ImageType = DataVisualization.Charting.ChartImageType.Jpeg

        Me.VALUES_CHART.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "VALUES_CHART_1_QUARTER.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
        Me.VALUES_CHART2.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "VALUES_CHART_5_QUARTER.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
        Me.VALUES_CHART3.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "VALUES_CHART_6_QUARTER.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)



        ValueQuarterTable = New DataTable
        ValueQuarterTable = GetValuesTrendsByQuarter(NEW_PDF_AMOD_ID, "", year_start.Text, year_end.Text, aftt_start.Text, aftt_end.Text, aircraft_registration.SelectedValue, localCriteria.ViewCriteriaDocumentsStartDate, localCriteria.ViewCriteriaDocumentsEndDate, True, True, 0) 'clsGeneral.clsGeneral.ExtractSelectedStringFromListboxDropdown(VariantList, False, 0, True)

        DisplayValueQuarterOtherGraphs(ValueQuarterTable, Graph8, Graph9, Graph10)


        Me.VALUES_CHART.Titles.Add("")
        Me.VALUES_CHART.ImageType = DataVisualization.Charting.ChartImageType.Jpeg

        Me.VALUES_CHART.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "VALUES_CHART_2_QUARTER.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
        Me.VALUES_CHART2.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "VALUES_CHART_3_QUARTER.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
        Me.VALUES_CHART3.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "VALUES_CHART_4_QUARTER.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)



        DisplayQuarterTable &= "<tr><td><br/><br/><table cellspacing='0' cellpadding='0' border='0' width='100%'><tr><td align='center' width='100%' valign=""top""><div class=""Box""><div style=""width:700px;"" class=""marginAuto"">"

        If HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag Then
            DisplayQuarterTable &= "<font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER_NOALIGN") & "'>Avg Asking vs Selling Price($k) - (Asking with Sold)</font>"
        Else
            DisplayQuarterTable &= "<font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER_NOALIGN") & "'>Avg Asking Price($k)</font>"
        End If
        ' DisplayQuarterTable &= "</td><!--<td>&nbsp;</td>--><td align='center'>"
        '  DisplayQuarterTable &= "<font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER_NOALIGN") & "'>Avg Asking vs Selling Price($k) - (All Prices)</font>"
        '  DisplayQuarterTable &= "<img src='" & HttpContext.Current.Session.Item("jetnetFullHostName").ToString & "/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "VALUES_CHART_1_QUARTER.jpg'>"
        '  DisplayQuarterTable &= "</td><td>&nbsp;</td><td align='center'>"
        '  DisplayQuarterTable &= "<img src='" & HttpContext.Current.Session.Item("jetnetFullHostName").ToString & "/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "VALUES_CHART_2_QUARTER.jpg'>"
        '  DisplayQuarterTable &= "</td><td>&nbsp;</td><td align='center'>"


        DisplayQuarterTable &= "<img src='" & valueGraphText7.Text & "' width='700' align='center'  align='center' class=""marginAuto"" />"
        DisplayQuarterTable &= "</div></div></td><!--<td>&nbsp;</td>--><td align='center'>"
        ' DisplayQuarterTable &= "<img src='" & valueGraphText8.Text & "' width='475' align='center' />"
        '  DisplayQuarterTable &= "</td><!--<td>&nbsp;</td>--><td align='center'>"


        DisplayQuarterTable &= "</td></tr></table>"
        DisplayQuarterTable &= "</td></tr>"

        DisplayQuarterTable &= ("</table>")

        ''-------------------------------------------------------------
        '' COMMENTED OUT SEECTION W 4 GRAPHS
        'DisplayQuarterTable &= (comp_functions.NEW_Insert_Page_Break_PDF(0, WD.SelectedValue))
        'DisplayQuarterTable &= (temp_pdf_header)
        'If bWordReport = True Then
        '  DisplayQuarterTable &= ("<table width='" & word_width & "' align='center' cellpadding='3'>")
        'Else
        '  DisplayQuarterTable &= ("<table width='" & pdf_html_width & "' align='center' cellpadding='3'>")
        'End If



        'DisplayQuarterTable &= "<tr><td><br/><br/><table cellspacing='0' cellpadding='0' border='0'><tr><td align='center'>"
        'DisplayQuarterTable &= "<font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER_NOALIGN") & "'>Avg Asking Price ($k) - (All Asking Prices)</font>"
        'DisplayQuarterTable &= "</td><!--<td>&nbsp;</td>--><td align='center'>"
        'DisplayQuarterTable &= "<font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER_NOALIGN") & "'>Avg Sold Price ($k) - (All Sold Prices)</font>"
        'DisplayQuarterTable &= "</td></tr><tr><td align='center'>"
        '' DisplayQuarterTable &= "<img src='" & HttpContext.Current.Session.Item("jetnetFullHostName").ToString & "/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "VALUES_CHART_3_QUARTER.jpg'>"
        '' DisplayQuarterTable &= "</td><td>&nbsp;</td><td align='center'>"
        '' DisplayQuarterTable &= "<img src='" & HttpContext.Current.Session.Item("jetnetFullHostName").ToString & "/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "VALUES_CHART_4_QUARTER.jpg'>"
        '' DisplayQuarterTable &= "</td><td>&nbsp;</td><td align='center'>" 

        'DisplayQuarterTable &= "<img src='" & valueGraphText9.Text & "' width='475' align='center' />"
        'DisplayQuarterTable &= "</td><!--<td>&nbsp;</td>--><td align='center'>"
        'DisplayQuarterTable &= "<img src='" & valueGraphText10.Text & "' width='475' align='center' />"
        'DisplayQuarterTable &= "</td><!--<td>&nbsp;</td>--><td align='center'>"

        'DisplayQuarterTable &= "</td></tr></table>"
        'DisplayQuarterTable &= "</td></tr>"


        'DisplayQuarterTable &= "<tr><td><br/><br/><table cellspacing='0' cellpadding='0' border='0'><tr><td align='center'>"
        'DisplayQuarterTable &= "<font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER_NOALIGN") & "'>Avg. Sold Price % of Asking Price -  (Asking with Sold)</font>"
        'DisplayQuarterTable &= "</td><!--<td>&nbsp;</td>--><td align='center'>"
        'DisplayQuarterTable &= "<font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER_NOALIGN") & "'>Variance of Sold Price from Asking Price - (Asking with Sold)</font>"
        ''  DisplayQuarterTable &= "</td></tr><tr><td align='center'>"
        ''  DisplayQuarterTable &= "<img src='" & HttpContext.Current.Session.Item("jetnetFullHostName").ToString & "/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "VALUES_CHART_5_QUARTER.jpg'>"
        '' DisplayQuarterTable &= "</td><td>&nbsp;</td><td align='center'>"
        ''  DisplayQuarterTable &= "<img src='" & HttpContext.Current.Session.Item("jetnetFullHostName").ToString & "/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "VALUES_CHART_6_QUARTER.jpg'>"
        '' DisplayQuarterTable &= "</td><td>&nbsp;</td><td align='center'>"
        ''
        'DisplayQuarterTable &= "</td></tr><tr><td align='center'>"
        'DisplayQuarterTable &= "<img src='" & valueGraphText5.Text & "'  width='475' align='center' />"
        'DisplayQuarterTable &= "</td><!--<td>&nbsp;</td>--><td align='center'>"
        'DisplayQuarterTable &= "<img src='" & valueGraphText6.Text & "'  width='475' align='center' />"
        'DisplayQuarterTable &= "</td><td>&nbsp;</td><td align='center'>"


        'DisplayQuarterTable &= "</td></tr></table>"
        'DisplayQuarterTable &= "</td></tr>"

        ''---------------------------------------------------------


        ' BuildValueGraphs(Graph1, Graph2, Graph3, Graph4, Graph5, Graph6)


        '  BuildQuarterTable()
        'If Not Page.ClientScript.IsClientScriptBlockRegistered("refreshQuarterTable") Then
        '  System.Web.UI.ScriptManager.RegisterClientScriptBlock(Me.tabs_bottom_4_update_panel, Me.GetType, "refreshQuarterTable", TableBuild.ToString, True)
        'End If

        'RecreateDropdownsValueYearGraphs(tabs_bottom_4_update_panel, False, True, True)


    End Function
    Public Sub DisplayValueQuarterOtherGraphs(ByVal dt As DataTable, ByRef Graph8 As String, ByRef Graph9 As String, ByRef Graph10 As String)
        Dim AvgAsking As Double = 0
        Dim AvgAskingHidden As Double = 0

        Dim YearMFR As Long = 0
        Dim YearDLV As Long = 0
        Dim yearSold As String = ""
        Dim quarterSold As String = ""

        Dim selling As Double = 0
        Dim _percent As Double = 0
        Dim percentHidden As Double = 0

        Dim variance As Double = 0
        Dim varianceHidden As Double = 0
        Dim avgAftt As Long = 0
        Dim avgDOM As Long = 0


        Dim high_number As Integer = 0
        Dim low_number As Integer = 20000000
        Dim starting_point As Integer = 0
        Dim interval_point As Integer = 1
        Dim ending_point As Integer = 0

        Dim high_number2 As Integer = 0
        Dim low_number2 As Integer = 20000000
        Dim starting_point2 As Integer = 0
        Dim interval_point2 As Integer = 1
        Dim ending_point2 As Integer = 0

        Dim high_number3 As Integer = 0
        Dim low_number3 As Integer = 20000000
        Dim starting_point3 As Integer = 0
        Dim interval_point3 As Integer = 1
        Dim ending_point3 As Integer = 0

        Me.VALUES_CHART.Series.Clear()
        Me.VALUES_CHART2.Series.Clear()
        Me.VALUES_CHART3.Series.Clear()
        Me.VALUES_CHART.Series.Add("AVG_PRICE").ChartType = UI.DataVisualization.Charting.SeriesChartType.Spline
        Me.VALUES_CHART.Series.Add("AVG_PRICE2").ChartType = UI.DataVisualization.Charting.SeriesChartType.Spline

        Me.VALUES_CHART.ChartAreas("ChartArea1").AxisY.Title = ""

        Me.VALUES_CHART.Series("AVG_PRICE").Color = Drawing.Color.Blue
        Me.VALUES_CHART.Series("AVG_PRICE").BorderWidth = 1
        Me.VALUES_CHART.Series("AVG_PRICE").MarkerSize = 5
        Me.VALUES_CHART.Series("AVG_PRICE").MarkerStyle = UI.DataVisualization.Charting.MarkerStyle.Circle
        Me.VALUES_CHART.BorderlineWidth = 10
        Me.VALUES_CHART.Series("AVG_PRICE").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32

        Me.VALUES_CHART.Series("AVG_PRICE2").Color = Drawing.Color.Red
        Me.VALUES_CHART.Series("AVG_PRICE2").BorderWidth = 1
        Me.VALUES_CHART.Series("AVG_PRICE2").MarkerSize = 5
        Me.VALUES_CHART.Series("AVG_PRICE2").MarkerStyle = UI.DataVisualization.Charting.MarkerStyle.Circle
        Me.VALUES_CHART.BorderlineWidth = 10
        Me.VALUES_CHART.Series("AVG_PRICE2").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32

        If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
            Me.VALUES_CHART.Width = 250
            Me.VALUES_CHART.Height = 215
        Else
            Me.VALUES_CHART.Width = 450
            Me.VALUES_CHART.Height = 325
        End If

        Me.VALUES_CHART2.Series.Add("AVG_PRICE").ChartType = UI.DataVisualization.Charting.SeriesChartType.Column
        Me.VALUES_CHART2.ChartAreas("ChartArea1").AxisY.Title = ""

        Me.VALUES_CHART2.Series("AVG_PRICE").Color = Drawing.Color.Green
        Me.VALUES_CHART2.Series("AVG_PRICE").BorderWidth = 1
        Me.VALUES_CHART2.Series("AVG_PRICE").MarkerSize = 0
        ' Me.VALUES_CHART2.Series("AVG_PRICE").MarkerStyle = UI.DataVisualization.Charting.MarkerStyle.Circle
        Me.VALUES_CHART2.BorderlineWidth = 10
        Me.VALUES_CHART2.Series("AVG_PRICE").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32

        If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
            Me.VALUES_CHART2.Width = 250
            Me.VALUES_CHART2.Height = 215
        Else
            Me.VALUES_CHART2.Width = 450
            Me.VALUES_CHART2.Height = 325
        End If

        Me.VALUES_CHART3.Series.Add("AVG_PRICE").ChartType = UI.DataVisualization.Charting.SeriesChartType.Column
        Me.VALUES_CHART3.ChartAreas("ChartArea1").AxisY.Title = ""

        Me.VALUES_CHART3.Series("AVG_PRICE").Color = Drawing.Color.Green
        Me.VALUES_CHART3.Series("AVG_PRICE").BorderWidth = 1
        Me.VALUES_CHART3.Series("AVG_PRICE").MarkerSize = 0
        ' Me.VALUES_CHART3.Series("AVG_PRICE").MarkerStyle = UI.DataVisualization.Charting.MarkerStyle.Circle
        Me.VALUES_CHART3.BorderlineWidth = 10
        Me.VALUES_CHART3.Series("AVG_PRICE").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32


        If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
            Me.VALUES_CHART3.Width = 250
            Me.VALUES_CHART3.Height = 215
        Else
            Me.VALUES_CHART3.Width = 450
            Me.VALUES_CHART3.Height = 325
        End If


        For Each r As DataRow In dt.Rows
            AvgAsking = 0
            AvgAskingHidden = 0
            YearMFR = 0
            YearDLV = 0
            yearSold = ""
            quarterSold = ""

            selling = 0
            _percent = 0
            percentHidden = 0
            variance = 0
            varianceHidden = 0
            avgAftt = 0
            avgDOM = 0
            yearSold = ""
            quarterSold = ""


            'Year
            If Not String.IsNullOrEmpty(r("YearSld")) Then
                yearSold = r("YearSld")
            Else
                yearSold = Year(Now())
            End If

            'Quarter Sold
            If Not String.IsNullOrEmpty(r("QuarterSld")) Then
                quarterSold = r("QuarterSld")
            End If

            'Year MFR
            If Not IsDBNull(r("dAvgYearMfr")) Then
                YearMFR = r("dAvgYearMfr")
            Else
                YearMFR = 0
            End If
            'Year DLV
            If Not IsDBNull(r("dAvgYearDlv")) Then
                YearDLV = r("dAvgYearDlv")
            Else
                YearDLV = 0
            End If

            'Asking Price.
            If Not IsDBNull(r("dAvgAsking")) Then
                AvgAsking = r("dAvgAsking")
            Else
                AvgAsking = 0
            End If
            If Not IsDBNull(r("dAvgAskingHidden")) Then
                AvgAskingHidden = r("dAvgAskingHidden")
            Else
                AvgAskingHidden = 0
            End If


            If Not IsDBNull(r("dAvgSelling")) Then
                selling = r("dAvgSelling")
            Else
                selling = 0
            End If

            If Not IsDBNull(r("dPercent")) Then
                _percent = r("dPercent")
            Else
                _percent = 0
            End If

            If Not IsDBNull(r("dPercentHidden")) Then
                percentHidden = r("dPercentHidden")
            Else
                percentHidden = 0
            End If

            If Not IsDBNull(r("dVariance")) Then
                variance = r("dVariance")
            Else
                variance = 0
            End If

            If Not IsDBNull(r("dVarianceHidden")) Then
                varianceHidden = r("dVarianceHidden")
            Else
                varianceHidden = 0
            End If

            If AvgAsking = 0 And AvgAskingHidden > 0 Then
                AvgAsking = AvgAskingHidden
                _percent = percentHidden
                variance = varianceHidden
            End If

            If Not IsDBNull(r("dAvgAFTT")) Then
                avgAftt = r("dAvgAFTT")
            Else
                avgAftt = 0
            End If

            If Not IsDBNull(r("dAvgDOM")) Then
                avgDOM = r("dAvgDOM")
            Else
                avgDOM = 0
            End If

            If Trim(AvgAsking) <> "null" Then
                AvgAsking = (AvgAsking / 1000)
            End If

            If Trim(selling) <> "null" Then
                selling = (selling / 1000)
            End If


            If AvgAsking > 0 Then
                Me.VALUES_CHART.Series("AVG_PRICE").Points.AddXY((yearSold & " - " & quarterSold), Replace(AvgAsking, ",", ""))
            End If

            If selling > 0 Then
                Me.VALUES_CHART.Series("AVG_PRICE2").Points.AddXY((yearSold & " - " & quarterSold), Replace(selling, ",", ""))
            End If

            If CDbl(AvgAsking) > high_number And AvgAsking > 0 Then
                high_number = AvgAsking
            End If
            If CDbl(AvgAsking) < low_number And AvgAsking > 0 Then
                low_number = AvgAsking
            End If

            If CDbl(selling) > high_number And selling > 0 Then
                high_number = selling
            End If
            If CDbl(selling) < low_number And selling > 0 Then
                low_number = selling
            End If



            Me.VALUES_CHART2.Series("AVG_PRICE").Points.AddXY((yearSold & " - " & quarterSold), Replace(AvgAsking, ",", ""))

            If CDbl(AvgAsking) > high_number2 Then
                high_number2 = AvgAsking
            End If
            If CDbl(AvgAsking) < low_number2 Then
                low_number2 = AvgAsking
            End If



            Me.VALUES_CHART3.Series("AVG_PRICE").Points.AddXY((yearSold & " - " & quarterSold), Replace(selling, ",", ""))

            If CDbl(selling) > high_number3 Then
                high_number3 = selling
            End If
            If CDbl(selling) < low_number3 Then
                low_number3 = selling
            End If


            If HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag Then
                If Graph8 <> "" Then
                    Graph8 += ", "
                End If
                Graph8 += "['" + quarterSold + "/" + yearSold + "'," & IIf(AvgAsking > 0, Replace(FormatNumber(AvgAsking, 0, True).ToString, ",", ""), "null") + "," + IIf(selling > 0, Replace(FormatNumber(selling, 0, True).ToString, ",", ""), "null") & "]"
            Else
                If Graph8 <> "" Then
                    Graph8 += ", "
                End If
                Graph8 += "['" + quarterSold + "/" + yearSold + "'," & IIf(AvgAsking > 0, Replace(FormatNumber(AvgAsking, 0, True).ToString, ",", ""), "null") + "]"
            End If



            If Graph9 <> "" Then
                Graph9 += ", "
            End If
            Graph9 += "['" + quarterSold + "/" + yearSold + "'," & IIf(AvgAsking > 0, Replace(FormatNumber(AvgAsking, 0, True).ToString, ",", ""), "null") & "]"

            If Graph10 <> "" Then
                Graph10 += ", "
            End If
            Graph10 += "['" + quarterSold + "/" + yearSold + "'," & IIf(selling > 0, Replace(FormatNumber(selling, 0, True).ToString, ",", ""), "null") & "]"



        Next

        commonEvo.set_ranges_for_vsCharts(low_number, high_number, interval_point, starting_point, ending_point)


        VALUES_CHART.ChartAreas("ChartArea1").AxisY.Maximum = ending_point
        VALUES_CHART.ChartAreas("ChartArea1").AxisY.Minimum = IIf(starting_point > 0, starting_point, 0)
        VALUES_CHART.ChartAreas("ChartArea1").AxisY.Interval = interval_point


        commonEvo.set_ranges_for_vsCharts(low_number2, high_number2, interval_point2, starting_point2, ending_point2)

        VALUES_CHART2.ChartAreas("ChartArea1").AxisY.Maximum = ending_point2
        VALUES_CHART2.ChartAreas("ChartArea1").AxisY.Minimum = IIf(starting_point2 > 0, starting_point2, 0)
        VALUES_CHART2.ChartAreas("ChartArea1").AxisY.Interval = interval_point2



        commonEvo.set_ranges_for_vsCharts(low_number3, high_number3, interval_point3, starting_point3, ending_point3)

        VALUES_CHART3.ChartAreas("ChartArea1").AxisY.Maximum = ending_point3
        VALUES_CHART3.ChartAreas("ChartArea1").AxisY.Minimum = IIf(starting_point3 > 0, starting_point3, 0)
        VALUES_CHART3.ChartAreas("ChartArea1").AxisY.Interval = interval_point3


        If HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag Then
            Graph8 = " data8.addColumn('string', 'Year/Month'); data8.addColumn('number', 'Asking'); data8.addColumn('number', 'Sale'); data8.addRows([ " & Graph8
        Else
            Graph8 = " data8.addColumn('string', 'Year/Month'); data8.addColumn('number', 'Asking'); data8.addRows([ " & Graph8
        End If



        Graph9 = " data9.addColumn('string', 'Year/Month'); data9.addColumn('number', 'Asking'); data9.addRows([ " & Graph9

        Graph10 = " data10.addColumn('string', 'Year/Month'); data10.addColumn('number', 'Selling'); data10.addRows([ " & Graph10

    End Sub
    Public Function Display_Values_By_MFR_Year_Graph() As String

        Dim table_string As String = ""
        Dim temp_header As String = ""

        Display_Values_By_MFR_Year_Graph = ""
        Display_Values_By_MFR_Year_Graph &= "<tr><td valign='top' align='center'><font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & real_make_model_name & " </strong>VALUES BY DLV YEAR</span></font></td></tr>"

        Display_Values_By_MFR_Year_Graph &= "<tr><td valign=""top""><table cellspacing='0' cellpadding='0' border='0' width='100%'><tr><td align='center' width='100%'>"

        Display_Values_By_MFR_Year_Graph &= "<div class=""Box"">"
        Display_Values_By_MFR_Year_Graph &= "<div style=""width:900px;"" class=""marginAuto""><img src='" & valuuationGraph2.Text & "' align='center'  class=""marginAuto""/></div>"
        Display_Values_By_MFR_Year_Graph &= "</div></td><td>&nbsp;</td><td align='center'>"

        Display_Values_By_MFR_Year_Graph &= "</td></tr>"
        Display_Values_By_MFR_Year_Graph &= "</table>"
        Display_Values_By_MFR_Year_Graph &= "</td></tr>"

    End Function

    Public Function Display_Values_By_Month_Graph() As String

        Dim table_string As String = ""
        Dim temp_header As String = ""

        Display_Values_By_Month_Graph = ""
        Display_Values_By_Month_Graph &= "<tr><td valign='top' align='center'><font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & real_make_model_name & " </strong>VALUES BY MONTH</span></font></td></tr>"

        Display_Values_By_Month_Graph &= "<tr><td valign=""top""><table cellspacing='0' cellpadding='0' border='0' width='100%'><tr><td align='center' width='100%'>"

        Display_Values_By_Month_Graph &= "<div class=""Box"">"
        Display_Values_By_Month_Graph &= "<div style=""width:900px;"" class=""marginAuto""><img src='" & valuuationGraph3.Text & "' align='center'  class=""marginAuto""/></div>"
        Display_Values_By_Month_Graph &= "</div></td><td>&nbsp;</td><td align='center'>"

        Display_Values_By_Month_Graph &= "</td></tr>"
        Display_Values_By_Month_Graph &= "</table>"
        Display_Values_By_Month_Graph &= "</td></tr>"
    End Function

    Public Function Display_Residual_Values_By_Year_MFR_Graph() As String

        Dim table_string As String = ""
        Dim temp_header As String = ""

        Display_Residual_Values_By_Year_MFR_Graph = ""
        Display_Residual_Values_By_Year_MFR_Graph &= "<tr><td valign='top' align='center'><font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & real_make_model_name & " </strong>RESIDUAL ESTIMATES BY YEAR DLV</span></font></td></tr>"

        Display_Residual_Values_By_Year_MFR_Graph &= "<tr><td valign=""top""><table cellspacing='0' cellpadding='0' border='0' width='100%'><tr><td align='center' width='100%'>"

        Display_Residual_Values_By_Year_MFR_Graph &= "<div class=""Box"">"
        Display_Residual_Values_By_Year_MFR_Graph &= "<div style=""width:900px;"" class=""marginAuto""><img src='" & valuuationGraph4.Text & "' align='center'  class=""marginAuto""/></div>"
        Display_Residual_Values_By_Year_MFR_Graph &= "</div></td><td>&nbsp;</td><td align='center'>"

        Display_Residual_Values_By_Year_MFR_Graph &= "</td></tr>"
        Display_Residual_Values_By_Year_MFR_Graph &= "</table>"
        Display_Residual_Values_By_Year_MFR_Graph &= "</td></tr>"
    End Function
    Public Function Display_Model_By_AFTT() As String

        Dim table_string As String = ""
        Dim temp_header As String = ""

        Display_Model_By_AFTT = ""
        Display_Model_By_AFTT &= "<tr><td valign='top' align='center'><font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & real_make_model_name & " </strong>VALUES BY AFTT</span></font></td></tr>"

        Display_Model_By_AFTT &= "<tr><td valign=""top""><table cellspacing='0' cellpadding='0' border='0' width='100%'><tr><td align='center' width='100%'>"

        Display_Model_By_AFTT &= "<div class=""Box"">"
        Display_Model_By_AFTT &= "<div style=""width:900px;"" class=""marginAuto""><img src='" & valuuationGraph5.Text & "' align='center'  class=""marginAuto""/></div>"
        Display_Model_By_AFTT &= "</div></td><td>&nbsp;</td><td align='center'>"

        Display_Model_By_AFTT &= "</td></tr>"
        Display_Model_By_AFTT &= "</table>"
        Display_Model_By_AFTT &= "</td></tr>"
    End Function


    Public Function Display_Current_Market_Trend() As String

        Dim table_string As String = ""
        Dim temp_header As String = ""

        Display_Current_Market_Trend = ""
        Display_Current_Market_Trend &= "<tr><td valign='top' align='center'><font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & real_make_model_name & " </strong>CURRENT MARKET VALUATION</span></font></td></tr>"

        Display_Current_Market_Trend &= "<tr><td valign=""top""><table cellspacing='0' cellpadding='0' border='0' width='100%'><tr><td align='center' width='100%'>"

        Display_Current_Market_Trend &= "<div class=""Box"">"
        Display_Current_Market_Trend &= "<div style=""width:900px;"" class=""marginAuto""><img src='" & valuuationGraph1.Text & "' align='center' class=""marginAuto""/></div>"  '  width=""900"" or 700
        Display_Current_Market_Trend &= "</div></td><td>&nbsp;</td><td align='center'>"

        Display_Current_Market_Trend &= "</td></tr>"
        Display_Current_Market_Trend &= "</table>"
        Display_Current_Market_Trend &= "</td></tr>"


        '----------------------------------------------------------
        temp_header &= ("</table>")

        If made_first_page = False Then
        Else
            temp_header &= (comp_functions.NEW_Insert_Page_Break_PDF(0, WD.SelectedValue))
        End If
        temp_header &= (temp_pdf_header)
        If bWordReport = True Then
            temp_header &= ("<table width='" & word_width & "' align='center' cellpadding='3'>")
        Else
            temp_header &= ("<table width='" & pdf_html_width & "' align='center' cellpadding='3'>")
        End If
        Display_Current_Market_Trend &= temp_header
        '----------------------------------------------------------


        Display_Current_Market_Trend &= "<tr><td valign='top' align='center'><font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & real_make_model_name & " </strong>CURRENT MARKET VALUATION</span></font></td></tr>"
        Display_Current_Market_Trend &= "<tr><td>"
        Call util_view_functions.views_display_market_for_Sale_assett_prices_graph(localCriteria, table_string, temp_header)
        Display_Current_Market_Trend &= table_string
        Display_Current_Market_Trend &= "</td></tr>"



    End Function
    Public Function DisplayWeightTable(ByRef Graph13 As String, ByRef Graph14 As String) As String
        DisplayWeightTable = ""
        Dim ValueWeightTable As New DataTable
        Dim count_mat As Long = 0
        ValueWeightTable = GetValuesTrendsByWeight(NEW_PDF_AMOD_ID, "", year_start.Text, year_end.Text, aftt_start.Text, aftt_end.Text, aircraft_registration.SelectedValue, localCriteria.ViewCriteriaDocumentsStartDate, localCriteria.ViewCriteriaDocumentsEndDate, modelAirframeTypeCode.Text, ModelTypeCode.Text, ModelWeightClass.Text)

        DisplayWeightTable = DisplayValueWeightTable(ValueWeightTable, Graph13, Graph14, count_mat)


        Me.VALUES_CHART.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "VALUES_CHART_1_WEIGHT.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
        Me.VALUES_CHART2.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "VALUES_CHART_2_WEIGHT.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)


        DisplayWeightTable &= "<tr><td valign=""top""><table cellspacing='0' cellpadding='0' border='0' width='100%'><tr><td align='center' width='100%'>"
        '  DisplayWeightTable &= "</td><td>&nbsp;</td><td align='center'>"
        '   DisplayWeightTable &= "<font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER_NOALIGN") & "'>Weight Class - Variance of Asking Price (%)</font>"
        DisplayWeightTable &= "<div class=""Box"">"
        '  DisplayWeightTable &= "<img src='" & HttpContext.Current.Session.Item("jetnetFullHostName").ToString & "/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "VALUES_CHART_1_WEIGHT.jpg'>"
        '  DisplayWeightTable &= "</td><td>&nbsp;</td><td align='center'>"
        '  DisplayWeightTable &= "<img src='" & HttpContext.Current.Session.Item("jetnetFullHostName").ToString & "/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "VALUES_CHART_2_WEIGHT.jpg'>"


        If HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag Then
            If count_mat > 25 Then
                DisplayWeightTable &= "<div style=""width:500px;"" class=""marginAuto""><font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER_NOALIGN") & "'>COMPARATIVE MODELS PERCENTAGE OF ASKING PRICE</font><img src='" & valueGraphText13.Text & "' width='90%' align='center' class=""marginAuto"" /></div>"
            ElseIf count_mat > 20 Then
                DisplayWeightTable &= "<div style=""width:690px;"" class=""marginAuto""><font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER_NOALIGN") & "'>COMPARATIVE MODELS PERCENTAGE OF ASKING PRICE</font><img src='" & valueGraphText13.Text & "' width='90%' align='center' class=""marginAuto"" /></div>"
            Else
                DisplayWeightTable &= "<div style=""width:900px;"" class=""marginAuto""><font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER_NOALIGN") & "'>COMPARATIVE MODELS PERCENTAGE OF ASKING PRICE</font><img src='" & valueGraphText13.Text & "' width='90%' align='center'  class=""marginAuto""/></div>"
            End If
        Else
            If count_mat > 25 Then
                DisplayWeightTable &= "<div style=""width:500px;"" class=""marginAuto""><font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER_NOALIGN") & "'>COMPARATIVE MODELS ASKING PRICE</font><img src='" & valueGraphText13.Text & "' width='90%' align='center' class=""marginAuto"" /></div>"
            ElseIf count_mat > 20 Then
                DisplayWeightTable &= "<div style=""width:690px;"" class=""marginAuto""><font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER_NOALIGN") & "'>COMPARATIVE MODELS ASKING PRICE</font><img src='" & valueGraphText13.Text & "' width='90%' align='center' class=""marginAuto"" /></div>"
            Else
                DisplayWeightTable &= "<div style=""width:900px;"" class=""marginAuto""><font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER_NOALIGN") & "'>COMPARATIVE MODELS ASKING PRICE</font><img src='" & valueGraphText13.Text & "' width='90%' align='center'  class=""marginAuto""/></div>"
            End If
        End If



        '  DisplayWeightTable &= "</td><td>&nbsp;</td><td align='center'>"
        '  DisplayWeightTable &= "<img src='" & valueGraphText14.Text & "' width='475' />"
        DisplayWeightTable &= "</div></td><td>&nbsp;</td><td align='center'>"

        DisplayWeightTable &= "</td></tr></table>"
        DisplayWeightTable &= "</td></tr>"

        '  BuildWeightGraphs(Graph1, Graph2)
        '  BuildWeightTable()
        '  If Not Page.ClientScript.IsClientScriptBlockRegistered("refreshWeightTable") Then
        '    System.Web.UI.ScriptManager.RegisterClientScriptBlock(Me.tabs_bottom_6_update_panel, Me.GetType, "refreshWeightTable", TableBuild.ToString, True)
        ' End If
        '  RecreateDropdownsValueYearGraphs(tabs_bottom_6_update_panel, False, True, True)
    End Function
    Public Function DisplayValueWeightTable(ByVal dt As DataTable, ByRef Graph13 As String, ByRef Graph14 As String, ByRef count_weight As Long) As String
        Dim results As String = ""
        Dim AvgAsking As Long = 0
        Dim AvgAskingHidden As Long = 0

        Dim YearMFR As Long = 0
        Dim YearDLV As Long = 0
        Dim yearSold As String = ""
        Dim quarterSold As String = ""

        Dim selling As Long = 0
        Dim _percent As Long = 0
        Dim percentHidden As Long = 0

        Dim variance As Long = 0
        Dim varianceHidden As Long = 0
        Dim avgAftt As Long = 0
        Dim avgDOM As Long = 0
        Dim Make As String = ""
        Dim Model As String = ""
        Dim range As Double = 0
        Dim pax As Integer = 0
        Dim cvolume As Double = 0

        Dim high_number As Integer = 0
        Dim low_number As Integer = 20000000
        Dim starting_point As Integer = 0
        Dim interval_point As Integer = 1
        Dim ending_point As Integer = 0

        Dim high_number2 As Integer = 0
        Dim low_number2 As Integer = 20000000
        Dim starting_point2 As Integer = 0
        Dim interval_point2 As Integer = 1
        Dim ending_point2 As Integer = 0
        Dim rows_count As Integer = 0


        Me.VALUES_CHART.Series.Clear()
        Me.VALUES_CHART2.Series.Clear()
        Me.VALUES_CHART.Series.Add("AVG_PRICE").ChartType = UI.DataVisualization.Charting.SeriesChartType.Column
        Me.VALUES_CHART.Series.Add("AVG_PRICE2").ChartType = UI.DataVisualization.Charting.SeriesChartType.Column

        Me.VALUES_CHART.ChartAreas("ChartArea1").AxisY.Title = ""

        Me.VALUES_CHART.Series("AVG_PRICE").Color = Drawing.Color.Blue
        Me.VALUES_CHART.Series("AVG_PRICE").BorderWidth = 1
        Me.VALUES_CHART.Series("AVG_PRICE").MarkerSize = 5
        Me.VALUES_CHART.Series("AVG_PRICE").MarkerStyle = UI.DataVisualization.Charting.MarkerStyle.Circle
        Me.VALUES_CHART.BorderlineWidth = 10
        Me.VALUES_CHART.Series("AVG_PRICE").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32

        Me.VALUES_CHART.Series("AVG_PRICE2").Color = Drawing.Color.Red
        Me.VALUES_CHART.Series("AVG_PRICE2").BorderWidth = 1
        Me.VALUES_CHART.Series("AVG_PRICE2").MarkerSize = 5
        Me.VALUES_CHART.Series("AVG_PRICE2").MarkerStyle = UI.DataVisualization.Charting.MarkerStyle.Circle
        Me.VALUES_CHART.BorderlineWidth = 10
        Me.VALUES_CHART.Series("AVG_PRICE2").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32

        If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
            Me.VALUES_CHART.Width = 250
            Me.VALUES_CHART.Height = 215
        Else
            Me.VALUES_CHART.Width = 450
            Me.VALUES_CHART.Height = 325
        End If

        Me.VALUES_CHART2.Series.Add("AVG_PRICE").ChartType = UI.DataVisualization.Charting.SeriesChartType.Column
        Me.VALUES_CHART2.ChartAreas("ChartArea1").AxisY.Title = ""

        Me.VALUES_CHART2.Series("AVG_PRICE").Color = Drawing.Color.Green
        Me.VALUES_CHART2.Series("AVG_PRICE").BorderWidth = 1
        Me.VALUES_CHART2.Series("AVG_PRICE").MarkerSize = 0
        ' Me.VALUES_CHART2.Series("AVG_PRICE").MarkerStyle = UI.DataVisualization.Charting.MarkerStyle.Circle
        Me.VALUES_CHART2.BorderlineWidth = 10
        Me.VALUES_CHART2.Series("AVG_PRICE").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32

        If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
            Me.VALUES_CHART2.Width = 250
            Me.VALUES_CHART2.Height = 215
        Else

            Me.VALUES_CHART2.Width = 450
            Me.VALUES_CHART2.Height = 325
        End If

        If HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag Then
            results = "<tr><td valign='top' align='center'><font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & real_make_model_name & " </strong>Comparative Model Sales<span>LAST " & month_timeframe.SelectedValue & " MONTHS</span>" & valueEmptyHeaderString & "</font></td></tr>"
        Else
            results = "<tr><td valign='top' align='center'><font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & real_make_model_name & " </strong>Comparative Model Asking<span>LAST " & month_timeframe.SelectedValue & " MONTHS</span>" & valueEmptyHeaderString & "</font></td></tr>"
        End If


        results += "<tr><td valign='top'><div class=""Box""><table id=""weightTable"" cellpadding='3'  cellspacing='0' width='100%' class='formatTable " & table_color & "'><thead>"
        results += "<tr class=""noBorder"">"
        If HttpContext.Current.Session.Item("isMobile") Then
            results += "<th></th>"
        End If
        results += "<th class=""bottom"" width=""145"">MAKE/MODEL</th>"
        results += "<th class='right'>AVG MFR</th>"
        results += "<th class='right'>AVG DLV</th>"
        results += "<th class='right'>AVG ASKING($K)</th>"

        If HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag Then
            results += "<th class='right'>AVG SALE($K)</th>"
            results += "<th class='right'>SALE % OF ASKING</th>"
        End If

        results += "<th class='right'>AVG AFTT</th>"
        results += "<th class='right'>AVG DOM</th>"
        results += "<th class='right'>MAX RANGE</th>"
        results += "<th class='right bottom' width=""45"">PAX</th>"
        results += "<th class='right'>CABIN VOLUME</th>"

        results += "</tr>"

        results += "</thead>"
        results += "<tbody>"
        For Each r As DataRow In dt.Rows
            AvgAsking = 0
            AvgAskingHidden = 0
            YearMFR = 0
            YearDLV = 0
            yearSold = ""
            quarterSold = ""


            selling = 0
            _percent = 0
            percentHidden = 0
            variance = 0
            varianceHidden = 0
            avgAftt = 0
            avgDOM = 0
            Make = ""
            Model = ""


            If Not IsDBNull(r("MakeAbbrev")) Then
                Make = r("MakeAbbrev")
            End If
            If Not IsDBNull(r("Model")) Then
                Model = r("Model")
            End If
            'Year MFR
            If Not IsDBNull(r("dAvgYearMfr")) Then
                YearMFR = r("dAvgYearMfr")
            Else
                YearMFR = 0
            End If
            'Year DLV
            If Not IsDBNull(r("dAvgYearDlv")) Then
                YearDLV = r("dAvgYearDlv")
            Else
                YearDLV = 0
            End If

            'Asking Price.
            If Not IsDBNull(r("dAvgAsking")) Then
                AvgAsking = r("dAvgAsking")
            Else
                AvgAsking = 0
            End If
            If Not IsDBNull(r("dAvgAskingHidden")) Then
                AvgAskingHidden = r("dAvgAskingHidden")
            Else
                AvgAskingHidden = 0
            End If


            If Not IsDBNull(r("dAvgSelling")) Then
                selling = r("dAvgSelling")
            Else
                selling = 0
            End If

            If Not IsDBNull(r("dPercent")) Then
                _percent = r("dPercent")
            Else
                _percent = 0
            End If

            If Not IsDBNull(r("cvolume")) Then
                cvolume = r("cvolume")
            Else
                cvolume = 0
            End If

            If Not IsDBNull(r("mrange")) Then
                range = r("mrange")
            Else
                range = 0
            End If
            If Not IsDBNull(r("pax")) Then
                pax = r("pax")
            Else
                pax = 0
            End If
            If Not IsDBNull(r("dPercentHidden")) Then
                percentHidden = r("dPercentHidden")
            Else
                percentHidden = 0
            End If

            If Not IsDBNull(r("dVariance")) Then
                variance = r("dVariance")
            Else
                variance = 0
            End If

            If Not IsDBNull(r("dVarianceHidden")) Then
                varianceHidden = r("dVarianceHidden")
            Else
                varianceHidden = 0
            End If

            If AvgAsking = 0 And AvgAskingHidden > 0 Then
                AvgAsking = AvgAskingHidden
                _percent = percentHidden
                variance = varianceHidden
            End If

            If Not IsDBNull(r("dAvgAFTT")) Then
                avgAftt = r("dAvgAFTT")
            Else
                avgAftt = 0
            End If

            If Not IsDBNull(r("dAvgDOM")) Then
                avgDOM = r("dAvgDOM")
            Else
                avgDOM = 0
            End If

            If r("AModId") <> NEW_PDF_AMOD_ID Then
                results += "<tr>"
            Else
                results += "<tr class=""highlight"">"
            End If
            If HttpContext.Current.Session.Item("isMobile") Then
                results += "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'></font></td>"
            End If
            results += "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
            results += "(" & Make.ToString & ") "
            results += Model.ToString
            results += "</font></td>"
            results += "<td align=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
            If YearMFR > 0 Then
                results += YearMFR.ToString
            End If
            results += "</font></td>"
            results += "<td align=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
            If YearDLV > 0 Then
                results += YearDLV.ToString
            End If
            results += "</font></td>"
            results += "<td align=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
            If AvgAsking > 0 Then
                results += "$" & FormatNumber(AvgAsking / 1000, 0, True).ToString
            End If
            results += "</font></td>"
            If HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag Then

                results += "<td align=""right"" class=""red_text""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                If selling > 0 Then
                    results += "$" & FormatNumber(selling / 1000, 0, True).ToString
                End If
                results += "</font></td>"
                results += "<td align=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                If _percent > 0 Then
                    results += FormatNumber(_percent, 1, True).ToString() & "%"
                End If
                results += "</font></td>"
            End If
            'results += "<td align=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
            'If AvgAsking > 0 Then
            '  results += FormatNumber(variance, 1, True).ToString() & "%</td>"
            'ElseIf AvgAsking = selling Then
            '  results += "0.0%</td>"
            'End If
            'results += "</font></td>"
            results += "<td align=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
            If avgAftt > 0 Then
                results += FormatNumber(avgAftt, 0, True).ToString()
            End If
            results += "</font></td>"
            results += "<td align=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
            If avgDOM > 0 Then
                results += FormatNumber(avgDOM, 0, True).ToString
            End If
            results += "</font></td>"
            results += "<td align=""right"">"
            If range > 0 Then
                results += range.ToString()
            End If
            results += "</td>"
            results += "<td align=""right"">"
            If pax > 0 Then
                results += pax.ToString()
            End If
            results += "</td>"
            results += "<td align=""right"">"
            If cvolume > 0 Then
                results += cvolume.ToString()
            End If
            results += "</td>"

            If HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag Then
                If _percent > 0 Then
                    If Graph13 <> "" Then
                        Graph13 += ", "
                    End If
                    Graph13 += "['(" & Make & ") " & Model & "'," & FormatNumber(_percent, 1, True).ToString() & " ]"
                End If
            Else
                If Graph13 <> "" Then
                    Graph13 += ", "
                End If
                Graph13 += "['(" & Make & ") " & Model & "'," & Replace(FormatNumber(AvgAsking / 1000, 0, True), ",", "") & " ]"
            End If



            If Graph14 <> "" Then
                Graph14 += ", "
            End If
            If AvgAsking > 0 Then
                Graph14 += "['(" & Make & ") " & Model & "'," & FormatNumber(variance, 1, True).ToString() & " ]"
            ElseIf AvgAsking = selling Then
                Graph14 += "['(" & Make & ") " & Model & "',0 ]"
            End If


            If Trim(AvgAsking) <> "null" Then
                Me.VALUES_CHART.Series("AVG_PRICE").Points.AddXY("(" & Make & ") " & Model & "", AvgAsking)

                If CDbl(AvgAsking) > high_number Then
                    high_number = AvgAsking
                End If
                If CDbl(AvgAsking) < low_number Then
                    low_number = AvgAsking
                End If
            End If

            'If Trim(selling) <> "null" Then
            '  Me.VALUES_CHART.Series("AVG_PRICE2").Points.AddXY("(" & Make & ") " & Model & "", selling)

            '  If CDbl(selling) > high_number Then
            '    high_number = selling
            '  End If
            '  If CDbl(selling) < low_number Then
            '    low_number = selling
            '  End If
            'End If

            If Trim(FormatNumber(variance, 1, True).ToString()) <> "null" Then
                Me.VALUES_CHART2.Series("AVG_PRICE").Points.AddXY("(" & Make & ") " & Model & "", FormatNumber(variance, 1, True).ToString())

                If CDbl(FormatNumber(variance, 1, True).ToString()) > high_number2 Then
                    high_number2 = FormatNumber(variance, 1, True).ToString()
                End If
                If CDbl(FormatNumber(variance, 1, True).ToString()) < low_number2 Then
                    low_number2 = FormatNumber(variance, 1, True).ToString()
                End If
            End If

            count_weight = count_weight + 1

            results += "</tr>"
        Next



        If count_weight > 20 Then
            results = Replace(results, "" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'", "" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "' size='-1'")
            results = Replace(results, "</span><span>Entire Fleet", ", Entire Fleet")
        End If



        commonEvo.set_ranges_for_vsCharts(low_number, high_number, interval_point, starting_point, ending_point)


        VALUES_CHART.ChartAreas("ChartArea1").AxisY.Maximum = ending_point
        VALUES_CHART.ChartAreas("ChartArea1").AxisY.Minimum = IIf(starting_point > 0, starting_point, 0)
        VALUES_CHART.ChartAreas("ChartArea1").AxisY.Interval = interval_point

        commonEvo.set_ranges_for_vsCharts(low_number2, high_number2, interval_point2, starting_point2, ending_point2)

        VALUES_CHART2.ChartAreas("ChartArea1").AxisY.Maximum = ending_point2
        VALUES_CHART2.ChartAreas("ChartArea1").AxisY.Minimum = IIf(starting_point2 > 0, starting_point2, 0)
        VALUES_CHART2.ChartAreas("ChartArea1").AxisY.Interval = interval_point2


        results += "</tbody></table></div></td></tr>"

        If HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag Then
            Graph13 = " data13.addColumn('string', 'Make/Model'); data13.addColumn('number', 'Percent'); data13.addRows([ " & Graph13
        Else
            Graph13 = " data13.addColumn('string', 'Make/Model'); data13.addColumn('number', 'AskingPrice'); data13.addRows([ " & Graph13
        End If

        Graph14 = " data14.addColumn('string', 'Make/Model'); data14.addColumn('number', 'Variance'); data14.addRows([ " & Graph14

        Return results
    End Function

    Public Function GetTopFeatures(ByVal amod_id As Long) As DataTable
        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlReader As SqlClient.SqlDataReader
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing
        Dim TempTable As New DataTable
        Dim query As String
        Try

            If amod_id <> 0 Then

                'Opening Connection
                SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString
                SqlConn.Open()
                query = "SELECT DISTINCT amfeat_feature_code, kfeat_name, amfeat_seq_no,"
                query += " SUM(case when afeat_status_flag='Y' then 1 else 0 end) as ACFEATYES, SUM(case when afeat_status_flag='N' then 1 else 0 end) as ACFEATNO, "
                query += " SUM(case when afeat_status_flag='U' then 1 else 0 end) as ACFEATUNK "
                query += " FROM Aircraft_Model_Key_Feature WITH(NOLOCK) "
                query += " INNER JOIN Key_Feature WITH(NOLOCK) ON amfeat_feature_code = kfeat_code "
                query += " INNER JOIN Aircraft WITH(NOLOCK) ON ac_amod_id = amfeat_amod_id AND ac_journ_id = 0 "
                query += " LEFT OUTER JOIN Aircraft_Key_Feature WITH(NOLOCK) ON afeat_feature_code = kfeat_code AND afeat_ac_id = ac_id AND afeat_journ_id = ac_journ_id "
                query += " WHERE(kfeat_inactive_date Is NULL And amfeat_amod_id = @amodID)"


                If localCriteria.ViewCriteriaAFTTStart > 0 Then
                    query += (Constants.cAndClause + " ((ac_airframe_tot_hrs >= " & localCriteria.ViewCriteriaAFTTStart & ") or (ac_airframe_tot_hrs IS NULL))")
                End If

                If localCriteria.ViewCriteriaAFTTEnd > 0 Then
                    query += (Constants.cAndClause + " ((ac_airframe_tot_hrs <= " & localCriteria.ViewCriteriaAFTTEnd & ") or (ac_airframe_tot_hrs IS NULL))")
                End If

                If localCriteria.ViewCriteriaYearStart > 0 Then
                    query += (Constants.cAndClause + " ac_mfr_year >= " & localCriteria.ViewCriteriaYearStart)
                End If

                If localCriteria.ViewCriteriaYearEnd > 0 Then
                    query += (Constants.cAndClause + " ac_mfr_year <=  " & localCriteria.ViewCriteriaYearEnd)
                End If


                query += " and amfeat_standard_equip<>'Y'"
                query += " and kfeat_name not like '%inspection%'"
                query += " and kfeat_name not like '%damage%'"
                query += " and ac_forsale_flag='Y'"
                query += " GROUP BY amfeat_feature_code,  kfeat_name, amfeat_seq_no"
                query += " ORDER BY ACFEATYES desc"



                clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, query.ToString)

                Dim SqlCommand As New SqlClient.SqlCommand(query, SqlConn)
                SqlCommand.Parameters.AddWithValue("amodID", amod_id)
                SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

                Try
                    TempTable.Load(SqlReader)
                Catch constrExc As System.Data.ConstraintException
                    Dim rowsErr As System.Data.DataRow() = TempTable.GetErrors()
                End Try

                SqlCommand.Dispose()
                SqlCommand = Nothing
            End If


        Catch ex As Exception
            GetTopFeatures = Nothing
            'Me.class_error = "Error in GetAircraftStartingTable(ByVal amod_id As Long) As DataTable SQL VERSION: " & ex.Message
        Finally
            SqlReader = Nothing

            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing


        End Try
        Return TempTable
    End Function

    Public Function GetTopProgramName(ByVal amod_id As Long) As DataTable
        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlReader As SqlClient.SqlDataReader
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing
        Dim TempTable As New DataTable
        Dim query As String
        Try

            If amod_id <> 0 Then

                'Opening Connection
                SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString
                SqlConn.Open()
                query = "SELECT DISTINCT top 3 emp_program_name AS ENGPROGNAME, COUNT(*) AS tcount "
                query += " FROM Aircraft WITH(NOLOCK) INNER JOIN Aircraft_Model WITH(NOLOCK) ON amod_id = ac_amod_id "
                query += " INNER JOIN Engine_Maintenance_Program WITH(NOLOCK) ON ac_engine_maintenance_prog_EMP = emp_id "
                query += " WHERE(ac_journ_id = 0)"
                query += " AND amod_id = @amodID"
                query += " and ac_lifecycle_stage = 3"
                query += " and ac_forsale_flag='Y'"


                If localCriteria.ViewCriteriaAFTTStart > 0 Then
                    query += (Constants.cAndClause + " ((ac_airframe_tot_hrs >= " & localCriteria.ViewCriteriaAFTTStart & ") or (ac_airframe_tot_hrs IS NULL))")
                End If

                If localCriteria.ViewCriteriaAFTTEnd > 0 Then
                    query += (Constants.cAndClause + " ((ac_airframe_tot_hrs <= " & localCriteria.ViewCriteriaAFTTEnd & ") or (ac_airframe_tot_hrs IS NULL))")
                End If

                If localCriteria.ViewCriteriaYearStart > 0 Then
                    query += (Constants.cAndClause + " ac_mfr_year >= " & localCriteria.ViewCriteriaYearStart)
                End If

                If localCriteria.ViewCriteriaYearEnd > 0 Then
                    query += (Constants.cAndClause + " ac_mfr_year <=  " & localCriteria.ViewCriteriaYearEnd)
                End If



                query += " and emp_program_name <> 'Unknown'"
                query += " and emp_program_name not like '%confirmed not on%'"
                query += " and emp_program_name not like '%confirmed on%'"
                query += " GROUP BY emp_program_name "
                query += " ORDER BY COUNT(*) desc"




                clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, query.ToString)

                Dim SqlCommand As New SqlClient.SqlCommand(query, SqlConn)
                SqlCommand.Parameters.AddWithValue("amodID", amod_id)
                SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

                Try
                    TempTable.Load(SqlReader)
                Catch constrExc As System.Data.ConstraintException
                    Dim rowsErr As System.Data.DataRow() = TempTable.GetErrors()
                End Try

                SqlCommand.Dispose()
                SqlCommand = Nothing
            End If


        Catch ex As Exception
            GetTopProgramName = Nothing
            'Me.class_error = "Error in GetAircraftStartingTable(ByVal amod_id As Long) As DataTable SQL VERSION: " & ex.Message
        Finally
            SqlReader = Nothing

            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing


        End Try
        Return TempTable
    End Function
    Public Function GetTopCountries(ByVal amod_id As Long, ByVal yearOne As String, ByVal yearTwo As String, ByVal afttStart As String, ByVal afttEnd As String, ByVal regType As String, ByVal Startdate As String, ByVal EndDate As String) As DataTable
        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlReader As SqlClient.SqlDataReader
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing
        Dim TempTable As New DataTable
        Dim query As String
        Try

            If amod_id <> 0 Then

                'Opening Connection
                SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString
                SqlConn.Open()
                query = " SELECT distinct top 20 country_name, COUNT(distinct ac_id) AS tcount "
                query += " FROM Aircraft WITH(NOLOCK) "
                query += " inner join Country with (NOLOCK) on ac_aport_country = country_name"


                query += " WHERE (ac_journ_id = 0) and (ac_amod_id = @amodID) AND (ac_lifecycle_stage = 3) "
                ''-- YEAR RANGE
                'query += " and ac_mfr_year between @yearOne and @yearTwo"
                ''-- AFTT
                'query += " and ac_airframe_tot_hrs between @startAFTT and @endAFTT"
                'Add flags:

                If localCriteria.ViewCriteriaAFTTStart > 0 Then
                    query += (Constants.cAndClause + " ((ac_airframe_tot_hrs >= " & localCriteria.ViewCriteriaAFTTStart & ") or (ac_airframe_tot_hrs IS NULL))")
                End If

                If localCriteria.ViewCriteriaAFTTEnd > 0 Then
                    query += (Constants.cAndClause + " ((ac_airframe_tot_hrs <= " & localCriteria.ViewCriteriaAFTTEnd & ") or (ac_airframe_tot_hrs IS NULL))")
                End If

                If localCriteria.ViewCriteriaYearStart > 0 Then
                    query += (Constants.cAndClause + " ac_mfr_year >= " & localCriteria.ViewCriteriaYearStart)
                End If

                If localCriteria.ViewCriteriaYearEnd > 0 Then
                    query += (Constants.cAndClause + " ac_mfr_year <=  " & localCriteria.ViewCriteriaYearEnd)
                End If



                query += " and ("


                If HttpContext.Current.Session.Item("localSubscription").crmBusiness_Flag = True Then
                    query += " ac_product_business_flag = 'Y' "
                End If

                If HttpContext.Current.Session.Item("localSubscription").crmBusiness_Flag = True And HttpContext.Current.Session.Item("localSubscription").crmCommercial_Flag = True Then
                    query += " or "
                End If

                If HttpContext.Current.Session.Item("localSubscription").crmCommercial_Flag = True Then
                    query += " ac_product_commercial_flag = 'Y' "
                End If

                If (HttpContext.Current.Session.Item("localSubscription").crmHelicopter_Flag = True And HttpContext.Current.Session.Item("localSubscription").crmCommercial_Flag = True) Or (HttpContext.Current.Session.Item("localSubscription").crmHelicopter_Flag = True And HttpContext.Current.Session.Item("localSubscription").crmBusiness_Flag = True) Then
                    query += " or "
                End If

                If HttpContext.Current.Session.Item("localSubscription").crmHelicopter_Flag = True Then
                    query += " ac_product_helicopter_flag = 'Y'"
                End If

                query += ")"

                query += " AND not (ac_aport_country IS NULL) "

                query += "GROUP BY country_name "
                query += " having count(distinct ac_id) > 1"
                query += " ORDER BY COUNT(distinct ac_id) desc"


                clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, query.ToString)

                Dim SqlCommand As New SqlClient.SqlCommand(query, SqlConn)
                SqlCommand.Parameters.AddWithValue("amodID", amod_id)
                'SqlCommand.Parameters.AddWithValue("yearOne", yearOne)
                'SqlCommand.Parameters.AddWithValue("yearTwo", yearTwo)
                'SqlCommand.Parameters.AddWithValue("startAFTT", afttStart)
                'SqlCommand.Parameters.AddWithValue("endAFTT", afttEnd)
                SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

                Try
                    TempTable.Load(SqlReader)
                Catch constrExc As System.Data.ConstraintException
                    Dim rowsErr As System.Data.DataRow() = TempTable.GetErrors()
                End Try

                SqlCommand.Dispose()
                SqlCommand = Nothing
            End If




        Catch ex As Exception
            GetTopCountries = Nothing
            'Me.class_error = "Error in GetAircraftStartingTable(ByVal amod_id As Long) As DataTable SQL VERSION: " & ex.Message
        Finally
            SqlReader = Nothing

            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing


        End Try
        Return TempTable
    End Function
    Public Function GetContinents(ByVal amod_id As Long, ByVal yearOne As String, ByVal yearTwo As String, ByVal afttStart As String, ByVal afttEnd As String, ByVal regType As String, ByVal Startdate As String, ByVal EndDate As String, ByVal forSaleParam As Boolean) As DataTable
        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlReader As SqlClient.SqlDataReader
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing
        Dim TempTable As New DataTable
        Dim query As String
        Try

            If amod_id <> 0 Then

                'Opening Connection
                SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString
                SqlConn.Open()
                query = " SELECT country_continent_name, COUNT(distinct ac_id) AS tcount "
                query += " FROM Aircraft WITH(NOLOCK) "
                query += " inner join Country with (NOLOCK) on ac_aport_country = country_name"


                query += " WHERE (ac_journ_id = 0) and (ac_amod_id = @amodID) AND (ac_lifecycle_stage = 3) "

                If forSaleParam Then
                    query += " and ac_forsale_flag='Y' "
                End If
                ''-- YEAR RANGE
                'query += " and ac_mfr_year between @yearOne and @yearTwo"
                ''-- AFTT
                'query += " and ac_airframe_tot_hrs between @startAFTT and @endAFTT"
                'Add flags:

                If localCriteria.ViewCriteriaAFTTStart > 0 Then
                    query += (Constants.cAndClause + " ((ac_airframe_tot_hrs >= " & localCriteria.ViewCriteriaAFTTStart & ") or (ac_airframe_tot_hrs IS NULL))")
                End If

                If localCriteria.ViewCriteriaAFTTEnd > 0 Then
                    query += (Constants.cAndClause + " ((ac_airframe_tot_hrs <= " & localCriteria.ViewCriteriaAFTTEnd & ") or (ac_airframe_tot_hrs IS NULL))")
                End If

                If localCriteria.ViewCriteriaYearStart > 0 Then
                    query += (Constants.cAndClause + " ac_mfr_year >= " & localCriteria.ViewCriteriaYearStart)
                End If

                If localCriteria.ViewCriteriaYearEnd > 0 Then
                    query += (Constants.cAndClause + " ac_mfr_year <=  " & localCriteria.ViewCriteriaYearEnd)
                End If


                query += " and ("


                If HttpContext.Current.Session.Item("localSubscription").crmBusiness_Flag = True Then
                    query += " ac_product_business_flag = 'Y' "
                End If

                If HttpContext.Current.Session.Item("localSubscription").crmBusiness_Flag = True And HttpContext.Current.Session.Item("localSubscription").crmCommercial_Flag = True Then
                    query += " or "
                End If

                If HttpContext.Current.Session.Item("localSubscription").crmCommercial_Flag = True Then
                    query += " ac_product_commercial_flag = 'Y' "
                End If

                If (HttpContext.Current.Session.Item("localSubscription").crmHelicopter_Flag = True And HttpContext.Current.Session.Item("localSubscription").crmCommercial_Flag = True) Or (HttpContext.Current.Session.Item("localSubscription").crmHelicopter_Flag = True And HttpContext.Current.Session.Item("localSubscription").crmBusiness_Flag = True) Then
                    query += " or "
                End If

                If HttpContext.Current.Session.Item("localSubscription").crmHelicopter_Flag = True Then
                    query += " ac_product_helicopter_flag = 'Y'"
                End If

                query += ")"

                query += " AND not (ac_aport_country IS NULL) "

                query += " GROUP BY country_continent_name"
                query += " ORDER BY country_continent_name"

                clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, query.ToString)

                Dim SqlCommand As New SqlClient.SqlCommand(query, SqlConn)
                SqlCommand.Parameters.AddWithValue("amodID", amod_id)
                'SqlCommand.Parameters.AddWithValue("yearOne", yearOne)
                'SqlCommand.Parameters.AddWithValue("yearTwo", yearTwo)
                'SqlCommand.Parameters.AddWithValue("startAFTT", afttStart)
                'SqlCommand.Parameters.AddWithValue("endAFTT", afttEnd)
                SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

                Try
                    TempTable.Load(SqlReader)
                Catch constrExc As System.Data.ConstraintException
                    Dim rowsErr As System.Data.DataRow() = TempTable.GetErrors()
                End Try

                SqlCommand.Dispose()
                SqlCommand = Nothing
            End If




        Catch ex As Exception
            GetContinents = Nothing
            'Me.class_error = "Error in GetAircraftStartingTable(ByVal amod_id As Long) As DataTable SQL VERSION: " & ex.Message
        Finally
            SqlReader = Nothing

            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing


        End Try
        Return TempTable
    End Function
    Public Function GetValuesTrendsByWeight(ByVal amod_id As Long, ByVal forsaleFlag As String, ByVal yearOne As String, ByVal yearTwo As String, ByVal afttStart As String, ByVal afttEnd As String, ByVal regType As String, ByVal Startdate As String, ByVal EndDate As String, ByVal AirframeTypeCode As String, ByVal AmodTypeCode As String, ByVal AmodWeightClass As String) As DataTable
        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlReader As SqlClient.SqlDataReader
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing
        Dim TempTable As New DataTable
        Dim query As String
        Try

            If amod_id <> 0 Then

                'Opening Connection
                SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString
                SqlConn.Open()
                query = " SELECT Aircraft_Model.amod_id As AModId, Aircraft_Model.amod_make_name As Make, "
                query += " Aircraft_Model.amod_make_abbrev As MakeAbbrev, "
                query += " Aircraft_Model.amod_model_name As Model, "
                query += " Aircraft_Model.amod_max_range_miles as MRANGE, Aircraft_Model.amod_number_of_passengers as PAX, "
                query += " Aircraft_Model.amod_cabin_volume as CVOLUME,"

                query += "AVG(CAST(ac_mfr_year AS INT)) As dAvgYearMfr,"
                query += " AVG(CAST(ac_year AS INT)) As dAvgYearDlv,"
                query += " AVG(ac_asking_price) As dAvgAsking, "
                query += "AVG(ac_hidden_asking_price) As dAvgAskingHidden,"
                query += " AVG(ac_sale_price) As dAvgSelling,"
                query += " ((AVG(ac_sale_price)/AVG(ac_asking_price)) * 100) As dPercent,"
                query += " ((1-(AVG(ac_sale_price)/AVG(ac_asking_price))) * 100) As dVariance, "
                query += "((AVG(ac_sale_price)/AVG(ac_hidden_asking_price)) * 100) As dPercentHidden, "
                query += "((1-(AVG(ac_sale_price)/AVG(ac_hidden_asking_price))) * 100) As dVarianceHidden, "
                query += "AVG(ac_airframe_tot_hrs) As dAvgAFTT, "
                query += " AVG(DateDiff(day,ac_list_date, journ_date)) As dAvgDOM "

                query += " FROM Aircraft_Summary_SPI WITH (NOLOCK) "
                query += " inner join Aircraft_Model with (NOLOCK) on Aircraft_Summary_SPI.amod_id = Aircraft_Model.amod_id "
                'query += " inner join Aircraft_Model with (NOLOCK) on ac_amod_id = amod_id"
                'query += " inner join Journal with (NOLOCK) on journ_id = ac_journ_id and journ_ac_id = ac_id"

                query += " WHERE (ac_journ_id > 0) "
                query += " AND NOT (journ_subcat_code_part3 IN ('DB','DS','FI','FY','IT','MF','RE','CC','LS', 'RM')) "
                query += "AND (journ_subcat_code_part1 = 'WS') AND "
                query += " (journ_internal_trans_flag = 'N') AND " '(Aircraft_Model.amod_id <> @amodID) AND "
                query += " (Aircraft_Model.amod_customer_flag = 'Y' AND Aircraft_Model.amod_airframe_type_code=@AirframeTypeCode AND Aircraft_Model.amod_type_code = @AmodTypeCode) AND (Aircraft_Model.amod_weight_class = @AmodWeightClass) "
                query += " AND (ac_sale_price IS NOT NULL) AND (ac_sale_price <> 0) AND (ac_asking_price IS NOT NULL) AND (ac_asking_price <> 0) "
                'query += " AND (DATEPART(year,journ_date) >= 2016) AND (DATEPART(quarter,journ_date) = 1) "

                '-- ADD TRANSACTION DATE RANGE
                If Trim(Startdate) <> "" Or Trim(EndDate) <> "" Then
                    query += " and journ_date between @StartDate and @EndDate"
                End If
                '-- YEAR RANGE
                If Trim(yearOne) <> "" Or Trim(yearTwo) <> "" Then
                    query += " and ac_mfr_year between @yearOne and @yearTwo"
                ElseIf Trim(year_start_mms) <> "" And Trim(year_end_mms) <> "" And Trim(year_start_mms) <> "0" And Trim(year_end_mms) <> "0" Then
                    query += " and ac_mfr_year between " & year_start_mms & " and " & year_end_mms & ""
                End If

                '-- WITH OR WITHOUT SALE PRICES

                'reg Type
                If regType = "N" Then
                    query += " and ac_reg_no like 'N%' "
                ElseIf regType = "I" Then
                    query += " and ac_reg_no not like 'N%' "
                End If

                '-- AFTT
                If afttStart = 0 And afttEnd = 0 Then
                Else
                    If afttStart = 0 Then
                        query += " and ((ac_airframe_tot_hrs between @startAFTT and @endAFTT) or (ac_airframe_tot_hrs is NULL))"
                    Else
                        query += " and ac_airframe_tot_hrs between @startAFTT and @endAFTT"
                    End If
                End If

                query += " GROUP BY Aircraft_Model.amod_id, Aircraft_Model.amod_make_name, Aircraft_Model.amod_make_abbrev, Aircraft_Model.amod_model_name, Aircraft_Model.amod_max_range_miles, Aircraft_Model.amod_number_of_Passengers, Aircraft_Model.amod_cabin_volume ORDER BY Aircraft_Model.amod_make_name, Aircraft_Model.amod_model_name asc"



                clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, query.ToString)

                Dim SqlCommand As New SqlClient.SqlCommand(query, SqlConn)
                ' SqlCommand.Parameters.AddWithValue("amodID", amod_id)
                SqlCommand.Parameters.AddWithValue("yearOne", yearOne)
                SqlCommand.Parameters.AddWithValue("yearTwo", yearTwo)
                SqlCommand.Parameters.AddWithValue("StartDate", Startdate)
                SqlCommand.Parameters.AddWithValue("EndDate", EndDate)
                SqlCommand.Parameters.AddWithValue("startAFTT", afttStart)
                SqlCommand.Parameters.AddWithValue("endAFTT", afttEnd)
                SqlCommand.Parameters.AddWithValue("AirframeTypeCode", AirframeTypeCode)
                SqlCommand.Parameters.AddWithValue("AmodTypeCode", AmodTypeCode)
                SqlCommand.Parameters.AddWithValue("AmodWeightClass", AmodWeightClass)
                SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

                Try
                    TempTable.Load(SqlReader)
                Catch constrExc As System.Data.ConstraintException
                    Dim rowsErr As System.Data.DataRow() = TempTable.GetErrors()
                End Try

                SqlCommand.Dispose()
                SqlCommand = Nothing
            End If




        Catch ex As Exception
            GetValuesTrendsByWeight = Nothing
            'Me.class_error = "Error in GetAircraftStartingTable(ByVal amod_id As Long) As DataTable SQL VERSION: " & ex.Message
        Finally
            SqlReader = Nothing

            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing


        End Try
        Return TempTable
    End Function
    Public Function GetAircraftSliderValues(ByVal amod_id As Long, ByVal variantIDs As String) As DataTable
        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlReader As SqlClient.SqlDataReader
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing
        Dim TempTable As New DataTable
        Dim query As String
        Try

            If amod_id <> 0 Then


                'Opening Connection
                SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString
                SqlConn.Open()


                query = "select MIN(ac_mfr_year) as MINYEAR, MAX(ac_mfr_year) AS MAXYEAR, "
                query += " MAX(ac_est_airframe_hrs) AS MAXAFTT"
                query += " from Aircraft_Flat with (NOLOCK)"

                If Not String.IsNullOrEmpty(variantIDs) Then
                    query += " where amod_id in (" & amod_id & "," & variantIDs & ") "
                Else
                    query += " where amod_id = @amodID "
                End If


                query += clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(HttpContext.Current.Session.Item("localSubscription"), False, True)
                query += " and ac_journ_id = 0"



                clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, query.ToString)
                Dim SqlCommand As New SqlClient.SqlCommand(query, SqlConn)


                SqlCommand.Parameters.AddWithValue("amodID", amod_id)


                SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

                Try
                    TempTable.Load(SqlReader)
                Catch constrExc As System.Data.ConstraintException
                    Dim rowsErr As System.Data.DataRow() = TempTable.GetErrors()
                End Try

                SqlCommand.Dispose()
                SqlCommand = Nothing

            End If
            Return TempTable
        Catch ex As Exception
            GetAircraftSliderValues = Nothing
            'Me.class_error = "Error in GetAircraftStartingTable(ByVal amod_id As Long) As DataTable SQL VERSION: " & ex.Message
        Finally
            SqlReader = Nothing

            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing



        End Try

    End Function
    Private Function DisplayAFTTTable(ByRef Graph11 As String, ByRef Graph12 As String) As String
        DisplayAFTTTable = ""

        Dim results_table As New DataTable
        results_table = GetAircraftSliderValues(NEW_PDF_AMOD_ID, "")

        If Not IsNothing(results_table) Then
            If results_table.Rows.Count > 0 Then
                If Not IsDBNull(results_table.Rows(0).Item("MAXAFTT")) Then
                    aftt_end.Text = results_table.Rows(0).Item("MAXAFTT")
                End If
            End If
        End If

        Dim ValueAFTTable As New DataTable
        ValueAFTTable = GetValuesTrendsByAFTT(NEW_PDF_AMOD_ID, "", year_start.Text, year_end.Text, aftt_start.Text, aftt_end.Text, aircraft_registration.SelectedValue, localCriteria.ViewCriteriaDocumentsStartDate, localCriteria.ViewCriteriaDocumentsEndDate, "") 'clsGeneral.clsGeneral.ExtractSelectedStringFromListboxDropdown(VariantList, False, 0, True)
        DisplayAFTTTable = DisplayValueAFTTTable(ValueAFTTable, Graph11, Graph12)


        Me.VALUES_CHART.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "VALUES_CHART_1_AFTT.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
        Me.VALUES_CHART2.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "VALUES_CHART_2_AFTT.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)



        DisplayAFTTTable &= "<tr><td valign=""top""><br/><br/><table cellspacing='0' cellpadding='0' border='0' width='100%'><tr><td align='center' width='100%' valign=""top""><div class=""Box""><div style=""width:680px;"" class=""marginAuto"">"
        If HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag Then
            DisplayAFTTTable &= "<font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER_NOALIGN") & "'>Avg Asking vs Selling Price By AFTT($k)</font>"
        Else
            DisplayAFTTTable &= "<font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER_NOALIGN") & "'>Avg Asking Price By AFTT($k)</font>"
        End If
        '  DisplayAFTTTable &= "</td><td>&nbsp;</td><td align='center'>"
        ' DisplayAFTTTable &= "<font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER") & "'>Avg Selling Price By AFTT($k)</font>"
        '  DisplayAFTTTable &= "</td></tr><tr><td align='center' width='100%'>"
        ' DisplayAFTTTable &= "<img src='" & HttpContext.Current.Session.Item("jetnetFullHostName").ToString & "/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "VALUES_CHART_1_AFTT.jpg'>"
        ' DisplayAFTTTable &= "</td><td>&nbsp;</td><td align='center'>"
        ' DisplayAFTTTable &= "<img src='" & HttpContext.Current.Session.Item("jetnetFullHostName").ToString & "/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "VALUES_CHART_2_AFTT.jpg'>"

        DisplayAFTTTable &= "<img src='" & valueGraphText11.Text & "' width=""700"" align='center' class=""marginAuto"" /></div>"
        '  DisplayAFTTTable &= "</td><td>&nbsp;</td><td align='center'>"
        ' DisplayAFTTTable &= "<img src='" & valueGraphText12.Text & "' width='505' />"
        ' DisplayAFTTTable &= "</td><td>&nbsp;</td><td align='center'>"


        DisplayAFTTTable &= "</div></td></tr></table>"
        DisplayAFTTTable &= "</td></tr>"

        ' BuildAFTTGraphs(Graph1, Graph2)

        '  BuildAFTTTable()

        '   If Not Page.ClientScript.IsClientScriptBlockRegistered("refreshAFTTTable") Then
        '    System.Web.UI.ScriptManager.RegisterClientScriptBlock(Me.tabs_bottom_5_update_panel, Me.GetType, "refreshAFTTTable", TableBuild.ToString, True)
        '   End If

        '  RecreateDropdownsValueYearGraphs(tabs_bottom_5_update_panel, False, True, True)

    End Function
    Public Function DisplayValueAFTTTable(ByVal dt As DataTable, ByRef Graph11 As String, ByRef Graph12 As String) As String
        Dim results As String = ""
        Dim sumAsking As Long = 0
        Dim sumSale As Long = 0
        Dim countAsking As Long = 0
        Dim CountSale As Long = 0
        Dim AircraftYear As String = ""
        Dim AvgAsking As String = ""
        Dim AvgSale As String = ""
        Dim high_number As Integer = 0
        Dim low_number As Integer = 20000000
        Dim starting_point As Integer = 0
        Dim interval_point As Integer = 1
        Dim ending_point As Integer = 0

        Me.VALUES_CHART.Series.Clear()
        Me.VALUES_CHART2.Series.Clear()
        Me.VALUES_CHART.Series.Add("AVG_PRICE").ChartType = UI.DataVisualization.Charting.SeriesChartType.Spline
        Me.VALUES_CHART.Series.Add("AVG_PRICE2").ChartType = UI.DataVisualization.Charting.SeriesChartType.Spline

        Me.VALUES_CHART.ChartAreas("ChartArea1").AxisY.Title = ""

        Me.VALUES_CHART.Series("AVG_PRICE").Color = Drawing.Color.Blue
        Me.VALUES_CHART.Series("AVG_PRICE").BorderWidth = 1
        Me.VALUES_CHART.Series("AVG_PRICE").MarkerSize = 5
        Me.VALUES_CHART.Series("AVG_PRICE").MarkerStyle = UI.DataVisualization.Charting.MarkerStyle.Circle
        Me.VALUES_CHART.BorderlineWidth = 10
        Me.VALUES_CHART.Series("AVG_PRICE").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32

        Me.VALUES_CHART.Series("AVG_PRICE2").Color = Drawing.Color.Red
        Me.VALUES_CHART.Series("AVG_PRICE2").BorderWidth = 1
        Me.VALUES_CHART.Series("AVG_PRICE2").MarkerSize = 5
        Me.VALUES_CHART.Series("AVG_PRICE2").MarkerStyle = UI.DataVisualization.Charting.MarkerStyle.Circle
        Me.VALUES_CHART.BorderlineWidth = 10
        Me.VALUES_CHART.Series("AVG_PRICE2").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32

        If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
            Me.VALUES_CHART.Width = 250
            Me.VALUES_CHART.Height = 215
        Else
            Me.VALUES_CHART.Width = 450
            Me.VALUES_CHART.Height = 325
        End If

        Me.VALUES_CHART2.Series.Add("AVG_PRICE").ChartType = UI.DataVisualization.Charting.SeriesChartType.Column
        Me.VALUES_CHART2.ChartAreas("ChartArea1").AxisY.Title = ""

        Me.VALUES_CHART2.Series("AVG_PRICE").Color = Drawing.Color.Green
        Me.VALUES_CHART2.Series("AVG_PRICE").BorderWidth = 1
        Me.VALUES_CHART2.Series("AVG_PRICE").MarkerSize = 0
        ' Me.VALUES_CHART2.Series("AVG_PRICE").MarkerStyle = UI.DataVisualization.Charting.MarkerStyle.Circle
        Me.VALUES_CHART2.BorderlineWidth = 10
        Me.VALUES_CHART2.Series("AVG_PRICE").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32

        If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
            Me.VALUES_CHART2.Width = 250
            Me.VALUES_CHART2.Height = 215
        Else
            Me.VALUES_CHART2.Width = 450
            Me.VALUES_CHART2.Height = 325
        End If



        results = "<tr><td valign='top' align='center'><font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & real_make_model_name & "</strong> Sales Summary by AFTT<span>LAST " & month_timeframe.SelectedValue & " MONTHS</span>" & valueHeaderString & "</font></td></tr>"

        results += "<tr><td valign=""top""><div class=""Box""><table id=""afttTable"" cellpadding='5' cellspacing='0' width='100%' class='formatTable large " & table_color & "'><thead>"
        results += "<tr>"
        If HttpContext.Current.Session.Item("isMobile") Then
            results += "<th></th>"
        End If
        results += "<th>AFTT</th>"
        results += "<th class='right'>Total<br/>Retail Sales</th>"
        results += "<th class='right'>Low<br/>Asking ($k)</th>"
        results += "<th class='right'>Avg<br/>Asking ($k)</th>"
        results += "<th class='right'>High<br/>Asking ($k)</th>"

        If HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag Then
            results += "<th class='right'>Low<br/>Sale ($k)</th>"
            results += "<th class='right'>Avg<br/>Sale ($k)</th>"
            results += "<th class='right'>High<br/>Sale ($k)</th>"
        End If

        results += "</tr></thead><tbody>"
        For Each r As DataRow In dt.Rows
            AircraftYear = ""
            AvgAsking = ""
            AvgSale = ""

            If Not IsDBNull(r("COUNTASKING")) Then
                countAsking += r("COUNTASKING")
            End If

            If Not IsDBNull(r("COUNTSALE")) Then
                CountSale += r("COUNTSALE")
            End If

            If Not IsDBNull(r("SUMASKING")) Then
                sumAsking += r("SUMASKING")
            End If

            If Not IsDBNull(r("SUMSALE")) Then
                sumSale += r("SUMSALE")
            End If

            If Not IsDBNull(r("AFTT")) Then
                results += "<tr>"
                If HttpContext.Current.Session.Item("isMobile") Then
                    results += "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'></font></td>"
                End If
                If Not IsDBNull(r("AFTT")) Then
                    results += "<td data-sort=""" & r("AFTTSORT") & """><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"

                    results += r("AFTT").ToString
                    AircraftYear = r("AFTT").ToString
                Else
                    results += "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                End If
                results += "</font></td>"
                results += "<td align=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                If Not IsDBNull(r("SALECOUNT")) Then
                    results += r("SALECOUNT").ToString
                End If
                results += "</font></td>"
                results += "<td align=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                If Not IsDBNull(r("LOWASKING")) Then
                    results += "$" & FormatNumber((r("LOWASKING") / 1000), 0)
                End If
                results += "</font></td>"
                results += "<td align=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                If Not IsDBNull(r("AVGASKING")) Then
                    results += "$" & FormatNumber((r("AVGASKING") / 1000), 0) '& "k"
                    AvgAsking = FormatNumber((r("AVGASKING") / 1000), 0).ToString
                Else
                    AvgAsking = "null"
                End If
                results += "</font></td>"
                results += "<td align=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                If Not IsDBNull(r("HIGHASKING")) Then
                    results += "$" & FormatNumber((r("HIGHASKING") / 1000), 0) '& "k"
                End If
                results += "</font></td>"
                If HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag Then
                    results += "<td align=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                    If Not IsDBNull(r("LOWSALE")) Then
                        results += "$" & FormatNumber((r("LOWSALE") / 1000), 0) '& "k"
                    End If
                    results += "</font></td>"
                    results += "<td align=""right"" class=""red_text""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                    If Not IsDBNull(r("AVGSALE")) Then
                        results += "$" & FormatNumber((r("AVGSALE") / 1000), 0) '& "k"
                        AvgSale = FormatNumber((r("AVGSALE") / 1000), 0).ToString
                    Else
                        AvgSale = "null"
                    End If
                    results += "</font></td>"
                    results += "<td align=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                    If Not IsDBNull(r("HIGHSALE")) Then
                        results += "$" & FormatNumber((r("HIGHSALE") / 1000), 0) '& "k"
                    End If

                    results += "</font></td>"
                Else
                    AvgSale = "null"
                End If


                If Trim(AvgAsking) <> "null" Then
                    Me.VALUES_CHART.Series("AVG_PRICE").Points.AddXY(AircraftYear, Replace(AvgAsking, ",", ""))

                    If CDbl(AvgAsking) > high_number Then
                        high_number = AvgAsking
                    End If
                    If CDbl(AvgAsking) < low_number Then
                        low_number = AvgAsking
                    End If
                End If


                If HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag Then
                    If Trim(AvgSale) <> "null" Then
                        Me.VALUES_CHART.Series("AVG_PRICE2").Points.AddXY(AircraftYear, Replace(AvgSale, ",", ""))

                        If CDbl(AvgSale) > high_number Then
                            high_number = AvgSale
                        End If
                        If CDbl(AvgSale) < low_number Then
                            low_number = AvgSale
                        End If
                    End If


                    If Trim(AvgSale) <> "null" Then
                        Me.VALUES_CHART2.Series("AVG_PRICE").Points.AddXY(AircraftYear, Replace(AvgSale, ",", ""))

                        If CDbl(AvgSale) > high_number Then
                            high_number = AvgSale
                        End If
                        If CDbl(AvgSale) < low_number Then
                            low_number = AvgSale
                        End If
                    End If
                End If



                If HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag Then
                    If Graph11 <> "" Then
                        Graph11 += ", "
                    End If
                    Graph11 += "['" & AircraftYear & "', " & Replace(AvgAsking, ",", "") & ", " & Replace(AvgSale, ",", "") & "]"


                    If Not String.IsNullOrEmpty(AvgSale) Then
                        If Graph12 <> "" Then
                            Graph12 += ", "
                        End If
                        Graph12 += "['" & AircraftYear & "', " & Replace(AvgSale, ",", "") & "]"
                    End If
                Else
                    If Trim(AircraftYear) <> "" Then
                        If Graph11 <> "" Then
                            Graph11 += ", "
                        End If
                        Graph11 += "['" & AircraftYear & "', " & Replace(AvgAsking, ",", "") & "]"
                    End If
                End If





                results += "</tr>"
            End If
        Next

        commonEvo.set_ranges_for_vsCharts(low_number, high_number, interval_point, starting_point, ending_point)

        VALUES_CHART.ChartAreas("ChartArea1").AxisY.Maximum = ending_point
        VALUES_CHART.ChartAreas("ChartArea1").AxisY.Minimum = IIf(starting_point > 0, starting_point, 0)
        VALUES_CHART.ChartAreas("ChartArea1").AxisY.Interval = interval_point


        VALUES_CHART2.ChartAreas("ChartArea1").AxisY.Maximum = ending_point
        VALUES_CHART2.ChartAreas("ChartArea1").AxisY.Minimum = IIf(starting_point > 0, starting_point, 0)
        VALUES_CHART2.ChartAreas("ChartArea1").AxisY.Interval = interval_point


        results += "</tbody></table></div></td></tr>"

        If HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag Then
            Graph11 = "data11.addColumn('string', 'AC Year'); data11.addColumn('number', 'Asking'); data11.addColumn('number', 'Sale'); data11.addRows([" & Graph11
        Else
            Graph11 = "data11.addColumn('string', 'AC Year'); data11.addColumn('number', 'Asking'); data11.addRows([" & Graph11
        End If

        Graph12 = "data12.addColumn('string', 'AC Year'); data12.addColumn('number', 'Sale'); data12.addRows([" & Graph12

        Return results
    End Function
    Public Function DisplayValueQuarterTable(ByVal dt As DataTable, ByRef Graph1 As String, ByRef Graph5 As String, ByRef Graph6 As String) As String
        Dim results As String = ""
        Dim AvgAsking As Double = 0
        Dim AvgAskingHidden As Double = 0

        Dim YearMFR As Long = 0
        Dim YearDLV As Long = 0
        Dim yearSold As String = ""
        Dim quarterSold As String = ""

        Dim selling As Double = 0
        Dim _percent As Double = 0
        Dim percentHidden As Double = 0

        Dim variance As Double = 0
        Dim varianceHidden As Double = 0
        Dim avgAftt As Long = 0
        Dim avgDOM As Long = 0


        Dim high_number As Integer = 0
        Dim low_number As Integer = 20000000
        Dim starting_point As Integer = 0
        Dim interval_point As Integer = 1
        Dim ending_point As Integer = 0

        Dim high_number2 As Integer = 0
        Dim low_number2 As Integer = 20000000
        Dim starting_point2 As Integer = 0
        Dim interval_point2 As Integer = 1
        Dim ending_point2 As Integer = 0

        Dim high_number3 As Integer = 0
        Dim low_number3 As Integer = 20000000
        Dim starting_point3 As Integer = 0
        Dim interval_point3 As Integer = 1
        Dim ending_point3 As Integer = 0

        Me.VALUES_CHART.Series.Clear()
        Me.VALUES_CHART2.Series.Clear()
        Me.VALUES_CHART3.Series.Clear()
        Me.VALUES_CHART.Series.Add("AVG_PRICE").ChartType = UI.DataVisualization.Charting.SeriesChartType.Spline
        Me.VALUES_CHART.Series.Add("AVG_PRICE2").ChartType = UI.DataVisualization.Charting.SeriesChartType.Spline

        Me.VALUES_CHART.ChartAreas("ChartArea1").AxisY.Title = ""

        Me.VALUES_CHART.Series("AVG_PRICE").Color = Drawing.Color.Blue
        Me.VALUES_CHART.Series("AVG_PRICE").BorderWidth = 1
        Me.VALUES_CHART.Series("AVG_PRICE").MarkerSize = 5
        Me.VALUES_CHART.Series("AVG_PRICE").MarkerStyle = UI.DataVisualization.Charting.MarkerStyle.Circle
        Me.VALUES_CHART.BorderlineWidth = 10
        Me.VALUES_CHART.Series("AVG_PRICE").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32

        Me.VALUES_CHART.Series("AVG_PRICE2").Color = Drawing.Color.Red
        Me.VALUES_CHART.Series("AVG_PRICE2").BorderWidth = 1
        Me.VALUES_CHART.Series("AVG_PRICE2").MarkerSize = 5
        Me.VALUES_CHART.Series("AVG_PRICE2").MarkerStyle = UI.DataVisualization.Charting.MarkerStyle.Circle
        Me.VALUES_CHART.BorderlineWidth = 10
        Me.VALUES_CHART.Series("AVG_PRICE2").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32

        If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
            Me.VALUES_CHART.Width = 250
            Me.VALUES_CHART.Height = 215
        Else
            Me.VALUES_CHART.Width = 450
            Me.VALUES_CHART.Height = 325
        End If

        Me.VALUES_CHART2.Series.Add("AVG_PRICE").ChartType = UI.DataVisualization.Charting.SeriesChartType.Column
        Me.VALUES_CHART2.ChartAreas("ChartArea1").AxisY.Title = ""

        Me.VALUES_CHART2.Series("AVG_PRICE").Color = Drawing.Color.Green
        Me.VALUES_CHART2.Series("AVG_PRICE").BorderWidth = 1
        Me.VALUES_CHART2.Series("AVG_PRICE").MarkerSize = 0
        ' Me.VALUES_CHART2.Series("AVG_PRICE").MarkerStyle = UI.DataVisualization.Charting.MarkerStyle.Circle
        Me.VALUES_CHART2.BorderlineWidth = 10
        Me.VALUES_CHART2.Series("AVG_PRICE").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32

        If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
            Me.VALUES_CHART2.Width = 250
            Me.VALUES_CHART2.Height = 215
        Else
            Me.VALUES_CHART2.Width = 450
            Me.VALUES_CHART2.Height = 325
        End If

        Me.VALUES_CHART3.Series.Add("AVG_PRICE").ChartType = UI.DataVisualization.Charting.SeriesChartType.Column
        Me.VALUES_CHART3.ChartAreas("ChartArea1").AxisY.Title = ""

        Me.VALUES_CHART3.Series("AVG_PRICE").Color = Drawing.Color.Green
        Me.VALUES_CHART3.Series("AVG_PRICE").BorderWidth = 1
        Me.VALUES_CHART3.Series("AVG_PRICE").MarkerSize = 0
        ' Me.VALUES_CHART3.Series("AVG_PRICE").MarkerStyle = UI.DataVisualization.Charting.MarkerStyle.Circle
        Me.VALUES_CHART3.BorderlineWidth = 10
        Me.VALUES_CHART3.Series("AVG_PRICE").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32


        If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
            Me.VALUES_CHART3.Width = 250
            Me.VALUES_CHART3.Height = 215
        Else
            Me.VALUES_CHART3.Width = 450
            Me.VALUES_CHART3.Height = 325
        End If


        results = "<tr><td valign='top' align='center'><font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & real_make_model_name & "</strong> Sales Summary by Month<span>LAST " & month_timeframe.SelectedValue & " MONTHS</span>" & valueHeaderString & "</font></td></tr>"


        results += "<tr><Td valign=""top""><div class=""Box""><table id=""quarterTable"" width=""100%"" cellpadding='4' cellspacing='0' width='100%' class='formatTable " & table_color & "'><thead>"
        results += "<tr class=""noBorder"">"
        If HttpContext.Current.Session.Item("isMobile") Then
            results += "<th></th>"
        End If
        results += "<th rowspan=""2"">Month/<br />Year</th>"
        results += "<th colspan=""2"">AVG YEAR OF</th>"

        If HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag Then
            results += "<th colspan=""2"" >AVG PRICE (k)</th>"
            results += "<th rowspan=""2"" class='right'>PERCENT</th>"
            results += "<th rowspan=""2"" class='right'>VARIANCE</th>"
        Else
            results += "<th colspan=""1"" class='right'>AVG PRICE (k)</th>"
        End If

        results += "<th colspan=""2"" class='right'>AVERAGE</th>"
        results += "</tr>"
        results += "<tr>"
        If HttpContext.Current.Session.Item("isMobile") Then
            results += "<th></th>"
        End If
        results += "<th class='right'>MFR</th>"
        results += "<th class='right'>DELIVERY</th>"
        results += "<th class='right'>ASKING</th>"


        If HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag Then
            results += "<th class='right'>SELLING</th>"
        End If

        results += "<th class='right'>AFTT</th>"
        results += "<th class='right'>DAYS ON MARKET</th>"
        results += "</tr></thead><tbody>"
        For Each r As DataRow In dt.Rows
            AvgAsking = 0
            AvgAskingHidden = 0
            YearMFR = 0
            YearDLV = 0
            yearSold = ""
            quarterSold = ""

            selling = 0
            _percent = 0
            percentHidden = 0
            variance = 0
            varianceHidden = 0
            avgAftt = 0
            avgDOM = 0
            yearSold = ""
            quarterSold = ""


            'Year
            If Not String.IsNullOrEmpty(r("YearSld")) Then
                yearSold = r("YearSld")
            Else
                yearSold = Year(Now())
            End If

            'Quarter Sold
            If Not String.IsNullOrEmpty(r("QuarterSld")) Then
                quarterSold = r("QuarterSld")
            End If

            'Year MFR
            If Not IsDBNull(r("dAvgYearMfr")) Then
                YearMFR = r("dAvgYearMfr")
            Else
                YearMFR = 0
            End If
            'Year DLV
            If Not IsDBNull(r("dAvgYearDlv")) Then
                YearDLV = r("dAvgYearDlv")
            Else
                YearDLV = 0
            End If

            'Asking Price.
            If Not IsDBNull(r("dAvgAsking")) Then
                AvgAsking = r("dAvgAsking")
            Else
                AvgAsking = 0
            End If
            If Not IsDBNull(r("dAvgAskingHidden")) Then
                AvgAskingHidden = r("dAvgAskingHidden")
            Else
                AvgAskingHidden = 0
            End If


            If Not IsDBNull(r("dAvgSelling")) Then
                selling = r("dAvgSelling")
            Else
                selling = 0
            End If

            If Not IsDBNull(r("dPercent")) Then
                _percent = r("dPercent")
            Else
                _percent = 0
            End If

            If Not IsDBNull(r("dPercentHidden")) Then
                percentHidden = r("dPercentHidden")
            Else
                percentHidden = 0
            End If

            If Not IsDBNull(r("dVariance")) Then
                variance = r("dVariance")
            Else
                variance = 0
            End If

            If Not IsDBNull(r("dVarianceHidden")) Then
                varianceHidden = r("dVarianceHidden")
            Else
                varianceHidden = 0
            End If

            If AvgAsking = 0 And AvgAskingHidden > 0 Then
                AvgAsking = AvgAskingHidden
                _percent = percentHidden
                variance = varianceHidden
            End If

            If Not IsDBNull(r("dAvgAFTT")) Then
                avgAftt = r("dAvgAFTT")
            Else
                avgAftt = 0
            End If

            If Not IsDBNull(r("dAvgDOM")) Then
                avgDOM = r("dAvgDOM")
            Else
                avgDOM = 0
            End If


            If HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag Then


                If Not IsDBNull(r("dAvgSelling")) Then
                    If r("dAvgSelling") > 0 Then
                        results += "<tr>"
                        If HttpContext.Current.Session.Item("isMobile") Then
                            results += "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'></font></td>"
                        End If
                        results += "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                        results += quarterSold.ToString
                        results += "/"
                        results += yearSold.ToString
                        results += "</font></td>"
                        results += "<td align=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                        If YearMFR > 0 Then
                            results += YearMFR.ToString
                        End If
                        results += "</font></td>"
                        results += "<td align=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                        If YearDLV > 0 Then
                            results += YearDLV.ToString
                        End If
                        results += "</font></td>"
                        results += "<td align=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                        If AvgAsking > 0 Then
                            results += "$" & FormatNumber(AvgAsking / 1000, 0, True).ToString
                        End If
                        results += "</font></td>"
                        results += "<td align=""right"" class=""red_text""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                        If selling > 0 Then
                            results += "$" & FormatNumber(selling / 1000, 0, True).ToString
                        End If
                        results += "</font></td>"
                        results += "<td align=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                        If _percent > 0 Then
                            results += FormatNumber(_percent, 1, True).ToString() & "%"
                        End If
                        results += "</font></td>"
                        results += "<td align=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                        If AvgAsking > 0 Then
                            results += FormatNumber(variance, 1, True).ToString() & "%</td>"
                        ElseIf AvgAsking = selling Then
                            results += "0.0%</td>"
                        End If
                        results += "</font></td>"
                        results += "<td align=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                        If avgAftt > 0 Then
                            results += FormatNumber(avgAftt, 0, True).ToString()
                        End If
                        results += "</font></td>"
                        results += "<td align=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                        If avgDOM > 0 Then
                            results += FormatNumber(avgDOM, 0, True).ToString
                        End If
                        results += "</font></td>"


                        results += "</tr>"
                        'This only shows up if there is a selling price.
                        If selling > 0 And AvgAsking > 0 Then
                            If Graph1 <> "" Then
                                Graph1 += ", "
                            End If
                            Graph1 += "['" + quarterSold + "/" + yearSold + "'," + IIf(AvgAsking > 0, Replace(FormatNumber(AvgAsking / 1000, 0, True).ToString, ",", ""), "null") + "," + IIf(selling > 0, Replace(FormatNumber(selling / 1000, 0, True).ToString, ",", ""), "null") & "]"
                        End If

                        If Graph5 <> "" Then
                            Graph5 += ", "
                        End If
                        Graph5 += "['" + quarterSold + "/" + yearSold + "'," + IIf(_percent > 0, FormatNumber(_percent, 1).ToString, "null") & "]"

                        If Graph6 <> "" Then
                            Graph6 += ", "
                        End If
                        Graph6 += "['" + quarterSold + "/" + yearSold + "'," + IIf(variance > 0, FormatNumber(variance, 1).ToString, "null") & "]"



                        If AvgAsking > 0 Then
                            Me.VALUES_CHART.Series("AVG_PRICE").Points.AddXY((yearSold & " - Q" & quarterSold), Replace(AvgAsking, ",", ""))
                        End If

                        If selling > 0 Then
                            Me.VALUES_CHART.Series("AVG_PRICE2").Points.AddXY((yearSold & " - Q" & quarterSold), Replace(selling, ",", ""))
                        End If

                        If CDbl(AvgAsking) > high_number And AvgAsking > 0 Then
                            high_number = AvgAsking
                        End If
                        If CDbl(AvgAsking) < low_number And AvgAsking > 0 Then
                            low_number = AvgAsking
                        End If

                        If CDbl(selling) > high_number And selling > 0 Then
                            high_number = selling
                        End If
                        If CDbl(selling) < low_number And selling > 0 Then
                            low_number = selling
                        End If



                        Me.VALUES_CHART2.Series("AVG_PRICE").Points.AddXY((yearSold & " - Q" & quarterSold), Replace(_percent, ",", ""))

                        If CDbl(_percent) > high_number2 Then
                            high_number2 = _percent
                        End If
                        If CDbl(_percent) < low_number2 Then
                            low_number2 = _percent
                        End If



                        Me.VALUES_CHART3.Series("AVG_PRICE").Points.AddXY((yearSold & " - Q" & quarterSold), Replace(variance, ",", ""))

                        If CDbl(variance) > high_number3 Then
                            high_number3 = variance
                        End If
                        If CDbl(variance) < low_number3 Then
                            low_number3 = variance
                        End If


                    End If
                End If
            Else
                If AvgAsking > 0 Then
                    results += "<tr>"
                    If HttpContext.Current.Session.Item("isMobile") Then
                        results += "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'></font></td>"
                    End If
                    results += "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                    results += quarterSold.ToString
                    results += "/"
                    results += yearSold.ToString
                    results += "</font></td>"
                    results += "<td align=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                    If YearMFR > 0 Then
                        results += YearMFR.ToString
                    End If
                    results += "</font></td>"
                    results += "<td align=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                    If YearDLV > 0 Then
                        results += YearDLV.ToString
                    End If
                    results += "</font></td>"
                    results += "<td align=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                    If AvgAsking > 0 Then
                        results += "$" & FormatNumber(AvgAsking / 1000, 0, True).ToString
                    End If
                    results += "</font></td>"
                    results += "<td align=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                    If avgAftt > 0 Then
                        results += FormatNumber(avgAftt, 0, True).ToString()
                    End If
                    results += "</font></td>"
                    results += "<td align=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                    If avgDOM > 0 Then
                        results += FormatNumber(avgDOM, 0, True).ToString
                    End If
                    results += "</font></td>"


                    results += "</tr>"
                    'This only shows up if there is a selling price.
                    If AvgAsking > 0 Then
                        If Graph1 <> "" Then
                            Graph1 += ", "
                        End If
                        Graph1 += "['" + quarterSold + "/" + yearSold + "'," + IIf(AvgAsking > 0, Replace(FormatNumber(AvgAsking / 1000, 0, True).ToString, ",", ""), "null") + "]"
                    End If

                End If
            End If

        Next


        If HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag Then
            Graph1 = " data7.addColumn('string', 'Year/Month'); data7.addColumn('number', 'Asking'); data7.addColumn('number', 'Sale'); data7.addRows([ " & Graph1

            Graph5 = " data5.addColumn('string', 'Year/Month'); data5.addColumn('number', 'Percent'); data5.addRows([ " & Graph5

            Graph6 = " data6.addColumn('string', 'Year/Month'); data6.addColumn('number', 'Variance'); data6.addRows([ " & Graph6
        Else
            Graph1 = " data7.addColumn('string', 'Year/Month'); data7.addColumn('number', 'Asking');   data7.addRows([ " & Graph1
        End If

        commonEvo.set_ranges_for_vsCharts(low_number, high_number, interval_point, starting_point, ending_point)


        VALUES_CHART.ChartAreas("ChartArea1").AxisY.Maximum = ending_point
        VALUES_CHART.ChartAreas("ChartArea1").AxisY.Minimum = IIf(starting_point > 0, starting_point, 0)
        VALUES_CHART.ChartAreas("ChartArea1").AxisY.Interval = interval_point


        commonEvo.set_ranges_for_vsCharts(low_number2, high_number2, interval_point2, starting_point2, ending_point2)

        VALUES_CHART2.ChartAreas("ChartArea1").AxisY.Maximum = ending_point2
        VALUES_CHART2.ChartAreas("ChartArea1").AxisY.Minimum = IIf(starting_point2 > 0, starting_point2, 0)
        VALUES_CHART2.ChartAreas("ChartArea1").AxisY.Interval = interval_point2



        commonEvo.set_ranges_for_vsCharts(low_number3, high_number3, interval_point3, starting_point3, ending_point3)

        VALUES_CHART3.ChartAreas("ChartArea1").AxisY.Maximum = ending_point3
        VALUES_CHART3.ChartAreas("ChartArea1").AxisY.Minimum = IIf(starting_point3 > 0, starting_point3, 0)
        VALUES_CHART3.ChartAreas("ChartArea1").AxisY.Interval = interval_point3


        results += "</tbody></table></div></td></tr>"


        Return results
    End Function
    Public Function GetValuesTrendsByAFTT(ByVal amod_id As Long, ByVal forsaleFlag As String, ByVal yearOne As String, ByVal yearTwo As String, ByVal afttStart As String, ByVal afttEnd As String, ByVal regType As String, ByVal Startdate As String, ByVal EndDate As String, ByVal variantListString As String) As DataTable
        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlReader As SqlClient.SqlDataReader
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing
        Dim TempTable As New DataTable
        Dim query As String
        Try

            If amod_id <> 0 Then

                TempTable.Columns.Add("AFTT")
                TempTable.Columns.Add("AFTTSORT", System.Type.GetType("System.Int64"))

                TempTable.Columns.Add("SALECOUNT")
                TempTable.Columns.Add("LOWASKING")
                TempTable.Columns.Add("AVGASKING")
                TempTable.Columns.Add("HIGHASKING")
                TempTable.Columns.Add("LOWSALE")
                TempTable.Columns.Add("AVGSALE")
                TempTable.Columns.Add("HIGHSALE")
                TempTable.Columns.Add("COUNTASKING")
                TempTable.Columns.Add("SUMASKING")
                TempTable.Columns.Add("COUNTSALE")
                TempTable.Columns.Add("SUMSALE")



                'Opening Connection
                SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString
                SqlConn.Open()

                query = "SELECT "
                Dim AFTTQuery As String = "case "

                Dim CeilingAFTT As Long = (Math.Ceiling(aftt_end.Text / 1000) * 1000)

                For x As Integer = 0 To CeilingAFTT Step 1000
                    If x = CeilingAFTT Then
                        AFTTQuery += " when ac_airframe_tot_hrs >= " & x & " and ac_airframe_tot_hrs <= " & x + 1000 & " then '" & x & "-" & (x + 1000) & "' "
                    Else
                        If x = 0 Then
                            AFTTQuery += " when ac_airframe_tot_hrs >= 1 and ac_airframe_tot_hrs < 1000 then '1-999' "
                        Else
                            AFTTQuery += " when ac_airframe_tot_hrs >= " & x & " and ac_airframe_tot_hrs < " & x + 1000 & " then '" & x & "-" & (x + 1000) - 1 & "' "
                        End If
                    End If
                Next

                AFTTQuery += " end "
                query += AFTTQuery & " as AFTT"
                query += " ,  "
                query += " count(distinct journ_id) as SALECOUNT,"
                query += " MIN(ac_asking_price) as LOWASKING, "
                query += " AVG(ac_asking_price) AS AVGASKING,"
                query += " MAX(ac_asking_price) as HIGHASKING,"
                query += " MIN(ac_sale_price) AS LOWSALE,"
                query += " AVG(ac_sale_price) AS AVGSALE,"
                query += " max(ac_sale_price) AS HIGHSALE,"
                query += " SUM(case when ac_asking_price > 0 then 1 else 0 end) as COUNTASKING, "
                query += " SUM(ac_asking_price) as SUMASKING, "
                query += " SUM(case when ac_sale_price > 0 then 1 else 0 end) as COUNTSALE, "
                query += " SUM(ac_sale_price) as SUMSALE"

                query += " From Aircraft a with (NOLOCK) "
                query += " inner join Journal with (NOLOCK) on journ_id = ac_journ_id and ac_id = journ_ac_id "
                query += " where journ_subcat_code_part1='WS' AND journ_internal_trans_flag='N' "
                query += " and journ_subcat_code_part3 NOT IN ('DB','DS','FI','FY','IT','MF','RE','CC','LS', 'RM') "


                If Not String.IsNullOrEmpty(variantListString) Then
                    query += " and ac_amod_id in (" & amod_id & "," & variantListString & ")"
                Else
                    query += " and ac_amod_id = @amodID"
                End If


                '-- ADD TRANSACTION DATE RANGE
                If Trim(Startdate) <> "" Or Trim(EndDate) <> "" Then
                    query += " and journ_date between @StartDate and @EndDate"
                End If
                '-- YEAR RANGE 
                If Trim(yearOne) <> "" Or Trim(yearTwo) <> "" Then
                    query += " and ac_mfr_year between @yearOne and @yearTwo"
                End If
                '-- WITH OR WITHOUT SALE PRICES

                'reg Type
                If regType = "N" Then
                    query += " and ac_reg_no like 'N%' "
                ElseIf regType = "I" Then
                    query += " and ac_reg_no not like 'N%' "
                End If

                '-- AFTT
                If afttStart = 0 And afttEnd = 0 Then
                Else
                    If afttStart = 0 Then
                        query += " and ((ac_airframe_tot_hrs between @startAFTT and @endAFTT) or (ac_airframe_tot_hrs is NULL))"
                    Else
                        query += " and ac_airframe_tot_hrs between @startAFTT and @endAFTT"
                    End If
                End If

                query += " group by  ac_amod_id, "
                query += "( " & AFTTQuery & " )"

                clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, query.ToString)

                Dim SqlCommand As New SqlClient.SqlCommand(query, SqlConn)
                SqlCommand.Parameters.AddWithValue("amodID", amod_id)
                SqlCommand.Parameters.AddWithValue("yearOne", yearOne)
                SqlCommand.Parameters.AddWithValue("yearTwo", yearTwo)
                SqlCommand.Parameters.AddWithValue("StartDate", Startdate)
                SqlCommand.Parameters.AddWithValue("EndDate", EndDate)
                SqlCommand.Parameters.AddWithValue("startAFTT", afttStart)
                SqlCommand.Parameters.AddWithValue("endAFTT", afttEnd)
                SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

                While SqlReader.Read()

                    Dim newRow As DataRow = TempTable.NewRow()
                    newRow("AFTT") = SqlReader.Item("AFTT")

                    Dim SortAFTT As Long = 0
                    If Not IsDBNull(SqlReader.Item("AFTT")) Then
                        Dim SortStringAFTTArray As Array = Split(SqlReader.Item("AFTT"), "-")
                        If UBound(SortStringAFTTArray) = 1 Then
                            If IsNumeric(Trim(SortStringAFTTArray(0))) Then
                                SortAFTT = Trim(SortStringAFTTArray(0))
                            End If
                        End If
                    End If

                    newRow("AFTTSORT") = SortAFTT
                    newRow("SALECOUNT") = SqlReader.Item("SALECOUNT")
                    newRow("LOWASKING") = SqlReader.Item("LOWASKING")
                    newRow("AVGASKING") = SqlReader.Item("AVGASKING")
                    newRow("HIGHASKING") = SqlReader.Item("HIGHASKING")
                    newRow("LOWSALE") = SqlReader.Item("LOWSALE")
                    newRow("AVGSALE") = SqlReader.Item("AVGSALE")
                    newRow("HIGHSALE") = SqlReader.Item("HIGHSALE")
                    newRow("COUNTASKING") = SqlReader.Item("COUNTASKING")
                    newRow("SUMASKING") = SqlReader.Item("SUMASKING")
                    newRow("COUNTSALE") = SqlReader.Item("COUNTSALE")
                    newRow("SUMSALE") = SqlReader.Item("SUMSALE")

                    TempTable.Rows.Add(newRow)
                    TempTable.AcceptChanges()
                End While

                SqlCommand.Dispose()
                SqlCommand = Nothing
            End If

            Dim SortView As New DataView(TempTable)
            SortView.Sort = "AFTTSORT desc"
            TempTable = SortView.ToTable

        Catch ex As Exception
            GetValuesTrendsByAFTT = Nothing
            'Me.class_error = "Error in GetAircraftStartingTable(ByVal amod_id As Long) As DataTable SQL VERSION: " & ex.Message
        Finally
            SqlReader = Nothing

            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing

        End Try
        Return TempTable
    End Function
    Public Function GetValuesTrendsByQuarter(ByVal amod_id As Long, ByVal forsaleFlag As String, ByVal yearOne As String, ByVal yearTwo As String, ByVal afttStart As String, ByVal afttEnd As String, ByVal regType As String, ByVal Startdate As String, ByVal EndDate As String, ByVal allSale As Boolean, ByVal allAsking As Boolean, ByVal variantListString As String) As DataTable
        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlReader As SqlClient.SqlDataReader
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing
        Dim TempTable As New DataTable
        Dim query As String

        Try

            If amod_id <> 0 Then

                'Opening Connection
                SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString
                SqlConn.Open()

                query = "SELECT DATEPART(year, journ_date) As YearSld, "
                query += " DATEPART(month, journ_date) As QuarterSld, "
                query += " AVG(CAST(ac_mfr_year AS INT)) As dAvgYearMfr, "
                query += " AVG(CAST(ac_year AS INT)) As dAvgYearDlv, "
                query += " AVG(ac_asking_price) As dAvgAsking, "
                query += " AVG(ac_hidden_asking_price) As dAvgAskingHidden, "
                query += " AVG(ac_sale_price) As dAvgSelling, "
                query += " ((AVG(ac_sale_price)/AVG(ac_asking_price)) * 100) As dPercent, "
                query += " ((1-(AVG(ac_sale_price)/AVG(ac_asking_price))) * 100) As dVariance, "
                query += " ((AVG(ac_sale_price)/AVG(ac_hidden_asking_price)) * 100) As dPercentHidden, "
                query += " ((1-(AVG(ac_sale_price)/AVG(ac_hidden_asking_price))) * 100) As dVarianceHidden, "
                query += " AVG(ac_airframe_tot_hrs) As dAvgAFTT, "
                query += " AVG(DateDiff(day,ac_list_date, journ_date)) As dAvgDOM "
                query += " FROM Aircraft WITH (NOLOCK) "
                query += " inner join Aircraft_Model with (NOLOCK) on ac_amod_id = amod_id"
                query += " inner join Journal with (NOLOCK) on journ_id = ac_journ_id and journ_ac_id = ac_id"
                query += " WHERE (ac_journ_id > 0) AND NOT (journ_subcat_code_part3 IN ('DB','DS','FI','FY','IT','MF','RE','CC','LS', 'RM')) "
                query += " AND (journ_subcat_code_part1 = 'WS') AND (journ_internal_trans_flag = 'N') "

                'Add Model

                If Not String.IsNullOrEmpty(variantListString) Then
                    query += " and amod_id in (" & amod_id & "," & variantListString & ")"
                Else
                    query += " and amod_id = @amodID "
                End If


                If allSale = False Then
                    query += " AND (ac_sale_price IS NOT NULL) AND (ac_sale_price <> 0) "
                End If

                If allAsking = False Then
                    query += " AND (ac_asking_price IS NOT NULL) AND (ac_asking_price <> 0) "
                End If

                'reg Type
                If regType = "N" Then
                    query += " and ac_reg_no like 'N%' "
                ElseIf regType = "I" Then
                    query += " and ac_reg_no not like 'N%' "
                End If

                'Add flags:
                query += clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(HttpContext.Current.Session.Item("localSubscription"), False, True)

                '-- AFTT
                If Trim(afttEnd) <> "0" Or Trim(afttEnd) <> "0" Then
                    query += " and ac_airframe_tot_hrs between @startAFTT and @endAFTT"
                End If

                ''-- ADD TRANSACTION DATE RANGE
                If Trim(Startdate) <> "" Or Trim(EndDate) <> "" Then
                    query += " and journ_date between @StartDate and @EndDate "
                End If

                ' commented out - doesnt do quarters anymore does 1/22/18 s
                'If Trim(Startdate) <> "" Then
                '  If Month(Startdate) = 12 Or Month(Startdate) = 11 Or Month(Startdate) = 10 Then
                '    Startdate = "01/01/" & (Year(Startdate) + 1)
                '  ElseIf Month(Startdate) = 7 Or Month(Startdate) = 8 Or Month(Startdate) = 9 Then
                '    Startdate = "10/01/" & Year(Startdate)
                '  ElseIf Month(Startdate) = 4 Or Month(Startdate) = 5 Or Month(Startdate) = 6 Then
                '    Startdate = "07/01/" & Year(Startdate)
                '  Else
                '    Startdate = "04/01/" & Year(Startdate)
                '  End If
                'End If

                'If Trim(EndDate) <> "" Then
                '  If Month(EndDate) = 12 Or Month(EndDate) = 11 Or Month(EndDate) = 10 Then
                '    EndDate = "01/01/" & (Year(EndDate) + 1)
                '  ElseIf Month(EndDate) = 7 Or Month(EndDate) = 8 Or Month(EndDate) = 9 Then
                '    EndDate = "10/01/" & Year(EndDate)
                '  ElseIf Month(Startdate) = 4 Or Month(EndDate) = 5 Or Month(EndDate) = 6 Then
                '    EndDate = "07/01/" & Year(EndDate)
                '  Else
                '    EndDate = "04/01/" & Year(EndDate)
                '  End If
                'End If


                '-- YEAR RANGE
                'query += " AND (DATEPART(year,journ_date) >= @yearSoldStart) AND (DATEPART(year,journ_date) <= @yearSoldEnd) "
                If Trim(yearOne) <> "" Or Trim(yearTwo) <> "" Then
                    query += " and ac_mfr_year between @yearOne and @yearTwo"
                End If


                query += " GROUP BY DATEPART(year, journ_date), DATEPART(month, journ_date) "
                query += " ORDER BY DATEPART(year, journ_date) ASC, DATEPART(month, journ_date) ASC"

                clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, query.ToString)

                Dim SqlCommand As New SqlClient.SqlCommand(query, SqlConn)
                SqlCommand.Parameters.AddWithValue("amodID", amod_id)
                SqlCommand.Parameters.AddWithValue("yearOne", yearOne)
                SqlCommand.Parameters.AddWithValue("yearTwo", yearTwo)
                SqlCommand.Parameters.AddWithValue("StartDate", Startdate)
                SqlCommand.Parameters.AddWithValue("EndDate", EndDate)
                'SqlCommand.Parameters.AddWithValue("yearSoldStart", Year(Startdate))
                'SqlCommand.Parameters.AddWithValue("yearSoldEnd", Year(EndDate))
                SqlCommand.Parameters.AddWithValue("startAFTT", afttStart)
                SqlCommand.Parameters.AddWithValue("endAFTT", afttEnd)
                SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

                Try
                    TempTable.Load(SqlReader)
                Catch constrExc As System.Data.ConstraintException
                    Dim rowsErr As System.Data.DataRow() = TempTable.GetErrors()
                End Try

                SqlCommand.Dispose()
                SqlCommand = Nothing
            End If




        Catch ex As Exception
            GetValuesTrendsByQuarter = Nothing
            'Me.class_error = "Error in GetAircraftStartingTable(ByVal amod_id As Long) As DataTable SQL VERSION: " & ex.Message
        Finally
            SqlReader = Nothing

            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing


        End Try
        Return TempTable
    End Function

    Public Function GET_SOLD_PER_MONTH_MTREND(ByVal amod_id As Long, ByVal date_search As Long, ByVal type_of As String) As DataTable
        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlReader As SqlClient.SqlDataReader
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing
        Dim TempTable As New DataTable
        Dim query As String = ""
        Dim temp_date As String = ""

        Try

            If amod_id <> 0 Then

                'Opening Connection
                SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString
                SqlConn.Open()

                query = "select mtrend_year,  mtrend_month, "
                query &= " mtrend_total_aircraft_for_sale as FORSALE, "
                query &= " mtrend_sold_total_count as NUMSOLD,"
                query &= " mtrend_avg_asking_price as AVGASKPRICE,"
                query &= " mtrend_avg_selling_price as AVGSALEPRICE,"
                query &= " mtrend_avg_market_days as AVGDAYSONMARKET"
                query &= " from Aircraft_Model_Trend with (NOLOCK)"
                query &= " where mtrend_amod_id = " & amod_id & ""

                temp_date = DateAdd(DateInterval.Month, -date_search, Date.Now())

                query &= " and "

                If Year(temp_date) <> Year(Date.Now()) Then
                    query &= " ( "
                    query &= " (mtrend_year >= '" & Year(temp_date) & "' and mtrend_month >= '" & Month(temp_date) & "')  "
                    query &= " or mtrend_year >= '" & Year(Date.Now()) & "') "
                Else
                    query &= " (mtrend_year >= '" & Year(temp_date) & "' and mtrend_month >= '" & Month(temp_date) & "')  "
                End If

                If Trim(type_of) <> "" Then
                    query &= " and mtrend_product_type = '" & Trim(type_of) & "' "
                End If

                'If HttpContext.Current.Session.Item("localSubscription").crmHelicopter_Flag = True And HttpContext.Current.Session.Item("localSubscription").crmCommercial_Flag = True And HttpContext.Current.Session.Item("localSubscription").crmBusiness_Flag = True Then
                '  query &= " and mtrend_product_type = 'B' "
                'ElseIf HttpContext.Current.Session.Item("localSubscription").crmBusiness_Flag = True Then
                '  query &= " and mtrend_product_type = 'B' "
                'ElseIf HttpContext.Current.Session.Item("localSubscription").crmCommercial_Flag = True Then
                '  query &= " and mtrend_product_type = 'C' "
                'ElseIf HttpContext.Current.Session.Item("localSubscription").crmHelicopter_Flag = True Then
                '  query &= " and mtrend_product_type = 'H' "
                'End If


                query &= " order by mtrend_year desc, mtrend_month desc"

                clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, "ViewToPDF.aspx", query.ToString)

                Dim SqlCommand As New SqlClient.SqlCommand(query, SqlConn)
                SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

                Try
                    TempTable.Load(SqlReader)
                Catch constrExc As System.Data.ConstraintException
                    Dim rowsErr As System.Data.DataRow() = TempTable.GetErrors()
                End Try

                SqlCommand.Dispose()
                SqlCommand = Nothing
            End If




        Catch ex As Exception
            GET_SOLD_PER_MONTH_MTREND = Nothing
            'Me.class_error = "Error in GetAircraftStartingTable(ByVal amod_id As Long) As DataTable SQL VERSION: " & ex.Message
        Finally
            SqlReader = Nothing

            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing


        End Try
        Return TempTable
    End Function

    Private Function DisplayValueVintageTable(ByVal modelPostback As Boolean, ByVal swapAC As Boolean, ByRef value_summary As String, ByRef AvgAskingPriceVsSellingPrice As String, ByRef AvgSellingPriceByYear As String) As String
        DisplayValueVintageTable = ""
        Dim ValueVintageTable As New DataTable
        Dim MaxMinCurrentTable As New DataTable

        Dim averageSalesAnswer As Long = 0
        Dim averageAskingAnswer As Long = 0
        Dim rows_count As Integer = 0

        Dim htmlout As New StringBuilder

        ValueVintageTable = GetValuesVintageTab(NEW_PDF_AMOD_ID, ac_market.Text, year_start.Text, year_end.Text, aftt_start.Text, aftt_end.Text, aircraft_registration.SelectedValue, localCriteria.ViewCriteriaDocumentsStartDate, localCriteria.ViewCriteriaDocumentsEndDate, "")   ' clsGeneral.clsGeneral.ExtractSelectedStringFromListboxDropdown(VariantList.Text, False, 0, True)
        MaxMinCurrentTable = GetValuesMaxMinCurrent(NEW_PDF_AMOD_ID, ac_market.Text, year_start.Text, year_end.Text, aftt_start.Text, aftt_end.Text, aircraft_registration.SelectedValue, localCriteria.ViewCriteriaDocumentsStartDate, localCriteria.ViewCriteriaDocumentsEndDate)



        Me.VALUES_CHART.Titles.Add("")
        Me.VALUES_CHART.ImageType = DataVisualization.Charting.ChartImageType.Jpeg


        DisplayValueVintageTable = DisplayValueVintageTable_2(ValueVintageTable, averageAskingAnswer, averageSalesAnswer, AvgAskingPriceVsSellingPrice, AvgSellingPriceByYear, rows_count)

        ' Me.VALUES_CHART.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "VALUES_CHART_1_VINTAGE.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
        ' Me.VALUES_CHART2.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "VALUES_CHART_2_VINTAGE.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)


        DisplayValueVintageTable &= "<tr><td><table cellspacing='0' cellpadding='0' border='0' width='100%'><tr><td align='center' width='100%'><div class=""Box""><div style=""width:700px;"" class=""marginAuto"">"
        If HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag Then
            DisplayValueVintageTable &= "<font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER_NOALIGN") & "'>Avg Asking vs Selling Price By Year MFR ($k)</font>"
        Else
            DisplayValueVintageTable &= "<font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER_NOALIGN") & "'>Avg Asking Price By Year MFR ($k)</font>"
        End If
        ' DisplayValueVintageTable &= "</td></tr><tr><td align='center' width='100%'>"

        If rows_count > 25 Then
            DisplayValueVintageTable &= ("<img src='" & valueGraphText.Text & "' width='450' align='center' /></div>")
        ElseIf rows_count > 20 Then
            DisplayValueVintageTable &= ("<img src='" & valueGraphText.Text & "' width='550' align='center' /></div>")
        Else
            DisplayValueVintageTable &= ("<img src='" & valueGraphText.Text & "' width='700' align='center' /></div>")
        End If


        '  DisplayValueVintageTable &= "</td></tr><tr><td align='center'>"
        '  DisplayValueVintageTable &= "<font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Avg Selling Price By Year MFR ($k)</font>"
        '  DisplayValueVintageTable &= "</td></tr><tr><td align='center'>"
        '  DisplayValueVintageTable &= ("<img src='" & valueGraphText4.Text & "' width='880' />")

        ' DisplayValueVintageTable &= "</td></tr><tr><td align='center'>"
        ' DisplayValueVintageTable &= "<img src='" & HttpContext.Current.Session.Item("jetnetFullHostName").ToString & "/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "VALUES_CHART_1_VINTAGE.jpg'>"
        ' DisplayValueVintageTable &= "</td><td>&nbsp;</td><td align='center'>"
        ' DisplayValueVintageTable &= "<img src='" & HttpContext.Current.Session.Item("jetnetFullHostName").ToString & "/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "VALUES_CHART_2_VINTAGE.jpg'>"
        DisplayValueVintageTable &= "</div></td></tr></table>"
        DisplayValueVintageTable &= "</td></tr>"

        '  BuildChartsYearByVintage(AvgAskingPriceVsSellingPrice, AvgSellingPriceByYear, modelPostback, swapAC)




        ' ac_market.SelectedValue was second value
        ValueVintageTable = GetValuesVintageTab(NEW_PDF_AMOD_ID, "", year_start.Text, year_end.Text, aftt_start.Text, aftt_end.Text, aircraft_registration.SelectedValue, start_date.Text, end_date.Text, "")
        ' MaxMinCurrentTable = GetValuesMaxMinCurrent(modelList.SelectedValue, ac_market.SelectedValue, year_start.Text, year_end.Text, aftt_start.Text, aftt_end.Text, aircraft_registration.SelectedValue, start_date.Text, end_date.Text)

        'valueYearVintageLabel.Text = DisplayValueVintageTable(ValueVintageTable, averageAskingAnswer, averageSalesAnswer, AvgAskingPriceVsSellingPrice, AvgSellingPriceByYear)
        ' BuildChartsYearByVintage(AvgAskingPriceVsSellingPrice, AvgSellingPriceByYear, modelPostback, swapAC)





        If ValueVintageTable.Rows.Count > 0 Then
            Dim minCurrentAsking As Long = Convert.ToInt64(IIf(Not IsDBNull(MaxMinCurrentTable.Compute("min(LOWASKING)", String.Empty)), MaxMinCurrentTable.Compute("min(LOWASKING)", String.Empty), 0))
            Dim maxCurrentAsking As Long = Convert.ToInt64(IIf(Not IsDBNull(MaxMinCurrentTable.Compute("max(HIGHASKING)", String.Empty)), MaxMinCurrentTable.Compute("max(HIGHASKING)", String.Empty), 0))
            Dim avgCurrentAskingTotal As Long = Convert.ToInt64(IIf(Not IsDBNull(MaxMinCurrentTable.Compute("sum(SUMASKING)", String.Empty)), MaxMinCurrentTable.Compute("sum(SUMASKING)", String.Empty), 0))
            Dim avgCurrentAskingTotalCount As Long = Convert.ToInt64(IIf(Not IsDBNull(MaxMinCurrentTable.Compute("sum(COUNTASKING)", String.Empty)), MaxMinCurrentTable.Compute("sum(COUNTASKING)", String.Empty), 0))
            Dim avgCurrentAsking As Long = 0

            If avgCurrentAskingTotal > 0 And avgCurrentAskingTotalCount > 0 Then
                avgCurrentAsking = avgCurrentAskingTotal / avgCurrentAskingTotalCount
            End If

            htmlout.Append("<table cellpadding='4' cellspacing='0' width='100%' class='formatTable large " & table_color & "'><thead>")
            htmlout.Append("<tr><th class='upperCase'>Pricing</th><th class='upperCase right'>LOW($k)</th><th class='upperCase right'>AVG($k)</th><th class='upperCase right'>HIGH($k)</th></tr>")
            htmlout.Append("</thead><tbody>")


            'lowest_aircraft_on_market.Text = IIf(minCurrentAsking > 0, "$" & FormatNumber((minCurrentAsking / 1000), 0) & "", "______")
            'highest_aircraft_on_market.Text = IIf(maxCurrentAsking > 0, "$" & FormatNumber((maxCurrentAsking / 1000), 0) & "", "______")
            'average_aircraft_on_market.Text = IIf(avgCurrentAsking > 0, "$" & FormatNumber((avgCurrentAsking / 1000), 0) & "", "______")

            Dim minAsking As Long = Convert.ToInt64(IIf(Not IsDBNull(ValueVintageTable.Compute("min(LOWASKING)", String.Empty)), ValueVintageTable.Compute("min(LOWASKING)", String.Empty), 0))
            Dim maxAsking As Long = Convert.ToInt64(IIf(Not IsDBNull(ValueVintageTable.Compute("max(HIGHASKING)", String.Empty)), ValueVintageTable.Compute("max(HIGHASKING)", String.Empty), 0))
            Dim minSale As Long = Convert.ToInt64(IIf(Not IsDBNull(ValueVintageTable.Compute("min(LOWSALE)", String.Empty)), ValueVintageTable.Compute("min(LOWSALE)", String.Empty), 0))
            Dim maxSale As Long = Convert.ToInt64(IIf(Not IsDBNull(ValueVintageTable.Compute("max(HIGHSALE)", String.Empty)), ValueVintageTable.Compute("max(HIGHSALE)", String.Empty), 0))
            'average_asking_sales.Text = IIf(averageSalesAnswer > 0, "$" & FormatNumber((averageAskingAnswer / 1000), 0) & "", "______")

            AvgSalesPrice = averageSalesAnswer
            LowSalesPrice = minSale
            HighSalesPrice = maxSale

            'average_sale_aircraft_sales.Text = IIf(averageSalesAnswer > 0, "$" & FormatNumber((averageSalesAnswer / 1000), 0) & "", "______")

            htmlout.Append("<tr><td align='left' class='upperCase'>Asking $</td><td align='right'>$" & FormatNumber((minAsking / 1000), 0) & "</td><td align='right'>$" & FormatNumber((averageAskingAnswer / 1000), 0) & "</td><td align='right'>$" & FormatNumber((maxAsking / 1000), 0) & "</td></tr>")
            If HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag Then
                htmlout.Append("<tr><td class='upperCase'>Sales $</font></td><td align='right'>$" & FormatNumber((minSale / 1000), 0) & "</td><td align='right'>$" & FormatNumber((averageSalesAnswer / 1000), 0) & "</td><td align='right'>$" & FormatNumber((maxSale / 1000), 0) & "</td></tr>")
            End If
            htmlout.Append("</tbody></table>")

            'lowest_asking_sales.Text = IIf(minAsking > 0, "$" & FormatNumber((minAsking / 1000), 0) & "", "______")
            'highest_asking_sales.Text = IIf(maxAsking > 0, "$" & FormatNumber((maxAsking / 1000), 0) & "", "______")
            'lowest_sale_aircraft_sales.Text = IIf(minSale > 0, "$" & FormatNumber((minSale / 1000), 0) & "", "______")
            'highest_sale_aircraft_sales.Text = IIf(maxSale > 0, "$" & FormatNumber((maxSale / 1000), 0) & "", "______")
        ElseIf ValueVintageTable.Rows.Count = 0 Then
            'lowest_aircraft_on_market.Text = "______"
            'highest_aircraft_on_market.Text = "______"
            'average_aircraft_on_market.Text = "______"
            'average_asking_sales.Text = "______"
            'average_sale_aircraft_sales.Text = "______"
            'lowest_asking_sales.Text = "______"
            'highest_asking_sales.Text = "______"
            'lowest_sale_aircraft_sales.Text = "______"
            'highest_sale_aircraft_sales.Text = "______"

        End If

        value_summary = htmlout.ToString

    End Function
    Public Function DisplayValueVintageTable_2(ByVal dt As DataTable, ByRef averageAsking As Long, ByRef averageSale As Long, ByRef AvgAskingPriceVsSellingPrice As String, ByRef AvgSellingPriceByYear As String, ByRef rows_count As Integer) As String
        Dim results As String = ""
        Dim sumAsking As Long = 0
        Dim sumSale As Long = 0
        Dim countAsking As Long = 0
        Dim CountSale As Long = 0
        Dim AircraftYear As String = ""
        Dim AvgAsking As String = ""
        Dim AvgSale As String = ""
        Dim high_number As Integer = 0
        Dim low_number As Integer = 20000000
        Dim starting_point As Integer = 0
        Dim interval_point As Integer = 1
        Dim ending_point As Integer = 0

        results = "<tr><td valign='top' align='center'><font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & real_make_model_name & "</strong> Sales Summary By Age of Aircraft<span>LAST " & month_timeframe.SelectedValue & " MONTHS</span>" & valueHeaderString & "</font></td></tr>"


        results += "<tr><td valign=""top""><div class=""Box""><table id='forSaleInnerTable' cellpadding='4'   cellspacing='0' align='center' width='100%' class='formatTable " & table_color & "'><thead>"
        results += "<tr>"
        results += "<th>Year</th>"
        results += "<th class='right'>In Op<br/>Fleet</th>"
        results += "<th class='right'>Total<br/>Retail Sales</th>"
        results += "<th class='right'>Low<br/>Asking($k)</th>"
        results += "<th class='right'>Avg<br/>Asking($k)</th>"
        results += "<th class='right'>High<br/>Asking($k)</th>"
        If HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag Then
            results += "<th class='right'>Low<br/>Sale($k)</th>"
            results += "<th class='right'>Avg<br/>Sale($k)</th>"
            results += "<th class='right'>High<br/>Sale($k)</th>"
        End If
        results += "</tr></thead><tbody>"

        Me.VALUES_CHART.Series.Clear()
        Me.VALUES_CHART2.Series.Clear()
        Me.VALUES_CHART.Series.Add("AVG_PRICE").ChartType = UI.DataVisualization.Charting.SeriesChartType.Spline
        Me.VALUES_CHART.Series.Add("AVG_PRICE2").ChartType = UI.DataVisualization.Charting.SeriesChartType.Spline

        Me.VALUES_CHART.ChartAreas("ChartArea1").AxisY.Title = ""

        Me.VALUES_CHART.Series("AVG_PRICE").Color = Drawing.Color.Blue
        Me.VALUES_CHART.Series("AVG_PRICE").BorderWidth = 1
        Me.VALUES_CHART.Series("AVG_PRICE").MarkerSize = 5
        Me.VALUES_CHART.Series("AVG_PRICE").MarkerStyle = UI.DataVisualization.Charting.MarkerStyle.Circle
        Me.VALUES_CHART.BorderlineWidth = 10
        Me.VALUES_CHART.Series("AVG_PRICE").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32

        Me.VALUES_CHART.Series("AVG_PRICE2").Color = Drawing.Color.Red
        Me.VALUES_CHART.Series("AVG_PRICE2").BorderWidth = 1
        Me.VALUES_CHART.Series("AVG_PRICE2").MarkerSize = 5
        Me.VALUES_CHART.Series("AVG_PRICE2").MarkerStyle = UI.DataVisualization.Charting.MarkerStyle.Circle
        Me.VALUES_CHART.BorderlineWidth = 10
        Me.VALUES_CHART.Series("AVG_PRICE2").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32

        If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
            Me.VALUES_CHART.Width = 250
            Me.VALUES_CHART.Height = 215
        Else
            Me.VALUES_CHART.Width = 450
            Me.VALUES_CHART.Height = 325
        End If

        Me.VALUES_CHART2.Series.Add("AVG_PRICE").ChartType = UI.DataVisualization.Charting.SeriesChartType.Column
        Me.VALUES_CHART2.ChartAreas("ChartArea1").AxisY.Title = ""

        Me.VALUES_CHART2.Series("AVG_PRICE").Color = Drawing.Color.Green
        Me.VALUES_CHART2.Series("AVG_PRICE").BorderWidth = 1
        Me.VALUES_CHART2.Series("AVG_PRICE").MarkerSize = 0
        ' Me.VALUES_CHART2.Series("AVG_PRICE").MarkerStyle = UI.DataVisualization.Charting.MarkerStyle.Circle
        Me.VALUES_CHART2.BorderlineWidth = 10
        Me.VALUES_CHART2.Series("AVG_PRICE").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32

        If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
            Me.VALUES_CHART2.Width = 250
            Me.VALUES_CHART2.Height = 215
        Else
            Me.VALUES_CHART2.Width = 450
            Me.VALUES_CHART2.Height = 325
        End If


        For Each r As DataRow In dt.Rows
            AircraftYear = ""
            AvgAsking = ""
            AvgSale = ""
            rows_count += 1

            If Not IsDBNull(r("COUNTASKING")) Then
                countAsking += r("COUNTASKING")
            End If

            If Not IsDBNull(r("COUNTSALE")) Then
                CountSale += r("COUNTSALE")
            End If

            If Not IsDBNull(r("SUMASKING")) Then
                sumAsking += r("SUMASKING")
            End If

            If Not IsDBNull(r("SUMSALE")) Then
                sumSale += r("SUMSALE")
            End If


            results += "<tr>"
            results += "<td><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
            If Not IsDBNull(r("MFRYEAR")) Then
                results += r("MFRYEAR").ToString
                AircraftYear = r("MFRYEAR").ToString
            End If
            results += "</font></td>"
            results += "<td align=""right"">"
            If Not IsDBNull(r("INOP")) Then
                results += r("INOP").ToString
            End If
            results += "</font></td>"
            results += "<td align=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
            If Not IsDBNull(r("SALECOUNT")) Then
                results += r("SALECOUNT").ToString
            End If
            results += "</font></td>"
            results += "<td align=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
            If Not IsDBNull(r("LOWASKING")) Then
                results += "$" & FormatNumber((r("LOWASKING") / 1000), 0)
            End If
            results += "</font></td>"
            results += "<td align=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
            If Not IsDBNull(r("AVGASKING")) Then
                results += "$" & FormatNumber((r("AVGASKING") / 1000), 0) '& "k"
                AvgAsking = FormatNumber((r("AVGASKING") / 1000), 0).ToString
            Else
                AvgAsking = "null"
            End If
            results += "</font></td>"
            results += "<td align=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
            If Not IsDBNull(r("HIGHASKING")) Then
                results += "$" & FormatNumber((r("HIGHASKING") / 1000), 0) '& "k"
            End If
            results += "</font></td>"


            If HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag Then
                results += "<td align=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                If Not IsDBNull(r("LOWSALE")) Then
                    results += "$" & FormatNumber((r("LOWSALE") / 1000), 0) '& "k"
                End If
                results += "</font></td>"
                results += "<td align=""right"" class=""red_text""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                If Not IsDBNull(r("AVGSALE")) Then
                    results += "$" & FormatNumber((r("AVGSALE") / 1000), 0) '& "k"
                    AvgSale = FormatNumber((r("AVGSALE") / 1000), 0).ToString
                Else
                    AvgSale = "null"
                End If
                results += "</font></td>"
                results += "<td align=""right""><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                If Not IsDBNull(r("HIGHSALE")) Then
                    results += "$" & FormatNumber((r("HIGHSALE") / 1000), 0) '& "k"
                End If
            Else
                AvgSale = "null"
            End If

            If Not String.IsNullOrEmpty(AvgAsking) And Not String.IsNullOrEmpty(AvgSale) Then

                If AvgAskingPriceVsSellingPrice <> "" Then
                    AvgAskingPriceVsSellingPrice += ", "
                End If
                If HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag Then
                    AvgAskingPriceVsSellingPrice += "['" & AircraftYear & "', " & Replace(AvgAsking, ",", "") & ", " & Replace(AvgSale, ",", "") & "]"
                Else
                    AvgAskingPriceVsSellingPrice += "['" & AircraftYear & "', " & Replace(AvgAsking, ",", "") & "]"
                End If
            End If

            If Trim(AvgAsking) <> "null" Then
                Me.VALUES_CHART.Series("AVG_PRICE").Points.AddXY(AircraftYear, Replace(AvgAsking, ",", ""))

                If CDbl(AvgAsking) > high_number Then
                    high_number = AvgAsking
                End If
                If CDbl(AvgAsking) < low_number Then
                    low_number = AvgAsking
                End If
            End If

            If Trim(AvgSale) <> "null" Then
                Me.VALUES_CHART.Series("AVG_PRICE2").Points.AddXY(AircraftYear, Replace(AvgSale, ",", ""))

                If CDbl(AvgSale) > high_number Then
                    high_number = AvgSale
                End If
                If CDbl(AvgSale) < low_number Then
                    low_number = AvgSale
                End If
            End If





            If HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag Then


                If Not String.IsNullOrEmpty(AvgSale) Then
                    If AvgSellingPriceByYear <> "" Then
                        AvgSellingPriceByYear += ", "
                    End If
                    AvgSellingPriceByYear += "['" & AircraftYear & "', " & Replace(AvgSale, ",", "") & "]"

                    Me.VALUES_CHART2.Series("AVG_PRICE").Points.AddXY(AircraftYear, Replace(AvgSale, ",", ""))

                    If Trim(AvgSale) <> "null" Then
                        Me.VALUES_CHART2.Series("AVG_PRICE").Points.AddXY(AircraftYear, Replace(AvgSale, ",", ""))

                        If CDbl(AvgSale) > high_number Then
                            high_number = AvgSale
                        End If
                        If CDbl(AvgSale) < low_number Then
                            low_number = AvgSale
                        End If
                    End If


                End If

                results += "</font></td>"

            End If

            results += "</tr>"
        Next


        If HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag Then
            AvgAskingPriceVsSellingPrice = " data1.addColumn('string', 'Year'); data1.addColumn('number', 'Asking'); data1.addColumn('number', 'Sale'); data1.addRows([ " & AvgAskingPriceVsSellingPrice

            AvgSellingPriceByYear = " data2.addColumn('string', 'Year'); data2.addColumn('number', 'Sale'); data2.addRows([ " & AvgSellingPriceByYear
        Else
            AvgAskingPriceVsSellingPrice = " data1.addColumn('string', 'Year'); data1.addColumn('number', 'Asking'); ; data1.addRows([ " & AvgAskingPriceVsSellingPrice
        End If


        commonEvo.set_ranges_for_vsCharts(low_number, high_number, interval_point, starting_point, ending_point)


        VALUES_CHART.ChartAreas("ChartArea1").AxisY.Maximum = ending_point
        VALUES_CHART.ChartAreas("ChartArea1").AxisY.Minimum = IIf(starting_point > 0, starting_point, 0)
        VALUES_CHART.ChartAreas("ChartArea1").AxisY.Interval = interval_point


        VALUES_CHART2.ChartAreas("ChartArea1").AxisY.Maximum = ending_point
        VALUES_CHART2.ChartAreas("ChartArea1").AxisY.Minimum = IIf(starting_point > 0, starting_point, 0)
        VALUES_CHART2.ChartAreas("ChartArea1").AxisY.Interval = interval_point


        results += "</tbody></table></div>"
        results += "</td>"
        results += "</tr>"

        'make the letters and numbers smaller so that they can fit the graph onto the page - MSW - 5/20/20
        If rows_count > 20 Then
            results = Replace(results, "" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'", "" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "' size='-1'")
        End If

        If countAsking > 0 And sumAsking > 0 Then
            averageAsking = sumAsking / countAsking
        End If

        If CountSale > 0 And sumSale > 0 Then
            averageSale = sumSale / CountSale
        End If

        Return results
    End Function
    Public Function GetValuesMaxMinCurrent(ByVal amod_id As Long, ByVal forsaleFlag As String, ByVal yearOne As String, ByVal yearTwo As String, ByVal afttStart As String, ByVal afttEnd As String, ByVal regType As String, ByVal Startdate As String, ByVal EndDate As String) As DataTable
        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlReader As SqlClient.SqlDataReader
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing
        Dim TempTable As New DataTable
        Dim query As String
        Try

            If amod_id <> 0 Then


                'Opening Connection
                SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString
                SqlConn.Open()

                query = "SELECT count(distinct ac_id) as INOP,"
                query += " SUM(case when ac_forsale_flag='Y' then 1 else 0 end) as COUNTFORSALE,"
                query += " MIN(ac_asking_price) as LOWASKING, "
                query += " AVG(ac_asking_price) AS AVGASKING,"
                query += " SUM(case when ac_asking_price > 0 then 1 else 0 end) as COUNTASKING,"
                query += " SUM(ac_asking_price) as SUMASKING,"
                query += " MAX(ac_asking_price) as HIGHASKING"
                query += " From Aircraft_Flat with (NOLOCK) where ac_journ_id = 0 and ac_lifecycle_stage = 3 "
                query += " and amod_id = @amodID "

                query += clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(HttpContext.Current.Session.Item("localSubscription"), False, True)

                '-- YEAR RANGE
                If Trim(yearOne) <> "" Or Trim(yearTwo) <> "" Then
                    query += " and ac_mfr_year between @yearOne and @yearTwo"
                End If
                '-- WITH OR WITHOUT SALE PRICES

                'reg Type
                If regType = "N" Then
                    query += " and ac_reg_no like 'N%' "
                ElseIf regType = "I" Then
                    query += " and ac_reg_no not like 'N%' "
                End If

                '-- AFTT 
                If afttStart = 0 And afttEnd = 0 Then
                Else
                    If afttStart = 0 Then
                        query += " and ((ac_airframe_tot_hrs between @startAFTT and @endAFTT) or (ac_airframe_tot_hrs is NULL))"
                    Else
                        query += " and ac_airframe_tot_hrs between @startAFTT and @endAFTT"
                    End If
                End If


                'query += " group by amod_id,ac_mfr_year"
                'query += " order by ac_mfr_year"


                clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, query.ToString)

                Dim SqlCommand As New SqlClient.SqlCommand(query, SqlConn)
                SqlCommand.Parameters.AddWithValue("amodID", amod_id)
                SqlCommand.Parameters.AddWithValue("yearOne", yearOne)
                SqlCommand.Parameters.AddWithValue("yearTwo", yearTwo)
                SqlCommand.Parameters.AddWithValue("startAFTT", afttStart)
                SqlCommand.Parameters.AddWithValue("endAFTT", afttEnd)
                SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

                Try
                    TempTable.Load(SqlReader)
                Catch constrExc As System.Data.ConstraintException
                    Dim rowsErr As System.Data.DataRow() = TempTable.GetErrors()
                End Try

                SqlCommand.Dispose()
                SqlCommand = Nothing
            End If




        Catch ex As Exception
            GetValuesMaxMinCurrent = Nothing
            'Me.class_error = "Error in GetAircraftStartingTable(ByVal amod_id As Long) As DataTable SQL VERSION: " & ex.Message
        Finally
            SqlReader = Nothing

            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing


        End Try
        Return TempTable
    End Function
    Public Function GetValuesVintageTab(ByVal amod_id As Long, ByVal forsaleFlag As String, ByVal yearOne As String, ByVal yearTwo As String, ByVal afttStart As String, ByVal afttEnd As String, ByVal regType As String, ByVal Startdate As String, ByVal EndDate As String, ByVal variantListString As String) As DataTable
        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlReader As SqlClient.SqlDataReader
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing
        Dim TempTable As New DataTable
        Dim query As String
        Try

            If amod_id <> 0 Then

                'Opening Connection
                SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString
                SqlConn.Open()

                query = "SELECT distinct ac_amod_id, ac_mfr_year AS MFRYEAR, "
                query += " (select count(distinct ac_id) from Aircraft_Flat with (NOLOCK)"
                query += " where ac_journ_id = 0 and ac_lifecycle_stage = 3 and Aircraft_Flat.amod_id = a.ac_amod_id and Aircraft_Flat.ac_mfr_year=a.ac_mfr_year) as INOP,"
                query += " count(distinct journ_id) as SALECOUNT,"
                query += " MIN(ac_asking_price) as LOWASKING, "
                query += " AVG(ac_asking_price) AS AVGASKING,"
                query += " MAX(ac_asking_price) as HIGHASKING,"
                query += " MIN(ac_sale_price) AS LOWSALE,"
                query += " AVG(ac_sale_price) AS AVGSALE,"
                query += " max(ac_sale_price) AS HIGHSALE,"
                query += " SUM(case when ac_asking_price > 0 then 1 else 0 end) as COUNTASKING, "
                query += " SUM(ac_asking_price) as SUMASKING, "
                query += " SUM(case when ac_sale_price > 0 then 1 else 0 end) as COUNTSALE, "
                query += " SUM(ac_sale_price) as SUMSALE"

                query += " From Aircraft a with (NOLOCK) "
                query += " inner join Journal with (NOLOCK) on journ_id = ac_journ_id and ac_id = journ_ac_id "
                query += " where journ_subcat_code_part1='WS' AND journ_internal_trans_flag='N' "
                query += " and journ_subcat_code_part3 NOT IN ('DB','DS','FI','FY','IT','MF','RE','CC','LS', 'RM') "




                'query += " and ac_amod_id = @amodID"

                If Not String.IsNullOrEmpty(variantListString) Then
                    query += " and ac_amod_id in (" & amod_id & "," & variantListString & ")"
                Else
                    query += " and ac_amod_id = @amodID"
                End If

                If forsaleFlag = "Y" Then
                    query += " and ac_forsale_flag = 'Y' "
                End If

                '-- ADD TRANSACTION DATE RANGE
                If Trim(Startdate) <> "" Or Trim(EndDate) <> "" Then
                    query += " and journ_date between @StartDate and @EndDate"
                End If

                '-- YEAR RANGE
                If Trim(yearOne) <> "" Or Trim(yearTwo) <> "" Then
                    query += " and ac_mfr_year between @yearOne and @yearTwo"
                End If

                '-- WITH OR WITHOUT SALE PRICES--

                'reg Type
                If regType = "N" Then
                    query += " and ac_reg_no like 'N%' "
                ElseIf regType = "I" Then
                    query += " and ac_reg_no not like 'N%' "
                End If

                '-- AFTT
                If afttStart = 0 And afttEnd = 0 Then
                Else
                    If afttStart = 0 Then
                        query += " and ((ac_airframe_tot_hrs between @startAFTT and @endAFTT) or (ac_airframe_tot_hrs is NULL))"
                    Else
                        query += " and ac_airframe_tot_hrs between @startAFTT and @endAFTT"
                    End If
                End If

                query += " group by ac_amod_id,ac_mfr_year"
                query += " order by ac_mfr_year"


                clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, query.ToString)

                Dim SqlCommand As New SqlClient.SqlCommand(query, SqlConn)
                SqlCommand.Parameters.AddWithValue("amodID", amod_id)
                SqlCommand.Parameters.AddWithValue("yearOne", yearOne)
                SqlCommand.Parameters.AddWithValue("yearTwo", yearTwo)
                SqlCommand.Parameters.AddWithValue("StartDate", Startdate)
                SqlCommand.Parameters.AddWithValue("EndDate", EndDate)
                SqlCommand.Parameters.AddWithValue("startAFTT", afttStart)
                SqlCommand.Parameters.AddWithValue("endAFTT", afttEnd)
                SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

                Try
                    TempTable.Load(SqlReader)
                Catch constrExc As System.Data.ConstraintException
                    Dim rowsErr As System.Data.DataRow() = TempTable.GetErrors()
                End Try

                SqlCommand.Dispose()
                SqlCommand = Nothing
            End If




        Catch ex As Exception
            GetValuesVintageTab = Nothing
            'Me.class_error = "Error in GetAircraftStartingTable(ByVal amod_id As Long) As DataTable SQL VERSION: " & ex.Message
        Finally
            SqlReader = Nothing

            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing


        End Try
        Return TempTable
    End Function
    Public Function CheckGetValuesVintageTab(ByVal amod_id As Long, ByVal forsaleFlag As String, ByVal yearOne As String, ByVal yearTwo As String, ByVal afttStart As String, ByVal afttEnd As String, ByVal regType As String, ByVal Startdate As String, ByVal EndDate As String, ByVal variantListString As String) As DataTable
        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlReader As SqlClient.SqlDataReader
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing
        Dim TempTable As New DataTable
        Dim query As String
        Try

            If amod_id <> 0 Then

                'Opening Connection
                SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString
                SqlConn.Open()

                query = "SELECT distinct count(journ_id) as tcount"

                query += " From Aircraft a with (NOLOCK) "
                query += " inner join Journal with (NOLOCK) on journ_id = ac_journ_id and ac_id = journ_ac_id "
                query += " where journ_subcat_code_part1='WS' AND journ_internal_trans_flag='N' "
                query += " and journ_subcat_code_part3 NOT IN ('DB','DS','FI','FY','IT','MF','RE','CC','LS', 'RM') "

                If Not String.IsNullOrEmpty(variantListString) Then
                    query += " and ac_amod_id in (" & amod_id & "," & variantListString & ")"
                Else
                    query += " and ac_amod_id = @amodID"
                End If

                If forsaleFlag = "Y" Then
                    query += " and ac_forsale_flag = 'Y' "
                End If

                '-- ADD TRANSACTION DATE RANGE
                query += " and journ_date between @StartDate and @EndDate"
                '-- YEAR RANGE
                query += " and ac_mfr_year between @yearOne and @yearTwo"
                '-- WITH OR WITHOUT SALE PRICES

                'reg Type
                If regType = "N" Then
                    query += " and ac_reg_no like 'N%' "
                ElseIf regType = "I" Then
                    query += " and ac_reg_no not like 'N%' "
                End If

                '-- AFTT
                query += " and ac_airframe_tot_hrs between @startAFTT and @endAFTT"



                clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, query.ToString)

                Dim SqlCommand As New SqlClient.SqlCommand(query, SqlConn)
                SqlCommand.Parameters.AddWithValue("amodID", amod_id)
                SqlCommand.Parameters.AddWithValue("yearOne", yearOne)
                SqlCommand.Parameters.AddWithValue("yearTwo", yearTwo)
                SqlCommand.Parameters.AddWithValue("StartDate", Startdate)
                SqlCommand.Parameters.AddWithValue("EndDate", EndDate)
                SqlCommand.Parameters.AddWithValue("startAFTT", afttStart)
                SqlCommand.Parameters.AddWithValue("endAFTT", afttEnd)
                SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

                Try
                    TempTable.Load(SqlReader)
                Catch constrExc As System.Data.ConstraintException
                    Dim rowsErr As System.Data.DataRow() = TempTable.GetErrors()
                End Try

                SqlCommand.Dispose()
                SqlCommand = Nothing
            End If




        Catch ex As Exception
            CheckGetValuesVintageTab = Nothing
            'Me.class_error = "Error in GetAircraftStartingTable(ByVal amod_id As Long) As DataTable SQL VERSION: " & ex.Message
        Finally
            SqlReader = Nothing

            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing


        End Try
        Return TempTable
    End Function
    'Public Sub Build_Sales_Tab(ByVal dt As DataTable)
    '  Dim results As String = ""
    '  Dim outStr As String = ""
    '  Dim bHadStatus As Boolean = False
    '  Dim page_break_count As Integer = 35

    '  outStr = "<table border='1' id='forSaleInnerTable' cellpadding='6'  bordercolor='lightgrey' cellspacing='0' align='center' width='100%'><tr><td class='table_specs' width='15%'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Serial#</font></td><td class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Reg#</font></td><td class='table_specs' width='4%'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Year MFR</font></td><td class='table_specs' nowrap='nowrap'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>For Sale Status</font></td><td class='table_specs' width='4%'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Hours</font></td><td class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Owner/Exclusive Broker </font></td></tr>" & vbCrLf
    '  Dim current_row As Integer = 0

    '  For Each r As DataRow In dt.Rows

    '    '------------------------------------------------- THIS SECTION IS FOR ENDING OF PAGE---------------------
    '    If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
    '      page_break_count = 35
    '    Else
    '      page_break_count = 35
    '    End If

    '    If current_row > page_break_count Then
    '      current_row = 0

    '      outStr = outStr & "</table></td></tr></table>"
    '      outStr = outStr & comp_functions.NEW_Insert_Page_Break_PDF(0, WD.SelectedValue)
    '      outStr = outStr & temp_pdf_header
    '      If bWordReport = True Then
    '        outStr = outStr & "<table width='" & word_width & "' align='center' cellpadding='3'>"
    '      Else
    '        outStr = outStr & "<table width='" & pdf_html_width & "' align='center' cellpadding='3'>"
    '      End If
    '      outStr = outStr & "<tr><td valign='top' align='center'><font class='" & Session("FONT_CLASS_HEADER") & "'>" & real_make_model_name & " Aircraft For Sale</font></td></tr><tr><td align='center' colspan='6'>&nbsp;</td></tr>"
    '      outStr = outStr & "<tr><td>"
    '      outStr = outStr & "<table border='1' id='forSaleInnerTable' cellpadding='6'  bordercolor='lightgrey' cellspacing='0' align='center' width='100%'><tr><td class='table_specs' width='15%'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Serial#</font></td><td class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Reg#</font></td><td class='table_specs' width='4%'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Year MFR</font></td><td class='table_specs' nowrap='nowrap'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>For Sale Status</font></td><td class='table_specs' width='4%'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Hours</font></td><td class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Owner/Exclusive Broker </font></td></tr>" & vbCrLf
    '    End If

    '    outStr = outStr & "<tr><td align='left' valign='top' class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & vbCrLf









    '    results += """ser"": [""" & Replace(Replace("<a " & DisplayFunctions.WriteDetailsLink(r("ac_id"), 0, 0, 0, False, "", "", "") & " title=""" & r("amod_make_name") & " " & r("amod_model_name") & " S/N #" & r("ac_ser_no_full") & """>" & r("ac_ser_no_full").ToString & "</a>", """", "\"""), "'", "\'") & """,   """ & r("ac_ser_no_sort").ToString & """],"
    '    results += """reg"": """ & r("ac_reg_no").ToString & ""","

    '    results += """mfr"": """ & r("ac_mfr_year").ToString & ""","
    '    If Not IsDBNull(r("journ_date")) Then
    '      results += Format(r("journ_date"), "MM/dd/yy")
    '    End If


    '    If Not IsDBNull(r("ac_engine_1_tot_hrs")) Then
    '      If CDbl(r.Item("ac_engine_1_tot_hrs").ToString) = 0 Then
    '        results += "[0]&nbsp;"
    '      Else
    '        results += "[" + r.Item("ac_engine_1_tot_hrs").ToString + "]&nbsp;"
    '      End If
    '    Else
    '      results += "[U]&nbsp;"
    '    End If

    '    If Not IsDBNull(r("ac_engine_2_tot_hrs")) Then
    '      If CDbl(r.Item("ac_engine_2_tot_hrs").ToString) = 0 Then
    '        results += "[0]&nbsp;"
    '      Else
    '        results += "[" + r.Item("ac_engine_2_tot_hrs").ToString + "]&nbsp;"
    '      End If
    '    Else
    '      results += "[U]&nbsp;"
    '    End If

    '    If Not IsDBNull(r("ac_engine_3_tot_hrs")) Then
    '      If CDbl(r.Item("ac_engine_3_tot_hrs").ToString) = 0 Then
    '        results += "[0]&nbsp;"
    '      Else
    '        results += "[" + r.Item("ac_engine_3_tot_hrs").ToString + "]&nbsp;"
    '      End If
    '    End If

    '    If Not IsDBNull(r("ac_engine_4_tot_hrs")) Then
    '      If CDbl(r.Item("ac_engine_4_tot_hrs").ToString) = 0 Then
    '        results += "[0]&nbsp;"
    '      Else
    '        results += "[" + r.Item("ac_engine_4_tot_hrs").ToString + "]&nbsp;"
    '      End If
    '    End If


    '    If r("ac_forsale_flag").ToString = "Y" Then
    '      If Not IsDBNull(r("ac_asking")) Then
    '        If r.Item("ac_asking").ToString.ToLower.Trim.Trim.Contains("price") Then
    '          If Not IsDBNull(r("ac_asking_price")) Then
    '            If CDbl(r.Item("ac_asking_price").ToString) > 0 Then
    '              results += """$" & FormatNumber((r("ac_asking_price") / 1000), 0) & """ , """ & r("ac_asking_price").ToString & """ "
    '            Else
    '              results += """"","""""
    '            End If
    '          Else
    '            results += """"","""""
    '          End If
    '        Else
    '          results += """M/O"",""1"""
    '          'results += """" & Replace(Replace(localDataLayer.forsale_status(r("ac_asking").ToString.Trim), """", "\"""), "'", "\'") & """,""1"" "
    '        End If
    '      Else
    '        results += """"","""""
    '      End If
    '    Else
    '      results += """OFFMKT"",""0"""
    '    End If
    '    results += "],"
    '    results += vbNewLine

    '    results += """sale"":"""
    '    If HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag Then
    '      If Not IsDBNull(r("ac_sold_price")) Then
    '        If r("ac_sold_price") > 0 Then
    '          'We need to keep the space here down below before the sale price.
    '          'The javascript filters on this row but it is not treating the image/span as actual content so it doesn't think any of the columns have a sale price.
    '          'A way to get past this is by adding the space down below. It does not change the display but pads the data giving a way to tell whether
    '          'a sales record has a sale price or not.
    '          results += " <span unselectable=\'on\' alt=\'Reported Sale Price Displayed with Permission from Source\' title=\'Reported Sale Price Displayed with Permission from Source\'>"
    '          results += Replace(Replace(DisplayFunctions.TextToImage("$" & FormatNumber((r("ac_sold_price") / 1000), 0), 10, "Arial", IIf(FormatNumber((r("ac_sold_price") / 1000), 0) < 10000, "35px", "43px"), ""), """", "\"""), "'", "\'")
    '          results += "</span>"
    '        Else
    '          ' results += "<a href=\'\' onclick=\""javascript:load(\'/SendSalesTransaction.aspx?sendSales=true&ModelID=" & modelList.SelectedValue & "&jID=" & r("journ_id").ToString & "&acid=" & r("ac_id").ToString & "\',\'\',\'scrollbars=yes,menubar=no,height=438,width=800,resizable=yes,toolbar=no,location=no,status=no\');return false;\"" class=\'gray_text\'>ENTER</a>"
    '        End If
    '      End If
    '    End If
    '    results += ""","
    '    results += vbNewLine
    '    results += """listdate"":["
    '    If Not IsDBNull(r("ac_list_date")) Then
    '      results += " """ & Format(r("ac_list_date"), "MM/dd/yy") & " "",""" & Format(r("ac_list_date"), "yyyy/MM/dd") & " "" "
    '    Else
    '      results += """"","""""
    '    End If
    '    results += "],"
    '    results += vbNewLine

    '    results += """PAX"":"""
    '    If Not IsDBNull(r("ac_passenger_count")) Then
    '      If CDbl(r.Item("ac_passenger_count").ToString) = 0 Then
    '        results += "0&nbsp;"
    '      Else
    '        results += r.Item("ac_passenger_count").ToString + "&nbsp;"
    '      End If
    '    Else
    '      results += "U&nbsp;"
    '    End If
    '    If Not String.IsNullOrEmpty(r.Item("ac_interior_moyear").ToString) Then
    '      results += Left(r.Item("ac_interior_moyear").ToString, 2).Trim
    '      If Not String.IsNullOrEmpty(Left(r.Item("ac_interior_moyear").ToString, 2).Trim) Then
    '        results += "/"
    '      End If
    '      results += Right(r.Item("ac_interior_moyear").ToString, 4).Trim + "&nbsp;"
    '    Else
    '      results += "&nbsp;"
    '    End If
    '    results += ""","
    '    results += vbNewLine
    '    results += """EXT"":"""
    '    If Not String.IsNullOrEmpty(r.Item("ac_exterior_moyear").ToString) Then
    '      results += Left(r.Item("ac_exterior_moyear").ToString, 2).Trim
    '      If Not String.IsNullOrEmpty(Left(r.Item("ac_exterior_moyear").ToString, 2).Trim) Then
    '        results += "/"
    '      End If
    '      results += Right(r.Item("ac_exterior_moyear").ToString, 4).Trim + "&nbsp;"
    '    Else
    '      results += "&nbsp;"
    '    End If


    '    If Not IsDBNull(r("EPROG")) Then
    '      If InStr(r("EPROG"), "Confirmed not") > 0 Then
    '        results += "Confirmed Not"
    '      ElseIf InStr(r("EPROG"), "Confirmed") > 0 Then
    '        results += "Confirmed"
    '      Else
    '        results += r("EPROG").ToString
    '      End If
    '    End If
    '    results += ""","
    '    results += vbNewLine
    '    results += """APROG"":"""
    '    If Not IsDBNull(r("APROG")) Then
    '      If InStr(r("APROG"), "Confirmed not") > 0 Then
    '        results += "Confirmed Not"
    '      ElseIf InStr(r("APROG"), "Confirmed") > 0 Then
    '        results += "Confirmed"
    '      Else
    '        results += r("APROG").ToString
    '      End If
    '    End If
    '    results += ""","
    '    results += vbNewLine
    '    results += """MAINTAINED"":"""
    '    If Not IsDBNull(r("ac_maintained")) Then
    '      results += r("ac_maintained").ToString
    '    End If
    '    results += ""","
    '    results += vbNewLine

    '    results += """forsale"":""" & r("ac_forsale_flag").ToString & ""","
    '    results += vbNewLine
    '    results += """new"":""" & r("NEWUSED").ToString & ""","
    '    results += vbNewLine
    '    results += """id"":""" & r("journ_id").ToString & """"
    '    results += "}"

    '  Next



    '  GetForSaleInfo = GetForSaleInfo & "</table>"
    '  GetForSaleInfo = GetForSaleInfo & "</td></tr>"
    'End Sub

    Public Function GetTransactionAircraftStartingTable(ByVal amod_id As Long, ByVal idList As String, ByVal variantListString As String, ByVal pass_num As Long) As DataTable
        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlReader As SqlClient.SqlDataReader
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing
        Dim TempTable As New DataTable
        Dim query As String
        Try

            If amod_id <> 0 Then


                'Opening Connection
                SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString
                SqlConn.Open()


                query = "SELECT amod_airframe_type_code, amod_type_code, amod_weight_class, ac_ser_no,ac_ser_no_full, ac_reg_no,journ_newac_flag, ac_mfr_year, journ_date, journ_subject, amod_make_name, amod_model_name,"
                query += "	case when journ_newac_flag = 'Y' then 'NEWFIRSTOWNER' when (select top 1 j.journ_newac_flag from Journal j with (NOLOCK) where j.journ_ac_id = ac_id and j.journ_id < journal.journ_id and j.journ_newac_flag = 'Y' order by j.journ_id desc) = 'Y' then 'USED' when ac_previously_owned_flag = 'Y' then 'USED' else 'UNKNOWN' end as NEWUSED, "
                query += " ac_asking_price,  case when ac_asking IS NULL then '' else ac_asking end as ac_asking ,"
                If HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag Then
                    query += " case when ac_sale_price > 0 and ac_sale_price_display_flag = 'Y' then ac_sale_price else '' end as ac_sold_price, "
                Else
                    query += " '' as ac_sold_price, "
                End If
                If FeaturesList <> "" Then
                    query += FeaturesList & ","
                End If
                query += " case amp_program_name when 'Unknown' then '' when 'Confirmed to be on a maintenance program' then 'Confirmed' when 'Confirmed not on any maintenance program' then 'Confirmed Not' else amp_program_name end as APROG,"
                query += " case emp_program_name when 'Unknown' then '' when 'Confirmed to be on a maintenance program' then 'Confirmed' when 'Confirmed not on any maintenance program' then 'Confirmed Not' else emp_program_name end as EPROG, "
                query += " ac_engine_1_tot_hrs, ac_maintained, "
                query += " ac_engine_2_tot_hrs, ac_engine_3_tot_hrs, ac_engine_4_tot_hrs, ac_interior_moyear, ac_exterior_moyear, "
                query += " ac_passenger_count, "
                query += " ac_sale_price_display_flag, ac_airframe_tot_hrs, "
                query += " ac_ser_no_sort, ac_id, ac_forsale_flag,journ_id, journ_subcategory_code, "
                query += " ac_list_date, "
                query += " journ_customer_note "
                query += " From Aircraft_Flat with (NOLOCK)"
                query += " inner join Journal with (NOLOCK) on journ_id = ac_journ_id and ac_id = journ_ac_id"
                query += " LEFT outer join Aircraft_Features_Flat on ac_id = afeat_ac_id and ac_journ_id = afeat_journ_id"
                query += " where  journ_subcat_code_part1='WS'"
                query += " AND journ_date >= '01/01/" & Year(DateAdd(DateInterval.Year, -3, Now())) & "' "
                query += " AND journ_internal_trans_flag='N' "
                query += " and journ_subcat_code_part3 NOT IN ('DB','DS','FI','FY','IT','MF','RE','CC','LS', 'RM')"

                query += clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(HttpContext.Current.Session.Item("localSubscription"), False, True)


                If Not String.IsNullOrEmpty(variantListString) Then
                    query += " and amod_id in (" & amod_id & "," & variantListString & ")"
                Else
                    query += " and amod_id = @amodID"
                End If



                If idList <> "" Then
                    query += " and journ_id in (" & idList & ") "
                End If

                If pass_num = 1 Then
                    query += " order by ac_mfr_year asc"
                ElseIf pass_num = 2 Then
                    query += " order by ac_mfr_year desc"
                ElseIf pass_num = 3 Then
                    query += " order by journ_date desc"
                End If


                clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, query.ToString)

                Dim SqlCommand As New SqlClient.SqlCommand(query, SqlConn)
                SqlCommand.Parameters.AddWithValue("amodID", amod_id)
                SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

                Try
                    TempTable.Load(SqlReader)
                Catch constrExc As System.Data.ConstraintException
                    Dim rowsErr As System.Data.DataRow() = TempTable.GetErrors()
                End Try

                SqlCommand.Dispose()
                SqlCommand = Nothing
            End If



            Return TempTable
        Catch ex As Exception
            GetTransactionAircraftStartingTable = Nothing
            'Me.class_error = "Error in GetAircraftStartingTable(ByVal amod_id As Long) As DataTable SQL VERSION: " & ex.Message
        Finally
            SqlReader = Nothing

            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing
        End Try

    End Function
    Private Sub GrabCurrentModelInformation(ByVal CurrentAircraftTable As DataTable, ByVal pass_num As Long)
        If Not IsNothing(CurrentAircraftTable) Then
            If CurrentAircraftTable.Rows.Count > 0 Then
                modelAirframeTypeCode.Text = CurrentAircraftTable.Rows(0).Item("amod_airframe_type_code")
                ModelTypeCode.Text = CurrentAircraftTable.Rows(0).Item("amod_type_code")
                ModelWeightClass.Text = CurrentAircraftTable.Rows(0).Item("amod_weight_class")

                If pass_num = 1 Then
                    If year_start.Text = "" Then
                        If Not IsDBNull(CurrentAircraftTable.Rows(0).Item("ac_mfr_year")) Then
                            If Trim(CurrentAircraftTable.Rows(0).Item("ac_mfr_year")) <> "" Then
                                year_start_mms = CurrentAircraftTable.Rows(0).Item("ac_mfr_year")
                            End If
                        End If
                    End If
                End If

                If pass_num = 2 Then
                    If year_end.Text = "" Then
                        If Not IsDBNull(CurrentAircraftTable.Rows(0).Item("ac_mfr_year")) Then
                            If Trim(CurrentAircraftTable.Rows(0).Item("ac_mfr_year")) <> "" Then
                                year_end_mms = CurrentAircraftTable.Rows(0).Item("ac_mfr_year")
                            End If
                        End If
                    End If
                End If

            End If
        End If
    End Sub

    Public Sub NEW_CREATE_PDF_SPEC_PAGE(ByVal page_name As String, ByRef htmlOut As StringBuilder, ByVal amod_id As Long)

        Dim page_total As Integer = 0
        Dim chart_text As String = ""
        Dim html_for_google_graph As String = ""

        Try


            If Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CRM Then
                NEW_CRMViewActive = True
            End If

            If made_first_page = False Then
            Else
                htmlOut.Append(comp_functions.NEW_Insert_Page_Break_PDF(0, WD.SelectedValue))
            End If

            NEW_PDF_AMOD_ID = amod_id

            htmlOut.Append(temp_pdf_header)
            made_first_page = True


            If bWordReport = True Then
                htmlOut.Append("<table width='" & word_width & "' align='center' cellpadding='3'>")
            Else
                htmlOut.Append("<table width='" & pdf_html_width & "' align='center' cellpadding='3'>")
            End If



            If Trim(page_name) = "cover" Then
                If Me.CP.Checked Then
                    htmlOut.Append(NEW_Build_PDF_Cover(False))
                    page_total = page_total + 1
                    made_first_page = True
                End If
            End If

            If Trim(page_name) = "ownership_status" Then

                chart_text = ""
                If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = False Then
                    If Me.MMS_CHARTS.Checked Then

                        page_total = page_total + 1
                        made_first_page = True
                        Me.AVG_PRICE_MONTH.Titles.Add(display_avg_price_by_month_graph(NEW_PDF_AMOD_ID, AVG_PRICE_MONTH, days, localCriteria.ViewCriteriaTimeSpan, localCriteria, ""))
                        Me.FOR_SALE.Titles.Add(display_for_sale_by_month_graph(NEW_PDF_AMOD_ID, FOR_SALE, days, localCriteria.ViewCriteriaTimeSpan, localCriteria, ""))
                        Me.PER_MONTH.Titles.Add(display_sold_per_month_graph(False, False, amod_id, PER_MONTH, localCriteria.ViewCriteriaTimeSpan, False, ""))
                        Me.AVG_DAYS_ON.Titles.Add(display_average_days_on_market_graph(NEW_PDF_AMOD_ID, AVG_DAYS_ON, days, localCriteria.ViewCriteriaTimeSpan))


                        Me.AVG_PRICE_MONTH.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                        Me.AVG_PRICE_MONTH.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + NEW_PDF_AMOD_ID.ToString + "_AVG_PRICE_MONTH.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
                        Me.FOR_SALE.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + NEW_PDF_AMOD_ID.ToString + "_FOR_SALE.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
                        Me.PER_MONTH.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + NEW_PDF_AMOD_ID.ToString + "_PER_MONTH.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
                        Me.AVG_DAYS_ON.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + NEW_PDF_AMOD_ID.ToString + "_AVG_DAYS_ON.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)




                        'If Trim(html_for_google_graph) <> "" Then
                        '  market_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
                        '  market_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
                        '  market_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
                        '  market_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
                        '  market_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim

                        '  localCriteria.ViewCriteriaAmodID = amod_id
                        '  localCriteria.ViewCriteriaTimeSpan = 6

                        '  market_functions.views_display_avg_price_by_month_graph(localCriteria, Me.AVG_PRICE_MONTH, html_for_google_graph, False)
                        '  DisplayFunctions.load_google_chart(graph_panel, html_for_google_graph, "", "Average Asking Price ($k)", "chart_div_tab1", 950, 550, "POINTS", 1, "", Me.Page, Me.graph_update_panel, False, True, True, False, False, False, False, False, False, False, 0, "", png2.ClientID)

                        ' chart_text = chart_text & (Me.png2.InnerHtml)
                        'End If

                        chart_text = ""
                        chart_text = chart_text & ("<tr><td valign='top' align='center' colspan='10'>")
                        chart_text = chart_text & ("<font class='" & Session("FONT_CLASS_HEADER") & "'>" & real_make_model_name & " Trends</font>" & vbCrLf)
                        chart_text = chart_text & ("</td></tr>")


                        'ImageLocation(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" + NEW_PDF_AMOD_ID.tostring + "_AVG_PRICE_MONTH.jpg").
                        chart_text = chart_text & ("<tr><td valign='top' align='center' class='Performance_Specs_Left_TD_1' colspan='12'>")

                        If InStr(HttpContext.Current.Session.Item("jetnetFullHostName").ToString.Trim, "jetnetevo") = 0 Or InStr(HttpContext.Current.Session.Item("jetnetFullHostName").ToString.Trim, "testjetnetevolution") > 0 Then
                            If InStr(HttpContext.Current.Session.Item("jetnetFullHostName").ToString, "http://") > 0 Then
                                chart_text = chart_text & ("<img src='" & HttpContext.Current.Session.Item("jetnetFullHostName").ToString & "/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + NEW_PDF_AMOD_ID.ToString + "_AVG_PRICE_MONTH.jpg'>")
                                chart_text = chart_text & ("&nbsp;<img src='" & HttpContext.Current.Session.Item("jetnetFullHostName").ToString & "/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + NEW_PDF_AMOD_ID.ToString + "_FOR_SALE.jpg'>")
                                chart_text = chart_text & ("</td></tr><tr><td colspan='12' align='center'>")
                                chart_text = chart_text & ("<img src='" & HttpContext.Current.Session.Item("jetnetFullHostName").ToString & "/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + NEW_PDF_AMOD_ID.ToString + "_PER_MONTH.jpg'>")
                                chart_text = chart_text & ("&nbsp;<img src='" & HttpContext.Current.Session.Item("jetnetFullHostName").ToString & "/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + NEW_PDF_AMOD_ID.ToString + "_AVG_DAYS_ON.jpg'>")
                            Else
                                chart_text = chart_text & ("<img src='http://" & HttpContext.Current.Session.Item("jetnetFullHostName").ToString & "/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + NEW_PDF_AMOD_ID.ToString + "_AVG_PRICE_MONTH.jpg'>")
                                chart_text = chart_text & ("&nbsp;<img src='http://" & HttpContext.Current.Session.Item("jetnetFullHostName").ToString & "/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + NEW_PDF_AMOD_ID.ToString + "_FOR_SALE.jpg'>")
                                chart_text = chart_text & ("</td></tr><tr><td colspan='12' align='center'>")
                                chart_text = chart_text & ("<img src='http://" & HttpContext.Current.Session.Item("jetnetFullHostName").ToString & "/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + NEW_PDF_AMOD_ID.ToString + "_PER_MONTH.jpg'>")
                                chart_text = chart_text & ("&nbsp;<img src='http://" & HttpContext.Current.Session.Item("jetnetFullHostName").ToString & "/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + NEW_PDF_AMOD_ID.ToString + "_AVG_DAYS_ON.jpg'>")
                            End If
                        Else
                            chart_text = chart_text & ("<img src='http://www.jetnetevolution.com/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + NEW_PDF_AMOD_ID.ToString + "_AVG_PRICE_MONTH.jpg'>")
                            chart_text = chart_text & ("&nbsp;<img src='http://www.jetnetevolution.com/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + NEW_PDF_AMOD_ID.ToString + "_FOR_SALE.jpg'>")
                            chart_text = chart_text & ("</td></tr><tr><td colspan='12' align='center'>")
                            chart_text = chart_text & ("<img src='http://www.jetnetevolution.com/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + NEW_PDF_AMOD_ID.ToString + "_PER_MONTH.jpg'>")
                            chart_text = chart_text & ("&nbsp;<img src='http://www.jetnetevolution.com/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + NEW_PDF_AMOD_ID.ToString + "_AVG_DAYS_ON.jpg'>")
                        End If

                        chart_text = chart_text & ("</td></tr>")
                    End If
                End If



                If MMS_FMS.Checked Then
                    page_total = page_total + 1
                    made_first_page = True

                    Dim Build_FleetMarketSummary_text As String = ""
                    Dim GetMarketStatus As String = ""
                    Dim ClientIDSToExclude As String = ""

                    If NEW_CRMViewActive Then
                        crmViewDataLayer.Combined_views_display_fleet_market_summary(localCriteria, Build_FleetMarketSummary_text, GetMarketStatus, localdatalayer, ClientIDSToExclude, True, False, 0, 0, 0)

                        htmlOut.Append(Build_FleetMarketSummary_text)

                        htmlOut.Append(GetMarketStatus)
                    Else
                        Build_FleetMarketSummary_text = NEW_Build_FleetMarketSummary(NEW_PDF_AMOD_ID, False, real_make_model_name, "", "N", "", localCriteria)


                        Build_FleetMarketSummary_text = Replace(Build_FleetMarketSummary_text, "width='32%'>", ">&nbsp;&nbsp;</td><td align='right' valign='top' width='30%'>")

                        htmlOut.Append(Build_FleetMarketSummary_text)
                        Build_FleetMarketSummary_text = ""
                    End If
                End If

                If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = False Then
                    If Trim(chart_text) <> "" Then
                        htmlOut.Append(comp_functions.NEW_Insert_Page_Break_PDF(0, WD.SelectedValue))

                        htmlOut.Append(temp_pdf_header)

                        If bWordReport = True Then
                            htmlOut.Append("<table width='" & word_width & "' align='center' cellpadding='3'>")
                        Else
                            htmlOut.Append("<table width='" & pdf_html_width & "' align='center' cellpadding='3'>")
                        End If

                        htmlOut.Append(chart_text)
                    End If
                End If
            End If

            If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = False Then
                If Trim(page_name) = "ac_forsale_byyear" Then
                    If Me.MMS_STAT.Checked = True Then
                        htmlOut.Append(NEW_aircraft_sales_by_year(NEW_PDF_AMOD_ID))
                        htmlOut.Append("</td></tr></table>")
                        made_first_page = True
                    End If
                End If
            End If


            If Trim(page_name) = "performance_specs_op_costs" Then

                If MMS_BPS.Checked Then
                    htmlOut.Append(New_Build_PerformanceSpecifications(False, "", False, "", "", NEW_PDF_AMOD_ID))
                    made_first_page = True
                End If

                If MMS_BPS.Checked And MMS_BOC.Checked Then
                    htmlOut.Append("<tr class='" & Session("ROW_CLASS_BOTTOM") & "' valign='top'><td colspan='14'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td></tr>")
                    htmlOut.Append("<tr valign='top'><td colspan='14'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></td></tr>")
                End If

                If MMS_OP_COSTS_2.Checked Then  ' changed from MMS_BOC
                    htmlOut.Append(New_Build_OperatingCosts("", NEW_PDF_AMOD_ID))
                    made_first_page = True
                End If

            End If



            If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = False Then
                If Trim(page_name) = "for_sale" Then
                    If MMS_BAFS.Checked Then
                        page_total = page_total + 1

                        Dim temp_ac_for_sale As String = ""
                        If NEW_CRMViewActive Then
                            crmViewDataLayer.views_display_aircraft_forsale(localCriteria, temp_ac_for_sale, False, localdatalayer, True, "", False, Nothing, 0, 0, "", 28, "", True, "", "", "", "", "", "", "")
                            made_first_page = True
                            htmlOut.Append(temp_ac_for_sale)
                        Else
                            htmlOut.Append(NEW_Build_AircraftForSale(NEW_PDF_AMOD_ID, "", False, "", "", "", "", "", "", "", "", "", "", "", "", "", "", 1))
                        End If

                    End If
                End If
            End If


            If Trim(page_name) = "recent_retail" Then
                If MMS_BRRS.Checked Then
                    page_total = page_total + 1
                    If NEW_CRMViewActive Then
                        Dim temp_table As New DataTable
                        Dim sRetailSales As String = ""
                        crmViewDataLayer.Combined_views_display_recent_retail_sales(localCriteria, sRetailSales, localdatalayer, NEW_CRMViewActive, False, temp_table, "N", "N", False, 0, 0, "", 0, 0, "", True, "")
                        made_first_page = True
                        htmlOut.Append(sRetailSales)
                    Else
                        htmlOut.Append(NEW_Build_RecentRetailSales(NEW_PDF_AMOD_ID, "", "", "", "", "", "", "", "", "", "", "", "", "", Nothing))
                    End If
                End If
            End If


            If Trim(page_name) = "upgrade" Then
                If Me.MMS_UP.Checked Then
                    page_total = page_total + 1
                    made_first_page = True
                    htmlOut.Append(NEW_Build_PDF_Upgrade(NEW_PDF_AMOD_ID, real_make_model_name)) '& Build_PDF_Template_Footer()

                    If Me.MMS_AA.Checked Then
                        htmlOut.Append("</table>")
                        htmlOut.Append(comp_functions.NEW_Insert_Page_Break_PDF(0, WD.SelectedValue))
                        htmlOut.Append(temp_pdf_header)

                        If bWordReport = True Then
                            htmlOut.Append("<table width='" & word_width & "' align='center'>")
                        Else
                            htmlOut.Append("<table width='" & pdf_html_width & "' align='center'>")
                        End If

                        htmlOut.Append(NEW_Show_Average_Year(NEW_PDF_AMOD_ID, localCriteria))

                        Me.PER_MONTH.Titles.Clear()
                        Me.PER_MONTH.Titles.Add(NEW_display_by_mft_year(NEW_PDF_AMOD_ID, ""))
                        Me.PER_MONTH.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + NEW_PDF_AMOD_ID.ToString + "_PER_MONTH_AGE.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)

                        chart_text = ""
                        If InStr(HttpContext.Current.Session.Item("jetnetFullHostName").ToString.Trim, "jetnetevo") = 0 Or InStr(HttpContext.Current.Session.Item("jetnetFullHostName").ToString.Trim, "testjetnetevolution") > 0 Then
                            If InStr(HttpContext.Current.Session.Item("jetnetFullHostName").ToString, "http://") > 0 Then
                                chart_text = chart_text & ("<tr><td align='center'>&nbsp;</td></tr><tr><td align='center'><br/><br/>&nbsp;</td></tr><tr><td align='center'><img src='" & HttpContext.Current.Session.Item("jetnetFullHostName").ToString & "/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + NEW_PDF_AMOD_ID.ToString + "_PER_MONTH_AGE.jpg'></td></tr>")
                            Else
                                chart_text = chart_text & ("<tr><td align='center'>&nbsp;</td></tr><tr><td align='center'><br/><br/>&nbsp;</td></tr><tr><td align='center'><img src='http://" & HttpContext.Current.Session.Item("jetnetFullHostName").ToString & "/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + NEW_PDF_AMOD_ID.ToString + "_PER_MONTH_AGE.jpg'></td></tr>")
                            End If
                        Else
                            chart_text = chart_text & ("<tr><td align='center'>&nbsp;</td></tr><tr><td align='center'><br/><br/>&nbsp;</td></tr><tr><td align='center'><img src='http://www.jetnetevolution.com/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + NEW_PDF_AMOD_ID.ToString + "_PER_MONTH_AGE.jpg'></td></tr>")
                        End If

                        htmlOut.Append(chart_text)
                    End If
                Else
                    If Me.MMS_AA.Checked Then
                        made_first_page = True
                        If bWordReport = True Then
                            htmlOut.Append("<table width='" & word_width & "' align='center'>")
                        Else
                            htmlOut.Append("<table width='" & pdf_html_width & "' align='center'>")
                        End If
                        htmlOut.Append(NEW_Show_Average_Year(NEW_PDF_AMOD_ID, localCriteria))

                        Me.PER_MONTH.Titles.Clear()
                        Me.PER_MONTH.Titles.Add(NEW_display_by_mft_year(NEW_PDF_AMOD_ID, ""))
                        Me.PER_MONTH.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + NEW_PDF_AMOD_ID.ToString + "_PER_MONTH.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)

                        chart_text = ""
                        If InStr(HttpContext.Current.Session.Item("jetnetFullHostName").ToString.Trim, "jetnetevo") = 0 Or InStr(HttpContext.Current.Session.Item("jetnetFullHostName").ToString.Trim, "testjetnetevolution") > 0 Then
                            If InStr(HttpContext.Current.Session.Item("jetnetFullHostName").ToString, "http://") > 0 Then
                                chart_text = chart_text & ("<tr><td align='center'>&nbsp;</td></tr><tr><td align='center'><br/><br/>&nbsp;</td></tr><tr><td align='center'><img src='" & HttpContext.Current.Session.Item("jetnetFullHostName").ToString & "/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + NEW_PDF_AMOD_ID.ToString + "_PER_MONTH.jpg'></td></tr>")
                            Else
                                chart_text = chart_text & ("<tr><td align='center'>&nbsp;</td></tr><tr><td align='center'><br/><br/>&nbsp;</td></tr><tr><td align='center'><img src='http://" & HttpContext.Current.Session.Item("jetnetFullHostName").ToString & "/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + NEW_PDF_AMOD_ID.ToString + "_PER_MONTH.jpg'></td></tr>")
                            End If
                        Else
                            chart_text = chart_text & ("<tr><td align='center'>&nbsp;</td></tr><tr><td align='center'><br/><br/>&nbsp;</td></tr><tr><td align='center'><img src='http://www.jetnetevolution.com/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + NEW_PDF_AMOD_ID.ToString + "_PER_MONTH.jpg'></td></tr>")
                        End If

                        htmlOut.Append(chart_text)
                    End If
                End If
            End If

            If Trim(page_name) = "recent_market" Then
                If MMS_BRMA.Checked And MMS_BRMA.Visible = True Then
                    page_total = page_total + 1
                    ' call the Recent Market Activity
                    htmlOut.Append(NEW_Build_RecentMarketActivity(NEW_PDF_AMOD_ID, ""))
                    made_first_page = True
                End If
            End If

            If Trim(page_name) = "display_wanteds" Then
                If Me.CRM_Wanteds.Checked And Me.CRM_Wanteds.Visible = True Then

                    Dim htmlModelWanteds As String = ""
                    If NEW_CRMViewActive Then
                        crmViewDataLayer.Combined_views_display_model_wanteds(localCriteria, htmlModelWanteds, localdatalayer, False)
                        made_first_page = True
                    Else
                        NEW_views_display_model_wanteds(localCriteria, htmlModelWanteds) ' todo 
                    End If
                    htmlOut.Append(htmlModelWanteds)
                End If
            End If





            htmlOut.Append("</table>")

            ' comp_functions.create_value_with_label("Damage History", "Y", True, True, Counter_For_PDF, spacer_width)

        Catch ex As Exception

        End Try

    End Sub


    Public Sub NEW_views_display_model_wanteds(ByRef searchCriteria As viewSelectionCriteriaClass, ByRef out_htmlString As String)

        Dim htmlOut As New StringBuilder
        Dim results_table As New DataTable
        Dim toggleRowColor As Boolean = False

        Dim fAmwant_listed_date As String = ""
        Dim fInterested_party As String = ""
        Dim fAmwant_start_year As String = ""
        Dim fAmwant_end_year As String = ""
        Dim fAmwant_notes As String = ""
        Dim fAmwant_id As Long = 0
        Dim fComp_id As Long = 0

        Try

            '   htmlOut.Append("<table border='0' cellpadding='3' cellspacing='0' align='center'>")

            results_table = localdatalayer.get_model_wanteds_info(searchCriteria, False)

            If Not IsNothing(results_table) Then


                htmlOut.Append("<tr><td valign='top' align='center' colspan='7'><font class='" & Session("FONT_CLASS_HEADER") & "'>" & real_make_model_name & " WANTED(s) <em>(" + results_table.Rows.Count.ToString + ")</font> </td></tr><tr><td align='center' colspan='6'>&nbsp;</td></tr>" & vbCrLf) '<em>(last 20 events)</em>

                htmlOut.Append("<tr><td align=""center"">")
                htmlOut.Append("<table  align='center' border='1' id='forSaleInnerTable'  bordercolor='lightgrey' cellpadding='6' cellspacing='0' width='100%'>")
                htmlOut.Append("<tr><td class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Date:</strong></td><td class='table_specs' nowrap='nowrap'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Interested Party</font></td><td class='table_specs'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Description</font></td></tr>")




                If results_table.Rows.Count > 0 Then


                    For Each r As DataRow In results_table.Rows


                        If Not IsDBNull(r("amwant_listed_date")) Then
                            fAmwant_listed_date = r.Item("amwant_listed_date").ToString.Trim
                        Else
                            fAmwant_listed_date = ""
                        End If

                        If Not IsDBNull(r("interested_party")) Then
                            fInterested_party = r.Item("interested_party").ToString.Trim
                        Else
                            fInterested_party = ""
                        End If

                        If Not IsDBNull(r("amwant_start_year")) Then
                            fAmwant_start_year = r.Item("amwant_start_year").ToString.Trim
                        Else
                            fAmwant_start_year = ""
                        End If

                        If Not IsDBNull(r("amwant_end_year")) Then
                            fAmwant_end_year = r.Item("amwant_end_year").ToString.Trim
                        Else
                            fAmwant_end_year = ""
                        End If

                        If Not IsDBNull(r("amwant_notes")) Then
                            fAmwant_notes = r.Item("amwant_notes").ToString.Trim
                        Else
                            fAmwant_notes = ""
                        End If

                        If Not IsDBNull(r("amwant_id")) Then
                            fAmwant_id = CLng(r.Item("amwant_id").ToString)
                        Else
                            fAmwant_id = 0
                        End If

                        If Not IsDBNull(r("comp_id")) Then
                            fComp_id = CLng(r.Item("comp_id").ToString)
                        Else
                            fComp_id = 0
                        End If

                        If Not toggleRowColor Then
                            htmlOut.Append("<tr class='alt_row'>")
                            toggleRowColor = True
                        Else
                            htmlOut.Append("<tr bgcolor='white'>")
                            toggleRowColor = False
                        End If


                        ' htmlOut.Append("<td align='left' valign='top' class='seperator'><img src='http://www.jetnetevolution.com/images/ch_red.jpg' class='bullet' alt='amwantid : " + r.Item("amwant_id").ToString + "' /></td>")
                        htmlOut.Append("<td align='left' valign='top' class='seperator'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" + FormatDateTime(fAmwant_listed_date.ToString, DateFormat.ShortDate) + "</font></a></td>")
                        htmlOut.Append("<td align='left' valign='top' class='seperator' width='200'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" + fInterested_party.Trim + "</font></a></td>")

                        htmlOut.Append("<td align='left' valign='top' class='seperator'>")
                        htmlOut.Append("<font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>")
                        If Not String.IsNullOrEmpty(fAmwant_start_year) And Not String.IsNullOrEmpty(fAmwant_end_year) Then
                            htmlOut.Append("Year : " + fAmwant_start_year.Trim)
                            htmlOut.Append(" - " + fAmwant_end_year.Trim)
                        ElseIf Not String.IsNullOrEmpty(fAmwant_start_year) And String.IsNullOrEmpty(fAmwant_end_year) Then
                            htmlOut.Append("Year : " + fAmwant_start_year.Trim)
                        ElseIf String.IsNullOrEmpty(fAmwant_start_year) And Not String.IsNullOrEmpty(fAmwant_end_year) Then
                            htmlOut.Append("End Year : " + fAmwant_end_year.Trim)
                        ElseIf String.IsNullOrEmpty(fAmwant_start_year) And String.IsNullOrEmpty(fAmwant_end_year) Then
                            htmlOut.Append("Year : Open")
                        End If

                        If Not String.IsNullOrEmpty(fAmwant_notes) Then
                            htmlOut.Append(" " + Left(fAmwant_notes, 250))
                        End If

                        htmlOut.Append("</font></td></tr>")

                    Next

                    htmlOut.Append("</table>")

                Else
                    htmlOut.Append("<font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>No Wanteds at this time, for this Make/Model ...</font>")
                End If

            Else
                htmlOut.Append("<font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>No Wanteds at this time, for this Make/Model ...</font>")
            End If

            htmlOut.Append("</td></tr>" & vbCrLf)


        Catch ex As Exception

            '  aError = "Error in views_display_model_wanteds(ByRef searchCriteria As viewSelectionCriteriaClass, ByVal in_sMakeName As String, ByRef out_Build_FleetMarketSummary_text As String, ByRef out_GetMarketStatus As String, ByRef out_string_for_op_percentage As String, ByRef out_avg_days_on_market As Integer) " + ex.Message

        Finally

        End Try

        'return resulting html string
        out_htmlString = htmlOut.ToString
        htmlOut = Nothing
        results_table = Nothing

    End Sub
    Function NEW_Build_PDF_Cover(ByVal is_from_values As Boolean) As String
        Dim imgFolder As String = HttpContext.Current.Server.MapPath(Session.Item("ModelPicturesFolderVirtualPath"))
        '  Dim imgDisplayFolder As String = Application.Item("crmClientSiteData").ClientFullHostName & Session.Item("ModelPicturesFolderVirtualPath")
        Dim imgDisplayFolder As String = Session.Item("ModelPicturesFolderVirtualPath")
        Dim imgFileName As String = NEW_PDF_AMOD_ID.ToString.Trim + ".jpg"
        NEW_Build_PDF_Cover = ""


        Try



            If is_from_values = True Then
                NEW_Build_PDF_Cover &= "<tr><td align='center' colspan='10'><font class='" & Session("FONT_CLASS_HEADER") & "'>"
                NEW_Build_PDF_Cover &= "" & real_make_model_name & ""
                NEW_Build_PDF_Cover &= "</td></tr>"

                NEW_Build_PDF_Cover &= "<tr><td align='center' colspan='10'>"
                NEW_Build_PDF_Cover &= NEW_build_model_spec_first_picture(imgFileName, is_from_values)
                NEW_Build_PDF_Cover &= "</td></tr>"
            Else
                NEW_Build_PDF_Cover &= "<tr><td align='center'><font class='" & Session("FONT_CLASS_HEADER") & "'>"
                NEW_Build_PDF_Cover &= "" & real_make_model_name & ""
                NEW_Build_PDF_Cover &= "</td></tr>"

                NEW_Build_PDF_Cover &= "<tr><td align='center'>"
                NEW_Build_PDF_Cover &= NEW_build_model_spec_first_picture(imgFileName, is_from_values)
                NEW_Build_PDF_Cover &= "</td></tr>"

                NEW_Build_PDF_Cover &= "<tr><td align='center'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                NEW_Build_PDF_Cover &= Get_Aircraft_Model_Description(NEW_PDF_AMOD_ID)
                NEW_Build_PDF_Cover &= "</td></tr>"

                NEW_Build_PDF_Cover &= "<tr><td align='center'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>"
                NEW_Build_PDF_Cover &= "Report Date: " & System.DateTime.Now.ToShortDateString
                NEW_Build_PDF_Cover &= "</td></tr>"
            End If





        Catch ex As Exception

        End Try

    End Function
    Public Function NEW_build_model_spec_first_picture(ByVal imgFileName As String, ByVal is_from_values As Boolean, Optional ByVal force_width As Integer = 0) As String
        'LAST SECTION  IN COL 1- PICTURE -----------------------------------------------------------------------------------------------------------------------------------
        Dim outString As String = ""

        ' This is right side column, should start with an open table already in td
        Dim fAcpic_image_type As String = ""
        Dim fAcpic_id As Integer = 0
        Dim pic_seq_num As Integer = 0
        Dim something_shown As Boolean = False
        Dim pic_size As Integer = 310
        Dim full_image_path As String = ""

        Dim fApicSubject As String = ""
        Dim pic_height_size As Integer = 850 ' was 310
        Dim pic_width As Integer = 610

        Dim imgDisplayFolder As String = ""

        ' If HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL Or HttpContext.Current.Session.Item("jetnetWebHostType") = eWebHostTypes.CRM Then
        '   imgDisplayFolder = "http://www.jetnetevolution.com/pictures/aircraft"
        ' Else
        If Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CRM Then
            imgDisplayFolder = Application.Item("crmClientSiteData").ClientFullHostName & HttpContext.Current.Session.Item("ModelPicturesFolderVirtualPath")
        Else
            imgDisplayFolder = "http://www.jetnetevolution.com/" & HttpContext.Current.Session.Item("ModelPicturesFolderVirtualPath")
        End If

        ' End If


        Dim htmlOutput As String = ""
        Dim div_by As Double = 0
        Dim Query As String : Query = ""

        Dim ac_image_file As String = ""
        Dim temp_height As Integer = 0
        Dim temp_width As Integer = 0
        Dim zimage2 As System.Drawing.Image
        Dim desired_width As Integer = 950
        Dim temp_percent1 As Double = 0.0
        Dim temp_percent2 As Double = 0.0


        Try


            If is_from_values = True Then
                desired_width = 400
            End If


            If force_width > 0 Then
                desired_width = force_width
            End If


            imgFileName = imgFileName

            full_image_path = imgDisplayFolder.Trim + "/" + imgFileName.Trim

            ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
            ' setup the path for the pictures based on which site is running
            ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

            Try

                ac_image_file = HttpContext.Current.Server.MapPath("pictures\model\") & imgFileName
                zimage2 = System.Drawing.Image.FromFile(ac_image_file)
                temp_width = zimage2.Width
                temp_height = zimage2.Height

                ' if the image is wider then the desired image width, then shirnk down to size.
                'if width > height, then shrink the width down 
                If temp_width > temp_height Then
                    If temp_width > desired_width Then
                        temp_percent1 = CDbl(CDbl(desired_width) / CDbl(temp_width))
                        temp_width = CDbl(CDbl(temp_width) * CDbl(temp_percent1))
                        temp_height = CDbl(CDbl(temp_height) * CDbl(temp_percent1))
                    End If
                ElseIf temp_height > temp_width Then
                    ' if taller than it is wide, then as long as not too wide, its ok till height check
                    If temp_width > desired_width Then
                        temp_percent1 = CDbl(CDbl(desired_width) / CDbl(temp_width))
                        temp_width = CDbl(CDbl(temp_width) * CDbl(temp_percent1))
                        temp_height = CDbl(CDbl(temp_height) * CDbl(temp_percent1))
                    End If
                End If

                ' make sure not too tall for a given page size
                If temp_height > pic_height_size Then
                    temp_percent1 = CDbl(CDbl(pic_height_size) / CDbl(temp_height))
                    temp_width = CDbl(CDbl(temp_width) * CDbl(temp_percent1))
                    temp_height = CDbl(CDbl(temp_height) * CDbl(temp_percent1))
                End If

                If bWordReport Then
                    outString += "<img Title='" + fApicSubject.Trim + "' alt='" + fApicSubject.Trim + "' src='" + full_image_path + "' width='" + temp_width.ToString + "' height='" + temp_height.ToString + "' /><br /><br />"
                Else
                    outString += "<img Title='" + fApicSubject.Trim + "' alt='" + fApicSubject.Trim + "' src='" + full_image_path + "' width='" + temp_width.ToString + "'  /><br /><br />"
                End If
            Catch ex As Exception

                If bWordReport Then
                    pic_width = 250
                    pic_height_size = 250
                End If

                outString += "<img Title='" + fApicSubject.Trim + "' alt='" + fApicSubject.Trim + "' src='" + full_image_path + "' width='" + pic_width.ToString + "' /><br /><br />"
            End Try

            something_shown = True

            NEW_build_model_spec_first_picture = outString

        Catch ex As Exception

        End Try

        Return outString

    End Function
    Function NEW_aircraft_sales_by_year(ByVal amod_id As Integer) As String
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim adoRs As System.Data.SqlClient.SqlDataReader : adoRs = Nothing
        Dim adoRs2 As System.Data.SqlClient.SqlDataReader : adoRs2 = Nothing
        Dim Query As String : Query = ""
        Dim ac13_make As String = ""
        Dim ac13_model As String = ""
        NEW_aircraft_sales_by_year = ""
        Dim htmlOutput = ""
        Dim sUnknownString
        Dim rc As Integer = 1
        ' Dim aMaxDate As Date
        Dim first_time As Integer = 0
        Dim totals_row As String = ""
        Dim total_fleet As Integer = 0
        Dim total_fs As Integer = 0
        Dim percent_fs As Double = 0
        Dim average_asking As Integer = 0
        Dim high_asking As Integer = 0
        Dim low_asking As Integer = 0
        Dim average_asking_counter As Integer = 0
        Dim average_total_counter As Integer = 0
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim adoOwnerRs As New System.Data.SqlClient.SqlDataAdapter ': adoOwnerRs = Nothing 
        Dim Query2 As String = ""

        'Select Case Application.Item("webHostObject").evoWebHostType
        'Case eWebSiteTypes.LOCAL
        'SqlConn.ConnectionString = My.Settings.DEFAULT_LOCAL_MSSQL
        '  Case Else
        SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
        ' End Select

        SqlConn.Open()

        SqlCommand.Connection = SqlConn
        SqlCommand.CommandType = System.Data.CommandType.Text
        SqlCommand.CommandTimeout = 60
        SqlCommand.CommandText = Query
        sUnknownString = ""

        Try

            htmlOutput = htmlOutput & "<tr><TH class='th_title' align='center' colspan='11'><font class='" & Session("FONT_CLASS_HEADER") & "'>" & vbCrLf
            htmlOutput = htmlOutput & "<br>" & real_make_model_name & " For Sale Statistics By Year of MFR" & vbCrLf
            htmlOutput = htmlOutput & " - In Operation" & vbCrLf
            htmlOutput = htmlOutput & "</font></TH>" & vbCrLf
            'htmlOutput = htmlOutput & "<td class='th_title' colSpan='13'>&nbsp;</td>" & vbCrLf
            htmlOutput = htmlOutput & "</tr>" & vbCrLf

            htmlOutput = htmlOutput & "<tr><td width='100%'>"
            htmlOutput = htmlOutput & "<table cellspacing='0' cellpadding='6' border='1' bordercolor='lightgrey' align='center' width='100%'>"



            'Query = "SELECT ac13_make, ac13_model, ac13_year_mfr, ac13_all_total_fleet, ac13_all_for_sale, ac13_all_percent_for_sale, ac13_all_average_asking_price,"
            'Query = Query & " ac13_all_high_asking_price, ac13_all_low_asking_price, ac13_new_total_fleet, ac13_new_for_sale, ac13_new_percent_for_sale, ac13_new_average_asking_price,"
            'Query = Query & " ac13_new_high_asking_price, ac13_new_low_asking_price, ac13_used_total_fleet, ac13_used_for_sale, ac13_used_percent_for_sale,"
            'Query = Query & " ac13_used_average_asking_price, ac13_used_high_asking_price, ac13_used_low_asking_price"
            'Query = Query & " FROM Aircraft_13 WITH(NOLOCK)"
            'Query = Query & " WHERE (ac13_amod_id = " + amod_id.ToString + ") AND (ac13_start_date = '" & aMaxDate & "')"


            'Query = Query & " ORDER BY ac13_start_date DESC, ac13_year_mfr"


            Query = " select amod_make_name, amod_model_name, ac_mfr_year, COUNT(*) as ac13_all_total_fleet,  "
            Query = Query & "  sum(case when ac_forsale_flag = 'Y' then 1 else 0 end) as ac13_all_for_sale,"
            Query = Query & " (((sum(case when ac_forsale_flag = 'Y' then 1 else 0 end))*100)/COUNT(*)) as ac13_all_percent_for_sale,"
            Query = Query & " min(ac_asking_price)as ac13_all_low_asking_price, "
            Query = Query & " avg(ac_asking_price)as ac13_all_average_asking_price,"
            Query = Query & " max(ac_asking_price)as ac13_all_high_asking_price"
            Query = Query & " from Aircraft with (NOLOCK)  "
            Query = Query & "   inner join Aircraft_Model with (NOLOCK) on amod_id = ac_amod_id"
            Query = Query & "  where  ac_journ_id = 0 and ac_amod_id = " & amod_id & " and ac_lifecycle_stage = '3'"
            Query = Query & "  group by ac_mfr_year, amod_make_name, amod_model_name "
            Query = Query & "  order by ac_mfr_year asc "



            SqlCommand.CommandText = Query
            adoRs = SqlCommand.ExecuteReader()

            If (adoRs.HasRows) Then
                adoRs.Read()

                ac13_make = Server.HtmlEncode(adoRs("amod_make_name") & "/")
                ac13_model = Server.HtmlEncode(adoRs("amod_model_name")) & " "

                '  htmlOutput = htmlOutput & "<TR align='center'>" & vbCrLf
                ' htmlOutput = htmlOutput & "<td class='lightcyan' colSpan='3'></td>" & vbCrLf  
                '  htmlOutput = htmlOutput & "<TH class='th_title_details' colSpan='5'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>All Aircraft</font></TH>" & vbCrLf
                '   htmlOutput = htmlOutput & "<TH class='separateheader'>&nbsp;</TH>" & vbCrLf
                'htmlOutput = htmlOutput & "<td class='lightcyan' colSpan='6'>New Aircraft</td>" & vbCrLf
                '  htmlOutput = htmlOutput & "<TH class='separateheader'>&nbsp;</TH>" & vbCrLf
                'htmlOutput = htmlOutput & "<td class='th_title_details' colSpan='6'>Used Aircraft</td>" & vbCrLf
                '  htmlOutput = htmlOutput & "</TR>" & vbCrLf

                htmlOutput = htmlOutput & "<TR>" & vbCrLf
                htmlOutput = htmlOutput & "<TH class='th_title_details' align='center'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Year<br>Of Mfr</font></TH>" & vbCrLf
                '  htmlOutput = htmlOutput & "<td class='separateheader'>&nbsp;</td>" & vbCrLf
                htmlOutput = htmlOutput & "<TH class='th_title_details' align='center'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Total<BR>Fleet</font></TH>" & vbCrLf
                htmlOutput = htmlOutput & "<TH class='th_title_details' align='center'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Number<BR>For Sale</font></TH>" & vbCrLf
                htmlOutput = htmlOutput & "<TH class='th_title_details' align='center'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Percent<BR>For Sale</font></TH>" & vbCrLf
                htmlOutput = htmlOutput & "<TH class='th_title_details' align='center'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Low<BR>Asking<BR>Price</font></TH>" & vbCrLf
                htmlOutput = htmlOutput & "<TH class='th_title_details' align='center'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Average<BR>Asking<BR>Price</font></TH>" & vbCrLf
                htmlOutput = htmlOutput & "<TH class='th_title_details' align='center'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>High<BR>Asking<BR>Price</font></TH>" & vbCrLf

                htmlOutput = htmlOutput & "</TR>" & vbCrLf
                rc = 25
                htmlOutput = htmlOutput & "<TR>" & vbCrLf
                htmlOutput = htmlOutput & "<td class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac_mfr_year")) & " Year Of Manufacture' vAlign='center' noWrap align='center'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & Trim(adoRs("ac_mfr_year")) & "</font></td>" & vbCrLf


                If adoRs("ac13_all_total_fleet") = 0 Then
                    htmlOutput = htmlOutput & "<TD class='blankline' align='right' colSpan='6'>&nbsp;</TD>" & vbCrLf
                Else
                    htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac_mfr_year")) & " - Total Active Fleet - All Aircraft' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & adoRs("ac13_all_total_fleet") & "</font></TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac_mfr_year")) & " - Total Active Fleet For Sale - All Aircraft' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & adoRs("ac13_all_for_sale") & "</font></TD>" & vbCrLf
                    htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac_mfr_year")) & " - Percent Of Active Flag For Sale - All Aircrdaft' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(adoRs("ac13_all_percent_for_sale"), 2) & "%</font></TD>" & vbCrLf

                    total_fleet = total_fleet + adoRs("ac13_all_total_fleet")
                    total_fs = total_fs + adoRs("ac13_all_for_sale")

                    If IsDBNull(adoRs("ac13_all_low_asking_price")) Then
                        htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac_mfr_year")) & " - High Asking Price - All Aircraft' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></TD>" & vbCrLf
                    ElseIf adoRs("ac13_all_low_asking_price") = 0 Then
                        htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac_mfr_year")) & " - High Asking Price - All Aircraft' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></TD>" & vbCrLf
                    Else
                        htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac_mfr_year")) & " - Low Asking Price - All Aircraft' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>$" & FormatNumber(adoRs("ac13_all_low_asking_price"), 0) & "</font></TD>" & vbCrLf
                        If FormatNumber(adoRs("ac13_all_low_asking_price"), 0) < low_asking Then
                            low_asking = FormatNumber(adoRs("ac13_all_low_asking_price"), 0)
                        ElseIf (low_asking = 0) Then
                            low_asking = FormatNumber(adoRs("ac13_all_low_asking_price"), 0)
                        End If
                    End If

                    If IsDBNull(adoRs("ac13_all_average_asking_price")) Then
                        htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac_mfr_year")) & " - Average Asking Price - All Aircraft' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></TD>" & vbCrLf
                    ElseIf adoRs("ac13_all_average_asking_price") = 0 Then
                        htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac_mfr_year")) & " - Average Asking Price - All Aircraft' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></TD>" & vbCrLf
                    Else
                        htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac_mfr_year")) & " - Average Asking Price - All Aircraft' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>$" & FormatNumber(adoRs("ac13_all_average_asking_price"), 0) & "</font></TD>" & vbCrLf
                    End If

                    If IsDBNull(adoRs("ac13_all_high_asking_price")) Then
                        htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac_mfr_year")) & " - High Asking Price - All Aircraft' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></TD>" & vbCrLf
                    ElseIf adoRs("ac13_all_high_asking_price") = 0 Then
                        htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac_mfr_year")) & " - High Asking Price - All Aircraft' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></TD>" & vbCrLf
                    Else
                        htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac_mfr_year")) & " - High Asking Price - All Aircraft' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>$" & FormatNumber(adoRs("ac13_all_high_asking_price"), 0) & "</font></TD>" & vbCrLf
                        If FormatNumber(adoRs("ac13_all_high_asking_price"), 0) > high_asking Then
                            high_asking = FormatNumber(adoRs("ac13_all_high_asking_price"), 0)
                        End If
                    End If



                    htmlOutput = htmlOutput & "</tr>"

                End If

            End If
            Do While adoRs.Read

                htmlOutput = htmlOutput & "<tr>"

                If LCase(Trim(adoRs("ac_mfr_year"))) <> LCase("ALL") Then

                    'Response.write("MFR YR VAL " & trim(rs("ac13_year_mfr").Value) & "<br>")

                    htmlOutput = htmlOutput & "<td class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac_mfr_year")) & " Year Of Manufacture' vAlign='center' noWrap align='center'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & Trim(adoRs("ac_mfr_year")) & "</font></td>" & vbCrLf
                    '  htmlOutput = htmlOutput & "<td class='separateheader'>&nbsp;</td>" & vbCrLf

                    If IsDBNull(adoRs("ac13_all_total_fleet")) Then
                        htmlOutput = htmlOutput & "<TD class='blankline' align='right' colSpan='6'>&nbsp;</TD>" & vbCrLf
                    ElseIf adoRs("ac13_all_total_fleet") = 0 Then
                        htmlOutput = htmlOutput & "<TD class='blankline' align='right' colSpan='6'>&nbsp;</TD>" & vbCrLf
                    Else
                        htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac_mfr_year")) & " - Total Active Fleet - All Aircraft' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & adoRs("ac13_all_total_fleet") & "</font></TD>" & vbCrLf
                        htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac_mfr_year")) & " - Total Active Fleet For Sale - All Aircraft' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & adoRs("ac13_all_for_sale") & "</font></TD>" & vbCrLf

                        If Not IsDBNull(adoRs("ac13_all_percent_for_sale")) Then
                            htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac_mfr_year")) & " - Percent Of Active Flag For Sale - All Aircrdaft' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & FormatNumber(adoRs("ac13_all_percent_for_sale"), 2) & "%</font></TD>" & vbCrLf
                        Else
                            htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac_mfr_year")) & " - Percent Of Active Flag For Sale - All Aircrdaft' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & adoRs("ac13_all_percent_for_sale") & "%</font></TD>" & vbCrLf
                        End If


                        total_fleet = total_fleet + adoRs("ac13_all_total_fleet")
                        total_fs = total_fs + adoRs("ac13_all_for_sale")

                        If IsDBNull(adoRs("ac13_all_low_asking_price")) Then
                            htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac_mfr_year")) & " - High Asking Price - All Aircraft' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></TD>" & vbCrLf
                        ElseIf adoRs("ac13_all_low_asking_price") = 0 Then
                            htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac_mfr_year")) & " - High Asking Price - All Aircraft' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></TD>" & vbCrLf
                        Else
                            htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac_mfr_year")) & " - Low Asking Price - All Aircraft' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>$" & FormatNumber(adoRs("ac13_all_low_asking_price"), 0) & "</font></TD>" & vbCrLf
                            If FormatNumber(adoRs("ac13_all_low_asking_price"), 0) < low_asking Then
                                low_asking = FormatNumber(adoRs("ac13_all_low_asking_price"), 0)
                            ElseIf (low_asking = 0) Then
                                low_asking = FormatNumber(adoRs("ac13_all_low_asking_price"), 0)
                            End If
                        End If

                        If IsDBNull(adoRs("ac13_all_average_asking_price")) Then
                            htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac_mfr_year")) & " - Average Asking Price - All Aircraft' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></TD>" & vbCrLf
                        ElseIf adoRs("ac13_all_average_asking_price") = 0 Then
                            htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac_mfr_year")) & " - Average Asking Price - All Aircraft' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></TD>" & vbCrLf
                        Else
                            htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac_mfr_year")) & " - Average Asking Price - All Aircraft' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>$" & FormatNumber(adoRs("ac13_all_average_asking_price"), 0) & "</font></TD>" & vbCrLf
                        End If

                        If IsDBNull(adoRs("ac13_all_high_asking_price")) Then
                            htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac_mfr_year")) & " - High Asking Price - All Aircraft' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></TD>" & vbCrLf
                        ElseIf adoRs("ac13_all_high_asking_price") = 0 Then
                            htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac_mfr_year")) & " - High Asking Price - All Aircraft' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>&nbsp;</font></TD>" & vbCrLf
                        Else
                            htmlOutput = htmlOutput & "<TD class='beige2' title='" & ac13_make & ac13_model & Trim(adoRs("ac_mfr_year")) & " - High Asking Price - All Aircraft' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>$" & FormatNumber(adoRs("ac13_all_high_asking_price"), 0) & "</font></TD>" & vbCrLf
                            If FormatNumber(adoRs("ac13_all_high_asking_price"), 0) > high_asking Then
                                high_asking = FormatNumber(adoRs("ac13_all_high_asking_price"), 0)
                            End If
                        End If



                    End If
                    percent_fs = (total_fs / total_fleet) * 100
                    percent_fs = FormatNumber(percent_fs, 2)


                End If


                htmlOutput = htmlOutput & "</tr>"
            Loop

            adoRs.Close()

            Query2 = "select ac_journ_id, ac_asking_price, ac_amod_id, amod_id from Aircraft_Model, Aircraft where ac_amod_id = '" + amod_id.ToString + "' and ac_amod_id = amod_id and ac_journ_id = 0 and ac_asking_price > 0"
            SqlCommand.CommandText = Query2
            adoRs2 = SqlCommand.ExecuteReader() 'aDBconn.execute(Query) '

            If (adoRs2.HasRows) Then
                'adoRs.Read()
                Do While adoRs2.Read()
                    average_total_counter = average_total_counter + adoRs2("ac_asking_price")
                    average_asking_counter = average_asking_counter + 1
                Loop

                'adoRs.Close()
            Else
                adoRs2.Close()
            End If

            If average_total_counter > 0 And average_asking_counter > 0 Then
                average_asking = (average_total_counter / average_asking_counter)
            End If

            htmlOutput = htmlOutput & "<TR>" & vbCrLf
            htmlOutput = htmlOutput & "<TD><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>Totals: </font></TD>" & vbCrLf
            htmlOutput = htmlOutput & "<TD class='th_title_details' title='Total Active Fleet - All Aircraft' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>" & total_fleet & "</font></TD>" & vbCrLf
            htmlOutput = htmlOutput & "<TD class='th_title_details' title='Total Active Fleet For Sale - All Aircraft' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>" & total_fs & "</font></TD>" & vbCrLf
            htmlOutput = htmlOutput & "<TD class='th_title_details' title='Percent Of Active Flag For Sale - All Aircrdaft' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>" & FormatNumber(percent_fs, 2) & "%</font></TD>" & vbCrLf
            htmlOutput = htmlOutput & "<TD class='th_title_details' title='Low Asking Price - All Aircraft' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>$" & FormatNumber(low_asking, 0) & "</font></TD>" & vbCrLf
            htmlOutput = htmlOutput & "<TD class='th_title_details' title='Average Asking Price - New Aircraft' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>$" & FormatNumber(average_asking, 0) & "</font></TD>" & vbCrLf
            htmlOutput = htmlOutput & "<TD class='th_title_details' title='High Asking Price - All Aircraft' align='right'><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT_TITLE") & "'>$" & FormatNumber(high_asking, 0) & "</font></TD>" & vbCrLf
            htmlOutput = htmlOutput & "</TR>" & vbCrLf
            htmlOutput = htmlOutput & "</table>"
            '------------------------------------------------------------------- totals section

            htmlOutput = htmlOutput & "</td></tr>"
            NEW_aircraft_sales_by_year = htmlOutput


        Catch Sqlex As SqlClient.SqlException
            Response.Write(Sqlex.Message)
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function

    Function Build_Model_Market_Summary_PDF(ByVal amod_id, ByVal real_make_model_name, ByVal months) As String

        ' crate a string to hold the PDF output info
        Dim ViewToPDF As String = ""
        ' Dim create footer variables
        '--------------------------------- header variables
        Dim foot_space_cover As String = "130"
        Dim foot_space_market_summary As String = "380"
        Dim foot_space_Performance_Specs As String = "400"
        Dim foot_space_op_costs As String = "30"
        Dim foot_space_ac_for_sale As String = "390"
        Dim foot_space_recent_retail_sales As String = "370"
        Dim foot_space_market_activity As String = "380"
        Dim temp_ac_for_sale As String = ""
        Dim ClientIDSToExclude As String = ""
        Dim Build_FleetMarketSummary_text As String = ""
        Dim GetMarketStatus As String = ""
        Dim sRetailSales As String = ""
        Dim CRMViewActive As Boolean = False
        Dim htmlModelWanteds As String = ""
        Dim temp_table As New DataTable
        Dim days As Integer = 0
        Dim column As New DataColumn 'Column to Add Source to jetnet data.
        Dim column2 As New DataColumn 'Column to Add id to jetnet data. To match client side datatable 
        Dim column3 As New DataColumn 'Column to add take price to jetnet data (null)
        Dim column4 As New DataColumn
        Dim column5 As New DataColumn
        Dim logo_header As String = ""
        Dim market_functions As New market_model_functions


        column.DataType = System.Type.GetType("System.Double")
        column.DefaultValue = 0
        column.Unique = False
        column.ColumnName = "asking_price"
        temp_table.Columns.Add(column)

        column2.DataType = System.Type.GetType("System.Double")
        column2.DefaultValue = 0
        column2.Unique = False
        column2.ColumnName = "take_price"
        temp_table.Columns.Add(column2)

        column3.DataType = System.Type.GetType("System.Double")
        column3.DefaultValue = 0
        column3.AllowDBNull = True
        column3.Unique = False
        column3.ColumnName = "sold_price"
        temp_table.Columns.Add(column3)


        column4.DataType = System.Type.GetType("System.DateTime")
        column4.AllowDBNull = True
        column4.Unique = False
        column4.ColumnName = "date_of"
        temp_table.Columns.Add(column4)

        column5.DataType = System.Type.GetType("System.String")
        column5.AllowDBNull = True
        column5.Unique = False
        column5.ColumnName = "ac_details"
        temp_table.Columns.Add(column5)


        If Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CRM Then
            CRMViewActive = True
        End If

        If CRMViewActive Then
            localdatalayer = New viewsDataLayer
            localdatalayer.adminConnectStr = Application.Item("crmClientSiteData").AdminDatabaseConn
            localdatalayer.clientConnectStr = Session.Item("localPreferences").UserDatabaseConn
            localdatalayer.starConnectStr = Session.Item("localPreferences").STARDatabaseConn
            localdatalayer.serverConnectStr = Session.Item("localPreferences").ServerNotesDatabaseConn

            localCriteria.ViewCriteriaAmodID = amod_id
        Else
            localCriteria.ViewCriteriaAmodID = amod_id
        End If

        If Trim(Request("months")) <> "" Then
            localCriteria.ViewCriteriaTimeSpan = Trim(Request("months"))
        Else
            localCriteria.ViewCriteriaTimeSpan = 6
        End If
        '-----------------------------------
        '************************************************************************
        '* You'll need to add some logic later to determine what report to build
        '* Use a select case for the report type, for now just for PDF
        '************************************************************************

        If Not IsNothing(Request.Item("thecurrency")) Then
            If Not String.IsNullOrEmpty(Request.Item("thecurrency").ToString) Then
                Session.Item("localPreferences").DefaultCurrency = Request.Item("thecurrency").Trim
            End If
        End If


        If Not IsNothing(Request.Item("standardormetric")) Then
            If Not String.IsNullOrEmpty(Request.Item("standardormetric").ToString) Then
                Session.Item("localPreferences").UseStandardOrMetric = Request.Item("standardormetric").Trim.ToLower
            Else
                Session.Item("localPreferences").UseStandardOrMetric = "standard"
            End If
        Else
            Session.Item("localPreferences").UseStandardOrMetric = "standard"
        End If




        If Not IsNothing(Trim(Request("useStandardOrMetric"))) Then
            If Trim(Request("useStandardOrMetric")) <> "" Then
                If Trim(Request("useStandardOrMetric")) = "metric" Then
                    Session.Item("localPreferences").UseStandardOrMetric = Trim(Request("useStandardOrMetric"))
                    Session.Item("useMetricValues") = True
                    'Session.item("defaultCurrency") = 0
                Else
                    If Trim(Request("useStandardOrMetric")) = "standard" Then
                        Session.Item("localPreferences").UseStandardOrMetric = "standard" ' default chall 300
                        Session.Item("useMetricValues") = False
                        '  Session.item("defaultCurrency") = 9
                    Else
                        ' THIS IS CURRENTLY , IF MESSED UP VALUE DEFAULT TO STANDARD
                        Session.Item("localPreferences").UseStandardOrMetric = "standard" ' default chall 300
                        Session.Item("useMetricValues") = False
                        '  Session.item("defaultCurrency") = 9
                    End If
                End If ' If Trim(Request("amod_id")) <> "" Then
            Else
                If Me.useStandardOrMetric.Text = "metric" Then
                    Session.Item("localPreferences").UseStandardOrMetric = "metric"
                    Session.Item("useMetricValues") = True
                Else
                    Session.Item("localPreferences").UseStandardOrMetric = "standard" ' default chall 300
                    Session.Item("useMetricValues") = False
                End If
            End If
        Else

            If Me.useStandardOrMetric.Text = "metric" Then
                Session.Item("localPreferences").UseStandardOrMetric = "metric"
                Session.Item("useMetricValues") = True
            Else
                Session.Item("localPreferences").UseStandardOrMetric = "standard" ' default chall 300
                Session.Item("useMetricValues") = False
            End If
        End If



        Dim page_total As Integer = 0

        If months = 3 Then
            days = 91
        ElseIf months = 6 Then
            days = 182
        ElseIf months = 6 Then
            days = 273
        ElseIf months = 12 Then
            days = 365
        ElseIf months = 24 Then
            days = 730
        ElseIf months = 36 Then
            days = 1095
        End If

        If Me.logo_check.Checked = True Then
            logo_header = get_company_images(real_make_model_name)
        End If

        If Me.CP.Checked Then
            ViewToPDF = Build_PDF_CoverPage(amod_id, foot_space_cover) '& Build_PDF_Template_Footer()
            page_total = page_total + 1
            '   ViewToPDF = ViewToPDF & Insert_Page_Break_PDF()
        End If



        If MMS_FMS.Checked Then
            If page_total > 0 Then
                ViewToPDF = ViewToPDF & Insert_Page_Break_PDF()
            End If
            page_total = page_total + 1
            ' call the Fleet/MarketSummary display and append the footer

            If CRMViewActive Then
                crmViewDataLayer.Combined_views_display_fleet_market_summary(localCriteria, Build_FleetMarketSummary_text, GetMarketStatus, localdatalayer, ClientIDSToExclude, True, False, 0, 0, 0)

                If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                    ViewToPDF = ViewToPDF & "<table align='center' id='fleetTable'  cellpadding='1' cellspacing='0' width='" & word_width & "'>" & vbCrLf
                Else
                    ViewToPDF = ViewToPDF & "<table align='center' id='fleetTable'  cellpadding='1' cellspacing='0' width='95%'>" & vbCrLf
                End If

                ViewToPDF = ViewToPDF & "<tr id='trInner_Content_AC_PIC'>" & vbCrLf

                If Me.logo_check.Checked = True Then
                    ViewToPDF = ViewToPDF & "<td  id='tdInner_Content_AC_PIC' align='center' colspan='3'>" & get_company_images(real_make_model_name)
                Else
                    ViewToPDF = ViewToPDF & "<td  id='tdInner_Content_AC_PIC' align='center' colspan='3'><img src='" & location_string & "images/marketpdfheader.jpg' />" & vbCrLf
                End If


                ViewToPDF = ViewToPDF & "</td></tr>" & vbCrLf
                ViewToPDF = ViewToPDF & "<tr><Td>" & vbCrLf

                ViewToPDF = ViewToPDF & Build_FleetMarketSummary_text

                ViewToPDF = ViewToPDF & "</td></tr>" & vbCrLf
                ViewToPDF = ViewToPDF & "<tr><Td>" & vbCrLf

                ViewToPDF = ViewToPDF & GetMarketStatus

                ViewToPDF = ViewToPDF & "</td></tr>" & vbCrLf
                ViewToPDF = ViewToPDF & "</table>" & vbCrLf


            Else
                'localDatalayer.views_display_fleet_market_summary(searchCriteria, Build_FleetMarketSummary_text, GetMarketStatus)

                ViewToPDF = ViewToPDF & Build_FleetMarketSummary(amod_id, False, real_make_model_name, foot_space_market_summary, "Y", localCriteria) '& Build_PDF_Template_Footer() & Insert_Page_Break_PDF()
            End If
        End If

        If Me.MMS_STAT.Checked = True Then
            ViewToPDF = ViewToPDF & Insert_Page_Break_PDF() ' inserted msw 1/3/14

            If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                ViewToPDF = ViewToPDF & "<table align='center' id='fleetTable'  cellpadding='1' cellspacing='0' width='" & word_width & "'>" & vbCrLf
                ViewToPDF = ViewToPDF & "<tr id='trInner_Content_AC_PIC'>" & vbCrLf
                ViewToPDF = ViewToPDF & "<td  id='tdInner_Content_AC_PIC' align='center' colspan='3' width='" & word_width & "'>"
            Else
                ViewToPDF = ViewToPDF & "<table align='center' id='fleetTable'  cellpadding='1' cellspacing='0' width='95%'>" & vbCrLf
                ViewToPDF = ViewToPDF & "<tr id='trInner_Content_AC_PIC'>" & vbCrLf
                ViewToPDF = ViewToPDF & "<td  id='tdInner_Content_AC_PIC' align='center' colspan='3' width='95%'>"
            End If



            If Me.logo_check.Checked = True Then
                ViewToPDF = ViewToPDF & get_company_images(real_make_model_name)
            Else
                ViewToPDF = ViewToPDF & "<img src='" & location_string & "images/marketpdfheader.jpg' />" & vbCrLf
            End If

            If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                ViewToPDF = ViewToPDF & "</td></tr><tr><td width='" & word_width & "' align='center'>"
            Else
                ViewToPDF = ViewToPDF & "</td></tr><tr><td width='95%' align='center'>"
            End If


            ViewToPDF = ViewToPDF & aircraft_sales_by_year(amod_id)
            ViewToPDF = ViewToPDF & "</td></tr></table>"
        End If

        '  ViewToPDF = ViewToPDF & Insert_Page_Break_PDF()


        If MMS_BPS.Checked Then
            If page_total > 0 Then
                ViewToPDF = ViewToPDF & Insert_Page_Break_PDF()
            End If
            page_total = page_total + 1
            ' call the Performance Specifications
            If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                ViewToPDF = ViewToPDF & "<table align='center' id='fleetTable'  cellpadding='1' cellspacing='0' width='" & word_width & "'>" & vbCrLf
                ViewToPDF = ViewToPDF & "<tr id='trInner_Content_AC_PIC'>" & vbCrLf
                ViewToPDF = ViewToPDF & "<td  id='tdInner_Content_AC_PIC' align='center' colspan='3'  width='" & word_width & "'>"
            Else
                ViewToPDF = ViewToPDF & "<table align='center' id='fleetTable'  cellpadding='1' cellspacing='0' width='95%'>" & vbCrLf
                ViewToPDF = ViewToPDF & "<tr id='trInner_Content_AC_PIC'>" & vbCrLf
                ViewToPDF = ViewToPDF & "<td  id='tdInner_Content_AC_PIC' align='center' colspan='3'  width='95%'>"
            End If

            ViewToPDF = ViewToPDF & Build_PerformanceSpecifications(False, "", False, "", foot_space_Performance_Specs, amod_id) '& Build_PDF_Template_Footer() & Insert_Page_Break_PDF()
            '  ViewToPDF = ViewToPDF & Insert_Page_Break_PDF()
        End If


        If MMS_OP_COSTS_2.Checked Then  ' changed from MMS_BOC
            If page_total > 0 Then
                ViewToPDF = ViewToPDF & Insert_Page_Break_PDF()
            End If
            page_total = page_total + 1
            ' call the Operation Costs

            If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                ViewToPDF = ViewToPDF & "<table align='center' id='fleetTable'  cellpadding='1' cellspacing='0' width='" & word_width & "'>" & vbCrLf
                ViewToPDF = ViewToPDF & "<tr id='trInner_Content_AC_PIC'>" & vbCrLf
                ViewToPDF = ViewToPDF & "<td  id='tdInner_Content_AC_PIC' align='center' colspan='3' align='center' width='" & word_width & "'>"
            Else
                ViewToPDF = ViewToPDF & "<table align='center' id='fleetTable'  cellpadding='1' cellspacing='0' width='95%'>" & vbCrLf
                ViewToPDF = ViewToPDF & "<tr id='trInner_Content_AC_PIC'>" & vbCrLf
                ViewToPDF = ViewToPDF & "<td  id='tdInner_Content_AC_PIC' align='center' colspan='3' align='center' width='95%'>"
            End If


            ViewToPDF = ViewToPDF & Build_OperatingCosts(foot_space_op_costs, amod_id) '& Build_PDF_Template_Footer() & Insert_Page_Break_PDF()
            ' ViewToPDF = ViewToPDF & Insert_Page_Break_PDF()
            'If Session.item("useMetricValues") = False Then
            'ViewToPDF = ViewToPDF & Insert_Page_Break_PDF()
            ' End If
        End If

        If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = False Then

            If MMS_BAFS.Checked Then
                ' call the Aircraft For Sale
                If page_total > 0 Then
                    ViewToPDF = ViewToPDF & Insert_Page_Break_PDF()
                End If
                page_total = page_total + 1


                If CRMViewActive Then

                    If Trim(Trim(Request("extra"))) <> "" Then
                        crmViewDataLayer.views_display_aircraft_forsale(localCriteria, temp_ac_for_sale, Trim(Request("extra")), localdatalayer, True, ClientIDSToExclude, False, Nothing)

                        If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                            ViewToPDF = ViewToPDF & "<table align='center' id='fleetTable'  cellpadding='1' cellspacing='0' width='" & word_width & "'>" & vbCrLf
                        Else
                            ViewToPDF = ViewToPDF & "<table align='center' id='fleetTable'  cellpadding='1' cellspacing='0' width='95%'>" & vbCrLf
                        End If

                        ViewToPDF = ViewToPDF & "<tr id='trInner_Content_AC_PIC'>" & vbCrLf
                        ViewToPDF = ViewToPDF & "<td  id='tdInner_Content_AC_PIC' align='center' colspan='3'>"

                        If Me.logo_check.Checked = True Then
                            ViewToPDF = ViewToPDF & logo_header
                        Else
                            ViewToPDF = ViewToPDF & "<img src='" & location_string & "images/marketpdfheader.jpg' />"
                        End If

                        ViewToPDF = ViewToPDF & "</td></tr>" & vbCrLf
                        ViewToPDF = ViewToPDF & "<tr><Td>" & vbCrLf

                        ViewToPDF = ViewToPDF & temp_ac_for_sale

                        ViewToPDF = ViewToPDF & "</td></tr>" & vbCrLf
                        ViewToPDF = ViewToPDF & "</table>" & vbCrLf

                    Else
                        crmViewDataLayer.views_display_aircraft_forsale(localCriteria, temp_ac_for_sale, False, localdatalayer, True, ClientIDSToExclude, False, Nothing, 0, 0, "", 28, "", True, "", "", "", "", "", "", logo_header)

                        If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                            ViewToPDF = ViewToPDF & "<table align='center' id='fleetTable'  cellpadding='1' cellspacing='0' width='" & word_width & "'>" & vbCrLf
                        Else
                            ViewToPDF = ViewToPDF & "<table align='center' id='fleetTable'  cellpadding='1' cellspacing='0' width='95%'>" & vbCrLf
                        End If


                        ViewToPDF = ViewToPDF & "<tr id='trInner_Content_AC_PIC'>" & vbCrLf
                        ViewToPDF = ViewToPDF & "<td  id='tdInner_Content_AC_PIC' align='center' colspan='3'>"


                        If Me.logo_check.Checked = True Then
                            ViewToPDF = ViewToPDF & logo_header
                        Else
                            ViewToPDF = ViewToPDF & "<img src='" & location_string & "images/marketpdfheader.jpg' />" & vbCrLf
                        End If


                        ViewToPDF = ViewToPDF & "</td></tr>" & vbCrLf
                        ViewToPDF = ViewToPDF & "<tr><Td>" & vbCrLf

                        ViewToPDF = ViewToPDF & temp_ac_for_sale

                        ViewToPDF = ViewToPDF & "</td></tr>" & vbCrLf
                        ViewToPDF = ViewToPDF & "</table>" & vbCrLf
                    End If

                Else
                    ViewToPDF = ViewToPDF & Build_AircraftForSale(amod_id, "", False, "", foot_space_ac_for_sale) '& Build_PDF_Template_Footer() & Insert_Page_Break_PDF()
                End If




                'ViewToPDF = ViewToPDF & Insert_Page_Break_PDF()
            End If
        End If
        ' Recent Sales Trends
        ' take the marketsummarygraph.asp page and make it a function
        'pass in variables 
        'MarketSummaryGraph.asp?Data=76,77,75,68,69,67
        '&HideLast=No&TopTitle=BUSINESS+AIRCRAFT+TYPES+EQUALS+JETS+MAKE%5BS%5D+EQUALS+%27CHALLENGER%27+MODEL%5BS%5D+EQUALS+600++MODEL%5BS%5D+EQUALS+601%2D1A++MODEL%5BS%5D+EQUALS+300+
        '&LeftTitle=Aircraft For Sale
        '&BottomTitle=6 Months
        '&Labels=2/2010,3/2010,4/2010,5/2010,6/2010,7/2010","MSGraphFS")

        ' ViewToPDF = ViewToPDF & Insert_Page_Break_PDF()
        ' call the Recent Sales Trends

        '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
        ' skip for now having graph issues
        'ViewToPDF = ViewToPDF & Build_RecentSalesTrends() & Build_PDF_Template_Footer()
        '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

        'If BRRS.Checked Then
        '  If page_total > 0 Then
        '    ViewToPDF = ViewToPDF & Insert_Page_Break_PDF()
        '  End If
        '  page_total = page_total + 1
        '  ' call the Recent Retail Sales
        '  ViewToPDF = ViewToPDF & Build_MarketSummaryGraph("76,77,75,68,69,67", "BUSINESS+AIRCRAFT+TYPES+EQUALS+JETS+MAKE%5BS%5D+EQUALS+%27CHALLENGER%27+MODEL%5BS%5D+EQUALS+600++MODEL%5BS%5D+EQUALS+601%2D1A++MODEL%5BS%5D+EQUALS+300+", "Aircraft For Sale" , "6 Months", "2/2010,3/2010,4/2010,5/2010,6/2010,7/2010") ','MSGraphFS'"
        '  ' ViewToPDF = ViewToPDF & Insert_Page_Break_PDF()
        'End If



        If MMS_BRRS.Checked Then
            If page_total > 0 Then
                ViewToPDF = ViewToPDF & Insert_Page_Break_PDF()
            End If
            page_total = page_total + 1
            ' call the Recent Retail Sales



            If CRMViewActive Then
                crmViewDataLayer.Combined_views_display_recent_retail_sales(localCriteria, sRetailSales, localdatalayer, CRMViewActive, False, temp_table, "N", "N", False, 0, 0, "", 0, 0, "", True, logo_header)

                If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                    ViewToPDF = ViewToPDF & "<table align='center' id='fleetTable'  cellpadding='1' cellspacing='0' width='" & word_width & "'>" & vbCrLf
                Else
                    ViewToPDF = ViewToPDF & "<table align='center' id='fleetTable'  cellpadding='1' cellspacing='0' width='95%'>" & vbCrLf
                End If

                ViewToPDF = ViewToPDF & "<tr id='trInner_Content_AC_PIC'>" & vbCrLf
                ViewToPDF = ViewToPDF & "<td  id='tdInner_Content_AC_PIC' align='center' colspan='3'>"


                If Me.logo_check.Checked = True Then
                    ViewToPDF = ViewToPDF & logo_header
                Else
                    ViewToPDF = ViewToPDF & "<img src='" & location_string & "images/marketpdfheader.jpg' />" & vbCrLf
                End If

                ViewToPDF = ViewToPDF & "</td></tr>" & vbCrLf
                ViewToPDF = ViewToPDF & "<tr><Td>" & vbCrLf

                ViewToPDF = ViewToPDF & sRetailSales


                ViewToPDF = ViewToPDF & "</td></tr>" & vbCrLf
                ViewToPDF = ViewToPDF & "</table>" & vbCrLf
                ViewToPDF = ViewToPDF & "</td></tr></table>" & vbCrLf
                ViewToPDF = ViewToPDF & "</table>"
                ViewToPDF = ViewToPDF & "</td></tr></table>" & vbCrLf
                ViewToPDF = ViewToPDF & "</td></tr></table>" & vbCrLf
                ViewToPDF = ViewToPDF & "</td></tr></table>" & vbCrLf
                ViewToPDF = ViewToPDF & "</td></tr></table>" & vbCrLf
                ViewToPDF = ViewToPDF & "</td></tr></table>" & vbCrLf
            Else
                ' localDatalayer.views_display_recent_retail_sales(localCriteria, sRetailSales)
                ViewToPDF = ViewToPDF & Build_RecentRetailSales(amod_id, foot_space_recent_retail_sales)
            End If
        End If



        If Me.MMS_UP.Checked Then
            If page_total > 0 Then
                ViewToPDF = ViewToPDF & Insert_Page_Break_PDF()
            End If
            page_total = page_total + 1
            If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                ViewToPDF = ViewToPDF & "<table align='center' id='fleetTable'  cellpadding='1' cellspacing='0' width='" & word_width & "'>" & vbCrLf
            Else
                ViewToPDF = ViewToPDF & "<table align='center' id='fleetTable'  cellpadding='1' cellspacing='0' width='95%'>" & vbCrLf
            End If


            ViewToPDF = ViewToPDF & "<tr id='trInner_Content_AC_PIC'>" & vbCrLf
            ViewToPDF = ViewToPDF & "<td  id='tdInner_Content_AC_PIC' align='center' colspan='7'>"

            If Me.logo_check.Checked = True Then
                ViewToPDF = ViewToPDF & logo_header
            Else
                ViewToPDF = ViewToPDF & "<img src='" & location_string & "images/marketpdfheader.jpg' />" & vbCrLf
            End If

            ViewToPDF = ViewToPDF & "</td></tr><tr><td>"
            ViewToPDF = ViewToPDF & Build_PDF_Upgrade(amod_id, real_make_model_name) '& Build_PDF_Template_Footer()
            ViewToPDF = ViewToPDF & "</td></tr></table>"
            If Me.MMS_AA.Checked Then
                ViewToPDF = ViewToPDF & Insert_Page_Break_PDF() ' inserted msw 1/3/14

                If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                    ViewToPDF = ViewToPDF & "<table align='center' id='fleetTable'  cellpadding='1' cellspacing='0' width='" & word_width & "'>" & vbCrLf
                Else
                    ViewToPDF = ViewToPDF & "<table align='center' id='fleetTable'  cellpadding='1' cellspacing='0' width='95%'>" & vbCrLf
                End If


                ViewToPDF = ViewToPDF & "<tr id='trInner_Content_AC_PIC'>" & vbCrLf
                ViewToPDF = ViewToPDF & "<td  id='tdInner_Content_AC_PIC' align='center' colspan='3'>"



                If Me.logo_check.Checked = True Then
                    ViewToPDF = ViewToPDF & logo_header
                Else
                    ViewToPDF = ViewToPDF & "<img src='" & location_string & "images/marketpdfheader.jpg' />" & vbCrLf
                End If

                If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = False Then
                    ViewToPDF = ViewToPDF & "</td></tr><tr><td>"
                    ViewToPDF = ViewToPDF & Show_Average_Year(amod_id)
                End If
                ViewToPDF = ViewToPDF & "</td></tr></table>"
            End If

            '   ViewToPDF = ViewToPDF & Insert_Page_Break_PDF()
        Else
            If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = False Then
                If Me.MMS_AA.Checked Then
                    If page_total > 0 Then
                        ViewToPDF = ViewToPDF & Insert_Page_Break_PDF()
                    End If
                    page_total = page_total + 1
                    ViewToPDF = ViewToPDF & "<table><tr><td align='center' colspan='7'>"
                    If Me.logo_check.Checked = True Then
                        ViewToPDF = ViewToPDF & logo_header
                    Else
                        ViewToPDF = ViewToPDF & "<img src='" & location_string & "images/marketpdfheader.jpg' />" & vbCrLf
                    End If

                    ViewToPDF = ViewToPDF & "</td></tr><tr><td>"
                    ViewToPDF = ViewToPDF & Show_Average_Year(amod_id)
                End If
                ViewToPDF = ViewToPDF & "</td></tr></table>"
            End If
        End If

        ' If HttpContext.Current.Session.Item("localPreferences").AerodexFlag Then
        ''dont show market activity
        ' Else
        If MMS_BRMA.Checked And MMS_BRMA.Visible = True Then
            If page_total > 0 Then
                ViewToPDF = ViewToPDF & "</td></tr></table>"
                ViewToPDF = ViewToPDF & Insert_Page_Break_PDF()
            End If
            page_total = page_total + 1
            ' call the Recent Market Activity
            ViewToPDF = ViewToPDF & Build_RecentMarketActivity(amod_id, foot_space_market_activity) '& Build_PDF_Template_Footer() & Insert_Page_Break_PDF()
        End If
        '  End If

        If CRMViewActive Then
            If Me.CRM_Wanteds.Checked And Me.CRM_Wanteds.Visible = True Then

                If page_total > 0 Then
                    ViewToPDF = ViewToPDF & Insert_Page_Break_PDF()
                End If

                If CRMViewActive Then
                    crmViewDataLayer.Combined_views_display_model_wanteds(localCriteria, htmlModelWanteds, localdatalayer, False)
                Else
                    localdatalayer.views_display_model_wanteds(localCriteria, htmlModelWanteds)
                End If


                If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                    ViewToPDF = ViewToPDF & "<table align='center' id='fleetTable'  cellpadding='1' cellspacing='0' width='" & word_width & "'>" & vbCrLf
                Else
                    ViewToPDF = ViewToPDF & "<table align='center' id='fleetTable'  cellpadding='1' cellspacing='0' width='95%'>" & vbCrLf
                End If


                ViewToPDF = ViewToPDF & "<tr id='trInner_Content_AC_PIC'>" & vbCrLf
                ViewToPDF = ViewToPDF & "<td  id='tdInner_Content_AC_PIC' align='center' colspan='3'>"
                If Me.logo_check.Checked = True Then
                    ViewToPDF = ViewToPDF & logo_header
                Else
                    ViewToPDF = ViewToPDF & "<img src='" & location_string & "images/marketpdfheader.jpg' />" & vbCrLf
                End If

                ViewToPDF = ViewToPDF & "</td></tr>" & vbCrLf
                ViewToPDF = ViewToPDF & "<tr><Td>" & vbCrLf

                ViewToPDF = ViewToPDF & htmlModelWanteds

                ViewToPDF = ViewToPDF & "</td></tr>" & vbCrLf
                ViewToPDF = ViewToPDF & "</table>" & vbCrLf
            End If
        End If


        If Me.MMS_CHARTS.Checked Then
            If page_total > 0 Then
                ViewToPDF = ViewToPDF & "</td></tr></table>"
                ViewToPDF = ViewToPDF & Insert_Page_Break_PDF()
            End If
            page_total = page_total + 1

            Me.AVG_PRICE_MONTH.Titles.Add(display_avg_price_by_month_graph(amod_id, AVG_PRICE_MONTH, days, months, localCriteria, ""))
            Me.FOR_SALE.Titles.Add(display_for_sale_by_month_graph(amod_id, FOR_SALE, days, months, localCriteria, ""))
            Me.PER_MONTH.Titles.Add(display_sold_per_month_graph(False, False, amod_id, PER_MONTH, months, False, ""))
            Me.AVG_DAYS_ON.Titles.Add(display_average_days_on_market_graph(amod_id, AVG_DAYS_ON, days, months))


            Me.AVG_PRICE_MONTH.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
            Me.AVG_PRICE_MONTH.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "_AVG_PRICE_MONTH.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
            Me.FOR_SALE.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "_FOR_SALE.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
            Me.PER_MONTH.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "_PER_MONTH.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
            Me.AVG_DAYS_ON.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "_AVG_DAYS_ON.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)

            If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                ViewToPDF = ViewToPDF & "<table width='" & word_width & "' align='center' cellpadding='1'><tr><td align='center' colspan='6'>"
            Else
                ViewToPDF = ViewToPDF & "<table width='90%' align='center' cellpadding='1'><tr><td align='center' colspan='6'>"
            End If


            If Me.logo_check.Checked = True Then
                ViewToPDF = ViewToPDF & logo_header
            Else
                ViewToPDF = ViewToPDF & "<img src='" & location_string & "images/marketpdfheader.jpg' />" & vbCrLf
            End If

            ViewToPDF = ViewToPDF & "</td></tr><tr><td align='center' colspan='6'><b>" & real_make_model_name & " Trends </b></td></tr><tr><td align='center' colspan='6'>&nbsp;</td></tr>" & vbCrLf

            'ImageLocation(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" + amod_id.tostring + "_AVG_PRICE_MONTH.jpg").
            ViewToPDF = ViewToPDF & "<tr><td valign='top' class='Performance_Specs_Left_TD_1'>"

            If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                ViewToPDF = ViewToPDF & "<table align='center' width='" & word_width & "'><tr><td width='" & word_width & "' align='center' >"
            Else
                ViewToPDF = ViewToPDF & "<table align='center'><tr><td>"
            End If



            If InStr(HttpContext.Current.Session.Item("jetnetFullHostName").ToString.Trim, "jetnetevo") = 0 Or InStr(HttpContext.Current.Session.Item("jetnetFullHostName").ToString.Trim, "testjetnetevolution") > 0 Then
                If InStr(HttpContext.Current.Session.Item("jetnetFullHostName").ToString, "http://") > 0 Then
                    ViewToPDF = ViewToPDF & "<img src='" & HttpContext.Current.Session.Item("jetnetFullHostName").ToString & "/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "_AVG_PRICE_MONTH.jpg'>"
                    ViewToPDF = ViewToPDF & "&nbsp;<img src='" & HttpContext.Current.Session.Item("jetnetFullHostName").ToString & "/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "_FOR_SALE.jpg'>"
                    ViewToPDF = ViewToPDF & "</td></tr><tr><tr><td>"
                    ViewToPDF = ViewToPDF & "<img src='" & HttpContext.Current.Session.Item("jetnetFullHostName").ToString & "/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "_PER_MONTH.jpg'>"
                    ViewToPDF = ViewToPDF & "&nbsp;<img src='" & HttpContext.Current.Session.Item("jetnetFullHostName").ToString & "/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "_AVG_DAYS_ON.jpg'>"
                Else
                    ViewToPDF = ViewToPDF & "<img src='http://" & HttpContext.Current.Session.Item("jetnetFullHostName").ToString & "/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "_AVG_PRICE_MONTH.jpg'>"
                    ViewToPDF = ViewToPDF & "&nbsp;<img src='http://" & HttpContext.Current.Session.Item("jetnetFullHostName").ToString & "/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "_FOR_SALE.jpg'>"
                    ViewToPDF = ViewToPDF & "</td></tr><tr><tr><td>"
                    ViewToPDF = ViewToPDF & "<img src='http://" & HttpContext.Current.Session.Item("jetnetFullHostName").ToString & "/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "_PER_MONTH.jpg'>"
                    ViewToPDF = ViewToPDF & "&nbsp;<img src='http://" & HttpContext.Current.Session.Item("jetnetFullHostName").ToString & "/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "_AVG_DAYS_ON.jpg'>"
                End If
            Else
                ViewToPDF = ViewToPDF & "<img src='http://www.jetnetevolution.com/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "_AVG_PRICE_MONTH.jpg'>"
                ViewToPDF = ViewToPDF & "&nbsp;<img src='http://www.jetnetevolution.com/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "_FOR_SALE.jpg'>"
                ViewToPDF = ViewToPDF & "</td></tr><tr><tr><td>"
                ViewToPDF = ViewToPDF & "<img src='http://www.jetnetevolution.com/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "_PER_MONTH.jpg'>"
                ViewToPDF = ViewToPDF & "&nbsp;<img src='http://www.jetnetevolution.com/tempfiles/" & HttpContext.Current.Session.Item("localUser").crmUserTemporaryFilePrefix + amod_id.ToString + "_AVG_DAYS_ON.jpg'>"
            End If





            ViewToPDF = ViewToPDF & "</td></tr></table></td></tr></table>"
        End If



        'ViewToPDF = ViewToPDF & Insert_Page_Break_PDF()
        'ViewToPDF = ViewToPDF & aircraft_sales_by_year(amod_id)


        'The page_total variable is added to whenever a new page is created.
        'If all pages are selected there are errors on a few page if no page break has been inserted
        'This is a temporary fix and we are not sure why it does this
        'With this in, all pages seem to work error free
        '   MSW(9 / 20 / 10)



        If page_total > 7 Then
            'ViewToPDF = ViewToPDF & Insert_Page_Break_PDF()
        End If

        ' Me.Chart1.SaveImage("C:\TempImageFiles\this.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
        'ViewToPDF = ViewToPDF & "<img src='C:\TempImageFiles\this.jpg'>"

        ' call the build header function
        ViewToPDF = Build_PDF_Template_Header(foot_space_cover, foot_space_market_summary, foot_space_Performance_Specs, foot_space_op_costs, foot_space_ac_for_sale, foot_space_recent_retail_sales, foot_space_market_activity) & ViewToPDF

        ' call the Build HTML Page
        ViewToPDF = Build_HTML_Page(ViewToPDF)
        ' call the Output String to HTML file

        Build_Model_Market_Summary_PDF = ViewToPDF.ToString
    End Function
    Public Function Build_PDF_Header_Final(ByVal Title, ByVal sub_info, ByVal real_make_model, ByVal real_company_name, ByVal sub_type, ByVal real_country_name, ByVal real_city_name, ByVal airframe_type, ByVal View_Uses_AC_Type_DropDown) As String
        Build_PDF_Header_Final = ""
        Dim htmlOutput As String = ""
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim adoRSAircraft As System.Data.SqlClient.SqlDataReader : adoRSAircraft = Nothing
        Dim company_name As String = ""
        Dim real_make_model_name As String = ""


        If airframe_type.ToString.Trim = "F" Then
            airframe_type = "Fixed Wing Aircraft"
        ElseIf airframe_type.ToString.Trim = "R" Then
            airframe_type = "Rotary Wing Aircraft"
        End If


        Try


            If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                Build_PDF_Header_Final = Build_PDF_Header_Final & "<table cellspacing='0' cellpadding='0' width='" & word_width & "'><tr bgcolor='#736F6E'><td colspan='3' valign='top'>"
                Build_PDF_Header_Final = Build_PDF_Header_Final & "<table border='1' cellspacing='0' cellpadding='4' bordercolor='black' width='100%' height='50' ><tr valign='top'><td valign='top'>"
                Build_PDF_Header_Final = Build_PDF_Header_Final & "<table valign='top' width='" & word_width & "'><tr valign='top'><td width='" & word_width & "' valign='top' class='white_feat_header_text'><font color='white' size='-1'>"
            Else
                Build_PDF_Header_Final = Build_PDF_Header_Final & "<table cellspacing='0' cellpadding='0' width='100%'><tr bgcolor='#736F6E'><td colspan='3' valign='top'>"
                Build_PDF_Header_Final = Build_PDF_Header_Final & "<table border='1' cellspacing='0' cellpadding='4' bordercolor='black' width='100%' height='50' ><tr valign='top'><td valign='top'>"
                Build_PDF_Header_Final = Build_PDF_Header_Final & "<table valign='top' width='100%'><tr valign='top'><td width='650' valign='top'>"
            End If

            Build_PDF_Header_Final = Build_PDF_Header_Final & sub_info
            Build_PDF_Header_Final = Build_PDF_Header_Final & "</td><td width='40%' cellpadding='5' class='white_feat_header_text'><font color='white' size='-1'>"



            If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                Build_PDF_Header_Final = Build_PDF_Header_Final & "<table align='left' valign='bottom'><tr><td align='center' class='white_feat_header_text'><font color='white' size='-1'><i>" & Title & "</i></font></td></tr></table>"
                Build_PDF_Header_Final = Build_PDF_Header_Final & "</font></td></tr></table></td></tr></table></td></tr><tr><td width='" & word_width & "' cellspacing='0'><table width='" & word_width & "' height='850' cellspacing='0' cellpadding='5'>"
            Else
                Build_PDF_Header_Final = Build_PDF_Header_Final & "<table align='left' valign='top' cellpadding='0' cellspacing='0'>"
                Build_PDF_Header_Final = Build_PDF_Header_Final & "<tr><td align='left'><font color='white'>" & Title

                If real_city_name.ToString.Trim <> "" Then
                    Build_PDF_Header_Final = Build_PDF_Header_Final & " - " & real_city_name
                ElseIf real_country_name.ToString.Trim <> "" Then
                    Build_PDF_Header_Final = Build_PDF_Header_Final & " - " & real_country_name
                End If

                Build_PDF_Header_Final = Build_PDF_Header_Final & "</font></td></tr>"

                If real_company_name.ToString.Trim <> "" Then
                    Build_PDF_Header_Final = Build_PDF_Header_Final & "<tr><td align='left'><font color='white'>" & real_company_name & "</font></td></tr>"
                End If




                If View_Uses_AC_Type_DropDown Then
                    ' this will be used to say like model - then subscription type, currrently doesnt use airframe

                    If real_make_model.ToString.Trim <> "" Then
                        Build_PDF_Header_Final = Build_PDF_Header_Final & "<tr><td align='left'><font color='white'>" & real_make_model
                        If sub_type.ToString.Trim <> "" Then
                            Build_PDF_Header_Final = Build_PDF_Header_Final & " - " & sub_type
                        End If
                        Build_PDF_Header_Final = Build_PDF_Header_Final & "</font></td></tr>"
                        '   ElseIf airframe_type.ToString.Trim <> "" Then
                        '    Build_PDF_Header_Final = Build_PDF_Header_Final & "<tr><td align='left'><font color='white'>" & airframe_type & "</font></td></tr>"
                    ElseIf sub_type.ToString.Trim <> "" Then
                        Build_PDF_Header_Final = Build_PDF_Header_Final & "<tr><td align='left'><font color='white'>" & sub_type & "</font></td></tr>"
                    End If


                Else
                    If real_make_model.ToString.Trim <> "" Then
                        Build_PDF_Header_Final = Build_PDF_Header_Final & "<tr><td align='left'><font color='white'>" & real_make_model & "</font></td></tr>"
                    ElseIf airframe_type.ToString.Trim <> "" Then
                        Build_PDF_Header_Final = Build_PDF_Header_Final & "<tr><td align='left'><font color='white'>" & airframe_type & "</font></td></tr>"
                    ElseIf sub_type.ToString.Trim <> "" Then
                        Build_PDF_Header_Final = Build_PDF_Header_Final & "<tr><td align='left'><font color='white'>" & sub_type & "</font></td></tr>"
                    End If
                End If







                Build_PDF_Header_Final = Build_PDF_Header_Final & "</table>"

                Build_PDF_Header_Final = Build_PDF_Header_Final & "</font></td></tr></table></td></tr></table></td></tr><tr><td width='100%' cellspacing='0'><table width='100%' cellspacing='0' cellpadding='5'>"
            End If

            Build_PDF_Header_Final = Build_PDF_Header_Final & "</td></tr></table>"

            SqlConn.Close()
        Catch ex As Exception
            'HttpContext.Current.Session.Item("localUser").crmUser_DebugText +="Error in Build_PDF_Header2: " & ex.Message)
        End Try
    End Function

    Public Function display_acContactType_location_piechart_country(ByVal inCompanyID, ByVal inAmodID, ByVal airframe, ByVal group_by_statement, ByVal sub_info, ByVal real_make_model_name, ByVal real_company_name, ByVal sub_type)
        display_acContactType_location_piechart_country = ""
        Dim query As String = ""
        Dim total_Aircraft As Integer = 0
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim localAdoRs2 As System.Data.SqlClient.SqlDataReader : localAdoRs2 = Nothing
        Dim htmlOutput As String = ""
        Dim record_count As Integer = 0
        Dim string_for_locations As String = ""
        Dim x As Integer = 0
        Dim string_for_country_names As String = ""
        Dim title As String = ""
        Dim sub_title As String = ""
        Dim page_title As String = ""
        Dim hidden_counter As Integer = 0
        Dim bgcolor As String = ""

        Try


            query = " SELECT DISTINCT comp_country, count(distinct comp_id) AS comp_count "
            query = query & " FROM Aircraft_Summary WITH(NOLOCK) "
            query = query & " WHERE ac_lifecycle_stage = 3 AND (cref_contact_type IN ('94','33') OR cref_business_type in ('CH')) "
            '  query = query & " " + commonEVO.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, False)
            query = query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, True)

            If CLng(inAmodID) > 0 Then
                query = query & " AND amod_id = '" & CStr(inAmodID) & "' "
            End If

            If Trim(airframe) <> "" Then
                query = query & " AND amod_airframe_type_code = '" & Trim(airframe) & "'"
            End If

            query = query & " GROUP BY comp_country"
            query = query & " " & group_by_statement

            If Session("debug") Then
                Response.Write("<b>display_acContactType_location_piechart_country : " & Server.HtmlEncode(query) & "</b><br /><br />")
            End If

            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            '  End Select

            ' End Select
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = query
            localAdoRs2 = SqlCommand.ExecuteReader()


            If localAdoRs2.HasRows Then

                page_title = "Charter_Countries"

                title = "CHARTER&nbsp;OPERATOR&nbsp;COUNTRIES"


                sub_title = sub_title & "<table cellspacing='0' cellpadding='0' border='0' width='100%'><tr><td valign='middle' align='left' width='60%'><strong>Country</strong></td>" & vbCrLf
                sub_title = sub_title & "<td valign='middle' align='right'><strong>#&nbsp;of&nbsp;Operators</strong></td></tr></table>" & vbCrLf

                Do While localAdoRs2.Read

                    If Not IsDBNull(localAdoRs2("comp_country")) Then
                        If localAdoRs2("comp_country").ToString.Trim <> "" Then


                            If bgcolor = "#ffffff" Then
                                bgcolor = "#F6F6F6"
                            Else
                                bgcolor = "#ffffff"
                            End If


                            If hidden_counter = 60 Then
                                string_for_country_names += Build_PDF_Template_Footer()
                                string_for_country_names += Insert_Page_Break_PDF()
                                string_for_country_names += Build_PDF_Header_Final("Charter Report", sub_info, real_make_model_name, real_company_name, sub_type, "", "", airframe, False)
                                string_for_country_names += Build_PDF_Column_Start(page_title, title, "Continued", sub_title, 2).ToString
                                hidden_counter = 0
                            ElseIf hidden_counter = 30 Then
                                string_for_country_names = string_for_country_names & Build_PDF_Column_2(sub_title, 2, page_title)
                            End If


                            string_for_country_names = string_for_country_names & "<tr bgcolor='" & bgcolor & "'><td align='left'>"
                            string_for_country_names = string_for_country_names & Replace(localAdoRs2("comp_country").ToString, "'", " ") & "</a>"
                            string_for_country_names = string_for_country_names & "</td><td align='right'>"
                            string_for_country_names = string_for_country_names & FormatNumber(CStr(localAdoRs2("comp_count").ToString), 0)
                            string_for_country_names = string_for_country_names & "</td></tr>"

                            x = x + localAdoRs2("comp_count")
                            hidden_counter = hidden_counter + 1

                        End If
                    End If


                Loop

                string_for_country_names = string_for_country_names & "</td></tr></table></td></tr></table></td></tr></table>"


            Else
                htmlOutput = ""
            End If




            localAdoRs2.Close()



            display_acContactType_location_piechart_country = Build_PDF_Column_Start(page_title, title, "", sub_title, 2) & string_for_country_names


            'display_acContactType_location_piechart_country = display_acContactType_location_piechart_country & "</td></tr></table>"
            'display_acContactType_location_piechart_country = display_acContactType_location_piechart_country & "</td></tr></table>"
            'display_acContactType_location_piechart_country = display_acContactType_location_piechart_country & "</td></tr></table>"
        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function
    Function display_acContactType_location_piechart_city(ByVal inCompanyID, ByVal inAmodID, ByVal airframe, ByVal Country_Name, ByVal group_by_statement, ByVal sub_info, ByVal real_make_model_name, ByVal real_company_name, ByVal sub_type)
        display_acContactType_location_piechart_city = ""
        Dim query As String = ""
        Dim total_Aircraft As Integer = 0
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim localAdoRs2 As System.Data.SqlClient.SqlDataReader : localAdoRs2 = Nothing
        Dim htmlOutput As String = ""
        Dim record_count As Integer = 0
        Dim x As Integer = 0
        Dim string_for_locations As String = ""
        Dim title As String = ""
        Dim sub_title As String = ""
        Dim page_title As String = ""
        Dim string_for_link As String = ""
        Dim string_for_city_names As String = ""
        Dim hidden_counter As Integer = 0
        Dim bgcolor As String = ""


        Try
            query = " SELECT DISTINCT comp_city, comp_state, count(distinct comp_id) AS comp_count "
            query = query & " FROM aircraft_summary WITH(NOLOCK) "
            query = query & " WHERE ac_lifecycle_stage = 3 AND (cref_contact_type IN ('94','33') OR cref_business_type in ('CH')) "
            ' query = query & " " + commonEVO.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, False)
            query = query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, True)

            query = query & " AND comp_country='" & Country_Name & "'"

            If CLng(inAmodID) > 0 Then
                query = query & " AND amod_id = " & CStr(inAmodID)
            End If

            If Trim(airframe) <> "" Then
                query = query & " AND amod_airframe_type_code = '" & Trim(airframe) & "'"
            End If


            query = query & " GROUP BY comp_city, comp_state"
            query = query & " " & group_by_statement



            If Session("debug") Then
                Response.Write("<b>display_acContactType_location_piechart_city : " & Server.HtmlEncode(query) & "</b><br /><br />")
            End If
            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            '  End Select

            ' End Select
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = query
            localAdoRs2 = SqlCommand.ExecuteReader()


            page_title = "Charter_Cities"

            title = "CHARTER&nbsp;OPERATOR&nbsp;CITIES"

            If Trim(Country_Name) <> "" Then
                title = title & " in " & Country_Name
            End If

            sub_title = sub_title & "<table cellspacing='0' cellpadding='0' border='0' width='100%'><tr><td valign='middle' align='left' width='60%'><strong>City</strong></td>" & vbCrLf
            sub_title = sub_title & "<td valign='middle' align='right'><strong>#&nbsp;of&nbsp;Operators</strong></td></tr></table>" & vbCrLf



            If localAdoRs2.HasRows Then


                Do While localAdoRs2.Read

                    If Not IsDBNull(localAdoRs2("comp_city")) Then
                        If Trim(localAdoRs2("comp_city").ToString.Trim) <> "" Then

                            If bgcolor = "#ffffff" Then
                                bgcolor = "#F6F6F6"
                            Else
                                bgcolor = "#ffffff"
                            End If



                            If hidden_counter = 60 Then
                                string_for_city_names += Build_PDF_Template_Footer()
                                string_for_city_names += Insert_Page_Break_PDF()
                                string_for_city_names += Build_PDF_Header_Final("Charter Report", sub_info, real_make_model_name, real_company_name, sub_type, "", "", airframe, False)
                                string_for_city_names += Build_PDF_Column_Start(page_title, title, "Continued", sub_title, 2).ToString
                                hidden_counter = 0
                            ElseIf hidden_counter = 30 Then
                                string_for_city_names = string_for_city_names & Build_PDF_Column_2(sub_title, 2, page_title)
                            End If


                            string_for_city_names = string_for_city_names & "<tr bgcolor='" & bgcolor & "'><td align='left'>" & string_for_link
                            string_for_city_names = string_for_city_names & Replace(localAdoRs2("comp_city").ToString, "'", " ")

                            If Not IsDBNull(localAdoRs2("comp_state")) Then
                                If Trim(localAdoRs2("comp_state").ToString.Trim) <> "" Then
                                    string_for_city_names = string_for_city_names & ", " & Replace(localAdoRs2("comp_state").ToString, "'", " ")
                                End If
                            End If

                            string_for_city_names = string_for_city_names & "</a>"
                            string_for_city_names = string_for_city_names & "</td><td align='right'>"
                            string_for_city_names = string_for_city_names & FormatNumber(CStr(localAdoRs2("comp_count").ToString), 0)
                            string_for_city_names = string_for_city_names & "</td></tr>"

                            x = x + localAdoRs2("comp_count")
                            hidden_counter = hidden_counter + 1
                        End If
                    End If


                Loop



            Else

            End If

            localAdoRs2.Close()


            string_for_city_names = string_for_city_names & "</td></tr></table></td></tr></table></td></tr></table>"



            display_acContactType_location_piechart_city = Build_PDF_Column_Start(page_title, title, "", sub_title, 2) & string_for_city_names
        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try

    End Function

    Function acContactType_companies(ByVal inAmodID, ByVal real_make_model_name, ByVal inCompanyID, ByVal airframe_type, ByVal country, ByVal City, ByVal sub_info, ByVal real_company_name, ByVal sub_type)
        acContactType_companies = ""
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim localAdoRs2 As System.Data.SqlClient.SqlDataReader : localAdoRs2 = Nothing
        Dim htmlOutput As String = ""
        Dim query As String = ""
        Dim counter1 As Integer = 0
        Dim starter_string As String = ""
        Dim title As String = ""
        Dim sub_title As String = ""
        Dim page_title As String = ""
        Dim counter_show As Integer = 0
        Dim text_for_counter_to_show As String = ""


        Try


            If Trim(inAmodID) = "" Then inAmodID = 0
            If Trim(inCompanyID) = "" Then inCompanyID = 0

            acContactType_companies = ""

            If CLng(inCompanyID) > 0 Then
                query = "SELECT DISTINCT comp_id, comp_address1, count(distinct ac_id) AS ac_count, comp_address2, comp_city, comp_state, comp_zip_code, comp_country"
            ElseIf CLng(inAmodID) > 0 And CLng(inCompanyID) = 0 Then
                query = "SELECT DISTINCT TOP 250 comp_id, comp_address1, comp_name, count(distinct ac_id) AS ac_count, comp_address2, comp_city, comp_state, comp_zip_code, comp_country"
            ElseIf Trim(country) <> "" Or Trim(City) <> "" Then
                query = "SELECT DISTINCT TOP 250 comp_id, comp_address1, comp_name, count(distinct ac_id) AS ac_count, comp_address2, comp_city, comp_state, comp_zip_code, comp_country"
            Else
                query = "SELECT DISTINCT TOP 50 comp_id, comp_address1, comp_name, count(distinct ac_id) AS ac_count, comp_address2, comp_city, comp_state, comp_zip_code, comp_country"
            End If

            query = query & " FROM aircraft_summary WITH(NOLOCK)"
            query = query & " WHERE ac_lifecycle_stage = 3 AND (cref_contact_type IN ('94','33') OR cref_business_type in ('CH'))"

            If CLng(inCompanyID) > 0 Then
                query = query & " AND comp_id = " & CStr(inCompanyID)
            End If

            If CLng(inAmodID) > 0 Then
                query = query & " AND amod_id = " & CStr(inAmodID)
            End If

            If Trim(country) <> "" Then
                query = query & " and comp_country='" & country & "' "
            End If

            If Trim(City) <> "" Then
                query = query & " and comp_city='" & City & "' "
            End If

            If Trim(airframe_type) <> "" Then
                query = query & " AND amod_airframe_type_code = '" & Trim(airframe_type) & "'"
            End If

            ' query = query & " " + commonEVO.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, False)
            query = query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, True)


            query = query & " GROUP BY comp_name, comp_id, comp_address1, comp_address2, comp_city, comp_state, comp_zip_code, comp_country"
            query = query & " ORDER BY ac_count DESC, comp_name asc"

            If Session("debug") Then
                If CLng(inCompanyID) > 0 Then
                    Response.Write("<b>acContactType_companies (companyId > 0) : " & Server.HtmlEncode(query) & "</b><br /><br />")
                ElseIf CLng(inAmodID) > 0 And CLng(inCompanyID) = 0 Then
                    Response.Write("<b>acContactType_companies (aModId > 0 and companyId = 0) : " & Server.HtmlEncode(query) & "</b><br /><br />")
                Else
                    Response.Write("<b>acContactType_companies (TOP 50) : " & Server.HtmlEncode(query) & "</b><br /><br />")
                End If
            End If

            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = query
            localAdoRs2 = SqlCommand.ExecuteReader()

            If CLng(inCompanyID) > 0 Then
                title = title & "CHARTER&nbsp;OPERATOR&nbsp;INFO</em>" & vbCrLf
            ElseIf CLng(inAmodID) > 0 And CLng(inCompanyID) = 0 Then
                title = title & "CHARTER OPERATORS "
                If Trim(real_make_model_name) <> "" Then
                    title = title & " for " & real_make_model_name
                End If

                If Trim(City) <> "" Then
                    title = title & " in " & City
                ElseIf Trim(country) <> "" Then
                    title = title & " in " & country
                End If

                title = title & " <em> by number of aircraft</em>" & vbCrLf
            ElseIf Trim(country) <> "" Or Trim(City) <> "" Then



                If Trim(airframe_type) <> "" Then
                    If Trim(airframe_type) = "F" Then
                        title = title & "Fixed Airframe - "
                    ElseIf Trim(airframe_type) = "R" Then
                        title = title & "Rotary Airframe - "
                    End If
                End If
                title = title & "CHARTER OPERATORS "
                If Trim(real_make_model_name) <> "" Then
                    title = title & " for " & real_make_model_name
                End If

                If Trim(City) <> "" Then
                    title = title & " in " & City
                ElseIf Trim(country) <> "" Then
                    title = title & " in " & country
                End If

                title = title & " <em> by number of aircraft</em>" & vbCrLf
            Else

                If Trim(airframe_type) <> "" Then
                    If Trim(airframe_type) = "F" Then
                        title = title & "Fixed Airframe - "
                    ElseIf Trim(airframe_type) = "R" Then
                        title = title & "Rotary Airframe - "
                    End If
                End If
                title = title & "CHARTER OPERATORS<em> "
                If Trim(airframe_type) <> "" Then
                    title = title & "<br>"
                End If
                title = title & "(Top 50) by number of aircraft</em>" & vbCrLf
            End If


            sub_title = sub_title & "<table cellspacing='0' cellpadding='0' border='0' width='100%'><tr><td valign='middle' align='left' width='60%'><strong>Operator&nbsp;Name</strong></td>" & vbCrLf
            sub_title = sub_title & "<td valign='middle' align='right'><strong># of Aircraft</strong></td></tr></table>" & vbCrLf

            page_title = "charter_operators"

            If localAdoRs2.HasRows Then


                If CLng(inCompanyID) = 0 Then

                    Do While localAdoRs2.Read ' selectAcContactCompany



                        If counter1 = 30 Then
                            htmlOutput += Build_PDF_Template_Footer()
                            htmlOutput += Build_PDF_Template_Footer()
                            htmlOutput += Insert_Page_Break_PDF()
                            htmlOutput += Build_PDF_Header_Final("Charter Report", sub_info, real_make_model_name, real_company_name, sub_type, "", "", airframe_type, False)
                            htmlOutput += Build_PDF_Column_Start(page_title, title, "Continued", sub_title, 4).ToString
                            counter1 = 0
                        ElseIf counter1 = 15 Then
                            htmlOutput = htmlOutput & Build_PDF_Column_2(sub_title, 4, page_title)
                        End If

                        If CLng(localAdoRs2("ac_count").ToString) > 0 Then

                            htmlOutput = htmlOutput & "<tr height='59'><td align='left' valign='top' class='seperator'><img src='" & location_string & "images/ch_red.jpg' class='bullet'/></td>" & vbCrLf
                            htmlOutput = htmlOutput & "<td align='left' valign='top' class='seperator'><font size='-3'>"
                            htmlOutput = htmlOutput & localAdoRs2("comp_name") & "<br>"

                            If Not IsDBNull(localAdoRs2("comp_address1")) Then
                                If localAdoRs2("comp_address1") <> "" Then
                                    htmlOutput = htmlOutput & localAdoRs2("comp_address1") & "<br>"
                                End If
                            End If

                            If Not IsDBNull(localAdoRs2("comp_address2")) Then
                                If localAdoRs2("comp_address2") <> "" Then
                                    htmlOutput = htmlOutput & localAdoRs2("comp_address2") & "<br>"
                                End If
                            End If

                            htmlOutput = htmlOutput & localAdoRs2("comp_city") & ","
                            htmlOutput = htmlOutput & localAdoRs2("comp_state") & " "
                            htmlOutput = htmlOutput & localAdoRs2("comp_zip_code") & " "
                            htmlOutput = htmlOutput & localAdoRs2("comp_country")


                            htmlOutput = htmlOutput & "</font></td>" & vbCrLf
                            htmlOutput = htmlOutput & "<td align='left' valign='top' class='seperator'>"
                            htmlOutput = htmlOutput & get_company_cert_images(CStr(localAdoRs2("comp_id").ToString), False)
                            htmlOutput = htmlOutput & "</td>"
                            htmlOutput = htmlOutput & "<td align='right' valign='top' class='seperator'><font size='-3'>" & CStr(localAdoRs2("ac_count").ToString) & "</font></td></tr>" & vbCrLf

                        End If

                        counter1 = counter1 + 1
                        counter_show = counter_show + 1
                    Loop

                Else

                    htmlOutput = htmlOutput & "<tr><td align='left' valign='top' class='seperator' colspan='3'>"
                    htmlOutput = htmlOutput & "<td align='left' valign='top' class='seperator'>" & CStr(localAdoRs2("ac_count").ToString) & "</td></tr>" & vbCrLf
                    htmlOutput = htmlOutput & "</td></tr>"

                End If

            Else

                sub_title = "No data matches for your search criteria"

            End If

            htmlOutput = htmlOutput & "</table></td></tr>"

            htmlOutput = htmlOutput & "</table></td></tr></table></td></tr></td></table>"


            If counter_show = 250 Then
                title = "TOP 250 " & title
                text_for_counter_to_show = ""
            ElseIf counter_show = 30 And CLng(inAmodID) = 0 And CLng(inCompanyID) = 0 And country.ToString.Trim = "" Or City.ToString.Trim = "" Then
                text_for_counter_to_show = ""
            Else
                text_for_counter_to_show = counter_show.ToString
            End If

            htmlOutput = Build_PDF_Column_Start(page_title, title, text_for_counter_to_show, sub_title, 4) & htmlOutput
            acContactType_companies = Trim(htmlOutput)
        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function
    Function get_company_cert_images(ByVal comp_id, ByVal IsCompanySelected)

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim localAdoRs2 As System.Data.SqlClient.SqlDataReader : localAdoRs2 = Nothing
        Dim counter1
        Dim query2 As String = ""
        counter1 = 1
        get_company_cert_images = ""


        Try



            query2 = "select  ccerttype_id, ccerttype_type, ccerttype_logo_image from company_certification "
            query2 = query2 & " inner join company_certification_type on ccert_type_id = ccerttype_id"
            query2 = query2 & " where ccert_journ_id = 0 and ccert_comp_id = " & comp_id
            query2 = query2 & " and ccerttype_logo_image <> '' "
            '  query2 = query2 & " and ccerttype_type in ('IS-BOA', 'AOC', 'ARG/US Gold', 'ARG/US Platnum') "



            ' 'Select Case Application.Item("webHostObject").evoWebHostType
            '   'Case eWebSiteTypes.LOCAL
            '  'SqlConn.ConnectionString = My.Settings.DEFAULT_LOCAL_MSSQL
            '  Case Else
            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            '  End Select

            ' End Select
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = query2
            localAdoRs2 = SqlCommand.ExecuteReader()


            If IsCompanySelected Then

                get_company_cert_images = get_company_cert_images & "<table id='acContactTypeCompaniesOuterTable' width='100%' height=' & table_height & ' cellpadding='1' cellspacing='0' class='module'>" & vbCrLf
                get_company_cert_images = get_company_cert_images & "<tr><td valign='top' align='left' class='header'>CHARTER&nbsp;OPERATOR&nbsp;CERTIFICATES</em></td></tr>" & vbCrLf
                get_company_cert_images = get_company_cert_images & "<tr><td valign='top' align='left'>"
                get_company_cert_images = get_company_cert_images & "<table id='acContactTypeCountiesInnerTable' width='100%' cellpadding='1' cellspacing='0'><tr><Td>" & vbCrLf

                If localAdoRs2.HasRows Then

                    Do While localAdoRs2.Read
                        If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                            get_company_cert_images = get_company_cert_images & "<img height='50' width='50' src='" & location_string & "images/" & localAdoRs2("ccerttype_logo_image") & "' alt='" & localAdoRs2("ccerttype_type") & "'>"
                        Else
                            get_company_cert_images = get_company_cert_images & "<img width='50' src='" & location_string & "images/" & localAdoRs2("ccerttype_logo_image") & "' alt='" & localAdoRs2("ccerttype_type") & "'>"
                        End If


                    Loop

                Else
                    get_company_cert_images = get_company_cert_images & "No Certificate Information Available"
                End If

                get_company_cert_images = get_company_cert_images & "</td></tr></table></td></tr></table>"

            Else



                If localAdoRs2.HasRows Then

                    get_company_cert_images = get_company_cert_images & "<table><tr>"


                    Do While localAdoRs2.Read
                        If counter1 > 2 Then
                            get_company_cert_images = get_company_cert_images & "</tr><tr><td>"
                            counter1 = 1
                        Else
                            get_company_cert_images = get_company_cert_images & "<td>"
                        End If

                        If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                            get_company_cert_images = get_company_cert_images & "<img height='21' width='21' src='" & location_string & "images/" & localAdoRs2("ccerttype_logo_image") & "' alt='" & localAdoRs2("ccerttype_type") & "'>"
                        Else
                            get_company_cert_images = get_company_cert_images & "<img width='21' src='" & location_string & "images/" & localAdoRs2("ccerttype_logo_image") & "' alt='" & localAdoRs2("ccerttype_type") & "'>"
                        End If

                        'get_company_cert_images = get_company_cert_images & Cstr(adors("ccerttype_id").ToString)

                        get_company_cert_images = get_company_cert_images & "</td>"
                        counter1 = counter1 + 1
                    Loop

                    get_company_cert_images = get_company_cert_images & "</table>"

                Else

                End If


            End If


            localAdoRs2.Close()
        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function
    Function get_companies_associated_names(ByVal ac_id, ByVal amod_id, ByVal airframe_type)
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim localAdoRs2 As System.Data.SqlClient.SqlDataReader : localAdoRs2 = Nothing
        Dim htmlOutput As String = ""
        Dim query2 As String = ""
        Dim total_Aircraft As String = ""
        get_companies_associated_names = ""

        Try

            query2 = ""
            query2 = query2 & "SELECT distinct cref_comp_id, comp_name, comp_city, comp_state FROM aircraft_reference WITH(NOLOCK)"
            query2 = query2 & " inner join company on cref_comp_id = comp_id and cref_journ_id = comp_journ_id "
            query2 = query2 & " WHERE cref_ac_id = " & Trim(ac_id)
            query2 = query2 & " AND ((cref_contact_type IN ('94','33') OR cref_business_type = 'CH') and cref_journ_id = 0)"


            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            '  End Select

            ' End Select
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = query2
            localAdoRs2 = SqlCommand.ExecuteReader()


            If localAdoRs2.HasRows Then


                Do While localAdoRs2.Read


                    get_companies_associated_names = get_companies_associated_names & "<font size='-1'>" & localAdoRs2("comp_name").ToString.Trim & " - </font><font size='-1'>" & localAdoRs2("comp_city").ToString.Trim

                    If Not IsDBNull(localAdoRs2("comp_state")) Then
                        If localAdoRs2("comp_state") <> "" Then
                            get_companies_associated_names = get_companies_associated_names & "</font><font size='-1'>, " & localAdoRs2("comp_state").ToString.Trim & "</a>"
                        End If
                    End If

                    get_companies_associated_names = get_companies_associated_names & "</font><br>"

                    'get_companies_associated_names = get_companies_associated_names & get_company_name(localAdoRs2("cref_comp_id")) & "<br>"
                    'get_companies_associated_names = get_companies_associated_names & commonEVO.get_company_name_fromID(Session.Item("localSubscription"), localAdoRs2("cref_comp_id"), 0, True) & "<br>"

                Loop

            Else

            End If

            localAdoRs2.Close()
        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try

    End Function

    Function acContactType_models(ByVal inAmodID, ByVal inCompanyID, ByVal prog_makemodel, ByVal company_name, ByVal airframe_type, ByVal country, ByVal City, ByVal sub_type, ByVal sub_info)

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim localAdoRs2 As System.Data.SqlClient.SqlDataReader : localAdoRs2 = Nothing
        Dim htmlOutput As String = ""
        Dim query As String = ""
        Dim total_Aircraft As String = ""
        Dim title As String = ""
        Dim sub_title As String = ""
        Dim table_name As String = ""
        Dim hidden_counter As Integer = 0
        Dim real_counter As Integer = 0
        Dim real_counter_text As String = ""

        If Trim(inAmodID) = "" Then inAmodID = 0
        If Trim(inCompanyID) = "" Then inCompanyID = 0

        acContactType_models = ""


        table_name = "charter_models"

        Try
            If inCompanyID > 0 Or country <> "" Or City <> "" Then
                query = "SELECT DISTINCT amod_id, amod_airframe_type_code, amod_type_code, amod_make_name, amod_model_name, count(distinct ac_id) AS ac_count"
            Else
                query = "SELECT DISTINCT TOP 50 amod_id, amod_airframe_type_code, amod_type_code, amod_make_name, amod_model_name, count(distinct ac_id) AS ac_count"
            End If

            query = query & " FROM aircraft_summary WITH(NOLOCK) "
            query = query & " WHERE ac_lifecycle_stage = 3"

            If CLng(inAmodID) > 0 Then
                query = query & " AND amod_id = " & CStr(inAmodID)
            End If



            If Trim(airframe_type) <> "" Then
                query = query & " AND amod_airframe_type_code = '" & Trim(airframe_type) & "'"
            End If

            If CLng(inCompanyID) > 0 Then
                query = query & " AND comp_id = " & CStr(inCompanyID)
            End If

            If Trim(country) <> "" Then
                query = query & " and comp_country='" & country & "' "
            End If

            If Trim(City) <> "" Then
                query = query & " and comp_city='" & City & "' "
            End If

            query = query & " AND (cref_contact_type IN ('94','33') OR cref_business_type = 'CH')"

            ' query = query & " " + commonEVO.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, False)
            query = query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, True)

            query = query & " GROUP BY amod_airframe_type_code, amod_type_code, amod_make_name, amod_model_name, amod_id"
            query = query & " ORDER BY ac_count DESC"

            If Session("debug") Then
                Response.Write("<b>acContactType_models:" & Server.HtmlEncode(query) & "</b><br /><br />")
            End If

            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = query
            localAdoRs2 = SqlCommand.ExecuteReader()


            If CLng(inCompanyID) > 0 Then
                title = title & "AIRCRAFT CHARTER MODELS"
            ElseIf Trim(country) <> "" Or Trim(City) <> "" Then
                title = title & "AIRCRAFT CHARTER MODELS "

                If Trim(City) <> "" Then
                    title = title & " in " & City
                ElseIf Trim(country) <> "" Then
                    title = title & " in " & country
                End If

            Else
                title = title & "AIRCRAFT " & "CHARTER" & " MODELS <em>(Top 50) most popular models"
            End If


            If Trim(company_name) <> "" And Trim(prog_makemodel) <> "" Then
                sub_title = sub_title & company_name & " - " & prog_makemodel
            ElseIf Trim(company_name) <> "" Then
                sub_title = sub_title & company_name
                If Trim(airframe_type) <> "" Then
                    If Trim(airframe_type) = "F" Then
                        sub_title = sub_title & " - Fixed Airframe"
                    ElseIf Trim(airframe_type) = "R" Then
                        sub_title = sub_title & " - Rotary Airframe"
                    End If
                End If
            ElseIf Trim(prog_makemodel) <> "" Then
                sub_title = sub_title & prog_makemodel
            ElseIf Trim(airframe_type) <> "" Then
                If Trim(airframe_type) = "F" Then
                    sub_title = sub_title & "Fixed Airframe"
                ElseIf Trim(airframe_type) = "R" Then
                    sub_title = sub_title & "Rotary Airframe"
                End If
            End If


            If localAdoRs2.HasRows Then


                Do While localAdoRs2.Read

                    If hidden_counter = 60 Then
                        htmlOutput = htmlOutput & Build_PDF_Template_Footer()
                        htmlOutput = htmlOutput & Insert_Page_Break_PDF()
                        htmlOutput = htmlOutput & Build_PDF_Header_Final("Charter Report", sub_info, prog_makemodel, company_name, sub_type, country, City, airframe_type, False)
                        htmlOutput = htmlOutput & Build_PDF_Column_Start(table_name, title, "Continued", sub_title, 2)
                        hidden_counter = 0
                    ElseIf hidden_counter = 30 Then
                        htmlOutput = htmlOutput & Build_PDF_Column_2("", 2, table_name)
                    End If


                    htmlOutput = htmlOutput & "<tr><td align='left' valign='top' class='seperator' width='80%'>" & localAdoRs2("amod_make_name") & "&nbsp;/&nbsp;" & localAdoRs2("amod_model_name") & "</td>" & vbCrLf
                    htmlOutput = htmlOutput & "<td align='right' valign='top' class='seperator' width='20%' style='padding-right:15px;'>" & localAdoRs2("ac_count") & "</td></tr>" & vbCrLf

                    real_counter = real_counter + 1
                    hidden_counter = hidden_counter + 1
                Loop



            Else
                htmlOutput = htmlOutput & "<tr><td valign='top' align='left' class='seperator'>No data matches for your search criteria</td></tr>" & vbCrLf
            End If


            htmlOutput = htmlOutput & "</table></td></tr></table></td></tr></td></table></td>"

            If real_counter = 50 And inCompanyID = 0 Or country = "" Or City = "" Then
                real_counter_text = ""
            Else
                real_counter_text = real_counter.ToString.Trim
            End If

            acContactType_models = Build_PDF_Column_Start(table_name, title, real_counter_text, sub_title, 2) & Trim(htmlOutput)
        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function

    Function display_aircraft_summary(ByRef real_make_model_name, ByVal inModelID)

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim adors As System.Data.SqlClient.SqlDataReader : adors = Nothing
        Dim fleetinfo As System.Data.SqlClient.SqlDataReader : fleetinfo = Nothing
        Dim specinfo As System.Data.SqlClient.SqlDataReader : specinfo = Nothing
        Dim htmlOutput As String = ""
        Dim query As String = ""
        Dim strHTML As String = ""
        Dim imgFolder As String = ""
        Dim theImgFile As String = ""
        Dim num As Integer = 0
        Dim count As Integer = 0
        Dim i As Integer = 0
        Dim avgyear As Integer = 0
        Dim totalcount As Integer = 0
        Dim totalInOpcount As Integer = 0
        Dim ac_for_sale As Integer = 0
        Dim ac_exclusive_sale As Integer = 0
        Dim ac_lease As Integer = 0
        Dim w_owner As Integer = 0
        Dim s_owner As Integer = 0
        Dim f_owner As Integer = 0
        Dim o_stage As Integer = 0
        Dim t_stage As Integer = 0
        Dim th_stage As Integer = 0
        Dim f_stage As Integer = 0
        Dim daysonmarket As Integer = 0
        Dim daysonmarket2 As Integer = 0
        Dim forsaleavghigh As Integer = 0
        Dim forsaleavlow As Integer = 199999999
        Dim this_counter As Integer = 0
        Dim crew As Integer = 0
        Dim passengers As Integer = 0
        Dim fieldlength As Integer = 0
        Dim ac_ext_width As String = ""
        Dim ac_ext_height As String = ""
        Dim ac_int_length As String = ""
        Dim ac_int_height As String = ""
        Dim ac_int_width As String = ""
        Dim range As Integer = 0
        Dim rangetanksfull As Integer = 0
        Dim rangeseatsfull As Integer = 0
        Dim knots As Integer = 0
        Dim climb As Integer = 0
        Dim miles As Integer = 0
        Dim hours As Integer = 0
        Dim directcost As Integer = 0
        Dim fixedcostd As Integer = 0
        Dim totalcost As Integer = 0
        Dim perhour As Integer = 0
        Dim perseat As Integer = 0

        Dim num2 As Boolean = True
        display_aircraft_summary = ""

        Try

            '--------------------------------------------------- FLEET INFO FOR LEFT----------------------------------------------

            query = "SELECT distinct ac_id, ac_ownership_type, ac_lifecycle_stage, ac_forsale_flag, "
            query = query & " ac_lease_flag, ac_mfr_year"

            query = query & " FROM Aircraft_Summary WITH(NOLOCK) "
            query = query & " WHERE amod_id = " & inModelID
            query = query & " AND (cref_contact_type IN ('94','33') OR cref_business_type = 'CH')"

            '  query = query & commonEVO.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, True)
            query = query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, True)


            query = query & " group by ac_id, ac_ownership_type, ac_lifecycle_stage, ac_forsale_flag, ac_lease_flag, ac_mfr_year "

            If Session("debug") Then
                Response.Write("<b>getFleetInfo : " & Server.HtmlEncode(query) & "</b><br /><br />")
            End If



            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = query
            fleetinfo = SqlCommand.ExecuteReader()


            If fleetinfo.HasRows Then


                Do While fleetinfo.Read

                    If this_counter = 0 Then
                        If Not IsDBNull(fleetinfo("ac_mfr_year")) Then
                            If IsNumeric(fleetinfo("ac_mfr_year")) Then
                                allhigh = CInt(fleetinfo("ac_mfr_year"))
                                alllow = CInt(fleetinfo("ac_mfr_year"))
                            End If
                        Else
                            allhigh = 0
                            alllow = CInt(Year(Now()))
                        End If

                    End If

                    If Not IsDBNull(fleetinfo("ac_mfr_year")) Then
                        If IsNumeric(fleetinfo("ac_mfr_year")) Then

                            If CInt(fleetinfo("ac_mfr_year")) > CInt(allhigh) Then
                                allhigh = CInt(fleetinfo("ac_mfr_year"))
                            End If

                            If CInt(fleetinfo("ac_mfr_year")) < CInt(alllow) Then
                                alllow = CInt(fleetinfo("ac_mfr_year"))
                            End If

                        End If
                    End If

                    totalcount = totalcount + 1

                    If Not IsDBNull(fleetinfo("ac_lifecycle_stage")) Then
                        If fleetinfo("ac_lifecycle_stage") = 3 And
                          (fleetinfo("ac_ownership_type") = "S" Or fleetinfo("ac_ownership_type") = "F" Or fleetinfo("ac_ownership_type") = "W") Then
                            totalInOpcount = totalInOpcount + 1
                        End If
                    End If

                    If Not IsDBNull(fleetinfo("ac_ownership_type")) Then
                        If fleetinfo("ac_ownership_type") = "W" And fleetinfo("ac_lifecycle_stage") = 3 Then
                            w_owner = w_owner + 1
                        End If
                    End If

                    If Not IsDBNull(fleetinfo("ac_ownership_type")) Then
                        If fleetinfo("ac_ownership_type") = "F" And fleetinfo("ac_lifecycle_stage") = 3 Then
                            f_owner = f_owner + 1
                        End If
                    End If

                    If Not IsDBNull(fleetinfo("ac_ownership_type")) Then
                        If fleetinfo("ac_ownership_type") = "S" And fleetinfo("ac_lifecycle_stage") = 3 Then
                            s_owner = s_owner + 1
                        End If
                    End If

                    If Not IsDBNull(fleetinfo("ac_lifecycle_stage")) Then
                        If fleetinfo("ac_lifecycle_stage") = 1 Then
                            o_stage = o_stage + 1
                        End If
                    End If

                    If Not IsDBNull(fleetinfo("ac_lifecycle_stage")) Then
                        If fleetinfo("ac_lifecycle_stage") = 2 Then
                            t_stage = t_stage + 1
                        End If
                    End If

                    If Not IsDBNull(fleetinfo("ac_lifecycle_stage")) And Not IsDBNull(fleetinfo("ac_ownership_type")) Then
                        If fleetinfo("ac_lifecycle_stage") = 3 And
                          (fleetinfo("ac_ownership_type") = "S" Or fleetinfo("ac_ownership_type") = "F" Or fleetinfo("ac_ownership_type") = "W") Then
                            th_stage = th_stage + 1
                        End If
                    End If

                    If Not IsDBNull(fleetinfo("ac_lifecycle_stage")) Then
                        If fleetinfo("ac_lifecycle_stage") = 4 Then
                            f_stage = f_stage + 1
                        End If
                    End If



                    If Not IsDBNull(fleetinfo("ac_lease_flag")) Then
                        If fleetinfo("ac_lease_flag") = "Y" Then
                            ac_lease = ac_lease + 1
                        End If
                    End If

                    this_counter = this_counter + 1
                Loop

                fleetinfo.Close()

                If num = True Then
                    forsaleavlow = forsaleavghigh
                End If

                If (forsaleavlow > 0) Then
                    forsaleavlow = CDbl(forsaleavlow / 1000)
                    forsaleavlow = FormatCurrency(forsaleavlow, 0)
                    forsaleavlow = forsaleavlow
                End If

                If (forsaleavghigh > 0) Then
                    forsaleavghigh = CDbl(forsaleavghigh / 1000)
                    forsaleavghigh = FormatCurrency(forsaleavghigh, 0)
                    forsaleavghigh = forsaleavghigh
                End If

                If (ac_for_sale > 0 And th_stage > 0) Then

                    per = CDbl(ac_for_sale / th_stage * 100)
                    per2 = CDbl(ac_exclusive_sale / ac_for_sale * 100)
                    per3 = CDbl(ac_lease / th_stage * 100)

                    If daysonmarket > 0 Then
                        days = FormatNumber(CLng(daysonmarket2) / CLng(daysonmarket), 0)
                    Else
                        days = FormatNumber(CLng(daysonmarket2), 0)
                    End If

                End If

                If (alllow >= 0 And allhigh > 0) Then
                    For i = alllow To allhigh
                        avgyear = avgyear + i
                        count = count + 1
                    Next
                End If

                If avgyear > 0 And count > 0 Then
                    avgyear = CLng(avgyear / count)
                    avgyear = FormatNumber(avgyear, 0, False, True, False)
                End If

                'Response.write " ALLHIGH:" & allhigh
                'Response.write " ALLLOW:" & alllow
                'Response.write " FORSALEAVLOW:" & forsaleavlow
                'Response.write " FORSALEAVGHIGH:" & forsaleavghigh
                'Response.write " AVGMFRYEAR:" & avgyear
                'Response.write " COUNT:" & count

            End If

            fleetinfo = Nothing

        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try




        '------------------------------------------------------------ END OF FLEET INFO FOR LEFT-----------------------------------

        strHTML = strHTML & "<table id='dealerMarketViewInnerTable' width='100%' cellpadding='1' cellspacing='0'>"
        strHTML = strHTML & "<tr><td align='left' valign='top' width='100%'>"

        strHTML = strHTML & "<table id='fleetTable' width='100%' height='380' cellpadding='1' cellspacing='0' class='module'>"

        strHTML = strHTML & "<tr><td align='left' valign='middle' class='header' style='padding-left:3px;'>" & "CHARTER " & real_make_model_name.ToString.ToUpper & " FLEET INFORMATION</td></tr>"

        strHTML = strHTML & "<tr><td align='center' valign='top'>"
        strHTML = strHTML & "<br /><br />"
        imgFolder = check_model_pic_exists(inModelID, 400)

        strHTML = strHTML & imgFolder

        strHTML = strHTML & "<br /><br>"



        strHTML = strHTML & "<table id='ownerShipTable' width='90%' cellspacing='0' cellpadding='4' align='center'><tr><td align='center'>" 'added to put these 2 into columns

        strHTML = strHTML & "<table id='ownerShipTable' width='40%' cellspacing='0' cellpadding='4' class='leftside'>"


        strHTML = strHTML & "<tr><td valign='middle' align='center' class='tabheader'><strong>Charter Ownership</strong><br /><em>(in&nbsp;operation)</em></td><td class='border_bottom'>&nbsp;</td></tr>"

        If CLng(w_owner) > 0 Then
            strHTML = strHTML & "<tr><td valign='top' align='left' class='seperator'>Whole</td><td valign='top' align='right' class='rightside'>" & FormatNumber(w_owner, 0, True, False, True) & "</td></tr>"
        Else
            strHTML = strHTML & "<tr><td valign='top' align='left' class='seperator'>Whole</td><td valign='top' align='right' class='rightside'>0</td></tr>"
        End If

        If CLng(s_owner) > 0 Then
            strHTML = strHTML & "<tr><td valign='top' align='left' class='seperator'>Shared</td><td valign='top' align='right' class='rightside'>" & FormatNumber(s_owner, 0, True, False, True) & "</td></tr>"
        Else
            strHTML = strHTML & "<tr><td valign='top' align='left' class='seperator'>Shared</td><td valign='top' align='right' class='rightside'>0</td></tr>"
        End If

        If CLng(f_owner) > 0 Then
            strHTML = strHTML & "<tr><td valign='top' align='left' class='seperator'>Fractional</td><td valign='top' align='right' class='rightside'>" & FormatNumber(f_owner, 0, True, False, True) & "</td></tr>"
        Else
            strHTML = strHTML & "<tr><td valign='top' align='left' class='seperator'>Fractional</td><td valign='top' align='right' class='rightside'>0</td></tr>"
        End If

        If CLng(totalInOpcount) > 0 Then
            strHTML = strHTML & "<tr><td valign='top' align='left' class='seperator'>Total Aircraft</td><td valign='top' align='right' class='rightside'>" & FormatNumber(totalInOpcount, 0, True, False, True) & "</td></tr>"
        Else
            strHTML = strHTML & "<tr bgcolor='#F8F8F8'><td valign='top' align='left' class='seperator' nowrap='nowrap'>Total Aircraft</td><td valign='top' align='right' class='rightside'>0</td></tr>"
        End If

        If CLng(alllow) > 0 And CLng(allhigh) > 0 Then
            strHTML = strHTML & "<tr><td valign='top' align='left' class='border_bottom' nowrap='nowrap'>MFR Year Range</td><td class='border_bottom_right' valign='top' align='right' nowrap='nowrap'>" & alllow & " - " & allhigh & "</td></tr>"
        ElseIf CLng(alllow) > 0 And CLng(allhigh) = 0 Then
            strHTML = strHTML & "<tr><td valign='top' align='left' class='border_bottom' nowrap='nowrap'>MFR Year Range</td><td class='border_bottom_right' valign='top' align='right' nowrap='nowrap'>" & alllow & " - To Present</td></tr>"
        Else
            strHTML = strHTML & "<tr><td valign='top' align='left' class='border_bottom' nowrap='nowrap'>MFR Year Range</td><td class='border_bottom_right' valign='top' align='right' nowrap='nowrap'>N/A</td></tr>"
        End If

        strHTML = strHTML & "</table>"



        '------------------------------------------------------------ START OF FLEET INFO FOR RIGHT-----------------------------------


        allhigh = 0
        alllow = 1999999999
        daysonmarket = 0
        daysonmarket2 = 0
        totalInOpcount = 0
        w_owner = 0
        f_owner = 0
        s_owner = 0
        o_stage = 0
        t_stage = 0
        th_stage = 0
        f_stage = 0
        ac_for_sale = 0
        ac_exclusive_sale = 0
        ac_lease = 0


        this_counter = 0


        query = "SELECT ac_id, ac_ownership_type, ac_lifecycle_stage, ac_forsale_flag, ac_exclusive_flag,"
        query = query & " ac_lease_flag, ac_asking, ac_asking_price, ac_list_date, ac_mfr_year, datediff(day, ac_list_date, getdate()) AS daysonmarket"
        query = query & " FROM Aircraft WITH(NOLOCK) INNER JOIN Aircraft_Model WITH(NOLOCK) ON ac_amod_id = amod_id"
        query = query & " WHERE ac_amod_id = " & inModelID & " AND ac_journ_id = 0"
        ' query &= " " + commonEVO.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, True)
        query = query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, True)

        If Session("debug") Then
            Response.Write("<b>getFleetInfo : " & Server.HtmlEncode(query) & "</b><br /><br />")
        End If

        Try

            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = query
            fleetinfo = SqlCommand.ExecuteReader()



            If fleetinfo.HasRows Then


                Do While fleetinfo.Read

                    If this_counter = 0 Then

                        If Not IsDBNull(fleetinfo("ac_mfr_year")) Then
                            If IsNumeric(fleetinfo("ac_mfr_year")) Then
                                allhigh = CInt(fleetinfo("ac_mfr_year"))
                                alllow = CInt(fleetinfo("ac_mfr_year"))
                            End If
                        Else
                            allhigh = 0
                            alllow = CInt(Year(Now()))
                        End If

                    End If



                    If Not IsDBNull(fleetinfo("daysonmarket")) Then
                        If CLng(fleetinfo("daysonmarket")) > 0 Then
                            daysonmarket = daysonmarket + 1
                            daysonmarket2 = daysonmarket2 + CLng(fleetinfo("daysonmarket"))
                        End If
                    End If


                    If Not IsDBNull(fleetinfo("ac_mfr_year")) Then
                        If IsNumeric(fleetinfo("ac_mfr_year")) Then

                            If CInt(fleetinfo("ac_mfr_year")) > CInt(allhigh) Then
                                allhigh = CInt(fleetinfo("ac_mfr_year"))
                            End If

                            If CInt(fleetinfo("ac_mfr_year")) < CInt(alllow) Then
                                alllow = CInt(fleetinfo("ac_mfr_year"))
                            End If

                        End If
                    End If

                    totalcount = totalcount + 1




                    If Not IsDBNull(fleetinfo("ac_lifecycle_stage")) Then
                        If fleetinfo("ac_lifecycle_stage") = 3 And
                          (fleetinfo("ac_ownership_type") = "S" Or fleetinfo("ac_ownership_type") = "F" Or fleetinfo("ac_ownership_type") = "W") Then
                            totalInOpcount = totalInOpcount + 1
                        End If
                    End If

                    If Not IsDBNull(fleetinfo("ac_ownership_type")) Then
                        If fleetinfo("ac_ownership_type") = "W" And fleetinfo("ac_lifecycle_stage") = 3 Then
                            w_owner = w_owner + 1
                        End If
                    End If

                    If Not IsDBNull(fleetinfo("ac_ownership_type")) Then
                        If fleetinfo("ac_ownership_type") = "F" And fleetinfo("ac_lifecycle_stage") = 3 Then
                            f_owner = f_owner + 1
                        End If
                    End If

                    If Not IsDBNull(fleetinfo("ac_ownership_type")) Then
                        If fleetinfo("ac_ownership_type") = "S" And fleetinfo("ac_lifecycle_stage") = 3 Then
                            s_owner = s_owner + 1
                        End If
                    End If

                    If Not IsDBNull(fleetinfo("ac_lifecycle_stage")) Then
                        If fleetinfo("ac_lifecycle_stage") = 1 Then
                            o_stage = o_stage + 1
                        End If
                    End If

                    If Not IsDBNull(fleetinfo("ac_lifecycle_stage")) Then
                        If fleetinfo("ac_lifecycle_stage") = 2 Then
                            t_stage = t_stage + 1
                        End If
                    End If

                    If Not IsDBNull(fleetinfo("ac_lifecycle_stage")) And Not IsDBNull(fleetinfo("ac_ownership_type")) Then
                        If fleetinfo("ac_lifecycle_stage") = 3 And
                          (fleetinfo("ac_ownership_type") = "S" Or fleetinfo("ac_ownership_type") = "F" Or fleetinfo("ac_ownership_type") = "W") Then
                            th_stage = th_stage + 1
                        End If
                    End If

                    If Not IsDBNull(fleetinfo("ac_lifecycle_stage")) Then
                        If fleetinfo("ac_lifecycle_stage") = 4 Then
                            f_stage = f_stage + 1
                        End If
                    End If


                    If Not IsDBNull(fleetinfo("ac_forsale_flag")) Then
                        If fleetinfo("ac_forsale_flag") = "Y" Then
                            ac_for_sale = ac_for_sale + 1

                            If Not IsDBNull(fleetinfo("ac_asking_price")) Then

                                If fleetinfo("ac_asking_price") > 0 Then

                                    If Not IsDBNull(fleetinfo("ac_asking_price")) Then
                                        If CDbl(fleetinfo("ac_asking_price")) > CDbl(forsaleavghigh) Then
                                            forsaleavghigh = fleetinfo("ac_asking_price")
                                        End If
                                    End If

                                    If Not IsDBNull(fleetinfo("ac_asking_price")) Then
                                        If CDbl(fleetinfo("ac_asking_price")) < CDbl(forsaleavlow) Then
                                            forsaleavlow = fleetinfo("ac_asking_price")
                                            num = False
                                        End If
                                    End If

                                End If
                            End If
                        End If
                    End If



                    If Not IsDBNull(fleetinfo("ac_exclusive_flag")) Then
                        If fleetinfo("ac_exclusive_flag") = "Y" Then
                            ac_exclusive_sale = ac_exclusive_sale + 1
                        End If
                    End If



                    If Not IsDBNull(fleetinfo("ac_lease_flag")) Then
                        If fleetinfo("ac_lease_flag") = "Y" Then
                            ac_lease = ac_lease + 1
                        End If
                    End If


                    this_counter = this_counter + 1

                Loop

                fleetinfo.Close()

                If num = True Then
                    forsaleavlow = forsaleavghigh
                End If

                If (forsaleavlow > 0) Then
                    forsaleavlow = CDbl(forsaleavlow / 1000)
                    forsaleavlow = FormatCurrency(forsaleavlow, 0)
                    forsaleavlow = forsaleavlow
                End If

                If (forsaleavghigh > 0) Then
                    forsaleavghigh = CDbl(forsaleavghigh / 1000)
                    forsaleavghigh = FormatCurrency(forsaleavghigh, 0)
                    forsaleavghigh = forsaleavghigh
                End If

                If (ac_for_sale > 0 And th_stage > 0) Then

                    per = CDbl(ac_for_sale / th_stage * 100)
                    per2 = CDbl(ac_exclusive_sale / ac_for_sale * 100)
                    per3 = CDbl(ac_lease / th_stage * 100)

                    If daysonmarket > 0 Then
                        days = FormatNumber(CLng(daysonmarket2) / CLng(daysonmarket), 0)
                    Else
                        days = FormatNumber(CLng(daysonmarket2), 0)
                    End If

                End If

                If (alllow >= 0 And allhigh > 0) Then
                    For i = alllow To allhigh
                        avgyear = avgyear + i
                        count = count + 1
                    Next
                End If

                If avgyear > 0 And count > 0 Then
                    avgyear = CLng(avgyear / count)
                    avgyear = FormatNumber(avgyear, 0, False, True, False)
                End If

                'Response.write " ALLHIGH:" & allhigh
                'Response.write " ALLLOW:" & alllow
                'Response.write " FORSALEAVLOW:" & forsaleavlow
                'Response.write " FORSALEAVGHIGH:" & forsaleavghigh
                'Response.write " AVGMFRYEAR:" & avgyear
                'Response.write " COUNT:" & count

            End If

            fleetinfo = Nothing

        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
        '------------------------------------------------------------ END OF FLEET INFO FOR RIGHT-----------------------------------



        strHTML = strHTML & "</td><td align='center'>"


        strHTML = strHTML & "<table id='ownerShipTable' width='40%' cellspacing='0' cellpadding='4' class='leftside_right'>"
        strHTML = strHTML & "<tr><td valign='middle' align='center' class='tabheader'><strong>Total Ownership</strong><br /><em>(in operation)</em></td><td class='border_bottom'>&nbsp;</td></tr>"

        If CLng(w_owner) > 0 Then
            strHTML = strHTML & "<tr><td valign='top' align='left' class='seperator'>Whole</td><td valign='top' align='right' class='rightside'>" & FormatNumber(w_owner, 0, True, False, True) & "</td></tr>"
        Else
            strHTML = strHTML & "<tr><td valign='top' align='left' class='seperator'>Whole</td><td valign='top' align='right' class='rightside'>0</td></tr>"
        End If

        If CLng(s_owner) > 0 Then
            strHTML = strHTML & "<tr><td valign='top' align='left' class='seperator'>Shared</td><td valign='top' align='right' class='rightside'>" & FormatNumber(s_owner, 0, True, False, True) & "</td></tr>"
        Else
            strHTML = strHTML & "<tr><td valign='top' align='left' class='seperator'>Shared</td><td valign='top' align='right' class='rightside'>0</td></tr>"
        End If

        If CLng(f_owner) > 0 Then
            strHTML = strHTML & "<tr><td valign='top' align='left' class='seperator'>Fractional</td><td valign='top' align='right' class='rightside'>" & FormatNumber(f_owner, 0, True, False, True) & "</td></tr>"
        Else
            strHTML = strHTML & "<tr><td valign='top' align='left' class='seperator'>Fractional</td><td valign='top' align='right' class='rightside'>0</td></tr>"
        End If

        If CLng(totalInOpcount) > 0 Then
            strHTML = strHTML & "<tr bgcolor='#F8F8F8'><td valign='top' align='left' class='seperator' nowrap='nowrap'>Total Aircraft</td><td valign='top' align='right' class='rightside'>" & FormatNumber(totalInOpcount, 0, True, False, True) & "</td></tr>"
        Else
            strHTML = strHTML & "<tr bgcolor='#F8F8F8'><td valign='top' align='left' class='seperator' nowrap='nowrap'>Total Aircraft</td><td valign='top' align='right' class='rightside'>0</td></tr>"
        End If

        If CLng(alllow) > 0 And CLng(allhigh) > 0 Then
            strHTML = strHTML & "<tr><td valign='top' align='left' class='border_bottom' nowrap='nowrap'>MFR Year Range</td><td class='border_bottom_right' valign='top' align='right' nowrap='nowrap'>" & alllow & " - " & allhigh & "</td></tr>"
        ElseIf CLng(alllow) > 0 And CLng(allhigh) = 0 Then
            strHTML = strHTML & "<tr><td valign='top' align='left' class='border_bottom' nowrap='nowrap'>MFR Year Range</td><td class='border_bottom_right' valign='top' align='right' nowrap='nowrap'>" & alllow & " - To Present</td></tr>"
        Else
            strHTML = strHTML & "<tr><td valign='top' align='left' class='border_bottom' nowrap='nowrap'>MFR Year Range</td><td class='border_bottom_right' valign='top' align='right' nowrap='nowrap'>N/A</td></tr>"
        End If

        strHTML = strHTML & "</table>"

        '----------------------------------------------------------------


        strHTML = strHTML & "</td></tr></table>"




        query = "SELECT amod_number_of_crew, amod_number_of_passengers, amod_field_length, amod_climb_normal_feet, amod_max_range_miles, amod_range_tanks_full, amod_range_seats_full,"
        query = query & " amod_cruis_speed, amod_number_of_engines, amod_annual_miles, amod_annual_hours, amod_tot_direct_cost, amod_tot_fixed_cost, amod_airframe_type_code, "
        query = query & " amod_cabinsize_length_feet, amod_cabinsize_height_feet, amod_cabinsize_width_feet, amod_cabinsize_length_inches, amod_cabinsize_height_inches, amod_cabinsize_width_inches, amod_takeoff_ali, amod_takeoff_500 "
        query = query & " FROM aircraft_model WITH(NOLOCK) WHERE amod_id = " & inModelID
        '  query &= " " + commonEVO.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, True)
        query = query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, False)

        If Session("debug") Then
            Response.Write("<b>getSpecInfo : " & Server.HtmlEncode(query) & "</b><br /><br />")
        End If

        Try
            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = query
            specinfo = SqlCommand.ExecuteReader()


            If specinfo.HasRows Then
                specinfo.Read()

                'Specifications 
                crew = specinfo("amod_number_of_crew")
                passengers = specinfo("amod_number_of_passengers")

                If specinfo("amod_airframe_type_code") = "F" Then
                    fieldlength = FormatNumber(CLng(specinfo("amod_field_length")), False, True, False)
                Else
                    fieldlength = 0
                End If


                If specinfo("amod_airframe_type_code") = "F" Then
                    ac_ext_width = FormatNumber(CLng(specinfo("amod_takeoff_ali")), False, True, False)
                Else
                    ac_ext_width = 0
                End If

                If specinfo("amod_airframe_type_code") = "F" Then
                    ac_ext_height = FormatNumber(CLng(specinfo("amod_takeoff_500")), False, True, False)
                Else
                    ac_ext_height = 0
                End If

                If Not IsDBNull(specinfo("amod_cabinsize_length_feet")) Then
                    If CDbl(specinfo("amod_cabinsize_length_feet")) > 0 Then
                        ac_int_length = FormatNumber(CDbl(specinfo("amod_cabinsize_length_feet")), False, True, False) & "'&nbsp;" & FormatNumber(CDbl(specinfo("amod_cabinsize_length_inches")), False, True, False)
                    Else
                        ac_int_length = FormatNumber(0, False, True, False) & "'&nbsp;" & FormatNumber(0, False, True, False)
                    End If
                Else
                    ac_int_length = FormatNumber(0, False, False, True) & "'&nbsp;" & FormatNumber(0, False, False, True)
                End If

                If Not IsDBNull(specinfo("amod_cabinsize_height_feet")) Then
                    If CDbl(specinfo("amod_cabinsize_height_feet")) > 0 Then
                        ac_int_height = FormatNumber(CDbl(specinfo("amod_cabinsize_height_feet")), False, True, False) & "'&nbsp;" & FormatNumber(CDbl(specinfo("amod_cabinsize_height_inches")), False, True, False)
                    Else
                        ac_int_height = FormatNumber(0, False, True, False) & "'&nbsp;" & FormatNumber(0, False, True, False)
                    End If
                Else
                    ac_int_height = FormatNumber(0, False, False, True) & "'&nbsp;" & FormatNumber(0, False, False, True)
                End If

                If Not IsDBNull(specinfo("amod_cabinsize_width_feet")) Then
                    If CDbl(specinfo("amod_cabinsize_width_feet")) > 0 Then
                        ac_int_width = FormatNumber(CDbl(specinfo("amod_cabinsize_width_feet")), False, True, False) & "'&nbsp;" & FormatNumber(CDbl(specinfo("amod_cabinsize_width_inches")), False, True, False)
                    Else
                        ac_int_width = FormatNumber(0, False, True, False) & "'&nbsp;" & FormatNumber(0, False, True, False)
                    End If
                Else
                    ac_int_width = FormatNumber(0, False, False, True) & "'&nbsp;" & FormatNumber(0, False, False, True)
                End If

                If specinfo("amod_airframe_type_code") = "F" Then
                    range = specinfo("amod_max_range_miles")
                Else
                    range = 0
                    rangetanksfull = specinfo("amod_range_tanks_full")
                    rangeseatsfull = specinfo("amod_range_seats_full")
                End If

                knots = specinfo("amod_cruis_speed")
                climb = specinfo("amod_climb_normal_feet")

                'Operating Costs
                miles = specinfo("amod_annual_miles")
                hours = specinfo("amod_annual_hours")
                directcost = specinfo("amod_tot_direct_cost")
                fixedcostd = specinfo("amod_tot_fixed_cost")

                totalcost = (specinfo("amod_tot_direct_cost") + specinfo("amod_tot_fixed_cost").ToString)

                If (specinfo("amod_tot_fixed_cost") <> 0 And specinfo("amod_tot_direct_cost") <> 0) Or specinfo("amod_annual_hours") <> 0 Then
                    perhour = CDbl((specinfo("amod_tot_direct_cost") + specinfo("amod_tot_fixed_cost")) / specinfo("amod_annual_hours"))
                End If

                If (specinfo("amod_tot_direct_cost") <> 0 And specinfo("amod_tot_fixed_cost") <> 0) Or specinfo("amod_annual_miles") <> 0 Then
                    perseat = CDbl((specinfo("amod_tot_direct_cost") + specinfo("amod_tot_fixed_cost")) / specinfo("amod_annual_miles"))
                End If

                specinfo.Close()

            End If

            specinfo = Nothing



            '-------------------------------------------------------------------
            '-------------------------------------------------------------------
            '-------------------------------------------------------------------
            '-------------------------------------------------------------------



            strHTML = strHTML & "</td></tr></table>"



            strHTML = strHTML & "</td></tr><tr>"
            strHTML = strHTML & "<td align='left' valign='top' width='100%'>"

            strHTML = strHTML & "<br /><br>"


            strHTML = strHTML & "<table id='aboutModelTable' height='120' width='100%' cellpadding='1' cellspacing='0' class='module'>"


            strHTML = strHTML & "<tr><td align='left' valign='middle' class='header' style='padding-left:3px;'>ABOUT " & real_make_model_name.ToString.ToUpper & "</td></tr>"
            strHTML = strHTML & "<tr><td align='left' valign='bottom'>"
            strHTML = strHTML & "<table id='aboutModelSpecsTable' width='100%' cellspacing='0' cellpadding='4' class='leftside'>"
            strHTML = strHTML & "<tr><td valign='top' align='left' class='tabheader'><strong>Specifications</strong></td><td width='36%' class='border_bottom'>&nbsp;</td></tr>"



            strHTML = strHTML & "<tr><td valign='top' align='left' class='seperator'>Crew</td><td valign='top' align='right' class='rightside'>" & FormatNumber(crew, 0, True, False, True) & "&nbsp;</td></tr>"
            strHTML = strHTML & "<tr><td valign='top' align='left' class='seperator'>Passengers</td><td valign='top' align='right' class='rightside'>" & FormatNumber(passengers, 0, True, False, True) & "&nbsp;</td></tr>"


            If fieldlength > 0 Then
                strHTML = strHTML & "<tr><td valign='top' align='left' class='seperator'>Cabin Dimensions (ft) (L x W x H)</td><td valign='top' align='right' class='rightside'>"
                If Trim(ac_int_length) <> "" Then
                    strHTML = strHTML & ac_int_length & " x "
                End If

                If Trim(ac_int_width) <> "" Then
                    strHTML = strHTML & ac_int_width & " x "
                End If

                If Trim(ac_int_height) <> "" Then
                    strHTML = strHTML & ac_int_height
                End If

                strHTML = strHTML & "&nbsp;</font></td></tr>"
                strHTML = strHTML & "<tr><td valign='top' align='left' class='seperator'>Landing Field Length (ft)</td><td valign='top' align='right' class='rightside'>" & FormatNumber(fieldlength, 0, True, False, True) & "&nbsp;</td></tr>"
                strHTML = strHTML & "<tr><td valign='top' align='left' class='seperator'>Takeoff Performance(ft) - SL ISA BFL</td><td valign='top' align='right' class='rightside'>" & FormatNumber(ac_ext_width, 0, True, False, True) & "&nbsp;</td></tr>"
                strHTML = strHTML & "<tr><td valign='top' align='left' class='seperator'>Takeoff Performance(ft) - 5000' +25C BLF</td><td valign='top' align='right' class='rightside'>" & FormatNumber(ac_ext_height, 0, True, False, True) & "&nbsp;</td></tr>"



            End If

            If range > 0 Then
                strHTML = strHTML & "<tr><td valign='top' align='left' class='seperator'>Range (nm)</td><td valign='top' align='right' class='rightside'>" & FormatNumber(range, 0, True, False, True) & "&nbsp;</td></tr>"
            Else
                strHTML = strHTML & "<tr><td valign='top' align='left' class='seperator'>Range Tanks&nbsp;Full&nbsp;(nm)</td><td valign='top' align='right' class='rightside'>" & FormatNumber(rangetanksfull, 0, True, False, True) & "&nbsp;</td></tr>"
                strHTML = strHTML & "<tr><td valign='top' align='left' class='seperator'>Range Seats&nbsp;Full&nbsp;(nm)</td><td valign='top' align='right' class='rightside'>" & FormatNumber(rangeseatsfull, 0, True, False, True) & "&nbsp;</td></tr>"
            End If

            strHTML = strHTML & "</table>"
            strHTML = strHTML & "<br />"

            strHTML = strHTML & "</td></tr></table>"


            display_aircraft_summary = Trim(strHTML)
        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function

    Function acContactType_airframeType(ByVal inAmodID, ByVal inCompanyID, ByVal airframe_type, ByVal country, ByVal City)
        acContactType_airframeType = ""

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim localAdoRs2 As System.Data.SqlClient.SqlDataReader : localAdoRs2 = Nothing
        Dim htmlOutput As String = ""
        Dim htmlOutput2 As String = ""
        If Trim(inAmodID) = "" Then inAmodID = 0
        If Trim(inCompanyID) = "" Then inCompanyID = 0
        Dim query As String = ""
        Dim total_Aircraft As Integer = 0

        Try
            acContactType_airframeType = ""

            query = "SELECT DISTINCT amod_airframe_type_code, count(distinct ac_id) AS ac_count"

            query = query & " FROM aircraft_summary WITH(NOLOCK) "
            query = query & " WHERE ac_lifecycle_stage = 3"

            If CLng(inAmodID) > 0 Then
                query = query & " AND amod_id = " & CStr(inAmodID)
            End If


            If Trim(airframe_type) <> "" Then
                query = query & " AND amod_airframe_type_code = '" & Trim(airframe_type) & "'"
            End If
            If CLng(inCompanyID) > 0 Then
                query = query & " AND comp_id = " & CStr(inCompanyID)
            End If

            If Trim(country) <> "" Then
                query = query & " and comp_country='" & country & "' "
            End If

            If Trim(City) <> "" Then
                query = query & " and comp_city='" & City & "' "
            End If

            If Trim(airframe_type) <> "" Then
                query = query & " AND amod_airframe_type_code = '" & Trim(airframe_type) & "'"
            End If


            query = query & " AND (cref_contact_type IN ('94','33') OR cref_business_type = 'CH') "

            ' query = query & " " + commonEVO.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, False)
            query = query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, True)


            query = query & " GROUP BY amod_airframe_type_code"
            query = query & " ORDER BY ac_count, amod_airframe_type_code ASC"

            If Session("debug") Then
                Response.Write("<b>acContactType_airframeType:" & Server.HtmlEncode(query) & "</b><br /><br />")
            End If



            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = query
            localAdoRs2 = SqlCommand.ExecuteReader()


            If localAdoRs2.HasRows Then


                Do While localAdoRs2.Read

                    If UCase(Trim(localAdoRs2("amod_airframe_type_code").ToString)) = "F" Then
                        htmlOutput2 = htmlOutput2 & "<tr><td align='left' valign='top' class='seperator'>Fixed Wing</td>"
                    Else
                        htmlOutput2 = htmlOutput2 & "<tr><td align='left' valign='top' class='seperator'>Rotary</td>"
                    End If

                    htmlOutput2 = htmlOutput2 & "<td align='right' valign='top' class='seperator' width='20%' style='padding-right:15px;'>" & FormatNumber(localAdoRs2("ac_count").ToString, 0) & "</td></tr>" & vbCrLf
                    total_Aircraft = total_Aircraft + localAdoRs2("ac_count")
                Loop


            Else
                htmlOutput2 = htmlOutput2 & "<tr><td valign='top' align='left' class='seperator'>No data matches for your search criteria</td></tr>" & vbCrLf
            End If




            htmlOutput = htmlOutput & "<table id='AcContactTypeAirframeOuterTable' width='100%'  cellpadding='1' cellspacing='0' class='module'>" & vbCrLf
            htmlOutput = htmlOutput & "<tr><td valign='top' align='left' class='header' style='padding-left:3px;'>" & "CHARTER" & " AIRCRAFT "

            If Trim(City) <> "" Then
                htmlOutput = htmlOutput & " in " & City
            ElseIf Trim(country) <> "" Then
                htmlOutput = htmlOutput & " in " & country
            End If

            htmlOutput = htmlOutput & " BY AIRFRAME&nbsp;(" & FormatNumber(total_Aircraft, 0) & ")</td></tr>" & vbCrLf

            htmlOutput = htmlOutput & "<tr><td valign='top' align='left'>" & vbCrLf

            htmlOutput = htmlOutput & "<table id='AcContactTypeAirframeInnerTable' width='100%' cellpadding='1' cellspacing='0'>" & vbCrLf
            htmlOutput = htmlOutput & "<tr><td valign='top' align='left' class='seperator' width='80%'><strong>Airframe</strong></td>" & vbCrLf
            htmlOutput = htmlOutput & "<td valign='top' align='right' class='seperator' width='20%'><strong>#&nbsp;of&nbsp;AC</strong></td></tr>" & vbCrLf

            htmlOutput = htmlOutput & "<tr><td colspan='2' class='rightside' valign='top'>" & vbCrLf


            htmlOutput = htmlOutput & "<table id='AcContactTypeAirframeDataTable' width='100%' cellpadding='4' cellspacing='0'>" & vbCrLf



            htmlOutput = htmlOutput & Trim(htmlOutput2)

            htmlOutput = htmlOutput & "</table></td></tr></table></td></tr></td></table>"

            acContactType_airframeType = Trim(htmlOutput)
        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function
    Function acContactType_fleet(ByVal inAmodID, ByVal inCompanyID, ByVal acView_makemodel, ByVal company_name, ByVal airframe_type, ByVal country, ByVal City, ByVal sub_type, ByVal sub_info)

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim localAdoRs2 As System.Data.SqlClient.SqlDataReader : localAdoRs2 = Nothing
        Dim htmlOutput As String = ""
        Dim total_Aircraft As Integer = 0
        Dim query As String = ""
        Dim QUOTE As String = "&#39;"
        If Trim(inAmodID) = "" Then inAmodID = 0
        If Trim(inCompanyID) = "" Then inCompanyID = 0
        Dim company_real_name As String = ""
        Dim counter1 As Integer = 0
        Dim hidden_counter As Integer = 0
        Dim starter_string As String = ""
        Dim model_or_airframe As String = ""
        Dim title As String = ""
        Dim sub_title As String = ""
        Dim table_name As String = ""
        Dim previous_comp_name As String = ""
        Dim info_for_counter_to_pass As String = ""
        acContactType_fleet = ""

        Try

            query = "SELECT DISTINCT TOP 250 amod_airframe_type_code, amod_type_code, amod_make_name, amod_model_name, ac_ser_no_full, ac_reg_no, ac_mfr_year, ac_id "

            query = query & " FROM aircraft_summary WITH(NOLOCK) "

            query = query & " WHERE ac_lifecycle_stage = 3 and ac_ownership_type IN ('S','F','W')"

            If CLng(inAmodID) > 0 Then
                query = query & " AND amod_id = " & CStr(inAmodID)
            End If



            If Trim(airframe_type) <> "" Then
                query = query & " AND amod_airframe_type_code = '" & Trim(airframe_type) & "'"
            End If

            If CLng(inCompanyID) > 0 Then
                query = query & " AND comp_id = " & CStr(inCompanyID)
            End If

            If Trim(country) <> "" Then
                query = query & " and comp_country='" & country & "' "
            End If

            If Trim(City) <> "" Then
                query = query & " and comp_city='" & City & "' "
            End If

            query = query & " AND (cref_contact_type IN ('94','33') OR cref_business_type = 'CH')"


            ' query = query & " " + commonEVO.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, False)
            query = query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, True)

            query = query & " GROUP BY amod_airframe_type_code, amod_type_code, amod_make_name, amod_model_name, ac_ser_no_full, ac_reg_no, ac_mfr_year, ac_id"

            query = query & " ORDER BY amod_airframe_type_code, amod_type_code, amod_make_name, amod_model_name, ac_ser_no_full"


            If Session("debug") Then
                Response.Write("<b>acContactType_fleet:" & Server.HtmlEncode(query) & "</b><br /><br />")
            End If

            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = query
            localAdoRs2 = SqlCommand.ExecuteReader()


            If CLng(inAmodID) = 0 Then
                title = title & "CHARTER&nbsp;FLEET&nbsp;"
            Else
                title = title & acView_makemodel & " CHARTER" & "&nbsp;FLEET&nbsp;"
            End If

            If Trim(City) <> "" Then
                title = title & " in " & City
            ElseIf Trim(country) <> "" Then
                title = title & " in " & country
            End If


            If Trim(company_name) <> "" And Trim(acView_makemodel) <> "" Then
                sub_title = sub_title & company_name & " - " & acView_makemodel
            ElseIf Trim(company_name) <> "" Then
                sub_title = sub_title & company_name
                If Trim(airframe_type) <> "" Then
                    If Trim(airframe_type) = "F" Then
                        sub_title = sub_title & " - Fixed Airframe"
                    ElseIf Trim(airframe_type) = "R" Then
                        sub_title = sub_title & " - Rotary Airframe"
                    End If
                End If
            ElseIf Trim(acView_makemodel) <> "" Then
                sub_title = sub_title & acView_makemodel
            ElseIf Trim(airframe_type) <> "" Then
                If Trim(airframe_type) = "F" Then
                    sub_title = sub_title & "Fixed Airframe"
                ElseIf Trim(airframe_type) = "R" Then
                    sub_title = sub_title & "Rotary Airframe"
                End If
            End If



            table_name = "charter_fleet"



            If localAdoRs2.HasRows Then


                Do While localAdoRs2.Read

                    If hidden_counter = 24 Then
                        htmlOutput = htmlOutput & Build_PDF_Template_Footer()
                        htmlOutput = htmlOutput & Insert_Page_Break_PDF()
                        htmlOutput = htmlOutput & Build_PDF_Header_Final("Charter Report", sub_info, acView_makemodel, company_name, sub_type, country, City, airframe_type, False)
                        htmlOutput = htmlOutput & Build_PDF_Column_Start(table_name, title, "Continued", sub_title, 4)
                        hidden_counter = 0
                    ElseIf hidden_counter = 12 Then
                        htmlOutput = htmlOutput & Build_PDF_Column_2("", 2, table_name)
                    End If

                    htmlOutput = htmlOutput & "<tr height='65'><td align='left' valign='top' class='seperator'><img src='" & location_string & "images/ch_red.jpg' class='bullet'/></td>" & vbCrLf

                    If CLng(inAmodID) = 0 Then
                        htmlOutput = htmlOutput & "<td align='left' valign='top' class='seperator'>" & localAdoRs2("amod_make_name").ToString & "&nbsp;/&nbsp;" & localAdoRs2("amod_model_name").ToString
                        htmlOutput = htmlOutput & " Serial# " & localAdoRs2("ac_ser_no_full").ToString & "</a> Reg# " & localAdoRs2("ac_reg_no").ToString & "<br>Year MFR : " & localAdoRs2("ac_mfr_year").ToString & vbCrLf
                    Else
                        htmlOutput = htmlOutput & "<td align='left' valign='top' class='seperator'>Serial# " & localAdoRs2("ac_ser_no_full").ToString & "</a> Reg# " & localAdoRs2("ac_reg_no").ToString & " Year MFR : " & localAdoRs2("ac_mfr_year").ToString
                    End If

                    If CLng(inCompanyID) = 0 Then

                        company_real_name = get_companies_associated_names(localAdoRs2("ac_id"), inAmodID, Trim(airframe_type))

                        If company_real_name <> "<Unknown>" And company_real_name <> "" And (company_real_name.ToUpper.Trim <> previous_comp_name.ToUpper.Trim) Then
                            htmlOutput = htmlOutput & "<br>" & company_real_name
                        End If

                        previous_comp_name = company_real_name.ToUpper.Trim

                    Else

                    End If

                    htmlOutput = htmlOutput & "</td></tr>" & vbCrLf


                    hidden_counter = hidden_counter + 1
                    counter1 = counter1 + 1
                Loop

            Else
                htmlOutput = htmlOutput & "<tr><td valign='top' align='left' class='seperator'>No data matches for your search criteria</td></tr>" & vbCrLf
            End If

            htmlOutput = htmlOutput & "</table></td></tr></table></td></tr></td></table></td>"



            If counter1 = 250 Then
                info_for_counter_to_pass = "Limited to 250"
            Else
                info_for_counter_to_pass = counter1.ToString
            End If

            htmlOutput = Build_PDF_Column_Start(table_name, title, info_for_counter_to_pass, sub_title, 2) & htmlOutput
            acContactType_fleet = Trim(htmlOutput)
        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function

    Function operator_display_aircraft(ByVal product_code, ByVal sub_info, ByVal acView_makemodel, ByVal company_name, ByVal sub_type, ByVal amod_id, ByVal engine_name, ByVal comp_id)
        operator_display_aircraft = ""

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim adors As System.Data.SqlClient.SqlDataReader : adors = Nothing
        Dim query As String = ""
        Dim tmp_title_variable As String = ""
        Dim hidden_counter As Integer = 0
        Dim table_name As String = ""
        Dim title As String = ""
        Dim sub_title As String = ""
        Dim QUOTE As String = "&quot;"
        Dim real_counter As Integer = 0

        Dim strBuilder As New StringBuilder

        Try
            query = "SELECT DISTINCT ac_id, ac_ser_no_full, ac_reg_no, ac_engine_name,"
            query = query & " amod_type_code, amod_make_name, amod_model_name, comp_name, comp_country, comp_id"
            query = query & " FROM Aircraft_Summary WITH(NOLOCK)"

            If product_code = "B" Then
                query = query & " where ac_product_business_flag = 'Y' and ac_lifecycle_stage = 3"
            ElseIf product_code = "C" Then
                query = query & " where ac_product_commercial_flag = 'Y' and ac_lifecycle_stage = 3"
            ElseIf product_code = "H" Then
                query = query & " where ac_product_helicopter_flag = 'Y' and ac_lifecycle_stage = 3"
            Else
                query = query & " where ac_product_business_flag = 'Y' and ac_lifecycle_stage = 3"
            End If
            query = query & " and cref_operator_flag IN ('Y', 'O') "

            '  query = query & " " + commonEvo.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, False)
            query = query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, True)

            If Trim(engine_name) <> "" And Trim(engine_name) <> "ALL" Then
                query = query & " and ac_engine_name = '" & Trim(engine_name) & "'"
            End If

            If CLng(comp_id) > 0 Then
                query = query & " and comp_id = " & CLng(comp_id)
            End If

            If CLng(amod_id) > 0 Then
                query = query & " and amod_id=" & CLng(amod_id)
            End If

            query = query & " ORDER BY amod_type_code, amod_make_name, amod_model_name, ac_id, ac_ser_no_full, ac_reg_no"

            If Session("debug") Then
                Response.Write("<b>displayCommercialAircraftBlock : " & Server.HtmlEncode(query) & "</b><br /><br />")
            End If



            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = query
            adors = SqlCommand.ExecuteReader()


            If Trim(engine_name) <> "" And Trim(engine_name) <> "ALL" Then
                tmp_title_variable = " - " & Trim(engine_name) & " Engine "
            End If

            If CLng(amod_id) > 0 And CLng(comp_id) > 0 Then
                title = Trim(company_name) & " - " & acView_makemodel & tmp_title_variable & ": AIRCRAFT&nbsp;"
                sub_title = acView_makemodel
            ElseIf CLng(comp_id) > 0 Then
                title = Trim(company_name) & tmp_title_variable & ": AIRCRAFT&nbsp;"
                sub_title = company_name
            ElseIf CLng(amod_id) > 0 Then
                title = Trim(acView_makemodel) & tmp_title_variable & ": AIRCRAFT&nbsp;"
                sub_title = acView_makemodel & tmp_title_variable
            ElseIf Trim(engine_name) <> "" And Trim(engine_name) <> "ALL" Then
                title = Trim(engine_name) & ": AIRCRAFT&nbsp;"
                sub_title = engine_name
            End If




            If adors.HasRows Then



                Do While adors.Read



                    If hidden_counter = 20 Then
                        strBuilder.Append(Build_PDF_Template_Footer())
                        strBuilder.Append(Insert_Page_Break_PDF())
                        strBuilder.Append(Build_PDF_Header_Final("Operator Report", sub_info, acView_makemodel, company_name, sub_type, "", "", "", True))
                        strBuilder.Append(Build_PDF_Column_Start(table_name, title, "Continued", sub_title, 2))
                        hidden_counter = 0
                    ElseIf hidden_counter = 10 Then
                        strBuilder.Append(Build_PDF_Column_2("", 2, table_name))
                    End If


                    strBuilder.Append("<tr><td align='left' valign='top'><img src='" & location_string & "images/ch_red.jpg' class='bullet'/></td><td align='left' valign='top'>")
                    strBuilder.Append("Serial# " & adors("ac_ser_no_full") & "</a>, Reg# " & adors("ac_reg_no"))
                    strBuilder.Append(" " & adors("amod_make_name"))
                    strBuilder.Append("/" & adors("amod_model_name") & ", ")
                    strBuilder.Append(adors("ac_engine_name") & " Engine(s) ")
                    ' strBuilder.Append("<em>" & adors("ac_engine_noise_rating") & " rating</em>")
                    strBuilder.Append("<br>" & adors("comp_name") & " <font size='-2'>(" & adors("comp_country") & ")</font>")
                    strBuilder.Append("<hr /></td></tr>")


                    hidden_counter = hidden_counter + 1
                    real_counter = real_counter + 1
                Loop


                adors.Close()

            Else

            End If

            adors = Nothing

            operator_display_aircraft = Build_PDF_Column_Start(table_name, title, real_counter, sub_title, 2) & strBuilder.ToString()
            strBuilder = Nothing
        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function



    Function displayAll_OP_Models(ByVal real_company_name, ByVal real_model_name, ByVal product_code, ByVal comp_id, ByVal amod_id, ByVal engine_name, ByVal sub_type, ByVal sub_info)

        displayAll_OP_Models = ""

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim adors As System.Data.SqlClient.SqlDataReader : adors = Nothing
        Dim current_total As Integer = 0
        Dim Query As String = ""
        Dim bgcolor As String = ""
        Dim tmp_title_holder As String = ""
        Dim nColspan As Integer = 0
        Dim strBuilder As New StringBuilder
        Dim totaltot As Integer = 0
        Dim inservicetot As Integer = 0
        Dim onordertot As Integer = 0
        Dim leasedtota As Integer = 0
        Dim retiredtot As Integer = 0
        Dim inserviceshowtot As Integer = 0
        Dim onordershowtot As Integer = 0
        Dim leasedshowtot As Integer = 0
        Dim retiredshowtot As Integer = 0
        Dim retiredshowtot2 As Integer = 0
        Dim retiredtot2 As Integer = 0
        Dim total_total_line As Integer = 0
        Dim leasedtot As Integer = 0
        Dim table_name As String = ""
        Dim title As String = ""
        Dim sub_title As String = ""
        Dim QUOTE As String = "&quot;"
        Dim real_counter As Integer = 0
        Dim hidden_counter As Integer = 0

        Try
            If product_code = "C" Then
                nColspan = 7
            Else
                nColspan = 3
            End If

            If CLng(amod_id) = 0 And CLng(comp_id) > 0 Then
                Query = "SELECT  top 100 amod_make_name, amod_model_name, amod_id, count(distinct ac_id) as account"
            ElseIf CLng(amod_id) > 0 And CLng(comp_id) = 0 Then
                Query = "SELECT  top 100 amod_make_name, amod_model_name, amod_id, count(distinct ac_id) as account"
            Else
                Query = "SELECT  top 100 amod_make_name, amod_model_name, amod_id, count(distinct ac_id) as account"
            End If

            Query = Query & " FROM Aircraft_Summary WITH(NOLOCK)"

            If product_code = "B" Then
                Query = Query & " where ac_product_business_flag = 'Y' and ac_lifecycle_stage = 3"
            ElseIf product_code = "C" Then
                Query = Query & " where ac_product_commercial_flag = 'Y' and ac_lifecycle_stage = 3"
            ElseIf product_code = "H" Then
                Query = Query & " where ac_product_helicopter_flag = 'Y' and ac_lifecycle_stage = 3"
            Else
                Query = Query & " where ac_product_business_flag = 'Y' and ac_lifecycle_stage = 3"
            End If



            Query = Query & " AND cref_operator_flag IN ('Y', 'O')"

            '  Query = Query & " " + commonEVO.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, False)
            Query = Query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, True)

            If Trim(engine_name) <> "" And Trim(engine_name) <> "ALL" Then
                Query = Query & " AND ac_engine_name = '" & Trim(engine_name) & "'"
            End If

            If CLng(comp_id) > 0 Then
                Query = Query & " AND comp_id = " & CStr(comp_id)
            End If

            Query = Query & " GROUP BY amod_make_name, amod_model_name, amod_id"
            Query = Query & " ORDER BY count(distinct ac_id) desc, amod_make_name asc"

            If Session("debug") Then
                Response.Write("displayAll_OP_Models Query: " & Query)
            End If

            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = Query
            adors = SqlCommand.ExecuteReader()


            If adors.HasRows Then



                If Trim(engine_name) <> "" And Trim(engine_name) <> "ALL" Then
                    If CLng(comp_id) > 0 Then
                        tmp_title_holder = real_company_name & " - "
                    End If
                    If CLng(amod_id) > 0 Then
                        tmp_title_holder = tmp_title_holder & real_model_name & " - "
                    End If
                    title = "MODEL SUMMARY: " & tmp_title_holder & Trim(engine_name) & " Engine"

                Else

                    If CLng(amod_id) = 0 And CLng(comp_id) = 0 Then

                        title = "MODEL SUMMARY: TOP 100 MODELS"

                    ElseIf CLng(comp_id) > 0 And CLng(amod_id) > 0 Then
                        title = "MODEL SUMMARY: " & real_company_name
                    ElseIf CLng(amod_id) > 0 Then
                        title = "MODEL SUMMARY: "
                    ElseIf CLng(comp_id) > 0 Then
                        title = "MODEL SUMMARY:  " & real_company_name
                    End If

                End If

                If product_code = "C" Then
                    sub_title = sub_title & "<table cellspacing='0' cellpadding='0' border='0' width='100%'><tr><td valign='middle' align='left' width='60%'>"
                Else
                    sub_title = sub_title & "<table cellspacing='0' cellpadding='0' border='0' width='100%'><tr><td valign='middle' align='left' width='60%'>"
                End If
                sub_title = sub_title & "<strong>Model&nbsp;Name</strong></td>" & vbCrLf



                If product_code = "C" Then
                    sub_title = sub_title & "<td valign='bottom' align='center' width='5%'><strong>On<br />Order</strong></td>"
                End If

                sub_title = sub_title & "<td valign='bottom' align='center'><strong>In<br />Operation</strong></td>"
                sub_title = sub_title & "<td valign='bottom' align='center'><strong>Leased</strong></td>"

                If product_code = "C" Then
                    sub_title = sub_title & "<td valign='bottom' align='center' width='7%'><strong>In<br />Storage</strong></td>"
                    sub_title = sub_title & "<td valign='bottom' align='center' width='6%'><strong>Retired</strong></td>"
                    sub_title = sub_title & "<td valign='bottom' align='right' width='7%'><strong>Total</strong></td>"
                End If

                sub_title = sub_title & "</tr></table>" & vbCrLf



                bgcolor = "#F6F6F6"

                Do While adors.Read

                    If bgcolor = "#ffffff" Then
                        bgcolor = "#F6F6F6"
                    Else
                        bgcolor = "#ffffff"
                    End If

                    If product_code = "C" Then
                        If hidden_counter = 25 Then
                            strBuilder.Append(Build_PDF_Template_Footer())
                            strBuilder.Append(Insert_Page_Break_PDF())
                            strBuilder.Append(Build_PDF_Header_Final("Operator Report", sub_info, real_model_name, real_company_name, sub_type, "", "", "", True))
                            strBuilder.Append(Build_PDF_Column_Start(table_name, title, "Continued", sub_title, nColspan))
                            hidden_counter = 0
                        End If
                    Else
                        If hidden_counter = 50 Then
                            strBuilder.Append(Build_PDF_Template_Footer())
                            strBuilder.Append(Insert_Page_Break_PDF())
                            strBuilder.Append(Build_PDF_Header_Final("Operator Report", sub_info, real_model_name, real_company_name, sub_type, "", "", "", True))
                            strBuilder.Append(Build_PDF_Column_Start(table_name, title, "Continued", sub_title, nColspan))
                            hidden_counter = 0
                        ElseIf hidden_counter = 25 Then
                            strBuilder.Append(Build_PDF_Column_2(sub_title, nColspan, table_name))
                        End If
                    End If




                    ' ******** COUNTING FUNCTION*******

                    inserviceshowtot = adors("account")  ' count_totals_ac_table(CLng(comp_id), adors("ac_amod_id"), "operation", 0, product_code)

                    If product_code = "C" Then
                        onordershowtot = count_totals_ac_table(CLng(comp_id), adors("amod_id"), "order", 0, product_code)
                        retiredshowtot2 = count_totals_ac_table(CLng(comp_id), adors("amod_id"), "storage", 0, product_code) ' MSW
                        retiredshowtot = count_totals_ac_table(CLng(comp_id), adors("amod_id"), "retired", 0, product_code)
                        retiredshowtot = retiredshowtot - retiredshowtot2
                        retiredtot2 = retiredtot2 + retiredshowtot2
                    End If

                    leasedshowtot = count_totals_ac_table(CLng(comp_id), adors("amod_id"), "leased", 0, product_code)
                    ' ******** COUNTING FUNCTION*******


                    inservicetot = inservicetot + inserviceshowtot
                    leasedtot = leasedtot + leasedshowtot
                    retiredtot = retiredtot + retiredshowtot
                    onordertot = onordertot + onordershowtot
                    total_total_line = inserviceshowtot + retiredshowtot + onordershowtot + retiredshowtot2 '+ leasedshowtot 

                    total_total_line = FormatNumber(total_total_line, 0)
                    retiredshowtot = FormatNumber(retiredshowtot, 0)
                    retiredshowtot2 = FormatNumber(retiredshowtot2, 0)
                    onordershowtot = FormatNumber(onordershowtot, 0)
                    inserviceshowtot = FormatNumber(inserviceshowtot, 0)
                    leasedshowtot = FormatNumber(leasedshowtot, 0)

                    If product_code = "C" Then
                        strBuilder.Append("<tr bgcolor = '" & bgcolor & "'>")
                        strBuilder.Append("<td valign='top' align='left' class='border_bottom_right' width='60%'>")
                        strBuilder.Append(Trim(adors("amod_make_name")) & " " & Trim(adors("amod_model_name")))
                        strBuilder.Append("</em></a></td>")
                        strBuilder.Append("<td align='right' class='border_bottom_right'>" & onordershowtot & "</td>")
                    Else
                        strBuilder.Append("<tr bgcolor = '" & bgcolor & "'>")
                        strBuilder.Append("<td valign='top' align='left' class='border_bottom_right' width='60%'>")
                        strBuilder.Append(Trim(adors("amod_make_name")) & " " & Trim(adors("amod_model_name")))
                        strBuilder.Append("</em></a></td>")
                    End If

                    strBuilder.Append("<td align='right' class='border_bottom_right'>" & FormatNumber(inserviceshowtot, 0) & "</td>")
                    strBuilder.Append("<td align='right' class='border_bottom_right'>" & FormatNumber(leasedshowtot, 0) & "</td>")

                    If product_code = "C" Then
                        strBuilder.Append("<td align='right' class='border_bottom_right'>" & FormatNumber(retiredshowtot2, 0) & "</td>")
                        strBuilder.Append("<td align='right' class='border_bottom_right'>" & FormatNumber(retiredshowtot, 0) & "</td>")
                        strBuilder.Append("<td align='right' class='border_bottom_right'>" & FormatNumber(total_total_line, 0) & "</td>")
                    End If

                    strBuilder.Append("</tr>")

                    real_counter = real_counter + 1
                    hidden_counter = hidden_counter + 1

                Loop

                strBuilder.Append("</table>")
                strBuilder.Append("</td></tr></table>")
                adors.Close()
            End If



            displayAll_OP_Models = Build_PDF_Column_Start(table_name, title, real_counter, sub_title, nColspan) & strBuilder.ToString()
            strBuilder = Nothing
        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function

    Function display_OperatorView_PieChart(ByVal real_model_name, ByVal height_top_middle_table, ByVal graphID, ByVal product_code, ByVal comp_id, ByVal amod_id)
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim rs As System.Data.SqlClient.SqlDataReader : rs = Nothing
        Dim current_total As Integer = 0
        Dim query As String = ""
        Dim pie_title_section As String = ""
        Dim record_count As Integer = 0
        Dim x As Integer = 0
        Dim strBuilder As New StringBuilder
        Dim high_number As Integer = 0
        Dim low_number As Integer = 20000000
        Dim temp_title As String = ""
        Dim bgcolor As String = ""
        Dim counter_for_break As Integer = 2
        display_OperatorView_PieChart = ""

        Try


            query = "SELECT Case ISNULL(comp_country,'') When '' then 'unknown' ELSE comp_country END AS comp_country, COUNT(*) AS tcount"
            query = query & " FROM Aircraft_Summary WITH(NOLOCK) "
            'query = query & " INNER JOIN Company WITH(NOLOCK) INNER JOIN Aircraft_Reference WITH(NOLOCK) ON comp_id = cref_comp_id AND"
            ' query = query & " comp_journ_id = cref_journ_id ON ac_journ_id = cref_journ_id AND ac_id = cref_ac_id INNER JOIN Aircraft_Model WITH(NOLOCK) ON ac_amod_id = amod_id"



            If product_code = "B" Then
                query = query & " WHERE ac_product_business_flag = 'Y' and ac_lifecycle_stage = 3"
            ElseIf product_code = "C" Then
                query = query & " WHERE ac_product_commercial_flag = 'Y' and ac_lifecycle_stage = 3"
            ElseIf product_code = "H" Then
                query = query & " WHERE ac_product_helicopter_flag = 'Y' and ac_lifecycle_stage = 3"
            Else
                query = query & " WHERE ac_product_business_flag = 'Y' and ac_lifecycle_stage = 3"
            End If



            query = query & " AND (cref_operator_flag IN ('Y', 'O'))"

            '   query = query & " " + commonEVO.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, False)
            query = query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, True)

            If CLng(comp_id) > 0 Then
                query = query & " AND comp_id = " & CStr(comp_id)
            End If

            If CLng(amod_id) > 0 Then
                query = query & " AND amod_id = " & CStr(amod_id)
            End If

            query = query & " GROUP BY comp_country ORDER BY tcount DESC"


            If Session("debug") Then
                Response.Write("<b>display_OperatorView_PieChart : " & Server.HtmlEncode(query) & "</b><br /><br />")
            End If

            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            '  End Select

            ' End Select
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = query
            rs = SqlCommand.ExecuteReader()


            If rs.HasRows Then

                Me.OP_COUNTRY_CHART.Series.Add("OP_COUNTRY_CHART").ChartType = UI.DataVisualization.Charting.SeriesChartType.Pie
                Me.OP_COUNTRY_CHART.ChartAreas("ChartArea1").AxisY.Title = "title1"

                Me.OP_COUNTRY_CHART.ChartAreas("ChartArea1").Area3DStyle.Enable3D = True
                'Me.SPI_QUARTER.ChartAreas("ChartArea1").Area3DStyle.Perspective = 5
                Me.OP_COUNTRY_CHART.ChartAreas("ChartArea1").Area3DStyle.Rotation = 10

                Me.OP_COUNTRY_CHART.Series("OP_COUNTRY_CHART").Color = Drawing.Color.Blue
                '     Me.OP_COUNTRY_CHART.Series("OP_COUNTRY_CHART").BorderWidth = 1
                '     Me.OP_COUNTRY_CHART.Series("OP_COUNTRY_CHART").MarkerSize = 5
                '     Me.OP_COUNTRY_CHART.Series("OP_COUNTRY_CHART").MarkerStyle = UI.DataVisualization.Charting.MarkerStyle.Circle
                '     Me.OP_COUNTRY_CHART.BorderlineWidth = 10
                Me.OP_COUNTRY_CHART.Series("OP_COUNTRY_CHART").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32

                If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                    Me.OP_COUNTRY_CHART.Width = 250
                    Me.OP_COUNTRY_CHART.Height = 250
                End If


                '     display_OperatorView_PieChart = display_OperatorView_PieChart & "<table width='100%'>"
                display_OperatorView_PieChart = display_OperatorView_PieChart & "<table valign='top' width='100%'><tr valign='top'><td valign='top' width='33%'><table valign='top' width='100%'>"

                Do While rs.Read
                    counter_for_break = counter_for_break + 1

                    If Not IsDBNull(rs("comp_country")) Then
                        If Trim(rs("comp_country")) <> "" Then

                            If bgcolor = "#ffffff" Then
                                bgcolor = "#F6F6F6"
                            Else
                                bgcolor = "#ffffff"
                            End If

                            Me.OP_COUNTRY_CHART.Series("OP_COUNTRY_CHART").Points.Add(rs("tcount"))


                            If x = 5 Then
                                display_OperatorView_PieChart = display_OperatorView_PieChart & "<tr><Td bgcolor='white'>&nbsp;</td></tr>"
                            End If

                            display_OperatorView_PieChart = display_OperatorView_PieChart & "<tr bgcolor='" & bgcolor & "' valign='top'><td align='left' valign='top' width='100%'>"

                            If x < 5 Then
                                Me.OP_COUNTRY_CHART.Series("OP_COUNTRY_CHART").Points.Last.Label = x + 1
                                display_OperatorView_PieChart = display_OperatorView_PieChart & "<font size='2px'>" & (x + 1) & ". "
                                display_OperatorView_PieChart = display_OperatorView_PieChart & rs("comp_country") & "</font>"
                                display_OperatorView_PieChart = display_OperatorView_PieChart & "</td><td align='right'><font size='2px'>" & rs("tcount") & "</font></td></tr>"
                            Else
                                display_OperatorView_PieChart = display_OperatorView_PieChart & "<font size='1px'>" & rs("comp_country") & "</font>"
                                display_OperatorView_PieChart = display_OperatorView_PieChart & "</td><td align='right'><font size='1px'>" & rs("tcount") & "</font></td></tr>"
                            End If



                            If counter_for_break = 14 Then
                                display_OperatorView_PieChart = display_OperatorView_PieChart & "</table></td><td width='1%'>&nbsp;</td><td valign='top' width='22%'><table valign='top' width='100%'>"
                                counter_for_break = 0
                            End If



                            x = x + 1
                        End If
                    End If



                    current_total = current_total + 1
                    record_count = record_count + 1
                Loop


                display_OperatorView_PieChart = display_OperatorView_PieChart & "</table></td></tr></table>"

                rs.Close()
                '
                '        display_OperatorView_PieChart = display_OperatorView_PieChart & "</table>"

                Me.PER_MONTH.ChartAreas("ChartArea1").AxisY.Maximum = high_number + 1
                Me.AVG_DAYS_ON.ChartAreas("ChartArea1").AxisY.Minimum = low_number - 1



            Else
                strBuilder.Append("")
            End If


            rs = Nothing


            strBuilder = Nothing

        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function

    Function displayOperatorCompanies(ByVal real_company_name, ByVal real_model_name, ByVal product_code, ByVal engine_name, ByVal amod_id, ByVal comp_id, ByVal sub_info, ByVal sub_type)
        displayOperatorCompanies = ""
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim adors As System.Data.SqlClient.SqlDataReader : adors = Nothing
        Dim query As String = ""
        Dim final_totals As Integer = 0
        Dim company_information As String = ""
        Dim type_of_search As String = ""
        Dim tmp_title_holder As String = ""
        Dim strBuilder As New StringBuilder
        Dim totaltot As Integer = 0
        Dim inservicetot As Integer = 0
        Dim onordertot As Integer = 0
        Dim leasedtota As Integer = 0
        Dim retiredtot As Integer = 0
        Dim inserviceshowtot As Integer = 0
        Dim onordershowtot As Integer = 0
        Dim leasedshowtot As Integer = 0
        Dim retiredshowtot As Integer = 0
        Dim retiredshowtot2 As Integer = 0
        Dim retiredtot2 As Integer = 0
        Dim total_total_line As Integer = 0
        Dim leasedtot As Integer = 0
        Dim nColspan As Integer = 0
        Dim countcompany As Integer = 0
        Dim bgcolor As String = ""
        Dim total As Integer = 0
        Dim runningtotal As Integer = 0
        Dim table_name As String = ""
        Dim title As String = ""
        Dim sub_title As String = ""
        Dim hidden_counter As Integer = 0

        Try

            If CLng(amod_id) > 0 Or Trim(engine_name) <> "" And Trim(engine_name) <> "ALL" Then
                query = "SELECT distinct top 100 comp_name, comp_country, comp_id, count(distinct ac_id) as account"
            Else
                query = "SELECT distinct top 100 comp_name, comp_country, comp_id, count(distinct ac_id) as account"
            End If

            query = query & " from Aircraft_Summary a WITH(NOLOCK)  "

            If product_code = "B" Then
                query = query & " WHERE  ac_product_business_flag = 'Y'"
            ElseIf product_code = "C" Then
                query = query & " WHERE ac_product_commercial_flag = 'Y'"
            ElseIf product_code = "H" Then
                query = query & " WHERE  ac_product_helicopter_flag = 'Y'"
            Else
                query = query & " WHERE ac_product_business_flag = 'Y'"
            End If

            'query = query & " AND cref_operator_flag IN ('Y', 'O')"

            '  query = query & " " + commonEVO.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, False)
            query = query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, True)


            query = query & " and ac_lifecycle_stage = '3' and cref_operator_flag IN ('Y', 'O')   "

            If CLng(comp_id) > 0 Then
                query = query & " and comp_id = " & CLng(comp_id)
            End If

            If CLng(amod_id) > 0 Then
                query = query & " and amod_id = " & CLng(amod_id)
            End If

            If Trim(engine_name) <> "" And UCase(Trim(engine_name)) <> "ALL" Then
                query = query & " and ac_engine_name = '" & Trim(engine_name) & "'"
            End If

            query = query & " GROUP BY comp_name, comp_country, comp_id"
            query = query & " ORDER BY count(distinct ac_id) desc, comp_name asc"

            If Session("debug") Then
                Response.Write("<b>displayOperatorCompanies : " & Server.HtmlEncode(query) & "</b><br /><br />")
            End If


            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = query
            adors = SqlCommand.ExecuteReader()


            If adors.HasRows Then


                If CLng(comp_id) > 0 Then
                    If Trim(tmp_title_holder) = "" Then
                        tmp_title_holder = real_company_name
                    Else
                        tmp_title_holder = tmp_title_holder & " - " & real_company_name
                    End If
                End If

                If CLng(amod_id) > 0 Then
                    If Trim(tmp_title_holder) = "" Then
                        tmp_title_holder = real_model_name
                    Else
                        tmp_title_holder = tmp_title_holder & " - " & real_model_name
                    End If
                End If

                If Trim(engine_name) <> "" And Trim(engine_name) <> "ALL" Then

                    title = "OPERATOR SUMMARY : " & tmp_title_holder & Trim(engine_name) & " Engine"

                Else

                    If CLng(amod_id) = 0 And CLng(comp_id) = 0 Then
                        title = "OPERATOR SUMMARY : TOP 100 OPERATORS"
                    Else
                        title = "OPERATOR SUMMARY : " & tmp_title_holder
                    End If

                End If

                If WD.SelectedValue.ToString = "WD" Then
                    If product_code = "C" Then
                        sub_title = sub_title & "<table cellspacing='0' cellpadding='0' border='0' valign='top' width='" & word_width & "'><tr><td valign='middle' valign='top' align='left' width='" & word_60 & "'>"
                    Else
                        sub_title = sub_title & "<table cellspacing='0' cellpadding='0' border='0' valign='top' width='" & word_width & "'><tr><td valign='middle' valign='top' align='left' width='" & word_60 & "'>"
                    End If
                Else
                    If product_code = "C" Then
                        sub_title = sub_title & "<table cellspacing='0' cellpadding='0' border='0' valign='top' width='100%'><tr><td valign='middle' valign='top' align='left' width='60%'>"
                    Else
                        sub_title = sub_title & "<table cellspacing='0' cellpadding='0' border='0' valign='top' width='100%'><tr><td valign='middle' valign='top' align='left' width='60%'>"
                    End If
                End If



                sub_title = sub_title & "<strong>Company&nbsp;Name(<em>Country<em>)</strong></td>" & vbCrLf



                If product_code = "C" Then
                    sub_title = sub_title & "<td valign='bottom' align='center' width='5%'><strong>On<br />Order</strong></td>"
                End If

                sub_title = sub_title & "<td valign='bottom' align='center'><strong>In<br />Operation</strong></td>"
                sub_title = sub_title & "<td valign='bottom' align='center'><strong>Leased</strong></td>"

                If product_code = "C" Then
                    sub_title = sub_title & "<td valign='bottom' align='center' width='7%'><strong>In<br />Storage</strong></td>"
                    sub_title = sub_title & "<td valign='bottom' align='center' width='6%'><strong>Retired</strong></td>"
                    sub_title = sub_title & "<td valign='bottom' align='right' width='7%'><strong>Total</strong></td>"
                End If

                sub_title = sub_title & "</tr></table>" & vbCrLf

                bgcolor = "#F6F6F6"

                Do While adors.Read
                    countcompany = countcompany + 1

                    If bgcolor = "#ffffff" Then
                        bgcolor = "#F6F6F6"
                    Else
                        bgcolor = "#ffffff"
                    End If

                    If hidden_counter = 30 Then
                        strBuilder.Append(Build_PDF_Template_Footer())
                        strBuilder.Append(Insert_Page_Break_PDF())
                        strBuilder.Append(Build_PDF_Header_Final("Operator Report", sub_info, real_model_name, real_company_name, sub_type, "", "", "", True))
                        strBuilder.Append(Build_PDF_Column_Start(table_name, title, "Continued", sub_title, 7))
                        hidden_counter = 0
                    End If


                    strBuilder.Append("<tr bgcolor = '" & bgcolor & "'>")

                    If WD.SelectedValue.ToString = "WD" Then
                        strBuilder.Append("<td valign='middle' align='left' width='" & word_60 & "' class='border_bottom_right'>" & Replace(adors("comp_name"), " ", "&nbsp;") & " (<em>" & Trim(adors("comp_country") & "") & ")</em></td>")
                    Else
                        strBuilder.Append("<td valign='middle' align='left' width='60%' class='border_bottom_right'>" & Replace(adors("comp_name"), " ", "&nbsp;") & " (<em>" & Trim(adors("comp_country") & "") & ")</em></td>")
                    End If

                    inservicetot = adors("account")
                    leasedtot = count_totals_ac_table(adors("comp_id"), CLng(amod_id), "leased", 0, product_code)

                    ' ******** COUNTING FUNCTION*******      
                    If product_code = "C" Then
                        retiredtot2 = count_totals_ac_table(adors("comp_id"), CLng(amod_id), "storage", 0, product_code) ' MSW
                        retiredtot = count_totals_ac_table(adors("comp_id"), CLng(amod_id), "retired", 0, product_code)
                        onordertot = count_totals_ac_table(adors("comp_id"), CLng(amod_id), "order", 0, product_code)
                        retiredtot = retiredtot - retiredtot2
                        retiredtot = FormatNumber(retiredtot, 0)
                        retiredtot2 = FormatNumber(retiredtot2, 0)
                        onordertot = FormatNumber(onordertot, 0)
                    End If

                    ' ******** COUNTING FUNCTION*******        
                    total = inservicetot + onordertot + retiredtot + retiredtot2
                    inservicetot = FormatNumber(inservicetot, 0)
                    leasedtot = FormatNumber(leasedtot, 0)
                    total = FormatNumber(total, 0)

                    If product_code = "C" Then
                        strBuilder.Append("<td valign='middle' align='right' class='border_bottom_right'>" & onordertot & "&nbsp;</td>")
                    End If

                    strBuilder.Append("<td valign='middle' align='right' class='border_bottom_right'>" & inservicetot & "&nbsp;</td>")
                    strBuilder.Append("<td valign='middle' align='right' class='border_bottom_right'>" & leasedtot & "&nbsp;</td>")

                    If product_code = "C" Then
                        strBuilder.Append("<td valign='middle' align='right' class='border_bottom_right'>" & retiredtot2 & "&nbsp;</td>")
                        strBuilder.Append("<td valign='middle' align='right' class='border_bottom_right'>" & retiredtot & "&nbsp;</td>")
                        strBuilder.Append("<td valign='middle' align='right' class='border_bottom_right'>" & total & "&nbsp;</td>")
                    End If

                    strBuilder.Append("</tr>")

                    runningtotal = runningtotal + total

                    hidden_counter = hidden_counter + 1
                Loop


                adors.Close()


            Else



                If product_code = "B" Then
                    type_of_search = " Business "
                ElseIf product_code = "C" Then
                    type_of_search = " Commercial "
                ElseIf product_code = "H" Then
                    type_of_search = " Helicopter "
                Else
                    type_of_search = " Business "
                End If


                displayOperatorCompanies = displayOperatorCompanies & "<tr><td valign='top' align='left' class='border_bottom_right'><br>No Data Available "
                displayOperatorCompanies = displayOperatorCompanies & real_model_name & "</td></tr><tr>"


            End If

            adors = Nothing
        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try

        If CLng(comp_id) = 0 And (Trim(engine_name) = "" Or
           UCase(Trim(engine_name)) = "ALL") Then

            inservicetot = count_totals_ac_table(CLng(comp_id), CLng(amod_id), "operation", 1, product_code)

            If product_code = "C" Then
                onordertot = count_totals_ac_table(CLng(comp_id), CLng(amod_id), "order", 1, product_code)
                retiredtot2 = count_totals_ac_table(CLng(comp_id), CLng(amod_id), "storage", 1, product_code) ' MSW
                retiredtot = count_totals_ac_table(CLng(comp_id), CLng(amod_id), "retired", 1, product_code)
                retiredtot = retiredtot - retiredtot2
            End If

            leasedtot = count_totals_ac_table(CLng(comp_id), CLng(amod_id), "leased", 1, product_code)

        Else

            inservicetot = inserviceshowtot
            inservicetot = FormatNumber(inservicetot, 0)

            query = "SELECT * FROM company WITH(NOLOCK) WHERE comp_id = " & CLng(comp_id)

            Try


                SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
                '  End Select

                ' End Select
                SqlConn.Open()

                SqlCommand.Connection = SqlConn
                SqlCommand.CommandType = System.Data.CommandType.Text
                SqlCommand.CommandTimeout = 60
                SqlCommand.CommandText = query
                adors = SqlCommand.ExecuteReader()


                If adors.HasRows Then
                    adors.Read()
                    If Me.WD.SelectedValue.ToString = "WD" Then
                        company_information = "<br /><table width='" & word_width & "' cellspacing='0' cellpadding='2' class='module'>"
                    Else
                        company_information = "<br /><table width='100%' cellspacing='0' cellpadding='2' class='module'>"
                    End If

                    company_information = company_information & "<tr><td align='left' valign='middle' class='header' style='padding-left:3px;'>OPERATOR DETAILS : " & tmp_title_holder & "</td></tr>"
                    company_information = company_information & "<tr><td>Name : " & adors("comp_name") & "</td></tr>"
                    company_information = company_information & "<tr><td>City : " & adors("comp_city") & "</td></tr>"
                    company_information = company_information & "<tr><td>Country : " & adors("comp_country") & "</td></tr>"
                    company_information = company_information & "</table>"

                    adors.Close()

                End If

                adors = Nothing

            Catch ex As Exception
            Finally
                SqlCommand.Dispose()
                SqlConn.Close()
                SqlConn.Dispose()
            End Try

        End If

        totaltot = inservicetot + onordertot + retiredtot + retiredtot2
        totaltot = FormatNumber(totaltot, 0)
        retiredtot = FormatNumber(retiredtot, 0)
        retiredtot2 = FormatNumber(retiredtot2, 0)
        onordertot = FormatNumber(onordertot, 0)
        inservicetot = FormatNumber(inservicetot, 0)
        leasedtot = FormatNumber(leasedtot, 0)
        total = FormatNumber(total, 0)

        displayOperatorCompanies = displayOperatorCompanies & strBuilder.ToString()

        '    If Trim(company_information) = "" Then
        '   displayOperatorCompanies = displayOperatorCompanies & displayOperatorViewSummary(totaltot, inservicetot, onordertot, leasedtot, retiredtot, retiredtot2, "op", 1)
        '  Else
        If CLng(comp_id) > 0 Then
            displayOperatorCompanies = displayOperatorCompanies & company_information
        End If
        ' End If

        displayOperatorCompanies = Build_PDF_Column_Start(table_name, title, countcompany, sub_title, 7) & displayOperatorCompanies
        strBuilder = Nothing

    End Function
    Function count_totals_ac_table(ByVal company_id, ByVal model_id, ByVal current_to_total, ByVal is_bottom, ByVal product_code)

        count_totals_ac_table = ""

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim adors As System.Data.SqlClient.SqlDataReader : adors = Nothing
        Dim current_total As Integer = 0
        Dim query As String = ""

        query = "SELECT count(distinct ac_id) as account2"
        query = query & " FROM Aircraft_Summary"

        '   query = query & " INNER JOIN Aircraft_Model WITH(NOLOCK) ON ac_amod_id = amod_id"
        '   query = query & " INNER JOIN Aircraft_Reference WITH(NOLOCK) ON ac_journ_id = cref_journ_id AND ac_id = cref_ac_id"

        query = query & " WHERE "

        If current_to_total = "leased" Then
            query = query & " ac_lease_flag='Y'"
            If is_bottom = 0 Then
                query = query & " AND cref_operator_flag IN ('Y', 'O')"
            End If
        ElseIf current_to_total = "storage" Then
            query = query & " (ac_lifecycle_stage IN ('4'))"
            query = query & " AND ((cref_operator_flag IN ('Y', 'O')) or cref_contact_type in ('42','56'))"
            query = query & " AND (ac_status = 'Withdrawn from Use - Stored')"
        ElseIf current_to_total = "retired" Then
            query = query & " (ac_lifecycle_stage IN ('4'))"
            query = query & " AND (cref_operator_flag IN ('Y', 'O') or cref_contact_type in ('42','56'))"
        ElseIf current_to_total = "operation" Then
            query = query & " ac_lifecycle_stage IN ('3')"
            If is_bottom = 0 Then
                query = query & " AND cref_operator_flag IN ('Y', 'O')"
            End If
        ElseIf current_to_total = "order" Then
            query = query & " (ac_lifecycle_stage IN ('1','2') and (cref_contact_type in ('42') or cref_operator_flag IN ('Y', 'O'))) "  ' 
        End If

        '  query = query & " " + commonEVO.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, False)
        query = query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, True)

        If model_id > 0 Then
            query = query & " AND amod_id = " & model_id
        End If

        If company_id > 0 Then
            query = query & " AND comp_id =" & company_id
        End If

        '     query = query & " AND (ac_journ_id = 0)"


        If product_code = "B" Then
            query = query & " AND ac_product_business_flag = 'Y'"
        ElseIf product_code = "C" Then
            query = query & " AND ac_product_commercial_flag = 'Y'"
        ElseIf product_code = "H" Then
            query = query & " AND ac_product_helicopter_flag = 'Y'"
        Else
            query = query & " AND ac_product_business_flag = 'Y'"
        End If
        Try

            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            '  End Select

            ' End Select
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = query
            adors = SqlCommand.ExecuteReader()


            If adors.HasRows Then
                Do While adors.Read
                    current_total = current_total + adors("account2")
                Loop
                adors.Close()
            End If

            adors = Nothing
            count_totals_ac_table = current_total

        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try


    End Function

    Function displayEngineInfo(ByVal real_company_name, ByVal real_model_name, ByVal engine_name, ByVal comp_id, ByVal amod_id)
        displayEngineInfo = ""

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim adors As System.Data.SqlClient.SqlDataReader : adors = Nothing
        Dim current_total As Integer = 0
        Dim query As String = ""
        Dim bgcolor As String = ""
        Dim tmp_title_holder As String = ""
        Dim strBuilder As New StringBuilder
        Dim totaltot As Integer = 0
        Dim inservicetot As Integer = 0
        Dim onordertot As Integer = 0
        Dim leasedtot As Integer = 0
        Dim retiredtot As Integer = 0
        totaltot = 0
        inservicetot = 0
        onordertot = 0
        leasedtot = 0
        retiredtot = 0
        Try
            query = "SELECT DISTINCT ac_engine_name, ameng_mfr_name, count(*) as tcount"
            query = query & " FROM Aircraft WITH(NOLOCK) "
            query = query & " INNER JOIN Aircraft_Model WITH(NOLOCK) ON ac_amod_id = amod_id"
            query = query & " LEFT OUTER JOIN Aircraft_Reference WITH(NOLOCK) ON ac_id = cref_ac_id and ac_journ_id = cref_journ_id and cref_operator_flag IN ('Y', 'O') "
            query = query & " LEFT OUTER JOIN company WITH(NOLOCK) ON comp_id = cref_comp_id and comp_journ_id = cref_journ_id "
            query = query & " INNER JOIN Aircraft_Model_Engine WITH(NOLOCK) ON ameng_engine_name = ac_engine_name "

            If CLng(amod_id) > 0 Then
                query = query & " AND ameng_amod_id =" & CLng(amod_id)
            End If

            query = query & " WHERE (ac_journ_id = 0) AND (ac_product_commercial_flag = 'Y') and ac_lifecycle_stage = 3"
            query = query & " AND ac_engine_name is not NULL "

            '  query = query & " " + commonEVO.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, False)
            query = query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, True)

            If CLng(amod_id) > 0 Then
                query = query & " AND amod_id =" & CLng(amod_id)
            End If

            If CLng(comp_id) > 0 Then
                query = query & " AND comp_id =" & CLng(comp_id)
            End If

            If Trim(engine_name) <> "" And Trim(engine_name) <> "ALL" Then
                query = query & " AND ac_engine_name = '" & Trim(engine_name) & "'"
            End If

            query = query & " GROUP BY ac_engine_name, ameng_mfr_name"
            query = query & " ORDER BY count(*) desc"

            If Session("debug") Then
                Response.Write("<b>displayEngineInfo : " & Server.HtmlEncode(query) & "</b><br /><br />")
            End If

            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            '  End Select

            ' End Select
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = query
            adors = SqlCommand.ExecuteReader()

            If adors.HasRows Then


                If CLng(comp_id) > 0 Then
                    If Trim(tmp_title_holder) = "" Then
                        tmp_title_holder = real_company_name
                    Else
                        tmp_title_holder = tmp_title_holder & " - " & real_company_name
                    End If
                End If

                If CLng(amod_id) > 0 Then
                    If Trim(tmp_title_holder) = "" Then
                        tmp_title_holder = real_model_name
                    Else
                        tmp_title_holder = tmp_title_holder & " - " & real_model_name
                    End If
                End If

                strBuilder.Append("<table id='displayEngineInfoOuterTable' width='100%' cellspacing='0' cellpadding='2' class='module'>")

                If Trim(engine_name) = "ALL" Then

                    strBuilder.Append("<tr><td align='left' colspan='3' valign='middle' class='header' style='padding-left:3px;'>")
                    strBuilder.Append("<table cellpadding='0' cellspacing='0'><tr><td>")
                    strBuilder.Append("<font color='white'>ENGINE SUMMARY: ALL</font>")
                    strBuilder.Append("</td><td width='200'>&nbsp;</td><td>")
                    strBuilder.Append("<strong><a href='saveSpecificSearchCriteria.asp?txtButton=HomeCriteria&operatorViewEngine=Clear'><font color='white'>SEARCH BY MODEL</font>")
                    strBuilder.Append("</td></tr></table>")

                ElseIf Trim(engine_name) <> "" Then

                    strBuilder.Append("<tr><td align='left' colspan='3' valign='middle' class='header' style='padding-left:3px;'>")
                    strBuilder.Append("<table cellpadding='0' cellspacing='0'><tr><td><font color='white'>ENGINE SUMMARY : " & tmp_title_holder)

                    strBuilder.Append(Trim(engine_name))
                    strBuilder.Append("</font></td><td width='100'>&nbsp;</td><td width='120'>")
                    strBuilder.Append("<strong><a href='saveSpecificSearchCriteria.asp?txtButton=HomeCriteria&operatorViewEngine=Clear'><font color='white'>SEARCH BY MODEL</font>")
                    strBuilder.Append("</td></tr></table>")
                    strBuilder.Append("</td></tr>")

                Else

                    strBuilder.Append("<tr><td align='left' colspan='3' valign='middle' class='header' style='padding-left:3px;'>ENGINE SUMMARY : " & tmp_title_holder & "</td></tr>")

                End If

                If Trim(engine_name) = "ALL" Then
                    strBuilder.Append("<tr><td><div style='height:465px;width:100%; overflow: auto;'><p>")
                ElseIf Trim(engine_name) <> "" And Trim(engine_name) <> "ALL" Then
                    strBuilder.Append("<tr><td><div style='width:100%; overflow: auto;'><p>")
                Else
                    strBuilder.Append("<tr><td><div style='height:300px;width:100%; overflow: auto;'><p>")
                End If

                strBuilder.Append("<table id='displayEngineInfoInnerTable' width='100%' cellpadding='2' cellspacing='0' border='0'>")
                strBuilder.Append("<tr bgcolor='#EEEEEE'>")
                strBuilder.Append("<td valign='middle' align='center'><strong>Engine Name</strong></td>")
                strBuilder.Append("<td valign='middle' align='center'><strong>Manufacturer Name</strong></td>")
                strBuilder.Append("<td valign='middle' align='center'><strong>Number Of Aircraft</strong></td>")
                strBuilder.Append("</tr>")

                bgcolor = "#F6F6F6"


                Do While adors.Read

                    If bgcolor = "#ffffff" Then
                        bgcolor = "#F6F6F6"
                    Else
                        bgcolor = "#ffffff"
                    End If

                    inservicetot = inservicetot + adors("tcount")
                    strBuilder.Append("<tr bgcolor = '" & bgcolor & "'>")
                    strBuilder.Append("<td valign='middle' align='left' class='border_bottom_right'>")
                    strBuilder.Append(adors("ac_engine_name") & "</td>")
                    strBuilder.Append("<td class='border_bottom_right'>" & adors("ameng_mfr_name") & "</td>")
                    strBuilder.Append("<td class='border_bottom_right'>" & adors("tcount") & "</td>")
                    strBuilder.Append("</tr>")


                Loop

                adors.Close()

                strBuilder.Append("</table>")


                strBuilder.Append("</td></tr></table>")


            End If

            displayEngineInfo = strBuilder.ToString()
            strBuilder = Nothing
        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function

    Function ReturnQuarterlyWithoutModel(ByVal lModelId, ByRef strHTMLData1, ByRef strGraphVarianceAsking,
                ByVal sub_info, ByVal real_make_model_name, ByVal sub_type, ByVal weight_class, ByVal weight_class_name, ByVal spi_year, ByVal spi_year2, ByVal airframe_type, ByVal color)

        ReturnQuarterlyWithoutModel = ""
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim rstRec1 As System.Data.SqlClient.SqlDataReader : rstRec1 = Nothing
        Dim strMake As String = ""
        Dim tmpGraph As String = ""
        Dim strQuery1

        Dim strMakeAbbrev
        Dim strModel
        Dim strAModId
        Dim lAModID

        Dim strAvgYearMfr
        Dim strAvgYearDlv
        Dim strAvgAsking
        Dim strAvgAskingHidden
        Dim strAvgSelling
        Dim strPercent
        Dim strPercentHidden
        Dim strVariance
        Dim strVarianceHidden
        Dim strAvgAFTT
        Dim strAvgDOM

        ' Dim lYearSld
        '  Dim lQuarterSld
        Dim dAvgYearMfr
        Dim dAvgYearDlv
        Dim dAvgAsking
        Dim dAvgAskingHidden
        Dim dAvgSelling
        Dim dPercent
        Dim dPercentHidden
        Dim dVariance
        Dim dVarianceHidden
        Dim dAvgAFTT
        Dim dAvgDOM


        Dim lColSpan As Integer = 1
        Dim lTotRec

        ' Dim objGraph
        Dim lGraphType
        '  Dim strGraphImage
        ' Dim lMaxSets
        '  Dim lThisSet

        ' Percentage Of Asking Price     
        Dim strTitle1
        Dim strBottomTitle1 As String = ""
        Dim strLeftTitle1 As String = ""
        Dim lCnt1
        Dim aData1()
        Dim aLabels1()

        ' Variance Of Asking Price     
        Dim strTitle2
        Dim strBottomTitle2 As String = ""
        Dim strLeftTitle2 As String = ""
        Dim lCnt2
        Dim aData2()
        Dim aLabels2()

        ' Asking Price     
        Dim strTitle3
        Dim strBottomTitle3 As String = ""
        Dim strLeftTitle3 As String = ""
        Dim lCnt3
        Dim aData3()
        Dim aLabels3()

        ' Selling Price     
        Dim strTitle4
        Dim strBottomTitle4
        Dim strLeftTitle4 As String = ""
        Dim lCnt4
        Dim aData4()
        Dim aLabels4()

        ' Asking vs Selling Price     
        Dim strTitle5
        Dim strBottomTitle5
        Dim strLeftTitle5 As String = ""
        Dim strRightTitle5 As String = ""
        Dim lCnt5a
        Dim lCnt5b
        Dim aData5a()  ' Asking
        Dim aData5b()  ' Selling
        Dim aLabels5a()
        Dim aLabels5b()

        ' AFTT (Airframe Total Time)
        Dim strTitle6
        Dim strBottomTitle6 As String = ""
        Dim strLeftTitle6 As String = ""
        Dim lCnt6
        Dim aData6()
        Dim aLabels6()

        ' DOM (Days On Market)
        Dim strTitle7
        Dim strBottomTitle7 As String = ""
        Dim strLeftTitle7 As String = ""
        Dim lCnt7
        Dim aData7()
        Dim aLabels7()

        ' AFTT vs Variance
        Dim strTitle8
        Dim strBottomTitle8 As String = ""
        Dim strLeftTitle8 As String = ""
        Dim lCnt8
        Dim aData8()
        Dim aLabels8()

        ' DOM vs Variance
        Dim strTitle9
        Dim strBottomTitle9 As String = ""
        Dim strLeftTitle9 As String = ""
        Dim lCnt9
        Dim aData9()
        Dim aLabels9()

        ' AFTT vs Selling Price
        Dim strTitle10
        Dim strBottomTitle10 As String = ""
        Dim strLeftTitle10 As String = ""
        Dim lCnt10
        Dim aData10()
        Dim aLabels10()

        ' DOM vs Selling Price
        Dim strTitle11
        Dim strBottomTitle11 As String = ""
        Dim strLeftTitle11 As String = ""
        Dim lCnt11
        Dim aData11()
        Dim aLabels11()

        Dim temp_data()

        ' Clear All Variables Passed By Reference
        strHTMLData1 = ""
        Try


            Dim strGraphPercentAsking As String = "Percentage of Asking Price (%)<br />Not Enough Data Available"

            Dim strGraphAskingVsSelling As String = "Asking vs selling Price (k)<br />Not Enough Data Available"

            Dim strGraphAsking As String = "Asking Price (k)<br />Not Enough Data Available"
            Dim strGraphSelling As String = "Selling Price (k)<br />Not Enough Data Available"
            Dim strGraphAFTT As String = "Average Airframe Total Time<br />Not Enough Data Available"
            Dim strGraphDOM As String = "Average Days On Market for Sales<br />Not Enough Data Available"

            Dim strGraphAFTTVsVariance As String = "Avg AFTT vs Variance (%)<br />Not Enough Data Available"
            Dim strGraphDOMVsVariance As String = "Avg DOM vs Variance (%)<br />Not Enough Data Available"
            Dim strGraphAFTTVsSelling As String = "AFTT vs Selling Price (k)<br />Not Enough Data Available"
            Dim strGraphDOMVsSelling As String = "Avg DOM vs Selling Price (k)<br />Not Enough Data Available"
            strGraphVarianceAsking = "Variance of Asking Price (%)<br />Not Enough Data Available"

            strQuery1 = "SELECT amod_id As AModId, amod_make_name As Make, amod_make_abbrev As MakeAbbrev, amod_model_name As Model,"
            strQuery1 = strQuery1 & " AVG(CAST(ac_mfr_year AS INT)) As dAvgYearMfr,"
            strQuery1 = strQuery1 & " AVG(CAST(ac_year AS INT)) As dAvgYearDlv,"
            strQuery1 = strQuery1 & " AVG(ac_asking_price) As dAvgAsking,"
            strQuery1 = strQuery1 & " AVG(ac_hidden_asking_price) As dAvgAskingHidden,"
            strQuery1 = strQuery1 & " AVG(ac_sale_price) As dAvgSelling,"
            strQuery1 = strQuery1 & " ((AVG(ac_sale_price)/AVG(ac_asking_price)) * 100) As dPercent,"
            strQuery1 = strQuery1 & " ((1-(AVG(ac_sale_price)/AVG(ac_asking_price))) * 100) As dVariance,"
            strQuery1 = strQuery1 & " ((AVG(ac_sale_price)/AVG(ac_hidden_asking_price)) * 100) As dPercentHidden,"
            strQuery1 = strQuery1 & " ((1-(AVG(ac_sale_price)/AVG(ac_hidden_asking_price))) * 100) As dVarianceHidden,"
            strQuery1 = strQuery1 & " AVG(ac_airframe_tot_hrs) As dAvgAFTT,"
            strQuery1 = strQuery1 & " AVG(DateDiff(day,ac_list_date, journ_date)) As dAvgDOM"

            strQuery1 = strQuery1 & " FROM Aircraft_Summary_SPI WITH (NOLOCK)"
            'strQuery1 = strQuery1 & " FROM Aircraft WITH (NOLOCK, INDEX(ix_ac_sale_price_ac_id_journ_id_key))"
            'strQuery1 = strQuery1 & " INNER JOIN Aircraft_Model WITH (NOLOCK) ON ac_amod_id = amod_id"
            'strQuery1 = strQuery1 & " INNER JOIN Journal WITH (NOLOCK) ON ac_id = journ_ac_id AND ac_journ_id = journ_id"
            'strQuery1 = strQuery1 & " INNER JOIN Journal_Category WITH (NOLOCK) ON journ_subcategory_code = jcat_subcategory_code"

            strQuery1 = strQuery1 & " WHERE (ac_journ_id > 0)"
            strQuery1 = strQuery1 & " AND (ac_lifecycle_stage = 3)"                   '-- In Operation Only
            strQuery1 = strQuery1 & " AND (jcat_used_retail_sales_flag = 'Y')"        '-- Retail Only    
            strQuery1 = strQuery1 & " AND (journ_newac_flag = 'N')"                   '-- Used Sales Only
            strQuery1 = strQuery1 & " AND (journ_subcategory_code LIKE 'WS%')"        '-- Whole Sales Only
            strQuery1 = strQuery1 & " AND (journ_subcategory_code NOT LIKE '%IT%')"   '-- No Internals
            strQuery1 = strQuery1 & " AND (journ_internal_trans_flag = 'N')"          '-- No Internals

            Select Case CLng(Session("salesPriceViewAirframeType"))
                Case Is = 1
                    strQuery1 = strQuery1 & " AND (amod_customer_flag = 'Y' AND amod_airframe_type_code='F' AND amod_type_code = 'E')"
                Case Is = 2
                    strQuery1 = strQuery1 & " AND (amod_customer_flag = 'Y' AND amod_airframe_type_code='F' AND amod_type_code = 'J')"
                Case Is = 3
                    strQuery1 = strQuery1 & " AND (amod_customer_flag = 'Y' AND amod_airframe_type_code='F' AND amod_type_code = 'T')"
                Case Is = 4
                    strQuery1 = strQuery1 & " AND (amod_customer_flag = 'Y' AND amod_airframe_type_code='F' AND amod_type_code = 'P')"
                Case Is = 5
                    strQuery1 = strQuery1 & " AND (amod_customer_flag = 'Y' AND amod_airframe_type_code='R' AND amod_type_code in ('T','P'))"
            End Select

            '   strQuery1 = strQuery1 & GenerateProductCodeSelectionQuery(Session("Product_Code"), Session("UserTierLevel"), False, False, False)
            ' strQuery1 = strQuery1 & commonEVO.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, True)
            strQuery1 = strQuery1 & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, True)

            If Trim(Session("salesPriceViewMake")) <> "" Then
                strQuery1 = strQuery1 & "AND amod_make_name LIKE '" & Session("salesPriceViewMake") & "%'"
            End If

            If Trim(Session("salesPriceViewWtCls")) <> "" Then

                If InStr(1, Session("salesPriceViewWtCls"), ",") = 0 Then
                    strQuery1 = strQuery1 & " AND (amod_weight_class = '" & Session("salesPriceViewWtCls") & "')"
                Else
                    strQuery1 = strQuery1 & " AND (amod_weight_class IN ('" & Replace(Session("salesPriceViewWtCls"), ",", "','") & "'))"
                End If

            End If

            If Trim(Session("SPYearSld1")) <> "" Then
                strQuery1 = strQuery1 & " AND (DATEPART(year,journ_date) = " & Session("SPYearSld1") & ")"
                If Trim(Session("SPYearQtr1")) <> "" Then
                    strQuery1 = strQuery1 & " AND (DATEPART(quarter,journ_date) = " & Session("SPYearQtr1") & ")"
                End If
            End If

            strQuery1 = strQuery1 & " AND (ac_sale_price IS NOT NULL) AND (ac_sale_price <> 0)"

            strQuery1 = strQuery1 & " GROUP BY amod_id, amod_make_name, amod_make_abbrev, amod_model_name"
            strQuery1 = strQuery1 & " ORDER BY amod_make_name, amod_make_abbrev, amod_model_name"

            If Session("debug") Then
                Response.Write("<b>ReturnQuarterlyWithoutModel : " & Server.HtmlEncode(strQuery1) & "</b><br /><br />")
            End If

            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            '  End Select

            ' End Select
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = strQuery1
            rstRec1 = SqlCommand.ExecuteReader()

            strHTMLData1 = "<table id='quarterlyWithoutModelDataTable' cellpadding='2' cellspacing='0' width='100%' class='salesPrice'>"

            strHTMLData1 = strHTMLData1 & "<tr bgcolor='#CCCCCC'><td align='center' colspan='10'>"
            '  strHTMLData1 = strHTMLData1 & ReturnYearQuarterName(Session("SPYearSld1"), Session("SPYearQtr1"))

            If Trim(Session("salesPriceViewMake")) <> "" Then
                strHTMLData1 = strHTMLData1 & " For " & Session("salesPriceViewMake")
            End If

            strHTMLData1 = strHTMLData1 & "</td></tr>"

            strHTMLData1 = strHTMLData1 & "<tr bgcolor='#CCCCCC'><td align='center' rowspan='2'>Make</td>"
            strHTMLData1 = strHTMLData1 & "<td align='center' rowspan='2'>Model</td>"
            strHTMLData1 = strHTMLData1 & "<td align='center' colspan='2'>Avg Year Of</td>"
            strHTMLData1 = strHTMLData1 & "<td align='center' colspan='2'>Avg Price (k)</td>"
            strHTMLData1 = strHTMLData1 & "<td align='center' rowspan='2'>Percent</td>"
            strHTMLData1 = strHTMLData1 & "<td align='center' rowspan='2'>Variance</td>"
            strHTMLData1 = strHTMLData1 & "<td align='center' colspan='2'>Average</td></tr>"

            strHTMLData1 = strHTMLData1 & "<tr bgcolor='#CCCCCC'><td align='center'>Mfr</td>"
            strHTMLData1 = strHTMLData1 & "<td align='center'>Delivery</td>"
            strHTMLData1 = strHTMLData1 & "<td align='center'>Asking</td>"
            strHTMLData1 = strHTMLData1 & "<td align='center'>Selling</td>"
            strHTMLData1 = strHTMLData1 & "<td align='center'>AFTT</td>"
            strHTMLData1 = strHTMLData1 & "<td align='center'>Days<br />On<br />Market</td></tr>"

            If rstRec1.HasRows Then


                'lTotRec = rstRec1.RecordCount
                lTotRec = 1001
                lCnt1 = 0
                lCnt2 = 0
                lCnt3 = 0
                lCnt4 = 0
                lCnt5a = 0
                lCnt5b = 0
                lCnt6 = 0
                lCnt7 = 0
                lCnt8 = 0
                lCnt9 = 0
                lCnt10 = 0
                lCnt11 = 0

                ReDim aData1(lTotRec)      ' Percentage Of Asking Price
                ReDim aLabels1(lTotRec)

                ReDim aData2(lTotRec)      ' Variance Of Asking Price
                ReDim aLabels2(lTotRec)

                ReDim aData3(lTotRec)      ' Asking Price
                ReDim aLabels3(lTotRec)

                ReDim aData4(lTotRec)      ' Selling Price
                ReDim aLabels4(lTotRec)

                ReDim aData5a(lTotRec)     ' Asking Price
                ReDim aLabels5a(lTotRec)

                ReDim aData5b(lTotRec)      ' Selling Price
                ReDim aLabels5b(lTotRec)

                ReDim aData6(lTotRec)      ' Avg AFTT
                ReDim aLabels6(lTotRec)

                ReDim aData7(lTotRec)      ' Avg DOM
                ReDim aLabels7(lTotRec)

                ReDim aData8(lTotRec)      ' Avg AFTT vs Variance
                ReDim aLabels8(lTotRec)

                ReDim aData9(lTotRec)      ' Avg DOM vs Variance
                ReDim aLabels9(lTotRec)

                ReDim aData10(lTotRec)     ' Avg AFTT vs Selling Price
                ReDim aLabels10(lTotRec)

                ReDim aData11(lTotRec)     ' Avg DOM vs Selling Price
                ReDim aLabels11(lTotRec)
                Do While rstRec1.Read

                    strMake = ""
                    strMakeAbbrev = ""
                    strModel = ""
                    strAModId = "0"
                    lAModID = 0

                    strAvgYearMfr = ""
                    strAvgYearDlv = ""
                    strAvgAsking = ""
                    strAvgAskingHidden = ""
                    strAvgSelling = ""
                    strPercent = ""
                    strPercentHidden = ""
                    strVariance = ""
                    strVarianceHidden = ""
                    strAvgAFTT = ""
                    strAvgDOM = ""

                    dAvgYearMfr = 0.0
                    dAvgYearDlv = 0.0
                    dAvgAsking = 0.0
                    dAvgAskingHidden = 0.0
                    dAvgSelling = 0.0
                    dPercent = 0.0
                    dPercentHidden = 0.0
                    dVariance = 0.0
                    dVarianceHidden = 0.0
                    dAvgAFTT = 0.0
                    dAvgDOM = 0.0

                    strMake = Trim(rstRec1("Make").ToString)
                    strMakeAbbrev = Trim(rstRec1("MakeAbbrev").ToString)
                    strModel = Trim(rstRec1("Model").ToString)
                    lAModID = rstRec1("AModId").ToString
                    strAModId = CStr(lAModID)

                    If Not IsDBNull(rstRec1("dAvgYearMfr")) Then
                        dAvgYearMfr = rstRec1("dAvgYearMfr")
                    Else
                        dAvgYearMfr = 0
                    End If

                    If Not IsDBNull(rstRec1("dAvgYearDlv")) Then
                        dAvgYearDlv = rstRec1("dAvgYearDlv")
                    Else
                        dAvgYearDlv = 0
                    End If

                    If Not IsDBNull(rstRec1("dAvgAsking")) Then
                        dAvgAsking = rstRec1("dAvgAsking")
                    Else
                        dAvgAsking = 0
                    End If

                    If Not IsDBNull(rstRec1("dAvgAskingHidden")) Then
                        dAvgAskingHidden = rstRec1("dAvgAskingHidden")
                    Else
                        dAvgAskingHidden = 0
                    End If

                    If dAvgAsking = 0 And dAvgAskingHidden > 0 Then
                        dAvgAsking = dAvgAskingHidden
                    End If

                    If Not IsDBNull(rstRec1("dAvgSelling")) Then
                        dAvgSelling = rstRec1("dAvgSelling")
                    Else
                        dAvgSelling = 0
                    End If

                    If Not IsDBNull(rstRec1("dPercent")) Then
                        dPercent = rstRec1("dPercent")
                    Else
                        dPercent = 0
                    End If

                    If Not IsDBNull(rstRec1("dPercentHidden")) Then
                        dPercentHidden = rstRec1("dPercentHidden")
                    Else
                        dPercentHidden = 0
                    End If

                    If dAvgAsking = 0 And dAvgAskingHidden > 0 Then
                        dPercent = dPercentHidden
                    End If

                    If Not IsDBNull(rstRec1("dVariance")) Then
                        dVariance = rstRec1("dVariance")
                    Else
                        dVariance = 0
                    End If

                    If Not IsDBNull(rstRec1("dVarianceHidden")) Then
                        dVarianceHidden = rstRec1("dVarianceHidden")
                    Else
                        dVarianceHidden = 0
                    End If

                    If dAvgAsking = 0 And dAvgAskingHidden > 0 Then
                        dVariance = dVarianceHidden
                    End If

                    If Not IsDBNull(rstRec1("dAvgAFTT")) Then
                        dAvgAFTT = rstRec1("dAvgAFTT")
                    Else
                        dAvgAFTT = 0
                    End If

                    If Not IsDBNull(rstRec1("dAvgDOM")) Then
                        dAvgDOM = rstRec1("dAvgDOM")
                    Else
                        dAvgDOM = 0
                    End If


                    strHTMLData1 = strHTMLData1 & "<tr><td align='left' nowrap='nowrap'>" & strMake & "</td>"
                    strHTMLData1 = strHTMLData1 & "<td align='left' nowrap='nowrap'>" & strModel & "</td>"

                    strHTMLData1 = strHTMLData1 & "<td align='center'>"
                    If dAvgYearMfr > 0 Then
                        strHTMLData1 = strHTMLData1 & CStr(dAvgYearMfr) & "</td>"
                    Else
                        strHTMLData1 = strHTMLData1 & "0</td>"
                    End If

                    strHTMLData1 = strHTMLData1 & "<td align='center'>"
                    If dAvgYearDlv > 0 Then
                        strHTMLData1 = strHTMLData1 & CStr(dAvgYearDlv) & "</td>"
                    Else
                        strHTMLData1 = strHTMLData1 & "&nbsp;</td>"
                    End If

                    strHTMLData1 = strHTMLData1 & "<td align='right'>"
                    If dAvgAsking > 0 Then
                        strHTMLData1 = strHTMLData1 & "$" & FormatNumber(dAvgAsking / 1000, 0, True) & "</td>"
                    Else
                        strHTMLData1 = strHTMLData1 & "&nbsp;</td>"
                    End If

                    strHTMLData1 = strHTMLData1 & "<td align='right'>"
                    If dAvgSelling > 0 Then
                        strHTMLData1 = strHTMLData1 & "$" & FormatNumber(dAvgSelling / 1000, 0, True) & "</td>"
                    Else
                        strHTMLData1 = strHTMLData1 & "&nbsp;</td>"
                    End If

                    strHTMLData1 = strHTMLData1 & "<td align='right'>"
                    If dPercent > 0 Then
                        strHTMLData1 = strHTMLData1 & FormatNumber(dPercent, 1, True) & "%" & "</td>"
                    Else
                        strHTMLData1 = strHTMLData1 & "&nbsp;</td>"
                    End If

                    strHTMLData1 = strHTMLData1 & "<td align='right'>"
                    If dAvgAsking > 0 Then
                        strHTMLData1 = strHTMLData1 & FormatNumber(dVariance, 1, True) & "%" & "</td>"
                    ElseIf dAvgAsking = dAvgSelling Then
                        strHTMLData1 = strHTMLData1 & "0.0%</td>"
                    Else
                        strHTMLData1 = strHTMLData1 & "&nbsp;</td>"
                    End If

                    strHTMLData1 = strHTMLData1 & "<td align='right'>"
                    If dAvgAFTT > 0 Then
                        strHTMLData1 = strHTMLData1 & FormatNumber(dAvgAFTT, 0, True) & "</td>"
                    Else
                        strHTMLData1 = strHTMLData1 & "&nbsp;</td>"
                    End If

                    strHTMLData1 = strHTMLData1 & "<td align='right'>"
                    If dAvgDOM > 0 Then
                        strHTMLData1 = strHTMLData1 & FormatNumber(dAvgDOM, 0, True) & "</td>"
                    Else
                        strHTMLData1 = strHTMLData1 & "&nbsp;</td>"
                    End If

                    strHTMLData1 = strHTMLData1 & "</tr>"

                    ' Percentage Of Asking Price  
                    If dAvgAsking > 0 Then
                        lCnt1 = lCnt1 + 1
                        aLabels1(lCnt1 - 1) = "(" & strMakeAbbrev & ") " & strModel
                        aData1(lCnt1 - 1) = CDbl(FormatNumber(dPercent, 1, True))
                    End If

                    ' Variance Of Asking Price  
                    If dAvgAsking > 0 Then
                        lCnt2 = lCnt2 + 1
                        aLabels2(lCnt2 - 1) = "(" & strMakeAbbrev & ") " & strModel
                        aData2(lCnt2 - 1) = CDbl(FormatNumber(dVariance, 1, True))
                    End If

                    ' Asking Price        
                    If dAvgAsking > 0 Then
                        lCnt3 = lCnt3 + 1
                        aLabels3(lCnt3 - 1) = "(" & strMakeAbbrev & ") " & strModel
                        aData3(lCnt3 - 1) = CDbl(FormatNumber(dAvgAsking / 1000, 1, True))
                    End If

                    ' Selling Price        
                    If dAvgSelling > 0 Then
                        lCnt4 = lCnt4 + 1
                        aLabels4(lCnt4 - 1) = "(" & strMakeAbbrev & ") " & strModel
                        aData4(lCnt4 - 1) = CDbl(FormatNumber(dAvgSelling / 1000, 1, True))
                    End If

                    ' Asking Price        
                    lCnt5a = lCnt5a + 1
                    aLabels5a(lCnt5a - 1) = "(" & strMakeAbbrev & ") " & strModel
                    aData5a(lCnt5a - 1) = CDbl(FormatNumber(dAvgAsking / 1000, 1, True))

                    ' Selling Price        
                    lCnt5b = lCnt5b + 1
                    aLabels5b(lCnt5b - 1) = "(" & strMakeAbbrev & ") " & strModel
                    aData5b(lCnt5b - 1) = CDbl(FormatNumber(dAvgSelling / 1000, 1, True))

                    ' Avg AFTT
                    If dAvgAFTT > 0 Then
                        lCnt6 = lCnt6 + 1
                        aLabels6(lCnt6 - 1) = "(" & strMakeAbbrev & ") " & strModel
                        aData6(lCnt6 - 1) = CLng(FormatNumber(dAvgAFTT, 0, True))
                    End If

                    ' Avg DOM
                    If dAvgDOM > 0 Then
                        lCnt7 = lCnt7 + 1
                        aLabels7(lCnt7 - 1) = "(" & strMakeAbbrev & ") " & strModel
                        aData7(lCnt7 - 1) = CLng(FormatNumber(dAvgDOM, 0, True))
                    End If

                    ' Avg AFTT vs Variance
                    If dAvgAFTT > 0 And dAvgAsking > 0 Then
                        lCnt8 = lCnt8 + 1
                        aLabels8(lCnt8 - 1) = FormatNumber(dAvgAFTT, 0, True)
                        aData8(lCnt8 - 1) = CDbl(FormatNumber(dVariance, 1, True))
                    End If

                    ' Avg DOM vs Variance
                    If dAvgDOM > 0 And dAvgAsking > 0 Then
                        lCnt9 = lCnt9 + 1
                        aLabels9(lCnt9 - 1) = FormatNumber(dAvgDOM, 0, True)
                        aData9(lCnt9 - 1) = CDbl(FormatNumber(dVariance, 1, True))
                    End If

                    ' Avg AFTT vs Selling Price
                    If dAvgAFTT > 0 And dAvgSelling > 0 Then
                        lCnt10 = lCnt10 + 1
                        aLabels10(lCnt10 - 1) = FormatNumber(dAvgAFTT, 0, True)
                        aData10(lCnt10 - 1) = CDbl(FormatNumber((dAvgSelling / 1000), 0, True))
                    End If

                    ' Avg DOM vs Selling Price
                    If dAvgDOM > 0 And dAvgSelling > 0 Then
                        lCnt11 = lCnt11 + 1
                        aLabels11(lCnt11 - 1) = FormatNumber(dAvgDOM, 0, True)
                        aData11(lCnt11 - 1) = CDbl(FormatNumber((dAvgSelling / 1000), 0, True))
                    End If



                Loop

                '  Graph Types
                '  1=2D-Pie,        2=3D Pie
                '  3=2D Bar,        4=3D Bar
                '  6=Line,          7=Line 
                '  8=Area,          9=Speckle
                ' 10=Circle Line,  13=3D Ribbon 
                ' 14=3D-Area,      15=Line 
                ' 16=Line,         17=+/- Bar

                ReturnQuarterlyWithoutModel += Build_PDF_Header_Final("Sales Price Index Report", sub_info, real_make_model_name, "", sub_type, "", "", "", True)
                ReturnQuarterlyWithoutModel += Build_PDF_Column_Start("graphs_3", "Sales Price Index Report", "", "Sold Aircraft Information", 7)



                If lCnt1 > 1 Then

                    Session("SPImageWidth") = Session("lgImageWidth")
                    Session("SPImageHeight") = Session("lgImageHeight")

                    lGraphType = Session("SPSingleGraphType")
                    strTitle1 = "Percentage of Asking Price (%)"
                    strBottomTitle1 = "Make/Model(s)"    ' Y      

                    ReDim Preserve aData1(lCnt1)
                    ReDim Preserve aLabels1(lCnt1)

                    SortLabelsValue(aLabels1, aData1, lCnt1 - 1, 2)

                    ReDim Preserve aData1(lCnt1)
                    ReDim Preserve aLabels1(lCnt1)


                    tmpGraph = CreateAndGraphData(strTitle1, strBottomTitle1, strLeftTitle1, lGraphType, aLabels1, aData1, 0, "", "##.0", 0, 0, color)

                    If tmpGraph.ToString.Length > 2 Then
                        ' If Trim(tmpGraph) <> "" Then
                        Me.SPI_QUARTER.Titles.Clear()
                        Me.SPI_QUARTER.Titles.Add(strTitle1)
                        Me.SPI_QUARTER.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                        Me.SPI_QUARTER.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" + amod_id.ToString + "SPI_QUARTER_1.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
                        ReturnQuarterlyWithoutModel += ("<tr><td align='center'><img src='" + amod_id.ToString + "SPI_QUARTER_1.jpg'></td></tr>")
                        Me.SPI_QUARTER.Series.Clear()
                        'End If

                    Else
                        ReturnQuarterlyWithoutModel += "<tr><td align='center'>Percentage of Asking Price (%)<br />Not Enough Data Available</td></tr>"
                    End If
                Else
                    ReturnQuarterlyWithoutModel += "<tr><td align='center'>Percentage of Asking Price (%)<br />Not Enough Data Available</td></tr>"


                End If ' If lCnt1 > 1 Then

                If lCnt2 > 1 Then

                    Session("SPImageWidth") = Session("lgImageWidth")
                    Session("SPImageHeight") = Session("lgImageHeight")

                    lGraphType = Session("SPSingleGraphType")
                    strTitle2 = "Variance of Asking Price (%)"
                    strBottomTitle2 = "Make/Model(s)"    ' Y

                    ReDim Preserve aData2(lCnt2)
                    ReDim Preserve aLabels2(lCnt2)

                    SortLabelsValue(aLabels2, aData2, lCnt2 - 1, 2)

                    ReDim Preserve aData2(lCnt2)
                    ReDim Preserve aLabels2(lCnt2)

                    tmpGraph = CreateAndGraphData(strTitle2, strBottomTitle2, strLeftTitle2, lGraphType, aLabels2, aData2, 0, "", "##.0", 0, 0, color)


                    If tmpGraph.ToString.Length > 2 Then
                        Me.SPI_QUARTER.Titles.Clear()
                        Me.SPI_QUARTER.Titles.Add(strTitle2)
                        Me.SPI_QUARTER.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                        Me.SPI_QUARTER.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" + amod_id.ToString + "SPI_QUARTER_2.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
                        ReturnQuarterlyWithoutModel += ("<tr><td align='center'><img src='" + amod_id.ToString + "SPI_QUARTER_2.jpg'></td></tr>")
                        Me.SPI_QUARTER.Series.Clear()
                    Else
                        ReturnQuarterlyWithoutModel += "<tr><td align='center'>Variance of Asking Price (%)<br />Not Enough Data Available</td></tr>"
                    End If
                Else
                    ReturnQuarterlyWithoutModel += "<tr><td align='center'>Variance of Asking Price (%)<br />Not Enough Data Available</td></tr>"
                End If ' If lCnt2 > 1 Then


                ReturnQuarterlyWithoutModel += Build_PDF_Column_2("", 2, "graph_2_2")


                If lCnt5a > 1 And lCnt5b > 1 Then

                    Session("SPImageWidth") = Session("lgImageWidth")
                    Session("SPImageHeight") = Session("lgImageHeight")

                    lGraphType = 7
                    strTitle5 = "Asking vs Selling Price (k)"
                    strBottomTitle5 = "Make/Model(s)"    ' Y
                    strRightTitle5 = ""

                    ReDim Preserve aData5a(lCnt5a)
                    ReDim Preserve aData5b(lCnt5b)
                    ReDim Preserve aLabels5a(lCnt5a)
                    ReDim Preserve aLabels5b(lCnt5b)

                    temp_data = aData5b.Clone
                    'SortTwoDataValues(aLabels5a, aLabels5b, aData5a, aData5b, True, 2)

                    Dim min_max As String = ""
                    Dim min As Integer = 0
                    Dim max As Integer = 0

                    SortLabelsValue(aData5b, aData5a, lCnt5a - 1, 1)

                    SortLabelsValue(aLabels5b, temp_data, lCnt5b - 1, 2)

                    ReDim Preserve aData5a(lCnt5a)
                    ReDim Preserve aData5b(lCnt5b)
                    ReDim Preserve aLabels5a(lCnt5a)
                    ReDim Preserve aLabels5b(lCnt5b)


                    min_max = CreateAndGraphData(strTitle5, strBottomTitle5, strLeftTitle5, lGraphType, aLabels5b, aData5b, 0, "", "", min, max, color)

                    min = Left(min_max, (InStr(min_max, ",") - 1))
                    max = Right(min_max, (min_max.ToString.Length - InStr(min_max, ",")))

                    tmpGraph = CreateAndGraphData(strTitle5 & "&nbsp;", strBottomTitle5, strLeftTitle5, lGraphType, aLabels5a, aData5a, 0, "", "", min, max, color)

                    If tmpGraph.ToString.Length > 2 Then
                        Me.SPI_QUARTER.Titles.Clear()
                        Me.SPI_QUARTER.Titles.Add(strTitle5)
                        Me.SPI_QUARTER.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                        Me.SPI_QUARTER.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" + amod_id.ToString + "SPI_QUARTER_5.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
                        ReturnQuarterlyWithoutModel += ("<tr><td align='center'><img src='" + amod_id.ToString + "SPI_QUARTER_5.jpg'></td></tr>")
                        ReturnQuarterlyWithoutModel += tmpGraph
                        Me.SPI_QUARTER.Series.Clear()
                    Else
                        ReturnQuarterlyWithoutModel += "<tr><td align='center'>Asking vs selling Price (k)<br />Not Enough Data Available</td></tr>"
                    End If
                Else
                    ReturnQuarterlyWithoutModel += "<tr><td align='center'>Asking vs Selling Price (k)<br />Not Enough Data Available</td></tr>"

                End If ' If lCnt5a > 1 And lCnt5b > 1 Then      





                ' ------------------------------ GRAPHING PAGE BREAK ------------------------------
                ReturnQuarterlyWithoutModel += Build_PDF_Template_Footer()
                ReturnQuarterlyWithoutModel += Insert_Page_Break_PDF()
                ReturnQuarterlyWithoutModel += Build_PDF_Header_Final("Sales Price Index Report", sub_info, real_make_model_name, "", sub_type, "", "", "", True)
                ReturnQuarterlyWithoutModel += Build_PDF_Column_Start("graphs_3", "Sales Price Index Report", "", "Sold Aircraft Information", 7)
                ' ------------------------------ GRAPHING PAGE BREAK ------------------------------







                If lCnt3 > 1 Then

                    Session("SPImageWidth") = Session("smImageWidth")
                    Session("SPImageHeight") = Session("smImageHeight")

                    lGraphType = Session("SPSingleGraphType")
                    strTitle3 = "Asking Price (k)"
                    strBottomTitle3 = "Make/Model(s)"    ' Y

                    ReDim Preserve aData3(lCnt3)
                    ReDim Preserve aLabels3(lCnt3)


                    'SortDataValue(aLabels3, aData3)
                    SortLabelsValue(aLabels3, aData3, lCnt3 - 1, 2)

                    ReDim Preserve aData3(lCnt3)
                    ReDim Preserve aLabels3(lCnt3)


                    tmpGraph = CreateAndGraphData(strTitle3, strBottomTitle3, strLeftTitle3, lGraphType, aLabels3, aData3, 0, "", "#,###", 0, 0, color)

                    If tmpGraph.ToString.Length > 2 Then
                        Me.SPI_QUARTER.Titles.Clear()
                        Me.SPI_QUARTER.Titles.Add(strTitle3)
                        Me.SPI_QUARTER.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                        Me.SPI_QUARTER.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" + amod_id.ToString + "SPI_QUARTER_3.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
                        ReturnQuarterlyWithoutModel += ("<tr><td align='center'><img src='" + amod_id.ToString + "SPI_QUARTER_3.jpg'></td></tr>")
                        Me.SPI_QUARTER.Series.Clear()
                    Else
                        ReturnQuarterlyWithoutModel += "<tr><td align='center'>Asking Price (k)<br />Not Enough Data Available</td></tr>"
                    End If
                Else
                    ReturnQuarterlyWithoutModel += "<tr><td align='center'>Asking Price (k)<br />Not Enough Data Available</td></tr>"
                End If ' If lCnt3 > 1 Then

                If lCnt4 > 1 Then

                    Session("SPImageWidth") = Session("smImageWidth")
                    Session("SPImageHeight") = Session("smImageHeight")

                    lGraphType = Session("SPSingleGraphType")
                    strTitle4 = "Selling Price (k)"
                    strBottomTitle4 = "Make/Model(s)"    ' Y

                    ReDim Preserve aData4(lCnt4)
                    ReDim Preserve aLabels4(lCnt4)

                    SortLabelsValue(aLabels4, aData4, lCnt4 - 1, 2)

                    ReDim Preserve aData4(lCnt4)
                    ReDim Preserve aLabels4(lCnt4)


                    tmpGraph = CreateAndGraphData(strTitle4, strBottomTitle4, strLeftTitle4, lGraphType, aLabels4, aData4, 0, "", "#,###", 0, 0, color)

                    If tmpGraph.ToString.Length > 2 Then
                        Me.SPI_QUARTER.Titles.Clear()
                        Me.SPI_QUARTER.Titles.Add(strTitle4)
                        Me.SPI_QUARTER.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                        Me.SPI_QUARTER.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" + amod_id.ToString + "SPI_QUARTER_4.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
                        ReturnQuarterlyWithoutModel += ("<tr><td align='center'><img src='" + amod_id.ToString + "SPI_QUARTER_4.jpg'></td></tr>")
                        Me.SPI_QUARTER.Series.Clear()

                    Else
                        ReturnQuarterlyWithoutModel += "<tr><td align='center'>Selling Price (k)<br />Not Enough Data Available</td></tr>"
                    End If
                Else
                    ReturnQuarterlyWithoutModel += "<tr><td align='center'>Selling Price (k)<br />Not Enough Data Available</td></tr>"
                End If ' If lCnt4 > 1 Then

                ReturnQuarterlyWithoutModel += Build_PDF_Column_2("", 2, "graph_2_2")


                If lCnt6 > 1 Then

                    Session("SPImageWidth") = Session("smImageWidth")
                    Session("SPImageHeight") = Session("smImageHeight")

                    lGraphType = Session("SPSingleGraphType")
                    strTitle6 = "Average Airframe Total Time"
                    strBottomTitle6 = "Make/Model(s)"    ' Y

                    ReDim Preserve aData6(lCnt6)
                    ReDim Preserve aLabels6(lCnt6)

                    SortLabelsValue(aLabels6, aData6, lCnt6 - 1, 2)

                    ReDim Preserve aData6(lCnt6)
                    ReDim Preserve aLabels6(lCnt6)

                    tmpGraph = CreateAndGraphData(strTitle6, strBottomTitle6, strLeftTitle6, lGraphType, aLabels6, aData6, 0, "", "#,###", 0, 0, color)

                    If tmpGraph.ToString.Length > 2 Then
                        Me.SPI_QUARTER.Titles.Clear()
                        Me.SPI_QUARTER.Titles.Add(strTitle6)
                        Me.SPI_QUARTER.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                        Me.SPI_QUARTER.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" + amod_id.ToString + "SPI_QUARTER_6.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
                        ReturnQuarterlyWithoutModel += ("<tr><td align='center'><img src='" + amod_id.ToString + "SPI_QUARTER_6.jpg'></td></tr>")
                        Me.SPI_QUARTER.Series.Clear()
                    Else
                        ReturnQuarterlyWithoutModel += "<tr><td align='center'>Average Airframe Total Time<br />Not Enough Data Available</td></tr>"
                    End If
                Else
                    ReturnQuarterlyWithoutModel += "<tr><td align='center'>Average Airframe Total Time<br />Not Enough Data Available</td></tr>"

                End If ' If lCnt6 > 1 Then

                If lCnt7 > 1 Then

                    Session("SPImageWidth") = Session("smImageWidth")
                    Session("SPImageHeight") = Session("smImageHeight")

                    lGraphType = Session("SPSingleGraphType")
                    strTitle7 = "Average Days On Market for Sales"
                    strBottomTitle7 = "Make/Model(s)"    ' Y

                    ReDim Preserve aData7(lCnt7)
                    ReDim Preserve aLabels7(lCnt7)

                    SortLabelsValue(aLabels7, aData7, lCnt7 - 1, 2)

                    ReDim Preserve aData7(lCnt7)
                    ReDim Preserve aLabels7(lCnt7)

                    tmpGraph = CreateAndGraphData(strTitle7, strBottomTitle7, strLeftTitle7, lGraphType, aLabels7, aData7, 0, "", "#,###", 0, 0, color)

                    If tmpGraph.ToString.Length > 2 Then
                        Me.SPI_QUARTER.Titles.Clear()
                        Me.SPI_QUARTER.Titles.Add(strTitle7)
                        Me.SPI_QUARTER.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                        Me.SPI_QUARTER.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" + amod_id.ToString + "SPI_QUARTER_7.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
                        ReturnQuarterlyWithoutModel += ("<tr><td align='center'><img src='" + amod_id.ToString + "SPI_QUARTER_7.jpg'></td></tr>")
                        Me.SPI_QUARTER.Series.Clear()
                    Else
                        ReturnQuarterlyWithoutModel += "<tr><td align='center'>Average Days On Market for Sales<br />Not Enough Data Available</td></tr>"
                    End If
                Else
                    ReturnQuarterlyWithoutModel += "<tr><td align='center'>Average Days On Market for Sales<br />Not Enough Data Available</td></tr>"

                End If ' If lCnt7 > 1 Then



                ' ------------------------------ GRAPHING PAGE BREAK ------------------------------
                ReturnQuarterlyWithoutModel += Build_PDF_Template_Footer()
                ReturnQuarterlyWithoutModel += Insert_Page_Break_PDF()
                ReturnQuarterlyWithoutModel += Build_PDF_Header_Final("Sales Price Index Report", sub_info, real_make_model_name, "", sub_type, "", "", "", True)
                ReturnQuarterlyWithoutModel += Build_PDF_Column_Start("graphs_3", "Sales Price Index Report", "", "Sold Aircraft Information", 7)
                ' ------------------------------ GRAPHING PAGE BREAK ------------------------------





                If lCnt8 > 1 Then

                    Session("SPImageWidth") = Session("smImageWidth")
                    Session("SPImageHeight") = Session("smImageHeight")

                    lGraphType = Session("SPSingleGraphType")
                    strTitle8 = "Avg AFTT vs Variance (%)"
                    strBottomTitle8 = "Average Airframe Total Time"     ' Y
                    strLeftTitle8 = "Variance (%)"                   ' X    

                    ReDim Preserve aData8(lCnt8)
                    ReDim Preserve aLabels8(lCnt8)

                    SortLabelsValue(aLabels8, aData8, lCnt8 - 1, 1)

                    ReDim Preserve aData8(lCnt8)
                    ReDim Preserve aLabels8(lCnt8)

                    tmpGraph = CreateAndGraphData(strTitle8, strBottomTitle8, strLeftTitle8, lGraphType, aLabels8, aData8, 0, "#,###", "##.0", 0, 0, color)

                    If tmpGraph.ToString.Length > 2 Then
                        Me.SPI_QUARTER.Titles.Clear()
                        Me.SPI_QUARTER.Titles.Add(strTitle8)
                        Me.SPI_QUARTER.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                        Me.SPI_QUARTER.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" + amod_id.ToString + "SPI_QUARTER_8.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
                        ReturnQuarterlyWithoutModel += ("<tr><td align='center'><img src='" + amod_id.ToString + "SPI_QUARTER_8.jpg'></td></tr>")
                        Me.SPI_QUARTER.Series.Clear()
                    Else
                        ReturnQuarterlyWithoutModel += "<tr><td align='center'>Avg AFTT vs Variance (%)<br />Not Enough Data Available</td></tr>"
                    End If
                Else
                    ReturnQuarterlyWithoutModel += "<tr><td align='center'>Avg AFTT vs Variance (%)<br />Not Enough Data Available</td></tr>"

                End If ' If lCnt8 > 1 Then

                If lCnt9 > 1 Then

                    Session("SPImageWidth") = Session("smImageWidth")
                    Session("SPImageHeight") = Session("smImageHeight")

                    lGraphType = Session("SPSingleGraphType")
                    strTitle9 = "Avg DOM vs Variance (%)"
                    strBottomTitle9 = "Average Days on Market for Sales"     ' Y
                    strLeftTitle9 = "Variance (%)"                   ' X    

                    ReDim Preserve aData9(lCnt9)
                    ReDim Preserve aLabels9(lCnt9)

                    SortLabelsValue(aLabels9, aData9, lCnt9 - 1, 1)

                    ReDim Preserve aData9(lCnt9)
                    ReDim Preserve aLabels9(lCnt9)

                    tmpGraph = CreateAndGraphData(strTitle9, strBottomTitle9, strLeftTitle9, lGraphType, aLabels9, aData9, 0, "#,###", "##.0", 0, 0, color)

                    If tmpGraph.ToString.Length > 2 Then
                        Me.SPI_QUARTER.Titles.Clear()
                        Me.SPI_QUARTER.Titles.Add(strTitle9)
                        Me.SPI_QUARTER.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                        Me.SPI_QUARTER.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" + amod_id.ToString + "SPI_QUARTER_9.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
                        ReturnQuarterlyWithoutModel += ("<tr><td align='center'><img src='" + amod_id.ToString + "SPI_QUARTER_9.jpg'></td></tr>")
                        Me.SPI_QUARTER.Series.Clear()
                    Else
                        ReturnQuarterlyWithoutModel += "<tr><td align='center'>Avg DOM vs Variance (%)<br />Not Enough Data Available</td></tr>"
                    End If
                Else
                    ReturnQuarterlyWithoutModel += "<tr><td align='center'>Avg DOM vs Variance (%)<br />Not Enough Data Available</td></tr>"
                End If ' If lCnt9 > 1 Then

                ReturnQuarterlyWithoutModel += Build_PDF_Column_2("", 2, "graph_2_2")


                If lCnt10 > 1 Then

                    Session("SPImageWidth") = Session("smImageWidth")
                    Session("SPImageHeight") = Session("smImageHeight")

                    lGraphType = Session("SPSingleGraphType")
                    strTitle10 = "Avg AFTT vs Selling Price (k)"
                    strBottomTitle10 = "Average Airframe Total Time"     ' Y

                    ReDim Preserve aData10(lCnt10)
                    ReDim Preserve aLabels10(lCnt10)

                    SortLabelsValue(aLabels10, aData10, lCnt10 - 1, 1)

                    ReDim Preserve aData10(lCnt10)
                    ReDim Preserve aLabels10(lCnt10)


                    tmpGraph = CreateAndGraphData(strTitle10, strBottomTitle10, strLeftTitle10, lGraphType, aLabels10, aData10, 0, "#,###", "#,###", 0, 0, color)

                    If tmpGraph.ToString.Length > 2 Then
                        Me.SPI_QUARTER.Titles.Clear()
                        Me.SPI_QUARTER.Titles.Add(strTitle10)
                        Me.SPI_QUARTER.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                        Me.SPI_QUARTER.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" + amod_id.ToString + "SPI_QUARTER_10.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
                        ReturnQuarterlyWithoutModel += ("<tr><td align='center'><img src='" + amod_id.ToString + "SPI_QUARTER_10.jpg'></td></tr>")
                        Me.SPI_QUARTER.Series.Clear()
                    Else
                        ReturnQuarterlyWithoutModel += "<tr><td align='center'>AFTT vs Selling Price (k)<br />Not Enough Data Available</td></tr>"
                    End If
                Else
                    ReturnQuarterlyWithoutModel += "<tr><td align='center'>AFTT vs Selling Price (k)<br />Not Enough Data Available</td></tr>"
                End If ' If lCnt10 > 1 Then

                If lCnt11 > 1 Then

                    Session("SPImageWidth") = Session("smImageWidth")
                    Session("SPImageHeight") = Session("smImageHeight")

                    lGraphType = Session("SPSingleGraphType")
                    strTitle11 = "Avg DOM vs Selling Price (k)"
                    strBottomTitle11 = "Average Days on Market for Sales"     ' Y

                    ReDim Preserve aData11(lCnt11)
                    ReDim Preserve aLabels11(lCnt11)

                    SortLabelsValue(aLabels11, aData11, lCnt11 - 1, 1)

                    ReDim Preserve aData11(lCnt11)
                    ReDim Preserve aLabels11(lCnt11)

                    tmpGraph = CreateAndGraphData(strTitle11, strBottomTitle11, strLeftTitle11, lGraphType, aLabels11, aData11, 0, "#,###", "#,###", 0, 0, color)

                    If tmpGraph.ToString.Length > 2 Then
                        Me.SPI_QUARTER.Titles.Clear()
                        Me.SPI_QUARTER.Titles.Add(strTitle11)
                        Me.SPI_QUARTER.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                        Me.SPI_QUARTER.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" + amod_id.ToString + "SPI_QUARTER_11.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
                        ReturnQuarterlyWithoutModel += ("<tr><td align='center'><img src='" + amod_id.ToString + "SPI_QUARTER_11.jpg'></td></tr>")
                        Me.SPI_QUARTER.Series.Clear()
                    Else
                        ReturnQuarterlyWithoutModel += "<tr><td align='center'>Avg DOM vs Selling Price (k)<br />Not Enough Data Available</td></tr>"
                    End If
                Else
                    ReturnQuarterlyWithoutModel += "<tr><td align='center'>Avg DOM vs Selling Price (k)<br />Not Enough Data Available</td></tr>"

                End If ' If lCnt11 > 1 Then

                rstRec1.Close()

            Else

                strHTMLData1 = "<tr><td align='center' colspan='9'>No Records Found</td></tr>"

            End If

            strHTMLData1 = strHTMLData1 & "</table>"
            strHTMLData1 += Build_PDF_Template_Footer()
            strHTMLData1 += Insert_Page_Break_PDF()

            ReturnQuarterlyWithoutModel = strHTMLData1 & ReturnQuarterlyWithoutModel
        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function ' ReturnQuarterlyWithoutModel
    Private Function ReturnQuarterlyByModel(ByVal lModelId, ByRef strHTMLData1, ByRef strGraphVarianceAsking,
                ByVal sub_info, ByVal real_make_model_name, ByVal sub_type, ByVal weight_class, ByVal weight_class_name, ByVal spi_year, ByVal spi_year2, ByVal airframe_type, ByVal color) As String


        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim rstRec1 As System.Data.SqlClient.SqlDataReader : rstRec1 = Nothing

        ReturnQuarterlyByModel = ""
        Dim query As String = ""
        Dim strQuery1 As String = ""

        Dim strYearSld As String = ""
        Dim strQuarterSld As String = ""
        Dim strYearQtrName As String = ""
        Dim strAvgYearMfr As String = ""
        Dim strAvgYearDlv As String = ""
        Dim strAvgAsking As String = ""
        Dim strAvgAskingHidden As String = ""
        Dim strAvgSelling As String = ""
        Dim strPercent As String = ""
        Dim strPercentHidden As String = ""
        Dim strVariance As String = ""
        Dim strVarianceHidden As String = ""
        Dim strAvgAFTT As String = ""
        Dim strAvgDOM As String = ""

        Dim lYearSld As String = ""
        Dim lQuarterSld As String = ""
        Dim dAvgYearMfr As Double = 0
        Dim dAvgYearDlv As Double = 0
        Dim dAvgAsking As Double = 0
        Dim dAvgAskingHidden As Double = 0
        Dim dAvgSelling As Double = 0
        Dim dPercent As Double = 0
        Dim dPercentHidden As Double = 0
        Dim dVariance As Double = 0
        Dim dVarianceHidden As Double = 0
        Dim dAvgAFTT As Double = 0
        Dim dAvgDOM As Double = 0

        Dim strHRef1 As String = ""

        Dim lColSpan As String = ""
        Dim lTotRec As Double = 0

        Dim objGraph As String = ""
        Dim lGraphType As String = ""
        Dim strGraphImage As String = ""
        Dim lMaxSets As Double = 0
        Dim lThisSet As Double = 0


        Dim strHTMLData1_2 As String = ""
        Dim strHTMLData1_2_final As String = ""


        ' Percentage Of Asking Price     
        Dim strTitle1 As String = ""
        Dim strBottomTitle1 As String = ""
        Dim strLeftTitle1 As String = ""
        Dim lCnt1 As Integer = 0
        Dim aData1()
        Dim aLabels1()

        ' Variance Of Asking Price     
        Dim strTitle2 As String = ""
        Dim strBottomTitle2 As String = ""
        Dim strLeftTitle2 As String = ""
        Dim lCnt2 As Integer = 0
        Dim aData2()
        Dim aLabels2()

        ' Asking Price     
        Dim strTitle3 As String = ""
        Dim strBottomTitle3 As String = ""
        Dim strLeftTitle3 As String = ""
        Dim lCnt3 As Integer = 0
        Dim aData3()
        Dim aLabels3()

        ' Selling Price     
        Dim strTitle4 As String = ""
        Dim strBottomTitle4 As String = ""
        Dim strLeftTitle4 As String = ""
        Dim lCnt4 As Integer = 0
        Dim aData4()
        Dim aLabels4()

        ' Asking vs Selling Price     
        Dim strTitle5 As String = ""
        Dim strBottomTitle5 As String = ""
        Dim strLeftTitle5 As String = ""
        Dim strRightTitle5 As String = ""
        Dim lCnt5a As Integer = 0
        Dim lCnt5b As Integer = 0
        Dim aData5a()  ' Asking
        Dim aData5b()  ' Selling
        Dim aLabels5a()
        Dim aLabels5b()

        ' AFTT (Airframe Total Time)
        Dim strTitle6 As String = ""
        Dim strBottomTitle6 As String = ""
        Dim strLeftTitle6 As String = ""
        Dim lCnt6 As Integer = 0
        Dim aData6()
        Dim aLabels6()

        ' DOM (Days On Market)
        Dim strTitle7 As String = ""
        Dim strBottomTitle7 As String = ""
        Dim strLeftTitle7 As String = ""
        Dim lCnt7 As Integer = 0
        Dim aData7()
        Dim aLabels7()

        ' AFTT vs Variance
        Dim strTitle8 As String = ""
        Dim strBottomTitle8 As String = ""
        Dim strLeftTitle8 As String = ""
        Dim lCnt8 As Integer = 0
        Dim aData8()
        Dim aLabels8()

        ' DOM vs Variance
        Dim strTitle9 As String = ""
        Dim strBottomTitle9 As String = ""
        Dim strLeftTitle9 As String = ""
        Dim lCnt9 As Integer = 0
        Dim aData9()
        Dim aLabels9()

        ' AFTT vs Selling Price
        Dim strTitle10 As String = ""
        Dim strBottomTitle10 As String = ""
        Dim strLeftTitle10 As String = ""
        Dim lCnt10 As Integer = 0
        Dim aData10()
        Dim aLabels10()

        ' DOM vs Selling Price
        Dim strTitle11 As String = ""
        Dim strBottomTitle11 As String = ""
        Dim strLeftTitle11 As String = ""
        Dim lCnt11 As Integer = 0
        Dim aData11()
        Dim aLabels11()

        Dim tmpGraph As String = ""
        Dim cHyphen As String = "-"

        Dim min As Integer = 0
        Dim max As Integer = 0
        Dim min_max As String = ""


        Try



            strQuery1 = "SELECT DATEPART(year, journ_date) As YearSld, DATEPART(quarter, journ_date) As QuarterSld,"
            strQuery1 = strQuery1 & " AVG(CAST(ac_mfr_year AS INT)) As dAvgYearMfr,"
            strQuery1 = strQuery1 & " AVG(CAST(ac_year AS INT)) As dAvgYearDlv,"
            strQuery1 = strQuery1 & " AVG(ac_asking_price) As dAvgAsking,"
            strQuery1 = strQuery1 & " AVG(ac_hidden_asking_price) As dAvgAskingHidden,"
            strQuery1 = strQuery1 & " AVG(ac_sale_price) As dAvgSelling,"
            strQuery1 = strQuery1 & " ((AVG(ac_sale_price)/AVG(ac_asking_price)) * 100) As dPercent,"
            strQuery1 = strQuery1 & " ((1-(AVG(ac_sale_price)/AVG(ac_asking_price))) * 100) As dVariance,"
            strQuery1 = strQuery1 & " ((AVG(ac_sale_price)/AVG(ac_hidden_asking_price)) * 100) As dPercentHidden,"
            strQuery1 = strQuery1 & " ((1-(AVG(ac_sale_price)/AVG(ac_hidden_asking_price))) * 100) As dVarianceHidden,"
            strQuery1 = strQuery1 & " AVG(ac_airframe_tot_hrs) As dAvgAFTT,"
            strQuery1 = strQuery1 & " AVG(DateDiff(day,ac_list_date, journ_date)) As dAvgDOM"

            strQuery1 = strQuery1 & " FROM Aircraft_Summary_SPI WITH (NOLOCK)"
            '  strQuery1 = strQuery1 & " FROM Aircraft WITH (NOLOCK, INDEX(ix_ac_sale_price_ac_id_journ_id_key))"
            '  strQuery1 = strQuery1 & " INNER JOIN Aircraft_Model WITH (NOLOCK) ON ac_amod_id = amod_id"
            '  strQuery1 = strQuery1 & " INNER JOIN Journal WITH (NOLOCK) ON ac_id = journ_ac_id AND ac_journ_id = journ_id"
            '  strQuery1 = strQuery1 & " INNER JOIN Journal_Category WITH (NOLOCK) ON journ_subcategory_code = jcat_subcategory_code "


            strQuery1 = strQuery1 & " WHERE (ac_journ_id > 0)"
            strQuery1 = strQuery1 & " AND (ac_lifecycle_stage = 3)"                   '-- In Operation Only
            strQuery1 = strQuery1 & " AND (jcat_used_retail_sales_flag = 'Y')"        '-- Retail Only    
            strQuery1 = strQuery1 & " AND (journ_newac_flag = 'N')"                   '-- Used Sales Only
            strQuery1 = strQuery1 & " AND (journ_subcategory_code LIKE 'WS%')"        '-- Whole Sales Only
            strQuery1 = strQuery1 & " AND (journ_subcategory_code NOT LIKE '%IT%')"   '-- No Internals
            strQuery1 = strQuery1 & " AND (journ_internal_trans_flag = 'N')"          '-- No Internals 

            If lModelId > 0 Then
                strQuery1 = strQuery1 & " AND (amod_id = " & lModelId & ")"
            End If

            strQuery1 = strQuery1 & " AND (ac_sale_price IS NOT NULL) AND (ac_sale_price <> 0)"


            '   strQuery1 = strQuery1 & " " + commonEVO.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, False)
            strQuery1 = strQuery1 & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, True)


            If Trim(Session("SPYearSld1")) > 0 Then
                strQuery1 = strQuery1 & " AND (DATEPART(year,journ_date) >= " & Session("SPYearSld1") & ")"
            End If

            If Trim(Session("SPYearSld2")) > 0 Then
                strQuery1 = strQuery1 & " AND (DATEPART(year,journ_date) <= " & Session("SPYearSld2") & ")"
            End If

            strQuery1 = strQuery1 & " GROUP BY DATEPART(year, journ_date), DATEPART(quarter, journ_date)"
            strQuery1 = strQuery1 & " ORDER BY DATEPART(year, journ_date) ASC, DATEPART(quarter, journ_date) ASC"

            If Session("debug") Then
                Response.Write("<b>ReturnQuarterlyByModel : " & Server.HtmlEncode(strQuery1) & "</b><br /><br />")
            End If

            '  Case Else
            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            '  End Select

            ' End Select
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = strQuery1
            rstRec1 = SqlCommand.ExecuteReader()



            strHTMLData1 = "<table id='quarterlyModelDataTable' cellpadding='2' cellspacing='0' width='100%' class='salesPrice'>"
            strHTMLData1 = strHTMLData1 & "<tr bgcolor='#CCCCCC'><td align='center' colspan='9'>" & Session("salesPriceViewMake") & "&nbsp;/&nbsp;" & Session("salesPriceViewModel") & "</td></tr>"

            strHTMLData1 = strHTMLData1 & "<tr bgcolor='#CCCCCC'><td align='center' rowspan='2'>Year<br />Quarter</td>"
            strHTMLData1 = strHTMLData1 & "<td align='center' colspan='2'>Avg Year Of</td>"
            strHTMLData1 = strHTMLData1 & "<td align='center' colspan='2'>Avg Price (k)</td>"
            strHTMLData1 = strHTMLData1 & "<td align='center' rowspan='2'>Percent</td>"
            strHTMLData1 = strHTMLData1 & "<td align='center' rowspan='2'>Variance</td>"
            strHTMLData1 = strHTMLData1 & "<td align='center' colspan='2'>Average</td></tr>"

            strHTMLData1 = strHTMLData1 & "<tr bgcolor='#CCCCCC'><td align='center'>Mfr</td>"
            strHTMLData1 = strHTMLData1 & "<td align='center'>Delivery</td>"
            strHTMLData1 = strHTMLData1 & "<td align='center'>Asking</td>"
            strHTMLData1 = strHTMLData1 & "<td align='center'>Selling</td>"
            strHTMLData1 = strHTMLData1 & "<td align='center'>AFTT</td>"
            strHTMLData1 = strHTMLData1 & "<td align='center'>Days<br />On<br />Market</td></tr>"

            If rstRec1.HasRows Then

                lTotRec = 1000

                lCnt1 = 0
                lCnt2 = 0
                lCnt3 = 0
                lCnt4 = 0
                lCnt5a = 0
                lCnt5b = 0
                lCnt6 = 0
                lCnt7 = 0
                lCnt8 = 0
                lCnt9 = 0
                lCnt10 = 0
                lCnt11 = 0

                ReDim aData1(lTotRec)      ' Percentage Of Asking Price
                ReDim aLabels1(lTotRec)

                ReDim aData2(lTotRec)      ' Variance Of Asking Price
                ReDim aLabels2(lTotRec)

                ReDim aData3(lTotRec)      ' Asking Price
                ReDim aLabels3(lTotRec)

                ReDim aData4(lTotRec)      ' Selling Price
                ReDim aLabels4(lTotRec)

                ReDim aData5a(lTotRec)     ' Asking Price
                ReDim aLabels5a(lTotRec)

                ReDim aData5b(lTotRec)      ' Selling Price
                ReDim aLabels5b(lTotRec)

                ReDim aData6(lTotRec)      ' Avg AFTT
                ReDim aLabels6(lTotRec)

                ReDim aData7(lTotRec)      ' Avg DOM
                ReDim aLabels7(lTotRec)

                ReDim aData8(lTotRec)      ' Avg AFTT vs Variance
                ReDim aLabels8(lTotRec)

                ReDim aData9(lTotRec)      ' Avg DOM vs Variance
                ReDim aLabels9(lTotRec)

                ReDim aData10(lTotRec)     ' Avg AFTT vs Selling Price
                ReDim aLabels10(lTotRec)

                ReDim aData11(lTotRec)     ' Avg DOM vs Selling Price
                ReDim aLabels11(lTotRec)


                strHTMLData1 = "<table id='quarterlyModelDataTable' cellpadding='2' cellspacing='0' width='100%' border='1' class='salesPrice'>"
                strHTMLData1 = strHTMLData1 & "<tr bgcolor='#CCCCCC'><td align='center' colspan='9'>" & Session("salesPriceViewMake") & "&nbsp;/&nbsp;" & Session("salesPriceViewModel") & "</td></tr>"

                strHTMLData1 = strHTMLData1 & "<tr bgcolor='#CCCCCC'><td align='center' rowspan='2'>Year<br />Quarter</td>"
                strHTMLData1 = strHTMLData1 & "<td align='center' colspan='2'>Avg Year Of</td>"
                strHTMLData1 = strHTMLData1 & "<td align='center' colspan='2'>Avg Price (k)</td>"
                strHTMLData1 = strHTMLData1 & "<td align='center' rowspan='2'>Percent</td>"
                strHTMLData1 = strHTMLData1 & "<td align='center' rowspan='2'>Variance</td>"
                strHTMLData1 = strHTMLData1 & "<td align='center' colspan='2'>Average</td></tr>"

                strHTMLData1 = strHTMLData1 & "<tr bgcolor='#CCCCCC'><td align='center'>Mfr</td>"
                strHTMLData1 = strHTMLData1 & "<td align='center'>Delivery</td>"
                strHTMLData1 = strHTMLData1 & "<td align='center'>Asking</td>"
                strHTMLData1 = strHTMLData1 & "<td align='center'>Selling</td>"
                strHTMLData1 = strHTMLData1 & "<td align='center'>AFTT</td>"
                strHTMLData1 = strHTMLData1 & "<td align='center'>Days<br />On<br />Market</td></tr>"

                Do While rstRec1.Read

                    strYearSld = ""
                    strQuarterSld = ""
                    strYearQtrName = ""

                    strAvgYearMfr = ""
                    strAvgYearDlv = ""
                    strAvgAsking = ""
                    strAvgAskingHidden = ""
                    strAvgSelling = ""
                    strPercent = ""
                    strPercentHidden = ""
                    strVariance = ""
                    strVarianceHidden = ""
                    strAvgAFTT = ""
                    strAvgDOM = ""

                    lYearSld = 0
                    lQuarterSld = 0
                    dAvgYearMfr = 0.0
                    dAvgYearDlv = 0.0
                    dAvgAsking = 0.0
                    dAvgAskingHidden = 0.0
                    dAvgSelling = 0.0
                    dPercent = 0.0
                    dPercentHidden = 0.0
                    dVariance = 0.0
                    dVarianceHidden = 0.0
                    dAvgAFTT = 0.0
                    dAvgDOM = 0.0

                    If Not String.IsNullOrEmpty(rstRec1("YearSld")) Then
                        lYearSld = rstRec1("YearSld")
                    Else
                        lYearSld = Year(Now())
                    End If

                    If Not String.IsNullOrEmpty(rstRec1("QuarterSld")) Then
                        lQuarterSld = rstRec1("QuarterSld")
                    Else
                        '     lQuarterSld = Right(Get_Quarter_For_Month_Server(Month(Now())), 1)
                    End If

                    strYearSld = CStr(lYearSld)
                    strQuarterSld = CStr(lQuarterSld)

                    strYearQtrName = strYearSld & cHyphen & "Q" & strQuarterSld

                    If Not IsDBNull(rstRec1("dAvgYearMfr")) Then
                        dAvgYearMfr = rstRec1("dAvgYearMfr")
                    Else
                        dAvgYearMfr = 0
                    End If

                    If Not IsDBNull(rstRec1("dAvgYearDlv")) Then
                        dAvgYearDlv = rstRec1("dAvgYearDlv")
                    Else
                        dAvgYearDlv = 0
                    End If

                    If Not IsDBNull(rstRec1("dAvgAsking")) Then
                        dAvgAsking = rstRec1("dAvgAsking")
                    Else
                        dAvgAsking = 0
                    End If

                    If Not IsDBNull(rstRec1("dAvgAskingHidden")) Then
                        dAvgAskingHidden = rstRec1("dAvgAskingHidden")
                    Else
                        dAvgAskingHidden = 0
                    End If


                    If dAvgAsking = 0 And dAvgAskingHidden > 0 Then
                        dAvgAsking = dAvgAskingHidden
                    End If

                    If Not IsDBNull(rstRec1("dAvgSelling")) Then
                        dAvgSelling = rstRec1("dAvgSelling")
                    Else
                        dAvgSelling = 0
                    End If

                    If Not IsDBNull(rstRec1("dPercent")) Then
                        dPercent = rstRec1("dPercent")
                    Else
                        dPercent = 0
                    End If

                    If Not IsDBNull(rstRec1("dPercentHidden")) Then
                        dPercentHidden = rstRec1("dPercentHidden")
                    Else
                        dPercentHidden = 0
                    End If

                    If dAvgAsking = 0 And dAvgAskingHidden > 0 Then
                        dPercent = dPercentHidden
                    End If

                    If Not IsDBNull(rstRec1("dVariance")) Then
                        dVariance = rstRec1("dVariance")
                    Else
                        dVariance = 0
                    End If

                    If Not IsDBNull(rstRec1("dVarianceHidden")) Then
                        dVarianceHidden = rstRec1("dVarianceHidden")
                    Else
                        dVarianceHidden = 0
                    End If

                    If dAvgAsking = 0 And dAvgAskingHidden > 0 Then
                        dVariance = dVarianceHidden
                    End If

                    If Not IsDBNull(rstRec1("dAvgAFTT")) Then
                        dAvgAFTT = rstRec1("dAvgAFTT")
                    Else
                        dAvgAFTT = 0
                    End If

                    If Not IsDBNull(rstRec1("dAvgDOM")) Then
                        dAvgDOM = rstRec1("dAvgDOM")
                    Else
                        dAvgDOM = 0
                    End If

                    '----------------------------- all changed to strHTMLData1_2 to mimick order of table - msw - 8/30/2011

                    strHTMLData1_2 = "<tr><td align='left' nowrap='nowrap'>" & strYearQtrName & "</td>"

                    strHTMLData1_2 = strHTMLData1_2 & "<td align='center'>"
                    If dAvgYearMfr > 0 Then
                        strHTMLData1_2 = strHTMLData1_2 & CStr(dAvgYearMfr) & "</td>"
                    Else
                        strHTMLData1_2 = strHTMLData1_2 & "&nbsp;</td>"
                    End If

                    strHTMLData1_2 = strHTMLData1_2 & "<td align='center'>"
                    If dAvgYearDlv > 0 Then
                        strHTMLData1_2 = strHTMLData1_2 & CStr(dAvgYearDlv) & "</td>"
                    Else
                        strHTMLData1_2 = strHTMLData1_2 & "&nbsp;</td>"
                    End If

                    strHTMLData1_2 = strHTMLData1_2 & "<td align='right'>"
                    If dAvgAsking > 0 Then
                        strHTMLData1_2 = strHTMLData1_2 & "$" & FormatNumber(dAvgAsking / 1000, 0, True) & "</td>"
                    Else
                        strHTMLData1_2 = strHTMLData1_2 & "&nbsp;</td>"
                    End If

                    strHTMLData1_2 = strHTMLData1_2 & "<td align='right'>"
                    If dAvgSelling > 0 Then
                        strHTMLData1_2 = strHTMLData1_2 & "$" & FormatNumber(dAvgSelling / 1000, 0, True) & "</td>"
                    Else
                        strHTMLData1_2 = strHTMLData1_2 & "&nbsp;</td>"
                    End If

                    strHTMLData1_2 = strHTMLData1_2 & "<td align='right'>"
                    If dPercent > 0 Then
                        strHTMLData1_2 = strHTMLData1_2 & FormatNumber(dPercent, 1, True) & "%</td>"
                    Else
                        strHTMLData1_2 = strHTMLData1_2 & "&nbsp;</td>"
                    End If

                    strHTMLData1_2 = strHTMLData1_2 & "<td align='right'>"
                    If dAvgAsking > 0 Then
                        strHTMLData1_2 = strHTMLData1_2 & FormatNumber(dVariance, 1, True) & "%</td>"
                    ElseIf dAvgAsking = dAvgSelling Then
                        strHTMLData1_2 = strHTMLData1_2 & "0.0%</td>"
                    Else
                        strHTMLData1_2 = strHTMLData1_2 & "&nbsp;</td>"
                    End If

                    strHTMLData1_2 = strHTMLData1_2 & "<td align='right'>"
                    If dAvgAFTT > 0 Then
                        strHTMLData1_2 = strHTMLData1_2 & FormatNumber(dAvgAFTT, 0, True) & "</td>"
                    Else
                        strHTMLData1_2 = strHTMLData1_2 & "&nbsp;</td>"
                    End If

                    strHTMLData1_2 = strHTMLData1_2 & "<td align='right'>"
                    If dAvgDOM > 0 Then
                        strHTMLData1_2 = strHTMLData1_2 & FormatNumber(dAvgDOM, 0, True) & "</td>"
                    Else
                        strHTMLData1_2 = strHTMLData1_2 & "&nbsp;</td>"
                    End If

                    strHTMLData1_2 = strHTMLData1_2 & "</tr>"

                    '--------------------------------------

                    strHTMLData1_2_final = strHTMLData1_2 & strHTMLData1_2_final


                    ' Percentage Of Asking Price  
                    If dAvgAsking > 0 Then
                        lCnt1 = lCnt1 + 1
                        aLabels1(lCnt1 - 1) = strYearQtrName
                        aData1(lCnt1 - 1) = CDbl(FormatNumber(dPercent, 1, True))
                    End If

                    ' Variance Of Asking Price  
                    If dAvgAsking > 0 Then
                        lCnt2 = lCnt2 + 1
                        aLabels2(lCnt2 - 1) = strYearQtrName
                        aData2(lCnt2 - 1) = CDbl(FormatNumber(dVariance, 1, True))
                    End If

                    ' Asking Price        
                    If dAvgAsking > 0 Then
                        lCnt3 = lCnt3 + 1
                        aLabels3(lCnt3 - 1) = strYearQtrName
                        aData3(lCnt3 - 1) = CDbl(FormatNumber(dAvgAsking / 1000, 1, True))
                    End If

                    ' Selling Price        
                    If dAvgSelling > 0 Then
                        lCnt4 = lCnt4 + 1
                        aLabels4(lCnt4 - 1) = strYearQtrName
                        aData4(lCnt4 - 1) = CDbl(FormatNumber(dAvgSelling / 1000, 1, True))
                    End If

                    ' Asking Price        
                    lCnt5a = lCnt5a + 1
                    aLabels5a(lCnt5a - 1) = strYearQtrName
                    aData5a(lCnt5a - 1) = CDbl(FormatNumber(dAvgAsking / 1000, 1, True))

                    ' Selling Price        
                    lCnt5b = lCnt5b + 1
                    aLabels5b(lCnt5b - 1) = strYearQtrName
                    aData5b(lCnt5b - 1) = CDbl(FormatNumber(dAvgSelling / 1000, 1, True))

                    ' Avg AFTT
                    If dAvgAFTT > 0 Then
                        lCnt6 = lCnt6 + 1
                        aLabels6(lCnt6 - 1) = strYearQtrName
                        aData6(lCnt6 - 1) = CLng(FormatNumber(dAvgAFTT, 0, True))
                    End If

                    ' Avg DOM
                    If dAvgDOM > 0 Then
                        lCnt7 = lCnt7 + 1
                        aLabels7(lCnt7 - 1) = strYearQtrName
                        aData7(lCnt7 - 1) = CLng(FormatNumber(dAvgDOM, 0, True))
                    End If

                    ' Avg AFTT vs Variance
                    If dAvgAFTT > 0 And dAvgAsking > 0 Then
                        lCnt8 = lCnt8 + 1
                        aLabels8(lCnt8 - 1) = FormatNumber(dAvgAFTT, 0, True)
                        aData8(lCnt8 - 1) = CDbl(FormatNumber(dVariance, 1, True))
                    End If

                    ' Avg DOM vs Variance
                    If dAvgDOM > 0 And dAvgAsking > 0 Then
                        lCnt9 = lCnt9 + 1
                        aLabels9(lCnt9 - 1) = FormatNumber(dAvgDOM, 0, True)
                        aData9(lCnt9 - 1) = CDbl(FormatNumber(dVariance, 1, True))
                    End If

                    ' Avg AFTT vs Selling Price
                    If dAvgAFTT > 0 And dAvgSelling > 0 Then
                        lCnt10 = lCnt10 + 1
                        aLabels10(lCnt10 - 1) = FormatNumber(dAvgAFTT, 0, True)
                        aData10(lCnt10 - 1) = CDbl(FormatNumber((dAvgSelling / 1000), 0, True))
                    End If

                    ' Avg DOM vs Selling Price
                    If dAvgDOM > 0 And dAvgSelling > 0 Then
                        lCnt11 = lCnt11 + 1
                        aLabels11(lCnt11 - 1) = FormatNumber(dAvgDOM, 0, True)
                        aData11(lCnt11 - 1) = CDbl(FormatNumber((dAvgSelling / 1000), 0, True))
                    End If



                Loop

                're_order_arrays(aLabels2, aData2)



                '  Graph Types
                '  1=2D-Pie,        2=3D Pie
                '  3=2D Bar,        4=3D Bar
                '  6=Line,          7=Line 
                '  8=Area,          9=Speckle
                ' 10=Circle Line,  13=3D Ribbon 
                ' 14=3D-Area,      15=Line 
                ' 16=Line,         17=+/- Bar





                ' ------------------------------ GRAPHING PAGE BREAK ------------------------------
                ReturnQuarterlyByModel += Build_PDF_Template_Footer()
                ReturnQuarterlyByModel += Insert_Page_Break_PDF()
                ReturnQuarterlyByModel += Build_PDF_Header_Final("Sales Price Index Report", sub_info, real_make_model_name, "", sub_type, "", "", "", True)
                ReturnQuarterlyByModel += Build_PDF_Column_Start("graphs_2", "Sales Price Index Report", "", "Sold Aircraft Information", 2)
                ' ------------------------------ GRAPHING PAGE BREAK ------------------------------






                If lCnt1 > 1 Then

                    Session("SPImageWidth") = Session("lgImageWidth")
                    Session("SPImageHeight") = Session("l gImageHeight")

                    lGraphType = Session("SPSingleGraphType")
                    strTitle1 = Session("salesPriceViewMake") & "/" & Session("salesPriceViewModel") & " - Percentage of Asking Price (%)"
                    strBottomTitle1 = "Year/Quarter Sold"    ' Y      
                    strLeftTitle1 = "Percentage (%)"

                    ReDim Preserve aData1(lCnt1)
                    ReDim Preserve aLabels1(lCnt1)

                    '       SortLabelsValue(aLabels1, aData1, True)

                    tmpGraph = CreateAndGraphData(strTitle1, strBottomTitle1, strLeftTitle1, lGraphType, aLabels1, aData1, 0, "", "##.0", 0, 0, color)
                    If tmpGraph.ToString.Length > 2 Then
                        ' If Trim(tmpGraph) <> "" Then
                        Me.SPI_QUARTER.Titles.Clear()
                        Me.SPI_QUARTER.Titles.Add(strTitle1)
                        Me.SPI_QUARTER.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                        Me.SPI_QUARTER.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" + amod_id.ToString + "SPI_QUARTER_1.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
                        ReturnQuarterlyByModel += ("<tr><td align='center'><img src='" + amod_id.ToString + "SPI_QUARTER_1.jpg'></td></tr>")
                        Me.SPI_QUARTER.Series.Clear()
                        'End If

                    Else
                        ReturnQuarterlyByModel += "<tr><td align='center'>Percentage of Asking Price (%)<br />Not Enough Data Available</td></tr>"
                    End If
                Else
                    ReturnQuarterlyByModel += "<tr><td align='center'>Percentage of Asking Price (%)<br />Not Enough Data Available</td></tr>"
                End If ' If lCnt1 > 1 Then

                If lCnt2 > 1 Then

                    Session("SPImageWidth") = Session("lgImageWidth")
                    Session("SPImageHeight") = Session("lgImageHeight")

                    lGraphType = Session("SPSingleGraphType")
                    strTitle2 = Session("salesPriceViewMake") & "/" & Session("salesPriceViewModel") & " - Variance of Asking Price (%)"
                    strBottomTitle2 = "Year/Quarter Sold"    ' Y
                    strLeftTitle2 = "Variance (%)"

                    ReDim Preserve aData2(lCnt2)
                    ReDim Preserve aLabels2(lCnt2)

                    '    SortLabelsValue(aLabels2, aData2, True)

                    tmpGraph = CreateAndGraphData(strTitle2, strBottomTitle2, strLeftTitle2, lGraphType, aLabels2, aData2, 0, "", "##.0", 0, 0, color)

                    If tmpGraph.ToString.Length > 2 Then
                        Me.SPI_QUARTER.Titles.Clear()
                        Me.SPI_QUARTER.Titles.Add(strTitle2)
                        Me.SPI_QUARTER.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                        Me.SPI_QUARTER.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" + amod_id.ToString + "SPI_QUARTER_2.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
                        ReturnQuarterlyByModel += ("<tr><td align='center'><img src='" + amod_id.ToString + "SPI_QUARTER_2.jpg'></td></tr>")
                        Me.SPI_QUARTER.Series.Clear()
                    Else
                        ReturnQuarterlyByModel += "<tr><td align='center'>Variance of Asking Price (%)<br />Not Enough Data Available</td></tr>"
                    End If
                Else
                    ReturnQuarterlyByModel += "<tr><td align='center'>Variance of Asking Price (%)<br />Not Enough Data Available</td></tr>"
                End If ' If lCnt2 > 1 Then


                ReturnQuarterlyByModel += Build_PDF_Column_2("", 2, "graph_2_2")


                If lCnt5a > 1 And lCnt5b > 1 Then

                    Session("SPImageWidth") = Session("lgImageWidth")
                    Session("SPImageHeight") = Session("lgImageHeight")

                    lGraphType = 7
                    strTitle5 = Session("salesPriceViewMake") & "/" & Session("salesPriceViewModel") & " - Asking vs Selling Price (k)"

                    strBottomTitle5 = "Year Sold-Quarter"    ' Y
                    strRightTitle5 = "Price ($)"
                    strLeftTitle5 = "Price ($)"

                    ReDim Preserve aData5a(lCnt5a)
                    ReDim Preserve aData5b(lCnt5b)
                    ReDim Preserve aLabels5a(lCnt5a)
                    ReDim Preserve aLabels5b(lCnt5b)

                    If Not Session("localMachine") Then

                        '  objGraph = Server.CreateObject("GSSERVER.GSServerProp")

                        ' If lMaxSets = 2 Then

                        ' SortLabelsWithTwoDataValues(aLabels5a, aLabels5b, aData5a, aData5b, True, 1)

                        '  SetMultiLineGraphTitleStyleLabels(objGraph, lMaxSets, lGraphType, strTitle5, strBottomTitle5, strLeftTitle5, strRightTitle5, aLabels5a, "", "#,###", 2)
                        '   End If


                        '    SetMultiLineGraphAddData(objGraph, lThisSet, aData5a, 5, 0, "Avg Asking Price")
                        min_max = CreateAndGraphData(strTitle5, strBottomTitle5, strLeftTitle5, lGraphType, aLabels5b, aData5b, 0, "", "", min, max, color)


                        min = Left(min_max, (InStr(min_max, ",") - 1))
                        max = Right(min_max, (min_max.ToString.Length - InStr(min_max, ",")))
                        '  SetMultiLineGraphAddData(objGraph, lThisSet, aData5b, 1, 0, "Avg Selling Price")
                        tmpGraph = CreateAndGraphData(strTitle5 & "&nbsp;", strBottomTitle5, strLeftTitle5, lGraphType, aLabels5a, aData5a, 0, "", "", min, max, color)

                        '       strGraphAskingVsSelling = DrawMultiLineGraphs(objGraph)

                        If tmpGraph.ToString.Length > 2 Then
                            Me.SPI_QUARTER.Titles.Clear()
                            Me.SPI_QUARTER.Titles.Add(strTitle5)
                            Me.SPI_QUARTER.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                            Me.SPI_QUARTER.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" + amod_id.ToString + "SPI_QUARTER_5.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
                            ReturnQuarterlyByModel += ("<tr><td align='center'><img src='" + amod_id.ToString + "SPI_QUARTER_5.jpg'></td></tr>")
                            ReturnQuarterlyByModel += tmpGraph
                            Me.SPI_QUARTER.Series.Clear()
                        Else
                            ReturnQuarterlyByModel += "<tr><td align='center'>Asking vs selling Price (k)<br />Not Enough Data Availabl</td></tr>"
                        End If
                    Else
                        ReturnQuarterlyByModel += "<tr><td align='center'>Asking vs Selling Price (k)<br />Not Enough Data Availabl</td></tr>"

                        Me.SPI_QUARTER.Series.Clear()
                    End If ' If lCnt5a > 1 And lCnt5b > 1 Then      


                End If


                ' ------------------------------ GRAPHING PAGE BREAK ------------------------------
                ReturnQuarterlyByModel += Build_PDF_Template_Footer()
                ReturnQuarterlyByModel += Insert_Page_Break_PDF()
                ReturnQuarterlyByModel += Build_PDF_Header_Final("Sales Price Index Report", sub_info, real_make_model_name, "", sub_type, "", "", "", True)
                ReturnQuarterlyByModel += Build_PDF_Column_Start("graphs_3", "Sales Price Index Report", "", "Sold Aircraft Information", 7)
                ' ------------------------------ GRAPHING PAGE BREAK ------------------------------











                If lCnt3 > 1 Then

                    Session("SPImageWidth") = Session("smImageWidth")
                    Session("SPImageHeight") = Session("smImageHeight")

                    lGraphType = Session("SPSingleGraphType")
                    strTitle3 = Session("salesPriceViewMake") & "/" & Session("salesPriceViewModel") & " - Asking Price (k)"
                    strBottomTitle3 = "Year/Quarter Sold"    ' Y
                    strLeftTitle3 = "Price ($)"

                    ReDim Preserve aData3(lCnt3)
                    ReDim Preserve aLabels3(lCnt3)

                    '   SortLabelsValue(aLabels3, aData3, True)

                    tmpGraph = CreateAndGraphData(strTitle3, strBottomTitle3, strLeftTitle3, lGraphType, aLabels3, aData3, 0, "", "#,###", 0, 0, color)
                    If tmpGraph.ToString.Length > 2 Then
                        Me.SPI_QUARTER.Titles.Clear()
                        Me.SPI_QUARTER.Titles.Add(strTitle3)
                        Me.SPI_QUARTER.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                        Me.SPI_QUARTER.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" + amod_id.ToString + "SPI_QUARTER_3.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
                        ReturnQuarterlyByModel += ("<tr><td align='center'><img src='" + amod_id.ToString + "SPI_QUARTER_3.jpg'></td></tr>")
                        Me.SPI_QUARTER.Series.Clear()
                    Else
                        ReturnQuarterlyByModel += "<tr><td align='center'>Asking Price (k)<br />Not Enough Data Available</td></tr>"
                    End If
                Else
                    ReturnQuarterlyByModel += "<tr><td align='center'>Asking Price (k)<br />Not Enough Data Available</td></tr>"
                End If ' If lCnt3 > 1 Then



                If lCnt4 > 1 Then

                    Session("SPImageWidth") = Session("smImageWidth")
                    Session("SPImageHeight") = Session("smImageHeight")

                    lGraphType = Session("SPSingleGraphType")
                    strTitle4 = Session("salesPriceViewMake") & "/" & Session("salesPriceViewModel") & " - Selling Price (k)"
                    strBottomTitle4 = "Year/Quarter Sold"    ' Y
                    strLeftTitle4 = "Price ($)"
                    ReDim Preserve aData4(lCnt4)
                    ReDim Preserve aLabels4(lCnt4)

                    '  SortLabelsValue(aLabels4, aData4, True)

                    tmpGraph = CreateAndGraphData(strTitle4, strBottomTitle4, strLeftTitle4, lGraphType, aLabels4, aData4, 0, "", "#,###", 0, 0, color)

                    If tmpGraph.ToString.Length > 2 Then
                        Me.SPI_QUARTER.Titles.Clear()
                        Me.SPI_QUARTER.Titles.Add(strTitle4)
                        Me.SPI_QUARTER.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                        Me.SPI_QUARTER.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" + amod_id.ToString + "SPI_QUARTER_4.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
                        ReturnQuarterlyByModel += ("<tr><td align='center'><img src='" + amod_id.ToString + "SPI_QUARTER_4.jpg'></td></tr>")
                        Me.SPI_QUARTER.Series.Clear()

                    Else
                        ReturnQuarterlyByModel += "<tr><td align='center'>Selling Price (k)<br />Not Enough Data Available</td></tr>"
                    End If
                Else
                    ReturnQuarterlyByModel += "<tr><td align='center'>Selling Price (k)<br />Not Enough Data Available</td></tr>"
                End If ' If lCnt4 > 1 Then


                ReturnQuarterlyByModel += Build_PDF_Column_2("", 2, "graph_3_2")



                If lCnt6 > 1 Then

                    Session("SPImageWidth") = Session("smImageWidth")
                    Session("SPImageHeight") = Session("smImageHeight")

                    lGraphType = Session("SPSingleGraphType")
                    strTitle6 = Session("salesPriceViewMake") & "/" & Session("salesPriceViewModel") & " - Average Airframe Total Time"
                    strBottomTitle6 = "Year/Quarter Sold"    ' Y


                    ReDim Preserve aData6(lCnt6)
                    ReDim Preserve aLabels6(lCnt6)

                    '  SortLabelsValue(aLabels6, aData6, True)

                    tmpGraph = CreateAndGraphData(strTitle6, strBottomTitle6, strLeftTitle6, lGraphType, aLabels6, aData6, 0, "", "#,###", 0, 0, color)

                    If tmpGraph.ToString.Length > 2 Then
                        Me.SPI_QUARTER.Titles.Clear()
                        Me.SPI_QUARTER.Titles.Add(strTitle6)
                        Me.SPI_QUARTER.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                        Me.SPI_QUARTER.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" + amod_id.ToString + "SPI_QUARTER_6.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
                        ReturnQuarterlyByModel += ("<tr><td align='center'><img src='" + amod_id.ToString + "SPI_QUARTER_6.jpg'></td></tr>")
                        Me.SPI_QUARTER.Series.Clear()
                    Else
                        ReturnQuarterlyByModel += "<tr><td align='center'>Average Airframe Total Time<br />Not Enough Data Available</td></tr>"
                    End If
                Else
                    ReturnQuarterlyByModel += "<tr><td align='center'>Average Airframe Total Time<br />Not Enough Data Available</td></tr>"
                End If ' If lCnt6 > 1 Then


                If lCnt7 > 1 Then

                    Session("SPImageWidth") = Session("smImageWidth")
                    Session("SPImageHeight") = Session("smImageHeight")

                    lGraphType = Session("SPSingleGraphType")
                    strTitle7 = Session("salesPriceViewMake") & "/" & Session("salesPriceViewModel") & " - Average Days On Market for Sales"
                    strBottomTitle7 = "Year/Quarter Sold"    ' Y


                    ReDim Preserve aData7(lCnt7)
                    ReDim Preserve aLabels7(lCnt7)

                    ' SortLabelsValue(aLabels7, aData7, True)

                    tmpGraph = CreateAndGraphData(strTitle7, strBottomTitle7, strLeftTitle7, lGraphType, aLabels7, aData7, 0, "", "#,###", 0, 0, color)

                    If tmpGraph.ToString.Length > 2 Then
                        Me.SPI_QUARTER.Titles.Clear()
                        Me.SPI_QUARTER.Titles.Add(strTitle7)
                        Me.SPI_QUARTER.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                        Me.SPI_QUARTER.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" + amod_id.ToString + "SPI_QUARTER_7.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
                        ReturnQuarterlyByModel += ("<tr><td align='center'><img src='" + amod_id.ToString + "SPI_QUARTER_7.jpg'></td></tr>")
                        Me.SPI_QUARTER.Series.Clear()
                    Else
                        ReturnQuarterlyByModel += "<tr><td align='center'>Average Days On Market for Sales<br />Not Enough Data Available</td></tr>"
                    End If
                Else
                    ReturnQuarterlyByModel += "<tr><td align='center'>Average Days On Market for Sales<br />Not Enough Data Available</td></tr>"
                End If ' If lCnt7 > 1 Then






                ' ------------------------------ GRAPHING PAGE BREAK ------------------------------
                ReturnQuarterlyByModel += Build_PDF_Template_Footer()
                ReturnQuarterlyByModel += Insert_Page_Break_PDF()
                ReturnQuarterlyByModel += Build_PDF_Header_Final("Sales Price Index Report", sub_info, real_make_model_name, "", sub_type, "", "", "", True)
                ReturnQuarterlyByModel += Build_PDF_Column_Start("graphs_4", "Sales Price Index Report", "", "Sold Aircraft Percentage Data", 7)
                ' ------------------------------ GRAPHING PAGE BREAK ------------------------------









                If lCnt8 > 1 Then

                    Session("SPImageWidth") = Session("smImageWidth")
                    Session("SPImageHeight") = Session("smImageHeight")

                    lGraphType = Session("SPSingleGraphType")
                    strTitle8 = Session("salesPriceViewMake") & "/" & Session("salesPriceViewModel") & " - Avg AFTT vs Variance (%)"
                    strBottomTitle8 = "Average Airframe Total Time"     ' Y
                    ' X    

                    ReDim Preserve aData8(lCnt8)
                    ReDim Preserve aLabels8(lCnt8)

                    SortLabelsValue(aLabels8, aData8, lCnt8 - 1, 1)

                    ReDim Preserve aData8(lCnt8)
                    ReDim Preserve aLabels8(lCnt8)
                    '   SortLabelsValue(aLabels8, aData8, True)

                    tmpGraph = CreateAndGraphData(strTitle8, strBottomTitle8, strLeftTitle8, lGraphType, aLabels8, aData8, 0, "#,###", "##.0", 0, 0, color)

                    If tmpGraph.ToString.Length > 2 Then
                        Me.SPI_QUARTER.Titles.Clear()
                        Me.SPI_QUARTER.Titles.Add(strTitle8)
                        Me.SPI_QUARTER.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                        Me.SPI_QUARTER.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" + amod_id.ToString + "SPI_QUARTER_8.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
                        ReturnQuarterlyByModel += ("<tr><td align='center'><img src='" + amod_id.ToString + "SPI_QUARTER_8.jpg'></td></tr>")
                        Me.SPI_QUARTER.Series.Clear()
                    Else
                        ReturnQuarterlyByModel += "<tr><td align='center'>Avg AFTT vs Variance (%)<br />Not Enough Data Available</td></tr>"
                    End If
                Else
                    ReturnQuarterlyByModel += "<tr><td align='center'>Avg AFTT vs Variance (%)<br />Not Enough Data Available</td></tr>"
                End If ' If lCnt8 > 1 Then


                If lCnt9 > 1 Then

                    Session("SPImageWidth") = Session("smImageWidth")
                    Session("SPImageHeight") = Session("smImageHeight")

                    lGraphType = Session("SPSingleGraphType")
                    strTitle9 = Session("salesPriceViewMake") & "/" & Session("salesPriceViewModel") & " - Avg DOM vs Variance (%)"
                    strBottomTitle9 = "Average Days on Market for Sales"     ' Y
                    ' X    

                    ReDim Preserve aData9(lCnt9 - 1)
                    ReDim Preserve aLabels9(lCnt9 - 1)

                    SortLabelsValue(aLabels9, aData9, lCnt9 - 1, 1)

                    ReDim Preserve aData9(lCnt9)
                    ReDim Preserve aLabels9(lCnt9)
                    '  SortLabelsValue(aLabels9, aData9, True)

                    tmpGraph = CreateAndGraphData(strTitle9, strBottomTitle9, strLeftTitle9, lGraphType, aLabels9, aData9, 0, "#,###", "##.0", 0, 0, color)

                    If tmpGraph.ToString.Length > 2 Then
                        Me.SPI_QUARTER.Titles.Clear()
                        Me.SPI_QUARTER.Titles.Add(strTitle9)
                        Me.SPI_QUARTER.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                        Me.SPI_QUARTER.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" + amod_id.ToString + "SPI_QUARTER_9.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
                        ReturnQuarterlyByModel += ("<tr><td align='center'><img src='" + amod_id.ToString + "SPI_QUARTER_9.jpg'></td></tr>")
                        Me.SPI_QUARTER.Series.Clear()
                    Else
                        ReturnQuarterlyByModel += "<tr><td align='center'>Avg DOM vs Variance (%)<br />Not Enough Data Available</td></tr>"
                    End If
                Else
                    ReturnQuarterlyByModel += "<tr><td align='center'>Avg DOM vs Variance (%)<br />Not Enough Data Available</td></tr>"
                End If ' If lCnt9 > 1 Then

                ReturnQuarterlyByModel += Build_PDF_Column_2("", 2, "graph_4_2")


                If lCnt10 > 1 Then

                    Session("SPImageWidth") = Session("smImageWidth")
                    Session("SPImageHeight") = Session("smImageHeight")

                    lGraphType = Session("SPSingleGraphType")
                    strTitle10 = Session("salesPriceViewMake") & "/" & Session("salesPriceViewModel") & " - Avg AFTT vs Selling Price (k)"
                    strBottomTitle10 = "Average Airframe Total Time"     ' Y


                    ReDim Preserve aData10(lCnt10 - 1)
                    ReDim Preserve aLabels10(lCnt10 - 1)

                    SortLabelsValue(aLabels10, aData10, lCnt10 - 1, 1)

                    ReDim Preserve aData10(lCnt10)
                    ReDim Preserve aLabels10(lCnt10)
                    'SortLabelsValue(aLabels10, aData10)



                    tmpGraph = CreateAndGraphData(strTitle10, strBottomTitle10, strLeftTitle10, lGraphType, aLabels10, aData10, 0, "#,###", "#,###", 0, 0, color)

                    If tmpGraph.ToString.Length > 2 Then
                        Me.SPI_QUARTER.Titles.Clear()
                        Me.SPI_QUARTER.Titles.Add(strTitle10)
                        Me.SPI_QUARTER.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                        Me.SPI_QUARTER.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" + amod_id.ToString + "SPI_QUARTER_10.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
                        ReturnQuarterlyByModel += ("<tr><td align='center'><img src='" + amod_id.ToString + "SPI_QUARTER_10.jpg'></td></tr>")
                        Me.SPI_QUARTER.Series.Clear()
                    Else
                        ReturnQuarterlyByModel += "<tr><td align='center'>AFTT vs Selling Price (k)<br />Not Enough Data Available</td></tr>"
                    End If
                Else
                    ReturnQuarterlyByModel += "<tr><td align='center'>AFTT vs Selling Price (k)<br />Not Enough Data Available</td></tr>"
                End If ' If lCnt10 > 1 Then

                If lCnt11 > 1 Then

                    Session("SPImageWidth") = Session("smImageWidth")
                    Session("SPImageHeight") = Session("smImageHeight")

                    lGraphType = Session("SPSingleGraphType")
                    strTitle11 = Session("salesPriceViewMake") & "/" & Session("salesPriceViewModel") & " - Avg DOM vs Selling Price (k)"
                    strBottomTitle11 = "Average Days on Market for Sales"     ' Y



                    ReDim Preserve aData11(lCnt11 - 1)
                    ReDim Preserve aLabels11(lCnt11 - 1)

                    SortLabelsValue(aLabels11, aData11, lCnt11 - 1, 1)

                    ReDim Preserve aData11(lCnt11)
                    ReDim Preserve aLabels11(lCnt11)

                    ' Array.Sort(aData11, aLabels11)
                    '  Array.Sort(aLabels11)

                    tmpGraph = CreateAndGraphData(strTitle11, strBottomTitle11, strLeftTitle11, lGraphType, aLabels11, aData11, 0, "#,###", "#,###", 0, 0, color)

                    If tmpGraph.ToString.Length > 2 Then
                        Me.SPI_QUARTER.Titles.Clear()
                        Me.SPI_QUARTER.Titles.Add(strTitle11)
                        Me.SPI_QUARTER.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                        Me.SPI_QUARTER.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" + amod_id.ToString + "SPI_QUARTER_11.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
                        ReturnQuarterlyByModel += ("<tr><td align='center'><img src='" + amod_id.ToString + "SPI_QUARTER_11.jpg'></td></tr>")
                        Me.SPI_QUARTER.Series.Clear()
                    Else
                        ReturnQuarterlyByModel += "<tr><td align='center'>Avg DOM vs Selling Price (k)<br />Not Enough Data Available</td></tr>"
                    End If
                Else
                    ReturnQuarterlyByModel += "<tr><td align='center'>Avg DOM vs Selling Price (k)<br />Not Enough Data Available</td></tr>"
                End If ' If lCnt11 > 1 Then

                rstRec1.Close()

            Else

                strHTMLData1 = "<tr><td align='center' colspan='9'>No Records Found</td></tr>"

            End If





            strHTMLData1 = strHTMLData1 & strHTMLData1_2_final

            strHTMLData1 = strHTMLData1 & "</table>"


            ReturnQuarterlyByModel = "<tr><td><br><br></td></tr>" & strHTMLData1 & "<tr><td><br><br></td></tr>" & strGraphVarianceAsking & ReturnQuarterlyByModel

            rstRec1 = Nothing



        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function ' ReturnQuarterlyByModel
    Function SortLabelsValue(ByRef labels, ByRef data, ByVal count, ByVal direction) ' 1 direction is label is used for sort 2 is that data is 
        SortLabelsValue = ""
        Dim i As Integer = 0
        Dim j As Integer = 0
        Dim temp_string As String = ""
        Dim temp_int As Integer = 0
        Dim temp_int_array(count) As Double


        For i = 0 To count
            If direction = 1 Then
                temp_int_array(i) = CDbl(labels(i))
            Else
                temp_int_array(i) = data(i)
            End If
        Next


        For j = 0 To count - 1
            For i = 0 To count - 1
                If temp_int_array(i) > temp_int_array(i + 1) Then

                    temp_int = data(i + 1)
                    data(i + 1) = data(i)
                    data(i) = temp_int

                    temp_string = labels(i + 1)
                    labels(i + 1) = labels(i)
                    labels(i) = temp_string

                    temp_int = temp_int_array(i + 1)
                    temp_int_array(i + 1) = temp_int_array(i)
                    temp_int_array(i) = temp_int

                End If
            Next
        Next

        For j = 0 To count - 1
            If labels(j) = Nothing Then
                labels(j) = ""
            End If
        Next


    End Function
    Function CreateAndGraphData(ByVal strTitle,
                                    ByVal strBottomTitle,
                                    ByVal strLeftTitle,
                                    ByVal lGraphType,
                                    ByRef aLabels,
                                    ByRef aData,
                                    ByVal lDivBy,
                                    ByVal strXFormatString,
                                    ByVal strYFormatString,
                                    ByVal current_min,
                                    ByVal current_max,
                                      ByVal color) As String
        CreateAndGraphData = ""
        Dim series_title As String = ""
        Dim text_legend As String = ""
        Dim temp_color As String = ""

        series_title = strTitle ' for the series to be consistent, gets replaced later on 



        If lGraphType = 1 Then '  1=2D-Pie
            Me.SPI_QUARTER.Series.Add(series_title).ChartType = UI.DataVisualization.Charting.SeriesChartType.Pie
        ElseIf lGraphType = 2 Then '  2=3D Pie
            Me.SPI_QUARTER.Series.Add(series_title).ChartType = UI.DataVisualization.Charting.SeriesChartType.Pie
            'rotate
        ElseIf lGraphType = 3 Then '  3=2D Bar
            Me.SPI_QUARTER.Series.Add(series_title).ChartType = UI.DataVisualization.Charting.SeriesChartType.Column
        ElseIf lGraphType = 4 Then '  4=3D Bar
            Me.SPI_QUARTER.Series.Add(series_title).ChartType = UI.DataVisualization.Charting.SeriesChartType.Column
            'rotate
        ElseIf lGraphType = 5 Then  '  5=Gantt
            '   Me.SPI_QUARTER.Series.Add(series_title).ChartType = UI.DataVisualization.Charting.SeriesChartType.
        ElseIf lGraphType = 6 Then '  6=Line 
            Me.SPI_QUARTER.Series.Add(series_title).ChartType = UI.DataVisualization.Charting.SeriesChartType.Line
        ElseIf lGraphType = 7 Then '  7=Log/lin 
            Me.SPI_QUARTER.Series.Add(series_title).ChartType = UI.DataVisualization.Charting.SeriesChartType.Line

        ElseIf lGraphType = 8 Then '  8=2D Area 
            Me.SPI_QUARTER.Series.Add(series_title).ChartType = UI.DataVisualization.Charting.SeriesChartType.Area
        End If



        Me.SPI_QUARTER.ChartAreas("ChartArea1").AxisY.Title = strLeftTitle  ' passed in 
        Me.SPI_QUARTER.ChartAreas("ChartArea1").AxisX.Title = strBottomTitle



        Me.SPI_QUARTER.Series(series_title).YValueType = UI.DataVisualization.Charting.ChartValueType.Int32
        Me.SPI_QUARTER.Series(series_title).XValueType = UI.DataVisualization.Charting.ChartValueType.String



        '-------------------------------------------------
        '  Graph Types
        '  1=2D-Pie
        '  2=3D Pie
        '  3=2D Bar
        '  4=3D Bar
        '  5=Gantt
        '  6=Line 
        '  7=Log/lin 
        '  8=2D Area 
        '  9=2D Scatter
        ' 10=Polar/Circle Line
        ' 11=High-low-close
        ' 12=Bubble
        ' 13=3D Ribbon 
        ' 14=3D Area 
        ' 15=Log/log
        ' 16=Lin/log
        ' 17=Box-whisker +/- Bar 
        ' 18=Open-high-low-close
        ' 19=Candlestick
        ' 20=3D Survace
        ' 21=3D Scatter

        '
        '
        '
        '
        '
        '  Y Axis (Left)
        '    .
        '   .
        '  .
        ' .               X Axis (Bottom)
        '----------------------------------


        If lGraphType = 7 Then

            Me.SPI_QUARTER.Series(series_title).BorderWidth = 2


            If Right(series_title, 1) = ";" Then

                If color = "Blue" Then
                    Me.SPI_QUARTER.Series(series_title).LabelForeColor = Drawing.Color.Blue
                    Me.SPI_QUARTER.Series(series_title).Color = Drawing.Color.Blue
                ElseIf color = "Navy" Then
                    Me.SPI_QUARTER.Series(series_title).LabelForeColor = Drawing.Color.Navy
                    Me.SPI_QUARTER.Series(series_title).Color = Drawing.Color.Navy
                ElseIf color = "Light Gray" Then
                    Me.SPI_QUARTER.Series(series_title).LabelForeColor = Drawing.Color.LightSlateGray
                    Me.SPI_QUARTER.Series(series_title).Color = Drawing.Color.LightSlateGray
                ElseIf color = "Gray" Then
                    Me.SPI_QUARTER.Series(series_title).LabelForeColor = Drawing.Color.Gray
                    Me.SPI_QUARTER.Series(series_title).Color = Drawing.Color.Gray
                ElseIf color = "Dark Gray" Then
                    Me.SPI_QUARTER.Series(series_title).LabelForeColor = Drawing.Color.DarkSlateGray
                    Me.SPI_QUARTER.Series(series_title).Color = Drawing.Color.DarkSlateGray
                ElseIf color = "Black" Then
                    Me.SPI_QUARTER.Series(series_title).LabelForeColor = Drawing.Color.Black
                    Me.SPI_QUARTER.Series(series_title).Color = Drawing.Color.Black
                Else
                    Me.SPI_QUARTER.Series(series_title).LabelForeColor = Drawing.Color.Blue ' set to blue for default 
                    Me.SPI_QUARTER.Series(series_title).Color = Drawing.Color.Blue
                End If

                If color = "Blue" Then
                    temp_color = "Blue"
                ElseIf color = "Navy" Then
                    temp_color = "#0000A0"
                ElseIf color = "Light Gray" Then
                    temp_color = "#A0A0A0"
                ElseIf color = "Gray" Then
                    temp_color = "Gray"
                ElseIf color = "Dark Gray" Then
                    temp_color = "#25383C"
                ElseIf color = "Black" Then
                    temp_color = "Black"
                Else
                    temp_color = "Blue"
                End If


                text_legend = "<tr valign='top'><td><table align='center' valign='top' width='50%' border='1'>"
                text_legend += "<tr><td align='left' bgcolor='red'><font size='-2' color='white'>Avg Selling Price:</font></td><td align='left' bgcolor='red'> <font size='-2' color='white'>Red</font></td></tr>"
                text_legend += "<tr><td align='left' bgcolor='" & temp_color & "'><font size='-2' color='white'>Avg Asking Price:</font></td><td align='left' bgcolor='" & temp_color & "'> <font size='-2' color='white'>" & color & "</font></td></tr>"
                text_legend += "</table></td></tr>"
            Else

                Me.SPI_QUARTER.Series(series_title).LabelForeColor = Drawing.Color.Red  ' set to blue for default 
                Me.SPI_QUARTER.Series(series_title).Color = Drawing.Color.Red


            End If





        Else
            If color = "Blue" Then
                Me.SPI_QUARTER.Series(series_title).LabelForeColor = Drawing.Color.Blue
                Me.SPI_QUARTER.Series(series_title).Color = Drawing.Color.Blue
            ElseIf color = "Navy" Then
                Me.SPI_QUARTER.Series(series_title).LabelForeColor = Drawing.Color.Navy
                Me.SPI_QUARTER.Series(series_title).Color = Drawing.Color.Navy
            ElseIf color = "Light Gray" Then
                Me.SPI_QUARTER.Series(series_title).LabelForeColor = Drawing.Color.LightSlateGray
                Me.SPI_QUARTER.Series(series_title).Color = Drawing.Color.LightSlateGray
            ElseIf color = "Gray" Then
                Me.SPI_QUARTER.Series(series_title).LabelForeColor = Drawing.Color.Gray
                Me.SPI_QUARTER.Series(series_title).Color = Drawing.Color.Gray
            ElseIf color = "Dark Gray" Then
                Me.SPI_QUARTER.Series(series_title).LabelForeColor = Drawing.Color.DarkSlateGray
                Me.SPI_QUARTER.Series(series_title).Color = Drawing.Color.DarkSlateGray
            ElseIf color = "Black" Then
                Me.SPI_QUARTER.Series(series_title).LabelForeColor = Drawing.Color.Black
                Me.SPI_QUARTER.Series(series_title).Color = Drawing.Color.Black
            Else
                Me.SPI_QUARTER.Series(series_title).LabelForeColor = Drawing.Color.Blue ' set to blue for default 
                Me.SPI_QUARTER.Series(series_title).Color = Drawing.Color.Blue
            End If
        End If
        '--------------------------
        ' Color
        '  1=Dark Red
        '  2=Red
        '  3=Green
        '  4=Purple
        '  5=Dk Blue
        '  6=Blue
        '  7=Lt Grey
        '  8=Dk Grey
        '  9=Lt Purple
        ' 10=Lt Bue
        ' 11=Lt Green
        ' 12=Lime Green
        ' 13=Yellow
        ' 14=Gold
        ' 15=White 
        ' 16=Blank




        Dim strGraphPath As String = ""
        Dim strGraphURL As String = ""
        Dim lData As Integer = 0
        Dim strLabel As String = ""


        Dim lMax As Double = 0
        Dim lMin As Double = 0

        Dim lCnt1 As Integer = 0

        Dim strHTML As String = ""

        Dim strImageWidth As Integer = 0
        Dim strImageHeight As Integer = 0

        Dim lWidth As Integer = 0
        Dim lHeight As Integer = 0



        If CLng(Session("SPGraphWidth")) > 0 Then
            lWidth = CInt(Session("SPGraphWidth"))
        End If

        If CLng(Session("SPGraphHeight")) > 0 Then
            lHeight = CInt(Session("SPGraphHeight"))
        End If

        strHTML = ""

        If UBound(aData) >= 1 And Not Session("localMachine") Then


            If UBound(aData) > 1 Then
                If (UBound(aData) / 2) > 100 Then
                    '   objGraph.YAxisTicks = 100
                Else
                    '  objGraph.YAxisTicks = (UBound(aData) / 2)
                End If
            Else
                '  objGraph.YAxisTicks = 1
            End If


            If current_min > 0 Or current_max > 0 Then
                lMin = current_min
                lMax = current_max
            Else
                lMin = 999999999
                lMax = -999999999
            End If




            For lCnt1 = 1 To UBound(aData)

                If Not IsNothing(aData(lCnt1 - 1)) Then

                    Me.SPI_QUARTER.Series(series_title).Points.AddXY(aLabels(lCnt1 - 1), aData(lCnt1 - 1))
                    '  strLabel = aLabels(lCnt1 - 1)
                    '  objGraph.Label(lCnt1) = strLabel & "   "

                    lData = CDbl(aData(lCnt1 - 1))

                    If lDivBy > 0 Then
                        lData = lData \ lDivBy
                    End If



                    If lData > lMax Then
                        lMax = lData
                    End If
                    If lData < lMin Then
                        lMin = lData
                    End If
                End If
            Next ' lCnt1




            Dim temp_counter As Integer = 0
            Dim temp_ten As Double = 10
            Dim temp_max As Double = 0
            Dim temp_min As Integer = 0
            Dim i As Integer = 1
            Dim label_count As Integer = 0
            Dim found As Integer = 0
            Dim found2 As Integer = 0
            label_count = UBound(aLabels)

            If lMax <= 0 Then
                temp_counter = -10
            ElseIf lMax <= 100 Then ' 100 
                temp_counter = 10
            ElseIf lMax <= 1000 Then  ' 1 thousand 
                temp_counter = 100
            ElseIf lMax <= 10000 Then ' ten thousand 
                temp_counter = 1000
            ElseIf lMax <= 100000 Then  ' 100 thousand 
                temp_counter = 10000
            ElseIf lMax <= 1000000 Then ' 1 mill 
                temp_counter = 100000
            ElseIf lMax <= 10000000 Then ' ten mill 
                temp_counter = 1000000
            ElseIf lMax <= 100000000 Then ' one hundred mill
                temp_counter = 10000000
            End If

            temp_max = lMax
            If lMax >= 0 Then
                For i = 1 To 20
                    If lMax >= (temp_counter * i) Then
                        temp_max = i + 1
                    Else
                        i = 20
                    End If
                Next
            Else
                For i = 1 To 20
                    If lMax >= (temp_counter * i * -1) Then
                        temp_max = (i - 1) * -1
                        i = 20
                    End If

                Next
            End If

            temp_min = lMin

            If lMin >= 0 Then
                For i = 1 To 20
                    If lMin <= (temp_counter * i) Then
                        temp_min = i - 1
                        i = 20
                    End If
                Next
            Else
                For i = 1 To 20
                    If lMin >= (temp_counter * i * -1) Then
                        temp_min = (i) * -1
                        i = 20
                    End If

                Next
            End If




            ' even more precision 
            If lMax >= 0 Then
                For i = 1 To 10
                    If (temp_counter + (i * (temp_counter / 10))) >= lMax Then
                        found = (temp_counter + (i * (temp_counter / 10)))
                        i = 10
                    End If
                Next
            End If


            If lMin < 0 Then
                For i = 1 To 10
                    If ((temp_counter * -1) - (i * (temp_counter / 10))) <= lMin Then
                        found2 = ((temp_counter * -1) - (i * (temp_counter / 10)))
                        i = 10
                    End If
                Next
            End If




            ' 10,000    *       2 =         20,000
            If found > 0 Then
                lMax = found
            Else
                lMax = (temp_counter * temp_max)
            End If

            If found2 < 0 Then
                lMin = found2
            Else
                lMin = (temp_counter * temp_min)
            End If


            If Me.S_3D.Checked = True Then
                Me.SPI_QUARTER.ChartAreas("ChartArea1").Area3DStyle.Enable3D = True
                'Me.SPI_QUARTER.ChartAreas("ChartArea1").Area3DStyle.Perspective = 5
                Me.SPI_QUARTER.ChartAreas("ChartArea1").Area3DStyle.Rotation = 10
            Else
                Me.SPI_QUARTER.Series(series_title).MarkerSize = 5
                Me.SPI_QUARTER.Series(series_title).MarkerStyle = UI.DataVisualization.Charting.MarkerStyle.Circle
            End If




            Me.SPI_QUARTER.ChartAreas("ChartArea1").AxisX.LabelStyle.Angle = -90
            Me.SPI_QUARTER.ChartAreas("ChartArea1").AxisX.LabelStyle.Interval = 1
            Me.SPI_QUARTER.ChartAreas("ChartArea1").AxisX.LabelStyle.IsEndLabelVisible = False
            Me.SPI_QUARTER.ChartAreas("ChartArea1").AxisX.IsLabelAutoFit = True
            '  Me.SPI_QUARTER.ChartAreas("ChartArea1").AxisX.LabelAutoFitStyle = DataVisualization.Charting.LabelAutoFitStyles.DecreaseFont
            ' Me.SPI_QUARTER.ChartAreas("ChartArea1").AxisX.LabelAutoFitMinFontSize = 5
            'Me.SPI_QUARTER.ChartAreas("ChartArea1").AxisX.LabelAutoFitMaxFontSize = 5







            Me.SPI_QUARTER.ChartAreas("ChartArea1").AxisY.Minimum = lMin
            Me.SPI_QUARTER.ChartAreas("ChartArea1").AxisY.Maximum = lMax
            '   Me.SPI_QUARTER.ChartAreas("ChartArea1").Area3DStyle.Rotation = 100



            '        If lGraphType = 7 Then
            ' If Right(series_title, 1) = ";" Then
            ' Me.SPI_QUARTER.Series(series_title).Points.FindMinByValue.Label = "Avg Selling Prices"
            ' Else
            '     Me.SPI_QUARTER.Series(series_title).Points.FindMaxByValue.Label = "Avg Asking Prices"
            ' End If
            ' End If




            'If CLng(Session("SPImageWidth")) > 0 Then
            '    strImageWidth = "width='" & CStr(Session("SPImageWidth")) & "' "
            'End If

            ''If Clng(Session("SPImageHeight")) > 0 Then
            ''  strImageHeight="height='" & CStr(Session("SPImageHeight")) & "' "
            ''End If
            If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                Me.SPI_QUARTER.Width = 250
                Me.SPI_QUARTER.Height = 250
            End If



        End If ' If UBound(aData) >= 1 Then

        If text_legend.ToString.Trim <> "" Then
            CreateAndGraphData = text_legend.ToString.Trim    ' if there is a legend ( for the one line graph) return the legend 
        Else
            CreateAndGraphData = lMin & "," & lMax
        End If


    End Function ' CreateAndGraphData

    Public Function ReturnPreviousFullQuarterlyByWeightClass(ByRef cntConn, ByVal lModelId, ByRef strHTMLData2, ByRef strGraphPercentAsking, ByRef strGraphVarianceAsking, ByVal weight_class, ByVal weight_class_name, ByVal spi_year, ByVal spi_year2, ByVal airframe_type, ByVal sub_info, ByVal real_make_model_name, ByVal sub_type, ByVal color) As String
        ReturnPreviousFullQuarterlyByWeightClass = ""



        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim rstRec1 As System.Data.SqlClient.SqlDataReader : rstRec1 = Nothing

        Dim strQuery1 As String = ""

        Dim strYearSld As String = ""
        Dim strQuarterSld As String = ""
        Dim strYearQtrName As String = ""

        Dim strMakeAbbrev As String = ""
        Dim lAModID As Integer = 0
        Dim strAModId As String = ""
        Dim strWeightClass As String = ""
        Dim strWeightClassName As String = ""

        Dim strAvgYearMfr As String = ""
        Dim strAvgYearDlv As String = ""
        Dim strAvgAsking As String = ""
        Dim strAvgSelling As String = ""
        Dim strPercent As String = ""
        Dim strVariance As String = ""
        Dim strAvgAFTT As String = ""
        Dim strAvgDOM As String = ""

        Dim dAvgYearMfr As Double = 0
        Dim dAvgYearDlv As Double = 0
        Dim dAvgAsking As Double = 0
        Dim dAvgSelling As Double = 0
        Dim dPercent As Double = 0
        Dim dVariance As Double = 0
        Dim dAvgAFTT As Double = 0
        Dim dAvgDOM As Double = 0

        Dim lRec1 As String = ""
        Dim strHRef As String = ""

        Dim lColSpan As Integer = 0
        Dim lTotRec As Double = 0

        Dim lGraphType As Integer = 0
        Dim strGraphImage As String = ""

        ' Percentage Of Asking Price     
        Dim strTitle1 As String = ""
        Dim strBottomTitle1 As String = ""
        Dim strLeftTitle1 As String = ""
        Dim lCnt1 As Integer = 0
        Dim aData1()
        Dim aLabels1()

        ' Variance Of Asking Price     
        Dim strTitle2 As String = ""
        Dim strBottomTitle2 As String = ""
        Dim strLeftTitle2 As String = ""
        Dim lCnt2 As Integer = 0
        Dim aData2()
        Dim aLabels2()

        Dim strModel As String = ""
        Dim strMake As String = ""
        Dim lYearSld As Integer = 0
        Dim lQuarterSld As Integer = 0

        Dim tmpGraph As String = ""

        Try
            strGraphPercentAsking = "Percentage of Asking Price (%)<br />Not Enough Data Available"
            strGraphVarianceAsking = "Variance of Asking Price (%)<br />Not Enough Data Available"

            ' Clear All Variables Passed By Reference

            strHTMLData2 = ""

            strQuery1 = "SELECT amod_id As AModId, amod_make_name As Make, amod_make_abbrev As MakeAbbrev, amod_model_name As Model,"
            strQuery1 = strQuery1 & " AVG(CAST(ac_mfr_year AS INT)) As dAvgYearMfr,"
            strQuery1 = strQuery1 & " AVG(CAST(ac_year AS INT)) As dAvgYearDlv,"
            strQuery1 = strQuery1 & " AVG(ac_asking_price) As dAvgAsking,"
            strQuery1 = strQuery1 & " AVG(ac_hidden_asking_price) As dAvgAskingHidden,"
            strQuery1 = strQuery1 & " AVG(ac_sale_price) As dAvgSelling,"
            strQuery1 = strQuery1 & " ((AVG(ac_sale_price)/AVG(ac_asking_price)) * 100) As dPercent,"
            strQuery1 = strQuery1 & " ((1-(AVG(ac_sale_price)/AVG(ac_asking_price))) * 100) As dVariance,"
            strQuery1 = strQuery1 & " ((AVG(ac_sale_price)/AVG(ac_hidden_asking_price)) * 100) As dPercentHidden,"
            strQuery1 = strQuery1 & " ((1-(AVG(ac_sale_price)/AVG(ac_hidden_asking_price))) * 100) As dVarianceHidden,"
            strQuery1 = strQuery1 & " AVG(ac_airframe_tot_hrs) As dAvgAFTT,"
            strQuery1 = strQuery1 & " AVG(DateDiff(day,ac_list_date, journ_date)) As dAvgDOM"

            strQuery1 = strQuery1 & " FROM Aircraft_Summary_SPI WITH (NOLOCK)"
            'strQuery1 = strQuery1 & " FROM Aircraft WITH (NOLOCK, INDEX(ix_ac_sale_price_ac_id_journ_id_key))"
            'strQuery1 = strQuery1 & " INNER JOIN Aircraft_Model WITH (NOLOCK) ON ac_amod_id = amod_id"
            'strQuery1 = strQuery1 & " INNER JOIN Journal WITH (NOLOCK) ON ac_id = journ_ac_id AND ac_journ_id = journ_id"
            'strQuery1 = strQuery1 & " INNER JOIN Journal_Category WITH (NOLOCK) ON journ_subcategory_code = jcat_subcategory_code"



            strQuery1 = strQuery1 & " WHERE (ac_journ_id > 0)"
            strQuery1 = strQuery1 & " AND (ac_lifecycle_stage = 3)"                   '-- In Operation Only
            strQuery1 = strQuery1 & " AND (jcat_used_retail_sales_flag = 'Y')"        '-- Retail Only    
            strQuery1 = strQuery1 & " AND (journ_newac_flag = 'N')"                   '-- Used Sales Only
            strQuery1 = strQuery1 & " AND (journ_subcategory_code LIKE 'WS%')"        '-- Whole Sales Only
            strQuery1 = strQuery1 & " AND (journ_subcategory_code NOT LIKE '%IT%')"   '-- No Internals
            strQuery1 = strQuery1 & " AND (journ_internal_trans_flag = 'N')"          '-- No Internals

            If lModelId > 0 Then
                strQuery1 = strQuery1 & " AND (amod_id <> " & CStr(lModelId) & ")"
            End If

            Select Case CLng(Session("salesPriceViewAirframeType"))
                Case Is = 1
                    strQuery1 = strQuery1 & " AND (amod_customer_flag = 'Y' AND amod_airframe_type_code='F' AND amod_type_code = 'E')"
                Case Is = 2
                    strQuery1 = strQuery1 & " AND (amod_customer_flag = 'Y' AND amod_airframe_type_code='F' AND amod_type_code = 'J')"
                Case Is = 3
                    strQuery1 = strQuery1 & " AND (amod_customer_flag = 'Y' AND amod_airframe_type_code='F' AND amod_type_code = 'T')"
                Case Is = 4
                    strQuery1 = strQuery1 & " AND (amod_customer_flag = 'Y' AND amod_airframe_type_code='F' AND amod_type_code = 'P')"
                Case Is = 5
                    strQuery1 = strQuery1 & " AND (amod_customer_flag = 'Y' AND amod_airframe_type_code='R' AND amod_type_code in ('T','P'))"
            End Select

            If Trim(Session("salesPriceViewWtCls")) <> "" Then

                If InStr(1, Session("salesPriceViewWtCls"), ",") = 0 Then
                    strQuery1 = strQuery1 & " AND (amod_weight_class = '" & Session("salesPriceViewWtCls") & "')"
                Else
                    strQuery1 = strQuery1 & " AND (amod_weight_class IN ('" & Replace(Session("salesPriceViewWtCls"), ",", "','") & "'))"
                End If

            End If

            strQuery1 = strQuery1 & " AND (ac_sale_price IS NOT NULL) AND (ac_sale_price <> 0)"

            If Trim(Session("SPYearSld2")) > 0 Then
                strQuery1 = strQuery1 & " AND (DATEPART(year,journ_date) >= " & Session("SPYearSld2") & ")"
                strQuery1 = strQuery1 & " AND (DATEPART(quarter,journ_date) = 1)"
            End If

            strQuery1 = strQuery1 & " GROUP BY amod_id, amod_make_name, amod_make_abbrev, amod_model_name"
            strQuery1 = strQuery1 & " ORDER BY amod_make_name, amod_model_name asc"

            If Session("debug") Then
                Response.Write("<b>ReturnPreviousFullQuarterlyByWeightClass : " & Server.HtmlEncode(strQuery1) & "</b><br /><br />")
            End If

            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn
            '  End Select

            ' End Select
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60
            SqlCommand.CommandText = strQuery1
            rstRec1 = SqlCommand.ExecuteReader()


            strHTMLData2 = "<table id='weightClassDataTable' cellpadding='2' cellspacing='0' border='1' width='100%' class='salesPrice'>"
            strHTMLData2 = strHTMLData2 & "<tr bgcolor='#CCCCCC'><td align='center' colspan='9'>"
            strHTMLData2 = strHTMLData2 & "Weight Class Similar To " & Session("salesPriceViewMake") & "&nbsp;/&nbsp;" & Session("salesPriceViewModel") & "&nbsp;&nbsp;(" & Session("salesPriceViewWtClsName") & ")<br />"

            strHTMLData2 = strHTMLData2 & "Year/Quarter Sold " & Session("SPYearSld2") & " - " & ReturnYearQuarterName_PDF(Session("SPYearSld2"), 1)

            strHTMLData2 = strHTMLData2 & "</td></tr>"

            strHTMLData2 = strHTMLData2 & "<tr bgcolor='#CCCCCC'><td align='center' rowspan='2'>Make<br />Model</td>"
            strHTMLData2 = strHTMLData2 & "<td align='center' colspan='2'>Avg Year Of</td>"
            strHTMLData2 = strHTMLData2 & "<td align='center' colspan='2'>Avg Price (k)</td>"
            strHTMLData2 = strHTMLData2 & "<td align='center' rowspan='2'>Percent</td>"
            strHTMLData2 = strHTMLData2 & "<td align='center' rowspan='2'>Variance</td>"
            strHTMLData2 = strHTMLData2 & "<td align='center' colspan='2'>Average</td></tr>"

            strHTMLData2 = strHTMLData2 & "<tr bgcolor='#CCCCCC'><td align='center'>Mfr</td>"
            strHTMLData2 = strHTMLData2 & "<td align='center'>Delivery</td>"
            strHTMLData2 = strHTMLData2 & "<td align='center'>Asking</td>"
            strHTMLData2 = strHTMLData2 & "<td align='center'>Selling</td>"
            strHTMLData2 = strHTMLData2 & "<td align='center'>AFTT</td>"
            strHTMLData2 = strHTMLData2 & "<td align='center'>Days<br />On<br />Market</td></tr>"

            If rstRec1.HasRows Then
                lTotRec = 1000

                lCnt1 = 0
                lCnt2 = 0

                ReDim aData1(lTotRec)      ' Percentage Of Asking Price
                ReDim aLabels1(lTotRec)

                ReDim aData2(lTotRec)      ' Variance Of Asking Price
                ReDim aLabels2(lTotRec)

                Do While rstRec1.Read

                    strYearSld = ""
                    strQuarterSld = ""
                    strYearQtrName = ""

                    strModel = ""
                    strMake = ""
                    strMakeAbbrev = ""
                    strAModId = ""

                    strAvgYearMfr = ""
                    strAvgYearDlv = ""
                    strAvgAsking = ""
                    strAvgSelling = ""
                    strPercent = ""
                    strVariance = ""
                    strAvgAFTT = ""
                    strAvgDOM = ""

                    lAModID = 0
                    lYearSld = 0
                    lQuarterSld = 0
                    dAvgYearMfr = 0.0
                    dAvgYearDlv = 0.0
                    dAvgAsking = 0.0
                    dAvgSelling = 0.0
                    dPercent = 0.0
                    dVariance = 0.0
                    dAvgAFTT = 0.0
                    dAvgDOM = 0.0

                    strMake = Trim(rstRec1("Make"))
                    strMakeAbbrev = "(" & Trim(rstRec1("MakeAbbrev")) & ")"
                    strModel = Trim(rstRec1("Model"))
                    lAModID = rstRec1("AModId")
                    strAModId = CStr(lAModID)

                    If Not IsDBNull(rstRec1("dAvgYearMfr")) Then
                        dAvgYearMfr = rstRec1("dAvgYearMfr")
                    Else
                        dAvgYearMfr = 0
                    End If

                    If Not IsDBNull(rstRec1("dAvgYearDlv")) Then
                        dAvgYearDlv = rstRec1("dAvgYearDlv")
                    Else
                        dAvgYearDlv = 0
                    End If

                    If Not IsDBNull(rstRec1("dAvgAsking")) Then
                        dAvgAsking = rstRec1("dAvgAsking")
                    ElseIf Not IsDBNull(rstRec1("dAvgAskingHidden")) Then
                        dAvgAsking = rstRec1("dAvgAskingHidden")
                    Else
                        dAvgAsking = 0
                    End If

                    If Not IsDBNull(rstRec1("dAvgSelling")) Then
                        dAvgSelling = rstRec1("dAvgSelling")
                    Else
                        dAvgSelling = 0
                    End If

                    If Not IsDBNull(rstRec1("dPercent")) Then
                        dPercent = rstRec1("dPercent")
                    ElseIf Not IsDBNull(rstRec1("dPercentHidden")) Then
                        dPercent = rstRec1("dPercentHidden")
                    Else
                        dPercent = 0
                    End If

                    If Not IsDBNull(rstRec1("dVariance")) Then
                        dVariance = rstRec1("dVariance")
                    ElseIf Not IsDBNull(rstRec1("dVarianceHidden")) Then
                        dVariance = rstRec1("dVarianceHidden")
                    Else
                        dVariance = 0
                    End If

                    If Not IsDBNull(rstRec1("dAvgAFTT")) Then
                        dAvgAFTT = rstRec1("dAvgAFTT")
                    Else
                        dAvgAFTT = 0
                    End If

                    If Not IsDBNull(rstRec1("dAvgDOM")) Then
                        dAvgDOM = rstRec1("dAvgDOM")
                    Else
                        dAvgDOM = 0
                    End If

                    strHRef = strMakeAbbrev & " " & strModel
                    strHTMLData2 = strHTMLData2 & "<tr><td align='left' nowrap='nowrap'>" & strHRef & "</td>"

                    strHTMLData2 = strHTMLData2 & "<td align='center'>"
                    If dAvgYearMfr > 0 Then
                        strHTMLData2 = strHTMLData2 & CStr(dAvgYearMfr) & "</td>"
                    Else
                        strHTMLData2 = strHTMLData2 & "&nbsp;</td>"
                    End If

                    strHTMLData2 = strHTMLData2 & "<td align='center'>"
                    If dAvgYearDlv > 0 Then
                        strHTMLData2 = strHTMLData2 & CStr(dAvgYearDlv) & "</td>"
                    Else
                        strHTMLData2 = strHTMLData2 & "&nbsp;</td>"
                    End If

                    strHTMLData2 = strHTMLData2 & "<td align='right'>"
                    If dAvgAsking > 0 Then
                        strHTMLData2 = strHTMLData2 & "$" & FormatNumber(dAvgAsking / 1000, 0, True) & "</td>"
                    Else
                        strHTMLData2 = strHTMLData2 & "&nbsp;</td>"
                    End If

                    strHTMLData2 = strHTMLData2 & "<td align='right'>"
                    If dAvgSelling > 0 Then
                        strHTMLData2 = strHTMLData2 & "$" & FormatNumber(dAvgSelling / 1000, 0, True) & "</td>"
                    Else
                        strHTMLData2 = strHTMLData2 & "&nbsp;</td>"
                    End If

                    strHTMLData2 = strHTMLData2 & "<td align='right'>"
                    If dPercent > 0 Then
                        strHTMLData2 = strHTMLData2 & FormatNumber(dPercent, 1, True) & "%</td>"
                    Else
                        strHTMLData2 = strHTMLData2 & "&nbsp;</td>"
                    End If

                    strHTMLData2 = strHTMLData2 & "<td align='right'>"
                    If dAvgAsking > 0 Then
                        strHTMLData2 = strHTMLData2 & FormatNumber(dVariance, 1, True) & "%</td>"
                    ElseIf dAvgAsking = dAvgSelling Then
                        strHTMLData2 = strHTMLData2 & "0.0%</td>"
                    Else
                        strHTMLData2 = strHTMLData2 & "&nbsp;</td>"
                    End If

                    strHTMLData2 = strHTMLData2 & "<td align='right'>"
                    If dAvgAFTT > 0 Then
                        strHTMLData2 = strHTMLData2 & FormatNumber(dAvgAFTT, 0, True) & "</td>"
                    Else
                        strHTMLData2 = strHTMLData2 & "&nbsp;</td>"
                    End If

                    strHTMLData2 = strHTMLData2 & "<td align='right'>"
                    If dAvgDOM > 0 Then
                        strHTMLData2 = strHTMLData2 & FormatNumber(dAvgDOM, 0, True) & "</td>"
                    Else
                        strHTMLData2 = strHTMLData2 & "&nbsp;</td>"
                    End If

                    strHTMLData2 = strHTMLData2 & "</tr>"

                    ' Percentage Of Asking Price  
                    If dAvgAsking > 0 Then
                        lCnt1 = lCnt1 + 1
                        aLabels1(lCnt1 - 1) = strMakeAbbrev & " " & strModel
                        aData1(lCnt1 - 1) = CDbl(FormatNumber(dPercent, 1, True))
                    End If

                    ' Variance Of Asking Price  
                    If dAvgAsking > 0 Then
                        lCnt2 = lCnt2 + 1
                        aLabels2(lCnt2 - 1) = strMakeAbbrev & " " & strModel
                        aData2(lCnt2 - 1) = CDbl(FormatNumber(dVariance, 1, True))
                    End If


                Loop

                'Graph(Types)
                '  1=2D-Pie,        2=3D Pie
                '  3=2D Bar,        4=3D Bar
                '  6=Line,          7=Line 
                '  8=Area,          9=Speckle
                ' 10=Circle Line,  13=3D Ribbon 
                ' 14=3D-Area,      15=Line 
                ' 16=Line,         17=+/- Bar




                ' ------------------------------ GRAPHING PAGE BREAK ------------------------------
                strHTMLData2 += Build_PDF_Template_Footer()
                strHTMLData2 += Insert_Page_Break_PDF()
                strHTMLData2 += Build_PDF_Header_Final("Sales Price Index Report", sub_info, real_make_model_name, "", sub_type, "", "", "", True)
                strHTMLData2 += Build_PDF_Column_Start("spi_vask1", "Sales Price Index Report", "", "Sold Aircraft Information", 2)
                ' ------------------------------ GRAPHING PAGE BREAK ------------------------------




                If lCnt1 > 1 And Not Session("localMachine") Then

                    Session("SPImageWidth") = Session("smImageWidth")
                    Session("SPImageHeight") = Session("smImageHeight")

                    lGraphType = Session("SPSingleGraphType")
                    strTitle1 = "Weight Class (" & Session("salesPriceViewWtClsName") & ") - Percentage of Asking Price (%)"
                    strBottomTitle1 = "Make/Model(s)"    ' Y      


                    '      lCnt1 = delete_bad_data_from_graphs(aLabels1, aData1, lCnt1)


                    ReDim Preserve aData1(lCnt1)
                    ReDim Preserve aLabels1(lCnt1)

                    SortLabelsValue(aLabels1, aData1, lCnt1 - 1, 2)


                    tmpGraph = CreateAndGraphData(strTitle1, strBottomTitle1, strLeftTitle1, lGraphType, aLabels1, aData1, 0, "", "##.0", 0, 0, color)

                    If tmpGraph.ToString.Length > 2 Then
                        Me.SPI_QUARTER.Titles.Clear()
                        Me.SPI_QUARTER.Titles.Add(strTitle1)
                        Me.SPI_QUARTER.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                        Me.SPI_QUARTER.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" + amod_id.ToString + "SPI_QUARTER_W.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
                        strHTMLData2 += ("<tr><td align='center'><img src='" + amod_id.ToString + "SPI_QUARTER_W.jpg'></td></tr>")
                        Me.SPI_QUARTER.Series.Clear()
                    Else
                        strHTMLData2 += "<tr><td align='center'>Percentage of Asking Price (%)<br />Not Enough Data Available</td></tr>"
                    End If
                Else
                    strHTMLData2 += "<tr><td align='center'>Percentage of Asking Price (%)<br />Not Enough Data Available</td></tr>"
                End If ' If lCnt1 > 1 Then

                strHTMLData2 += Build_PDF_Column_2("", 2, "spi_vask2")

                If lCnt2 > 1 And Not Session("localMachine") Then

                    Session("SPImageWidth") = Session("smImageWidth")
                    Session("SPImageHeight") = Session("smImageHeight")

                    lGraphType = Session("SPSingleGraphType")
                    strTitle2 = "Weight Class (" & Session("salesPriceViewWtClsName") & ") - Variance of Asking Price (%)"
                    strBottomTitle2 = "Make/Model(s)"    ' Y

                    ReDim Preserve aData2(lCnt2)
                    ReDim Preserve aLabels2(lCnt2)


                    SortLabelsValue(aLabels2, aData2, lCnt2 - 1, 2)

                    tmpGraph = CreateAndGraphData(strTitle2, strBottomTitle2, strLeftTitle2, lGraphType, aLabels2, aData2, 0, "", "##.0", 0, 0, color)
                    If tmpGraph.ToString.Length > 2 Then
                        Me.SPI_QUARTER.Titles.Clear()
                        Me.SPI_QUARTER.Titles.Add(strTitle2)
                        Me.SPI_QUARTER.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                        Me.SPI_QUARTER.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" + amod_id.ToString + "SPI_QUARTER_W_2.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
                        strHTMLData2 += ("<tr><td align='center'><img src='" + amod_id.ToString + "SPI_QUARTER_W_2.jpg'></td></tr>")
                        Me.SPI_QUARTER.Series.Clear()
                    Else
                        strHTMLData2 += "<tr><td align='center'>Variance of Asking Price (%)<br />Not Enough Data Available</td></tr>"
                    End If
                Else
                    strHTMLData2 += "<tr><td align='center'>Variance of Asking Price (%)<br />Not Enough Data Available</td></tr>"
                End If ' If lCnt2 > 1 Then

                rstRec1.Close()

            Else

                strHTMLData2 = strHTMLData2 & "<tr><td align='center' colspan='9'>No Records Found</td></tr>"

            End If

            strHTMLData2 = strHTMLData2 & "</table>"

            rstRec1 = Nothing

            ReturnPreviousFullQuarterlyByWeightClass = strHTMLData2.ToString

        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function ' ReturnPreviousFullQuarterlyByWeightClass
    Function delete_bad_data_from_graphs(ByRef labal, ByRef data, ByVal count) As Integer
        Dim new_count As Integer = 0

        delete_bad_data_from_graphs = new_count
    End Function

    Function ReturnYearQuarterName_PDF(ByVal strYear, ByVal strQuarter)

        Dim strResults

        strResults = ""

        Select Case strQuarter
            Case "1"
                strResults = "1st Quarter (Jan-Feb-Mar), " & strYear
            Case "2"
                strResults = "2nd Quarter (Apr-May-Jun), " & strYear
            Case "3"
                strResults = "3rd Quarter (Jul-Aug-Sep), " & strYear
            Case "4"
                strResults = "4th Quarter (Oct-Nov-Dec), " & strYear
        End Select

        ReturnYearQuarterName_PDF = strResults

    End Function ' ReturnYearQuarterName

    Function Build_PDF_Column_2(ByVal Table_sub_title, ByVal num_columns, ByVal table_name) As String
        Build_PDF_Column_2 = "</table></td><td width='50%' valign='top' class='rightside'><table valign='top' id='" & table_name & "_second_column_table' width='100%' cellpadding='4' cellspacing='0'>"
        Build_PDF_Column_2 = Build_PDF_Column_2 & "<tr><td colspan='" & num_columns & "'  bgcolor='#CCCCCC' width='100%'><strong>" & Table_sub_title
        If Table_sub_title.ToString.Trim = "" Then
            Build_PDF_Column_2 = Build_PDF_Column_2 & "&nbsp;"
        End If
        Build_PDF_Column_2 = Build_PDF_Column_2 & "</strong></td></tr>"
    End Function
    Function Build_PDF_Column_Start(ByVal table_name, ByVal table_title, ByVal value_in_parens, ByVal Table_sub_title, ByVal num_columns) As String
        'num-columns is number of columns in each column
        Build_PDF_Column_Start = ""

        If Me.WD.SelectedValue.ToString = "WD" Then
            Build_PDF_Column_Start = Build_PDF_Column_Start & "<table id='" & table_name & "_outer_table' width='" & word_width & "'  cellpadding='1' cellspacing='0' class='module'>" & vbCrLf
            Build_PDF_Column_Start = Build_PDF_Column_Start & "<tr><td valign='top' align='left' class='header' style='padding-left:3px;'>" & table_title

            If value_in_parens.ToString.Trim <> "" Then
                Build_PDF_Column_Start = Build_PDF_Column_Start & " <em>(" & value_in_parens & ")</em>"
            End If

            Build_PDF_Column_Start = Build_PDF_Column_Start & "</td></tr>"
            Build_PDF_Column_Start = Build_PDF_Column_Start & "<tr><td valign='top' align='left'>"
            Build_PDF_Column_Start = Build_PDF_Column_Start & "<table id='" & table_name & "_inner_table' width='" & word_width & "' cellpadding='1' cellspacing='0'>" & vbCrLf
            Build_PDF_Column_Start = Build_PDF_Column_Start & "<tr valign='top'><td class='rightside' valign='top'>" & vbCrLf
            Build_PDF_Column_Start = Build_PDF_Column_Start & "<table id='" & table_name & "_data_table' width='" & word_width & "' cellpadding='4'  valign='top' cellspacing='0'>" & vbCrLf
            Build_PDF_Column_Start = Build_PDF_Column_Start & "<tr><td colspan='" & num_columns & "' bgcolor='#CCCCCC' width='" & word_width & "'><strong>"
        Else
            Build_PDF_Column_Start = Build_PDF_Column_Start & "<table id='" & table_name & "_outer_table' width='100%'  cellpadding='1' cellspacing='0' class='module'>" & vbCrLf

            ' getting rid of the ugly blue for now 
            '  Build_PDF_Column_Start = Build_PDF_Column_Start & "<tr><td valign='top' align='left' class='header' style='padding-left:3px;'>" & table_title
            '
            '           If value_in_parens.ToString.Trim <> "" Then
            '           Build_PDF_Column_Start = Build_PDF_Column_Start & " <em>(" & value_in_parens & ")</em>"
            '       End If
            '
            '            Build_PDF_Column_Start = Build_PDF_Column_Start & "</td></tr>"


            Build_PDF_Column_Start = Build_PDF_Column_Start & "<tr><td valign='top' align='left'>"
            Build_PDF_Column_Start = Build_PDF_Column_Start & "<table id='" & table_name & "_inner_table' width='100%' cellpadding='1' cellspacing='0'>" & vbCrLf
            Build_PDF_Column_Start = Build_PDF_Column_Start & "<tr valign='top'><td class='rightside' valign='top'>" & vbCrLf
            Build_PDF_Column_Start = Build_PDF_Column_Start & "<table id='" & table_name & "_data_table' width='100%' cellpadding='4'  valign='top' cellspacing='0'>" & vbCrLf
            Build_PDF_Column_Start = Build_PDF_Column_Start & "<tr><td colspan='" & num_columns & "' bgcolor='#CCCCCC' width='100%'><strong>"
        End If



        If Table_sub_title.ToString.Trim <> "" Then
            Build_PDF_Column_Start = Build_PDF_Column_Start & Table_sub_title
        Else
            Build_PDF_Column_Start = Build_PDF_Column_Start & "&nbsp;"
        End If

        Build_PDF_Column_Start = Build_PDF_Column_Start & "</strong></td></tr>"

    End Function
    Public Function Build_PDF_Template_Footer() As String
        Build_PDF_Template_Footer = "</td></tr></table></td></tr></table></td></tr></table></td></tr></table>"
    End Function
    Public Function Build_SPI_PDF(ByVal real_make_model_name, ByVal amod_id, ByVal sub_info, ByVal sub_type, ByVal weight_class, ByVal weight_class_name, ByVal spi_year, ByVal spi_year2, ByVal airframe_type, ByVal quarter, ByVal first_model)
        Build_SPI_PDF = ""
        Dim page_count As Integer = 0
        Dim space_spot As Integer = 0
        Dim text_from_first As String = ""
        Dim color As String = "Blue"
        Dim sales_prices As String = ""
        Dim temp_header As String = ""

        color = Me.S_COL.SelectedValue.ToString
        Session("salesPriceViewWtCls") = weight_class
        Session("salesPriceViewWtClsName") = weight_class_name
        Session("SPSingleGraphType") = 4

        If first_model = True Then
            Session("SPYearSld1") = spi_year
        ElseIf amod_id > 0 Then
            Session("SPYearSld1") = 2005
        Else
            Session("SPYearSld1") = spi_year
        End If

        Session("SPYearSld2") = spi_year2
        Session("salesPriceViewMake") = real_make_model_name
        Session("salesPriceViewAirframeType") = airframe_type
        Session("SPYearQtr1") = quarter



        space_spot = InStr(real_make_model_name, " ")

        If space_spot > 0 Then
            Session("salesPriceViewMake") = Left(real_make_model_name, space_spot - 1)
            Session("salesPriceViewModel") = Right(real_make_model_name, (real_make_model_name.ToString.Length - space_spot))
        End If


        Build_SPI_PDF = Build_PDF_Template_Header_Final(WD).ToString ' style information

        If amod_id > 0 Then


            If page_count > 0 Then
                Build_SPI_PDF += Insert_Page_Break_PDF()
            End If
            temp_header += Build_PDF_Header_Final("Sales Price Index Report", sub_info, real_make_model_name, "", sub_type, "", "", "", True)
            temp_header += Build_PDF_Column_Start("", "Reported Sales Prices", "", "Reported Sales Prices", 7)
            Build_SPI_PDF += temp_header

            sales_prices = Session("SPI_Sale_Prices")
            sales_prices = Replace(sales_prices, "XXXX", Insert_Page_Break_PDF() & Build_PDF_Template_Header_Final(WD).ToString & temp_header)


            Build_SPI_PDF += sales_prices
            page_count = page_count + 1

            Build_SPI_PDF += Insert_Page_Break_PDF()
            Build_SPI_PDF += Build_PDF_Header_Final("Sales Price Index Report", sub_info, real_make_model_name, "", sub_type, "", "", "", True)
            Build_SPI_PDF += Build_PDF_Column_Start("", "FLEET SALES SUMMARY ", "", "FLEET SALES SUMMARY ", 7)
            Build_SPI_PDF += Session("SPI_Fleet_Sales")
            page_count = page_count + 1



            If Me.S_SM.Checked Then
                If page_count > 0 Then
                    Build_SPI_PDF += Insert_Page_Break_PDF()
                End If
                page_count = page_count + 1
                Build_SPI_PDF += Build_PDF_Header_Final("Sales Price Index Report", sub_info, real_make_model_name, "", sub_type, "", "", "", True)
                Build_SPI_PDF += Build_PDF_Column_Start("graphs_1", "Sales Price Index Report", "", "Sold Aircraft Information", 7)

                If Me.S_FQ.Checked Then
                    text_from_first = ReturnPreviousFullQuarterlyByWeightClass("", amod_id, "", "", "", weight_class, weight_class_name, spi_year, spi_year2, airframe_type, sub_info, real_make_model_name, sub_type, color)
                    text_from_first += "<br><br>"
                Else
                    Build_SPI_PDF += ReturnPreviousFullQuarterlyByWeightClass("", amod_id, "", "", "", weight_class, weight_class_name, spi_year, spi_year2, airframe_type, sub_info, real_make_model_name, sub_type, color)
                    Build_SPI_PDF += Build_PDF_Template_Footer()
                End If
            End If


            If Me.S_FQ.Checked Then
                If Not Me.S_SM.Checked Then
                    If page_count > 0 Then
                        Build_SPI_PDF += Insert_Page_Break_PDF()
                    End If
                    page_count = page_count + 1
                    Build_SPI_PDF += Build_PDF_Header_Final("Sales Price Index Report", sub_info, real_make_model_name, "", sub_type, "", "", "", True)
                End If
                Build_SPI_PDF += ReturnQuarterlyByModel(amod_id, "", text_from_first, sub_info, real_make_model_name, sub_type, weight_class, weight_class_name, spi_year, spi_year2, airframe_type, color)
                Build_SPI_PDF += Build_PDF_Template_Footer()
            End If

        Else


            If Me.S_FQ.Checked Then
                If page_count > 0 Then
                    Build_SPI_PDF += Insert_Page_Break_PDF()
                End If
                page_count = page_count + 1
                Build_SPI_PDF += Build_PDF_Header_Final("Sales Price Index Report", sub_info, real_make_model_name, "", sub_type, "", "", "", True)
                Build_SPI_PDF += Build_PDF_Column_Start("graphs_1", "Sales Price Index Report", "", "Sold Aircraft Information", 7)
                Build_SPI_PDF += ReturnQuarterlyWithoutModel(amod_id, "", text_from_first, sub_info, real_make_model_name, sub_type, weight_class, weight_class_name, spi_year, spi_year2, airframe_type, color)
                Build_SPI_PDF += Build_PDF_Template_Footer()
            End If

        End If


    End Function
    Private Sub Build_Financial_Documents_tab(ByRef searchCriteria As viewSelectionCriteriaClass, ByRef out_htmlString As String)

        Dim htmlOut As New StringBuilder


        Dim nRememberLastScale As Integer = 0
        Dim tmpStartDate As New Date
        Dim tmpEndDate As New Date
        Dim nScaleSets As Integer = 0
        Dim bShiftStartDate As Boolean = True
        Dim doc_view_header As String = ""
        Dim START_DATE As String = "1/1/2013"
        Dim END_DATE As String = "1/1/2014"
        Dim sHtmlLeasesPerMonthChart As String = ""
        Dim htmlModelDocuments As String = ""
        Dim clear_company_link As String = ""
        Dim clear_model_link As String = ""

        Try
            Dim localDatalayer As financial_view_functions

            localDatalayer = New financial_view_functions
            localDatalayer.adminConnectStr = Application.Item("crmClientSiteData").AdminDatabaseConn
            localDatalayer.clientConnectStr = Session.Item("localPreferences").UserDatabaseConn
            localDatalayer.starConnectStr = Session.Item("localPreferences").STARDatabaseConn
            localDatalayer.serverConnectStr = Session.Item("localPreferences").ServerNotesDatabaseConn
            searchCriteria.ViewCriteriaShowInternal = True
            If searchCriteria.ViewCriteriaTimeSpan = 0 Then
                searchCriteria.ViewCriteriaTimeSpan = 6
            End If

            END_DATE = Month(Date.Now.ToString) & "/1/" & Year(Date.Now)

            START_DATE = DateAdd(DateInterval.Month, -searchCriteria.ViewCriteriaTimeSpan, CDate(Month(Date.Now) & "/1/" & Year(Date.Now)))

            '  clear_company_link = "<a href='View_Template.aspx?ViewID=4&ViewName=Financial+Transaction+Documents&viewCompany=0&viewCity=" & searchCriteria.ViewCriteriaCity & "&viewCountry=" & searchCriteria.ViewCriteriaCountry & "&viewAirframe=" & searchCriteria.ViewCriteriaAirframeTypeStr & "&amod_id=" & searchCriteria.ViewCriteriaAmodID & "'>Clear Institution</a><br>"
            '  clear_model_link = "<a href='View_Template.aspx?ViewID=4&ViewName=Financial+Transaction+Documents&viewCompany=" & searchCriteria.ViewCriteriaCompanyID & "&viewCity=" & searchCriteria.ViewCriteriaCity & "&viewCountry=" & searchCriteria.ViewCriteriaCountry & "&viewAirframe=" & searchCriteria.ViewCriteriaAirframeTypeStr & "&amod_id=-1'>Clear Model</a>"
            clear_company_link = ""
            clear_model_link = ""

            ' nRememberLastScale = Session("documentsViewScaleSets")

            If nScaleSets > nRememberLastScale Then
                bShiftStartDate = True
            End If


            'Call DocViewDateRange(END_DATE, START_DATE, Session("documentsViewTimeScale"), searchCriteria.ViewCriteriaTimeSpan, nRememberLastScale, Session("isHeliOnlyProduct"))

            'Call localDatalayer.build_DocView_TabHeader(doc_view_header, START_DATE, END_DATE, searchCriteria, "")

            'htmlOut.Append("<table id='financialDocsViewOuterTable' width=""100%"" cellpadding=""0"" cellspacing=""0""><tr valign='top'><td align=""left"" valign=""top"">")
            'htmlOut.Append("<table id='financialDocsViewInnerTable' width=""100%"" cellpadding=""0"" cellspacing=""0""><tr valign='top'><td align=""left"">")

            'htmlOut.Append("<table id='financialDocsViewOuterTable' width='100%' cellpadding='2' cellspacing='0'>")
            'htmlOut.Append("<tr valign='top'><td align='left' valign='bottom'>")

            'htmlOut.Append("<table id='financialDocsViewLeftSideTable' width='100%' cellpadding='1' cellspacing='0'><tr valign='top'>")

            'If CLng(searchCriteria.ViewCriteriaCompanyID) > 0 Then
            '    htmlOut.Append(localDatalayer.display_top_financial_institutions(False, doc_view_header, 50, "", START_DATE, END_DATE, 6, 1, searchCriteria, "", ""))
            '    htmlOut.Append(clear_company_link)
            'Else
            '    htmlOut.Append(localDatalayer.display_top_financial_institutions(False, doc_view_header, 520, "", START_DATE, END_DATE, 6, 1, searchCriteria, "", ""))
            'End If

            'htmlOut.Append("</tr><tr valign='top'>")

            'If CLng(searchCriteria.ViewCriteriaAmodID) > 0 Then
            '    htmlOut.Append(localDatalayer.display_top_models(doc_view_header, 50, searchCriteria, "", searchCriteria.ViewCriteriaShowInternal, 1, "", START_DATE, END_DATE))
            '    htmlOut.Append("<tr valign='top'></td>")
            '    htmlOut.Append(clear_model_link)
            '    htmlOut.Append("</td></tr>")
            'ElseIf CLng(searchCriteria.ViewCriteriaCompanyID) > 0 Then
            '    htmlOut.Append(localDatalayer.display_top_models(doc_view_header, 490, searchCriteria, "", searchCriteria.ViewCriteriaShowInternal, 1, "", START_DATE, END_DATE))
            'Else
            '    htmlOut.Append(localDatalayer.display_top_models(doc_view_header, 520, searchCriteria, "", searchCriteria.ViewCriteriaShowInternal, 1, "", START_DATE, END_DATE))
            'End If

            'htmlOut.Append("</tr>")

            'If CLng(searchCriteria.ViewCriteriaAmodID) > 0 Then

            '    If Not Session("Aerodex") Then
            '        htmlOut.Append("<tr valign='top'><td align='left' valign='top'>")
            '        ' moved back into this page because of variables
            '        Call GetFleetInfo(searchCriteria.ViewCriteriaAmodID, False)
            '        htmlOut.Append(localDatalayer.GetMarketStatus(searchCriteria.ViewCriteriaAmodID, ac_for_sale, ac_exclusive_sale, ac_lease, per, per2, per3, avgyear, days, forsaleavlow, forsaleavghigh, Session.Item("localSubscription").crmAerodexFlag))
            '        htmlOut.Append("</td></tr>")
            '    End If

            '    htmlOut.Append("<tr valign='top'><td align='left' valign='top'>")

            '    AVG_PRICE_MONTH.Titles.Clear()
            '    AVG_PRICE_MONTH.Titles.Add("Avg Price By Month (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
            '    localDatalayer.views_display_avg_price_by_month_graph(searchCriteria, Me.AVG_PRICE_MONTH)
            '    AVG_PRICE_MONTH.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
            '    AVG_PRICE_MONTH.SaveImage(Server.MapPath("TempFiles") + "\" + searchCriteria.ViewCriteriaAmodID.ToString + "_AVG_PRICE_" + searchCriteria.ViewCriteriaTimeSpan.ToString + "_MONTHS.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)

            '    htmlOut.Append("<img src='TempFiles/" + searchCriteria.ViewCriteriaAmodID.ToString + "_AVG_PRICE_" + searchCriteria.ViewCriteriaTimeSpan.ToString + "_MONTHS.jpg' width='260' height='260'>")


            '    htmlOut.Append("<tr valign='top'><td align='left' valign='top'>")

            '    PER_MONTH.Titles.Clear()
            '    PER_MONTH.Titles.Add("Sold Per Month (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
            '    localDatalayer.views_display_sold_per_month_graph(searchCriteria, True, Me.PER_MONTH)
            '    PER_MONTH.ImageType = DataVisualization.Charting.ChartImageType.Jpeg

            '    PER_MONTH.SaveImage(Server.MapPath("TempFiles") + "\" + searchCriteria.ViewCriteriaAmodID.ToString + "_PER_" + searchCriteria.ViewCriteriaTimeSpan.ToString + "_MONTHS.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
            '    htmlOut.Append("<img src='TempFiles/" + searchCriteria.ViewCriteriaAmodID.ToString + "_PER_" + searchCriteria.ViewCriteriaTimeSpan.ToString + "_MONTHS.jpg' width='260' height='260'>")


            '    htmlOut.Append("</td></tr><tr><td align='left' valign='top'>")

            '    AVG_DAYS_ON.Titles.Clear()
            '    AVG_DAYS_ON.Titles.Add("Avg Days on Market (past " + searchCriteria.ViewCriteriaTimeSpan.ToString + " months)")
            '    localDatalayer.views_display_average_days_on_market_graph(searchCriteria, Me.AVG_DAYS_ON)

            '    AVG_DAYS_ON.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
            '    AVG_DAYS_ON.SaveImage(Server.MapPath("TempFiles") + "\" + searchCriteria.ViewCriteriaAmodID.ToString + "_AVG_DAYS_ON_" + searchCriteria.ViewCriteriaTimeSpan.ToString + "_MONTHS.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)

            '    htmlOut.Append("<img src='TempFiles/" + searchCriteria.ViewCriteriaAmodID.ToString + "_AVG_DAYS_ON_" + searchCriteria.ViewCriteriaTimeSpan.ToString + "_MONTHS.jpg' width='260' height='260'>")
            '    htmlOut.Append("</td></tr>")
            'End If

            'htmlOut.Append("</table></td>")

            'htmlOut.Append("<td width='33%' align='left' valign='top'>")
            'htmlOut.Append("<table id='financialDocsViewMiddleTable' width='100%' cellpadding='1' cellspacing='0'><tr valign='top'>")
            'htmlOut.Append(localDatalayer.display_documents_by_month(doc_view_header, 210, 4, searchCriteria, START_DATE, END_DATE, "", searchCriteria.ViewCriteriaShowInternal, 1, Me.DOCS_BY_MONTH_GRAPH))
            'htmlOut.Append("</tr><tr>")
            'htmlOut.Append(localDatalayer.view_display_types_of_documents(doc_view_header, "", 1, searchCriteria.ViewCriteriaShowInternal, "", START_DATE, END_DATE, searchCriteria))
            'htmlOut.Append("</tr>")

            'If CLng(searchCriteria.ViewCriteriaCompanyID) = 0 Then
            '    htmlOut.Append("<tr valign='top'>")
            '    doc_view_header = ""
            '    localDatalayer.views_display_leases_by_month_chart(searchCriteria, sHtmlLeasesPerMonthChart, Me.LEASES_SOLD_PER_MONTH)
            '    htmlOut.Append("<tr><td valign='top' align='center'>" & sHtmlLeasesPerMonthChart & "</td></tr>")
            '    htmlOut.Append(doc_view_header)
            '    htmlOut.Append("</tr><tr><td>")
            '    localDatalayer.views_display_leases_due_to_expire(searchCriteria, False, doc_view_header)
            '    htmlOut.Append(doc_view_header)
            '    htmlOut.Append("</td></tr><tr><td>")
            '    localDatalayer.views_display_leases_expired(searchCriteria, False, doc_view_header)
            '    htmlOut.Append(doc_view_header)
            '    htmlOut.Append("</td></tr></table></td>")
            'Else
            '    htmlOut.Append("</tr></table></td>")
            'End If

            'htmlOut.Append("<td width='33%' align='left' valign='top'>")
            htmlOut.Append("<table id='financialDocsViewRightTable' width='100%' cellpadding='1' cellspacing='0'>")
            htmlOut.Append("<tr><td>")

            searchCriteria.ViewCriteriaIsReport = True
            localDatalayer.views_display_transaction_documents(searchCriteria, htmlModelDocuments)
            htmlOut.Append(htmlModelDocuments)

            htmlOut.Append("</td></tr></table>")

            'htmlOut.Append("</td></tr></table>") ' inner view table
            'htmlOut.Append("</td></tr></table>") ' outter view table


            out_htmlString = htmlOut.ToString()
            htmlOut = Nothing

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "error in [Build_Documents_tab] : " + ex.Message
        End Try

    End Sub
    Public Function Build_Operator_PDF(ByVal real_company_name, ByVal comp_id, ByVal real_make_model_name, ByVal amod_id, ByVal sub_info, ByVal sub_type, ByVal selected_dropdown_code, ByVal engine_name) As String
        Dim page_count As Integer = 0
        Dim temp_title As String = ""
        Dim temp_returned As String = ""
        Dim pie_title_section As String = ""
        Dim temp_sub_title As String = ""
        Dim run_country As Boolean = True
        Dim total_count_op As Integer = 0
        Dim total_count_leased As Integer = 0

        Build_Operator_PDF = ""

        Build_Operator_PDF = Build_PDF_Template_Header_Final(WD).ToString ' style information



        '-------------------- 11/14/2011 - MSW --- IF THERE IS A MODEL AND A COMPANY AND BOTH ARE SELECTED, SHOW EVERYTHING ON PAGE 1 for picture and company info--------
        If Me.CP.Checked And Me.O_OS.Checked And amod_id > 0 And comp_id > 0 Then
            page_count = page_count + 1
            Build_Operator_PDF += Build_PDF_Header_Final("Operator Report", sub_info, real_make_model_name, real_company_name, sub_type, "", "", "", True)

            If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                Build_Operator_PDF += "<table align='center' width='" & word_width & "'><tr><td align='center'><br><br>"
            Else
                Build_Operator_PDF += "<table align='center' width='100%'><tr><td align='center'><br><br>"
            End If

            Build_Operator_PDF += check_model_pic_exists(amod_id, 500)
            Build_Operator_PDF += "</td></tr><tr><td><br>"
            Build_Operator_PDF += displayOperatorCompanies(real_company_name, real_make_model_name, selected_dropdown_code, engine_name, amod_id, comp_id, sub_info, sub_type)
            Build_Operator_PDF += get_company_cert_images(comp_id, True)
            Build_Operator_PDF += "</td></tr></table>"
            Build_Operator_PDF += Build_PDF_Template_Footer()
        ElseIf Me.CP.Checked And amod_id > 0 And Me.O_COUNTRY.Checked And comp_id = 0 Then
            run_country = False
            page_count = page_count + 1
            Build_Operator_PDF += Build_PDF_Header_Final("Operator Report", sub_info, real_make_model_name, real_company_name, sub_type, "", "", "", True)

            If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                Build_Operator_PDF += "<table align='center' valign='top' width='" & word_width & "'><tr><td align='center'><br>"
            Else
                Build_Operator_PDF += "<table align='center' valign='top' width='100%'><tr><td align='center'><br>"
            End If



            Build_Operator_PDF += check_model_pic_exists(amod_id, 500)
            If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                Build_Operator_PDF += "</td></tr><tr valign='top'><td colspan='2' width='" & word_width & "' valign='top'><br><br>"
            Else
                Build_Operator_PDF += "</td></tr><tr valign='top'><td colspan='2' width='95%' valign='top'><br><br>"
            End If



            '------------------------ section for count totals - MSW - 12/7/2011---------------------------------------
            total_count_op = (count_totals_ac_table(comp_id, amod_id, "operation", 1, sub_type))
            total_count_leased = (count_totals_ac_table(comp_id, amod_id, "leased", 1, sub_type))

            If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                Build_Operator_PDF += "<table width='" & word_width & "' cellspacing='0' cellpadding='2' class='module'>"
            Else
                Build_Operator_PDF += "<table width='100%' cellspacing='0' cellpadding='2' class='module'>"
            End If


            Build_Operator_PDF += "<tr><td align='left' colspan='3' valign='middle' class='header' style='padding-left:3px;'>Totals ( With or Without Operators )</td></tr>"
            Build_Operator_PDF += "<tr>"
            Build_Operator_PDF += "<td width='75%' class='rightside'>&nbsp;</td>"
            Build_Operator_PDF += "<td valign='top' width='40' align='center' class='border_bottom_right'>" & CStr(total_count_op) & "</td>"
            Build_Operator_PDF += "<td valign='middle' width='35' align='center' class='border_bottom'>" & CStr(total_count_leased) & "</td>"
            Build_Operator_PDF += "</tr><tr>"
            Build_Operator_PDF += "<td width='75%' class='rightside'>&nbsp;</td>"
            Build_Operator_PDF += "<td valign='middle' width='40' align='center' class='border_bottom_right'>Operation</td>"
            Build_Operator_PDF += "<td valign='middle' width='35' align='center' class='border_bottom'>Leased</td>"
            Build_Operator_PDF += "</tr><tr>"
            Build_Operator_PDF += "<tr><td colspan='' valign='middle' align='center'>"
            Build_Operator_PDF += "</td></tr></table><br><br>"
            '------------------------ section for count totals - MSW - 12/7/2011---------------------------------------


            ' this will do the actual work, make the chart and list, returns list, chart will be displayed later
            temp_returned = display_OperatorView_PieChart(real_make_model_name, "", 2, selected_dropdown_code, comp_id, amod_id)
            temp_title = "COUNTRY SUMMARY: " & real_make_model_name

            If selected_dropdown_code = "B" Then
                pie_title_section = "BUSINESS AIRCRAFT "
            ElseIf selected_dropdown_code = "C" Then
                pie_title_section = "COMMERCIAL AIRCRAFT"
            ElseIf selected_dropdown_code = "H" Then
                pie_title_section = "HELICOPTERS "
            Else
                pie_title_section = "BUSINESS AIRCRAFT "
            End If

            Me.OP_COUNTRY_CHART.Titles.Add(temp_title)
            Me.OP_COUNTRY_CHART.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
            Me.OP_COUNTRY_CHART.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" + amod_id.ToString + "_" & comp_id & "_" & "OP_COUNTRY_CHART.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
            ' the temp returned will hold the list of countries and numbers while the graph will display


            '  Build_Operator_PDF += "<table width='100%' align='center'>"
            If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                Build_Operator_PDF += "<table id='_outer_table' width='" & word_width & "'  cellpadding='1' cellspacing='0' class='module' valign='top'>" & vbCrLf
            Else
                Build_Operator_PDF += "<table id='_outer_table' width='100%'  cellpadding='1' cellspacing='0' class='module' valign='top'>" & vbCrLf
            End If


            Build_Operator_PDF += "<tr><td valign='top' align='left' class='header' style='padding-left:3px;' colspan='2'>"
            Build_Operator_PDF += real_make_model_name & ": COUNTRY SUMMARY"
            Build_Operator_PDF += "</td></tr>"
            Build_Operator_PDF += "<tr><td align='center'><img src='" + amod_id.ToString + "_" & comp_id & "_" & "OP_COUNTRY_CHART.jpg'></td><td align='left' valign='top'>"
            Build_Operator_PDF += "<table width='100%' valign='top' cellpadding='0' border='0' cellspacing='0'><tr valign='top'><td align='left' width='50%'><br><strong>Country</strong></td><td  width='50%' align='right'><br><strong># of Operators&nbsp;&nbsp;</strong></td></tr>"
            Build_Operator_PDF += "<tr valign='top'><td colspan='2' valign='top'>"
            Build_Operator_PDF += "<br>" & temp_returned
            Build_Operator_PDF += "</td></tr></table>"
            Build_Operator_PDF += "</td></tr></table>"
            Build_Operator_PDF += "</td></tr></table>"
            Build_Operator_PDF += Build_PDF_Template_Footer()

            If Me.O_OS.Checked Then     ' operator
                If page_count > 0 Then
                    Build_Operator_PDF += Insert_Page_Break_PDF()
                End If
                page_count = page_count + 1
                Build_Operator_PDF += Build_PDF_Header_Final("Operator Report", sub_info, real_make_model_name, real_company_name, sub_type, "", "", "", True)
                Build_Operator_PDF += displayOperatorCompanies(real_company_name, real_make_model_name, selected_dropdown_code, engine_name, amod_id, comp_id, sub_info, sub_type)
                If comp_id > 0 Then
                    Build_Operator_PDF += get_company_cert_images(comp_id, True)
                End If
                Build_Operator_PDF += Build_PDF_Template_Footer()
            End If


        Else
            If Me.CP.Checked And amod_id > 0 Then
                page_count = page_count + 1
                Build_Operator_PDF += Build_PDF_Header_Final("Operator Report", sub_info, real_make_model_name, real_company_name, sub_type, "", "", "", True)
                If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                    Build_Operator_PDF += "<table align='center' width='" & word_width & "'><tr><td align='center'><br><br>"
                Else
                    Build_Operator_PDF += "<table align='center' width='100%'><tr><td align='center'><br><br>"
                End If

                Build_Operator_PDF += check_model_pic_exists(amod_id, 500)
                Build_Operator_PDF += "</td></tr></table>"
                Build_Operator_PDF += Build_PDF_Template_Footer()
            End If


            If Me.O_OS.Checked Then     ' operator
                If page_count > 0 Then
                    Build_Operator_PDF += Insert_Page_Break_PDF()
                End If
                page_count = page_count + 1
                Build_Operator_PDF += Build_PDF_Header_Final("Operator Report", sub_info, real_make_model_name, real_company_name, sub_type, "", "", "", True)
                Build_Operator_PDF += displayOperatorCompanies(real_company_name, real_make_model_name, selected_dropdown_code, engine_name, amod_id, comp_id, sub_info, sub_type)
                If comp_id > 0 Then
                    Build_Operator_PDF += get_company_cert_images(comp_id, True)
                End If
                Build_Operator_PDF += Build_PDF_Template_Footer()
            End If

        End If






        If Me.O_MOD.Checked And amod_id = 0 Then
            If page_count > 0 Then
                Build_Operator_PDF += Insert_Page_Break_PDF()
            End If
            page_count = page_count + 1
            Build_Operator_PDF += Build_PDF_Header_Final("Operator Report", sub_info, real_make_model_name, real_company_name, sub_type, "", "", "", True)
            Build_Operator_PDF += displayAll_OP_Models(real_company_name, real_make_model_name, selected_dropdown_code, comp_id, amod_id, engine_name, sub_type, sub_info)
            Build_Operator_PDF += Build_PDF_Template_Footer()
        End If


        If Me.O_AC.Checked Then ' ac
            If page_count > 0 Then
                Build_Operator_PDF += Insert_Page_Break_PDF()
            End If
            page_count = page_count + 1
            Build_Operator_PDF += Build_PDF_Header_Final("Operator Report", sub_info, real_make_model_name, real_company_name, sub_type, "", "", "", True)
            Build_Operator_PDF += operator_display_aircraft(selected_dropdown_code, sub_info, real_make_model_name, real_company_name, sub_type, amod_id, engine_name, comp_id)
            Build_Operator_PDF += Build_PDF_Template_Footer()
        End If

        If Me.O_ENG.Checked And amod_id > 0 Then
            If page_count > 0 Then
                Build_Operator_PDF += Insert_Page_Break_PDF()
            End If
            page_count = page_count + 1
            Build_Operator_PDF += Build_PDF_Header_Final("Operator Report", sub_info, real_make_model_name, real_company_name, sub_type, "", "", "", True)
            Build_Operator_PDF += displayEngineInfo(real_company_name, real_make_model_name, engine_name, comp_id, amod_id)
            Build_Operator_PDF += Build_PDF_Template_Footer()
        End If



        If Me.O_COUNTRY.Checked And run_country = True Then
            If page_count > 0 Then
                Build_Operator_PDF += Insert_Page_Break_PDF()
            End If
            page_count = page_count + 1

            ' this will do the actual work, make the chart and list, returns list, chart will be displayed later
            temp_returned = display_OperatorView_PieChart(real_make_model_name, "", 2, selected_dropdown_code, comp_id, amod_id)

            If CLng(comp_id) > 0 Then
                temp_title = "CITY SUMMARY: " & real_make_model_name
            Else
                temp_title = "COUNTRY SUMMARY: " & real_make_model_name
            End If


            If selected_dropdown_code = "B" Then
                pie_title_section = "BUSINESS AIRCRAFT "
            ElseIf selected_dropdown_code = "C" Then
                pie_title_section = "COMMERCIAL AIRCRAFT"
            ElseIf selected_dropdown_code = "H" Then
                pie_title_section = "HELICOPTERS "
            Else
                pie_title_section = "BUSINESS AIRCRAFT "
            End If

            Me.OP_COUNTRY_CHART.Titles.Add(temp_title)
            Me.OP_COUNTRY_CHART.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
            Me.OP_COUNTRY_CHART.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" + amod_id.ToString + "_" & comp_id & "_" & "OP_COUNTRY_CHART.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
            ' the temp returned will hold the list of countries and numbers while the graph will display

            If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                temp_sub_title = "<table width='" & word_width & "' cellpadding='0' border='0' cellspacing='0'><tr><td align='left' width='" & word_half & "'><strong>Country</strong></td><td  width='" & word_half & "' align='right'><strong># of Operators</strong></td></tr></table>"
            Else
                temp_sub_title = "<table width='100%' cellpadding='0' border='0' cellspacing='0'><tr><td align='left' width='50%'><strong>Country</strong></td><td  width='50%' align='right'><strong># of Operators</strong></td></tr></table>"
            End If



            Build_Operator_PDF += Build_PDF_Header_Final("Operator Report", sub_info, real_make_model_name, real_company_name, sub_type, "", "", "", True)
            Build_Operator_PDF += Build_PDF_Column_Start("operator_country", temp_title, "", pie_title_section, 1)
            Build_Operator_PDF += ("<tr><td align='center'><img src='" + amod_id.ToString + "_" & comp_id & "_" & "OP_COUNTRY_CHART.jpg'></td></tr>")
            Build_Operator_PDF += Build_PDF_Column_2(temp_sub_title, 2, "operator_country_2")
            Build_Operator_PDF += temp_returned
            Build_Operator_PDF += Build_PDF_Template_Footer()
        End If


    End Function
    Public Function Build_Charter_PDF(ByVal real_company_name, ByVal comp_id, ByVal real_make_model_name, ByVal amod_id, ByVal sub_info, ByVal sub_type, ByVal airframe_type, ByVal real_country_name, ByVal real_city_name) As String

        ' this section determins if the function needs to be called based on the checkbox and then builds the page accordingly
        Dim page_count As Integer = 0

        Build_Charter_PDF = Build_PDF_Template_Header_Final(WD).ToString ' style information



        If Me.C_MPAS.Checked And amod_id > 0 Then
            page_count = page_count + 1
            Build_Charter_PDF += Build_PDF_Header_Final("Charter Report", sub_info, real_make_model_name, real_company_name, sub_type, real_country_name, real_city_name, airframe_type, False)
            Build_Charter_PDF += display_aircraft_summary(real_make_model_name, amod_id)
            Build_Charter_PDF += Build_PDF_Template_Footer()
        End If


        If Me.C_AC.Checked And (amod_id > 0 Or comp_id > 0 Or real_city_name <> "" Or real_country_name <> "") Then
            If page_count > 0 Then
                Build_Charter_PDF += Insert_Page_Break_PDF()
            End If
            page_count = page_count + 1
            Build_Charter_PDF += Build_PDF_Header_Final("Charter Report", sub_info, real_make_model_name, real_company_name, sub_type, real_country_name, real_city_name, airframe_type, False)
            Build_Charter_PDF += acContactType_fleet(amod_id, comp_id, real_make_model_name, real_company_name, airframe_type, real_country_name, real_city_name, sub_type, sub_info)
            Build_Charter_PDF += Build_PDF_Template_Footer()
        End If

        If Me.C_AF.Checked And amod_id = 0 Then
            If page_count > 0 Then
                Build_Charter_PDF += Insert_Page_Break_PDF()
            End If
            page_count = page_count + 1
            Build_Charter_PDF += Build_PDF_Header_Final("Charter Report", sub_info, real_make_model_name, real_company_name, sub_type, real_country_name, real_city_name, airframe_type, False)
            Build_Charter_PDF += acContactType_airframeType(amod_id, comp_id, airframe_type, real_country_name, real_city_name)
            Build_Charter_PDF += Build_PDF_Template_Footer()
        End If

        If Me.C_LOCITY.Checked And real_country_name.ToString.Trim <> "" And comp_id = 0 Then
            If page_count > 0 Then
                Build_Charter_PDF += Insert_Page_Break_PDF()
            End If
            page_count = page_count + 1
            Build_Charter_PDF += Build_PDF_Header_Final("Charter Report", sub_info, real_make_model_name, real_company_name, sub_type, real_country_name, real_city_name, airframe_type, False)
            Build_Charter_PDF += display_acContactType_location_piechart_city(comp_id, amod_id, airframe_type, real_country_name, " ORDER BY comp_city, comp_state asc ", sub_info, real_make_model_name, real_company_name, sub_type)
            Build_Charter_PDF += Build_PDF_Template_Footer()
        End If

        If Me.C_LOC.Checked And real_country_name.ToString.Trim = "" And real_city_name.ToString.Trim = "" And comp_id = 0 Then
            If page_count > 0 Then
                Build_Charter_PDF += Insert_Page_Break_PDF()
            End If
            page_count = page_count + 1
            Build_Charter_PDF += Build_PDF_Header_Final("Charter Report", sub_info, real_make_model_name, real_company_name, sub_type, real_country_name, real_city_name, airframe_type, False)
            Build_Charter_PDF += display_acContactType_location_piechart_country(comp_id, amod_id, airframe_type, " ORDER BY comp_country asc ", sub_info, real_make_model_name, real_company_name, sub_type)
            Build_Charter_PDF += Build_PDF_Template_Footer()

        End If

        If Me.C_MOD.Checked And amod_id = 0 Then
            If page_count > 0 Then
                Build_Charter_PDF += Insert_Page_Break_PDF()
            End If
            page_count = page_count + 1
            Build_Charter_PDF += Build_PDF_Header_Final("Charter Report", sub_info, real_make_model_name, real_company_name, sub_type, real_country_name, real_city_name, airframe_type, False)
            Build_Charter_PDF += acContactType_models(amod_id, comp_id, real_make_model_name, real_company_name, airframe_type, real_country_name, real_city_name, sub_type, sub_info)
            Build_Charter_PDF += Build_PDF_Template_Footer()

        End If

        If Me.C_OP.Checked And comp_id = 0 Then
            If page_count > 0 Then
                Build_Charter_PDF += Insert_Page_Break_PDF()
            End If
            page_count = page_count + 1
            Build_Charter_PDF += Build_PDF_Header_Final("Charter Report", sub_info, real_make_model_name, real_company_name, sub_type, real_country_name, real_city_name, airframe_type, False)
            Build_Charter_PDF += acContactType_companies(amod_id, real_make_model_name, comp_id, airframe_type, real_country_name, real_city_name, sub_info, real_company_name, sub_type)
            Build_Charter_PDF += Build_PDF_Template_Footer()
        End If






    End Function
    Function Build_Financial_PDF(ByVal real_company_name, ByVal comp_id, ByVal real_make_model_name, ByVal amod_id, ByVal sub_info, ByVal sub_type, ByVal airframe_type, ByVal selected_product_code_from_drop_down, ByVal real_country_name, ByVal real_city_name, ByVal months_count, ByVal make_name)
        Dim page_count As Integer = 0
        Dim make_model_or_make_for_title As String = ""
        If make_name <> "" Then
            make_model_or_make_for_title = make_name
        ElseIf real_make_model_name <> "" Then
            make_model_or_make_for_title = real_make_model_name
        End If

        If months_count = 0 Then
            months_count = 6
        End If

        If airframe_type <> "" Then
            If IsNumeric(airframe_type) Then
                If airframe_type = 0 Then
                    airframe_type = ""
                ElseIf airframe_type = 1 Then
                    airframe_type = "E"
                ElseIf airframe_type = 2 Then
                    airframe_type = "J"
                ElseIf airframe_type = 3 Then
                    airframe_type = "T"
                ElseIf airframe_type = 4 Then
                    airframe_type = "P"
                End If
            Else

            End If
        End If


        Build_Financial_PDF = Build_PDF_Template_Header_Final(WD).ToString ' style information


        ' IF THERE IS A MODEL, COMBINE THE FIRST AND SECOND PAGE -------------------------
        If amod_id > 0 And Me.CP.Checked Then
            If Me.CP.Checked Then
                page_count = page_count + 1
                If (amod_id > 0) Then
                    Build_Financial_PDF += Build_PDF_Header_Final("Financial Report", sub_info, make_model_or_make_for_title, real_company_name, sub_type, real_country_name, real_city_name, airframe_type, False)
                    Build_Financial_PDF += "<table width='90%' align='center'><tr><td align='center'><br>"
                    Build_Financial_PDF += check_model_pic_exists(amod_id, 340)
                    Build_Financial_PDF += "<br><br></td></tr></table>"



                    If Me.MMS_FMS.Checked Then
                        Build_Financial_PDF += "<tr><td valign='top' align='center' class='tabheader'><strong>" & real_make_model_name & ": Fleet Market Summary</strong></td><td class='border_bottom' width='20%'>&nbsp;</td></tr>"
                        Build_Financial_PDF += "<tr><td class='rightside' colspan='2'>"
                        Build_Financial_PDF += "<table width='100%' cellpadding='4' cellspacing='0'>"

                        Build_Financial_PDF += Build_FleetMarketSummary(amod_id, False, real_make_model_name, "", "N", localCriteria)
                        Build_Financial_PDF += "</td><td>"
                        Me.PER_MONTH.Titles.Add(display_sold_per_month_graph(False, False, amod_id, PER_MONTH, months_count, True, ""))
                        Me.PER_MONTH.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" + amod_id.ToString + "_PER_MONTH.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
                        Build_Financial_PDF += "<img src='" + amod_id.ToString + "_PER_MONTH.jpg'>"
                        Build_Financial_PDF += "</td></tr></table></td></tr>"

                    End If

                    If Me.F_DM.Checked Then
                        Build_Financial_PDF += "<tr><td class='rightside' colspan='3'>"
                        Build_Financial_PDF += "<table width='100%' cellpadding='4' cellspacing='0'>"
                        Build_Financial_PDF += display_market_up_down_one_model(50, real_make_model_name, amod_id, months_count, airframe_type, selected_product_code_from_drop_down)
                        Build_Financial_PDF += "</td></tr></table></td></tr>"
                    End If


                    Build_Financial_PDF += Build_PDF_Template_Footer()
                End If
            End If



        Else

            If Me.MMS_FMS.Checked And amod_id > 0 Then
                If page_count > 0 Then
                    Build_Financial_PDF += Insert_Page_Break_PDF()
                End If
                Build_Financial_PDF += Build_PDF_Header_Final("Financial Report", sub_info, make_model_or_make_for_title, real_company_name, sub_type, real_country_name, real_city_name, airframe_type, False)

                Build_Financial_PDF += "<table id='displayTransactionDocumentsOuterTable' width='100%' height='500' cellpadding='1' cellspacing='0' class='module'>"
                Build_Financial_PDF += "<tr><td valign='top' align='left' colspan='2' class='header' style='padding-left:3px;'>Fleet Market Summary</td></tr>"

                Build_Financial_PDF += "<tr><td><table id='displayExpiredLeasesOuterTable' width='100%' height='' cellpadding='1' cellspacing='0' class='module'> "

                Build_Financial_PDF += "<tr><td valign='top' align='left'><table  width='100%' cellpadding='1' cellspacing='0'>"
                Build_Financial_PDF += "<tr><td valign='top' align='left' class='tabheader'><strong>" & real_make_model_name & "<br>Fleet Market Summary</strong></td><td class='border_bottom' width='20%'>&nbsp;</td></tr>"
                Build_Financial_PDF += "<tr><td class='rightside' colspan='2'>"
                Build_Financial_PDF += "<table width='100%' cellpadding='4' cellspacing='0'>"

                Build_Financial_PDF += Build_FleetMarketSummary(amod_id, False, real_make_model_name, "", "N", localCriteria)
                Build_Financial_PDF += "</td><td>"
                Me.PER_MONTH.Titles.Add(display_sold_per_month_graph(False, False, amod_id, PER_MONTH, months_count, True, ""))
                Me.PER_MONTH.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" + amod_id.ToString + "_PER_MONTH.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
                Build_Financial_PDF += "<img src='" + amod_id.ToString + "_PER_MONTH.jpg'>"
                Build_Financial_PDF += Build_PDF_Template_Footer()
                Build_Financial_PDF += "</td></tr></table></td></tr></table>"
            End If


            If Me.F_DM.Checked Then
                If page_count > 0 Then
                    Build_Financial_PDF += Insert_Page_Break_PDF()
                End If
                page_count = page_count + 1
                Build_Financial_PDF += Build_PDF_Header_Final("Financial Report", sub_info, real_make_model_name, real_company_name, sub_type, "", "", "", True)
                If amod_id > 0 Then
                    Build_Financial_PDF += display_market_up_down_one_model(500, real_make_model_name, amod_id, months_count, airframe_type, selected_product_code_from_drop_down)
                Else
                    Build_Financial_PDF += display_market_up_down(500, real_make_model_name, amod_id, months_count, airframe_type, selected_product_code_from_drop_down, sub_info, real_company_name, sub_type, make_name, make_model_or_make_for_title)
                End If
                Build_Financial_PDF += Build_PDF_Template_Footer()
            End If
        End If






        '----------------------- SECTIONS ALSO INCLUDED IN OTHER PDFS ----------
        If L_LE.Checked Then
            If page_count > 0 Then
                Build_Financial_PDF += Insert_Page_Break_PDF()
            End If
            page_count = page_count + 1
            Build_Financial_PDF += Build_PDF_Header_Final("Financial Aircraft", sub_info, real_make_model_name, real_company_name, sub_type, "", "", "", True)
            Build_Financial_PDF += display_leases_expired("", real_company_name, real_make_model_name, amod_id, comp_id, False, airframe_type, sub_info, sub_type, selected_product_code_from_drop_down, months_count, make_name, make_model_or_make_for_title)
            Build_Financial_PDF += Build_PDF_Template_Footer()
        End If


        If Me.L_LDTE.Checked Then
            If page_count > 0 Then
                Build_Financial_PDF += Insert_Page_Break_PDF()
            End If
            page_count = page_count + 1
            Build_Financial_PDF += Build_PDF_Header_Final("Financial Report", sub_info, real_make_model_name, real_company_name, sub_type, "", "", "", True)
            Build_Financial_PDF += display_leases_due_to_expire("", real_company_name, real_make_model_name, amod_id, comp_id, False, airframe_type, selected_product_code_from_drop_down, months_count, sub_info, sub_type, make_name, make_model_or_make_for_title)
            Build_Financial_PDF += Build_PDF_Template_Footer()
        End If
        '----------------------- SECTIONS ALSO INCLUDED IN OTHER PDFS ----------


        If Me.F_DTD.Checked Then
            If page_count > 0 Then
                Build_Financial_PDF += Insert_Page_Break_PDF()
            End If
            page_count = page_count + 1
            Build_Financial_PDF += Build_PDF_Header_Final("Financial Report", sub_info, real_make_model_name, real_company_name, sub_type, "", "", "", True)
            Build_Financial_PDF += display_transaction_documents(amod_id, 500, real_city_name, real_country_name, "", comp_id, real_make_model_name, months_count, sub_info, real_company_name, sub_type, make_name, make_model_or_make_for_title, selected_product_code_from_drop_down, airframe_type)
            Build_Financial_PDF += Build_PDF_Template_Footer()
        End If

        If Me.F_DTD.Checked Then
            If page_count > 0 Then
                Build_Financial_PDF += Insert_Page_Break_PDF()
            End If
            page_count = page_count + 1
            Build_Financial_PDF += Build_PDF_Header_Final("Financial Report", sub_info, real_make_model_name, real_company_name, sub_type, "", "", "", True)
            Build_Financial_PDF += display_top_financial_institutions("", 500, real_make_model_name, amod_id, months_count, airframe_type, sub_info, real_company_name, sub_type, make_name, make_model_or_make_for_title, selected_product_code_from_drop_down)
            Build_Financial_PDF += Build_PDF_Template_Footer()
        End If



        If Me.F_DFS.Checked Then
            If page_count > 0 Then
                Build_Financial_PDF += Insert_Page_Break_PDF()
            End If
            page_count = page_count + 1
            Build_Financial_PDF += Build_PDF_Header_Final("Financial Report", sub_info, real_make_model_name, real_company_name, sub_type, "", "", "", True)
            Build_Financial_PDF += display_for_sale("", 400, 3, amod_id, real_make_model_name, months_count, airframe_type, selected_product_code_from_drop_down, make_name, make_model_or_make_for_title)
            Build_Financial_PDF += Build_PDF_Template_Footer()
        End If


        If Me.F_DSPM.Checked And Me.F_LTG.Checked And amod_id = 0 Then
            If page_count > 0 Then
                Build_Financial_PDF += Insert_Page_Break_PDF()
            End If
            Build_Financial_PDF += Build_PDF_Header_Final("Financial Report", sub_info, real_make_model_name, real_company_name, sub_type, "", "", "", True)
            Build_Financial_PDF += "<table width='100% align='center'><tr><td align='center'>"
            Build_Financial_PDF += display_sold_per_month(400, real_make_model_name, amod_id, months_count, airframe_type, selected_product_code_from_drop_down, make_name, make_model_or_make_for_title)
            Build_Financial_PDF += "</td></tr><tr><td>"
            Build_Financial_PDF += display_leased_per_month(400, real_make_model_name, amod_id, months_count, airframe_type, selected_product_code_from_drop_down, make_name, make_model_or_make_for_title)
            Build_Financial_PDF += "</td></tr></tablle>"

        Else
            If amod_id = 0 Then
                If Me.F_DSPM.Checked Then
                    If page_count > 0 Then
                        Build_Financial_PDF += Insert_Page_Break_PDF()
                    End If
                    page_count = page_count + 1
                    Build_Financial_PDF += Build_PDF_Header_Final("Financial Report", sub_info, real_make_model_name, real_company_name, sub_type, "", "", "", True)
                    Build_Financial_PDF += display_sold_per_month(500, real_make_model_name, amod_id, months_count, airframe_type, selected_product_code_from_drop_down, make_name, make_model_or_make_for_title)
                    Build_Financial_PDF += Build_PDF_Template_Footer()
                End If
            End If

            If Me.F_LTG.Checked Then
                If page_count > 0 Then
                    Build_Financial_PDF += Insert_Page_Break_PDF()
                End If
                Build_Financial_PDF += Build_PDF_Header_Final("Financial Report", sub_info, real_make_model_name, real_company_name, sub_type, "", "", "", True)
                Build_Financial_PDF += display_leased_per_month(500, real_make_model_name, amod_id, months_count, airframe_type, selected_product_code_from_drop_down, make_name, make_model_or_make_for_title)
                Build_Financial_PDF += Build_PDF_Template_Footer()
            End If
        End If



        If Me.F_NVU.Checked Then
            If page_count > 0 Then
                Build_Financial_PDF += Insert_Page_Break_PDF()
            End If
            Build_Financial_PDF += Build_PDF_Header_Final("Financial Report", sub_info, real_make_model_name, real_company_name, sub_type, "", "", "", True)
            Build_Financial_PDF += display_new_vs_used_piechart(500, real_make_model_name, amod_id, months_count, airframe_type, selected_product_code_from_drop_down, make_name, make_model_or_make_for_title)
            Build_Financial_PDF += Build_PDF_Template_Footer()
        End If

    End Function
    Public Function Build_Lease_PDF(ByVal real_company_name, ByVal comp_id, ByVal real_make_model_name, ByVal amod_id, ByVal sub_info, ByVal sub_type, ByVal airframe_type, ByVal selected_product_code_from_drop_down) As String
        Dim text_for_graph_title As String = ""
        Dim temp_business_type As String = ""
        Dim temp_airframe_Type As String = ""
        Dim page_count As Integer = 0

        temp_business_type = sub_type


        Build_Lease_PDF = Build_PDF_Template_Header_Final(WD).ToString ' style information


        If Me.CP.Checked Then
            ' PAGE 1 --------------------------------------------------------------------------------------------------------



            Build_Lease_PDF += Build_PDF_Header_Final("Leased Aircraft", sub_info, real_make_model_name, real_company_name, temp_business_type, "", "", "", True) ' grey header


            Build_Lease_PDF += "<table width='100%'><tr><td width='50%' align='center'>"
            If (amod_id > 0) Then
                Build_Lease_PDF += check_model_pic_exists(amod_id, 400)
            Else

            End If
            Build_Lease_PDF += "</td><td width='50%' align='center'>"

            '-------- Graph--------g
            text_for_graph_title = display_leases_sold_by_month("", 195, real_company_name, real_make_model_name, amod_id, comp_id, airframe_type, selected_product_code_from_drop_down)

            If text_for_graph_title <> "" Then
                Me.AVG_SOLD_PER_MONTH.Titles.Add(text_for_graph_title)
                Me.AVG_SOLD_PER_MONTH.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                Me.AVG_SOLD_PER_MONTH.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" + amod_id.ToString + "AVG_SOLD_PER_MONTH.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
                Build_Lease_PDF += ("<img src='" + amod_id.ToString + "AVG_SOLD_PER_MONTH.jpg'>")
            Else
                Build_Lease_PDF += "There Are No Leases Sold In The Last 6 Months"
            End If

            '------- Graph---------

            Build_Lease_PDF += "</td></tr><tr><td align='center'>&nbsp;"

            Build_Lease_PDF += "</td><td align='center'>"

            Build_Lease_PDF += lease_market_status_block(real_company_name, real_make_model_name, amod_id, comp_id, airframe_type, selected_product_code_from_drop_down)
            Build_Lease_PDF += Build_PDF_Template_Footer()
            page_count = page_count + 1
            ' PAGE 1 --------------------------------------------------------------------------------------------------------
        End If

        If Me.L_TL.Checked And comp_id = 0 Then
            If page_count > 0 Then
                Build_Lease_PDF += Insert_Page_Break_PDF()
            End If
            page_count = page_count + 1
            Build_Lease_PDF += Build_PDF_Header_Final("Leased Aircraft", sub_info, real_make_model_name, real_company_name, temp_business_type, "", "", "", True)
            Build_Lease_PDF += display_top_lessors(real_company_name, real_make_model_name, amod_id, comp_id, airframe_type, selected_product_code_from_drop_down)
            Build_Lease_PDF += Build_PDF_Template_Footer()
        End If


        If Me.L_TM.Checked And amod_id = 0 Then
            If page_count > 0 Then
                Build_Lease_PDF += Insert_Page_Break_PDF()
            End If
            page_count = page_count + 1
            Build_Lease_PDF += Build_PDF_Header_Final("Leased Aircraft", sub_info, real_make_model_name, real_company_name, temp_business_type, "", "", "", True)
            Build_Lease_PDF += display_models_leased_list(real_company_name, real_make_model_name, amod_id, comp_id, airframe_type, selected_product_code_from_drop_down)
            Build_Lease_PDF += Build_PDF_Template_Footer()
        End If


        If Me.L_AL.Checked And (amod_id > 0 Or comp_id > 0) Then
            If page_count > 0 Then
                Build_Lease_PDF += Insert_Page_Break_PDF()
            End If
            page_count = page_count + 1
            Build_Lease_PDF += Build_PDF_Header_Final("Leased Aircraft", sub_info, real_make_model_name, real_company_name, temp_business_type, "", "", "", True)
            Build_Lease_PDF += displayLeasedAircraft(amod_id, comp_id, sub_info, real_make_model_name, real_company_name, sub_type, airframe_type, temp_business_type, selected_product_code_from_drop_down)
            Build_Lease_PDF += Build_PDF_Template_Footer()
        End If

        If Me.L_MRT.Checked Then
            If page_count > 0 Then
                Build_Lease_PDF += Insert_Page_Break_PDF()
            End If
            page_count = page_count + 1
            Build_Lease_PDF += Build_PDF_Header_Final("Leased Aircraft", sub_info, real_make_model_name, real_company_name, temp_business_type, "", "", "", True)
            Build_Lease_PDF += most_recent_lease_trans(real_company_name, real_make_model_name, amod_id, comp_id, sub_info, sub_type, airframe_type, temp_business_type, selected_product_code_from_drop_down)
            Build_Lease_PDF += Build_PDF_Template_Footer()
        End If


        If L_LE.Checked Then
            If page_count > 0 Then
                Build_Lease_PDF += Insert_Page_Break_PDF()
            End If
            page_count = page_count + 1
            Build_Lease_PDF += Build_PDF_Header_Final("Leased Aircraft", sub_info, real_make_model_name, real_company_name, temp_business_type, "", "", "", True)
            Build_Lease_PDF += display_leases_expired("", real_company_name, real_make_model_name, amod_id, comp_id, False, airframe_type, sub_info, temp_business_type, selected_product_code_from_drop_down, 6, "", real_make_model_name)
            Build_Lease_PDF += Build_PDF_Template_Footer()
        End If

        If L_LDTE.Checked Then
            If page_count > 0 Then
                Build_Lease_PDF += Insert_Page_Break_PDF()
            End If
            page_count = page_count + 1
            Build_Lease_PDF += Build_PDF_Header_Final("Leased Aircraft", sub_info, real_make_model_name, real_company_name, temp_business_type, "", "", "", True)
            Build_Lease_PDF += display_leases_due_to_expire("", real_company_name, real_make_model_name, amod_id, comp_id, False, airframe_type, selected_product_code_from_drop_down, 1, sub_info, sub_type, "", real_make_model_name)
            Build_Lease_PDF += Build_PDF_Template_Footer()
        End If





    End Function

    Function display_market_up_down(ByVal table_height As Integer, ByVal real_make_model_name As String, ByVal amod_id As Integer, ByVal marketViewTimeSpan As Integer, ByVal airframe_type As String, ByVal product_codes As String, ByVal sub_info As String, ByVal real_company_name As String, ByVal sub_type As String, ByVal make_name As String, ByVal make_item_to_pass_to_header As String)
        display_market_up_down = ""

        Dim last_year_diff As Double = 0
        Dim last_month_diff As Double = 0
        Dim last_year_percentage As Double = 0
        Dim last_month_percentage As Double = 0
        Dim sum_current_for_sale As Integer = 0
        Dim sum_pastyear_gain_loss As Integer = 0
        Dim sum_pastmonth_gain_loss As Integer = 0
        Dim sum_LastMonth As Integer = 0
        Dim sum_LastYear As Integer = 0
        Dim nMonthOffset As Integer = 0
        Dim query As String = ""
        Dim outstring As String = ""
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim rs As System.Data.SqlClient.SqlDataReader : rs = Nothing
        Dim currentDate_Month As Integer = 0
        Dim currentDate_Year As Integer = 0
        Dim start_string As String = ""
        Dim page_break_counter As Integer = 0

        Try
            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60



            nMonthOffset = -1
            display_market_up_down = ""

            ' check for missing data

            query = "SELECT SUM(mtrend_total_aircraft_for_sale) AS pastmonthforsale FROM Aircraft_Model_Trend WITH(NOLOCK)"
            query = query & " INNER JOIN Aircraft_Model WITH(NOLOCK) ON mtrend_amod_id = amod_id"
            query = query & " WHERE (mtrend_year = " & Year(Now) & " AND mtrend_month = " & Month(DateAdd("m", -1, Now)) & ")"

            SqlCommand.CommandText = query
            rs = SqlCommand.ExecuteReader()
            If rs.HasRows Then
                rs.Read()
                If IsDBNull(rs("pastmonthforsale")) Then
                    nMonthOffset = -2
                End If
            End If
            rs.Close()
            rs.Dispose()
            rs = Nothing

            If Trim(make_name) = "" And amod_id = 0 Then

                query = "SELECT amod_make_name, count(*) as currentforsale,"
                query = query & "(select SUM(mtrend_total_aircraft_for_sale) FROM Aircraft_Model_Trend WITH(NOLOCK) INNER JOIN"
                query = query & " Aircraft_Model WITH(NOLOCK) ON mtrend_amod_id = amod_id"

                If Trim(airframe_type) <> "" Then
                    query = query & " AND amod_type_code = '" & Trim(airframe_type) & "'"
                End If



                If product_codes.ToString.Trim <> "" Then
                    If product_codes.ToString.Trim = "B" Then
                        query = query & " AND amod_product_business_flag='Y' "
                    ElseIf product_codes.ToString.Trim = "C" Then
                        query = query & " AND amod_product_commercial_flag='Y' "
                    ElseIf product_codes.ToString.Trim = "H" Then
                        query = query & " AND amod_product_helicopter_flag='Y' "
                    End If
                End If


                currentDate_Month = Month(DateAdd("m", (-1) * marketViewTimeSpan, Now))
                currentDate_Year = Year(DateAdd("m", (-1) * marketViewTimeSpan, Now))

                query = query & " WHERE amod_make_name = a.amod_make_name AND (mtrend_year = " & currentDate_Year & ") AND (mtrend_month = " & currentDate_Month & ")) AS pastyearforsale,"

                query = query & " (select SUM(mtrend_total_aircraft_for_sale) FROM Aircraft_Model_Trend WITH(NOLOCK) INNER JOIN"
                query = query & " Aircraft_Model WITH(NOLOCK) ON mtrend_amod_id = amod_id"


                If Trim(airframe_type) <> "" Then
                    query = query & " AND amod_type_code = '" & Trim(airframe_type) & "'"
                End If




                If product_codes.ToString.Trim <> "" Then
                    If product_codes.ToString.Trim = "B" Then
                        query = query & " AND amod_product_business_flag='Y' "
                    ElseIf product_codes.ToString.Trim = "C" Then
                        query = query & " AND amod_product_commercial_flag='Y' "
                    ElseIf product_codes.ToString.Trim = "H" Then
                        query = query & " AND amod_product_helicopter_flag='Y' "
                    End If
                End If


                currentDate_Month = Month(DateAdd("m", nMonthOffset, Now))
                currentDate_Year = Year(DateAdd("m", nMonthOffset, Now))

                query = query & " WHERE amod_make_name = a.amod_make_name AND (mtrend_year = " & currentDate_Year & ") AND (mtrend_month = " & currentDate_Month & ")) AS pastmonthforsale"

                query = query & " FROM aircraft WITH(NOLOCK) INNER JOIN aircraft_model AS A WITH(NOLOCK) ON ac_amod_id = amod_id"
                query = query & " WHERE ac_forsale_flag = 'Y' AND ac_journ_id = 0"

                ' query = query & commonEVO.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, True)
                query = query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, True)


                If Trim(airframe_type) <> "" Then
                    query = query & " AND amod_type_code = '" & Trim(airframe_type) & "'"
                End If




                If product_codes.ToString.Trim <> "" Then
                    If product_codes.ToString.Trim = "B" Then
                        query = query & " AND amod_product_business_flag='Y' "
                    ElseIf product_codes.ToString.Trim = "C" Then
                        query = query & " AND amod_product_commercial_flag='Y' "
                    ElseIf product_codes.ToString.Trim = "H" Then
                        query = query & " AND amod_product_helicopter_flag='Y' "
                    End If
                End If



                query = query & " GROUP BY amod_make_name ORDER by amod_make_name ASC"

            Else

                query = "SELECT amod_make_name, amod_model_name, amod_id, count(*) as currentforsale,"
                query = query & "(select SUM(mtrend_total_aircraft_for_sale) FROM Aircraft_Model_Trend WITH(NOLOCK) INNER JOIN"
                query = query & " Aircraft_Model WITH(NOLOCK) ON mtrend_amod_id = amod_id"

                If Trim(make_name) <> "" Then
                    query = query & " AND amod_make_name = '" & Trim(make_name) & "'"
                End If

                If Trim(airframe_type) <> "" Then
                    query = query & " AND amod_type_code = '" & Trim(airframe_type) & "'"
                End If




                If product_codes.ToString.Trim <> "" Then
                    If product_codes.ToString.Trim = "B" Then
                        query = query & " AND amod_product_business_flag='Y' "
                    ElseIf product_codes.ToString.Trim = "C" Then
                        query = query & " AND amod_product_commercial_flag='Y' "
                    ElseIf product_codes.ToString.Trim = "H" Then
                        query = query & " AND amod_product_helicopter_flag='Y' "
                    End If
                End If


                currentDate_Month = Month(DateAdd("m", (-1) * marketViewTimeSpan, Now))
                currentDate_Year = Year(DateAdd("m", (-1) * marketViewTimeSpan, Now))

                query = query & " WHERE (amod_make_name = a.amod_make_name AND amod_model_name = a.amod_model_name) AND (mtrend_year = " & currentDate_Year & ") AND (mtrend_month = " & currentDate_Month & ")) AS pastyearforsale,"

                query = query & " (select SUM(mtrend_total_aircraft_for_sale) FROM Aircraft_Model_Trend WITH(NOLOCK) INNER JOIN"
                query = query & " Aircraft_Model WITH(NOLOCK) ON mtrend_amod_id = amod_id"

                If Trim(make_name) <> "" Then
                    query = query & " AND amod_make_name = '" & Trim(make_name) & "'"
                End If

                If Trim(airframe_type) <> "" Then
                    query = query & " AND amod_type_code = '" & Trim(airframe_type) & "'"
                End If



                If product_codes.ToString.Trim <> "" Then
                    If product_codes.ToString.Trim = "B" Then
                        query = query & " AND amod_product_business_flag='Y' "
                    ElseIf product_codes.ToString.Trim = "C" Then
                        query = query & " AND amod_product_commercial_flag='Y' "
                    ElseIf product_codes.ToString.Trim = "H" Then
                        query = query & " AND amod_product_helicopter_flag='Y' "
                    End If
                End If



                currentDate_Month = Month(DateAdd("m", nMonthOffset, Now))
                currentDate_Year = Year(DateAdd("m", nMonthOffset, Now))

                query = query & " WHERE (amod_make_name = a.amod_make_name AND amod_model_name = a.amod_model_name) AND (mtrend_year = " & currentDate_Year & ") AND (mtrend_month = " & currentDate_Month & ")) AS pastmonthforsale"

                query = query & " FROM aircraft WITH(NOLOCK) INNER JOIN aircraft_model AS A WITH(NOLOCK) ON ac_amod_id = amod_id"
                query = query & " WHERE ac_forsale_flag = 'Y' AND ac_journ_id = 0"

                ' query = query & commonEVO.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, True)
                query = query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, True)

                If Trim(make_name) <> "" Then
                    query = query & " AND amod_make_name = '" & Trim(make_name) & "'"
                End If


                If Trim(airframe_type) <> "" Then
                    query = query & " AND amod_type_code = '" & Trim(airframe_type) & "'"
                End If




                If product_codes.ToString.Trim <> "" Then
                    If product_codes.ToString.Trim = "B" Then
                        query = query & " AND amod_product_business_flag='Y' "
                    ElseIf product_codes.ToString.Trim = "C" Then
                        query = query & " AND amod_product_commercial_flag='Y' "
                    ElseIf product_codes.ToString.Trim = "H" Then
                        query = query & " AND amod_product_helicopter_flag='Y' "
                    End If
                End If


                If Trim(make_name) = "" And CLng(amod_id) = 0 Then
                    query = query & " GROUP BY amod_make_name ORDER by amod_make_name ASC"
                Else
                    query = query & " GROUP BY amod_make_name, amod_model_name, amod_id ORDER BY amod_make_name, amod_model_name, amod_id"
                End If

            End If

            If Session("debug") Then
                Response.Write("<b>display_market_up_down:" & Server.HtmlEncode(query) & "</b><br /><br />")
            End If

            SqlCommand.CommandText = query
            rs = SqlCommand.ExecuteReader()

            Dim sixSelected As String = ""
            Dim twelveSelected As String = ""
            If marketViewTimeSpan = 6 Then sixSelected = " checked='checked'"
            If marketViewTimeSpan = 12 Then twelveSelected = " checked='checked'"

            start_string = "<table width='100%' height='" & table_height & "' cellpadding='1' cellspacing='0' class='module'>" & vbCrLf
            start_string = start_string & "<tr><td valign='middle' align='left' class='header' style='padding-left:3px; height:24px;'>AIRCRAFT FOR SALE MARKET TRENDS BY MAKE</td>"
            start_string = start_string & "<td valign='middle' align='right' class='header' style='padding-left:3px; height:24px;'>" & marketViewTimeSpan & " MONTHS&nbsp;</td></tr>" & vbCrLf
            start_string = start_string & "<tr><td valign='top' align='left' colspan='2'><table width='100%' cellpadding='1' cellspacing='0'>" & vbCrLf
            start_string = start_string & "<tr><td valign='bottom' align='left' class='seperator' width='40%'><strong>Make</strong></td>" & vbCrLf
            start_string = start_string & "<td valign='bottom' align='center' class='seperator' width='10%'><strong>For Sale</strong></td>" & vbCrLf
            start_string = start_string & "<td valign='bottom' align='center' class='seperator' width='25%'><strong>Last Month +/-</strong></td>" & vbCrLf

            start_string = start_string & "<td valign='bottom' align='center' class='seperator' style='padding-right:25px;'><strong>Last " & marketViewTimeSpan & " Months +/-</strong></td><tr>"


            start_string = start_string & "<tr><td colspan='4' class='rightside'>"
            start_string = start_string & "<p><table width='100%' cellpadding='4' cellspacing='0'>"

            If rs.HasRows Then

                Do While rs.Read

                    page_break_counter = page_break_counter + 1

                    If page_break_counter > 26 Then
                        outstring = outstring & Build_PDF_Template_Footer()
                        outstring = outstring & Insert_Page_Break_PDF()
                        outstring = outstring & Build_PDF_Header_Final("Financial Report", sub_info, make_item_to_pass_to_header, real_company_name, sub_type, "", "", "", True)
                        outstring = outstring & start_string
                        page_break_counter = 0
                    End If



                    If Trim(make_name) = "" And CLng(amod_id) = 0 Then
                        outstring = outstring & "<tr><td valign='top' align='left' class='seperator' title='" & rs("amod_make_name") & "' width='40%'>"
                        outstring = outstring & Trim(rs("amod_make_name")) & "</td>" & vbCrLf
                        outstring = outstring & "<td valign='top' align='right' class='seperator' title='" & rs("amod_make_name") & "' width='10%'>" & CStr(FormatNumber(rs("currentforsale"), 0, True, False, True)) & "</td>" & vbCrLf
                    Else
                        outstring = outstring & "<tr><td valign='top' align='left' class='seperator' title='" & Trim(rs("amod_make_name")) & "&nbsp;/&nbsp;" & Trim(rs("amod_model_name")) & "' width='40%'>"
                        outstring = outstring & Trim(rs("amod_make_name")) & "&nbsp;/&nbsp;" & Trim(rs("amod_model_name")) & "</td>" & vbCrLf
                        outstring = outstring & "<td valign='top' align='right' class='seperator' title='" & Trim(rs("amod_make_name")) & "&nbsp;/&nbsp;" & Trim(rs("amod_model_name")) & "' width='10%'>" & CStr(FormatNumber(rs("currentforsale"), 0, True, False, True)) & "</td>" & vbCrLf
                    End If

                    last_year_diff = 0
                    last_year_percentage = 0

                    If Not IsDBNull(rs("pastyearforsale")) Then
                        If CDbl(rs("pastyearforsale")) > 0 Then
                            last_year_diff = CDbl(CDbl(rs("currentforsale")) - CDbl(rs("pastyearforsale")))
                            last_year_percentage = CDbl(last_year_diff / CDbl(rs("pastyearforsale")))
                            last_year_percentage = CDbl(last_year_percentage * 100)
                            last_year_percentage = FormatNumber(last_year_percentage, 1)
                            sum_LastYear = CInt(sum_LastYear + CInt(rs("pastyearforsale")))
                        End If
                    End If

                    last_month_diff = 0
                    last_month_percentage = 0

                    If Not IsDBNull(rs("pastmonthforsale")) Then
                        If CDbl(rs("pastmonthforsale")) > 0 Then
                            last_month_diff = CDbl(CDbl(rs("currentforsale")) - CDbl(rs("pastmonthforsale")))
                            last_month_percentage = CDbl(last_month_diff / CDbl(rs("pastmonthforsale")))
                            last_month_percentage = CDbl(last_month_percentage * 100)
                            last_month_percentage = FormatNumber(last_month_percentage, 1)
                            sum_LastMonth = CInt(sum_LastMonth + CInt(rs("pastmonthforsale")))

                        End If
                    End If

                    If last_month_diff = 0 Then
                        outstring = outstring & "<td valign='top' align='right' class='seperator' title='No Change' width='25%'><img align='center' src='" & location_string & "images/gain_loss_none.jpg'>&nbsp;&nbsp;" & last_month_diff & " (" & last_month_percentage & "%)</td>" & vbCrLf
                    ElseIf last_month_diff < 0 Then
                        outstring = outstring & "<td valign='top' align='right' class='seperator' title='Net Loss' width='25%'><img align='center' src='" & location_string & "images/gain_loss_down.jpg'>&nbsp;&nbsp;" & last_month_diff & " (" & last_month_percentage & "%)</td>" & vbCrLf
                    Else
                        outstring = outstring & "<td valign='top' align='right' class='seperator' title='Net Gain' width='25%'><img align='center' src='" & location_string & "images/gain_loss_up.jpg'>&nbsp;&nbsp;" & last_month_diff & " (" & last_month_percentage & "%)</td>" & vbCrLf
                    End If

                    If last_year_diff = 0 Then
                        outstring = outstring & "<td valign='top' align='right' class='seperator' title='No Change' style='padding-right:35px;'><img align='center' src='" & location_string & "images/gain_loss_none.jpg'>&nbsp;&nbsp;" & last_year_diff & " (" & last_year_percentage & "%)</td></tr>" & vbCrLf
                    ElseIf last_year_diff < 0 Then
                        outstring = outstring & "<td valign='top' align='right' class='seperator' title='Net Loss' style='padding-right:35px;'><img align='center' src='" & location_string & "images/gain_loss_down.jpg'>&nbsp;&nbsp;" & last_year_diff & " (" & last_year_percentage & "%)</td></tr>" & vbCrLf
                    Else
                        outstring = outstring & "<td valign='top' align='right' class='seperator' title='Net Gain' style='padding-right:35px;'><img align='center' src='" & location_string & "images/gain_loss_up.jpg'>&nbsp;&nbsp;" & last_year_diff & " (" & last_year_percentage & "%)</td></tr>" & vbCrLf
                    End If

                    sum_current_for_sale = CInt(sum_current_for_sale + CInt(rs("currentforsale")))
                    Session("sum_current_for_sale") = sum_current_for_sale
                Loop
                rs.Close()
            Else
                outstring = outstring & "<tr><td valign='top' align='left' class='seperator'>No data matches for your search criteria</td></tr>" & vbCrLf
            End If

            outstring = outstring & "</table></p></td></tr>"

            outstring = outstring & "<tr><td valign='top' align='left' class='seperator' title='Summary' width='40%'><strong>Total Market</strong></td>" & vbCrLf
            outstring = outstring & "<td valign='top' align='right' class='seperator' title='Summary'width='10%'><strong>" & FormatNumber(sum_current_for_sale, 0, True, False, True) & "</strong></td>" & vbCrLf ' Current         

            If sum_LastMonth > 0 Then
                sum_pastmonth_gain_loss = CInt(sum_current_for_sale - sum_LastMonth)

                If sum_pastmonth_gain_loss > 0 Then
                    outstring = outstring & "<td valign='top' align='right' class='seperator' title='Summary' width='25%'><img align='center' src='" & location_string & "images/gain_loss_up.jpg'><strong> " & FormatNumber(sum_pastmonth_gain_loss, 0, True, False, True) & " (" & FormatPercent(sum_pastmonth_gain_loss / sum_LastMonth) & ")</strong></td>" & vbCrLf
                ElseIf sum_pastmonth_gain_loss < 0 Then
                    outstring = outstring & "<td valign='top' align='right' class='seperator' title='Summary' width='25%'><img align='center' src='" & location_string & "images/gain_loss_down.jpg'><strong> " & FormatNumber(sum_pastmonth_gain_loss, 0, True, False, True) & " (" & FormatPercent(sum_pastmonth_gain_loss / sum_LastMonth) & ")</strong></td>" & vbCrLf
                Else
                    outstring = outstring & "<td valign='top' align='right' class='seperator' title='Summary' width='25%'><img align='center' src='" & location_string & "images/gain_loss_none.jpg'><strong> " & FormatNumber(sum_pastmonth_gain_loss, 0, True, False, True) & " (" & FormatPercent(sum_pastmonth_gain_loss / sum_LastMonth) & ")</strong></td>" & vbCrLf
                End If
            Else
                outstring = outstring & "<td valign='top' align='right' class='seperator' title='Summary' width='25%'><img align='center' src='" & location_string & "images/gain_loss_none.jpg'><strong> 0 (0.00%)</strong></td>" & vbCrLf
            End If

            If sum_LastYear > 0 Then
                sum_pastyear_gain_loss = CInt(sum_current_for_sale - sum_LastYear)

                If sum_pastyear_gain_loss > 0 Then
                    outstring = outstring & "<td valign='top' align='right' class='seperator' title='Summary' style='padding-right:35px;'><img align='center' src='" & location_string & "images/gain_loss_up.jpg'><strong> " & FormatNumber(sum_pastyear_gain_loss, 0, True, False, True) & " (" & FormatPercent(sum_pastyear_gain_loss / sum_LastYear) & ")</strong></td>" & vbCrLf
                ElseIf sum_pastyear_gain_loss < 0 Then
                    outstring = outstring & "<td valign='top' align='right' class='seperator' title='Summary' style='padding-right:35px;'><img align='center' src='" & location_string & "images/gain_loss_down.jpg'><strong> " & FormatNumber(sum_pastyear_gain_loss, 0, True, False, True) & " (" & FormatPercent(sum_pastyear_gain_loss / sum_LastYear) & ")</strong></td>" & vbCrLf
                Else
                    outstring = outstring & "<td valign='top' align='right' class='seperator' title='Summary' style='padding-right:35px;'><img align='center' src='" & location_string & "images/gain_loss_none.jpg'><strong> " & FormatNumber(sum_pastyear_gain_loss, 0, True, False, True) & " (" & FormatPercent(sum_pastyear_gain_loss / sum_LastYear) & ")</strong></td>" & vbCrLf
                End If
            Else
                outstring = outstring & "<td valign='top' align='right' class='seperator' title='Summary' style='padding-right:35px;'><img align='center' src='" & location_string & "images/gain_loss_none.jpg'><strong> 0 (0.00%)</strong></td>" & vbCrLf
            End If

            outstring = outstring & "</tr></table></tr></td></table>" & vbCrLf

            display_market_up_down = start_string & Trim(outstring)
        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function
    Function display_market_up_down_one_model(ByVal table_height As Integer, ByVal real_make_model_name As String, ByVal amod_id As Integer, ByVal marketViewTimeSpan As Integer, ByVal airframe_type As String, ByVal product_codes As String)

        display_market_up_down_one_model = ""

        Dim last_year_diff As Integer = 0
        Dim last_month_diff As Integer = 0
        Dim last_year_percentage As Double = 0
        Dim last_month_percentage As Double = 0
        Dim nMonthOffset As Integer = 0
        Dim query As String = ""
        Dim outstring As String = ""
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim rs As System.Data.SqlClient.SqlDataReader : rs = Nothing
        Dim currentDate_Month As Integer = 0
        Dim currentDate_Year As Integer = 0


        Try
            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60





            nMonthOffset = -1
            display_market_up_down_one_model = ""

            ' check for missing data

            query = "SELECT SUM(mtrend_total_aircraft_for_sale) AS pastmonthforsale FROM Aircraft_Model_Trend WITH(NOLOCK)"
            query = query & " INNER JOIN Aircraft_Model WITH(NOLOCK) ON mtrend_amod_id = amod_id"
            query = query & " WHERE (mtrend_year = " & Year(Now) & " AND mtrend_month = " & Month(DateAdd("m", -1, Now)) & ")"

            SqlCommand.CommandText = query
            rs = SqlCommand.ExecuteReader()
            If rs.HasRows Then
                rs.Read()
                If IsDBNull(rs("pastmonthforsale")) Then
                    nMonthOffset = -2
                End If
            End If
            rs.Close()
            rs = Nothing

            query = "SELECT amod_make_name, amod_model_name, amod_id, count(*) as currentforsale,"
            query = query & "(select SUM(mtrend_total_aircraft_for_sale) FROM Aircraft_Model_Trend WITH(NOLOCK) INNER JOIN"
            query = query & " Aircraft_Model WITH(NOLOCK) ON mtrend_amod_id = amod_id"

            If amod_id > 0 Then
                query = query & " AND amod_id = " & amod_id
            ElseIf Trim(airframe_type) <> "" Then
                query = query & " AND amod_type_code = '" & Trim(airframe_type) & "'"
            End If

            If product_codes.ToString.Trim <> "" Then
                If product_codes.ToString.Trim = "B" Then
                    query = query & " AND amod_product_business_flag='Y' "
                ElseIf product_codes.ToString.Trim = "C" Then
                    query = query & " AND amod_product_commercial_flag='Y' "
                ElseIf product_codes.ToString.Trim = "H" Then
                    query = query & " AND amod_product_helicopter_flag='Y' "
                End If
            End If


            currentDate_Month = Month(DateAdd("m", (-1) * marketViewTimeSpan, Now))
            currentDate_Year = Year(DateAdd("m", (-1) * marketViewTimeSpan, Now))

            query = query & " WHERE (amod_make_name = a.amod_make_name AND amod_model_name = a.amod_model_name) AND (mtrend_year = " & currentDate_Year & ") AND (mtrend_month = " & currentDate_Month & ")) AS pastyearforsale,"

            query = query & " (select SUM(mtrend_total_aircraft_for_sale) FROM Aircraft_Model_Trend WITH(NOLOCK) INNER JOIN"
            query = query & " Aircraft_Model WITH(NOLOCK) ON mtrend_amod_id = amod_id"


            If amod_id > 0 Then
                query = query & " AND amod_id = " & amod_id
            ElseIf Trim(airframe_type) <> "" Then
                query = query & " AND amod_type_code = '" & Trim(airframe_type) & "'"
            End If


            If product_codes.ToString.Trim <> "" Then
                If product_codes.ToString.Trim = "B" Then
                    query = query & " AND amod_airframe_type_code='F' "
                ElseIf product_codes.ToString.Trim = "H" Then
                    query = query & " AND amod_airframe_type_code='R' "
                End If
            End If


            currentDate_Month = Month(DateAdd("m", nMonthOffset, Now))
            currentDate_Year = Year(DateAdd("m", nMonthOffset, Now))

            query = query & " WHERE (amod_make_name = a.amod_make_name AND amod_model_name = a.amod_model_name) AND (mtrend_year = " & currentDate_Year & ") AND (mtrend_month = " & currentDate_Month & ")) AS pastmonthforsale"

            query = query & " FROM aircraft WITH(NOLOCK) INNER JOIN aircraft_model AS A WITH(NOLOCK) ON ac_amod_id = amod_id"
            query = query & " WHERE ac_forsale_flag = 'Y' AND ac_journ_id = 0"

            '  query = query & commonEVO.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, True)
            query = query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, True)


            If amod_id > 0 Then
                query = query & " AND amod_id = " & amod_id
            ElseIf Trim(airframe_type) <> "" Then
                query = query & " AND amod_type_code = '" & Trim(airframe_type) & "'"
            End If


            If product_codes.ToString.Trim <> "" Then
                If product_codes.ToString.Trim = "B" Then
                    query = query & " AND amod_airframe_type_code='F' "
                ElseIf product_codes.ToString.Trim = "H" Then
                    query = query & " AND amod_airframe_type_code='R' "
                End If
            End If


            query = query & " GROUP BY amod_make_name, amod_model_name, amod_id ORDER BY amod_make_name, amod_model_name, amod_id"


            If Session("debug") Then
                Response.Write("<b>display_market_up_down_one_model:" & Server.HtmlEncode(query) & "</b><br /><br />")
            End If

            SqlCommand.CommandText = query
            rs = SqlCommand.ExecuteReader()


            outstring = "<table width='100%' height='" & table_height & "' align='left' cellpadding='1' cellspacing='0' class='module'>" & vbCrLf
            outstring = outstring & "<tr><td valign='middle' align='left' class='header' style='padding-left:3px; height:24px;'>AIRCRAFT FOR SALE MARKET TRENDS FOR MODEL</td>"
            outstring = outstring & "<td valign='middle' align='right' class='header' style='padding-left:3px; height:24px;'>" & marketViewTimeSpan & " MONTHS&nbsp;</td></tr>" & vbCrLf

            outstring = outstring & "<tr><td valign='top' align='left' colspan='2'><table width='100%' cellpadding='1' cellspacing='0' cell>" & vbCrLf
            outstring = outstring & "<tr><td valign='top' align='left' class='seperator' width='40%'><strong>Make</strong></td>" & vbCrLf
            outstring = outstring & "<td valign='top' align='right' class='seperator' width='10%'><strong>For Sale</strong></td>" & vbCrLf
            outstring = outstring & "<td valign='top' align='right' class='seperator' width='25%'><strong>Last Month +/-</strong></td>" & vbCrLf

            If CInt(marketViewTimeSpan) = 6 Then
                outstring = outstring & "<td valign='bottom' align='center' class='seperator' style='padding-right:25px;'><strong>Last Six Months +/-</strong></td><tr>" & vbCrLf
            End If

            If CInt(marketViewTimeSpan) = 12 Then
                outstring = outstring & "<td valign='bottom' align='center' class='seperator' style='padding-right:35px;'><strong>Last Year +/-</strong></td><tr>" & vbCrLf
            End If

            outstring = outstring & "<tr><td colspan='4' class='rightside'>" & vbCrLf
            outstring = outstring & "<p><table width='100%' cellpadding='4' cellspacing='0'>" & vbCrLf

            If rs.HasRows Then

                Do While rs.Read


                    Session("sum_current_for_sale") = FormatNumber(rs("currentforsale"), 0, True, False, True)
                    outstring = outstring & "<tr><td valign='top' align='left' class='seperator' title='" & Trim(rs("amod_make_name")) & "&nbsp;/&nbsp;" & Trim(rs("amod_model_name")) & "' width='40%'>"
                    outstring = outstring & "" & Trim(rs("amod_make_name")) & "&nbsp;/&nbsp;" & Trim(rs("amod_model_name")) & "</td>" & vbCrLf
                    outstring = outstring & "<td valign='top' align='right' class='seperator' title='" & Trim(rs("amod_make_name")) & "&nbsp;/&nbsp;" & Trim(rs("amod_model_name")) & "' width='10%'>" & CStr(FormatNumber(rs("currentforsale"), 0, True, False, True)) & "</td>" & vbCrLf

                    last_year_diff = 0
                    last_year_percentage = 0

                    If Not IsDBNull(rs("pastyearforsale")) Then
                        If CDbl(rs("pastyearforsale")) > 0 Then
                            last_year_diff = CDbl(CDbl(rs("currentforsale")) - CDbl(rs("pastyearforsale")))
                            last_year_percentage = CDbl(last_year_diff / CDbl(rs("pastyearforsale")))
                            last_year_percentage = CDbl(last_year_percentage * 100)
                            last_year_percentage = CDbl(last_year_percentage) ' was a round , 1 
                        End If
                    End If

                    last_month_diff = 0
                    last_month_percentage = 0

                    If Not IsDBNull(rs("pastmonthforsale")) Then
                        If CDbl(rs("pastmonthforsale")) > 0 Then
                            last_month_diff = CDbl(CDbl(rs("currentforsale")) - CDbl(rs("pastmonthforsale")))
                            last_month_percentage = CDbl(last_month_diff / CDbl(rs("pastmonthforsale")))
                            last_month_percentage = CDbl(last_month_percentage * 100)
                            last_month_percentage = CDbl(last_month_percentage) ' was a round , 1 
                        End If
                    End If

                    If last_month_diff = 0 Then
                        outstring = outstring & "<td valign='top' align='right' class='seperator' title='No Change' width='25%'><img align='center' src='" & location_string & "images/gain_loss_none.jpg'>&nbsp;&nbsp;" & last_month_diff & " (" & FormatNumber(last_month_percentage, 1) & "%)</td>" & vbCrLf
                    ElseIf last_month_diff < 0 Then
                        outstring = outstring & "<td valign='top' align='right' class='seperator' title='Net Loss' width='25%'><img align='center' src='" & location_string & "images/gain_loss_down.jpg'>&nbsp;&nbsp;" & last_month_diff & " (" & FormatNumber(last_month_percentage, 1) & "%)</td>" & vbCrLf
                    Else
                        outstring = outstring & "<td valign='top' align='right' class='seperator' title='Net Gain' width='25%'><img align='center' src='" & location_string & "images/gain_loss_up.jpg'>&nbsp;&nbsp;" & last_month_diff & " (" & FormatNumber(last_month_percentage, 1) & "%)</td>" & vbCrLf
                    End If

                    If last_year_diff = 0 Then
                        outstring = outstring & "<td valign='top' align='right' class='seperator' title='No Change' style='padding-right:35px;'><img align='center' src='" & location_string & "images/gain_loss_none.jpg'>&nbsp;&nbsp;" & last_year_diff & " (" & FormatNumber(last_year_percentage, 1) & "%)</td></tr>" & vbCrLf
                    ElseIf last_year_diff < 0 Then
                        outstring = outstring & "<td valign='top' align='right' class='seperator' title='Net Loss' style='padding-right:35px;'><img align='center' src='" & location_string & "images/gain_loss_down.jpg'>&nbsp;&nbsp;" & last_year_diff & " (" & FormatNumber(last_year_percentage, 1) & "%)</td></tr>" & vbCrLf
                    Else
                        outstring = outstring & "<td valign='top' align='right' class='seperator' title='Net Gain' style='padding-right:35px;'><img align='center' src='" & location_string & "images/gain_loss_up.jpg'>&nbsp;&nbsp;" & last_year_diff & " (" & FormatNumber(last_year_percentage, 1) & "%)</td></tr>" & vbCrLf
                    End If


                Loop
                rs.Close()
            Else
                outstring = outstring & "<tr><td valign='top' align='left' class='seperator'>No data matches for your search criteria</td></tr>"
            End If

            outstring = outstring & "</table></p></td></tr></table>"


            display_market_up_down_one_model = Trim(outstring)
        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function

    Function display_sold_per_month(ByVal table_height As Integer, ByVal real_make_model_name As String, ByVal amod_id As Integer, ByVal marketViewTimeSpan As Integer, ByVal airframe_type As String, ByVal product_codes As String, ByVal make_name As String, ByVal make_model_or_make_for_title As String)
        display_sold_per_month = ""

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim adoRs As System.Data.SqlClient.SqlDataReader : adoRs = Nothing
        Dim currentDate_Month As Integer = 0
        Dim currentDate_Year As Integer = 0
        Dim last_month_percentage As Integer = 0
        Dim total_count As Integer = 0
        Dim aLabels1(1000) As String
        Dim aData1(1000) As Integer
        Dim i As Integer = 0
        Dim current_data_point As Integer = 0
        Dim info_for_current_month As Boolean = False
        Try

            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60

            currentDate_Month = Month(DateAdd("m", (-1) * marketViewTimeSpan, Now))
            currentDate_Year = Year(DateAdd("m", (-1) * marketViewTimeSpan, Now))

            Dim outstring As String = ""
            Dim query As String = ""
            Dim x As Integer = 0

            query = "SELECT YEAR(journ_date) AS aYear, MONTH(journ_date) AS aMonth, count(*) AS acount"
            query = query & " FROM Journal WITH(NOLOCK) INNER JOIN Aircraft WITH(NOLOCK) ON journ_ac_id = ac_id AND journ_id = ac_journ_id"
            query = query & " INNER JOIN aircraft_model WITH(NOLOCK) ON ac_amod_id = amod_id"
            query = query & " WHERE (journ_date >= '" & Month(DateAdd("m", (-1) * marketViewTimeSpan, Now)) & "/01/" & Year(DateAdd("m", (-1) * marketViewTimeSpan, Now)) & "')"
            query = query & " AND (journ_date < '" & Month(Now) & "/" & Day(Now) & "/" & Year(Now) & "')"
            query = query & " AND journ_subcategory_code LIKE 'WS%' AND RIGHT(journ_subcategory_code,4) <> 'CORR' AND RIGHT(journ_subcategory_code,2) <> 'IT'"


            'query = query & commonEVO.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, True)
            query = query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, True)


            If Trim(make_name) <> "" Then
                query = query & " AND amod_make_name = '" & make_name & "' "
            ElseIf amod_id > 0 Then
                query = query & " AND amod_id = " & amod_id
            ElseIf Trim(airframe_type) <> "" Then
                query = query & " AND amod_type_code = '" & Trim(airframe_type) & "'"
            End If


            If product_codes.ToString.Trim <> "" Then
                If product_codes.ToString.Trim = "B" Then
                    query = query & " AND amod_airframe_type_code='F' "
                ElseIf product_codes.ToString.Trim = "H" Then
                    query = query & " AND amod_airframe_type_code='R' "
                End If
            End If

            query = query & " GROUP BY year(journ_date), month(journ_date)"
            query = query & " ORDER BY year(journ_date), month(journ_date)"

            If Session("debug") Then
                Response.Write("<b>display_sold_per_month:" & Server.HtmlEncode(query) & "</b><br /><br />")
            End If


            SqlCommand.CommandText = query
            adoRs = SqlCommand.ExecuteReader()

            If adoRs.HasRows Then



                Me.SALES_TRENDS.Series.Add("SALES_TRENDS").ChartType = UI.DataVisualization.Charting.SeriesChartType.Spline
                Me.SALES_TRENDS.Series("SALES_TRENDS").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32
                Me.SALES_TRENDS.Series("SALES_TRENDS").LabelForeColor = Drawing.Color.Blue
                Me.SALES_TRENDS.ChartAreas("ChartArea1").AxisY.Title = "Transactions"
                Me.SALES_TRENDS.Series("SALES_TRENDS").Color = Drawing.Color.Blue
                Me.SALES_TRENDS.Series("SALES_TRENDS").BorderWidth = 2
                Me.SALES_TRENDS.Series("SALES_TRENDS").MarkerSize = 6
                Me.SALES_TRENDS.Series("SALES_TRENDS").MarkerStyle = UI.DataVisualization.Charting.MarkerStyle.Circle
                '  Me.AVG_PRICE_MONTH.BorderlineWidth = 10
                Me.SALES_TRENDS.Series("SALES_TRENDS").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32




                Do While adoRs.Read


                    If adoRs("aMonth") = Month(Now) Then
                        info_for_current_month = True
                    End If

                    aLabels1(x) = CStr(adoRs("aMonth")) & "-" & CStr(adoRs("aYear"))
                    aData1(x) = FormatNumber(adoRs("aCount"), 2, False, False, False)

                    x = x + 1


                Loop
                adoRs.Close()
                adoRs = Nothing

                calculate_min_max(aData1, x, "Sales Trends")

                If x > 0 Then

                    'SortLabelsValue(aLabels1, aData1, x - 2, 2)

                    For i = 0 To x - 1
                        If i = x - 1 And Left(aLabels1(i), 2) = Month(Now) Then
                            Me.SALES_TRENDS.Series("SALES_TRENDS").Points.AddXY("Month to Date", aData1(i))
                        Else
                            Me.SALES_TRENDS.Series("SALES_TRENDS").Points.AddXY(aLabels1(i), aData1(i))
                        End If


                    Next

                    If info_for_current_month = True Then
                        Me.SALES_TRENDS.Series("SALES_TRENDS").Points.Last.Color = Drawing.Color.Black
                        Me.SALES_TRENDS.Series("SALES_TRENDS").Points.Last.BorderDashStyle = DataVisualization.Charting.ChartDashStyle.Dash
                    End If
                    'current_data_point = find_current_values(amod_id, "SalesTrends", make_name, product_codes)

                    Me.SALES_TRENDS.Titles.Add("SALES TRENDS (# of Sales Transactions)")
                    Me.SALES_TRENDS.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                    Me.SALES_TRENDS.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" + amod_id.ToString + "_SALES_TRENDS.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
                End If
                outstring = "1"
            Else
                outstring = ""
            End If

            If Trim(outstring) <> "" Then
                outstring = "<table width='100%' height='" & table_height & "' cellpadding='1' cellspacing='0' class='module'>"
                outstring = outstring & "<tr><td valign='top' align='left' class='header' colspan='2' style='padding-left:3px;'>SALES TRENDS (<em># of Sales Transactions</em>): " & make_model_or_make_for_title.ToUpper & "</td></tr>"
                outstring = outstring & "<tr><td valign='top' align='left' class='tabheader'><strong>" & make_model_or_make_for_title.ToUpper & "</strong></td><td width='20%' class='border_bottom'>&nbsp;</td>"
                outstring = outstring & "<tr><td valign='top' align='center' class='border_bottom_right' colspan='2'><div  style='width:300px; height:" & table_height & "px;'><img src='" + amod_id.ToString + "_SALES_TRENDS.jpg'></div></td></tr></table></td>"
            Else
                outstring = "<table width='100%' height='" & table_height & "' cellpadding='1' cellspacing='0' class='module'>"
                outstring = outstring & "<tr><td valign='top' align='left' class='header' colspan='2' style='padding-left:3px;'>SALES TRENDS (<em># of Sales Transactions</em>): " & make_model_or_make_for_title.ToUpper & "</td></tr>"
                outstring = outstring & "<tr><td valign='top' align='left' class='tabheader'><strong>" & make_model_or_make_for_title.ToUpper & "</strong></td><td width='20%' class='border_bottom'>&nbsp;</td>"
                outstring = outstring & "<tr><td valign='top' align='left' class='border_bottom_right' colspan='2'><div style='width:300px; height:" & table_height & "px;'>No Graph Data</div></td></tr></table></td>"
            End If

            display_sold_per_month = outstring
        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function

    Function display_for_sale(ByVal in_HeaderText As String, ByVal table_height As Integer, ByVal graphID As Integer, ByVal amod_id As Integer, ByVal real_make_model_name As String, ByVal marketViewTimeSpan As Integer, ByVal airframe_type As String, ByVal product_codes As String, ByVal make_name As String, ByVal make_model_or_make_for_title As String)
        display_for_sale = ""
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim rs As System.Data.SqlClient.SqlDataReader : rs = Nothing
        Dim currentDate_Month As Integer = 0
        Dim currentDate_Year As Integer = 0
        Dim last_month_percentage As Integer = 0
        Dim total_count As Integer = 0
        Dim outstring As String = ""
        Dim query As String = ""
        Dim x As Integer = 0
        Dim aLabels1(1000)
        Dim aData1(1000)
        Dim aLabels2(1000)
        Dim aData2(1000)
        Dim i As Integer = 0
        Dim has_information As Boolean = False
        Dim average_asking_month As Integer = 0
        Dim info_for_current_month As Boolean = False

        Try
            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60



            query = "SELECT DISTINCT mtrend_year, mtrend_month, sum(mtrend_total_aircraft_for_sale) AS tforsale,"
            query = query & " ((sum(cast(mtrend_avail_asking_price_total as float))/sum(cast(NULLIF([mtrend_avail_asking_price_count],0) as float)))) AS avgprice"
            query = query & " FROM Aircraft_Model_Trend WITH(NOLOCK) INNER JOIN aircraft_model WITH(NOLOCK) ON mtrend_amod_id = amod_id"


            If Trim(make_name) <> "" Then
                query = query & " AND amod_make_name = '" & make_name & "' "
            ElseIf amod_id > 0 Then
                query = query & " AND amod_id = " & amod_id
            ElseIf Trim(airframe_type) <> "" Then
                query = query & " AND amod_type_code = '" & Trim(airframe_type) & "'"
            End If


            If product_codes.ToString.Trim <> "" Then
                If product_codes.ToString.Trim = "B" Then
                    query = query & " AND mtrend_product_type='B' "
                ElseIf product_codes.ToString.Trim = "C" Then
                    query = query & " AND mtrend_product_type='C' "
                ElseIf product_codes.ToString.Trim = "H" Then
                    query = query & " AND mtrend_product_type='H' "
                End If
            End If



            query = query & " WHERE"

            query = query & "((mtrend_year = year(CONVERT(DATETIME, '" & DateAdd("m", (-1) * marketViewTimeSpan, Now) & "',102)))"
            query = query & " and (mtrend_month >= month(CONVERT(DATETIME, '" & DateAdd("m", (-1) * marketViewTimeSpan, Now) & "',102)))"

            'If CInt(marketViewTimeSpan) = 6 Then
            '    query = query & ")"
            'ElseIf CInt(marketViewTimeSpan) = 12 Then
            '    query = query & " or "
            '    query = query & "((mtrend_year = year(CONVERT(DATETIME, '" & Now & "',102))) and (mtrend_month <= month(CONVERT(DATETIME, '" & Now & "',102)))))"
            'End If
            ''


            If CInt(marketViewTimeSpan) = 6 Then

                If Year(DateAdd("m", (-1) * CInt(marketViewTimeSpan), Now)) <> Year(Now) Then
                    query = query & " OR "
                Else
                    query = query & " AND "
                End If

                query = query & "((mtrend_year = year(CONVERT(DATETIME, '" & Now & "',102))) and (mtrend_month <= month(CONVERT(DATETIME, '" & Now & "',102)))))"

            ElseIf CInt(marketViewTimeSpan) = 12 Then

                If Year(DateAdd("m", (-1) * CInt(marketViewTimeSpan), Now)) <> Year(Now) Then
                    query = query & " OR "
                Else
                    query = query & " AND "
                End If

                query = query & "((mtrend_year = year(CONVERT(DATETIME, '" & Now & "',102))) and (mtrend_month <= month(CONVERT(DATETIME, '" & Now & "',102)))))"

            End If


            'query = query & commonEVO.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, True)
            query = query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, False)

            query = query & " GROUP BY mtrend_year, mtrend_month ORDER BY mtrend_year ASC, mtrend_month ASC"

            If Session("debug") Then
                Response.Write("<b>display_for_sale:" & Server.HtmlEncode(query) & "</b><br /><br />")
            End If

            SqlCommand.CommandText = query
            rs = SqlCommand.ExecuteReader()

            If rs.HasRows Then


                has_information = True


                Do While rs.Read
                    If Not IsDBNull(("mtrend_year")) Then

                        ' If Month(Now) = rs("mtrend_month") Then
                        'info_for_current_month = True
                        'End If

                        aLabels1(x) = CStr(rs("mtrend_month")) & "-" & CStr(rs("mtrend_year"))
                        aData1(x) = FormatNumber(rs("tforsale"), 2, False, False, False)


                        x = x + 1
                    End If


                Loop


                aLabels1(x) = "Now"
                aData1(x) = Session("sum_current_for_sale")
                x = x + 1
                Dim tmpGraph As String = ""



                ReDim Preserve aLabels1(x)
                ReDim Preserve aData1(x)

                calculate_min_max(aData1, x, "AC For Sale")


                Me.M_TREND.Series.Add("M_TREND").ChartType = UI.DataVisualization.Charting.SeriesChartType.Spline
                Me.M_TREND.Series("M_TREND").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32
                Me.M_TREND.Series("M_TREND").LabelForeColor = Drawing.Color.Blue
                Me.M_TREND.ChartAreas("ChartArea1").AxisY.Title = "Aircraft"
                Me.M_TREND.Series("M_TREND").Color = Drawing.Color.Blue
                Me.M_TREND.Series("M_TREND").BorderWidth = 2
                Me.M_TREND.Series("M_TREND").MarkerSize = 5
                Me.M_TREND.Series("M_TREND").MarkerStyle = UI.DataVisualization.Charting.MarkerStyle.Circle
                '  Me.AVG_PRICE_MONTH.BorderlineWidth = 10
                Me.M_TREND.Series("M_TREND").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32



                'SortLabelsValue(aLabels1, aData1, x - 2, 2)

                For i = 0 To x - 1
                    Me.M_TREND.Series("M_TREND").Points.AddXY(aLabels1(i), aData1(i))
                Next

                ' If info_for_current_month = True Then
                Me.M_TREND.Series("M_TREND").Points.Last.Color = Drawing.Color.Black
                Me.M_TREND.Series("M_TREND").Points.Last.BorderDashStyle = DataVisualization.Charting.ChartDashStyle.Dash
                'End If

                Me.M_TREND.Titles.Add("Aircraft For Sale ( Past " & marketViewTimeSpan & " Months )")
                Me.M_TREND.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                Me.M_TREND.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" + amod_id.ToString + "M_TREND.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
                '  outstring += ("<img src='" + amod_id.tostring + "M_TREND.jpg'>")


                x = 0
                info_for_current_month = False

                rs.Close()
                SqlCommand.CommandText = query
                rs = SqlCommand.ExecuteReader()

                If rs.HasRows Then
                    has_information = True

                    Do While rs.Read

                        If Not IsDBNull(rs("avgprice")) Then
                            aLabels2(x) = CStr(rs("mtrend_month")) & "-" & CStr(rs("mtrend_year"))
                            aData2(x) = FormatNumber(rs("avgprice"), 2, False, False, False)
                        End If
                        x = x + 1

                    Loop

                Else
                    outstring = ""
                End If
            End If
            rs.Close()
            rs = Nothing

            If x > 0 Then
                ReDim Preserve aLabels2(x)
                ReDim Preserve aData2(x + 1)

                ' SortLabelsValue(aLabels2, aData2, x - 2, 2)

                Me.M_TREND.Titles.Clear()
                Me.M_TREND.Series.Clear()


                average_asking_month = find_current_values(amod_id, "AvgAsking", make_name, product_codes, airframe_type)
                aData2(x) = average_asking_month
                ' For i = 0 To x + 1
                'aData2(i) = CDbl(FormatNumber(CDbl((aData2(i) / 100)), 0))
                ' Next

            End If

            Me.M_TREND.Series.Add("M_TREND").ChartType = UI.DataVisualization.Charting.SeriesChartType.Spline
            Me.M_TREND.Series("M_TREND").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32
            Me.M_TREND.Series("M_TREND").LabelForeColor = Drawing.Color.Blue
            Me.M_TREND.ChartAreas("ChartArea1").AxisY.Title = "Average Asking Price(US $)"
            Me.M_TREND.Series("M_TREND").Color = Drawing.Color.Blue
            Me.M_TREND.Series("M_TREND").BorderWidth = 2
            Me.M_TREND.Series("M_TREND").MarkerSize = 5
            Me.M_TREND.Series("M_TREND").MarkerStyle = UI.DataVisualization.Charting.MarkerStyle.Circle
            '  Me.AVG_PRICE_MONTH.BorderlineWidth = 10
            Me.M_TREND.Series("M_TREND").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32

            For i = 0 To x
                aData2(i) = (aData2(i) / 1000)
            Next
            calculate_min_max(aData2, x + 1, "AC For Sale")
            For i = 0 To x - 1
                Me.M_TREND.Series("M_TREND").Points.AddXY(aLabels2(i) & "", FormatNumber(aData2(i), 0))
            Next
            Me.M_TREND.ChartAreas("ChartArea1").AxisY.LabelStyle.Format = "#,###"
            Me.M_TREND.Series("M_TREND").Points.AddXY("Now", FormatNumber(aData2(x), 0))
            Me.M_TREND.Series("M_TREND").Points.Last.Color = Drawing.Color.Black
            Me.M_TREND.Series("M_TREND").Points.Last.BorderDashStyle = DataVisualization.Charting.ChartDashStyle.Dash


            Me.M_TREND.Titles.Add("Average Asking Price  in Thousands ( Past " & marketViewTimeSpan & " Months )")
            Me.M_TREND.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
            Me.M_TREND.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" + amod_id.ToString + "M_TREND2.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)
            ' outstring += ("<img src='" + amod_id.tostring + "M_TREND2.jpg'>")


            If has_information = True Then
                outstring = outstring & "<table id='marketTrendsOuterTable' width='100%' height='" & table_height & "' cellspacing='0' cellpadding='1' class='module'>" & vbCrLf
                outstring = outstring & "<tr><td valign='middle' align='left' class='header' style='padding-left:3px; height:24px;'>MARKET TRENDS: " & make_model_or_make_for_title.ToString.ToUpper & UCase(in_HeaderText) & "</td></tr>" & vbCrLf
                outstring = outstring & "<tr><td valign='top' align='left'><table id='marketTrendsInnerTable' width='100%' cellspacing='0' cellpadding='1'>" & vbCrLf
                outstring = outstring & "<tr><td valign='top' align='center' class='border_bottom_right'><div id='visualization" & graphID & "' style='height:" & CStr(CLng(table_height)) & "px;'><img src='" + amod_id.ToString + "M_TREND.jpg'></div></td></tr>" ' was rounded
                outstring = outstring & "<tr><td valign='top' align='center' class='border_bottom_right'><div id='visualization" & graphID + 1 & "' style='height:" & CStr(CLng(table_height)) & "px;'><img src='" + amod_id.ToString + "M_TREND2.jpg'></div></td></tr>" ' was rounded
                outstring = outstring & "</table></td></tr></table>"
            Else
                outstring = outstring & "<table id='marketTrendsOuterTable' width='100%' height='" & table_height & "' cellspacing='0' cellpadding='1' class='module'>" & vbCrLf
                outstring = outstring & "<tr><td valign='middle' align='left' class='header' style='padding-left:3px; height:24px;'>MARKET TRENDS: " & make_model_or_make_for_title & UCase(in_HeaderText) & "</td></tr>" & vbCrLf
                outstring = outstring & "<tr><td valign='top' align='left'><table id='marketTrendsInnerTable' width='100%' cellspacing='0' cellpadding='1'>" & vbCrLf
                outstring = outstring & "<tr><td valign='top' align='center' class='border_bottom_right'><div style='height:" & CStr(CLng(table_height)) & "px;'>No Graph Data</div></td></tr>" ' was rounded
                outstring = outstring & "<tr><td valign='top' align='center' class='border_bottom_right'><div style='height:" & CStr(CLng(table_height)) & "px;'>No Graph Data</div></td></tr>" ' was rounded
                outstring = outstring & "</table></td></tr></table>"
            End If

            display_for_sale = Trim(outstring)
        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function

    Function find_current_values(ByVal amod_id As Integer, ByVal type As String, ByVal make As String, ByVal product_codes As String, ByVal airframe_type As String) As Integer
        find_current_values = 0
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim rs As System.Data.SqlClient.SqlDataReader : rs = Nothing
        Dim query As String = ""
        Dim sum As Double = 0
        Dim count As Integer = 0
        Dim average As Double = 0
        Try


            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60

            If type = "AvgAsking" Then
                query = "Select sum(ac_asking_price) as sum, count(*) as tcount from aircraft "
                query = query & " inner join aircraft_model on ac_amod_id = amod_id "
                query = query & " where ac_journ_id = 0 and ac_asking_price > 0 and ac_asking_price is not NULL and ac_forsale_flag = 'Y'  "
                '  ElseIf 
                '    query = ""
            End If

            If Trim(make) <> "" Then
                query = query & " AND amod_make_name = '" & make & "' "
            ElseIf amod_id > 0 Then
                query = query & " AND amod_id = " & amod_id
            ElseIf Trim(airframe_type) <> "" Then
                query = query & " AND amod_type_code = '" & Trim(airframe_type) & "'"
            End If

            Select Case (product_codes)

                Case "B"
                    query = query & " AND amod_product_business_flag = 'Y'"
                Case "C"
                    query = query & " AND amod_product_commercial_flag = 'Y'"
                Case "H"
                    query = query & " AND amod_product_helicopter_flag = 'Y'"
                Case Else
                    query = query & " AND amod_product_business_flag = 'Y'"

            End Select
            'query = query & commonEVO.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, True)

            query = query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, True)

            SqlCommand.CommandText = query
            rs = SqlCommand.ExecuteReader()

            If rs.HasRows Then
                Do While rs.Read

                    If type = "AvgAsking" Then
                        If Not IsDBNull(rs("tcount")) And Not IsDBNull(rs("sum")) Then
                            count = rs("tcount")
                            sum = rs("sum")
                            average = (sum / count)
                            average = FormatNumber(average, 0)
                            '   ElseIf type = "SalesTrends" Then
                        End If
                    End If




                Loop
            End If

            If type = "AvgAsking" Then
                find_current_values = average
                '  ElseIf type = "SalesTrends" Then

            End If

        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function

    Function calculate_min_max(ByVal aData, ByVal size_of_array, ByVal chart_type) As Integer
        calculate_min_max = 0
        Dim current_min As Integer = 99999999
        Dim current_max As Integer = -99999999
        Dim lMax As Integer = -99999999
        Dim lMin As Integer = 99999999
        Dim i As Integer = 0
        Dim Add_one As Boolean = False

        For i = 0 To size_of_array - 1

            If aData(i) > current_max Then
                current_max = aData(i)
            End If

            If aData(i) < current_min Then
                current_min = aData(i)
            End If

        Next


        If current_min > 0 Or current_max > 0 Then
            lMin = current_min
            lMax = current_max
        Else
            lMin = 99999999
            lMax = -99999999
        End If



        Dim temp_counter As Integer = 0
        Dim temp_ten As Double = 10
        Dim temp_max As Double = 0
        Dim temp_min As Integer = 0
        i = 1
        Dim label_count As Integer = 0
        Dim found As Integer = 0
        Dim found2 As Integer = 0


        If lMax <= 0 Then
            temp_counter = -10
        ElseIf lMax <= 100 Then ' 100 
            temp_counter = 1
        ElseIf lMax <= 1000 Then  ' 1 thousand 
            temp_counter = 5
        ElseIf lMax <= 10000 Then ' ten thousand 
            temp_counter = 50
        ElseIf lMax <= 100000 Then  ' 100 thousand 
            temp_counter = 500
        ElseIf lMax <= 1000000 Then ' 1 mill 
            temp_counter = 5000
        ElseIf lMax <= 10000000 Then ' ten mill 
            temp_counter = 50000
        ElseIf lMax <= 100000000 Then ' one hundred mill
            temp_counter = 500000
        End If

        temp_max = lMax
        If lMax >= 0 Then
            For i = 1 To 200
                If lMax >= (temp_counter * i) Then
                    temp_max = i + 1
                Else
                    i = 200
                End If
            Next
        Else
            For i = 1 To 200
                If lMax >= (temp_counter * i * -1) Then
                    temp_max = (i - 1) * -1
                    i = 200
                End If

            Next
        End If

        temp_min = lMin

        If lMin >= 0 Then
            For i = 1 To 200
                If lMin <= (temp_counter * i) Then
                    temp_min = i - 1
                    i = 200
                End If
            Next
        Else
            For i = 1 To 200
                If lMin >= (temp_counter * i * -1) Then
                    temp_min = (i) * -1
                    i = 200
                End If

            Next
        End If




        ' even more precision 
        If lMax >= 0 Then
            For i = 1 To 10
                If (temp_counter + (i * (temp_counter / 10))) >= lMax Then
                    found = (temp_counter + (i * (temp_counter / 10)))
                    i = 10
                End If
            Next
        End If


        If lMin < 0 Then
            For i = 1 To 10
                If ((temp_counter * -1) - (i * (temp_counter / 10))) <= lMin Then
                    found2 = ((temp_counter * -1) - (i * (temp_counter / 10)))
                    i = 10
                End If
            Next
        End If



        If found > 0 Then
            If (found - lMax) <= (temp_counter / 2) Then
                Add_one = True
            End If
        Else
            '  if its a 1 then dont want to check if <= the .5 
            If temp_counter = 1 Then
                If ((temp_counter * temp_max) - lMax) <= 1 Then
                    Add_one = True
                End If
            Else
                If ((temp_counter * temp_max) - lMax) <= (temp_counter / 2) Then
                    Add_one = True
                End If
            End If


        End If


        ' 10,000    *       2 =         20,000
        If found > 0 Then
            lMax = found
        Else
            lMax = (temp_counter * temp_max)
        End If

        If found2 < 0 Then
            lMin = found2
        Else
            lMin = (temp_counter * temp_min)
        End If

        If Add_one = True Then
            If temp_counter = 1 Then
                lMax = lMax + 2
            ElseIf temp_counter = 5 Then
                lMax = lMax + 5
            End If


        End If


        If current_min = 0 And current_max = 0 Then
            lMax = 1
            lMin = 1
        End If


        If chart_type = "Sales Trends" Then
            Me.SALES_TRENDS.ChartAreas("ChartArea1").AxisY.Minimum = lMin
            Me.SALES_TRENDS.ChartAreas("ChartArea1").AxisY.Maximum = lMax
        ElseIf chart_type = "AC For Sale" Then
            If lMin = 1 And lMax = 1 Then
                ' if both are 1 then it didnt find anything - we need to let it do it automatically. - MSW 6/13/12
            Else
                Me.M_TREND.ChartAreas("ChartArea1").AxisY.Minimum = FormatNumber(lMin, 0)
                Me.M_TREND.ChartAreas("ChartArea1").AxisY.Maximum = FormatNumber(lMax, 0)
            End If


        End If
    End Function

    Function display_new_vs_used_piechart(ByVal table_height As Integer, ByVal real_make_model_name As String, ByVal amod_id As Integer, ByVal marketViewTimeSpan As Integer, ByVal airframe_type As String, ByVal product_codes As String, ByVal make_name As String, ByVal make_model_or_make_for_title As String) As String
        display_new_vs_used_piechart = ""
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim adoRs As System.Data.SqlClient.SqlDataReader : adoRs = Nothing
        Dim x As Integer = 0
        Dim new_used_sum As Integer = 0
        Dim aLabels1(1000)
        Dim aData1(1000)
        Dim new_used_percent(1000)
        Dim outstring As String = ""
        Dim query As String = ""
        Dim graph_info As String = ""
        Dim i As Integer = 0

        Try

            query = "SELECT DISTINCT journ_newac_flag, count(*) AS tcount"
            query = query & " FROM aircraft WITH(NOLOCK) INNER JOIN aircraft_model WITH(NOLOCK) ON ac_amod_id = amod_id"
            query = query & " INNER JOIN journal WITH(NOLOCK) ON ac_journ_id = journ_id"
            query = query & " WHERE (journ_subcategory_code like 'WS%') AND RIGHT(journ_subcategory_code,4) <> 'CORR' AND RIGHT(journ_subcategory_code,2) <> 'IT'"

            '  query = query & commonEVO.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, True)
            query = query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, True)

            query = query & " AND (journ_date >= '" & Month(DateAdd("m", (-1) * marketViewTimeSpan, Now)) & "/01/" & Year(DateAdd("m", (-1) * marketViewTimeSpan, Now)) & "')"

            If Trim(make_name) <> "" Then
                query = query & " AND amod_make_name = '" & make_name & "' "
            ElseIf amod_id > 0 Then
                query = query & " AND amod_id = " & amod_id
            ElseIf Trim(airframe_type) <> "" Then
                query = query & " AND amod_type_code = '" & Trim(airframe_type) & "'"
            End If


            If product_codes.ToString.Trim <> "" Then
                If product_codes.ToString.Trim = "B" Then
                    query = query & " AND amod_product_business_flag='Y' "
                ElseIf product_codes.ToString.Trim = "C" Then
                    query = query & " AND amod_product_commercial_flag='Y' "
                ElseIf product_codes.ToString.Trim = "H" Then
                    query = query & " AND amod_product_helicopter_flag='Y' "
                End If
            End If


            query = query & " GROUP BY journ_newac_flag ORDER BY journ_newac_flag "

            If Session("debug") Then
                Response.Write("<b>display_new_vs_used_piechart:" & Server.HtmlEncode(query) & "</b><br /><br />")
            End If

            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60


            SqlCommand.CommandText = query
            adoRs = SqlCommand.ExecuteReader()

            If adoRs.HasRows Then

                Do While adoRs.Read

                    new_used_sum = CLng(new_used_sum + CLng(adoRs("tcount")))

                    If UCase(adoRs("journ_newac_flag")) = "N" Then
                        graph_info = "Used"
                    ElseIf UCase(adoRs("journ_newac_flag")) = "Y" Then
                        graph_info = "New"
                    End If
                    aData1(x) = adoRs("tcount")
                    x = x + 1
                Loop


                Me.M_TREND.Titles.Clear()
                Me.M_TREND.Series.Clear()


                Me.M_TREND.Series.Add("M_TREND").ChartType = UI.DataVisualization.Charting.SeriesChartType.Pie
                Me.M_TREND.Series("M_TREND").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32
                Me.M_TREND.Series("M_TREND").LabelForeColor = Drawing.Color.Blue


                calculate_min_max(aData1, x, "AC For Sale")



                For i = 0 To x - 1
                    new_used_percent(i) = CDbl((CDbl(aData1(i)) / CDbl(new_used_sum)) * CDbl(100))
                    Me.M_TREND.Series("M_TREND").Points.Add(new_used_percent(i))

                    If i = 0 Then
                        Me.M_TREND.Series("M_TREND").Points.Last.Label = "Used - " & FormatNumber(new_used_percent(i), 1).ToString & " %"
                    ElseIf i = 1 Then
                        Me.M_TREND.Series("M_TREND").Points.Last.Label = "New - " & FormatNumber(new_used_percent(i), 1).ToString & " %"
                    End If



                Next


                Me.M_TREND.ChartAreas("ChartArea1").Area3DStyle.Enable3D = True
                Me.M_TREND.ChartAreas("ChartArea1").Area3DStyle.Rotation = 10
                Me.M_TREND.Titles.Add("NEW VS. USED SALES")
                Me.M_TREND.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
                Me.M_TREND.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" + amod_id.ToString + "N_V_U_SALES.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)


                ' outstring = outstring & "data.setCell(" & x & ", 0, '" & graph_info & "','" & graph_info & " (" & FormatNumber(new_used_percent, 1, False, False, False) & "%)');" & vbCrLf
                ' outstring = outstring & "data.setCell(" & x & ", 1, " & CStr(round(adoRs("tcount").value, 0)) & ");" & vbCrLf

                adoRs.Close()
                adoRs = Nothing
                outstring = "1"
            Else
                outstring = ""
            End If

            If Trim(outstring) <> "" Then
                outstring = "<table id='newUsedOuterTable' width='100%' height='" & table_height & "' cellspacing='0' cellpadding='1' class='module'>"
                outstring = outstring & "<tr><td valign='top' align='left' class='header' colspan='2' style='padding-left:3px;'>NEW VS. USED SALES: "
                If amod_id > 0 Then
                    outstring = outstring & real_make_model_name
                ElseIf Trim(make_name) <> "" Then
                    outstring = outstring & make_name.ToString.ToUpper
                Else
                    outstring = outstring & "ALL MAKES/MODELS"
                End If
                outstring = outstring & "</td></tr>"
                outstring = outstring & "<tr><td valign='top' align='left' class='tabheader'><strong>NEW VS. USED: "
                If amod_id > 0 Then
                    outstring = outstring & real_make_model_name
                ElseIf Trim(make_name) <> "" Then
                    outstring = outstring & make_name.ToString.ToUpper
                Else
                    outstring = outstring & "ALL MAKES/MODELS"
                End If
                outstring = outstring & "</strong></td><td width='20%' class='border_bottom'>&nbsp;</td></tr>"
                outstring = outstring & "<tr><td valign='top' align='center' class='border_bottom_right' colspan='2'><div style='width:300px; height:" & table_height & "px;'><img src='" + amod_id.ToString + "N_V_U_SALES.jpg'></div></td></tr></table></td>"
            Else
                outstring = "<table id='newUsedOuterTable' width='100%' height='" & table_height & "' cellspacing='0' cellpadding='1' class='module'>"
                outstring = outstring & "<tr><td valign='top' align='left' class='header' colspan='2' style='padding-left:3px;'>NEW VS. USED SALES</td></tr>"
                outstring = outstring & "<tr><td valign='top' align='left' class='tabheader'><strong>NEW VS. USED: " & make_model_or_make_for_title & "</strong></td><td width='20%' class='border_bottom'>&nbsp;</td></tr>"
                outstring = outstring & "<tr><td valign='top' align='center' class='border_bottom_right' colspan='2'><div style='width:300px; height:" & table_height & "px;'>No Graph Data</div></td></tr></table></td>"
            End If

            display_new_vs_used_piechart = Trim(outstring)
        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function

    Function display_leased_per_month(ByVal table_height As Integer, ByVal real_make_model_name As String, ByVal amod_id As Integer, ByVal marketViewTimeSpan As Integer, ByVal airframe_type As String, ByVal product_codes As String, ByVal make_name As String, ByVal make_model_or_make_for_title As String) As String
        display_leased_per_month = ""

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim adoRs As System.Data.SqlClient.SqlDataReader : adoRs = Nothing
        Dim aData1(1000)
        Dim aLabels1(1000)
        Dim i As Integer = 0
        Dim info_for_current_month As Boolean = False

        Try
            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60

            Dim outstring As String = ""
            Dim x As Integer = 0
            Dim query As String = ""

            query = "SELECT YEAR(journ_date) AS aYear, MONTH(journ_date) AS amonth, count(*) AS acount"
            query = query & " FROM Journal WITH(NOLOCK) INNER JOIN Aircraft WITH(NOLOCK) ON journ_ac_id = ac_id AND journ_id = ac_journ_id"
            query = query & " INNER JOIN aircraft_model WITH(NOLOCK) ON ac_amod_id = amod_id"
            query = query & " WHERE (journ_date >= '" & Month(DateAdd("m", (-1) * marketViewTimeSpan, Now)) & "/01/" & Year(DateAdd("m", (-1) * marketViewTimeSpan, Now)) & "')"
            query = query & " AND (journ_date < '" & Month(Now) & "/" & Day(Now) & "/" & Year(Now) & "')"
            query = query & " AND journ_subcategory_code LIKE 'L%' AND right(journ_subcategory_code,4) <> 'CORR' AND right(journ_subcategory_code,2) <> 'IT'"

            ' query = query & commonEVO.GenerateProductCodeSelectionQuery(Session.Item("localSubscription"), False, True)
            query = query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(Session.Item("localSubscription"), False, True)


            If Trim(make_name) <> "" Then
                query = query & " AND amod_make_name = '" & make_name & "' "
            ElseIf amod_id > 0 Then
                query = query & " AND amod_id = " & amod_id
            ElseIf Trim(airframe_type) <> "" Then
                query = query & " AND amod_type_code = '" & Trim(airframe_type) & "'"
            End If


            If product_codes.ToString.Trim <> "" Then
                If product_codes.ToString.Trim = "B" Then
                    query = query & " AND amod_product_business_flag='Y' "
                ElseIf product_codes.ToString.Trim = "C" Then
                    query = query & " AND amod_product_commercial_flag='Y' "
                ElseIf product_codes.ToString.Trim = "H" Then
                    query = query & " AND amod_product_helicopter_flag='Y' "
                End If
            End If


            query = query & " GROUP BY year(journ_date), month(journ_date)"
            query = query & " ORDER BY year(journ_date), month(journ_date)"

            If Session("debug") Then
                Response.Write("<b>display_leased_per_month:" & Server.HtmlEncode(query) & "</b><br /><br />")
            End If

            SqlCommand.CommandText = query
            adoRs = SqlCommand.ExecuteReader()

            If adoRs.HasRows Then

                Do While adoRs.Read

                    aLabels1(x) = CStr(adoRs("aMonth")) & "-" & CStr(adoRs("aYear"))
                    aData1(x) = FormatNumber(adoRs("aCount"), 2, False, False, False)

                    x = x + 1
                Loop

                outstring = "1"
            Else
                outstring = ""
            End If

            adoRs.Close()
            adoRs.Dispose()
            adoRs = Nothing

            Me.M_TREND.Titles.Clear()
            Me.M_TREND.Series.Clear()

            Me.M_TREND.Series.Add("M_TREND").ChartType = UI.DataVisualization.Charting.SeriesChartType.Spline
            Me.M_TREND.Series("M_TREND").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32
            Me.M_TREND.Series("M_TREND").LabelForeColor = Drawing.Color.Blue
            Me.M_TREND.ChartAreas("ChartArea1").AxisY.Title = "Leasses"
            Me.M_TREND.Series("M_TREND").Color = Drawing.Color.Blue
            Me.M_TREND.Series("M_TREND").BorderWidth = 2
            Me.M_TREND.Series("M_TREND").MarkerSize = 5
            Me.M_TREND.Series("M_TREND").MarkerStyle = UI.DataVisualization.Charting.MarkerStyle.Circle
            '  Me.AVG_PRICE_MONTH.BorderlineWidth = 10
            Me.M_TREND.Series("M_TREND").YValueType = UI.DataVisualization.Charting.ChartValueType.Int32

            If x > 0 Then
                calculate_min_max(aData1, x, "AC For Sale")
            End If

            For i = 0 To x - 1

                If i = x - 1 And Left(aLabels1(i), 2) = Month(Now) Then
                    Me.M_TREND.Series("M_TREND").Points.AddXY("Month to Date", aData1(i))
                    info_for_current_month = True
                Else
                    Me.M_TREND.Series("M_TREND").Points.AddXY(aLabels1(i), aData1(i))
                End If

            Next

            If info_for_current_month = True Then
                Me.M_TREND.Series("M_TREND").Points.Last.Color = Drawing.Color.Black
                Me.M_TREND.Series("M_TREND").Points.Last.BorderDashStyle = DataVisualization.Charting.ChartDashStyle.Dash
            End If

            Me.M_TREND.Titles.Add("LEASE TRENDS (# of Lease Transactions)")
            Me.M_TREND.ImageType = DataVisualization.Charting.ChartImageType.Jpeg
            Me.M_TREND.SaveImage(HttpContext.Current.Server.MapPath(Session.Item("MarketSummaryFolderVirtualPath").ToString) + "\" + amod_id.ToString + "S_TREND.jpg", DataVisualization.Charting.ChartImageFormat.Jpeg)

            If Trim(outstring) <> "" Then
                outstring = "<table width='100%' height='" & table_height & "' cellpadding='1' cellspacing='0' class='module'>"
                outstring = outstring & "<tr><td valign='top' align='left' class='header' colspan='2' style='padding-left:3px;'>LEASE TRENDS (<em># of Lease Transactions</em>)</td></tr>"
                outstring = outstring & "<tr><td valign='top' align='left' class='tabheader'><strong>" & make_model_or_make_for_title.ToUpper & " LEASE TRENDS</strong></td><td width='20%' class='border_bottom'>&nbsp;</td>"
                outstring = outstring & "<tr><td valign='top' align='center' class='border_bottom_right' colspan='2'><div style='width:300px; height:" & table_height & "px;'><img src='" + amod_id.ToString + "S_TREND.jpg'></div></td></tr></table></td>"
            Else
                outstring = "<table width='100%' height='" & table_height & "' cellpadding='1' cellspacing='0' class='module'>"
                outstring = outstring & "<tr><td valign='top' align='left' class='header' colspan='2' style='padding-left:3px;'>LEASE TRENDS (<em># of Lease Transactions</em>)</td></tr>"
                outstring = outstring & "<tr><td valign='top' align='left' class='tabheader'><strong>" & make_model_or_make_for_title.ToUpper & " LEASE TRENDS</strong></td><td width='20%' class='border_bottom'>&nbsp;</td>"
                outstring = outstring & "<tr><td valign='top' align='center' class='border_bottom_right' colspan='2'><div style='width:300px; height:" & table_height & "px;'>No Graph Data</div></td></tr></table></td>"
            End If

            display_leased_per_month = Trim(outstring)
        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function

    Public Function Build_PDF_Template_Header_Final_orig() As String
        Build_PDF_Template_Header_Final_orig = ""
        Try
            Dim sServerMapPath As String = ""
            Dim sSiteStyleSheet As String = "common\jetnet.css"
            sServerMapPath = Server.MapPath(sSiteStyleSheet)
            Dim txtFile As New System.IO.StreamReader(sServerMapPath)
            Dim readStyle As String = ""
            Dim formatStyle As String = ""
            readStyle = "<style>"
            Do While txtFile.EndOfStream <> True
                formatStyle = txtFile.ReadLine()
                If Trim(formatStyle.StartsWith(".border_bottom")) Then
                    formatStyle = formatStyle.Replace("0px", "1px")
                ElseIf Trim(formatStyle.StartsWith(".border_bottom_right")) Then
                    formatStyle = formatStyle.Replace("0px", "1px")
                ElseIf Trim(formatStyle.StartsWith(".leftside")) Then
                    formatStyle = formatStyle.Replace("0px", "1px")
                ElseIf Trim(formatStyle.StartsWith(".rightside")) Then
                    formatStyle = formatStyle.Replace("0px", "1px")
                ElseIf Trim(readStyle.EndsWith("TD{")) Then
                    formatStyle = formatStyle.Replace("8pt", "12pt")
                End If
                readStyle = readStyle & formatStyle
            Loop
            readStyle = readStyle & ".break { page-break-before: always; }" & vbCrLf

            readStyle = readStyle & "</style>" & vbCrLf
            Build_PDF_Template_Header_Final_orig = "<html><head>" & vbCrLf & readStyle & "</head><body>" & vbCrLf

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in Build_PDF_Template_Header: " & ex.Message
        End Try
    End Function
    Public Function Build_PDF_Template_Header_Final(ByRef this_element As RadioButtonList) As String
        Build_PDF_Template_Header_Final = ""
        Try
            Dim sServerMapPath As String = ""
            '   Dim sSiteStyleSheet As String = "common\jetnet.css"
            Dim sSiteStyleSheet As String = "common\style.css"
            sServerMapPath = Server.MapPath(sSiteStyleSheet)
            Dim txtFile As New System.IO.StreamReader(sServerMapPath)
            Dim readStyle As String = ""
            Dim formatStyle As String = ""
            readStyle = "<style type='text/css'>"
            Do While txtFile.EndOfStream <> True
                formatStyle = txtFile.ReadLine()
                If Trim(formatStyle.StartsWith(".border_bottom")) Then
                    formatStyle = formatStyle.Replace("0px", "1px")
                ElseIf Trim(formatStyle.StartsWith(".border_bottom_right")) Then
                    formatStyle = formatStyle.Replace("0px", "1px")
                ElseIf Trim(formatStyle.StartsWith(".leftside")) Then
                    formatStyle = formatStyle.Replace("0px", "1px")
                ElseIf Trim(formatStyle.StartsWith(".rightside")) Then
                    formatStyle = formatStyle.Replace("0px", "1px")
                ElseIf Trim(readStyle.EndsWith("TD{")) Then
                    formatStyle = formatStyle.Replace("8pt", "12pt")
                End If
                readStyle = readStyle & formatStyle
            Loop
            readStyle = readStyle & ".break { page-break-before: always; }" & vbCrLf


            If this_element.SelectedValue = "Word" Then
                readStyle = readStyle & ".small_text{font-family:Arial;font-size: xx-small}" & vbCrLf
                readStyle = readStyle & ".small_bold_text{font-family:Arial;font-size: xx-small; font-weight: bold;}" & vbCrLf
            Else
                readStyle = readStyle & ".small_text{font-family:Arial;font-size: x-small}" & vbCrLf
                readStyle = readStyle & ".small_bold_text{font-family:Arial;font-size: x-small; font-weight: bold;}" & vbCrLf
            End If

            readStyle = readStyle & ".table_specs{font-size:12px;}" & vbCrLf
            readStyle = readStyle & "</style>" & vbCrLf
            Build_PDF_Template_Header_Final = "<html><head>" & vbCrLf & readStyle & "</head><body>" & vbCrLf

        Catch ex As Exception
            '  aCommonEvo.DisplayAlert("Error in Build_PDF_Template_Header: " & ex.Message)
        End Try
    End Function


    Public Function get_company_name(ByVal comp_id) As String
        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim localAdoRs2 As System.Data.SqlClient.SqlDataReader : localAdoRs2 = Nothing
        Dim Query As String = ""
        get_company_name = ""

        Try
            SqlConn.ConnectionString = Session.Item("localPreferences").UserDatabaseConn

            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60

            Query = "SELECT comp_name FROM Company WITH(NOLOCK) WHERE comp_id = " + comp_id.ToString

            SqlCommand.CommandText = Query
            localAdoRs2 = SqlCommand.ExecuteReader()
            If localAdoRs2.HasRows Then
                ' EXTRA QUERY TAKEN OUT
                localAdoRs2.Read()
                'End If

                'TYPE_OF_AC = localAdoRs2.Item("amod_airframe_type_code").ToString
                get_company_name = localAdoRs2.Item("comp_name")

            End If
        Catch ex As Exception
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function

    Public Function Build_PDF_Form_Final(ByVal View_Type, ByVal Company_Name, ByVal Model_Name, ByVal Country, ByVal City, ByVal Airframe, ByVal engine_name, ByVal business_type_from_dropdown, ByVal year1, ByVal year2, ByVal weight_class_name, ByVal make_name, ByVal months, ByVal model_name2, ByVal model_name3)
        Build_PDF_Form_Final = "" ' section that puts the correct check boxes visible and labels the form. 
        Dim temp_view_type As String = ""



        If View_Type = 1 And all_pdf = False Then
            temp_view_type = "MODEL MARKET"
            Me.CP.Text = "Cover Page with Model Description"
            Me.prepared_panel.Visible = True
        ElseIf View_Type = 2 And all_pdf = False Then
            temp_view_type = "MODEL COMPARISON"
        ElseIf View_Type = 3 And all_pdf = False Then
            temp_view_type = "OPERATOR"
            Me.CP.Text = "Cover Page with Model Description"
        ElseIf View_Type = 4 And all_pdf = False Then
            temp_view_type = "FINANCIAL AND TRANSACTION DOCUMNETS"
            Me.CP.Text = "Cover Page with Model Description"
            Me.WD.Items.Clear()
            Me.WD.Items.Add(New System.Web.UI.WebControls.ListItem("EXCEL", "EXCEL"))
        ElseIf View_Type = 9 And all_pdf = False Then
            temp_view_type = "FINANCIAL "
            Me.CP.Visible = True
        ElseIf View_Type = 10 And all_pdf = False Then
            temp_view_type = "CHARTER"
            Me.CP.Checked = False
        ElseIf View_Type = 12 And all_pdf = False Then
            temp_view_type = "SPI"
            Me.CP.Checked = False
        ElseIf View_Type = 13 And all_pdf = False Then
            temp_view_type = "LEASE"
            Me.CP.Text = "Cover Page with Model Description (Market Status/Trends)"
        ElseIf View_Type = 998 Then   ' 999 is the printdetials pdf old asp page
            temp_view_type = "Market Report"
            Me.CP.Visible = True
        ElseIf View_Type = 999 And all_pdf = False Then   ' 999 is the printdetials pdf old asp page
            temp_view_type = "Print Aircraft Specs"
            Me.CP.Visible = True
        ElseIf View_Type = 100 Then   ' 100 is going to be the all pdf
            temp_view_type = "Print All Model Information"
            Me.CP.Visible = True
        ElseIf View_Type = 111 Then   ' 100 is going to be the all pdf
            temp_view_type = "Asset Insight Report"
            Me.CP.Visible = True
        End If




        If View_Type > 0 Then  ' if there is a view selected , it will display cover page checkbox and the label

            Me.view_type_label.Text = temp_view_type.ToString.ToUpper
            Master.SetPageTitle(temp_view_type.ToString & " Selections")

            Me.btnRunReport.Visible = True
            Me.btnRunReport.Enabled = True
        Else        ' if there is no view selected, there should be nothing showing - also if no valid subscription found 
            Me.CP.Visible = False
            Me.view_type_label.Text = ""
            Me.btnRunReport.Visible = False
            Me.btnRunReport.Enabled = False
        End If



        If Company_Name.ToString.Trim <> "" Then
            Me.form_title.Text = Company_Name
        ElseIf City.ToString.Trim <> "" Then
            Me.form_title.Text = City
        ElseIf Country.ToString.Trim <> "" Then
            Me.form_title.Text = Country
        Else
            Me.form_title.Text = ""
        End If


        If (Model_Name.ToString.Trim <> "" Or Airframe.ToString.Trim <> "" Or business_type_from_dropdown.ToString.Trim <> "") And (Company_Name.ToString.Trim <> "" Or City.ToString.Trim <> "" Or Country.ToString.Trim <> "") Then
            Me.form_title.Text += " - "
        End If



        If View_Type = 2 Then
            Me.form_title.Text += Model_Name & " - " & model_name2 & " - " & model_name3
        ElseIf Not View_Type = 9 Then
            If Model_Name.ToString.Trim <> "" Then
                Me.form_title.Text += Model_Name
                If View_Type <> 1 Then
                    If business_type_from_dropdown.ToString.Trim <> "" Then
                        Me.form_title.Text += " - " & business_type_from_dropdown
                    End If
                End If
            ElseIf business_type_from_dropdown.ToString.Trim <> "" Then
                Me.form_title.Text += business_type_from_dropdown
            End If
        Else
            If Model_Name.ToString.Trim <> "" Then
                Me.form_title.Text += Model_Name
                If business_type_from_dropdown.ToString.Trim <> "" Then
                    Me.form_title.Text += " - " & business_type_from_dropdown
                End If
            ElseIf Airframe > 0 Then
                Me.form_title.Text += Airframe
            ElseIf business_type_from_dropdown.ToString.Trim <> "" Then
                Me.form_title.Text += business_type_from_dropdown
            End If

            If make_name.ToString.Trim <> "" Then
                Me.form_title.Text += " - " & make_name.ToString.ToUpper
            End If

            If months > 0 Then
                Me.form_title.Text += "-" & months.ToString.Trim & " Months "
            End If
        End If
        ' each view will either turn on or turn off its selected checkboxes









        '----------------------------- MODEL MARKET SUMMARY CHECKBOXES ----------------------

        If View_Type = 1 Then

            If Not IsNothing(Request.Item("PDF_Page_Flag")) Then
                If Not String.IsNullOrEmpty(Request.Item("PDF_Page_Flag").ToString) Then
                    PDF_Page_Flag = Request.Item("PDF_Page_Flag").Trim
                End If
            End If

            Me.logo_check.Visible = True
            Me.indent_label.Visible = True

            If Session.Item("localPreferences").UserSPIViewFlag = True Then
                Me.MMS_Sale_Prices.Visible = True
            Else
                Me.MMS_Sale_Prices.Visible = False
                Me.MMS_Sale_Prices.Checked = False
            End If


            If Me.PDF_Page_Flag.Trim.ToUpper = "OC" Then
                Me.CP.Visible = False
                Me.MMS_FMS.Visible = False
                Me.MMS_BPS.Visible = False
                Me.MMS_BOC.Visible = True
                Me.MMS_BAFS.Visible = False
                Me.MMS_BRRS.Visible = False
                Me.MMS_BRMA.Visible = False
                Me.MMS_STAT.Visible = False
                Me.CP.Checked = False
                Me.MMS_FMS.Checked = False
                Me.MMS_BPS.Checked = False
                Me.MMS_BOC.Checked = True
                Me.MMS_BAFS.Checked = False
                Me.MMS_BRRS.Checked = False
                Me.MMS_BRMA.Checked = False
                Me.MMS_STAT.Checked = False


            ElseIf Me.PDF_Page_Flag.Trim.ToUpper = "PS" Then
                Me.CP.Visible = False
                Me.MMS_FMS.Visible = False
                Me.MMS_BPS.Visible = True
                Me.MMS_BOC.Visible = False
                Me.MMS_BAFS.Visible = False
                Me.MMS_BRRS.Visible = False
                Me.MMS_BRMA.Visible = False
                Me.MMS_STAT.Visible = False
                Me.CP.Checked = False
                Me.MMS_FMS.Checked = False
                Me.MMS_BPS.Checked = True
                Me.MMS_BOC.Checked = False
                Me.MMS_BAFS.Checked = False
                Me.MMS_BRRS.Checked = False
                Me.MMS_BRMA.Checked = False
                Me.MMS_STAT.Checked = False
            Else
                If Me.TYPE_OF_AC.ToUpper = "R" Or Me.TYPE_OF_AC.ToUpper = "" Then
                    MMS_BOC.Visible = True
                Else
                    MMS_BOC.Visible = False
                End If

                If Model_Name <> "" Then
                    Me.CP.Visible = True
                Else
                    Me.CP.Visible = False
                    Me.CP.Checked = False
                End If

                Me.MMS_FMS.Visible = True
                Me.MMS_BPS.Visible = True
                Me.MMS_BOC.Visible = True
                Me.MMS_BAFS.Visible = True
                Me.MMS_BRRS.Visible = True
                Me.MMS_STAT.Visible = True
                Me.useStandardOrMetric.Visible = True

            End If

            'added msw - make inisible if you are aerodex
            If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Then
                Me.MMS_STAT.Visible = False
                Me.MMS_STAT.Checked = False
                Me.indent_label.Visible = False
                Me.MMS_CHARTS.Visible = False
                Me.MMS_CHARTS.Checked = False
                Me.CRM_Wanteds.Visible = False
                Me.CRM_Wanteds.Checked = False
                Me.MMS_UP.Visible = False
                Me.MMS_UP.Checked = False
            ElseIf Trim(Request("new_PDF")) = "Y" Then
                Me.CRM_Wanteds.Visible = True
                Me.CRM_Wanteds.Checked = True
            End If


            ' added MSW ----to add the op costs into mms ----------------
            Me.MMS_OP_COSTS_2.Visible = True
            ' ------------------------------

        ElseIf all_pdf = False Then
            Me.CP.Visible = False

            Me.MMS_BPS.Visible = False
            Me.MMS_BOC.Visible = False
            Me.MMS_BAFS.Visible = False
            Me.MMS_BRRS.Visible = False
            Me.MMS_BRMA.Visible = False
            Me.MMS_UP.Visible = False
            Me.MMS_AA.Visible = False
            Me.MMS_BRMA.Visible = False
            Me.MMS_CHARTS.Visible = False
            Me.useStandardOrMetric.Visible = False

            Me.MMS_BPS.Checked = False
            Me.MMS_BOC.Checked = False
            Me.MMS_BAFS.Checked = False
            Me.MMS_BRRS.Checked = False
            Me.MMS_BRMA.Checked = False
        End If
        '----------------------------- MODEL MARKET SUMMARY CHECKBOXES ----------------------



        '----------------------------- MODEL COMPARISON CHECKBOXES ----------------------
        If View_Type = 2 Then
            Me.MCOMP_FMS.Visible = True
            Me.MC_AVG_PRICE.Visible = True
            Me.MC_FSBM.Visible = True
            Me.MC_SOLD_PM.Visible = True
            Me.MC_AVG_DOM.Visible = True
        ElseIf all_pdf = False Then
            Me.MCOMP_FMS.Visible = False
            Me.MCOMP_FMS.Checked = False

            Me.MC_SOLD_PM.Visible = False
            Me.MC_SOLD_PM.Checked = False

            Me.MC_FSBM.Visible = False
            Me.MC_FSBM.Checked = False

            Me.MC_AVG_PRICE.Visible = False
            Me.MC_AVG_PRICE.Checked = False

            Me.MC_AVG_DOM.Visible = False
            Me.MC_AVG_DOM.Checked = False

        End If
        '----------------------------- MODEL COMPARISON CHECKBOXES ----------------------








        '----------------------------- OPERATOR SUMMARY CHECKBOXES ----------------------
        If View_Type = 3 Then



            If Company_Name <> "" Then ' company gets company and details 
                Me.O_OS.Visible = True
                Me.O_OS.Text = "Operator Details"
                Me.O_AC.Visible = True
            Else
                Me.O_OS.Visible = True
                Me.O_OS.Text = "Operator Summary"
            End If


            If Model_Name <> "" Then
                Me.O_AC.Visible = True
                Me.O_COUNTRY.Visible = True
                Me.CP.Visible = True

                Me.O_MOD.Visible = False
                Me.O_MOD.Checked = False
            Else
                Me.O_MOD.Visible = True
                Me.CP.Visible = False

                Me.CP.Visible = False

                If Not Company_Name <> "" Then
                    Me.O_AC.Visible = False
                    Me.O_AC.Checked = False
                End If

            End If

            If business_type_from_dropdown.ToString.ToUpper = "COMMERCIAL" And Model_Name <> "" And Company_Name = "" Then
                Me.O_ENG.Visible = True
                Me.O_COUNTRY.Checked = False
                Me.O_COUNTRY.Visible = False
            ElseIf business_type_from_dropdown.ToString.ToUpper <> "COMMERCIAL" And Model_Name <> "" And Company_Name = "" Then
                Me.O_COUNTRY.Visible = True

                Me.O_ENG.Visible = False
                Me.O_ENG.Checked = False
            Else
                Me.O_ENG.Visible = False
                Me.O_ENG.Checked = False
                Me.O_COUNTRY.Checked = False
                Me.O_COUNTRY.Visible = False
            End If

        ElseIf all_pdf = False Then
            Me.O_AC.Visible = False
            Me.O_COUNTRY.Visible = False
            Me.O_MOD.Visible = False
            Me.O_ENG.Visible = False
            Me.O_OS.Visible = False

            Me.O_ENG.Checked = False
            Me.O_AC.Checked = False
            Me.O_COUNTRY.Checked = False
            Me.O_MOD.Checked = False
            Me.O_OS.Checked = False
        End If
        '----------------------------- OPERATOR SUMMARY CHECKBOXES ----------------------


        '----------------------------- FINANCIAL VIEW SUMMMARY ----------------------
        If View_Type = 9 Then
            Me.CP.Visible = True
            Me.L_LDTE.Visible = True
            Me.MMS_FMS.Visible = True


            Me.F_DSPM.Visible = True
            Me.F_DFS.Visible = True
            Me.F_DTD.Visible = True
            Me.F_DM.Visible = True
            Me.F_LTG.Visible = True
            Me.F_NVU.Visible = True
        ElseIf all_pdf = False Then
            Me.F_DSPM.Visible = False
            Me.F_DFS.Visible = False
            Me.F_DTD.Visible = False
            Me.F_DM.Visible = False
            Me.F_LTG.Visible = False
            Me.F_NVU.Visible = False


            Me.F_DSPM.Checked = False
            Me.F_DFS.Checked = False
            Me.F_DTD.Checked = False
            Me.F_DM.Checked = False
            Me.F_LTG.Checked = False
            Me.F_NVU.Checked = False
        End If
        '----------------------------- FINANCIAL VIEW SUMMMARY ----------------------




        '-------------------------- CHARTER VIEW CHECKBOXES -------------------------------------
        If View_Type = 10 Then
            Me.CP.Visible = False

            If Model_Name.ToString.Trim <> "" Then   ' if model show ac and pics/specs  - hide models and airframe 
                Me.C_AC.Visible = True
                Me.C_MPAS.Visible = True

                Me.C_MOD.Visible = False
                Me.C_MOD.Checked = False
                Me.C_AF.Visible = False
                Me.C_AF.Checked = False
            ElseIf Airframe.ToString.Trim <> "" Then ' if no model but airframe, show model list and aircraft, no airframe or pics/specs
                Me.C_AC.Visible = True
                Me.C_MOD.Visible = True
                Me.C_MPAS.Visible = False
                Me.C_AF.Visible = False

                Me.C_MPAS.Checked = False
                Me.C_AF.Checked = False
            Else      ' if no airframe of model, then show airframe list and model list, no ac or pics/specs 
                Me.C_AC.Visible = False
                Me.C_MPAS.Visible = False
                Me.C_MOD.Visible = True
                Me.C_AF.Visible = True

                Me.C_AC.Checked = False
                Me.C_MPAS.Checked = False
            End If


            If Company_Name.ToString.Trim = "" Then  ' if there is no company name, show operators and country or city 
                Me.C_OP.Visible = True

                If Country.ToString.Trim <> "" Then
                    Me.C_LOCITY.Visible = True
                    Me.C_LOC.Visible = False
                    Me.C_LOC.Checked = False
                ElseIf City.ToString.Trim = "" Then
                    Me.C_LOC.Visible = True
                    Me.C_LOCITY.Visible = False
                    Me.C_LOCITY.Checked = False
                End If
            Else       'if there is a company name the dont show operators or country/city
                Me.C_OP.Visible = False
                Me.C_LOC.Visible = False
                Me.C_LOCITY.Visible = False
                Me.C_OP.Checked = False
                Me.C_LOC.Checked = False
                Me.C_LOCITY.Checked = False
            End If

        ElseIf all_pdf = False Then

            Me.C_AC.Visible = False
            Me.C_AF.Visible = False
            Me.C_LOCITY.Visible = False
            Me.C_LOC.Visible = False
            Me.C_MOD.Visible = False
            Me.C_OP.Visible = False
            Me.C_MPAS.Visible = False

            Me.C_MPAS.Checked = False
            Me.C_AC.Checked = False
            Me.C_AF.Checked = False
            Me.C_LOCITY.Checked = False
            Me.C_LOC.Checked = False
            Me.C_MOD.Checked = False
            Me.C_OP.Checked = False

        End If
        '-------------------------- CHARTER VIEW CHECKBOXES -------------------------------------




        '-------------------------- SPI VIEW CHECKBOXES -------------------------------------
        If View_Type = 12 Then
            Me.S_FQ.Visible = True
            Me.S_SM.Visible = True
            Me.S_COL.Visible = True
            Me.S_3D.Visible = True
            Me.S_COL_LABEL.Visible = True
        ElseIf all_pdf = False Then
            Me.S_SM.Checked = False
            Me.S_SM.Visible = False
            Me.S_FQ.Checked = False
            Me.S_FQ.Visible = False
            Me.S_FQ.Checked = False
            Me.S_COL.Visible = False
            Me.S_3D.Visible = False
            Me.S_3D.Checked = False
            Me.S_COL_LABEL.Visible = False
        End If
        '-------------------------- SPI VIEW CHECKBOXES -------------------------------------





        '-------------------------- LEASE VIEW CHECKBOXES -------------------------------------
        If View_Type = 13 Then

            Me.CP.Visible = True


            If Model_Name.ToString.Trim = "" Then  ' if no model, show models, but dont show aircraft
                Me.L_TM.Visible = True
                Me.L_AL.Visible = False

                Me.L_AL.Checked = False
            Else
                Me.L_TM.Visible = False
                Me.L_AL.Visible = True

                Me.L_TM.Checked = False
            End If

            If Company_Name.ToString.Trim = "" Then
                Me.L_TL.Visible = True

            Else
                Me.L_TL.Visible = False
                Me.L_TL.Checked = False
            End If




            Me.L_MRT.Visible = True
            Me.L_LE.Visible = True
            Me.L_LDTE.Visible = True

        ElseIf all_pdf = False Then
            Me.L_TM.Visible = False
            Me.L_TL.Visible = False
            Me.L_AL.Visible = False
            Me.L_MRT.Visible = False




            Me.L_TM.Checked = False
            Me.L_TL.Checked = False
            Me.L_AL.Checked = False
            Me.L_MRT.Checked = False

        End If
        '-------------------------- LEASE VIEW CHECKBOXES -------------------------------------


        ' if not financial or lease 
        If View_Type <> 9 And View_Type <> 13 Then
            Me.L_LDTE.Visible = False
            Me.L_LDTE.Checked = False
            Me.L_LE.Checked = False
            Me.L_LE.Visible = False
        End If

        ' if not financial or mms 
        If View_Type <> 9 And View_Type <> 1 Then
            Me.MMS_FMS.Visible = False
            Me.MMS_FMS.Checked = False
        End If

        If View_Type = 999 Then
            Me.PAD_DET.Visible = True
        Else
            Me.PAD_DET.Visible = False
            Me.PAD_DET.Checked = False
        End If





        If View_Type = 100 Then
            Me.Lease_View_PDF.Visible = True
            Me.Operator_View_PDF.Visible = True
            Me.btnRunReport.Visible = False
            Me.btnRunReport.Enabled = False
            Me.select_all_types_button.Visible = True
            Me.select_all_types_button.Enabled = True
        Else
            Me.Lease_View_PDF.Visible = False
            Me.Operator_View_PDF.Visible = False
            Me.select_all_types_button.Visible = False
            Me.select_all_types_button.Enabled = False
        End If

        If View_Type = 111 Then
            Me.CP.Visible = True

        End If


        If View_Type = 997 Then
            Me.MR_CMS.Visible = True
            Me.sales_panel.Visible = False
            Me.MR_MARKET_CHARACTERISTICS.Visible = False
            Me.MR_LOCATIONS.Visible = False

        ElseIf View_Type = 997 Or View_Type = 998 Then
            If Trim(Request("ac_id")) <> "" Then
                Me.ac_checkbox_panel.Visible = True
            End If
            chk_alt_name.Visible = True
            rangeTab.Visible = True
            Me.CP.Visible = True
            Me.CP.Text = "Cover Page"
            Me.chk_header.Visible = True
            Me.MR_Fleet.Visible = True
            Me.MR_DOM.Visible = True
            Me.MR_CMS.Visible = True
            Me.MR_CMACFORSALE.Visible = True
            Me.MR_SITRENS.Visible = True
            Me.MR_RRS.Visible = True
            Me.MR_STBMFR.Visible = True
            Me.MR_STBM.Visible = True
            Me.MR_STBAFTT.Visible = True
            Me.MR_STBWC.Visible = True
            'Me.indent_label2.CssClass = "display_none"
            Me.indent_label.Visible = False ' for the current market summary 
            Me.S_COL_LABEL.Visible = True
            Me.market_color.Visible = True
            Me.logo_check.Visible = True
            Me.prepared_panel.Visible = True
            Me.MR_Panel1.Visible = True
            MR_UTILIZATION.Visible = True
            Me.MR_UPGRADE.Visible = True
            Me.MR_RECENT_MARKET.Visible = True
            'Me.MR_SALE_PRICES.Visible = True
            Me.month_timeframe.Visible = True
            Me.month_timeframe_label.Visible = True
            Me.MR_FSS.Visible = True
            Me.current_market_check.Visible = True
        End If


        If View_Type = 28 Then
            Me.CP.Visible = True
            Me.CP.Text = "Cover Page"
            Me.logo_check.Visible = True
            Me.prepared_panel.Visible = True
            utilizationRoutes.Visible = True
            utilizationSummary.Visible = True
            utilizationOperators.Visible = True
            utilizationModels.Visible = True
            utilizationAC.Visible = True


            If is_aport_us = True Then
                utilizationInternational.Visible = True
            Else
                utilizationInternational.Checked = False
                utilizationInternational.Visible = False
            End If

            refuel_check.Visible = True

            ' out for now 
            utilizationGraphs.Visible = True
            '  utilizationGraphs.Checked = False
        End If



    End Function
    'Private Function CreateAirportCache() As DataSet
    '  Dim airportDataSet As New DataSet
    '  Dim TemporaryTable As New DataTable
    '  Try
    '    TemporaryTable = localdatalayer.ListOfActiveAirportsControlled()
    '    TemporaryTable.TableName = "AIRPORTS"

    '    'Adding to the dataset.
    '    airportDataSet.Tables.Add(TemporaryTable)
    '  Catch ex As Exception
    '    airportDataSet = Nothing
    '  End Try

    '  Return airportDataSet
    'End Function

    'Private Sub FillAirports(ByVal fieldLength As Double)
    '  Dim TemporaryTable As New DataTable
    '  Dim AirportDataSet As New DataSet
    '  localdatalayer = New viewsDataLayer
    '  localdatalayer.adminConnectStr = Application.Item("crmClientSiteData").AdminDatabaseConn
    '  localdatalayer.clientConnectStr = Session.Item("localPreferences").UserDatabaseConn
    '  localdatalayer.starConnectStr = Session.Item("localPreferences").STARDatabaseConn
    '  localdatalayer.serverConnectStr = Session.Item("localPreferences").ServerNotesDatabaseConn

    '  If IsNothing(HttpContext.Current.Cache("AirportLookup")) Then
    '    HttpContext.Current.Cache.Insert("AirportLookup", CreateAirportCache, Nothing, DateTime.Now.AddDays(1), Cache.NoSlidingExpiration)
    '  End If

    '  If Not IsNothing(Cache("AirportLookup")) Then
    '    AirportDataSet = Cache("AirportLookup")
    '    TemporaryTable = AirportDataSet.Tables(0)
    '  End If


    '  If Not IsNothing(TemporaryTable) Then
    '    If TemporaryTable.Rows.Count > 0 Then
    '      For Each r As DataRow In TemporaryTable.Rows

    '        If fieldLength = 0 Or r("aport_max_runway_length") > fieldLength Then
    '          Dim icao As String = IIf(Not IsDBNull(r("aport_icao_code")), r("aport_icao_code"), "")
    '          Dim iata As String = IIf(Not IsDBNull(r("aport_iata_code")), r("aport_iata_code"), "")
    '          Dim city As String = IIf(Not IsDBNull(r("aport_city")), r("aport_city"), "")
    '          Dim country As String = IIf(Not IsDBNull(r("aport_country")), r("aport_country"), "")

    '          country = Replace(country, "United States", "U.S.")
    '          airport.Items.Add(New ListItem(r("aport_name") & " (" & city & IIf(Not String.IsNullOrEmpty(country), IIf(Not String.IsNullOrEmpty(city), ", " & country, country), "") & ") (" & icao & IIf(Not String.IsNullOrEmpty(iata) And Not String.IsNullOrEmpty(icao), "/", "") & iata & ")", r("aport_latitude_decimal").ToString & "|" & r("aport_longitude_decimal").ToString & "|" & r("aport_id")))
    '        End If
    '      Next
    '    End If
    '  End If

    '  airport.Items.Add(New ListItem("", ""))
    '  airport.SelectedValue = ""
    'End Sub
    'Private Sub BuildJqueryDropdownJavascript()
    '  'If Not Page.IsPostBack Then
    '  'Dim dropdownString As New StringBuilder
    '  'dropdownString.Append("swapChosenDropdowns();")
    '  'If Not Page.ClientScript.IsClientScriptBlockRegistered("chosenDropdowns") Then
    '  '  System.Web.UI.ScriptManager.RegisterStartupScript(Me, Me.GetType(), "chosenDropdowns", dropdownString.ToString, True)
    '  'End If

    '  ' End If
    'End Sub
    Public Function get_company_images(ByVal make_model_name As String) As String

        get_company_images = ""

        Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
        Dim SqlConn As New System.Data.SqlClient.SqlConnection
        Dim SqlCommand As New System.Data.SqlClient.SqlCommand
        Dim sqlReaderTemp As System.Data.SqlClient.SqlDataReader : sqlReaderTemp = Nothing
        Dim Query As String = ""
        Dim comp_id As Long = 0
        Dim htmlOutput As String = ""
        Dim tempStr As String = ""
        Dim logo_link As String = ""
        Dim image_ref As String = ""
        Dim company_name As String = ""
        Dim MainLocationDataTable As DataTable
        Dim has_main_logo As Boolean = False
        Dim ac_image_file As String = ""
        Dim temp_height As Integer = 0
        Dim temp_width As Integer = 0
        Dim zimage2 As System.Drawing.Image
        ' Dim zimage3 As System.Drawing.Image
        Dim desired_width As Integer = 500
        Dim desired_height As Integer = 142
        Dim temp_percent1 As Double = 0.0
        Dim temp_percent2 As Double = 0.0
        Dim total_width As Integer = 0
        Dim width_size_total As Integer = 740
        Dim add_pic As String = "Y"
        Dim blow_up As Boolean = False
        Dim temp_calc As Double = 0.0
        Dim imgFolder As String = ""
        Dim atemptable As New DataTable

        Try

            SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            SqlConn.Open()

            SqlCommand.Connection = SqlConn
            SqlCommand.CommandType = System.Data.CommandType.Text
            SqlCommand.CommandTimeout = 60

            If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                htmlOutput += "<table class='centerTable' border='1' bordercolor='#949494' cellpadding='2' cellspacing='0' width='" & word_width & "'><tr><td width='5'>&nbsp;</td><td>" ' start outer table
            Else
                htmlOutput += "<table class='centerTable' border='1' bordercolor='#949494' cellpadding='2' cellspacing='0' width='95%'><tr><td width='2%'>&nbsp;</td><td>" ' start outer table
            End If


            If logo_check.Checked Then
                MainLocationDataTable = Master.aclsData_Temp.GetCompanyMainLocationDescriptionLogo(Session.Item("localUser").crmUserCompanyID)

                If MainLocationDataTable.Rows.Count > 0 Then
                    Try

                        ac_image_file = HttpContext.Current.Server.MapPath("pictures\company\") & Session.Item("localUser").crmUserCompanyID.ToString + Constants.cDot + "jpg"
                        zimage2 = System.Drawing.Image.FromFile(ac_image_file)
                        temp_width = zimage2.Width
                        temp_height = zimage2.Height
                        desired_width = 150
                        desired_height = 100

                        If Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CRM Then
                            imgFolder = HttpContext.Current.Session.Item("jetnetFullHostName").ToString + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                        Else
                            imgFolder = "https://www.testjetnetevolution.com/pictures/company"
                        End If

                        Call CommonAircraftFunctions.find_image_resize_to_fit(temp_width, temp_height, desired_width, desired_height, image_ref, MainLocationDataTable.Rows(0), imgFolder, "", "jpg", "Company Logo", "Company", 0, 0, MainLocationDataTable.Rows(0).Item("comp_id"))
                        has_main_logo = True

                    Catch ex As Exception
                        If Not IsDBNull(MainLocationDataTable.Rows(0).Item("comp_logo_flag")) Then
                            If InStr(HttpContext.Current.Session.Item("jetnetFullHostName").ToString.Trim, "jetnetevo") Then
                                logo_link = HttpContext.Current.Session.Item("jetnetFullHostName").ToString.Trim + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                            Else
                                logo_link = "https://www.testjetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                            End If

                            If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                                image_ref = "<img src='" + logo_link + "/" + MainLocationDataTable.Rows(0).Item("comp_id").ToString + ".jpg' width='150' height='75'>"
                            Else
                                image_ref = "<img src='" + logo_link + "/" + MainLocationDataTable.Rows(0).Item("comp_id").ToString + ".jpg' width='150'>"
                            End If
                            has_main_logo = True
                        End If
                    End Try
                End If

            End If



            Query = " SELECT TOP 1 * FROM Company with (NOLOCK) "
            Query &= " WHERE comp_id = " & Session.Item("localUser").crmUserCompanyID & " and comp_journ_id =  0  AND comp_hide_flag = 'N' "


            SqlCommand.CommandText = Query
            sqlReaderTemp = SqlCommand.ExecuteReader()

            Try
                atemptable.Load(sqlReaderTemp)
            Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
            End Try



            If atemptable.Rows.Count > 0 Then

                company_name = atemptable.Rows(0).Item("comp_name").ToString


                If Not IsDBNull(atemptable.Rows(0).Item("comp_logo_flag")) And logo_check.Checked Then
                    If atemptable.Rows(0).Item("comp_logo_flag").ToString.ToUpper.Contains("Y") And logo_check.Checked Then

                        Try


                            ac_image_file = HttpContext.Current.Server.MapPath("pictures\company\") & Session.Item("localUser").crmUserCompanyID.ToString + Constants.cDot + "jpg"
                            zimage2 = System.Drawing.Image.FromFile(ac_image_file)
                            temp_width = zimage2.Width
                            temp_height = zimage2.Height
                            desired_width = 150
                            desired_height = 100
                            image_ref = ""


                            If Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CRM Then
                                imgFolder = HttpContext.Current.Session.Item("jetnetFullHostName").ToString + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                            Else
                                imgFolder = "https://www.testjetnetevolution.com/pictures/company/"
                            End If

                            Call CommonAircraftFunctions.find_image_resize_to_fit(temp_width, temp_height, desired_width, desired_height, image_ref, atemptable.Rows(0), imgFolder, "", "jpg", "Company Logo", "Company", 0, 0, atemptable.Rows(0).Item("comp_id"))

                        Catch ex As Exception
                            If InStr(HttpContext.Current.Session.Item("jetnetFullHostName").ToString.Trim, "jetnetevo") Then
                                logo_link = HttpContext.Current.Session.Item("jetnetFullHostName").ToString.Trim + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                            Else
                                logo_link = "https://www.testjetnetevolution.com/" + HttpContext.Current.Session.Item("CompanyPicturesFolderVirtualPath")
                            End If

                            If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                                image_ref = "<img src='" + logo_link + "/" + atemptable.Rows(0).Item("comp_id").ToString + ".jpg' width='150' height='75'>"
                            Else
                                image_ref = "<img src='" + logo_link + "/" + atemptable.Rows(0).Item("comp_id").ToString + ".jpg' width='150'>"
                            End If
                        End Try

                    End If
                End If


                tempStr = "<table class='FontSize' cellspacing='0' cellpadding='0'>"

                'If Not IsDBNull(sqlReaderTemp("comp_name")) Then
                '  If Not String.IsNullOrEmpty(sqlReaderTemp.Item("comp_name").ToString.Trim) Then
                '    tempStr += "<tr><td><font size='-1'><strong><i>" + sqlReaderTemp.Item("comp_name").ToString + "</i></strong></font></td></tr>"
                '  End If
                'End If

                If Not IsDBNull(atemptable.Rows(0).Item("comp_address1")) Then
                    If Not String.IsNullOrEmpty(atemptable.Rows(0).Item("comp_address1").ToString.Trim) Then
                        tempStr += "<tr><td><font size='-1' color='white'>" + atemptable.Rows(0).Item("comp_address1").ToString.Trim + "</font></td></tr>"
                    End If
                End If

                If Not IsDBNull(atemptable.Rows(0).Item("comp_address2")) Then
                    If Not String.IsNullOrEmpty(atemptable.Rows(0).Item("comp_address2").ToString.Trim) Then
                        tempStr += "<tr><td><font size='-1' color='white'>" + atemptable.Rows(0).Item("comp_address2").ToString.Trim + "</font></td></tr>"
                    End If
                End If

                If Not IsDBNull(atemptable.Rows(0).Item("comp_city")) Or Not IsDBNull(atemptable.Rows(0).Item("comp_state")) Or Not IsDBNull(atemptable.Rows(0).Item("comp_zip_code")) Then
                    tempStr += "<tr><td><font size='-1' color='white'>"
                End If

                If Not IsDBNull(atemptable.Rows(0).Item("comp_city")) Then
                    If Not String.IsNullOrEmpty(atemptable.Rows(0).Item("comp_city").ToString.Trim) Then

                        tempStr += atemptable.Rows(0).Item("comp_city").ToString.Trim

                        If Not IsDBNull(atemptable.Rows(0).Item("comp_state")) Then
                            If Not String.IsNullOrEmpty(atemptable.Rows(0).Item("comp_state").ToString.Trim) Then
                                tempStr += ", " + atemptable.Rows(0).Item("comp_state").ToString.Trim
                            End If
                        End If

                    End If

                Else

                    If Not IsDBNull(atemptable.Rows(0).Item("comp_state")) Then
                        If Not String.IsNullOrEmpty(atemptable.Rows(0).Item("comp_state").ToString.Trim) Then
                            tempStr += atemptable.Rows(0).Item("comp_state").ToString.Trim
                        End If
                    End If

                End If

                If Not IsDBNull(atemptable.Rows(0).Item("comp_zip_code")) Then
                    If Not String.IsNullOrEmpty(atemptable.Rows(0).Item("comp_zip_code").ToString.Trim) Then
                        tempStr += " " + atemptable.Rows(0).Item("comp_zip_code").ToString.Trim
                    End If
                End If

                If Not IsDBNull(atemptable.Rows(0).Item("comp_city")) Or Not IsDBNull(atemptable.Rows(0).Item("comp_state")) Or Not IsDBNull(atemptable.Rows(0).Item("comp_zip_code")) Then
                    tempStr += "</font></td></tr>"
                End If

                tempStr += "<tr><td><font size='-1' color='white'>"

                If Not IsDBNull(atemptable.Rows(0).Item("comp_web_address")) Then
                    If Not String.IsNullOrEmpty(atemptable.Rows(0).Item("comp_web_address").ToString.Trim) Then
                        tempStr += atemptable.Rows(0).Item("comp_web_address").ToString.Trim + ""
                    End If
                End If

                If Not IsDBNull(atemptable.Rows(0).Item("comp_web_address")) And Not IsDBNull(atemptable.Rows(0).Item("comp_email_address")) Then
                    tempStr += " - "
                End If

                If Not IsDBNull(atemptable.Rows(0).Item("comp_email_address")) Then
                    If Not String.IsNullOrEmpty(atemptable.Rows(0).Item("comp_email_address").ToString.Trim) Then
                        tempStr += "" + atemptable.Rows(0).Item("comp_email_address").ToString.Trim + ""
                    End If
                End If


                tempStr += "</font></td></tr>"

            End If

            sqlReaderTemp.Close()

            Query = "SELECT * FROM Phone_Numbers WITH(NOLOCK), Phone_Type WITH(NOLOCK)"
            Query = Query + " WHERE pnum_comp_id = " + comp_id.ToString
            Query = Query + " AND pnum_journ_id = 0"
            Query = Query + " AND pnum_hide_customer = 'N' AND pnum_contact_id = 0"
            Query = Query + " AND pnum_type = ptype_name ORDER BY pnum_type desc"  ' QUERY EDITED TO DISPLAY TOLL FREE THEN OFFICE THEN FAX

            SqlCommand.CommandText = Query
            sqlReaderTemp = SqlCommand.ExecuteReader()

            If sqlReaderTemp.HasRows Then
                Do While sqlReaderTemp.Read
                    tempStr += "<tr><td><font size='-1'><b>" + sqlReaderTemp.Item("pnum_type").ToString.Trim + "</b>: " + sqlReaderTemp.Item("pnum_number_full").ToString.Trim + "</font></td></tr>"
                Loop
            End If
            sqlReaderTemp.Close()

            tempStr += "</table>"

            sqlReaderTemp.Close()
            sqlReaderTemp = Nothing

            get_company_images = build_full_spec_page_header("Model Information", company_name, tempStr, image_ref, make_model_name)

        Catch SqlException
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in set_report_types_checks() SqlDataReader " + SqlException.Message
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try

    End Function


    Public Function build_full_spec_page_header(ByVal Title As String, ByVal company_name As String, ByVal address_info As String, ByVal image_ref As String, ByVal make_model_name As String) As String

        Dim sQuery = New StringBuilder()
        Dim sOutString As StringBuilder = New StringBuilder()


        Try


            If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                sOutString.Append("<table cellspacing='0' cellpadding='0' width='" & word_width & "'><tr bgcolor='#736F6E'><td colspan='3' cellpadding='0' cellspacing='0'>")
                sOutString.Append("<table border='1' cellspacing='0' cellpadding='4' bordercolor='black' width='" & word_width & "' height='50'><tr><td>")
                sOutString.Append("<table width='" & word_width & "'><tr>")

                If Not String.IsNullOrEmpty(image_ref.Trim) Then
                    sOutString.Append("<td width='150'>" + image_ref.Trim + "</td><td width='" & word_half & "' valign='top' class='white_feat_header_text'><font color='white' size='-1'>")
                Else
                    sOutString.Append("<td width='" & word_width & "' valign='top' class='white_feat_header_text'><font color='white' size='-1'>")
                End If

            Else
                sOutString.Append("<table cellspacing='0' cellpadding='0' width='95%' align='center'><tr bgcolor='#736F6E'><td colspan='3' cellpadding='0' cellspacing='0' align='center'>")
                sOutString.Append("<table border='1' cellspacing='0' cellpadding='4' bordercolor='black' width='100%' height='50' align='center'><tr><td align='center'>")
                sOutString.Append("<table width='100%' align='center'><tr>")

                If Not String.IsNullOrEmpty(image_ref.Trim) Then
                    sOutString.Append("<td width='150'>" + image_ref.Trim + "</td><td width='600'><font color='white' size='+1'>")
                Else
                    sOutString.Append("<td width='850'><font color='white' size='+1'>")
                End If

            End If

            sOutString.Append(company_name + "</font><br>")

            If Not String.IsNullOrEmpty(address_info.Trim) Then
                sOutString.Append("<table>" + address_info.Trim)
                sOutString.Append("</table>")
            End If

            If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                sOutString.Append("</td><td width='" & word_35 & "' cellpadding='5' valign='top' class='white_feat_header_text'><font color='white' size='-1'>")
            Else
                sOutString.Append("</td><td width='35%' cellpadding='5' valign='top'><font color='white'>")
            End If

            If Me.check_prepared_for.Checked = True Then
                If Me.prepared_for.Text <> "" Then
                    sOutString.Append("Prepared For: </strong>" & Trim(Me.prepared_for.Text) & "<Br>")
                End If
            End If


            sOutString.Append("" & make_model_name & "</font>")

            sOutString.Append("<table align='left' valign='bottom'>")

            sOutString.Append("<tr><td align='center'>&nbsp;</td></tr>")

            If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                sOutString.Append("<tr><td align='center' class='white_feat_header_text'><font color='white' size='-1'><i>" + Title.Trim + "</i></font></td></tr></table>")
            Else
                sOutString.Append("<tr><td align='center'><font color='white'><i>" + Title.Trim + "</i></font></td></tr></table>")
            End If
            ' commented out msw - 3-26-15
            'If Me.WD.SelectedValue = "Word" or Me.WD.SelectedValue = "WordX" Then
            '  sOutString.Append("</td></tr></table></td></tr></table></td></tr><tr valign='top'><td width='550' valign='top' height='500'><table valign='top' cellpadding='0' cellspacing='0'>")
            'Else
            '  sOutString.Append("</td></tr></table></td></tr></table></td></tr><tr valign='top'><td width='60%' height='900' valign='top'><table valign='top' cellpadding='0' cellspacing='0'>")
            'End If

            If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                sOutString.Append("</td></tr></table></td></tr></table></td></tr></table></td></tr><tr valign='top'><td width='550' valign='top' height='500'><table valign='top' cellpadding='0' cellspacing='0' width='" & word_width & "'>")
            Else
                sOutString.Append("</td></tr></table></td></tr></table></td></tr><tr valign='top'><td width='60%' height='900' valign='top' align='center'><table valign='top' cellpadding='0' cellspacing='0' align='center' width='95%'>")
            End If

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in build_full_spec_page_header " + ex.Message
        Finally

        End Try

        Return (sOutString.ToString)

    End Function

    Public Function Insert_Page_Break_PDF() As String
        Insert_Page_Break_PDF = ""
        Try
            Insert_Page_Break_PDF = "</table></td></tr></table></td></tr></table></td></tr></table></td></tr></table></td></tr></table></td></tr></table>"

            If Me.WD.SelectedValue = "Word" Or Me.WD.SelectedValue = "WordX" Then
                Insert_Page_Break_PDF &= "<br style=""page-break-before: always"">"
            Else
                Insert_Page_Break_PDF &= "<table width='100%' align='center' class='break'><tr><td>&nbsp;</td></tr></table>"
            End If

        Catch ex As Exception
            ' Response.Write("Error " & ex.Message & " in Insert_Page_Break() As String")
            'clsGeneral.clsGeneral.LogError("Error " & ex.Message & " in Insert_Page_Break() As String", aclsData_Temp)
        End Try
    End Function




    Public Function Build_Utilization_Summary_PDF_Standard(ByVal amod_id, ByVal real_make_model_name, ByVal months, ByVal selected_product_code_from_drop_down, ByVal View_Type) As String

        Session("FONT_CLASS_TEXT") = ""
        Session("FONT_CLASS_TEXT_TITLE") = ""
        Session("FONT_CLASS_HEADER") = ""
        Session("FONT_CLASS_HEADER_BIG") = ""

        Dim htmlOut = New StringBuilder()
        Dim aclsData_Temp As New clsData_Manager_SQL
        Dim AirportData As New DataTable

        Dim util_start_date As String = ""
        Dim util_end_date As String = ""
        Dim only_international As Boolean = False


        Try



            localdatalayer = New viewsDataLayer
            localdatalayer.adminConnectStr = Application.Item("crmClientSiteData").AdminDatabaseConn
            localdatalayer.clientConnectStr = Session.Item("localPreferences").UserDatabaseConn
            localdatalayer.starConnectStr = Session.Item("localPreferences").STARDatabaseConn
            localdatalayer.serverConnectStr = Session.Item("localPreferences").ServerNotesDatabaseConn

            market_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            market_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            market_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            market_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            market_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim


            util_functions.adminConnectStr = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            util_functions.clientConnectStr = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
            util_functions.starConnectStr = HttpContext.Current.Session.Item("jetnetStarDatabase").ToString.Trim
            util_functions.serverConnectStr = HttpContext.Current.Session.Item("jetnetServerNotesDatabase").ToString.Trim
            util_functions.cloudConnectStr = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString.Trim


            If Not IsNothing(Request.Item("origin_or_dest")) Then
                If Not String.IsNullOrEmpty(Request.Item("origin_or_dest").ToString) Then
                    origin_or_dest = Request("origin_or_dest").ToString
                End If
            End If
            util_functions.airport_direction = origin_or_dest


            aclsData_Temp.JETNET_DB = Application.Item("crmClientSiteData").AdminDatabaseConn
            aclsData_Temp.JETNET_DB = Application.Item("crmJetnetDatabase")
            aclsData_Temp.client_DB = Application.Item("crmClientDatabase")



            ' pick up the company from "view page selections"
            If Not IsNothing(Request.Item("viewCompany")) Then
                If Not String.IsNullOrEmpty(Request.Item("viewCompany").ToString) Then
                    localCriteria.ViewCriteriaCompanyID = CLng(Request.Item("viewCompany").ToString.Trim)
                Else
                    localCriteria.ViewCriteriaCompanyID = 0
                End If
            Else
                localCriteria.ViewCriteriaCompanyID = 0
            End If


            If InStr(Trim(selected_product_code_from_drop_down), "B") > 0 Then
                localCriteria.ViewCriteriaHasBusinessFlag = True
            Else
                localCriteria.ViewCriteriaHasBusinessFlag = False
            End If

            If InStr(Trim(selected_product_code_from_drop_down), "C") > 0 Then
                localCriteria.ViewCriteriaHasCommercialFlag = True
            Else
                localCriteria.ViewCriteriaHasCommercialFlag = False
            End If

            If InStr(Trim(selected_product_code_from_drop_down), "H") > 0 Then
                localCriteria.ViewCriteriaHasHelicopterFlag = True
            Else
                localCriteria.ViewCriteriaHasHelicopterFlag = False
            End If

            percent_flight = percent_flight

            ground_time = ground_time

            If Not IsNothing(Request.Item("pc")) Then
                If Not String.IsNullOrEmpty(Request.Item("pc").ToString) Then
                    temp_util_title = Request("pc").ToString
                    If selected_product_code_from_drop_down.ToString.Trim = "1" Then
                        temp_util_title = "Business"
                    ElseIf selected_product_code_from_drop_down.ToString.Trim = "2" Then
                        temp_util_title = "Commercial"
                    ElseIf selected_product_code_from_drop_down.ToString.Trim = "3" Then
                        temp_util_title = "Helicopters"
                    ElseIf selected_product_code_from_drop_down.ToString.Trim = "B" Then
                        temp_util_title = "Business"
                    ElseIf selected_product_code_from_drop_down.ToString.Trim = "C" Then
                        temp_util_title = "Commercial"
                    ElseIf selected_product_code_from_drop_down.ToString.Trim = "H" Then
                        temp_util_title = "Helicopters"
                    ElseIf selected_product_code_from_drop_down.ToString.Trim = "B,C" Then
                        temp_util_title = "Business, Commercial"
                    ElseIf selected_product_code_from_drop_down.ToString.Trim = "B,H" Then
                        temp_util_title = "Business, Helicopters"
                    ElseIf selected_product_code_from_drop_down.ToString.Trim = "C,H" Then
                        temp_util_title = "Commercial, Helicopters"
                    End If
                End If
            End If

            If utilizationInternational.Checked = True Then
                only_international = True
                international_label = "International Flights"
                If Trim(temp_util_title) <> "" Then
                    temp_util_title &= "<br/>International Flights"
                Else
                    temp_util_title = "International Flights"
                End If
                localCriteria.ViewCriteriaContinent = "International"
            Else
                only_international = False
                international_label = ""
            End If


            If Trim(Request("aport_id")) <> "" Then
                aport_id = Trim(Request("aport_id"))
                AirportData = localdatalayer.get_range_airports_by_IATA_or_ICAO(localCriteria, aport_id)
                Call localdatalayer.get_airport_information(AirportData, "", localCriteria, "", 0, 0)
                ' temp_util_title &= " Located At " & Trim(localCriteria.ViewCriteriaAirportName)

                localCriteria.ViewCriteriaAirportName = Replace(localCriteria.ViewCriteriaAirportName, " International", " Intl.")
                localCriteria.ViewCriteriaAirportName = Replace(localCriteria.ViewCriteriaAirportName, "é", "e")
                localCriteria.ViewCriteriaAirportName = Replace(localCriteria.ViewCriteriaAirportName, "è", "e")


            Else
                aport_id = 10125 ' griffis
                localCriteria.ViewCriteriaAirportName = "Griffiss International Airport"
            End If




            If WD.SelectedValue = "Word" Then
                bWordReport = True
            End If

            If Not IsNothing(Request.Item("word_width")) Then
                If Not String.IsNullOrEmpty(Request.Item("word_width").ToString.Trim) Then
                    word_width = Request.Item("word_width").ToString.ToUpper.Contains("Y")
                End If
            End If

            table_color = market_color.SelectedValue
            graph_color_new = create_graph_color(table_color)
            HttpContext.Current.Session.Item("graph_color") = graph_color_new

            'If Not IsNothing(Request.Item("pdf_html_width")) Then
            '  If Not String.IsNullOrEmpty(Request.Item("pdf_html_width").ToString.Trim) Then
            '    pdf_html_width = Request.Item("pdf_html_width").ToString.ToUpper.Contains("Y")
            '  End If
            'End If



            localCriteria.ViewCriteriaAmodID = amod_id


            If amod_id > 0 Then
                amod_id_list = amod_id ' to be changed later 
            End If


            If Trim(amod_id_list) <> "" Then
                localCriteria.ViewCriteriaAmodIDArray = Split(amod_id_list, ",")
                localCriteria.ViewCriteriaAmodID = -1
            ElseIf amod_id > 0 Then
                localCriteria.ViewCriteriaAmodID = amod_id
                localCriteria.ViewCriteriaAmodIDArray = Nothing
            Else
                localCriteria.ViewCriteriaAmodID = -1
                localCriteria.ViewCriteriaAmodIDArray = Nothing
            End If



            If Trim(Request("start_date")) <> "" Then
                start_date.Text = Trim(Request("start_date"))
                localCriteria.ViewCriteriaDocumentsStartDate = start_date.Text
            Else

                If Trim(Request("months")) <> "" Then
                    localCriteria.ViewCriteriaTimeSpan = Trim(Request("months"))
                Else
                    localCriteria.ViewCriteriaTimeSpan = 6
                End If

                ' will need to change when you bring over custom 
                localCriteria.ViewCriteriaDocumentsStartDate = FormatDateTime(DateAdd(DateInterval.Month, -localCriteria.ViewCriteriaTimeSpan, Now()), DateFormat.ShortDate)

            End If
            If Trim(Request("end_date")) <> "" Then
                end_date.Text = Trim(Request("end_date"))
                localCriteria.ViewCriteriaDocumentsEndDate = end_date.Text
            Else
                If Trim(Request("months")) <> "" Then
                    localCriteria.ViewCriteriaTimeSpan = Trim(Request("months"))
                Else
                    localCriteria.ViewCriteriaTimeSpan = 6
                End If

                ' will need to change when you bring over custom 

                localCriteria.ViewCriteriaDocumentsEndDate = FormatDateTime(Now(), DateFormat.ShortDate)
            End If


            If Trim(localCriteria.ViewCriteriaDocumentsStartDate) <> "" Then
                temp_util_title &= " (" & Trim(localCriteria.ViewCriteriaDocumentsStartDate) & " - "
                If Trim(localCriteria.ViewCriteriaDocumentsEndDate) <> "" Then
                    temp_util_title &= "" & Trim(localCriteria.ViewCriteriaDocumentsEndDate)
                End If
                temp_util_title &= ")"
            Else
                If Trim(localCriteria.ViewCriteriaDocumentsEndDate) <> "" Then
                    temp_util_title &= "Ending: " & Trim(localCriteria.ViewCriteriaDocumentsEndDate)
                End If
            End If


            If Trim(origin_or_dest) = "D" Then ' d is for destination - which means arrivals 
                temp_util_title &= " - Arrivals"
            ElseIf Trim(origin_or_dest) = "O" Then  ' o is for origin which means departures
                temp_util_title &= " - Departures"
            ElseIf Trim(origin_or_dest) = "X" Then   ' x is for both 
                temp_util_title &= " - Arrivals/Departures"
            Else
                temp_util_title &= " - Arrivals"
            End If


            If Trim(View_Type) = 928 Then
                ' Session.Item("searchCriteria").SearchViewCriteriaAirportDropdown = Session.Item("searchCriteria").SearchViewCriteriaAirportDropdown
                Session.Item("searchCriteria").SearchViewCriteriaAirportDropdown2 = Session.Item("searchCriteria").SearchViewCriteriaAirportDropdown2
                Session.Item("searchCriteria").SearchViewCriteriaAirportFolderName = Session.Item("searchCriteria").SearchViewCriteriaAirportFolderName
                Session.Item("Airport_Folder_List") = Session.Item("Airport_Folder_List")

                util_functions.Airport_IDS_String = Session.Item("Airport_Folder_List")
            End If


            If Trim(Request("year_start")) <> "" Then
                Call Load_Values_Variables_From_ViewMaster()
            Else
                Call Load_Values_Variables()
            End If

            If Me.CP.Checked Then
                Dim companyName As String = ""

                htmlOut.Append("<html><body>")

                htmlOut.Append(comp_functions.NEW_build_style_page_full_spec(bWordReport, True))

                Call comp_functions.CompanyInformationHeaderWithPNG(0, "", comp_address, comp_logo, invisible_label_parent_image, logo_check, bWordReport, companyName, "PDF")

                temp_pdf_header = comp_functions.NEW_build_full_spec_page_header(0, "", comp_address, comp_logo, amod_id, 0, bWordReport, word_width_new, pdf_html_width, check_prepared_for, Nothing, prepared_for, "", True, True, True)

                Dim imgFolder As String = HttpContext.Current.Server.MapPath(Session.Item("ModelPicturesFolderVirtualPath"))
                '  Dim imgDisplayFolder As String = Application.Item("crmClientSiteData").ClientFullHostName & Session.Item("ModelPicturesFolderVirtualPath")
                Dim imgDisplayFolder As String = Session.Item("ModelPicturesFolderVirtualPath")
                Dim imgFileName As String = amod_id.ToString.Trim + ".jpg"


                If Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CRM Then
                    htmlOut.Append("<table width='100%' height='1449' cellpadding=""0"" cellspacing=""0"" style=""background-color:#d4d4d4;background-size:100% 1449px;background-image:url('" & Application.Item("crmClientSiteData").ClientFullHostName & " /images/background/wordBackground.jpg');""><tr><td valign=""bottom"">")
                Else
                    htmlOut.Append("<table width='100%' height='1449' cellpadding=""0"" cellspacing=""0"" style=""background-color:#d4d4d4;background-size:100% 1449px;background-image:url('http://www.jetnetevolution.com/images/background/wordBackground.jpg');""><tr><td valign=""bottom"">")
                End If

                htmlOut.Append("<table cellspacing='0' cellpadding='0' border='0' width='100%' cellpadding=""0"" cellspacing=""0"" class=""viewValueExport"">")


                htmlOut.Append("<tr><td nowrap='nowrap'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td align='left' width='65%' height='1185'><table align='right' width='100%' cellpadding=""0"" cellspacing=""0""><tr><td style='border-bottom-style:solid; border-bottom-width:2px; border-color:#fff' align='left'><font face='arial' style='padding-bottom:15px;display:inline-block;font-size:36px;color:#e1e1e1;'><strong>AIRPORT FLIGHT ACTIVTY REPORT</strong></td></tr><tr><td align='left'>")
                If View_Type = 928 Then
                    htmlOut.Append("<font color ='#fff' face='arial' class=""makeModel""><strong>" & Trim(Session.Item("searchCriteria").SearchViewCriteriaAirportFolderName) & "</strong></font><br />")
                Else
                    htmlOut.Append("<font color ='#fff' face='arial' class=""makeModel""><strong>" & Replace(localCriteria.ViewCriteriaAirportName.ToString.Trim, " Airport", " ") & "</strong></font><br />")
                End If


                If aport_id > 0 And only_international = True Then
                    htmlOut.Append("<font face='arial' color='#fff' class=""dateName"">" & international_label & "</font><br />")
                End If

                If amod_id > 0 Then
                    htmlOut.Append("<font face='arial' color='#fff' class=""dateName"">" & Get_Model_Name(amod_id) & "</font><br />")
                ElseIf amod_id <= 0 Then


                    If Not IsNothing(localCriteria.ViewCriteriaTypeIDArray) Then
                        If localCriteria.ViewCriteriaTypeIDArray.Length > 0 Then
                            htmlOut.Append("<font face='arial' color='#fff' class=""dateName"">")
                            For i = 0 To localCriteria.ViewCriteriaTypeIDArray.Length - 1
                                If i > 0 Then
                                    htmlOut.Append(", ")
                                End If
                                htmlOut.Append(Get_Type_Name(localCriteria.ViewCriteriaTypeIDArray(i)))
                            Next
                            htmlOut.Append("</font><br />")
                        End If
                    End If


                    If Not IsNothing(localCriteria.ViewCriteriaAmodIDArray) Then
                        If localCriteria.ViewCriteriaAmodIDArray.Length > 0 Then
                            htmlOut.Append("<font face='arial' color='#fff' class=""dateName"">")
                            For i = 0 To localCriteria.ViewCriteriaAmodIDArray.Length - 1
                                If i > 0 Then
                                    htmlOut.Append(", ")
                                End If
                                htmlOut.Append(Get_Model_Name(localCriteria.ViewCriteriaAmodIDArray(i)))
                            Next
                            htmlOut.Append("</font><br />")
                        End If
                    End If

                    If Not IsNothing(localCriteria.ViewCriteriaAircraftMake) Then
                        If Trim(localCriteria.ViewCriteriaAircraftMake) <> "" Then
                            htmlOut.Append("<font face='arial' color='#fff' class=""dateName"">")
                            htmlOut.Append(Trim(localCriteria.ViewCriteriaAircraftMake))
                            htmlOut.Append("</font><br />")
                        End If
                    End If

                End If


                If check_prepared_for.Checked = True Then
                    If prepared_for.Text <> "" Then
                        htmlOut.Append("<font face='arial' color='#fff' class=""dateName"">PREPARED FOR: </b>" & Trim(prepared_for.Text) & "</font><br />")
                    End If
                End If

                htmlOut.Append("<font face='arial' color='#fff' class=""dateName"">" & MonthName(Month(Now())) & " " & Day(Now()) & ", " & Year(Now()) & "</font>")
                htmlOut.Append("</td></tr></table></td>")

                If amod_id > 0 Then
                    htmlOut.Append("<td align='left' width='15%'>" & Replace(NEW_build_model_spec_first_picture(imgFileName, True), "Title=''", " Title='' style='border-width:2px;border-style: solid;border-color:#fff;'") & "</td><td nowrap='nowrap'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>")
                ElseIf Not IsNothing(localCriteria.ViewCriteriaAmodIDArray) Then
                    If localCriteria.ViewCriteriaAmodIDArray.Length > 0 And localCriteria.ViewCriteriaAmodIDArray.Length < 6 Then
                        If Trim(amod_id_list) <> "" Then
                            htmlOut.Append("<td align='left' width='15%'>")
                            For i = 0 To localCriteria.ViewCriteriaAmodIDArray.Length - 1
                                imgFileName = localCriteria.ViewCriteriaAmodIDArray(i) & ".jpg"
                                htmlOut.Append("" & Replace(NEW_build_model_spec_first_picture(imgFileName, True, 175), "Title=''", " Title='' style='border-width:2px;border-style: solid;border-color:#fff;'") & "<br/>")
                            Next
                            htmlOut.Append("</td><td nowrap='nowrap'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>")
                        End If
                    End If
                End If

                htmlOut.Append("</tr>")

                htmlOut.Append("<tr valign='middle'><td height='200' width='700' align='left' valign=""bottom"" colspan=""4""><table align='right' width='100%' cellpadding=""0"" cellspacing=""0"" class=""overlaySep""><tr><td align='left' valign=""bottom""><span class=""companyName"">" & UCase(companyName) & "</td><td rowspan=""2"" align=""right"">" & comp_logo & "</td></tr><tr><td align='left' valign=""top""><Table align='left' cellpadding=""0"" cellspacing=""0"">" & Replace(comp_address, " class='sub_text'", " style=""font-family:Arial;font-size:18px;color:#737373""") & "</table></td></tr></table></font></td></tr>")
                htmlOut.Append("</table>")

                htmlOut.Append("</td></tr></table>")
                made_first_page = True
                'body {margin: 0%;width: 100%;height: 100%;} ' needed 

                htmlOut.Append("<body><html>")
            End If


            htmlOut.Append("</html></body>")

            htmlOut.Append(comp_functions.NEW_build_style_page_full_spec(bWordReport, False, 998))
            ' htmlOut.Append("<link rel='stylesheet' type='text/css' href='" & Application.Item("crmClientSiteData").ClientFullHostName & "EvoStyles/stylesheets/tableThemes.css' />")


            If Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CRM Then
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='" & Application.Item("crmClientSiteData").ClientFullHostName & "EvoStyles/stylesheets/tableThemes.css' />")
            ElseIf InStr(Application.Item("crmClientSiteData").ClientFullHostName, "https://") > 0 Or InStr(Application.Item("crmClientSiteData").ClientFullHostName, "testjetnet") > 0 Then
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='http://www.jetnetevolution.com/EvoStyles/stylesheets/tableThemes.css' />")
            Else
                htmlOut.Append("<link rel='stylesheet' type='text/css' href='" & Application.Item("crmClientSiteData").ClientFullHostName & "EvoStyles/stylesheets/tableThemes.css' />")
            End If


            ' htmlOut.Append("<link rel='stylesheet' type='text/css' href='" & Application.Item("crmClientSiteData").ClientFullHostName & "EvoStyles/stylesheets/additional_styles.css' />")

            ' <link rel=""stylesheet"" href=""/EvoStyles/stylesheets/.css"" />
            'htmlOut.Append("<link rel='stylesheet' type='text/css' href='../EvoStyles/stylesheets/tableThemes.css' />")

            Call comp_functions.CompanyInformationHeaderWithPNG(0, "", comp_address, comp_logo, invisible_label_parent_image, logo_check, bWordReport, "", "PDF")

            temp_pdf_header = "</div><div class=""valueSpec AirportViewSpec viewValueExport Simplistic " & table_color & """>" & comp_functions.NEW_build_full_spec_page_header(0, "", comp_address, comp_logo, amod_id, 0, bWordReport, word_width_new, pdf_html_width, check_prepared_for, Nothing, prepared_for)


            util_start_date = ""
            util_end_date = ""


            If View_Type = 928 Then
                If utilizationSummary.Checked Then
                    Call NEW_UTIL_CREATE_PDF_SPEC_PAGE("Graph_Only", htmlOut, amod_id)
                End If
            Else

                If utilizationSummary.Checked Then
                    Call NEW_UTIL_CREATE_PDF_SPEC_PAGE("Graph", htmlOut, amod_id)
                End If

                If aport_id = 0 Then
                    Call NEW_UTIL_CREATE_PDF_SPEC_PAGE("Airports", htmlOut, amod_id)
                End If



                If utilizationRoutes.Checked Then
                    Call NEW_UTIL_CREATE_PDF_SPEC_PAGE("Routes", htmlOut, amod_id)
                End If
                If utilizationModels.Checked Then
                    Call NEW_UTIL_CREATE_PDF_SPEC_PAGE("Aircraft Model", htmlOut, amod_id)
                End If

                '  Call NEW_UTIL_CREATE_PDF_SPEC_PAGE("Flights", htmlOut, amod_id)
                If utilizationOperators.Checked Then
                    Call NEW_UTIL_CREATE_PDF_SPEC_PAGE("Operators", htmlOut, amod_id)
                End If
                '   Call NEW_UTIL_CREATE_PDF_SPEC_PAGE("Reports", htmlOut, amod_id)


                If Me.utilizationAC.Checked = True Then
                    Call NEW_UTIL_CREATE_PDF_SPEC_PAGE("Aircraft", htmlOut, amod_id)
                End If

                If utilizationInternational.Checked = True Then
                    Call NEW_UTIL_CREATE_PDF_SPEC_PAGE("Arrivals", htmlOut, amod_id)
                    Call NEW_UTIL_CREATE_PDF_SPEC_PAGE("Departures", htmlOut, amod_id)
                End If

                If refuel_check.Checked = True Then
                    Call NEW_UTIL_CREATE_PDF_SPEC_PAGE("Refuel", htmlOut, amod_id)
                End If

            End If


            htmlOut.Replace("<table width='100%' align='center' class='break'><tr><td>&nbsp;</td></tr></table>", "")

            ' htmlOut.Append("</body></html>") 

        Catch ex As Exception
            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Error in create_aircraft_full_spec_sheet(ByVal item_string As Array) As String" + ex.Message
        End Try

        Return htmlOut.ToString

        htmlOut = Nothing
    End Function





    Public Sub NEW_UTIL_CREATE_PDF_SPEC_PAGE(ByVal page_name As String, ByRef htmlOut As StringBuilder, ByVal amod_id As Long)

        Dim page_total As Integer = 0
        Dim chart_text As String = ""
        Dim temp_string As String = ""
        Dim product_code_selection As String = ""
        Dim this_section_string As String = ""
        Dim table_count As Long = 0
        Dim TotalFlights As Long = 0
        Dim location_name As String = ""
        Dim is_located_here As Boolean = False
        Dim airport_list As String = ""
        Dim operator_drop2 As String = ""
        Dim recent_flight_months As Long = 0
        Dim compare_view_current_label As String = ""
        Dim compare_view_current_label2 As String = ""
        Dim ac_projects_ddl As String = ""
        Dim product_link As String = ""
        Dim html_string As String = ""
        Dim original_start As String = ""
        Dim original_end As String = ""

        Try

            If Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CRM Then
                NEW_CRMViewActive = True
            End If

            If made_first_page = False Then
            Else
                htmlOut.Append(comp_functions.NEW_Insert_Page_Break_PDF(0, WD.SelectedValue))
            End If

            NEW_PDF_AMOD_ID = amod_id

            If amod_id > 0 Then
                amod_id_list = amod_id ' to be changed later 
            End If


            If Trim(amod_id_list) <> "" Then
                localCriteria.ViewCriteriaAmodIDArray = Split(amod_id_list, ",")
                localCriteria.ViewCriteriaAmodID = -1
            ElseIf amod_id > 0 Then
                localCriteria.ViewCriteriaAmodID = amod_id
                localCriteria.ViewCriteriaAmodIDArray = Nothing
            Else
                localCriteria.ViewCriteriaAmodID = -1
                localCriteria.ViewCriteriaAmodIDArray = Nothing
            End If

            If Me.fuel_burn_liters.Checked = True Then
                show_fuel_burn_in_liters = True
            End If


            'If page_name = "recent_retail" Or page_name = "current_market" Or page_name = "for_sale" Then
            '  htmlOut.Append(Replace(temp_pdf_header, "viewValueExport", "viewValueExport Simplistic"))
            'Else
            htmlOut.Append(temp_pdf_header)
            'End If

            made_first_page = True
            util_functions.Airport_ID_OVERALL = aport_id
            util_functions.airport_direction = origin_or_dest



            If bWordReport = True Then
                htmlOut.Append("<table width='" & word_width & "' align='center' cellpadding='3'>")
            Else
                htmlOut.Append("<table width='" & pdf_html_width & "' align='center' cellpadding='3'>")
            End If



            If Trim(page_name) = "Graph" Or Trim(page_name) = "Graph_Only" Then
                If Trim(page_name) = "Graph_Only" Then
                    htmlOut.Append("<tr><td valign='top' align='center' colspan=""2""><font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER") & " mainHeading'><strong></strong> Flight Summary<br/><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & temp_util_title & "</font></font></td></tr>")
                Else
                    htmlOut.Append("<tr><td valign='top' align='center' colspan=""2""><font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & Replace(localCriteria.ViewCriteriaAirportName.ToString.Trim, " Airport", " ") & "</strong> Flight Summary<br/><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & temp_util_title & "</font></font></td></tr>")
                End If

                htmlOut.Append("<tr><td  align='left' valign=""top"" width=""70%"">")
                htmlOut.Append("<font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>Flight Summary<strong>Flights Per Month</strong></font>")
                htmlOut.Append("<img src='" & valueGraphText4.Text & "' width='100%' align='center' />")
                htmlOut.Append("</td>")

                original_start = ""
                original_end = ""
                original_start = localCriteria.ViewCriteriaDocumentsStartDate
                original_end = localCriteria.ViewCriteriaDocumentsEndDate


                If DateDiff(DateInterval.Month, CDate(original_start), CDate(original_end)) > 18 Then

                    'If Trim(Request("Folder_Id")) <> "" Then
                    '    localCriteria.ViewCriteriaFolderID = Trim(Request("Folder_Id"))
                    'End If

                    Call util_functions.get_flight_profile_top_function(localCriteria, html_string, "Month", Session("Last_FAA_DATE"), "", "pdf3")
                Else
                    Call util_functions.get_flight_profile_top_function(localCriteria, html_string, "Month", Session("Last_FAA_DATE"), "", "pdf2")
                    htmlOut.Append("<td align='left' valign=""top""><table width=""100%"" cellpadding=""0"" cellspacing=""0"" class=""formatTable large " & table_color & """>")
                    htmlOut.Append(html_string)
                    htmlOut.Append("</td></tr>")
                End If

                If Trim(page_name) = "Graph_Only" Then
                Else
                    htmlOut.Append(DisplayTopManufacturers(localCriteria, aport_id, TotalFlights, show_fuel_burn_in_liters))
                End If
            End If



            If Trim(page_name) = "Airports" Then
                Call util_functions.MostCommonOriginsJSArray(localCriteria, this_section_string, product_code_selection, table_count, True, True, TotalFlights, "pdf", table_color, temp_pdf_header, 0, "<strong>" & Replace(localCriteria.ViewCriteriaAirportName.ToString.Trim, " Airport", " ") & "</strong> TOP AIRPORTS", "", 0, show_fuel_burn_in_liters)
                htmlOut.Append(this_section_string)
            End If


            If Trim(page_name) = "Routes" Then

                If utilizationGraphs.Checked = True Then

                    htmlOut.Append("<tr><td valign='top' align='center' colspan=""2""><font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & Replace(localCriteria.ViewCriteriaAirportName.ToString.Trim, " Airport", " ") & "</strong> Top Airports<br/><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & temp_util_title & "</font></font></td></tr>")


                    htmlOut.Append("<tr><td  align='center' valign=""top"" width=""95%"" colspan='2'>")
                    htmlOut.Append("<font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>Top Airports</strong></font>")
                    htmlOut.Append("<img src='" & valueGraphText16.Text & "' width='100%' align='center' />")
                    htmlOut.Append("</td>")
                    htmlOut.Append("</tr>")
                    htmlOut.Append("<tr><td  align='left' valign=""top"" width=""49%"">")
                    htmlOut.Append("<font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>Top Airport Countries</strong></font>")
                    htmlOut.Append("<img src='" & valueGraphText8.Text & "' width='100%' align='center' />")
                    htmlOut.Append("</td>")
                    htmlOut.Append("<td  align='left' valign=""top"" width=""49%"">")
                    If utilization_state_check.Visible = True And utilization_state_check.Checked = True Then
                        htmlOut.Append("<font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>Top Airport States</strong></font>")
                    Else
                        htmlOut.Append("<font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>Top Airport Continents</strong></font>")
                    End If
                    htmlOut.Append("<img src='" & valueGraphText9.Text & "' width='100%' align='center' />")
                    htmlOut.Append("</td>")
                    htmlOut.Append("</tr>")
                    htmlOut.Append("</table>")

                    htmlOut.Append(comp_functions.NEW_Insert_Page_Break_PDF(0, WD.SelectedValue))

                    htmlOut.Append(temp_pdf_header)

                    If bWordReport = True Then
                        htmlOut.Append("<table width='" & word_width & "' align='center' cellpadding='3'>")
                    Else
                        htmlOut.Append("<table width='" & pdf_html_width & "' align='center' cellpadding='3'>")
                    End If
                End If

                Call util_functions.MostCommonOriginsJSArray(localCriteria, this_section_string, product_code_selection, table_count, False, False, TotalFlights, "pdf", table_color, temp_pdf_header, 0, "<strong>" & Replace(localCriteria.ViewCriteriaAirportName.ToString.Trim, " Airport", " ") & "</strong> TOP ROUTES" & "<br/><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & temp_util_title & "</font>", "", 0, show_fuel_burn_in_liters)
                htmlOut.Append(this_section_string)
            End If


            If Trim(page_name) = "Aircraft Model" Then

                If utilizationGraphs.Checked = True Then

                    htmlOut.Append("<tr><td valign='top' align='center' colspan=""2""><font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & Replace(localCriteria.ViewCriteriaAirportName.ToString.Trim, " Airport", " ") & "</strong> Top Models<br/><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & temp_util_title & "</font></font></td></tr>")

                    htmlOut.Append("<tr><td  align='center' valign=""top"" width=""95%"" colspan='2'>")
                    htmlOut.Append("<font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>Top Models</strong></font>")
                    htmlOut.Append("<img src='" & valueGraphText17.Text & "' width='100%' align='center' />")
                    htmlOut.Append("</td>")
                    htmlOut.Append("</tr>")

                    htmlOut.Append("<tr><td  align='left' valign=""top"" width=""49%"">")
                    htmlOut.Append("<font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>Top Aircraft by Size Category</strong></font>")
                    htmlOut.Append("<img src='" & valueGraphText11.Text & "' width='100%' align='center' />")
                    htmlOut.Append("</td>")
                    htmlOut.Append("<td  align='left' valign=""top"" width=""49%"">")
                    htmlOut.Append("<font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>Weight Class</strong></font>")
                    htmlOut.Append("<img src='" & valueGraphText10.Text & "' width='100%' align='center' />")
                    htmlOut.Append("</td>")
                    htmlOut.Append("</tr>")
                    'htmlOut.Append("<tr><td  align='center' valign=""top"" width=""49%"">")
                    'htmlOut.Append("<font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>Fuel Tank capacity </strong></font>")
                    'htmlOut.Append("<img src='" & valueGraphText11.Text & "' width='100%' align='center' />")
                    'htmlOut.Append("</td>")
                    'htmlOut.Append("</tr>")
                    'htmlOut.Append("<tr><td  align='center' valign=""top"" width=""49%"">")
                    'htmlOut.Append("<font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>Fuel Tank capacity </strong></font>")
                    'htmlOut.Append("<img src='" & valueGraphText12.Text & "' width='100%' align='center' />")
                    'htmlOut.Append("</td>")
                    'htmlOut.Append("</tr>")
                    htmlOut.Append("</table>")

                    htmlOut.Append(comp_functions.NEW_Insert_Page_Break_PDF(0, WD.SelectedValue))

                    htmlOut.Append(temp_pdf_header)

                    If bWordReport = True Then
                        htmlOut.Append("<table width='" & word_width & "' align='center' cellpadding='3'>")
                    Else
                        htmlOut.Append("<table width='" & pdf_html_width & "' align='center' cellpadding='3'>")
                    End If
                End If

                Call util_functions.FlightActivityArrayByModel(localCriteria, this_section_string, product_code_selection, "pdf2", TotalFlights, temp_pdf_header, table_color, "<br/><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & temp_util_title & "</font>", show_fuel_burn_in_liters)
                htmlOut.Append(this_section_string)
            End If

            'If Trim(page_name) = "Flights" Then
            '  Call util_functions.FlightJSArray(localCriteria, this_section_string, location_name, Trim(Request("export")), compare_view_current_label, compare_view_current_label2, ac_projects_ddl, recent_flight_months, IIf(String.IsNullOrEmpty(localCriteria.ViewCriteriaDocumentsStartDate), start_date.Text, localCriteria.ViewCriteriaDocumentsStartDate), IIf(String.IsNullOrEmpty(localCriteria.ViewCriteriaDocumentsEndDate), end_date.Text, localCriteria.ViewCriteriaDocumentsEndDate), product_code_selection, product_link, table_count, "pdf", table_color)  ' TONS OF FIELDS    '  Me.compare_view_current_label.Text, Me.compare_view_current_label2.Text, Me.ac_projects_ddl.SelectedValue
            '  htmlOut.Append(this_section_string)
            'End If


            If Trim(page_name) = "Operators" Then

                If utilizationGraphs.Checked = True Then

                    htmlOut.Append("<tr><td valign='top' align='center' colspan=""2""><font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & Replace(localCriteria.ViewCriteriaAirportName.ToString.Trim, " Airport", " ") & "</strong> Operators<br/><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & temp_util_title & "</font></font></td></tr>")

                    htmlOut.Append("<tr>")
                    htmlOut.Append("<td  align='left' valign=""top"" width=""49%"">")
                    htmlOut.Append("<font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>Top Operators</strong></font>")
                    htmlOut.Append("<img src='" & valueGraphText18.Text & "' width='100%' align='center' />")
                    htmlOut.Append("</td>")
                    htmlOut.Append("<td  align='left' valign=""top"" width=""49%"">")
                    htmlOut.Append("<font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>Top Operator Business Types</strong></font>")
                    htmlOut.Append("<img src='" & valueGraphText5.Text & "' width='100%' align='center' />")
                    htmlOut.Append("</td>")
                    htmlOut.Append("</tr>")
                    htmlOut.Append("<tr><td  align='center' valign=""top"" width=""49%"">")
                    htmlOut.Append("<font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>Top Operator Countries</strong></font>")
                    htmlOut.Append("<img src='" & valueGraphText7.Text & "' width='100%' align='center' />")
                    htmlOut.Append("</td>")
                    htmlOut.Append("<td  align='left' valign=""top"" width=""49%"">")

                    If utilization_state_check.Visible = True And utilization_state_check.Checked = True Then
                        htmlOut.Append("<font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>Top Operator States</strong></font>")
                    Else
                        htmlOut.Append("<font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>Top Operator Continents</strong></font>")
                    End If

                    htmlOut.Append("<img src='" & valueGraphText6.Text & "' width='100%' align='center' />")
                    htmlOut.Append("</td>")
                    htmlOut.Append("</tr>")

                    htmlOut.Append("</tr>")
                    htmlOut.Append("</table>")

                    htmlOut.Append(comp_functions.NEW_Insert_Page_Break_PDF(0, WD.SelectedValue))

                    htmlOut.Append(temp_pdf_header)

                    If bWordReport = True Then
                        htmlOut.Append("<table width='" & word_width & "' align='center' cellpadding='3'>")
                    Else
                        htmlOut.Append("<table width='" & pdf_html_width & "' align='center' cellpadding='3'>")
                    End If
                End If

                Call util_functions.Build_Operators_Array(localCriteria, "pdf", IIf(Not String.IsNullOrEmpty(airport_list), 0, aport_id), this_section_string, operator_drop2, table_count, TotalFlights, table_color, temp_pdf_header, 0, "<strong>" & Replace(localCriteria.ViewCriteriaAirportName, " Airport", " ") & "</strong> TOP OPERATORS" & "<br/><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & temp_util_title & "</font>", show_fuel_burn_in_liters) ' operator_drop2 = Me.operator_drop2.SelectedValue
                htmlOut.Append(this_section_string)
            End If



            If Trim(page_name) = "Aircraft" Then

                If utilizationGraphs.Checked = True Then

                    htmlOut.Append("<tr><td valign='top' align='center' colspan=""2""><font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER") & " mainHeading'><strong>" & Replace(localCriteria.ViewCriteriaAirportName.ToString.Trim, " Airport", " ") & "</strong> AIRCRAFT<br/><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & temp_util_title & "</font></font></td></tr>")

                    htmlOut.Append("<tr><td  align='center' valign=""top"" width=""95%"" colspan='2'>")
                    htmlOut.Append("<font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>Top Aircraft</strong></font>")
                    htmlOut.Append("<img src='" & valueGraphText19.Text & "' width='100%' align='center' />")
                    htmlOut.Append("</td>")
                    htmlOut.Append("</tr>")

                    htmlOut.Append("<tr><td  align='left' valign=""top"" width=""49%"">")
                    htmlOut.Append("<font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>Seats</strong></font>")
                    htmlOut.Append("<img src='" & valueGraphText13.Text & "' width='100%' align='center' />")
                    htmlOut.Append("</td>")
                    htmlOut.Append("<td  align='left' valign=""top"" width=""49%"">")
                    htmlOut.Append("<font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>Crew</strong></font>")
                    htmlOut.Append("<img src='" & valueGraphText14.Text & "' width='100%' align='center' />")
                    htmlOut.Append("</td>")
                    htmlOut.Append("</tr>")
                    'htmlOut.Append("<tr><td  align='center' valign=""top"" width=""49%"">")
                    'htmlOut.Append("<font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>Size Category</strong></font>")
                    'htmlOut.Append("<img src='" & valueGraphText15.Text & "' width='100%' align='center' />")
                    'htmlOut.Append("</td>")
                    'htmlOut.Append("</tr>") 
                    htmlOut.Append("</table>")

                    htmlOut.Append(comp_functions.NEW_Insert_Page_Break_PDF(0, WD.SelectedValue))

                    htmlOut.Append(temp_pdf_header)

                    If bWordReport = True Then
                        htmlOut.Append("<table width='" & word_width & "' align='center' cellpadding='3'>")
                    Else
                        htmlOut.Append("<table width='" & pdf_html_width & "' align='center' cellpadding='3'>")
                    End If
                End If

                Call util_functions.FlightActivityJSArray(localCriteria, this_section_string, is_located_here, product_code_selection, TotalFlights, "pdf2", table_color, "<br/><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & temp_util_title & "</font>", False, 0, "", show_fuel_burn_in_liters)
                htmlOut.Append(this_section_string)
            End If

            If Trim(page_name) = "Arrivals" Then
                Call util_functions.ArrivalsDeparturesJSArray(localCriteria, this_section_string, product_code_selection, table_count, False, False, TotalFlights, "pdf", table_color, temp_pdf_header, 30, "<strong>" & Replace(localCriteria.ViewCriteriaAirportName.ToString.Trim, " Airport", " ") & "</strong> MOST RECENT ARRIVALS" & "<br/><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & temp_util_title & "</font>", "", "A")
                htmlOut.Append(this_section_string)
            End If

            If Trim(page_name) = "Departures" Then
                Call util_functions.ArrivalsDeparturesJSArray(localCriteria, this_section_string, product_code_selection, table_count, False, False, TotalFlights, "pdf", table_color, temp_pdf_header, 30, "<strong>" & Replace(localCriteria.ViewCriteriaAirportName.ToString.Trim, " Airport", " ") & "</strong> MOST RECENT DEPARTURES" & "<br/><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & temp_util_title & "</font>", "", "D")
                htmlOut.Append(this_section_string)
            End If

            If Trim(page_name) = "Refuel" Then
                If util_functions.Airport_ID_OVERALL > 0 Then
                    Call util_functions.Refuel_Tech_Stops(localCriteria, this_section_string, product_code_selection, table_count, False, False, TotalFlights, "pdf", table_color, temp_pdf_header, 30, "<strong>" & Replace(localCriteria.ViewCriteriaAirportName.ToString.Trim, " Airport", " ") & "</strong> Refuel/Tech Stops" & "<br/><font class='" & HttpContext.Current.Session("FONT_CLASS_TEXT") & "'>" & temp_util_title & "</font>", "", percent_flight, ground_time, show_fuel_burn_in_liters)
                    htmlOut.Append(this_section_string)
                End If
            End If

            '  If Trim(page_name) = "Reports" Then
            '    Call Utilization_Build_Summaries(util_functions, localCriteria, product_code_selection, TotalFlights)
            ' End If 

            htmlOut.Append("</table>")

        Catch ex As Exception

        End Try

    End Sub

    Public Function DisplayTopManufacturers(ByVal localcriteria As viewSelectionCriteriaClass, ByVal aportID As Long, ByVal totalFlights As Long, ByVal show_fuel_burn_in_liters As Boolean) As String
        Dim resultsString As String = ""
        Dim resultsTable As DataTable = util_functions.GetTopManufacturers(localcriteria, aportID, totalFlights, "pdf", 0)
        Dim temp_gal_lit As Integer = 0

        resultsString = "<tr><td valign='middle' class='left' colspan='10'><font class='" & Session("FONT_CLASS_HEADER") & "  mainHeading'><strong>" & Replace(localcriteria.ViewCriteriaAirportName.ToString.Trim, " Airport", " ") & "</strong> TOP MANUFACTURERS</font></td></tr>"

        resultsString += "<tr><td valign='top' class='left' colspan='10'><div class=""Box"">"

        resultsString += "<table width=""100%"" cellpadding=""0"" cellspacing=""0"" class='formatTable large " & table_color & "'>"
        resultsString += "<thead><tr><th>MANUFACTURERS</th><th class=""right""># FLIGHTS</th><th class=""right"">TOTAL FLIGHT HOURS</th>"

        If show_fuel_burn_in_liters = True Then
            resultsString += "<th Class=""right"">EST FUEL BURN (L)</th>"
        Else
            resultsString += "<th Class=""right"">EST FUEL BURN (GAL)</th>"
        End If

        resultsString += "</tr></thead>"

        For Each r As DataRow In resultsTable.Rows
            resultsString += "<tr>"

            resultsString += "<td>"

            If Not IsDBNull(r(0)) Then
                resultsString += r(0)
            End If

            resultsString += "</td>"

            resultsString += "<td class=""right"">"

            If Not IsDBNull(r(1)) Then
                resultsString += (FormatNumber(r(1), 0)).ToString
            End If

            resultsString += "</td>"

            resultsString += "<td class=""right"">"

            If Not IsDBNull(r(2)) Then
                resultsString += (FormatNumber(r(2), 1)).ToString
            End If

            resultsString += "</td>"
            resultsString += "<td class=""right"">"


            If Not IsDBNull(r(3)) Then
                temp_gal_lit = r(3).ToString
                If show_fuel_burn_in_liters = True Then
                    temp_gal_lit = FormatNumber((r(3).ToString * 3.78541), 1)
                End If
                resultsString += (FormatNumber(temp_gal_lit, 0)).ToString
            End If

            resultsString += "</td>"

            resultsString += "</tr>"
        Next

        resultsString += "</table></div></td></tr>"

        Return resultsString
    End Function
    Public Function DisplayDaysOnMarket(ByVal TimeSpan As Long, ByRef graph_string As String, ByRef searchCriteria As viewSelectionCriteriaClass) As String
        DisplayDaysOnMarket = ""

        Dim rtable As New DataTable

        Try

            If days = 0 Then
                Call GetFleetInfo(localCriteria.ViewCriteriaAmodID, False, searchCriteria)
            End If
            forsaleavg = Replace(forsaleavg, "$", "")
            forsaleavg = Replace(forsaleavg, "k", "")
            DisplayDaysOnMarket = "<tr><td valign='middle' class='left' colspan='10'><font class='" & Session("FONT_CLASS_HEADER") & "  mainHeading'><strong>" & real_make_model_name & "</strong> AVERAGE DAYS ON MARKET TRENDS" & valueEmptyHeaderString & "</font></td></tr>"
            DisplayDaysOnMarket += "<tr><td valign='top' class='left' colspan=""5"" width='50%'><div class=""Box gaugeImage""><font class='" & Session("FONT_CLASS_HEADER_NOALIGN") & "'>CURRENT AVG DAYS ON MARKET</font><img src='" & valueGraphTextGauge6.Text & "' width='100%' /></div></td>"

            DisplayDaysOnMarket += "<td class=""tickerBox""><div class=""Box"" style=""text-align:center;position:relative;"">"
            DisplayDaysOnMarket += DisplayFunctions.make_MTREND_CHANGE_TICKERS(localCriteria.ViewCriteriaAmodID, localCriteria.ViewCriteriaTimeSpan, aclsData_Temp_aspx, ac_for_sale, days, forsaleavg, in_op_count, total_in_op, "daysonmarket")
            DisplayDaysOnMarket += "</div></td>"
            DisplayDaysOnMarket += "</tr>"


            rtable = market_functions.get_average_days_on_market_info(localCriteria, True)

            If rtable.Rows.Count > 0 Then

                For Each r As DataRow In rtable.Rows

                    If Trim(graph_string) <> "" Then
                        graph_string &= ", "
                    End If
                    graph_string += "['" & (r.Item("mtrend_month") & "-" & r.Item("mtrend_year")) & "'," & r.Item("mtrend_avg_market_days") & " ]"

                Next

                graph_string += ", ['" & (Month(Date.Now()) & "-" & Year(Date.Now())) & "'," & days & " ]"
            End If


            graph_string = " data24.addColumn('string', 'Month/Year'); data24.addColumn('number', 'AverageDOM'); data24.addRows([ " & graph_string

            DisplayDaysOnMarket &= "<tr><td valign=""top"" colspan='10'><br/><br/><table cellspacing='0' cellpadding='0' border='0' width='100%'><tr><td align='center' width='100%' valign=""top""><div class=""Box""><div style=""width:680px;"" class=""marginAuto"">"
            DisplayDaysOnMarket &= "<font class='" & HttpContext.Current.Session("FONT_CLASS_HEADER_NOALIGN") & "'>Avg Days On Market<strong>Past " & localCriteria.ViewCriteriaTimeSpan & " Months</strong></font>"
            DisplayDaysOnMarket &= "<img src='" & valueGraphText24.Text & "' width=""700"" align='center' class=""marginAuto"" /></div>"
            DisplayDaysOnMarket &= "</div></table></td></tr>"

        Catch ex As Exception

        End Try
    End Function

    Private Sub utilizationGraphs_CheckedChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles utilizationGraphs.CheckedChanged, utilization_state_check.CheckedChanged

        utilization_state_check.Visible = True


        System.Web.UI.ScriptManager.RegisterStartupScript(Me.graph_update_panel, Me.GetType(), "clearLoading", "<script type=""text/javascript"">$(""#divLoading"").css(""display"", ""none"");</script>", False)

    End Sub
End Class