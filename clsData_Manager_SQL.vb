' ********************************************************************************
' Copyright 2004-11. JETNET,LLC. All rights reserved.
'
'$$Archive: /commonWebProject/clsData_Manager_SQL.vb $
'$$Author: Matt $
'$$Date: 6/29/20 12:33p $
'$$Modtime: 6/29/20 12:29p $
'$$Revision: 86 $
'$$Workfile: clsData_Manager_SQL.vb $
' 

' ********************************************************************************

Public Class clsData_Manager_SQL
  Private aError As String = ""
  Private client_connStr As String = ""
  Private ref_connStr As String = ""
  Private jetnet_connStr As String = ""
  Private ref_history_connStr As String = ""
  Private bDisable_JETNET As Boolean
  Public Const cSingleSpace As String = " "


  Public Const cHTMLnbsp As String = "&nbsp;"
  Public Const QUOTE As String = """"
  Public Const cMultiDelim = ", "
  Public Const cDot = "."
  Public Const cHyphen = "-"
  Public Const cCommaDelim = ","

  Public Const PRODUCT_TYPE_B = "B"  ' Business     ** check tier level for make/model selection
  Public Const PRODUCT_TYPE_H = "H"  ' Helicopters  ** ignore tier level
  Public Const PRODUCT_TYPE_C = "C"  ' Commercial   ** check tier level for make/model selection
  Public Const PRODUCT_TYPE_R = "R"  ' Regional     ** ignore tier level

  Public Const PRODUCT_TYPE_F = "F"  ' Fortune 1000 ** not used

  Public Const PRODUCT_TYPE_A = "A"  ' ABI          ** ignore tier level ** not used
  Public Const PRODUCT_TYPE_P = "P"  ' AirBP        ** ignore tier level ** not used
  Public Const PRODUCT_TYPE_S = "S"  ' STAR Reports ** ignore tier level
  Public Const PRODUCT_TYPE_I = "I"  ' SPI View     ** ignore tier level

  Public Const PRODUCT_TYPE_Y = "Y"  ' Yacht        ** ignore tier level
  Public Const EVOAERO_VIEW_0 = 0   ' no view
  Public Const EVOAERO_VIEW_1 = 1   ' aircraft model view
  Public Const EVOAERO_VIEW_2 = 2   ' model compare view
  Public Const EVOAERO_VIEW_3 = 3   ' operator view
  Public Const EVOAERO_VIEW_4 = 4   ' financial document view
  Public Const EVOAERO_VIEW_5 = 5   ' start with ac tab view
  Public Const EVOAERO_VIEW_6 = 6   ' star reports view
  Public Const EVOAERO_VIEW_7 = 7   ' fractional view
  Public Const EVOAERO_VIEW_8 = 8   ' aircraft location view 
  Public Const EVOAERO_VIEW_9 = 9   ' financial market view
  Public Const EVOAERO_VIEW_10 = 10 ' aircraft contact type view(charter)
  Public Const EVOAERO_VIEW_11 = 11 ' model forsale view
  Public Const EVOAERO_VIEW_12 = 12 ' sales price view
  Public Const EVOAERO_VIEW_13 = 13 ' lease view
  Public Const EVOAERO_VIEW_14 = 14 ' manufacturer view
  Public Const EVOAERO_VIEW_15 = 15 ' reminder view
  Public Const EVOAERO_VIEW_16 = 16 ' 
  Public Const EVOAERO_VIEW_17 = 17 ' 
  Public Const EVOAERO_VIEW_18 = 18 ' 


#Region "Properties"
  Public Sub New()
    aError = ""
    client_connStr = ""
    ref_connStr = ""
    ref_history_connStr = ""
    bDisable_JETNET = False
  End Sub

  Public Property client_DB() As String
    Get
      client_DB = client_connStr
    End Get
    Set(ByVal value As String)
      client_connStr = value
    End Set
  End Property

  Public Property ref_DB() As String
    Get
      ref_DB = ref_connStr
    End Get
    Set(ByVal value As String)
      ref_connStr = value
    End Set
  End Property

  Public Property JETNET_DB() As String
    Get
      JETNET_DB = jetnet_connStr
    End Get
    Set(ByVal value As String)
      jetnet_connStr = value
    End Set
  End Property

  Public Property ref_history_DB() As String
    Get
      ref_history_DB = ref_history_connStr
    End Get
    Set(ByVal value As String)
      ref_history_connStr = value
    End Set
  End Property

  Public Property class_error() As String
    Get
      class_error = aError
    End Get
    Set(ByVal value As String)
      aError = value
    End Set
  End Property

  Public Property bolDisable_JETNET() As Boolean
    Get
      bolDisable_JETNET = bDisable_JETNET
    End Get
    Set(ByVal value As Boolean)
      bDisable_JETNET = value
    End Set
  End Property
#End Region
#Region "EVOLUTION SIDE!!! with some mixed client side if the results are both"
#Region "Start Aircraft Related Data Queries"
#Region "Aircraft Contact Card"

#End Region
#Region "Aircraft Search"
  '/////////////////////////////////AIRCRAFT/////////////////////////////////////////
  '/////////////////////////////////AIRCRAFT/////////////////////////////////////////
  ''' <summary>
  ''' This function runs the AC Search on both the Master and Mobile Websites. 
  ''' </summary>
  ''' <param name="first_column">Column that the data is sorted by</param>
  ''' <param name="data_subset">Type of data we're displaying, jetnet/client/both?</param>
  ''' <param name="operator_type">Types of operators, owners, etc</param>
  ''' <param name="ID_SQL_IN_JETNET">Jetnet MODEL IDs sent from subfolder</param>
  ''' <param name="ID_SQL_IN_CLIENT">Client MODEL IDs sent from subfolder</param>
  ''' <param name="ac_text">Search string</param>
  ''' <param name="market_status">Market Status</param>
  ''' <param name="airport_name">Airport Name Search paramater</param>
  ''' <param name="icao_code">ICAO Search paramater</param>
  ''' <param name="iata_code">IATA search paramater</param>
  ''' <param name="ac_city">Airport City Search Parameter</param>
  ''' <param name="ac_country">AC Country Search Parameter</param>
  ''' <param name="ac_state">Airport State Search Parameter</param>
  ''' <param name="client_models">Client Models sent from Model ID listbox</param>
  ''' <param name="jetnet_models">Jetnet Models sent from Model ID listbox</param>
  ''' <param name="helicopter">view helicopter security setting</param>
  ''' <param name="business">view business security setting</param>
  ''' <param name="jets">view jets security setting</param>
  ''' <param name="executive">view executive security setting</param>
  ''' <param name="turboprops">view turboprops security setting</param>
  ''' <param name="commercial">view commercial security setting</param>
  ''' <param name="aerodex">view aerodex security setting</param>
  ''' <param name="on_exclusive">on exclusive flag</param>
  ''' <param name="on_lease">on lease flag</param>
  ''' <param name="year_start">year mfr start string</param>
  ''' <param name="year_end">year mfr end string</param>
  ''' <returns>Returns Datatable</returns>
  ''' <remarks>First thing that happens is that the function builds a temporary table.
  ''' Then this same function queries the Jetnet History Table.
  ''' And then throws that information into the Temporary Table
  ''' And then.. queries the client history table and puts it into the temporary table.
  ''' Then it creates a table meant to return with all the columns.
  ''' Then it will loop through the temporary table and go through each data set to combine all of
  ''' company information into one string (one data row as opposed to many). So company name will be delimetered company_name | company_name
  ''' and so on. This is to assure that all information is passed to the client and does NOT need to be required on the display
  ''' so the database is only touched once.
  ''' Unfortunately this means that the client needs to parse the information which is taken care of in
  ''' listing.aspx.vb Results_Item_Databound event.</remarks>
  Public Function AC_Search_New(ByVal first_column As String, ByVal data_subset As String, ByVal operator_type As String, ByVal ID_SQL_IN_JETNET As String, ByVal ID_SQL_IN_CLIENT As String, ByVal ac_text As String, ByVal market_status As String, ByVal airport_name As String, ByVal icao_code As String, ByVal iata_code As String, ByVal ac_city As String, ByVal ac_country As String, ByVal ac_state As String, ByVal client_models As String, ByVal jetnet_models As String, ByVal helicopter As Boolean, ByVal business As Boolean, ByVal jets As Boolean, ByVal executive As Boolean, ByVal turboprops As Boolean, ByVal commercial As Boolean, ByVal aerodex As Boolean, ByVal on_exclusive As String, ByVal on_lease As String, ByVal year_start As String, ByVal year_end As String, ByVal search_field As String, ByVal search_where As String, ByVal lifecycle As String, ByVal ownership As String, ByVal CustomField1 As String, ByVal CustomField2 As String, ByVal CustomField3 As String, ByVal CustomField4 As String, ByVal CustomField5 As String, ByVal CustomField6 As String, ByVal CustomField7 As String, ByVal CustomField8 As String, ByVal CustomField9 As String, ByVal CustomField10 As String, ByVal AircraftNotesSearch As Integer, ByVal MergeLists As Boolean) As DataTable
    Dim sQuery As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader : SqlReader = Nothing
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing


    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing


    ' create the Select Strings
    Dim aSQL_String_Client_Select As String = ""
    Dim aSQL_String_JETNET_Select As String = ""
    ' create the Where string
    Dim aSQL_String_Client_Where As String = ""
    Dim aSQL_String_JETNET_Where As String = ""
    ' create a data table to hold the company info
    Dim dalTable As New DataTable
    Dim atemptable As New DataTable
    Dim atemptable2 As New DataTable
    Dim dataSet As DataSet = New DataSet("dataSet")
    Dim search_string As String = ""
    Dim op As String = " like "
    Dim JetnetIDExcluded As String = ""
    Try

      dataSet.Tables.Add(atemptable)
      dataSet.Tables.Add(atemptable2)
      dataSet.Tables.Add(dalTable)
      dataSet.EnforceConstraints = False

      Dim ac_airframe_tot_col As DataColumn = atemptable.Columns.Add("ac_airframe_tot_hrs", Type.GetType("System.Int32"))
      ac_airframe_tot_col.AllowDBNull = True

      atemptable.Columns.Add("ac_id")
      atemptable.Columns.Add("ac_amod_id")
      atemptable.Columns.Add("ac_ser_nbr")
      atemptable.Columns.Add("ac_reg_nbr")
      atemptable.Columns.Add("amod_make_name")
      atemptable.Columns.Add("amod_model_name")
      atemptable.Columns.Add("amod_make_type")
      atemptable.Columns.Add("ac_status")
      atemptable.Columns.Add("ac_year_mfr")
      atemptable.Columns.Add("act_name")
      atemptable.Columns.Add("ac_forsale_flag")
      atemptable.Columns.Add("ac_exclusive_flag")
      atemptable.Columns.Add("ac_asking_wordage")
      atemptable.Columns.Add("ac_asking_price")
      atemptable.Columns.Add("ac_lease_flag")
      atemptable.Columns.Add("comp_id")
      atemptable.Columns.Add("ac_date_listed")
      atemptable.Columns.Add("ac_product_business_flag")
      atemptable.Columns.Add("ac_product_helicopter_flag")
      atemptable.Columns.Add("ac_product_commercial_flag")
      atemptable.Columns.Add("ac_est_price")
      atemptable.Columns.Add("ac_ser_nbr_sort")
      atemptable.Columns.Add("contact_id")
      atemptable.Columns.Add("source")
      atemptable.Columns.Add("ac_delivery")
      atemptable.Columns.Add("acref_owner_percentage")
      atemptable.Columns.Add("jetnet_ac_id")
      atemptable.Columns.Add("lastnote")
      atemptable.Columns.Add("lastevent")
      atemptable.Columns.Add("value_price")
      'Company Information 
      atemptable.Columns.Add("comp_name")
      atemptable.Columns.Add("comp_address1")
      atemptable.Columns.Add("comp_address2")
      atemptable.Columns.Add("comp_city")
      atemptable.Columns.Add("comp_state")
      atemptable.Columns.Add("comp_country")
      atemptable.Columns.Add("comp_zip_code")
      atemptable.Columns.Add("comp_email_address")
      atemptable.Columns.Add("comp_web_address")

      ''Contact Information
      atemptable.Columns.Add("contact_first_name")
      atemptable.Columns.Add("contact_last_name")
      atemptable.Columns.Add("contact_middle_initial")
      atemptable.Columns.Add("contact_preferred_name")
      atemptable.Columns.Add("contact_title")
      atemptable.Columns.Add("contact_email_address")
      atemptable.Columns.Add("contact_notes")

      'Engine
      atemptable.Columns.Add("acep_engine_1_ttsn_hours")
      atemptable.Columns.Add("acep_engine_2_ttsn_hours")
      atemptable.Columns.Add("acep_engine_3_ttsn_hours")
      atemptable.Columns.Add("acep_engine_4_ttsn_hours")
      atemptable.Columns.Add("acep_engine_1_tsoh_hours")
      atemptable.Columns.Add("acep_engine_2_tsoh_hours")
      atemptable.Columns.Add("acep_engine_3_tsoh_hours")
      atemptable.Columns.Add("acep_engine_4_tsoh_hours")

      atemptable.Columns.Add("ac_engine_1_shi_hrs")
      atemptable.Columns.Add("ac_engine_2_shi_hrs")
      atemptable.Columns.Add("ac_engine_3_shi_hrs")
      atemptable.Columns.Add("ac_engine_4_shi_hrs")

      atemptable.Columns.Add("comp_source")
      atemptable.Columns.Add("ac_upd_date")

      If HttpContext.Current.Session.Item("localUser").crmEvo = True Then
        data_subset = "JC"
      End If

      '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
      '----------------------------------------------------------- check to see if we are getting client data---------------------------------------------------
      '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
      If (data_subset = "C" Or data_subset = "JC" Or data_subset = "B") Then
        '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
        ' ---------------------------------------------------------Setup the Client SQL Strings---------------------------------------------------------------
        '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

        'These are the basic fields needed for the company export. 
        aSQL_String_Client_Select = "SELECT DISTINCT "
        aSQL_String_Client_Select = aSQL_String_Client_Select & "Client_Aircraft.cliaircraft_id AS ac_id,client_aircraft.cliaircraft_value_description as value_price, client_aircraft.cliaircraft_action_date as ac_upd_date, Client_Aircraft_Model.cliamod_id AS ac_amod_id, Client_Aircraft.cliaircraft_ser_nbr AS ac_ser_nbr, "
        aSQL_String_Client_Select = aSQL_String_Client_Select & "Client_Aircraft.cliaircraft_reg_nbr AS ac_reg_nbr, Client_Aircraft.cliaircraft_airframe_total_hours AS ac_airframe_tot_hrs, Client_Aircraft_Model.cliamod_make_name AS amod_make_name, "
        aSQL_String_Client_Select = aSQL_String_Client_Select & "Client_Aircraft_Model.cliamod_model_name AS amod_model_name, client_aircraft.cliaircraft_jetnet_ac_id as jetnet_ac_id,"
        aSQL_String_Client_Select = aSQL_String_Client_Select & "Client_Aircraft.cliaircraft_status AS ac_status, Client_Aircraft.cliaircraft_year_mfr AS ac_year_mfr, "
        aSQL_String_Client_Select = aSQL_String_Client_Select & "Client_Aircraft_Contact_Type.cliact_name AS act_name, Client_Aircraft.cliaircraft_forsale_flag AS ac_forsale_flag, Client_Aircraft.cliaircraft_exclusive_flag AS ac_exclusive_flag, Client_Aircraft.cliaircraft_asking_wordage AS ac_asking_wordage, "
        aSQL_String_Client_Select = aSQL_String_Client_Select & "Client_Aircraft.cliaircraft_asking_price AS ac_asking_price, Client_Aircraft.cliaircraft_lease_flag AS ac_lease_flag, Client_Aircraft_Reference.cliacref_comp_id AS comp_id, Client_Aircraft_Reference.cliacref_contact_id AS contact_id, "
        aSQL_String_Client_Select = aSQL_String_Client_Select & "Client_Aircraft.cliaircraft_product_business_flag as ac_product_business_flag,	Client_Aircraft.cliaircraft_product_helicopter_flag as ac_product_helicopter_flag, Client_Aircraft.cliaircraft_product_commercial_flag AS ac_product_commercial_flag, Client_Aircraft_Model.cliamod_make_type as amod_make_type, "
        aSQL_String_Client_Select = aSQL_String_Client_Select & "'CLIENT' AS source, client_aircraft.cliaircraft_est_price as ac_est_price, client_aircraft.cliaircraft_date_listed as ac_date_listed, "
        aSQL_String_Client_Select = aSQL_String_Client_Select & "client_aircraft.cliaircraft_delivery AS ac_delivery, client_aircraft_reference.cliacref_owner_percentage AS acref_owner_percentage, "
        aSQL_String_Client_Select = aSQL_String_Client_Select & "'JETNET' as lastnote, Client_Aircraft.cliaircraft_ser_nbr_sort as ac_ser_nbr_sort, cliacep_engine_1_ttsn_hours as acep_engine_1_ttsn_hours,cliacep_engine_2_ttsn_hours as acep_engine_2_ttsn_hours,cliacep_engine_3_ttsn_hours as acep_engine_3_ttsn_hours,cliacep_engine_4_ttsn_hours as acep_engine_4_ttsn_hours, "
        aSQL_String_Client_Select = aSQL_String_Client_Select & "cliacep_engine_1_tsoh_hours as acep_engine_1_tsoh_hours,cliacep_engine_2_tsoh_hours as acep_engine_2_tsoh_hours,cliacep_engine_3_tsoh_hours as acep_engine_3_tsoh_hours,cliacep_engine_4_tsoh_hours as acep_engine_4_tsoh_hours, "
        aSQL_String_Client_Select = aSQL_String_Client_Select & "cliacep_engine_1_tshi_hours as ac_engine_1_shi_hrs,cliacep_engine_2_tshi_hours as ac_engine_2_shi_hrs,cliacep_engine_3_tshi_hours as ac_engine_3_shi_hrs,cliacep_engine_4_tshi_hours as ac_engine_4_shi_hrs,"

        aSQL_String_Client_Select = aSQL_String_Client_Select & " ''  as lastevent, clicomp_name as comp_name, clicomp_address1 as comp_address1, clicomp_address2 as comp_address2, "
        aSQL_String_Client_Select = aSQL_String_Client_Select & "clicomp_city as comp_city, clicomp_state as comp_state, clicomp_country as comp_country, clicomp_email_address as comp_email_address, clicomp_web_address as comp_web_address, "
        aSQL_String_Client_Select = aSQL_String_Client_Select & "clicomp_zip_code as comp_zip_code, clicontact_first_name as contact_first_name, clicontact_last_name as contact_last_name, clicontact_title as contact_title, clicontact_email_address as contact_email_address,"
        aSQL_String_Client_Select = aSQL_String_Client_Select & "clicontact_middle_initial as contact_middle_initial, clicontact_preferred_name as contact_preferred_name, clicontact_notes as contact_notes "
        aSQL_String_Client_Select = aSQL_String_Client_Select & " from client_aircraft"

        aSQL_String_Client_Select = aSQL_String_Client_Select & " inner JOIN client_aircraft_model ON client_aircraft.cliaircraft_cliamod_id = client_aircraft_model.cliamod_id "
        aSQL_String_Client_Select = aSQL_String_Client_Select & " LEFT OUTER JOIN client_aircraft_reference ON client_aircraft_reference.cliacref_cliac_id = client_aircraft.cliaircraft_id "
        aSQL_String_Client_Select = aSQL_String_Client_Select & " left outer join client_aircraft_engine on client_aircraft.cliaircraft_id=cliacep_cliac_id "
        aSQL_String_Client_Select = aSQL_String_Client_Select & " left outer join client_contact on client_aircraft_reference.cliacref_contact_id=clicontact_id "
        aSQL_String_Client_Select = aSQL_String_Client_Select & " LEFT OUTER JOIN client_company on client_aircraft_reference.cliacref_comp_id = client_company.clicomp_id "
        aSQL_String_Client_Select = aSQL_String_Client_Select & " LEFT OUTER JOIN client_aircraft_contact_type ON client_aircraft_reference.cliacref_contact_type = client_aircraft_contact_type.cliact_type"

        'The Building of the Where Clause 
        If ID_SQL_IN_CLIENT <> "" Then
          If AircraftNotesSearch = 2 Then 'Without notes
            aSQL_String_Client_Where = " cliaircraft_id not in (" & ID_SQL_IN_CLIENT & ")"
          Else 'With notes/With and without notes
            aSQL_String_Client_Where = " cliaircraft_id in (" & ID_SQL_IN_CLIENT & ")"
          End If
        End If

        '                where(Year() >= year_start) and year <= year_end

        Dim AndQ As String = ""

        'Starting with Custom Field 1
        If CustomField1 <> "" Then
          If CustomField1 = "_" Then
            CustomField1 = "%"
          End If
          data_subset = "C"
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_custom_1 like '" & CustomField1 & "' "
        End If

        'Custom Field 2
        If CustomField2 <> "" Then
          If CustomField2 = "_" Then
            CustomField2 = "%"
          End If
          data_subset = "C"
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_custom_2 like '" & CustomField2 & "' "
        End If

        'Custom Field 3
        If CustomField3 <> "" Then
          If CustomField3 = "_" Then
            CustomField3 = "%"
          End If
          data_subset = "C"
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_custom_3 like '" & CustomField3 & "' "
        End If

        'Custom Field 4
        If CustomField4 <> "" Then
          If CustomField4 = "_" Then
            CustomField4 = "%"
          End If
          data_subset = "C"
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_custom_4 like '" & CustomField4 & "' "
        End If

        'Custom Field 5
        If CustomField5 <> "" Then
          If CustomField5 = "_" Then
            CustomField5 = "%"
          End If
          data_subset = "C"
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_custom_5 like '" & CustomField5 & "' "
        End If

        'Custom Field 6
        If CustomField6 <> "" Then
          If CustomField6 = "_" Then
            CustomField6 = "%"
          End If
          data_subset = "C"
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_custom_6 like '" & CustomField6 & "' "
        End If

        'Custom Field 7
        If CustomField7 <> "" Then
          If CustomField7 = "_" Then
            CustomField7 = "%"
          End If
          data_subset = "C"
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_custom_7 like '" & CustomField7 & "' "
        End If

        'Custom Field 8
        If CustomField8 <> "" Then
          If CustomField8 = "_" Then
            CustomField8 = "%"
          End If
          data_subset = "C"
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_custom_8 like '" & CustomField8 & "' "
        End If

        'Custom Field 9
        If CustomField9 <> "" Then
          If CustomField9 = "_" Then
            CustomField9 = "%"
          End If
          data_subset = "C"
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_custom_9 like '" & CustomField9 & "' "
        End If

        'Custom Field 10
        If CustomField10 <> "" Then
          If CustomField10 = "_" Then
            CustomField10 = "%"
          End If
          data_subset = "C"
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_custom_10 like '" & CustomField9 & "' "
        End If

        If year_start <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_year_mfr >= '" & year_start & "' "
        End If

        If year_end <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_year_mfr <= '" & year_end & "' "
        End If


        If on_exclusive <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_exclusive_flag = '" & on_exclusive & "' "
        End If

        If operator_type <> "" Then
          If aSQL_String_Client_Where <> "" Then
            aSQL_String_Client_Where += " and "
          End If
          Select Case operator_type
            Case "whole"
              aSQL_String_Client_Where += " cliacref_contact_type in ('00')"
            Case "all"
              aSQL_String_Client_Where += " cliacref_contact_type in ('00','97','08','56')"
            Case "shared"
              aSQL_String_Client_Where += " cliacref_contact_type in ('08')"
            Case "fractional"
              aSQL_String_Client_Where += " cliacref_contact_type in ('97','17')"
            Case "operators"
              aSQL_String_Client_Where += " cliacref_operator_flag='Y'"
          End Select
        End If



        If on_lease <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_lease_flag like '" & on_lease & "' "
        End If

        If airport_name <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_aport_name like '%" & airport_name & "%' "
        End If

        If icao_code <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_aport_icao_code like '%" & icao_code & "%' "
        End If

        If iata_code <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_aport_iata_code like '%" & iata_code & "%' "
        End If

        If ac_city <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_aport_city like '%" & ac_city & "%' "
        End If


        If ownership <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_ownership in ('" & ownership & "') "
        End If


        If ac_country <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_aport_country in (" & ac_country & ") "
        End If

        If ac_state <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_aport_state IN(" & ac_state & ") "
        End If


        If client_models <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliamod_id in (" & client_models & ") "
        End If

        If ac_text <> "%" And ac_text <> "%%" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If

          search_string = ""
          op = " LIKE "

          If search_where = "3" Then
            op = " = "
          End If

          If search_field = "1" Then 'serial/reg
            search_string = " cliaircraft_ser_nbr " & op & " '" & ac_text & "' or cliaircraft_reg_nbr " & op & " '" & ac_text & "' "
          ElseIf search_field = 2 Then 'ser
            search_string = " cliaircraft_ser_nbr  " & op & " '" & ac_text & "'"
          ElseIf search_field = 3 Then 'reg
            search_string = " cliaircraft_reg_nbr  " & op & " '" & ac_text & "' "
          ElseIf search_field = 4 Then 'ac id
            search_string = " cliaircraft_id " & op & " '" & ac_text & "' "
          ElseIf search_field = 5 Then
            search_string = " cliaircraft_ser_nbr " & op & " '" & ac_text & "' or cliaircraft_reg_nbr " & op & " '" & ac_text & "' or cliamod_make_name " & op & " '" & ac_text & "' or cliamod_model_name " & op & " '" & ac_text & "'"
          End If



          'If search_where = "3" Then ' equals = 
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & "(" & search_string & ")"

          'Else
          '    aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & "(cliaircraft_ser_nbr like '" & ac_text & "' or cliaircraft_reg_nbr like '" & ac_text & "' or cliamod_make_name = '" & ac_text & "' or cliamod_make_type = '" & ac_text & "')"

          'End If
        End If

        If aSQL_String_Client_Where <> "" Then
          AndQ = " and "
        Else
          AndQ = ""
        End If

        Select Case market_status
          Case "For Sale"
            aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_forsale_flag = 'Y'"
          Case "Not For Sale"
            aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_forsale_flag = 'N'"
          Case "For Sale Exclusive"
            aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_exclusive_flag = 'Y'"
          Case "Lease"
            aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_lease_flag = 'Y'"
          Case ""
          Case Else
            aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_status = '" & market_status & "'"
        End Select


        MySqlConn.ConnectionString = Me.client_DB
        MySqlConn.Open()
        MySqlCommand.Connection = MySqlConn
        MySqlCommand.CommandType = CommandType.Text
        MySqlCommand.CommandTimeout = 60

        MySqlCommand.CommandText = aSQL_String_Client_Select & " WHERE " & aSQL_String_Client_Where


        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>AC_Search_New(ByVal first_column As String, ByVal data_subset As String, ByVal operator_type As String, ByVal ID_SQL_IN_JETNET As String, ByVal ID_SQL_IN_CLIENT As String, ByVal ac_text As String, ByVal market_status As String, ByVal airport_name As String, ByVal icao_code As String, ByVal iata_code As String, ByVal ac_city As String, ByVal ac_country As String, ByVal ac_state As String, ByVal client_models As String, ByVal jetnet_models As String, ByVal helicopter As Boolean, ByVal business As Boolean, ByVal jets As Boolean, ByVal executive As Boolean, ByVal turboprops As Boolean, ByVal commercial As Boolean, ByVal aerodex As Boolean, ByVal on_exclusive As String, ByVal on_lease As String, ByVal year_start As String, ByVal year_end As String) As DataTable <em>Client Side!</em></b><br />" & aSQL_String_Client_Select & " WHERE " & aSQL_String_Client_Where

        MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


        While MySqlReader.Read()
          Dim newCustomersRow As DataRow = atemptable.NewRow()
          newCustomersRow("ac_id") = MySqlReader.Item("ac_id")
          newCustomersRow("ac_amod_id") = MySqlReader.Item("ac_amod_id")
          newCustomersRow("ac_ser_nbr") = MySqlReader.Item("ac_ser_nbr")
          newCustomersRow("ac_reg_nbr") = MySqlReader.Item("ac_reg_nbr")
          newCustomersRow("ac_airframe_tot_hrs") = MySqlReader.Item("ac_airframe_tot_hrs")
          newCustomersRow("amod_make_name") = MySqlReader.Item("amod_make_name")
          newCustomersRow("amod_model_name") = MySqlReader.Item("amod_model_name")
          newCustomersRow("amod_make_type") = MySqlReader.Item("amod_make_type")
          newCustomersRow("ac_status") = MySqlReader.Item("ac_status")
          newCustomersRow("ac_year_mfr") = MySqlReader.Item("ac_year_mfr")
          newCustomersRow("act_name") = MySqlReader.Item("act_name")
          newCustomersRow("ac_forsale_flag") = MySqlReader.Item("ac_forsale_flag")
          newCustomersRow("ac_exclusive_flag") = MySqlReader.Item("ac_exclusive_flag")
          newCustomersRow("ac_asking_wordage") = MySqlReader.Item("ac_asking_wordage")
          newCustomersRow("ac_asking_price") = MySqlReader.Item("ac_asking_price")
          newCustomersRow("ac_lease_flag") = MySqlReader.Item("ac_lease_flag")
          newCustomersRow("comp_id") = MySqlReader.Item("comp_id")
          newCustomersRow("ac_date_listed") = MySqlReader.Item("ac_date_listed")
          newCustomersRow("ac_product_business_flag") = MySqlReader.Item("ac_product_business_flag")
          newCustomersRow("ac_product_helicopter_flag") = MySqlReader.Item("ac_product_helicopter_flag")
          newCustomersRow("ac_product_commercial_flag") = MySqlReader.Item("ac_product_commercial_flag")
          newCustomersRow("ac_est_price") = MySqlReader.Item("ac_est_price")
          newCustomersRow("ac_ser_nbr_sort") = MySqlReader.Item("ac_ser_nbr_sort")
          newCustomersRow("value_price") = MySqlReader.Item("value_price")
          newCustomersRow("acref_owner_percentage") = MySqlReader.Item("acref_owner_percentage")
          newCustomersRow("contact_id") = MySqlReader.Item("contact_id")
          newCustomersRow("source") = MySqlReader.Item("source")
          newCustomersRow("ac_delivery") = MySqlReader.Item("ac_delivery")
          newCustomersRow("jetnet_ac_id") = MySqlReader.Item("jetnet_ac_id")
          newCustomersRow("lastnote") = MySqlReader.Item("lastnote")
          newCustomersRow("comp_name") = MySqlReader.Item("comp_name")
          newCustomersRow("comp_address1") = MySqlReader.Item("comp_address1")
          newCustomersRow("comp_address2") = MySqlReader.Item("comp_address2")
          newCustomersRow("comp_city") = MySqlReader.Item("comp_city")
          newCustomersRow("comp_state") = MySqlReader.Item("comp_state")
          newCustomersRow("comp_country") = MySqlReader.Item("comp_country")
          newCustomersRow("comp_zip_code") = MySqlReader.Item("comp_zip_code")
          newCustomersRow("comp_email_address") = MySqlReader.Item("comp_email_address")
          newCustomersRow("comp_web_address") = MySqlReader.Item("comp_web_address")
          newCustomersRow("comp_source") = "CLIENT"
          newCustomersRow("contact_first_name") = MySqlReader.Item("contact_first_name")
          newCustomersRow("contact_last_name") = MySqlReader.Item("contact_last_name")
          newCustomersRow("contact_middle_initial") = MySqlReader.Item("contact_middle_initial")
          newCustomersRow("contact_preferred_name") = MySqlReader.Item("contact_preferred_name")
          newCustomersRow("contact_title") = MySqlReader.Item("contact_title")
          newCustomersRow("contact_email_address") = MySqlReader.Item("contact_email_address")
          newCustomersRow("contact_notes") = MySqlReader.Item("contact_notes")

          'Added 1/14/16 an option to exclude the matching jetnet searching IDS from the list.
          If MergeLists = True Then
            'Only care about saving this here:
            If JetnetIDExcluded <> "" Then
              JetnetIDExcluded += ","
            End If
            JetnetIDExcluded += MySqlReader.Item("jetnet_ac_id").ToString
          End If


          newCustomersRow("acep_engine_1_ttsn_hours") = MySqlReader.Item("acep_engine_1_ttsn_hours")
          newCustomersRow("acep_engine_2_ttsn_hours") = MySqlReader.Item("acep_engine_2_ttsn_hours")
          newCustomersRow("acep_engine_3_ttsn_hours") = MySqlReader.Item("acep_engine_3_ttsn_hours")
          newCustomersRow("acep_engine_4_ttsn_hours") = MySqlReader.Item("acep_engine_4_ttsn_hours")


          newCustomersRow("ac_engine_1_shi_hrs") = MySqlReader.Item("ac_engine_1_shi_hrs")
          newCustomersRow("ac_engine_2_shi_hrs") = MySqlReader.Item("ac_engine_2_shi_hrs")
          newCustomersRow("ac_engine_3_shi_hrs") = MySqlReader.Item("ac_engine_3_shi_hrs")
          newCustomersRow("ac_engine_4_shi_hrs") = MySqlReader.Item("ac_engine_4_shi_hrs")

          newCustomersRow("acep_engine_1_tsoh_hours") = MySqlReader.Item("acep_engine_1_tsoh_hours")
          newCustomersRow("acep_engine_2_tsoh_hours") = MySqlReader.Item("acep_engine_2_tsoh_hours")
          newCustomersRow("acep_engine_3_tsoh_hours") = MySqlReader.Item("acep_engine_3_tsoh_hours")
          newCustomersRow("acep_engine_4_tsoh_hours") = MySqlReader.Item("acep_engine_4_tsoh_hours")
          newCustomersRow("ac_upd_date") = MySqlReader.Item("ac_upd_date")
          newCustomersRow("lastevent") = "CLIENT"

          atemptable.Rows.Add(newCustomersRow)
          atemptable.AcceptChanges()
        End While

      End If ' If (data_subset = "C" Or data_subset = "JC") Then

      '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
      '------------------------------------------------------------------ check to see if we are getting JETNET data---------------------------------------------
      '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
      If (data_subset = "J" Or data_subset = "JC" Or data_subset = "B") Then
        '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
        '--------------------------------------------------------------------- Setup the JETNET SQL Strings-----------------------------------------------------
        '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
        'The basic company fields
        aSQL_String_JETNET_Select = "SELECT DISTINCT "
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & "Aircraft.ac_id, aircraft.ac_upd_date, Aircraft.ac_amod_id,  Aircraft.ac_airframe_tot_hrs, Aircraft.ac_ser_no_full as ac_ser_nbr, Aircraft.ac_reg_no as ac_reg_nbr, Aircraft_Model.amod_make_name, "
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & "Aircraft_Model.amod_model_name, Aircraft.ac_status, aircraft.ac_id as jetnet_ac_id, "
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & "Aircraft.ac_mfr_year as ac_year_mfr, '0' as ac_est_price, aircraft.ac_list_date as ac_date_listed, 'JETNET' as lastnote, "
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & "Aircraft_Contact_Type.actype_name as act_name, Aircraft.ac_forsale_flag, Aircraft.ac_exclusive_flag, Aircraft.ac_asking as ac_asking_wordage, Aircraft.ac_asking_price, "
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & "Aircraft.ac_lease_flag, Aircraft_Reference.cref_comp_id as comp_id, Aircraft_Reference.cref_contact_id as contact_id, 'JETNET' AS source, aircraft.ac_delivery, aircraft_reference.cref_owner_percent as acref_owner_percentage, "
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & "Aircraft.ac_product_business_flag,	Aircraft.ac_product_helicopter_flag, Aircraft.ac_product_commercial_flag, Aircraft_Model.amod_type_code as amod_make_type, "
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " comp_name, comp_address1, comp_address2, comp_city,comp_state, comp_country, comp_email_address, comp_web_address, "
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & "comp_zip_code,contact_first_name, contact_last_name, contact_middle_initial, '' as contact_preferred_name, contact_title, contact_email_address, '' as contact_notes,ac_ser_no_sort as ac_ser_nbr_sort, "
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & "ac_engine_1_shi_hrs, ac_engine_2_shi_hrs, ac_engine_3_shi_hrs, ac_engine_4_shi_hrs, "
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & "ac_engine_1_tot_hrs as acep_engine_1_ttsn_hours, ac_engine_2_tot_hrs as acep_engine_2_ttsn_hours,ac_engine_3_tot_hrs as acep_engine_3_ttsn_hours, ac_engine_4_tot_hrs as acep_engine_4_ttsn_hours, "
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & "ac_engine_1_soh_hrs as acep_engine_1_tsoh_hours,ac_engine_2_soh_hrs as acep_engine_2_tsoh_hours,ac_engine_3_soh_hrs as acep_engine_3_tsoh_hours, ac_engine_4_soh_hrs as acep_engine_4_tsoh_hours, "
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " '' as lastevent FROM Aircraft WITH (NOLOCK) "

        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " inner JOIN aircraft_model WITH (NOLOCK) ON aircraft.ac_amod_id = aircraft_model.amod_id "
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " LEFT OUTER JOIN aircraft_reference WITH (NOLOCK) ON aircraft_reference.cref_ac_id = aircraft.ac_id and aircraft_reference.cref_journ_id = ac_journ_id"
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " left outer join contact WITH (NOLOCK) on aircraft_reference.cref_contact_id=contact_id and contact_journ_id = cref_journ_id and contact_hide_flag='N' "

        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " inner JOIN company WITH (NOLOCK) ON company.comp_id = aircraft_reference.cref_comp_id and comp_journ_id = cref_journ_id "
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " inner JOIN aircraft_contact_type WITH (NOLOCK) ON aircraft_reference.cref_contact_type = aircraft_contact_type.actype_code "

        '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
        '-----------------------------------------------------------------The Building of the Where Clause----------------------------------------------------
        '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
        'journ id=0!!!!!!!!!!!!

        Dim AndQ As String = ""

        aSQL_String_JETNET_Where = " ac_journ_id = 0 "

        If ID_SQL_IN_JETNET <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          If AircraftNotesSearch = 2 Then 'Not in search. Without notes. 2
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_id not in (" & ID_SQL_IN_JETNET & ")"
          Else 'With notes or a regular folder search 1/0
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_id in (" & ID_SQL_IN_JETNET & ")"
          End If

        End If


        If MergeLists = True Then 'If you want to exclude matching jetnet rows
          If JetnetIDExcluded <> "" Then
            If aSQL_String_JETNET_Where <> "" Then
              AndQ = " and "
            Else
              AndQ = ""
            End If
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_id not in (" & JetnetIDExcluded & ")"
          End If
        End If

        If year_start <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_mfr_year >= '" & year_start & "' "
        End If

        If ownership <> "" Then
          If aSQL_String_Client_Where <> "" Then
            aSQL_String_JETNET_Where += " and "
          End If
          aSQL_String_JETNET_Where += " ac_ownership_type in ('" & ownership & "') "
        End If


        If year_end <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            aSQL_String_JETNET_Where += " and "
          End If
          aSQL_String_JETNET_Where += " ac_mfr_year <= '" & year_end & "' "
        End If

        If airport_name <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_aport_name like '%" & airport_name & "%' "
        End If

        If on_exclusive <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_exclusive_flag = '" & on_exclusive & "' "
        End If

        ' check the operator_type 
        If operator_type <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            aSQL_String_JETNET_Where += " and "
          End If
          Select Case operator_type
            Case "whole"
              aSQL_String_JETNET_Where += " cref_contact_type in  ('00')"
            Case "all"
              aSQL_String_JETNET_Where += " cref_contact_type in ('00','97','08','56')"
            Case "shared"
              aSQL_String_JETNET_Where += " cref_contact_type in ('08')"
            Case "fractional"
              aSQL_String_JETNET_Where += " cref_contact_type in ('97','17')"
            Case "operators"
              aSQL_String_JETNET_Where += " cref_operator_flag='Y'"
          End Select
        End If

        If on_lease <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_lease_flag = '" & on_lease & "' "
        End If

        If icao_code <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_aport_icao_code like '%" & icao_code & "%' "
        End If

        If iata_code <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_aport_iata_code like '%" & iata_code & "%' "
        End If

        If ac_city <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_aport_city like '%" & ac_city & "%' "
        End If

        If ac_country <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_aport_country in (" & ac_country & ") "
        End If

        If ac_state <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_aport_state IN(" & ac_state & ") "
        End If

        If jetnet_models <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " amod_id in (" & jetnet_models & ") "
        End If

        If ac_text <> "%" And ac_text <> "%%" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If

          search_string = ""
          op = " LIKE "

          If search_where = "3" Then
            op = " = "
          End If

          If search_field = "1" Then 'serial/reg
            search_string = " ac_ser_no_full " & op & " '" & ac_text & "' or ac_reg_no " & op & " '" & ac_text & "' "
          ElseIf search_field = 2 Then 'ser
            search_string = " ac_ser_no_full " & op & " '" & ac_text & "'"
          ElseIf search_field = 3 Then 'reg
            search_string = " ac_reg_no " & op & " '" & ac_text & "' "
          ElseIf search_field = 4 Then 'ac id
            search_string = " ac_id " & op & " '" & ac_text & "' "
          ElseIf search_field = 5 Then
            search_string = " ac_ser_no_full " & op & " '" & ac_text & "' or ac_reg_no " & op & " '" & ac_text & "' or amod_make_name " & op & " '" & ac_text & "' or amod_model_name " & op & " '" & ac_text & "'"
          End If

          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & "(" & search_string & ")"

        End If


        If aSQL_String_JETNET_Where <> "" Then
          AndQ = " and "
        Else
          AndQ = ""
        End If
        Select Case market_status
          Case "For Sale"
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_forsale_flag = 'Y'"
          Case "Not For Sale"
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_forsale_flag = 'N'"
          Case "For Sale Exclusive"
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_exclusive_flag = 'Y'"
          Case "Lease"
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_lease_flag = 'Y'"
          Case ""
          Case Else
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_status = '" & market_status & "'"
        End Select


        aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " " & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(HttpContext.Current.Session.Item("localSubscription"), False, True)

        SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
        SqlConn.Open()
        SqlCommand.Connection = SqlConn


        sQuery = aSQL_String_JETNET_Select & " WHERE " & aSQL_String_JETNET_Where

        SqlCommand.CommandText = sQuery
        SqlCommand.CommandType = CommandType.Text
        SqlCommand.CommandTimeout = 180

        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>AC_Search_New(ByVal first_column As String, ByVal data_subset As String, ByVal operator_type As String, ByVal ID_SQL_IN_JETNET As String, ByVal ID_SQL_IN_CLIENT As String, ByVal ac_text As String, ByVal market_status As String, ByVal airport_name As String, ByVal icao_code As String, ByVal iata_code As String, ByVal ac_city As String, ByVal ac_country As String, ByVal ac_state As String, ByVal client_models As String, ByVal jetnet_models As String, ByVal helicopter As Boolean, ByVal business As Boolean, ByVal jets As Boolean, ByVal executive As Boolean, ByVal turboprops As Boolean, ByVal commercial As Boolean, ByVal aerodex As Boolean, ByVal on_exclusive As String, ByVal on_lease As String, ByVal year_start As String, ByVal year_end As String) As DataTable <em>JETNET Side!</em></b><br />" & sQuery
        SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


        dataSet.EnforceConstraints = False
        atemptable.PrimaryKey = Nothing
        atemptable.Constraints.Clear()

        'SqlReader = Nothing
        While SqlReader.Read()
          Dim newCustomersRow As DataRow = atemptable.NewRow()
          newCustomersRow("ac_id") = SqlReader.Item("ac_id")
          newCustomersRow("ac_amod_id") = SqlReader.Item("ac_amod_id")
          newCustomersRow("ac_ser_nbr") = SqlReader.Item("ac_ser_nbr")
          newCustomersRow("ac_reg_nbr") = SqlReader.Item("ac_reg_nbr")
          newCustomersRow("ac_airframe_tot_hrs") = SqlReader.Item("ac_airframe_tot_hrs")
          newCustomersRow("amod_make_name") = SqlReader.Item("amod_make_name")
          newCustomersRow("amod_model_name") = SqlReader.Item("amod_model_name")
          newCustomersRow("amod_make_type") = SqlReader.Item("amod_make_type")
          newCustomersRow("ac_status") = SqlReader.Item("ac_status")
          newCustomersRow("ac_year_mfr") = SqlReader.Item("ac_year_mfr")
          newCustomersRow("act_name") = SqlReader.Item("act_name")
          newCustomersRow("ac_forsale_flag") = SqlReader.Item("ac_forsale_flag")
          newCustomersRow("ac_exclusive_flag") = SqlReader.Item("ac_exclusive_flag")
          newCustomersRow("ac_asking_wordage") = SqlReader.Item("ac_asking_wordage")
          newCustomersRow("ac_asking_price") = SqlReader.Item("ac_asking_price")
          newCustomersRow("ac_lease_flag") = SqlReader.Item("ac_lease_flag")
          newCustomersRow("comp_id") = SqlReader.Item("comp_id")
          newCustomersRow("ac_date_listed") = SqlReader.Item("ac_date_listed")
          newCustomersRow("ac_product_business_flag") = SqlReader.Item("ac_product_business_flag")
          newCustomersRow("ac_product_helicopter_flag") = SqlReader.Item("ac_product_helicopter_flag")
          newCustomersRow("ac_product_commercial_flag") = SqlReader.Item("ac_product_commercial_flag")
          newCustomersRow("ac_est_price") = SqlReader.Item("ac_est_price")
          newCustomersRow("acref_owner_percentage") = SqlReader.Item("acref_owner_percentage")
          newCustomersRow("contact_id") = SqlReader.Item("contact_id")
          newCustomersRow("source") = SqlReader.Item("source")
          newCustomersRow("ac_delivery") = SqlReader.Item("ac_delivery")
          newCustomersRow("jetnet_ac_id") = SqlReader.Item("jetnet_ac_id")
          newCustomersRow("lastnote") = SqlReader.Item("lastnote")
          newCustomersRow("lastevent") = SqlReader.Item("lastevent")
          newCustomersRow("comp_source") = "JETNET"
          newCustomersRow("comp_name") = SqlReader.Item("comp_name")
          newCustomersRow("comp_address1") = SqlReader.Item("comp_address1")
          newCustomersRow("comp_address2") = SqlReader.Item("comp_address2")
          newCustomersRow("comp_city") = SqlReader.Item("comp_city")
          newCustomersRow("comp_state") = SqlReader.Item("comp_state")
          newCustomersRow("comp_country") = SqlReader.Item("comp_country")
          newCustomersRow("comp_zip_code") = SqlReader.Item("comp_zip_code")
          newCustomersRow("comp_email_address") = SqlReader.Item("comp_email_address")
          newCustomersRow("comp_web_address") = SqlReader.Item("comp_web_address")
          newCustomersRow("ac_ser_nbr_sort") = SqlReader.Item("ac_ser_nbr_sort")
          newCustomersRow("contact_first_name") = SqlReader.Item("contact_first_name")
          newCustomersRow("contact_last_name") = SqlReader.Item("contact_last_name")
          newCustomersRow("contact_middle_initial") = SqlReader.Item("contact_middle_initial")
          newCustomersRow("contact_preferred_name") = SqlReader.Item("contact_preferred_name")
          newCustomersRow("contact_title") = SqlReader.Item("contact_title")
          newCustomersRow("contact_email_address") = SqlReader.Item("contact_email_address")
          newCustomersRow("contact_notes") = SqlReader.Item("contact_notes")
          newCustomersRow("value_price") = ""
          newCustomersRow("acep_engine_1_tsoh_hours") = SqlReader.Item("acep_engine_1_tsoh_hours")
          newCustomersRow("acep_engine_2_tsoh_hours") = SqlReader.Item("acep_engine_2_tsoh_hours")
          newCustomersRow("acep_engine_3_tsoh_hours") = SqlReader.Item("acep_engine_3_tsoh_hours")
          newCustomersRow("acep_engine_4_tsoh_hours") = SqlReader.Item("acep_engine_4_tsoh_hours")

          newCustomersRow("acep_engine_1_ttsn_hours") = SqlReader.Item("acep_engine_1_ttsn_hours")
          newCustomersRow("acep_engine_2_ttsn_hours") = SqlReader.Item("acep_engine_2_ttsn_hours")
          newCustomersRow("acep_engine_3_ttsn_hours") = SqlReader.Item("acep_engine_3_ttsn_hours")
          newCustomersRow("acep_engine_4_ttsn_hours") = SqlReader.Item("acep_engine_4_ttsn_hours")
          newCustomersRow("ac_engine_1_shi_hrs") = SqlReader.Item("ac_engine_1_shi_hrs")
          newCustomersRow("ac_engine_2_shi_hrs") = SqlReader.Item("ac_engine_2_shi_hrs")
          newCustomersRow("ac_engine_3_shi_hrs") = SqlReader.Item("ac_engine_3_shi_hrs")
          newCustomersRow("ac_engine_4_shi_hrs") = SqlReader.Item("ac_engine_4_shi_hrs")

          newCustomersRow("ac_upd_date") = SqlReader.Item("ac_upd_date")

          atemptable.Rows.Add(newCustomersRow)
          atemptable.AcceptChanges()
        End While

      End If ' If (data_subset = "J" Or data_subset = "JC") Then

      ''''''''''''''''''''''''''''''''combining
      dalTable = atemptable.Clone
      dataSet.EnforceConstraints = False
      dalTable.PrimaryKey = Nothing
      dalTable.Constraints.Clear()

      Dim afiltered_Client As DataRow() = atemptable.Select("", first_column & ", jetnet_ac_id asc, comp_source desc")
      ' extract and import
      For Each atmpDataRow_Client In afiltered_Client
        dalTable.ImportRow(atmpDataRow_Client)
      Next
      AC_Search_New = dalTable

      Dim adatatable4 As New DataTable
      Dim old_ac_id As Long = 0
      Dim comp_name As String = ""

      adatatable4.Columns.Add("ac_id")
      adatatable4.Columns.Add("other_ac_id")
      adatatable4.Columns.Add("ac_amod_id")
      adatatable4.Columns.Add("ac_ser_nbr")
      adatatable4.Columns.Add("other_ac_ser_nbr")
      adatatable4.Columns.Add("ac_reg_nbr")
      adatatable4.Columns.Add("other_ac_reg_nbr")
      Dim ac_airframe_tot_hrs As DataColumn = adatatable4.Columns.Add("ac_airframe_tot_hrs", Type.GetType("System.Int32"))
      ac_airframe_tot_hrs.AllowDBNull = True
      Dim other_ac_airframe_tot_hrs As DataColumn = adatatable4.Columns.Add("other_ac_airframe_tot_hrs", Type.GetType("System.Int32"))
      other_ac_airframe_tot_hrs.AllowDBNull = True


      adatatable4.Columns.Add("amod_make_name")
      adatatable4.Columns.Add("amod_model_name")
      adatatable4.Columns.Add("amod_make_type")
      adatatable4.Columns.Add("ac_status")
      adatatable4.Columns.Add("other_ac_status")
      adatatable4.Columns.Add("ac_year_mfr")
      adatatable4.Columns.Add("other_ac_year_mfr")
      adatatable4.Columns.Add("act_name")
      adatatable4.Columns.Add("ac_forsale_flag")
      adatatable4.Columns.Add("other_ac_forsale_flag")
      adatatable4.Columns.Add("ac_exclusive_flag")
      adatatable4.Columns.Add("other_ac_exclusive_flag")
      adatatable4.Columns.Add("ac_asking_wordage")
      adatatable4.Columns.Add("other_ac_asking_wordage")
      adatatable4.Columns.Add("ac_asking_price")
      adatatable4.Columns.Add("other_ac_asking_price")
      adatatable4.Columns.Add("ac_lease_flag")
      adatatable4.Columns.Add("other_ac_lease_flag")
      adatatable4.Columns.Add("comp_id")
      adatatable4.Columns.Add("ac_date_listed")
      adatatable4.Columns.Add("other_ac_date_listed")
      adatatable4.Columns.Add("ac_product_business_flag")
      adatatable4.Columns.Add("ac_product_helicopter_flag")
      adatatable4.Columns.Add("ac_product_commercial_flag")
      adatatable4.Columns.Add("ac_est_price")
      adatatable4.Columns.Add("contact_id")
      adatatable4.Columns.Add("source")
      adatatable4.Columns.Add("other_source")
      adatatable4.Columns.Add("ac_delivery")
      adatatable4.Columns.Add("acref_owner_percentage")
      adatatable4.Columns.Add("lastnote")
      adatatable4.Columns.Add("lastevent")
      adatatable4.Columns.Add("jetnet_ac_id")
      adatatable4.Columns.Add("ac_ser_nbr_sort")
      adatatable4.Columns.Add("comp_name")
      adatatable4.Columns.Add("comp_address1")
      adatatable4.Columns.Add("comp_address2")
      adatatable4.Columns.Add("comp_city")
      adatatable4.Columns.Add("comp_state")
      adatatable4.Columns.Add("comp_country")
      adatatable4.Columns.Add("comp_zip_code")
      adatatable4.Columns.Add("comp_email_address")
      adatatable4.Columns.Add("comp_web_address")

      adatatable4.Columns.Add("contact_first_name")
      adatatable4.Columns.Add("contact_last_name")
      adatatable4.Columns.Add("contact_middle_initial")
      adatatable4.Columns.Add("contact_preferred_name")
      adatatable4.Columns.Add("contact_title")
      adatatable4.Columns.Add("contact_email_address")
      adatatable4.Columns.Add("contact_notes")
      adatatable4.Columns.Add("acep_engine_1_ttsn_hours")
      adatatable4.Columns.Add("other_acep_engine_1_ttsn_hours")
      adatatable4.Columns.Add("acep_engine_2_ttsn_hours")
      adatatable4.Columns.Add("other_acep_engine_2_ttsn_hours")
      adatatable4.Columns.Add("acep_engine_3_ttsn_hours")
      adatatable4.Columns.Add("other_acep_engine_3_ttsn_hours")
      adatatable4.Columns.Add("acep_engine_4_ttsn_hours")
      adatatable4.Columns.Add("other_acep_engine_4_ttsn_hours")
      adatatable4.Columns.Add("acep_engine_1_tsoh_hours")
      adatatable4.Columns.Add("other_acep_engine_1_tsoh_hours")
      adatatable4.Columns.Add("acep_engine_2_tsoh_hours")
      adatatable4.Columns.Add("other_acep_engine_2_tsoh_hours")
      adatatable4.Columns.Add("acep_engine_3_tsoh_hours")
      adatatable4.Columns.Add("other_acep_engine_3_tsoh_hours")
      adatatable4.Columns.Add("acep_engine_4_tsoh_hours")
      adatatable4.Columns.Add("other_acep_engine_4_tsoh_hours")


      adatatable4.Columns.Add("ac_engine_1_shi_hrs")
      adatatable4.Columns.Add("ac_engine_2_shi_hrs")
      adatatable4.Columns.Add("ac_engine_3_shi_hrs")
      adatatable4.Columns.Add("ac_engine_4_shi_hrs")

      adatatable4.Columns.Add("other_ac_engine_1_shi_hrs")
      adatatable4.Columns.Add("other_ac_engine_2_shi_hrs")
      adatatable4.Columns.Add("other_ac_engine_3_shi_hrs")
      adatatable4.Columns.Add("other_ac_engine_4_shi_hrs")


      adatatable4.Columns.Add("comp_source")
      adatatable4.Columns.Add("value_price")
      adatatable4.Columns.Add("ac_upd_date")
      adatatable4.Columns.Add("other_ac_upd_date")

      Dim b As Integer = 1
      Dim counted As Integer = dalTable.Rows.Count
      Dim cont_id As String = ""
      Dim act_name As String = ""
      Dim acref_owner_percentage As String = ""
      Dim name As String = ""
      Dim address As String = ""
      Dim address2 As String = ""
      Dim city As String = ""
      Dim state As String = ""
      Dim country As String = ""
      Dim zip As String = ""
      Dim email As String = ""
      Dim web As String = ""

      Dim first As String = ""
      Dim last As String = ""
      Dim middle As String = ""
      Dim title As String = ""
      Dim pref As String = ""
      Dim cemail As String = ""
      Dim notes As String = ""


      'repeated values!!
      Dim ac_repeat As String = ""
      Dim repeated As Boolean = False
      Dim other_case As String = ""
      Dim year_repeat As String = ""
      Dim reg_repeat As String = ""
      Dim ac_listed_date As String = ""

      Dim ac_asking_repeat As Integer = 0
      Dim ac_est_repeat As Integer = 0

      Dim other_act_name As String = ""

      Dim other_acref_owner_percentage As String = ""
      Dim other_comp_name As String = ""
      Dim other_cont_id As String = ""
      Dim other_name As String = ""
      Dim other_address As String = ""
      Dim other_address2 As String = ""
      Dim other_city As String = ""
      Dim other_state As String = ""
      Dim other_country As String = ""
      Dim other_zip As String = ""
      Dim other_email As String = ""
      Dim other_web As String = ""

      Dim other_first As String = ""
      Dim other_last As String = ""
      Dim other_middle As String = ""
      Dim other_title As String = ""
      Dim other_pref As String = ""
      Dim other_cemail As String = ""
      Dim other_notes As String = ""
      Dim repeatable_company As String = ""
      Dim repeat_counting As Integer = 0
      Dim type_mapping As String = ""
      Dim company_source As String = ""
      Dim page_link As String = "details.aspx"
      Dim OrderLink As Long = 0
      If HttpContext.Current.Session.Item("isMobile") = True Then
        page_link = "Mobile_Details.aspx"
      End If

      For Each r As DataRow In dalTable.Rows
        Dim newCustomersRow As DataRow = adatatable4.NewRow()
        repeated = False


        Dim acit As Long = r("ac_id")
        Dim jetnet_ac_id As Long = r("jetnet_ac_id")

        If acit = 12793 Then
          Dim x As String = ""
          x = "here"
        End If
        If b = 1 Then
          old_ac_id = r("ac_id")
        End If
        Dim next_ac As Long = 0
        Dim next_jetnet_id As Long = 0
        If b <> counted Then
          next_ac = dalTable.Rows(b).Item("ac_id")
          next_jetnet_id = dalTable.Rows(b).Item("jetnet_ac_id")
        Else
          next_ac = 0
          next_jetnet_id = 0
        End If
        Select Case UCase(r("source"))
          Case "JETNET"
            other_case = "CLIENT"
          Case "CLIENT"
            other_case = "JETNET"
        End Select

        ac_repeat = ""
        year_repeat = ""
        reg_repeat = ""
        ac_listed_date = ""
        ac_asking_repeat = 0
        ac_est_repeat = 0
        type_mapping = ""

        Dim s_string As String = ""

        s_string = "source = '" & other_case & "' and jetnet_ac_id = '" & r("jetnet_ac_id") & "'" ' and amod_make_name = '" & r("amod_make_name") & "' and amod_model_name = '" & r("amod_model_name") & "' and (ac_reg_nbr = '' or ac_reg_nbr = NULL)"

        If other_case = "CLIENT" Then
          'Let's check for other AC
          Dim afiltered_search As DataRow() = dalTable.Select(s_string, "")
          'extract and import
          For Each atmpDataRow_JETNET In afiltered_search
            '  If jetnet_ac_id <> next_jetnet_id Then
            repeated = True
            ' End If
          Next
        Else


          Dim afiltered_search As DataRow() = dalTable.Select(s_string, "")
          'extract and import
          Dim new_table As DataTable = dalTable.Clone
          For Each atmpDataRow_JETNET In afiltered_search
            new_table.ImportRow(atmpDataRow_JETNET)

          Next

          If new_table.Rows.Count > 0 Then
            repeated = False
            'one to one
            '----------------------------------------------------------Serial Number--------------------------------------------------
            If new_table.Rows(0).Item("source") = "JETNET" Then

              newCustomersRow.Item("other_ac_ser_nbr") = IIf(Not IsDBNull(new_table.Rows(0).Item("ac_ser_nbr")), "<em><a href='" & page_link & "?order=" & OrderLink.ToString & "&type=3&source=" & Trim(new_table.Rows(0).Item("source").ToString) & "&ac_id=" & new_table.Rows(0).Item("ac_id") & "'>" & new_table.Rows(0).Item("ac_ser_nbr") & "</span>", "")
              newCustomersRow.Item("other_source") = new_table.Rows(0).Item("source")
              OrderLink = OrderLink + 1
            Else
              newCustomersRow.Item("ac_ser_nbr") = IIf(Not IsDBNull(new_table.Rows(0).Item("ac_ser_nbr")), "<em><a class='client_row' href='" & page_link & "?order=" & OrderLink.ToString & "&type=3&source=" & Trim(new_table.Rows(0).Item("source").ToString) & "&ac_id=" & new_table.Rows(0).Item("ac_id") & "'>" & new_table.Rows(0).Item("ac_ser_nbr") & "</span>", "")
              newCustomersRow.Item("source") = new_table.Rows(0).Item("source")
              OrderLink = OrderLink + 1
            End If

            newCustomersRow.Item("other_ac_year_mfr") = IIf(Not IsDBNull(new_table.Rows(0).Item("ac_year_mfr")), new_table.Rows(0).Item("ac_year_mfr"), "")

            '----------------------------------------------------Reg Number-------------------------------
            newCustomersRow.Item("other_ac_reg_nbr") = IIf(Not IsDBNull(new_table.Rows(0).Item("ac_reg_nbr")), new_table.Rows(0).Item("ac_reg_nbr"), "")

            newCustomersRow.Item("other_ac_id") = new_table.Rows(0).Item("ac_id")

            '--------------------------------------------------Source------------------------------------------------------
            '-----------------------------------------------------SHI HOURS---------------------------------------------
            If IIf(Not IsDBNull(r("ac_engine_1_shi_hrs")), r("ac_engine_1_shi_hrs"), 0) <> IIf(Not IsDBNull(new_table.Rows(0).Item("ac_engine_1_shi_hrs")), new_table.Rows(0).Item("ac_engine_1_shi_hrs"), 0) Then
              newCustomersRow.Item("other_ac_engine_1_shi_hrs") = IIf(Not IsDBNull(new_table.Rows(0).Item("ac_engine_1_shi_hrs")), new_table.Rows(0).Item("ac_engine_1_shi_hrs"), 0)
            End If
            If IIf(Not IsDBNull(r("ac_engine_2_shi_hrs")), r("ac_engine_2_shi_hrs"), 0) <> IIf(Not IsDBNull(new_table.Rows(0).Item("ac_engine_2_shi_hrs")), new_table.Rows(0).Item("ac_engine_2_shi_hrs"), 0) Then
              newCustomersRow.Item("other_ac_engine_2_shi_hrs") = IIf(Not IsDBNull(new_table.Rows(0).Item("ac_engine_2_shi_hrs")), new_table.Rows(0).Item("ac_engine_2_shi_hrs"), 0)
            End If
            If IIf(Not IsDBNull(r("ac_engine_3_shi_hrs")), r("ac_engine_3_shi_hrs"), 0) <> IIf(Not IsDBNull(new_table.Rows(0).Item("ac_engine_3_shi_hrs")), new_table.Rows(0).Item("ac_engine_3_shi_hrs"), 0) Then
              newCustomersRow.Item("other_ac_engine_3_shi_hrs") = IIf(Not IsDBNull(new_table.Rows(0).Item("ac_engine_3_shi_hrs")), new_table.Rows(0).Item("ac_engine_3_shi_hrs"), 0)
            End If
            If IIf(Not IsDBNull(r("ac_engine_4_shi_hrs")), r("ac_engine_4_shi_hrs"), 0) <> IIf(Not IsDBNull(new_table.Rows(0).Item("ac_engine_4_shi_hrs")), new_table.Rows(0).Item("ac_engine_4_shi_hrs"), 0) Then
              newCustomersRow.Item("other_ac_engine_4_shi_hrs") = IIf(Not IsDBNull(new_table.Rows(0).Item("ac_engine_4_shi_hrs")), new_table.Rows(0).Item("ac_engine_4_shi_hrs"), 0)
            End If
            '-----------------------------------------------------TTSN HOURS---------------------------------------------
            If IIf(Not IsDBNull(r("acep_engine_1_ttsn_hours")), r("acep_engine_1_ttsn_hours"), 0) <> IIf(Not IsDBNull(new_table.Rows(0).Item("acep_engine_1_ttsn_hours")), new_table.Rows(0).Item("acep_engine_1_ttsn_hours"), 0) Then
              newCustomersRow.Item("other_acep_engine_1_ttsn_hours") = IIf(Not IsDBNull(new_table.Rows(0).Item("acep_engine_1_ttsn_hours")), new_table.Rows(0).Item("acep_engine_1_ttsn_hours"), 0)
            End If
            If IIf(Not IsDBNull(r("acep_engine_2_ttsn_hours")), r("acep_engine_2_ttsn_hours"), 0) <> IIf(Not IsDBNull(new_table.Rows(0).Item("acep_engine_2_ttsn_hours")), new_table.Rows(0).Item("acep_engine_2_ttsn_hours"), 0) Then
              newCustomersRow.Item("other_acep_engine_2_ttsn_hours") = IIf(Not IsDBNull(new_table.Rows(0).Item("acep_engine_2_ttsn_hours")), new_table.Rows(0).Item("acep_engine_2_ttsn_hours"), 0)
            End If
            If IIf(Not IsDBNull(r("acep_engine_3_ttsn_hours")), r("acep_engine_3_ttsn_hours"), 0) <> IIf(Not IsDBNull(new_table.Rows(0).Item("acep_engine_3_ttsn_hours")), new_table.Rows(0).Item("acep_engine_3_ttsn_hours"), 0) Then
              newCustomersRow.Item("other_acep_engine_3_ttsn_hours") = IIf(Not IsDBNull(new_table.Rows(0).Item("acep_engine_3_ttsn_hours")), new_table.Rows(0).Item("acep_engine_3_ttsn_hours"), 0)
            End If
            If IIf(Not IsDBNull(r("acep_engine_4_ttsn_hours")), r("acep_engine_4_ttsn_hours"), 0) <> IIf(Not IsDBNull(new_table.Rows(0).Item("acep_engine_4_ttsn_hours")), new_table.Rows(0).Item("acep_engine_4_ttsn_hours"), 0) Then
              newCustomersRow.Item("other_acep_engine_4_ttsn_hours") = IIf(Not IsDBNull(new_table.Rows(0).Item("acep_engine_4_ttsn_hours")), new_table.Rows(0).Item("acep_engine_4_ttsn_hours"), 0)
            End If
            '-----------------------------------------------------TSOH HOURS---------------------------------------------------
            If IIf(Not IsDBNull(r("acep_engine_1_tsoh_hours")), r("acep_engine_1_tsoh_hours"), 0) <> IIf(Not IsDBNull(new_table.Rows(0).Item("acep_engine_1_tsoh_hours")), new_table.Rows(0).Item("acep_engine_1_tsoh_hours"), 0) Then
              newCustomersRow.Item("other_acep_engine_1_tsoh_hours") = IIf(Not IsDBNull(new_table.Rows(0).Item("acep_engine_1_tsoh_hours")), new_table.Rows(0).Item("acep_engine_1_tsoh_hours"), 0)
            End If
            If IIf(Not IsDBNull(r("acep_engine_2_tsoh_hours")), r("acep_engine_2_tsoh_hours"), 0) <> IIf(Not IsDBNull(new_table.Rows(0).Item("acep_engine_2_tsoh_hours")), new_table.Rows(0).Item("acep_engine_2_tsoh_hours"), 0) Then
              newCustomersRow.Item("other_acep_engine_2_tsoh_hours") = IIf(Not IsDBNull(new_table.Rows(0).Item("acep_engine_2_tsoh_hours")), new_table.Rows(0).Item("acep_engine_2_ttsn_hours"), 0)
            End If
            If IIf(Not IsDBNull(r("acep_engine_3_tsoh_hours")), r("acep_engine_3_tsoh_hours"), 0) <> IIf(Not IsDBNull(new_table.Rows(0).Item("acep_engine_3_tsoh_hours")), new_table.Rows(0).Item("acep_engine_3_tsoh_hours"), 0) Then
              newCustomersRow.Item("other_acep_engine_3_tsoh_hours") = IIf(Not IsDBNull(new_table.Rows(0).Item("acep_engine_3_tsoh_hours")), new_table.Rows(0).Item("acep_engine_3_tsoh_hours"), 0)
            End If
            If IIf(Not IsDBNull(r("acep_engine_4_tsoh_hours")), r("acep_engine_4_tsoh_hours"), 0) <> IIf(Not IsDBNull(new_table.Rows(0).Item("acep_engine_4_tsoh_hours")), new_table.Rows(0).Item("acep_engine_4_tsoh_hours"), 0) Then
              newCustomersRow.Item("other_acep_engine_4_tsoh_hours") = IIf(Not IsDBNull(new_table.Rows(0).Item("acep_engine_4_tsoh_hours")), new_table.Rows(0).Item("acep_engine_4_tsoh_hours"), 0)
            End If
            '-----------------------------------------------------AIRFRAME TOT HOURS-------------------------------------------
            If IIf(Not IsDBNull(r("ac_airframe_tot_hrs")), r("ac_airframe_tot_hrs"), 0) <> IIf(Not IsDBNull(new_table.Rows(0).Item("ac_airframe_tot_hrs")), new_table.Rows(0).Item("ac_airframe_tot_hrs"), 0) Then
              newCustomersRow.Item("other_ac_airframe_tot_hrs") = IIf(Not IsDBNull(new_table.Rows(0).Item("ac_airframe_tot_hrs")), new_table.Rows(0).Item("ac_airframe_tot_hrs"), 0)
            End If
            '--------------------For Sale Flag--------------------
            'If IIf(Not IsDBNull(r("ac_forsale_flag")), r("ac_forsale_flag"), "N") <> IIf(Not IsDBNull(new_table.Rows(0).Item("ac_forsale_flag")), new_table.Rows(0).Item("ac_forsale_flag"), "N") Then
            newCustomersRow.Item("other_ac_forsale_flag") = IIf(Not IsDBNull(new_table.Rows(0).Item("ac_forsale_flag")), new_table.Rows(0).Item("ac_forsale_flag"), "N")
            'End If
            '--------------------Exclusive Flag--------------------
            'If IIf(Not IsDBNull(r("ac_exclusive_flag")), r("ac_exclusive_flag"), "N") <> IIf(Not IsDBNull(new_table.Rows(0).Item("ac_exclusive_flag")), new_table.Rows(0).Item("ac_exclusive_flag"), "N") Then
            newCustomersRow.Item("other_ac_exclusive_flag") = IIf(Not IsDBNull(new_table.Rows(0).Item("ac_exclusive_flag")), new_table.Rows(0).Item("ac_exclusive_flag"), "N")
            'End If
            '--------------------Lease Flag--------------------
            'If IIf(Not IsDBNull(r("ac_lease_flag")), r("ac_lease_flag"), "N") <> IIf(Not IsDBNull(new_table.Rows(0).Item("ac_lease_flag")), new_table.Rows(0).Item("ac_lease_flag"), "N") Then
            newCustomersRow.Item("other_ac_lease_flag") = IIf(Not IsDBNull(new_table.Rows(0).Item("ac_lease_flag")), new_table.Rows(0).Item("ac_lease_flag"), "N")
            'End If
            '--------------------Asking Wordage--------------
            newCustomersRow.Item("other_ac_asking_wordage") = IIf(Not IsDBNull(new_table.Rows(0).Item("ac_asking_wordage")), new_table.Rows(0).Item("ac_asking_wordage"), "")
            '--------------------AC Status--------------
            newCustomersRow.Item("other_ac_status") = IIf(Not IsDBNull(new_table.Rows(0).Item("ac_status")), new_table.Rows(0).Item("ac_status"), "")
            '----------------------AC Date Listed----------------
            newCustomersRow.Item("other_ac_date_listed") = IIf(Not IsDBNull(new_table.Rows(0).Item("ac_date_listed")), clsGeneral.clsGeneral.datenull(new_table.Rows(0).Item("ac_date_listed")), "")
            newCustomersRow.Item("other_ac_asking_price") = IIf(Not IsDBNull(new_table.Rows(0).Item("ac_asking_price")), clsGeneral.clsGeneral.no_zero(new_table.Rows(0).Item("ac_asking_price"), "", True), "")

            '----------------------AC Update Date----------------
            If Not IsDBNull(new_table.Rows(0).Item("ac_upd_date")) Then
              newCustomersRow.Item("other_ac_upd_date") = new_table.Rows(0).Item("ac_upd_date")
            End If

          End If
          'repeated = False
        End If

        Dim hold_company_name As String = ""
        Dim hold_contact_first As String = ""
        Dim hold_contact_last As String = ""
        Dim hold_act_name As String = ""

        If Not IsDBNull(r("comp_name")) Then
          hold_company_name = Trim(r("comp_name"))
        End If

        If Not IsDBNull(r("contact_first_name")) Then
          hold_contact_first = Trim(r("contact_first_name"))
        End If

        If Not IsDBNull(r("contact_last_name")) Then
          hold_contact_last = Trim(r("contact_last_name"))
        End If

        If Not IsDBNull(r("act_name")) Then
          hold_act_name = Trim(r("act_name"))
        End If

        Dim comp_compare As String = hold_company_name & "|||" & hold_contact_first & "|||" & hold_contact_last & "|||" & hold_act_name

        If InStr(repeatable_company, comp_compare) = 0 Then
          Dim compare_id As Integer = r("jetnet_ac_id")
          Dim replace_comp As String = ""
          If Not IsDBNull(r("comp_name")) Then
            replace_comp = Trim(Replace(r("comp_name"), "'", "''"))
          End If

          'Dim s As String = "jetnet_ac_id = '" & compare_id & "' and comp_name = '" & replace_comp & "' and source = 'JETNET' and act_name = '" & r("act_name") & "' and contact_id = '" & r("contact_id") & "'"
          Dim afiltered_search As DataRow() = dalTable.Select("jetnet_ac_id = '" & compare_id & "' and comp_name = '" & replace_comp & "' and source = 'JETNET' and act_name = '" & hold_act_name & "' ", "")
          'extract and import
          Dim new_table As DataTable = dalTable.Clone
          For Each atmpDataRow_JETNET In afiltered_search
            new_table.ImportRow(atmpDataRow_JETNET)
          Next

          If Not IsNothing(new_table) Then
            If new_table.Rows.Count > 0 Then
              If r("source") = "JETNET" Then
                company_source = company_source & "JETNET|" 'client company with jetnet company view
              Else
                company_source = company_source & "CJETNET|" 'client company with jetnet company view
              End If

            Else
              company_source = company_source & "CLIENT|"
            End If
          Else
            company_source = company_source & "CLIENT|"
          End If
          repeatable_company = repeatable_company & "|||" & hold_company_name & "|||" & hold_contact_first & "|||" & hold_contact_last & "|||" & hold_act_name
          act_name = act_name & r("act_name") & "|"
          acref_owner_percentage = acref_owner_percentage & r("acref_owner_percentage") & "|"
          comp_name = comp_name & r("comp_id") & "|"
          cont_id = cont_id & r("contact_id") & "|"
          name = name & r("comp_name") & "|"
          address = address & r("comp_address1") & "|"
          address2 = address2 & r("comp_address2") & "|"
          city = city & r("comp_city") & "|"
          state = state & r("comp_state") & "|"
          country = country & r("comp_country") & "|"
          zip = zip & r("comp_zip_code") & "|"
          email = email & r("comp_email_address") & "|"
          web = web & r("comp_web_address") & "|"

          first = first & r("contact_first_name") & "|"
          last = last & r("contact_last_name") & "|"
          middle = middle & r("contact_middle_initial") & "|"
          title = title & r("contact_title") & "|"
          pref = pref & r("contact_preferred_name") & "|"
          cemail = cemail & r("contact_email_address") & "|"
          notes = notes & r("contact_notes") & "|"
        End If
        newCustomersRow.Item("value_price") = r("value_price")
        '----------------------------------------------------------------Ac ID--------------------------------------------
        newCustomersRow.Item("ac_id") = r("ac_id")
        '---------------------------------------------------------------Ac Amod ID--------------------------------------------
        newCustomersRow.Item("ac_amod_id") = r("ac_amod_id")
        '--------------------------------------------------Ser Number---------------------------------
        If Not IsDBNull(r("ac_ser_nbr")) And Not IsDBNull(newCustomersRow.Item("other_ac_ser_nbr")) Then
          ' If newCustomersRow.Item("other_ac_forsale_flag") <> r("ac_forsale_flag") Then
          newCustomersRow.Item("ac_ser_nbr") = "<a class='" & LCase(Trim(r("source").ToString)) & "_row' href='" & page_link & "?order=" & OrderLink.ToString & "&type=3&source=" & Trim(r("source").ToString) & "&ac_id=" & r("ac_id") & "'>" & r("ac_ser_nbr") & "</a>"
          OrderLink = OrderLink + 1
          'End If
        Else
          If repeated = True Then
            newCustomersRow.Item("ac_ser_nbr") = "<a class='" & LCase(Trim(r("source").ToString)) & "_row' href='" & page_link & "?order=" & OrderLink.ToString & "&type=3&source=" & Trim(r("source").ToString) & "&ac_id=" & r("ac_id") & "'>" & r("ac_ser_nbr") & "</a>"
            '  OrderLink = OrderLink + 1
          Else
            newCustomersRow.Item("other_ac_ser_nbr") = "<a class='" & LCase(Trim(r("source").ToString)) & "_row' href='" & page_link & "?order=" & OrderLink.ToString & "&type=3&source=" & Trim(r("source").ToString) & "&ac_id=" & r("ac_id") & "'>" & r("ac_ser_nbr") & "</a>"
            OrderLink = OrderLink + 1
          End If
        End If

        '--------------------------------------------------Registration Number---------------------------------
        If Not IsDBNull(r("ac_reg_nbr")) And Not IsDBNull(newCustomersRow.Item("other_ac_reg_nbr")) Then
          ' If newCustomersRow.Item("other_ac_forsale_flag") <> r("ac_forsale_flag") Then
          newCustomersRow.Item("ac_reg_nbr") = r("ac_reg_nbr")
          'End If
        Else
          If repeated = True Then
            newCustomersRow.Item("ac_reg_nbr") = r("ac_reg_nbr")
          Else
            newCustomersRow.Item("other_ac_reg_nbr") = r("ac_reg_nbr")
          End If
        End If
        '-----------------------------------------------Contact Email Addresss---------------------------------------
        If Not IsDBNull(r("contact_email_address")) And Not IsDBNull(dalTable.Rows(b - 1).Item("contact_email_address")) Then
          If repeated = True Then
            If r("contact_email_address") <> dalTable.Rows(b - 1).Item("contact_email_address") Then
              newCustomersRow.Item("contact_email_address") = cemail '& other_cemail
            End If
          Else
            newCustomersRow.Item("contact_email_address") = cemail '& other_cemail
          End If
        Else
          newCustomersRow.Item("contact_email_address") = cemail '& other_cemail
        End If
        '-------------------------------------------Airframe Total Hours-----------------------------------------------
        If Not IsDBNull(r("ac_airframe_tot_hrs")) And Not IsDBNull(newCustomersRow.Item("other_ac_airframe_tot_hrs")) Then
          If newCustomersRow.Item("other_ac_airframe_tot_hrs") <> r("ac_airframe_tot_hrs") Then
            newCustomersRow.Item("ac_airframe_tot_hrs") = r("ac_airframe_tot_hrs")
          End If
        Else
          If repeated = True Then
            newCustomersRow.Item("ac_airframe_tot_hrs") = r("ac_airframe_tot_hrs")
          Else
            newCustomersRow.Item("other_ac_airframe_tot_hrs") = r("ac_airframe_tot_hrs")
          End If
        End If
        '------------------------------------------Model Make Name---------------------------------------------
        If Not IsDBNull(r("amod_make_name")) And Not IsDBNull(dalTable.Rows(b - 1).Item("amod_make_name")) Then
          If repeated = True Then
            If r("amod_make_name") <> dalTable.Rows(b - 1).Item("amod_make_name") Then
              newCustomersRow.Item("amod_make_name") = r("amod_make_name")
            End If
          Else
            newCustomersRow.Item("amod_make_name") = r("amod_make_name")
          End If
        Else
          newCustomersRow.Item("amod_make_name") = r("amod_make_name")
        End If
        '----------------------------------------------Model Model Name----------------------------------------
        If Not IsDBNull(r("amod_model_name")) And Not IsDBNull(dalTable.Rows(b - 1).Item("amod_model_name")) Then
          If repeated = True Then
            If r("amod_model_name") <> dalTable.Rows(b - 1).Item("amod_model_name") Then
              newCustomersRow.Item("amod_model_name") = r("amod_model_name")
            End If
          Else
            newCustomersRow.Item("amod_model_name") = r("amod_model_name")
          End If
        Else
          newCustomersRow.Item("amod_model_name") = r("amod_model_name")
        End If
        '------------------------------------------------Make Type -------------------------------------------
        If Not IsDBNull(r("amod_make_type")) And Not IsDBNull(dalTable.Rows(b - 1).Item("amod_make_type")) Then
          If repeated = True Then
            If r("amod_make_type") <> dalTable.Rows(b - 1).Item("amod_make_type") Then
              newCustomersRow.Item("amod_make_type") = r("amod_make_type")
            End If
          Else
            newCustomersRow.Item("amod_make_type") = r("amod_make_type")
          End If
        Else
          newCustomersRow.Item("amod_make_type") = r("amod_make_type")
        End If
        '-------------------------------------Year Manufactured----------------------------------------
        If Not IsDBNull(r("ac_year_mfr")) And Not IsDBNull(newCustomersRow.Item("other_ac_year_mfr")) Then
          ' If newCustomersRow.Item("other_ac_forsale_flag") <> r("ac_forsale_flag") Then
          newCustomersRow.Item("ac_year_mfr") = r("ac_year_mfr")
          'End If
        Else
          If repeated = True Then
            newCustomersRow.Item("ac_year_mfr") = r("ac_year_mfr")
          Else
            newCustomersRow.Item("other_ac_year_mfr") = r("ac_year_mfr")
          End If
        End If
        '----------------------------------------------Act Name----------------------------
        If Not IsDBNull(act_name) And Not IsDBNull(dalTable.Rows(b - 1).Item("act_name")) Then
          If repeated = True Then
            If act_name <> dalTable.Rows(b - 1).Item("act_name") Then
              newCustomersRow.Item("act_name") = act_name '& other_act_name 
            End If
          Else
            newCustomersRow.Item("act_name") = act_name '& other_act_name
          End If
        Else
          newCustomersRow.Item("act_name") = act_name '& other_act_name
        End If

        '--------------------------------------AC Forsale Flag------------------------------------------------------------
        If Not IsDBNull(r("ac_forsale_flag")) And Not IsDBNull(newCustomersRow.Item("other_ac_forsale_flag")) Then
          ' If newCustomersRow.Item("other_ac_forsale_flag") <> r("ac_forsale_flag") Then
          newCustomersRow.Item("ac_forsale_flag") = r("ac_forsale_flag")
          'End If
        Else
          If repeated = True Then
            newCustomersRow.Item("ac_forsale_flag") = r("ac_forsale_flag")
          Else
            newCustomersRow.Item("other_ac_forsale_flag") = r("ac_forsale_flag")
          End If
        End If
        '--------------------------------------------End Exclusive Flag--------------------------------------------------------
        '--------------------------------------Exclusive Flag------------------------------------------------------------

        If r("source") = "JETNET" Then
          newCustomersRow.Item("other_ac_exclusive_flag") = r("ac_exclusive_flag")
        Else
          newCustomersRow.Item("ac_exclusive_flag") = r("ac_exclusive_flag")
        End If

        '--------------------------------------------End Exclusive Flag--------------------------------------------------------
        '----------------------------------------Lease Flag--------------------------------------------------------------
        If r("source") = "JETNET" Then
          newCustomersRow.Item("other_ac_lease_flag") = r("ac_lease_flag")
        Else
          newCustomersRow.Item("ac_lease_flag") = r("ac_lease_flag")
        End If

        '--------------------------------------------End Lease Flag--------------------------------------------------------
        '--------------------------------------------Asking Wordage--------------------------------------------------------
        If Not IsDBNull(r("ac_asking_wordage")) And Not IsDBNull(newCustomersRow.Item("other_ac_asking_wordage")) Then
          'If newCustomersRow.Item("other_ac_asking_wordage") <> r("ac_asking_wordage") Then
          newCustomersRow.Item("ac_asking_wordage") = r("ac_asking_wordage")
          'End If
        Else
          If repeated = True Then
            newCustomersRow.Item("ac_asking_wordage") = r("ac_asking_wordage")
          Else
            newCustomersRow.Item("other_ac_asking_wordage") = r("ac_asking_wordage")
          End If
        End If
        '--------------------------------------------End Asking Wordage--------------------------------------------------------
        '--------------------------------------------AC Status--------------------------------------------------------
        If Not IsDBNull(r("ac_status")) And Not IsDBNull(newCustomersRow.Item("other_ac_status")) Then
          ' If newCustomersRow.Item("other_ac_status") <> r("ac_status") Then
          newCustomersRow.Item("ac_status") = r("ac_status")
          'End If
        Else
          If repeated = True Then
            newCustomersRow.Item("ac_status") = r("ac_status")
          Else
            newCustomersRow.Item("other_ac_status") = r("ac_status")
          End If
        End If
        '--------------------------------------------End AC Status--------------------------------------------------------
        '--------------------------------------------AC Date Listed--------------------------------------------------------
        If Not IsDBNull(r("ac_date_listed")) And Not IsDBNull(newCustomersRow.Item("other_ac_date_listed")) Then
          'If newCustomersRow.Item("other_ac_date_listed") <> r("ac_date_listed") Then
          newCustomersRow.Item("ac_date_listed") = clsGeneral.clsGeneral.datenull(r("ac_date_listed"))
          'End If
        Else
          If repeated = True Then
            newCustomersRow.Item("ac_date_listed") = clsGeneral.clsGeneral.datenull(r("ac_date_listed"))
          Else
            newCustomersRow.Item("other_ac_date_listed") = clsGeneral.clsGeneral.datenull(r("ac_date_listed"))
          End If
        End If
        '--------------------------------------------AC Update Date--------------------------------------------------------
        If Not IsDBNull(r("ac_upd_date")) And Not IsDBNull(newCustomersRow.Item("other_ac_upd_date")) Then
          newCustomersRow.Item("ac_upd_date") = clsGeneral.clsGeneral.datenull(r("ac_upd_date"))
        Else
          If repeated = True Then
            newCustomersRow.Item("ac_upd_date") = clsGeneral.clsGeneral.datenull(r("ac_upd_date"))
          Else
            newCustomersRow.Item("other_ac_upd_date") = clsGeneral.clsGeneral.datenull(r("ac_upd_date"))
          End If
        End If
        '--------------------------------------------End AC Status--------------------------------------------------------
        '--------------------------------------------AC Price--------------------------------------------------------
        If Not IsDBNull(r("ac_asking_price")) And Not IsDBNull(newCustomersRow.Item("other_ac_asking_price")) Then
          ' If newCustomersRow.Item("other_ac_asking_price") <> r("ac_asking_price") Then
          newCustomersRow.Item("ac_asking_price") = clsGeneral.clsGeneral.no_zero(r("ac_asking_price"), "", True)
          'End If
        Else
          If repeated = True Then
            newCustomersRow.Item("ac_asking_price") = clsGeneral.clsGeneral.no_zero(r("ac_asking_price"), "", True)
          Else
            newCustomersRow.Item("other_ac_asking_price") = clsGeneral.clsGeneral.no_zero(r("ac_asking_price"), "", True)
          End If
        End If
        '--------------------------------------------End AC Price--------------------------------------------------------

        If Not IsDBNull(comp_name) And Not IsDBNull(dalTable.Rows(b - 1).Item("comp_id")) Then
          If repeated = True Then
            If comp_name <> dalTable.Rows(b - 1).Item("comp_id") Then
              newCustomersRow.Item("comp_id") = comp_name '& other_comp_name
            End If
          Else
            newCustomersRow.Item("comp_id") = comp_name '& other_comp_name
          End If
        Else
          newCustomersRow.Item("comp_id") = comp_name '& other_comp_name
        End If
        '-------------------------------------------Company Name-----------------------------------
        If Not IsDBNull(name) And Not IsDBNull(dalTable.Rows(b - 1).Item("comp_name")) Then
          If repeated = True Then
            If name <> dalTable.Rows(b - 1).Item("comp_name") Then
              newCustomersRow.Item("comp_name") = name '& other_name
            End If
          Else
            newCustomersRow.Item("comp_name") = name '& other_name
          End If
        Else
          newCustomersRow.Item("comp_name") = name '& other_name
        End If
        '------------------------------------Company Address------------------------------------
        If Not IsDBNull(address) And Not IsDBNull(dalTable.Rows(b - 1).Item("comp_address1")) Then
          If repeated = True Then
            If address <> dalTable.Rows(b - 1).Item("comp_address1") Then
              newCustomersRow.Item("comp_address1") = address '& other_address
            End If
          Else
            newCustomersRow.Item("comp_address1") = address '& other_address
          End If
        Else
          newCustomersRow.Item("comp_address1") = address '& other_address
        End If

        '----------------------------------Company Address 2------------------------------------
        If Not IsDBNull(address2) And Not IsDBNull(dalTable.Rows(b - 1).Item("comp_address2")) Then
          If repeated = True Then
            If address2 <> dalTable.Rows(b - 1).Item("comp_address2") Then
              newCustomersRow.Item("comp_address2") = address2 '& other_address2
            End If
          Else
            newCustomersRow.Item("comp_address2") = address2 '& other_address2
          End If
        Else
          newCustomersRow.Item("comp_address2") = address2 '& other_address2
        End If

        '-----------------------------------Company City---------------------------------------
        If Not IsDBNull(city) And Not IsDBNull(dalTable.Rows(b - 1).Item("comp_city")) Then
          If repeated = True Then
            If city <> dalTable.Rows(b - 1).Item("comp_city") Then
              newCustomersRow.Item("comp_city") = city '& other_city
            End If
          Else
            newCustomersRow.Item("comp_city") = city '& other_city
          End If
        Else
          newCustomersRow.Item("comp_city") = city '& other_city
        End If
        '--------------------------------------------Company State------------------------------
        If Not IsDBNull(state) And Not IsDBNull(dalTable.Rows(b - 1).Item("comp_state")) Then
          If repeated = True Then
            If state <> dalTable.Rows(b - 1).Item("comp_state") Then
              newCustomersRow.Item("comp_state") = state '& other_state
            End If
          Else
            newCustomersRow.Item("comp_state") = state '& other_state
          End If
        Else
          newCustomersRow.Item("comp_state") = state '& other_state
        End If
        '--------------------------------Company Country-----------------------------------
        If Not IsDBNull(country) And Not IsDBNull(dalTable.Rows(b - 1).Item("comp_country")) Then
          If repeated = True Then
            If country <> dalTable.Rows(b - 1).Item("comp_country") Then
              newCustomersRow.Item("comp_country") = country '& other_country
            End If
          Else
            newCustomersRow.Item("comp_country") = country '& other_country
          End If
        Else
          newCustomersRow.Item("comp_country") = country '& other_country
        End If
        '---------------------------------Company zip--------------------------------------
        If Not IsDBNull(zip) And Not IsDBNull(dalTable.Rows(b - 1).Item("comp_zip_code")) Then
          If repeated = True Then
            If zip <> dalTable.Rows(b - 1).Item("comp_zip_code") Then
              newCustomersRow.Item("comp_zip_code") = zip '& other_zip
            End If
          Else
            newCustomersRow.Item("comp_zip_code") = zip '& other_zip
          End If
        Else
          newCustomersRow.Item("comp_zip_code") = zip '& other_zip
        End If
        '--------------------------------------Company Email--------------------------------------------
        If Not IsDBNull(email) And Not IsDBNull(dalTable.Rows(b - 1).Item("comp_email_address")) Then
          If repeated = True Then
            If email <> dalTable.Rows(b - 1).Item("comp_email_address") Then
              newCustomersRow.Item("comp_email_address") = email '& other_email
            End If
          Else
            newCustomersRow.Item("comp_email_address") = email '& other_email
          End If
        Else
          newCustomersRow.Item("comp_email_address") = email '& other_email
        End If
        '----------------------------------------Company Web Address----------------------------------------
        If Not IsDBNull(web) And Not IsDBNull(dalTable.Rows(b - 1).Item("comp_web_address")) Then
          If repeated = True Then
            If web <> dalTable.Rows(b - 1).Item("comp_web_address") Then
              newCustomersRow.Item("comp_web_address") = web '& other_web
            End If
          Else
            newCustomersRow.Item("comp_web_address") = web '& other_web
          End If
        Else
          newCustomersRow.Item("comp_web_address") = web '& other_web
        End If

        '-------------------------------------First Name---------------------------------------------------
        If Not IsDBNull(first) And Not IsDBNull(dalTable.Rows(b - 1).Item("contact_first_name")) Then
          If repeated = True Then
            If first <> dalTable.Rows(b - 1).Item("contact_first_name") Then
              newCustomersRow.Item("contact_first_name") = first '& other_first
            End If
          Else
            newCustomersRow.Item("contact_first_name") = first '& other_first
          End If
        Else
          newCustomersRow.Item("contact_first_name") = first '& other_first
        End If
        '-----------------------------------Last Name----------------------------------------------
        If Not IsDBNull(last) And Not IsDBNull(dalTable.Rows(b - 1).Item("contact_last_name")) Then
          If repeated = True Then
            If last <> dalTable.Rows(b - 1).Item("contact_last_name") Then
              newCustomersRow.Item("contact_last_name") = last '& other_last
            End If
          Else
            newCustomersRow.Item("contact_last_name") = last '& other_last
          End If
        Else
          newCustomersRow.Item("contact_last_name") = last '& other_last
        End If
        '----------------------------Middle Name---------------------------------------
        If Not IsDBNull(middle) And Not IsDBNull(dalTable.Rows(b - 1).Item("contact_middle_initial")) Then
          If repeated = True Then
            If middle <> dalTable.Rows(b - 1).Item("contact_middle_initial") Then
              newCustomersRow.Item("contact_middle_initial") = middle '& other_middle
            End If
          Else
            newCustomersRow.Item("contact_middle_initial") = middle '& other_middle
          End If
        Else
          newCustomersRow.Item("contact_middle_initial") = middle '& other_middle
        End If
        '--------------------------------Title----------------------------------
        If Not IsDBNull(title) And Not IsDBNull(dalTable.Rows(b - 1).Item("contact_title")) Then
          If repeated = True Then
            If title <> dalTable.Rows(b - 1).Item("contact_title") Then
              newCustomersRow.Item("contact_title") = title '& other_title
            End If
          Else
            newCustomersRow.Item("contact_title") = title '& other_title
          End If
        Else
          newCustomersRow.Item("contact_title") = title '& other_title
        End If
        '----------------------------Preferred Name-----------------------
        If Not IsDBNull(pref) And Not IsDBNull(dalTable.Rows(b - 1).Item("contact_preferred_name")) Then
          If repeated = True Then
            If pref <> dalTable.Rows(b - 1).Item("contact_preferred_name") Then
              newCustomersRow.Item("contact_preferred_name") = pref '& other_pref
            End If
          Else
            newCustomersRow.Item("contact_preferred_name") = pref '& other_pref
          End If
        Else
          newCustomersRow.Item("contact_preferred_name") = pref '& other_pref
        End If
        '-------------------------------Note------------------
        newCustomersRow.Item("lastnote") = r("lastnote")
        '-------------------------------Event------------------
        newCustomersRow.Item("lastevent") = r("lastevent")
        '----------------------------Sort-----------------
        newCustomersRow.Item("ac_ser_nbr_sort") = r("ac_ser_nbr_sort")
        '------------------------------AC ID----------------------
        newCustomersRow.Item("jetnet_ac_id") = r("jetnet_ac_id")
        '------------------------------------Notes-----------
        newCustomersRow("contact_notes") = notes
        '-------------------------------------------Flags----------------------------------
        newCustomersRow.Item("ac_product_business_flag") = r("ac_product_business_flag")
        newCustomersRow.Item("ac_product_helicopter_flag") = r("ac_product_helicopter_flag")
        newCustomersRow.Item("ac_product_commercial_flag") = r("ac_product_commercial_flag")

        'SHI Hrs
        If Not IsDBNull(r("ac_engine_1_shi_hrs")) And Not IsDBNull(newCustomersRow.Item("other_ac_engine_1_shi_hrs")) Then
          If newCustomersRow.Item("other_ac_engine_1_shi_hrs") <> r("ac_engine_1_shi_hrs") Then
            newCustomersRow.Item("ac_engine_1_shi_hrs") = r("ac_engine_1_shi_hrs")
          End If
        Else
          If repeated = True Then
            newCustomersRow.Item("ac_engine_1_shi_hrs") = r("ac_engine_1_shi_hrs")
          Else
            newCustomersRow.Item("other_ac_engine_1_shi_hrs") = r("ac_engine_1_shi_hrs")
          End If
        End If
        If Not IsDBNull(r("ac_engine_2_shi_hrs")) And Not IsDBNull(newCustomersRow.Item("other_ac_engine_2_shi_hrs")) Then
          If newCustomersRow.Item("other_ac_engine_2_shi_hrs") <> r("ac_engine_2_shi_hrs") Then
            newCustomersRow.Item("ac_engine_2_shi_hrs") = r("ac_engine_2_shi_hrs")
          End If
        Else
          If repeated = True Then
            newCustomersRow.Item("ac_engine_2_shi_hrs") = r("ac_engine_2_shi_hrs")
          Else
            newCustomersRow.Item("other_ac_engine_2_shi_hrs") = r("ac_engine_2_shi_hrs")
          End If
        End If
        If Not IsDBNull(r("ac_engine_3_shi_hrs")) And Not IsDBNull(newCustomersRow.Item("other_ac_engine_3_shi_hrs")) Then
          If newCustomersRow.Item("other_ac_engine_3_shi_hrs") <> r("ac_engine_3_shi_hrs") Then
            newCustomersRow.Item("ac_engine_3_shi_hrs") = r("ac_engine_3_shi_hrs")
          End If
        Else
          If repeated = True Then
            newCustomersRow.Item("ac_engine_3_shi_hrs") = r("ac_engine_3_shi_hrs")
          Else
            newCustomersRow.Item("other_ac_engine_3_shi_hrs") = r("ac_engine_3_shi_hrs")
          End If
        End If
        If Not IsDBNull(r("ac_engine_4_shi_hrs")) And Not IsDBNull(newCustomersRow.Item("other_ac_engine_4_shi_hrs")) Then
          If newCustomersRow.Item("other_ac_engine_4_shi_hrs") <> r("ac_engine_4_shi_hrs") Then
            newCustomersRow.Item("ac_engine_4_shi_hrs") = r("ac_engine_4_shi_hrs")
          End If
        Else
          If repeated = True Then
            newCustomersRow.Item("ac_engine_4_shi_hrs") = r("ac_engine_4_shi_hrs")
          Else
            newCustomersRow.Item("other_ac_engine_4_shi_hrs") = r("ac_engine_4_shi_hrs")
          End If
        End If
        '-----------------------------------------TTSN Hours-----------------------------------------
        If Not IsDBNull(r("acep_engine_1_ttsn_hours")) And Not IsDBNull(newCustomersRow.Item("other_acep_engine_1_ttsn_hours")) Then
          If newCustomersRow.Item("other_acep_engine_1_ttsn_hours") <> r("acep_engine_1_ttsn_hours") Then
            newCustomersRow.Item("acep_engine_1_ttsn_hours") = r("acep_engine_1_ttsn_hours")
          End If
        Else
          If repeated = True Then
            newCustomersRow.Item("acep_engine_1_ttsn_hours") = r("acep_engine_1_ttsn_hours")
          Else
            newCustomersRow.Item("other_acep_engine_1_ttsn_hours") = r("acep_engine_1_ttsn_hours")
          End If
        End If
        If Not IsDBNull(r("acep_engine_2_ttsn_hours")) And Not IsDBNull(newCustomersRow.Item("other_acep_engine_2_ttsn_hours")) Then
          If newCustomersRow.Item("other_acep_engine_2_ttsn_hours") <> r("acep_engine_2_ttsn_hours") Then
            newCustomersRow.Item("acep_engine_2_ttsn_hours") = r("acep_engine_2_ttsn_hours")
          End If
        Else
          If repeated = True Then
            newCustomersRow.Item("acep_engine_2_ttsn_hours") = r("acep_engine_2_ttsn_hours")
          Else
            newCustomersRow.Item("other_acep_engine_2_ttsn_hours") = r("acep_engine_2_ttsn_hours")
          End If
        End If

        If Not IsDBNull(r("acep_engine_3_ttsn_hours")) And Not IsDBNull(newCustomersRow.Item("other_acep_engine_3_ttsn_hours")) Then
          If newCustomersRow.Item("other_acep_engine_3_ttsn_hours") <> r("acep_engine_3_ttsn_hours") Then
            newCustomersRow.Item("acep_engine_3_ttsn_hours") = r("acep_engine_3_ttsn_hours")
          End If
        Else
          If repeated = True Then
            newCustomersRow.Item("acep_engine_3_ttsn_hours") = r("acep_engine_3_ttsn_hours")
          Else
            newCustomersRow.Item("other_acep_engine_3_ttsn_hours") = r("acep_engine_3_ttsn_hours")
          End If
        End If

        If Not IsDBNull(r("acep_engine_4_ttsn_hours")) And Not IsDBNull(newCustomersRow.Item("other_acep_engine_4_ttsn_hours")) Then
          If newCustomersRow.Item("other_acep_engine_4_ttsn_hours") <> r("acep_engine_4_ttsn_hours") Then
            newCustomersRow.Item("acep_engine_4_ttsn_hours") = r("acep_engine_4_ttsn_hours")
          End If
        Else
          If repeated = True Then
            newCustomersRow.Item("acep_engine_4_ttsn_hours") = r("acep_engine_4_ttsn_hours")
          Else
            newCustomersRow.Item("other_acep_engine_4_ttsn_hours") = r("acep_engine_4_ttsn_hours")
          End If
        End If
        '---------------------------------------------TSOH HOurs----------------------------------------------
        If Not IsDBNull(r("acep_engine_1_tsoh_hours")) And Not IsDBNull(newCustomersRow.Item("other_acep_engine_1_tsoh_hours")) Then
          If newCustomersRow.Item("other_acep_engine_1_tsoh_hours") <> r("acep_engine_1_tsoh_hours") Then
            newCustomersRow.Item("acep_engine_1_tsoh_hours") = r("acep_engine_1_tsoh_hours")
          End If
        Else
          If repeated = True Then
            newCustomersRow.Item("acep_engine_1_tsoh_hours") = r("acep_engine_1_tsoh_hours")
          Else
            newCustomersRow.Item("other_acep_engine_1_tsoh_hours") = r("acep_engine_1_tsoh_hours")
          End If
        End If
        If Not IsDBNull(r("acep_engine_2_tsoh_hours")) And Not IsDBNull(newCustomersRow.Item("other_acep_engine_2_tsoh_hours")) Then
          If newCustomersRow.Item("other_acep_engine_2_tsoh_hours") <> r("acep_engine_2_tsoh_hours") Then
            newCustomersRow.Item("acep_engine_2_tsoh_hours") = r("acep_engine_2_tsoh_hours")
          End If
        Else
          If repeated = True Then
            newCustomersRow.Item("acep_engine_2_tsoh_hours") = r("acep_engine_2_tsoh_hours")
          Else
            newCustomersRow.Item("other_acep_engine_2_tsoh_hours") = r("acep_engine_2_tsoh_hours")
          End If
        End If
        If Not IsDBNull(r("acep_engine_3_tsoh_hours")) And Not IsDBNull(newCustomersRow.Item("other_acep_engine_3_tsoh_hours")) Then
          If newCustomersRow.Item("other_acep_engine_3_tsoh_hours") <> r("acep_engine_3_tsoh_hours") Then
            newCustomersRow.Item("acep_engine_3_tsoh_hours") = r("acep_engine_3_tsoh_hours")
          End If
        Else
          If repeated = True Then
            newCustomersRow.Item("acep_engine_3_tsoh_hours") = r("acep_engine_3_tsoh_hours")
          Else
            newCustomersRow.Item("other_acep_engine_3_tsoh_hours") = r("acep_engine_3_tsoh_hours")
          End If
        End If
        If Not IsDBNull(r("acep_engine_4_tsoh_hours")) And Not IsDBNull(newCustomersRow.Item("other_acep_engine_4_tsoh_hours")) Then
          If newCustomersRow.Item("other_acep_engine_4_tsoh_hours") <> r("acep_engine_4_tsoh_hours") Then
            newCustomersRow.Item("acep_engine_4_tsoh_hours") = r("acep_engine_4_tsoh_hours")
          End If
        Else
          If repeated = True Then
            newCustomersRow.Item("acep_engine_4_tsoh_hours") = r("acep_engine_4_tsoh_hours")
          Else
            newCustomersRow.Item("other_acep_engine_4_tsoh_hours") = r("acep_engine_4_tsoh_hours")
          End If
        End If
        '----------------------------------------------------------ESTIMATED PRICE---------------------------------------------
        If UCase(r("source")) = "CLIENT" Then
          newCustomersRow.Item("ac_est_price") = "<span class='client_row'>" & clsGeneral.clsGeneral.no_zero(r("ac_est_price"), "", True) & "</span>"
        End If
        '------------------------------------------------------------Contact ID-----------------------------------------------------
        If Not IsDBNull(cont_id) And Not IsDBNull(r("contact_id")) Then
          If repeated = True Then
            If cont_id <> dalTable.Rows(b - 1).Item("contact_id") Then
              newCustomersRow.Item("contact_id") = cont_id '& other_cont_id
            End If
          Else
            newCustomersRow.Item("contact_id") = cont_id '& other_cont_id
          End If
        Else
          newCustomersRow.Item("contact_id") = cont_id '& other_cont_id
        End If
        '----------------------------------------------------AC Delivery---------------------------------------
        If Not IsDBNull(r("ac_delivery")) And Not IsDBNull(dalTable.Rows(b - 1).Item("ac_delivery")) Then
          If repeated = True Then
            If r("ac_delivery") <> dalTable.Rows(b - 1).Item("ac_delivery") Then
              newCustomersRow.Item("ac_delivery") = r("ac_delivery")
            End If
          Else
            newCustomersRow.Item("ac_delivery") = r("ac_delivery")
          End If
        Else
          newCustomersRow.Item("ac_delivery") = r("ac_delivery")
        End If
        '---------------------------------------------------Owner Percentage------------------------------------
        If Not IsDBNull(acref_owner_percentage) And Not IsDBNull(r("acref_owner_percentage")) Then
          If repeated = True Then
            If acref_owner_percentage <> dalTable.Rows(b - 1).Item("acref_owner_percentage") Then
              newCustomersRow.Item("acref_owner_percentage") = acref_owner_percentage '& other_acref_owner_percentage
            End If
          Else
            newCustomersRow.Item("acref_owner_percentage") = acref_owner_percentage '& other_acref_owner_percentage
          End If
        Else
          newCustomersRow.Item("acref_owner_percentage") = acref_owner_percentage '& other_acref_owner_percentage
        End If

        '---------------------------------------------Company Source------------------------------
        If Not IsDBNull(company_source) And Not IsDBNull(r("comp_source")) Then
          If repeated = True Then
            If acref_owner_percentage <> dalTable.Rows(b - 1).Item("comp_source") Then
              newCustomersRow.Item("comp_source") = company_source '& other_acref_owner_percentage
            End If
          Else
            newCustomersRow.Item("comp_source") = company_source '& other_acref_owner_percentage
          End If
        Else
          newCustomersRow.Item("comp_source") = company_source '& other_acref_owner_percentage
        End If

        '--------------------------------------------Source----------------------------------------
        If IsDBNull(newCustomersRow("other_source")) Then

          If IsDBNull(newCustomersRow.Item("source")) Then
            newCustomersRow.Item("source") = r("source")
          Else
            newCustomersRow.Item("other_source") = r("source")
          End If

        Else
          newCustomersRow.Item("source") = r("source")
        End If



        'Dim e As String = jetnet_ac_id
        'e = next_jetnet_id
        If acit <> next_ac Then
          If repeated = False Then
            repeat_counting = 0
            repeatable_company = ""
            adatatable4.Rows.Add(newCustomersRow)

            adatatable4.AcceptChanges()
            comp_name = ""
            company_source = ""
            cont_id = ""
            acref_owner_percentage = ""
            act_name = ""
            name = ""
            address = ""
            address2 = ""
            city = ""
            state = ""
            country = ""
            zip = ""
            email = ""
            web = ""

            first = ""
            last = ""
            middle = ""
            title = ""
            pref = ""
            cemail = ""
            notes = ""

            other_comp_name = ""
            other_cont_id = ""
            other_acref_owner_percentage = ""
            other_act_name = ""
            other_name = ""
            other_address = ""
            other_address2 = ""
            other_city = ""
            other_state = ""
            other_country = ""
            other_zip = ""
            other_email = ""
            other_web = ""

            other_first = ""
            other_last = ""
            other_middle = ""
            other_title = ""
            other_pref = ""
            other_cemail = ""
            other_notes = ""

            ' '
          End If
        End If
        ' End If

        old_ac_id = r("ac_id")
        b = b + 1


      Next

      Dim daltable2 As DataTable = adatatable4.Clone
      ', jetnet_ac_id asc
      '    Dim afiltered_Client2 As DataRow() = adatatable4.Select("", first_column & ", jetnet_ac_id asc")
      Dim afiltered_Client2 As DataRow() = adatatable4.Select("", "")
      ' extract and import
      For Each atmpDataRow_Client2 In afiltered_Client2
        daltable2.ImportRow(atmpDataRow_Client2)
        ' Dim test As String = atmpDataRow_Client2("ac_airframe_tot_hrs")
      Next


      AC_Search_New = daltable2 'adatatable4

      atemptable = Nothing
      atemptable2 = Nothing
      dalTable = Nothing
      adatatable4 = Nothing


    Catch ex As Exception
      AC_Search_New = Nothing
      Me.class_error = "Error in AC_Search_New(): SQL VERSION" & ex.Message
    Finally
      'SqlReader.Close()
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing

      'MySqlReader.Close()
      MySqlReader = Nothing


      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function

  '/////////////////////////////////AIRCRAFT/////////////////////////////////////////
  ''' <summary>
  ''' This function runs the AC Search on both the Master and Mobile Websites. 
  ''' </summary>
  ''' <param name="first_column">Column that the data is sorted by</param>
  ''' <param name="data_subset">Type of data we're displaying, jetnet/client/both?</param>
  ''' <param name="operator_type">Types of operators, owners, etc</param>
  ''' <param name="ID_SQL_IN_JETNET">Jetnet MODEL IDs sent from subfolder</param>
  ''' <param name="ID_SQL_IN_CLIENT">Client MODEL IDs sent from subfolder</param>
  ''' <param name="ac_text">Search string</param>
  ''' <param name="market_status">Market Status</param>
  ''' <param name="airport_name">Airport Name Search paramater</param>
  ''' <param name="icao_code">ICAO Search paramater</param>
  ''' <param name="iata_code">IATA search paramater</param>
  ''' <param name="ac_city">Airport City Search Parameter</param>
  ''' <param name="ac_country">AC Country Search Parameter</param>
  ''' <param name="ac_state">Airport State Search Parameter</param>
  ''' <param name="client_models">Client Models sent from Model ID listbox</param>
  ''' <param name="jetnet_models">Jetnet Models sent from Model ID listbox</param>
  ''' <param name="helicopter">view helicopter security setting</param>
  ''' <param name="business">view business security setting</param>
  ''' <param name="jets">view jets security setting</param>
  ''' <param name="executive">view executive security setting</param>
  ''' <param name="turboprops">view turboprops security setting</param>
  ''' <param name="commercial">view commercial security setting</param>
  ''' <param name="aerodex">view aerodex security setting</param>
  ''' <param name="on_exclusive">on exclusive flag</param>
  ''' <param name="on_lease">on lease flag</param>
  ''' <param name="year_start">year mfr start string</param> 
  ''' <param name="year_end">year mfr end string</param>
  ''' <returns>Returns Datatable</returns>
  ''' <remarks>First thing that happens is that the function builds a temporary table.
  ''' Then this same function queries the Jetnet History Table.
  ''' And then throws that information into the Temporary Table
  ''' And then.. queries the client history table and puts it into the temporary table.
  ''' Then it creates a table meant to return with all the columns.
  ''' Then it will loop through the temporary table and go through each data set to combine all of
  ''' company information into one string (one data row as opposed to many). So company name will be delimetered company_name | company_name
  ''' and so on. This is to assure that all information is passed to the client and does NOT need to be required on the display
  ''' so the database is only touched once.
  ''' Unfortunately this means that the client needs to parse the information which is taken care of in
  ''' listing.aspx.vb Results_Item_Databound event.</remarks>
  Public Function AC_Search(ByVal first_column As String, ByVal data_subset As String, ByVal operator_type As String, ByVal ID_SQL_IN_JETNET As String, ByVal ID_SQL_IN_CLIENT As String, ByVal ac_text As String, ByVal market_status As String, ByVal airport_name As String, ByVal icao_code As String, ByVal iata_code As String, ByVal ac_city As String, ByVal ac_country As String, ByVal ac_state As String, ByVal client_models As String, ByVal jetnet_models As String, ByVal helicopter As Boolean, ByVal business As Boolean, ByVal jets As Boolean, ByVal executive As Boolean, ByVal turboprops As Boolean, ByVal commercial As Boolean, ByVal aerodex As Boolean, ByVal on_exclusive As String, ByVal on_lease As String, ByVal year_start As String, ByVal year_end As String, ByVal search_field As String, ByVal search_where As String, ByVal lifecycle As String, ByVal ownership As String, ByVal CustomField1 As String, ByVal CustomField2 As String, ByVal CustomField3 As String, ByVal CustomField4 As String, ByVal CustomField5 As String, ByVal CustomField6 As String, ByVal CustomField7 As String, ByVal CustomField8 As String, ByVal CustomField9 As String, ByVal CustomField10 As String, ByVal AircraftNotesSearch As Integer, ByVal MergeLists As Boolean) As DataTable
    Dim sQuery As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader : SqlReader = Nothing
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing


    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing


    ' create the Select Strings
    Dim aSQL_String_Client_Select As String = ""
    Dim aSQL_String_JETNET_Select As String = ""
    ' create the Where string
    Dim aSQL_String_Client_Where As String = ""
    Dim aSQL_String_JETNET_Where As String = ""
    ' create a data table to hold the company info
    Dim dalTable As New DataTable
    Dim atemptable As New DataTable
    Dim atemptable2 As New DataTable
    Dim dataSet As DataSet = New DataSet("dataSet")
    Dim search_string As String = ""
    Dim op As String = " like "
    Dim JetnetIDExcluded As String = ""

    Try

      dataSet.Tables.Add(atemptable)
      dataSet.Tables.Add(atemptable2)
      dataSet.Tables.Add(dalTable)
      dataSet.EnforceConstraints = False

      Dim ac_airframe_tot_col As DataColumn = atemptable.Columns.Add("ac_airframe_tot_hrs", Type.GetType("System.Int32"))
      ac_airframe_tot_col.AllowDBNull = True

      atemptable.Columns.Add("ac_id")
      atemptable.Columns.Add("ac_amod_id")
      atemptable.Columns.Add("ac_ser_nbr")
      atemptable.Columns.Add("ac_reg_nbr")
      atemptable.Columns.Add("amod_make_name")
      atemptable.Columns.Add("amod_model_name")
      atemptable.Columns.Add("amod_make_type")
      atemptable.Columns.Add("ac_status")
      atemptable.Columns.Add("ac_year_mfr")
      'atemptable.Columns.Add("act_name")
      atemptable.Columns.Add("ac_forsale_flag")
      atemptable.Columns.Add("ac_exclusive_flag")
      atemptable.Columns.Add("ac_asking_wordage")
      atemptable.Columns.Add("ac_asking_price")
      atemptable.Columns.Add("ac_asking_price_sort")
      atemptable.Columns.Add("ac_lease_flag")
      'atemptable.Columns.Add("comp_id")

      'atemptable.Columns.Add("ac_date_listed")
      Dim acDateListed As DataColumn = atemptable.Columns.Add("ac_date_listed", Type.GetType("System.DateTime"))
      acDateListed.AllowDBNull = True

      atemptable.Columns.Add("ac_product_business_flag")
      atemptable.Columns.Add("ac_product_helicopter_flag")
      atemptable.Columns.Add("ac_product_commercial_flag")
      atemptable.Columns.Add("ac_est_price")
      atemptable.Columns.Add("ac_ser_nbr_sort")
      'atemptable.Columns.Add("contact_id")
      atemptable.Columns.Add("source")
      atemptable.Columns.Add("ac_delivery")
      'atemptable.Columns.Add("acref_owner_percentage")
      atemptable.Columns.Add("jetnet_ac_id")
      atemptable.Columns.Add("lastnote")
      atemptable.Columns.Add("lastevent")

      ''Company Information 
      'atemptable.Columns.Add("comp_name")
      'atemptable.Columns.Add("comp_address1")
      'atemptable.Columns.Add("comp_address2")
      'atemptable.Columns.Add("comp_city")
      'atemptable.Columns.Add("comp_state")
      'atemptable.Columns.Add("comp_country")
      'atemptable.Columns.Add("comp_zip_code")
      'atemptable.Columns.Add("comp_email_address")
      'atemptable.Columns.Add("comp_web_address")

      ' ''Contact Information
      'atemptable.Columns.Add("contact_first_name")
      'atemptable.Columns.Add("contact_last_name")
      'atemptable.Columns.Add("contact_middle_initial")
      'atemptable.Columns.Add("contact_preferred_name")
      'atemptable.Columns.Add("contact_title")
      'atemptable.Columns.Add("contact_email_address")
      'atemptable.Columns.Add("contact_notes")

      'Engine
      atemptable.Columns.Add("acep_engine_1_ttsn_hours")
      atemptable.Columns.Add("acep_engine_2_ttsn_hours")
      atemptable.Columns.Add("acep_engine_3_ttsn_hours")
      atemptable.Columns.Add("acep_engine_4_ttsn_hours")
      atemptable.Columns.Add("acep_engine_1_tsoh_hours")
      atemptable.Columns.Add("acep_engine_2_tsoh_hours")
      atemptable.Columns.Add("acep_engine_3_tsoh_hours")
      atemptable.Columns.Add("acep_engine_4_tsoh_hours")

      atemptable.Columns.Add("ac_engine_1_shi_hrs")
      atemptable.Columns.Add("ac_engine_2_shi_hrs")
      atemptable.Columns.Add("ac_engine_3_shi_hrs")
      atemptable.Columns.Add("ac_engine_4_shi_hrs")

      atemptable.Columns.Add("comp_source")
      atemptable.Columns.Add("value_price")
      atemptable.Columns.Add("ac_upd_date")



      If HttpContext.Current.Session.Item("localUser").crmEvo = True Then
        data_subset = "JC"
      End If

      '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
      '----------------------------------------------------------- check to see if we are getting client data---------------------------------------------------
      '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
      If (data_subset = "C" Or data_subset = "JC" Or data_subset = "B") Then
        '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
        ' ---------------------------------------------------------Setup the Client SQL Strings---------------------------------------------------------------
        '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

        'These are the basic fields needed for the company export. 
        aSQL_String_Client_Select = "SELECT DISTINCT "
        aSQL_String_Client_Select = aSQL_String_Client_Select & "Client_Aircraft.cliaircraft_id AS ac_id, client_aircraft.cliaircraft_value_description as value_price, client_aircraft.cliaircraft_action_date as ac_upd_date, Client_Aircraft_Model.cliamod_id AS ac_amod_id, Client_Aircraft.cliaircraft_ser_nbr AS ac_ser_nbr, "
        aSQL_String_Client_Select = aSQL_String_Client_Select & "Client_Aircraft.cliaircraft_reg_nbr AS ac_reg_nbr, Client_Aircraft.cliaircraft_airframe_total_hours AS ac_airframe_tot_hrs, Client_Aircraft_Model.cliamod_make_name AS amod_make_name, "
        aSQL_String_Client_Select = aSQL_String_Client_Select & "Client_Aircraft_Model.cliamod_model_name AS amod_model_name, client_aircraft.cliaircraft_jetnet_ac_id as jetnet_ac_id,"
        aSQL_String_Client_Select = aSQL_String_Client_Select & "Client_Aircraft.cliaircraft_status AS ac_status, Client_Aircraft.cliaircraft_year_mfr AS ac_year_mfr, "
        aSQL_String_Client_Select = aSQL_String_Client_Select & " Client_Aircraft.cliaircraft_forsale_flag AS ac_forsale_flag, Client_Aircraft.cliaircraft_exclusive_flag AS ac_exclusive_flag, Client_Aircraft.cliaircraft_asking_wordage AS ac_asking_wordage, "
        aSQL_String_Client_Select = aSQL_String_Client_Select & "Client_Aircraft.cliaircraft_asking_price AS ac_asking_price, Client_Aircraft.cliaircraft_lease_flag AS ac_lease_flag,"
        aSQL_String_Client_Select = aSQL_String_Client_Select & "Client_Aircraft.cliaircraft_product_business_flag as ac_product_business_flag,	Client_Aircraft.cliaircraft_product_helicopter_flag as ac_product_helicopter_flag, Client_Aircraft.cliaircraft_product_commercial_flag AS ac_product_commercial_flag, Client_Aircraft_Model.cliamod_make_type as amod_make_type, "
        aSQL_String_Client_Select = aSQL_String_Client_Select & "'CLIENT' AS source, client_aircraft.cliaircraft_est_price as ac_est_price, client_aircraft.cliaircraft_date_listed as ac_date_listed, "
        aSQL_String_Client_Select = aSQL_String_Client_Select & "client_aircraft.cliaircraft_delivery AS ac_delivery,  "
        aSQL_String_Client_Select = aSQL_String_Client_Select & "'JETNET' as lastnote, Client_Aircraft.cliaircraft_ser_nbr_sort as ac_ser_nbr_sort, cliacep_engine_1_ttsn_hours as acep_engine_1_ttsn_hours,cliacep_engine_2_ttsn_hours as acep_engine_2_ttsn_hours,cliacep_engine_3_ttsn_hours as acep_engine_3_ttsn_hours,cliacep_engine_4_ttsn_hours as acep_engine_4_ttsn_hours, "
        aSQL_String_Client_Select = aSQL_String_Client_Select & "cliacep_engine_1_tshi_hours as ac_engine_1_shi_hrs,cliacep_engine_2_tshi_hours as ac_engine_2_shi_hrs,cliacep_engine_3_tshi_hours as ac_engine_3_shi_hrs,cliacep_engine_4_tshi_hours as ac_engine_4_shi_hrs,"

        aSQL_String_Client_Select = aSQL_String_Client_Select & "cliacep_engine_1_tsoh_hours as acep_engine_1_tsoh_hours,cliacep_engine_2_tsoh_hours as acep_engine_2_tsoh_hours,cliacep_engine_3_tsoh_hours as acep_engine_3_tsoh_hours,cliacep_engine_4_tsoh_hours as acep_engine_4_tsoh_hours, "

        aSQL_String_Client_Select = aSQL_String_Client_Select & " ''  as lastevent "
        aSQL_String_Client_Select = aSQL_String_Client_Select & " from client_aircraft"

        aSQL_String_Client_Select = aSQL_String_Client_Select & " inner JOIN client_aircraft_model ON client_aircraft.cliaircraft_cliamod_id = client_aircraft_model.cliamod_id "

        If operator_type <> "" Then
          aSQL_String_Client_Select = aSQL_String_Client_Select & " LEFT OUTER JOIN client_aircraft_reference ON client_aircraft_reference.cliacref_cliac_id = client_aircraft.cliaircraft_id "
        End If

        aSQL_String_Client_Select = aSQL_String_Client_Select & " left outer join client_aircraft_engine on client_aircraft.cliaircraft_id=cliacep_cliac_id "
        'aSQL_String_Client_Select = aSQL_String_Client_Select & " left outer join client_contact on client_aircraft_reference.cliacref_contact_id=clicontact_id "
        'aSQL_String_Client_Select = aSQL_String_Client_Select & " LEFT OUTER JOIN client_company on client_aircraft_reference.cliacref_comp_id = client_company.clicomp_id "
        'aSQL_String_Client_Select = aSQL_String_Client_Select & " LEFT OUTER JOIN client_aircraft_contact_type ON client_aircraft_reference.cliacref_contact_type = client_aircraft_contact_type.cliact_type"

        'The Building of the Where Clause 
        If ID_SQL_IN_CLIENT <> "" Then
          If AircraftNotesSearch = 2 Then 'if it's 2, it's a not in.
            aSQL_String_Client_Where = " cliaircraft_id not in (" & ID_SQL_IN_CLIENT & ")"
          Else 'if it's 1 or 0, just work like normal.
            aSQL_String_Client_Where = " cliaircraft_id in (" & ID_SQL_IN_CLIENT & ")"
          End If
        End If

        '                where(Year() >= year_start) and year <= year_end

        Dim AndQ As String = ""

        'Starting with Custom Field 1
        If CustomField1 <> "" Then
          If CustomField1 = "_" Then
            CustomField1 = "%"
          End If
          data_subset = "C"
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_custom_1 like '" & CustomField1 & "' "
        End If

        'Custom Field 2
        If CustomField2 <> "" Then
          If CustomField2 = "_" Then
            CustomField2 = "%"
          End If
          data_subset = "C"
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_custom_2 like '" & CustomField2 & "' "
        End If

        'Custom Field 3
        If CustomField3 <> "" Then
          If CustomField3 = "_" Then
            CustomField3 = "%"
          End If
          data_subset = "C"
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_custom_3 like '" & CustomField3 & "' "
        End If

        'Custom Field 4
        If CustomField4 <> "" Then
          If CustomField4 = "_" Then
            CustomField4 = "%"
          End If
          data_subset = "C"
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_custom_4 like '" & CustomField4 & "' "
        End If

        'Custom Field 5
        If CustomField5 <> "" Then
          If CustomField5 = "_" Then
            CustomField5 = "%"
          End If
          data_subset = "C"
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_custom_5 like '" & CustomField5 & "' "
        End If

        'Custom Field 6
        If CustomField6 <> "" Then
          If CustomField6 = "_" Then
            CustomField6 = "%"
          End If
          data_subset = "C"
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_custom_6 like '" & CustomField6 & "' "
        End If

        'Custom Field 7
        If CustomField7 <> "" Then
          If CustomField7 = "_" Then
            CustomField7 = "%"
          End If
          data_subset = "C"
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_custom_7 like '" & CustomField7 & "' "
        End If

        'Custom Field 8
        If CustomField8 <> "" Then
          If CustomField8 = "_" Then
            CustomField8 = "%"
          End If
          data_subset = "C"
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_custom_8 like '" & CustomField8 & "' "
        End If

        'Custom Field 9
        If CustomField9 <> "" Then
          If CustomField9 = "_" Then
            CustomField9 = "%"
          End If
          data_subset = "C"
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_custom_9 like '" & CustomField9 & "' "
        End If

        'Custom Field 10
        If CustomField10 <> "" Then
          If CustomField10 = "_" Then
            CustomField10 = "%"
          End If
          data_subset = "C"
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_custom_10 like '" & CustomField9 & "' "
        End If

        If year_start <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_year_mfr >= '" & year_start & "' "
        End If

        If ownership <> "" Then
          If aSQL_String_Client_Where <> "" Then
            aSQL_String_Client_Where += " and "
          End If
          aSQL_String_Client_Where += " cliaircraft_ownership in ('" & ownership & "') "
        End If

        If year_end <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_year_mfr <= '" & year_end & "' "
        End If

        If lifecycle <> "" Then
          If aSQL_String_Client_Where <> "" Then
            aSQL_String_Client_Where += " and "
          End If

          If lifecycle = "4" Then
            aSQL_String_Client_Where += " (cliaircraft_lifecycle = '4' AND lower(cliaircraft_status) <> 'withdrawn from use - stored') "
          ElseIf lifecycle = "5" Then
            aSQL_String_Client_Where += " (cliaircraft_lifecycle = '4' AND lower(cliaircraft_status) = 'withdrawn from use - stored') "
          Else
            aSQL_String_Client_Where += " (cliaircraft_lifecycle = '" & lifecycle & "') "
          End If
        End If

        If on_exclusive <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_exclusive_flag = '" & on_exclusive & "' "
        End If

        If on_lease <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_lease_flag like '" & on_lease & "' "
        End If

        If airport_name <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_aport_name like '%" & airport_name & "%' "
        End If

        If operator_type <> "" Then
          If aSQL_String_Client_Where <> "" Then
            aSQL_String_Client_Where += " and "
          End If

          If operator_type = "all" Then 'all owners
            aSQL_String_Client_Where += " cliacref_contact_type in ('00','08','97','17','99','56')"
          ElseIf operator_type = "whole" Then 'whole owners
            aSQL_String_Client_Where += " cliacref_contact_type in ('56','99', '00')"
          ElseIf operator_type = "fractional" Then 'fractional owners
            aSQL_String_Client_Where += " cliacref_contact_type in ('97','17')"
          ElseIf operator_type = "shared" Then 'shared owners
            aSQL_String_Client_Where += " cliacref_contact_type in ('08')"
          ElseIf operator_type = "operators" Then 'operators
            aSQL_String_Client_Where += " cliacref_operator_flag in ('Y','O') "
          End If
        End If

        If icao_code <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_aport_icao_code like '%" & icao_code & "%' "
        End If

        If iata_code <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_aport_iata_code like '%" & iata_code & "%' "
        End If

        If ac_city <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_aport_city like '%" & ac_city & "%' "
        End If

        If ac_country <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_aport_country in (" & ac_country & ") "
        End If

        If ac_state <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_aport_state IN(" & ac_state & ") "
        End If


        If client_models <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliamod_id in (" & client_models & ") "
        End If

        If ac_text <> "%" And ac_text <> "%%" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If

          search_string = ""
          op = " LIKE "

          If search_where = "3" Then
            op = " = "
          End If

          If search_field = "1" Then 'serial/reg
            search_string = " cliaircraft_ser_nbr " & op & " '" & ac_text & "' or cliaircraft_reg_nbr " & op & " '" & ac_text & "' "
          ElseIf search_field = 2 Then 'ser
            search_string = " cliaircraft_ser_nbr  " & op & " '" & ac_text & "'"
          ElseIf search_field = 3 Then 'reg
            search_string = " cliaircraft_reg_nbr  " & op & " '" & ac_text & "' "
          ElseIf search_field = 4 Then 'ac id
            search_string = " cliaircraft_id " & op & " '" & ac_text & "' "
          ElseIf search_field = 5 Then
            search_string = " cliaircraft_ser_nbr " & op & " '" & ac_text & "' or cliaircraft_reg_nbr " & op & " '" & ac_text & "' or cliamod_make_name " & op & " '" & ac_text & "' or cliamod_model_name " & op & " '" & ac_text & "'"
          End If



          'If search_where = "3" Then ' equals = 
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & "(" & search_string & ")"

          'Else
          '    aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & "(cliaircraft_ser_nbr like '" & ac_text & "' or cliaircraft_reg_nbr like '" & ac_text & "' or cliamod_make_name = '" & ac_text & "' or cliamod_make_type = '" & ac_text & "')"

          'End If
        End If

        If aSQL_String_Client_Where <> "" Then
          AndQ = " and "
        Else
          AndQ = ""
        End If

        Select Case market_status
          Case "For Sale"
            aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_forsale_flag = 'Y'"
          Case "Not For Sale"
            aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_forsale_flag = 'N'"
          Case "For Sale Exclusive"
            aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_exclusive_flag = 'Y'"
          Case "Lease"
            aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_lease_flag = 'Y'"
          Case ""
          Case Else
            aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_status = '" & market_status & "'"
        End Select


        MySqlConn.ConnectionString = Me.client_DB
        MySqlConn.Open()
        MySqlCommand.Connection = MySqlConn
        MySqlCommand.CommandType = CommandType.Text
        MySqlCommand.CommandTimeout = 60

        MySqlCommand.CommandText = aSQL_String_Client_Select & " WHERE " & aSQL_String_Client_Where


        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>AC_Search(ByVal first_column As String, ByVal data_subset As String, ByVal operator_type As String, ByVal ID_SQL_IN_JETNET As String, ByVal ID_SQL_IN_CLIENT As String, ByVal ac_text As String, ByVal market_status As String, ByVal airport_name As String, ByVal icao_code As String, ByVal iata_code As String, ByVal ac_city As String, ByVal ac_country As String, ByVal ac_state As String, ByVal client_models As String, ByVal jetnet_models As String, ByVal helicopter As Boolean, ByVal business As Boolean, ByVal jets As Boolean, ByVal executive As Boolean, ByVal turboprops As Boolean, ByVal commercial As Boolean, ByVal aerodex As Boolean, ByVal on_exclusive As String, ByVal on_lease As String, ByVal year_start As String, ByVal year_end As String) As DataTable <em>Client Side!</em></b><br />" & aSQL_String_Client_Select & " WHERE " & aSQL_String_Client_Where

        MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


        While MySqlReader.Read()
          Dim newCustomersRow As DataRow = atemptable.NewRow()
          newCustomersRow("ac_id") = MySqlReader.Item("ac_id")
          newCustomersRow("ac_amod_id") = MySqlReader.Item("ac_amod_id")
          newCustomersRow("ac_ser_nbr") = MySqlReader.Item("ac_ser_nbr")
          newCustomersRow("ac_reg_nbr") = MySqlReader.Item("ac_reg_nbr")
          newCustomersRow("ac_airframe_tot_hrs") = MySqlReader.Item("ac_airframe_tot_hrs")
          newCustomersRow("amod_make_name") = MySqlReader.Item("amod_make_name")
          newCustomersRow("amod_model_name") = MySqlReader.Item("amod_model_name")
          newCustomersRow("amod_make_type") = MySqlReader.Item("amod_make_type")
          newCustomersRow("ac_status") = MySqlReader.Item("ac_status")
          newCustomersRow("ac_year_mfr") = MySqlReader.Item("ac_year_mfr")
          'newCustomersRow("act_name") = MySqlReader.Item("act_name")
          newCustomersRow("ac_forsale_flag") = MySqlReader.Item("ac_forsale_flag")
          newCustomersRow("ac_exclusive_flag") = MySqlReader.Item("ac_exclusive_flag")
          newCustomersRow("ac_asking_wordage") = MySqlReader.Item("ac_asking_wordage")
          newCustomersRow("ac_asking_price") = MySqlReader.Item("ac_asking_price")
          newCustomersRow("ac_lease_flag") = MySqlReader.Item("ac_lease_flag")
          'newCustomersRow("comp_id") = MySqlReader.Item("comp_id")
          newCustomersRow("ac_date_listed") = MySqlReader.Item("ac_date_listed")
          newCustomersRow("ac_product_business_flag") = MySqlReader.Item("ac_product_business_flag")
          newCustomersRow("ac_product_helicopter_flag") = MySqlReader.Item("ac_product_helicopter_flag")
          newCustomersRow("ac_product_commercial_flag") = MySqlReader.Item("ac_product_commercial_flag")
          newCustomersRow("ac_est_price") = MySqlReader.Item("ac_est_price")
          newCustomersRow("value_price") = MySqlReader.Item("value_price")
          newCustomersRow("ac_asking_price_sort") = MySqlReader.Item("ac_asking_price")
          Dim RecreateSer As Boolean = False

          If IsDBNull(MySqlReader.Item("ac_ser_nbr_sort")) Then
            RecreateSer = True
          ElseIf String.IsNullOrEmpty(MySqlReader.Item("ac_ser_nbr_sort")) Then
            RecreateSer = True
          End If

          If RecreateSer = True Then
            If Not IsDBNull(newCustomersRow("ac_ser_nbr")) Then
              '0000000000000010000000
              Dim SerSort As String = newCustomersRow("ac_ser_nbr")
              SerSort = SerSort.PadRight(SerSort.Length + 7, "0")
              SerSort = SerSort.PadLeft(22, "0")
              newCustomersRow("ac_ser_nbr_sort") = SerSort
            Else
              Dim EmptyVar As String = "0"
              newCustomersRow("ac_ser_nbr_sort") = EmptyVar.PadRight(22, "0")
            End If
          Else
            newCustomersRow("ac_ser_nbr_sort") = MySqlReader.Item("ac_ser_nbr_sort")
          End If

          'newCustomersRow("acref_owner_percentage") = MySqlReader.Item("acref_owner_percentage")
          'newCustomersRow("contact_id") = MySqlReader.Item("contact_id")
          newCustomersRow("source") = MySqlReader.Item("source")
          newCustomersRow("ac_delivery") = MySqlReader.Item("ac_delivery")
          newCustomersRow("jetnet_ac_id") = MySqlReader.Item("jetnet_ac_id")

          'Added 1/14/16 an option to exclude the matching jetnet searching IDS from the list.
          If MergeLists = True Then
            'Only care about saving this here:
            If JetnetIDExcluded <> "" Then
              JetnetIDExcluded += ","
            End If
            JetnetIDExcluded += MySqlReader.Item("jetnet_ac_id").ToString
          End If

          newCustomersRow("lastnote") = MySqlReader.Item("lastnote")
          'newCustomersRow("comp_name") = MySqlReader.Item("comp_name")
          'newCustomersRow("comp_address1") = MySqlReader.Item("comp_address1")
          'newCustomersRow("comp_address2") = MySqlReader.Item("comp_address2")
          'newCustomersRow("comp_city") = MySqlReader.Item("comp_city")
          'newCustomersRow("comp_state") = MySqlReader.Item("comp_state")
          'newCustomersRow("comp_country") = MySqlReader.Item("comp_country")
          'newCustomersRow("comp_zip_code") = MySqlReader.Item("comp_zip_code")
          'newCustomersRow("comp_email_address") = MySqlReader.Item("comp_email_address")
          'newCustomersRow("comp_web_address") = MySqlReader.Item("comp_web_address")
          'newCustomersRow("comp_source") = "CLIENT"
          'newCustomersRow("contact_first_name") = MySqlReader.Item("contact_first_name")
          'newCustomersRow("contact_last_name") = MySqlReader.Item("contact_last_name")
          'newCustomersRow("contact_middle_initial") = MySqlReader.Item("contact_middle_initial")
          'newCustomersRow("contact_preferred_name") = MySqlReader.Item("contact_preferred_name")
          'newCustomersRow("contact_title") = MySqlReader.Item("contact_title")
          'newCustomersRow("contact_email_address") = MySqlReader.Item("contact_email_address")
          'newCustomersRow("contact_notes") = MySqlReader.Item("contact_notes")


          newCustomersRow("acep_engine_1_ttsn_hours") = MySqlReader.Item("acep_engine_1_ttsn_hours")
          newCustomersRow("acep_engine_2_ttsn_hours") = MySqlReader.Item("acep_engine_2_ttsn_hours")
          newCustomersRow("acep_engine_3_ttsn_hours") = MySqlReader.Item("acep_engine_3_ttsn_hours")
          newCustomersRow("acep_engine_4_ttsn_hours") = MySqlReader.Item("acep_engine_4_ttsn_hours")

          newCustomersRow("acep_engine_1_tsoh_hours") = MySqlReader.Item("acep_engine_1_tsoh_hours")
          newCustomersRow("acep_engine_2_tsoh_hours") = MySqlReader.Item("acep_engine_2_tsoh_hours")
          newCustomersRow("acep_engine_3_tsoh_hours") = MySqlReader.Item("acep_engine_3_tsoh_hours")
          newCustomersRow("acep_engine_4_tsoh_hours") = MySqlReader.Item("acep_engine_4_tsoh_hours")

          newCustomersRow("ac_engine_1_shi_hrs") = MySqlReader.Item("ac_engine_1_shi_hrs")
          newCustomersRow("ac_engine_2_shi_hrs") = MySqlReader.Item("ac_engine_2_shi_hrs")
          newCustomersRow("ac_engine_3_shi_hrs") = MySqlReader.Item("ac_engine_3_shi_hrs")
          newCustomersRow("ac_engine_4_shi_hrs") = MySqlReader.Item("ac_engine_4_shi_hrs")


          newCustomersRow("ac_upd_date") = MySqlReader.Item("ac_upd_date")

          newCustomersRow("lastevent") = "CLIENT"

          atemptable.Rows.Add(newCustomersRow)
          atemptable.AcceptChanges()
        End While

      End If ' If (data_subset = "C" Or data_subset = "JC") Then

      '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
      '------------------------------------------------------------------ check to see if we are getting JETNET data---------------------------------------------
      '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
      If (data_subset = "J" Or data_subset = "JC" Or data_subset = "B") Then
        '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
        '--------------------------------------------------------------------- Setup the JETNET SQL Strings-----------------------------------------------------
        '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''


        'The basic company fields
        aSQL_String_JETNET_Select = "SELECT DISTINCT "
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & "ac_id, amod_id as ac_amod_id, ac_upd_date,  ac_airframe_tot_hrs, ac_ser_no_full as ac_ser_nbr, ac_reg_no as ac_reg_nbr, amod_make_name, "
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & "amod_model_name, ac_status, ac_id as jetnet_ac_id, "
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & "ac_mfr_year as ac_year_mfr, '0' as ac_est_price, ac_list_date as ac_date_listed, 'JETNET' as lastnote, "
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & "ac_forsale_flag, ac_exclusive_flag, ac_asking as ac_asking_wordage, ac_asking_price, "
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & "ac_lease_flag, 'JETNET' AS source, ac_delivery, "
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & "ac_product_business_flag,	ac_product_helicopter_flag, ac_product_commercial_flag, amod_type_code as amod_make_type, "
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " ac_ser_no_sort as ac_ser_nbr_sort, ac_engine_1_shi_hrs, ac_engine_2_shi_hrs, ac_engine_3_shi_hrs, ac_engine_4_shi_hrs, "

        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & "ac_engine_1_tot_hrs as acep_engine_1_ttsn_hours, ac_engine_2_tot_hrs as acep_engine_2_ttsn_hours,ac_engine_3_tot_hrs as acep_engine_3_ttsn_hours, ac_engine_4_tot_hrs as acep_engine_4_ttsn_hours, "
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & "ac_engine_1_soh_hrs as acep_engine_1_tsoh_hours,ac_engine_2_soh_hrs as acep_engine_2_tsoh_hours,ac_engine_3_soh_hrs as acep_engine_3_tsoh_hours, ac_engine_4_soh_hrs as acep_engine_4_tsoh_hours, "
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " ac_last_event as lastevent "
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " FROM View_Aircraft_Company_Flat WITH (NOLOCK) "




        '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
        '-----------------------------------------------------------------The Building of the Where Clause----------------------------------------------------
        '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''



        ''The basic company fields
        'aSQL_String_JETNET_Select = "SELECT DISTINCT "
        'aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & "Aircraft.ac_id, Aircraft.ac_amod_id, aircraft.ac_upd_date,  Aircraft.ac_airframe_tot_hrs, Aircraft.ac_ser_no_full as ac_ser_nbr, Aircraft.ac_reg_no as ac_reg_nbr, Aircraft_Model.amod_make_name, "
        'aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & "Aircraft_Model.amod_model_name, Aircraft.ac_status, aircraft.ac_id as jetnet_ac_id, "
        'aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & "Aircraft.ac_mfr_year as ac_year_mfr, '0' as ac_est_price, aircraft.ac_list_date as ac_date_listed, 'JETNET' as lastnote, "
        'aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & "Aircraft.ac_forsale_flag, Aircraft.ac_exclusive_flag, Aircraft.ac_asking as ac_asking_wordage, Aircraft.ac_asking_price, "
        'aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & "Aircraft.ac_lease_flag, 'JETNET' AS source, aircraft.ac_delivery, "
        'aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & "Aircraft.ac_product_business_flag,	Aircraft.ac_product_helicopter_flag, Aircraft.ac_product_commercial_flag, Aircraft_Model.amod_type_code as amod_make_type, "
        'aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " ac_ser_no_sort as ac_ser_nbr_sort, "

        'aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & "ac_engine_1_tot_hrs as acep_engine_1_ttsn_hours, ac_engine_2_tot_hrs as acep_engine_2_ttsn_hours,ac_engine_3_tot_hrs as acep_engine_3_ttsn_hours, ac_engine_4_tot_hrs as acep_engine_4_ttsn_hours, "
        'aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & "ac_engine_1_soh_hrs as acep_engine_1_tsoh_hours,ac_engine_2_soh_hrs as acep_engine_2_tsoh_hours,ac_engine_3_soh_hrs as acep_engine_3_tsoh_hours, ac_engine_4_soh_hrs as acep_engine_4_tsoh_hours, "
        'aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " '' as lastevent FROM Aircraft WITH (NOLOCK) "

        'aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " inner JOIN aircraft_model WITH (NOLOCK) ON aircraft.ac_amod_id = aircraft_model.amod_id "

        'If operator_type <> "" Then
        '  aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " inner join Aircraft_Reference WITH (NOLOCK) ON aircraft.ac_id = cref_ac_id and ac_journ_id = cref_journ_id "
        'End If

        ''aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " LEFT OUTER JOIN aircraft_reference WITH (NOLOCK) ON aircraft_reference.cref_ac_id = aircraft.ac_id and aircraft_reference.cref_journ_id = ac_journ_id"

        ''aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " left outer join contact WITH (NOLOCK) on aircraft_reference.cref_contact_id=contact_id and contact_journ_id = cref_journ_id and contact_hide_flag='N' "

        ''aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " inner JOIN company WITH (NOLOCK) ON company.comp_id = aircraft_reference.cref_comp_id and comp_journ_id = cref_journ_id "
        ''aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " inner JOIN aircraft_contact_type WITH (NOLOCK) ON aircraft_reference.cref_contact_type = aircraft_contact_type.actype_code "

        ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
        ''-----------------------------------------------------------------The Building of the Where Clause----------------------------------------------------
        ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
        ''journ id=0!!!!!!!!!!!!






        Dim AndQ As String = ""

        aSQL_String_JETNET_Where = " ac_journ_id = 0 "

        If ID_SQL_IN_JETNET <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          If AircraftNotesSearch = 2 Then 'if without notes, use not in.
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_id not in (" & ID_SQL_IN_JETNET & ")"
          Else 'If with notes, or with and without notes (folder search) perform normally.
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_id in (" & ID_SQL_IN_JETNET & ")"
          End If
        End If

        If MergeLists = True Then 'If you want to exclude matching jetnet rows
          If JetnetIDExcluded <> "" Then
            If aSQL_String_JETNET_Where <> "" Then
              AndQ = " and "
            Else
              AndQ = ""
            End If
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_id not in (" & JetnetIDExcluded & ")"
          End If
        End If

        If ownership <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            aSQL_String_JETNET_Where += " and "
          End If
          aSQL_String_JETNET_Where += " ac_ownership_type in ('" & ownership & "') "
        End If

        If operator_type <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            aSQL_String_JETNET_Where += " and "
          End If

          If operator_type = "all" Then 'all owners
            aSQL_String_JETNET_Where += " cref_contact_type in ('00','08','97','17','99','56')"
          ElseIf operator_type = "whole" Then 'whole owners
            aSQL_String_JETNET_Where += " cref_contact_type in ('56','99', '00')"
          ElseIf operator_type = "fractional" Then 'fractional owners
            aSQL_String_JETNET_Where += " cref_contact_type in ('97','17')"
          ElseIf operator_type = "shared" Then 'shared owners
            aSQL_String_JETNET_Where += " cref_contact_type in ('08')"
          ElseIf operator_type = "operators" Then 'operators
            aSQL_String_JETNET_Where += " cref_operator_flag in ('Y','O') "
          End If
        End If


        If year_start <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_mfr_year >= '" & year_start & "' "
        End If

        If year_end <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_mfr_year <= '" & year_end & "' "
        End If

        If airport_name <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_aport_name like '%" & airport_name & "%' "
        End If

        If on_exclusive <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_exclusive_flag = '" & on_exclusive & "' "
        End If

        If on_lease <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_lease_flag = '" & on_lease & "' "
        End If

        If icao_code <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_aport_icao_code like '%" & icao_code & "%' "
        End If

        If iata_code <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_aport_iata_code like '%" & iata_code & "%' "
        End If

        If ac_city <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_aport_city like '%" & ac_city & "%' "
        End If

        If ac_country <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_aport_country in (" & ac_country & ") "
        End If

        If ac_state <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_aport_state IN(" & ac_state & ") "
        End If


        If lifecycle <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If

          If lifecycle = "4" Then
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " (ac_lifecycle_stage = '4' AND lower(ac_status) <> 'withdrawn from use - stored') "
          ElseIf lifecycle = "5" Then
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " (ac_lifecycle_stage = '4' AND lower(ac_status) = 'withdrawn from use - stored') "
          Else
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " (ac_lifecycle_stage = '" & lifecycle & "') "
          End If
        End If

        If jetnet_models <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " amod_id in (" & jetnet_models & ") "
        End If

        If ac_text <> "%" And ac_text <> "%%" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If

          search_string = ""
          op = " LIKE "

          If search_where = "3" Then
            op = " = "
          End If

          If search_field = "1" Then 'serial/reg
            search_string = " ac_ser_no_full " & op & " '" & ac_text & "' or ac_reg_no " & op & " '" & ac_text & "' "
          ElseIf search_field = 2 Then 'ser
            search_string = " ac_ser_no_full " & op & " '" & ac_text & "'"
          ElseIf search_field = 3 Then 'reg
            search_string = " ac_reg_no " & op & " '" & ac_text & "' "
          ElseIf search_field = 4 Then 'ac id
            search_string = " ac_id " & op & " '" & ac_text & "' "
          ElseIf search_field = 5 Then
            search_string = " ac_ser_no_full " & op & " '" & ac_text & "' or ac_reg_no " & op & " '" & ac_text & "' or amod_make_name " & op & " '" & ac_text & "' or amod_model_name " & op & " '" & ac_text & "'"
          End If

          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & "(" & search_string & ")"

        End If


        If aSQL_String_JETNET_Where <> "" Then
          AndQ = " and "
        Else
          AndQ = ""
        End If
        Select Case market_status
          Case "For Sale"
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_forsale_flag = 'Y'"
          Case "Not For Sale"
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_forsale_flag = 'N'"
          Case "For Sale Exclusive"
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_exclusive_flag = 'Y'"
          Case "Lease"
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_lease_flag = 'Y'"
          Case ""
          Case Else
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_status = '" & market_status & "'"
        End Select


        aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " " & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(HttpContext.Current.Session.Item("localSubscription"), False, True)

        SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
        SqlConn.Open()
        SqlCommand.Connection = SqlConn
        SqlCommand.CommandType = CommandType.Text
        SqlCommand.CommandTimeout = 180

        sQuery = aSQL_String_JETNET_Select & " WHERE " & aSQL_String_JETNET_Where

        SqlCommand.CommandText = sQuery

        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>AC_Search(ByVal first_column As String, ByVal data_subset As String, ByVal operator_type As String, ByVal ID_SQL_IN_JETNET As String, ByVal ID_SQL_IN_CLIENT As String, ByVal ac_text As String, ByVal market_status As String, ByVal airport_name As String, ByVal icao_code As String, ByVal iata_code As String, ByVal ac_city As String, ByVal ac_country As String, ByVal ac_state As String, ByVal client_models As String, ByVal jetnet_models As String, ByVal helicopter As Boolean, ByVal business As Boolean, ByVal jets As Boolean, ByVal executive As Boolean, ByVal turboprops As Boolean, ByVal commercial As Boolean, ByVal aerodex As Boolean, ByVal on_exclusive As String, ByVal on_lease As String, ByVal year_start As String, ByVal year_end As String) As DataTable <em>JETNET Side!</em></b><br />" & sQuery

        SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)



        dataSet.EnforceConstraints = False
        atemptable.PrimaryKey = Nothing
        atemptable.Constraints.Clear()

        'SqlReader = Nothing
        While SqlReader.Read()
          Dim newCustomersRow As DataRow = atemptable.NewRow()
          newCustomersRow("ac_id") = SqlReader.Item("ac_id")
          newCustomersRow("ac_amod_id") = SqlReader.Item("ac_amod_id")
          newCustomersRow("ac_ser_nbr") = SqlReader.Item("ac_ser_nbr")
          newCustomersRow("ac_reg_nbr") = SqlReader.Item("ac_reg_nbr")
          newCustomersRow("ac_airframe_tot_hrs") = SqlReader.Item("ac_airframe_tot_hrs")
          newCustomersRow("amod_make_name") = SqlReader.Item("amod_make_name")
          newCustomersRow("amod_model_name") = SqlReader.Item("amod_model_name")
          newCustomersRow("amod_make_type") = SqlReader.Item("amod_make_type")
          newCustomersRow("ac_status") = SqlReader.Item("ac_status")
          newCustomersRow("ac_year_mfr") = SqlReader.Item("ac_year_mfr")
          ' newCustomersRow("act_name") = SqlReader.Item("act_name")
          newCustomersRow("ac_forsale_flag") = SqlReader.Item("ac_forsale_flag")
          newCustomersRow("ac_exclusive_flag") = SqlReader.Item("ac_exclusive_flag")
          newCustomersRow("ac_asking_wordage") = SqlReader.Item("ac_asking_wordage")
          newCustomersRow("ac_asking_price") = SqlReader.Item("ac_asking_price")
          newCustomersRow("ac_asking_price_sort") = SqlReader.Item("ac_asking_price")
          newCustomersRow("ac_lease_flag") = SqlReader.Item("ac_lease_flag")
          '  newCustomersRow("comp_id") = SqlReader.Item("comp_id")
          newCustomersRow("ac_date_listed") = SqlReader.Item("ac_date_listed")
          newCustomersRow("ac_product_business_flag") = SqlReader.Item("ac_product_business_flag")
          newCustomersRow("ac_product_helicopter_flag") = SqlReader.Item("ac_product_helicopter_flag")
          newCustomersRow("ac_product_commercial_flag") = SqlReader.Item("ac_product_commercial_flag")
          newCustomersRow("ac_est_price") = SqlReader.Item("ac_est_price")
          'newCustomersRow("acref_owner_percentage") = SqlReader.Item("acref_owner_percentage")
          'newCustomersRow("contact_id") = SqlReader.Item("contact_id")
          newCustomersRow("source") = SqlReader.Item("source")
          newCustomersRow("ac_delivery") = SqlReader.Item("ac_delivery")
          newCustomersRow("jetnet_ac_id") = SqlReader.Item("jetnet_ac_id")
          newCustomersRow("lastnote") = SqlReader.Item("lastnote")
          newCustomersRow("lastevent") = SqlReader.Item("lastevent")
          'newCustomersRow("comp_source") = "JETNET"
          'newCustomersRow("comp_name") = SqlReader.Item("comp_name")
          'newCustomersRow("comp_address1") = SqlReader.Item("comp_address1")
          'newCustomersRow("comp_address2") = SqlReader.Item("comp_address2")
          'newCustomersRow("comp_city") = SqlReader.Item("comp_city")
          'newCustomersRow("comp_state") = SqlReader.Item("comp_state")
          'newCustomersRow("comp_country") = SqlReader.Item("comp_country")
          'newCustomersRow("comp_zip_code") = SqlReader.Item("comp_zip_code")
          'newCustomersRow("comp_email_address") = SqlReader.Item("comp_email_address")
          'newCustomersRow("comp_web_address") = SqlReader.Item("comp_web_address")
          newCustomersRow("ac_ser_nbr_sort") = SqlReader.Item("ac_ser_nbr_sort")
          'newCustomersRow("contact_first_name") = SqlReader.Item("contact_first_name")
          'newCustomersRow("contact_last_name") = SqlReader.Item("contact_last_name")
          'newCustomersRow("contact_middle_initial") = SqlReader.Item("contact_middle_initial")
          'newCustomersRow("contact_preferred_name") = SqlReader.Item("contact_preferred_name")
          'newCustomersRow("contact_title") = SqlReader.Item("contact_title")
          'newCustomersRow("contact_email_address") = SqlReader.Item("contact_email_address")
          'newCustomersRow("contact_notes") = SqlReader.Item("contact_notes")

          newCustomersRow("acep_engine_1_tsoh_hours") = SqlReader.Item("acep_engine_1_tsoh_hours")
          newCustomersRow("acep_engine_2_tsoh_hours") = SqlReader.Item("acep_engine_2_tsoh_hours")
          newCustomersRow("acep_engine_3_tsoh_hours") = SqlReader.Item("acep_engine_3_tsoh_hours")
          newCustomersRow("acep_engine_4_tsoh_hours") = SqlReader.Item("acep_engine_4_tsoh_hours")

          newCustomersRow("acep_engine_1_ttsn_hours") = SqlReader.Item("acep_engine_1_ttsn_hours")
          newCustomersRow("acep_engine_2_ttsn_hours") = SqlReader.Item("acep_engine_2_ttsn_hours")
          newCustomersRow("acep_engine_3_ttsn_hours") = SqlReader.Item("acep_engine_3_ttsn_hours")
          newCustomersRow("acep_engine_4_ttsn_hours") = SqlReader.Item("acep_engine_4_ttsn_hours")

          newCustomersRow("ac_engine_1_shi_hrs") = SqlReader.Item("ac_engine_1_shi_hrs")
          newCustomersRow("ac_engine_2_shi_hrs") = SqlReader.Item("ac_engine_2_shi_hrs")
          newCustomersRow("ac_engine_3_shi_hrs") = SqlReader.Item("ac_engine_3_shi_hrs")
          newCustomersRow("ac_engine_4_shi_hrs") = SqlReader.Item("ac_engine_4_shi_hrs")

          newCustomersRow("ac_upd_date") = SqlReader.Item("ac_upd_date")
          newCustomersRow("value_price") = ""
          atemptable.Rows.Add(newCustomersRow)
          atemptable.AcceptChanges()
        End While

      End If ' If (data_subset = "J" Or data_subset = "JC") Then

      ''''''''''''''''''''''''''''''''combining
      dalTable = atemptable.Clone
      dataSet.EnforceConstraints = False
      dalTable.PrimaryKey = Nothing
      dalTable.Constraints.Clear()

      Dim afiltered_Client As DataRow() = atemptable.Select("", first_column & ", jetnet_ac_id asc, comp_source desc")
      ' extract and import
      For Each atmpDataRow_Client In afiltered_Client
        dalTable.ImportRow(atmpDataRow_Client)
      Next
      AC_Search = dalTable

      Dim adatatable4 As New DataTable
      Dim old_ac_id As Long = 0
      Dim comp_name As String = ""

      adatatable4.Columns.Add("ac_id")
      adatatable4.Columns.Add("other_ac_id")
      adatatable4.Columns.Add("ac_amod_id")
      adatatable4.Columns.Add("ac_ser_nbr")
      adatatable4.Columns.Add("other_ac_ser_nbr")
      adatatable4.Columns.Add("ac_reg_nbr")
      adatatable4.Columns.Add("other_ac_reg_nbr")
      Dim ac_airframe_tot_hrs As DataColumn = adatatable4.Columns.Add("ac_airframe_tot_hrs", Type.GetType("System.Int32"))
      ac_airframe_tot_hrs.AllowDBNull = True
      Dim other_ac_airframe_tot_hrs As DataColumn = adatatable4.Columns.Add("other_ac_airframe_tot_hrs", Type.GetType("System.Int32"))
      other_ac_airframe_tot_hrs.AllowDBNull = True


      adatatable4.Columns.Add("amod_make_name")
      adatatable4.Columns.Add("amod_model_name")
      adatatable4.Columns.Add("amod_make_type")
      adatatable4.Columns.Add("ac_status")
      adatatable4.Columns.Add("other_ac_status")
      adatatable4.Columns.Add("ac_year_mfr")
      adatatable4.Columns.Add("other_ac_year_mfr")
      adatatable4.Columns.Add("act_name")
      adatatable4.Columns.Add("ac_forsale_flag")
      adatatable4.Columns.Add("other_ac_forsale_flag")
      adatatable4.Columns.Add("ac_exclusive_flag")
      adatatable4.Columns.Add("other_ac_exclusive_flag")
      adatatable4.Columns.Add("ac_asking_wordage")
      adatatable4.Columns.Add("other_ac_asking_wordage")
      adatatable4.Columns.Add("ac_asking_price")
      adatatable4.Columns.Add("other_ac_asking_price")
      adatatable4.Columns.Add("ac_lease_flag")
      adatatable4.Columns.Add("other_ac_lease_flag")
      adatatable4.Columns.Add("comp_id")

      'adatatable4.Columns.Add("ac_date_listed")
      'adatatable4.Columns.Add("other_ac_date_listed")
      Dim ac_date_listed As DataColumn = adatatable4.Columns.Add("ac_date_listed", Type.GetType("System.DateTime"))
      ac_date_listed.AllowDBNull = True
      Dim other_ac_date_listed As DataColumn = adatatable4.Columns.Add("other_ac_date_listed", Type.GetType("System.DateTime"))
      other_ac_date_listed.AllowDBNull = True


      adatatable4.Columns.Add("ac_product_business_flag")
      adatatable4.Columns.Add("ac_product_helicopter_flag")
      adatatable4.Columns.Add("ac_product_commercial_flag")
      adatatable4.Columns.Add("ac_est_price")
      adatatable4.Columns.Add("contact_id")
      adatatable4.Columns.Add("source")
      adatatable4.Columns.Add("other_source")
      adatatable4.Columns.Add("ac_delivery")
      adatatable4.Columns.Add("acref_owner_percentage")
      adatatable4.Columns.Add("lastnote")
      adatatable4.Columns.Add("lastevent")
      adatatable4.Columns.Add("jetnet_ac_id")
      adatatable4.Columns.Add("ac_ser_nbr_sort")

      adatatable4.Columns.Add("comp_name")
      adatatable4.Columns.Add("comp_address1")
      adatatable4.Columns.Add("comp_address2")
      adatatable4.Columns.Add("comp_city")
      adatatable4.Columns.Add("comp_state")
      adatatable4.Columns.Add("comp_country")
      adatatable4.Columns.Add("comp_zip_code")
      adatatable4.Columns.Add("comp_email_address")
      adatatable4.Columns.Add("comp_web_address")

      adatatable4.Columns.Add("contact_first_name")
      adatatable4.Columns.Add("contact_last_name")
      adatatable4.Columns.Add("contact_middle_initial")
      adatatable4.Columns.Add("contact_preferred_name")
      adatatable4.Columns.Add("contact_title")
      adatatable4.Columns.Add("contact_email_address")
      adatatable4.Columns.Add("contact_notes")

      adatatable4.Columns.Add("acep_engine_1_ttsn_hours")
      adatatable4.Columns.Add("other_acep_engine_1_ttsn_hours")
      adatatable4.Columns.Add("acep_engine_2_ttsn_hours")
      adatatable4.Columns.Add("other_acep_engine_2_ttsn_hours")
      adatatable4.Columns.Add("acep_engine_3_ttsn_hours")
      adatatable4.Columns.Add("other_acep_engine_3_ttsn_hours")
      adatatable4.Columns.Add("acep_engine_4_ttsn_hours")
      adatatable4.Columns.Add("other_acep_engine_4_ttsn_hours")
      adatatable4.Columns.Add("acep_engine_1_tsoh_hours")
      adatatable4.Columns.Add("other_acep_engine_1_tsoh_hours")
      adatatable4.Columns.Add("acep_engine_2_tsoh_hours")
      adatatable4.Columns.Add("other_acep_engine_2_tsoh_hours")
      adatatable4.Columns.Add("acep_engine_3_tsoh_hours")
      adatatable4.Columns.Add("other_acep_engine_3_tsoh_hours")
      adatatable4.Columns.Add("acep_engine_4_tsoh_hours")
      adatatable4.Columns.Add("other_acep_engine_4_tsoh_hours")

      adatatable4.Columns.Add("ac_engine_1_shi_hrs")
      adatatable4.Columns.Add("ac_engine_2_shi_hrs")
      adatatable4.Columns.Add("ac_engine_3_shi_hrs")
      adatatable4.Columns.Add("ac_engine_4_shi_hrs")
      adatatable4.Columns.Add("other_ac_engine_1_shi_hrs")
      adatatable4.Columns.Add("other_ac_engine_2_shi_hrs")
      adatatable4.Columns.Add("other_ac_engine_3_shi_hrs")
      adatatable4.Columns.Add("other_ac_engine_4_shi_hrs")

      adatatable4.Columns.Add("comp_source")
      adatatable4.Columns.Add("value_price")
      adatatable4.Columns.Add("ac_upd_date")
      adatatable4.Columns.Add("other_ac_upd_date")
      adatatable4.Columns.Add("ac_asking_price_sort")

      Dim b As Integer = 1
      Dim counted As Integer = dalTable.Rows.Count
      'Dim cont_id As String = ""
      'Dim act_name As String = ""
      'Dim acref_owner_percentage As String = ""
      'Dim name As String = ""
      'Dim address As String = ""
      'Dim address2 As String = ""
      'Dim city As String = ""
      'Dim state As String = ""
      'Dim country As String = ""
      'Dim zip As String = ""
      'Dim email As String = ""
      'Dim web As String = ""

      'Dim first As String = ""
      'Dim last As String = ""
      'Dim middle As String = ""
      'Dim title As String = ""
      'Dim pref As String = ""
      'Dim cemail As String = ""
      'Dim notes As String = ""


      'repeated values!!
      Dim ac_repeat As String = ""
      Dim repeated As Boolean = False
      Dim other_case As String = ""
      Dim year_repeat As String = ""
      Dim reg_repeat As String = ""
      Dim ac_listed_date As String = ""

      Dim ac_asking_repeat As Integer = 0
      Dim ac_est_repeat As Integer = 0

      'Dim other_act_name As String = ""

      'Dim other_acref_owner_percentage As String = ""
      'Dim other_comp_name As String = ""
      'Dim other_cont_id As String = ""
      'Dim other_name As String = ""
      'Dim other_address As String = ""
      'Dim other_address2 As String = ""
      'Dim other_city As String = ""
      'Dim other_state As String = ""
      'Dim other_country As String = ""
      'Dim other_zip As String = ""
      'Dim other_email As String = ""
      'Dim other_web As String = ""

      'Dim other_first As String = ""
      'Dim other_last As String = ""
      'Dim other_middle As String = ""
      'Dim other_title As String = ""
      'Dim other_pref As String = ""
      'Dim other_cemail As String = ""
      'Dim other_notes As String = ""
      'Dim repeatable_company As String = ""
      Dim repeat_counting As Integer = 0
      Dim type_mapping As String = ""
      'Dim company_source As String = ""
      Dim page_link As String = "details.aspx"
      If HttpContext.Current.Session.Item("isMobile") = True Then
        page_link = "Mobile_Details.aspx"
      End If

      For Each r As DataRow In dalTable.Rows
        Dim newCustomersRow As DataRow = adatatable4.NewRow()
        repeated = False


        Dim acit As Long = r("ac_id")
        Dim jetnet_ac_id As Long = r("jetnet_ac_id")

        If acit = 12793 Then
          Dim x As String = ""
          x = "here"
        End If
        If b = 1 Then
          old_ac_id = r("ac_id")
        End If
        Dim next_ac As Long = 0
        Dim next_jetnet_id As Long = 0
        If b <> counted Then
          next_ac = dalTable.Rows(b).Item("ac_id")
          next_jetnet_id = dalTable.Rows(b).Item("jetnet_ac_id")
        Else
          next_ac = 0
          next_jetnet_id = 0
        End If
        Select Case UCase(r("source"))
          Case "JETNET"
            other_case = "CLIENT"
          Case "CLIENT"
            other_case = "JETNET"
        End Select

        ac_repeat = ""
        year_repeat = ""
        reg_repeat = ""
        ac_listed_date = ""
        ac_asking_repeat = 0
        ac_est_repeat = 0
        type_mapping = ""

        If other_case = "CLIENT" Then
          'Let's check for other AC
          Dim afiltered_search As DataRow()
          Dim reg_hold As String = ""
          If Not IsDBNull(r("ac_reg_nbr")) Then
            reg_hold = r("ac_reg_nbr")
          End If
          '---------------------------------------------------------------------
          '---------------------------------------------------------------------
          'edited 5-18-2012
          'Swapped out the searching by a bunch of different parameters
          'to searching out for the ac ID = jetnet AC ID
          '---------------------------------------------------------------------
          '---------------------------------------------------------------------
          afiltered_search = dalTable.Select("source = '" & other_case & "' and jetnet_ac_id = '" & r("ac_id") & "'", "")

          ' If reg_hold = "" Then
          'afiltered_search = dalTable.Select("source = '" & other_case & "' and amod_make_name = '" & r("amod_make_name") & "' and amod_model_name = '" & r("amod_model_name") & "' and ac_ser_nbr = '" & r("ac_ser_nbr") & "'", "")
          'Else
          '    afiltered_search = dalTable.Select("source = '" & other_case & "' and amod_make_name = '" & r("amod_make_name") & "' and amod_model_name = '" & r("amod_model_name") & "' and ac_reg_nbr = '" & r("ac_reg_nbr") & "' and ac_ser_nbr = '" & r("ac_ser_nbr") & "'", "")
          'End If

          'extract and import
          For Each atmpDataRow_JETNET In afiltered_search
            '  If jetnet_ac_id <> next_jetnet_id Then
            repeated = True
            ' End If
          Next
        Else
          Dim afiltered_search As DataRow()
          Dim reg_hold As String = ""
          If Not IsDBNull(r("ac_reg_nbr")) Then
            reg_hold = r("ac_reg_nbr")
          End If
          'If reg_hold = "" Then
          '    afiltered_search = dalTable.Select("source = '" & other_case & "' and amod_make_name = '" & r("amod_make_name") & "' and amod_model_name = '" & r("amod_model_name") & "' and ac_ser_nbr = '" & r("ac_ser_nbr") & "'", "")
          'Else
          '    afiltered_search = dalTable.Select("source = '" & other_case & "' and amod_make_name = '" & r("amod_make_name") & "' and amod_model_name = '" & r("amod_model_name") & "' and ac_reg_nbr = '" & r("ac_reg_nbr") & "' and ac_ser_nbr = '" & r("ac_ser_nbr") & "'", "")

          'End If
          '---------------------------------------------------------------------
          '---------------------------------------------------------------------
          'edited 5-18-2012
          'Swapped out the searching by a bunch of different parameters
          'to searching out for the ac ID = jetnet AC ID
          '---------------------------------------------------------------------
          '---------------------------------------------------------------------
          afiltered_search = dalTable.Select("source = '" & other_case & "' and ac_id = '" & r("jetnet_ac_id") & "'", "")

          'extract and import
          Dim new_table As DataTable = dalTable.Clone
          For Each atmpDataRow_JETNET In afiltered_search
            new_table.ImportRow(atmpDataRow_JETNET)

          Next

          If new_table.Rows.Count > 0 Then
            repeated = False
            'one to one
            '----------------------------------------------------------Serial Number--------------------------------------------------
            If new_table.Rows(0).Item("source") = "JETNET" Then
              newCustomersRow.Item("other_ac_ser_nbr") = IIf(Not IsDBNull(new_table.Rows(0).Item("ac_ser_nbr")), "<em><a href='" & page_link & "?type=3&source=" & Trim(new_table.Rows(0).Item("source").ToString) & "&ac_id=" & new_table.Rows(0).Item("ac_id") & "'>" & new_table.Rows(0).Item("ac_ser_nbr") & "</span>", "")
              newCustomersRow.Item("other_source") = new_table.Rows(0).Item("source")
            Else
              newCustomersRow.Item("ac_ser_nbr") = IIf(Not IsDBNull(new_table.Rows(0).Item("ac_ser_nbr")), "<em><a class='client_row' href='" & page_link & "?type=3&source=" & Trim(new_table.Rows(0).Item("source").ToString) & "&ac_id=" & new_table.Rows(0).Item("ac_id") & "'>" & new_table.Rows(0).Item("ac_ser_nbr") & "</span>", "")
              newCustomersRow.Item("source") = new_table.Rows(0).Item("source")
            End If

            newCustomersRow.Item("other_ac_year_mfr") = IIf(Not IsDBNull(new_table.Rows(0).Item("ac_year_mfr")), new_table.Rows(0).Item("ac_year_mfr"), "")

            '----------------------------------------------------Reg Number-------------------------------
            newCustomersRow.Item("other_ac_reg_nbr") = IIf(Not IsDBNull(new_table.Rows(0).Item("ac_reg_nbr")), new_table.Rows(0).Item("ac_reg_nbr"), "")

            newCustomersRow.Item("other_ac_id") = new_table.Rows(0).Item("ac_id")

            '--------------------------------------------------Source------------------------------------------------------

            '----------------------------------------------------SHI HOURS---------------------------------------------
            If IIf(Not IsDBNull(r("ac_engine_1_shi_hrs")), r("ac_engine_1_shi_hrs"), 0) <> IIf(Not IsDBNull(new_table.Rows(0).Item("ac_engine_1_shi_hrs")), new_table.Rows(0).Item("ac_engine_1_shi_hrs"), 0) Then
              newCustomersRow.Item("other_ac_engine_1_shi_hrs") = IIf(Not IsDBNull(new_table.Rows(0).Item("ac_engine_1_shi_hrs")), new_table.Rows(0).Item("ac_engine_1_shi_hrs"), 0)
            End If
            If IIf(Not IsDBNull(r("ac_engine_2_shi_hrs")), r("ac_engine_2_shi_hrs"), 0) <> IIf(Not IsDBNull(new_table.Rows(0).Item("ac_engine_2_shi_hrs")), new_table.Rows(0).Item("ac_engine_2_shi_hrs"), 0) Then
              newCustomersRow.Item("other_ac_engine_2_shi_hrs") = IIf(Not IsDBNull(new_table.Rows(0).Item("ac_engine_2_shi_hrs")), new_table.Rows(0).Item("ac_engine_2_shi_hrs"), 0)
            End If
            If IIf(Not IsDBNull(r("ac_engine_3_shi_hrs")), r("ac_engine_3_shi_hrs"), 0) <> IIf(Not IsDBNull(new_table.Rows(0).Item("ac_engine_3_shi_hrs")), new_table.Rows(0).Item("ac_engine_3_shi_hrs"), 0) Then
              newCustomersRow.Item("other_ac_engine_3_shi_hrs") = IIf(Not IsDBNull(new_table.Rows(0).Item("ac_engine_3_shi_hrs")), new_table.Rows(0).Item("ac_engine_3_shi_hrs"), 0)
            End If
            If IIf(Not IsDBNull(r("ac_engine_4_shi_hrs")), r("ac_engine_4_shi_hrs"), 0) <> IIf(Not IsDBNull(new_table.Rows(0).Item("ac_engine_4_shi_hrs")), new_table.Rows(0).Item("ac_engine_4_shi_hrs"), 0) Then
              newCustomersRow.Item("other_ac_engine_4_shi_hrs") = IIf(Not IsDBNull(new_table.Rows(0).Item("ac_engine_4_shi_hrs")), new_table.Rows(0).Item("ac_engine_4_shi_hrs"), 0)
            End If
            '-----------------------------------------------------TTSN HOURS---------------------------------------------
            If IIf(Not IsDBNull(r("acep_engine_1_ttsn_hours")), r("acep_engine_1_ttsn_hours"), 0) <> IIf(Not IsDBNull(new_table.Rows(0).Item("acep_engine_1_ttsn_hours")), new_table.Rows(0).Item("acep_engine_1_ttsn_hours"), 0) Then
              newCustomersRow.Item("other_acep_engine_1_ttsn_hours") = IIf(Not IsDBNull(new_table.Rows(0).Item("acep_engine_1_ttsn_hours")), new_table.Rows(0).Item("acep_engine_1_ttsn_hours"), 0)
            End If
            If IIf(Not IsDBNull(r("acep_engine_2_ttsn_hours")), r("acep_engine_2_ttsn_hours"), 0) <> IIf(Not IsDBNull(new_table.Rows(0).Item("acep_engine_2_ttsn_hours")), new_table.Rows(0).Item("acep_engine_2_ttsn_hours"), 0) Then
              newCustomersRow.Item("other_acep_engine_2_ttsn_hours") = IIf(Not IsDBNull(new_table.Rows(0).Item("acep_engine_2_ttsn_hours")), new_table.Rows(0).Item("acep_engine_2_ttsn_hours"), 0)
            End If
            If IIf(Not IsDBNull(r("acep_engine_3_ttsn_hours")), r("acep_engine_3_ttsn_hours"), 0) <> IIf(Not IsDBNull(new_table.Rows(0).Item("acep_engine_3_ttsn_hours")), new_table.Rows(0).Item("acep_engine_3_ttsn_hours"), 0) Then
              newCustomersRow.Item("other_acep_engine_3_ttsn_hours") = IIf(Not IsDBNull(new_table.Rows(0).Item("acep_engine_3_ttsn_hours")), new_table.Rows(0).Item("acep_engine_3_ttsn_hours"), 0)
            End If
            If IIf(Not IsDBNull(r("acep_engine_4_ttsn_hours")), r("acep_engine_4_ttsn_hours"), 0) <> IIf(Not IsDBNull(new_table.Rows(0).Item("acep_engine_4_ttsn_hours")), new_table.Rows(0).Item("acep_engine_4_ttsn_hours"), 0) Then
              newCustomersRow.Item("other_acep_engine_4_ttsn_hours") = IIf(Not IsDBNull(new_table.Rows(0).Item("acep_engine_4_ttsn_hours")), new_table.Rows(0).Item("acep_engine_4_ttsn_hours"), 0)
            End If
            '-----------------------------------------------------TSOH HOURS---------------------------------------------------
            If IIf(Not IsDBNull(r("acep_engine_1_tsoh_hours")), r("acep_engine_1_tsoh_hours"), 0) <> IIf(Not IsDBNull(new_table.Rows(0).Item("acep_engine_1_tsoh_hours")), new_table.Rows(0).Item("acep_engine_1_tsoh_hours"), 0) Then
              newCustomersRow.Item("other_acep_engine_1_tsoh_hours") = IIf(Not IsDBNull(new_table.Rows(0).Item("acep_engine_1_tsoh_hours")), new_table.Rows(0).Item("acep_engine_1_tsoh_hours"), 0)
            End If
            If IIf(Not IsDBNull(r("acep_engine_2_tsoh_hours")), r("acep_engine_2_tsoh_hours"), 0) <> IIf(Not IsDBNull(new_table.Rows(0).Item("acep_engine_2_tsoh_hours")), new_table.Rows(0).Item("acep_engine_2_tsoh_hours"), 0) Then
              newCustomersRow.Item("other_acep_engine_2_tsoh_hours") = IIf(Not IsDBNull(new_table.Rows(0).Item("acep_engine_2_tsoh_hours")), new_table.Rows(0).Item("acep_engine_2_ttsn_hours"), 0)
            End If
            If IIf(Not IsDBNull(r("acep_engine_3_tsoh_hours")), r("acep_engine_3_tsoh_hours"), 0) <> IIf(Not IsDBNull(new_table.Rows(0).Item("acep_engine_3_tsoh_hours")), new_table.Rows(0).Item("acep_engine_3_tsoh_hours"), 0) Then
              newCustomersRow.Item("other_acep_engine_3_tsoh_hours") = IIf(Not IsDBNull(new_table.Rows(0).Item("acep_engine_3_tsoh_hours")), new_table.Rows(0).Item("acep_engine_3_tsoh_hours"), 0)
            End If
            If IIf(Not IsDBNull(r("acep_engine_4_tsoh_hours")), r("acep_engine_4_tsoh_hours"), 0) <> IIf(Not IsDBNull(new_table.Rows(0).Item("acep_engine_4_tsoh_hours")), new_table.Rows(0).Item("acep_engine_4_tsoh_hours"), 0) Then
              newCustomersRow.Item("other_acep_engine_4_tsoh_hours") = IIf(Not IsDBNull(new_table.Rows(0).Item("acep_engine_4_tsoh_hours")), new_table.Rows(0).Item("acep_engine_4_tsoh_hours"), 0)
            End If
            '-----------------------------------------------------AIRFRAME TOT HOURS-------------------------------------------
            If IIf(Not IsDBNull(r("ac_airframe_tot_hrs")), r("ac_airframe_tot_hrs"), 0) <> IIf(Not IsDBNull(new_table.Rows(0).Item("ac_airframe_tot_hrs")), new_table.Rows(0).Item("ac_airframe_tot_hrs"), 0) Then
              newCustomersRow.Item("other_ac_airframe_tot_hrs") = IIf(Not IsDBNull(new_table.Rows(0).Item("ac_airframe_tot_hrs")), new_table.Rows(0).Item("ac_airframe_tot_hrs"), 0)
            End If
            '--------------------For Sale Flag--------------------
            'If IIf(Not IsDBNull(r("ac_forsale_flag")), r("ac_forsale_flag"), "N") <> IIf(Not IsDBNull(new_table.Rows(0).Item("ac_forsale_flag")), new_table.Rows(0).Item("ac_forsale_flag"), "N") Then
            newCustomersRow.Item("other_ac_forsale_flag") = IIf(Not IsDBNull(new_table.Rows(0).Item("ac_forsale_flag")), new_table.Rows(0).Item("ac_forsale_flag"), "N")
            'End If
            '--------------------Exclusive Flag--------------------
            'If IIf(Not IsDBNull(r("ac_exclusive_flag")), r("ac_exclusive_flag"), "N") <> IIf(Not IsDBNull(new_table.Rows(0).Item("ac_exclusive_flag")), new_table.Rows(0).Item("ac_exclusive_flag"), "N") Then
            newCustomersRow.Item("other_ac_exclusive_flag") = IIf(Not IsDBNull(new_table.Rows(0).Item("ac_exclusive_flag")), new_table.Rows(0).Item("ac_exclusive_flag"), "N")
            'End If
            '--------------------Lease Flag--------------------
            'If IIf(Not IsDBNull(r("ac_lease_flag")), r("ac_lease_flag"), "N") <> IIf(Not IsDBNull(new_table.Rows(0).Item("ac_lease_flag")), new_table.Rows(0).Item("ac_lease_flag"), "N") Then
            newCustomersRow.Item("other_ac_lease_flag") = IIf(Not IsDBNull(new_table.Rows(0).Item("ac_lease_flag")), new_table.Rows(0).Item("ac_lease_flag"), "N")
            'End If
            '--------------------Asking Wordage--------------
            newCustomersRow.Item("other_ac_asking_wordage") = IIf(Not IsDBNull(new_table.Rows(0).Item("ac_asking_wordage")), new_table.Rows(0).Item("ac_asking_wordage"), "")
            '--------------------AC Status--------------
            newCustomersRow.Item("other_ac_status") = IIf(Not IsDBNull(new_table.Rows(0).Item("ac_status")), new_table.Rows(0).Item("ac_status"), "")
            '----------------------AC Date Listed----------------
            If Not IsDBNull(new_table.Rows(0).Item("ac_date_listed")) Then
              newCustomersRow.Item("other_ac_date_listed") = new_table.Rows(0).Item("ac_date_listed") 'IIf(Not IsDBNull(new_table.Rows(0).Item("ac_date_listed")), clsGeneral.clsGeneral.datenull(new_table.Rows(0).Item("ac_date_listed")), "")
            End If

            '----------------------AC Update Date----------------
            If Not IsDBNull(new_table.Rows(0).Item("ac_upd_date")) Then
              newCustomersRow.Item("other_ac_upd_date") = new_table.Rows(0).Item("ac_upd_date")
            End If

            newCustomersRow.Item("other_ac_asking_price") = IIf(Not IsDBNull(new_table.Rows(0).Item("ac_asking_price")), clsGeneral.clsGeneral.no_zero(new_table.Rows(0).Item("ac_asking_price"), "", True), "")
            newCustomersRow.Item("ac_asking_price_sort") = IIf(Not IsDBNull(new_table.Rows(0).Item("ac_asking_price")), new_table.Rows(0).Item("ac_asking_price"), "")
          End If
          'repeated = False
        End If

        'Dim hold_company_name As String = ""
        'Dim hold_contact_first As String = ""
        'Dim hold_contact_last As String = ""
        'Dim hold_act_name As String = ""

        'If Not IsDBNull(r("comp_name")) Then
        '    hold_company_name = Trim(r("comp_name"))
        'End If

        'If Not IsDBNull(r("contact_first_name")) Then
        '    hold_contact_first = Trim(r("contact_first_name"))
        'End If

        'If Not IsDBNull(r("contact_last_name")) Then
        '    hold_contact_last = Trim(r("contact_last_name"))
        'End If

        'If Not IsDBNull(r("act_name")) Then
        '    hold_act_name = Trim(r("act_name"))
        'End If

        'Dim comp_compare As String = hold_company_name & "|||" & hold_contact_first & "|||" & hold_contact_last & "|||" & hold_act_name

        'If InStr(repeatable_company, comp_compare) = 0 Then
        '    Dim compare_id As Integer = r("jetnet_ac_id")
        '    Dim replace_comp As String = ""
        '    If Not IsDBNull(r("comp_name")) Then
        '        replace_comp = Trim(Replace(r("comp_name"), "'", "''"))
        '    End If

        '    'Dim s As String = "jetnet_ac_id = '" & compare_id & "' and comp_name = '" & replace_comp & "' and source = 'JETNET' and act_name = '" & r("act_name") & "' and contact_id = '" & r("contact_id") & "'"
        '    Dim afiltered_search As DataRow() = dalTable.Select("jetnet_ac_id = '" & compare_id & "' and comp_name = '" & replace_comp & "' and source = 'JETNET' and act_name = '" & hold_act_name & "' ", "")
        '    'extract and import
        '    Dim new_table As DataTable = dalTable.Clone
        '    For Each atmpDataRow_JETNET In afiltered_search
        '        new_table.ImportRow(atmpDataRow_JETNET)
        '    Next

        '    If Not IsNothing(new_table) Then
        '        If new_table.Rows.Count > 0 Then
        '            If r("source") = "JETNET" Then
        '                company_source = company_source & "JETNET|" 'client company with jetnet company view
        '            Else
        '                company_source = company_source & "CJETNET|" 'client company with jetnet company view
        '            End If

        '        Else
        '            company_source = company_source & "CLIENT|"
        '        End If
        '    Else
        '        company_source = company_source & "CLIENT|"
        '    End If
        '    repeatable_company = repeatable_company & "|||" & hold_company_name & "|||" & hold_contact_first & "|||" & hold_contact_last & "|||" & hold_act_name
        '    act_name = act_name & r("act_name") & "|"
        '    acref_owner_percentage = acref_owner_percentage & r("acref_owner_percentage") & "|"
        '    comp_name = comp_name & r("comp_id") & "|"
        '    cont_id = cont_id & r("contact_id") & "|"
        '    name = name & r("comp_name") & "|"
        '    address = address & r("comp_address1") & "|"
        '    address2 = address2 & r("comp_address2") & "|"
        '    city = city & r("comp_city") & "|"
        '    state = state & r("comp_state") & "|"
        '    country = country & r("comp_country") & "|"
        '    zip = zip & r("comp_zip_code") & "|"
        '    email = email & r("comp_email_address") & "|"
        '    web = web & r("comp_web_address") & "|"

        '    first = first & r("contact_first_name") & "|"
        '    last = last & r("contact_last_name") & "|"
        '    middle = middle & r("contact_middle_initial") & "|"
        '    title = title & r("contact_title") & "|"
        '    pref = pref & r("contact_preferred_name") & "|"
        '    cemail = cemail & r("contact_email_address") & "|"
        '    notes = notes & r("contact_notes") & "|"
        'End If
        newCustomersRow.Item("value_price") = r("value_price")
        '----------------------------------------------------------------Ac ID--------------------------------------------
        newCustomersRow.Item("ac_id") = r("ac_id")
        '---------------------------------------------------------------Ac Amod ID--------------------------------------------
        newCustomersRow.Item("ac_amod_id") = r("ac_amod_id")
        '--------------------------------------------------Ser Number---------------------------------
        If Not IsDBNull(r("ac_ser_nbr")) And Not IsDBNull(newCustomersRow.Item("other_ac_ser_nbr")) Then
          ' If newCustomersRow.Item("other_ac_forsale_flag") <> r("ac_forsale_flag") Then
          newCustomersRow.Item("ac_ser_nbr") = "<a class='" & LCase(Trim(r("source").ToString)) & "_row' href='" & page_link & "?type=3&source=" & Trim(r("source").ToString) & "&ac_id=" & r("ac_id") & "'>" & r("ac_ser_nbr") & "</a>"
          'End If
        Else
          If repeated = True Then
            newCustomersRow.Item("ac_ser_nbr") = "<a class='" & LCase(Trim(r("source").ToString)) & "_row' href='" & page_link & "?type=3&source=" & Trim(r("source").ToString) & "&ac_id=" & r("ac_id") & "'>" & r("ac_ser_nbr") & "</a>"
          Else
            newCustomersRow.Item("other_ac_ser_nbr") = "<a class='" & LCase(Trim(r("source").ToString)) & "_row' href='" & page_link & "?type=3&source=" & Trim(r("source").ToString) & "&ac_id=" & r("ac_id") & "'>" & r("ac_ser_nbr") & "</a>"
          End If
        End If

        '--------------------------------------------------Registration Number---------------------------------
        If Not IsDBNull(r("ac_reg_nbr")) And Not IsDBNull(newCustomersRow.Item("other_ac_reg_nbr")) Then
          ' If newCustomersRow.Item("other_ac_forsale_flag") <> r("ac_forsale_flag") Then
          newCustomersRow.Item("ac_reg_nbr") = r("ac_reg_nbr")
          'End If
        Else
          If repeated = True Then
            newCustomersRow.Item("ac_reg_nbr") = r("ac_reg_nbr")
          Else
            newCustomersRow.Item("other_ac_reg_nbr") = r("ac_reg_nbr")
          End If
        End If
        ''-----------------------------------------------Contact Email Addresss---------------------------------------
        'If Not IsDBNull(r("contact_email_address")) And Not IsDBNull(dalTable.Rows(b - 1).Item("contact_email_address")) Then
        '    If repeated = True Then
        '        If r("contact_email_address") <> dalTable.Rows(b - 1).Item("contact_email_address") Then
        '            newCustomersRow.Item("contact_email_address") = cemail '& other_cemail
        '        End If
        '    Else
        '        newCustomersRow.Item("contact_email_address") = cemail '& other_cemail
        '    End If
        'Else
        '    newCustomersRow.Item("contact_email_address") = cemail '& other_cemail
        'End If
        ''-------------------------------------------Airframe Total Hours-----------------------------------------------
        If Not IsDBNull(r("ac_airframe_tot_hrs")) And Not IsDBNull(newCustomersRow.Item("other_ac_airframe_tot_hrs")) Then
          ' If newCustomersRow.Item("other_ac_airframe_tot_hrs") <> r("ac_airframe_tot_hrs") Then
          newCustomersRow.Item("ac_airframe_tot_hrs") = r("ac_airframe_tot_hrs")
          'End If
        Else
          If repeated = True Then
            newCustomersRow.Item("ac_airframe_tot_hrs") = r("ac_airframe_tot_hrs")
          Else
            newCustomersRow.Item("other_ac_airframe_tot_hrs") = r("ac_airframe_tot_hrs")
          End If
        End If
        '------------------------------------------Model Make Name---------------------------------------------
        If Not IsDBNull(r("amod_make_name")) And Not IsDBNull(dalTable.Rows(b - 1).Item("amod_make_name")) Then
          If repeated = True Then
            If r("amod_make_name") <> dalTable.Rows(b - 1).Item("amod_make_name") Then
              newCustomersRow.Item("amod_make_name") = r("amod_make_name")
            End If
          Else
            newCustomersRow.Item("amod_make_name") = r("amod_make_name")
          End If
        Else
          newCustomersRow.Item("amod_make_name") = r("amod_make_name")
        End If
        '----------------------------------------------Model Model Name----------------------------------------
        If Not IsDBNull(r("amod_model_name")) And Not IsDBNull(dalTable.Rows(b - 1).Item("amod_model_name")) Then
          If repeated = True Then
            If r("amod_model_name") <> dalTable.Rows(b - 1).Item("amod_model_name") Then
              newCustomersRow.Item("amod_model_name") = r("amod_model_name")
            End If
          Else
            newCustomersRow.Item("amod_model_name") = r("amod_model_name")
          End If
        Else
          newCustomersRow.Item("amod_model_name") = r("amod_model_name")
        End If
        '------------------------------------------------Make Type -------------------------------------------
        If Not IsDBNull(r("amod_make_type")) And Not IsDBNull(dalTable.Rows(b - 1).Item("amod_make_type")) Then
          If repeated = True Then
            If r("amod_make_type") <> dalTable.Rows(b - 1).Item("amod_make_type") Then
              newCustomersRow.Item("amod_make_type") = r("amod_make_type")
            End If
          Else
            newCustomersRow.Item("amod_make_type") = r("amod_make_type")
          End If
        Else
          newCustomersRow.Item("amod_make_type") = r("amod_make_type")
        End If
        '-------------------------------------Year Manufactured----------------------------------------
        If Not IsDBNull(r("ac_year_mfr")) And Not IsDBNull(newCustomersRow.Item("other_ac_year_mfr")) Then
          ' If newCustomersRow.Item("other_ac_forsale_flag") <> r("ac_forsale_flag") Then
          newCustomersRow.Item("ac_year_mfr") = r("ac_year_mfr")
          'End If
        Else
          If repeated = True Then
            newCustomersRow.Item("ac_year_mfr") = r("ac_year_mfr")
          Else
            newCustomersRow.Item("other_ac_year_mfr") = r("ac_year_mfr")
          End If
        End If
        '----------------------------------------------Act Name----------------------------
        'If Not IsDBNull(act_name) And Not IsDBNull(dalTable.Rows(b - 1).Item("act_name")) Then
        '    If repeated = True Then
        '        If act_name <> dalTable.Rows(b - 1).Item("act_name") Then
        '            newCustomersRow.Item("act_name") = act_name '& other_act_name 
        '        End If
        '    Else
        '        newCustomersRow.Item("act_name") = act_name '& other_act_name
        '    End If
        'Else
        '    newCustomersRow.Item("act_name") = act_name '& other_act_name
        'End If


        '--------------------------------------AC Forsale Flag------------------------------------------------------------
        If Not IsDBNull(r("ac_forsale_flag")) And Not IsDBNull(newCustomersRow.Item("other_ac_forsale_flag")) Then
          ' If newCustomersRow.Item("other_ac_forsale_flag") <> r("ac_forsale_flag") Then
          newCustomersRow.Item("ac_forsale_flag") = r("ac_forsale_flag")
          'End If
        Else
          If repeated = True Then
            newCustomersRow.Item("ac_forsale_flag") = r("ac_forsale_flag")
          Else
            newCustomersRow.Item("other_ac_forsale_flag") = r("ac_forsale_flag")
          End If
        End If
        '--------------------------------------------End Exclusive Flag--------------------------------------------------------
        '--------------------------------------Exclusive Flag------------------------------------------------------------

        If r("source") = "JETNET" Then
          newCustomersRow.Item("other_ac_exclusive_flag") = r("ac_exclusive_flag")
        Else
          newCustomersRow.Item("ac_exclusive_flag") = r("ac_exclusive_flag")
        End If

        '--------------------------------------------End Exclusive Flag--------------------------------------------------------
        '----------------------------------------Lease Flag--------------------------------------------------------------
        If r("source") = "JETNET" Then
          newCustomersRow.Item("other_ac_lease_flag") = r("ac_lease_flag")
        Else
          newCustomersRow.Item("ac_lease_flag") = r("ac_lease_flag")
        End If

        '--------------------------------------------End Lease Flag--------------------------------------------------------
        '--------------------------------------------Asking Wordage--------------------------------------------------------
        If Not IsDBNull(r("ac_asking_wordage")) And Not IsDBNull(newCustomersRow.Item("other_ac_asking_wordage")) Then
          'If newCustomersRow.Item("other_ac_asking_wordage") <> r("ac_asking_wordage") Then
          newCustomersRow.Item("ac_asking_wordage") = r("ac_asking_wordage")
          'End If
        Else
          If repeated = True Then
            newCustomersRow.Item("ac_asking_wordage") = r("ac_asking_wordage")
          Else
            newCustomersRow.Item("other_ac_asking_wordage") = r("ac_asking_wordage")
          End If
        End If
        '--------------------------------------------End Asking Wordage--------------------------------------------------------
        '--------------------------------------------AC Status--------------------------------------------------------
        If Not IsDBNull(r("ac_status")) And Not IsDBNull(newCustomersRow.Item("other_ac_status")) Then
          ' If newCustomersRow.Item("other_ac_status") <> r("ac_status") Then
          newCustomersRow.Item("ac_status") = r("ac_status")
          'End If
        Else
          If repeated = True Then
            newCustomersRow.Item("ac_status") = r("ac_status")
          Else
            newCustomersRow.Item("other_ac_status") = r("ac_status")
          End If
        End If
        '--------------------------------------------End AC Status--------------------------------------------------------
        '--------------------------------------------AC Date Listed--------------------------------------------------------
        If Not IsDBNull(r("ac_date_listed")) And Not IsDBNull(newCustomersRow.Item("other_ac_date_listed")) Then
          'If newCustomersRow.Item("other_ac_date_listed") <> r("ac_date_listed") Then
          newCustomersRow.Item("ac_date_listed") = r("ac_date_listed") 'clsGeneral.clsGeneral.datenull(r("ac_date_listed"))
          'End If
        Else
          If repeated = True Then
            newCustomersRow.Item("ac_date_listed") = r("ac_date_listed") 'clsGeneral.clsGeneral.datenull(r("ac_date_listed"))
          Else
            newCustomersRow.Item("other_ac_date_listed") = r("ac_date_listed") 'clsGeneral.clsGeneral.datenull(r("ac_date_listed"))
          End If
        End If
        '--------------------------------------------AC Update Date-------------------------------------------------------
        If Not IsDBNull(r("ac_upd_date")) And Not IsDBNull(newCustomersRow.Item("other_ac_upd_date")) Then
          newCustomersRow.Item("ac_upd_date") = r("ac_upd_date")
        Else
          If repeated = True Then
            newCustomersRow.Item("ac_upd_date") = r("ac_upd_date")
          Else
            newCustomersRow.Item("other_ac_upd_date") = r("ac_upd_date")
          End If
        End If
        '--------------------------------------------End AC Status--------------------------------------------------------
        '--------------------------------------------AC Price--------------------------------------------------------
        If Not IsDBNull(r("ac_asking_price")) And Not IsDBNull(newCustomersRow.Item("other_ac_asking_price")) Then
          ' If newCustomersRow.Item("other_ac_asking_price") <> r("ac_asking_price") Then
          newCustomersRow.Item("ac_asking_price") = clsGeneral.clsGeneral.no_zero(r("ac_asking_price"), "", True)
          newCustomersRow.Item("ac_asking_price_sort") = r("ac_asking_price")
          'End If
        Else
          If repeated = True Then
            newCustomersRow.Item("ac_asking_price") = clsGeneral.clsGeneral.no_zero(r("ac_asking_price"), "", True)
            newCustomersRow.Item("ac_asking_price_sort") = r("ac_asking_price")
          Else
            newCustomersRow.Item("other_ac_asking_price") = clsGeneral.clsGeneral.no_zero(r("ac_asking_price"), "", True)
            newCustomersRow.Item("ac_asking_price_sort") = r("ac_asking_price")
          End If
        End If
        '--------------------------------------------End AC Price--------------------------------------------------------

        'If Not IsDBNull(comp_name) And Not IsDBNull(dalTable.Rows(b - 1).Item("comp_id")) Then
        '    If repeated = True Then
        '        If comp_name <> dalTable.Rows(b - 1).Item("comp_id") Then
        '            newCustomersRow.Item("comp_id") = comp_name '& other_comp_name
        '        End If
        '    Else
        '        newCustomersRow.Item("comp_id") = comp_name '& other_comp_name
        '    End If
        'Else
        '    newCustomersRow.Item("comp_id") = comp_name '& other_comp_name
        'End If
        ''-------------------------------------------Company Name-----------------------------------
        'If Not IsDBNull(name) And Not IsDBNull(dalTable.Rows(b - 1).Item("comp_name")) Then
        '    If repeated = True Then
        '        If name <> dalTable.Rows(b - 1).Item("comp_name") Then
        '            newCustomersRow.Item("comp_name") = name '& other_name
        '        End If
        '    Else
        '        newCustomersRow.Item("comp_name") = name '& other_name
        '    End If
        'Else
        '    newCustomersRow.Item("comp_name") = name '& other_name
        'End If
        ''------------------------------------Company Address------------------------------------
        'If Not IsDBNull(address) And Not IsDBNull(dalTable.Rows(b - 1).Item("comp_address1")) Then
        '    If repeated = True Then
        '        If address <> dalTable.Rows(b - 1).Item("comp_address1") Then
        '            newCustomersRow.Item("comp_address1") = address '& other_address
        '        End If
        '    Else
        '        newCustomersRow.Item("comp_address1") = address '& other_address
        '    End If
        'Else
        '    newCustomersRow.Item("comp_address1") = address '& other_address
        'End If

        ''----------------------------------Company Address 2------------------------------------
        'If Not IsDBNull(address2) And Not IsDBNull(dalTable.Rows(b - 1).Item("comp_address2")) Then
        '    If repeated = True Then
        '        If address2 <> dalTable.Rows(b - 1).Item("comp_address2") Then
        '            newCustomersRow.Item("comp_address2") = address2 '& other_address2
        '        End If
        '    Else
        '        newCustomersRow.Item("comp_address2") = address2 '& other_address2
        '    End If
        'Else
        '    newCustomersRow.Item("comp_address2") = address2 '& other_address2
        'End If

        ''-----------------------------------Company City---------------------------------------
        'If Not IsDBNull(city) And Not IsDBNull(dalTable.Rows(b - 1).Item("comp_city")) Then
        '    If repeated = True Then
        '        If city <> dalTable.Rows(b - 1).Item("comp_city") Then
        '            newCustomersRow.Item("comp_city") = city '& other_city
        '        End If
        '    Else
        '        newCustomersRow.Item("comp_city") = city '& other_city
        '    End If
        'Else
        '    newCustomersRow.Item("comp_city") = city '& other_city
        'End If
        ''--------------------------------------------Company State------------------------------
        'If Not IsDBNull(state) And Not IsDBNull(dalTable.Rows(b - 1).Item("comp_state")) Then
        '    If repeated = True Then
        '        If state <> dalTable.Rows(b - 1).Item("comp_state") Then
        '            newCustomersRow.Item("comp_state") = state '& other_state
        '        End If
        '    Else
        '        newCustomersRow.Item("comp_state") = state '& other_state
        '    End If
        'Else
        '    newCustomersRow.Item("comp_state") = state '& other_state
        'End If
        ''--------------------------------Company Country-----------------------------------
        'If Not IsDBNull(country) And Not IsDBNull(dalTable.Rows(b - 1).Item("comp_country")) Then
        '    If repeated = True Then
        '        If country <> dalTable.Rows(b - 1).Item("comp_country") Then
        '            newCustomersRow.Item("comp_country") = country '& other_country
        '        End If
        '    Else
        '        newCustomersRow.Item("comp_country") = country '& other_country
        '    End If
        'Else
        '    newCustomersRow.Item("comp_country") = country '& other_country
        'End If
        ''---------------------------------Company zip--------------------------------------
        'If Not IsDBNull(zip) And Not IsDBNull(dalTable.Rows(b - 1).Item("comp_zip_code")) Then
        '    If repeated = True Then
        '        If zip <> dalTable.Rows(b - 1).Item("comp_zip_code") Then
        '            newCustomersRow.Item("comp_zip_code") = zip '& other_zip
        '        End If
        '    Else
        '        newCustomersRow.Item("comp_zip_code") = zip '& other_zip
        '    End If
        'Else
        '    newCustomersRow.Item("comp_zip_code") = zip '& other_zip
        'End If
        ''--------------------------------------Company Email--------------------------------------------
        'If Not IsDBNull(email) And Not IsDBNull(dalTable.Rows(b - 1).Item("comp_email_address")) Then
        '    If repeated = True Then
        '        If email <> dalTable.Rows(b - 1).Item("comp_email_address") Then
        '            newCustomersRow.Item("comp_email_address") = email '& other_email
        '        End If
        '    Else
        '        newCustomersRow.Item("comp_email_address") = email '& other_email
        '    End If
        'Else
        '    newCustomersRow.Item("comp_email_address") = email '& other_email
        'End If
        ''----------------------------------------Company Web Address----------------------------------------
        'If Not IsDBNull(web) And Not IsDBNull(dalTable.Rows(b - 1).Item("comp_web_address")) Then
        '    If repeated = True Then
        '        If web <> dalTable.Rows(b - 1).Item("comp_web_address") Then
        '            newCustomersRow.Item("comp_web_address") = web '& other_web
        '        End If
        '    Else
        '        newCustomersRow.Item("comp_web_address") = web '& other_web
        '    End If
        'Else
        '    newCustomersRow.Item("comp_web_address") = web '& other_web
        'End If

        ''-------------------------------------First Name---------------------------------------------------
        'If Not IsDBNull(first) And Not IsDBNull(dalTable.Rows(b - 1).Item("contact_first_name")) Then
        '    If repeated = True Then
        '        If first <> dalTable.Rows(b - 1).Item("contact_first_name") Then
        '            newCustomersRow.Item("contact_first_name") = first '& other_first
        '        End If
        '    Else
        '        newCustomersRow.Item("contact_first_name") = first '& other_first
        '    End If
        'Else
        '    newCustomersRow.Item("contact_first_name") = first '& other_first
        'End If
        ''-----------------------------------Last Name----------------------------------------------
        'If Not IsDBNull(last) And Not IsDBNull(dalTable.Rows(b - 1).Item("contact_last_name")) Then
        '    If repeated = True Then
        '        If last <> dalTable.Rows(b - 1).Item("contact_last_name") Then
        '            newCustomersRow.Item("contact_last_name") = last '& other_last
        '        End If
        '    Else
        '        newCustomersRow.Item("contact_last_name") = last '& other_last
        '    End If
        'Else
        '    newCustomersRow.Item("contact_last_name") = last '& other_last
        'End If
        ''----------------------------Middle Name---------------------------------------
        'If Not IsDBNull(middle) And Not IsDBNull(dalTable.Rows(b - 1).Item("contact_middle_initial")) Then
        '    If repeated = True Then
        '        If middle <> dalTable.Rows(b - 1).Item("contact_middle_initial") Then
        '            newCustomersRow.Item("contact_middle_initial") = middle '& other_middle
        '        End If
        '    Else
        '        newCustomersRow.Item("contact_middle_initial") = middle '& other_middle
        '    End If
        'Else
        '    newCustomersRow.Item("contact_middle_initial") = middle '& other_middle
        'End If
        ''--------------------------------Title----------------------------------
        'If Not IsDBNull(title) And Not IsDBNull(dalTable.Rows(b - 1).Item("contact_title")) Then
        '    If repeated = True Then
        '        If title <> dalTable.Rows(b - 1).Item("contact_title") Then
        '            newCustomersRow.Item("contact_title") = title '& other_title
        '        End If
        '    Else
        '        newCustomersRow.Item("contact_title") = title '& other_title
        '    End If
        'Else
        '    newCustomersRow.Item("contact_title") = title '& other_title
        'End If
        ''----------------------------Preferred Name-----------------------
        'If Not IsDBNull(pref) And Not IsDBNull(dalTable.Rows(b - 1).Item("contact_preferred_name")) Then
        '    If repeated = True Then
        '        If pref <> dalTable.Rows(b - 1).Item("contact_preferred_name") Then
        '            newCustomersRow.Item("contact_preferred_name") = pref '& other_pref
        '        End If
        '    Else
        '        newCustomersRow.Item("contact_preferred_name") = pref '& other_pref
        '    End If
        'Else
        '    newCustomersRow.Item("contact_preferred_name") = pref '& other_pref
        'End If
        '-------------------------------Note------------------
        newCustomersRow.Item("lastnote") = r("lastnote")
        '-------------------------------Event------------------
        newCustomersRow.Item("lastevent") = r("lastevent")
        '----------------------------Sort-----------------
        newCustomersRow.Item("ac_ser_nbr_sort") = r("ac_ser_nbr_sort")
        '------------------------------AC ID----------------------
        newCustomersRow.Item("jetnet_ac_id") = r("jetnet_ac_id")
        '------------------------------------Notes-----------
        'newCustomersRow("contact_notes") = notes
        '-------------------------------------------Flags----------------------------------
        newCustomersRow.Item("ac_product_business_flag") = r("ac_product_business_flag")
        newCustomersRow.Item("ac_product_helicopter_flag") = r("ac_product_helicopter_flag")
        newCustomersRow.Item("ac_product_commercial_flag") = r("ac_product_commercial_flag")
        '-----------------------------------------SHI Hours-----------------------------------------
        If Not IsDBNull(r("ac_engine_1_shi_hrs")) And Not IsDBNull(newCustomersRow.Item("other_ac_engine_1_shi_hrs")) Then
          If newCustomersRow.Item("other_ac_engine_1_shi_hrs") <> r("ac_engine_1_shi_hrs") Then
            newCustomersRow.Item("ac_engine_1_shi_hrs") = r("ac_engine_1_shi_hrs")
          End If
        Else
          If repeated = True Then
            newCustomersRow.Item("ac_engine_1_shi_hrs") = r("ac_engine_1_shi_hrs")
          Else
            newCustomersRow.Item("other_ac_engine_1_shi_hrs") = r("ac_engine_1_shi_hrs")
          End If
        End If
        If Not IsDBNull(r("ac_engine_2_shi_hrs")) And Not IsDBNull(newCustomersRow.Item("other_ac_engine_2_shi_hrs")) Then
          If newCustomersRow.Item("other_ac_engine_2_shi_hrs") <> r("ac_engine_2_shi_hrs") Then
            newCustomersRow.Item("ac_engine_1_shi_hrs") = r("ac_engine_2_shi_hrs")
          End If
        Else
          If repeated = True Then
            newCustomersRow.Item("ac_engine_2_shi_hrs") = r("ac_engine_2_shi_hrs")
          Else
            newCustomersRow.Item("other_ac_engine_2_shi_hrs") = r("ac_engine_2_shi_hrs")
          End If
        End If

        If Not IsDBNull(r("ac_engine_3_shi_hrs")) And Not IsDBNull(newCustomersRow.Item("other_ac_engine_3_shi_hrs")) Then
          If newCustomersRow.Item("other_ac_engine_3_shi_hrs") <> r("ac_engine_3_shi_hrs") Then
            newCustomersRow.Item("ac_engine_3_shi_hrs") = r("ac_engine_3_shi_hrs")
          End If
        Else
          If repeated = True Then
            newCustomersRow.Item("ac_engine_3_shi_hrs") = r("ac_engine_3_shi_hrs")
          Else
            newCustomersRow.Item("other_ac_engine_3_shi_hrs") = r("ac_engine_3_shi_hrs")
          End If
        End If

        If Not IsDBNull(r("ac_engine_4_shi_hrs")) And Not IsDBNull(newCustomersRow.Item("other_ac_engine_4_shi_hrs")) Then
          If newCustomersRow.Item("other_ac_engine_4_shi_hrs") <> r("ac_engine_4_shi_hrs") Then
            newCustomersRow.Item("ac_engine_4_shi_hrs") = r("ac_engine_4_shi_hrs")
          End If
        Else
          If repeated = True Then
            newCustomersRow.Item("ac_engine_4_shi_hrs") = r("ac_engine_4_shi_hrs")
          Else
            newCustomersRow.Item("other_ac_engine_4_shi_hrs") = r("ac_engine_4_shi_hrs")
          End If
        End If
        '-----------------------------------------TTSN Hours-----------------------------------------
        If Not IsDBNull(r("acep_engine_1_ttsn_hours")) And Not IsDBNull(newCustomersRow.Item("other_acep_engine_1_ttsn_hours")) Then
          If newCustomersRow.Item("other_acep_engine_1_ttsn_hours") <> r("acep_engine_1_ttsn_hours") Then
            newCustomersRow.Item("acep_engine_1_ttsn_hours") = r("acep_engine_1_ttsn_hours")
          End If
        Else
          If repeated = True Then
            newCustomersRow.Item("acep_engine_1_ttsn_hours") = r("acep_engine_1_ttsn_hours")
          Else
            newCustomersRow.Item("other_acep_engine_1_ttsn_hours") = r("acep_engine_1_ttsn_hours")
          End If
        End If
        If Not IsDBNull(r("acep_engine_2_ttsn_hours")) And Not IsDBNull(newCustomersRow.Item("other_acep_engine_2_ttsn_hours")) Then
          If newCustomersRow.Item("other_acep_engine_2_ttsn_hours") <> r("acep_engine_2_ttsn_hours") Then
            newCustomersRow.Item("acep_engine_2_ttsn_hours") = r("acep_engine_2_ttsn_hours")
          End If
        Else
          If repeated = True Then
            newCustomersRow.Item("acep_engine_2_ttsn_hours") = r("acep_engine_2_ttsn_hours")
          Else
            newCustomersRow.Item("other_acep_engine_2_ttsn_hours") = r("acep_engine_2_ttsn_hours")
          End If
        End If

        If Not IsDBNull(r("acep_engine_3_ttsn_hours")) And Not IsDBNull(newCustomersRow.Item("other_acep_engine_3_ttsn_hours")) Then
          If newCustomersRow.Item("other_acep_engine_3_ttsn_hours") <> r("acep_engine_3_ttsn_hours") Then
            newCustomersRow.Item("acep_engine_3_ttsn_hours") = r("acep_engine_3_ttsn_hours")
          End If
        Else
          If repeated = True Then
            newCustomersRow.Item("acep_engine_3_ttsn_hours") = r("acep_engine_3_ttsn_hours")
          Else
            newCustomersRow.Item("other_acep_engine_3_ttsn_hours") = r("acep_engine_3_ttsn_hours")
          End If
        End If

        If Not IsDBNull(r("acep_engine_4_ttsn_hours")) And Not IsDBNull(newCustomersRow.Item("other_acep_engine_4_ttsn_hours")) Then
          If newCustomersRow.Item("other_acep_engine_4_ttsn_hours") <> r("acep_engine_4_ttsn_hours") Then
            newCustomersRow.Item("acep_engine_4_ttsn_hours") = r("acep_engine_4_ttsn_hours")
          End If
        Else
          If repeated = True Then
            newCustomersRow.Item("acep_engine_4_ttsn_hours") = r("acep_engine_4_ttsn_hours")
          Else
            newCustomersRow.Item("other_acep_engine_4_ttsn_hours") = r("acep_engine_4_ttsn_hours")
          End If
        End If
        '---------------------------------------------TSOH HOurs----------------------------------------------
        If Not IsDBNull(r("acep_engine_1_tsoh_hours")) And Not IsDBNull(newCustomersRow.Item("other_acep_engine_1_tsoh_hours")) Then
          If newCustomersRow.Item("other_acep_engine_1_tsoh_hours") <> r("acep_engine_1_tsoh_hours") Then
            newCustomersRow.Item("acep_engine_1_tsoh_hours") = r("acep_engine_1_tsoh_hours")
          End If
        Else
          If repeated = True Then
            newCustomersRow.Item("acep_engine_1_tsoh_hours") = r("acep_engine_1_tsoh_hours")
          Else
            newCustomersRow.Item("other_acep_engine_1_tsoh_hours") = r("acep_engine_1_tsoh_hours")
          End If
        End If
        If Not IsDBNull(r("acep_engine_2_tsoh_hours")) And Not IsDBNull(newCustomersRow.Item("other_acep_engine_2_tsoh_hours")) Then
          If newCustomersRow.Item("other_acep_engine_2_tsoh_hours") <> r("acep_engine_2_tsoh_hours") Then
            newCustomersRow.Item("acep_engine_2_tsoh_hours") = r("acep_engine_2_tsoh_hours")
          End If
        Else
          If repeated = True Then
            newCustomersRow.Item("acep_engine_2_tsoh_hours") = r("acep_engine_2_tsoh_hours")
          Else
            newCustomersRow.Item("other_acep_engine_2_tsoh_hours") = r("acep_engine_2_tsoh_hours")
          End If
        End If
        If Not IsDBNull(r("acep_engine_3_tsoh_hours")) And Not IsDBNull(newCustomersRow.Item("other_acep_engine_3_tsoh_hours")) Then
          If newCustomersRow.Item("other_acep_engine_3_tsoh_hours") <> r("acep_engine_3_tsoh_hours") Then
            newCustomersRow.Item("acep_engine_3_tsoh_hours") = r("acep_engine_3_tsoh_hours")
          End If
        Else
          If repeated = True Then
            newCustomersRow.Item("acep_engine_3_tsoh_hours") = r("acep_engine_3_tsoh_hours")
          Else
            newCustomersRow.Item("other_acep_engine_3_tsoh_hours") = r("acep_engine_3_tsoh_hours")
          End If
        End If
        If Not IsDBNull(r("acep_engine_4_tsoh_hours")) And Not IsDBNull(newCustomersRow.Item("other_acep_engine_4_tsoh_hours")) Then
          If newCustomersRow.Item("other_acep_engine_4_tsoh_hours") <> r("acep_engine_4_tsoh_hours") Then
            newCustomersRow.Item("acep_engine_4_tsoh_hours") = r("acep_engine_4_tsoh_hours")
          End If
        Else
          If repeated = True Then
            newCustomersRow.Item("acep_engine_4_tsoh_hours") = r("acep_engine_4_tsoh_hours")
          Else
            newCustomersRow.Item("other_acep_engine_4_tsoh_hours") = r("acep_engine_4_tsoh_hours")
          End If
        End If
        '----------------------------------------------------------ESTIMATED PRICE---------------------------------------------
        If UCase(r("source")) = "CLIENT" Then
          newCustomersRow.Item("ac_est_price") = "<span class='client_row'>" & clsGeneral.clsGeneral.no_zero(r("ac_est_price"), "", True) & "</span>"
        End If
        '------------------------------------------------------------Contact ID-----------------------------------------------------
        'If Not IsDBNull(cont_id) And Not IsDBNull(r("contact_id")) Then
        '    If repeated = True Then
        '        If cont_id <> dalTable.Rows(b - 1).Item("contact_id") Then
        '            newCustomersRow.Item("contact_id") = cont_id '& other_cont_id
        '        End If
        '    Else
        '        newCustomersRow.Item("contact_id") = cont_id '& other_cont_id
        '    End If
        'Else
        '    newCustomersRow.Item("contact_id") = cont_id '& other_cont_id
        'End If
        '----------------------------------------------------AC Delivery---------------------------------------
        If Not IsDBNull(r("ac_delivery")) And Not IsDBNull(dalTable.Rows(b - 1).Item("ac_delivery")) Then
          If repeated = True Then
            If r("ac_delivery") <> dalTable.Rows(b - 1).Item("ac_delivery") Then
              newCustomersRow.Item("ac_delivery") = r("ac_delivery")
            End If
          Else
            newCustomersRow.Item("ac_delivery") = r("ac_delivery")
          End If
        Else
          newCustomersRow.Item("ac_delivery") = r("ac_delivery")
        End If
        '---------------------------------------------------Owner Percentage------------------------------------
        'If Not IsDBNull(acref_owner_percentage) And Not IsDBNull(r("acref_owner_percentage")) Then
        '    If repeated = True Then
        '        If acref_owner_percentage <> dalTable.Rows(b - 1).Item("acref_owner_percentage") Then
        '            newCustomersRow.Item("acref_owner_percentage") = acref_owner_percentage '& other_acref_owner_percentage
        '        End If
        '    Else
        '        newCustomersRow.Item("acref_owner_percentage") = acref_owner_percentage '& other_acref_owner_percentage
        '    End If
        'Else
        '    newCustomersRow.Item("acref_owner_percentage") = acref_owner_percentage '& other_acref_owner_percentage
        'End If

        '---------------------------------------------Company Source------------------------------
        'If Not IsDBNull(company_source) And Not IsDBNull(r("comp_source")) Then
        '    If repeated = True Then
        '        If acref_owner_percentage <> dalTable.Rows(b - 1).Item("comp_source") Then
        '            newCustomersRow.Item("comp_source") = company_source '& other_acref_owner_percentage
        '        End If
        '    Else
        '        newCustomersRow.Item("comp_source") = company_source '& other_acref_owner_percentage
        '    End If
        'Else
        '    newCustomersRow.Item("comp_source") = company_source '& other_acref_owner_percentage
        'End If

        '--------------------------------------------Source----------------------------------------
        If IsDBNull(newCustomersRow("other_source")) Then

          If IsDBNull(newCustomersRow.Item("source")) Then
            newCustomersRow.Item("source") = r("source")
          Else
            newCustomersRow.Item("other_source") = r("source")
          End If

        Else
          newCustomersRow.Item("source") = r("source")
        End If



        'Dim e As String = jetnet_ac_id
        'e = next_jetnet_id
        If acit <> next_ac Then
          If repeated = False Then
            repeat_counting = 0
            'repeatable_company = ""
            adatatable4.Rows.Add(newCustomersRow)

            adatatable4.AcceptChanges()
            'comp_name = ""
            'company_source = ""
            'cont_id = ""
            'acref_owner_percentage = ""
            'act_name = ""
            'name = ""
            'address = ""
            'address2 = ""
            'city = ""
            'state = ""
            'country = ""
            'zip = ""
            'email = ""
            'web = ""

            'first = ""
            'last = ""
            'middle = ""
            'title = ""
            'pref = ""
            'cemail = ""
            'notes = ""

            'other_comp_name = ""
            'other_cont_id = ""
            'other_acref_owner_percentage = ""
            'other_act_name = ""
            'other_name = ""
            'other_address = ""
            'other_address2 = ""
            'other_city = ""
            'other_state = ""
            'other_country = ""
            'other_zip = ""
            'other_email = ""
            'other_web = ""

            'other_first = ""
            'other_last = ""
            'other_middle = ""
            'other_title = ""
            'other_pref = ""
            'other_cemail = ""
            'other_notes = ""

            ' '
          End If
        End If
        ' End If

        old_ac_id = r("ac_id")
        b = b + 1
      Next

      Dim daltable2 As DataTable = adatatable4.Clone
      ', jetnet_ac_id asc
      If first_column = "AC_DATE_LISTED DESC" Then
        first_column = "OTHER_AC_DATE_LISTED DESC"
      ElseIf first_column = "AC_DATE_LISTED ASC" Then
        first_column = "OTHER_AC_DATE_LISTED ASC"
      ElseIf first_column = "AC_AIRFRAME_TOT_HRS DESC" Then
        first_column = "OTHER_AC_AIRFRAME_TOT_HRS DESC"
      ElseIf first_column = "AC_AIRFRAME_TOT_HRS ASC" Then
        first_column = "OTHER_AC_AIRFRAME_TOT_HRS ASC"
      ElseIf first_column = "AC_AIRFRAME_TOT_HRS ASC" Then
        first_column = "OTHER_AC_AIRFRAME_TOT_HRS ASC"
      ElseIf first_column = "AMOD_MAKE_NAME DESC, AMOD_MODEL_NAME DESC, AC_SER_NBR_SORT DESC" Then
        first_column = "AMOD_MAKE_NAME DESC, AMOD_MODEL_NAME DESC, AC_SER_NBR_SORT DESC"
      ElseIf first_column = "AMOD_MAKE_NAME ASC, AMOD_MODEL_NAME ASC, AC_SER_NBR_SORT ASC" Then
        first_column = "AMOD_MAKE_NAME ASC, AMOD_MODEL_NAME ASC, AC_SER_NBR_SORT ASC"
      ElseIf first_column = "AC_YEAR_MFR DESC" Then
        first_column = "OTHER_AC_YEAR_MFR DESC, AC_SER_NBR_SORT ASC"
      ElseIf first_column = "AC_YEAR_MFR ASC" Then
        first_column = "OTHER_AC_YEAR_MFR ASC, AC_SER_NBR_SORT ASC"
      ElseIf first_column = "AC_SER_NBR_SORT DESC" Then
        first_column = "AC_SER_NBR_SORT DESC"
      ElseIf first_column = "AC_SER_NBR_SORT ASC" Then
        first_column = "AC_SER_NBR_SORT ASC"
      ElseIf first_column = "AC_REG_NBR DESC" Then
        first_column = "OTHER_AC_REG_NBR DESC"
      ElseIf first_column = "AC_REG_NBR ASC" Then
        first_column = "OTHER_AC_REG_NBR ASC"
      End If



      Dim afiltered_Client2 As DataRow() = adatatable4.Select("", first_column & ", jetnet_ac_id asc")
      'Dim afiltered_Client2 As DataRow() = adatatable4.Select("", "")
      ' extract and import
      For Each atmpDataRow_Client2 In afiltered_Client2
        daltable2.ImportRow(atmpDataRow_Client2)
        ' Dim test As String = atmpDataRow_Client2("ac_airframe_tot_hrs")
      Next


      AC_Search = daltable2 'adatatable4

      atemptable = Nothing
      atemptable2 = Nothing
      dalTable = Nothing
      adatatable4 = Nothing


    Catch ex As Exception
      AC_Search = Nothing
      Me.class_error = "Error in AC_Search REVAMP(): SQL VERSION: jetnet models: " & jetnet_models & ", client models: " & client_models & " " & ex.Message
    Finally
      'SqlReader.Close()
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing

      'MySqlReader.Close()
      MySqlReader = Nothing


      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function

#End Region
#Region "Aircraft Features"
  Public Function GetJETNET_Aircraft_Details_Equipment_AC_ID(ByVal ac_id As Long) As DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable
    Try
      sql = "SELECT adet_ac_id, adet_action_date, adet_data_description, adet_data_name, adet_data_type, adet_id FROM aircraft_details WITH(NOLOCK) WHERE (adet_ac_id = " & ac_id & ") and adet_journ_id = 0 ORDER BY adet_ac_id, adet_data_type, adet_data_name"

      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      GetJETNET_Aircraft_Details_Equipment_AC_ID = atemptable
    Catch ex As Exception
      GetJETNET_Aircraft_Details_Equipment_AC_ID = Nothing
      Me.class_error = "Error in GetJETNET_Aircraft_Details_Equipment_AC_ID() SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function
  Public Function Get_Aircraft_Reference_Jetnet_acID(ByVal jetnetID As Long, ByVal journalID As Long) As DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable

    Try
      sql = "SELECT comp_name, comp_id, comp_country, comp_state, comp_city, cref_fraction_expires_date as acref_fraction_expires_date, cref_transmit_seq_no as acref_transmit_seq_no, "
      sql = sql & " contact_first_name,  contact_last_name, cref_id as acref_id, cref_ac_id as acref_ac_id, cref_contact_type as acref_contact_type, cref_journ_id, "
      sql = sql & " actype_name as act_name, contact_id as acref_contact_id,  'JETNET' AS source, "
      sql = sql & " cref_owner_percent as acref_owner_percentage "

      sql = sql & " , comp_phone_office,comp_web_address, comp_email_address "
      sql = sql & " , contact_title, contact_phone_office, contact_phone_mobile, contact_email_address "
      sql = sql & " , comp_id as acref_comp_id, cref_journ_id as comp_journ_id "
      sql = sql & " , contact_phone_office, contact_phone_mobile, contact_phone_fax "
      sql = sql & " , comp_name_alt_type, comp_name_alt, comp_address1, comp_address2, comp_zip_code "

      sql = sql & " , comp_phone_mobile, comp_phone_fax "


      sql = sql & " ,comp_id as contact_comp_id, contact_sirname, contact_middle_initial, contact_suffix  "
      sql = sql & " ,contact_title, contact_email_address, cref_journ_id as contact_journ_id, contact_id  "

      sql = sql & " FROM  Aircraft_Company_Flat with (NOLOCK)  "
      ' sql = sql & " FROM Aircraft_Reference with (NOLOCK)  "
      ' sql = sql & " INNER JOIN Aircraft_Contact_Type with (NOLOCK)  ON cref_contact_type = actype_code "
      ' sql = sql & " inner join company with (NOLOCK) on cref_comp_id=comp_id and company.comp_journ_id = aircraft_reference.cref_journ_id "
      ' sql = sql & " left outer join contact with (NOLOCK) on  cref_contact_id = contact_id and aircraft_reference.cref_journ_id = contact.contact_journ_id and contact_hide_flag='N' "
      sql = sql & " WHERE  (cref_ac_id = " & jetnetID & " and cref_journ_id = " & journalID & " ) "

      If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag Then
        sql = sql & " and Cref_contact_type NOT IN ('93','98','99','71', '38') "   ','44' ADDED BACK IN 
      Else
        sql = sql & " AND cref_contact_type NOT IN ('71') "
      End If

      sql = sql & " AND comp_hide_flag = 'N' "

      sql = sql & " order by cref_transmit_seq_no asc, cref_contact_type  "


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Get_Aircraft_Reference_Jetnet_acID = atemptable

    Catch ex As Exception
      Get_Aircraft_Reference_Jetnet_acID = Nothing
      Me.class_error = "Error in Get_Aircraft_Reference_Jetnet_acID(ByVal jetnetID As Integer) SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try



  End Function
  Public Function Get_Aircraft_Reference_Jetnet_acID_CURRENT_COMPANY(ByVal jetnetID As Long, ByVal journalID As Long) As DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable

    Try
      sql = "SELECT comp_name, comp_id, comp_country, comp_state, comp_city, cref_fraction_expires_date as acref_fraction_expires_date, cref_transmit_seq_no as acref_transmit_seq_no, "
      sql = sql & " contact_first_name,  contact_last_name, cref_id as acref_id, cref_ac_id as acref_ac_id, cref_contact_type as acref_contact_type, cref_journ_id, "
      sql = sql & " actype_name as act_name, contact_id as acref_contact_id,  'JETNET' AS source, "
      sql = sql & " cref_owner_percent as acref_owner_percentage "

      sql = sql & " , comp_web_address, comp_email_address "
      sql = sql & " , contact_title,  contact_email_address "
      sql = sql & " , comp_id as acref_comp_id, 0 as comp_journ_id "

      sql = sql & " , comp_name_alt_type, comp_name_alt, comp_address1, comp_address2, comp_zip_code "

      sql = sql & ", (select top 1 pnum_number_full from Phone_Numbers where pnum_type ='Office' and comp_id = pnum_comp_id and pnum_contact_id =0 and pnum_journ_id=0) as comp_phone_office,"
      sql = sql & " (select top 1 pnum_number_full from Phone_Numbers where pnum_type ='Fax' and comp_id = pnum_comp_id and pnum_contact_id =0 and pnum_journ_id=0) as comp_phone_fax,"
      sql = sql & " (select top 1 pnum_number_full from Phone_Numbers where pnum_type ='Mobile' and comp_id = pnum_comp_id and pnum_contact_id =0 and pnum_journ_id=0) as comp_phone_mobile"

      sql = sql & ", (select top 1 pnum_number_full from Phone_Numbers where pnum_type ='Office' and comp_id = pnum_comp_id and pnum_contact_id =contact_id and pnum_journ_id=0) as contact_phone_office,"
      sql = sql & " (select top 1 pnum_number_full from Phone_Numbers where pnum_type ='Fax' and comp_id = pnum_comp_id and pnum_contact_id =contact_id and pnum_journ_id=0) as contact_phone_fax,"
      sql = sql & " (select top 1 pnum_number_full from Phone_Numbers where pnum_type ='Mobile' and comp_id = pnum_comp_id and pnum_contact_id =contact_id and pnum_journ_id=0) as contact_phone_mobile"


      sql = sql & " ,comp_id as contact_comp_id, contact_sirname, contact_middle_initial, contact_suffix  "
      sql = sql & " ,contact_title, contact_email_address, contact_journ_id, contact_id  "

      'sql = sql & " FROM  Aircraft_Company_Flat with (NOLOCK)  "
      sql = sql & " FROM Aircraft_Reference with (NOLOCK)  "
      sql = sql & " INNER JOIN Aircraft_Contact_Type with (NOLOCK)  ON cref_contact_type = actype_code "
      sql = sql & " inner join company with (NOLOCK) on cref_comp_id=comp_id and company.comp_journ_id = 0 "
      sql = sql & " left outer join contact with (NOLOCK) on  cref_contact_id = contact_id and contact_journ_id = 0 and contact_hide_flag='N' "
      sql = sql & " WHERE  (cref_ac_id = " & jetnetID & " and cref_journ_id = " & journalID & " ) "

      If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag Then
        sql = sql & " and Cref_contact_type NOT IN ('93','98','99','71', '38') "   ','44' ADDED BACK IN 
      Else
        sql = sql & " AND cref_contact_type NOT IN ('71') "
      End If

      sql = sql & " AND comp_hide_flag = 'N' "

      sql = sql & " order by cref_transmit_seq_no asc, cref_contact_type  "


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Get_Aircraft_Reference_Jetnet_acID_CURRENT_COMPANY = atemptable

    Catch ex As Exception
      Get_Aircraft_Reference_Jetnet_acID_CURRENT_COMPANY = Nothing
      Me.class_error = "Error in Get_Aircraft_Reference_Jetnet_acID_CURRENT_COMPANY(ByVal jetnetID As Integer) SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try



  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: GetJETNET_Aircraft_Details_Equipment_AC_ID_TYPE
  ' Purpose: to get aircraft details
  ' Parameters: AC_ID
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/1/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function GetJETNET_Aircraft_Details_Equipment_AC_ID_TYPE(ByVal ac_id As Long, ByVal type As String, ByVal journ_ID As Long) As DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable
    Try
      sql = "SELECT  distinct aircraft_details.adet_ac_id, aircraft_details.adet_data_name, aircraft_details.adet_data_type, adt_seq_no, "
      sql = sql & " replace(replace(replace(STUFF((select adet_data_description + ', ' as adet_data_description from aircraft_details a2 where a2.adet_ac_id = aircraft_details.adet_ac_id and a2.adet_data_type = aircraft_details.adet_data_type and a2.adet_data_name = aircraft_details.adet_data_name and a2.adet_journ_id = aircraft_details.adet_journ_id FOR XML PATH('')),1,1,''), '<adet_data_description>', ''), '</adet_data_description>', ''), 'adet_data_description>', '') as adet_data_description "
      sql = sql & "  FROM aircraft_details WITH(NOLOCK) "
      sql = sql & " inner join Aircraft_Data_Type WITH(NOLOCK) on adet_data_type=adt_data_type and adet_data_name=adt_data_name "
      sql = sql & " WHERE "
      sql = sql & " (aircraft_details.adet_ac_id = " & ac_id & ") AND (aircraft_details.adet_data_type in ('" & type & "')) AND (aircraft_details.adet_journ_id = " & journ_ID & ") ORDER BY adt_seq_no"


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      GetJETNET_Aircraft_Details_Equipment_AC_ID_TYPE = atemptable
    Catch ex As Exception
      GetJETNET_Aircraft_Details_Equipment_AC_ID_TYPE = Nothing
      Me.class_error = "Error in GetJETNET_Aircraft_Details_Equipment_AC_ID_TYPE(ByVal ac_id As long, ByVal type As String,  journID as long) As DataTable SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function

  Public Function GetJETNET_Aircraft_Maintenance_BY_ACID(ByVal ac_id As Long, ByVal journ_ID As Long) As DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable
    Try
      sql = "SELECT * from aircraft_maintenance with (NOLOCK)  "
      sql = sql & " WHERE "
      sql = sql & " (aircraft_maintenance.acmaint_ac_id = " & ac_id & ")  AND (aircraft_maintenance.acmaint_journ_id = " & journ_ID & ") "
      sql = sql & " order by acmaint_complied_date asc "

      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      GetJETNET_Aircraft_Maintenance_BY_ACID = atemptable
    Catch ex As Exception
      GetJETNET_Aircraft_Maintenance_BY_ACID = Nothing
      Me.class_error = "Error in GetJETNET_Aircraft_Details_Equipment_AC_ID_TYPE(ByVal ac_id As long, ByVal type As String,  journID as long) As DataTable SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function

  Public Function GetJETNET_Aircraft_Details_Key_Features_AC_ID(ByVal ac_id As Long, ByVal journID As Long) As DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable

    Try

      sql = " SELECT kfeat_name, Key_Feature.kfeat_code, Aircraft_Key_Feature.afeat_status_flag as kff_name, kfeat_code as kfeat_type, "
      sql = sql & " Aircraft_Key_Feature.afeat_ac_id, Aircraft_Key_Feature.afeat_status_flag as afeat_flag, Aircraft_Key_Feature.afeat_seq_no as afeat_seq_nbr"
      sql = sql & " FROM Aircraft_Key_Feature with (NOLOCK) "
      sql = sql & " INNER JOIN Key_Feature with (NOLOCK) ON Aircraft_Key_Feature.afeat_feature_code = Key_Feature.kfeat_code"
      sql = sql & " WHERE kfeat_inactive_date IS NULL and Aircraft_Key_Feature.afeat_ac_id = " & ac_id
      sql = sql & " AND afeat_journ_id = " & journID
      sql = sql & " ORDER BY Aircraft_Key_Feature.afeat_seq_no"


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      GetJETNET_Aircraft_Details_Key_Features_AC_ID = atemptable

    Catch ex As Exception
      GetJETNET_Aircraft_Details_Key_Features_AC_ID = Nothing
      Me.class_error = "Error in GetJETNET_Aircraft_Details_Key_Features_AC_ID() SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function

  Public Function GetJETNET_Aircraft_Details_Ordered_Features_AC_ID(ByVal ac_id As Long, ByVal journID As Long) As DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable

    Try

      sql = " SELECT amfeat_feature_code, amfeat_standard_equip, kfeat_name, Key_Feature.kfeat_code, Aircraft_Key_Feature.afeat_status_flag as kff_name, "
      sql += " kfeat_code as kfeat_type, "
      sql += " Aircraft_Key_Feature.afeat_ac_id, Aircraft_Key_Feature.afeat_status_flag as afeat_flag, Aircraft_Key_Feature.afeat_seq_no as afeat_seq_nbr"
      sql += " FROM Aircraft_Key_Feature with (NOLOCK) "
      sql += " INNER JOIN Key_Feature with (NOLOCK) ON Aircraft_Key_Feature.afeat_feature_code = Key_Feature.kfeat_code"
      sql += " inner join Aircraft with (NOLOCK) on ac_id = afeat_ac_id and afeat_journ_id = ac_journ_id "
      sql += " left outer join Aircraft_Model_Key_Feature on amfeat_feature_code = kfeat_code and amfeat_amod_id = ac_amod_id"
      sql += " WHERE(kfeat_inactive_date Is NULL And Aircraft_Key_Feature.afeat_ac_id = " & ac_id & ")"
      sql += " AND afeat_journ_id = " & journID
      sql += " ORDER BY afeat_flag desc, amfeat_standard_equip asc"



      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      GetJETNET_Aircraft_Details_Ordered_Features_AC_ID = atemptable

    Catch ex As Exception
      GetJETNET_Aircraft_Details_Ordered_Features_AC_ID = Nothing
      Me.class_error = "Error in GetJETNET_Aircraft_Details_Ordered_Features_AC_ID() SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function
  Public Function GetJETNET_Aircraft_Engine(ByVal ac_id As Long) As DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable

    Try
      sql = "SELECT ac_id, ac_engine_name, ac_engine_maintenance_prog_EMP, ac_engine_management_prog_EMGP, ac_engine_tbo_oc_flag, "
      sql = sql & " ac_engine_noise_rating, ac_model_config, ac_maint_eoh_by_name, ac_main_eoh_moyear, ac_maint_hots_by_name, "
      sql = sql & " ac_maint_hots_moyear, ac_engine_1_ser_no, ac_engine_2_ser_no, ac_engine_3_ser_no, "
      sql = sql & " ac_engine_4_ser_no, ac_engine_1_tot_hrs, ac_engine_2_tot_hrs, ac_engine_3_tot_hrs, "
      sql = sql & "  ac_engine_4_tot_hrs, ac_engine_1_soh_hrs, ac_engine_2_soh_hrs, ac_engine_3_soh_hrs, "
      sql = sql & " ac_engine_4_soh_hrs, ac_engine_1_shi_hrs, ac_engine_2_shi_hrs, ac_engine_3_shi_hrs, "
      sql = sql & " ac_engine_4_shi_hrs, ac_engine_1_tbo_hrs, ac_engine_2_tbo_hrs, ac_engine_3_tbo_hrs, "
      sql = sql & " ac_engine_4_tbo_hrs, ac_engine_1_snew_cycles, ac_engine_2_snew_cycles, ac_engine_3_snew_cycles, "
      sql = sql & "  ac_engine_4_snew_cycles, ac_engine_1_soh_cycles, ac_engine_2_soh_cycles, ac_engine_3_soh_cycles, "
      sql = sql & " ac_engine_4_soh_cycles,ac_engine_1_shs_cycles,ac_engine_2_shs_cycles,ac_engine_3_shs_cycles, "
      sql = sql & "  ac_engine_4_shs_cycles, '' as emp_provider_name, "
      sql = sql & "  '' as emp_program_name, '' as emgp_provider_name, "
      sql = sql & "  '' as emgp_program_name"
      sql = sql & " FROM ((Aircraft with (NOLOCK) INNER JOIN"
      sql = sql & "  Engine_Maintenance_Program WITH(NOLOCK) ON ac_engine_maintenance_prog_EMP = Engine_Maintenance_Program.emp_id) INNER JOIN"
      sql = sql & "  Engine_Management_Program WITH(NOLOCK) ON ac_engine_management_prog_EMGP = Engine_Management_Program.emgp_id) "
      sql = sql & " WHERE   ac_id = " & ac_id
      sql = sql & " and ac_journ_id = 0 ORDER BY   ac_id"


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try


      GetJETNET_Aircraft_Engine = atemptable
    Catch ex As Exception
      GetJETNET_Aircraft_Engine = Nothing
      Me.class_error = "Error in GetJETNET_Aircraft_Engine() SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function
  Public Function GetJETNET_Aircraft_Avionics_AC_ID(ByVal ac_id As Long, ByVal journID As Long) As DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable
    Try
      sql = "SELECT av_ac_id, av_name, av_description"
      sql = sql & " FROM aircraft_avionics with (NOLOCK) "
      sql = sql & "WHERE (av_ac_id = " & ac_id & ") and av_ac_journ_id = " & journID
      sql = sql & " ORDER BY av_ac_id, av_name, av_description"


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      GetJETNET_Aircraft_Avionics_AC_ID = atemptable
    Catch ex As Exception
      GetJETNET_Aircraft_Avionics_AC_ID = Nothing
      Me.class_error = "Error in GetJETNET_Aircraft_Avionics_AC_ID() SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try


  End Function


#End Region
#Region "Aircraft Company Display"
  ''' <summary>
  ''' Aircraft Listing on Company Details Page. This lists all the AC on the company page.
  ''' </summary>
  ''' <param name="compID"></param>
  ''' <param name="Helicopter"></param>
  ''' <param name="Business"></param>
  ''' <param name="Commercial"></param>
  ''' <param name="Jets"></param>
  ''' <param name="Executive"></param>
  ''' <param name="Turboprops"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function GetAircraft_Listing_compid(ByVal compID As Long, ByVal Helicopter As Boolean, ByVal Business As Boolean, ByVal Commercial As Boolean, ByVal Jets As Boolean, ByVal Executive As Boolean, ByVal Turboprops As Boolean, ByVal journalID As Long, ByVal aerodex As Boolean, Optional ByVal amod_id As Long = 0, Optional ByVal use_insight_roll As Boolean = False) As DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable
    Try
      sql = " SELECT DISTINCT "
      sql = sql & " aircraft.ac_id, aircraft.ac_amod_id, Aircraft.ac_ser_no as ac_ser_nbr, Aircraft.ac_reg_no as ac_reg_nbr, Aircraft.ac_airframe_tot_hrs as ac_airframe_total_hours, aircraft_model.amod_make_name, "
      sql = sql & " Aircraft_Model.amod_type_code as amod_make_type, ac_year, aircraft_model.amod_model_name, company.comp_name, company.comp_country, company.comp_state, company.comp_city, "
      sql = sql & " aircraft.ac_status, Aircraft.ac_mfr_year as ac_year_mfr, contact.contact_sirname, contact.contact_title, contact.contact_first_name, contact.contact_middle_initial, contact.contact_last_name, "
      sql = sql & " contact.contact_suffix, Aircraft_Contact_Type.actype_name as act_name, aircraft.ac_forsale_flag, aircraft.ac_exclusive_flag, Aircraft.ac_asking as ac_asking_wordage, "
      sql = sql & " aircraft.ac_asking_price, ac_ser_no_full, cref_transmit_seq_no, "
      sql = sql & " aircraft.ac_list_date as ac_date_listed, aircraft.ac_product_business_flag, aircraft.ac_product_helicopter_flag, aircraft.ac_product_commercial_flag, aircraft.ac_lease_flag, "
      sql = sql & " company.comp_id, contact.contact_id, 'JETNET' AS source, aircraft.ac_delivery, aircraft_reference.cref_owner_percent as acref_owner_percentage "
      sql = sql & ", aport_name, aport_state, aport_city, aport_country "
      sql = sql & ", aircraft.ac_aport_name, aircraft.ac_aport_state, aircraft.ac_aport_country, aircraft.ac_aport_city, ac_engine_name "

      sql = sql & " FROM company with (NOLOCK) "
      sql = sql & " INNER JOIN aircraft_reference with (NOLOCK) ON company.comp_id = aircraft_reference.cref_comp_id and company.comp_journ_id = aircraft_reference.cref_journ_id"
      sql = sql & " INNER JOIN aircraft with (NOLOCK) ON aircraft_reference.cref_ac_id = aircraft.ac_id and aircraft_reference.cref_journ_id = aircraft.ac_journ_id"
      sql = sql & " INNER JOIN aircraft_model with (NOLOCK) ON aircraft.ac_amod_id = aircraft_model.amod_id "
      sql = sql & " LEFT OUTER JOIN contact with (NOLOCK) ON aircraft_reference.cref_contact_id = contact.contact_id and aircraft_reference.cref_journ_id = contact.contact_journ_id and contact_hide_flag='N' "
      sql = sql & " left outer join airport with (NOLOCK) on aport_id =  ac_aport_id "
      sql = sql & " INNER JOIN aircraft_contact_type with (NOLOCK) ON aircraft_reference.cref_contact_type = aircraft_contact_type.actype_code  "

      If use_insight_roll = True Then
        sql = sql & " WHERE   comp_journ_id = " & journalID
        sql = sql & " and comp_id in (select distinct RelCompID from ReturnAllCompanyLocationsByCompId(" & compID & ")) "
      Else
        sql = sql & " WHERE (company.comp_id = " & compID & ") and comp_journ_id = " & journalID
      End If


      If HttpContext.Current.Session.Item("localUser").crmEvo = True Then
        sql &= " and ((ac_lifecycle_stage <> 4 ) or (lower(ac_status) = 'withdrawn from use - stored')) "
      End If

      If aerodex Then
        sql &= " AND cref_contact_type NOT IN ('93','98','99','71','38')"
      Else
        sql &= " AND cref_contact_type NOT IN ('71')"
      End If

      If amod_id > 0 Then
        sql = sql & " and (aircraft.ac_amod_id = " & amod_id & ")"
      End If


      sql = sql & " " & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(HttpContext.Current.Session.Item("localSubscription"), False, True)

      'sql = sql & " order by amod_make_name, amod_model_name, ac_ser_no, cref_transmit_seq_no"
      sql = sql & " order by amod_make_name, amod_model_name, ac_ser_no_full, cref_transmit_seq_no "



      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      GetAircraft_Listing_compid = atemptable
    Catch ex As Exception
      GetAircraft_Listing_compid = Nothing
      Me.class_error = "Error in GetAircraft_Listing_compid(ByVal compID As Long, ByVal Helicopter As Boolean, ByVal Business As Boolean, ByVal Commercial As Boolean, ByVal Jets As Boolean, ByVal Executive As Boolean, ByVal Turboprops As Boolean, ByVal journalID As Long, ByVal aerodex As Boolean) As DataTable SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function


  Public Sub LoopAndCombineClientJetnet(ByRef ClientTable As DataTable, ByRef JetnetTable As DataTable, ByRef ReturnTable As DataTable)
    Dim column As New DataColumn 'Column to Add id to jetnet data
    Dim IDsToExclude As String = ""

    column.DataType = System.Type.GetType("System.Int64")
    column.DefaultValue = 0
    column.Unique = False
    column.ColumnName = "jetnet_ac_id"
    JetnetTable.Columns.Add(column)


    'Loop through each row on client side
    For Each drRow As DataRow In ClientTable.Rows
      If IDsToExclude <> "" Then
        IDsToExclude += ", "
      End If
      IDsToExclude += drRow("jetnet_ac_id").ToString
    Next

    'Copying data so return table has client data in it.
    ReturnTable = ClientTable.Copy

    'Filtering IDs or not
    If IDsToExclude <> "" Then
      Dim afiltered_Jetnet As DataRow() = JetnetTable.Select(" ac_id not in (" & IDsToExclude & ") ", "")
      For Each drJetnet In afiltered_Jetnet
        ReturnTable.ImportRow(drJetnet)
      Next
    Else
      'Nothing to exclude, so we go ahead and import the jetnet data as is.
      For Each drRow As DataRow In JetnetTable.Rows
        ReturnTable.ImportRow(drRow)
      Next
    End If

  End Sub
  Public Function Client_As_Jetnet_Fields_GetAircraft_Listing_compid(ByVal compID As Long, ByVal Helicopter As Boolean, ByVal Business As Boolean, ByVal Commercial As Boolean, ByVal Jets As Boolean, ByVal Executive As Boolean, ByVal Turboprops As Boolean, ByVal journalID As Long, ByVal aerodex As Boolean) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim ReturnTable As New DataTable
    Try

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()

      ReturnTable.Columns.Add("ac_id")
      ReturnTable.Columns.Add("jetnet_ac_id")
      ReturnTable.Columns.Add("ac_amod_id")
      ReturnTable.Columns.Add("ac_ser_nbr")
      ReturnTable.Columns.Add("ac_reg_nbr")
      ReturnTable.Columns.Add("ac_airframe_total_hours")
      ReturnTable.Columns.Add("amod_make_name")
      ReturnTable.Columns.Add("amod_make_type")
      ReturnTable.Columns.Add("ac_year")
      ReturnTable.Columns.Add("amod_model_name")
      ReturnTable.Columns.Add("comp_name")
      ReturnTable.Columns.Add("comp_country")
      ReturnTable.Columns.Add("comp_city")
      ReturnTable.Columns.Add("comp_state")
      ReturnTable.Columns.Add("ac_status")
      ReturnTable.Columns.Add("ac_year_mfr")
      ReturnTable.Columns.Add("contact_sirname")
      ReturnTable.Columns.Add("contact_title")
      ReturnTable.Columns.Add("contact_first_name")
      ReturnTable.Columns.Add("contact_middle_initial")
      ReturnTable.Columns.Add("contact_last_name")
      ReturnTable.Columns.Add("contact_suffix")
      ReturnTable.Columns.Add("act_name")
      ReturnTable.Columns.Add("ac_forsale_flag")
      ReturnTable.Columns.Add("ac_exclusive_flag")
      ReturnTable.Columns.Add("ac_asking_wordage")
      ReturnTable.Columns.Add("ac_asking_price")
      ReturnTable.Columns.Add("ac_ser_no_full")
      ReturnTable.Columns.Add("cref_transmit_seq_no")
      ReturnTable.Columns.Add("ac_date_listed")
      ReturnTable.Columns.Add("ac_product_business_flag")
      ReturnTable.Columns.Add("ac_product_helicopter_flag")
      ReturnTable.Columns.Add("ac_product_commercial_flag")
      ReturnTable.Columns.Add("ac_lease_flag")
      ReturnTable.Columns.Add("comp_id")
      ReturnTable.Columns.Add("contact_id")
      ReturnTable.Columns.Add("source")
      ReturnTable.Columns.Add("ac_delivery")
      ReturnTable.Columns.Add("acref_owner_percentage")

      sql = " SELECT DISTINCT "
      sql += " cliaircraft_id as ac_id, "
      sql += " cliaircraft_jetnet_ac_id as jetnet_ac_id, "
      sql += " cliaircraft_cliamod_id as ac_amod_id, "
      sql += " cliaircraft_ser_nbr as ac_ser_nbr, "
      sql += " cliaircraft_reg_nbr as ac_reg_nbr, "
      sql += " cliaircraft_airframe_total_hours as ac_airframe_total_hours, "
      sql += " cliamod_make_name as amod_make_name, "
      sql += " cliamod_make_type as amod_make_type, "
      sql += " cliaircraft_year_dlv as ac_year, "
      sql += " cliamod_model_name as amod_model_name, "
      sql += " clicomp_name as comp_name, "
      sql += " clicomp_country as comp_country, "
      sql += " clicomp_state as comp_state, "
      sql += " clicomp_city as comp_city, "
      sql += " cliaircraft_status as ac_status, "
      sql += " cliaircraft_year_mfr as ac_year_mfr, "
      sql += " clicontact_sirname as contact_sirname, "
      sql += " clicontact_title as contact_title, "
      sql += " clicontact_first_name as contact_first_name, "
      sql += " clicontact_middle_initial as contact_middle_initial,  "
      sql += " clicontact_last_name as contact_last_name, "
      sql += " clicontact_suffix as contact_suffix, "
      sql += " cliact_name as act_name, "
      sql += " cliaircraft_forsale_flag ac_forsale_flag, "
      sql += " cliaircraft_exclusive_flag as ac_exclusive_flag, "
      sql += " cliaircraft_asking_wordage as ac_asking_wordage, "
      sql += " cliaircraft_asking_price as ac_asking_price, "
      sql += " cliaircraft_ser_nbr as ac_ser_no_full, "
      sql += " 0 as cref_transmit_seq_no, "
      sql += " cliaircraft_date_listed as ac_date_listed, "
      sql += " cliaircraft_product_business_flag as ac_product_business_flag, "
      sql += " cliaircraft_product_helicopter_flag as ac_product_helicopter_flag, "
      sql += " cliaircraft_product_commercial_flag as ac_product_commercial_flag, "
      sql += " cliaircraft_lease_flag as ac_lease_flag, "
      sql += " clicomp_id as comp_id, "
      sql += " clicontact_id as contact_id, "
      sql += "'CLIENT' AS source, "
      sql += " cliaircraft_delivery as ac_delivery, "
      sql += " cliacref_owner_percentage as acref_owner_percentage "
      sql += " FROM client_company "
      sql += " INNER JOIN client_aircraft_reference ON client_company.clicomp_id = cliacref_comp_id "
      sql += " INNER JOIN client_aircraft ON client_aircraft_reference.cliacref_cliac_id = client_aircraft.cliaircraft_id "
      sql += " INNER JOIN client_aircraft_model ON client_aircraft.cliaircraft_cliamod_id = client_aircraft_model.cliamod_id "
      sql += " LEFT OUTER JOIN client_contact ON client_aircraft_reference.cliacref_contact_id = client_contact.clicontact_id "
      sql += " INNER JOIN client_aircraft_contact_type ON client_aircraft_reference.cliacref_contact_type = cliact_type  "
      sql += " WHERE (client_company.clicomp_id = @CompanyID) "

      If aerodex Then
        sql &= " AND cliacref_contact_type NOT IN ('93','98','99','71','38')"
      Else
        sql &= " AND cliacref_contact_type NOT IN ('71')"
      End If

      sql = sql & " order by cliamod_make_name, cliamod_model_name, cliaircraft_ser_nbr "

      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand(sql, MySqlConn)
      MySqlCommand.Parameters.AddWithValue("@CompanyID", compID)

      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      While MySqlReader.Read()
        Dim newCustomersRow As DataRow = ReturnTable.NewRow()
        newCustomersRow("ac_id") = MySqlReader.Item("ac_id")

        newCustomersRow("jetnet_ac_id") = MySqlReader.Item("jetnet_ac_id")
        newCustomersRow("ac_amod_id") = MySqlReader.Item("ac_amod_id")

        newCustomersRow("ac_ser_nbr") = MySqlReader.Item("ac_ser_nbr")
        newCustomersRow("ac_reg_nbr") = MySqlReader.Item("ac_reg_nbr")
        newCustomersRow("ac_airframe_total_hours") = MySqlReader.Item("ac_airframe_total_hours")
        newCustomersRow("amod_make_name") = MySqlReader.Item("amod_make_name")
        newCustomersRow("amod_make_type") = MySqlReader.Item("amod_make_type")
        newCustomersRow("ac_year") = MySqlReader.Item("ac_year")
        newCustomersRow("amod_model_name") = MySqlReader.Item("amod_model_name")

        newCustomersRow("comp_name") = MySqlReader.Item("comp_name")
        newCustomersRow("comp_country") = MySqlReader.Item("comp_country")
        newCustomersRow("comp_city") = MySqlReader.Item("comp_city")
        newCustomersRow("comp_state") = MySqlReader.Item("comp_state")
        newCustomersRow("ac_status") = MySqlReader.Item("ac_status")
        newCustomersRow("ac_year_mfr") = MySqlReader.Item("ac_year_mfr")
        newCustomersRow("contact_sirname") = MySqlReader.Item("contact_sirname")
        newCustomersRow("contact_title") = MySqlReader.Item("contact_title")

        newCustomersRow("contact_first_name") = MySqlReader.Item("contact_first_name")
        newCustomersRow("contact_middle_initial") = MySqlReader.Item("contact_middle_initial")
        newCustomersRow("contact_last_name") = MySqlReader.Item("contact_last_name")
        newCustomersRow("contact_suffix") = MySqlReader.Item("contact_suffix")
        newCustomersRow("act_name") = MySqlReader.Item("act_name")
        newCustomersRow("ac_forsale_flag") = MySqlReader.Item("ac_forsale_flag")
        newCustomersRow("ac_exclusive_flag") = MySqlReader.Item("ac_exclusive_flag")
        newCustomersRow("ac_asking_wordage") = MySqlReader.Item("ac_asking_wordage")
        newCustomersRow("ac_asking_price") = MySqlReader.Item("ac_asking_price")
        newCustomersRow("ac_ser_no_full") = MySqlReader.Item("ac_ser_no_full")
        newCustomersRow("cref_transmit_seq_no") = MySqlReader.Item("cref_transmit_seq_no")
        newCustomersRow("ac_date_listed") = MySqlReader.Item("ac_date_listed")
        newCustomersRow("ac_product_business_flag") = MySqlReader.Item("ac_product_business_flag")
        newCustomersRow("ac_product_helicopter_flag") = MySqlReader.Item("ac_product_helicopter_flag")
        newCustomersRow("ac_product_commercial_flag") = MySqlReader.Item("ac_product_commercial_flag")
        newCustomersRow("ac_lease_flag") = MySqlReader.Item("ac_lease_flag")
        newCustomersRow("comp_id") = MySqlReader.Item("comp_id")
        newCustomersRow("contact_id") = MySqlReader.Item("contact_id")
        newCustomersRow("source") = MySqlReader.Item("source")
        newCustomersRow("ac_delivery") = MySqlReader.Item("ac_delivery")
        newCustomersRow("acref_owner_percentage") = MySqlReader.Item("acref_owner_percentage")

        ReturnTable.Rows.Add(newCustomersRow)
        ReturnTable.AcceptChanges()
      End While

      MySqlCommand.Dispose()
      MySqlCommand = Nothing

      Return ReturnTable
    Catch ex As Exception
      Return Nothing
      Me.class_error = "Error in Client_As_Jetnet_Fields_GetAircraft_Listing_compid(ByVal compID As Long, ByVal Helicopter As Boolean, ByVal Business As Boolean, ByVal Commercial As Boolean, ByVal Jets As Boolean, ByVal Executive As Boolean, ByVal Turboprops As Boolean, ByVal journalID As Long, ByVal aerodex As Boolean) As DataTable SQL VERSION: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
    End Try

  End Function
#End Region
#Region "Aircraft Models"
  ''' <summary>
  ''' This lists all the aircraft model types used for the evolution aircraft search.
  ''' </summary>
  ''' <param name="Helicopter_Flag"></param>
  ''' <param name="Business_Flag"></param>
  ''' <param name="Commercial_Flag"></param> 
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function GetAircraft_Type(ByVal Helicopter_Flag As Boolean, ByVal Business_Flag As Boolean, ByVal Commercial_Flag As Boolean, ByVal amod_IDs As String)
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim TempTable As New DataTable

    Try
      Dim query As String = ""
      Dim where As String = ""

      query = "select distinct amod_airframe_type_code, amod_type_code, afmt_description as atype_name, amod_product_commercial_flag, amod_product_business_flag, amod_product_helicopter_flag "
      query = query & "from aircraft_type with (nolock) "
      query = query & "inner join aircraft_model with (nolock) on amod_type_code=atype_code "
      query = query & "inner join airframe_make_type with (nolock) on amod_airframe_type_code = afmt_airframetype and afmt_airframemaketype = amod_type_code "
      query = query & "where amod_customer_flag = 'Y' "

      If amod_IDs <> "" Then
        query = query & " and amod_id in (" & amod_IDs & ")"
      End If

      where = where & " " & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(HttpContext.Current.Session.Item("localSubscription"), False, False)

      where = where & "order by amod_airframe_type_code asc, amod_type_code asc "



      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString

      query = query & where


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, query.ToString)

      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = query
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        TempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = TempTable.GetErrors()
      End Try
      Return TempTable
    Catch ex As Exception
      GetAircraft_Type = Nothing
      Me.class_error = "Error in GetAircraft_Type() SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing

    End Try

  End Function

  ''' <summary>
  '''    'create a datatable for above so timeout errors don't kill the page on searches
  ''' </summary>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Create_Type_DataTable() As DataTable
    Dim aTempTable As New DataTable
    aTempTable.Columns.Add("amod_airframe_type_code")
    aTempTable.Columns.Add("amod_type_code")
    aTempTable.Columns.Add("atype_name")
    aTempTable.Columns.Add("amod_product_commercial_flag")
    aTempTable.Columns.Add("amod_product_business_flag")
    aTempTable.Columns.Add("amod_product_helicopter_flag")
    Return aTempTable
  End Function

  Public Function GetAircraft_MakeModels(ByVal amod_make_name As String, ByVal amod_model_name As String, ByVal Helicopter As Boolean, ByVal Business As Boolean, ByVal Commercial As Boolean, ByVal Jets As Boolean, ByVal Executive As Boolean, ByVal Turboprops As Boolean, ByVal AMOD_IDs As String) As DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim TempTable As New DataTable

    Try
      Dim query As String
      query = "select amod_id, amod_type_code,amod_airframe_type_code, atype_code as amod_make_type_code,amod_picture_exists_flag, amod_make_name, amod_model_name, amod_make_abbrev As MakeAbbrev, "
      query = query & " amod_product_commercial_flag, amod_product_business_flag, "
      query = query & " amod_product_helicopter_flag, 'JETNET' as source, '0' as client_id, "
      query = query & " atype_code, atype_name from aircraft_model with (nolock) inner join "
      query = query & " aircraft_type with (nolock) on atype_code = amod_type_code "
      query = query & " where  "

      query = query & " amod_customer_flag = 'Y' "

      If AMOD_IDs <> "" Then
        query = query & " and (amod_id in (" & AMOD_IDs & ")) "
      End If

      If amod_make_name <> "" Then
        query = query & " and amod_make_name like '" & amod_make_name & "' "
      End If

      If amod_model_name <> "" Then
        query = query & " and amod_model_name like '" & amod_model_name & "' "
      End If
      Dim crmSubScriptionCls As New crmSubscriptionClass
      crmSubScriptionCls.crmAerodexFlag = False
      crmSubScriptionCls.crmBusiness_Flag = Business
      crmSubScriptionCls.crmCommercial_Flag = Commercial
      crmSubScriptionCls.crmHelicopter_Flag = Helicopter
      crmSubScriptionCls.crmJets_Flag = Jets
      crmSubScriptionCls.crmExecutive_Flag = Executive
      crmSubScriptionCls.crmTurboprops = Turboprops

      query = query & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(crmSubScriptionCls, False, False)

      query = query & " order by amod_make_name, amod_model_name"
      query = query


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, query.ToString)
      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString

      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = query
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        TempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = TempTable.GetErrors()
      End Try
      Return TempTable
    Catch ex As Exception
      GetAircraft_MakeModels = Nothing
      Me.class_error = "Error in GetAircraft_MakeModels() SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing

    End Try

  End Function

  ''' <summary>
  ''' Imported from Full Model View aspx Page. This grabs Model Information from the Jetnet Database based on a Model ID.
  ''' </summary>
  ''' <param name="amod_id">Model ID</param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function GetJetnetModelInfo(ByVal amod_id As Long, ByVal complete_fields As Boolean, ByVal called_from As String) As DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim TempTable As New DataTable
    Dim query As String
    Try

      If amod_id <> 0 Then
        query = "SELECT "
        If complete_fields = True Then
          query = query & " * "
        Else
          query = query & " amod_make_name, amod_model_name, amod_manufacturer, amod_airframe_type_code, amod_weight_class, amod_start_year, amod_end_year, amod_ser_no_prefix, amod_ser_no_start, "
          query = query & " amod_ser_no_end, amod_ser_no_suffix, amod_start_price, amod_end_price, amod_description, amod_product_commercial_flag, amod_product_helicopter_flag, amod_type_code, ambc_name"
        End If

        query = query & " FROM Aircraft_Model WITH(NOLOCK) "

        '  If complete_fields = False Then
        query = query & " INNER JOIN Aircraft_Type WITH(NOLOCK) ON amod_type_code = atype_code"
        query = query & " INNER JOIN Airframe_Type WITH(NOLOCK) ON amod_airframe_type_code = aftype_code"
        query = query & " INNER JOIN Aircraft_Model_Body_Config WITH(NOLOCK) ON amod_body_config = ambc_type"
        'End If

        query = query & " WHERE amod_id = " & amod_id

        query = query & " " & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(HttpContext.Current.Session.Item("localSubscription"), False, False)



        clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, query.ToString)
        SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString

        SqlConn.Open()
        SqlCommand.Connection = SqlConn

        SqlCommand.CommandText = query
        SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
        SqlCommand.CommandType = CommandType.Text
        SqlCommand.CommandTimeout = 60

        Try
          TempTable.Load(SqlReader)
        Catch constrExc As System.Data.ConstraintException
          Dim rowsErr As System.Data.DataRow() = TempTable.GetErrors()
        End Try
      End If
      Return TempTable
    Catch ex As Exception
      GetJetnetModelInfo = Nothing
      Me.class_error = "Error in GetJetnetModelInfo(ByVal amod_id As Long) As DataTable SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing

    End Try

  End Function
  ''' <summary>
  ''' The client database doesn't have the model # of engines. So I had to perform an extra lookup on the jetnet model to return the
  ''' correct # of engines for each model. I then go ahead and combine the table with the aircraft table. This function combines them.
  ''' </summary>
  ''' <param name="JetnetModelTable"></param>
  ''' <param name="ClientAircraftTable"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function AddEngineNumber(ByVal JetnetModelTable As DataTable, ByVal ClientAircraftTable As DataTable) As DataTable

    Dim column As New DataColumn 'Column to Add Source to jetnet data.
    column.DataType = System.Type.GetType("System.Double")
    column.AllowDBNull = True
    column.Unique = False
    column.ColumnName = "amod_number_of_engines"

    If Not IsNothing(JetnetModelTable) Then
      If JetnetModelTable.Rows.Count > 0 Then
        column.DefaultValue = JetnetModelTable.Rows(0).Item("amod_number_of_engines")
      End If
    End If

    If Not IsNothing(ClientAircraftTable) Then
      ClientAircraftTable.Columns.Add(column)
    End If

    Return ClientAircraftTable
  End Function
  Public Function Get_JETNET_Aircraft_ModelID_BY_CLIENT_MODEL(ByVal client_amod_id As Integer) As Integer
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Get_JETNET_Aircraft_ModelID_BY_CLIENT_MODEL = 0

    Dim sql As String = ""
    Dim atemptable As New DataTable
    Try

      sql = "Select cliamod_jetnet_amod_id from client_aircraft_model where cliamod_id = " & client_amod_id


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      MySqlReader.Close()

      For Each t As DataRow In atemptable.Rows
        Get_JETNET_Aircraft_ModelID_BY_CLIENT_MODEL = t("cliamod_jetnet_amod_id")
      Next


    Catch ex As Exception
      Get_JETNET_Aircraft_ModelID_BY_CLIENT_MODEL = Nothing
      Me.class_error = "Error in Aircraft_Listing_Company_Display(ByVal id As Integer, ByVal source As String, ByVal operators As String) As DataTable: " & ex.Message
    Finally


      MySqlReader = Nothing

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_JETNET_Aircraft_Model_amodID
  ' Purpose: to get all jetnet aircraft 
  ' Parameters: amod_ID
  ' Return: 
  '       integer
  ' Change Log
  '           1/5/2011    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_JETNET_Aircraft_Model_amodID(ByVal amod_ID As Integer) As DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim TempTable As New DataTable

    Try
      sql = "SELECT amod_airframe_type_code as amod_airframe_type, amod_id, amod_make_name, amod_type_code as amod_make_type, amod_manufacturer as amod_manufacturer_name, "
      sql = sql & " amod_model_name, amod_product_business_flag, amod_product_commercial_flag, amod_product_helicopter_flag, "
      sql = sql & " 'JETNET' AS source FROM aircraft_model  WITH(NOLOCK) WHERE (amod_id = " & amod_ID & ")"

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString

      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sql


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        TempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = TempTable.GetErrors()
      End Try
      Return TempTable
    Catch ex As Exception
      Get_JETNET_Aircraft_Model_amodID = Nothing
      Me.class_error = "Error in Get_JETNET_Aircraft_Model_amodID(ByVal amod_ID As Integer) SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing

    End Try

  End Function
  Public Function Get_Maintenance_By_ID(ByVal ac_id As Long) As DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim TempTable As New DataTable

    Try

      sql = "SELECT  acmaint_id, acmaint_name, acmaint_complied_date, acmaint_date_type, acmaint_complied_hrs, acmaint_due_hrs, "
      sql = sql & " acmaint_due_date, acmaint_notes, 0 as mitem_duration from aircraft_maintenance   "
      sql = sql & " INNER JOIN Maintenance_Item with (NOLOCK) ON aircraft_maintenance.acmaint_name = maintenance_item.mitem_name"
      sql = sql & " WHERE "
      sql = sql & " acmaint_ac_id = " & ac_id & "  "
      sql = sql & " order by  acmaint_complied_date asc "


      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString

      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sql


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        TempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = TempTable.GetErrors()
      End Try
      Return TempTable
    Catch ex As Exception
      Get_Maintenance_By_ID = Nothing
      Me.class_error = "Error in Get_JETNET_Aircraft_Model_amodID(ByVal amod_ID As Integer) SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing

    End Try

  End Function
  Public Function GET_AC_ATTRIBUTES_STANDARD_AND_EQUIPPED(ByVal ac_id As Long) As DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable

    Try

      sql = "Select acatt_name, attmod_standard_equip, acattind_status_flag, ac_amod_id, "
      sql &= " Case when attmod_standard_equip = 'Y' then 'STANDARD EQUIPMENT' "
      sql &= " when acattind_status_flag = 'Y' then 'EQUIPPED WITH' "
      sql &= " when acattind_status_flag = 'N' then 'NOT EQUIPPED WITH' "
      sql &= " Else 'NOT EQUIPPED WITH' end as FEATURES "
      sql &= " From [Homebase].jetnet_ra.dbo.Aircraft_Attribute_Index with (NOLOCK) "
      sql &= " inner Join [Homebase].jetnet_ra.dbo.Aircraft_Attribute with (NOLOCK) on acattind_acatt_id = acatt_id "
      sql &= " inner Join [Homebase].jetnet_ra.dbo.Aircraft with (NOLOCK) on acattind_ac_id = ac_id And ac_journ_id = 0 "
      sql &= " inner Join [Homebase].jetnet_ra.dbo.Aircraft_Attribute_Model with (NOLOCK) on ac_amod_id = attmod_amod_id And acattind_acatt_id = attmod_att_id "
      sql &= " where acattind_ac_id = " & ac_id & " And acattind_journ_id = 0 "
      sql &= " And acattind_status_flag <> 'U' "
      sql &= " order by FEATURES, acatt_name "



      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      GET_AC_ATTRIBUTES_STANDARD_AND_EQUIPPED = atemptable

    Catch ex As Exception
      GET_AC_ATTRIBUTES_STANDARD_AND_EQUIPPED = Nothing
      Me.class_error = "Error in GetJETNET_Model_Standard_Key_Features(ByVal model_id As Long) As DataTable SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function

  Public Function GET_AC_ATTRIBUTES_ADDITIONAL_ASSETS(ByVal ac_id As Long) As DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable

    Try

      sql = " select acatt_name "
      sql &= " from Aircraft_Attribute_Index with (NOLOCK) "
      sql &= " inner join Aircraft_Attribute with (NOLOCK) on acattind_acatt_id = acatt_id "
      sql &= " inner join Aircraft with (NOLOCK) on acattind_ac_id = ac_id and ac_journ_id = 0 "
      sql &= " left outer join Aircraft_Attribute_Model with (NOLOCK) on ac_amod_id = attmod_amod_id and acattind_acatt_id = attmod_att_id "
      sql &= " where acattind_ac_id = " & ac_id & " and acattind_journ_id = 0 "
      sql &= " And acattind_status_flag ='Y' "
      sql &= " and attmod_amod_id is NULL "
      sql &= " order by acatt_name  "

      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      GET_AC_ATTRIBUTES_ADDITIONAL_ASSETS = atemptable

    Catch ex As Exception
      GET_AC_ATTRIBUTES_ADDITIONAL_ASSETS = Nothing
      Me.class_error = "Error in GetJETNET_Model_Standard_Key_Features(ByVal model_id As Long) As DataTable SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function

  ''' <summary>
  ''' Query that gets the model standard Key feature list based on a model ID.
  ''' </summary>
  ''' <param name="model_id"></param>
  ''' <returns></returns> 
  ''' <remarks></remarks>
  Public Function GetJETNET_Model_Standard_Key_Features(ByVal model_id As Long) As DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable

    Try

      sql = "SELECT amfeat_feature_code, kfeat_name, amfeat_seq_no FROM Aircraft_Model_Key_Feature WITH(NOLOCK), Key_Feature WITH(NOLOCK) WHERE amfeat_standard_equip = 'Y' AND"
      sql &= " ((amfeat_stdeq_start_ser_no_value IS NULL AND amfeat_stdeq_end_ser_no_value IS NULL) OR"
      sql &= " (amfeat_stdeq_start_ser_no_value = 0 AND amfeat_stdeq_end_ser_no_value = 0)) AND"
      sql &= " amfeat_amod_id = " & model_id & " AND amfeat_feature_code = kfeat_code ORDER BY amfeat_seq_no, amfeat_feature_code"


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      GetJETNET_Model_Standard_Key_Features = atemptable

    Catch ex As Exception
      GetJETNET_Model_Standard_Key_Features = Nothing
      Me.class_error = "Error in GetJETNET_Model_Standard_Key_Features(ByVal model_id As Long) As DataTable SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function
  ''' <summary>
  ''' </summary>
  ''' <param name="amod_ids"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function PerformanceSpecSearch(ByVal amod_ids As String, ByVal modelType As String, ByVal AirframeType As String, ByVal MakeString As String, ByVal performance As Boolean, ByVal WeightClass As String, ByVal TakeOffSL As String, ByVal TakeOffSLOperator As String, ByVal MaxRange As String, ByVal MaxRangeOperator As String, ByVal FuseLength As String, ByVal FuseLengthOperator As String, ByVal FuseHeight As String, ByVal FuseHeightOperator As String, ByVal FuseWing As String, ByVal FuseWingOperator As String, ByVal Crew As String, ByVal CrewOperator As String, ByVal Passengers As String, ByVal PassengersOperator As String, ByVal MaxTakeOff As String, ByVal MaxTakeOffOperator As String, ByVal NormalCruise As String, ByVal NormalCruiseOperator As String, ByVal Helicopter As Boolean, ByVal Business As Boolean, ByVal Commercial As Boolean) As DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim TempTable As New DataTable
    Dim query As String = ""
    Dim sqlwhere As String = ""
    Try

      '  If amod_ids <> "" And performance Or performance = False Then
      query = "SELECT * "
      query = query & " FROM Aircraft_Model WITH(NOLOCK) "

      If WeightClass <> "" Then
        If sqlwhere <> "" Then
          sqlwhere = " and "
        End If
        sqlwhere = sqlwhere & " (amod_weight_class = '" & WeightClass & "') "
      End If

      'Takeoff ALI
      If TakeOffSL <> "" Then
        If sqlwhere <> "" Then
          sqlwhere += " and "
        End If
        sqlwhere = sqlwhere & " (amod_takeoff_ali " & clsGeneral.clsGeneral.PrepQueryString(TakeOffSLOperator, TakeOffSL, "Numeric", False, "amod_takeoff_ali", True) & ") "
      End If
      'Fuselage Length
      If FuseLength <> "" Then
        If sqlwhere <> "" Then
          sqlwhere += " and "
        End If
        sqlwhere = sqlwhere & " (amod_fuselage_length " & clsGeneral.clsGeneral.PrepQueryString(FuseLengthOperator, FuseLength, "Numeric", False, "amod_fuselage_length", True) & ") "
      End If

      'Fuselage Height
      If FuseHeight <> "" Then
        If sqlwhere <> "" Then
          sqlwhere += " and "
        End If
        sqlwhere = sqlwhere & " (amod_fuselage_height " & clsGeneral.clsGeneral.PrepQueryString(FuseHeightOperator, FuseHeight, "Numeric", False, "amod_fuselage_height", True) & ") "
      End If

      'Fuselage Wing
      If FuseWing <> "" Then
        If sqlwhere <> "" Then
          sqlwhere = sqlwhere & " and "
        End If

        sqlwhere = sqlwhere & " ( "

        If Commercial = True Or Business = True Then
          sqlwhere = sqlwhere & " (amod_fuselage_wingspan " & clsGeneral.clsGeneral.PrepQueryString(FuseWingOperator, FuseWing, "Numeric", False, "amod_fuselage_wingspan", True) & ") "
        End If

        If Helicopter = True Then
          If Commercial = True Or Business = True Then
            sqlwhere = sqlwhere & " or "
          End If
          sqlwhere = sqlwhere & " (amod_fuselage_width " & clsGeneral.clsGeneral.PrepQueryString(FuseWingOperator, FuseWing, "Numeric", False, "amod_fuselage_width", True) & ") "
        End If
        sqlwhere = sqlwhere & " ) "
      End If

      If MaxRange <> "" Then
        If sqlwhere <> "" Then
          sqlwhere = sqlwhere & " and "
        End If

        sqlwhere = sqlwhere & " ( "

        If Commercial = True Or Business = True Then
          sqlwhere = sqlwhere & " (amod_max_range_miles " & clsGeneral.clsGeneral.PrepQueryString(MaxRangeOperator, MaxRange, "Numeric", False, "amod_max_range_miles", True) & ") "
        End If
        If Helicopter = True Then
          If Commercial = True Or Business = True Then
            sqlwhere = sqlwhere & " or "
          End If
          sqlwhere = sqlwhere & " (amod_range_tanks_full " & clsGeneral.clsGeneral.PrepQueryString(MaxRangeOperator, MaxRange, "Numeric", False, "amod_range_tanks_full", True) & ") "
        End If
        sqlwhere = sqlwhere & " ) "
      End If

      'Crew
      If Crew <> "" Then
        If sqlwhere <> "" Then
          sqlwhere += " and "
        End If
        sqlwhere = sqlwhere & " (amod_number_of_crew " & clsGeneral.clsGeneral.PrepQueryString(CrewOperator, Crew, "Numeric", False, "amod_number_of_crew", True) & ") "
      End If

      'Passengers
      If Passengers <> "" Then
        If sqlwhere <> "" Then
          sqlwhere += " and "
        End If
        sqlwhere = sqlwhere & " (amod_number_of_passengers " & clsGeneral.clsGeneral.PrepQueryString(PassengersOperator, Passengers, "Numeric", False, "amod_number_of_passengers", True) & ") "
      End If

      'Max Takeoff
      If MaxTakeOff <> "" Then
        If sqlwhere <> "" Then
          sqlwhere += " and "
        End If
        sqlwhere = sqlwhere & " (amod_max_takeoff_weight " & clsGeneral.clsGeneral.PrepQueryString(MaxTakeOffOperator, MaxTakeOff, "Numeric", False, "amod_max_takeoff_weight", True) & ") "
      End If

      'Normal Cruise
      If NormalCruise <> "" Then
        If sqlwhere <> "" Then
          sqlwhere += " and "
        End If
        sqlwhere = sqlwhere & " (amod_cruis_speed " & clsGeneral.clsGeneral.PrepQueryString(NormalCruiseOperator, NormalCruise, "Numeric", False, "amod_cruis_speed", True) & ") "
      End If

      If amod_ids <> "" Then
        If sqlwhere <> "" Then
          sqlwhere += " and "
        End If
        sqlwhere += " amod_id in (" & amod_ids & ") "
      Else
        If modelType <> "" Then
          If sqlwhere <> "" Then
            sqlwhere += " and "
          End If
          sqlwhere += " amod_type_code in (" & modelType & ")"
        End If

        If AirframeType <> "" Then
          If sqlwhere <> "" Then
            sqlwhere += " and "
          End If
          sqlwhere += " amod_airframe_type_code in (" & AirframeType & ")"
        End If


        If MakeString <> "" Then
          If sqlwhere <> "" Then
            sqlwhere += " and "
          End If
          sqlwhere += " amod_make_name in (" & MakeString & ")"
        End If
      End If

      'Setting up the filtering
      Dim HoldClsSubscription As New crmSubscriptionClass

      HoldClsSubscription.crmAerodexFlag = HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag
      HoldClsSubscription.crmBusiness_Flag = Business
      HoldClsSubscription.crmCommercial_Flag = Commercial
      HoldClsSubscription.crmHelicopter_Flag = Helicopter
      HoldClsSubscription.crmJets_Flag = HttpContext.Current.Session.Item("localSubscription").crmJets_Flag
      HoldClsSubscription.crmTurboprops = HttpContext.Current.Session.Item("localSubscription").crmTurboprops
      HoldClsSubscription.crmExecutive_Flag = HttpContext.Current.Session.Item("localSubscription").crmExecutive_Flag


      Dim tmpProductString As String = clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(HoldClsSubscription, False, False).ToString.Trim

      sqlwhere = " where " + sqlwhere + IIf(Not String.IsNullOrEmpty(tmpProductString.Trim), Constants.cSingleSpace + tmpProductString.Trim, "")

      If performance = True Then
        HttpContext.Current.Session.Item("MasterAircraftPerformanceSpecsWhere") = sqlwhere
      Else
        HttpContext.Current.Session.Item("MasterAircraftOperatingCostWhere") = sqlwhere
      End If


      query += sqlwhere + " ORDER BY amod_make_name, amod_model_name"

      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, query.ToString)

      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 120

      SqlCommand.CommandText = query
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        TempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = TempTable.GetErrors()
      End Try
      ' End If
      Return TempTable
    Catch ex As Exception
      PerformanceSpecSearch = Nothing
      Me.class_error = "Error in PerformanceSpecSearch(ByVal amod_ids As String) As DataTable SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing

    End Try

  End Function
  ''' <summary>
  ''' </summary>
  ''' <param name="amod_ids"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function OperatingCostSearch(ByVal amod_ids As String, ByVal modelType As String, ByVal AirframeType As String, ByVal MakeString As String, ByVal WeightClass As String, ByVal FuelBurn As String, ByVal FuelBurnOperator As String, ByVal TotalDirectCost As String, ByVal TotalDirectCostOperator As String, ByVal Business As Boolean, ByVal Helicopter As Boolean, ByVal Commercial As Boolean) As DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim TempTable As New DataTable
    Dim query As String = ""
    Dim sqlwhere As String = ""
    Try
      HttpContext.Current.Session.Item("OpCostsModelID") = 0
      HttpContext.Current.Session.Item("OpCostsModelList") = ""

      query = "SELECT * "
      query = query & " FROM Aircraft_Model WITH(NOLOCK) "

      If WeightClass <> "" Then
        sqlwhere = sqlwhere & " (amod_weight_class = '" & WeightClass & "') "
      End If

      If FuelBurn <> "" Then
        If sqlwhere <> "" Then
          sqlwhere = sqlwhere & " and "
        End If
        sqlwhere = sqlwhere & " (amod_fuel_burn_rate " & clsGeneral.clsGeneral.PrepQueryString(FuelBurnOperator, FuelBurn, "Numeric", False, "amod_fuel_burn_rate", True) & ")"
      End If

      If TotalDirectCost <> "" Then
        If sqlwhere <> "" Then
          sqlwhere = sqlwhere & " and "
        End If
        sqlwhere = sqlwhere & " (amod_tot_hour_direct_cost " & clsGeneral.clsGeneral.PrepQueryString(TotalDirectCostOperator, TotalDirectCost, "Numeric", False, "amod_tot_hour_direct_cost", True) & ")"
      End If

      If amod_ids <> "" Then
        If sqlwhere <> "" Then
          sqlwhere += " and "
        End If
        sqlwhere += " amod_id in (" & amod_ids & ") "
        If InStr(amod_ids.ToString, ",") = 0 Then
          HttpContext.Current.Session.Item("OpCostsModelID") = amod_ids
          HttpContext.Current.Session.Item("OpCostsModelList") = ""
        Else
          HttpContext.Current.Session.Item("OpCostsModelID") = 0
          HttpContext.Current.Session.Item("OpCostsModelList") = amod_ids.ToString
        End If

      Else
        If modelType <> "" Then
          If sqlwhere <> "" Then
            sqlwhere += " and "
          End If
          sqlwhere += " amod_type_code in (" & modelType & ")"
        End If

        If AirframeType <> "" Then
          If sqlwhere <> "" Then
            sqlwhere += " and "
          End If
          sqlwhere += " amod_airframe_type_code in (" & AirframeType & ")"
        End If

        If MakeString <> "" Then
          If sqlwhere <> "" Then
            sqlwhere += " and "
          End If
          sqlwhere += " amod_make_name in (" & MakeString & ")"
        End If
      End If

      'Setting up the filtering
      Dim HoldClsSubscription As New crmSubscriptionClass

      HoldClsSubscription.crmAerodexFlag = HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag
      HoldClsSubscription.crmBusiness_Flag = Business
      HoldClsSubscription.crmCommercial_Flag = Commercial
      HoldClsSubscription.crmHelicopter_Flag = Helicopter
      HoldClsSubscription.crmJets_Flag = HttpContext.Current.Session.Item("localSubscription").crmJets_Flag
      HoldClsSubscription.crmTurboprops = HttpContext.Current.Session.Item("localSubscription").crmTurboprops
      HoldClsSubscription.crmExecutive_Flag = HttpContext.Current.Session.Item("localSubscription").crmExecutive_Flag


      Dim tmpProductString As String = clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(HoldClsSubscription, False, False).ToString.Trim

      If String.IsNullOrEmpty(sqlwhere.Trim) And tmpProductString.Substring(0, 4).ToLower.Contains("and") Then
        sqlwhere += " " + tmpProductString.Substring(tmpProductString.IndexOf(" ") + 1, (tmpProductString.Length - (tmpProductString.IndexOf(" ") + 1)))
      End If

      sqlwhere = " where " + sqlwhere


      HttpContext.Current.Session.Item("MasterAircraftOperatingCostWhere") = sqlwhere



      query = query & sqlwhere

      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, query.ToString)

      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 120

      SqlCommand.CommandText = query
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        TempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = TempTable.GetErrors()
      End Try
      ' End If
      Return TempTable
    Catch ex As Exception
      OperatingCostSearch = Nothing
      Me.class_error = "Error in OperatingCostSearch(ByVal amod_ids As String, ByVal modelType As String, ByVal AirframeType As String, ByVal MakeString As String, ByVal WeightClass As String, ByVal FuelBurn As Long, ByVal FuelBurnOperator As String, ByVal TotalDirectCost As Long, ByVal TotalDirectCostOperator As String) As DataTable SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing

    End Try

  End Function

  ''' <summary>
  ''' Gets Aircraft Model Engine Information based on Model ID
  ''' </summary>
  ''' <param name="amod_id"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Aircraft_Model_Engine(ByVal amod_id As Long) As DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim TempTable As New DataTable
    Dim query As String
    Try

      If amod_id <> 0 Then
        query = "SELECT * FROM Aircraft_Model_Engine WITH(NOLOCK) WHERE ameng_active_flag = 'Y'"
        query = query & " AND ameng_amod_id = " & CStr(amod_id) & " ORDER BY ameng_seq_no"



        clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, query.ToString)

        SqlConn.ConnectionString = JETNET_DB
        SqlConn.Open()
        SqlCommand.Connection = SqlConn

        SqlCommand.CommandText = query
        SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
        SqlCommand.CommandType = CommandType.Text
        SqlCommand.CommandTimeout = 60

        Try
          TempTable.Load(SqlReader)
        Catch constrExc As System.Data.ConstraintException
          Dim rowsErr As System.Data.DataRow() = TempTable.GetErrors()
        End Try
      End If
      Return TempTable
    Catch ex As Exception
      Aircraft_Model_Engine = Nothing
      Me.class_error = "Error in Aircraft_Model_Engine(ByVal amod_id As Long) As DataTable SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing

    End Try

  End Function
#End Region
#Region "Aircraft Details"
  ''' <summary>
  ''' The AC details page used for the aircraft details page. This 
  ''' Is only for Non Historical Aircraft.
  ''' Eventually it might make more sense to combine the Historical one and this one, however for right now
  ''' I want to keep them seperate because they're each pulling different sets of fields.
  ''' </summary>
  ''' <param name="ac_id"></param>
  ''' <param name="aError"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function GetJETNET_Aircraft_Details_AC_ID(ByVal ac_id As Long, ByRef aError As String) As DataTable
    Dim sql As String = ""
    Dim atemptable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try
      sql = sql & "Select DISTINCT "
      sql = sql & "aircraft.ac_id, aircraft.ac_amod_id, aircraft.ac_journ_id, aircraft.ac_delivery_date, aircraft.ac_lifecycle_stage as ac_lifecycle, "
      sql = sql & "aircraft.ac_ownership_type as ac_ownership, aircraft.ac_use_code as ac_usage, aircraft.ac_ser_no_full as ac_ser_nbr,"
      sql = sql & "aircraft.ac_alt_ser_no as ac_alt_ser_nbr, aircraft.ac_reg_no as ac_reg_nbr, aircraft.ac_alt_ser_no_full, "
      sql = sql & "aircraft.ac_prev_reg_no as ac_prev_reg_nbr, aircraft.ac_country_of_registration, (select case when ac_previously_owned_flag='Y' then 'N' else 'Y' end) as ac_new_flag, "
      sql = sql & " aircraft.ac_mfr_year as ac_year_mfr, aircraft.ac_year as ac_year_dlv, aircraft.ac_purchase_date as ac_date_purchased, "
      sql = sql & "aircraft.ac_forsale_flag, aircraft.ac_foreign_currency_price, aircraft.ac_list_date as ac_date_listed, aircraft.ac_status, aircraft.ac_delivery, "
      sql = sql & " aircraft.ac_exclusive_flag, aircraft.ac_asking as ac_asking_wordage, "
      sql = sql & "aircraft.ac_asking_price, aircraft.ac_lease_flag, ac_airframe_maintenance_prog_AMP as ac_airframe_maintenance_program, "
      sql = sql & " ac_airframe_maint_tracking_prog_AMTP as ac_airframe_maintenance_tracking_program, "
      sql = sql & "aircraft.ac_airframe_tot_hrs as ac_airframe_total_hours, aircraft.ac_airframe_tot_landings as ac_airframe_total_landings, "
      sql = sql & "aircraft.ac_times_as_of_date as ac_date_engine_times_as_of, aircraft.ac_aport_iata_code, aircraft.ac_aport_icao_code, "
      sql = sql & "aircraft.ac_aport_name, aircraft.ac_aport_state, aircraft.ac_aport_country, aircraft.ac_aport_city, "
      sql = sql & " aircraft.ac_aport_private, aircraft.ac_apu_model_name, "
      sql = sql & "aircraft.ac_apu_ser_no as ac_apu_ser_nbr, ac_apu_tot_hrs as ac_apu_ttsn_hours, ac_apu_soh_hrs as ac_apu_tsoh_hours, "
      sql = sql & "ac_apu_shi_hrs as ac_apu_tshi_hours, ac_apu_maint_prog as ac_apu_maintance_program, "
      sql = sql & "'' as ac_damage_flag, aircraft.ac_damage_history_notes, aircraft.ac_interior_rating, "
      sql = sql & "ac_interior_moyear as ac_interior_month_year, aircraft.ac_interior_doneby_name, "
      sql = sql & "aircraft.ac_interior_config_name, aircraft.ac_exterior_rating, ac_exterior_moyear as ac_exterior_month_year, "
      sql = sql & " aircraft.ac_exterior_doneby_name, aircraft.ac_passenger_count, "
      sql = sql & "aircraft.ac_confidential_notes, aircraft.ac_action_date, amod_airframe_type_code as amod_airframe_type, amod_type_code as amod_make_type, "
      sql = sql & " aircraft_model.amod_weight_class, "
      sql = sql & "aircraft_model.amod_make_name, aircraft_model.amod_model_name, aircraft_model.amod_manufacturer_comp_id, "
      sql = sql & " amod_manufacturer as amod_manufacturer_name, "

      sql = sql & " amp_provider_name,  amp_program_name, ac_maintained as ac_maintained, "

      sql = sql & " ac_engine_name, ac_engine_maintenance_prog_EMP, ac_engine_management_prog_EMGP, ac_engine_tbo_oc_flag, "
      sql = sql & " ac_engine_noise_rating, ac_model_config, ac_maint_eoh_by_name, ac_main_eoh_moyear, ac_maint_hots_by_name, "
      sql = sql & " ac_maint_hots_moyear, ac_engine_1_ser_no, ac_engine_2_ser_no, ac_engine_3_ser_no, "
      sql = sql & " ac_engine_4_ser_no, ac_engine_1_tot_hrs, ac_engine_2_tot_hrs, ac_engine_3_tot_hrs, "
      sql = sql & "  ac_engine_4_tot_hrs, ac_engine_1_soh_hrs, ac_engine_2_soh_hrs, ac_engine_3_soh_hrs, "
      sql = sql & " ac_engine_4_soh_hrs, ac_engine_1_shi_hrs, ac_engine_2_shi_hrs, ac_engine_3_shi_hrs, "
      sql = sql & " ac_engine_4_shi_hrs, ac_engine_1_tbo_hrs, ac_engine_2_tbo_hrs, ac_engine_3_tbo_hrs, "
      sql = sql & " ac_engine_4_tbo_hrs, ac_engine_1_snew_cycles, ac_engine_2_snew_cycles, ac_engine_3_snew_cycles, "
      sql = sql & "  ac_engine_4_snew_cycles, ac_engine_1_soh_cycles, ac_engine_2_soh_cycles, ac_engine_3_soh_cycles, "
      sql = sql & " ac_engine_4_soh_cycles,ac_engine_1_shs_cycles,ac_engine_2_shs_cycles,ac_engine_3_shs_cycles, "
      sql = sql & "  ac_engine_4_shs_cycles,  emp_provider_name, "
      sql = sql & "  emp_program_name, emgp_provider_name, "
      sql = sql & "  emgp_program_name, "

      sql = sql & "  amtp_provider_name,  amtp_program_name, 'N' as ac_picture_exist_flag, "
      sql = sql & "aircraft.ac_product_business_flag, aircraft.ac_product_helicopter_flag, aircraft.ac_product_commercial_flag, "
      sql = sql & " aircraft.ac_ser_no_sort as ac_ser_nbr_sort "
      sql = sql & " FROM   aircraft with (NOLOCK) INNER JOIN "
      sql = sql & " aircraft_model WITH(NOLOCK) ON aircraft.ac_amod_id = aircraft_model.amod_id " 'LEFT OUTER JOIN "
      'sql = sql & " aircraft_reference  WITH(NOLOCK)  ON aircraft.ac_id = aircraft_reference.cref_ac_id " 
      sql = sql & " LEFT OUTER JOIN  "
      sql = sql & " Engine_Maintenance_Program WITH(NOLOCK) ON ac_engine_maintenance_prog_EMP = Engine_Maintenance_Program.emp_id LEFT OUTER JOIN "
      sql = sql & " Engine_Management_Program WITH(NOLOCK) ON ac_engine_management_prog_EMGP = Engine_Management_Program.emgp_id "
      sql = sql & " LEFT OUTER JOIN  "
      sql = sql & " airframe_maintenance_program WITH(NOLOCK) ON aircraft.ac_airframe_maintenance_prog_AMP = airframe_maintenance_program.amp_id LEFT OUTER JOIN  "
      sql = sql & " airframe_maintenance_tracking_program WITH(NOLOCK) ON aircraft.ac_airframe_maint_tracking_prog_AMTP = airframe_maintenance_tracking_program.amtp_id "
      sql = sql & " WHERE (aircraft.ac_id = " & ac_id & ") and ac_journ_id = 0 "




      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString

      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Return atemptable
    Catch ex As Exception
      GetJETNET_Aircraft_Details_AC_ID = Nothing
      Me.class_error = "Error in GetJETNET_Aircraft_Details_AC_ID(ByVal ac_id As Integer, ByRef aError As String)  SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing

    End Try


  End Function

  ''' <summary>
  ''' The AC details page used for the aircraft details page on new Evo
  ''' </summary>
  ''' <param name="ac_id"></param>
  ''' <param name="journal_id"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function GetJETNET_ACDetails_PresentAndHistorical(ByVal ac_id As Long, ByVal journal_id As Long) As DataTable
    Dim sql As String = ""
    Dim atemptable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try
      sql = sql & "Select DISTINCT "
      sql = sql & "aircraft.ac_id, aircraft.ac_amod_id, aircraft.ac_amod_id as jetnet_amod_id, ac_upd_date, 0 as broker_price, ac_foreign_currency_name, ac_reg_no_expiration_date, aircraft.ac_journ_id,ac_reg_no_search, aircraft.ac_delivery_date, aircraft.ac_lifecycle_stage, aircraft.ac_lifecycle_stage as ac_lifecycle, "
      sql = sql & "aircraft.ac_ownership_type as ac_ownership,ac_ownership_type, aircraft.ac_use_code as ac_usage, aircraft.ac_ser_no_full as ac_ser_nbr,"
      sql = sql & "aircraft.ac_alt_ser_no as ac_alt_ser_nbr, aircraft.ac_reg_no as ac_reg_nbr,  aircraft.ac_reg_no, aircraft.ac_alt_ser_no_full, aircraft.ac_prev_reg_no,"
      sql = sql & "aircraft.ac_prev_reg_no as ac_prev_reg_nbr, aircraft.ac_country_of_registration, (select case when ac_previously_owned_flag='Y' then 'N' else 'Y' end) as ac_new_flag,ac_previously_owned_flag, "
      sql = sql & " aircraft.ac_mfr_year as ac_year_mfr, aircraft.ac_mfr_year, aircraft.ac_year as ac_year_dlv,aircraft.ac_year,aircraft.ac_purchase_date, aircraft.ac_purchase_date as ac_date_purchased, "
      sql = sql & "aircraft.ac_forsale_flag, aircraft.ac_foreign_currency_price, aircraft.ac_list_date, aircraft.ac_list_date as ac_date_listed, aircraft.ac_status, aircraft.ac_delivery, "
      sql = sql & " aircraft.ac_exclusive_flag, aircraft.ac_asking as ac_asking_wordage, aircraft.ac_asking, amod_number_of_engines, "
      sql = sql & "aircraft.ac_asking_price, aircraft.ac_lease_flag, ac_airframe_maintenance_prog_AMP as ac_airframe_maintenance_program, "
      sql = sql & " ac_airframe_maint_tracking_prog_AMTP as ac_airframe_maintenance_tracking_program, "  ' ac_est_airframe_hrs ADDED IN MSW - 11/5/18
      sql = sql & "aircraft.ac_airframe_tot_hrs as ac_airframe_total_hours, aircraft.ac_airframe_tot_hrs, aircraft.ac_airframe_tot_landings,  aircraft.ac_airframe_tot_landings as ac_airframe_total_landings, "
      sql = sql & "aircraft.ac_times_as_of_date as ac_date_engine_times_as_of, aircraft.ac_times_as_of_date, aircraft.ac_aport_iata_code, aircraft.ac_aport_icao_code, "
      sql = sql & "aircraft.ac_aport_name, aircraft.ac_aport_state, aircraft.ac_aport_country, aircraft.ac_aport_city, "
      sql = sql & " aircraft.ac_aport_private, aircraft.ac_apu_model_name, aircraft.ac_apu_ser_no,"
      sql += " '' as custom_1, "
      sql += " '' as custom_2, "
      sql += " '' as custom_3, "
      sql += " '' as custom_4, "
      sql += " '' as custom_5, "
      sql += " '' as custom_6, "
      sql += " '' as custom_7, "
      sql += " '' as custom_8, "
      sql += " '' as custom_9, "
      sql += " '' as custom_10, "
      sql += " ac_apu_ser_no, ac_apu_tot_hrs,  ac_apu_soh_hrs, ac_apu_shi_hrs, replace(replace(replace(STUFF((select accert_name + ', ' as cc  FROM Aircraft_Certified WITH(NOLOCK) WHERE accert_ac_id = aircraft.ac_id and accert_ac_journ_id = aircraft.ac_journ_id FOR XML PATH('')),1,1,''), '<cc>', ''), '</cc>', ''), 'cc>', '')  as certifications, "

      sql = sql & "aircraft.ac_apu_ser_no as ac_apu_ser_nbr,ac_apu_tot_hrs, ac_apu_tot_hrs as ac_apu_ttsn_hours, ac_apu_soh_hrs, ac_apu_soh_hrs as ac_apu_tsoh_hours, "
      sql = sql & "ac_apu_shi_hrs, ac_apu_shi_hrs as ac_apu_tshi_hours, (select top 1 emp_name from Engine_Maintenance_Program where ac_apu_maint_prog = emp_code)as ac_apu_maintance_program, "
      sql = sql & "'' as ac_damage_flag, aircraft.ac_damage_history_notes, aircraft.ac_interior_rating, "
      sql = sql & "ac_interior_moyear as ac_interior_month_year, ac_interior_moyear, aircraft.ac_interior_doneby_name, "
      sql = sql & "aircraft.ac_interior_config_name, aircraft.ac_exterior_rating, ac_exterior_moyear as ac_exterior_month_year, ac_exterior_moyear, "
      sql = sql & " aircraft.ac_exterior_doneby_name, aircraft.ac_passenger_count, "
      sql = sql & "aircraft.ac_confidential_notes, aircraft.ac_action_date,amod_airframe_type_code, amod_airframe_type_code as amod_airframe_type, amod_type_code, amod_type_code as amod_make_type, "
      sql = sql & " aircraft_model.amod_weight_class, "
      sql = sql & "aircraft_model.amod_make_name, aircraft_model.amod_model_name, aircraft_model.amod_manufacturer_comp_id, "
      sql = sql & " amod_manufacturer as amod_manufacturer_name, NULL as take_price, "

      sql = sql & " amp_provider_name,  amp_program_name, ac_maintained as ac_maintained, "

      sql = sql & " ac_engine_name, ac_engine_maintenance_prog_EMP, ac_engine_management_prog_EMGP, ac_engine_tbo_oc_flag, "
      sql = sql & " ac_engine_noise_rating, ac_model_config, ac_maint_eoh_by_name, ac_main_eoh_moyear, ac_maint_hots_by_name, "
      sql = sql & " ac_maint_hots_moyear, ac_engine_1_ser_no, ac_engine_2_ser_no, ac_engine_3_ser_no, ac_exclusive_expiration_flag, ac_exclusive_date, "
      sql = sql & " ac_engine_4_ser_no, ac_engine_1_tot_hrs, ac_engine_2_tot_hrs, ac_engine_3_tot_hrs, "
      sql = sql & "  ac_engine_4_tot_hrs, ac_engine_1_soh_hrs, ac_engine_2_soh_hrs, ac_engine_3_soh_hrs, "
      sql = sql & " ac_engine_4_soh_hrs, ac_engine_1_shi_hrs, ac_engine_2_shi_hrs, ac_engine_3_shi_hrs, "
      sql = sql & " ac_engine_4_shi_hrs, ac_engine_1_tbo_hrs, ac_engine_2_tbo_hrs, ac_engine_3_tbo_hrs, "
      sql = sql & " ac_engine_4_tbo_hrs, ac_engine_1_snew_cycles, ac_engine_2_snew_cycles, ac_engine_3_snew_cycles, "
      sql = sql & "  ac_engine_4_snew_cycles, ac_engine_1_soh_cycles, ac_engine_2_soh_cycles, ac_engine_3_soh_cycles, "
      sql = sql & " ac_engine_4_soh_cycles,ac_engine_1_shs_cycles,ac_engine_2_shs_cycles,ac_engine_3_shs_cycles, "
      sql = sql & "  ac_engine_4_shs_cycles,  emp_provider_name, "
      sql = sql & "  emp_program_name, emgp_provider_name, "
      sql = sql & "  emgp_program_name, "
      sql = sql & " ac_prop_1_ser_no, ac_prop_2_ser_no, ac_prop_3_ser_no, ac_prop_4_ser_no, "
      sql = sql & " ac_prop_1_snew_hrs, ac_prop_2_snew_hrs, ac_prop_3_snew_hrs, ac_prop_4_snew_hrs, "
      sql = sql & " ac_prop_1_soh_hrs,  ac_prop_2_soh_hrs,  ac_prop_3_soh_hrs,  ac_prop_4_soh_hrs, "
      sql = sql & " ac_prop_1_soh_moyear, ac_prop_2_soh_moyear, ac_prop_3_soh_moyear, ac_prop_4_soh_moyear, "

      sql = sql & "  amtp_provider_name,  amtp_program_name, 'N' as ac_picture_exist_flag, "
      sql = sql & "aircraft.ac_product_business_flag, aircraft.ac_product_helicopter_flag, aircraft.ac_product_commercial_flag, "
      sql = sql & " aircraft.ac_ser_no_sort as ac_ser_nbr_sort,acuse_name "

      sql = sql & ",  aircraft.ac_aport_faaid_code "

      If HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag = True Or HttpContext.Current.Session.Item("localSubscription").crmSalesPriceIndex_Flag = True Then

        sql = sql & ",ac_sale_price_display_flag "
        sql = sql & add_in_case_for_ac_sale_price()

      End If

      If journal_id > 0 Then
        sql = sql & ", (select top 1 ac_est_airframe_hrs  from Aircraft_Flat with (NOLOCK) where Aircraft_Flat.ac_id = " & ac_id & " and Aircraft_Flat.ac_journ_id = " & journal_id & ") as  ac_est_airframe_hrs "
      End If

      sql = sql & " FROM   aircraft with (NOLOCK) INNER JOIN "
      sql = sql & " aircraft_model WITH(NOLOCK) ON aircraft.ac_amod_id = aircraft_model.amod_id "
      sql = sql & " LEFT OUTER JOIN  "
      sql = sql & " Engine_Maintenance_Program WITH(NOLOCK) ON ac_engine_maintenance_prog_EMP = Engine_Maintenance_Program.emp_id LEFT OUTER JOIN "
      sql = sql & " Engine_Management_Program WITH(NOLOCK) ON ac_engine_management_prog_EMGP = Engine_Management_Program.emgp_id "
      sql = sql & " LEFT OUTER JOIN  "
      sql = sql & " airframe_maintenance_program WITH(NOLOCK) ON aircraft.ac_airframe_maintenance_prog_AMP = airframe_maintenance_program.amp_id LEFT OUTER JOIN  "
      sql = sql & " airframe_maintenance_tracking_program WITH(NOLOCK) ON aircraft.ac_airframe_maint_tracking_prog_AMTP = airframe_maintenance_tracking_program.amtp_id "

      If HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag = True Or HttpContext.Current.Session.Item("localSubscription").crmSalesPriceIndex_Flag = True Then
        sql = sql & " left outer join journal with (NOLOCK) on journ_id = ac_journ_id "
      End If
      sql = sql & "  left outer join Aircraft_Useage on ac_use_code = acuse_code "
      sql = sql & " WHERE (aircraft.ac_id = " & ac_id & ") and ac_journ_id = " & journal_id


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB

      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Return atemptable
    Catch ex As Exception
      GetJETNET_ACDetails_PresentAndHistorical = Nothing
      Me.class_error = "Error in GetJETNET_ACDetails_PresentAndHistorical(ByVal ac_id As Long, ByVal journal_id As Long) As DataTable  SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing

    End Try


  End Function
  ''' <summary>
  ''' Query to grab Helicopter Gearbox/Rotorblade Info
  ''' </summary>
  ''' <param name="ac_id"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function GetJETNET_GearboxRotorblade(ByVal ac_id As Long, ByVal journal_id As Long) As DataTable
    Dim sql As String = ""
    Dim atemptable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try
      sql = "SELECT * FROM Helicopter_Detail_Times WITH(NOLOCK) WHERE heldt_ac_id = " & ac_id
      sql &= " AND heldt_journ_id = " & journal_id & " order by heldt_category_type"


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
      SqlConn.ConnectionString = JETNET_DB

      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Return atemptable
    Catch ex As Exception
      GetJETNET_GearboxRotorblade = Nothing
      Me.class_error = "Error in  GetJETNET_GearboxRotorblade(ByVal ac_id As Long, ByVal journal_id As Long, ByRef aError As String) As DataTable  SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing

    End Try


  End Function
  ''' <summary>
  ''' The AC details page used for the aircraft details page
  ''' </summary>
  ''' <param name="ac_id"></param>
  ''' <param name="aError"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function GetJETNET_AC_NAME(ByVal ac_id As Long, ByRef aError As String) As DataTable
    Dim sql As String = ""
    Dim atemptable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try

      sql = sql & "Select DISTINCT "
      sql = sql & "aircraft.ac_id, "
      sql = sql & " aircraft.ac_ser_no as ac_ser_nbr, aircraft.ac_reg_no as ac_reg_nbr, "
      sql = sql & " aircraft.ac_mfr_year as ac_year_mfr, aircraft_model.amod_id, "
      sql = sql & "aircraft_model.amod_make_name, aircraft_model.amod_model_name "
      sql = sql & "FROM   aircraft with (NOLOCK) INNER JOIN "
      sql = sql & "aircraft_model WITH(NOLOCK) ON aircraft.ac_amod_id = aircraft_model.amod_id "
      sql = sql & " WHERE (aircraft.ac_id = " & ac_id & ") and ac_journ_id = 0 "


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)


      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString

      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Return atemptable
    Catch ex As Exception
      GetJETNET_AC_NAME = Nothing
      Me.class_error = "Error in GetJETNET_AC_NAME(ByVal ac_id As Integer, ByRef aError As String) As DataTable  SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing

    End Try


  End Function
  '''<summary>
  ''' 
  ''' </summary>
  ''' <param name="ac_id"></param>
  ''' <param name="aError"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function GetJETNET_AC_NAME_InClause(ByVal ac_id As String, ByRef aError As String) As DataTable
    Dim sql As String = ""
    Dim atemptable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try

      sql = sql & "Select DISTINCT "
      sql = sql & "aircraft.ac_id, "
      sql = sql & " aircraft.ac_ser_no as ac_ser_nbr, aircraft.ac_reg_no as ac_reg_nbr, "
      sql = sql & " aircraft.ac_mfr_year as ac_year_mfr, aircraft_model.amod_id, "
      sql = sql & "aircraft_model.amod_make_name, aircraft_model.amod_model_name "
      sql = sql & "FROM   aircraft with (NOLOCK) INNER JOIN "
      sql = sql & "aircraft_model WITH(NOLOCK) ON aircraft.ac_amod_id = aircraft_model.amod_id "
      sql = sql & " WHERE ac_id in (" & ac_id & ") and ac_journ_id = 0 "


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)


      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString

      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Return atemptable
    Catch ex As Exception
      GetJETNET_AC_NAME_InClause = Nothing
      Me.class_error = "Error in GetJETNET_AC_NAME_InClause(ByVal ac_id As String, ByRef aError As String) As DataTable  SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing

    End Try


  End Function

  ''' <summary>
  ''' The AC Picture and related picture query
  ''' </summary>
  ''' <param name="ac_id"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function GetJETNET_AC_pictures(ByVal ac_id As Long, ByVal journ_id As Long) As DataTable
    Dim sql As String = ""
    Dim atemptable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try

      sql = "SELECT * FROM Aircraft_Pictures WITH(NOLOCK) WHERE acpic_ac_id = " & ac_id.ToString
      sql &= " AND acpic_journ_id = " & journ_id.ToString & " AND acpic_hide_flag = 'N' ORDER BY acpic_seq_no"


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString

      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Return atemptable
    Catch ex As Exception
      GetJETNET_AC_pictures = Nothing
      Me.class_error = "Error in GetJETNET_AC_pictures(ByVal ac_id As Long, ByVal journ_id As Long) As DataTable  SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing

    End Try


  End Function

  Public Function GetJETNET_Yacht_pictures(ByVal yt_id As Long, ByVal journ_id As Long) As DataTable
    Dim sql As String = ""
    Dim atemptable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try

      sql = "SELECT * FROM Yacht_Pictures WITH(NOLOCK) WHERE ytpic_yt_id = " & yt_id.ToString
      sql &= " AND ytpic_journ_id = " & journ_id.ToString & " AND ytpic_hide_flag = 'N' ORDER BY ytpic_seq_no"


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString

      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Return atemptable
    Catch ex As Exception
      GetJETNET_Yacht_pictures = Nothing
      Me.class_error = "Error in GetJETNET_AC_pictures(ByVal ac_id As Long, ByVal journ_id As Long) As DataTable  SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing

    End Try


  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: GetAircraft_Lease_acID_ExpFlag
  ' Purpose: to get the aircraft lease info based on the ac_id and the expr flag (Y or N)
  ' Parameters: AC_ID
  ' Return: 
  '       DataTable
  ' Change Log
  '           1/6/2012   - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function GetAircraft_Lease_acID_ExpFlag(ByVal ac_id As Long, ByVal expr_flag As String, ByVal journID As Long) As DataTable
    Dim sql As String = ""
    Dim atemptable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader : SqlReader = Nothing
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try

      sql = " SELECT aclease_ac_id, aclease_entry_date as aclease_date_entered, aclease_expiration_date as aclease_date_expiration, "
      sql = sql & " aclease_exp_confirm_date as aclease_date_expiration_confirmed, aclease_expired as aclease_expired_flag, "
      sql = sql & " aclease_note, aclease_percentage, aclease_term, aclease_journ_id as aclease_trans_id, aclease_type FROM aircraft_lease WITH(NOLOCK) WHERE "
      sql = sql & " (aclease_ac_id = " & ac_id & ") "
      sql = sql & "AND (aclease_expired = '" & expr_flag & "') "
      If journID <> 0 Then
        sql = sql & " and aclease_journ_id = " & journID
      End If

      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString

      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      Return atemptable

    Catch ex As Exception
      GetAircraft_Lease_acID_ExpFlag = Nothing
      Me.class_error = "Error in GetAircraft_Lease_acID_ExpFlag(ByVal ac_id As Integer, ByVal expr_flag As String)  SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing

    End Try


  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: GetJETNET_Aircraft_Propeller
  ' Purpose: to get aircraft propeller info
  ' Parameters: AC_ID
  ' Return: 
  '       DataTable
  ' Change Log
  '           1/9/2011    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function GetJETNET_Aircraft_Propeller(ByVal ac_id As Long) As DataTable
    Dim sql As String = ""
    Dim atemptable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader : SqlReader = Nothing
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try
      sql = " SELECT ac_id, ac_prop_1_soh_moyear, ac_prop_1_ser_no, ac_prop_1_soh_hrs, ac_prop_1_snew_hrs, ac_prop_2_soh_moyear, "
      sql = sql & " ac_prop_2_ser_no, ac_prop_2_soh_hrs, ac_prop_2_snew_hrs, ac_prop_3_soh_moyear, ac_prop_3_ser_no, ac_prop_3_soh_hrs, "
      sql = sql & "ac_prop_3_snew_hrs, ac_prop_4_soh_moyear, ac_prop_4_ser_no, ac_prop_4_soh_hrs, ac_prop_4_snew_hrs FROM aircraft with (NOLOCK) "
      sql = sql & " WHERE (ac_id = " & ac_id & "  and ac_journ_id = 0) ORDER BY ac_id"

      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString

      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      Return atemptable
    Catch ex As Exception
      GetJETNET_Aircraft_Propeller = Nothing
      Me.class_error = "Error in GetJETNET_Aircraft_Propeller(ByVal ac_id As Integer)  SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing

    End Try


  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: GetAircraft_Listing_wContacts
  ' Purpose: to get an Aircraft Listing page with Model/Make, Ser/Reg, Owner Tot_hrs, Status with all it's contacts
  ' Parameters: ac_id
  ' Return: 
  '       DataTable
  ' Change Log
  '           1/20/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function GetAircraft_Listing_wContacts(ByVal ac_id As Long, ByVal source As String) As DataTable
    Dim client_sql As String = ""
    Dim jetnet_sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader : SqlReader = Nothing
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim aTempTable As New DataTable

    aTempTable.Columns.Add("ac_id")
    aTempTable.Columns.Add("ac_amod_id")
    aTempTable.Columns.Add("ac_ser_nbr")
    aTempTable.Columns.Add("ac_reg_nbr")
    aTempTable.Columns.Add("ac_airframe_total_hours")
    aTempTable.Columns.Add("amod_make_name")
    aTempTable.Columns.Add("amod_make_type")
    aTempTable.Columns.Add("amod_model_name")
    aTempTable.Columns.Add("comp_name")
    aTempTable.Columns.Add("comp_country")
    aTempTable.Columns.Add("comp_state")
    aTempTable.Columns.Add("comp_city")
    aTempTable.Columns.Add("ac_status")
    aTempTable.Columns.Add("ac_year_mfr")
    aTempTable.Columns.Add("contact_sirname")
    aTempTable.Columns.Add("contact_first_name")
    aTempTable.Columns.Add("contact_middle_initial")
    aTempTable.Columns.Add("contact_last_name")
    aTempTable.Columns.Add("contact_suffix")
    aTempTable.Columns.Add("act_name")
    aTempTable.Columns.Add("ac_forsale_flag")
    aTempTable.Columns.Add("ac_exclusive_flag")
    aTempTable.Columns.Add("ac_asking_wordage")
    aTempTable.Columns.Add("ac_asking_price")
    aTempTable.Columns.Add("ac_date_listed")
    aTempTable.Columns.Add("ac_product_business_flag")
    aTempTable.Columns.Add("ac_product_helicopter_flag")
    aTempTable.Columns.Add("ac_product_commercial_flag")
    aTempTable.Columns.Add("ac_lease_flag")
    aTempTable.Columns.Add("comp_id")
    aTempTable.Columns.Add("contact_id")
    aTempTable.Columns.Add("source")
    aTempTable.Columns.Add("ac_delivery")
    aTempTable.Columns.Add("acref_owner_percentage")
    aTempTable.Columns.Add("comp_jetnet_id")

    Try

      Select Case UCase(source)
        Case "JETNET"
          jetnet_sql = " Select DISTINCT"
          jetnet_sql = jetnet_sql & " Aircraft.ac_id, Aircraft.ac_amod_id, Aircraft.ac_ser_no as ac_ser_nbr, Aircraft.ac_reg_no as ac_reg_nbr, ac_airframe_tot_hrs as ac_airframe_total_hours, Aircraft_Model.amod_make_name, Aircraft_Model.amod_type_code as amod_make_type,"
          jetnet_sql = jetnet_sql & "  Aircraft_Model.amod_model_name, Company.comp_name, Company.comp_country, Company.comp_state, Company.comp_city, Aircraft.ac_status, "
          jetnet_sql = jetnet_sql & " Aircraft.ac_mfr_year as ac_year_mfr, Contact.contact_sirname, Contact.contact_first_name, Contact.contact_middle_initial,"
          jetnet_sql = jetnet_sql & " Contact.contact_last_name, Contact.contact_suffix, "
          jetnet_sql = jetnet_sql & " actype_name as act_name, Aircraft.ac_forsale_flag, Aircraft.ac_exclusive_flag, Aircraft.ac_asking as ac_asking_wordage, Aircraft.ac_asking_price, aircraft.ac_list_date as ac_date_listed, "
          jetnet_sql = jetnet_sql & " aircraft.ac_product_business_flag, aircraft.ac_product_helicopter_flag, aircraft.ac_product_commercial_flag,"
          jetnet_sql = jetnet_sql & "  Aircraft.ac_lease_flag, Company.comp_id, Contact.contact_id, 'JETNET' AS source, aircraft.ac_delivery, aircraft_reference.cref_owner_percent as acref_owner_percentage"
          jetnet_sql = jetnet_sql & " FROM (((Company with (NOLOCK) INNER JOIN "
          jetnet_sql = jetnet_sql & " ((Aircraft WITH (NOLOCK) INNER JOIN"
          jetnet_sql = jetnet_sql & "  Aircraft_Model with (NOLOCK) ON Aircraft.ac_amod_id = Aircraft_Model.amod_id) INNER JOIN"
          jetnet_sql = jetnet_sql & " Aircraft_Reference with (NOLOCK) ON Aircraft.ac_id = Aircraft_Reference.cref_ac_id and aircraft_reference.cref_journ_id = ac_journ_id ) ON Company.comp_id = Aircraft_Reference.cref_comp_id and aircraft_reference.cref_journ_id = comp_journ_id)  left outer join"
          jetnet_sql = jetnet_sql & "  Contact ON Company.comp_id = Contact.contact_comp_id AND Aircraft_Reference.cref_contact_id = Contact.contact_id and aircraft_reference.cref_journ_id = contact_journ_id) INNER JOIN"
          jetnet_sql = jetnet_sql & " Aircraft_Contact_Type with (NOLOCK) ON Aircraft_Reference.cref_contact_type = Aircraft_Contact_Type.actype_code)"
          jetnet_sql = jetnet_sql & " WHERE (ac_journ_id = 0 and aircraft.ac_id = " & ac_id & ") order by comp_id"

          SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString

          clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, jetnet_sql.ToString)
          SqlConn.Open()
          SqlCommand.Connection = SqlConn

          SqlCommand.CommandText = jetnet_sql
          SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
          SqlCommand.CommandType = CommandType.Text
          SqlCommand.CommandTimeout = 60

          While SqlReader.Read()
            Dim newCustomersRow As DataRow = aTempTable.NewRow()

            newCustomersRow("ac_id") = SqlReader.Item("ac_id")
            newCustomersRow("ac_amod_id") = SqlReader.Item("ac_amod_id")
            newCustomersRow("ac_ser_nbr") = SqlReader.Item("ac_ser_nbr")
            newCustomersRow("ac_reg_nbr") = SqlReader.Item("ac_reg_nbr")
            newCustomersRow("ac_airframe_total_hours") = SqlReader.Item("ac_airframe_total_hours")
            newCustomersRow("amod_make_name") = SqlReader.Item("amod_make_name")
            newCustomersRow("amod_make_type") = SqlReader.Item("amod_make_type")
            newCustomersRow("amod_model_name") = SqlReader.Item("amod_model_name")
            newCustomersRow("comp_name") = SqlReader.Item("comp_name")
            newCustomersRow("comp_country") = SqlReader.Item("comp_country")
            newCustomersRow("comp_state") = SqlReader.Item("comp_state")

            newCustomersRow("comp_city") = SqlReader.Item("comp_city")
            newCustomersRow("ac_status") = SqlReader.Item("ac_status")
            newCustomersRow("ac_year_mfr") = SqlReader.Item("ac_year_mfr")
            newCustomersRow("contact_sirname") = SqlReader.Item("contact_sirname")
            newCustomersRow("contact_first_name") = SqlReader.Item("contact_first_name")
            newCustomersRow("contact_middle_initial") = SqlReader.Item("contact_middle_initial")
            newCustomersRow("contact_last_name") = SqlReader.Item("contact_last_name")
            newCustomersRow("contact_suffix") = SqlReader.Item("contact_suffix")
            newCustomersRow("act_name") = SqlReader.Item("act_name")
            newCustomersRow("ac_forsale_flag") = SqlReader.Item("ac_forsale_flag")
            newCustomersRow("ac_exclusive_flag") = SqlReader.Item("ac_exclusive_flag")
            newCustomersRow("ac_asking_wordage") = SqlReader.Item("ac_asking_wordage")
            newCustomersRow("ac_asking_price") = SqlReader.Item("ac_asking_price")
            newCustomersRow("ac_date_listed") = SqlReader.Item("ac_date_listed")
            newCustomersRow("ac_product_business_flag") = SqlReader.Item("ac_product_business_flag")
            newCustomersRow("ac_product_helicopter_flag") = SqlReader.Item("ac_product_helicopter_flag")
            newCustomersRow("ac_product_commercial_flag") = SqlReader.Item("ac_product_commercial_flag")
            newCustomersRow("ac_lease_flag") = SqlReader.Item("ac_lease_flag")
            newCustomersRow("comp_id") = SqlReader.Item("comp_id")
            newCustomersRow("contact_id") = SqlReader.Item("contact_id")
            newCustomersRow("source") = SqlReader.Item("source")
            newCustomersRow("ac_delivery") = SqlReader.Item("ac_delivery")
            newCustomersRow("acref_owner_percentage") = SqlReader.Item("acref_owner_percentage")
            newCustomersRow("comp_jetnet_id") = 0


            aTempTable.Rows.Add(newCustomersRow)
            aTempTable.AcceptChanges()
          End While
          SqlReader.Close()
        Case Else
          client_sql = ""
          client_sql = client_sql & "  Select DISTINCT"
          client_sql = client_sql & "  Client_Aircraft.cliaircraft_id AS ac_id, Client_Aircraft_Model.cliamod_id AS ac_amod_id, Client_Aircraft.cliaircraft_ser_nbr AS ac_ser_nbr, "
          client_sql = client_sql & "  Client_Aircraft.cliaircraft_reg_nbr AS ac_reg_nbr, 'N/A' AS ac_airframe_tot_hrs, Client_Aircraft_Model.cliamod_make_name AS amod_make_name, "
          client_sql = client_sql & "  Client_Aircraft_Model.cliamod_model_name AS amod_model_name,  Client_Aircraft_Model.cliamod_make_type as amod_make_type, Client_Company.clicomp_name AS comp_name, "
          client_sql = client_sql & "  Client_Company.clicomp_country AS comp_country, Client_Company.clicomp_city AS comp_city, Client_Company.clicomp_state AS comp_state, "
          client_sql = client_sql & "  Client_Aircraft.cliaircraft_status AS ac_status, Client_Aircraft.cliaircraft_year_mfr AS ac_year_mfr, Client_Contact.clicontact_sirname AS contact_sirname, "
          client_sql = client_sql & "  Client_Contact.clicontact_first_name AS contact_first_name, Client_Contact.clicontact_middle_initial AS contact_middle_initial, "
          client_sql = client_sql & "  Client_Contact.clicontact_last_name AS contact_last_name, Client_Contact.clicontact_suffix AS contact_suffix, Client_Aircraft_Contact_Type.cliact_name AS act_name, Client_Aircraft.cliaircraft_forsale_flag AS ac_forsale_flag, Client_Aircraft.cliaircraft_exclusive_flag AS ac_exclusive_flag, Client_Aircraft.cliaircraft_asking_wordage AS ac_asking_wordage, "
          client_sql = client_sql & "  Client_Aircraft.cliaircraft_asking_price AS ac_asking_price, Client_Aircraft.cliaircraft_lease_flag AS ac_lease_flag, Client_Company.clicomp_id AS comp_id, client_aircraft.cliaircraft_date_listed as ac_date_listed, client_aircraft.cliaircraft_est_price as ac_est_price, "
          client_sql = client_sql & "  client_aircraft.cliaircraft_product_business_flag as ac_product_business_flag, "
          client_sql = client_sql & "  client_aircraft.cliaircraft_product_helicopter_flag as ac_product_helicopter_flag, client_aircraft.cliaircraft_product_commercial_flag as ac_product_commercial_flag, "
          client_sql = client_sql & "  Client_Contact.clicontact_id AS contact_id, client_company.clicomp_jetnet_comp_id as comp_jetnet_id, "
          client_sql = client_sql & "  'CLIENT' AS source, "
          client_sql = client_sql & "  client_aircraft.cliaircraft_delivery AS ac_delivery, client_aircraft_reference.cliacref_owner_percentage AS acref_owner_percentage"
          client_sql = client_sql & "  FROM  client_aircraft LEFT OUTER JOIN"
          client_sql = client_sql & "  client_aircraft_reference ON client_aircraft.cliaircraft_id = client_aircraft_reference.cliacref_cliac_id LEFT OUTER JOIN"
          client_sql = client_sql & "  client_company ON client_aircraft_reference.cliacref_comp_id = client_company.clicomp_id LEFT OUTER JOIN"
          client_sql = client_sql & "  client_contact ON client_aircraft_reference.cliacref_contact_id = client_contact.clicontact_id LEFT OUTER JOIN"
          client_sql = client_sql & "  client_aircraft_contact_type ON client_aircraft_reference.cliacref_contact_type = client_aircraft_contact_type.cliact_type LEFT OUTER JOIN"
          client_sql = client_sql & "  client_aircraft_model ON client_aircraft.cliaircraft_cliamod_id = client_aircraft_model.cliamod_id"
          client_sql = client_sql & "  WHERE (cliaircraft_id = " & ac_id & ") order by comp_id"


          MySqlConn.ConnectionString = Me.client_DB
          MySqlConn.Open()
          MySqlCommand.Connection = MySqlConn
          MySqlCommand.CommandType = CommandType.Text
          MySqlCommand.CommandTimeout = 60
          MySqlCommand.CommandText = client_sql


          clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, client_sql.ToString)

          MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
          While MySqlReader.Read()
            Dim newCustomersRow As DataRow = aTempTable.NewRow()

            newCustomersRow("ac_id") = MySqlReader.Item("ac_id")
            newCustomersRow("ac_amod_id") = MySqlReader.Item("ac_amod_id")
            newCustomersRow("ac_ser_nbr") = MySqlReader.Item("ac_ser_nbr")
            newCustomersRow("ac_reg_nbr") = MySqlReader.Item("ac_reg_nbr")
            newCustomersRow("ac_airframe_total_hours") = MySqlReader.Item("ac_airframe_tot_hrs")
            newCustomersRow("amod_make_name") = MySqlReader.Item("amod_make_name")
            newCustomersRow("amod_make_type") = MySqlReader.Item("amod_make_type")
            newCustomersRow("amod_model_name") = MySqlReader.Item("amod_model_name")
            newCustomersRow("comp_name") = MySqlReader.Item("comp_name")
            newCustomersRow("comp_country") = MySqlReader.Item("comp_country")
            newCustomersRow("comp_state") = MySqlReader.Item("comp_state")

            newCustomersRow("comp_city") = MySqlReader.Item("comp_city")
            newCustomersRow("ac_status") = MySqlReader.Item("ac_status")
            newCustomersRow("ac_year_mfr") = MySqlReader.Item("ac_year_mfr")
            newCustomersRow("contact_sirname") = MySqlReader.Item("contact_sirname")
            newCustomersRow("contact_first_name") = MySqlReader.Item("contact_first_name")
            newCustomersRow("contact_middle_initial") = MySqlReader.Item("contact_middle_initial")
            newCustomersRow("contact_last_name") = MySqlReader.Item("contact_last_name")
            newCustomersRow("contact_suffix") = MySqlReader.Item("contact_suffix")
            newCustomersRow("act_name") = MySqlReader.Item("act_name")
            newCustomersRow("ac_forsale_flag") = MySqlReader.Item("ac_forsale_flag")
            newCustomersRow("ac_exclusive_flag") = MySqlReader.Item("ac_exclusive_flag")
            newCustomersRow("ac_asking_wordage") = MySqlReader.Item("ac_asking_wordage")
            newCustomersRow("ac_asking_price") = MySqlReader.Item("ac_asking_price")
            newCustomersRow("ac_date_listed") = MySqlReader.Item("ac_date_listed")
            newCustomersRow("ac_product_business_flag") = MySqlReader.Item("ac_product_business_flag")
            newCustomersRow("ac_product_helicopter_flag") = MySqlReader.Item("ac_product_helicopter_flag")
            newCustomersRow("ac_product_commercial_flag") = MySqlReader.Item("ac_product_commercial_flag")
            newCustomersRow("ac_lease_flag") = MySqlReader.Item("ac_lease_flag")
            newCustomersRow("comp_id") = MySqlReader.Item("comp_id")
            newCustomersRow("contact_id") = MySqlReader.Item("contact_id")
            newCustomersRow("source") = MySqlReader.Item("source")
            newCustomersRow("ac_delivery") = MySqlReader.Item("ac_delivery")
            newCustomersRow("acref_owner_percentage") = MySqlReader.Item("acref_owner_percentage")
            newCustomersRow("comp_jetnet_id") = MySqlReader.Item("comp_jetnet_id")


            aTempTable.Rows.Add(newCustomersRow)
            aTempTable.AcceptChanges()
          End While

          MySqlReader.Close()
      End Select
      Return aTempTable
    Catch ex As Exception
      Return Nothing
      Me.class_error = "Error in GetAircraft_Listing_wContacts(ByVal ac_id As Integer, ByVal source As String): " & ex.Message
    Finally
      SqlReader = Nothing
      MySqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing




      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try


  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: GetAircraft_Listing_wContacts_WITHOUTID
  ' Purpose: to get an Aircraft Listing page with Model/Make, Ser/Reg, Owner Tot_hrs, Status with all it's contacts
  ' Parameters: ac_id
  ' Return: 
  '       DataTable
  ' Change Log
  '           6/25/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function GetAircraft_Listing_wContacts_WITHOUTID(ByVal ac_id As Long, ByVal source As String, ByVal id_array As String) As DataTable
    Dim client_sql As String = ""
    Dim jetnet_sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader : SqlReader = Nothing
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim aTempTable As New DataTable

    aTempTable.Columns.Add("ac_id")
    aTempTable.Columns.Add("ac_amod_id")
    aTempTable.Columns.Add("ac_ser_nbr")
    aTempTable.Columns.Add("ac_reg_nbr")
    aTempTable.Columns.Add("ac_airframe_total_hours")
    aTempTable.Columns.Add("amod_make_name")
    aTempTable.Columns.Add("amod_make_type")
    aTempTable.Columns.Add("amod_model_name")
    aTempTable.Columns.Add("comp_name")
    aTempTable.Columns.Add("comp_country")
    aTempTable.Columns.Add("comp_state")
    aTempTable.Columns.Add("comp_city")
    aTempTable.Columns.Add("ac_status")
    aTempTable.Columns.Add("ac_year_mfr")
    aTempTable.Columns.Add("contact_sirname")
    aTempTable.Columns.Add("contact_first_name")
    aTempTable.Columns.Add("contact_middle_initial")
    aTempTable.Columns.Add("contact_last_name")
    aTempTable.Columns.Add("contact_suffix")
    aTempTable.Columns.Add("act_name")
    aTempTable.Columns.Add("ac_forsale_flag")
    aTempTable.Columns.Add("ac_exclusive_flag")
    aTempTable.Columns.Add("ac_asking_wordage")
    aTempTable.Columns.Add("ac_asking_price")
    aTempTable.Columns.Add("ac_date_listed")
    aTempTable.Columns.Add("ac_product_business_flag")
    aTempTable.Columns.Add("ac_product_helicopter_flag")
    aTempTable.Columns.Add("ac_product_commercial_flag")
    aTempTable.Columns.Add("ac_lease_flag")
    aTempTable.Columns.Add("comp_id")
    aTempTable.Columns.Add("contact_id")
    aTempTable.Columns.Add("source")
    aTempTable.Columns.Add("ac_delivery")
    aTempTable.Columns.Add("acref_owner_percentage")


    Try

      Select Case UCase(source)
        Case "JETNET"
          jetnet_sql = " Select DISTINCT"
          jetnet_sql = jetnet_sql & " Aircraft.ac_id, Aircraft.ac_amod_id, Aircraft.ac_ser_no as ac_ser_nbr, Aircraft.ac_reg_no as ac_reg_nbr, ac_airframe_tot_hrs as ac_airframe_total_hours, Aircraft_Model.amod_make_name, Aircraft_Model.amod_type_code as amod_make_type,"
          jetnet_sql = jetnet_sql & "  Aircraft_Model.amod_model_name, Company.comp_name, Company.comp_country, Company.comp_state, Company.comp_city, Aircraft.ac_status, "
          jetnet_sql = jetnet_sql & " Aircraft.ac_mfr_year as ac_year_mfr, Contact.contact_sirname, Contact.contact_first_name, Contact.contact_middle_initial,"
          jetnet_sql = jetnet_sql & " Contact.contact_last_name, Contact.contact_suffix, "
          jetnet_sql = jetnet_sql & " actype_name as act_name, Aircraft.ac_forsale_flag, Aircraft.ac_exclusive_flag, Aircraft.ac_asking as ac_asking_wordage, Aircraft.ac_asking_price, aircraft.ac_list_date as ac_date_listed, "
          jetnet_sql = jetnet_sql & " aircraft.ac_product_business_flag, aircraft.ac_product_helicopter_flag, aircraft.ac_product_commercial_flag,"
          jetnet_sql = jetnet_sql & "  Aircraft.ac_lease_flag, Company.comp_id, Contact.contact_id, 'JETNET' AS source, aircraft.ac_delivery, aircraft_reference.cref_owner_percent as acref_owner_percentage"
          jetnet_sql = jetnet_sql & " FROM (((Company with (NOLOCK) INNER JOIN "
          jetnet_sql = jetnet_sql & " ((Aircraft WITH (NOLOCK) INNER JOIN"
          jetnet_sql = jetnet_sql & "  Aircraft_Model with (NOLOCK) ON Aircraft.ac_amod_id = Aircraft_Model.amod_id) INNER JOIN"
          jetnet_sql = jetnet_sql & " Aircraft_Reference with (NOLOCK) ON Aircraft.ac_id = Aircraft_Reference.cref_ac_id and aircraft_reference.cref_journ_id = ac_journ_id ) ON Company.comp_id = Aircraft_Reference.cref_comp_id and aircraft_reference.cref_journ_id = comp_journ_id)  left outer join"
          jetnet_sql = jetnet_sql & "  Contact ON Company.comp_id = Contact.contact_comp_id AND Aircraft_Reference.cref_contact_id = Contact.contact_id and aircraft_reference.cref_journ_id = contact_journ_id) INNER JOIN"
          jetnet_sql = jetnet_sql & " Aircraft_Contact_Type with (NOLOCK) ON Aircraft_Reference.cref_contact_type = Aircraft_Contact_Type.actype_code)"
          jetnet_sql = jetnet_sql & " WHERE (ac_journ_id = 0 and aircraft.ac_id = " & ac_id
          If id_array <> "" Then
            jetnet_sql = jetnet_sql & " and comp_id NOT in(" & id_array & ") "
          End If
          jetnet_sql = jetnet_sql & " ) order by comp_id"

          SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString

          clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, jetnet_sql.ToString)
          SqlConn.Open()
          SqlCommand.Connection = SqlConn

          SqlCommand.CommandText = jetnet_sql
          SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
          SqlCommand.CommandType = CommandType.Text
          SqlCommand.CommandTimeout = 60

          While SqlReader.Read()
            Dim newCustomersRow As DataRow = aTempTable.NewRow()

            newCustomersRow("ac_id") = SqlReader.Item("ac_id")
            newCustomersRow("ac_amod_id") = SqlReader.Item("ac_amod_id")
            newCustomersRow("ac_ser_nbr") = SqlReader.Item("ac_ser_nbr")
            newCustomersRow("ac_reg_nbr") = SqlReader.Item("ac_reg_nbr")
            newCustomersRow("ac_airframe_total_hours") = SqlReader.Item("ac_airframe_total_hours")
            newCustomersRow("amod_make_name") = SqlReader.Item("amod_make_name")
            newCustomersRow("amod_make_type") = SqlReader.Item("amod_make_type")
            newCustomersRow("amod_model_name") = SqlReader.Item("amod_model_name")
            newCustomersRow("comp_name") = SqlReader.Item("comp_name")
            newCustomersRow("comp_country") = SqlReader.Item("comp_country")
            newCustomersRow("comp_state") = SqlReader.Item("comp_state")

            newCustomersRow("comp_city") = SqlReader.Item("comp_city")
            newCustomersRow("ac_status") = SqlReader.Item("ac_status")
            newCustomersRow("ac_year_mfr") = SqlReader.Item("ac_year_mfr")
            newCustomersRow("contact_sirname") = SqlReader.Item("contact_sirname")
            newCustomersRow("contact_first_name") = SqlReader.Item("contact_first_name")
            newCustomersRow("contact_middle_initial") = SqlReader.Item("contact_middle_initial")
            newCustomersRow("contact_last_name") = SqlReader.Item("contact_last_name")
            newCustomersRow("contact_suffix") = SqlReader.Item("contact_suffix")
            newCustomersRow("act_name") = SqlReader.Item("act_name")
            newCustomersRow("ac_forsale_flag") = SqlReader.Item("ac_forsale_flag")
            newCustomersRow("ac_exclusive_flag") = SqlReader.Item("ac_exclusive_flag")
            newCustomersRow("ac_asking_wordage") = SqlReader.Item("ac_asking_wordage")
            newCustomersRow("ac_asking_price") = SqlReader.Item("ac_asking_price")
            newCustomersRow("ac_date_listed") = SqlReader.Item("ac_date_listed")
            newCustomersRow("ac_product_business_flag") = SqlReader.Item("ac_product_business_flag")
            newCustomersRow("ac_product_helicopter_flag") = SqlReader.Item("ac_product_helicopter_flag")
            newCustomersRow("ac_product_commercial_flag") = SqlReader.Item("ac_product_commercial_flag")
            newCustomersRow("ac_lease_flag") = SqlReader.Item("ac_lease_flag")
            newCustomersRow("comp_id") = SqlReader.Item("comp_id")
            newCustomersRow("contact_id") = SqlReader.Item("contact_id")
            newCustomersRow("source") = SqlReader.Item("source")
            newCustomersRow("ac_delivery") = SqlReader.Item("ac_delivery")
            newCustomersRow("acref_owner_percentage") = SqlReader.Item("acref_owner_percentage")



            aTempTable.Rows.Add(newCustomersRow)
            aTempTable.AcceptChanges()
          End While
          SqlReader.Close()
        Case Else
          client_sql = ""
          client_sql = client_sql & "  Select DISTINCT"
          client_sql = client_sql & "  Client_Aircraft.cliaircraft_id AS ac_id, Client_Aircraft_Model.cliamod_id AS ac_amod_id, Client_Aircraft.cliaircraft_ser_nbr AS ac_ser_nbr, "
          client_sql = client_sql & "  Client_Aircraft.cliaircraft_reg_nbr AS ac_reg_nbr, 'N/A' AS ac_airframe_tot_hrs, Client_Aircraft_Model.cliamod_make_name AS amod_make_name, "
          client_sql = client_sql & "  Client_Aircraft_Model.cliamod_model_name AS amod_model_name,  Client_Aircraft_Model.cliamod_make_type as amod_make_type, Client_Company.clicomp_name AS comp_name, "
          client_sql = client_sql & "  Client_Company.clicomp_country AS comp_country, Client_Company.clicomp_city AS comp_city, Client_Company.clicomp_state AS comp_state, "
          client_sql = client_sql & "  Client_Aircraft.cliaircraft_status AS ac_status, Client_Aircraft.cliaircraft_year_mfr AS ac_year_mfr, Client_Contact.clicontact_sirname AS contact_sirname, "
          client_sql = client_sql & "  Client_Contact.clicontact_first_name AS contact_first_name, Client_Contact.clicontact_middle_initial AS contact_middle_initial, "
          client_sql = client_sql & "  Client_Contact.clicontact_last_name AS contact_last_name, Client_Contact.clicontact_suffix AS contact_suffix, Client_Aircraft_Contact_Type.cliact_name AS act_name, Client_Aircraft.cliaircraft_forsale_flag AS ac_forsale_flag, Client_Aircraft.cliaircraft_exclusive_flag AS ac_exclusive_flag, Client_Aircraft.cliaircraft_asking_wordage AS ac_asking_wordage, "
          client_sql = client_sql & "  Client_Aircraft.cliaircraft_asking_price AS ac_asking_price, Client_Aircraft.cliaircraft_lease_flag AS ac_lease_flag, Client_Company.clicomp_id AS comp_id, client_aircraft.cliaircraft_date_listed as ac_date_listed, client_aircraft.cliaircraft_est_price as ac_est_price, "
          client_sql = client_sql & "  client_aircraft.cliaircraft_product_business_flag as ac_product_business_flag, "
          client_sql = client_sql & "  client_aircraft.cliaircraft_product_helicopter_flag as ac_product_helicopter_flag, client_aircraft.cliaircraft_product_commercial_flag as ac_product_commercial_flag, "
          client_sql = client_sql & "  Client_Contact.clicontact_id AS contact_id,"
          client_sql = client_sql & "  'CLIENT' AS source, "
          client_sql = client_sql & "  client_aircraft.cliaircraft_delivery AS ac_delivery, client_aircraft_reference.cliacref_owner_percentage AS acref_owner_percentage"
          client_sql = client_sql & "  FROM  client_aircraft LEFT OUTER JOIN"
          client_sql = client_sql & "  client_aircraft_reference ON client_aircraft.cliaircraft_id = client_aircraft_reference.cliacref_cliac_id LEFT OUTER JOIN"
          client_sql = client_sql & "  client_company ON client_aircraft_reference.cliacref_comp_id = client_company.clicomp_id LEFT OUTER JOIN"
          client_sql = client_sql & "  client_contact ON client_aircraft_reference.cliacref_contact_id = client_contact.clicontact_id LEFT OUTER JOIN"
          client_sql = client_sql & "  client_aircraft_contact_type ON client_aircraft_reference.cliacref_contact_type = client_aircraft_contact_type.cliact_type LEFT OUTER JOIN"
          client_sql = client_sql & "  client_aircraft_model ON client_aircraft.cliaircraft_cliamod_id = client_aircraft_model.cliamod_id"
          client_sql = client_sql & "  WHERE (cliaircraft_id = " & ac_id & ") order by comp_id"


          MySqlConn.ConnectionString = Me.client_DB
          MySqlConn.Open()
          MySqlCommand.Connection = MySqlConn
          MySqlCommand.CommandType = CommandType.Text
          MySqlCommand.CommandTimeout = 60
          MySqlCommand.CommandText = client_sql

          clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, client_sql.ToString)

          MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
          While SqlReader.Read()
            Dim newCustomersRow As DataRow = aTempTable.NewRow()

            newCustomersRow("ac_id") = MySqlReader.Item("ac_id")
            newCustomersRow("ac_amod_id") = MySqlReader.Item("ac_amod_id")
            newCustomersRow("ac_ser_nbr") = MySqlReader.Item("ac_ser_nbr")
            newCustomersRow("ac_reg_nbr") = MySqlReader.Item("ac_reg_nbr")
            newCustomersRow("ac_airframe_total_hours") = MySqlReader.Item("ac_airframe_total_hours")
            newCustomersRow("amod_make_name") = MySqlReader.Item("amod_make_name")
            newCustomersRow("amod_make_type") = MySqlReader.Item("amod_make_type")
            newCustomersRow("amod_model_name") = MySqlReader.Item("amod_model_name")
            newCustomersRow("comp_name") = MySqlReader.Item("comp_name")
            newCustomersRow("comp_country") = MySqlReader.Item("comp_country")
            newCustomersRow("comp_state") = MySqlReader.Item("comp_state")

            newCustomersRow("comp_city") = MySqlReader.Item("comp_city")
            newCustomersRow("ac_status") = MySqlReader.Item("ac_status")
            newCustomersRow("ac_year_mfr") = MySqlReader.Item("ac_year_mfr")
            newCustomersRow("contact_sirname") = MySqlReader.Item("contact_sirname")
            newCustomersRow("contact_first_name") = MySqlReader.Item("contact_first_name")
            newCustomersRow("contact_middle_initial") = MySqlReader.Item("contact_middle_initial")
            newCustomersRow("contact_last_name") = MySqlReader.Item("contact_last_name")
            newCustomersRow("contact_suffix") = MySqlReader.Item("contact_suffix")
            newCustomersRow("act_name") = MySqlReader.Item("act_name")
            newCustomersRow("ac_forsale_flag") = MySqlReader.Item("ac_forsale_flag")
            newCustomersRow("ac_exclusive_flag") = MySqlReader.Item("ac_exclusive_flag")
            newCustomersRow("ac_asking_wordage") = MySqlReader.Item("ac_asking_wordage")
            newCustomersRow("ac_asking_price") = MySqlReader.Item("ac_asking_price")
            newCustomersRow("ac_date_listed") = MySqlReader.Item("ac_date_listed")
            newCustomersRow("ac_product_business_flag") = MySqlReader.Item("ac_product_business_flag")
            newCustomersRow("ac_product_helicopter_flag") = MySqlReader.Item("ac_product_helicopter_flag")
            newCustomersRow("ac_product_commercial_flag") = MySqlReader.Item("ac_product_commercial_flag")
            newCustomersRow("ac_lease_flag") = MySqlReader.Item("ac_lease_flag")
            newCustomersRow("comp_id") = MySqlReader.Item("comp_id")
            newCustomersRow("contact_id") = MySqlReader.Item("contact_id")
            newCustomersRow("source") = MySqlReader.Item("source")
            newCustomersRow("ac_delivery") = MySqlReader.Item("ac_delivery")
            newCustomersRow("acref_owner_percentage") = MySqlReader.Item("acref_owner_percentage")



            aTempTable.Rows.Add(newCustomersRow)
            aTempTable.AcceptChanges()
          End While
          MySqlReader.Close()

      End Select
      Return aTempTable
    Catch ex As Exception
      Return Nothing
      Me.class_error = "Error in GetAircraft_Listing_wContacts(ByVal ac_id As Integer, ByVal source As String): " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing


      MySqlReader = Nothing

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing

    End Try


  End Function

  ''' <summary>
  ''' Gets a list of ac certifications
  ''' </summary>
  ''' <param name="ac_id"></param>
  ''' <param name="JournalID"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function GetJETNET_AC_Certs(ByVal ac_id As Long, ByVal JournalID As Long) As DataTable
    Dim sql As String = ""
    Dim atemptable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader : SqlReader = Nothing
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try
      sql = "SELECT accert_name FROM Aircraft_Certified WITH(NOLOCK) WHERE accert_ac_id = " & ac_id
      sql &= " AND accert_ac_journ_id = " & JournalID


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB

      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      Return atemptable
    Catch ex As Exception
      GetJETNET_AC_Certs = Nothing
      Me.class_error = "Error in GetJETNET_AC_Certs(ByVal ac_id As Long, ByVal JournalID As Long) As DataTable  SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing

    End Try


  End Function
#End Region
#Region "Aircraft Pictures"
  Public Function AC_Pictures(ByVal acID As Integer) As DataTable
    Dim temptable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader : SqlReader = Nothing
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim sql As String = ""

    Try

      sql = " SELECT DISTINCT acpic_id, acpic_ac_id, acpic_journ_id, acpic_subject, acpic_image_type, acpic_seq_no "
      sql = sql & " FROM Aircraft_Pictures WITH(NOLOCK)"
      sql = sql & " INNER JOIN Aircraft WITH(NOLOCK) ON acpic_ac_id = ac_id AND acpic_journ_id = ac_journ_id"
      ' sql = sql & " INNER JOIN Aircraft_Model WITH(NOLOCK) ON ac_amod_id = amod_id"
      sql = sql & " WHERE(acpic_ac_id = " & acID & ")"
      sql = sql & " AND acpic_journ_id =  0"
      sql = sql & " AND acpic_image_type = 'jpg'"
      sql = sql & " AND acpic_hide_flag = 'N'"
      sql = sql & " ORDER BY acpic_seq_no"



      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString

      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        temptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = temptable.GetErrors()
      End Try

      Return temptable
    Catch ex As Exception
      Return Nothing
      Me.class_error = "Error in AC_Pictures(ByVal acID As Integer) As DataTable: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing

    End Try

  End Function
#End Region
#Region "Aircraft Reference Record"
  ''' <summary>
  ''' The datahook just performs a lookup to return only the references you pass in the IN clause.
  ''' </summary>
  ''' <param name="acID"></param>
  ''' <param name="RelationshipType">in clause '99,'99','99'</param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Get_EvoAC_RelationshipByType(ByVal acID As Long, ByVal journalID As Long, ByVal RelationshipType As String, Optional ByRef comp_id_list As String = "") As DataTable
    Dim temptable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader : SqlReader = Nothing
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim sql As String = ""
    Dim productSelection As String = ""
    Try

      sql = "SELECT DISTINCT comp_name, comp_id, cref_transmit_seq_no FROM Company WITH(NOLOCK)"
      sql &= " INNER JOIN Aircraft_Reference WITH(NOLOCK) ON (comp_id = cref_comp_id AND comp_journ_id = cref_journ_id)"
      sql &= " WHERE (cref_ac_id = " & acID & " AND cref_journ_id = " & journalID
      sql &= " AND cref_contact_type IN (" & RelationshipType & ")"

      If Trim(comp_id_list) <> "" Then
        sql &= " and comp_id not in (" & Trim(comp_id_list) & ") "
      End If

      sql &= " AND comp_hide_flag = 'N') "
      productSelection = clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(HttpContext.Current.Session.Item("localSubscription"), True, False)

      'If we're passing a journal ID, we can get rid of the active flag = Y.
      If journalID <> 0 Then
        productSelection = Replace(productSelection, "AND comp_active_flag = 'Y'", "")
      End If


      sql &= productSelection
      sql &= " ORDER BY cref_transmit_seq_no"


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
      SqlConn.ConnectionString = JETNET_DB

      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        temptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = temptable.GetErrors()
      End Try

      Return temptable
    Catch ex As Exception
      Return Nothing
      Me.class_error = "Error in Get_EvoAC_RelationshipByType(ByVal acID As Long, ByVal journalID As Long, ByVal RelationshipType As String) As DataTable: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing

    End Try

  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Aircraft_Reference_JETNET_compID
  ' Purpose: to get an aircraft reference record based on the compID
  ' Parameters: compID 
  ' Return: 
  '       Boolean
  ' Change Log
  '           1/20/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

  Public Function Get_Aircraft_Reference_JETNET_compID(ByVal compID As Integer) As DataTable
    Dim temptable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader : SqlReader = Nothing
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim sql As String = ""

    Try

      sql = " SELECT  cref_id as acref_id, cref_ac_id as acref_ac_id, cref_comp_id as acref_comp_id, cref_contact_id as acref_contact_id, "
      sql = sql & " cref_contact_type as acref_contact_type, cref_owner_percent as acref_owner_percentage, "
      sql = sql & " cref_fraction_expires_date as acref_date_fraction_purchased, cref_fraction_expires_date as acref_date_fraction_expires, "
      sql = sql & " cref_business_type as acref_business_type, cref_operator_flag as acref_operator_flag"
      sql = sql & "  FROM Aircraft_Reference with (NOLOCK) "
      sql = sql & " left outer join contact with (NOLOCK) on cref_contact_id = contact_id and contact_journ_id = cref_journ_id  "
      sql = sql & " WHERE (cref_comp_id = " & compID & " and cref_contact_id = 0 and cref_journ_id = 0) OR (contact_hide_flag = 'Y' and cref_journ_id = 0 and cref_comp_id = " & compID & ")"
      sql = sql & " ORDER BY cref_ac_id ASC, cref_id ASC"


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString

      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        temptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = temptable.GetErrors()
      End Try

      Return temptable
    Catch ex As Exception
      Return Nothing
      Me.class_error = "Error in Get_Aircraft_Reference_JETNET_compID(ByVal compID As Integer) As DataTable: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing

    End Try

  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Aircraft_Reference_JETNET_contactID
  ' Purpose: to get an aircraft reference record based on the compID
  ' Parameters: compID 
  ' Return: 
  '       Boolean
  ' Change Log
  '           1/20/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

  Public Function Get_Aircraft_Reference_JETNET_contactID(ByVal contactID As Integer) As DataTable
    Dim temptable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader : SqlReader = Nothing
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim sql As String = ""

    Try

      sql = " SELECT  cref_id as acref_id, cref_ac_id as acref_ac_id, cref_comp_id as acref_comp_id, cref_contact_id as acref_contact_id, "
      sql = sql & " cref_contact_type as acref_contact_type, cref_owner_percent as acref_owner_percentage, "
      sql = sql & " cref_fraction_expires_date as acref_date_fraction_purchased, cref_fraction_expires_date as acref_date_fraction_expires, "
      sql = sql & " cref_business_type as acref_business_type, cref_operator_flag as acref_operator_flag"
      sql = sql & "  FROM Aircraft_Reference with (NOLOCK) "
      sql = sql & " WHERE cref_contact_id = " & contactID & " and cref_journ_id = 0 "
      sql = sql & " ORDER BY cref_ac_id ASC, cref_id ASC"


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString

      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        temptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = temptable.GetErrors()
      End Try

      Return temptable
    Catch ex As Exception
      Return Nothing
      Me.class_error = "Error in Get_Aircraft_Reference_JETNET_contactID(ByVal contactID As Integer) As DataTable: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing

    End Try

  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Aircraft_Reference_JETNET_compIDONLY (no contactId = 0)
  ' Purpose: to get an aircraft reference record based on the compID
  ' Parameters: compID
  ' Return: 
  '       Boolean
  ' Change Log
  '           2/1/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Aircraft_Reference_JETNET_ONLYcompID(ByVal compID As Integer) As DataTable
    Dim temptable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader : SqlReader = Nothing
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim sql As String = ""

    Try

      sql = " SELECT  cref_id as acref_id, cref_ac_id as acref_ac_id, cref_comp_id as acref_comp_id, cref_contact_id as acref_contact_id, "
      sql = sql & " cref_contact_type as acref_contact_type, cref_owner_percent as acref_owner_percentage, "
      sql = sql & " cref_fraction_expires_date as acref_date_fraction_purchased, cref_fraction_expires_date as acref_date_fraction_expires, "
      sql = sql & " cref_business_type as acref_business_type, cref_operator_flag as acref_operator_flag"
      sql = sql & "  FROM Aircraft_Reference with (NOLOCK) "
      sql = sql & " WHERE (cref_comp_id = " & compID & " and cref_journ_id = 0) "
      sql = sql & " ORDER BY cref_ac_id ASC, cref_id ASC"


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString

      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        temptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = temptable.GetErrors()
      End Try

      Return temptable
    Catch ex As Exception
      Return Nothing
      Me.class_error = "Error in Get_Aircraft_Reference_JETNET_ONLYcompID(ByVal compID As Integer) As DataTable: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing

    End Try

  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Aircraft_Reference_JETNET_contactID
  ' Purpose: to get an aircraft reference record based on the contactID
  ' Parameters: compID
  ' Return: 
  '       Boolean
  ' Change Log
  '           2/1/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

  Public Function Get_Aircraft_Relationship_By_AC(ByVal acID As Integer) As DataTable
    Dim temptable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader : SqlReader = Nothing
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim sql As String = ""

    Try

      sql = " SELECT  cref_id as acref_id, cref_ac_id as acref_ac_id, cref_comp_id as acref_comp_id, cref_contact_id as acref_contact_id, "
      sql = sql & " cref_contact_type as acref_contact_type, cref_owner_percent as acref_owner_percentage, "
      sql = sql & " cref_fraction_expires_date as acref_date_fraction_purchased, cref_fraction_expires_date as acref_date_fraction_expires, "
      sql = sql & " cref_business_type as acref_business_type, cref_operator_flag as acref_operator_flag"
      sql = sql & "  FROM Aircraft_Reference with (NOLOCK) "
      sql = sql & " WHERE cref_ac_id = " & acID & " and cref_journ_id = 0 "
      sql = sql & " ORDER BY cref_ac_id ASC, cref_id ASC"


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString

      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        temptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = temptable.GetErrors()
      End Try

      Return temptable
    Catch ex As Exception
      Return Nothing
      Me.class_error = "Error in Get_Aircraft_Relationship_By_AC(ByVal acID As Integer) As DataTable: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing

    End Try

  End Function
#End Region
#Region "Aircraft Flight"
  Public Function Aircraft_Flight_Results(ByVal regNo As String, ByVal date_ As String) As DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim aTempTable As New DataTable
    Try

      If Not IsDate(date_) Then
        date_ = DateAdd(DateInterval.Day, -90, Now())
      End If


      date_ = Month(date_) & "/" & Day(date_) & "/" & Year(date_)
      sql = " SELECT aractivity_date_depart,"
      sql = sql & " aractivity_origin_aport, (SELECT TOP 1 aport_city + ',' + aport_state + ' (' + aport_iata_code + ')' FROM airport WITH(NOLOCK) "
      sql = sql & " WHERE aport_icao_code = aractivity_origin_aport OR aport_iata_code = aractivity_origin_aport) as origin,"
      sql = sql & " aractivity_dest_aport, (SELECT TOP 1 aport_city + ',' + aport_state + ' (' + aport_iata_code + ')' "
      sql = sql & " FROM airport WITH(NOLOCK) "
      sql = sql & " WHERE aport_icao_code = aractivity_dest_aport OR aport_iata_code = aractivity_dest_aport) as destination,"
      sql = sql & " aractivity_distance, aractivity_flight_time"
      sql = sql & " FROM ARGUS_Activity_Data WITH(NOLOCK) "
      sql = sql & " WHERE aractivity_reg_no = '" & clsGeneral.clsGeneral.StripChars(regNo, False) & "'"
      sql = sql & " and aractivity_date_depart >= '" & date_ & "'"
      sql = sql & " order by aractivity_date_depart desc"


      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable
    Catch ex As Exception
      Aircraft_Flight_Results = Nothing
      Me.class_error = "Error in Aircraft_Flight_Results(ByVal regNo As String, ByVal date_ As String) SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function
  ''' <summary>
  ''' Checks quickly for recent flight activity.
  ''' </summary>
  ''' <param name="regNo"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function EvoCheckFlightActivity(ByVal regNo As String, Optional ByVal test_is_barred As Boolean = False) As DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim aTempTable As New DataTable
    Try

      sql = "SELECT TOP 1 aractivity_id FROM ARGUS_Activity_Data WITH(NOLOCK, INDEX(ix_aractivity_date_depart_reg_no_key)) WHERE aractivity_reg_no = '" & regNo & "' AND aractivity_date_depart >= (getdate()-90)"

      If test_is_barred = True Then
        sql = sql & " and aractivity_reg_no not in (SELECT faablk_reg_no FROM FAA_Blocked_Registration_Numbers WITH (NOLOCK)WHERE faablk_reg_no = '" & regNo & "')"
      End If



      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable
    Catch ex As Exception
      EvoCheckFlightActivity = Nothing
      Me.class_error = "Error in EvoCheckFlightActivity(ByVal regNo As String) As DataTable SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function

  Public Function EvoCheckifBarred(ByVal regNo As String, Optional ByVal test_is_barred As Boolean = False) As DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim aTempTable As New DataTable
    Try

      sql = "SELECT * FROM FAA_Blocked_Registration_Numbers WITH (NOLOCK) WHERE (faablk_reg_no = '" & Trim(regNo) & "') "



      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable
    Catch ex As Exception
      EvoCheckifBarred = Nothing
      Me.class_error = "Error in EvoCheckifBarred(ByVal regNo As String) As DataTable SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function


#End Region
#Region "Aircraft Listing Display"
  Public Function Aircraft_Listing_Company_Display(ByVal id As Integer, ByVal source As String, ByVal operators As String) As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing

    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing


    Dim sql As String = ""
    Dim atemptable As New DataTable
    Try
      Select Case UCase(source)
        Case "JETNET"
          sql = " select comp_id, contact_id as jetnet_contact_id, comp_id as jetnet_comp_id, cref_owner_percent as percentage, comp_name, comp_address1 as comp_address, 'JETNET' as source, comp_address2, comp_city, comp_state, comp_zip_code, comp_country,"
          sql = sql & "comp_email_address, comp_web_address, actype_name,"
          sql = sql & "(select top 1 pnum_number_full from phone_numbers where pnum_type='Office' and pnum_comp_id=tcomp.comp_id and pnum_journ_id = 0 "
          sql = sql & " and pnum_contact_id = 0 and pnum_hide_customer='N') as comp_office_phone,"
          sql = sql & "(select top 1 pnum_number_full from phone_numbers where pnum_type='Fax' and pnum_comp_id=tcomp.comp_id and pnum_journ_id = 0 "
          sql = sql & " and pnum_contact_id = 0 and pnum_hide_customer='N') as comp_fax_phone,"
          sql = sql & " contact_first_name, contact_last_name,contact_middle_initial, contact_title, contact_email_address, contact_email_address "
          sql = sql & " from  aircraft_reference with (NOLOCK) "
          sql = sql & " inner join company as tcomp with (NOLOCK) on cref_comp_id = comp_id and cref_journ_id = comp_journ_id "
          sql = sql & " inner JOIN aircraft_contact_type WITH (NOLOCK) ON cref_contact_type = actype_code "
          sql = sql & " left outer join contact on cref_contact_id = contact_id and cref_journ_id = contact_journ_id and contact_hide_flag='N'"
          sql = sql & " where (cref_ac_id = " & id & ")"
          '-- FOR ACTIVE AIRCRAFT (NOT TRANSACTIONS) FORCE JOURN ID TO 0
          sql = sql & " and cref_journ_id = 0"
          '-- FOR TRANSACTIONS SHOULD BE ABLE TO USE SAME CODE BUT PASS THE JOURNAL ID
          '-- and cref_journ_id = xxxxx
          '-- FOR GETTING JUST OWNERS - THERE ARE A FEW MORE CODES I COULDN'T REMEMBER THAT SHOULD BE IN YOUR CODE
          If operators = "all" Then 'all owners
            sql = sql & " and cref_contact_type in('00','08','97','17','99','56')"
          ElseIf operators = "whole" Then 'whole owners
            sql = sql & " and cref_contact_type in('56','99', '00')"
          ElseIf operators = "fractional" Then 'fractional owners
            sql = sql & " and cref_contact_type in('97','17')"
          ElseIf operators = "shared" Then 'shared owners
            sql = sql & " and cref_contact_type in('08')"
          ElseIf operators = "operators" Then 'operators
            sql = sql & " and cref_operator_flag in ('Y','O') "
          Else
            'ignore, all companies.
          End If

          sql = sql & " order by cref_transmit_seq_no"

          SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
          SqlConn.Open()
          SqlCommand.Connection = SqlConn


          clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

          SqlCommand.CommandText = sql
          SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
          SqlCommand.CommandType = CommandType.Text
          SqlCommand.CommandTimeout = 60


          Try
            atemptable.Load(SqlReader)
          Catch constrExc As System.Data.ConstraintException
            Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
          End Try
          SqlReader.Close()


        Case "CLIENT"
          sql = "Select clicomp_id as comp_id, clicontact_jetnet_contact_id as jetnet_contact_id, clicomp_jetnet_comp_id as jetnet_comp_id, cliacref_owner_percentage as percentage,'CLIENT' as source, clicomp_name as comp_name, clicomp_address1 as comp_address, clicomp_address2 as comp_address2, clicomp_city as comp_city, clicomp_state as comp_state, clicomp_zip_code as comp_zip_code,"
          sql = sql & " Clicomp_country as comp_country, clicomp_email_address as comp_email_address, clicomp_web_address as comp_web_address, cliact_name as actype_name, "
          sql = sql & " (select clipnum_number from client_phone_numbers where clipnum_type='Office' and clipnum_comp_id = tcomp.clicomp_id and clipnum_contact_id = 0 limit 1) as comp_office_phone, "
          sql = sql & " (select clipnum_number from client_phone_numbers where clipnum_type='Fax' and clipnum_comp_id = tcomp.clicomp_id and clipnum_contact_id = 0 limit 1) as comp_fax_phone, clicontact_first_name as contact_first_name, clicontact_last_name as contact_last_name, clicontact_title as contact_title, "
          sql = sql & " clicontact_middle_initial as contact_middle_initial, clicontact_email_address as contact_email_address from client_aircraft_reference "
          sql = sql & " Inner join client_company as tcomp on cliacref_comp_id = clicomp_id "
          sql = sql & " Inner join client_aircraft_contact_type on cliacref_contact_type = cliact_type"
          sql = sql & " Left outer join client_contact on cliacref_contact_id = clicontact_id and clicontact_status = 'Y'"
          sql = sql & " Where(cliacref_cliac_id = " & id & ")"

          If operators = "all" Then 'all owners
            sql = sql & " and cliact_type in('00','08','97','17','99','56')"
          ElseIf operators = "whole" Then 'whole owners
            sql = sql & " and cliact_type in('56','99')"
          ElseIf operators = "fractional" Then 'fractional owners
            sql = sql & " and cliact_type in('97','17')"
          ElseIf operators = "shared" Then 'shared owners
            sql = sql & " and cliact_type in('08')"
          ElseIf operators = "operators" Then 'operators
            sql = sql & " and cliact_type in('99','31', '94','11','35','12','36','18','39')"
          Else
            'ignore, all companies.
          End If


          clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
          MySqlConn.ConnectionString = Me.client_DB
          MySqlConn.Open()
          MySqlCommand.Connection = MySqlConn
          MySqlCommand.CommandType = CommandType.Text
          MySqlCommand.CommandTimeout = 60

          MySqlCommand.CommandText = sql
          MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

          Try
            atemptable.Load(MySqlReader)
          Catch constrExc As System.Data.ConstraintException
            Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
          End Try

          MySqlReader.Close()


      End Select
      Return atemptable
    Catch ex As Exception
      Aircraft_Listing_Company_Display = Nothing
      Me.class_error = "Error in Aircraft_Listing_Company_Display(ByVal id As Integer, ByVal source As String, ByVal operators As String) As DataTable: " & ex.Message
    Finally

      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing


      MySqlReader = Nothing

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
  Public Function Combine_Jetnet_Client_Company_Listing_Display(ByVal table_one As DataTable, ByVal table_two As DataTable) As DataTable
    Dim return_table As New DataTable
    Dim distinct_table As New DataTable
    Dim distinct_table_view As New DataView
    Dim table_of_holding As New DataTable

    'So you want to take two tables and merge them together. They have the exact same fields.
    'First let's create the combined table.
    Dim combined_table As New DataTable
    combined_table.Columns.Add("comp_id")
    combined_table.Columns.Add("jetnet_comp_id")
    combined_table.Columns.Add("jetnet_contact_id")
    combined_table.Columns.Add("percentage")
    combined_table.Columns.Add("source")
    combined_table.Columns.Add("comp_name")
    combined_table.Columns.Add("comp_address")
    combined_table.Columns.Add("comp_address2")
    combined_table.Columns.Add("comp_city")
    combined_table.Columns.Add("comp_state")
    combined_table.Columns.Add("comp_zip_code")
    combined_table.Columns.Add("comp_country")
    combined_table.Columns.Add("comp_email_address")
    combined_table.Columns.Add("comp_web_address")
    combined_table.Columns.Add("actype_name")
    combined_table.Columns.Add("comp_office_phone")
    combined_table.Columns.Add("comp_fax_phone")
    combined_table.Columns.Add("contact_first_name")
    combined_table.Columns.Add("contact_last_name")
    combined_table.Columns.Add("contact_title")
    combined_table.Columns.Add("contact_middle_initial")
    combined_table.Columns.Add("contact_email_address")
    'make a schema copy of this for the return.
    table_of_holding = combined_table.Clone
    return_table = combined_table.Clone
    'now that the datatable schema is created
    'loop through each table to add them together.

    combined_table = Actual_Merge_For_Listing(table_one, combined_table)
    combined_table = Actual_Merge_For_Listing(table_two, combined_table)

    ''create the view to get the distinct values.
    distinct_table_view = combined_table.DefaultView
    ''actually get the distinct values.
    distinct_table = distinct_table_view.ToTable(True, "jetnet_comp_id", "jetnet_contact_id", "actype_name")

    'Now here's the interesting part. For each row in that distinct table
    'we're going to take the original table and filter it based on that unique row, to get the unique information
    For Each t As DataRow In distinct_table.Rows
      Dim afileterd As DataRow() = combined_table.Select("jetnet_comp_id = '" & t("jetnet_comp_id") & "' and actype_name = '" & t("actype_name") & "'", "")
      If afileterd.GetUpperBound(0) = 1 Then
        afileterd = combined_table.Select("jetnet_comp_id = '" & t("jetnet_comp_id") & "' and actype_name = '" & t("actype_name") & "' and source = 'CLIENT' ", "")
      End If
      ' extract and import
      For Each atmpDataRow As DataRow In afileterd
        table_of_holding.ImportRow(atmpDataRow)
      Next
    Next

    Dim afileterd_final As DataRow() = table_of_holding.Select("", "source desc")
    For Each atmpDataRow As DataRow In afileterd_final
      return_table.ImportRow(atmpDataRow)
    Next


    Combine_Jetnet_Client_Company_Listing_Display = return_table
  End Function

  Public Function Actual_Merge_For_Listing(ByVal table As DataTable, ByVal return_table As DataTable) As DataTable
    For Each company As DataRow In table.Rows
      Dim newCustomersRow As DataRow = return_table.NewRow()
      newCustomersRow("comp_id") = company.Item("comp_id")
      newCustomersRow("jetnet_comp_id") = company.Item("jetnet_comp_id")
      newCustomersRow("percentage") = company.Item("percentage")
      newCustomersRow("comp_name") = company.Item("comp_name")
      newCustomersRow("comp_address") = company.Item("comp_address")
      newCustomersRow("comp_address2") = company.Item("comp_address2")
      newCustomersRow("comp_city") = company.Item("comp_city")
      newCustomersRow("comp_state") = company.Item("comp_state")
      newCustomersRow("comp_zip_code") = company.Item("comp_zip_code")
      newCustomersRow("comp_country") = company.Item("comp_country")
      newCustomersRow("comp_email_address") = company.Item("comp_email_address")
      newCustomersRow("comp_web_address") = company.Item("comp_web_address")
      newCustomersRow("actype_name") = company.Item("actype_name")
      newCustomersRow("comp_office_phone") = company.Item("comp_office_phone")
      newCustomersRow("comp_fax_phone") = company.Item("comp_fax_phone")
      newCustomersRow("contact_first_name") = company.Item("contact_first_name")
      newCustomersRow("contact_last_name") = company.Item("contact_last_name")
      newCustomersRow("contact_title") = company.Item("contact_title")
      newCustomersRow("contact_middle_initial") = company.Item("contact_middle_initial")
      newCustomersRow("contact_email_address") = company.Item("contact_email_address")
      newCustomersRow("source") = company.Item("source")
      return_table.Rows.Add(newCustomersRow)
      return_table.AcceptChanges()
    Next

    Return return_table
  End Function
#End Region

  Public Function GetCompanyNews_Listing_compid(ByVal compID As Long, ByVal limit As Boolean, ByVal journ_id As Long) As DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable
    Try
      sql = " select "

      'if the checkbox isnt checked, then limit 
      If limit = False Then
        sql &= " top 10 "
      End If

      sql &= " * from View_Yacht_News "

      If journ_id > 0 Then
        sql &= " inner join Company with (NOLOCK) on company.comp_id = View_Yacht_News.comp_id  "
        sql &= " inner join Journal  with (NOLOCK) on journ_id = company.comp_journ_id  and journ_date >= ytnews_date "
      End If


      sql &= " where View_Yacht_News.comp_id = " & compID & " "

      If journ_id > 0 Then
        sql &= " and company.comp_journ_id = " & journ_id & " "
      End If


      sql &= "order by ytnews_date desc "

      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

    Catch ex As Exception

      Me.class_error = "Error in GetCompanyNews_Listing_compid() As DataTable SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

    Return atemptable

  End Function

#End Region

#Region "Start Company Related Data Queries"
  ''' <summary>
  ''' Returns company certifications based on company ID and journalID
  ''' </summary>
  ''' <param name="compID"></param>
  ''' <param name="JournalID"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Return_Certifications(ByVal compID As Long, ByVal JournalID As Long, Optional ByVal cert_category As String = "") As DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable
    Try
      ' sql = "SELECT ccerttype_id, ccerttype_type, ccerttype_logo_image "
      sql = "SELECT  distinct ccerttype_type, ccerttype_logo_image "
      sql = sql & " FROM company_certification with (NOLOCK) "
      sql = sql & " INNER JOIN company_certification_type WITH(NOLOCK) ON ccert_type_id = ccerttype_id "
      sql = sql & " WHERE (ccert_journ_id = " & JournalID & " AND ccert_comp_id = " & compID

      If Trim(cert_category) = "Certificate" Then
        sql = sql & " and ccerttype_category = 'Certificate' "
      ElseIf Trim(cert_category) = "Membership" Then
        sql = sql & " and ccerttype_category = 'Membership' "
      ElseIf Trim(cert_category) = "Accreditation" Then
        sql = sql & " and ccerttype_category = 'Accreditation' "
      Else
        sql = sql & " and ccerttype_category = 'Certificate' "
      End If

      sql = sql & " AND ccerttype_logo_image IS NOT NULL AND ccerttype_logo_image <> '')"


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
    Catch ex As Exception
      Return Nothing
      Me.class_error = "Error in Return_Certifications(ByVal comp_id As long, JournalID as long): SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

    Return atemptable

  End Function

  Public Function Return_Certifications_AC(ByVal cert_ids As String) As DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable
    Try
      ' sql = "SELECT ccerttype_id, ccerttype_type, ccerttype_logo_image "
      sql = "SELECT  distinct ccert_comp_id "
      sql = sql & " FROM company_certification with (NOLOCK) "
      sql = sql & " INNER JOIN company_certification_type WITH(NOLOCK) ON ccert_type_id = ccerttype_id "
      sql = sql & " WHERE (ccert_id in (" & cert_ids & ") and ccert_journ_id = 0  "
      sql = sql & " AND ccerttype_logo_image IS NOT NULL AND ccerttype_logo_image <> '')"


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
    Catch ex As Exception
      Return Nothing
      Me.class_error = "Error in Return_Certifications(ByVal comp_id As long, JournalID as long): SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

    Return atemptable

  End Function

  ''' <summary>
  ''' Returns business type of Evo company
  ''' </summary>
  ''' <param name="compID"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Return_Business_Type(ByVal compID As Long, ByVal JournalID As Long) As DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable
    Try
      sql = "select distinct cbus_name from business_type_reference WITH(NOLOCK) inner join company_business_type WITH(NOLOCK) on bustypref_type=cbus_type "
      sql = sql & "where bustypref_Comp_id = " & compID & " And bustypref_journ_id = " & JournalID

      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      Return atemptable

    Catch ex As Exception
      Return_Business_Type = Nothing
      Me.class_error = "Error in Return_Business_Type(ByVal compID As Long, JournalID As long): SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Close()
      SqlConn.Dispose()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function

  ''' <summary>
  ''' Returns Share Relationships on DisplayCompanyDetail.aspx
  ''' </summary>
  ''' <param name="compID"></param>
  ''' <param name="JournalID"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Return_Share_Relationships(ByVal compID As Long, ByVal JournalID As Long) As DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable
    Try
      sql = "SELECT DISTINCT amod_make_name, amod_model_name, "
      sql += " ac_year, ac_ser_no_full, ac_reg_no, ac_status, ac_forsale_flag,"
      sql += " ac_id, actype_name, actype_compref_name2, "
      sql += " cref_comp_id, comp_name, comp_city, comp_state, comp_zip_code, comp_country, cref_owner_percent, "
      sql += " cref_contact_id, contact_sirname, contact_first_name, contact_middle_initial, contact_last_name, contact_title"
      sql += " FROM Share_Reference WITH(NOLOCK) "
      sql += " inner join Aircraft_Reference WITH(NOLOCK) on cref_id = sref_cref_id "
      sql += " inner join Aircraft_Contact_Type WITH(NOLOCK) on sref_contact_type = actype_code "
      sql += " inner join Aircraft WITH(NOLOCK) on ac_id = cref_ac_id AND ac_journ_id = cref_journ_id "
      sql += " inner join Aircraft_Model WITH(NOLOCK) on ac_amod_id = amod_id"
      sql += " inner join Company on cref_comp_id = comp_id and cref_journ_id = comp_journ_id"
      sql += " left outer join Contact on cref_contact_id = contact_id and cref_journ_id = contact_journ_id"
      sql += " WHERE (sref_comp_id = " & compID & " and ac_journ_id = " & JournalID & " ) "

      sql += clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(HttpContext.Current.Session.Item("localSubscription"), False, True)


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      Return atemptable

    Catch ex As Exception
      Return_Share_Relationships = Nothing
      Me.class_error = "Error in Return_Share_Relationships(ByVal compID As Long, ByVal JournalID As Long) As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Close()
      SqlConn.Dispose()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function


  ''' <summary>
  ''' Returns Basic Existence of ShareRelationship. Only one field returned.
  ''' </summary>
  ''' <param name="compID">Checks with compID</param>
  ''' <param name="JournalID">Doesn't use Journal ID yet, but passed </param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function ShareRelationshipExist(ByVal compID As Long, ByVal JournalID As Long) As DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable
    Try
      sql = "SELECT distinct actype_name, sref_cref_id, sref_contact_type,  comp_id, comp_name, comp_city, comp_state, comp_zip_code, comp_country, "
      sql += " contact_sirname, contact_id, contact_first_name, contact_middle_initial, contact_last_name, contact_title "
      sql += " FROM Share_Reference WITH(NOLOCK) "
      sql += " INNER JOIN Aircraft_Contact_Type WITH(NOLOCK) ON sref_contact_type = actype_code "
      sql += " INNER JOIN Aircraft_Reference WITH(NOLOCK) ON cref_id = sref_cref_id "
      sql += " INNER JOIN Company WITH(NOLOCK) ON sref_comp_id = comp_id and comp_journ_id = 0 "
      sql += " LEFT OUTER JOIN Contact WITH(NOLOCK) ON sref_contact_id = contact_id and contact_journ_id = 0"
      sql += " WHERE sref_cref_id = " & compID


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      Return atemptable

    Catch ex As Exception
      ShareRelationshipExist = Nothing
      Me.class_error = "Error in ShareRelationshipExist(ByVal compID As Long, ByVal JournalID As Long) : SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Close()
      SqlConn.Dispose()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function



  ''' <summary>
  ''' Here's the problem:
  ''' click on notes and enter a note - while entering you decide to select a new company/contact rather 
  ''' than the one in the list. Need additional parameters to search by including first name and last name of 
  ''' contact, phone number, and email address
  ''' 
  ''' Here's why we can't use an existing function:
  ''' The company search that we use for everywhere else - does not join the contact table. This means that we won't be able
  ''' to ever search on the first/last name of contact using it unless we join the contact table which could have performance issues.
  ''' </summary>
  ''' <param name="data_subset"></param>
  ''' <param name="company_name"></param>
  ''' <param name="first_name"></param>
  ''' <param name="last_name"></param>
  ''' <param name="phone_number"></param>
  ''' <param name="email_address"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Search_CompanysWithContacts(ByVal data_subset As String, ByVal company_name As String, ByVal first_name As String, ByVal last_name As String, ByVal phone_number As String, ByVal email_address As String) As DataTable
    Dim sql As String = ""
    Dim sql_where As String = ""
    Dim andclause As String = ""
    Dim atemptable As New DataTable
    Dim dalTable As New DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    'return table needs: comp_name, comp_address1, comp_address2, comp_city, comp_state, comp_zip_code, comp_country, comp_id, source
    atemptable.Columns.Add("comp_name")
    atemptable.Columns.Add("comp_address1")
    atemptable.Columns.Add("comp_address2")
    atemptable.Columns.Add("comp_city")
    atemptable.Columns.Add("comp_state")
    atemptable.Columns.Add("comp_zip_code")
    atemptable.Columns.Add("comp_country")
    atemptable.Columns.Add("comp_id")
    atemptable.Columns.Add("source")
    atemptable.Columns.Add("jetnet_comp_id")
    Try
      If data_subset = "J" Or data_subset = "JC" Then
        sql = "select distinct comp_name, comp_address1, comp_address2, " &
      " comp_city, comp_state, comp_zip_code, comp_country, comp_id, " &
      " 'JETNET' as source from company left outer join contact on comp_id = " &
      " contact_comp_id and comp_journ_id = contact_journ_id "

        sql_where = " comp_journ_id = 0 "

        If company_name <> "" Then
          If sql_where <> "" Then
            andclause = " and "
          Else
            andclause = ""
          End If

          sql_where = sql_where & andclause & " comp_name_search like '%" & Replace(company_name, " ", "") & "%' "
        End If

        If phone_number <> "" Then
          If sql_where <> "" Then
            andclause = " and "
          Else
            andclause = ""
          End If

          sql_where = sql_where & andclause & " comp_id in (select distinct pnum_comp_id from phone_numbers where pnum_number_full_search like '%" & phone_number & "%' and pnum_journ_id = 0) "
        End If




        If first_name <> "" Then
          If sql_where <> "" Then
            andclause = " and "
          Else
            andclause = ""
          End If
          sql_where = sql_where & andclause & " contact_first_name like '%" & first_name & "%' "
        End If

        If last_name <> "" Then
          If sql_where <> "" Then
            andclause = " and "
          Else
            andclause = ""
          End If
          sql_where = sql_where & andclause & " contact_last_name like '%" & last_name & "%' "
        End If

        If email_address <> "" Then
          If sql_where <> "" Then
            andclause = " and "
          Else
            andclause = ""
          End If
          sql_where = sql_where & andclause & " (contact_email_address like '%" & email_address & "%' "

          sql_where = sql_where & " or comp_email_address like '%" & email_address & "%') "
        End If

        If sql_where <> "" Then
          sql = sql & " where " & sql_where
        End If

        sql = sql & " order by comp_name "


        clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
        SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
        SqlConn.Open()
        SqlCommand.Connection = SqlConn


        SqlCommand.CommandText = sql
        SqlCommand.CommandTimeout = 120
        SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
        SqlCommand.CommandType = CommandType.Text


        While SqlReader.Read()
          Dim newCustomersRow As DataRow = atemptable.NewRow()
          newCustomersRow("comp_id") = SqlReader.Item("comp_id")
          newCustomersRow("comp_name") = SqlReader.Item("comp_name")
          newCustomersRow("comp_address1") = SqlReader.Item("comp_address1")
          newCustomersRow("comp_address2") = SqlReader.Item("comp_address2")
          newCustomersRow("comp_city") = SqlReader.Item("comp_city")
          newCustomersRow("comp_state") = SqlReader.Item("comp_state")
          newCustomersRow("comp_zip_code") = SqlReader.Item("comp_zip_code")
          newCustomersRow("comp_country") = SqlReader.Item("comp_country")
          newCustomersRow("jetnet_comp_id") = SqlReader.Item("comp_id")
          newCustomersRow("source") = SqlReader.Item("source")
          atemptable.Rows.Add(newCustomersRow)
          atemptable.AcceptChanges()
        End While


      End If
      If data_subset = "C" Or data_subset = "JC" Then
        sql_where = ""
        sql = ""
        sql = "select distinct clicomp_name as comp_name, clicomp_jetnet_comp_id as jetnet_comp_id, clicomp_address1 as comp_address1, clicomp_address2 as comp_address2, " &
        " clicomp_city as comp_city, clicomp_state as comp_state, clicomp_zip_code as comp_zip_code, clicomp_country as comp_country, clicomp_id as comp_id, " &
        " 'CLIENT' as source from client_company left outer join client_contact on clicomp_id = clicontact_comp_id"

        If company_name <> "" Then
          sql_where = "clicomp_name like '%" & company_name & "%' "
        End If

        If first_name <> "" Then
          If sql_where <> "" Then
            andclause = " and "
          Else
            andclause = ""
          End If
          sql_where = sql_where & andclause & " clicontact_first_name like '%" & first_name & "%' "
        End If

        If phone_number <> "" Then
          If sql_where <> "" Then
            andclause = " and "
          Else
            andclause = ""
          End If

          sql_where = sql_where & andclause & " clicomp_id in (select distinct clipnum_comp_id from client_phone_numbers where clipnum_number like '%" & phone_number & "%') "
        End If

        If last_name <> "" Then
          If sql_where <> "" Then
            andclause = " and "
          Else
            andclause = ""
          End If
          sql_where = sql_where & andclause & " clicontact_last_name like '%" & last_name & "%' "
        End If

        If email_address <> "" Then
          If sql_where <> "" Then
            andclause = " and "
          Else
            andclause = ""
          End If
          sql_where = sql_where & andclause & " ( clicontact_email_address like '%" & email_address & "%' "

          sql_where = sql_where & " or clicomp_email_address like '%" & email_address & "%') "
        End If

        If sql_where <> "" Then
          sql = sql & " where " & sql_where
        End If

        sql = sql & " order by clicomp_name "

        clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
        MySqlConn.ConnectionString = Me.client_DB
        MySqlConn.Open()
        MySqlCommand.Connection = MySqlConn
        MySqlCommand.CommandType = CommandType.Text
        MySqlCommand.CommandTimeout = 60


        MySqlCommand.CommandText = sql


        MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
        While MySqlReader.Read()
          Dim newCustomersRow As DataRow = atemptable.NewRow()
          newCustomersRow("comp_id") = MySqlReader.Item("comp_id")
          newCustomersRow("comp_name") = MySqlReader.Item("comp_name")
          newCustomersRow("comp_address1") = MySqlReader.Item("comp_address1")
          newCustomersRow("comp_address2") = MySqlReader.Item("comp_address2")
          newCustomersRow("comp_city") = MySqlReader.Item("comp_city")
          newCustomersRow("comp_state") = MySqlReader.Item("comp_state")
          newCustomersRow("comp_zip_code") = MySqlReader.Item("comp_zip_code")
          newCustomersRow("comp_country") = MySqlReader.Item("comp_country")
          newCustomersRow("jetnet_comp_id") = MySqlReader.Item("jetnet_comp_id")
          newCustomersRow("source") = MySqlReader.Item("source")
          atemptable.Rows.Add(newCustomersRow)
          atemptable.AcceptChanges()
        End While

      End If

      dalTable = atemptable.Clone
      Dim afiltered_Client As DataRow() = atemptable.Select("", "comp_name,jetnet_comp_id asc")
      ' extract and import
      For Each atmpDataRow_Client In afiltered_Client
        dalTable.ImportRow(atmpDataRow_Client)
      Next

      Return atemptable
    Catch ex As Exception
      Search_CompanysWithContacts = Nothing
      Me.class_error = "Error in Search_CompanysWithContacts(ByVal data_subset As String, ByVal company_name As String, ByVal first_name As String, ByVal last_name As String, ByVal phone_number As String, ByVal email_address As String): SQL VERSION " & ex.Message
    Finally

      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing


      MySqlReader = Nothing

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  ''' <summary>
  ''' Company search running from both the Regular search and mobile search
  ''' </summary>
  ''' <param name="comp_name">Company Name Text/search txt box</param>
  ''' <param name="status">Status - Inactive, active?</param>
  ''' <param name="data_subset">Jetnet/Client/Both?</param>
  ''' <param name="country">Company Country</param>
  ''' <param name="state">Company State</param>
  ''' <param name="operator_type">Company operator type</param>
  ''' <param name="helicopter">helicopter data security flag</param>
  ''' <param name="business">business security flag</param>
  ''' <param name="commercial">commercial security flag</param>
  ''' <param name="special_field"></param>
  ''' <param name="special_field_text"></param>
  ''' <param name="SQL_IN_JETNET"></param>
  ''' <param name="SQL_IN_CLIENT"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Company_Search(ByVal comp_name As String, ByVal status As String, ByVal data_subset As String, ByVal country As String, ByVal state As String, ByVal operator_type As String, ByVal helicopter As Boolean, ByVal business As Boolean, ByVal commercial As Boolean, ByVal special_field As String, ByVal special_field_text As String, ByVal SQL_IN_CLIENT As String, ByVal SQL_IN_JETNET As String, ByVal zip As String, ByVal city As String, ByVal address As String) As DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader

    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Dim dalTable As New DataTable
    Try
      ' create the Select Strings
      Dim aSQL_String_Client_Select As String = ""
      Dim aSQL_String_JETNET_Select As String = ""
      ' create the Where string
      Dim aSQL_String_Client_Where As String = ""
      Dim aSQL_String_JETNET_Where As String = ""

      Dim dataSet As DataSet = New DataSet("dataSet")
      dataSet.Tables.Add(atemptable)

      dataSet.Tables.Add(dalTable)
      dataSet.EnforceConstraints = False

      atemptable.Columns.Add("comp_id")
      atemptable.Columns.Add("comp_name")
      atemptable.Columns.Add("comp_alternate_name_type")
      atemptable.Columns.Add("comp_address1")
      atemptable.Columns.Add("comp_address2")
      atemptable.Columns.Add("comp_city")
      atemptable.Columns.Add("comp_state")
      atemptable.Columns.Add("comp_zip_code")
      atemptable.Columns.Add("comp_country")
      atemptable.Columns.Add("comp_agency_type")
      atemptable.Columns.Add("comp_web_address")
      atemptable.Columns.Add("comp_email_address")
      atemptable.Columns.Add("comp_action_date")
      atemptable.Columns.Add("source")
      atemptable.Columns.Add("comp_status")
      atemptable.Columns.Add("comp_jetnet_comp_id")
      atemptable.Columns.Add("comp_user_id")
      atemptable.Columns.Add("comp_product_helicopter_flag")
      atemptable.Columns.Add("comp_product_business_flag")
      atemptable.Columns.Add("comp_product_commercial_flag")
      atemptable.Columns.Add("comp_description")
      atemptable.Columns.Add("comp_category1")
      atemptable.Columns.Add("comp_category2")
      atemptable.Columns.Add("comp_category3")
      atemptable.Columns.Add("comp_category4")
      atemptable.Columns.Add("comp_category5")

      'if you're searching on the special field, we're going to ignore the jetnet data. 
      If special_field = "" Then
        'keep subset the same
      Else
        data_subset = "C"
      End If
      If HttpContext.Current.Session.Item("localUser").crmEvo = True Then
        data_subset = "J"
      End If

      If (data_subset = "C" Or data_subset = "JC") Then

        aSQL_String_Client_Select = "SELECT DISTINCT clicomp_id AS comp_id, clicomp_name AS comp_name, clicomp_alternate_name_type AS "
        aSQL_String_Client_Select = aSQL_String_Client_Select & "comp_alternate_name_type, clicomp_alternate_name AS comp_alternate_name, "
        aSQL_String_Client_Select = aSQL_String_Client_Select & "clicomp_address1 AS comp_address1, clicomp_address2 AS comp_address2, "
        aSQL_String_Client_Select = aSQL_String_Client_Select & "clicomp_city AS comp_city, clicomp_state AS comp_state, clicomp_zip_code "
        aSQL_String_Client_Select = aSQL_String_Client_Select & " AS comp_zip_code, clicomp_country AS comp_country, clicomp_agency_type "
        aSQL_String_Client_Select = aSQL_String_Client_Select & "AS comp_agency_type, clicomp_web_address AS comp_web_address, "
        aSQL_String_Client_Select = aSQL_String_Client_Select & "clicomp_email_address AS comp_email_address, clicomp_action_date "
        aSQL_String_Client_Select = aSQL_String_Client_Select & " AS comp_action_date, 'CLIENT' AS source, clicomp_status as comp_status, "
        aSQL_String_Client_Select = aSQL_String_Client_Select & "clicomp_jetnet_comp_id as comp_jetnet_comp_id, clicomp_user_id comp_user_id, "
        aSQL_String_Client_Select = aSQL_String_Client_Select & "clicomp_product_helicopter_flag as "
        aSQL_String_Client_Select = aSQL_String_Client_Select & " comp_product_helicopter_flag,	clicomp_product_business_flag as "
        aSQL_String_Client_Select = aSQL_String_Client_Select & "comp_product_business_flag, clicomp_product_commercial_flag as "
        aSQL_String_Client_Select = aSQL_String_Client_Select & "comp_product_commercial_flag, clicomp_category1 as comp_category1, clicomp_category2 as comp_category2, "
        aSQL_String_Client_Select = aSQL_String_Client_Select & "clicomp_category3 as comp_category3, clicomp_category4 as comp_category4, clicomp_category5 as comp_category5, clicomp_description as comp_description FROM client_company "


        If operator_type <> "" Then
          aSQL_String_Client_Select = aSQL_String_Client_Select & " LEFT OUTER JOIN client_aircraft_reference on clicomp_id = cliacref_comp_id "
          aSQL_String_Client_Select = aSQL_String_Client_Select & "LEFT OUTER JOIN client_aircraft on cliacref_cliac_id = cliaircraft_id"
        End If


        ' fill the data sets
        If special_field = "" Or special_field_text = "%" Then
          If comp_name <> "%" And comp_name <> "%%" And comp_name <> "" Then
            Select Case status
              Case "B"
                ' search by comp_name
                aSQL_String_Client_Where = " clicomp_name_search LIKE '" & comp_name & "'"
                'dsClient.Tables.Add(dtAdapter_Client.GetDataBy_Client_Company_CompName(comp_name))
              Case Else
                ' search by comp_name and status
                aSQL_String_Client_Where = " clicomp_name_search LIKE '" & comp_name & "' AND clicomp_status = '" & status & "'"
                'dsClient.Tables.Add(dtAdapter_Client.GetDataBy_Client_Company_CompName_Active(comp_name, status))
            End Select
          End If
        Else
          aSQL_String_Client_Where = " " & special_field & " LIKE '" & special_field_text & "'"
        End If
        ' check the country
        If country <> "" And aSQL_String_Client_Where <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & " AND clicomp_country = '" & country & "'"
        ElseIf country <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & " clicomp_country = '" & country & "'"
        End If

        '''''added 2.3.12 to combine two functions
        ' check the address
        If address <> "" And aSQL_String_Client_Where <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & " AND clicomp_address1 like '%" & address & "%'"
        ElseIf address <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & " clicomp_address1 like '%" & address & "%'"
        End If

        'If HttpContext.Current.Session.Item("jetnetWebSiteType") <> eWebSiteTypes.TEST And HttpContext.Current.Session.Item("jetnetWebSiteType") <> eWebSiteTypes.LOCAL Then
        '  ' check the city
        '  If city <> "" And aSQL_String_Client_Where <> "" Then
        '    aSQL_String_Client_Where = aSQL_String_Client_Where & " AND clicomp_city like '%" & city & "%'"
        '  ElseIf city <> "" Then
        '    aSQL_String_Client_Where = aSQL_String_Client_Where & " clicomp_city like '%" & city & "%'"
        '  End If

        'Else
        ' check the city
        If city <> "" Then
          If aSQL_String_Client_Where <> "" Then
            aSQL_String_Client_Where += " and "
          End If
          Dim TemporaryOperator As String = "Begins With"
          city = clsGeneral.clsGeneral.CleanUserData(city, Constants.cEmptyString, Constants.cCommaDelim, True)

          If InStr(city, "*") = 0 Then
            aSQL_String_Client_Where += " " & "clicomp_city" & " " & clsGeneral.clsGeneral.PrepQueryString(TemporaryOperator, city, "String", False, "clicomp_city", True)
          Else
            aSQL_String_Client_Where += " " & clsGeneral.clsGeneral.PrepQueryString(TemporaryOperator, city, "String", False, "clicomp_city", True)
          End If
        End If
        'End If

        ' check the zip
        If zip <> "" And aSQL_String_Client_Where <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & " AND clicomp_zip_code like '%" & zip & "%'"
        ElseIf zip <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & " clicomp_zip_code like '%" & zip & "%'"
        End If

        'check SQL_IN_CLIENT
        If SQL_IN_CLIENT <> "" And aSQL_String_Client_Where <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & " AND clicomp_id in (" & SQL_IN_CLIENT & ")"
        ElseIf SQL_IN_CLIENT <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & " clicomp_id in (" & SQL_IN_CLIENT & ")"
        End If

        ' check the state
        If state <> "" And country <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & " AND clicomp_state IN (" & state & ")"
        ElseIf state <> "" And aSQL_String_Client_Where <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & " AND clicomp_state IN (" & state & ")"
        ElseIf state <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & " clicomp_state IN (" & state & ")"
        End If
        ' check the operator_type 
        If operator_type <> "" Then
          If aSQL_String_Client_Where <> "" Then
            aSQL_String_Client_Where += " and "
          End If
          Select Case operator_type
            Case "whole"
              aSQL_String_Client_Where += " cliacref_contact_type in ('00')"
            Case "fractional"
              aSQL_String_Client_Where += " cliacref_contact_type in ('97','17')"
            Case "shared"
              aSQL_String_Client_Where += " cliacref_contact_type in ('08')"
            Case "all"
              aSQL_String_Client_Where += " cliacref_contact_type in ('00','97','08','56')"
            Case "operators"
              aSQL_String_Client_Where += " cliacref_operator_flag='Y'"
          End Select
        End If



        MySqlConn.ConnectionString = Me.client_DB
        MySqlConn.Open()
        MySqlCommand.Connection = MySqlConn
        MySqlCommand.CommandType = CommandType.Text
        MySqlCommand.CommandTimeout = 60

        Dim sQuery As String = aSQL_String_Client_Select
        If aSQL_String_Client_Where <> "" Then
          sQuery = sQuery & " WHERE " & aSQL_String_Client_Where
        End If
        MySqlCommand.CommandText = sQuery

        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Company_Search(ByVal comp_name As String, ByVal status As String, ByVal data_subset As String, ByVal country As String, ByVal state As String, ByVal operator_type As String, ByVal helicopter As Boolean, ByVal business As Boolean, ByVal commercial As Boolean, ByVal special_field As String, ByVal special_field_text As String, ByVal SQL_IN_CLIENT As String, ByVal SQL_IN_JETNET As String) As DataTable <em>Client Side!!</em></b><br />" & sQuery


        MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
        While MySqlReader.Read()
          Dim newCustomersRow As DataRow = atemptable.NewRow()
          newCustomersRow("comp_id") = MySqlReader.Item("comp_id")
          newCustomersRow("comp_name") = MySqlReader.Item("comp_name")
          newCustomersRow("comp_alternate_name_type") = MySqlReader.Item("comp_alternate_name_type")
          newCustomersRow("comp_address1") = MySqlReader.Item("comp_address1")
          newCustomersRow("comp_address2") = MySqlReader.Item("comp_address2")
          newCustomersRow("comp_city") = MySqlReader.Item("comp_city")
          newCustomersRow("comp_state") = MySqlReader.Item("comp_state")
          newCustomersRow("comp_zip_code") = MySqlReader.Item("comp_zip_code")
          newCustomersRow("comp_country") = MySqlReader.Item("comp_country")
          newCustomersRow("comp_agency_type") = MySqlReader.Item("comp_agency_type")
          newCustomersRow("comp_web_address") = MySqlReader.Item("comp_web_address")
          newCustomersRow("comp_email_address") = MySqlReader.Item("comp_email_address")
          newCustomersRow("comp_action_date") = MySqlReader.Item("comp_action_date")
          newCustomersRow("source") = MySqlReader.Item("source")
          newCustomersRow("comp_status") = MySqlReader.Item("comp_status")
          newCustomersRow("comp_jetnet_comp_id") = MySqlReader.Item("comp_jetnet_comp_id")
          newCustomersRow("comp_user_id") = MySqlReader.Item("comp_user_id")
          newCustomersRow("comp_product_helicopter_flag") = MySqlReader.Item("comp_product_helicopter_flag")
          newCustomersRow("comp_product_business_flag") = MySqlReader.Item("comp_product_business_flag")
          newCustomersRow("comp_product_commercial_flag") = MySqlReader.Item("comp_product_commercial_flag")
          newCustomersRow("comp_description") = MySqlReader.Item("comp_description")
          newCustomersRow("comp_category1") = MySqlReader.Item("comp_category1")
          newCustomersRow("comp_category2") = MySqlReader.Item("comp_category2")
          newCustomersRow("comp_category3") = MySqlReader.Item("comp_category3")
          newCustomersRow("comp_category4") = MySqlReader.Item("comp_category4")
          newCustomersRow("comp_category5") = MySqlReader.Item("comp_category5")

          atemptable.Rows.Add(newCustomersRow)
          atemptable.AcceptChanges()
        End While

      End If

      If (data_subset = "J" Or data_subset = "JC") Then
        '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
        ' Setup the JETNET SQL Strings
        '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
        aSQL_String_JETNET_Select = "SELECT DISTINCT comp_id, comp_name, comp_name_alt as comp_alternate_name, 'Y' as comp_status, comp_name_alt_type as comp_alternate_name_type, "
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & "comp_address1, comp_address2, comp_city, comp_state, comp_zip_code, comp_country, "
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " comp_agency_type, comp_web_address, comp_email_address, comp_id as "
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & "comp_jetnet_comp_id, 0 as comp_user_id, comp_action_date,"
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & "'JETNET' as source, comp_product_helicopter_flag,	"
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " comp_product_business_flag,	comp_product_commercial_flag, "
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & "'' as comp_category1, '' as comp_category2, '' as comp_category3, "
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & "'' as comp_category4, '' as comp_category5, '' as comp_description FROM company with (NOLOCK) "

        If operator_type <> "" Then
          aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " LEFT OUTER JOIN aircraft_reference with (nolock) "
          aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " on comp_id = cref_comp_id and comp_journ_id = "
          aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " cref_journ_id LEFT OUTER JOIN aircraft with (nolock) on cref_ac_id = "
          aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " ac_id and cref_journ_id = ac_journ_id "
        End If

        aSQL_String_JETNET_Where = " comp_journ_id = 0 and comp_active_flag='Y'  "


        If special_field = "" Then
          If comp_name <> "%" And comp_name <> "%%" And comp_name <> "" Then
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " and comp_name_search LIKE '" & comp_name & "'"
          End If
        Else
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & "  and " & special_field & " LIKE '" & comp_name & "'"
        End If
        ' check the country
        If country <> "" And aSQL_String_JETNET_Where <> "" Then
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " AND comp_country = '" & country & "'"
        ElseIf country <> "" Then
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " comp_country = '" & country & "'"
        End If

        '''''''added 2.3.12 to combine two functions
        ' check the address
        If address <> "" And aSQL_String_JETNET_Where <> "" Then
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " AND comp_address1 = '" & address & "'"
        ElseIf address <> "" Then
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " comp_address1 = '" & address & "'"
        End If

        'If HttpContext.Current.Session.Item("jetnetWebSiteType") <> eWebSiteTypes.TEST And HttpContext.Current.Session.Item("jetnetWebSiteType") <> eWebSiteTypes.LOCAL Then
        '  ' check the city
        '  If city <> "" And aSQL_String_JETNET_Where <> "" Then
        '    aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " AND comp_city = '" & city & "'"
        '  ElseIf city <> "" Then
        '    aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " comp_city = '" & city & "'"
        '  End If
        'ElseIf HttpContext.Current.Session.Item("jetnetWebSiteType") = eWebSiteTypes.TEST Or HttpContext.Current.Session.Item("jetnetWebSiteType") = eWebSiteTypes.LOCAL Then
        ' check the city
        If city <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            aSQL_String_JETNET_Where += " and "
          End If
          Dim TemporaryOperator As String = "Begins With"
          city = clsGeneral.clsGeneral.CleanUserData(city, Constants.cEmptyString, Constants.cCommaDelim, True)

          If InStr(city, "*") = 0 Then
            aSQL_String_JETNET_Where += " " & "comp_city" & " " & clsGeneral.clsGeneral.PrepQueryString(TemporaryOperator, city, "String", False, "comp_city", True)
          Else
            aSQL_String_JETNET_Where += " " & clsGeneral.clsGeneral.PrepQueryString(TemporaryOperator, city, "String", False, "comp_city", True)
          End If
        End If
        'End If

        ' check the zip
        If zip <> "" And aSQL_String_JETNET_Where <> "" Then
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " AND comp_zip_code = '" & city & "'"
        ElseIf zip <> "" Then
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " comp_zip_code = '" & city & "'"
        End If

        ' check the state
        If state <> "" And country <> "" Then
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " AND comp_state IN (" & state & ")"
        ElseIf state <> "" And aSQL_String_JETNET_Where <> "" Then
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " AND comp_state IN (" & state & ")"
        ElseIf state <> "" Then
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " comp_state IN (" & state & ")"
        End If

        'check SQL_IN_JETNET
        If SQL_IN_JETNET <> "" And aSQL_String_JETNET_Where <> "" Then
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " AND comp_id in (" & SQL_IN_JETNET & ")"
        ElseIf SQL_IN_JETNET <> "" Then
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " comp_id in (" & SQL_IN_JETNET & ")"
        End If

        ' check the operator_type 
        If operator_type <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            aSQL_String_JETNET_Where += " and "
          End If
          Select Case operator_type
            Case "whole"
              aSQL_String_JETNET_Where += " cref_contact_type in  ('00')"
            Case "fractional"
              aSQL_String_JETNET_Where += " cref_contact_type in  ('97','17')"
            Case "shared"
              aSQL_String_JETNET_Where += " cref_contact_type in  ('08')"
            Case "all"
              aSQL_String_JETNET_Where += " cref_contact_type in ('00','97','08','56')"
            Case "operators"
              aSQL_String_JETNET_Where += " cref_operator_flag='Y'"
          End Select
        End If


        aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " " & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(HttpContext.Current.Session.Item("localSubscription"), True, False)

        SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
        SqlConn.Open()
        SqlCommand.Connection = SqlConn

        Dim sQuery As String = aSQL_String_JETNET_Select & " WHERE " & aSQL_String_JETNET_Where & " order by comp_name"

        SqlCommand.CommandText = sQuery

        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Company_Search(ByVal comp_name As String, ByVal status As String, ByVal data_subset As String, ByVal country As String, ByVal state As String, ByVal operator_type As String, ByVal helicopter As Boolean, ByVal business As Boolean, ByVal commercial As Boolean, ByVal special_field As String, ByVal special_field_text As String, ByVal SQL_IN_CLIENT As String, ByVal SQL_IN_JETNET As String) As DataTable <em>Jetnet Side!!</em></b><br />" & sQuery


        SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
        SqlCommand.CommandType = CommandType.Text
        SqlCommand.CommandTimeout = 60

        While SqlReader.Read()
          Dim newCustomersRow As DataRow = atemptable.NewRow()
          newCustomersRow("comp_id") = SqlReader.Item("comp_id")
          newCustomersRow("comp_name") = SqlReader.Item("comp_name")
          newCustomersRow("comp_alternate_name_type") = SqlReader.Item("comp_alternate_name_type")
          newCustomersRow("comp_address1") = SqlReader.Item("comp_address1")
          newCustomersRow("comp_address2") = SqlReader.Item("comp_address2")
          newCustomersRow("comp_city") = SqlReader.Item("comp_city")
          newCustomersRow("comp_state") = SqlReader.Item("comp_state")
          newCustomersRow("comp_zip_code") = SqlReader.Item("comp_zip_code")
          newCustomersRow("comp_country") = SqlReader.Item("comp_country")
          newCustomersRow("comp_agency_type") = SqlReader.Item("comp_agency_type")
          newCustomersRow("comp_web_address") = SqlReader.Item("comp_web_address")
          newCustomersRow("comp_email_address") = SqlReader.Item("comp_email_address")
          newCustomersRow("comp_action_date") = SqlReader.Item("comp_action_date")
          newCustomersRow("source") = SqlReader.Item("source")
          newCustomersRow("comp_status") = SqlReader.Item("comp_status")
          newCustomersRow("comp_jetnet_comp_id") = SqlReader.Item("comp_jetnet_comp_id")
          newCustomersRow("comp_user_id") = SqlReader.Item("comp_user_id")
          newCustomersRow("comp_product_helicopter_flag") = SqlReader.Item("comp_product_helicopter_flag")
          newCustomersRow("comp_product_business_flag") = SqlReader.Item("comp_product_business_flag")
          newCustomersRow("comp_product_commercial_flag") = SqlReader.Item("comp_product_commercial_flag")
          newCustomersRow("comp_description") = SqlReader.Item("comp_description")
          newCustomersRow("comp_category1") = SqlReader.Item("comp_category1")
          newCustomersRow("comp_category2") = SqlReader.Item("comp_category2")
          newCustomersRow("comp_category3") = SqlReader.Item("comp_category3")
          newCustomersRow("comp_category4") = SqlReader.Item("comp_category4")
          newCustomersRow("comp_category5") = SqlReader.Item("comp_category5")

          atemptable.Rows.Add(newCustomersRow)
          atemptable.AcceptChanges()
        End While

      End If

      dalTable = atemptable.Clone
      Dim afiltered_Client As DataRow() = atemptable.Select("", "comp_name,comp_jetnet_comp_id asc")
      ' extract and import
      For Each atmpDataRow_Client In afiltered_Client
        dalTable.ImportRow(atmpDataRow_Client)
      Next


      Company_Search = dalTable

    Catch ex As Exception
      Company_Search = Nothing
      Me.class_error = "Error in Company_Search(): SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing

      'MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  Public Function add_in_wholesale_non_internal_retail_string() As String

    add_in_wholesale_non_internal_retail_string = ""
    add_in_wholesale_non_internal_retail_string &= (" AND NOT (journ_subcat_code_part3 IN ('DB','DS','FI','FY','IT','MF','RE','CC','LS','RM')) ")
    add_in_wholesale_non_internal_retail_string &= (" AND (journ_subcat_code_part1 = 'WS') ")      '-- Whole Sales Only 
    add_in_wholesale_non_internal_retail_string &= (" AND (journ_internal_trans_flag = 'N') ")          '-- No Internals 

  End Function

  Public Function add_in_case_for_ac_sale_price(Optional ByVal rename_as As String = "") As String

    add_in_case_for_ac_sale_price = ""

    add_in_case_for_ac_sale_price &= ", case "
    add_in_case_for_ac_sale_price &= " when ac_sale_price_display_flag = 'N' then 0"
    add_in_case_for_ac_sale_price &= " when ac_sale_price_display_flag = 'Y' then "
    add_in_case_for_ac_sale_price &= " case when journ_internal_trans_flag = 'Y' then 0"
    add_in_case_for_ac_sale_price &= " when journ_subcat_code_part3 IN ('DB','DS','FI','FY','IT','MF','RE','CC','LS', 'RM') then 0"
    add_in_case_for_ac_sale_price &= " when journ_subcat_code_part1 <> 'WS' then 0 "
    add_in_case_for_ac_sale_price &= " else  ac_sale_price  end  "
    add_in_case_for_ac_sale_price &= " end "

    If Trim(rename_as) <> "" Then
      add_in_case_for_ac_sale_price &= " as " & Trim(rename_as)
    Else
      add_in_case_for_ac_sale_price &= " as ac_sale_price "
    End If



  End Function
  ''' <summary>
  ''' Get Company Details from the Company Details Page
  ''' </summary>
  ''' <param name="comp_id"></param>
  ''' <param name="comp_source"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function GetCompanyInfo_ID(ByVal comp_id As Long, ByVal comp_source As String, ByVal journalID As Long) As DataTable
    'sql
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    'mysql
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim atemptable As New DataTable

    Try
      Select Case comp_source
        Case "JETNET"
          Dim sql As String = ""

          sql = "select comp_action_date, comp_customer_notes as clicomp_description, comp_address1, comp_address2, comp_agency_type, comp_name_alt as comp_alternate_name, "
          sql = sql & " comp_name_alt_type as comp_alternate_name_type, comp_product_helicopter_flag, comp_product_business_flag, "
          sql = sql & " comp_product_commercial_flag, '' as clicomp_category2, '' as clicomp_category3, '' as clicomp_category4, '' as clicomp_category5, "
          sql = sql & " comp_city, comp_country, comp_email_address, comp_id, comp_id as jetnet_comp_id, comp_name, comp_state, "
          sql = sql & " comp_active_flag as comp_status, 0 as comp_user_id, comp_logo_flag, comp_web_address, comp_zip_code, 'JETNET' as source from "
          sql = sql & IIf(HttpContext.Current.Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CUSTOMER_CENTER, "[Homebase].jetnet_ra.dbo.", "")
          sql = sql & "company WITH (NOLOCK) where comp_journ_id = " & journalID
          sql = sql & " and comp_id = " & comp_id
          If Not IsNothing(HttpContext.Current.Request.Item("homebase")) Then
            If Trim(HttpContext.Current.Request.Item("homebase")) = "Y" Then
            Else
              ' sql = sql & " " + commonEvo.MakeCompanyProductCodeClause(HttpContext.Current.Session.Item("localPreferences"), False)
              sql = sql & " " + clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_YachtsIncluded(HttpContext.Current.Session.Item("localSubscription"), True, False)
            End If
          Else
            ' sql = sql & " " + commonEvo.MakeCompanyProductCodeClause(HttpContext.Current.Session.Item("localPreferences"), False)
            sql = sql & " " + clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_YachtsIncluded(HttpContext.Current.Session.Item("localSubscription"), True, False)
          End If

          If journalID > 0 And comp_id > 0 Then
            sql = Replace(sql, "AND comp_active_flag = 'Y'", "")
          End If

          'save to session query debug string.

          clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
          SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
          SqlConn.Open()
          SqlCommand.Connection = SqlConn


          SqlCommand.CommandText = sql
          SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
          SqlCommand.CommandType = CommandType.Text
          SqlCommand.CommandTimeout = 60

          Try
            atemptable.Load(SqlReader)
          Catch constrExc As System.Data.ConstraintException
            Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
          End Try
        Case Else
          Dim sql As String = ""
          sql = ""
          sql = "SELECT  clicomp_action_date AS comp_action_date, clicomp_address1 AS comp_address1, clicomp_address2 AS comp_address2, "
          sql = sql & " clicomp_agency_type AS comp_agency_type, clicomp_alternate_name AS comp_alternate_name, clicomp_alternate_name_type AS comp_alternate_name_type, "
          sql = sql & " clicomp_category1, clicomp_category2, clicomp_category3, clicomp_category4, clicomp_category5, clicomp_city AS comp_city, clicomp_country AS comp_country, "
          sql = sql & " clicomp_description, clicomp_email_address AS comp_email_address, clicomp_id AS comp_id, clicomp_jetnet_comp_id AS jetnet_comp_id, "
          sql = sql & " clicomp_mainloc_comp_id, clicomp_name AS comp_name, clicomp_product_business_flag AS comp_product_business_flag, "
          sql = sql & " clicomp_product_commercial_flag AS comp_product_commercial_flag, clicomp_product_helicopter_flag AS comp_product_helicopter_flag, "
          sql = sql & " clicomp_state AS comp_state, clicomp_status, clicomp_user_id AS comp_user_id, '' as comp_logo_flag, clicomp_web_address AS comp_web_address, "
          sql = sql & " clicomp_zip_code AS comp_zip_code, 'CLIENT' AS source"
          sql = sql & " FROM client_company WHERE (clicomp_id = " & comp_id & ")"


          clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
          MySqlConn.ConnectionString = Me.client_DB
          MySqlConn.Open()
          MySqlCommand.Connection = MySqlConn
          MySqlCommand.CommandType = CommandType.Text
          MySqlCommand.CommandTimeout = 60

          MySqlCommand.CommandText = sql
          MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

          Try
            atemptable.Load(MySqlReader)
          Catch constrExc As System.Data.ConstraintException
            Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
          End Try


      End Select
      Return atemptable
    Catch ex As Exception
      GetCompanyInfo_ID = Nothing
      Me.class_error = "Error in GetCompanyInfo_ID(ByVal comp_id As Integer, ByVal comp_source As String): SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing

      MySqlReader = Nothing

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
  ''' <summary>
  ''' Get Company Details from the Company Details Page
  ''' </summary>
  ''' <param name="comp_id"></param>
  ''' <param name="comp_source"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function GetCompanyInfo_ID_WithPhoneNumber(ByVal comp_id As Long, ByVal comp_source As String, ByVal journalID As Long) As DataTable
    'sql
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    'mysql
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim atemptable As New DataTable

    Try
      Select Case comp_source
        Case "JETNET"
          Dim sql As String = ""
          sql = "select comp_action_date, comp_customer_notes as clicomp_description, comp_address1, comp_address2, comp_agency_type, comp_name_alt as comp_alternate_name, "
          sql = sql & " comp_name_alt_type as comp_alternate_name_type, comp_product_helicopter_flag, comp_product_business_flag, "
          sql = sql & " comp_product_commercial_flag, '' as clicomp_category2, '' as clicomp_category3, '' as clicomp_category4, '' as clicomp_category5, "
          sql = sql & " comp_city, comp_country, comp_email_address, comp_id, comp_id as jetnet_comp_id, comp_name, comp_state, "
          sql = sql & " comp_active_flag as comp_status, 0 as comp_user_id, comp_logo_flag, comp_web_address, comp_zip_code, 'JETNET' as source, "

          sql = sql & " (select top 1 pnum_number_full "
          sql = sql & " from Phone_Numbers where pnum_type ='Office' "
          sql = sql & " and comp_id = pnum_comp_id and pnum_contact_id =0 and pnum_journ_id=0) as comp_phone_office,"
          sql = sql & " (select top 1 pnum_number_full from Phone_Numbers where pnum_type ='Fax' and comp_id = pnum_comp_id "
          sql = sql & " and pnum_contact_id =0 and pnum_journ_id=0) as comp_phone_fax"

          sql = sql & " from company WITH (NOLOCK) where comp_journ_id = " & journalID
          sql = sql & " and comp_id = " & comp_id

          'save to session query debug string.

          clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
          SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
          SqlConn.Open()
          SqlCommand.Connection = SqlConn


          SqlCommand.CommandText = sql
          SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
          SqlCommand.CommandType = CommandType.Text
          SqlCommand.CommandTimeout = 60

          Try
            atemptable.Load(SqlReader)
          Catch constrExc As System.Data.ConstraintException
            Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
          End Try
        Case Else
          Dim sql As String = ""
          sql = ""
          sql = "SELECT  clicomp_action_date AS comp_action_date, clicomp_address1 AS comp_address1, clicomp_address2 AS comp_address2, "
          sql = sql & " clicomp_agency_type AS comp_agency_type, clicomp_alternate_name AS comp_alternate_name, clicomp_alternate_name_type AS comp_alternate_name_type, "
          sql = sql & " clicomp_category1, clicomp_category2, clicomp_category3, clicomp_category4, clicomp_category5, clicomp_city AS comp_city, clicomp_country AS comp_country, "
          sql = sql & " clicomp_description, clicomp_email_address AS comp_email_address, clicomp_id AS comp_id, clicomp_jetnet_comp_id AS jetnet_comp_id, "
          sql = sql & " clicomp_mainloc_comp_id, clicomp_name AS comp_name, clicomp_product_business_flag AS comp_product_business_flag, "
          sql = sql & " clicomp_product_commercial_flag AS comp_product_commercial_flag, clicomp_product_helicopter_flag AS comp_product_helicopter_flag, "
          sql = sql & " clicomp_state AS comp_state, clicomp_status, clicomp_user_id AS comp_user_id, '' as comp_logo_flag, clicomp_web_address AS comp_web_address, "
          sql = sql & " clicomp_zip_code AS comp_zip_code, 'CLIENT' AS source, clicomp_name, clicomp_city, clicomp_state, "
          sql = sql & " (select clipnum_number "
          sql = sql & " from client_phone_numbers where clipnum_type ='Office' "
          sql = sql & " and clicomp_id = clipnum_comp_id and clipnum_contact_id =0 limit 1) as comp_phone_office,"
          sql = sql & " (select clipnum_number "
          sql = sql & " from client_phone_numbers where clipnum_type ='Fax' "
          sql = sql & " and clicomp_id = clipnum_comp_id and clipnum_contact_id =0 limit 1) as comp_phone_fax "

          sql = sql & " FROM client_company WHERE (clicomp_id = " & comp_id & ")"


          clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
          MySqlConn.ConnectionString = Me.client_DB
          MySqlConn.Open()
          MySqlCommand.Connection = MySqlConn
          MySqlCommand.CommandType = CommandType.Text
          MySqlCommand.CommandTimeout = 60

          MySqlCommand.CommandText = sql
          MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

          Try
            atemptable.Load(MySqlReader)
          Catch constrExc As System.Data.ConstraintException
            Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
          End Try


      End Select
      Return atemptable
    Catch ex As Exception
      GetCompanyInfo_ID_WithPhoneNumber = Nothing
      Me.class_error = "Error in GetCompanyInfo_ID_WithPhoneNumber(ByVal comp_id As Integer, ByVal comp_source As String): SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing

      MySqlReader = Nothing

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  Public Function CheckIfCompanyIsActive(ByVal comp_id As Long, ByVal journalID As Long, ByVal compActiveFlag As String, ByVal compHideFlag As String) As DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim aTempTable As New DataTable
    Try

      Dim sqlQuery As String = ""
      sqlQuery = "select comp_id from company WITH (NOLOCK) where comp_journ_id = @compJournID "
      sqlQuery += " and comp_id = @compID "
      sqlQuery += " and comp_active_flag = @compActiveFlag "
      sqlQuery += " and comp_hide_flag = @compHideFlag"

      'save to session query debug string.

      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sqlQuery.ToString)
      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()

      Dim SqlCommand As New SqlClient.SqlCommand(sqlQuery, SqlConn)


      SqlCommand.Parameters.AddWithValue("compID", comp_id)
      SqlCommand.Parameters.AddWithValue("compJournID", journalID)
      SqlCommand.Parameters.AddWithValue("compActiveFlag", compActiveFlag)
      SqlCommand.Parameters.AddWithValue("compHideFlag", compHideFlag)

      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      SqlCommand.Dispose()
      SqlCommand = Nothing

      Return aTempTable
    Catch ex As Exception
      CheckIfCompanyIsActive = Nothing
      Me.class_error = "Error in CheckIfCompanyIsActive(ByVal comp_id As Long, ByVal journalID As Long) As DataTable" & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing



    End Try

  End Function

  ''' <summary>
  ''' Get Company Details from the Company Details Page
  ''' </summary>
  ''' <param name="comp_id"></param>
  ''' <param name="comp_source"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  ''' '3-1-2012
  Public Function GetLimited_CompanyInfo_ID(ByVal comp_id As Long, ByVal comp_source As String, ByVal journ_id As Long) As DataTable
    'sql
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    'mysql
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim atemptable As New DataTable

    Try
      Select Case comp_source
        Case "JETNET"
          Dim sql As String = ""

          sql = "select comp_city, comp_id, comp_name, comp_state, 'JETNET' as source from company WITH (NOLOCK) where comp_journ_id = " & journ_id
          sql = sql & " and comp_id = " & comp_id

          'save to session query debug string.

          clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
          SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
          SqlConn.Open()
          SqlCommand.Connection = SqlConn


          SqlCommand.CommandText = sql
          SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
          SqlCommand.CommandType = CommandType.Text
          SqlCommand.CommandTimeout = 60

          Try
            atemptable.Load(SqlReader)
          Catch constrExc As System.Data.ConstraintException
            Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
          End Try
        Case Else
          Dim sql As String = ""
          sql = ""

          sql = "SELECT  clicomp_city AS comp_city, clicomp_id AS comp_id, clicomp_name AS comp_name, "
          sql = sql & " clicomp_state AS comp_state, 'CLIENT' AS source"
          sql = sql & " FROM client_company WHERE (clicomp_id = " & comp_id & ")"


          clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
          MySqlConn.ConnectionString = Me.client_DB
          MySqlConn.Open()
          MySqlCommand.Connection = MySqlConn
          MySqlCommand.CommandType = CommandType.Text
          MySqlCommand.CommandTimeout = 60

          MySqlCommand.CommandText = sql
          MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

          Try
            atemptable.Load(MySqlReader)
          Catch constrExc As System.Data.ConstraintException
            Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
          End Try


      End Select
      Return atemptable
    Catch ex As Exception
      GetLimited_CompanyInfo_ID = Nothing
      Me.class_error = "Error in GetLimited_CompanyInfo_ID(ByVal comp_id As long, ByVal comp_source As String, journ_id as long) As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing

      MySqlReader = Nothing

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  ''' <summary>
  ''' Pass an in clause of company IDs
  ''' </summary>
  ''' <param name="compIDs"></param>
  ''' <param name="comp_source"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function GetLimited_CompanyInfo_InClause(ByVal compIDs As String, ByVal comp_source As String) As DataTable
    'sql
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    'mysql
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim atemptable As New DataTable

    Try
      Select Case comp_source
        Case "JETNET"
          Dim sql As String = ""

          sql = "select comp_city, comp_id, comp_name, comp_state, 'JETNET' as source from company WITH (NOLOCK) where comp_journ_id = 0 "
          sql = sql & " and comp_id in (" & compIDs & ")"

          'save to session query debug string.

          clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
          SqlConn.ConnectionString = JETNET_DB
          SqlConn.Open()
          SqlCommand.Connection = SqlConn


          SqlCommand.CommandText = sql
          SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
          SqlCommand.CommandType = CommandType.Text
          SqlCommand.CommandTimeout = 60

          Try
            atemptable.Load(SqlReader)
          Catch constrExc As System.Data.ConstraintException
            Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
          End Try
        Case Else
          Dim sql As String = ""
          sql = ""

          sql = "SELECT  clicomp_city AS comp_city, clicomp_id AS comp_id, clicomp_name AS comp_name, "
          sql = sql & " clicomp_state AS comp_state, 'CLIENT' AS source"
          sql = sql & " FROM client_company WHERE clicomp_id  in (" & compIDs & ")"


          clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
          MySqlConn.ConnectionString = Me.client_DB
          MySqlConn.Open()
          MySqlCommand.Connection = MySqlConn
          MySqlCommand.CommandType = CommandType.Text
          MySqlCommand.CommandTimeout = 60

          MySqlCommand.CommandText = sql
          MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

          Try
            atemptable.Load(MySqlReader)
          Catch constrExc As System.Data.ConstraintException
            Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
          End Try


      End Select
      Return atemptable
    Catch ex As Exception
      GetLimited_CompanyInfo_InClause = Nothing
      Me.class_error = "Error in GetLimited_CompanyInfo_InClause(ByVal comp_id As Long, ByVal comp_source As String) As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing

      MySqlReader = Nothing

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  ''' <summary>
  ''' Returns Company Relationships based on company ID
  ''' </summary>
  ''' <param name="compID"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Get_Company_Relationships(ByVal compID As Long, ByVal journalID As Long)
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable
    Try
      sql = sql & " SELECT DISTINCT Company_Reference.*, actype_name, actype_compref_internal_flag, actype_compref_twoway_flag, actype_compref_name2, "
      '-- GET NUMBER OF AIRCRAFT FOR THIS COMPANY
      sql = sql & " case compref_rel_comp_id"
      sql = sql & " when " & compID & " then "
      sql = sql & " (select cac_fullsale_owner from Company_Aircraft_Count with (NOLOCK) "
      sql = sql & " where cac_comp_id = compref_comp_id and cac_product_type = 'B'"
      sql = sql & " and cac_journ_id = 0 )"
      sql = sql & " else "
      sql = sql & " (select cac_fullsale_owner from Company_Aircraft_Count with (NOLOCK) "
      sql = sql & " where cac_comp_id = compref_rel_comp_id and cac_product_type = 'B'"
      sql = sql & " and cac_journ_id = 0 )"
      sql = sql & " end as ac_count, "

      '-- GET NUMBER OF AIRCRAFT FOR THIS COMPANY
      sql = sql & " case compref_rel_comp_id"
      sql = sql & " when  " & compID & "  then "
      sql = sql & " (select cac_fullsale_owner from Company_Aircraft_Count with (NOLOCK) "
      sql = sql & " where cac_comp_id = compref_comp_id and cac_product_type = 'H'"
      sql = sql & " and cac_journ_id = " & journalID & " )"
      sql = sql & " else "
      sql = sql & " (select cac_fullsale_owner from Company_Aircraft_Count with (NOLOCK) "
      sql = sql & " where cac_comp_id = compref_rel_comp_id and cac_product_type = 'H'"
      sql = sql & " and cac_journ_id =  " & journalID & " )"
      sql = sql & " end as heli_count,"
      '-- GET NUMBER OF YACHTS FOR THIS COMPANY
      sql = sql & " case compref_rel_comp_id"
      sql = sql & " when  " & compID & "  then "
      sql = sql & " (select COUNT(*) from Yacht_Reference with (NOLOCK) where yr_comp_id = compref_comp_id"
      sql = sql & " and yr_journ_id =  " & journalID & " and yr_contact_type in ('00','08','97')) "
      sql = sql & " else "
      sql = sql & " (select COUNT(*) from Yacht_Reference with (NOLOCK) where yr_comp_id = compref_rel_comp_id"
      sql = sql & " and yr_journ_id =  " & journalID & " and yr_contact_type in ('00','08','97')) "
      sql = sql & " end as ytcount"


      sql = sql & " FROM Company_Reference WITH(NOLOCK)"
      sql = sql & " inner join Aircraft_Contact_Type WITH(NOLOCK) on actype_code = compref_contact_type"
      sql = sql & " WHERE compref_journ_id = " & journalID
      sql = sql & " AND compref_comp_id = " & compID & " OR compref_rel_comp_id = " & compID
      sql = sql & " and compref_hide_flag = 'N' "
      sql = sql & " ORDER BY actype_compref_name2"

      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      Return atemptable
    Catch ex As Exception
      Get_Company_Relationships = Nothing
      Me.class_error = "Error in Get_Company_Relationships(ByVal comp_id As Integer): SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function

  ''' <summary>
  ''' Grabs the company information in the displayAircraftDetail.aspx page. Looks up the rest of the info for company.
  ''' </summary>
  ''' <param name="compID"></param>
  ''' <param name="journalID"></param>
  ''' <param name="aerodex"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Get_Company_Information_Evo_AC_Details_References(ByVal compID As Long, ByVal journalID As Long, ByVal aerodex As Boolean) As DataTable
    Dim sQuery As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable
    Try
      sQuery = "SELECT * FROM Company WITH(NOLOCK)"
      sQuery &= " INNER JOIN Aircraft_Reference WITH(NOLOCK) ON (cref_comp_id = comp_id AND cref_journ_id = comp_journ_id)"
      sQuery &= " WHERE (comp_journ_id = " & journalID & " AND comp_id = " & compID

      If journalID = 0 Then
        sQuery &= " AND comp_active_flag = 'Y'"
      End If

      ' Hide Exclusive Brokers and Representatives and Dealers from Aerodex users
      If aerodex Then
        sQuery &= " AND cref_contact_type NOT IN ('93','98','99','71')"
      Else
        sQuery &= " AND cref_contact_type NOT IN ('71')"
      End If

      sQuery &= " AND comp_hide_flag = 'N')"



      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sQuery.ToString)

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sQuery
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      Return atemptable
    Catch ex As Exception
      Get_Company_Information_Evo_AC_Details_References = Nothing
      Me.class_error = "Error in Get_Company_Information_Evo_AC_Details_References(ByVal compID As Long, ByVal journalID As Long, ByVal aerodex As Boolean) As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function

  Public Function GetCompanyMainLoc_ID(ByVal clicomp_mainloc_id As Long) As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim atemptable As New DataTable
    Dim sql As String = ""
    Try

      sql = " SELECT clicomp_id AS comp_id, clicomp_name AS comp_name, clicomp_alternate_name_type AS comp_alternate_name_type, "
      sql = sql & " clicomp_alternate_name AS comp_alternate_name, clicomp_address1 AS comp_address1, clicomp_address2 AS comp_address2, clicomp_city AS comp_city, "
      sql = sql & " clicomp_state AS comp_state, clicomp_zip_code AS comp_zip_code, clicomp_country AS comp_country, clicomp_agency_type AS comp_agency_type, "
      sql = sql & " clicomp_web_address AS comp_web_address, clicomp_email_address AS comp_email_address, clicomp_action_date AS comp_action_date, "
      sql = sql & " clicomp_jetnet_comp_id AS jetnet_comp_id, 'CLIENT' AS source, clicomp_user_id AS comp_user_id, clicomp_status, clicomp_description, clicomp_category1, "
      sql = sql & " clicomp_category2, clicomp_category3, clicomp_category4, clicomp_category5, clicomp_product_helicopter_flag AS comp_product_helicopter_flag, "
      sql = sql & " clicomp_product_business_flag AS comp_product_business_flag, clicomp_product_commercial_flag AS comp_product_commercial_flag, "
      sql = sql & " clicomp_mainloc_comp_id"
      sql = sql & " FROM  client_company"
      sql = sql & " where clicomp_mainloc_comp_id =  " & clicomp_mainloc_id


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      MySqlConn.ConnectionString = client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try


      Return atemptable
    Catch ex As Exception
      GetCompanyMainLoc_ID = Nothing
      Me.class_error = "Error in SQL GetCompanyMainLoc_ID(ByVal clicomp_mainloc_id As Integer): " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_JETNET_AC
  ' Purpose: Get the Clients JENET AC's mixed with the jetnet AC's. E
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Client_JETNET_AC(ByVal acomp_ID As Integer, ByVal sort_by As String, ByVal Helicopter As Boolean, ByVal Business As Boolean, ByVal Commercial As Boolean, ByVal Jets As Boolean, ByVal Executive As Boolean, ByVal Turboprops As Boolean) As DataTable
    Dim aTempTable As New DataTable
    Dim datatable As New DataTable
    Dim returnTable As New DataTable
    Dim Client_Reference_Table As New DataTable
    Dim sql As String = ""
    Dim dsClient_JETNET_AC_Merger As New DataSet
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Try
      aTempTable = References_Table_Setup()

      Client_Reference_Table.Columns.Add("cliacref_id")
      Client_Reference_Table.Columns.Add("cliacref_cliac_id")
      Client_Reference_Table.Columns.Add("cliacref_jetnet_ac_id")
      Client_Reference_Table.Columns.Add("cliact_name")

      Client_Reference_Table.Columns.Add("clicontact_first_name")
      Client_Reference_Table.Columns.Add("clicontact_last_name")
      Client_Reference_Table.Columns.Add("clicontact_id")
      Client_Reference_Table.Columns.Add("clicontact_jetnet_contact_id")
      Client_Reference_Table.Columns.Add("clicontact_title")
      Client_Reference_Table.Columns.Add("cliacref_comp_id")
      Client_Reference_Table.Columns.Add("cliaircraft_cliamod_id")


      sql = "  SELECT  cliacref_id, clicontact_jetnet_contact_id, client_aircraft_reference.cliacref_cliac_id, client_aircraft_reference.cliacref_jetnet_ac_id, client_aircraft_contact_type.cliact_name, "
      sql = sql & " client_contact.clicontact_first_name, client_contact.clicontact_title, client_contact.clicontact_last_name, client_contact.clicontact_id, "
      sql = sql & " client_aircraft_reference.cliacref_comp_id, client_aircraft.cliaircraft_cliamod_id "
      sql = sql & " FROM (client_aircraft_reference) "
      sql = sql & " LEFT OUTER JOIN client_aircraft_contact_type on cliacref_contact_type=cliact_type"
      sql = sql & " LEFT OUTER JOIN client_contact on cliacref_contact_id = clicontact_id"
      sql = sql & " LEFT OUTER JOIN client_aircraft on cliaircraft_id = cliacref_cliac_id"
      sql = sql & " WHERE cliacref_comp_id = " & acomp_ID


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      While MySqlReader.Read()
        Dim newCustomersRow As DataRow = Client_Reference_Table.NewRow()
        newCustomersRow("cliacref_id") = MySqlReader.Item("cliacref_id")
        newCustomersRow("cliacref_cliac_id") = MySqlReader.Item("cliacref_cliac_id")
        newCustomersRow("cliacref_jetnet_ac_id") = MySqlReader.Item("cliacref_jetnet_ac_id")


        newCustomersRow("clicontact_jetnet_contact_id") = IIf(Not IsDBNull(MySqlReader.Item("clicontact_jetnet_contact_id")), MySqlReader.Item("clicontact_jetnet_contact_id"), 0)
        newCustomersRow("cliact_name") = MySqlReader.Item("cliact_name")
        newCustomersRow("cliact_name") = MySqlReader.Item("clicontact_title")
        newCustomersRow("clicontact_first_name") = MySqlReader.Item("clicontact_first_name")
        newCustomersRow("clicontact_last_name") = MySqlReader.Item("clicontact_last_name")
        newCustomersRow("clicontact_id") = IIf(Not IsDBNull(MySqlReader.Item("clicontact_id")), MySqlReader.Item("clicontact_id"), 0)

        newCustomersRow("cliacref_comp_id") = MySqlReader.Item("cliacref_comp_id")
        newCustomersRow("cliaircraft_cliamod_id") = MySqlReader.Item("cliaircraft_cliamod_id")

        Client_Reference_Table.Rows.Add(newCustomersRow)
        Client_Reference_Table.AcceptChanges()
      End While

      MySqlReader.Close()

      dsClient_JETNET_AC_Merger.Tables.Add(Client_Reference_Table) 'client reference information


      sql = ""
      sql = " Select DISTINCT"
      sql = sql & " client_aircraft.cliaircraft_id AS ac_id,clicontact_jetnet_contact_id, cliacep_engine_name as ac_engine_name, '' as amod_make_type, client_aircraft.cliaircraft_year_dlv as ac_year, client_aircraft.cliaircraft_date_listed as ac_date_listed, client_contact.clicontact_title as contact_title, 0 as cref_transmit_seq_no, client_aircraft_model.cliamod_id AS ac_amod_id, client_aircraft.cliaircraft_ser_nbr AS ac_ser_nbr, "
      sql = sql & " client_aircraft.cliaircraft_reg_nbr AS ac_reg_nbr, 'N/A' AS ac_airframe_tot_hrs, client_aircraft_model.cliamod_make_name AS amod_make_name, "
      sql = sql & " client_aircraft_model.cliamod_model_name AS amod_model_name, client_aircraft.cliaircraft_status AS ac_status, client_aircraft.cliaircraft_year_mfr AS ac_year_mfr, "
      sql = sql & " client_contact.clicontact_sirname AS contact_sirname, client_contact.clicontact_first_name AS contact_first_name, "
      sql = sql & " client_contact.clicontact_middle_initial AS contact_middle_initial, client_contact.clicontact_last_name AS contact_last_name, "
      sql = sql & " client_contact.clicontact_suffix AS contact_suffix, client_aircraft_contact_type.cliact_name AS act_name, client_aircraft.cliaircraft_forsale_flag AS ac_forsale_flag, "
      sql = sql & " client_aircraft.cliaircraft_exclusive_flag AS ac_exclusive_flag, client_aircraft.cliaircraft_asking_wordage AS ac_asking_wordage, "
      sql = sql & " client_aircraft.cliaircraft_asking_price AS ac_asking_price, client_aircraft.cliaircraft_lease_flag AS ac_lease_flag, client_contact.clicontact_id AS contact_id, "
      sql = sql & " 'CLIENT' AS source, client_aircraft.cliaircraft_delivery AS ac_delivery, client_aircraft_reference.cliacref_owner_percentage AS acref_owner_percentage, "
      sql = sql & " client_aircraft_reference.cliacref_id, client_aircraft_reference.cliacref_cliac_id, client_aircraft_reference.cliacref_jetnet_ac_id, "
      sql = sql & " client_aircraft_reference.cliacref_contact_priority, client_aircraft_reference.cliacref_comp_id AS comp_id, "
      sql = sql & " client_aircraft.cliaircraft_product_business_flag AS ac_product_business_flag, client_aircraft.cliaircraft_product_helicopter_flag AS ac_product_helicopter_flag, "
      sql = sql & " client_aircraft.cliaircraft_product_commercial_flag AS ac_product_commercial_flag, client_aircraft_model.cliamod_make_type AS amod_make_type"
      sql = sql & " FROM  client_aircraft_reference INNER JOIN"
      sql = sql & " client_aircraft_contact_type ON client_aircraft_reference.cliacref_contact_type = client_aircraft_contact_type.cliact_type LEFT OUTER JOIN"
      sql = sql & "  client_aircraft ON client_aircraft.cliaircraft_id = client_aircraft_reference.cliacref_cliac_id "
      sql = sql & " left outer join client_aircraft_engine on cliacep_cliac_id= client_aircraft_reference.cliacref_cliac_id "
      sql = sql & " LEFT OUTER JOIN"
      sql = sql & " client_contact ON client_contact.clicontact_id = client_aircraft_reference.cliacref_contact_id LEFT OUTER JOIN"
      sql = sql & "  client_aircraft_model ON client_aircraft_model.cliamod_id = client_aircraft.cliaircraft_cliamod_id"
      sql = sql & "  WHERE (client_aircraft_reference.cliacref_comp_id = " & acomp_ID & ") "


      datatable.Columns.Add("ac_id")
      datatable.Columns.Add("ac_amod_id")
      datatable.Columns.Add("ac_ser_nbr")
      datatable.Columns.Add("ac_reg_nbr")
      datatable.Columns.Add("ac_airframe_tot_hrs")
      datatable.Columns.Add("ac_engine_name")
      datatable.Columns.Add("ac_airframe_total_hours")
      datatable.Columns.Add("ac_year")
      datatable.Columns.Add("ac_ser_no_full")
      datatable.Columns.Add("ac_date_listed")
      datatable.Columns.Add("comp_name")
      datatable.Columns.Add("comp_country")
      datatable.Columns.Add("comp_city")
      datatable.Columns.Add("comp_state")
      datatable.Columns.Add("amod_make_Type")

      datatable.Columns.Add("contact_title")
      datatable.Columns.Add("cref_transmit_seq_no")

      datatable.Columns.Add("amod_make_name")
      datatable.Columns.Add("amod_model_name")
      datatable.Columns.Add("ac_status")
      datatable.Columns.Add("ac_year_mfr")
      datatable.Columns.Add("contact_sirname")
      datatable.Columns.Add("contact_first_name")
      datatable.Columns.Add("contact_middle_initial")
      datatable.Columns.Add("contact_last_name")

      datatable.Columns.Add("contact_suffix")


      datatable.Columns.Add("act_name")



      datatable.Columns.Add("ac_forsale_flag")


      datatable.Columns.Add("ac_exclusive_flag")

      datatable.Columns.Add("ac_asking_wordage")
      datatable.Columns.Add("ac_asking_price")



      datatable.Columns.Add("ac_lease_flag")



      datatable.Columns.Add("contact_id")

      datatable.Columns.Add("source")
      datatable.Columns.Add("ac_delivery")
      datatable.Columns.Add("acref_owner_percentage")



      datatable.Columns.Add("cliacref_id")

      ' datatable.Columns.Add("cliacref_id")

      datatable.Columns.Add("clicontact_jetnet_contact_id")

      datatable.Columns.Add("cliacref_cliac_id")
      datatable.Columns.Add("cliacref_jetnet_ac_id")

      datatable.Columns.Add("cliacref_contact_priority")
      datatable.Columns.Add("comp_id")

      datatable.Columns.Add("ac_product_business_flag")
      datatable.Columns.Add("ac_product_helicopter_flag")
      datatable.Columns.Add("ac_product_commercial_flag")
      datatable.Columns.Add("amod_make_type")

      MySqlConn = New MySql.Data.MySqlClient.MySqlConnection
      MySqlCommand = New MySql.Data.MySqlClient.MySqlCommand

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      While MySqlReader.Read()
        Dim newCustomersRow As DataRow = datatable.NewRow()
        newCustomersRow("cliacref_id") = MySqlReader.Item("cliacref_id")
        newCustomersRow("ac_id") = MySqlReader.Item("ac_id")
        newCustomersRow("ac_amod_id") = MySqlReader.Item("ac_amod_id")
        newCustomersRow("ac_ser_nbr") = MySqlReader.Item("ac_ser_nbr")
        newCustomersRow("ac_reg_nbr") = MySqlReader.Item("ac_reg_nbr")
        newCustomersRow("ac_airframe_tot_hrs") = MySqlReader.Item("ac_airframe_tot_hrs")
        newCustomersRow("amod_make_name") = MySqlReader.Item("amod_make_name")
        newCustomersRow("amod_model_name") = MySqlReader.Item("amod_model_name")
        newCustomersRow("ac_status") = MySqlReader.Item("ac_status")
        newCustomersRow("ac_year_mfr") = MySqlReader.Item("ac_year_mfr")
        newCustomersRow("contact_sirname") = MySqlReader.Item("contact_sirname")
        newCustomersRow("contact_first_name") = MySqlReader.Item("contact_first_name")
        newCustomersRow("clicontact_jetnet_contact_id") = IIf(Not IsDBNull(MySqlReader.Item("clicontact_jetnet_contact_id")), MySqlReader.Item("clicontact_jetnet_contact_id"), 0)
        newCustomersRow("ac_engine_name") = MySqlReader.Item("ac_engine_name")
        newCustomersRow("ac_airframe_total_hours") = MySqlReader.Item("ac_airframe_tot_hrs")
        newCustomersRow("ac_year") = MySqlReader.Item("ac_year")
        newCustomersRow("ac_ser_no_full") = MySqlReader.Item("ac_ser_nbr")
        newCustomersRow("ac_date_listed") = MySqlReader.Item("ac_date_listed")
        newCustomersRow("comp_name") = ""
        newCustomersRow("comp_country") = ""
        newCustomersRow("comp_city") = ""
        newCustomersRow("comp_state") = ""
        newCustomersRow("amod_make_Type") = MySqlReader.Item("amod_make_type")

        newCustomersRow("contact_title") = MySqlReader.Item("contact_title")
        newCustomersRow("cref_transmit_seq_no") = MySqlReader.Item("cref_transmit_seq_no")

        newCustomersRow("contact_middle_initial") = MySqlReader.Item("contact_middle_initial")
        newCustomersRow("contact_last_name") = MySqlReader.Item("contact_last_name")
        newCustomersRow("contact_suffix") = MySqlReader.Item("contact_suffix")

        newCustomersRow("act_name") = MySqlReader.Item("act_name")
        newCustomersRow("ac_forsale_flag") = MySqlReader.Item("ac_forsale_flag")
        newCustomersRow("ac_exclusive_flag") = MySqlReader.Item("ac_exclusive_flag")
        newCustomersRow("ac_asking_wordage") = MySqlReader.Item("ac_asking_wordage")


        newCustomersRow("ac_asking_price") = MySqlReader.Item("ac_asking_price")
        newCustomersRow("ac_lease_flag") = MySqlReader.Item("ac_lease_flag")

        newCustomersRow("contact_id") = IIf(Not IsDBNull(MySqlReader.Item("contact_id")), MySqlReader.Item("contact_id"), 0)

        newCustomersRow("source") = MySqlReader.Item("source")
        newCustomersRow("ac_delivery") = MySqlReader.Item("ac_delivery")
        newCustomersRow("acref_owner_percentage") = MySqlReader.Item("acref_owner_percentage")
        newCustomersRow("cliacref_id") = MySqlReader.Item("cliacref_id")


        newCustomersRow("cliacref_cliac_id") = MySqlReader.Item("cliacref_cliac_id")
        newCustomersRow("cliacref_jetnet_ac_id") = MySqlReader.Item("cliacref_jetnet_ac_id")
        newCustomersRow("cliacref_contact_priority") = MySqlReader.Item("cliacref_contact_priority")
        newCustomersRow("comp_id") = MySqlReader.Item("comp_id")
        newCustomersRow("ac_product_business_flag") = MySqlReader.Item("ac_product_business_flag")

        newCustomersRow("ac_product_helicopter_flag") = MySqlReader.Item("ac_product_helicopter_flag")
        newCustomersRow("ac_product_commercial_flag") = MySqlReader.Item("ac_product_commercial_flag")
        newCustomersRow("amod_make_type") = MySqlReader.Item("amod_make_type")

        datatable.Rows.Add(newCustomersRow)
        datatable.AcceptChanges()
      End While


      returnTable = datatable

      If Not IsNothing(dsClient_JETNET_AC_Merger) Then
        If dsClient_JETNET_AC_Merger.Tables(0).Rows.Count > 0 Then
          If Me.bolDisable_JETNET Then
            Get_Client_JETNET_AC = Nothing
          Else

            aTempTable = SetUpClientACForListing(sort_by, dsClient_JETNET_AC_Merger, acomp_ID)

            If Not IsNothing(aTempTable) Then
              Dim afileterd_CLIENT As DataRow() = datatable.Select("ac_id IS NOT NULL", sort_by)
              ' extract and import
              For Each atmpDataRow In afileterd_CLIENT
                aTempTable.ImportRow(atmpDataRow)
              Next
            End If

            Get_Client_JETNET_AC = aTempTable
          End If
        Else
          Get_Client_JETNET_AC = Nothing
        End If
      End If
      Return aTempTable

    Catch ex As Exception
      Get_Client_JETNET_AC = Nothing
      Me.class_error = "Error in SQL Get_Client_JETNET_AC(ByVal acomp_ID As Integer, ByVal sort_by As String, ByVal Helicopter As Boolean, ByVal Business As Boolean, ByVal Commercial As Boolean, ByVal Jets As Boolean, ByVal Executive As Boolean, ByVal Turboprops As Boolean) As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
  Public Function References_Table_Setup() As DataTable
    Dim aTempTable As New DataTable
    aTempTable.Columns.Add("ac_id")
    aTempTable.Columns.Add("ac_amod_id")
    aTempTable.Columns.Add("ac_ser_nbr")
    aTempTable.Columns.Add("ac_reg_nbr")
    aTempTable.Columns.Add("ac_airframe_tot_hrs")
    aTempTable.Columns.Add("ac_airframe_total_hours")
    aTempTable.Columns.Add("ac_year")
    aTempTable.Columns.Add("ac_ser_no_full")
    aTempTable.Columns.Add("ac_date_listed")
    aTempTable.Columns.Add("comp_name")
    aTempTable.Columns.Add("comp_country")
    aTempTable.Columns.Add("comp_state")
    aTempTable.Columns.Add("comp_city")

    aTempTable.Columns.Add("contact_title")
    aTempTable.Columns.Add("clicontact_jetnet_contact_id")
    aTempTable.Columns.Add("cref_transmit_seq_no")
    aTempTable.Columns.Add("ac_engine_name")
    aTempTable.Columns.Add("amod_make_name")
    aTempTable.Columns.Add("amod_make_Type")
    aTempTable.Columns.Add("amod_model_name")
    aTempTable.Columns.Add("ac_status")
    aTempTable.Columns.Add("ac_year_mfr")
    aTempTable.Columns.Add("contact_sirname")
    aTempTable.Columns.Add("contact_first_name")
    aTempTable.Columns.Add("contact_last_name")
    aTempTable.Columns.Add("contact_middle_initial")
    aTempTable.Columns.Add("contact_suffix")
    aTempTable.Columns.Add("act_name")
    aTempTable.Columns.Add("ac_forsale_flag")
    aTempTable.Columns.Add("ac_exclusive_flag")
    aTempTable.Columns.Add("ac_asking_wordage")
    aTempTable.Columns.Add("ac_asking_price")
    aTempTable.Columns.Add("ac_lease_flag")
    aTempTable.Columns.Add("contact_id")
    aTempTable.Columns.Add("source")
    aTempTable.Columns.Add("ac_delivery")
    aTempTable.Columns.Add("cliacref_id")
    aTempTable.Columns.Add("cliacref_cliac_id")
    aTempTable.Columns.Add("cliacref_jetnet_ac_id")
    aTempTable.Columns.Add("acref_owner_percentage")
    aTempTable.Columns.Add("cliacref_contact_priority")
    aTempTable.Columns.Add("ac_product_business_flag")
    aTempTable.Columns.Add("comp_id")
    aTempTable.Columns.Add("ac_product_helicopter_flag")
    aTempTable.Columns.Add("ac_product_commercial_flag")
    Return aTempTable
  End Function
  'Made a copy of Tom's function, didn't want to change or alter his.
  Function SetUpClientACForListing(ByVal sort_by As String, ByVal dsReference As DataSet, ByVal acomp_id As Integer) As DataTable
    SetUpClientACForListing = Nothing
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim daltable As New DataTable
    daltable = References_Table_Setup()

    Try

      If Me.bolDisable_JETNET Then
        SetUpClientACForListing = Nothing
        Exit Function
      End If
      ' create strings to hold the ac_ids
      Dim jetnet_ac_ids As String = ""
      ' build the ac_ids based off the passed datatable
      For x As Integer = 0 To dsReference.Tables(0).Rows.Count - 1
        If dsReference.Tables(0).Rows(x).Item("cliacref_jetnet_ac_id") > 0 Then
          jetnet_ac_ids = jetnet_ac_ids & dsReference.Tables(0).Rows(x).Item("cliacref_jetnet_ac_id")
        End If
        If jetnet_ac_ids <> "" And dsReference.Tables(0).Rows(x).Item("cliacref_jetnet_ac_id") > 0 Then
          jetnet_ac_ids = jetnet_ac_ids & ","
        End If
      Next
      ' trim the ", "

      jetnet_ac_ids = jetnet_ac_ids.TrimEnd(",")

      Dim dtJETNET As New DataTable

      ' check for no ids
      If jetnet_ac_ids = "" Then
        ' there is no need to merge JETNET AC with client AC
      Else
        ' setup the SQL strings
        Dim aSQL As String = ""
        ' build the select / where strings
        aSQL = "Select DISTINCT "
        aSQL = aSQL & "Aircraft.ac_id, Aircraft.ac_amod_id, ac_ser_no as ac_ser_nbr, ac_engine_name, ac_reg_no as ac_reg_nbr, ac_airframe_tot_hrs as ac_airframe_total_hours, "
        aSQL = aSQL & " Aircraft_Model.amod_make_name, Aircraft_Model.amod_type_code as amod_make_type, ac_list_date as ac_date_listed, ac_year, "
        aSQL = aSQL & "Aircraft_Model.amod_model_name, Aircraft.ac_status, 0 as cref_transmit_seq_no, "
        aSQL = aSQL & "ac_mfr_year as ac_year_mfr, Aircraft.ac_forsale_flag, Aircraft.ac_exclusive_flag, ac_asking as ac_asking_wordage, Aircraft.ac_asking_price, Aircraft.ac_product_helicopter_flag, Aircraft.ac_product_business_flag,Aircraft.ac_product_commercial_flag,  "
        aSQL = aSQL & "Aircraft.ac_lease_flag, 'JETNET' AS source, aircraft.ac_delivery "
        aSQL = aSQL & "FROM aircraft WITH(NOLOCK) LEFT OUTER JOIN "
        aSQL = aSQL & "Aircraft_Model  WITH(NOLOCK) ON Aircraft.ac_amod_id = Aircraft_Model.amod_id  where "
        aSQL = aSQL & " Aircraft.ac_id IN(" & jetnet_ac_ids & ") and ac_journ_id = 0 "

        Dim str As String = clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(HttpContext.Current.Session.Item("localSubscription"), False, True)

        Dim full As String = ""
        full = aSQL & str
        aSQL = full


        clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, aSQL.ToString)
        SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString

        SqlConn.Open()
        SqlCommand.Connection = SqlConn

        SqlCommand.CommandText = aSQL
        SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
        SqlCommand.CommandType = CommandType.Text
        SqlCommand.CommandTimeout = 60

        Try
          dtJETNET.Load(SqlReader)
        Catch constrExc As System.Data.ConstraintException
          Dim rowsErr As System.Data.DataRow() = dtJETNET.GetErrors()
        End Try

      End If

      ' create an integer to hold the JETNET ac_id
      If Not IsNothing(dtJETNET) Then
        If dtJETNET.Rows.Count > 0 Then
          Dim aJETNET_ac_ID As Integer = dtJETNET.Rows(0).Item("ac_id")
          Dim max_row As Integer = dtJETNET.Rows.Count
          Dim cRow As Integer = 0
          For Each r As DataRow In dtJETNET.Rows
            Dim id As Integer = dtJETNET.Rows(cRow).Item("ac_id")

            Dim DataTable As DataTable = dsReference.Tables(0)

            Dim DataTable2 As DataTable = DataTable.Clone
            If Not IsNothing(DataTable) Then
              Dim afileterd_CLIENT As DataRow() = DataTable.Select("cliacref_jetnet_ac_id = '" & dtJETNET.Rows(cRow).Item("ac_id") & "'", "")
              ' extract and import
              For Each atmpDataRow In afileterd_CLIENT
                DataTable2.ImportRow(atmpDataRow)
              Next
            End If

            Dim newCustomersRow As DataRow = daltable.NewRow()
            If DataTable2.Rows.Count > 0 Then
              newCustomersRow("act_name") = DataTable2.Rows(0).Item("cliact_name")
              newCustomersRow("contact_first_name") = DataTable2.Rows(0).Item("clicontact_first_name")
              newCustomersRow("contact_last_name") = DataTable2.Rows(0).Item("clicontact_last_name")
              newCustomersRow("contact_title") = DataTable2.Rows(0).Item("clicontact_title").ToString
              newCustomersRow("clicontact_jetnet_contact_id") = IIf(Not IsDBNull(DataTable2.Rows(0).Item("clicontact_jetnet_contact_id")), DataTable2.Rows(0).Item("clicontact_jetnet_contact_id"), 0)
              newCustomersRow("contact_id") = 0
            End If

            newCustomersRow("ac_id") = id
            newCustomersRow("ac_amod_id") = dtJETNET.Rows(cRow).Item("ac_amod_id")
            newCustomersRow("ac_ser_nbr") = dtJETNET.Rows(cRow).Item("ac_ser_nbr")
            newCustomersRow("ac_reg_nbr") = dtJETNET.Rows(cRow).Item("ac_reg_nbr")
            newCustomersRow("ac_airframe_tot_hrs") = dtJETNET.Rows(cRow).Item("ac_airframe_total_hours")
            newCustomersRow("amod_make_name") = dtJETNET.Rows(cRow).Item("amod_make_name")
            newCustomersRow("amod_make_Type") = dtJETNET.Rows(cRow).Item("amod_make_type")
            newCustomersRow("amod_model_name") = dtJETNET.Rows(cRow).Item("amod_model_name")
            newCustomersRow("ac_status") = dtJETNET.Rows(cRow).Item("ac_status")
            newCustomersRow("ac_year_mfr") = dtJETNET.Rows(cRow).Item("ac_year_mfr")
            newCustomersRow("ac_engine_name") = dtJETNET.Rows(cRow).Item("ac_engine_name")
            newCustomersRow("ac_airframe_total_hours") = dtJETNET.Rows(cRow).Item("ac_airframe_total_hours")
            newCustomersRow("ac_year") = dtJETNET.Rows(cRow).Item("ac_year")
            newCustomersRow("ac_ser_no_full") = dtJETNET.Rows(cRow).Item("ac_ser_nbr")
            newCustomersRow("ac_date_listed") = dtJETNET.Rows(cRow).Item("ac_date_listed")
            newCustomersRow("comp_name") = ""
            newCustomersRow("comp_country") = ""
            newCustomersRow("comp_state") = ""
            newCustomersRow("comp_city") = ""
            newCustomersRow("cref_transmit_seq_no") = r("cref_transmit_seq_no")



            newCustomersRow("ac_forsale_flag") = dtJETNET.Rows(cRow).Item("ac_forsale_flag")
            newCustomersRow("ac_exclusive_flag") = dtJETNET.Rows(cRow).Item("ac_exclusive_flag")
            newCustomersRow("ac_asking_wordage") = dtJETNET.Rows(cRow).Item("ac_asking_wordage")
            newCustomersRow("ac_asking_price") = dtJETNET.Rows(cRow).Item("ac_asking_price")
            newCustomersRow("ac_lease_flag") = dtJETNET.Rows(cRow).Item("ac_lease_flag")

            newCustomersRow("ac_product_helicopter_flag") = dtJETNET.Rows(cRow).Item("ac_product_helicopter_flag")
            newCustomersRow("ac_product_business_flag") = dtJETNET.Rows(cRow).Item("ac_product_business_flag")
            newCustomersRow("ac_product_commercial_flag") = dtJETNET.Rows(cRow).Item("ac_product_commercial_flag")

            newCustomersRow("ac_delivery") = dtJETNET.Rows(cRow).Item("ac_delivery")
            newCustomersRow("source") = "JETNET"

            daltable.Rows.Add(newCustomersRow)
            cRow = cRow + 1
          Next
        End If
      End If
      Return daltable
    Catch ex As Exception
      SetUpClientACForListing = Nothing
      Me.class_error = "Error in SetUpClientACForListing(ByVal sort_by As String, ByVal dsReference As DataSet, ByVal acomp_id As Integer) " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function

  ''' <summary>
  ''' This query is going to look up a company's main location and see if they have a logo/description. 
  ''' </summary>
  ''' <param name="relatedCompanyID"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function GetCompanyMainLocationDescriptionLogo(ByVal relatedCompanyID As Long) As DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable
    Try

      sql = "select top 1 comp_id,comp_logo_flag, comp_customer_notes from Company inner join Company_Reference on comp_id = compref_comp_id "
      sql += " and compref_journ_id = comp_journ_id"
      sql += " where comp_journ_id = 0 and compref_contact_type='59' and compref_rel_comp_id=" & relatedCompanyID


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try


      Return atemptable
    Catch ex As Exception
      GetCompanyMainLocationDescriptionLogo = Nothing
      Me.class_error = "Error in SQL GetCompanyMainLocationDescriptionLogo(ByVal relatedCompanyID As Long) As DataTable " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function

  'Company search baseline for crmevo.

#End Region
#Region "Phone # Queries"
  ''' <summary>
  ''' Phone # query that returns phone numbers in several different spots
  ''' </summary>
  ''' <param name="company_id"></param>
  ''' <param name="contact_id"></param>
  ''' <param name="source"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function GetPhoneNumbers(ByVal company_id As Long, ByVal contact_id As Long, ByVal source As String, ByVal journal_ID As Long) As DataTable
    Dim tempTable As New DataTable
    'sql
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    'mysql
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing


    Try
      Select Case source
        Case "JETNET"

          SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
          SqlConn.Open()
          SqlCommand.Connection = SqlConn

          Dim sQuery As String = "Select distinct pnum_number_full  as pnum_number, pnum_type, pnum_comp_id, pnum_contact_id, ptype_seq_no from phone_numbers WITH (NOLOCK) inner join phone_type on pnum_type = ptype_name where "

          sQuery = sQuery & "pnum_comp_id = " & company_id

          sQuery = sQuery & " and pnum_journ_id = " & journal_ID

          sQuery = sQuery & " and pnum_hide_customer='N' "

          sQuery = sQuery & " and pnum_contact_id = " & contact_id & " order by ptype_seq_no"


          clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sQuery.ToString)

          SqlCommand.CommandText = sQuery
          SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
          SqlCommand.CommandType = CommandType.Text
          SqlCommand.CommandTimeout = 60

          Try
            tempTable.Load(SqlReader)
          Catch constrExc As System.Data.ConstraintException
            Dim rowsErr As System.Data.DataRow() = tempTable.GetErrors()
          End Try

        Case Else

          Dim squery As String = "SELECT clipnum_comp_id AS pnum_comp_id, clipnum_contact_id AS pnum_contact_id, clipnum_id, clipnum_number AS pnum_number, clipnum_type AS pnum_type, 'CLIENT' AS source FROM client_phone_numbers "
          squery = squery & " INNER JOIN client_phone_type ON cliptype_name = clipnum_type"
          squery = squery & " WHERE (clipnum_comp_id = " & company_id & ") AND (clipnum_contact_id = " & contact_id & ")"
          squery = squery & " ORDER BY cliptype_seq_no"



          clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, squery.ToString)
          MySqlConn.ConnectionString = Me.client_DB
          MySqlConn.Open()
          MySqlCommand.Connection = MySqlConn
          MySqlCommand.CommandType = CommandType.Text
          MySqlCommand.CommandTimeout = 60

          MySqlCommand.CommandText = squery
          MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

          Try
            tempTable.Load(MySqlReader)
          Catch constrExc As System.Data.ConstraintException
            Dim rowsErr As System.Data.DataRow() = tempTable.GetErrors()
          End Try

      End Select

      Return tempTable
    Catch ex As Exception
      GetPhoneNumbers = Nothing
      Me.class_error = "Error in GetPhoneNumbers(comp/contact): SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing

      MySqlReader = Nothing

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function


  ''' <summary>
  ''' Retrieves a list of contact/company phone numbers for historical and current companies based on the ac details query pre-existing in evo.
  ''' </summary>
  ''' <param name="pnum_comp_id"></param>
  ''' <param name="pnum_trans_id"></param>
  ''' <param name="pnum_contact_id"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Get_All_JETNET_PhoneNbrs_compID(ByVal pnum_comp_id As Long, ByVal pnum_trans_id As Long, ByVal pnum_contact_id As Long) As DataTable
    Dim aTempTable As New DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Try


      sql = "SELECT * FROM Phone_Numbers WITH(NOLOCK), Phone_Type WITH(NOLOCK) WHERE pnum_comp_id=" & pnum_comp_id
      sql = sql & " and pnum_journ_id=" & pnum_trans_id
      sql = sql & " and pnum_contact_id = " & pnum_contact_id
      sql = sql & " AND pnum_hide_customer <> 'Y'"
      sql = sql & " AND pnum_type = ptype_name"
      sql = sql & " ORDER BY ptype_seq_no"


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable
    Catch ex As Exception
      Get_All_JETNET_PhoneNbrs_compID = Nothing
      Me.class_error = "Error in Get_All_JETNET_PhoneNbrs_compID(ByVal pnum_comp_id As Long, ByVal pnum_trans_id As Long, ByVal pnum_contact_id As Long) As DataTable: SQL VERSION " & ex.Message

    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try


  End Function

  Public Function GetPreferencesPhoneNumbers(ByVal company_id As Long, ByVal contact_id As Long, ByVal contact_hide_flag As Boolean, ByVal contact_type As String) As DataTable
    Dim tempTable As New DataTable
    'sql
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      Dim sQuery As String = "Select pnum_number_full as pnum_number, pnum_type from phone_numbers WITH (NOLOCK) inner join phone_type on pnum_type = ptype_name where "

      sQuery = sQuery & "pnum_comp_id = " & company_id

      sQuery = sQuery & " and pnum_journ_id = 0 "

      If contact_hide_flag = False Then
        sQuery = sQuery & " AND pnum_hide_customer = 'N' "
      End If

      sQuery = sQuery & " AND pnum_type IN (" & contact_type & ")"
      sQuery = sQuery & " and pnum_contact_id = " & contact_id & " order by ptype_seq_no"


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sQuery.ToString)

      SqlCommand.CommandText = sQuery
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        tempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = tempTable.GetErrors()
      End Try


      Return tempTable
    Catch ex As Exception
      GetPreferencesPhoneNumbers = Nothing
      Me.class_error = "Error in GetPreferencesPhoneNumbers(ByVal company_id As Integer, ByVal contact_id As long, ByVal contact_hide_flag As long, ByVal contact_type As String) As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function

  Public Function SearchPhoneNumbers(ByVal phone_number As String) As DataTable
    Dim tempTable As New DataTable
    Dim aDatatable As New DataTable
    Dim sql As String = ""
    Dim sql_client As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Dim aTempTable_Jetnet As New DataTable
    Dim aTempTable_Client As New DataTable

    'mysql
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing

    aTempTable_Jetnet.Columns.Add("pnum_comp_id")
    aTempTable_Jetnet.Columns.Add("pnum_contact_id")
    aTempTable_Jetnet.Columns.Add("pnum_type")
    aTempTable_Jetnet.Columns.Add("pnum_number")
    aTempTable_Jetnet.Columns.Add("source")
    aTempTable_Client.Columns.Add("pnum_comp_id")
    aTempTable_Client.Columns.Add("pnum_contact_id")
    aTempTable_Client.Columns.Add("pnum_type")
    aTempTable_Client.Columns.Add("pnum_number")
    aTempTable_Client.Columns.Add("source")

    Try


      If HttpContext.Current.Session.Item("localUser").crmEvo <> True Then
        sql_client = " SELECT client_phone_numbers.clipnum_id, client_phone_numbers.clipnum_comp_id AS pnum_comp_id, client_phone_numbers.clipnum_contact_id AS pnum_contact_id, "
        sql_client = sql_client & " client_phone_numbers.clipnum_type AS pnum_type, client_phone_numbers.clipnum_number AS pnum_number, 'CLIENT' AS source"
        sql_client = sql_client & " FROM client_phone_numbers INNER JOIN"
        sql_client = sql_client & "  client_phone_type ON client_phone_type.cliptype_name = client_phone_numbers.clipnum_type"
        sql_client = sql_client & " WHERE (client_phone_numbers.clipnum_number LIKE '" & phone_number & "')"
        sql_client = sql_client & " ORDER BY client_phone_type.cliptype_seq_no"


        clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql_client.ToString)
        MySqlConn.ConnectionString = Me.client_DB
        MySqlConn.Open()
        MySqlCommand.Connection = MySqlConn
        MySqlCommand.CommandType = CommandType.Text
        MySqlCommand.CommandTimeout = 60

        MySqlCommand.CommandText = sql_client
        MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

        Try
          aTempTable_Client.Load(MySqlReader)
        Catch constrExc As System.Data.ConstraintException
          Dim rowsErr As System.Data.DataRow() = tempTable.GetErrors()
        End Try

      End If

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn



      sql = " SELECT  phone_numbers.pnum_comp_id, phone_numbers.pnum_contact_id, phone_numbers.pnum_type, pnum_number_full as pnum_number, 'JETNET' AS source"
      sql = sql & " FROM  phone_numbers with (NOLOCK) INNER JOIN"
      sql = sql & " phone_type  WITH(NOLOCK) ON phone_type.ptype_name = phone_numbers.pnum_type"
      sql = sql & " WHERE  (phone_numbers.pnum_number_full LIKE '" & phone_number & "' and pnum_journ_id = 0 )"
      sql = sql & " ORDER BY phone_type.ptype_seq_no"



      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        aTempTable_Jetnet.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = tempTable.GetErrors()
      End Try

      tempTable = aTempTable_Jetnet.Clone

      ' create an array datarows for extraction
      Dim afileterd As DataRow() = aTempTable_Jetnet.Select("", "pnum_comp_id ASC")
      ' a single data row for importing to the dalTable
      Dim atmpDataRow As DataRow
      ' extract and import
      For Each atmpDataRow In afileterd
        tempTable.ImportRow(atmpDataRow)
      Next
      ' reset the array to the other table
      afileterd = aTempTable_Client.Select("", "pnum_comp_id ASC")
      ' extract and import
      For Each atmpDataRow In afileterd
        tempTable.ImportRow(atmpDataRow)
      Next

      afileterd = tempTable.Select("", "pnum_comp_id ASC")

      aDatatable = tempTable.Clone

      For Each atmpDataRow In afileterd
        aDatatable.ImportRow(atmpDataRow)
      Next
      SearchPhoneNumbers = aDatatable


    Catch ex As Exception
      SearchPhoneNumbers = Nothing
      Me.class_error = "Error in SearchPhoneNumbers(" & phone_number & "): SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing

      MySqlReader = Nothing

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: GetContact_PhoneNumbers
  ' Purpose: to get all the PhoneNumbers in the JETNET & CLIENT DBs
  ' Parameters: none
  ' Return: 
  '       DataTable
  ' Change Log
  '           1/20/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function GetContact_PhoneNumbers(ByVal contact_id As Integer) As DataTable
    'sql
    Dim temptable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim sql As String = ""
    Try
      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      sql = " SELECT pnum_comp_id, pnum_contact_id,  pnum_number_full as pnum_number, pnum_type, 'JETNET' AS source, ptype_seq_no from phone_numbers WITH (NOLOCK) "
      sql = sql & " INNER JOIN phone_type with (NOLOCK) ON phone_type.ptype_name = phone_numbers.pnum_type "
      sql = sql & " WHERE (pnum_contact_id = " & contact_id & "  and pnum_journ_id = 0 )"
      sql = sql & " order by ptype_seq_no"


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        temptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = temptable.GetErrors()
      End Try
      Return temptable
    Catch ex As Exception
      GetContact_PhoneNumbers = Nothing
      Me.class_error = "Error in GetContact_PhoneNumbers(ByVal contact_id As Integer): SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try


  End Function

#End Region
#Region "Get User Rep Data For Company"
  'SELECT TOP 1 [user_id], user_first_name, user_middle_initial, user_last_name, user_phone_no, user_phone_no_ext, user_email_address,  
  'comp_account_id, accrep_user_id, user_password  
  'FROM Company WITH (NOLOCK)  
  'inner join Account_Rep WITH (NOLOCK) on comp_account_id=accrep_account_id  
  'INNER JOIN [User] WITH (NOLOCK) ON [User].[user_id] =accrep_user_id 
  'WHERE (comp_id = 244241)  AND (comp_journ_id = 0)  
  'AND (user_password <> 'inactive' or user_password is null)    
  Public Function GetRepresentative(ByVal companyID As Integer) As DataTable
    GetRepresentative = New DataTable
    If companyID <> 0 Then
      'sql
      Dim tempTable As New DataTable
      Dim SqlConn As New SqlClient.SqlConnection
      Dim SqlCommand As New SqlClient.SqlCommand
      Dim SqlReader As SqlClient.SqlDataReader
      Dim SqlException As SqlClient.SqlException : SqlException = Nothing
      Dim sql As String = ""
      Try
        SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
        SqlConn.Open()
        SqlCommand.Connection = SqlConn

        sql = " SELECT TOP 1 [user_id], user_first_name, user_middle_initial, user_last_name, user_phone_no, user_phone_no_ext, user_email_address,  "
        sql = sql & " comp_account_id, accrep_user_id, user_password  "
        sql = sql & " FROM Company WITH (NOLOCK)  "
        sql = sql & " inner join Account_Rep WITH (NOLOCK) on comp_account_id=accrep_account_id  "
        sql = sql & " INNER JOIN [User] WITH (NOLOCK) ON [User].[user_id] =accrep_user_id "
        sql = sql & " WHERE (comp_id = " & companyID & ")  AND (comp_journ_id = 0)  "
        sql = sql & " AND (user_password <> 'inactive' or user_password is null)   "



        clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
        SqlCommand.CommandText = sql
        SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
        SqlCommand.CommandType = CommandType.Text
        SqlCommand.CommandTimeout = 60

        Try
          tempTable.Load(SqlReader)
        Catch constrExc As System.Data.ConstraintException
          Dim rowsErr As System.Data.DataRow() = tempTable.GetErrors()
        End Try

        Return tempTable
      Catch ex As Exception
        GetRepresentative = Nothing
        Me.class_error = "Error in GetRepresentative(companyID): SQL VERSION " & ex.Message
      Finally
        SqlReader = Nothing

        SqlConn.Dispose()
        SqlConn.Close()
        SqlConn = Nothing

        SqlCommand.Dispose()
        SqlCommand = Nothing
      End Try
    End If
  End Function

  ''' <summary>
  ''' This query was created on 11/04/2015. 
  ''' Per instruction that we need to change how we run the query to get the account representative 
  ''' on the support tab of the myPreferences page.
  ''' This query below is meant to run first.
  ''' If it returns nothing, then the one called GetRepresentative runs.
  ''' </summary>
  ''' <param name="companyID"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function GetRepresentativeFirstCheck(ByRef companyID As Long) As DataTable
    Dim sqlQuery As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable

    Try
      If companyID > 0 Then
        'Opening Connection
        SqlConn.ConnectionString = JETNET_DB
        SqlConn.Open()


        sqlQuery = "select TOP 1 [user_id], user_first_name, user_middle_initial, user_last_name, "
        sqlQuery += " user_phone_no, user_phone_no_ext, user_email_address, comp_account_id, "
        sqlQuery += " user_password"
        sqlQuery += " FROM Company WITH (NOLOCK)"
        sqlQuery += " LEFT OUTER JOIN [User] AS U2 WITH (NOLOCK) ON U2.[user_id] = comp_marketing_rep"
        sqlQuery += " WHERE(comp_journ_id = 0)"
        sqlQuery += " AND (comp_marketing_rep IS NOT NULL)"
        sqlQuery += " AND (comp_marketing_rep <> '')"
        sqlQuery += " and comp_id = @companyID"

        Dim SqlCommand As New SqlClient.SqlCommand(sqlQuery, SqlConn)


        clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sqlQuery.ToString)
        SqlCommand.Parameters.AddWithValue("companyID", companyID)

        SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

        Try
          atemptable.Load(SqlReader)
        Catch constrExc As System.Data.ConstraintException
          Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
        End Try


        SqlCommand.Dispose()
        SqlCommand = Nothing
      End If

      Return atemptable
    Catch ex As Exception
      GetRepresentativeFirstCheck = Nothing
      Me.class_error = "Error in GetRepresentativeFirstCheck(ByRef companyID As Long) As DataTable: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

    End Try

  End Function
#End Region
#Region "Background Images"
  Public Function GetBackgroundImages() As DataTable
    'sql
    Dim where As String = ""
    Dim temptable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim sql As String = ""
    Try
      'We need to do a test to see if we should even be polling the database

      If ((HttpContext.Current.Session.Item("localSubscription").crmHelicopter_Flag = True) Or (HttpContext.Current.Session.Item("localSubscription").crmBusiness_Flag = True) Or (HttpContext.Current.Session.Item("localSubscription").crmCommercial_Flag = True)) Or (HttpContext.Current.Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.YACHT) Then

        SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
        SqlConn.Open()
        SqlCommand.Connection = SqlConn


        sql = " SELECT * from Evolution_Backgrounds WITH (NOLOCK) "
        sql = sql & " where evoback_active_flag = 'Y' and ( "

        If (HttpContext.Current.Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.YACHT) Then
          where = where & " evoback_product_yacht_flag='Y' "
        Else
          If HttpContext.Current.Session.Item("localSubscription").crmHelicopter_Flag = True Then

            where = where & " evoback_product_helicopter_flag = 'Y' "
          Else
            '  sql = sql & " and evoback_product_helicopter_flag = 'N' "
          End If

          If HttpContext.Current.Session.Item("localSubscription").crmBusiness_Flag = True Then
            If where <> "" Then
              where = where & " or "
            End If
            where = where & "  evoback_product_business_flag = 'Y' "
          Else
            '    sql = sql & " and evoback_product_business_flag = 'N' "
          End If

          If HttpContext.Current.Session.Item("localSubscription").crmCommercial_Flag = True Then
            If where <> "" Then
              where = where & " or "
            End If
            where = where & " evoback_product_commercial_flag = 'Y' "
          Else
            '  sql = sql & " and evoback_product_commercial_flag = 'N' "
          End If
        End If




        sql = sql & where
        sql = sql & " ) order by newid() "


        '[evoback_aerodex_flag] [char](1) NULL,
        '[evoback_product_business_flag] [char](1) NULL,
        '[evoback_product_helicopter_flag] [char](1) NULL,
        '[evoback_product_commercial_flag] [char](1) NULL,


        clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
        SqlCommand.CommandText = sql
        SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
        SqlCommand.CommandType = CommandType.Text
        SqlCommand.CommandTimeout = 60

        Try
          temptable.Load(SqlReader)
        Catch constrExc As System.Data.ConstraintException
          Dim rowsErr As System.Data.DataRow() = temptable.GetErrors()
        End Try

      End If
      Return temptable
    Catch ex As Exception
      GetBackgroundImages = Nothing
      Me.class_error = "Error in GetBackgroundImages(): SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try


  End Function
#End Region
#Region "Market Query"
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  'Method name: Market_Search_Category
  'Purpose: to fill category list box on market search control
  '6/7/11 - Amanda Vaughn
  'These two market search category functions need to be extensible. They all need in clauses. Table adapters don't 
  'allow. So just using regular
  ''' <summary>
  ''' Fills the Market Search Category dropdown in the market search user control
  ''' </summary>
  ''' <returns>Datatable</returns>
  ''' <remarks></remarks>
  Public Function Market_Search_Category() As DataTable

    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Try
      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString

      SqlConn.Open()
      SqlCommand.Connection = SqlConn
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60
      Dim atemptable As New DataTable
      atemptable.Columns.Add("apecat_category_group")

      Dim sQuery As String = "select distinct priorevcat_category as apecat_category_group from priority_events_category WITH(NOLOCK) "



      If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Then
        sQuery = sQuery & " where priorevcat_category <> 'Market Status' "
      End If

      sQuery = sQuery & " order by priorevcat_category"


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sQuery.ToString)

      SqlCommand.CommandText = sQuery
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      While SqlReader.Read()
        Dim newCustomersRow As DataRow = atemptable.NewRow()
        newCustomersRow("apecat_category_group") = SqlReader.Item("apecat_category_group")
        atemptable.Rows.Add(newCustomersRow)
        atemptable.AcceptChanges()
      End While

      Return atemptable
    Catch ex As Exception
      Market_Search_Category = Nothing
      Me.class_error = "Error in Market_Search_Category(): " & ex.Message
    Finally

      SqlConn.Close()
      SqlReader = Nothing
    End Try
  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  'Method name: Market_Search_Type
  'Purpose: to fill type list box on market search control
  '6/7/11 - Amanda Vaughn
  'These two market search category functions need to be extensible. They all need in clauses. Table adapters don't 
  'allow. So just using regular
  ''' <summary>
  ''' To Fill Type List Box on the Market SEarch User Control
  ''' </summary>
  ''' <param name="categories">Categories, a list of categories used in an in clause</param>
  ''' <returns>Returns Datatable</returns>
  ''' <remarks>Didn't use a datahook because IN clause was needed.</remarks>

  Public Function Market_Search_Type(ByVal categories As String, ByVal EventType As String) As DataTable

    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Try
      SqlConn.ConnectionString = JETNET_DB

      SqlConn.Open()
      SqlCommand.Connection = SqlConn
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60
      Dim atemptable As New DataTable
      atemptable.Columns.Add("apecat_category_name")

      Dim sQuery As String = "select distinct priorevcat_category_name as apecat_category_name from priority_events_category WITH(NOLOCK)  "
      sQuery = sQuery & " where "

      'The first Rule:
      'we're going to carry on like normal.
      'Which would be here:
      sQuery = sQuery & " priorevcat_category in (" & categories & ") "

      'the second rule.
      'If the event is Aircraft, then add this rule.
      'select all where priorevcat_category_name not in (‘Newly Added Wanted’,’Company Formal Name Change’)
      If UCase(EventType) = "AIRCRAFT" Then
        sQuery = sQuery & " and priorevcat_category_name not in ('Newly Added Wanted','Company Formal Name Change') "
      End If

      'the third rule.
      'if the event is Wanted, then we add this rule.
      'If wanted events then make list boxes disappear and force query to priorevcat_category_name in (‘Newly Added Wanted’)
      If UCase(EventType) = "WANTED" Then
        sQuery = sQuery & " and priorevcat_category_name in ('Newly Added Wanted')"
      End If

      'the fourth rule.
      'if the event is Company, then we add this rule.
      'If company only events then make list boxes disappear and force query to priorevcat_category_name in (’Company Formal Name Change’)
      If UCase(EventType) = "COMPANY" Then
        sQuery = sQuery & " and priorevcat_category_name in ('Company Formal Name Change')"
      End If

      If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Then
        sQuery = sQuery & " and priorevcat_category <> 'Market Status' "
      End If

      sQuery = sQuery & " order by priorevcat_category_name "


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sQuery.ToString)
      SqlCommand.CommandText = sQuery
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      While SqlReader.Read()
        Dim newCustomersRow As DataRow = atemptable.NewRow()
        newCustomersRow("apecat_category_name") = SqlReader.Item("apecat_category_name")
        atemptable.Rows.Add(newCustomersRow)
        atemptable.AcceptChanges()
      End While


      Return atemptable
    Catch ex As Exception
      Market_Search_Type = Nothing
      Me.class_error = "Error in Market_Search_Type(): " & ex.Message
    Finally
      SqlConn.Close()
      SqlReader = Nothing
    End Try
  End Function

  'this function returns priority events for client
  Public Function PriorityEventsClient(ByVal ac_id As Long, ByVal aerodex As Boolean) As String
    PriorityEventsClient = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Try
      Dim aSQL_String_JETNET_Select As String
      aSQL_String_JETNET_Select = "select top 1 (cast(priorev_entry_date as char) + ' - ' + priorev_subject + ' - ' + priorev_description)  as lastevent from priority_events with(NOLOCK) "
      If aerodex = True Then
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " inner join priority_events_category with(NOLOCK) on priorev_category_code=priorevcat_category_code "
      End If

      aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & "where priorev_ac_id = " & ac_id & " and priorev_entry_date >= '"
      aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & Year(DateAdd(DateInterval.Day, -7, Now())) & "-" & Month(DateAdd(DateInterval.Day, -7, Now())) & "-" & Day(DateAdd(DateInterval.Day, -7, Now()))
      aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & "'"
      If aerodex = True Then
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " and priorevcat_category<>'Market Status' "
      End If
      aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " order by priorev_entry_date desc "

      aSQL_String_JETNET_Select = aSQL_String_JETNET_Select

      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, aSQL_String_JETNET_Select.ToString)
      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60
      SqlCommand.CommandText = aSQL_String_JETNET_Select
      SqlReader = SqlCommand.ExecuteReader()
      ac_id = ac_id
      While SqlReader.Read()
        If Not IsDBNull(SqlReader.Item("lastevent")) Then
          PriorityEventsClient = SqlReader.Item("lastevent")
        End If
      End While
      SqlReader.Close()
      aSQL_String_JETNET_Select = ""
    Finally
      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlReader = Nothing
    End Try
  End Function

  ''' <summary>
  ''' Returns list of events on ac details page.
  ''' </summary>
  ''' <param name="ac_id"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function EvoACDetailsReturnEvents(ByVal ac_id As Long) As DataTable
    EvoACDetailsReturnEvents = New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim sql As String = ""
    Dim tempTable As New DataTable
    Try
      sql = "SELECT * FROM Aircraft WITH(NOLOCK), Priority_Events WITH(NOLOCK), Aircraft_Model WITH(NOLOCK)"
      sql &= " WHERE ac_amod_id = amod_id AND priorev_ac_id = ac_id AND ac_journ_id = 0 AND ac_id = " & ac_id & " "
      sql &= clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(HttpContext.Current.Session.Item("localSubscription"), False, False)


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
      SqlConn.ConnectionString = JETNET_DB

      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        tempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = tempTable.GetErrors()
      End Try


    Catch ex As Exception
      EvoACDetailsReturnEvents = Nothing
      Me.class_error = "Error in EvoACDetailsReturnEvents(ByVal ac_id As Long) As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try
    Return tempTable
  End Function
  Public Function AC_Listing_Market_Search(ByVal models As String, ByVal start_date As String, ByVal end_date As String, ByVal aerodex_flag As Boolean, ByVal ac_id As Long, ByVal categories As String, ByVal types As String, ByVal sort As String)
    Dim market_sql As String = ""
    Dim market_sql_where As String = ""
    Dim andQ As String = ""
    Dim aTempTable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try
      market_sql = " select priorev_entry_date as apev_entry_date, priorev_entry_date as apev_action_date, "
      market_sql = market_sql & " priorev_subject as apev_subject, "
      market_sql = market_sql & " priorev_description as apev_description, '0' as client_id "
      market_sql = market_sql & "from priority_events with(NOLOCK) "

      market_sql = market_sql & " inner join priority_events_category with(NOLOCK) on priorev_category_code=priorevcat_category_code "
      market_sql = market_sql & " where "

      If aerodex_flag = True Then
        market_sql_where = " priorevcat_category <> 'Market Status' "
      End If


      If market_sql_where <> "" Then
        andQ = " and"
      Else
        andQ = ""
      End If

      '  market_sql_where = market_sql_where & andQ & " priorev_journ_id = 0 "
      market_sql_where = market_sql_where & andQ & " priorev_hide_flag = 'N' "

      If ac_id <> 0 Then
        If market_sql_where <> "" Then
          andQ = " and"
        Else
          andQ = ""
        End If
        market_sql_where = market_sql_where & andQ & "  priorev_ac_id = " & ac_id & " "
      End If

      If sort = "" Then
        market_sql_where = market_sql_where & " order by priorev_entry_date desc "
      Else
        market_sql_where = market_sql_where & " order by " & sort
      End If

      Dim sql As String = market_sql & market_sql_where
      sql = sql


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = market_sql & market_sql_where
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60
      'SqlReader = Nothing

      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable
    Catch ex As Exception
      AC_Listing_Market_Search = Nothing
      Me.class_error = "Error in AC_Listing_Market_Search(ByVal models As String, ByVal start_date As String, ByVal aerodex_flag As Boolean, ByVal ac_id As Integer, ByVal categories As String, ByVal types As String): SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try


  End Function
  Public Function YACHT_Listing_Market_Search(ByVal models As String, ByVal start_date As String, ByVal end_date As String, ByVal aerodex_flag As Boolean, ByVal yacht_id As Long, ByVal categories As String, ByVal types As String)
    Dim market_sql As String = ""
    Dim market_sql_where As String = ""
    Dim andQ As String = ""
    Dim aTempTable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try
      market_sql = " select ype_entered_date as apev_entry_date, ype_action_date as apev_action_date, "
      market_sql = market_sql & " ype_subject as apev_subject, "
      market_sql = market_sql & " ype_description as apev_description, '0' as client_id "
      market_sql = market_sql & "from Yacht_priority_Events with(NOLOCK) "

      market_sql = market_sql & " inner join yacht_priority_events_category with(NOLOCK) on ypec_category_code=ype_category_code "
      market_sql = market_sql & " where "



      If market_sql_where <> "" Then
        andQ = " and"
      Else
        andQ = ""
      End If

      '   market_sql_where = market_sql_where & andQ & " ype_journ_id = 0 "
      market_sql_where = market_sql_where & andQ & " ype_hide_flag = 'N' "

      If yacht_id <> 0 Then
        If market_sql_where <> "" Then
          andQ = " and"
        Else
          andQ = ""
        End If
        market_sql_where = market_sql_where & andQ & "  ype_yt_id = " & yacht_id & " "
      End If

      market_sql_where = market_sql_where & " order by ype_entered_date desc "

      Dim sql As String = market_sql & market_sql_where
      sql = sql


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, market_sql.ToString & market_sql_where.ToString)

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = market_sql & market_sql_where
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60
      'SqlReader = Nothing

      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable
    Catch ex As Exception
      YACHT_Listing_Market_Search = Nothing
      Me.class_error = "Error in AC_Listing_Market_Search(ByVal models As String, ByVal start_date As String, ByVal aerodex_flag As Boolean, ByVal ac_id As Integer, ByVal categories As String, ByVal types As String): SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try


  End Function
  ''' <summary>
  ''' Search Query for Market on listing page
  ''' </summary>
  ''' <param name="models"></param>
  ''' <param name="start_date"></param>
  ''' <param name="end_date"></param>
  ''' <param name="aerodex_flag"></param>
  ''' <param name="ac_id"></param>
  ''' <param name="categories"></param>
  ''' <param name="types"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Market_Search(ByVal models As String, ByVal start_date As String, ByVal end_date As String, ByVal aerodex_flag As Boolean, ByVal ac_id As Long, ByVal categories As String, ByVal types As String)
    Dim market_sql As String = ""
    Dim market_sql_where As String = ""
    Dim andQ As String = ""
    Dim aTempTable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try
      market_sql = " select priorev_entry_date as apev_entry_date, ac_reg_no, priorev_entry_date as apev_action_date, "
      market_sql = market_sql & " amod_make_name, amod_model_name, ac_id, ac_year, ac_ser_no as ac_ser_nbr, priorev_subject as apev_subject, "
      market_sql = market_sql & " priorev_description as apev_description, '0' as client_id "
      market_sql = market_sql & "from priority_events with(NOLOCK) "
      market_sql = market_sql & "inner join aircraft with(NOLOCK) on priorev_ac_id = ac_id and ac_journ_id = 0 "
      market_sql = market_sql & "inner join priority_events_category with(NOLOCK) on priorev_category_code=priorevcat_category_code "
      market_sql = market_sql & "inner join aircraft_model with(NOLOCK) on ac_amod_id = amod_id where "

      If aerodex_flag = True Then
        market_sql_where = " priorevcat_category_group<>'Market Status' "
      End If


      If market_sql_where <> "" Then
        andQ = " and"
      Else
        andQ = ""
      End If
      market_sql_where = market_sql_where & andQ & " priorev_hide_flag='N' "



      market_sql_where = market_sql_where & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(HttpContext.Current.Session.Item("localSubscription"), False, False)

      If models <> "" Then
        If market_sql_where <> "" Then
          andQ = " and"
        Else
          andQ = ""
        End If
        market_sql_where = market_sql_where & andQ & " ac_amod_id in (" & models & ") "
      End If

      If categories = "''" Then
        categories = ""
      End If
      If types = "''" Then
        types = ""
      End If
      If categories <> "" Then
        If market_sql_where <> "" Then
          andQ = " and"
        Else
          andQ = ""
        End If
        market_sql_where = market_sql_where & andQ & " priorevcat_category in (" & categories & ") "
      End If

      If types <> "" Then
        If market_sql_where <> "" Then
          andQ = " and"
        Else
          andQ = ""
        End If
        market_sql_where = market_sql_where & andQ & " priorevcat_category_name in (" & types & ") "
      End If

      If ac_id <> 0 Then
        If market_sql_where <> "" Then
          andQ = " and"
        Else
          andQ = ""
        End If
        market_sql_where = market_sql_where & andQ & " ac_id = " & ac_id & " "
      End If

      If start_date <> "" Then
        If market_sql_where <> "" Then
          andQ = " and"
        Else
          andQ = ""
        End If
        market_sql_where = market_sql_where & andQ & " priorev_entry_date >= '" & start_date & "'"
      End If

      If end_date <> "" Then
        If market_sql_where <> "" Then
          andQ = " and"
        Else
          andQ = ""
        End If
        market_sql_where = market_sql_where & andQ & " priorev_entry_date <= '" & end_date & "'"
      End If

      market_sql_where = market_sql_where & " order by priorev_entry_date desc,amod_make_name, amod_model_name, ac_ser_no"

      Dim sql As String = market_sql & market_sql_where


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = market_sql & market_sql_where
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60
      'SqlReader = Nothing

      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable
    Catch ex As Exception
      Market_Search = Nothing
      Me.class_error = "Error in Market_Search(ByVal models As String, ByVal start_date As String, ByVal aerodex_flag As Boolean, ByVal ac_id As Integer, ByVal categories As String, ByVal types As String): SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try


  End Function


  Public Function EvolutionCompanyEvents(ByVal compID As Long, ByVal aerodex As Boolean, Optional ByVal is_company_page As Boolean = False) As DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable
    Try
      If compID <> 0 Then
        sql = "SELECT DISTINCT amod_make_name, amod_model_name,amod_id, ac_year, ac_ser_no_full, ac_id, ac_ser_no_sort,"
        sql += " ac_reg_no,priorev_entry_date, priorev_subject, priorev_description"
        sql += " FROM Priority_Events WITH(NOLOCK) "
        sql += " inner join Priority_Events_Category on priorev_category_code = priorevcat_category_code "
        sql += " LEFT OUTER JOIN Aircraft WITH(NOLOCK) ON (priorev_ac_id = ac_id AND ac_journ_id = 0) "
        sql += " LEFT OUTER JOIN Aircraft_Model WITH(NOLOCK) ON (ac_amod_id = amod_id) "
        sql += " WHERE (priorev_hide_flag = 'N') AND (priorev_comp_id = " & compID & ") "
        If aerodex = True Then
          sql += " and priorevcat_category<>'Market Status' "
        End If
        '-- SUBSCRIPTION AIRCRAFT CRITERIA
        sql += " " & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(HttpContext.Current.Session.Item("localSubscription"), False, True)

        If is_company_page Then
          sql += " ORDER BY priorev_entry_date desc, amod_make_name asc, amod_model_name, ac_ser_no_sort"
        Else
          sql += " ORDER BY amod_make_name, amod_model_name, ac_ser_no_sort"
        End If



        clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
        SqlConn.ConnectionString = JETNET_DB
        SqlConn.Open()
        SqlCommand.Connection = SqlConn


        SqlCommand.CommandText = sql
        SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
        SqlCommand.CommandType = CommandType.Text
        SqlCommand.CommandTimeout = 60

        Try
          atemptable.Load(SqlReader)
        Catch constrExc As System.Data.ConstraintException
          Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
        End Try
      End If
      EvolutionCompanyEvents = atemptable
    Catch ex As Exception
      EvolutionCompanyEvents = Nothing
      Me.class_error = "Error in EvolutionCompanyEvents(ByVal compID As Long) As DataTable SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try
  End Function
  ''' <summary>
  ''' This returns a list of events for a list of aircraft models from the flat table
  ''' </summary>
  ''' <param name="weekdateValue">day value querying against</param>
  ''' <param name="amod_IDs">IDS of models</param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function HomePageGetEventsListing(ByVal weekdateValue As String, ByVal amod_IDs As String, ByVal eventCategory As String) As DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable
    Try
      If amod_IDs <> "" Then

        sql = " select * "
        sql = sql & " from aircraft_flat with (NOLOCK) "
        sql = sql & " inner join Priority_Events on ac_id = priorev_ac_id "
        sql = sql & " inner join Priority_Events_Category WITH(NOLOCK) on priorev_category_code=priorevcat_category_code"
        sql = sql & " where ac_journ_id = 0 and amod_id in (" & amod_IDs & ")"
        sql = sql & " and priorev_entry_date >='" & weekdateValue & "'  "

        sql = sql & " and priorev_hide_flag='N'"

        If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Then
          sql = sql & " And priorev_category_code NOT IN ('CA','EXOFF','EXON','MA','OM','OMNS','SALEP','SC','SPTOIM')"
        End If

        If eventCategory <> "" Then
          sql = sql & " and priorevcat_category = '" & eventCategory & "'  "
        End If

        '-- SUBSCRIPTION AIRCRAFT CRITERIA
        sql += " " & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(HttpContext.Current.Session.Item("localSubscription"), False, True)


        sql = sql & " order by amod_make_name, amod_model_name, ac_ser_no_sort, priorev_entry_date desc"


        clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
        SqlConn.ConnectionString = JETNET_DB
        SqlConn.Open()
        SqlCommand.Connection = SqlConn


        SqlCommand.CommandText = sql
        SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
        SqlCommand.CommandType = CommandType.Text
        SqlCommand.CommandTimeout = 60

        Try
          atemptable.Load(SqlReader)
        Catch constrExc As System.Data.ConstraintException
          Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
        End Try
      End If
      HomePageGetEventsListing = atemptable
    Catch ex As Exception
      HomePageGetEventsListing = Nothing
      Me.class_error = "Error in HomePageGetEventsListing(ByVal weekdateValue As String, ByVal sub_id As Long, ByVal login As String, ByVal seqNo As Integer) As DataTable SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try
  End Function

  Public Function HomePageGetFolderEventsListing(ByVal weekdateValue As String, ByVal amod_IDs As String, ByVal eventCategory As String, ByVal login As String, ByVal sub_id As Long, ByVal seq As Integer) As DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable
    Try
      If amod_IDs <> "" Then


        sql = " select distinct cfolder_name,cfolder_description, cfolder_jetnet_run_freq_in_mins, "
        sql &= " cfolder_jetnet_run_last_process_date, cfolder_jetnet_run_reply_username, "
        sql &= " cfolder_jetnet_run_reply_email "
        sql = sql & ",  dateadd(MINUTE,cfolder_jetnet_run_freq_in_mins,cfolder_jetnet_run_last_process_date) as NEXTRUN "
        sql &= " from Client_Folder with (NOLOCK)"
        sql &= " inner join Subscription with (NOLOCK) on cfolder_sub_id = sub_id "
        sql &= " inner join Subscription_Install on cfolder_sub_id = subins_sub_id and cfolder_login=subins_login "
        sql &= " and cfolder_seq_no = subins_seq_no "
        sql &= " where cfolder_jetnet_run_flag='Y' "
        sql &= " and cfolder_sub_id = " & sub_id & " and cfolder_login='" & login & "' and cfolder_seq_no=" & seq & " "

        'sql &= " and cfolder_sub_id = 2319 "
        sql &= " order by cfolder_jetnet_run_last_process_date "

        clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
        SqlConn.ConnectionString = JETNET_DB
        SqlConn.Open()
        SqlCommand.Connection = SqlConn


        SqlCommand.CommandText = sql
        SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
        SqlCommand.CommandType = CommandType.Text
        SqlCommand.CommandTimeout = 60

        Try
          atemptable.Load(SqlReader)
        Catch constrExc As System.Data.ConstraintException
          Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
        End Try
      End If
      HomePageGetFolderEventsListing = atemptable
    Catch ex As Exception
      HomePageGetFolderEventsListing = Nothing
      Me.class_error = "Error in HomePageGetEventsListing(ByVal weekdateValue As String, ByVal sub_id As Long, ByVal login As String, ByVal seqNo As Integer) As DataTable SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try
  End Function

  Public Function HomePageGetMarketSummaryListing_SPI(ByVal amod_IDs As String, ByVal number_of_months_divide As Integer) As DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable
    Dim AclsData_Temp As New clsData_Manager_SQL

    Dim LastMonthDate As Date = Now()
    Dim LastMonth As Integer = 0
    Dim LastMonthYear As Integer = 0

    Dim LastSixMonthDate As Date = Now()
    Dim LastSixMonth As Integer = 0
    Dim LastSixMonthYear As Integer = 0
    Dim table_name As String = ""

    'last month vars
    LastMonthDate = DateAdd(DateInterval.Month, -1, Now())
    LastMonth = Month(LastMonthDate)
    LastMonthYear = Year(LastMonthDate)

    'last six month vars
    LastSixMonthDate = DateAdd(DateInterval.Month, -6, Now())
    LastSixMonth = Month(LastSixMonthDate)
    LastSixMonthYear = Year(LastSixMonthDate)

    Try
      If Not String.IsNullOrEmpty(amod_IDs.Trim) Then

        sql += " SELECT DISTINCT amod_make_name, amod_model_name, amod_id, amod_type_code, amod_airframe_type_code,"
        sql += " (SELECT COUNT(distinct ac_id) from Aircraft_Flat WITH(NOLOCK) WHERE ac_journ_id = 0 and ac_lifecycle_stage = 3 and Aircraft_Flat.amod_id = a.amod_id) AS INOP,"
        sql += " COUNT(distinct journ_id) AS SALECOUNT,"
        sql += " SUM(case when ac_sale_price > 0 then 1 else 0 end) as SALEPRICECOUNT,"
        sql += " SUM(case when ac_sale_price > 0 and ac_sale_price_display_flag = 'Y' then 1 else 0 end) AS SALEPRICEDISPLAYCOUNT,"
        sql += " MIN(ac_asking_price) AS LOWASKING,"
        sql += " AVG(ac_asking_price) AS AVGASKING,"
        sql += " MAX(ac_asking_price) AS HIGHASKING,"
        sql += " MIN(ac_sale_price) AS LOWSALE,"
        sql += " AVG(ac_sale_price) AS AVGSALE,"
        sql += " MAX(ac_sale_price) AS HIGHSALE"
        sql += " FROM View_Aircraft_History_Flat a WITH(NOLOCK)"
        sql += " WHERE amod_id in (" + amod_IDs.Trim + ")"

        'changed to in clause on 4/26/17.
        'sql += " AND (jcat_used_retail_sales_flag = 'Y') "
        sql += " and journ_subcat_code_part3 NOT IN ('DB','DS','FI','FY','IT','MF','RE','CC','LS', 'RM') "

        sql += " AND (journ_subcat_code_part1 = 'WS') AND (journ_internal_trans_flag = 'N')"
        sql += " AND journ_date >= DATEADD(month, -" & number_of_months_divide & ", DATEDIFF(d, 0, GETDATE()))"

        sql += " " + clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(HttpContext.Current.Session.Item("localSubscription"), False, True)

        sql += " AND journ_newac_flag = 'N' AND journ_internal_trans_flag = 'N'"

        sql += " AND ("

        sql += " (journ_date >"
        sql += " (SELECT TOP 1 journ_date FROM View_Aircraft_History_Flat af2 WITH(NOLOCK)"
        sql += " WHERE af2.ac_id = a.ac_id"
        sql += " AND (af2.journ_newac_flag = 'Y' OR ac_previously_owned_flag = 'Y')"
        sql += " ORDER BY af2.journ_date asc))"

        sql += " OR"

        sql += " (journ_date ="
        sql += " (SELECT TOP 1 journ_date FROM View_Aircraft_History_Flat af2 WITH(NOLOCK)"
        sql += " WHERE af2.ac_id = a.ac_id AND a.ac_journ_id > af2.ac_journ_id"
        sql += " AND (af2.journ_newac_flag = 'Y' OR ac_previously_owned_flag = 'Y')"
        sql += " ORDER BY af2.journ_date asc))"

        sql += " )"

        sql += " GROUP BY amod_make_name, amod_model_name, amod_id, amod_type_code, amod_airframe_type_code"
        sql += " ORDER BY amod_make_name asc, amod_model_name ASC"


        clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
        SqlConn.ConnectionString = JETNET_DB
        SqlConn.Open()
        SqlCommand.Connection = SqlConn


        SqlCommand.CommandText = sql
        SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
        SqlCommand.CommandType = CommandType.Text
        SqlCommand.CommandTimeout = 60

        Try
          atemptable.Load(SqlReader)
        Catch constrExc As System.Data.ConstraintException
          Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
        End Try
      End If
      HomePageGetMarketSummaryListing_SPI = atemptable
    Catch ex As Exception
      HomePageGetMarketSummaryListing_SPI = Nothing
      Me.class_error = "Error in HomePageGetMarketSummaryListing(ByVal amod_IDs As String) As DataTable SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try
  End Function
  Public Function HomePageGetMarketSummaryListing_RECENT(ByVal amod_IDs As String, ByVal number_of_months_divide As Long) As DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable
    Dim AclsData_Temp As New clsData_Manager_SQL

    Dim LastMonthDate As Date = Now()
    Dim LastMonth As Integer = 0
    Dim LastMonthYear As Integer = 0

    Dim LastSixMonthDate As Date = Now()
    Dim LastSixMonth As Integer = 0
    Dim LastSixMonthYear As Integer = 0
    Dim table_name As String = ""

    'last month vars
    LastMonthDate = DateAdd(DateInterval.Month, -1, Now())
    LastMonth = Month(LastMonthDate)
    LastMonthYear = Year(LastMonthDate)

    'last six month vars
    LastSixMonthDate = DateAdd(DateInterval.Month, -6, Now())
    LastSixMonth = Month(LastSixMonthDate)
    LastSixMonthYear = Year(LastSixMonthDate)

    Try
      If Not String.IsNullOrEmpty(amod_IDs.Trim) Then

        sql += " SELECT DISTINCT top 100 ac_id, ac_ser_no_full, amod_make_name, amod_model_name, amod_id, amod_type_code, amod_airframe_type_code, journ_id, journ_date, journ_subject, ac_asking, ac_asking_price, ac_forsale_flag "
        sql += " FROM View_Aircraft_History_Flat a WITH(NOLOCK)"
        sql += " WHERE amod_id in (" + amod_IDs.Trim + ")"

        'changed to in clause on 4/26/17.
        'sql += " AND (jcat_used_retail_sales_flag = 'Y') "
        sql += " and journ_subcat_code_part3 NOT IN ('DB','DS','FI','FY','IT','MF','RE','CC','LS', 'RM') "

        sql += " AND (journ_subcat_code_part1 = 'WS') AND (journ_internal_trans_flag = 'N')"
        sql += " AND journ_date >= DATEADD(month, -" & number_of_months_divide & ", DATEDIFF(d, 0, GETDATE()))"

        sql += " " + clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(HttpContext.Current.Session.Item("localSubscription"), False, True)
        sql += " AND (ac_sale_price = 0  or ac_sale_price is null)"
        sql += " AND journ_newac_flag = 'N' AND journ_internal_trans_flag = 'N'"

        sql += " AND ("

        sql += " (journ_date >"
        sql += " (SELECT TOP 1 journ_date FROM View_Aircraft_History_Flat af2 WITH(NOLOCK)"
        sql += " WHERE af2.ac_id = a.ac_id"
        sql += " AND (af2.journ_newac_flag = 'Y' OR ac_previously_owned_flag = 'Y')"
        sql += " ORDER BY af2.journ_date asc))"

        sql += " OR"

        sql += " (journ_date ="
        sql += " (SELECT TOP 1 journ_date FROM View_Aircraft_History_Flat af2 WITH(NOLOCK)"
        sql += " WHERE af2.ac_id = a.ac_id AND a.ac_journ_id > af2.ac_journ_id"
        sql += " AND (af2.journ_newac_flag = 'Y' OR ac_previously_owned_flag = 'Y')"
        sql += " ORDER BY af2.journ_date asc))"

        sql += " )"

        sql += " ORDER BY journ_date desc, amod_model_name ASC"


        clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
        SqlConn.ConnectionString = JETNET_DB
        SqlConn.Open()
        SqlCommand.Connection = SqlConn


        SqlCommand.CommandText = sql
        SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
        SqlCommand.CommandType = CommandType.Text
        SqlCommand.CommandTimeout = 60

        Try
          atemptable.Load(SqlReader)
        Catch constrExc As System.Data.ConstraintException
          Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
        End Try
      End If
      HomePageGetMarketSummaryListing_RECENT = atemptable
    Catch ex As Exception
      HomePageGetMarketSummaryListing_RECENT = Nothing
      Me.class_error = "Error in HomePageGetMarketSummaryListing(ByVal amod_IDs As String) As DataTable SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try
  End Function
  Public Sub GetMarketListing(ByVal marketLabel As Label, ByVal CRMView As Boolean, ByVal number_of_months_divide As Integer, ByRef market_summary_tab As AjaxControlToolkit.TabPanel, ByRef toggleSalesEvo As Button, ByRef toggleSales As Button)

    Dim forSale As Double = 0
    Dim inOperation As Double = 0

    Dim cssClass As String = ""
    Dim ResultsTable As New DataTable

    'one month variables to figure out +/-
    Dim last_month_count As Double = 0
    Dim last_month_difference As Double = 0
    Dim last_month_percentage As Double = 0

    'six month variables to figure out +/-
    Dim six_month_count As Double = 0
    Dim six_month_difference As Double = 0
    Dim six_month_percentage As Double = 0
    Dim temp_string As String = ""

    Dim total_in_op As Long = 0
    Dim total_for_sale As Long = 0
    Dim total_percent_in_op As Double = 0.0
    Dim total_exclusive As Integer = 0
    Dim total_last_month As Integer = 0
    Dim total_last_six As Integer = 0
    Dim absorb_rate As Double = 0
    Dim total_absorb_rate As Double = 0
    Dim total_forsale As Integer = 0
    Dim total_sales As Integer = 0


    Trace.Write("Start GetMarketListing Home.aspx" + Now.ToString)
    HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br />Start GetMarketListing Home.aspx : " + Now.ToString + "<br />"

    ResultsTable = HomePageGetMarketSummaryListing(HttpContext.Current.Session.Item("localUser").crmSelectedModels, number_of_months_divide)
    If Not IsNothing(ResultsTable) Then
      If ResultsTable.Rows.Count > 0 Then
        marketLabel.Text = ""
        If CRMView Then
          marketLabel.Text += "<span class=""help_cursor"" title=""Information on this tab includes data from JETNET Evolution only and is not customized based on edits made within the Marketplace Manager.""><em>Source: JETNET Evolution</em></span><br />"
        End If

        marketLabel.Text += "<table width=""100%"" cellpadding=""3"" cellspacing=""0"" class=""data_aircraft_grid"">"


        marketLabel.Text += "<tr class=""header_row"">"
        marketLabel.Text += "<td align=""center"" valign=""top"" colspan='10'>"
        marketLabel.Text += "<b class=""title"">CURRENT MARKET – AIRCRAFT FOR SALE</b>"
        marketLabel.Text += "</td>"
        marketLabel.Text += "</tr>"

        marketLabel.Text += "<tr class=""header_row"">"

        If CRMView Then
          marketLabel.Text += "<td align=""right"" valign=""top"" width=""16"">"
          marketLabel.Text += "<b class=""title"">&nbsp;</b>"
          marketLabel.Text += "</td>"
        Else

          '   HttpContext.Current.Session.Item("jetnetServerNotesDatabase") = HttpContext.Current.Session.Item("jetnetClientDatabase")

          '  If localDataLayer.Get_Subscription_Team(Session.Item("localUser").crmSubSubID, "Market Insight") = True Then
          marketLabel.Text += "<td align=""right"" valign=""top"" width=""16"">"
          marketLabel.Text += "<b class=""title"">&nbsp;</b>"
          marketLabel.Text += "</td>"
          'End If

          '  If ((HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.LOCAL) Or (HttpContext.Current.Session.Item("jetnetWebSiteType") = crmWebClient.eWebSiteTypes.TEST)) Then
          If HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag Then
            marketLabel.Text += "<td align=""right"" valign=""top"" width=""16"">"
            marketLabel.Text += "<b class=""title"">&nbsp;</b>"
            marketLabel.Text += "</td>"
          End If
          'End If
        End If


        marketLabel.Text += "<td align=""left"" valign=""top"">"
        marketLabel.Text += "<b class=""title"">Make/Model</b>"
        marketLabel.Text += "</td>"

        marketLabel.Text += "<td align=""right"" valign=""top"">"
        marketLabel.Text += "<b class=""title""># AC<br />in op</b>"
        marketLabel.Text += "</td>"
        marketLabel.Text += "<td align=""right"" valign=""top"">"
        marketLabel.Text += "<b class=""title"">for<br/>sale</b>"
        marketLabel.Text += " </td>"
        marketLabel.Text += "<td align=""right"" valign=""top""><b class=""title"">% for<br/>sale</b></td>"
        If HttpContext.Current.Session.Item("isMobile") = True Then
        Else
          marketLabel.Text += "<td align=""right"" valign=""top""><b class=""title"">exclusive</b></td>"
          marketLabel.Text += " <td align=""right"" valign=""top""><b class=""title"">last<br />month +/-</b></td>"
          marketLabel.Text += "<td align=""right"" valign=""top""><b class=""title"">Last<br />" & number_of_months_divide & " months +/-</b></td>"
        End If
                marketLabel.Text += "<td align=""right"" valign=""top""><a href='help.aspx?t=6&search_term=Absorption Rate'  target='_blank' tag='Based on " & number_of_months_divide & " Months of Trailing Sales' title='Based on " & number_of_months_divide & " Months of Trailing Sales'><b class=""title"">absorption rate<br/>(months)</b></a></td>"
                marketLabel.Text += "</tr>"

        For Each r As DataRow In ResultsTable.Rows
          '''''''''''''Resetting the variables to figure'''''''''''''
          '''''''''''''out for sale % number down below''''''''''''''
          'For sale count
          If Not IsDBNull(r("forsalecount")) Then
            forSale = r("forsalecount")
          Else
            forSale = 0
          End If
          'In Operation variable Count
          If Not IsDBNull(r("inopcount")) Then
            inOperation = r("inopcount")
          Else
            inOperation = 0
          End If
          'Last month count
          If Not IsDBNull(r("lastmonth")) Then
            last_month_count = r("lastmonth")
          Else
            last_month_count = 0
          End If
          'Last six month count
          If Not IsDBNull(r("lastsix")) Then
            six_month_count = r("lastsix")
          Else
            six_month_count = 0
          End If

          'one month variable configuration
          last_month_difference = forSale - last_month_count
          If last_month_count <> 0 Then
            last_month_percentage = last_month_difference / last_month_count
          Else
            last_month_difference = 0
            last_month_percentage = 0
          End If
          last_month_percentage = last_month_percentage * 100
          last_month_percentage = FormatNumber(last_month_percentage, 1)

          'six month variable configuration
          six_month_difference = forSale - six_month_count
          If six_month_count <> 0 Then
            six_month_percentage = six_month_difference / six_month_count
          Else
            six_month_difference = 0
            six_month_percentage = 0
          End If
          six_month_percentage = six_month_percentage * 100
          six_month_percentage = FormatNumber(six_month_percentage, 1)

          '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
          '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

          temp_string += "<tr class='" & cssClass & "'>"

          If CRMView Then
            temp_string += "<td align=""left"" valign=""top"" width=""16"">"
            'Dim ValueTable As New DataTable
            'ValueTable = Master.aclsData_Temp.Get_Client_Value_By_Model(r("amod_id"))
            ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
            '''''''''''''''''''''''''LINK TO VALUE''''''''''''''''''''''''''''''''''
            'If Not IsNothing(ValueTable) Then
            '  If ValueTable.Rows.Count > 0 Then
            '    temp_string += "<img src=""images/current_value.png"" alt="""" alt='Launch Values View' class='help_cursor' title='Launch Market Valuation' onclick=""javascript:load('view_template.aspx?ViewID=19&noteID=" & ValueTable.Rows(0).Item("lnote_id") & "&amod_ID=" & r("amod_id") & "&noMaster=false','','scrollbars=yes,menubar=no,height=700,width=1250,resizable=yes,toolbar=no,location=no,status=no');""/>"
            '  Else
            '    Dim FakeTable As New DataTable

            '    'Okay let's fake in a link here by getting a client aircraft.
            '    FakeTable = Master.aclsData_Temp.Get_Client_Aircraft_By_Model(r("amod_id"))
            '    If Not IsNothing(FakeTable) Then
            '      If FakeTable.Rows.Count > 0 Then
            '        temp_string += "<img src=""images/current_value.png"" alt="""" alt='Launch Values View' class='help_cursor' title='Launch Market Valuation' onclick=""javascript:load('edit_note.aspx?action=new&amp;type=valuation&amp;cat_key=0&amp;ac_ID=" & FakeTable.Rows(0).Item("cliaircraft_jetnet_ac_id") & "&source=JETNET&listing=true&amp;refreshing=view&amod_ID=" & r("amod_id") & "&temporary=true" & "','','scrollbars=yes,menubar=no,height=700,width=1250,resizable=yes,toolbar=no,location=no,status=no');""/>"
            '      End If
            '    End If
            '  End If
            'End If

            'ValueTable.Dispose()
            temp_string += "<img src=""images/current_value.png"" alt=""""  alt='Launch  Market Summary' class='help_cursor values_icon_width' title='Launch Market Summary' onclick=""javascript:load('view_template.aspx?noMaster=false&ViewID=1&ViewName=Model Market Summary&amod_id=" & r("amod_id").ToString & "&activetab=2" & "','','scrollbars=yes,menubar=no,height=700,width=1250,resizable=yes,toolbar=no,location=no,status=no');""/>"

            temp_string += "</td>"
          Else


            ' HttpContext.Current.Session.Item("jetnetServerNotesDatabase") = HttpContext.Current.Session.Item("jetnetClientDatabase")


            ' If localDataLayer.Get_Subscription_Team(Session.Item("localUser").crmSubSubID, "Market Insight") = True Then
            temp_string += "<td align=""left"" valign=""top"" width=""16"">"
            temp_string += "<a href='#' onclick=""javascript:load('viewtopdf.aspx?viewID=998&amod_id=" & r("amod_id") & "','','scrollbars=yes,menubar=no,height=900,width=1150,resizable=yes,toolbar=no,location=no,status=no');return false;"" class=""fa fa-area-chart"" alt='" & r("amod_make_name") & " " & r("amod_model_name") & " Market Report' class='help_cursor' title='" & r("amod_make_name") & " " & r("amod_model_name") & " Market Report'></a>"
            temp_string += "</td>"
            'End If


            If HttpContext.Current.Session.Item("localSubscription").crmSalesPriceIndex_Flag = True Then
              temp_string += "<td align=""left"" valign=""top"" width=""16"">"
              temp_string += "<a " & IIf(HttpContext.Current.Session.Item("isMobile"), "href=""/view_template.aspx?ViewID=27&amod_id=" & r("amod_id") & """", " href=""#"" onclick=""javascript:load('view_template.aspx?ViewID=27&amod_id=" & r("amod_id") & "','','scrollbars=yes,menubar=no,height=700,width=1250,resizable=yes,toolbar=no,location=no,status=no');""") & "><img src=""images/current_value.png"" alt="""" border=""0"" alt='Launch Values View' class='help_cursor values_icon_width' title='Launch Values View'  /></a>"
              temp_string += "</td>"
            End If


          End If



          '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
          ''''''''''''''''''''''''MAKE'''''''''''''''''''''''''''''''''''''''''''
          temp_string += "<td align=""left"" valign=""top"">"
          temp_string += "" & r("amod_make_name").ToString & " "
          temp_string += DisplayFunctions.WriteModelLink(r("amod_id"), r("amod_model_name"), True) ' "<a href=""#"" onclick=""javascript:load('DisplayModelDetail.aspx?id=" & r("amod_id").ToString & "','','scrollbars=yes,menubar=no,height=900,width=1050,resizable=yes,toolbar=no,location=no,status=no');return false;"">" & r("amod_model_name").ToString & "</a>"
          temp_string += "</td>"


          '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
          ''''''''''''''''''''''''TOTAL AC IN OP'''''''''''''''''''''''''''''''''
          temp_string += "<td align=""right"" valign=""top"">"
          If CRMView Then
            temp_string += r("inopcount").ToString
          Else
            temp_string += IIf(HttpContext.Current.Session.Item("isMobile"), "", "<a href='#' onclick=""javascript:document.body.style.cursor = 'wait';SubmitForm('" & r("amod_id") & "','3','N','N','" & r("amod_type_code").ToString & "|" & r("amod_airframe_type_code").ToString & "','" & r("amod_make_name") & "');"">") & r("inopcount").ToString & IIf(HttpContext.Current.Session.Item("isMobile"), "", "</a>")
          End If

          total_in_op = total_in_op + r("inopcount")

          temp_string += "</td>"
          ''''''''''''''''''''''''FOR SALE'''''''''''''''''''''''''''''''''''''''

          temp_string += "<td align=""right"" valign=""top"">"

          If CRMView = False Then
            If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = False Then
              If HttpContext.Current.Session.Item("isMobile") Then
                temp_string += "<a href=""/view_template.aspx?ViewID=11&ViewName=Model Market List&amod_id=" & r("amod_id").ToString & """>"
              Else
                temp_string += "<a href='#' onclick=""javascript:document.body.style.cursor = 'wait';SubmitForm('" & r("amod_id") & "','','Y','N','" & r("amod_type_code").ToString & "|" & r("amod_airframe_type_code").ToString & "','" & r("amod_make_name") & "');"">"
              End If
            End If
          Else
            temp_string += "<a href='/listing_air.aspx?runMarket=true&jetnetModelID=" & r("amod_id") & "&forSale=true'>"
          End If

          temp_string += "" & r("forsalecount").ToString
          total_for_sale = total_for_sale + r("forsalecount")

          If CRMView = False Then
            If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = False Then
              temp_string += "</a>"
            End If
          Else
            temp_string += "</a>"
          End If

          temp_string += "</td>"
          '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
          ''''''''''''''''''''''''% FOR SALE'''''''''''''''''''''''''''''''''''''
          temp_string += "<td align=""right"" valign=""top"">"

          If CRMView = False Then
            If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = False Then
              If HttpContext.Current.Session.Item("isMobile") = False Then
                temp_string += "<a href='#' onclick=""javascript:document.body.style.cursor = 'wait';SubmitForm('" & r("amod_id") & "','3','Y','N','" & r("amod_type_code").ToString & "|" & r("amod_airframe_type_code").ToString & "','" & r("amod_make_name") & "');"">"
              End If
            End If
          End If

          '% for sale = (for sale/total in operation)*100
          temp_string += FormatNumber(((forSale / inOperation) * 100), 1) & "%"


          If CRMView = False Then
            If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = False Then
              If HttpContext.Current.Session.Item("isMobile") = False Then
                temp_string += "</a>"
              End If
            End If
          End If

          temp_string += "</td>"

          If HttpContext.Current.Session.Item("isMobile") = True Then
          Else
            ''''''''''''''''''''''''EXCLUSIVE'''''''''''''''''''''''''''''''''''''''
            temp_string += "<td align=""right"" valign=""top"">"

            If CRMView = False Then
              If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = False Then
                temp_string += "<a href='#' onclick=""javascript:document.body.style.cursor = 'wait';SubmitForm('" & r("amod_id") & "','','N','Y','" & r("amod_type_code").ToString & "|" & r("amod_airframe_type_code").ToString & "','" & r("amod_make_name") & "');"">"
              End If
            End If

            temp_string += "" & r("exclusivecount").ToString
            total_exclusive = total_exclusive + r("exclusivecount")

            If CRMView = False Then
              If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = False Then
                temp_string += "</a>"
              End If
            End If

            temp_string += "</td>"
            '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
            ''''''''''''''''''''''''LAST MONTH'''''''''''''''''''''''''''''''''''''
            temp_string += "<td align=""right"" valign=""top"">"
            If last_month_difference = 0 Then
              temp_string += "<img src='images/gain_loss_none.jpg' alt='' class='image_padding' />"
            ElseIf last_month_difference.ToString > 0 Then
              temp_string += "<img src='images/gain_loss_up.jpg' alt=''/>"
            Else
              temp_string += "<img src='images/gain_loss_down.jpg' alt='' />"
            End If
            temp_string += "" & last_month_difference.ToString & " <span class='tiny_text emphasis_text'>(" & last_month_percentage & "%)</span>"
            total_last_month = total_last_month + last_month_difference
            temp_string += "</td>"
            '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
            ''''''''''''''''''''''''LAST 6 MONTHS''''''''''''''''''''''''''''''''''
            temp_string += "<td align=""right"" valign=""top"">"

            If six_month_difference = 0 Then
              temp_string += "<img src='images/gain_loss_none.jpg' alt='' class='image_padding'/>"
            ElseIf six_month_difference.ToString > 0 Then
              temp_string += "<img src='images/gain_loss_up.jpg' alt=''  />"
            Else
              temp_string += "<img src='images/gain_loss_down.jpg' alt=''  />"
            End If

            temp_string += "" & six_month_difference.ToString & " <span class='tiny_text emphasis_text'>(" & six_month_percentage & "%)</span>"
            total_last_six = total_last_six + six_month_difference
            temp_string += "</td>"
          End If

          temp_string += "<td align=""right"" valign=""top"">"
          If Not IsDBNull(r("SalesPerTimeframe")) Then

            total_forsale = total_forsale + forSale
            total_sales = total_sales + r("SalesPerTimeframe")

            If r("SalesPerTimeframe") = 0 Then
              temp_string &= "-&nbsp;"
            Else
              absorb_rate = FormatNumber((FormatNumber(r("SalesPerTimeframe"), 2) / number_of_months_divide), 2)
              absorb_rate = (FormatNumber(forSale, 2) / FormatNumber(absorb_rate, 2)) ' divide the timeframe by 
              temp_string &= FormatNumber(absorb_rate, 1).ToString.Trim & "&nbsp;"
            End If

          Else
            temp_string += "&nsbp;"
          End If

          temp_string += "</td>"


          temp_string += "</tr>"
          If cssClass = "" Then
            cssClass = "alt_row"
          Else
            cssClass = ""
          End If

          marketLabel.Text += temp_string
          temp_string = ""
        Next

        total_absorb_rate = 0
        If total_for_sale > 0 And total_sales > 0 Then
          total_absorb_rate = (total_for_sale / (total_sales / number_of_months_divide)) ' divide the timeframe by 
        End If


        temp_string = "<tr>"
        temp_string += "<td align=""right"" valign=""top"" colspan='2'><b>Total:&nbsp;</b></td><td>&nbsp;</td>"
        temp_string += "<td align=""right"" valign=""top"">" & FormatNumber(total_in_op, 0) & "</td>"
        temp_string += "<td align=""right"" valign=""top"">" & FormatNumber(total_for_sale, 0) & "</td>"
        temp_string += "<td align=""right"" valign=""top"">" & FormatNumber(((total_for_sale / total_in_op) * 100), 1) & "%</td>"
        temp_string += "<td align=""right"" valign=""top"">" & FormatNumber(total_exclusive, 0) & "</td>"

        If total_last_month > 0 Then
          temp_string += "<td align=""right"" valign=""top""><img src='images/gain_loss_up.jpg' alt=''  />" & total_last_month & "</td>"
        ElseIf total_last_month < 0 Then
          temp_string += "<td align=""right"" valign=""top""><img src='images/gain_loss_down.jpg' alt=''  />" & total_last_month & "</td>"
        ElseIf total_last_month = 0 Then
          temp_string += "<td align=""right"" valign=""top""><img src='images/gain_loss_none.jpg' alt='' class='image_padding'/>" & total_last_month & "</td>"
        End If

        If total_last_six > 0 Then
          temp_string += "<td align=""right"" valign=""top""><img src='images/gain_loss_up.jpg' alt=''  />" & total_last_six & "</td>"
        ElseIf total_last_six < 0 Then
          temp_string += "<td align=""right"" valign=""top""><img src='images/gain_loss_down.jpg' alt=''  />" & total_last_six & "</td>"
        ElseIf total_last_six = 0 Then
          temp_string += "<td align=""right"" valign=""top""><img src='images/gain_loss_none.jpg' alt='' class='image_padding'/>" & total_last_six & "</td>"
        End If

        temp_string += "<td align=""right"" valign=""top"">" & FormatNumber(total_absorb_rate, 1) & "</td>"

        temp_string += "</tr>"
        marketLabel.Text += temp_string
        temp_string = ""

        marketLabel.Text += "</table>"
      Else
        marketLabel.CssClass = "padding" ' emphasis_text"
        ' market_listing_label.Text = "<br /><p align='center'>There are no market items currently.</p>"
        If CRMView = True Then
          marketLabel.Text = "<p align='left'>Welcome " & HttpContext.Current.Session.Item("localUser").crmLocalUserFirstName.ToString & " " & HttpContext.Current.Session.Item("localUser").crmLocalUserLastName.ToString & ".<br />To customize the default  """ & market_summary_tab.HeaderText.ToString & """, ""Events"" and ""Wanted"" tabs, <a href='#' onclick=""javascript:window.open('myCRM.aspx','','scrollbars=yes,menubar=no,height=800,width=1150,resizable=yes,toolbar=no,location=no,status=no');"">select your preferred models using this link</a>."
        Else
          marketLabel.Text = "<p align='left'>Welcome " & HttpContext.Current.Session.Item("localUser").crmLocalUserFirstName.ToString & " " & HttpContext.Current.Session.Item("localUser").crmLocalUserLastName.ToString & ".<br />To customize the default  """ & market_summary_tab.HeaderText.ToString & """, ""Events"" and ""Wanted"" tabs, <a href='#' onclick=""javascript:window.open('Preferences.aspx','','scrollbars=yes,menubar=no,height=800,width=1150,resizable=yes,toolbar=no,location=no,status=no');"">select your preferred models using this link</a>."

        End If

      End If

    Else
      ''error logging here. 
      'Master.LogError("home.aspx.vb - GetMarketListing() - " & masterPage.aclsData_Temp.class_error)
      'clear error for data layer class
      class_error = ""
    End If

    If HttpContext.Current.Session.Item("isMobile") = True Then
    Else 'turn block off for mobile
      If CRMView = False Then
        If Not IsNothing(toggleSalesEvo) Then
          toggleSalesEvo.Visible = True
        End If
      Else
        If Not IsNothing(toggleSales) Then
          toggleSales.Visible = True
        End If
      End If
      'End If
    End If

    Trace.Write("End GetMarketListing Home.aspx" + Now.ToString)
    HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br />End GetMarketListing Home.aspx : " + Now.ToString + "<br />"

  End Sub
  ''' <summary>
  ''' This returns a list of Market Trends for the Home Page based on subscribers selected models
  ''' </summary>
  ''' <param name="amod_IDs">model IDs</param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function HomePageGetMarketSummaryListing(ByVal amod_IDs As String, ByVal number_of_months_divide As Integer) As DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable

    Dim LastMonthDate As Date = Now()
    Dim LastMonth As Integer = 0
    Dim LastMonthYear As Integer = 0

    Dim LastSixMonthDate As Date = Now()
    Dim LastSixMonth As Integer = 0
    Dim LastSixMonthYear As Integer = 0

    'last month vars
    LastMonthDate = DateAdd(DateInterval.Month, -1, Now())
    LastMonth = Month(LastMonthDate)
    LastMonthYear = Year(LastMonthDate)

    'last six month vars
    LastSixMonthDate = DateAdd(DateInterval.Month, -number_of_months_divide, Now())
    LastSixMonth = Month(LastSixMonthDate)
    LastSixMonthYear = Year(LastSixMonthDate)

    Try
      If amod_IDs <> "" Then

        sql = "select distinct amod_make_name, amod_model_name, amod_airframe_type_code, amod_type_code, amod_id, COUNT(*) as inopcount,  "
        sql += " (select COUNT(*) from aircraft_flat with(NOLOCK) where amod_id=a.amod_id and ac_journ_id = 0 and ac_forsale_flag='Y') as forsalecount,  "
        sql += " (select COUNT(*) from aircraft_flat with(NOLOCK) where amod_id=a.amod_id and ac_journ_id = 0 and ac_forsale_flag='Y' and ac_exclusive_flag='Y' and ac_status LIKE 'For Sale%') as exclusivecount,  "
        sql += " (select top 1 mtrend_total_aircraft_for_sale from aircraft_model_trend where mtrend_amod_id=a.amod_id and mtrend_year=" & LastMonthYear & " and mtrend_month=" & LastMonth & " order by mtrend_product_type) as lastmonth,  "
        sql += " (select top 1 mtrend_total_aircraft_for_sale from aircraft_model_trend where mtrend_amod_id=a.amod_id and mtrend_year=" & LastSixMonthYear & " and mtrend_month=" & LastSixMonth & " order by mtrend_product_type) as lastsix  "

        ' -- GET SALES PER MONTH FOR LAST 6 MONTHS - DIVIDE THIS INTO THE TOTAL FOR SALE TO GET ABSORPTION RATE.
        sql += ", (SELECT COUNT(J1.journ_id)"
        sql += " FROM Journal AS J1 WITH (NOLOCK)"
        sql += " INNER JOIN Aircraft AS A1 WITH (NOLOCK) ON A1.ac_id = J1.journ_ac_id AND A1.ac_journ_id = J1.journ_id"
        sql += "  WHERE A1.ac_amod_id = a.amod_id "
        '-- Whole Sale, Used, Retail Only Last Year
        sql += " AND (J1.journ_subcat_code_part1 IN ('WS'))  "
        sql += " AND (J1.journ_subcat_code_part2 NOT IN ('CC','DS','FY','MF'))  "
        sql += " AND (J1.journ_subcat_code_part3 NOT IN ('CC','DB','DS','FI','FY','IT','LS','MF','RE','RM')) "
        sql += " AND (J1.journ_internal_trans_flag = 'N') "
        sql += " AND (J1.journ_newac_flag = 'N')"
        sql += " AND (J1.journ_subcategory_code NOT LIKE '%CORR%')  "
        sql += " AND (J1.journ_date >= DATEADD(MONTH,-" & number_of_months_divide & ",GETDATE()))"
        '    sql += " )/" & number_of_months_divide & " As SalesPerMonth "

        sql += "  and"
        sql += " ( (J1.journ_date > (select top 1 journ_date from View_Aircraft_History_Flat af2 with (NOLOCK) "
        sql += " Where af2.ac_id = A1.ac_id and (af2.journ_newac_flag = 'Y' or ac_previously_owned_flag = 'Y') "
        sql += " order by af2.journ_date asc))"
        sql += " or "
        sql += " (J1.journ_date = (select top 1 journ_date from View_Aircraft_History_Flat af2 with (NOLOCK) "
        sql += " where af2.ac_id = A1.ac_id And af2.ac_journ_id > A1.ac_journ_id "
        sql += " and (af2.journ_newac_flag = 'Y' or ac_previously_owned_flag = 'Y') "
        sql += " order by af2.journ_date asc))"
        sql += " )"

        sql += " ) As SalesPerTimeframe "


        sql += " from aircraft_flat a  with (NOLOCK) "
        sql += " where amod_id in (" & amod_IDs & ")  "

        '-- SUBSCRIPTION AIRCRAFT CRITERIA
        sql += " " & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(HttpContext.Current.Session.Item("localSubscription"), False, True)

        sql += " and ac_lifecycle_stage=3 and ac_journ_id = 0 "
        sql += " group by amod_make_name, amod_model_name,amod_id, amod_airframe_type_code, amod_type_code "
        sql += " order by amod_make_name, amod_model_name,amod_id, amod_airframe_type_code, amod_type_code "




        clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
        SqlConn.ConnectionString = JETNET_DB
        SqlConn.Open()
        SqlCommand.Connection = SqlConn


        SqlCommand.CommandText = sql
        SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
        SqlCommand.CommandType = CommandType.Text
        SqlCommand.CommandTimeout = 60

        Try
          atemptable.Load(SqlReader)
        Catch constrExc As System.Data.ConstraintException
          Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
        End Try
      End If
      HomePageGetMarketSummaryListing = atemptable
    Catch ex As Exception
      HomePageGetMarketSummaryListing = Nothing
      Me.class_error = "Error in HomePageGetMarketSummaryListing(ByVal amod_IDs As String) As DataTable SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try
  End Function
  ''' <summary>
  ''' This returns a list of Fleet Summary for the Home Page based on subscribers selected models for Aerodex
  ''' </summary>
  ''' <param name="amod_IDs">model IDs</param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function HomePageGetFleetSummaryListing(ByVal amod_IDs As String) As DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable

    Try
      If amod_IDs <> "" Then

        sql = "select distinct amod_make_name, amod_model_name, amod_airframe_type_code, amod_type_code, amod_id, "
        sql += " (select COUNT(*) from aircraft_flat with(NOLOCK) where amod_id=a.amod_id and ac_journ_id = 0 and ac_lifecycle_stage=1) as inprodcount, "
        sql += " (select COUNT(*) from aircraft_flat with(NOLOCK) where amod_id=a.amod_id and ac_journ_id = 0 and ac_lifecycle_stage=2) as mfrcount,"
        sql += " COUNT(*) as inopcount, "
        sql += " (select COUNT(*) from aircraft_flat with(NOLOCK) where amod_id=a.amod_id and ac_lifecycle_stage=4 and ac_status = 'Withdrawn from Use - Stored') as storedcount, "
        sql += " (select COUNT(*) from aircraft_flat with(NOLOCK) where amod_id=a.amod_id and ac_lifecycle_stage=4 and ac_status <> 'Withdrawn from Use - Stored') as retiredcount"
        sql += " from aircraft_flat a with (NOLOCK) "
        sql += " where amod_id in (" & amod_IDs & ") "
        sql += " and ac_lifecycle_stage=3 and ac_journ_id = 0 "
        sql += " group by amod_make_name, amod_model_name,amod_id, amod_airframe_type_code, amod_type_code "
        sql += " order by amod_make_name, amod_model_name,amod_id, "
        sql += " amod_airframe_type_code, amod_type_code"



        clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
        SqlConn.ConnectionString = JETNET_DB
        SqlConn.Open()
        SqlCommand.Connection = SqlConn


        SqlCommand.CommandText = sql
        SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
        SqlCommand.CommandType = CommandType.Text
        SqlCommand.CommandTimeout = 60

        Try
          atemptable.Load(SqlReader)
        Catch constrExc As System.Data.ConstraintException
          Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
        End Try
      End If
      HomePageGetFleetSummaryListing = atemptable
    Catch ex As Exception
      HomePageGetFleetSummaryListing = Nothing
      Me.class_error = "Error in HomePageGetFleetSummaryListing(ByVal amod_IDs As String) As DataTable SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try
  End Function


#End Region
#Region "Contact Queries"
  ''' <summary>
  ''' Get Contacts from the Company Display page. List of Company's Contacts
  ''' </summary>
  ''' <param name="comp_id"></param>
  ''' <param name="source"></param>
  ''' <param name="clicontact_status"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function GetContacts(ByVal comp_id As Long, ByVal source As String, ByVal clicontact_status As String, ByVal journalID As Long, Optional ByVal is_yacht As Boolean = False) As DataTable
    Dim sql As String = ""
    Dim aTempTable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    'mysql
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing



    Try
      Select Case source
        Case "JETNET"


          sql = "SELECT contact_action_date, contact_comp_id, contact_email_address,NULL as ACTIVEUSER, contact_first_name, 'N' as subins_admin_flag, NULL as SALESFORCE,  "
          sql = sql & "contact_id, contact_last_name, contact_middle_initial, contact_sirname, contact_suffix,  NULL as VALUESUSER, contact_hide_flag,"
          sql = sql & "contact_title, 'JETNET' AS contact_type, contact_pictures.*, "

          If (HttpContext.Current.Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CUSTOMER_CENTER) Then
            sql = sql & " (select top 1 subins_last_session_date from [Homebase].jetnet_ra.dbo.[Subscription_Install] WITH(NOLOCK) where (subins_contact_id = contact_id) "
            sql = sql & " and subins_last_session_date >= '" & DateAdd(DateInterval.Minute, -10, Date.Now()) & "' "
            sql = sql & " and (subins_last_session_date <> subins_last_logout_date or subins_last_logout_date is NULL)) as onlinedate"
            sql = sql & " FROM [Homebase].jetnet_ra.dbo.[contact] WITH (NOLOCK) "
            sql = sql & " left outer join [Homebase].jetnet_ra.dbo.[contact_pictures] WITH(NOLOCK) on contact_id = conpic_contact_id and conpic_hide_flag='N'"
          ElseIf (HttpContext.Current.Session.Item("jetnetAppVersion") <> Constants.ApplicationVariable.HOMEBASE) Then
            sql = sql & " (select top 1 subins_last_session_date from Subscription_Install WITH(NOLOCK) where (subins_contact_id = contact_id) "
            sql = sql & " and subins_last_session_date >= '" & DateAdd(DateInterval.Minute, -10, Date.Now()) & "' "
            sql = sql & " and (subins_last_session_date <> subins_last_logout_date or subins_last_logout_date is NULL)) as onlinedate"
            sql = sql & " FROM contact WITH (NOLOCK) "
            sql = sql & " left outer join contact_pictures WITH(NOLOCK) on contact_id = conpic_contact_id and conpic_hide_flag='N'"
          Else
            sql = sql & " (select top 1 subins_last_session_date from Subscription_Install WITH(NOLOCK) where (subins_contact_id = contact_id) "
            sql = sql & " and subins_last_session_date >= '" & DateAdd(DateInterval.Minute, -10, Date.Now()) & "' "
            sql = sql & " and (subins_last_session_date <> subins_last_logout_date or subins_last_logout_date is NULL)) as onlinedate"
            sql = sql & " FROM contact WITH (NOLOCK) "
            sql = sql & " left outer join contact_pictures WITH(NOLOCK) on contact_id = conpic_contact_id and conpic_hide_flag='N'"
          End If


                    ' ADDED MSW - if its customer center or homebase, then include inactive contacts  6/5/20
                    If (HttpContext.Current.Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CUSTOMER_CENTER) Or (HttpContext.Current.Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.HOMEBASE) Then
                        sql = sql & "  WHERE contact_id > 0  "
                    Else
                        sql = sql & "  WHERE contact_hide_flag='N' "
                    End If




                    'If is_yacht Then
                    'Else
                    sql = sql & "  and contact_active_flag='Y' "
          'End If

          sql = sql & " and contact_journ_id = " & journalID & " and contact_comp_id = " & comp_id & " order by contact_acpros_seq_no"

          clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
          SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
          SqlConn.Open()
          SqlCommand.Connection = SqlConn


          SqlCommand.CommandText = sql
          SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
          SqlCommand.CommandType = CommandType.Text
          SqlCommand.CommandTimeout = 60


          Try
            aTempTable.Load(SqlReader)
          Catch constrExc As System.Data.ConstraintException
            Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
          End Try

        Case Else
          sql = "SELECT clicontact_id AS contact_id, NULL as conpic_contact_id, NULL as ACTIVEUSER, 'N' as subins_admin_flag, NULL as SALESFORCE, clicontact_comp_id AS "
          sql = sql & " contact_comp_id, clicontact_sirname AS contact_sirname, clicontact_first_name AS contact_first_name, "
          sql = sql & " clicontact_middle_initial AS contact_middle_initial, NULL as VALUESUSER, NULL as contact_hide_flag, "
          sql = sql & " clicontact_last_name AS contact_last_name, "
          sql = sql & " clicontact_suffix AS contact_suffix, clicontact_title AS contact_title, "
          sql = sql & " clicontact_email_address AS contact_email_address, "
          sql = sql & " clicontact_action_date AS contact_action_date, 'Client' AS contact_type, clicontact_notes, clicontact_email_list, "
          sql = sql & " clicontact_preferred_name, clicontact_status, clicontact_jetnet_contact_id, clicontact_user_id"
          sql = sql & " FROM client_contact WHERE (clicontact_comp_id = " & comp_id & ") AND (clicontact_status = '" & clicontact_status & "')"

          clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
          MySqlConn.ConnectionString = Me.client_DB
          MySqlConn.Open()
          MySqlCommand.Connection = MySqlConn
          MySqlCommand.CommandType = CommandType.Text
          MySqlCommand.CommandTimeout = 60

          MySqlCommand.CommandText = sql
          MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


          Try
            aTempTable.Load(MySqlReader)
          Catch constrExc As System.Data.ConstraintException
            Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
          End Try
      End Select
      Return aTempTable
    Catch ex As Exception
      GetContacts = Nothing
      Me.class_error = "Error in GetContacts(ByVal comp_id As Long, ByVal source As String, ByVal clicontact_status As String, ByVal journalID As Long) As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing

      MySqlReader = Nothing

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  Public Function GetContactsAdmin(ByVal comp_id As Long, ByVal source As String, ByVal journalID As Long) As DataTable
    Dim sql As String = ""
    Dim aTempTable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection

    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim SqlCommand As New SqlClient.SqlCommand

    'mysql
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection

    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing



    Try
      Select Case source
        Case "JETNET"

          SqlConn.ConnectionString = JETNET_DB

          SqlConn.Open()

          sql = "SELECT c.contact_comp_id, c.contact_email_address, c.contact_first_name, c.contact_id, c.contact_last_name,   View_JETNET_Customers.subins_admin_flag, View_JETNET_Customers.sublogin_password, "
          sql += " c.contact_middle_initial, c.contact_sirname, c.contact_suffix, c.contact_title, c.contact_hide_flag, View_JETNET_Customers.subins_last_login_date,  contact_pictures.*, "
          sql += " (case when View_JETNET_Customers.sublogin_password Is NULL then 'NO' else 'YES' end) as ACTIVEUSER,"
          sql += " View_JETNET_Customers.sublogin_password, View_JETNET_Customers.subins_last_login_date , "
          sql += "  vc2.sub_id as SALESFORCE, vc3.sublogin_values_flag as VALUESUSER "

          ' sql += "(select top 1 sub_id from View_JETNET_Customers s with (NOLOCK) where s.comp_id = c.contact_comp_id "
          '        sql += " And s.contact_email_address=c.contact_email_address And s.sub_serv_code Like '%FS') as SALESFORCE, "

          '            sql += " (select distinct top 1 v.sublogin_values_flag from View_JETNET_Customers v with (NOLOCK) where v.subins_contact_id = C.contact_id and v.sub_sale_price_flag='Y' "
          '             sql += " And v.sub_comp_id=c.contact_comp_id) as VALUESUSER "

          If (HttpContext.Current.Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CUSTOMER_CENTER) Then
            sql += " FROM [Homebase].jetnet_ra.dbo.[contact] c WITH (NOLOCK) "
            sql += " left outer join [Homebase].jetnet_ra.dbo.[contact_pictures] WITH(NOLOCK) on c.contact_id = conpic_contact_id and conpic_hide_flag='N' "
            sql += " LEFT OUTER JOIN View_JETNET_Customers with (NOLOCK) on View_JETNET_Customers.contact_email_address=c.contact_email_address"
            sql += " and View_JETNET_Customers.sub_id = (select top 1 sub_id from View_JETNET_Customers t with (NOLOCK) where t.comp_id = c.contact_comp_id"
            sql += " and t.contact_email_address=c.contact_email_address and t.sub_serv_code not like '%FS')"
          ElseIf (HttpContext.Current.Session.Item("jetnetAppVersion") <> Constants.ApplicationVariable.HOMEBASE) Then
            sql += " FROM contact c WITH (NOLOCK) "
            sql += " left outer join contact_pictures WITH(NOLOCK) on c.contact_id = conpic_contact_id and conpic_hide_flag='N' "
            sql += " LEFT OUTER JOIN View_JETNET_Customers with (NOLOCK) on View_JETNET_Customers.contact_email_address=c.contact_email_address"
            sql += " and View_JETNET_Customers.sub_id = (select top 1 sub_id from View_JETNET_Customers t with (NOLOCK) where t.comp_id = c.contact_comp_id"
            sql += " and t.contact_email_address=c.contact_email_address and t.sub_serv_code not like '%FS')"
          Else
            sql += " FROM contact c WITH (NOLOCK) "
            sql += " left outer join contact_pictures WITH(NOLOCK) on c.contact_id = conpic_contact_id and conpic_hide_flag='N' "
            sql += " LEFT OUTER JOIN View_JETNET_Customers with (NOLOCK) on View_JETNET_Customers.contact_email_address=c.contact_email_address"
            sql += " and View_JETNET_Customers.sub_id = (select top 1 sub_id from View_JETNET_Customers t with (NOLOCK) where t.comp_id = c.contact_comp_id"
            sql += " and t.contact_email_address=c.contact_email_address and t.sub_serv_code not like '%FS')"
          End If




          sql += "  Left outer join  View_JETNET_Customers vc2 with (NOLOCK) on vc2.comp_id = c.contact_comp_id And vc2.contact_email_address=c.contact_email_address And vc2.sub_serv_code Like '%FS' "
          sql += " Left outer join  View_JETNET_Customers vc3 with (NOLOCK) on  vc3.subins_contact_id = C.contact_id And vc3.sub_sale_price_flag='Y' And vc3.sub_comp_id=c.contact_comp_id "



          sql += " WHERE c.contact_active_flag='Y' and (c.contact_email_address <> 'demo@jetnet.com'  or c.contact_email_address is null) "
          sql += " and c.contact_journ_id = " & journalID & " and c.contact_comp_id =" & comp_id & " "
          sql += " order by c.contact_acpros_seq_no"


          clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)


          SqlCommand.Connection = SqlConn

          SqlCommand.CommandText = sql.ToString

          '   Dim SqlCommand As New SqlClient.SqlCommand(sql.ToString, SqlConn)


          '   SqlCommand.Parameters.AddWithValue("@compID", comp_id)

          '            SqlCommand.Parameters.AddWithValue("@journalID", journalID)

          SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


          Try
            aTempTable.Load(SqlReader)
          Catch constrExc As System.Data.ConstraintException
            Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
          End Try

          SqlCommand.Dispose()
          SqlCommand = Nothing
        Case Else
          sql = "SELECT clicontact_id AS contact_id, NULL as conpic_contact_id, 'N' as subins_admin_flag, '' as sublogin_password, NULL as SALESFORCE, clicontact_comp_id AS "
          sql = sql & " contact_comp_id, clicontact_sirname AS contact_sirname, clicontact_first_name AS contact_first_name, "
          sql = sql & " clicontact_middle_initial AS contact_middle_initial, NULL as ACTIVEUSER, NULL as VALUESUSER, NULL as contact_hide_flag,  "
          sql = sql & " clicontact_last_name AS contact_last_name, "
          sql = sql & " clicontact_suffix AS contact_suffix, clicontact_title AS contact_title, "
          sql = sql & " clicontact_email_address AS contact_email_address, "
          sql = sql & " clicontact_action_date AS contact_action_date, 'Client' AS contact_type, clicontact_notes, clicontact_email_list, "
          sql = sql & " clicontact_preferred_name, clicontact_status, clicontact_jetnet_contact_id, clicontact_user_id"
          sql = sql & " FROM client_contact WHERE (clicontact_comp_id = @compID)  "

          clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

          MySqlConn.ConnectionString = Me.client_DB
          MySqlConn.Open()

          Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand(sql, MySqlConn)
          MySqlCommand.Parameters.AddWithValue("@compID", comp_id)


          MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

          Try
            aTempTable.Load(MySqlReader)
          Catch constrExc As System.Data.ConstraintException
            Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
          End Try
          MySqlCommand.Dispose()
          MySqlCommand = Nothing
      End Select
      Return aTempTable
    Catch ex As Exception
      GetContactsAdmin = Nothing
      Me.class_error = "Error in GetContacts(ByVal comp_id As Long, ByVal source As String, ByVal clicontact_status As String, ByVal journalID As Long) As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing


      MySqlReader = Nothing

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing


    End Try

  End Function
  ''' <summary>
  ''' This looks up individual contact details. 
  ''' </summary>
  ''' <param name="contact_id"></param>
  ''' <param name="source"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function GetContacts_Details(ByVal contact_id As Long, ByVal source As String, Optional ByVal contactHide As Boolean = False)
    Dim sql As String = ""
    Dim aTempTable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing


    Try
      Select Case source
        Case "JETNET"


          sql = "SELECT contact_action_date, contact_comp_id, contact_email_address, contact_first_name,"
          sql = sql & "contact_id, contact_last_name, contact_middle_initial, contact_sirname,NULL as SALESFORCE, NULL as ACTIVEUSER,   NULL as VALUESUSER, "
          sql = sql & "contact_suffix, contact_title, 'JETNET' AS contact_type"
          sql = sql & " FROM contact WITH (NOLOCK)  "
          sql = sql & " WHERE (contact_id = " & contact_id & ") and contact_journ_id = 0 "

          If contactHide = False Then
            sql = sql & " and contact_hide_flag='N' "
          End If

          sql = sql & " and contact_active_flag='Y' "


          clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

          SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
          SqlConn.Open()
          SqlCommand.Connection = SqlConn


          SqlCommand.CommandText = sql
          SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
          SqlCommand.CommandType = CommandType.Text
          SqlCommand.CommandTimeout = 60


          Try
            aTempTable.Load(SqlReader)
          Catch constrExc As System.Data.ConstraintException
            Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
          End Try

        Case Else

          sql = "SELECT clicontact_action_date AS contact_action_date,NULL as conpic_contact_id, clicontact_comp_id AS contact_comp_id,NULL as SALESFORCE, NULL as ACTIVEUSER,  NULL as VALUESUSER, "
          sql = sql & " clicontact_email_address AS contact_email_address, clicontact_email_list AS contact_email_list, clicontact_first_name AS contact_first_name, "
          sql = sql & "clicontact_id AS contact_id, clicontact_jetnet_contact_id AS contact_jetnet_contact_id, clicontact_last_name AS "
          sql = sql & " contact_last_name, clicontact_middle_initial AS contact_middle_initial, clicontact_notes AS "
          sql = sql & " contact_notes, clicontact_preferred_name AS contact_preferred_name, clicontact_sirname AS contact_sirname, "
          sql = sql & " clicontact_status, clicontact_suffix AS contact_suffix, clicontact_title AS contact_title, "
          sql = sql & " clicontact_user_id FROM client_contact WHERE (clicontact_id = " & contact_id & ")"


          clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

          MySqlConn.ConnectionString = Me.client_DB
          MySqlConn.Open()
          MySqlCommand.Connection = MySqlConn
          MySqlCommand.CommandType = CommandType.Text
          MySqlCommand.CommandTimeout = 60

          MySqlCommand.CommandText = sql
          MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


          Try
            aTempTable.Load(MySqlReader)
          Catch constrExc As System.Data.ConstraintException
            Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
          End Try


      End Select

      Return aTempTable

    Catch ex As Exception
      GetContacts_Details = Nothing
      Me.class_error = "Error in GetContacts_Details(ByVal contact_id, ByVal source): SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try


  End Function
  ''' <summary>
  ''' This looks up individual contact details by using an in clause. 
  ''' </summary>
  ''' <param name="contactIDs"></param>
  ''' <param name="source"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function GetContacts_Details_InClause(ByVal contactIDs As String, ByVal source As String, Optional ByVal contactHide As Boolean = False)
    Dim sql As String = ""
    Dim aTempTable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing


    Try
      Select Case source
        Case "JETNET"


          sql = "SELECT contact_action_date, contact_comp_id, contact_email_address, contact_first_name,"
          sql += "contact_id, contact_last_name, contact_middle_initial, contact_sirname, comp_name, "
          sql += "contact_suffix, contact_title, 'JETNET' AS contact_type"
          sql += " FROM contact WITH (NOLOCK)  "
          sql += " inner join company on contact_comp_id = comp_id and contact_journ_id = comp_journ_id"
          sql += " WHERE contact_id in (" & contactIDs & ") and contact_journ_id = 0 "
          sql += " and contact_hide_flag='N' "
          sql += " and contact_active_flag='Y' "


          clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

          SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
          SqlConn.Open()
          SqlCommand.Connection = SqlConn


          SqlCommand.CommandText = sql
          SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
          SqlCommand.CommandType = CommandType.Text
          SqlCommand.CommandTimeout = 60


          Try
            aTempTable.Load(SqlReader)
          Catch constrExc As System.Data.ConstraintException
            Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
          End Try

        Case Else

          sql = "SELECT clicontact_action_date AS contact_action_date, clicontact_comp_id AS contact_comp_id, clicomp_name as comp_name, "
          sql += " clicontact_email_address AS contact_email_address, clicontact_email_list AS contact_email_list, clicontact_first_name AS contact_first_name, "
          sql += " clicontact_id AS contact_id, clicontact_jetnet_contact_id AS contact_jetnet_contact_id, clicontact_last_name AS "
          sql += " contact_last_name, clicontact_middle_initial AS contact_middle_initial, clicontact_notes AS "
          sql += " contact_notes, clicontact_preferred_name AS contact_preferred_name, clicontact_sirname AS contact_sirname, "
          sql += " clicontact_status, clicontact_suffix AS contact_suffix, clicontact_title AS contact_title, "
          sql += " clicontact_user_id FROM client_contact "
          sql += " inner join client_company on clicontact_comp_id = clicomp_id "
          sql += " WHERE clicontact_id in (" & contactIDs & ")"


          clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

          MySqlConn.ConnectionString = Me.client_DB
          MySqlConn.Open()
          MySqlCommand.Connection = MySqlConn
          MySqlCommand.CommandType = CommandType.Text
          MySqlCommand.CommandTimeout = 60

          MySqlCommand.CommandText = sql
          MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


          Try
            aTempTable.Load(MySqlReader)
          Catch constrExc As System.Data.ConstraintException
            Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
          End Try


      End Select

      Return aTempTable

    Catch ex As Exception
      GetContacts_Details_InClause = Nothing
      Me.class_error = "Error in GetContacts_Details_InClause(ByVal contactIDs As String, ByVal source As String, Optional ByVal contactHide As Boolean = False): SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try


  End Function
  ''' <summary>
  ''' This returns the contact information on the ac details page.
  ''' </summary>
  ''' <param name="journalID"></param>
  ''' <param name="contactID"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function ReturnContactInformationACDetails(ByVal journalID As Long, ByVal contactID As Long, Optional contactHideFlag As Boolean = True) As DataTable
    Dim sQuery As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable
    Try


      If (HttpContext.Current.Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CUSTOMER_CENTER) Then
        sQuery = "SELECT Contact.*, contact_pictures.*, NULL as SALESFORCE, NULL as ACTIVEUSER,  NULL as VALUESUSER, "
        sQuery &= " (select top 1 subins_last_session_date from [Homebase].jetnet_ra.dbo.[Subscription_Install] WITH(NOLOCK) where (subins_contact_id = contact_id) "
        sQuery &= " and subins_last_session_date >= '" & DateAdd(DateInterval.Minute, -10, Date.Now()) & "' "
        sQuery &= " and (subins_last_session_date <> subins_last_logout_date or subins_last_logout_date is NULL)) as onlinedate"
        sQuery &= "  FROM [Homebase].jetnet_ra.dbo.[Contact] WITH(NOLOCK) "
        sQuery &= " left outer join [Homebase].jetnet_ra.dbo.[contact_pictures] WITH(NOLOCK) on contact_id = conpic_contact_id and conpic_hide_flag='N'"
        sQuery &= " WHERE contact_id = " & contactID & " AND contact_journ_id = " & journalID
      ElseIf (HttpContext.Current.Session.Item("jetnetAppVersion") <> Constants.ApplicationVariable.HOMEBASE) Then
        sQuery = "SELECT Contact.*, contact_pictures.*, NULL as SALESFORCE, NULL as ACTIVEUSER,  NULL as VALUESUSER, "
        sQuery &= " (select top 1 subins_last_session_date from Subscription_Install WITH(NOLOCK) where (subins_contact_id = contact_id) "
        sQuery &= " and subins_last_session_date >= '" & DateAdd(DateInterval.Minute, -10, Date.Now()) & "' "
        sQuery &= " and (subins_last_session_date <> subins_last_logout_date or subins_last_logout_date is NULL)) as onlinedate"
        sQuery &= "  FROM Contact WITH(NOLOCK) "
        sQuery &= " left outer join contact_pictures WITH(NOLOCK) on contact_id = conpic_contact_id and conpic_hide_flag='N'"
        sQuery &= " WHERE contact_id = " & contactID & " AND contact_journ_id = " & journalID
      Else
        sQuery = "SELECT Contact.*, contact_pictures.*, NULL as SALESFORCE, NULL as ACTIVEUSER,  NULL as VALUESUSER, "
        sQuery &= " (select top 1 subins_last_session_date from Subscription_Install WITH(NOLOCK) where (subins_contact_id = contact_id) "
        sQuery &= " and subins_last_session_date >= '" & DateAdd(DateInterval.Minute, -10, Date.Now()) & "' "
        sQuery &= " and (subins_last_session_date <> subins_last_logout_date or subins_last_logout_date is NULL)) as onlinedate"
        sQuery &= "  FROM Contact WITH(NOLOCK) "
        sQuery &= " left outer join contact_pictures WITH(NOLOCK) on contact_id = conpic_contact_id and conpic_hide_flag='N'"
        sQuery &= " WHERE contact_id = " & contactID & " AND contact_journ_id = " & journalID
      End If


      If contactHideFlag Then
        sQuery &= " AND contact_hide_flag = 'N'"
      End If

      If journalID = 0 Then
        sQuery &= " AND contact_active_flag = 'Y'"
      End If

      sQuery &= " ORDER BY contact_acpros_seq_no, contact_last_name, contact_first_name"


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sQuery.ToString)

      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sQuery
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      Return atemptable
    Catch ex As Exception
      Return Nothing
      Me.class_error = "Error in ReturnContactInformationACDetails(ByVal aircraftID As Long, ByVal journalID As Long, ByVal contactID As Long) As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: GetCompanyInfo_JETNET_ID
  ' Purpose: to get a specific company based on the ID and source
  ' Parameters: comp_id, source
  ' Return: 
  '       DataTable
  ' Change Log
  '           1/19/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function GetContactInfo_JETNET_ID(ByVal contact_id As Integer, ByVal clicontact_staus As String) As DataTable
    Dim sql As String = ""
    Dim aTempTable As New DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing


    Try
      sql = "SELECT clicontact_id AS contact_id, clicontact_comp_id AS contact_comp_id, clicontact_sirname AS contact_sirname, clicontact_first_name AS contact_first_name, "
      sql = sql & " clicontact_middle_initial AS contact_middle_initial, clicontact_last_name AS contact_last_name, clicontact_suffix AS contact_suffix, clicontact_title AS contact_title, "
      sql = sql & " clicontact_email_address AS contact_email_address, clicontact_action_date AS contact_action_date, 'Client' AS contact_type, clicontact_notes, clicontact_email_list, "
      sql = sql & " clicontact_preferred_name, clicontact_status, clicontact_jetnet_contact_id, clicontact_user_id"
      sql = sql & " FROM  client_contact WHERE (clicontact_jetnet_contact_id = " & contact_id & ") AND (clicontact_status = '" & clicontact_staus & "')"



      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable
    Catch ex As Exception
      GetContactInfo_JETNET_ID = Nothing
      Me.class_error = "Error in GetContacts_Details(ByVal contact_id, ByVal source): SQL VERSION " & ex.Message
    Finally
      MySqlReader = Nothing

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try



  End Function

  ''' <summary>
  ''' Contact Search SQL side
  ''' </summary>
  ''' <param name="f_name"></param>
  ''' <param name="l_name"></param>
  ''' <param name="comp_name"></param>
  ''' <param name="status"></param>
  ''' <param name="search_where"></param>
  ''' <param name="sort_by"></param>
  ''' <param name="search_type"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Search_Contacts(ByVal f_name As String, ByVal l_name As String, ByVal comp_name As String, ByVal status As String, ByVal search_where As String, ByVal sort_by As String, ByVal search_type As String, ByVal JETNET_IDS As String, ByVal CLIENT_IDS As String, ByVal email_address As String) As DataTable

    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim aDataTable As New DataTable
    Dim returnTable As New DataTable

    Try
      ' create a string to hold the % symbol for searching
      Dim percent_wild_card As String = "%"
      ' create an AND variable to append to the Where clause
      Dim a_AND As String = ""
      ' setup the string for the SQL
      Dim aSQL_Client_Select As String = ""
      Dim aSQL_JETNET_Select As String = ""
      Dim aSQL_Client_Where As String = ""
      Dim aSQL_JETNET_Where As String = ""

      'If HttpContext.Current.Session.Item("localUser").crmEvo = True Then
      '    search_type = "J"
      'End If

      'contact fields that we need!
      aDataTable.Columns.Add("contact_id")
      aDataTable.Columns.Add("contact_comp_id")
      aDataTable.Columns.Add("contact_sirname")
      aDataTable.Columns.Add("contact_first_name")
      aDataTable.Columns.Add("contact_middle_initial")
      aDataTable.Columns.Add("contact_last_name")
      aDataTable.Columns.Add("contact_suffix")
      aDataTable.Columns.Add("contact_title")
      aDataTable.Columns.Add("contact_email_address")
      aDataTable.Columns.Add("comp_name")
      aDataTable.Columns.Add("comp_address1")
      aDataTable.Columns.Add("comp_address2")
      aDataTable.Columns.Add("comp_city")
      aDataTable.Columns.Add("comp_state")
      aDataTable.Columns.Add("comp_zip_code")
      aDataTable.Columns.Add("comp_country")
      aDataTable.Columns.Add("contact_type")

      If HttpContext.Current.Session.Item("localUser").crmEvo = True Then
        search_type = "J"
      End If


      If search_type = "J" Or search_type = "B" Then
        ' setup the SQL for JETNET
        aSQL_JETNET_Select = "SELECT Contact.contact_id, Contact.contact_comp_id, Contact.contact_sirname, Contact.contact_first_name, Contact.contact_middle_initial, Contact.contact_last_name, "
        aSQL_JETNET_Select = aSQL_JETNET_Select & "Contact.contact_suffix, Contact.contact_title, Contact.contact_email_address,  comp_name, Company.comp_address1, "
        aSQL_JETNET_Select = aSQL_JETNET_Select & "Company.comp_address2, Company.comp_city, Company.comp_state, Company.comp_zip_code, Company.comp_country, 'JETNET' as contact_type "
        aSQL_JETNET_Select = aSQL_JETNET_Select & "FROM (Company WITH(NOLOCK)  INNER JOIN Contact  WITH(NOLOCK) ON Company.comp_id = Contact.contact_comp_id) "

        aSQL_JETNET_Where = " contact_journ_id = 0 and comp_journ_id = 0  and contact_active_flag = 'Y' and contact_hide_flag='N'  "

        ' build the Where statement based on what is not "%%"
        If f_name <> "%%" And f_name <> "%" Then
          a_AND = " AND "
          aSQL_JETNET_Where = aSQL_JETNET_Where & a_AND & " contact_first_name LIKE '" & f_name & "'"
        End If


        If JETNET_IDS <> "" Then
          a_AND = " AND "
          If aSQL_JETNET_Where <> "" Then
            aSQL_JETNET_Where = aSQL_JETNET_Where & a_AND & " contact_id in (" & JETNET_IDS & ")"
          Else
            aSQL_JETNET_Where = aSQL_JETNET_Where & " contact_id in (" & JETNET_IDS & ")"
          End If
        End If

        If l_name <> "%%" And l_name <> "%" Then
          a_AND = " AND "
          If aSQL_JETNET_Where <> "" Then
            aSQL_JETNET_Where = aSQL_JETNET_Where & a_AND & " contact_last_name LIKE '" & l_name & "'"
          Else
            aSQL_JETNET_Where = aSQL_JETNET_Where & " contact_last_name LIKE '" & l_name & "'"
          End If
        End If
        If comp_name <> "%%" And comp_name <> "%" Then
          a_AND = " AND "
          If aSQL_JETNET_Where <> "" Then
            aSQL_JETNET_Where = aSQL_JETNET_Where & a_AND & " comp_name LIKE '" & comp_name & "'"
          Else
            aSQL_JETNET_Where = aSQL_JETNET_Where & " comp_name LIKE '" & comp_name & "'"
          End If
        End If

        If email_address <> "%%" And email_address <> "%" And email_address <> "" Then
          a_AND = " AND "
          If aSQL_JETNET_Where <> "" Then
            aSQL_JETNET_Where = aSQL_JETNET_Where & a_AND & " (contact_email_address like '" & email_address & "' or comp_email_address LIKE '" & email_address & "')"
          Else
            aSQL_JETNET_Where = aSQL_JETNET_Where & " (contact_email_address like '" & email_address & "' or comp_email_address LIKE '" & email_address & "')"
          End If
        End If


        aSQL_JETNET_Where = aSQL_JETNET_Where & " " & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(HttpContext.Current.Session.Item("localSubscription"), True, False)


        SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
        SqlConn.Open()
        SqlCommand.Connection = SqlConn

        SqlCommand.CommandText = aSQL_JETNET_Select & " where " & aSQL_JETNET_Where
        SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
        SqlCommand.CommandType = CommandType.Text
        SqlCommand.CommandTimeout = 60

        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><b>Search_Contacts(ByVal f_name As String, ByVal l_name As String, ByVal comp_name As String, ByVal status As String, ByVal search_where As String, ByVal sort_by As String, ByVal search_type As String, ByVal JETNET_IDS As String, ByVal CLIENT_IDS As String) As DataTable <em>Jetnet side</em></b><br />" & aSQL_JETNET_Select & " where " & aSQL_JETNET_Where


        While SqlReader.Read()

          Dim newCustomersRow As DataRow = aDataTable.NewRow()
          newCustomersRow("contact_id") = SqlReader.Item("contact_id")
          newCustomersRow("contact_comp_id") = SqlReader.Item("contact_comp_id")
          newCustomersRow("comp_name") = SqlReader.Item("comp_name")
          newCustomersRow("contact_sirname") = SqlReader.Item("contact_sirname")
          newCustomersRow("contact_first_name") = SqlReader.Item("contact_first_name")
          newCustomersRow("contact_middle_initial") = SqlReader.Item("contact_middle_initial")

          newCustomersRow("contact_last_name") = SqlReader.Item("contact_last_name")
          newCustomersRow("contact_suffix") = SqlReader.Item("contact_suffix")
          newCustomersRow("contact_title") = SqlReader.Item("contact_title")
          newCustomersRow("contact_email_address") = SqlReader.Item("contact_email_address")

          newCustomersRow("comp_address1") = SqlReader.Item("comp_address1")
          newCustomersRow("comp_address2") = SqlReader.Item("comp_address2")

          newCustomersRow("comp_city") = SqlReader.Item("comp_city")
          newCustomersRow("comp_state") = SqlReader.Item("comp_state")

          newCustomersRow("comp_zip_code") = SqlReader.Item("comp_zip_code")

          newCustomersRow("comp_country") = SqlReader.Item("comp_country")
          newCustomersRow("contact_type") = SqlReader.Item("contact_type")
          aDataTable.Rows.Add(newCustomersRow)
          aDataTable.AcceptChanges()
        End While

      End If

      If search_type = "C" Or search_type = "B" Then
        a_AND = " AND " 'and seperator for where clause
        ' setup the SQL for the Client
        aSQL_Client_Select = "SELECT client_contact.clicontact_id AS contact_id, client_contact.clicontact_comp_id AS contact_comp_id, client_contact.clicontact_sirname AS contact_sirname, "
        aSQL_Client_Select = aSQL_Client_Select & "client_contact.clicontact_first_name AS contact_first_name, client_contact.clicontact_middle_initial AS contact_middle_initial, "
        aSQL_Client_Select = aSQL_Client_Select & "client_contact.clicontact_last_name AS contact_last_name, client_contact.clicontact_suffix AS contact_suffix, client_contact.clicontact_title AS contact_title, "
        aSQL_Client_Select = aSQL_Client_Select & "client_contact.clicontact_email_address AS contact_email_address, left(client_company.clicomp_name,40) as comp_name, "
        aSQL_Client_Select = aSQL_Client_Select & "client_company.clicomp_address1 AS comp_address, client_company.clicomp_address2 AS comp_address2, client_company.clicomp_city AS comp_city, "
        aSQL_Client_Select = aSQL_Client_Select & "client_company.clicomp_state AS comp_state, client_company.clicomp_zip_code AS comp_zip_code, client_company.clicomp_country AS comp_country, "
        aSQL_Client_Select = aSQL_Client_Select & "'CLIENT' AS contact_type, client_company.clicomp_status, client_contact.clicontact_status "
        aSQL_Client_Select = aSQL_Client_Select & "FROM client_company INNER JOIN client_contact ON client_company.clicomp_id = client_contact.clicontact_comp_id "
        ' build the Where statement based on what is not "%%"
        If f_name <> "%%" And f_name <> "%" Then
          aSQL_Client_Where = " clicontact_first_name LIKE '" & f_name & "'"
        End If
        If l_name <> "%%" And l_name <> "%" Then
          If aSQL_Client_Where <> "" Then
            aSQL_Client_Where = aSQL_Client_Where & a_AND & " clicontact_last_name LIKE '" & l_name & "'"
          Else
            aSQL_Client_Where = aSQL_Client_Where & " clicontact_last_name LIKE '" & l_name & "'"
          End If
        End If


        If CLIENT_IDS <> "" Then
          If aSQL_Client_Where <> "" Then
            aSQL_Client_Where = aSQL_Client_Where & a_AND & " clicontact_id in (" & CLIENT_IDS & ")"
          Else
            aSQL_Client_Where = aSQL_Client_Where & " clicontact_id in (" & CLIENT_IDS & ")"
          End If
        End If



        If comp_name <> "%%" And comp_name <> "%" Then
          If aSQL_Client_Where <> "" Then
            aSQL_Client_Where = aSQL_Client_Where & a_AND & " clicomp_name LIKE '" & comp_name & "'"
          Else
            aSQL_Client_Where = aSQL_Client_Where & " clicomp_name LIKE '" & comp_name & "'"
          End If
        End If
        If status <> "B" Then
          If aSQL_Client_Where <> "" Then
            aSQL_Client_Where = aSQL_Client_Where & a_AND & " clicontact_status = '" & status & "'"
          Else
            aSQL_Client_Where = aSQL_Client_Where & " clicontact_status = '" & status & "'"
          End If
        End If

        If email_address <> "%%" And email_address <> "%" Then
          If aSQL_Client_Where <> "" Then
            aSQL_Client_Where = aSQL_Client_Where & a_AND & " (clicontact_email_address LIKE '" & email_address & "' or clicomp_email_address like '" & email_address & "')"
          Else
            aSQL_Client_Where = aSQL_Client_Where & " (clicontact_email_address LIKE '" & email_address & "' or clicomp_email_address like '" & email_address & "')"
          End If
        End If


        Dim sql As String = aSQL_Client_Select & " where " & aSQL_Client_Where




        MySqlConn.ConnectionString = Me.client_DB
        MySqlConn.Open()
        MySqlCommand.Connection = MySqlConn
        MySqlCommand.CommandType = CommandType.Text
        MySqlCommand.CommandTimeout = 60

        MySqlCommand.CommandText = aSQL_Client_Select & " WHERE " & aSQL_Client_Where
        MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><b>Search_Contacts(ByVal f_name As String, ByVal l_name As String, ByVal comp_name As String, ByVal status As String, ByVal search_where As String, ByVal sort_by As String, ByVal search_type As String, ByVal JETNET_IDS As String, ByVal CLIENT_IDS As String) As DataTable <em>Client side</em></b><br />" & aSQL_Client_Select & " WHERE " & aSQL_Client_Where


        While MySqlReader.Read()

          Dim newCustomersRow As DataRow = aDataTable.NewRow()
          newCustomersRow("contact_id") = MySqlReader.Item("contact_id")
          newCustomersRow("contact_comp_id") = MySqlReader.Item("contact_comp_id")
          newCustomersRow("comp_name") = MySqlReader.Item("comp_name")
          newCustomersRow("contact_sirname") = MySqlReader.Item("contact_sirname")
          newCustomersRow("contact_first_name") = MySqlReader.Item("contact_first_name")
          newCustomersRow("contact_middle_initial") = MySqlReader.Item("contact_middle_initial")

          newCustomersRow("contact_last_name") = MySqlReader.Item("contact_last_name")
          newCustomersRow("contact_suffix") = MySqlReader.Item("contact_suffix")
          newCustomersRow("contact_title") = MySqlReader.Item("contact_title")
          newCustomersRow("contact_email_address") = MySqlReader.Item("contact_email_address")

          newCustomersRow("comp_address1") = MySqlReader.Item("comp_address")
          newCustomersRow("comp_address2") = MySqlReader.Item("comp_address2")

          newCustomersRow("comp_city") = MySqlReader.Item("comp_city")
          newCustomersRow("comp_state") = MySqlReader.Item("comp_state")

          newCustomersRow("comp_zip_code") = MySqlReader.Item("comp_zip_code")

          newCustomersRow("comp_country") = MySqlReader.Item("comp_country")
          newCustomersRow("contact_type") = MySqlReader.Item("contact_type")
          aDataTable.Rows.Add(newCustomersRow)
          aDataTable.AcceptChanges()
        End While
      End If


      returnTable = aDataTable.Clone
      Dim afiltered_Client As DataRow() = aDataTable.Select("", sort_by)
      ' extract and import
      For Each atmpDataRow_Client In afiltered_Client
        returnTable.ImportRow(atmpDataRow_Client)
      Next

      Search_Contacts = returnTable
    Catch ex As Exception
      Search_Contacts = Nothing
      Me.class_error = "Error in Search_Contacts(ByVal f_name As String, ByVal l_name As String, ByVal comp_name As String, ByVal status As String, ByVal and_or As String, Byval sort_by as string, ByVal search_type As String): " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing

      MySqlReader = Nothing

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
  ''' <summary>
  ''' MOVE TO DATA LAYER
  ''' </summary>
  ''' <param name="aircraftID"></param>
  ''' <param name="journalID"></param>
  ''' <param name="companyID"></param>
  ''' <param name="CompanyTypeNbr"></param>
  ''' <param name="aerodex"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Get_ContactReferences_Evo_AC_Details(ByVal aircraftID As Long, ByVal journalID As Long, ByVal companyID As Long, ByVal CompanyTypeNbr As String, ByVal aerodex As Boolean) As DataTable
    Dim sQuery As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable
    Try
      sQuery = "SELECT DISTINCT cref_contact_id, cref_transmit_seq_no FROM Aircraft_Reference WITH(NOLOCK)"
      sQuery &= " WHERE cref_ac_id = " & aircraftID
      sQuery &= " AND cref_journ_id = " & journalID
      sQuery &= " AND cref_comp_id = " & companyID
      sQuery &= " AND cref_contact_type IN (" & CompanyTypeNbr & ")"

      ' Hide Exclusive Brokers and Representatives and Dealers from Aerodex users
      If aerodex Then
        sQuery &= " AND cref_contact_type NOT IN ('93','98','99','71')"
      Else
        sQuery &= " AND cref_contact_type NOT IN ('71')"
      End If

      sQuery &= " ORDER BY cref_transmit_seq_no"



      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sQuery.ToString)

      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sQuery
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      Return atemptable
    Catch ex As Exception
      Get_ContactReferences_Evo_AC_Details = Nothing
      Me.class_error = "Error in Get_ContactReferences_Evo_AC_Details(ByVal aircraftID As Long, ByVal journalID As Long, ByVal companyID As Long, ByVal CompanyTypeNbr As String, ByVal aerodex As Boolean) As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function
  ''' <summary>
  ''' This takes the contact ID, and grabs the related companies so we can get the Contact Title(s) from the related company.
  ''' So we know what they're also known as at the other company.
  ''' </summary>
  ''' <param name="contactID"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Get_Related_Aircraft_Info(ByVal contactID As String) As DataTable
    Dim sQuery As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable
    Try
      sQuery = "	select amod_make_name, ac_id, amod_model_name, ac_ser_no_full, ac_reg_no,actype_name, "
      sQuery += " ac_asking_price,ac_forsale_flag, ac_asking as ac_asking_wordage, ac_status, ac_list_date as ac_date_listed, ac_delivery, "
      sQuery += "	comp_id, comp_name, comp_city, comp_state "
      sQuery += "	from view_aircraft_company_flat"
      sQuery += "	where contact_id in (" & contactID & ")"

      sQuery += " " & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(HttpContext.Current.Session.Item("localSubscription"), False, True)

      sQuery += "	and ac_journ_id = 0"
      sQuery += "	order by amod_make_name, amod_model_name, ac_ser_no_full"



      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sQuery.ToString)

      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sQuery
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      Return atemptable
    Catch ex As Exception
      Get_Related_Aircraft_Info = Nothing
      Me.class_error = "Error in Get_ContactReferenceRelatedCompanyTitle(ByVal contactID As Long) As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function
  Public Function GET_CONTACT_IDS_RELATED(ByVal contactID As Long) As String
    Dim sQuery As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable
    Dim add_in_where As String = ""
    Dim contact_id_list As String = ""

    Try

      add_in_where += " " & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(HttpContext.Current.Session.Item("localSubscription"), True, False)


      sQuery = " SELECT distinct ContactId FROM ReturnContactIdRelationshipsByContactId(" & contactID & ") "

      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sQuery.ToString)

      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sQuery
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      For Each q As DataRow In atemptable.Rows
        contact_id_list &= q("ContactId") & ","
      Next


      Return contact_id_list

    Catch ex As Exception
      GET_CONTACT_IDS_RELATED = Nothing
      Me.class_error = "Error in GET_CONTACT_IDS_RELATED(ByVal contactID As Long) As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function
  ''' <summary>
  ''' This takes the contact ID, and grabs the related companies so we can get the Contact Title(s) from the related company.
  ''' So we know what they're also known as at the other company.
  ''' </summary>
  ''' <param name="contactID"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Get_ContactReferenceRelatedCompanyTitle(ByVal contactID As Long, ByVal application_string As String) As DataTable
    Dim sQuery As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable
    Dim add_in_where As String = ""

    Try
      '      sQuery = "select cr_comp_id, cr_contact_id,  cr_comp_rel_id, cr_contact_rel_id "
      '      sQuery += " from contact_reference with (NOLOCK) "
      '      sQuery += "  inner join Contact  with (NOLOCK) on contact_id = cr_contact_id and contact_journ_id = cr_journ_id  "
      '      sQuery += "  inner join Company with (NOLOCK) on  comp_id = cr_comp_rel_id   and comp_journ_id = cr_journ_id  "
      '      '  sQuery += " where (cr_contact_id = " &  & " Or cr_contact_rel_id = " & contactID & ") "
      '      sQuery += "where (cr_contact_id in (select distinct cr_contact_id from contact_reference where cr_contact_rel_id= " & contactID & ")"
      '      sQuery += "or cr_contact_rel_id in (select distinct cr_contact_rel_id from contact_reference where cr_contact_id=  " & contactID & "))"
      '      sQuery += " and cr_journ_id = 0 "
      '      sQuery += " and contact_active_flag = 'Y' "
      'sQuery += " and comp_active_flag = 'Y' "

      add_in_where += " " & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(HttpContext.Current.Session.Item("localSubscription"), True, False)

      If Trim(application_string) = Constants.ApplicationVariable.YACHT Then
        add_in_where = Replace(add_in_where, "AND comp_active_flag = 'Y'", "")
      End If
      ' add_in_where = Replace(add_in_where, "comp_", "a.comp_")

      sQuery = " select distinct comp_name, contact_first_name, contact_last_name, comp_id, contact_id "
      sQuery += " from Company with (NOLOCK) "
      sQuery += " inner join Contact with (NOLOCK) on contact_comp_id = comp_id and contact_journ_id = 0"
      sQuery += " where contact_id in (SELECT ContactId FROM ReturnContactIdRelationshipsByContactId(" & contactID & "))"
      sQuery += " and comp_journ_id = 0"
      sQuery += add_in_where
      sQuery += " order by comp_name asc "


      'sQuery = " select distinct cr_comp_id, cr_contact_id, cr_comp_rel_id, cr_contact_rel_id, a.comp_id, b.comp_id"
      'sQuery += " from contact_reference with (NOLOCK)  "
      'sQuery += " inner join Contact ac on ac.contact_journ_id = 0 and ac.contact_id = cr_contact_id and ac.contact_hide_flag = 'N' "
      'sQuery += " inner join Contact ac2 on ac2.contact_journ_id = 0 and ac2.contact_id = cr_contact_rel_id and ac2.contact_hide_flag = 'N' "
      'sQuery += " LEFT outer join Company a with (NOLOCK) on "
      'sQuery += " ("
      'sQuery += "  a.comp_id = cr_comp_rel_id And a.comp_journ_id = cr_journ_id"

      'sQuery += add_in_where

      'sQuery += " ) "
      'sQuery += " LEFT outer join Company b with (NOLOCK) on (b.comp_id = cr_comp_rel_id and b.comp_journ_id = cr_journ_id "

      'add_in_where = Replace(add_in_where, "a.comp_", "b.comp_")

      'sQuery += add_in_where
      'sQuery += " )"
      'sQuery += " where "
      'sQuery += " ("
      'sQuery += " cr_contact_id in "
      'sQuery += " (select distinct cr_contact_id from contact_reference  "
      'sQuery += "  where (cr_contact_rel_id = " & contactID & " And cr_journ_id = 0)"
      'sQuery += "  )"
      'sQuery += " or cr_contact_rel_id in "
      'sQuery += " 	(select distinct cr_contact_rel_id from contact_reference  where cr_contact_id= " & contactID & " and cr_journ_id = 0  )"
      'sQuery += " or cr_contact_rel_id in "
      'sQuery += " (select distinct cr_contact_id from contact_reference  "
      'sQuery += "  where (cr_contact_rel_id = " & contactID & " And cr_journ_id = 0)"
      'sQuery += "  )"
      'sQuery += " or cr_contact_id in "
      'sQuery += " 	(select distinct cr_contact_rel_id from contact_reference  where cr_contact_id= " & contactID & " and cr_journ_id = 0  )"
      'sQuery += " ) "


      'sQuery += " and  a.comp_id is not null  "
      'sQuery += " and  b.comp_id is not null  "
      'sQuery += " order by cr_comp_id asc"



      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sQuery.ToString)

      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sQuery
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      Return atemptable
    Catch ex As Exception
      Get_ContactReferenceRelatedCompanyTitle = Nothing
      Me.class_error = "Error in Get_ContactReferenceRelatedCompanyTitle(ByVal contactID As Long) As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function
  ''' <summary>
  ''' Returns Basic Company Information and the ContactTitle for Related Contact Title on the Contact Details Page
  ''' </summary>
  ''' <param name="contactID"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function GetContactTitleAndCompanyInformation(ByVal contactID As Long, ByVal journalID As Long) As DataTable
    Dim sQuery As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable
    Try
      sQuery = "select contact_title, contact_id, comp_id, comp_name, comp_city, comp_state, comp_country"
      sQuery += " from contact with (NOLOCK)"
      sQuery += " inner join company on contact_comp_id = comp_id and contact_journ_id = comp_journ_id"
      sQuery += " where(comp_journ_id = " & journalID & ")"
      sQuery += " and contact_id = " & contactID



      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sQuery.ToString)

      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sQuery
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      Return atemptable
    Catch ex As Exception
      GetContactTitleAndCompanyInformation = Nothing
      Me.class_error = "Error in GetContactTitleAndCompanyInformation(ByVal contactID As Long, ByVal journalID As Long) As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function


  ''' <summary>
  ''' Returns whether or not chief pilot. Needs to be moved to DLayer 
  ''' </summary>
  ''' <param name="aircraftID"></param>
  ''' <param name="journalID"></param>
  ''' <param name="contactID"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function IsChiefPilot(ByVal aircraftID As Long, ByVal journalID As Long, ByVal contactID As Long) As Boolean
    Dim sQuery As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable
    Try
      sQuery = "SELECT cref_contact_type FROM Aircraft_Reference WITH(NOLOCK)"
      sQuery &= " WHERE cref_contact_id = " & contactID
      sQuery &= " AND cref_ac_id = " & aircraftID
      sQuery &= " AND cref_journ_id = " & journalID
      sQuery &= " AND cref_contact_type = '44'"




      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sQuery.ToString)

      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sQuery
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      If atemptable.Rows.Count > 0 Then
        IsChiefPilot = True
      Else
        IsChiefPilot = False
      End If
    Catch ex As Exception
      IsChiefPilot = False
      Me.class_error = "Error in IsChiefPilot(ByVal aircraftID As Long, ByVal journalID As Long, ByVal contactID As Long) As Boolean: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function

#End Region
#Region "Lookup Tables"
  ''' <summary>
  ''' Get Lifecycle stage
  ''' </summary>
  ''' <param name="Stage"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function GetLifeCycleStage(ByVal Stage As Long) As DataTable
    Dim sql As String = ""
    Dim aTempTable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try
      sql = "SELECT acs_name FROM Aircraft_Stage WITH(NOLOCK) WHERE acs_code = " & Stage.ToString


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable

    Catch ex As Exception
      GetLifeCycleStage = Nothing
      Me.class_error = "Error in GetLifeCycleStage(ByVal Stage As String) As DataTable SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function
  Public Function GetStatesByTimezone(ByVal timezoneStr As String) As DataTable
    Dim sql As String = ""
    Dim aTempTable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try
      sql = "SELECT distinct state_code FROM Geographic WITH(NOLOCK) LEFT OUTER JOIN State WITH(NOLOCK) ON (geographic_state_code = state_code AND geographic_country_name = state_country) "
      sql += " AND state_active_flag = 'Y' "
      If timezoneStr <> "" Then
        sql += " where state_timezone_id in (" & timezoneStr & ") "
      End If
      sql += " ORDER BY state_code"


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable

    Catch ex As Exception
      GetStatesByTimezone = Nothing
      Me.class_error = "Error in GetStatesByTimezone(ByVal timezoneStr As String) As DataTable SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function
  ''' <summary>
  ''' Gets the latest Flight Data Date for the subscription class whenever the user logs in (default.aspx.vb page in UpdateUserSession())
  ''' </summary>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Get_FAA_Date() As DataTable
    Dim sql As String = ""
    Dim aTempTable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try

      sql = "SELECT MAX(ffd_date) AS MaxDate FROM FAA_Flight_Data WITH (NOLOCK)"


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString.Trim
      'HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim changed from this - MSW - to get the latest date from their own Db - weekly
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable
    Catch ex As Exception
      Get_FAA_Date = Nothing
      Me.class_error = "Error in Get_FAA_Date() As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function

  Public Sub FillCacheLookups()
    If IsNothing(HttpContext.Current.Cache("CacheLookups")) Then
      HttpContext.Current.Cache.Insert("CacheLookups", CacheLookupFields, Nothing, DateTime.Now.AddDays(1), Cache.NoSlidingExpiration)
    End If
  End Sub

  Public Function CacheLookupFields()
    Dim LookupDataSet As New DataSet
    'Dim AircraftContactType_Datatable As New DataTable
    Dim BusinessType_Datatable As New DataTable
    Dim ContactTitle_Datatable As New DataTable
    Dim MaintenanceRegulation_Datatable As New DataTable
    Dim FractionalPrograms_Datatable As New DataTable
    Dim EngineMaintenance_Datatable As New DataTable
    Dim EngineManagement_Datatable As New DataTable
    Dim AirframeMaintenance_Datatable As New DataTable
    Dim AirframeManagement_Datatable As New DataTable
    Dim MaintenanceRegulation_Active_Datatable As New DataTable

    Dim Maintenance_Item_Datatable As New DataTable


    'Datatable #1 is Business Types
    BusinessType_Datatable = Get_Jetnet_Business_Type()
    BusinessType_Datatable.TableName = "BUSINESS_TYPE"

    'Datatable #2 is Contact Title
    ContactTitle_Datatable = Get_Jetnet_Contact_Title_Group()
    ContactTitle_Datatable.TableName = "CONTACT_TITLE"

    'Datatable #3 is MaintenanceRegulationUSOrForeign
    MaintenanceRegulation_Datatable = MaintenanceRegulationUSOrForeign(False, False)
    MaintenanceRegulation_Datatable.TableName = "MAINTENANCE"

    ''Datatable #4 is Fractional Programs"
    FractionalPrograms_Datatable = GetFractionalPrograms()
    FractionalPrograms_Datatable.TableName = "FRACTIONAL_PROGRAMS"

    'Datatable #5 is Engine Maintenance.
    EngineMaintenance_Datatable = EngineMaintenanceProgramProviderOrName(True, False, "")
    EngineMaintenance_Datatable.TableName = "ENGINE_MAINTENANCE"

    'Datatable #6 is Engine Management.
    EngineManagement_Datatable = EngineManagementProgramProviderOrName(True, False, "")
    EngineManagement_Datatable.TableName = "ENGINE_MANAGEMENT"

    'Datatable #7 is Airframe Maintenance.
    AirframeMaintenance_Datatable = AirframeMaintenanceProgramProviderOrName(True, False, "")
    AirframeMaintenance_Datatable.TableName = "AIRFRAME_MAINTENANCE"

    'Datatable #8 is Airframe TP.
    AirframeManagement_Datatable = AirframeMaintenanceTrackingProgramProviderOrName(True, False, "")
    AirframeManagement_Datatable.TableName = "AIRFRAME_MANAGEMENT"

    ''Datatable #9 is Maintenance_Item"
    Maintenance_Item_Datatable = GetMaintenanceItem()
    Maintenance_Item_Datatable.TableName = "MAINTENANCE_ITEMS"

    ' MSW - 5/5/19
    ''Datatable #10 is Maintenance_Active"
    MaintenanceRegulation_Active_Datatable = MaintenanceRegulationUSOrForeign(False, False, True)
    MaintenanceRegulation_Active_Datatable.TableName = "MAINTENANCE_ACTIVE"

    'Adding to the dataset.
    'LookupDataSet.Tables.Add(AircraftContactType_Datatable)
    LookupDataSet.Tables.Add(BusinessType_Datatable)
    LookupDataSet.Tables.Add(ContactTitle_Datatable)
    LookupDataSet.Tables.Add(MaintenanceRegulation_Datatable)
    LookupDataSet.Tables.Add(FractionalPrograms_Datatable)
    LookupDataSet.Tables.Add(EngineMaintenance_Datatable)
    LookupDataSet.Tables.Add(EngineManagement_Datatable)
    LookupDataSet.Tables.Add(AirframeMaintenance_Datatable)
    LookupDataSet.Tables.Add(AirframeManagement_Datatable)
    LookupDataSet.Tables.Add(Maintenance_Item_Datatable)
    LookupDataSet.Tables.Add(MaintenanceRegulation_Active_Datatable)

    Return LookupDataSet

  End Function
  ''' <summary>
  ''' Gets Fractional Programs.
  ''' </summary>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function GetMaintenanceItem() As DataTable
    Dim sql As String = ""
    Dim aTempTable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try
      sql = "SELECT DISTINCT * FROM Maintenance_Item WITH(NOLOCK) WHERE mitem_active_flag='Y' ORDER BY mitem_sort"

      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

    Catch ex As Exception

      Me.class_error = "Error in GetMaintenanceItem() As DataTable SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

    Return aTempTable

  End Function

  ''' <summary>
  ''' Gets Fractional Programs.
  ''' </summary>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function GetFractionalPrograms() As DataTable
    Dim sql As String = ""
    Dim aTempTable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try
      sql = "SELECT DISTINCT prog_id, prog_comp_id, prog_name FROM Aircraft_Programs WITH(NOLOCK) where prog_active_flag = 'Y' GROUP BY prog_id, prog_name, prog_comp_id ORDER BY prog_name"

      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable

    Catch ex As Exception
      GetFractionalPrograms = Nothing
      Me.class_error = "Error in GetFractionalPrograms() As DataTable SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function
  ''' <summary>
  ''' Gets Financial Institutions Primary Groups.
  ''' </summary>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Get_Financial_Institution_Primary_Group(ByVal genericName As String) As DataTable
    Dim sql As String = ""
    Dim aTempTable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try
      sql = "SELECT DISTINCT fipg_generic_name, fipg_comp_id_in_clause FROM Financial_Institution_Primary_Group WITH (NOLOCK) WHERE fipg_active_flag='Y'"

      If Not String.IsNullOrEmpty(genericName.Trim) Then
        sql += " AND fipg_generic_name = '" + genericName.Trim + "'"
      End If

      sql += " ORDER BY fipg_generic_name "



      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable

    Catch ex As Exception
      Get_Financial_Institution_Primary_Group = Nothing
      Me.class_error = "Error in Get_Financial_Institution_Primary_Group(ByVal Stage As String) As DataTable SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function
  ''' <summary>
  ''' Types of ownership
  ''' </summary>
  ''' <param name="ownertype"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function GetOwnershipType(ByVal ownertype As String) As DataTable
    Dim sql As String = ""
    Dim aTempTable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try
      sql = "SELECT acot_name FROM Aircraft_Owner_Type WITH(NOLOCK) WHERE acot_code = '" + ownertype.ToUpper.Trim + "'"


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)
      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable

    Catch ex As Exception
      GetOwnershipType = Nothing
      Me.class_error = "Error in GetOwnershipType(ByVal ownertype As String) As DataTable SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function
  Public Function Run_Selection_Listing_Query() As DataTable
    Dim sql As String = ""
    Dim aTempTable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try
      sql = ""

      If InStr(Left(UCase(Trim(HttpContext.Current.Session.Item("Selection_Listing_Fields"))), 10), "SELECT") > 0 Then
        sql &= "" & Replace(HttpContext.Current.Session.Item("Selection_Listing_Fields"), "^", ",") & " "
      Else
        sql &= " Select  " & Replace(HttpContext.Current.Session.Item("Selection_Listing_Fields"), "^", ",") & " "
      End If

      If InStr(Left(UCase(Trim(HttpContext.Current.Session.Item("Selection_Listing_Table"))), 10), "FROM") > 0 Then
        sql &= " " & HttpContext.Current.Session.Item("Selection_Listing_Table") & " "
      Else
        sql &= " From " & HttpContext.Current.Session.Item("Selection_Listing_Table") & " "
      End If


      If Trim(HttpContext.Current.Session.Item("Selection_Listing_Where")) <> "" Then
        If InStr(Left(UCase(Trim(HttpContext.Current.Session.Item("Selection_Listing_Where"))), 10), "WHERE") > 0 Then
          sql &= " " & HttpContext.Current.Session.Item("Selection_Listing_Where") & " "
        Else
          sql &= " where  " & HttpContext.Current.Session.Item("Selection_Listing_Where") & " "
        End If


      End If
      sql &= " " & HttpContext.Current.Session.Item("Selection_Listing_Group")  ' group by statement should be included in sessio
      sql &= " " & HttpContext.Current.Session.Item("Selection_Listing_Order")  ' order by statement should be included in session


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable
    Catch ex As Exception
      Run_Selection_Listing_Query = Nothing
      Me.class_error = "Error in Get_Jetnet_Country(): SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function
  Public Function Get_Avionics_Mfr_Names() As DataTable
    Dim sql As String = ""
    Dim aTempTable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try
      sql = "select distinct avitem_mfr_name from Avionics_Item with (NOLOCK) where avitem_mfr_name is not null order by avitem_mfr_name asc"


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable
    Catch ex As Exception
      Get_Avionics_Mfr_Names = Nothing
      Me.class_error = "Error in Get_Jetnet_Country(): SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function
  Public Function Get_Avionics_Item_By_ID(ByVal temp_id As Long) As DataTable
    Dim sql As String = ""
    Dim aTempTable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try
      sql = "select * from Avionics_Item with (NOLOCK) where avitem_id = " & temp_id & " "


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable
    Catch ex As Exception
      Get_Avionics_Item_By_ID = Nothing
      Me.class_error = "Error in Get_Jetnet_Country(): SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function
  ''' <summary>
  ''' returns a list of countries for dropdown
  ''' </summary>
  ''' <returns></returns>
  ''' <remarks></remarks> 
  Public Function Get_Jetnet_Country() As DataTable
    Dim sql As String = ""
    Dim aTempTable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try
      sql = "select country_name as clicountry_name from country with (NOLOCK) where country_active_flag = 'Y' order by country_name asc"


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable
    Catch ex As Exception
      Get_Jetnet_Country = Nothing
      Me.class_error = "Error in Get_Jetnet_Country(): SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function
  ''' <summary>
  ''' Returns a list of states for dropdown
  ''' </summary>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Get_Jetnet_State() As DataTable
    Dim sql As String = ""
    Dim aTempTable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try
      sql = "select state_name as client_state, state_code as client_state_abbr from state with (NOLOCK) where state_active_flag = 'Y' order by state_name asc"


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable

    Catch ex As Exception
      Get_Jetnet_State = Nothing
      Me.class_error = "Error in Get_Jetnet_State(): SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function
  ''' <summary>
  ''' list of trans contact types on search page
  ''' </summary>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Get_Client_Aircraft_Contact_Type(Optional ByVal Historical As Boolean = False) As DataTable
    Dim tempTable As New DataTable

    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      Dim sQuery As String = ""

      sQuery = "select actype_name as cliact_name, actype_code as cliact_type from aircraft_contact_type with (NOLOCK) where actype_acref_flag='Y' "

      If Historical = False Then
        sQuery += " and actype_use_flag not in ('T') "
      Else
        sQuery += " and actype_transref_flag='Y'"
      End If

      If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Then
        sQuery += " and actype_code not in ('38','99','93','2X')"
      End If

      sQuery += " and actype_code not in ('02','66','67','68','73') order by actype_name "


      SqlCommand.CommandText = sQuery


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sQuery.ToString)

      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        tempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = tempTable.GetErrors()
      End Try
      Return tempTable
    Catch ex As Exception
      Get_Client_Aircraft_Contact_Type = Nothing
      Me.class_error = "Error in Get_Client_Aircraft_Contact_Type(): SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function

  Public Function Get_Yacht_Brand_names() As DataTable
    Dim tempTable As New DataTable

    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      Dim sQuery As String = ""

      sQuery = " select distinct ym_brand_name from Yacht_model where ym_brand_name <> 'JETNET' "


      SqlCommand.CommandText = sQuery


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sQuery.ToString)


      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        tempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = tempTable.GetErrors()
      End Try
      Return tempTable
    Catch ex As Exception
      Get_Yacht_Brand_names = Nothing
      Me.class_error = "Error in Get_Yacht_MFr_Comp_names() As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function
  Public Function Get_Yacht_MFr_Comp_names() As DataTable
    Dim tempTable As New DataTable

    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      Dim sQuery As String = ""

      sQuery = " select distinct comp_name, comp_id "
      sQuery += "  from Yacht with (NOLOCK) "
      sQuery += " inner join Yacht_Model with (NOLOCK) on ym_model_id = yt_model_id  "
      sQuery += " inner join Company with (NOLOCK) on comp_id = ym_mfr_comp_id and comp_journ_id = 0  "
      sQuery += " order by comp_name asc "


      SqlCommand.CommandText = sQuery


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sQuery.ToString)

      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        tempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = tempTable.GetErrors()
      End Try
      Return tempTable
    Catch ex As Exception
      Get_Yacht_MFr_Comp_names = Nothing
      Me.class_error = "Error in Get_Yacht_MFr_Comp_names() As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function
  '''' <summary>
  '''' list of yacht contact types on search page
  '''' </summary>
  '''' <returns></returns>
  '''' <remarks></remarks>
  Public Function Get_Yacht_Contact_Type(ByVal isHistorical As Boolean) As DataTable
    Dim tempTable As New DataTable

    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      Dim sQuery As String = ""

      If isHistorical Then
        sQuery = "SELECT *"
        sQuery += " FROM yacht_contact_type"
        sQuery += " WHERE yct_transaction_reference_flag = 'Y' AND yct_code NOT IN ('71')"
        sQuery += " ORDER BY yct_name"
      Else
        sQuery = "SELECT *"
        sQuery += " FROM yacht_contact_type"
        sQuery += " WHERE yct_yacht_reference_flag = 'Y' AND yct_code NOT IN ('71')"
        sQuery += " ORDER BY yct_name"
      End If


      SqlCommand.CommandText = sQuery


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sQuery.ToString)

      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        tempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = tempTable.GetErrors()
      End Try
      Return tempTable
    Catch ex As Exception
      Get_Yacht_Contact_Type = Nothing
      Me.class_error = "Error in Get_Yacht_Contact_Type() As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function
  '''' <summary>
  '''' list of yacht contact types on search page
  '''' </summary>
  '''' <returns></returns>
  '''' <remarks></remarks>
  Public Function Get_Yacht_Class() As DataTable
    Dim tempTable As New DataTable

    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      Dim sQuery As String = ""

      sQuery = " select ycst_code,ycst_society_name"
      sQuery += " from Yacht_Classification_Society_Types"
      sQuery += " where ycst_active_flag='Y'"
      sQuery += " order by ycst_society_name"



      SqlCommand.CommandText = sQuery


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sQuery.ToString)

      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        tempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = tempTable.GetErrors()
      End Try
      Return tempTable
    Catch ex As Exception
      Get_Yacht_Class = Nothing
      Me.class_error = "Error in Get_Yacht_Class() As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function
  ''' <summary>
  ''' list of trans contact types on search page
  ''' </summary>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Get_CRM_Client_Aircraft_Contact_Type() As DataTable
    Dim tempTable As New DataTable

    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      Dim sQuery As String = "select actype_name as cliact_name, actype_code as cliact_type from aircraft_contact_type with (NOLOCK) order by actype_name"
      SqlCommand.CommandText = sQuery


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sQuery.ToString)

      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        tempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = tempTable.GetErrors()
      End Try
      Return tempTable
    Catch ex As Exception
      Get_CRM_Client_Aircraft_Contact_Type = Nothing
      Me.class_error = "Error in Get_CRM_Client_Aircraft_Contact_Type: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_Aircraft_Contact_Type
  ' Purpose: to get the client aircraft contact types 
  ' Parameters: act_type
  ' Return: 
  '       datatable
  ' Change Log
  '           1/27/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Client_Aircraft_Contact_Type(ByVal act_type As String) As DataTable
    Dim tempTable As New DataTable

    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      Dim sQuery As String = "select actype_name as cliact_name, actype_code as cliact_type from aircraft_contact_type with (NOLOCK)  WHERE (actype_code = '" & act_type & "') order by actype_name "
      SqlCommand.CommandText = sQuery


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sQuery.ToString)

      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        tempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = tempTable.GetErrors()
      End Try
      Return tempTable
    Catch ex As Exception
      Get_Client_Aircraft_Contact_Type = Nothing
      Me.class_error = "Error in Get_Client_Aircraft_Contact_Type(ByVal act_type As String) As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function
  '''' <summary>
  '''' list of trans cats on ac transaction edit page
  '''' </summary>
  '''' <returns></returns>
  '''' <remarks></remarks>
  'Public Function Get_Client_Transactions_Category() As DataTable
  '    Dim tempTable As New DataTable

  '    Dim SqlConn As New SqlClient.SqlConnection
  '    Dim SqlCommand As New SqlClient.SqlCommand
  '    Dim SqlReader As SqlClient.SqlDataReader
  '    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

  '    Try

  '        SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
  '        SqlConn.Open()
  '        SqlCommand.Connection = SqlConn

  '        Dim sQuery As String = "select jcat_subcategory_transtype as clitcat_type from journal_category WITH (NOLOCK) order by jcat_subcategory_transtype"
  '        SqlCommand.CommandText = sQuery
  '        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Transactions_Category() As DataTable</b><br />" & sQuery


  '        SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
  '        SqlCommand.CommandType = CommandType.Text
  '        SqlCommand.CommandTimeout = 60

  '        Try
  '            tempTable.Load(SqlReader)
  '        Catch constrExc As System.Data.ConstraintException
  '            Dim rowsErr As System.Data.DataRow() = tempTable.GetErrors()
  '        End Try
  '    Catch ex As Exception
  '        Get_Client_Transactions_Category = Nothing
  '        Me.class_error = "Error in Get_Client_Transactions_Category(): SQL VERSION " & ex.Message
  '    Finally
  '        SqlReader = Nothing

  '        SqlConn.Dispose()
  '        SqlConn.Close()
  '        SqlConn = Nothing

  '        SqlCommand.Dispose()
  '        SqlCommand = Nothing
  '    End Try
  '    Return tempTable
  'End Function

  ''' <summary>
  ''' list of trans cats on search page
  ''' </summary>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Get_Client_Transactions_Category() As DataTable
    Dim tempTable As New DataTable
    Try

      tempTable.Columns.Add("clitcat_type")
      tempTable.Columns.Add("clitcat_code")


      Dim newCustomersRow As DataRow = tempTable.NewRow()
      newCustomersRow("clitcat_type") = "Full Sale"
      newCustomersRow("clitcat_code") = "Full Sale|WS"
      tempTable.Rows.Add(newCustomersRow)
      tempTable.AcceptChanges()

      newCustomersRow = tempTable.NewRow()
      newCustomersRow("clitcat_type") = "Fractional Sale"
      newCustomersRow("clitcat_code") = "Fractional Sale|FS"
      tempTable.Rows.Add(newCustomersRow)
      tempTable.AcceptChanges()

      newCustomersRow = tempTable.NewRow()
      newCustomersRow("clitcat_type") = "Share Sale"
      newCustomersRow("clitcat_code") = "Share Sale|SS"
      tempTable.Rows.Add(newCustomersRow)
      tempTable.AcceptChanges()

      newCustomersRow = tempTable.NewRow()
      newCustomersRow("clitcat_type") = "Delivery Position Sale"
      newCustomersRow("clitcat_code") = "Delivery Position Sale|DP"
      tempTable.Rows.Add(newCustomersRow)
      tempTable.AcceptChanges()

      newCustomersRow = tempTable.NewRow()
      newCustomersRow("clitcat_type") = "Foreclosure"
      newCustomersRow("clitcat_code") = "Foreclosure|FC"
      tempTable.Rows.Add(newCustomersRow)
      tempTable.AcceptChanges()

      newCustomersRow = tempTable.NewRow()
      newCustomersRow("clitcat_type") = "Seizure"
      newCustomersRow("clitcat_code") = "Seizure|SZ"
      tempTable.Rows.Add(newCustomersRow)
      tempTable.AcceptChanges()

      newCustomersRow = tempTable.NewRow()
      newCustomersRow("clitcat_type") = "Lease"
      newCustomersRow("clitcat_code") = "Lease|LS"
      tempTable.Rows.Add(newCustomersRow)
      tempTable.AcceptChanges()

    Catch ex As Exception
      Get_Client_Transactions_Category = Nothing
      Me.class_error = "Error in Get_Search_Transactions_Category(): SQL VERSION " & ex.Message

    End Try
    Return tempTable
  End Function


  ''' <summary>
  ''' gets list of timezones
  ''' </summary>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Get_Jetnet_Timezone() As DataTable
    Dim sql As String = ""
    Dim aTempTable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try

      sql = "Select tzone_name from TimeZone with (NOLOCK) order by tzone_name"

      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable
    Catch ex As Exception
      Get_Jetnet_Timezone = Nothing
      Me.class_error = "Error in Get_Jetnet_Timezone() As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function

  ''' <summary>
  ''' gets list of contact title group
  ''' </summary>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Get_Jetnet_Contact_Title_Group() As DataTable
    Dim sql As String = ""
    Dim aTempTable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try

      sql = "SELECT ctitleg_group_name FROM Contact_Title_Group with (NOLOCK) where ctitleg_product_yacht_flag <> 'Y'"


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable
    Catch ex As Exception
      Get_Jetnet_Contact_Title_Group = Nothing
      Me.class_error = "Error in Get_Jetnet_Contact_Title_Group() As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function
  Public Function Get_Jetnet_Category_Size() As DataTable
    Dim sql As String = ""
    Dim aTempTable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try

      sql = "SELECT distinct ycs_category_size, ycs_description from yacht_category_size WITH (NOLOCK) "


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable
    Catch ex As Exception
      Get_Jetnet_Category_Size = Nothing
      Me.class_error = "Error in Get_Jetnet_Contact_Title_Group() As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function
  ''' <summary>
  ''' Gets a list of continents
  ''' </summary>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Get_Jetnet_Continents() As DataTable
    Dim sql As String = ""
    Dim aTempTable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try

      sql = "SELECT continent_name FROM Continent with (NOLOCK) order by continent_name "


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable
    Catch ex As Exception
      Get_Jetnet_Continents = Nothing
      Me.class_error = "Error in Get_Jetnet_Continents() As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function

  ''' <summary>
  ''' Gets a list of regions
  ''' </summary>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Get_Jetnet_Regions() As DataTable
    Dim sql As String = ""
    Dim aTempTable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try
      sql = "SELECT distinct geographic_region_name FROM geographic with (NOLOCK) order by geographic_region_name"


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable
    Catch ex As Exception
      Get_Jetnet_Regions = Nothing
      Me.class_error = "Error in Public Function Get_Jetnet_Regions() As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function
  Public Function Get_States_From_Jetnet_Region(ByVal region_name As String) As DataTable
    Dim sql As String = ""
    Dim aTempTable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try
      sql = "SELECT distinct state_name FROM geographic with (NOLOCK) inner join state with (NOLOCK) on state_code=geographic_state_code where geographic_region_name in ('" & region_name & "') order by state_name asc "


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable
    Catch ex As Exception
      Get_States_From_Jetnet_Region = Nothing
      Me.class_error = "Error in Public Function Get_Jetnet_Regions() As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function
  Public Function Get_Countries_From_Jetnet_Region(ByVal region_name As String) As DataTable
    Dim sql As String = ""
    Dim aTempTable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try
      sql = "SELECT distinct geographic_country_name FROM geographic with (NOLOCK) where geographic_region_name in ('" & region_name & "') order by geographic_country_name asc "


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable
    Catch ex As Exception
      Get_Countries_From_Jetnet_Region = Nothing
      Me.class_error = "Error in Public Function Get_Jetnet_Regions() As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function

  ''' <summary>
  ''' Gets an associated country by a state name
  ''' </summary>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Get_Jetnet_Country_By_State(ByVal regionList As String, ByVal STATENAME As String) As DataTable
    Dim sqlQuery As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim aTempTable As New DataTable

    Try
      sqlQuery = "Select geographic_country_name from geographic with (NOLOCK) "
      sqlQuery += " inner join state with (NOLOCK) on state_code=geographic_state_code "
      sqlQuery += " where geographic_region_name in (" & regionList & ") "
      If STATENAME <> "" Then
        sqlQuery += " and state_name = @STATENAME "
      End If

      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sqlQuery.ToString)

      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()

      Dim SqlCommand As New SqlClient.SqlCommand(sqlQuery, SqlConn)
      If STATENAME <> "" Then
        SqlCommand.Parameters.AddWithValue("STATENAME", STATENAME)
      End If

      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable

      SqlCommand.Dispose()
      SqlCommand = Nothing
    Catch ex As Exception
      Get_Jetnet_Country_By_State = Nothing
      Me.class_error = "Error in Public Function Get_Jetnet_Country_By_State(ByVal regionList As String, ByVal STATENAME As String) As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

    End Try

  End Function
  Public Function Get_Jetnet_Country_By_Continent(ByVal continentList As String) As DataTable
    Dim sqlQuery As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim aTempTable As New DataTable

    Try
      ' Invalid column name 'geographic_state_code'. Invalid column name 'continent_country_name'.

      sqlQuery = "SELECT * FROM Country with (NOLOCK)  "
      sqlQuery += " where country_continent_name in (" & continentList & ") "
      sqlQuery += "  order by country_continent_name"

      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sqlQuery.ToString)

      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()

      Dim SqlCommand As New SqlClient.SqlCommand(sqlQuery, SqlConn)

      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable

      SqlCommand.Dispose()
      SqlCommand = Nothing
    Catch ex As Exception
      Get_Jetnet_Country_By_Continent = Nothing
      Me.class_error = "Error in Public Function Get_Jetnet_Country_By_Continent(ByVal continentList As String) As DataTable SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

    End Try

  End Function
  ''' <summary>
  ''' Get associated state by country/region
  ''' </summary>
  ''' <param name="regionList"></param>
  ''' <param name="countryName"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Get_Jetnet_State_By_Country(ByVal regionList As String, ByVal countryName As String) As DataTable
    Dim sqlQuery As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim aTempTable As New DataTable

    Try
      sqlQuery = "Select state_name from geographic with (NOLOCK) "
      sqlQuery += " inner join state with (NOLOCK) on state_code=geographic_state_code "
      sqlQuery += " where geographic_region_name in (" & regionList & ") and geographic_country_name = @COUNTRYNAME "


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sqlQuery.ToString)

      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()

      Dim SqlCommand As New SqlClient.SqlCommand(sqlQuery, SqlConn)
      SqlCommand.Parameters.AddWithValue("COUNTRYNAME", countryName)

      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable

      SqlCommand.Dispose()
      SqlCommand = Nothing
    Catch ex As Exception
      Get_Jetnet_State_By_Country = Nothing
      Me.class_error = "Error in Public Function Get_Jetnet_State_By_Country(ByVal regionList As String, ByVal countryName As String) As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

    End Try

  End Function

  ''' <summary>
  ''' </summary>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Get_Jetnet_Business_Type() As DataTable
    Dim sql As String = ""
    Dim aTempTable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try

      sql = "Select cbus_name, cbus_type from Company_business_type with (NOLOCK) "
      sql += " where "

      If HttpContext.Current.Session.Item("jetnetAppVersion") <> crmWebClient.Constants.ApplicationVariable.YACHT Then
        sql += " cbus_aircraft_flag='Y' "
      Else
        sql += " cbus_yacht_flag='Y' "
      End If
      sql += "order by cbus_name"

      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable
    Catch ex As Exception
      Get_Jetnet_Business_Type = Nothing
      Me.class_error = "Error in Public Function Get_Jetnet_Business_Type() As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function

  Public Function FillCurrencyTable() As DataTable
    Dim atemptable As New DataTable
    Dim sQuery = New StringBuilder()

    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try

      sQuery.Append("SELECT currency_id, currency_exchange_rate, currency_name, currency_exchange_rate_date FROM Currency WITH(NOLOCK)")


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sQuery.ToString)
      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
      SqlConn.Open()

      SqlCommand.Connection = SqlConn
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      SqlCommand.CommandText = sQuery.ToString
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

    Catch ex As Exception
      FillCurrencyTable = Nothing
      Me.class_error = "Error in Public Function FillCurrencyTable() As DataTable: SQL VERSION " & ex.Message
    Finally

      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

    Return atemptable

  End Function

#End Region
#Region "Transaction Queries"
  Public Function GetExclusiveBrokerDateJournal(ByVal ac_id As Long, ByVal compID As Long) As DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable
    Dim sql As String = ""
    Try

      sql = "SELECT TOP 1 journ_date FROM Journal WITH(NOLOCK) WHERE (journ_ac_id = " & ac_id

      If compID <> 0 Then
        sql &= " AND journ_comp_id = " & compID
      End If

      If compID > 0 Then
        sql &= " AND (journ_subcategory_code = 'EXON' or journ_subject like 'Added Co-Exclusive%' ) "
      Else
        sql &= " AND journ_subcategory_code = 'EXON'  "
      End If


      sql &= ") ORDER BY journ_date DESC"


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn



      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60
      'SqlReader = Nothing
      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Return atemptable
    Catch ex As Exception
      GetExclusiveBrokerDateJournal = Nothing
      Me.class_error = "Error in GetExclusiveBrokerDateJournal(ByVal ac_id As Long, ByVal compID As Long) As DataTable: SQL VERSION " & ex.Message

    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function


  '''' <summary>
  '''' This is the transaction query for the company side for the evo version
  '''' </summary>
  '''' <param name="comp_id"></param>
  '''' <returns></returns>
  ''' <remarks></remarks>
  Public Function GetJETNET_Transactions_compID(ByVal comp_id As Long, ByVal FilterOffMarketMadeVariables As Boolean) As DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable
    Dim sql As String = ""
    Dim count As Integer = 0
    Dim oldID As Long = 0
    Try
      Dim compcount As DataColumn = atemptable.Columns.Add("count", Type.GetType("System.Int64"))

      atemptable.Columns.Add("cref_contact_type")
      atemptable.Columns.Add("trans_date")
      atemptable.Columns.Add("tdoc_pdf_exist_flag")
      atemptable.Columns.Add("tdoc_doc_type")
      atemptable.Columns.Add("tdoc_date_of_document")
      atemptable.Columns.Add("tdoc_seq_nbr")
      atemptable.Columns.Add("tcat_name")
      atemptable.Columns.Add("trans_subject")
      atemptable.Columns.Add("trans_id")
      atemptable.Columns.Add("tdoc_general_note")
      atemptable.Columns.Add("ac_id")
      atemptable.Columns.Add("amod_make_name")
      atemptable.Columns.Add("amod_model_name")
      atemptable.Columns.Add("ac_ser_no_full")
      atemptable.Columns.Add("comp_id")

      sql = "SELECT DISTINCT '' as cref_contact_type, journ_date as trans_date, 'N' as tdoc_pdf_exist_flag, adoc_doc_type as tdoc_doc_type, adoc_doc_date as tdoc_date_of_document, "
      sql = sql & " adoc_journ_seq_no as tdoc_seq_nbr, jcat_category_name as tcat_name, journ_subject as trans_subject, "
      sql = sql & " journ_id as trans_id,  "
      sql = sql & " journ_customer_note as tdoc_general_note, ac_id, "
      sql = sql & " amod_make_name, amod_model_name,ac_ser_no_full,  cref_comp_id as comp_id FROM Aircraft_Reference WITH(NOLOCK) "
      sql = sql & " INNER JOIN Journal WITH(NOLOCK) ON Journal.journ_id = Aircraft_Reference.cref_journ_id "
      sql = sql & " INNER JOIN Aircraft WITH(NOLOCK) ON Journal.journ_ac_id = Aircraft.ac_id AND Journal.journ_id = Aircraft.ac_journ_id "
      sql = sql & " INNER JOIN Journal_Category WITH(NOLOCK) ON Journal_Category.jcat_subcategory_code = journ_subcategory_code "
      sql = sql & " INNER JOIN Aircraft_Model WITH(NOLOCK) ON Aircraft_Model.amod_id = Aircraft.ac_amod_id "
      sql = sql & " LEFT OUTER JOIN"
      sql = sql & " aircraft_document ON journ_id = adoc_journ_id and adoc_hide_flag='N' "
      sql = sql & " WHERE Aircraft_Reference.cref_comp_id = " & comp_id
      sql = sql & " AND jcat_category_code = 'AH' "
      '-- DO NOT INCLUDE OFF MARKETS AND MADE AVAILABLES
      If FilterOffMarketMadeVariables = True Then
        sql = sql & " AND journ_subcat_code_part1 not in ('OM','MA')"
      End If

      sql = sql & " " & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(HttpContext.Current.Session.Item("localSubscription"), False, True)


      sql = sql & " AND jcat_subcategory_code NOT LIKE '%CORR' "
      'sql = sql & " AND journ_subcat_code_part1 not in ('OM','MA')"
      sql = sql & " ORDER BY journ_date desc, journ_id desc, adoc_journ_seq_no "


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn



      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      While SqlReader.Read()
        Dim newCustomersRow As DataRow = atemptable.NewRow()

        If oldID <> SqlReader.Item("trans_id") Then
          count = count + 1
        End If

        newCustomersRow("count") = count
        newCustomersRow("ac_id") = SqlReader.Item("ac_id")
        newCustomersRow("comp_id") = SqlReader.Item("comp_id")
        newCustomersRow("trans_id") = SqlReader.Item("trans_id")

        newCustomersRow("cref_contact_type") = SqlReader.Item("cref_contact_type")
        newCustomersRow("trans_date") = SqlReader.Item("trans_date")
        newCustomersRow("tdoc_pdf_exist_flag") = SqlReader.Item("tdoc_pdf_exist_flag")
        newCustomersRow("tdoc_doc_type") = SqlReader.Item("tdoc_doc_type")
        newCustomersRow("tdoc_date_of_document") = SqlReader.Item("tdoc_date_of_document")

        newCustomersRow("tdoc_seq_nbr") = SqlReader.Item("tdoc_date_of_document")

        newCustomersRow("tcat_name") = SqlReader.Item("tcat_name")
        newCustomersRow("trans_subject") = SqlReader.Item("trans_subject")

        newCustomersRow("tdoc_general_note") = SqlReader.Item("tdoc_general_note")

        newCustomersRow("amod_make_name") = SqlReader.Item("amod_make_name")
        newCustomersRow("amod_model_name") = SqlReader.Item("amod_model_name")
        newCustomersRow("ac_ser_no_full") = SqlReader.Item("ac_ser_no_full")



        atemptable.Rows.Add(newCustomersRow)
        atemptable.AcceptChanges()


        oldID = SqlReader.Item("trans_id")
      End While

      Return atemptable
    Catch ex As Exception
      GetJETNET_Transactions_compID = Nothing
      Me.class_error = "Error in GetJETNET_Transactions_compID(): SQL VERSION " & ex.Message

    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function

  Public Function TransactionsCompanyDetailsByJetnetID(ByVal comp_id As Long, ByVal FilterOffMarketMadeVariables As Boolean, ByVal viewAll As Boolean) As DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable
    Dim sql As String = ""
    Dim count As Integer = 0
    Dim oldID As Long = 0
    Try
      Dim compcount As DataColumn = atemptable.Columns.Add("count", Type.GetType("System.Int64"))

      atemptable.Columns.Add("cref_contact_type")
      atemptable.Columns.Add("trans_date")
      'atemptable.Columns.Add("tdoc_pdf_exist_flag")
      'atemptable.Columns.Add("tdoc_doc_type")
      'atemptable.Columns.Add("tdoc_date_of_document")
      'atemptable.Columns.Add("tdoc_seq_nbr")
      atemptable.Columns.Add("tcat_name")
      atemptable.Columns.Add("trans_subject")
      atemptable.Columns.Add("trans_id")
      atemptable.Columns.Add("tdoc_general_note")
      atemptable.Columns.Add("ac_id")
      atemptable.Columns.Add("amod_make_name")
      atemptable.Columns.Add("amod_model_name")
      atemptable.Columns.Add("ac_ser_no_full")
      atemptable.Columns.Add("comp_id")
      atemptable.Columns.Add("ac_asking")
      atemptable.Columns.Add("ac_sale_price")
      atemptable.Columns.Add("ac_asking_price")
      atemptable.Columns.Add("ac_list_date")
      sql = "SELECT DISTINCT '' as cref_contact_type, journ_date as trans_date, jcat_category_name as tcat_name, journ_subject as trans_subject, "
      sql = sql & " journ_id as trans_id, ac_asking_price, ac_asking , case when ac_sale_price_display_flag = 'N' then 0 when ac_sale_price_display_flag = 'Y' then case when journ_internal_trans_flag = 'Y' then 0 when journ_subcat_code_part3 IN ('DB','DS','FI','FY','IT','MF','RE','CC','LS', 'RM') then 0 when journ_subcat_code_part1 <> 'WS' then 0 else ac_sale_price end end as ac_sale_price, "
      sql = sql & " journ_customer_note as tdoc_general_note, ac_id,ac_list_date, "
      sql = sql & " amod_make_name, amod_model_name,ac_ser_no_full,  cref_comp_id as comp_id FROM Aircraft_Reference WITH(NOLOCK) "
      sql = sql & " INNER JOIN Journal WITH(NOLOCK) ON Journal.journ_id = Aircraft_Reference.cref_journ_id "
      sql = sql & " INNER JOIN Aircraft WITH(NOLOCK) ON Journal.journ_ac_id = Aircraft.ac_id AND Journal.journ_id = Aircraft.ac_journ_id "
      sql = sql & " INNER JOIN Journal_Category WITH(NOLOCK) ON Journal_Category.jcat_subcategory_code = journ_subcategory_code  "
      sql = sql & " INNER JOIN Aircraft_Model WITH(NOLOCK) ON Aircraft_Model.amod_id = Aircraft.ac_amod_id "
      sql = sql & " WHERE Aircraft_Reference.cref_comp_id = " & comp_id
      sql = sql & " AND jcat_category_code = 'AH' "
      '-- DO NOT INCLUDE OFF MARKETS AND MADE AVAILABLES
      If FilterOffMarketMadeVariables = True Then
        sql = sql & " AND journ_subcat_code_part1 not in ('OM','MA')"
      End If

      'sql = sql & " " & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(HttpContext.Current.Session.Item("localSubscription"), False, True)

      If viewAll = False Then
        Dim DateLastYear As Date = DateAdd(DateInterval.Year, -1, Now())
        sql = sql & " AND journ_date >= '" & Month(DateLastYear) & "/" & Day(DateLastYear) & "/" & Year(DateLastYear) & "'"
      End If
      'sql = sql & " AND journ_subcat_code_part1 not in ('OM','MA')"
      sql = sql & " ORDER BY journ_date desc, journ_id desc "


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn



      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      While SqlReader.Read()
        Dim newCustomersRow As DataRow = atemptable.NewRow()

        If oldID <> SqlReader.Item("trans_id") Then
          count = count + 1
        End If

        newCustomersRow("count") = count
        newCustomersRow("ac_id") = SqlReader.Item("ac_id")
        newCustomersRow("comp_id") = SqlReader.Item("comp_id")
        newCustomersRow("trans_id") = SqlReader.Item("trans_id")

        newCustomersRow("cref_contact_type") = SqlReader.Item("cref_contact_type")
        newCustomersRow("trans_date") = SqlReader.Item("trans_date")
        'newCustomersRow("tdoc_pdf_exist_flag") = SqlReader.Item("tdoc_pdf_exist_flag")
        'newCustomersRow("tdoc_doc_type") = SqlReader.Item("tdoc_doc_type")
        'newCustomersRow("tdoc_date_of_document") = SqlReader.Item("tdoc_date_of_document")

        'newCustomersRow("tdoc_seq_nbr") = SqlReader.Item("tdoc_date_of_document")

        newCustomersRow("tcat_name") = SqlReader.Item("tcat_name")
        newCustomersRow("trans_subject") = SqlReader.Item("trans_subject")

        newCustomersRow("tdoc_general_note") = SqlReader.Item("tdoc_general_note")

        newCustomersRow("amod_make_name") = SqlReader.Item("amod_make_name")
        newCustomersRow("amod_model_name") = SqlReader.Item("amod_model_name")
        newCustomersRow("ac_ser_no_full") = SqlReader.Item("ac_ser_no_full")

        newCustomersRow("ac_asking") = SqlReader.Item("ac_asking")
        newCustomersRow("ac_sale_price") = SqlReader.Item("ac_sale_price")
        newCustomersRow("ac_asking_price") = SqlReader.Item("ac_asking_price")
        newCustomersRow("ac_list_date") = SqlReader.Item("ac_list_date")


        atemptable.Rows.Add(newCustomersRow)
        atemptable.AcceptChanges()


        oldID = SqlReader.Item("trans_id")
      End While

      Return atemptable
    Catch ex As Exception
      TransactionsCompanyDetailsByJetnetID = Nothing
      Me.class_error = "Error in TransactionsCompanyDetailsByJetnetID(): SQL VERSION " & ex.Message

    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function
  '''' <summary>
  '''' This is the transaction query for the company side for the evo version
  '''' </summary>
  '''' <param name="comp_id"></param>
  '''' <returns></returns>
  ''' <remarks></remarks>
  Public Function GetJETNET_OnlyTransactionsByCompany(ByVal comp_id As Long, Optional ByVal amod_id As Integer = 0, Optional ByVal is_homebase As String = "N") As DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable
    Dim sql As String = ""
    Dim count As Integer = 0
    Dim oldID As Long = 0
    Try

      sql = "SELECT DISTINCT journ_id, journ_date, journ_subject, amod_make_name, amod_model_name, ac_ser_no_full, ac_id, "
      sql = sql & " actype_name, journ_customer_note, cref_comp_id"

      If Trim(is_homebase) = "Y" Then
        sql = sql & ", ac_year, ac_reg_no "
      End If

      sql = sql & " FROM Aircraft_Reference WITH(NOLOCK) "
      sql = sql & " Inner join Aircraft_Contact_Type WITH(NOLOCK) ON cref_contact_type=actype_code"
      sql = sql & " INNER JOIN Journal WITH(NOLOCK) ON Journal.journ_id = Aircraft_Reference.cref_journ_id "
      sql = sql & " INNER JOIN Aircraft WITH(NOLOCK) ON Journal.journ_ac_id = Aircraft.ac_id AND Journal.journ_id = Aircraft.ac_journ_id "
      sql = sql & " INNER JOIN Journal_Category WITH(NOLOCK) ON Journal_Category.jcat_subcategory_code = journ_subcategory_code "
      sql = sql & " INNER JOIN Aircraft_Model WITH(NOLOCK) ON Aircraft_Model.amod_id = Aircraft.ac_amod_id "
      sql = sql & " WHERE Aircraft_Reference.cref_comp_id =  " & comp_id & " AND jcat_category_code = 'AH' "
      sql = sql & " " & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(HttpContext.Current.Session.Item("localSubscription"), False, True)

      If Trim(is_homebase) = "Y" Then
        sql = sql & " and journ_date >= '" & Year(DateAdd(DateInterval.Year, -3, Date.Now)) & "' "
      End If


      If amod_id > 0 Then
        sql = sql & " AND ac_amod_id =" & amod_id & " "
        sql = sql & " and journ_date >= '1/1/" & Year(DateAdd(DateInterval.Year, -5, Date.Now)) & "' "
        sql = sql & " and journ_subcat_code_part1='WS' "
        sql = sql & " and journ_internal_trans_flag='N' and cref_contact_type in ('99','93','38','95','96') "
      End If


      '-- DO NOT INCLUDE CORRECTION TRANSACTIONS
      sql = sql & " AND jcat_subcategory_code NOT LIKE '%CORR' "
      '-- DO NOT INCLUDE OFF MARKETS AND MADE AVAILABLES
      sql = sql & " AND journ_subcat_code_part1 not in ('OM','MA')"
      sql = sql & " ORDER BY journ_date desc, journ_id desc"

      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)


      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Return atemptable


    Catch ex As Exception
      GetJETNET_OnlyTransactionsByCompany = Nothing
      Me.class_error = "Error in GetJETNET_OnlyTransactionsByCompany(ByVal comp_id As Long) As DataTable: SQL VERSION " & ex.Message

    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function
  Public Function GetJETNET_Transactions_acID(ByVal jetnet_id As Long) As DataTable
    Dim aTempTable As New DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Try
      sql = "SELECT DISTINCT journ_date as trans_date, journ_id as trans_id, journ_subject as trans_subject, journ_customer_note, ac_list_date, 'N' as tdoc_pdf_exist_flag,  "
      sql = sql & " ac_asking_price, ac_asking "


      If HttpContext.Current.Session.Item("localSubscription").crmSalesPriceIndex_Flag = True Then
        'sql = sql & ", case ac_sale_price_display_flag  when 'Y' then ac_sale_price when 'N' then 0 end as ac_sale_price  "
        sql = sql & add_in_case_for_ac_sale_price()
      Else
        sql = sql & ", '0' as ac_sale_price  "
      End If


      ' sql = sql & " , adoc_doc_type as tdoc_doc_type, adoc_doc_date, adoc_journ_seq_no as tdoc_seq_nbr"
      sql = sql & " FROM Journal WITH(NOLOCK) "
      sql = sql & " INNER JOIN Aircraft WITH(NOLOCK) ON Journal.journ_ac_id = Aircraft.ac_id AND Journal.journ_id = Aircraft.ac_journ_id "
      sql = sql & " INNER JOIN Journal_Category WITH(NOLOCK) ON Journal_Category.jcat_subcategory_code = journ_subcategory_code "
      sql = sql & " inner join aircraft_model  WITH(NOLOCK) on amod_id = ac_amod_id"
      'sql = sql & " left outer join aircraft_document  WITH(NOLOCK) on adoc_ac_id=ac_id and adoc_journ_id = ac_journ_id"
      sql = sql & " WHERE(ac_id = " & jetnet_id & ")"
      sql = sql & " AND jcat_category_code = 'AH' "
      'sql = sql & " AND ((amod_type_code IN ('T','P') AND amod_customer_flag = 'Y' AND amod_airframe_type_code = 'R' AND ac_product_helicopter_flag = 'Y') "
      'sql = sql & " OR (amod_customer_flag = 'Y' AND amod_airframe_type_code = 'F' AND ac_product_business_flag = 'Y') OR (amod_customer_flag = 'Y' "
      'sql = sql & " AND ac_product_commercial_flag = 'Y')) "
      sql = sql & " AND jcat_subcategory_code NOT LIKE '%CORR' "
      ' sql = sql & " AND journ_subcat_code_part1 not in ('OM','MA')"
      sql = sql & " ORDER BY journ_date desc" ', adoc_journ_seq_no"


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable
    Catch ex As Exception
      GetJETNET_Transactions_acID = Nothing
      Me.class_error = "Error in GetJETNET_Transactions_acID(): SQL VERSION " & ex.Message

    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function

  ''' <summary>
  ''' Gets Historical Data on the DisplayAircraftDetails Page
  ''' </summary>
  ''' <param name="acID"></param>
  ''' <param name="journalID"></param>
  ''' <param name="aerodex"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function GetJETNET_Historical_Data(ByVal acID As Long, ByVal journalID As Long, ByVal aerodex As Boolean) As DataTable
    Dim aTempTable As New DataTable
    Dim sql As String = ""
    Dim excludeONOFFmarket As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Try
      sql = "SELECT journ_id, journ_ac_id,  journ_date, 'JETNET' as source, 0 as client_jetnet_trans_id, journ_subject, jcat_subcategory_name, jcat_auto_subject_flag, journ_subcategory_code, journ_customer_note "
      ' sql &= ", ac_id, amod_make_name, amod_model_name, ac_ser_no_full "

      sql &= ", adoc_doc_date, journ_subject, adoc_onbehalf_comp_id, adoc_onbehalf_text, adoc_infavor_comp_id, adoc_infavor_text, adoc_general_note, adoc_journ_seq_no, adoc_doc_type, adoc_journ_id, "
      sql &= " adoc_hide_flag, doctype_subdir_name, doctype_file_extension "
      sql &= ", (select distinct ac_journ_id from Aircraft with (NOLOCK) where ac_id = journ_ac_id and ac_journ_id = journ_id) as Journal_Exists "

      If HttpContext.Current.Session.Item("localSubscription").crmSalesPriceIndex_Flag = True Then
        sql &= ", (select distinct ac_sale_price from Aircraft with (NOLOCK) where ac_id = journ_ac_id and ac_journ_id = journ_id) as ac_sale_price "
      Else
        sql &= ", 0 as ac_sale_price "
      End If

      sql &= " FROM Journal WITH(NOLOCK) INNER JOIN Journal_Category WITH(NOLOCK) ON journ_subcategory_code = jcat_subcategory_code"
      sql &= " left outer join Aircraft_Document WITH(NOLOCK) ON adoc_ac_id=journ_ac_id and adoc_journ_id = journ_id"
      sql &= " left outer JOIN Document_Type WITH (NOLOCK) ON doctype_description = adoc_doc_type"
      ' sql &= " left outer join aircraft with (NOLOCK)  on journ_ac_id = ac_id and journ_id = ac_journ_id "
      ' sql &= " left outer join aircraft_model with (NOLOCK) on amod_id = ac_amod_id "
      sql &= " WHERE jcat_category_code = 'AH' "
      sql &= " and (doctype_subdir_name <> 'COMPANY' or   doctype_subdir_name is null)"

      If aerodex Then excludeONOFFmarket = ",'OM','MA'"

      sql &= " AND journ_subcategory_code NOT IN ('IN','DM','EXOFF','EXON'" & excludeONOFFmarket & ")"

      If journalID > 0 Then
        sql &= " AND journ_id = " & journalID
      Else
        sql &= " AND journ_ac_id = " & acID
      End If

      sql &= " ORDER BY journ_date DESC, journ_id DESC"


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable
    Catch ex As Exception
      GetJETNET_Historical_Data = Nothing
      Me.class_error = "Error in GetJETNET_Historical_Data(ByVal acID As Long, ByVal journalID As Long, ByVal aerodex As Boolean) As DataTable: SQL VERSION " & ex.Message

    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function

  '-------------------------------------------------------------------------------------------------------------------------------
  ' Purpose: Insane function that is used for the Transaction Search
  'Start_Date = Start Date search parameter for Transactions
  'End_Date = End Date search parameter for Transactions
  'Category_type = Category Type Parameter for Transactions
  'Models = list of models for in clause for transactions
  'Search_Text = search box text for transaction search
  'Return: 
  '       DataTable
  ' Change Log
  '           2/21/2011    - Created By: Amanda Vaughn
  ''' <summary>
  ''' This function runs the Transaction Search on both the Master and Mobile Websites. 
  ''' </summary>
  ''' <param name="start_date">Start Date for the Transactions.</param>
  ''' <param name="end_date">End Date for the Transactions</param>
  ''' <param name="category_type">Type of Category for the transactions</param>
  ''' <param name="client_model_id_hold">Group of Client Models for the Transaction Search</param>
  ''' <param name="jetnet_model_id_hold">Group of Jetnet Models for the Transaction Search</param>
  ''' <param name="search_text">Search Text for the Transaction Search</param>
  ''' <param name="subset">Datasubset - Jetnet, Client, both?</param>
  ''' <param name="year_start">Start of the year - trans_year_mfr</param>
  ''' <param name="year_end">End of the year - trans_year_mfr</param>
  ''' <param name="internal">Internal Flag</param>
  ''' <param name="awaiting">Whether or not the transaction is awaiting documentation or not.</param>
  ''' <returns>Returns a Datatable of Transaction Information.</returns>
  ''' <remarks>First thing that happens is that the function builds a temporary table.
  ''' Then this same function queries the Jetnet History Table.
  ''' And then throws that information into the Temporary Table
  ''' And then.. queries the client history table and puts it into the temporary table.
  ''' Then it creates a table meant to return with all the columns.
  ''' Then it will loop through the temporary table and go through each data set to combine all of
  ''' company information into one string (one data row as opposed to many). So company name will be delimetered company_name | company_name
  ''' and so on. This is to assure that all information is passed to the client and does NOT need to be required on the display
  ''' so the database is only touched once.
  ''' Unfortunately this means that the client needs to parse the information which is taken care of in
  ''' listing.aspx.vb Results_Item_Databound event.</remarks>
  Public Function Transaction_Search(ByVal start_date As String, ByVal end_date As String, ByVal category_type As String, ByVal client_model_id_hold As String, ByVal jetnet_model_id_hold As String, ByVal search_text As String, ByVal subset As String, ByVal year_start As String, ByVal year_end As String, ByVal internal As String, ByVal awaiting As String) As DataTable
    Dim dalTable As New DataTable
    Dim atemptable As New DataTable
    Dim returntable As New DataTable
    Dim dataSet As DataSet = New DataSet("dataSet")
    dataSet.Tables.Add(atemptable)
    dataSet.Tables.Add(dalTable)
    dataSet.EnforceConstraints = False
    Dim andQ As String = ""
    Dim transaction_category As Array = Split(category_type, "|")
    Dim jetnet_transaction_category As String = ""
    Dim client_transaction_category As String = ""

    If UBound(transaction_category) = 1 Then
      jetnet_transaction_category = transaction_category(1)
      client_transaction_category = transaction_category(0)
    End If

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing

    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try

      'Building the datatable by hand because no matter what - I can't get the schema to drop and ignore the primaries
      'Added to consider the transaction column a date 7/20/11
      atemptable.Columns.Add(New DataColumn("trans_date", GetType(Date)))

      Dim trans_airframe_total_hours As DataColumn = atemptable.Columns.Add("trans_airframe_total_hours", Type.GetType("System.Int32"))
      trans_airframe_total_hours.AllowDBNull = True

      'atemptable.Columns.Add("trans_date")
      atemptable.Columns.Add("trans_ser_nbr")
      atemptable.Columns.Add("trans_reg_nbr")
      atemptable.Columns.Add("trans_subject")
      atemptable.Columns.Add("trans_date_listed")
      atemptable.Columns.Add("jetnet_trans_id")
      atemptable.Columns.Add("trans_amod_id")
      atemptable.Columns.Add("trans_exclusive_flag")
      atemptable.Columns.Add("trans_asking_wordage")
      atemptable.Columns.Add("trans_asking_price")
      'atemptable.Columns.Add("trans_airframe_total_hours")
      atemptable.Columns.Add("trans_ac_id")
      atemptable.Columns.Add("jetnet_trans_ac_id")
      atemptable.Columns.Add("trans_id")
      atemptable.Columns.Add("tcat_type")
      atemptable.Columns.Add("trans_year_mfr")
      atemptable.Columns.Add("source")
      atemptable.Columns.Add("contact_type")
      atemptable.Columns.Add("contact_type_id")
      atemptable.Columns.Add("comp_id")
      atemptable.Columns.Add("contact_id")
      atemptable.Columns.Add("clitrans_deal_type")
      atemptable.Columns.Add("clitrans_est_price")
      atemptable.Columns.Add("clitrans_sold_price")
      atemptable.Columns.Add("clitrans_sold_price_type")
      atemptable.Columns.Add("amod_make_name")
      atemptable.Columns.Add("amod_model_name")

      'Company Information
      atemptable.Columns.Add("tcomp_name")
      atemptable.Columns.Add("tcomp_address1")
      atemptable.Columns.Add("tcomp_address2")
      atemptable.Columns.Add("tcomp_city")
      atemptable.Columns.Add("tcomp_state")
      atemptable.Columns.Add("tcomp_country")
      atemptable.Columns.Add("tcomp_zip_code")
      atemptable.Columns.Add("tcomp_email_address")
      atemptable.Columns.Add("tcomp_web_address")

      ''Contact Information
      atemptable.Columns.Add("tcontact_first_name")
      atemptable.Columns.Add("tcontact_last_name")
      atemptable.Columns.Add("tcontact_middle_initial")
      atemptable.Columns.Add("tcontact_preferred_name")
      atemptable.Columns.Add("tcontact_title")
      atemptable.Columns.Add("tcontact_email_address")
      atemptable.Columns.Add("tcontact_notes")
      'subset = "J"
      If subset = "J" Or subset = "JC" Then
        Dim sql_JETNET_Transaction As String = ""

        sql_JETNET_Transaction = "SELECT distinct journ_date as trans_date, aircraft.ac_ser_no_full as trans_ser_nbr, aircraft.ac_reg_no as trans_reg_nbr, "
        sql_JETNET_Transaction = sql_JETNET_Transaction & " amod_make_name, amod_model_name, journ_subject as trans_subject, "
        sql_JETNET_Transaction = sql_JETNET_Transaction & " ac_list_date as trans_date_listed, journ_id as jetnet_trans_id, "
        sql_JETNET_Transaction = sql_JETNET_Transaction & " amod_id as trans_amod_id, ac_exclusive_flag as trans_exclusive_flag, "
        sql_JETNET_Transaction = sql_JETNET_Transaction & " ac_asking as trans_asking_wordage, ac_asking_price as trans_asking_price, "

        sql_JETNET_Transaction = sql_JETNET_Transaction & " ac_airframe_tot_hrs as trans_airframe_total_hours, ac_id as trans_ac_id, "
        sql_JETNET_Transaction = sql_JETNET_Transaction & " journ_id as trans_id, jcat_category_name as tcat_type, "
        sql_JETNET_Transaction = sql_JETNET_Transaction & " ac_mfr_year as trans_year_mfr, "
        sql_JETNET_Transaction = sql_JETNET_Transaction & " 'JETNET' AS source, cref_contact_type AS contact_type_id, "
        sql_JETNET_Transaction = sql_JETNET_Transaction & "  actype_name as contact_type, cref_comp_id AS comp_id, "
        sql_JETNET_Transaction = sql_JETNET_Transaction & "cref_contact_id AS contact_id, '' as clitrans_deal_type,'0' as clitrans_est_price "


        If HttpContext.Current.Session.Item("localSubscription").crmSalesPriceIndex_Flag = True Then
          sql_JETNET_Transaction = sql_JETNET_Transaction & add_in_case_for_ac_sale_price("clitrans_sold_price")
        Else
          sql_JETNET_Transaction = sql_JETNET_Transaction & ", '0' as clitrans_sold_price "
        End If



        sql_JETNET_Transaction = sql_JETNET_Transaction & ", '' as clitrans_sold_price_type, "
        sql_JETNET_Transaction = sql_JETNET_Transaction & " comp_name as tcomp_name, comp_address1 as tcomp_address1, comp_address2 as tcomp_address2, "
        sql_JETNET_Transaction = sql_JETNET_Transaction & " comp_city as tcomp_city, "
        sql_JETNET_Transaction = sql_JETNET_Transaction & " comp_state as tcomp_state, comp_country as tcomp_country, comp_zip_code as tcomp_zip_code, "
        sql_JETNET_Transaction = sql_JETNET_Transaction & " comp_email_address as tcomp_email_address, comp_web_address as tcomp_web_address, "
        sql_JETNET_Transaction = sql_JETNET_Transaction & "contact_first_name as tcontact_first_name, contact_last_name as tcontact_last_name, "
        sql_JETNET_Transaction = sql_JETNET_Transaction & " contact_middle_initial as tcontact_middle_initial, '' as tcontact_preferred_name, "
        sql_JETNET_Transaction = sql_JETNET_Transaction & " contact_title as tcontact_title, contact_email_address as tcontact_email_address, '' as tcontact_notes"

        sql_JETNET_Transaction = sql_JETNET_Transaction & " FROM journal with (NOLOCK) INNER JOIN journal_category with (NOLOCK) ON journal.journ_subcategory_code = journal_category.jcat_subcategory_code  "
        sql_JETNET_Transaction = sql_JETNET_Transaction & " inner join aircraft_reference with (NOLOCK) ON journal.journ_id = aircraft_reference.cref_journ_id and journ_ac_id = aircraft_reference.cref_ac_id  "

        sql_JETNET_Transaction = sql_JETNET_Transaction & " inner join aircraft with (NOLOCK) on aircraft_reference.cref_ac_id = ac_id and ac_journ_id = cref_journ_id  "
        sql_JETNET_Transaction = sql_JETNET_Transaction & " inner join aircraft_contact_type with (NOLOCK) on actype_code = cref_contact_type  "
        sql_JETNET_Transaction = sql_JETNET_Transaction & " inner join aircraft_model with (NOLOCK) on amod_id = ac_amod_id  "

        sql_JETNET_Transaction = sql_JETNET_Transaction & " inner join company with (NOLOCK) on aircraft_reference.cref_comp_id = comp_id and comp_journ_id = cref_journ_id  "
        sql_JETNET_Transaction = sql_JETNET_Transaction & " left outer join contact with (NOLOCK) on cref_contact_id = contact_id and contact_journ_id = cref_journ_id and contact_hide_flag='N' and contact_active_flag='Y'  "
        sql_JETNET_Transaction = sql_JETNET_Transaction & " WHERE "
        sql_JETNET_Transaction = sql_JETNET_Transaction



        Dim sql_JETNET_WHERE_Transaction As String = ""


        '%Awaiting Documentation’

        If awaiting = "Y" Then
          sql_JETNET_WHERE_Transaction = sql_JETNET_WHERE_Transaction & andQ & " journ_subject like '%Awaiting Documentation' "
        End If

        If internal <> "" Then
          If sql_JETNET_WHERE_Transaction <> "" Then
            andQ = " and "
          Else
            andQ = ""
          End If
          sql_JETNET_WHERE_Transaction = sql_JETNET_WHERE_Transaction & andQ & " journ_internal_trans_flag = '" & internal & "' "
        End If

        If year_start <> "" Then
          If sql_JETNET_WHERE_Transaction <> "" Then
            andQ = " and "
          Else
            andQ = ""
          End If
          sql_JETNET_WHERE_Transaction = sql_JETNET_WHERE_Transaction & andQ & " ac_mfr_year >= '" & year_start & "' "
        End If

        If year_end <> "" Then
          If sql_JETNET_WHERE_Transaction <> "" Then
            andQ = " and "
          Else
            andQ = ""
          End If
          sql_JETNET_WHERE_Transaction = sql_JETNET_WHERE_Transaction & andQ & " ac_mfr_year <= '" & year_end & "' "
        End If

        If start_date <> "" Then
          If sql_JETNET_WHERE_Transaction <> "" Then
            andQ = " and "
          Else
            andQ = ""
          End If
          sql_JETNET_WHERE_Transaction = sql_JETNET_WHERE_Transaction & andQ & " (journal.journ_date >= '" & start_date & "') "
        End If
        If end_date <> "" Then
          If sql_JETNET_WHERE_Transaction <> "" Then
            andQ = " and "
          Else
            andQ = ""
          End If
          sql_JETNET_WHERE_Transaction = sql_JETNET_WHERE_Transaction & andQ & " (journal.journ_date <= '" & end_date & "')"
        End If
        If jetnet_transaction_category <> "" Then
          If sql_JETNET_WHERE_Transaction <> "" Then
            andQ = " and "
          Else
            andQ = ""
          End If
          sql_JETNET_WHERE_Transaction = sql_JETNET_WHERE_Transaction & andQ & " (journ_subcat_code_part1  = '" & jetnet_transaction_category & "') "
        End If

        If jetnet_model_id_hold <> "" Then
          If sql_JETNET_WHERE_Transaction <> "" Then
            andQ = " and "
          Else
            andQ = ""
          End If
          sql_JETNET_WHERE_Transaction = sql_JETNET_WHERE_Transaction & andQ & " amod_id in(" & jetnet_model_id_hold & ") "
        End If

        If search_text <> "" Then
          If sql_JETNET_WHERE_Transaction <> "" Then
            andQ = " and "
          Else
            andQ = ""
          End If
          If search_text <> "%" And search_text <> "%%" Then
            sql_JETNET_WHERE_Transaction = sql_JETNET_WHERE_Transaction & andQ & " ( journ_subject like '" & search_text & "' or ac_ser_no_full like '" & search_text & "' or ac_reg_no like '" & search_text & "' )"
          End If
        End If


        sql_JETNET_WHERE_Transaction = sql_JETNET_WHERE_Transaction & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(HttpContext.Current.Session.Item("localSubscription"), False, True)



        sql_JETNET_WHERE_Transaction = sql_JETNET_WHERE_Transaction & " ORDER BY journ_id asc"



        SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
        SqlConn.Open()
        SqlCommand.Connection = SqlConn

        Dim sql As String = sql_JETNET_Transaction & sql_JETNET_WHERE_Transaction
        SqlCommand.CommandText = sql

        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Transaction_Search(ByVal start_date As String, ByVal end_date As String, ByVal category_type As String, ByVal client_model_id_hold As String, ByVal jetnet_model_id_hold As String, ByVal search_text As String, ByVal subset As String, ByVal year_start As String, ByVal year_end As String, ByVal internal As String, ByVal awaiting As String) As DataTable <em>Jetnet Side</em></b><br />" & sql

        SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
        SqlCommand.CommandType = CommandType.Text
        SqlCommand.CommandTimeout = 120
        dataSet.EnforceConstraints = False

        While SqlReader.Read()
          Dim newCustomersRow As DataRow = atemptable.NewRow()
          newCustomersRow("trans_date") = SqlReader.Item("trans_date")
          newCustomersRow("trans_ser_nbr") = SqlReader.Item("trans_ser_nbr")
          newCustomersRow("trans_reg_nbr") = SqlReader.Item("trans_reg_nbr")
          newCustomersRow("trans_subject") = SqlReader.Item("trans_subject")
          newCustomersRow("trans_date_listed") = SqlReader.Item("trans_date_listed")
          newCustomersRow("jetnet_trans_id") = SqlReader.Item("jetnet_trans_id")
          newCustomersRow("trans_amod_id") = SqlReader.Item("trans_amod_id")
          newCustomersRow("trans_exclusive_flag") = SqlReader.Item("trans_exclusive_flag")
          newCustomersRow("trans_asking_wordage") = SqlReader.Item("trans_asking_wordage")
          newCustomersRow("trans_asking_price") = SqlReader.Item("trans_asking_price")
          newCustomersRow("trans_airframe_total_hours") = SqlReader.Item("trans_airframe_total_hours")
          newCustomersRow("trans_ac_id") = SqlReader.Item("trans_ac_id")
          newCustomersRow("trans_id") = SqlReader.Item("trans_id")
          newCustomersRow("tcat_type") = SqlReader.Item("tcat_type")
          newCustomersRow("trans_year_mfr") = SqlReader.Item("trans_year_mfr")
          newCustomersRow("source") = SqlReader.Item("source")
          newCustomersRow("contact_type") = SqlReader.Item("contact_type")
          newCustomersRow("contact_type_id") = SqlReader.Item("contact_type_id")

          newCustomersRow("jetnet_trans_ac_id") = SqlReader.Item("trans_ac_id")

          newCustomersRow("comp_id") = SqlReader.Item("comp_id")
          newCustomersRow("contact_id") = SqlReader.Item("contact_id")
          newCustomersRow("clitrans_deal_type") = SqlReader.Item("clitrans_deal_type")
          newCustomersRow("clitrans_est_price") = SqlReader.Item("clitrans_est_price")
          newCustomersRow("clitrans_sold_price") = SqlReader.Item("clitrans_sold_price")
          newCustomersRow("clitrans_sold_price_type") = SqlReader.Item("clitrans_sold_price_type")
          newCustomersRow("amod_make_name") = SqlReader.Item("amod_make_name")
          newCustomersRow("amod_model_name") = SqlReader.Item("amod_model_name")

          'Company Information
          newCustomersRow("tcomp_name") = SqlReader.Item("tcomp_name")
          newCustomersRow("tcomp_address1") = SqlReader.Item("tcomp_address1")
          newCustomersRow("tcomp_address2") = SqlReader.Item("tcomp_address2")
          newCustomersRow("tcomp_city") = SqlReader.Item("tcomp_city")
          newCustomersRow("tcomp_state") = SqlReader.Item("tcomp_state")
          newCustomersRow("tcomp_country") = SqlReader.Item("tcomp_country")
          newCustomersRow("tcomp_zip_code") = SqlReader.Item("tcomp_zip_code")
          newCustomersRow("tcomp_email_address") = SqlReader.Item("tcomp_email_address")
          newCustomersRow("tcomp_web_address") = SqlReader.Item("tcomp_web_address")

          ''Contact Information
          newCustomersRow("tcontact_first_name") = SqlReader.Item("tcontact_first_name")
          newCustomersRow("tcontact_last_name") = SqlReader.Item("tcontact_last_name")
          newCustomersRow("tcontact_middle_initial") = SqlReader.Item("tcontact_middle_initial")
          newCustomersRow("tcontact_preferred_name") = SqlReader.Item("tcontact_preferred_name")
          newCustomersRow("tcontact_title") = SqlReader.Item("tcontact_title")
          newCustomersRow("tcontact_email_address") = SqlReader.Item("tcontact_email_address")
          newCustomersRow("tcontact_notes") = SqlReader.Item("tcontact_notes")


          atemptable.Rows.Add(newCustomersRow)
          atemptable.AcceptChanges()
        End While
        SqlReader.Close()
        SqlReader = Nothing


        dataSet.EnforceConstraints = False

        Dim count As Integer = atemptable.Rows.Count
      End If
      If subset = "C" Or subset = "JC" Then
        Dim sql_client_transaction As String = ""
        sql_client_transaction = "SELECT distinct client_transactions.clitrans_date AS trans_date, clitrans_jetnet_ac_id, cliamod_make_name as amod_make_name, cliamod_model_name as amod_model_name,client_transactions.clitrans_ser_nbr AS trans_ser_nbr, client_transactions.clitrans_reg_nbr AS trans_reg_nbr, "
        sql_client_transaction = sql_client_transaction & " client_transactions.clitrans_subject AS trans_subject, client_transactions.clitrans_date_listed AS trans_date_listed, "
        sql_client_transaction = sql_client_transaction & " client_transactions.clitrans_cliamod_id AS trans_amod_id, client_transactions.clitrans_exclusive_flag AS trans_exclusive_flag, "
        sql_client_transaction = sql_client_transaction & " client_transactions.clitrans_asking_wordage AS trans_asking_wordage, client_transactions.clitrans_asking_price AS trans_asking_price, "
        sql_client_transaction = sql_client_transaction & " client_transactions.clitrans_airframe_total_hours AS trans_airframe_total_hours, client_transactions.clitrans_cliac_id AS trans_ac_id, "
        sql_client_transaction = sql_client_transaction & " client_transactions.clitrans_id AS trans_id, client_transactions.clitrans_est_price, client_transactions.clitrans_sold_price,"
        sql_client_transaction = sql_client_transaction & " client_transactions.clitrans_sold_price_type, 'CLIENT' AS source,  client_transactions.clitrans_jetnet_trans_id as jetnet_trans_id, "
        sql_client_transaction = sql_client_transaction & " client_transactions.clitrans_year_mfr AS trans_year_mfr, client_transactions_aircraft_reference.clitcref_contact_type AS contact_type_id, cliact_name as contact_type, "
        sql_client_transaction = sql_client_transaction & " client_transactions_aircraft_reference.clitcref_client_comp_id AS comp_id, client_transactions_aircraft_reference.clitcref_client_contact_id AS contact_id, "
        sql_client_transaction = sql_client_transaction & " client_aircraft_contact_type.cliact_name AS act_name, client_transactions.clitrans_deal_type, client_transactions.clitrans_type as tcat_type, "

        sql_client_transaction = sql_client_transaction & "clitcomp_name as tcomp_name, clitcomp_address1 as tcomp_address1, clitcomp_address2 as tcomp_address2, clitcomp_city as tcomp_city, clitcomp_state as tcomp_state, clitcomp_country as tcomp_country, clitcomp_zip_code as tcomp_zip_code, clitcomp_email_address as tcomp_email_address, clitcomp_web_address as tcomp_web_address, "
        sql_client_transaction = sql_client_transaction & "clitcontact_first_name as tcontact_first_name, clitcontact_last_name as tcontact_last_name, clitcontact_middle_initial as tcontact_middle_initial, '' as tcontact_preferred_name, clitcontact_title as tcontact_title, clitcontact_email_address as tcontact_email_address, '' as tcontact_notes"

        sql_client_transaction = sql_client_transaction & " FROM client_transactions "
        sql_client_transaction = sql_client_transaction & " left outer join  client_transactions_aircraft_reference ON clitrans_id = clitcref_client_trans_id "
        sql_client_transaction = sql_client_transaction & " left outer join  client_aircraft_contact_type ON clitcref_contact_type = client_aircraft_contact_type.cliact_type "
        sql_client_transaction = sql_client_transaction & " inner join client_aircraft_model on client_aircraft_model.cliamod_id = clitrans_cliamod_id  "
        sql_client_transaction = sql_client_transaction & " left outer join client_transactions_company on clitcref_client_comp_id = client_transactions_company.clitcomp_id "
        sql_client_transaction = sql_client_transaction & " and clitcref_client_trans_id = clitcomp_trans_id  "
        sql_client_transaction = sql_client_transaction & " left outer join client_transactions_contact on clitcref_client_contact_id = client_transactions_contact.clitcontact_id "
        sql_client_transaction = sql_client_transaction & " and clitcref_client_trans_id = clitcontact_trans_id where "


        andQ = ""
        Dim sql_Client_WHERE_Transaction As String = ""

        If awaiting = "Y" Then
          If sql_Client_WHERE_Transaction <> "" Then
            andQ = " and "
          Else
            andQ = ""
          End If
          sql_Client_WHERE_Transaction = sql_Client_WHERE_Transaction & andQ & " clitrans_subject like '%Awaiting Documentation' "
        End If



        If internal <> "" Then
          If sql_Client_WHERE_Transaction <> "" Then
            andQ = " and "
          Else
            andQ = ""
          End If
          sql_Client_WHERE_Transaction = sql_Client_WHERE_Transaction & andQ & " clitrans_internal_trans_flag = '" & internal & "' "
        End If


        If year_start <> "" Then
          If sql_Client_WHERE_Transaction <> "" Then
            andQ = " and "
          Else
            andQ = ""
          End If
          sql_Client_WHERE_Transaction = sql_Client_WHERE_Transaction & andQ & " client_transactions.clitrans_year_mfr >= '" & year_start & "' "
        End If

        If year_end <> "" Then
          If sql_Client_WHERE_Transaction <> "" Then
            andQ = " and "
          Else
            andQ = ""
          End If
          sql_Client_WHERE_Transaction = sql_Client_WHERE_Transaction & andQ & " client_transactions.clitrans_year_mfr <= '" & year_end & "' "
        End If



        If start_date <> "" Then
          If sql_Client_WHERE_Transaction <> "" Then
            andQ = " and "
          Else
            andQ = ""
          End If
          sql_Client_WHERE_Transaction = sql_Client_WHERE_Transaction & andQ & " (client_transactions.clitrans_date >= """ & start_date & """) "
        End If
        If end_date <> "" Then
          If sql_Client_WHERE_Transaction <> "" Then
            andQ = " and "
          Else
            andQ = ""
          End If
          sql_Client_WHERE_Transaction = sql_Client_WHERE_Transaction & andQ & " (client_transactions.clitrans_date <= """ & end_date & """)"
        End If
        If client_transaction_category <> "" Then
          If sql_Client_WHERE_Transaction <> "" Then
            andQ = " and "
          Else
            andQ = ""
          End If
          sql_Client_WHERE_Transaction = sql_Client_WHERE_Transaction & andQ & " (client_transactions.clitrans_type = '" & client_transaction_category & "') "
        End If

        If client_model_id_hold <> "" Then
          If sql_Client_WHERE_Transaction <> "" Then
            andQ = " and "
          Else
            andQ = ""
          End If
          sql_Client_WHERE_Transaction = sql_Client_WHERE_Transaction & andQ & " clitrans_cliamod_id in(" & client_model_id_hold & ") "
        End If

        If search_text <> "" Then
          If sql_Client_WHERE_Transaction <> "" Then
            andQ = " and "
          Else
            andQ = ""
          End If
          If search_text <> "%" Then
            sql_Client_WHERE_Transaction = sql_Client_WHERE_Transaction & andQ & " (clitrans_subject like '" & search_text & "' or clitrans_ser_nbr like '" & search_text & "' or clitrans_reg_nbr like '" & search_text & "')"
          End If
        End If

        sql_Client_WHERE_Transaction = sql_Client_WHERE_Transaction & " ORDER BY client_transactions.clitrans_id asc"


        MySqlConn.ConnectionString = Me.client_DB
        MySqlConn.Open()
        MySqlCommand.Connection = MySqlConn
        MySqlCommand.CommandType = CommandType.Text
        MySqlCommand.CommandTimeout = 60

        Dim sQuery As String = sql_client_transaction & sql_Client_WHERE_Transaction
        MySqlCommand.CommandText = sQuery

        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Transaction_Search(ByVal start_date As String, ByVal end_date As String, ByVal category_type As String, ByVal client_model_id_hold As String, ByVal jetnet_model_id_hold As String, ByVal search_text As String, ByVal subset As String, ByVal year_start As String, ByVal year_end As String, ByVal internal As String, ByVal awaiting As String) As DataTable <em>Jetnet Side</em></b><br />" & sQuery

        MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

        While MySqlReader.Read()
          Dim newCustomersRow As DataRow = atemptable.NewRow()
          newCustomersRow("trans_date") = MySqlReader.Item("trans_date")
          newCustomersRow("trans_ser_nbr") = MySqlReader.Item("trans_ser_nbr")
          newCustomersRow("trans_reg_nbr") = MySqlReader.Item("trans_reg_nbr")
          newCustomersRow("trans_subject") = MySqlReader.Item("trans_subject")
          newCustomersRow("trans_date_listed") = MySqlReader.Item("trans_date_listed")
          newCustomersRow("jetnet_trans_id") = MySqlReader.Item("jetnet_trans_id")
          newCustomersRow("trans_amod_id") = MySqlReader.Item("trans_amod_id")
          newCustomersRow("trans_exclusive_flag") = MySqlReader.Item("trans_exclusive_flag")
          newCustomersRow("trans_asking_wordage") = MySqlReader.Item("trans_asking_wordage")
          newCustomersRow("trans_asking_price") = MySqlReader.Item("trans_asking_price")
          newCustomersRow("trans_airframe_total_hours") = MySqlReader.Item("trans_airframe_total_hours")

          newCustomersRow("trans_ac_id") = MySqlReader.Item("trans_ac_id")
          newCustomersRow("source") = MySqlReader.Item("source")
          newCustomersRow("jetnet_trans_ac_id") = MySqlReader.Item("clitrans_jetnet_ac_id")


          newCustomersRow("trans_id") = MySqlReader.Item("trans_id")
          newCustomersRow("tcat_type") = MySqlReader.Item("tcat_type")
          newCustomersRow("trans_year_mfr") = MySqlReader.Item("trans_year_mfr")

          newCustomersRow("contact_type") = MySqlReader.Item("contact_type")
          newCustomersRow("contact_type_id") = MySqlReader.Item("contact_type_id")

          newCustomersRow("comp_id") = MySqlReader.Item("comp_id")
          newCustomersRow("contact_id") = MySqlReader.Item("contact_id")
          newCustomersRow("clitrans_deal_type") = MySqlReader.Item("clitrans_deal_type")
          newCustomersRow("clitrans_est_price") = MySqlReader.Item("clitrans_est_price")
          newCustomersRow("clitrans_sold_price") = MySqlReader.Item("clitrans_sold_price")
          newCustomersRow("clitrans_sold_price_type") = MySqlReader.Item("clitrans_sold_price_type")
          newCustomersRow("amod_make_name") = MySqlReader.Item("amod_make_name")
          newCustomersRow("amod_model_name") = MySqlReader.Item("amod_model_name")

          'Company Information
          newCustomersRow("tcomp_name") = MySqlReader.Item("tcomp_name")
          newCustomersRow("tcomp_address1") = MySqlReader.Item("tcomp_address1")
          newCustomersRow("tcomp_address2") = MySqlReader.Item("tcomp_address2")
          newCustomersRow("tcomp_city") = MySqlReader.Item("tcomp_city")
          newCustomersRow("tcomp_state") = MySqlReader.Item("tcomp_state")
          newCustomersRow("tcomp_country") = MySqlReader.Item("tcomp_country")
          newCustomersRow("tcomp_zip_code") = MySqlReader.Item("tcomp_zip_code")
          newCustomersRow("tcomp_email_address") = MySqlReader.Item("tcomp_email_address")
          newCustomersRow("tcomp_web_address") = MySqlReader.Item("tcomp_web_address")

          ''Contact Information
          newCustomersRow("tcontact_first_name") = MySqlReader.Item("tcontact_first_name")
          newCustomersRow("tcontact_last_name") = MySqlReader.Item("tcontact_last_name")
          newCustomersRow("tcontact_middle_initial") = MySqlReader.Item("tcontact_middle_initial")
          newCustomersRow("tcontact_preferred_name") = MySqlReader.Item("tcontact_preferred_name")
          newCustomersRow("tcontact_title") = MySqlReader.Item("tcontact_title")
          newCustomersRow("tcontact_email_address") = MySqlReader.Item("tcontact_email_address")
          newCustomersRow("tcontact_notes") = MySqlReader.Item("tcontact_notes")

          atemptable.Rows.Add(newCustomersRow)
          atemptable.AcceptChanges()
        End While
        MySqlReader.Close()
        MySqlReader = Nothing


        dataSet.EnforceConstraints = False
      End If
      Dim row As DataRow

      returntable.PrimaryKey = Nothing
      returntable.Constraints.Clear()

      'setting up return table rows
      'Added to consider the transaction column a date 7/20/11
      returntable.Columns.Add(New DataColumn("trans_date", GetType(Date)))
      'returnTable.Columns.Add("trans_date")
      returntable.Columns.Add("trans_ser_nbr")
      returntable.Columns.Add("trans_reg_nbr")
      returntable.Columns.Add("comp_id")
      returntable.Columns.Add("contact_id")
      returntable.Columns.Add("trans_subject")
      returntable.Columns.Add("trans_date_listed")
      returntable.Columns.Add("trans_exclusive_flag")
      returntable.Columns.Add("trans_asking_wordage")
      returntable.Columns.Add("trans_asking_price")
      returntable.Columns.Add("trans_airframe_total_hours")
      returntable.Columns.Add("trans_ac_id")
      returntable.Columns.Add("jetnet_trans_ac_id")

      returntable.Columns.Add("source")
      returntable.Columns.Add("clitrans_est_price")
      returntable.Columns.Add("clitrans_sold_price")
      returntable.Columns.Add("clitrans_sold_price_type")
      returntable.Columns.Add("trans_amod_id")
      returntable.Columns.Add("contact_type")

      returntable.Columns.Add("contact_type_id")
      returntable.Columns.Add("jetnet_trans_id")
      returntable.Columns.Add("trans_year_mfr")
      returntable.Columns.Add("trans_id")
      returntable.Columns.Add("clitrans_deal_type")
      returntable.Columns.Add("amod_make_name")
      returntable.Columns.Add("amod_model_name")

      'Company Information
      returntable.Columns.Add("tcomp_name")
      returntable.Columns.Add("tcomp_address1")
      returntable.Columns.Add("tcomp_address2")
      returntable.Columns.Add("tcomp_city")
      returntable.Columns.Add("tcomp_state")
      returntable.Columns.Add("tcomp_country")
      returntable.Columns.Add("tcomp_zip_code")
      returntable.Columns.Add("tcomp_email_address")
      returntable.Columns.Add("tcomp_web_address")

      ''Contact Information
      returntable.Columns.Add("tcontact_first_name")
      returntable.Columns.Add("tcontact_last_name")
      returntable.Columns.Add("tcontact_middle_initial")
      returntable.Columns.Add("tcontact_preferred_name")
      returntable.Columns.Add("tcontact_title")
      returntable.Columns.Add("tcontact_email_address")
      returntable.Columns.Add("tcontact_notes")

      ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''


      If Not IsNothing(atemptable) Then
        If atemptable.Rows.Count > 0 Then
          Dim comp_id As String = ""
          Dim cont_id As String = ""
          Dim cont_type As String = ""
          Dim cont_type_id As String = ""
          Dim counted As Integer = atemptable.Rows.Count
          Dim next_trans As Integer = 0
          Dim b As Integer = 1
          Dim old_trans_id As Integer = 0
          Dim name As String = ""
          Dim address As String = ""
          Dim address2 As String = ""
          Dim city As String = ""
          Dim state As String = ""
          Dim country As String = ""
          Dim zip As String = ""
          Dim email As String = ""
          Dim web As String = ""

          Dim first As String = ""
          Dim last As String = ""
          Dim middle As String = ""
          Dim title As String = ""
          Dim pref As String = ""
          Dim cemail As String = ""
          Dim Notes As String = ""

          For Each q As DataRow In atemptable.Rows
            Dim transit As Integer = q("trans_id")
            Dim com As String = IIf(Not IsDBNull(q("comp_id")), q("comp_id"), "0")

            row = returntable.NewRow
            If b <> counted Then
              next_trans = q("trans_id")
            Else
              next_trans = 0
            End If
            If b = 1 Then
              old_trans_id = q("trans_id")
            End If
            If b <> counted Then
              next_trans = atemptable.Rows(b).Item("trans_id")
            Else
              next_trans = 0
            End If


            row("amod_make_name") = q("amod_make_name")
            row("amod_model_name") = q("amod_model_name")
            row("trans_year_mfr") = q("trans_year_mfr")
            row("trans_id") = q("trans_id")
            row("trans_year_mfr") = q("trans_year_mfr")
            comp_id = comp_id & q("comp_id") & "|"
            cont_id = cont_id & q("contact_id") & "|"
            row("clitrans_deal_type") = q("clitrans_deal_type")
            row("trans_date") = q("trans_date")
            row("trans_ser_nbr") = q("trans_ser_nbr")
            row("trans_reg_nbr") = q("trans_reg_nbr")
            row("trans_subject") = q("trans_subject")
            row("trans_date_listed") = q("trans_date_listed")
            row("trans_exclusive_flag") = q("trans_exclusive_flag")
            row("trans_asking_wordage") = q("trans_asking_wordage")
            row("trans_asking_price") = q("trans_asking_price")
            row("trans_airframe_total_hours") = q("trans_airframe_total_hours")
            row("trans_ac_id") = q("trans_ac_id")
            row("jetnet_trans_ac_id") = q("jetnet_trans_ac_id")

            row("source") = q("source")
            cont_type = cont_type & q("contact_type") & "|"
            cont_type_id = cont_type_id & q("contact_type_id") & "|"
            row("clitrans_est_price") = q("clitrans_est_price")
            row("clitrans_sold_price") = q("clitrans_sold_price")
            row("clitrans_sold_price_type") = q("clitrans_sold_price_type")
            row("trans_amod_id") = q("trans_amod_id")
            row("jetnet_trans_id") = q("jetnet_trans_id")



            name = name & q("tcomp_name") & "|"
            address = address & q("tcomp_address1") & "|"
            address2 = address2 & q("tcomp_address2") & "|"
            city = city & q("tcomp_city") & "|"
            state = state & q("tcomp_state") & "|"
            country = country & q("tcomp_country") & "|"
            zip = zip & q("tcomp_zip_code") & "|"
            email = email & q("tcomp_email_address") & "|"
            web = web & q("tcomp_web_address") & "|"

            first = first & q("tcontact_first_name") & "|"
            last = last & q("tcontact_last_name") & "|"
            middle = middle & q("tcontact_middle_initial") & "|"
            title = title & q("tcontact_title") & "|"
            pref = pref & q("tcontact_preferred_name") & "|"
            cemail = cemail & q("tcontact_email_address") & "|"
            Notes = Notes & q("tcontact_notes") & "|"




            If next_trans <> transit Then
              row("contact_id") = cont_id
              row("comp_id") = comp_id
              row("contact_type") = cont_type
              row("contact_type_id") = cont_type_id
              'Company information
              row("tcomp_name") = name
              row("tcomp_address1") = address
              row("tcomp_address2") = address2
              row("tcomp_city") = city
              row("tcomp_state") = state
              row("tcomp_country") = country
              row("tcomp_zip_code") = zip
              row("tcomp_email_address") = email
              row("tcomp_web_address") = web

              'contact information
              row("tcontact_first_name") = first
              row("tcontact_last_name") = last
              row("tcontact_middle_initial") = middle
              row("tcontact_title") = title
              row("tcontact_preferred_name") = pref
              row("tcontact_notes") = Notes
              row("tcontact_email_address") = cemail

              returntable.Rows.Add(row)
              returntable.AcceptChanges()
              cont_id = ""
              comp_id = ""
              cont_type = ""
              cont_type_id = ""
              name = ""
              address = ""
              address2 = ""
              city = ""
              state = ""
              country = ""
              zip = ""
              email = ""
              web = ""

              first = ""
              last = ""
              middle = ""
              title = ""
              pref = ""
              cemail = ""
              Notes = ""
            ElseIf b = counted Then
              returntable.Rows.Add(row)
              returntable.AcceptChanges()
            Else
              Dim test As Integer = q("comp_id")
            End If
            b = b + 1
          Next

        End If

        dalTable = returntable.Clone
        dataSet.EnforceConstraints = False
        dalTable.PrimaryKey = Nothing
        dalTable.Constraints.Clear()


        Dim afiltered As DataRow() = returntable.Select("", "trans_date desc, jetnet_trans_id")
        ' extract and import
        For Each atmpDataRow_Client In afiltered
          dalTable.ImportRow(atmpDataRow_Client)
        Next

      End If

      Return dalTable
      dalTable = Nothing
      atemptable = Nothing
      returntable = Nothing
    Finally

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing


      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_JETNET_Transactions_Aircraft_Reference_TransID
  ' Purpose: to get all the JETNET transaction Aircraft Reference Records
  ' Parameters: tacref_trans_id
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/10/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_JETNET_Transactions_Aircraft_Reference_TransID(ByVal tacref_trans_id As Long) As DataTable
    Dim aTempTable As New DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Try


      sql = "SELECT cref_id as tacref_id, cref_ac_id as tacref_ac_id, cref_journ_id as tacref_trans_id, cref_comp_id as tacref_comp_id, cref_contact_id as tacref_contact_id, "
      sql = sql & " cref_contact_type as tacref_contact_type, cref_owner_percent as tacref_owner_percentage, cref_fraction_expires_date as tacref_date_fraction_expires, "
      sql = sql & " cref_business_type as tacref_business_type, cref_operator_flag as tacref_operator_flag"
      sql = sql & " FROM aircraft_reference WITH(NOLOCK) "
      sql = sql & " WHERE cref_journ_id = '" & tacref_trans_id & "'"


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable
    Catch ex As Exception
      Get_JETNET_Transactions_Aircraft_Reference_TransID = Nothing
      Me.class_error = "Error in Get_JETNET_Transactions_Aircraft_Reference_TransID(ByVal tacref_trans_id As Integer) As DataTable: SQL VERSION " & ex.Message

    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try


  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_JETNET_Transactions_Company
  ' Purpose: to get all the JETNET transaction company Records
  ' Parameters: tacref_comp_id
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/10/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_JETNET_Transactions_Company(ByVal tacref_comp_id As Long, ByVal tacref_trans_id As Long) As DataTable
    Dim aTempTable As New DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Try


      sql = "SELECT comp_id as tcomp_id, comp_journ_id as tcomp_trans_id, comp_name as tcomp_name, "
      sql = sql & " comp_name_alt_type as tcomp_alternate_name_type,comp_name_alt as tcomp_alternate_name, "
      sql = sql & " comp_address1 as tcomp_address1, comp_address2 as tcomp_address2, comp_city as tcomp_city, "
      sql = sql & " comp_state as tcomp_state,comp_zip_code as tcomp_zip_code, comp_country as tcomp_country, "
      sql = sql & " comp_agency_type as tcomp_agency_type, comp_web_address as tcomp_web_address, "
      sql = sql & " comp_email_address as tcomp_email_address, comp_action_date as tcomp_action_date"
      sql = sql & " FROM company  WITH(NOLOCK) "
      sql = sql & " WHERE comp_id = '" & tacref_comp_id & "' And comp_journ_id = '" & tacref_trans_id & "'"

      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable
    Catch ex As Exception
      Get_JETNET_Transactions_Company = Nothing
      Me.class_error = "Error in Get_JETNET_Transactions_Company(ByVal tacref_comp_id As Integer, ByVal tacref_trans_id As Integer) As DataTable: SQL VERSION " & ex.Message

    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try


  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_JETNET_Transactions_PhoneNbrs_contactID
  ' Purpose: to get all the JETNET transaction phone number Records
  ' Parameters: tpnum_contact_id
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/10/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_JETNET_Transactions_PhoneNbrs_contactID(ByVal tpnum_contact_id As Long, ByVal tpnum_trans_id As Long) As DataTable
    Dim aTempTable As New DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Try


      sql = "SELECT pnum_comp_id AS tpnum_comp_id, pnum_contact_id AS tpnum_contact_id, "
      sql = sql & " pnum_journ_id AS tpnum_trans_id, pnum_type as tpnum_type, pnum_number as tpnum_number"
      sql = sql & " FROM phone_numbers WITH(NOLOCK) "
      sql = sql & " WHERE (pnum_contact_id = '" & tpnum_contact_id & "' And pnum_JOURN_id = '" & tpnum_trans_id & "')"


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)


      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable
    Catch ex As Exception
      Get_JETNET_Transactions_PhoneNbrs_contactID = Nothing
      Me.class_error = "Error in Get_JETNET_Transactions_PhoneNbrs_contactID(ByVal tpnum_contact_id As Integer, ByVal tpnum_trans_id As Integer) As DataTable: SQL VERSION " & ex.Message

    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try


  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_JETNET_Transactions_PhoneNbrs_compID
  ' Purpose: to get all the JETNET transaction phone number Records
  ' Parameters: tpnum_contact_id
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/13/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_JETNET_Transactions_PhoneNbrs_compID(ByVal tpnum_comp_id As Long, ByVal tpnum_trans_id As Long) As DataTable
    '      SELECT        tpnum_comp_id, tpnum_contact_id, tpnum_trans_id, tpnum_type, tpnum_number
    'FROM            transactions_phone_numbers
    'WHERE  tpnum_comp_id = @tpnum_comp_id AND  tpnum_trans_id = @tpnum_trans_id
    Dim aTempTable As New DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Try


      sql = "SELECT pnum_comp_id AS tpnum_comp_id, pnum_contact_id AS tpnum_contact_id, "
      sql = sql & " pnum_journ_id AS tpnum_trans_id, pnum_type as tpnum_type, pnum_number as tpnum_number"
      sql = sql & " FROM phone_numbers WITH(NOLOCK) "
      sql = sql & " WHERE (pnum_comp_id = '" & tpnum_comp_id & "' And pnum_JOURN_id = '" & tpnum_trans_id & "')"

      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)


      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable
    Catch ex As Exception
      Get_JETNET_Transactions_PhoneNbrs_compID = Nothing
      Me.class_error = "Error in Get_JETNET_Transactions_PhoneNbrs_compID(ByVal tpnum_contact_id As Integer, ByVal tpnum_trans_id As Integer) As DataTable: SQL VERSION " & ex.Message

    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try


  End Function

  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_JETNET_Transactions_transID
  ' Purpose: to get jetnets transaction info
  ' Parameters: trans_id
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/13/2010    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_JETNET_Transactions_transID(ByVal trans_id As Long) As DataTable
    Dim aTempTable As New DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Try


      sql = "SELECT ac_id AS journ_ac_id, ac_action_date AS journ_action_date, ac_airframe_tot_hrs AS ac_airframe_tot_hrs, "
      sql = sql & " ac_airframe_tot_landings AS ac_airframe_tot_landings, ac_amod_id AS ac_amod_id, ac_aport_city AS ac_aport_city, "
      sql = sql & " ac_aport_country AS ac_aport_country, ac_aport_iata_code AS ac_aport_iata_code, ac_aport_icao_code AS ac_aport_icao_code, "
      sql = sql & " ac_aport_name AS ac_aport_name, ac_aport_private AS ac_aport_private, ac_aport_state AS ac_aport_state, "
      sql = sql & " ac_asking_price AS ac_asking_price, ac_asking AS ac_asking, ac_country_of_registration AS ac_country_of_registration, "
      sql = sql & " journ_customer_note AS journ_customer_note, journ_date AS journ_date, ac_list_date AS ac_list_date"
      If HttpContext.Current.Session.Item("localSubscription").crmSalesPriceIndex_Flag = True Then
        sql = sql & add_in_case_for_ac_sale_price()
      Else
        sql = sql & ",  0 as ac_sale_price "
      End If

      sql = sql & ",  ac_sale_price_display_flag, "
      sql = sql & " ac_exclusive_flag AS ac_exclusive_flag, journ_id AS journ_id, journ_internal_trans_flag AS journ_internal_trans_flag, "
      sql = sql & " ac_lifecycle_stage AS ac_lifecycle_stage, journ_newac_flag AS journ_newac_flag, ac_ownership_type AS ac_ownership_type, "
      sql = sql & " ac_reg_no AS ac_reg_no, ac_ser_no_full AS ac_ser_no_full, journ_subcategory_code AS journ_subcategory_code, "
      sql = sql & " journ_subject AS journ_subject, ac_mfr_year as trans_year_mfr, journ_subcat_code_part1, journ_subcat_code_part2, journ_subcat_code_part3"
      sql = sql & " FROM aircraft WITH(NOLOCK) inner join journal WITH(NOLOCK) on ac_id = journ_ac_id and ac_journ_id = journ_id "
      sql = sql & " WHERE (journ_id = '" & trans_id & "')"

      sql = sql & " ORDER BY ac_action_date"

      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable
    Catch ex As Exception
      Get_JETNET_Transactions_transID = Nothing
      Me.class_error = "Error in Get_JETNET_Transactions_transID(ByVal trans_id As Integer) As DataTable: SQL VERSION " & ex.Message

    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try


  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_JETNET_Transactions_Contact_compID
  ' Purpose: to get all the JETNET transaction contact Records
  ' Parameters: tcontact_trans_id
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/13/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_JETNET_Transactions_Contact_compID(ByVal tcontact_comp_id As Integer, ByVal tcontact_trans_id As Integer) As DataTable
    Dim aTempTable As New DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Try

      sql = "SELECT contact_id as tcontact_id, contact_journ_id as tcontact_trans_id, contact_comp_id as tcontact_comp_id, "
      sql = sql & " contact_sirname as tcontact_sirname, contact_first_name as tcontact_first_name, "
      sql = sql & " contact_middle_initial as tcontact_middle_initial, contact_last_name as tcontact_last_name, "
      sql = sql & " contact_suffix as tcontact_suffix, contact_title as tcontact_title, "
      sql = sql & " contact_email_address as tcontact_email_address, contact_action_date as tcontact_action_date"
      sql = sql & " FROM contact WITH(NOLOCK)  "
      sql = sql & " WHERE contact_comp_id = '" & tcontact_comp_id & "' AND contact_journ_id = '" & tcontact_trans_id & "' "

      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable
    Catch ex As Exception
      Get_JETNET_Transactions_Contact_compID = Nothing
      Me.class_error = "Error in Get_JETNET_Transactions_Contact_compID(ByVal tcontact_comp_id As Integer, ByVal tcontact_trans_id As Integer) As DataTable: SQL VERSION " & ex.Message

    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try


  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_JETNET_Transactions_Contact_ContactID
  ' Purpose: to get all the JETNET transaction contact Records
  ' Parameters: tcontact_trans_id
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/13/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_JETNET_Transactions_Contact_ContactID(ByVal tcontact_id As Integer, ByVal trans_id As Integer) As DataTable
    Dim aTempTable As New DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Try

      sql = "SELECT contact_id as tcontact_id, contact_journ_id as tcontact_trans_id, contact_comp_id as tcontact_comp_id, "
      sql = sql & " contact_sirname as tcontact_sirname, "
      sql = sql & " contact_first_name as tcontact_first_name, contact_middle_initial as tcontact_middle_initial, "
      sql = sql & " contact_last_name as tcontact_last_name, contact_suffix as tcontact_suffix, contact_title as tcontact_title, "
      sql = sql & " contact_email_address as tcontact_email_address, contact_action_date as tcontact_action_date"
      sql = sql & " FROM contact WITH(NOLOCK) "
      sql = sql & " WHERE  contact_id = '" & tcontact_id & "' and contact_journ_id = '" & trans_id & "' and contact_hide_flag='N' and contact_active_flag = 'Y' "

      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)


      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable
    Catch ex As Exception
      Get_JETNET_Transactions_Contact_ContactID = Nothing
      Me.class_error = "Error in Get_JETNET_Transactions_Contact_ContactID(ByVal tcontact_id As Integer) As DataTable: SQL VERSION " & ex.Message

    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function
  Public Function Get_JETNET_TransactionDocuments(ByVal acID As Long, ByVal journalID As Long, ByVal seqNo As Integer) As DataTable
    Dim aTempTable As New DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Try

      sql = "SELECT adoc_doc_date, journ_subject, adoc_onbehalf_comp_id, adoc_onbehalf_text, adoc_infavor_comp_id, adoc_infavor_text,"
      sql &= " adoc_general_note, adoc_journ_seq_no, adoc_doc_type, adoc_journ_id, adoc_hide_flag, doctype_subdir_name, doctype_file_extension"
      sql &= " FROM Aircraft_Document WITH(NOLOCK) INNER JOIN Document_Type WITH(NOLOCK) ON (doctype_description = adoc_doc_type)"
      sql &= " INNER JOIN Journal WITH(NOLOCK) ON adoc_journ_id = journ_id"
      sql &= " WHERE adoc_ac_id = " & acID & " AND adoc_journ_id = " & journalID
      sql &= " and doctype_subdir_name <> 'COMPANY' "

      If seqNo > 0 Then
        sql &= " AND adoc_journ_seq_no = " & seqNo
      End If

      sql &= " ORDER BY adoc_journ_seq_no"

      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)


      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable
    Catch ex As Exception
      Get_JETNET_TransactionDocuments = Nothing
      Me.class_error = "Error in Get_JETNET_TransactionDocuments(ByVal acID As Long, ByVal journalID As Long, ByVal seqNo As Integer) As DataTable: SQL VERSION " & ex.Message

    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function

#End Region
#Region "Wanted(s)"
  ''' <summary>
  ''' This returns Wanted AC for the company display page and the wanteds search. 
  ''' </summary>
  ''' <param name="compID"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Return_Wanted(ByVal compID As Long, ByVal companySource As String, ByVal otherID As Long, ByVal amodID As String, ByVal start_date As String, ByVal end_date As String, ByVal company_name As String, ByVal subset As String, ByVal JournalID As Long) As DataTable
    Dim sql As String = ""
    Dim sqlwhere As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader
    Dim afileterd As DataRow()
    Dim Return_Table As New DataTable

    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim jetnet_ID As Integer = 0
    Dim client_ID As Integer = 0
    Dim andQ As String
    atemptable.Columns.Add("source")
    atemptable.Columns.Add("lnote_id")
    'atemptable.Columns.Add("amwant_listed_date")

    Dim amwant_listed_date As DataColumn = atemptable.Columns.Add("amwant_listed_date", Type.GetType("System.DateTime"))
    amwant_listed_date.AllowDBNull = True
    atemptable.Columns.Add("amwant_amod_id")
    atemptable.Columns.Add("amod_make_name")
    atemptable.Columns.Add("comp_name")
    atemptable.Columns.Add("comp_id")
    atemptable.Columns.Add("amod_model_name")
    atemptable.Columns.Add("amwant_notes")
    atemptable.Columns.Add("amwant_start_year")
    atemptable.Columns.Add("amwant_end_year")
    atemptable.Columns.Add("amwant_max_price")
    atemptable.Columns.Add("amwant_max_aftt")
    atemptable.Columns.Add("contact_first_name")
    atemptable.Columns.Add("contact_last_name")
    atemptable.Columns.Add("contact_id")
    atemptable.Columns.Add("amwant_accept_dam_cur")
    atemptable.Columns.Add("amwant_accept_damage_hist")

    If companySource = "CLIENT" Then
      client_ID = compID
      jetnet_ID = otherID
    Else
      jetnet_ID = compID
      client_ID = otherID
    End If

    If jetnet_ID <> 0 And client_ID = 0 Then
      subset = "J"
    End If
    If client_ID <> 0 And jetnet_ID = 0 Then
      subset = "C"
    End If


    Try
      If HttpContext.Current.Session.Item("localUser").crmEvo = True Then
        subset = "J"
      End If


      If subset = "J" Or subset = "JC" Then
        sql = ""
        sql = "select amwant_listed_date, amwant_accept_damage_hist, amwant_accept_dam_cur, amwant_amod_id, amod_make_name, comp_name, comp_id, amod_model_name, amwant_notes, amwant_start_year, amwant_end_year, "
        sql = sql & "amwant_max_price, amwant_max_aftt, contact_first_name, contact_last_name, contact_id, 'JETNET' as source "
        sql = sql & "from aircraft_model_wanted WITH(NOLOCK) "
        sql = sql & " inner join company WITH(NOLOCK) on amwant_comp_id = comp_id and amwant_journ_id = comp_journ_id "
        sql = sql & " left outer join contact WITH(NOLOCK) on amwant_contact_id = contact_id and amwant_journ_id = contact_journ_id and contact_hide_flag='N' "
        sql = sql & " inner join aircraft_model WITH(NOLOCK) on amwant_amod_id = amod_id "
        sql = sql & "where "

        sqlwhere = " amwant_journ_id = " & JournalID & " "

        sqlwhere = sqlwhere & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(HttpContext.Current.Session.Item("localSubscription"), False, False)


        If jetnet_ID <> 0 Then
          If sqlwhere <> "" Then
            andQ = " and "
          Else
            andQ = ""
          End If
          sqlwhere = sqlwhere & andQ & " amwant_comp_id = " & jetnet_ID
        End If

        If company_name <> "" Then
          If sqlwhere <> "" Then
            andQ = " and "
          Else
            andQ = ""
          End If
          sqlwhere = sqlwhere & andQ & " (comp_name like '%" & company_name & "%') "
        End If

        If start_date <> "" Then
          If sqlwhere <> "" Then
            andQ = " and "
          Else
            andQ = ""
          End If
          sqlwhere = sqlwhere & andQ & " (amwant_listed_date >= '" & start_date & "') "
        End If
        If end_date <> "" Then
          If sqlwhere <> "" Then
            andQ = " and "
          Else
            andQ = ""
          End If
          sqlwhere = sqlwhere & andQ & " (amwant_listed_date <= '" & end_date & "')"
        End If


        If amodID <> "" Then
          If sqlwhere <> "" Then
            andQ = " and "
          Else
            andQ = ""
          End If
          sqlwhere = sqlwhere & andQ & " amwant_amod_id in (" & amodID & ") "
        End If

        HttpContext.Current.Session.Item("MasterAircraftWantedWhere") = sqlwhere

        sql = sql & sqlwhere & " order by amwant_listed_date desc"

        SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
        SqlConn.Open()
        SqlCommand.Connection = SqlConn


        SqlCommand.CommandText = sql

        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Return_Wanted(ByVal compID As Long, ByVal companySource As String, ByVal otherID As Long, ByVal amodID As String, ByVal start_date As String, ByVal end_date As String, ByVal company_name As String, ByVal subset As String, JournalID As long) As DataTable <em>Jetnet Side</em></b><br />" & sql

        SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
        SqlCommand.CommandType = CommandType.Text
        SqlCommand.CommandTimeout = 60

        'SqlReader = Nothing

        While SqlReader.Read()
          Dim newCustomersRow As DataRow = atemptable.NewRow()
          newCustomersRow("source") = SqlReader.Item("source")
          newCustomersRow("amwant_listed_date") = SqlReader.Item("amwant_listed_date")
          newCustomersRow("amod_make_name") = SqlReader.Item("amod_make_name")
          newCustomersRow("lnote_id") = 0
          newCustomersRow("comp_name") = SqlReader.Item("comp_name")
          newCustomersRow("comp_id") = SqlReader.Item("comp_id")
          newCustomersRow("amod_model_name") = SqlReader.Item("amod_model_name")
          newCustomersRow("amwant_notes") = SqlReader.Item("amwant_notes")
          newCustomersRow("amwant_amod_id") = SqlReader.Item("amwant_amod_id")

          newCustomersRow("amwant_start_year") = SqlReader.Item("amwant_start_year")
          newCustomersRow("amwant_end_year") = SqlReader.Item("amwant_end_year")
          newCustomersRow("amwant_max_price") = SqlReader.Item("amwant_max_price")
          newCustomersRow("amwant_max_aftt") = SqlReader.Item("amwant_max_aftt")

          newCustomersRow("contact_first_name") = SqlReader.Item("contact_first_name")
          newCustomersRow("contact_last_name") = SqlReader.Item("contact_last_name")
          newCustomersRow("contact_id") = SqlReader.Item("contact_id")

          newCustomersRow("amwant_accept_dam_cur") = SqlReader.Item("amwant_accept_dam_cur")
          newCustomersRow("amwant_accept_damage_hist") = SqlReader.Item("amwant_accept_damage_hist")



          atemptable.Rows.Add(newCustomersRow)
          atemptable.AcceptChanges()
        End While

      End If
      If subset = "C" Or subset = "JC" Then
        sql = ""
        sql = "select lnote_id, '' as amwant_accept_dam_cur, '' as amwant_accept_damage_hist, clicomp_name as comp_name, clicomp_id as comp_id, lnote_wanted_start_year as amwant_start_year, lnote_wanted_end_year as amwant_end_year, "
        sql = sql & " lnote_wanted_max_price as amwant_max_price, lnote_wanted_max_aftt as amwant_max_aftt, "
        sql = sql & " lnote_schedule_start_date as amwant_listed_date, cliamod_make_name as amod_make_name, "
        sql = sql & " cliamod_model_name as amod_model_name, lnote_client_amod_id as amwant_amod_id, lnote_note as amwant_notes, 'CLIENT' as source, "
        sql = sql & " clicontact_first_name as contact_first_name, clicontact_last_name as contact_last_name, "
        sql = sql & " clicontact_id as contact_id  "
        sql = sql & " from local_notes "
        sql = sql & " inner join client_company on lnote_client_comp_id = clicomp_id "
        sql = sql & " left outer join client_contact on lnote_client_contact_id = clicontact_id "
        sql = sql & " left outer join client_aircraft_model on lnote_client_amod_id = cliamod_id "
        sql = sql & "where "

        sqlwhere = " lnote_status = 'W' "


        If jetnet_ID <> 0 Then
          If sqlwhere <> "" Then
            andQ = " and "
          Else
            andQ = ""
          End If
          sqlwhere = sqlwhere & andQ & " lnote_jetnet_comp_id = " & jetnet_ID
        End If

        If client_ID <> 0 Then
          If sqlwhere <> "" Then
            andQ = " and "
          Else
            andQ = ""
          End If
          sqlwhere = sqlwhere & andQ & " lnote_client_comp_id = " & client_ID
        End If


        If start_date <> "" Then
          If sqlwhere <> "" Then
            andQ = " and "
          Else
            andQ = ""
          End If
          sqlwhere = sqlwhere & andQ & " (lnote_schedule_start_date >= '" & start_date & "') "
        End If
        If end_date <> "" Then
          If sqlwhere <> "" Then
            andQ = " and "
          Else
            andQ = ""
          End If
          sqlwhere = sqlwhere & andQ & " (lnote_schedule_start_date <= '" & end_date & "')"
        End If

        If company_name <> "" Then
          If sqlwhere <> "" Then
            andQ = " and "
          Else
            andQ = ""
          End If
          sqlwhere = sqlwhere & andQ & " (clicomp_name like '%" & company_name & "%') "
        End If

        If amodID <> "" Then
          If sqlwhere <> "" Then
            andQ = " and "
          Else
            andQ = ""
          End If
          sqlwhere = sqlwhere & andQ & " lnote_jetnet_amod_id in (" & amodID & ") "
        End If

        sql = sql & sqlwhere

        MySqlConn.ConnectionString = Me.client_DB
        MySqlConn.Open()
        MySqlCommand.Connection = MySqlConn
        MySqlCommand.CommandType = CommandType.Text
        MySqlCommand.CommandTimeout = 60
        MySqlCommand.CommandText = sql

        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Return_Wanted(ByVal compID As Long, ByVal companySource As String, ByVal otherID As Long, ByVal amodID As String, ByVal start_date As String, ByVal end_date As String, ByVal company_name As String, ByVal subset As String, JournalID As long) As DataTabl <em>Client Side</em></b><br />" & sql

        MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

        While MySqlReader.Read()
          Dim newCustomersRow As DataRow = atemptable.NewRow()
          newCustomersRow("source") = MySqlReader.Item("source")
          newCustomersRow("amwant_listed_date") = MySqlReader.Item("amwant_listed_date")
          newCustomersRow("amod_make_name") = MySqlReader.Item("amod_make_name")
          newCustomersRow("lnote_id") = MySqlReader.Item("lnote_id")
          newCustomersRow("comp_name") = MySqlReader.Item("comp_name")
          newCustomersRow("comp_id") = MySqlReader.Item("comp_id")
          newCustomersRow("amod_model_name") = MySqlReader.Item("amod_model_name")
          newCustomersRow("amwant_notes") = MySqlReader.Item("amwant_notes")
          newCustomersRow("amwant_amod_id") = MySqlReader.Item("amwant_amod_id")

          newCustomersRow("amwant_start_year") = MySqlReader.Item("amwant_start_year")
          newCustomersRow("amwant_end_year") = MySqlReader.Item("amwant_end_year")
          newCustomersRow("amwant_max_price") = MySqlReader.Item("amwant_max_price")
          newCustomersRow("amwant_max_aftt") = MySqlReader.Item("amwant_max_aftt")

          newCustomersRow("contact_first_name") = MySqlReader.Item("contact_first_name")
          newCustomersRow("contact_last_name") = MySqlReader.Item("contact_last_name")
          newCustomersRow("contact_id") = MySqlReader.Item("contact_id")

          newCustomersRow("amwant_accept_dam_cur") = MySqlReader.Item("amwant_accept_dam_cur")
          newCustomersRow("amwant_accept_damage_hist") = MySqlReader.Item("amwant_accept_damage_hist")

          atemptable.Rows.Add(newCustomersRow)
          atemptable.AcceptChanges()
        End While
      End If


      Return_Table = atemptable.Clone

      atemptable = atemptable
      afileterd = atemptable.Select("", "amwant_listed_date desc")
      atemptable = atemptable

      'a single data row for importing to the dalTable
      'extract and import
      For Each atmpDataRow In afileterd
        Return_Table.ImportRow(atmpDataRow)
      Next

      Return Return_Table

    Catch ex As Exception
      Return_Wanted = Nothing
      Me.class_error = "Error in Return_Wanted(ByVal compID As Long, ByVal companySource As String, ByVal otherID As Long, ByVal amodID As String, ByVal start_date As String, ByVal end_date As String, ByVal company_name As String, ByVal subset As String, JournalID As long): SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing
      'atemptable = Nothing
      SqlConn.Dispose()
      MySqlConn.Dispose()
      SqlConn.Close()
      MySqlConn.Close()
      SqlConn = Nothing
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      SqlCommand.Dispose()
      MySqlCommand = Nothing
      SqlCommand = Nothing
    End Try


    Return_Table = Nothing
    atemptable = Nothing
  End Function

  Public Function Return_Wanted_Evo(ByVal compID As Long, ByVal companySource As String, ByVal otherID As Long, ByVal amodID As String, ByVal start_date As String, ByVal end_date As String, ByVal company_name As String, ByVal subset As String, ByVal JournalID As Long, ByVal PageSort As String, ByVal MakeString As String, ByVal ModelType As String, ByVal AirframeType As String, ByVal WeightClass As String, ByVal WantedIDs As String, ByVal Business As Boolean, ByVal Commercial As Boolean, ByVal Helicopter As Boolean) As DataTable
    Dim sql As String = ""
    Dim sqlwhere As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable


    'Dim afileterd As DataRow()
    'Dim Return_Table As New DataTable

    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim jetnet_ID As Integer = 0
    Dim client_ID As Integer = 0
    Dim andQ As String
    atemptable.Columns.Add("source")
    atemptable.Columns.Add("lnote_id")
    'atemptable.Columns.Add("amwant_listed_date")

    Dim amwant_listed_date As DataColumn = atemptable.Columns.Add("amwant_listed_date", Type.GetType("System.DateTime"))
    amwant_listed_date.AllowDBNull = True
    atemptable.Columns.Add("amwant_amod_id")
    atemptable.Columns.Add("amod_make_name")
    atemptable.Columns.Add("comp_name")
    atemptable.Columns.Add("comp_id")
    atemptable.Columns.Add("amod_model_name")
    atemptable.Columns.Add("amwant_notes")
    atemptable.Columns.Add("amwant_start_year")
    atemptable.Columns.Add("amwant_end_year")
    atemptable.Columns.Add("amwant_max_price")
    atemptable.Columns.Add("amwant_max_aftt")
    atemptable.Columns.Add("contact_first_name")
    atemptable.Columns.Add("contact_last_name")
    atemptable.Columns.Add("contact_id")
    atemptable.Columns.Add("amwant_id")
    atemptable.Columns.Add("amwant_accept_dam_cur")
    atemptable.Columns.Add("amwant_accept_damage_hist")
    If companySource = "CLIENT" Then
      client_ID = compID
      jetnet_ID = otherID
    Else
      jetnet_ID = compID
      client_ID = otherID
    End If

    If jetnet_ID <> 0 And client_ID = 0 Then
      subset = "J"
    End If
    If client_ID <> 0 And jetnet_ID = 0 Then
      subset = "C"
    End If

    HttpContext.Current.Session.Item("MasterWanted") = "" 'Whole Search
    HttpContext.Current.Session.Item("MasterAircraftWantedFrom") = "" 'Where only
    HttpContext.Current.Session.Item("MasterAircraftWantedWhere") = "" 'From Only

    Try
      If HttpContext.Current.Session.Item("localUser").crmEvo = True Then
        subset = "J"
      End If


      If subset = "J" Or subset = "JC" Then
        sql = ""
        sql = "select amwant_listed_date, amwant_accept_damage_hist, amwant_accept_dam_cur,  amwant_id,amwant_amod_id, amod_make_name, view_aircraft_model_wanted.comp_name, view_aircraft_model_wanted.comp_id, amod_model_name, amwant_notes, amwant_start_year, amwant_end_year,"
        sql = sql & " amwant_max_price, amwant_max_aftt, contact_first_name, contact_last_name, contact_id, 'JETNET' AS source, comp_product_helicopter_flag, comp_product_business_flag, comp_product_commercial_flag"
        sql = sql & " FROM view_aircraft_model_wanted WITH(NOLOCK) INNER JOIN company WITH(NOLOCK) ON view_aircraft_model_wanted.comp_id = company.comp_id AND company.comp_journ_id = 0"
        sql = sql & "  "

        HttpContext.Current.Session.Item("MasterAircraftWantedFrom") = " FROM view_aircraft_model_wanted WITH(NOLOCK) INNER JOIN company WITH(NOLOCK) ON view_aircraft_model_wanted.comp_id = company.comp_id AND company.comp_journ_id = 0"

        sql = sql & " WHERE "

        sqlwhere = " amwant_journ_id = " & JournalID & " AND (amwant_verified_date IS NOT NULL) "


        If jetnet_ID <> 0 Then
          If sqlwhere <> "" Then
            andQ = " and "
          Else
            andQ = ""
          End If
          sqlwhere = sqlwhere & andQ & " amwant_comp_id = " & jetnet_ID
        End If


        If WeightClass <> "" Then
          If sqlwhere <> "" Then
            andQ = " and "
          Else
            andQ = ""
          End If
          sqlwhere = sqlwhere & andQ & " (amod_weight_class = '" & WeightClass & "') "
        End If

        If WantedIDs <> "" Then
          If sqlwhere <> "" Then
            andQ = " and "
          Else
            andQ = ""
          End If
          sqlwhere = sqlwhere & andQ & " (amwant_id in (" & WantedIDs & ")) "
        End If

        If company_name <> "" Then
          If sqlwhere <> "" Then
            andQ = " and "
          Else
            andQ = ""
          End If
          sqlwhere = sqlwhere & andQ & " (comp_name like '%" & company_name & "%') "
        End If

        If start_date <> "" Then
          If sqlwhere <> "" Then
            andQ = " and "
          Else
            andQ = ""
          End If
          sqlwhere = sqlwhere & andQ & " (amwant_listed_date >= '" & start_date & "') "
        End If

        If end_date <> "" Then
          If sqlwhere <> "" Then
            andQ = " and "
          Else
            andQ = ""
          End If
          sqlwhere = sqlwhere & andQ & " (amwant_listed_date <= '" & end_date & "')"
        End If


        If amodID <> "" Then
          If sqlwhere <> "" Then
            sqlwhere += " and "
          End If
          sqlwhere += " amwant_amod_id in (" & amodID & ") "
        Else
          If ModelType <> "" Then
            If sqlwhere <> "" Then
              sqlwhere += " and "
            End If
            sqlwhere += " amod_type_code in (" & ModelType & ")"
          End If

          If AirframeType <> "" Then
            If sqlwhere <> "" Then
              sqlwhere += " and "
            End If
            sqlwhere += " amod_airframe_type_code in (" & AirframeType & ")"
          End If

          If MakeString <> "" Then
            If sqlwhere <> "" Then
              sqlwhere += " and "
            End If
            sqlwhere += " amod_make_name in (" & MakeString & ")"
          End If

        End If

        ''Setting up the filtering
        Dim HoldClsSubscription As New crmSubscriptionClass

        HoldClsSubscription.crmAerodexFlag = HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag
        HoldClsSubscription.crmBusiness_Flag = Business
        HoldClsSubscription.crmCommercial_Flag = Commercial
        HoldClsSubscription.crmHelicopter_Flag = Helicopter
        HoldClsSubscription.crmJets_Flag = HttpContext.Current.Session.Item("localSubscription").crmJets_Flag
        HoldClsSubscription.crmTurboprops = HttpContext.Current.Session.Item("localSubscription").crmTurboprops
        HoldClsSubscription.crmExecutive_Flag = HttpContext.Current.Session.Item("localSubscription").crmExecutive_Flag


        sqlwhere += " " + clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(HoldClsSubscription, False, False)

        sqlwhere += " " + commonEvo.MakeCompanyProductCodeClause(HttpContext.Current.Session.Item("localPreferences"), False)


        HttpContext.Current.Session.Item("MasterAircraftWantedWhere") = sqlwhere

        sql = sql & sqlwhere & " order by "
        If PageSort = "" Then
          sql = sql & " amwant_listed_date desc"
        Else
          sql = sql & PageSort & " asc"
        End If

        SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
        SqlConn.Open()
        SqlCommand.Connection = SqlConn
        SqlCommand.CommandType = CommandType.Text
        SqlCommand.CommandTimeout = 60

        SqlCommand.CommandText = sql

        'Setting the WHOLE QUERY in a session variable
        'This will be used on the Folder Maintenance Page to save the query:
        HttpContext.Current.Session.Item("MasterWanted") = sql
        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Return_Wanted_Evo(ByVal compID As Long, ByVal companySource As String, ByVal otherID As Long, ByVal amodID As String, ByVal start_date As String, ByVal end_date As String, ByVal company_name As String, ByVal subset As String, JournalID As long) As DataTabl <em>Jetnet Side</em></b><br />" & sql

        SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

        Do While SqlReader.Read()

          Dim newCustomersRow As DataRow = atemptable.NewRow()
          newCustomersRow("source") = SqlReader.Item("source")
          newCustomersRow("amwant_amod_id") = SqlReader.Item("amwant_amod_id")

          newCustomersRow("amwant_listed_date") = SqlReader.Item("amwant_listed_date")
          newCustomersRow("amod_make_name") = SqlReader.Item("amod_make_name")
          newCustomersRow("lnote_id") = 0
          newCustomersRow("comp_name") = SqlReader.Item("comp_name")
          newCustomersRow("comp_id") = SqlReader.Item("comp_id")
          newCustomersRow("amod_model_name") = SqlReader.Item("amod_model_name")
          newCustomersRow("amwant_notes") = SqlReader.Item("amwant_notes")

          newCustomersRow("amwant_start_year") = SqlReader.Item("amwant_start_year")
          newCustomersRow("amwant_end_year") = SqlReader.Item("amwant_end_year")
          newCustomersRow("amwant_max_price") = SqlReader.Item("amwant_max_price")
          newCustomersRow("amwant_max_aftt") = SqlReader.Item("amwant_max_aftt")

          newCustomersRow("contact_first_name") = SqlReader.Item("contact_first_name")
          newCustomersRow("contact_last_name") = SqlReader.Item("contact_last_name")
          newCustomersRow("contact_id") = SqlReader.Item("contact_id")
          newCustomersRow("amwant_id") = SqlReader.Item("amwant_id")
          newCustomersRow("amwant_accept_dam_cur") = SqlReader.Item("amwant_accept_dam_cur")
          newCustomersRow("amwant_accept_damage_hist") = SqlReader.Item("amwant_accept_damage_hist")

          atemptable.Rows.Add(newCustomersRow)
          atemptable.AcceptChanges()

        Loop

      End If


      'Return_Table = atemptable.Clone

      'atemptable = atemptable
      'afileterd = atemptable.Select("", "amwant_listed_date desc")
      'atemptable = atemptable

      ''a single data row for importing to the dalTable
      ''extract and import
      'For Each atmpDataRow In afileterd
      '    Return_Table.ImportRow(atmpDataRow)
      'Next

      Return atemptable

    Catch ex As Exception
      Return_Wanted_Evo = Nothing
      Me.class_error = "Error in Return_Wanted_Evo(ByVal compID As Long, ByVal companySource As String, ByVal otherID As Long, ByVal amodID As String, ByVal start_date As String, ByVal end_date As String, ByVal company_name As String, ByVal subset As String, JournalID As long): SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing
      'atemptable = Nothing
      SqlConn.Dispose()

      SqlConn.Close()

      SqlConn = Nothing

      SqlCommand.Dispose()

      SqlCommand = Nothing
    End Try


    'Return_Table = Nothing
    atemptable = Nothing
  End Function

#End Region
#Region "Folders"
  ''' <summary>
  ''' Displays Folders by subscription information
  ''' </summary>
  ''' <param name="login_variable"></param>
  ''' <param name="sub_id"></param>
  ''' <param name="seqNo"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function GetEvolutionFolderssBySubscription(ByVal folderID As Long, ByVal login_variable As String, ByVal sub_id As Long, ByVal seqNo As Long, ByVal cFolder_Share As String, ByVal SpecificFolderType As Integer, ByVal SortNumber As Nullable(Of System.Int16), ByVal method As String, Optional ByVal temp_type As String = "") As DataTable
    Dim atemptable As New DataTable
    Dim sQuery As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try
      If sub_id <> 0 And login_variable <> "" And seqNo <> 0 Then
        sQuery = ""
        sQuery = "select 'JETNET' as source, cfolder_jetnet_run_flag, cfolder_operator_flag, cfolder_default_flag, cfolder_jetnet_run_reply_username, cfolder_jetnet_run_reply_email, cfolder_jetnet_run_freq_in_mins, cfttpe_name, cfolder_description, cftype_id, cfolder_data, cfolder_hide_flag, cfolder_share, cfolder_name, cfolder_id, cfolder_method,cfolder_sort"
        sQuery += ", contact_first_name, contact_last_name "
        sQuery += " from Client_Folder with (NOLOCK)"
        sQuery += " inner join Client_Folder_Type with (NOLOCK) on cfolder_cftype_id = cftype_id"
        sQuery += " LEFT OUTER JOIN Subscription_Install with (NOLOCK) on subins_sub_id = cfolder_sub_id and subins_login=cfolder_login and subins_seq_no = cfolder_seq_no "
        sQuery += " left outer join Contact with (NOLOCK) on subins_contact_id = contact_id and contact_journ_id = 0 "


        If Trim(temp_type) = "" Then
          If folderID = 0 And Not IsNumeric(SortNumber) And cFolder_Share = "" Then
            '-- 2. ADDED JOIN TO SUBSCRIPTION TABLE
            'inner join Subscription with (NOLOCK) on cfolder_sub_id=sub_id 
            sQuery += " inner join Subscription with (NOLOCK) on cfolder_sub_id=sub_id  "
          End If

          sQuery += " where (("
          If folderID = 0 Then
            sQuery += " cfolder_sub_id = " & sub_id
            sQuery += " and cfolder_login = '" & Trim(login_variable) & "'"
            sQuery += " and cfolder_seq_no = " & seqNo
          Else
            sQuery += " cfolder_id = " & folderID & " "
          End If

          If cFolder_Share <> "" Then
            sQuery += " and (cfolder_share = '" & cFolder_Share & "' or "
            'ByVal login_variable As String, ByVal sub_id As Long, ByVal seqNo As Long

            sQuery += " cfolder_sub_id = " & sub_id
            sQuery += " and cfolder_login = '" & Trim(login_variable) & "'"
            sQuery += " and cfolder_seq_no = " & seqNo
            sQuery += " ) "
          End If

          sQuery += ")"

          If folderID = 0 And Not IsNumeric(SortNumber) And cFolder_Share = "" Then
            Select Case HttpContext.Current.Session.Item("localSubscription").crmSubscriptionShareType
              Case eSubscriptionShareType.MY_PARENT_COMPANY
                '-- BLOCK 3.C - GET MY FOLDERS AND THOSE SHARED FOR MY PARENT COMPANY 
                '    where (( cfolder_sub_id = 777 and cfolder_login = 'mvintech' and cfolder_seq_no = 1) 
                ' or (sub_comp_id = 135887 and cfolder_share='Y' and sub_share_by_comp_id_flag = 'Y')) 
                sQuery += " or (sub_comp_id = " & HttpContext.Current.Session.Item("localUser").crmUserCompanyID & " and cfolder_share='Y' and sub_share_by_comp_id_flag = 'Y')"
              Case eSubscriptionShareType.MY_PARENT_SUBSCRIPTION
                ' -- BLOCK 3.B - GET MY FOLDERS AND THOSE SHARED FOR MY PARENT SUBSCRIPTION 
                '  where (( cfolder_sub_id = 777 and cfolder_login = 'mvintech' and cfolder_seq_no = 1) 
                '  or (sub_parent_sub_id = 777 and cfolder_share='Y' and sub_share_by_parent_sub_id_flag = 'Y' )) 
                sQuery += " or (sub_parent_sub_id = " & HttpContext.Current.Session.Item("localUser").crmSubParentID & " and cfolder_share='Y' and sub_share_by_parent_sub_id_flag = 'Y')"
              Case Else
                '  -- BLOCK 3.A - GET MY FOLDERS AND THOSE SHARED FOR MY SUBSCRIPTION ONLY
                '  --where (( cfolder_sub_id = 777 and cfolder_login = 'mvintech' and cfolder_seq_no = 1) 
                '  -- or (cfolder_sub_id = 777 and cfolder_share='Y')) 
                sQuery += " or (cfolder_sub_id = " & sub_id & " and cfolder_share='Y' )"
            End Select
          End If
          sQuery += ")"


          If SpecificFolderType <> 0 Then
            sQuery += " and cfolder_cftype_id = " & SpecificFolderType & " "
          End If

          If method <> "" Then
            sQuery += " and cfolder_method = '" & method & "' "
          End If


          If Not IsDBNull(SortNumber) Then
            If IsNumeric(SortNumber) Then
              sQuery += " and cfolder_sort = " & SortNumber & " "
            End If
          End If

        Else


          ' ADDED MSW - for folders 
          sQuery += " inner join Subscription with (NOLOCK) on cfolder_sub_id=sub_id  "
          sQuery += Build_Subscription_Select_String("Folders", temp_type, sub_id, Trim(login_variable), SpecificFolderType, seqNo)

          If cFolder_Share = "Y" Then
            sQuery += " and cfolder_share = 'Y' "
          Else
            sQuery += " and cfolder_share = 'N' "
          End If


        End If


        sQuery += " and not (cfolder_cftype_id = 3 And cfolder_jetnet_run_flag='Y') "



        sQuery += " order by cfolder_share desc,cfolder_sort, cfolder_name"


        clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sQuery.ToString)

        SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
        SqlConn.Open()
        SqlCommand.Connection = SqlConn


        SqlCommand.CommandText = sQuery
        SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
        SqlCommand.CommandType = CommandType.Text
        SqlCommand.CommandTimeout = 60


        Try
          atemptable.Load(SqlReader)
        Catch constrExc As System.Data.ConstraintException
          Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
        End Try
      End If
    Catch ex As Exception
      GetEvolutionFolderssBySubscription = Nothing
      Me.class_error = "Error in GetEvolutionFolderssBySubscription(ByVal login_variable As String, ByVal sub_id As Long, ByVal seqNo As Long) As DataTable " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try
    Return atemptable
  End Function

  Public Function Check_Permission_BySubscription(ByVal folderID As Long, ByVal login_variable As String, ByVal sub_id As Long, ByVal seqNo As Long, ByVal cFolder_Share As String, ByVal SpecificFolderType As Integer, ByVal SortNumber As Nullable(Of System.Int16), ByVal method As String, Optional ByVal temp_type As String = "") As DataTable
    Dim atemptable As New DataTable
    Dim sQuery As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try

      sQuery = ""
      sQuery = "select cfolder_jetnet_run_flag, cfolder_jetnet_run_reply_username, cfolder_jetnet_run_reply_email, cfolder_jetnet_run_freq_in_mins, cfttpe_name, cfolder_description, cftype_id, cfolder_data, cfolder_hide_flag, cfolder_share, cfolder_name, cfolder_id, cfolder_method,cfolder_sort"
      sQuery += ", contact_first_name, contact_last_name "
      sQuery += " from Client_Folder with (NOLOCK)"
      sQuery += " inner join Client_Folder_Type with (NOLOCK) on cfolder_cftype_id = cftype_id"
      sQuery += " LEFT OUTER JOIN Subscription_Install with (NOLOCK) on subins_sub_id = cfolder_sub_id and subins_login=cfolder_login and subins_seq_no = cfolder_seq_no "
      sQuery += " left outer join Contact with (NOLOCK) on subins_contact_id = contact_id and contact_journ_id = 0 "
      sQuery += " inner join Subscription with (NOLOCK) on cfolder_sub_id=sub_id  "

      sQuery += " where ("
      sQuery += " cfolder_sub_id = " & sub_id
      sQuery += " and cfolder_login = '" & Trim(login_variable) & "'"
      sQuery += " and cfolder_seq_no = " & seqNo
      sQuery += " and cfolder_id = " & folderID & " "
      sQuery += ")"

      sQuery += " order by cfolder_share desc,cfolder_sort, cfolder_name"


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>GetEvolutionFolderssBySubscription(ByVal login_variable As String, ByVal sub_id As Long, ByVal seqNo As Long) As DataTable</b><br />" & sQuery

      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sQuery
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

    Catch ex As Exception
      Check_Permission_BySubscription = Nothing
      Me.class_error = "Error in GetEvolutionFolderssBySubscription(ByVal login_variable As String, ByVal sub_id As Long, ByVal seqNo As Long) As DataTable " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try
    Return atemptable
  End Function
    ''' <summary>
    ''' edit an evolution folder
    ''' </summary>
    ''' <param name="cfolder_hide_flag"></param>
    ''' <param name="cfolder_name"></param>
    ''' <param name="cfolder_share"></param>
    ''' <param name="cfolder_description"></param>
    ''' <param name="cfolder_id"></param>
    ''' <param name="subID"></param>
    ''' <param name="userLogin"></param>
    ''' <param name="seqNO"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function Edit_Fields_Evolution_Folders(ByVal cfolder_data As String, ByVal cfolder_hide_flag As String, ByVal cfolder_name As String, ByVal cfolder_share As String, ByVal cfolder_description As String, ByVal cfolder_id As Integer, ByVal subID As Long, ByVal userLogin As String, ByVal seqNO As Long, ByVal cfolder_jetnet_run_flag As String, ByVal cfolder_jetnet_run_reply_username As String, ByVal cfolder_jetnet_run_reply_email As String, ByVal cfolder_jetnet_run_last_process_date As String, ByVal cfolder_jetnet_run_freq_in_mins As Long, ByVal cfolder_operator_flag As String, Optional ByVal cfolder_default As Boolean = False, Optional ByVal cfolder_schedule_run_date As String = "", Optional ByVal cfolder_schedule_type As String = "", Optional ByVal cfolder_schedule_day As String = "", Optional cfolder_schedule_hour As String = "") As Integer
        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing
        Dim sql As String = ""
        Edit_Fields_Evolution_Folders = 0
        Try
            'make sure there's a session set.
            If HttpContext.Current.Session.Item("crmUserLogon") = True Then
                If subID <> 0 And userLogin <> "" And seqNO <> 0 Then

                    If cfolder_id <> 0 Then
                        sql = " UPDATE client_folder "
                        sql = sql & " SET  cfolder_hide_flag = '" & clsGeneral.clsGeneral.StripChars(cfolder_hide_flag, False) & "', "
                        sql = sql & " cfolder_name = '" & clsGeneral.clsGeneral.PrepFolderNameForSave(cfolder_name, False) & "', "
                        sql = sql & " cfolder_share = '" & clsGeneral.clsGeneral.StripChars(cfolder_share, False) & "', "

                        If cfolder_data <> "" Then
                            sql = sql & " cfolder_data = '" & cfolder_data & "', "
                        End If

                        If cfolder_operator_flag <> "" Then
                            sql = sql & " cfolder_operator_flag = '" & IIf(cfolder_operator_flag = "Y", "Y", "N") & "', "
                        End If

                        If cfolder_jetnet_run_flag <> "" Then
                            sql = sql & " cfolder_jetnet_run_flag = '" & cfolder_jetnet_run_flag & "', "
                        End If

                        If cfolder_jetnet_run_reply_username <> "" Then
                            sql = sql & " cfolder_jetnet_run_reply_username = '" & cfolder_jetnet_run_reply_username & "', "
                        End If

                        If cfolder_jetnet_run_reply_email <> "" Then
                            sql = sql & " cfolder_jetnet_run_reply_email = '" & cfolder_jetnet_run_reply_email & "', "
                        End If

                        If cfolder_jetnet_run_last_process_date <> "" Then
                            sql = sql & " cfolder_jetnet_run_last_process_date = '" & cfolder_jetnet_run_last_process_date & "', "
                        End If

                        If cfolder_jetnet_run_freq_in_mins <> 0 Then
                            sql = sql & " cfolder_jetnet_run_freq_in_mins = " & cfolder_jetnet_run_freq_in_mins & ", "
                        End If

                        If cfolder_default Then
                            sql = sql & " cfolder_default_flag = 'Y', "
                        End If


                        ' ADDED IN MSW - 6/1/20 -------------------------------------
                        If cfolder_schedule_run_date <> "" Then
                            sql = sql & " cfolder_schedule_run_date = '" & cfolder_schedule_run_date & "', "
                        End If

                        If cfolder_schedule_type <> "" Then
                            sql = sql & " cfolder_schedule_type = '" & cfolder_schedule_type & "', "
                        End If

                        If cfolder_schedule_day <> "" Then
                            sql = sql & " cfolder_schedule_day = '" & cfolder_schedule_day & "', "
                        End If


                        If cfolder_schedule_hour <> "" Then
                            sql = sql & " cfolder_schedule_hour = '" & cfolder_schedule_hour & "', "
                        End If



                        sql = sql & " cfolder_description = '" & clsGeneral.clsGeneral.StripChars(cfolder_description, False) & "' "
                        sql = sql & " WHERE (cfolder_id = '" & cfolder_id & "')"
                        ' and cfolder_sub_id = " & subID & " and cfolder_login = '" & Trim(userLogin) & "' and cfolder_seq_no = " & seqNO & ") "
                    End If
                    'sql = sql
                    SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
                    SqlConn.Open()
                    SqlCommand.Connection = SqlConn

                    SqlCommand.CommandText = sql
                    SqlCommand.ExecuteNonQuery()

                    HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Edit_Fields_Evolution_Folders(ByVal cfolder_hide_flag As String, ByVal cfolder_name As String, ByVal cfolder_share As String, ByVal cfolder_description As String, ByVal cfolder_id As Integer, ByVal subID As Long, ByVal userLogin As String, ByVal seqNO As Long) As Integer</b><br />" & sql


                    Edit_Fields_Evolution_Folders = 1
                    sql = ""
                End If
            End If

        Catch ex As Exception
            Edit_Fields_Evolution_Folders = 0
            Me.class_error = "Error in Edit_Fields_Evolution_Folders(ByVal cfolder_hide_flag As String, ByVal cfolder_name As String, ByVal cfolder_share As String, ByVal cfolder_description As String, ByVal cfolder_id As Integer, ByVal subID As Long, ByVal userLogin As String, ByVal seqNO As Long) As Integer " & ex.Message
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function


    ''' <summary>
    ''' This inserts parameters into the Evolution Folders Table
    ''' </summary>
    ''' <param name="cfolder_cftype_id"></param>
    ''' <param name="cfolder_hide_flag"></param>
    ''' <param name="cfolder_name"></param>
    ''' <param name="cfolder_share"></param>
    ''' <param name="cfolder_method"></param>
    ''' <param name="cfolder_description"></param>
    ''' <param name="cfolder_data"></param>
    ''' <param name="subID"></param>
    ''' <param name="userLogin"></param>
    ''' <param name="seqNO"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function Insert_Into_Evolution_Folders(ByVal cfolder_cftype_id As Integer, ByVal cfolder_hide_flag As String, ByVal cfolder_name As String, ByVal cfolder_share As String, ByVal cfolder_method As String, ByVal cfolder_description As String, ByVal cfolder_data As String, ByVal subID As Long, ByVal userLogin As String, ByVal seqNO As Long, ByVal cfolder_jetnet_run_flag As String, ByVal cfolder_jetnet_run_reply_username As String, ByVal cfolder_jetnet_run_reply_email As String, ByVal cfolder_jetnet_run_last_process_date As String, ByVal cfolder_jetnet_run_freq_in_mins As Long, ByVal cfolder_operator_flag As String, Optional ByVal cfolder_default As Boolean = False, Optional ByVal cfolder_schedule_run_date As String = "", Optional ByVal cfolder_schedule_type As String = "", Optional ByVal cfolder_schedule_day As String = "", Optional cfolder_schedule_hour As String = "") As Integer
        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing
        Dim strInsert As String = ""
        Dim NewFolderID As Long = 0
        Try
            'make sure there's a session set.
            If HttpContext.Current.Session.Item("crmUserLogon") = True Then
                If subID <> 0 And userLogin <> "" And seqNO <> 0 Then


                    strInsert = "INSERT INTO Client_Folder (cfolder_operator_flag, cfolder_cftype_id,cfolder_hide_flag, cfolder_name, cfolder_share, cfolder_method, cfolder_description, cfolder_data, cfolder_sub_id, cfolder_login, cfolder_seq_no, "
                    strInsert = strInsert & "cfolder_jetnet_run_flag, cfolder_jetnet_run_reply_username, cfolder_jetnet_run_reply_email, cfolder_jetnet_run_last_process_date, cfolder_jetnet_run_freq_in_mins" + IIf(cfolder_default, ", cfolder_default_flag", "")

                    strInsert = strInsert & " , cfolder_schedule_run_date, cfolder_schedule_type, cfolder_schedule_day, cfolder_schedule_hour "

                    strInsert = strInsert & ") VALUES ('" & cfolder_operator_flag & "'," & cfolder_cftype_id & ",'" & cfolder_hide_flag & "','" & cfolder_name & "','" & cfolder_share & "','" & cfolder_method & "','" & cfolder_description & "','" & cfolder_data & "'," & subID & ", '" & Trim(userLogin) & "', " & seqNO & ","

                    strInsert = strInsert & "'" & cfolder_jetnet_run_flag & "', "
                    If cfolder_jetnet_run_reply_username <> "" Then
                        strInsert = strInsert & "'" & cfolder_jetnet_run_reply_username & "', "
                    Else
                        strInsert = strInsert & "NULL,"
                    End If

                    If cfolder_jetnet_run_reply_email <> "" Then
                        strInsert = strInsert & "'" & cfolder_jetnet_run_reply_email & "', "
                    Else
                        strInsert = strInsert & "NULL,"
                    End If

                    If cfolder_jetnet_run_last_process_date <> "" Then
                        strInsert = strInsert & "'" & cfolder_jetnet_run_last_process_date & "',"
                    Else
                        strInsert = strInsert & "NULL,"
                    End If

                    strInsert = strInsert & cfolder_jetnet_run_freq_in_mins & ","

                    If cfolder_default Then
                        strInsert = strInsert & "'Y',"
                    End If

                    ' ADDED IN MSW - 6/1/20 
                    If cfolder_schedule_run_date <> "" Then
                        strInsert = strInsert & "'" & cfolder_schedule_run_date & "', "
                    Else
                        strInsert = strInsert & "NULL,"
                    End If

                    If cfolder_schedule_type <> "" Then
                        strInsert = strInsert & "'" & cfolder_schedule_type & "', "
                    Else
                        strInsert = strInsert & "NULL,"
                    End If

                    If cfolder_schedule_day <> "" Then
                        strInsert = strInsert & "'" & cfolder_schedule_day & "',  "
                    Else
                        strInsert = strInsert & "NULL, "
                    End If


                    If cfolder_schedule_hour <> "" Then
                        strInsert = strInsert & "'" & cfolder_schedule_hour & "'  "
                    Else
                        strInsert = strInsert & "NULL "
                    End If


                    strInsert = strInsert & ");SELECT SCOPE_IDENTITY() AS insertid;"

                    SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
                    SqlConn.Open()
                    SqlCommand.Connection = SqlConn

                    SqlCommand.CommandText = strInsert


                    NewFolderID = Convert.ToInt64(SqlCommand.ExecuteScalar())

                    HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Insert_Into_Evolution_Folders(ByVal cfolder_name As String, ByVal cfolder_method As String, ByVal cfolder_description As String, ByVal cfolder_data As String, ByVal subID As Long, ByVal userLogin As String, ByVal seqNO As Long) As Integer</b><br />" & strInsert

                    strInsert = ""
                    Insert_Into_Evolution_Folders = NewFolderID
                End If
            End If


        Catch ex As Exception
            Insert_Into_Evolution_Folders = 0
            Me.class_error = "Error in Insert_Into_Evolution_Folders(ByVal cfolder_name As String, ByVal cfolder_method As String, ByVal cfolder_description As String, ByVal cfolder_data As String, ByVal subID As Long, ByVal userLogin As String, ByVal seqNO As Long) As Integer " & ex.Message
        Finally
            SqlCommand.Dispose()
            SqlConn.Close()
            SqlConn.Dispose()
        End Try
    End Function
    Public Sub Insert_Primary_Comparable_Record(ByVal note_id As Integer, ByVal client_ac_id As String, ByVal jetnet_ac_id As String)
    Dim SqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim SqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim SqlException As MySql.Data.MySqlClient.MySqlException : SqlException = Nothing
    Dim insert_string As String = ""


    Try

      insert_string = " insert into client_value_comparables "
      insert_string &= " (clival_note_id,clival_type, clival_client_ac_id, clival_clitrans_id, clival_ac_type, clival_jetnet_ac_id) "
      insert_string &= " values (" & note_id & ",'F'," & client_ac_id & ",0,'P', " & jetnet_ac_id & ")"

      SqlConn.ConnectionString = client_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn
      SqlCommand.CommandText = insert_string
      SqlCommand.ExecuteNonQuery()
    Catch ex As Exception
    Finally
      SqlCommand.Dispose()
      SqlConn.Close()
      SqlConn.Dispose()
    End Try
  End Sub
  ''' <summary>
  ''' Edits the sort on Evolution Folders.
  ''' </summary>
  ''' <param name="newSort"></param>
  ''' <param name="cfolder_id"></param>
  ''' <param name="subID"></param>
  ''' <param name="userLogin"></param>
  ''' <param name="seqNO"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Edit_Sort_Evolution_Folders(ByVal newSort As Integer, ByVal cfolder_id As Integer, ByVal subID As Long, ByVal userLogin As String, ByVal seqNO As Long) As Integer
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim sql As String = ""
    Edit_Sort_Evolution_Folders = 0
    Try
      'make sure there's a session set.
      If HttpContext.Current.Session.Item("crmUserLogon") = True Then
        If subID <> 0 And userLogin <> "" And seqNO <> 0 Then


          sql = " UPDATE client_folder "
          sql = sql & " SET  cfolder_sort = '" & Math.Abs(newSort) & "' "
          sql = sql & " WHERE (cfolder_id = '" & cfolder_id & "' and cfolder_sub_id = " & subID & " and cfolder_login = '" & Trim(userLogin) & "' and cfolder_seq_no = " & seqNO & ") "

          SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
          SqlConn.Open()
          SqlCommand.Connection = SqlConn

          SqlCommand.CommandText = sql
          SqlCommand.ExecuteNonQuery()

          HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b> Edit_Sort_Evolution_Folders(ByVal newSort As Integer, ByVal cfolder_id As Integer, ByVal subID As Long, ByVal userLogin As String, ByVal seqNO As Long) As Integer</b><br />" & sql


          Edit_Sort_Evolution_Folders = 1
          sql = ""
        End If
      End If

    Catch ex As Exception
      Edit_Sort_Evolution_Folders = 0
      Me.class_error = "Error in Insert_Into_Evolution_Folders(ByVal cfolder_name As String, ByVal cfolder_method As String, ByVal cfolder_description As String, ByVal cfolder_data As String, ByVal subID As Long, ByVal userLogin As String, ByVal seqNO As Long) As Integer " & ex.Message
    Finally
      SqlCommand.Dispose()
      SqlConn.Close()
      SqlConn.Dispose()
    End Try
  End Function

  ''' <summary>
  ''' Removes a folder from Evolution based on user parameters and folder ID
  ''' </summary>
  ''' <param name="cfolder_id"></param>
  ''' <param name="subID"></param>
  ''' <param name="userLogin"></param>
  ''' <param name="seqNO"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Remove_Evolution_Folders(ByVal cfolder_id As Integer, ByVal subID As Long, ByVal userLogin As String, ByVal seqNO As Long, ByVal is_admin As String) As Integer
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim sql As String = ""
    Remove_Evolution_Folders = 0
    Try
      'make sure there's a session set.
      If HttpContext.Current.Session.Item("crmUserLogon") = True Then
        If subID <> 0 And userLogin <> "" And seqNO <> 0 Then


          sql = " delete from client_folder "
          If Trim(is_admin) = "Y" Then
            sql = sql & " WHERE (cfolder_id = '" & cfolder_id & "'  ) "
          Else
            sql = sql & " WHERE (cfolder_id = '" & cfolder_id & "' and cfolder_sub_id = " & subID & " and cfolder_login = '" & Trim(userLogin) & "' and cfolder_seq_no = " & seqNO & ") "
          End If

          SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
          SqlConn.Open()
          SqlCommand.Connection = SqlConn

          SqlCommand.CommandText = sql
          SqlCommand.ExecuteNonQuery()

          HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Remove_Evolution_Folders(ByVal cfolder_id As Integer, ByVal subID As Long, ByVal userLogin As String, ByVal seqNO As Long) As Integer</b><br />" & sql


          Remove_Evolution_Folders = 1
          sql = ""
        End If
      End If

    Catch ex As Exception
      Remove_Evolution_Folders = 0
      Me.class_error = "Error in Remove_Evolution_Folders(ByVal cfolder_id As Integer, ByVal subID As Long, ByVal userLogin As String, ByVal seqNO As Long) As Integer " & ex.Message
    Finally
      SqlCommand.Dispose()
      SqlConn.Close()
      SqlConn.Dispose()
    End Try
  End Function


  ''' <summary>
  ''' Needs to be extended eventually as more folders are added
  ''' </summary>
  ''' <param name="cfoldind_id"></param>
  ''' <param name="cfolder_id"></param>
  ''' <param name="acID"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Remove_Evolution_Folder_Index(ByVal cfoldind_id As Long, ByVal cfolder_id As Long, ByVal acID As Long, ByVal companyID As Long, ByVal WantedID As Long, ByVal ContactID As Long, ByVal journalID As Long, ByVal yachtID As Long) As Integer
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim sql As String = ""
    Remove_Evolution_Folder_Index = 0
    Try
      'make sure there's a session set.
      If HttpContext.Current.Session.Item("crmUserLogon") = True Then
        If cfolder_id <> 0 Then


          sql = " delete from client_folder_index "
          sql = sql & " WHERE ("

          sql = sql & " cfoldind_cfolder_id = '" & cfolder_id & "' "

          If cfoldind_id <> 0 Then
            sql = sql & " and cfoldind_id = '" & cfoldind_id & "' "
          End If

          If acID <> 0 Then
            sql = sql & " and cfoldind_jetnet_ac_id = '" & acID & "' "
          End If

          If WantedID <> 0 Then
            sql = sql & " and cfoldind_jetnet_amwanted_id = '" & WantedID & "' "
          End If

          If ContactID <> 0 Then
            sql = sql & " and cfoldind_jetnet_contact_id = '" & ContactID & "' "
          End If

          If journalID <> 0 Then
            sql = sql & " and cfoldind_jetnet_journ_id = '" & journalID & "' "
          End If

          If companyID <> 0 Then
            sql = sql & " and cfoldind_jetnet_comp_id = '" & companyID & "' "
          End If

          If yachtID <> 0 Then
            sql = sql & " and cfoldind_jetnet_yacht_id = '" & yachtID & "' "
          End If

          sql = sql & " ) "

          SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
          SqlConn.Open()
          SqlCommand.Connection = SqlConn

          SqlCommand.CommandText = sql
          SqlCommand.ExecuteNonQuery()

          HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b> Public Function Remove_Evolution_Folder_Index(ByVal cfolder_id As Long, ByVal acID As Long) As Integer</b><br />" & sql


          Remove_Evolution_Folder_Index = 1
          sql = ""
        End If
      End If

    Catch ex As Exception
      Remove_Evolution_Folder_Index = 0
      Me.class_error = "Error inPublic Function Remove_Evolution_Folder_Index(ByVal cfolder_id As Long, ByVal acID As Long) As Integer " & ex.Message
    Finally
      SqlCommand.Dispose()
      SqlConn.Close()
      SqlConn.Dispose()
    End Try
  End Function


  ''' <summary>
  ''' </summary>
  ''' <returns></returns>
  ''' <remarks></remarks> 
  Public Function GetEvolutionFoldersType() As DataTable
    Dim atemptable As New DataTable
    Dim sQuery As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try
      sQuery = "select * from Client_Folder_Type with (NOLOCK) "
      sQuery += " order by cfttpe_name"


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Public Function GetEvolutionFoldersType() As DataTable</b><br />" & sQuery


      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sQuery
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

    Catch ex As Exception
      GetEvolutionFoldersType = Nothing
      'Me.class_error = "Error in Public Function GetEvolutionFoldersType() As DataTable " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try
    Return atemptable
  End Function

  ''' <summary>
  ''' MOVE TO DL!!
  ''' </summary>
  ''' <param name="cfolder_id"></param>
  ''' <param name="cfolder_priority"></param>
  ''' <param name="jetnetAC"></param>
  ''' <param name="journalID"></param>
  ''' <param name="companyID"></param>
  ''' <param name="contactID"></param>
  ''' <param name="wantedID"></param>
  ''' <param name="eventID"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Insert_Into_Evolution_Folder_Index(ByVal cfolder_id As Integer, ByVal cfolder_priority As Integer, ByVal jetnetAC As Long, ByVal journalID As Long, ByVal companyID As Long, ByVal contactID As Long, ByVal wantedID As Long, ByVal eventID As Long, ByVal YachtID As Long, Optional ByVal aport_id As Long = 0) As Integer
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim strInsert As String = ""

    Try
      'make sure there's a session set.
      If HttpContext.Current.Session.Item("crmUserLogon") = True Then
        If cfolder_id <> 0 Then


          strInsert = " insert into Client_Folder_Index (cfoldind_cfolder_id, cfoldind_priority,cfoldind_jetnet_ac_id, cfoldind_jetnet_journ_id, cfoldind_jetnet_comp_id, cfoldind_jetnet_contact_id, cfoldind_jetnet_amwanted_id, cfoldind_jetnet_priorev_id, cfoldind_jetnet_yacht_id, cfoldind_jetnet_aport_id  ) values (" & cfolder_id & ", " & cfolder_priority & ", " & jetnetAC & ", " & journalID & ", " & companyID & ", " & contactID & ", " & wantedID & ", " & eventID & ", " & YachtID & " , " & aport_id & ")"

          SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
          SqlConn.Open()
          SqlCommand.Connection = SqlConn

          SqlCommand.CommandText = strInsert
          SqlCommand.ExecuteNonQuery()

          HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Insert_Into_Evolution_Folder_Index(ByVal cfolder_id As Integer, ByVal cfolder_priority As Integer, ByVal jetnetAC As Long, ByVal journalID As Long, ByVal companyID As Long, ByVal contactID As Long, ByVal wantedID As Long, ByVal eventID As Long) As Integer</b><br />" & strInsert

          strInsert = ""
          Insert_Into_Evolution_Folder_Index = 1
        End If
      End If


    Catch ex As Exception
      Insert_Into_Evolution_Folder_Index = 0
      Me.class_error = "Error in Insert_Into_Evolution_Folder_Index(ByVal cfolder_id As Integer, ByVal cfolder_priority As Integer, ByVal jetnetAC As Long, ByVal journalID As Long, ByVal companyID As Long, ByVal contactID As Long, ByVal wantedID As Long, ByVal eventID As Long) As Integer " & ex.Message
    Finally
      SqlCommand.Dispose()
      SqlConn.Close()
      SqlConn.Dispose()
    End Try
  End Function

  ''' <summary>
  ''' move to DL!!
  ''' </summary>
  ''' <param name="folderID"></param>
  ''' <param name="ACID"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function GetEvolutionFoldersIndex(ByVal folderID As Long, ByVal ACID As Long, ByVal CompanyID As Long, ByVal WantedID As Long, ByVal contactID As Long, ByVal JournalID As Long, ByVal yachtID As Long) As DataTable
    Dim atemptable As New DataTable
    Dim sQuery As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try
      If folderID <> 0 Then
        sQuery = ""
        sQuery = "select * from Client_Folder_Index with (NOLOCK)"
        sQuery += " where cfoldind_cfolder_id = " & folderID
        If ACID <> 0 Then
          sQuery += " and cfoldind_jetnet_ac_id = '" & ACID & "'"
        End If
        If CompanyID <> 0 Then
          sQuery += " and cfoldind_jetnet_comp_id = '" & CompanyID & "'"
        End If
        If contactID <> 0 Then
          sQuery += " and cfoldind_jetnet_contact_id = '" & contactID & "'"
        End If

        If WantedID <> 0 Then
          sQuery += " and cfoldind_jetnet_amwanted_id = '" & WantedID & "'"
        End If

        If JournalID <> 0 Then
          sQuery += " and cfoldind_jetnet_journ_id = '" & JournalID & "'"
        End If
        If yachtID <> 0 Then
          sQuery += " and cfoldind_jetnet_yacht_id = '" & yachtID & "'"
        End If

        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>GetEvolutionFoldersIndex(ByVal folderID As Long, ByVal ACID As Long) As DataTable</b><br />" & sQuery


        SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
        SqlConn.Open()
        SqlCommand.Connection = SqlConn


        SqlCommand.CommandText = sQuery
        SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
        SqlCommand.CommandType = CommandType.Text
        SqlCommand.CommandTimeout = 60


        Try
          atemptable.Load(SqlReader)
        Catch constrExc As System.Data.ConstraintException
          Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
        End Try
      End If
    Catch ex As Exception
      GetEvolutionFoldersIndex = Nothing
      Me.class_error = "Error in GetEvolutionFoldersIndex(ByVal folderID As Long, ByVal ACID As Long) As DataTable " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try
    Return atemptable
  End Function
    Public Function GetEvolutionFolders(ByVal folderID As Long) As DataTable
        Dim atemptable As New DataTable
        Dim sQuery As String = ""
        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing

        Try
            If folderID <> 0 Then
                sQuery = ""
                sQuery = "select * from Client_Folder with (NOLOCK)"
                sQuery += " where cfolder_id = " & folderID


                HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>GetEvolutionFoldersIndex(ByVal folderID As Long, ByVal ACID As Long) As DataTable</b><br />" & sQuery


                SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
                SqlConn.Open()
                SqlCommand.Connection = SqlConn


                SqlCommand.CommandText = sQuery
                SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
                SqlCommand.CommandType = CommandType.Text
                SqlCommand.CommandTimeout = 60


                Try
                    atemptable.Load(SqlReader)
                Catch constrExc As System.Data.ConstraintException
                    Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
                End Try
            End If
        Catch ex As Exception
            GetEvolutionFolders = Nothing
            Me.class_error = "Error in GetEvolutionFoldersIndex(ByVal folderID As Long, ByVal ACID As Long) As DataTable " & ex.Message
        Finally
            SqlReader = Nothing

            SqlConn.Dispose()
            SqlConn.Close()
            SqlConn = Nothing

            SqlCommand.Dispose()
            SqlCommand = Nothing
        End Try
        Return atemptable
    End Function

    Public Function UpdateDefaultFolderFlag(ByVal DefaultFolderFlag As String, ByVal cfolder_id As Integer, ByVal subID As Long, ByVal userLogin As String, ByVal seqNO As Long) As Integer
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim sql As String = ""
    UpdateDefaultFolderFlag = 0
    Try
      'make sure there's a session set.
      If HttpContext.Current.Session.Item("crmUserLogon") = True Then
        If subID <> 0 And userLogin <> "" And seqNO <> 0 Then

          sql = " UPDATE client_folder "
          sql = sql & " SET  cfolder_default_flag = '" & DefaultFolderFlag & "' "
          sql = sql & " WHERE (cfolder_id = '" & cfolder_id & "' and cfolder_sub_id = " & subID & " and cfolder_login = '" & Trim(userLogin) & "' and cfolder_seq_no = " & seqNO & ") "

          SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
          SqlConn.Open()
          SqlCommand.Connection = SqlConn

          SqlCommand.CommandText = sql
          SqlCommand.ExecuteNonQuery()

          HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>UpdateDefaultFolderFlag(ByVal DefaultFolderFlag As String, ByVal cfolder_id As Integer, ByVal subID As Long, ByVal userLogin As String, ByVal seqNO As Long) As Integer</b><br />" & sql

          UpdateDefaultFolderFlag = 1
          sql = ""
        End If
      End If

    Catch ex As Exception
      UpdateDefaultFolderFlag = 0
      Me.class_error = "Error in UpdateDefaultFolderFlag(ByVal DefaultFolderFlag As String, ByVal cfolder_id As Integer, ByVal subID As Long, ByVal userLogin As String, ByVal seqNO As Long) As Integer " & ex.Message
    Finally
      SqlCommand.Dispose()
      SqlConn.Close()
      SqlConn.Dispose()
    End Try
  End Function

  Public Function ClearDefaultFolderFlag(ByVal subID As Long, ByVal userLogin As String, ByVal seqNO As Long) As Integer
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim sql As String = ""
    ClearDefaultFolderFlag = 0
    Try
      'make sure there's a session set.
      If HttpContext.Current.Session.Item("crmUserLogon") = True Then
        If subID <> 0 And userLogin <> "" And seqNO <> 0 Then

          sql = " UPDATE client_folder "
          sql = sql & " SET  cfolder_default_flag = 'N' "
          sql = sql & " WHERE (cfolder_sub_id = " & subID & " and cfolder_login = '" & Trim(userLogin) & "' and cfolder_seq_no = " & seqNO & ") "

          SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
          SqlConn.Open()
          SqlCommand.Connection = SqlConn

          SqlCommand.CommandText = sql
          SqlCommand.ExecuteNonQuery()

          HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>ClearDefaultFolderFlag(ByVal cfolder_id As Integer, ByVal subID As Long, ByVal userLogin As String, ByVal seqNO As Long) As Integer</b><br />" & sql

          ClearDefaultFolderFlag = 1
          sql = ""
        End If
      End If

    Catch ex As Exception
      ClearDefaultFolderFlag = 0
      Me.class_error = "Error in UpdateDefaultFolderFlag(ByVal DefaultFolderFlag As String, ByVal cfolder_id As Integer, ByVal subID As Long, ByVal userLogin As String, ByVal seqNO As Long) As Integer " & ex.Message
    Finally
      SqlCommand.Dispose()
      SqlConn.Close()
      SqlConn.Dispose()
    End Try
  End Function
#End Region
#Region "Subscription Heavy User Log - Bot Activity"

  Public Function Update_Subscription_Heavy_User_Log(ByVal subID As Long, ByVal userLogin As String, ByVal seqNO As Long) As Integer
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim strDate As String = ""
    Dim strUpdate1 As String = ""

    Try
      'make sure there's a session set.
      If HttpContext.Current.Session.Item("crmUserLogon") = True Then
        If HttpContext.Current.Session.Item("localUser").crmEvo = True Then
          If subID <> 0 And userLogin <> "" And seqNO <> 0 Then


            strUpdate1 = "UPDATE Subscription_Heavy_User_Log SET shul_cleared_date = '" & DateTime.Now & "', shul_cleared_flag = 'Y' "
            strUpdate1 = strUpdate1 & " WHERE (shul_sub_id = " & CStr(subID) & ") "
            strUpdate1 = strUpdate1 & " AND (shul_login = '" & CStr(Trim(userLogin)) & "') "
            strUpdate1 = strUpdate1 & " AND (shul_seq_no = " & CStr(seqNO) & ") "


            SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            SqlConn.Open()
            SqlCommand.Connection = SqlConn

            SqlCommand.CommandText = strUpdate1
            SqlCommand.ExecuteNonQuery()


            clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, strUpdate1.ToString)

            strUpdate1 = ""


          End If
        End If
      End If
      Update_Subscription_Heavy_User_Log = 1

    Catch ex As Exception
      Update_Subscription_Heavy_User_Log = 0
      Me.class_error = "Error in Update_Subscription_Heavy_User_Log(ByVal subID As Long, ByVal userLogin As String, ByVal seqNO As Long) As Integer " & ex.Message
    Finally
      SqlCommand.Dispose()
      SqlConn.Close()
      SqlConn.Dispose()
    End Try
  End Function

  Public Function CheckForBotActivity(ByVal subID As Long, ByVal loginVar As String, ByVal seqNo As Long) As DataTable
    Dim sqlQuery As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable

    Try
      If subID > 0 And Not String.IsNullOrEmpty(loginVar) And seqNo > 0 Then
        'Opening Connection
        SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
        SqlConn.Open()


        sqlQuery = "select COUNT(*) as tcount from Subscription_Heavy_User_Log with (NOLOCK) "
        sqlQuery += " WHERE shul_sub_id = @subID and shul_login=@login and shul_seq_no=@seqNO and shul_cleared_flag='N'"


        Dim SqlCommand As New SqlClient.SqlCommand(sqlQuery, SqlConn)


        clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sqlQuery.ToString)
        SqlCommand.Parameters.AddWithValue("subID", subID)
        SqlCommand.Parameters.AddWithValue("login", loginVar)
        SqlCommand.Parameters.AddWithValue("seqNo", seqNo)

        SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

        Try
          atemptable.Load(SqlReader)
        Catch constrExc As System.Data.ConstraintException
          Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
        End Try


        SqlCommand.Dispose()
        SqlCommand = Nothing
      End If

      Return atemptable
    Catch ex As Exception
      CheckForBotActivity = Nothing
      Me.class_error = "Error in CheckForBotActivity(ByVal subID As Long, ByVal loginVar As String, ByVal seqNo As Long) As DataTable: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

    End Try

  End Function

#End Region
#Region "GetDataAge"
  Public Function Get_Data_Age() As DataTable
    Dim sql As String = ""
    Dim aTempTable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try


      sql = "select datediff(second,max(Aircraft.ac_action_date),max(Aircraft_Flat.ac_action_date)) as viewage "
      sql += " from Aircraft"
      sql += " left outer join Aircraft_Flat on Aircraft.ac_id=Aircraft_flat.ac_id"
      sql += " and Aircraft.ac_journ_id=Aircraft_flat.ac_journ_id"


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)


      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable
    Catch ex As Exception
      Get_Data_Age = Nothing
      Me.class_error = "Error in Public Function Get_Data_Age() As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function
#End Region
#Region "Subscription"
  ''' <summary>
  ''' Update_Evo_Sub_Dates - This updates all the timestamps on the user record depending on the variable what action
  ''' </summary>
  ''' <returns>integer. 1 = through, 0 = error</returns>
  ''' <remarks></remarks>
  Public Function Update_Evo_Sub_Dates(ByVal what_action As String, ByVal strDate As System.DateTime, ByVal subID As Long, ByVal userLogin As String, ByVal seqNO As Long, ByVal userGUID As String) As Integer
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Dim strUpdate1 As String = ""

    Try
      'make sure there's a session set.
      If HttpContext.Current.Session.Item("crmUserLogon") = True Then
        If subID <> 0 And userLogin <> "" And seqNO <> 0 And userGUID <> "" Then

          SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
          SqlConn.Open()
          SqlCommand.Connection = SqlConn


          ' fill the data sets
          If what_action = "main_login" Then
            strDate = FormatDateTime(strDate, vbGeneralDate)

            Dim fSubins_platform_os As String = ""

            If Not IsNothing(HttpContext.Current.Request.Item("whatBrowser")) Then
              If Not String.IsNullOrEmpty(HttpContext.Current.Request.Item("whatBrowser").ToString.Trim) Then
                fSubins_platform_os = HttpContext.Current.Request.Item("whatBrowser").ToString.Trim
              End If
            End If

            If String.IsNullOrEmpty(fSubins_platform_os.Trim) Then
              fSubins_platform_os = "other  unknown  "
            End If

            strUpdate1 = "UPDATE Subscription_Install "
            strUpdate1 = strUpdate1 & "SET subins_last_login_date = '" & strDate & "', "
            strUpdate1 = strUpdate1 & "subins_access_date = '" & strDate & "', "
            strUpdate1 = strUpdate1 & "subins_platform_os = '" & fSubins_platform_os & "', "
            strUpdate1 = strUpdate1 & "subins_last_session_date = '" & strDate & "', "
            strUpdate1 = strUpdate1 & "subins_session_guid = '" & userGUID & "' ,"
            strUpdate1 = strUpdate1 & "subins_last_logout_date = NULL, "
            strUpdate1 = strUpdate1 & "subins_web_action_date = NULL "
            strUpdate1 = strUpdate1 & "WHERE (subins_sub_id = " & CStr(subID) & ") "
            strUpdate1 = strUpdate1 & "AND (subins_login = '" & CStr(Trim(userLogin)) & "') "
            strUpdate1 = strUpdate1 & "AND (subins_seq_no = " & CStr(seqNO) & ") "

            If Not HttpContext.Current.Session.Item("jetnetWebHostType") = eWebHostTypes.CRM Then
              SqlCommand.CommandText = strUpdate1
              SqlCommand.ExecuteNonQuery()
            End If

            clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, strUpdate1.ToString)

            Call commonLogFunctions.Log_User_Event_Data("UserLogin", "User Has Logged In", SqlCommand)

            strUpdate1 = ""
          ElseIf what_action = "logout" Then

            strDate = FormatDateTime(strDate, vbGeneralDate)

            strUpdate1 = "UPDATE Subscription_Install "
            strUpdate1 = strUpdate1 & "SET subins_last_logout_date = '" & strDate & "', "
            strUpdate1 = strUpdate1 & "subins_last_session_date = '" & strDate & "', "
            strUpdate1 = strUpdate1 & "subins_session_guid = '' ,"
            strUpdate1 = strUpdate1 & "subins_web_action_date = NULL "
            strUpdate1 = strUpdate1 & "WHERE (subins_session_guid = '" & CStr(userGUID) & "') "
            strUpdate1 = strUpdate1 & "AND (subins_sub_id = " & CStr(subID) & ") "
            strUpdate1 = strUpdate1 & "AND (subins_login = '" & CStr(Trim(userLogin)) & "') "
            strUpdate1 = strUpdate1 & "AND (subins_seq_no = " & CStr(seqNO) & ") "

            If Not HttpContext.Current.Session.Item("jetnetWebHostType") = eWebHostTypes.CRM Then
              SqlCommand.CommandText = strUpdate1
              SqlCommand.ExecuteNonQuery()
            End If

            clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, strUpdate1.ToString)

            Call commonLogFunctions.Log_User_Event_Data("UserLogout", "User Has Logged Out", SqlCommand)

            strUpdate1 = ""

          ElseIf what_action = "session" Then

            strDate = FormatDateTime(strDate, vbGeneralDate)


            strUpdate1 = "UPDATE Subscription_Install "
            strUpdate1 = strUpdate1 & "SET subins_last_session_date = '" & strDate & "' "
            strUpdate1 = strUpdate1 & "WHERE (subins_session_guid = '" & CStr(userGUID) & "') "
            strUpdate1 = strUpdate1 & "AND (subins_sub_id = " & CStr(subID) & ") "
            strUpdate1 = strUpdate1 & "AND (subins_login = '" & CStr(Trim(userLogin)) & "') "
            strUpdate1 = strUpdate1 & "AND (subins_seq_no = " & CStr(seqNO) & ") "

            If Not HttpContext.Current.Session.Item("jetnetWebHostType") = eWebHostTypes.CRM Then
              SqlCommand.CommandText = strUpdate1
              SqlCommand.ExecuteNonQuery()
            End If

            clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, strUpdate1.ToString)

            'Call commonLogFunctions.Log_User_Event_Data("UserSession", "User Has Logged Out", SqlCommand)

            strUpdate1 = ""
          End If
        End If
      End If
      Update_Evo_Sub_Dates = 1

    Catch ex As Exception
      Update_Evo_Sub_Dates = 0
      Me.class_error = "Error in Update_Evo_Sub_Dates(ByVal what_action(" & what_action.ToString & ") As String, ByVal strDate(" & strDate.ToString & ") As System.DateTime, ByVal subID(" & subID.ToString & ") As Long, ByVal userLogin(" & userLogin.ToString & ") As String, ByVal seqNO As Long, ByVal userGUID (" & userGUID.ToString & ") As String) As Integer " & ex.Message
    Finally
      SqlCommand.Dispose()
      SqlConn.Close()
      SqlConn.Dispose()
    End Try
  End Function

  ''' <summary>
  ''' Updates the subscription Install Table.
  ''' </summary>
  ''' <param name="subID"></param>
  ''' <param name="userLogin"></param>
  ''' <param name="seqNO"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Update_Evo_Sub_Install_Date(ByVal subID As Long, ByVal userLogin As String, ByVal seqNO As Long) As Integer
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim strDate As String = ""
    Dim strUpdate1 As String = ""

    Try
      'make sure there's a session set.
      If HttpContext.Current.Session.Item("crmUserLogon") = True Then
        If HttpContext.Current.Session.Item("localUser").crmEvo = True Then
          If subID <> 0 And userLogin <> "" And seqNO <> 0 Then



            ' fill the data sets
            strDate = FormatDateTime(Now(), vbGeneralDate)

            strUpdate1 = "UPDATE Subscription_Install "
            strUpdate1 = strUpdate1 & "SET subins_install_date = '" & strDate & "' "
            strUpdate1 = strUpdate1 & "WHERE (subins_sub_id = " & CStr(subID) & ") "
            strUpdate1 = strUpdate1 & "AND (subins_login = '" & CStr(Trim(userLogin)) & "') "
            strUpdate1 = strUpdate1 & "AND (subins_seq_no = " & CStr(seqNO) & ") "


            SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
            SqlConn.Open()
            SqlCommand.Connection = SqlConn

            SqlCommand.CommandText = strUpdate1
            SqlCommand.ExecuteNonQuery()


            clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, strUpdate1.ToString)

            strUpdate1 = ""


          End If
        End If
      End If
      Update_Evo_Sub_Install_Date = 1

    Catch ex As Exception
      Update_Evo_Sub_Install_Date = 0
      Me.class_error = "Error in Update_Evo_Sub_Install_Date(ByVal subID As Long, ByVal userLogin As String, ByVal seqNO As Long) As Integer " & ex.Message
    Finally
      SqlCommand.Dispose()
      SqlConn.Close()
      SqlConn.Dispose()
    End Try
  End Function


  ''' <summary>
  ''' compares user login to active dates
  ''' </summary>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Compare_Evo_User_Dates() As DataTable
    Dim atemptable As New DataTable
    Dim str As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try

      str = "select subins_last_login_date as cliuser_last_login_date, subins_last_session_date as cliuser_last_session_date from Subscription_Install WITH(NOLOCK) "
      str = str & "WHERE (subins_sub_id = " & CStr(HttpContext.Current.Session.Item("localUser").crmSubSubID) & ") "
      str = str & "AND (subins_login = '" & CStr(Trim(HttpContext.Current.Session.Item("localUser").crmUserLogin)) & "') "
      str = str & "AND (subins_seq_no = " & CStr(HttpContext.Current.Session.Item("localUser").crmSubSeqNo) & ") "


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, str.ToString)

      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = str
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

    Catch ex As Exception
      Compare_Evo_User_Dates = Nothing
      Me.class_error = "Error in Compare_Evo_User_Dates() " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try
    Return atemptable
  End Function
  ''' <summary>
  ''' This is going to query the jetnet database and grab a database connection string which is in then stored for later use.
  ''' </summary>
  '''<param name="subscriptionFrequency"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Getting_Database_Connection(ByVal subscriptionFrequency As String) As DataTable
    Dim atemptable As New DataTable
    Dim str As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim app_name As String = ""

    Try
      If Not String.IsNullOrEmpty(subscriptionFrequency) Then

        str = " select serfreqan_database_name as connectdb,"
        str = str & " serfreqan_sqlserver_name as connectserver, "
        str = str & " serfreqan_user_id as connectuser, "
        str = str & " serfreqan_password as connectpw "
        str = str & " from Service_Frequency_AppName "
        str = str & " where lower(serfreqan_appname) = '" + HttpContext.Current.Session.Item("localPreferences").AppUserName.ToString.ToLower.Trim + "' "
        str = str & " and lower(serfreqan_frequency) = '" + subscriptionFrequency.ToLower.Trim + "' "
        clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, str.ToString)

        SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
        SqlConn.Open()
        SqlCommand.Connection = SqlConn

        SqlCommand.CommandType = CommandType.Text
        SqlCommand.CommandTimeout = 60

        SqlCommand.CommandText = str
        SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


        Try
          atemptable.Load(SqlReader)
        Catch constrExc As System.Data.ConstraintException
          Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
        End Try
      End If

    Catch ex As Exception
      Getting_Database_Connection = Nothing
      Me.class_error = "Error in Getting_Database_Connection(ByVal subscriptionFrequency As String) As DataTable " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try
    Return atemptable
  End Function
  ''' <summary>
  ''' Query to return forgotten password info to see if user is applicable for password.
  ''' </summary>
  ''' <param name="username">Username, prescreened for gunk.</param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function ForgottenPassword(ByVal username As String) As DataTable
    Dim atemptable As New DataTable
    Dim sQuery As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try

      sQuery = "SELECT DISTINCT sublogin_sub_id, sublogin_login, sublogin_password, sublogin_active_flag, sub_marketing_flag, sublogin_demo_flag, sub_comp_id, subins_contact_id, contact_email_address"
      sQuery = sQuery & " FROM Subscription WITH(NOLOCK)"
      sQuery = sQuery & " INNER JOIN Subscription_Login WITH(NOLOCK) ON (sublogin_sub_id = sub_id)"
      sQuery = sQuery & " INNER JOIN Subscription_Install WITH(NOLOCK) ON ((subins_sub_id = sub_id) AND (sublogin_login = subins_login))"
      sQuery = sQuery & " INNER JOIN Contact WITH(NOLOCK) ON ((contact_comp_id = sub_comp_id) AND (subins_contact_id = contact_id))"
      sQuery = sQuery & " WHERE lower(contact_email_address) = '" + username.Trim + "' AND contact_journ_id = 0"
      sQuery = sQuery & " AND (sub_start_date <= GetDate()) AND (sub_end_date IS NULL OR sub_end_date > GetDate())"
      sQuery = sQuery & " AND (sublogin_active_flag = 'Y') AND (subins_active_flag = 'Y') AND (contact_active_flag = 'Y') AND"
      sQuery = sQuery & " (sub_serv_code NOT LIKE 'CRM%' AND sub_serv_code NOT LIKE 'JIQ%' AND sub_serv_code NOT LIKE '%API%')"

      sQuery = sQuery & " ORDER BY sublogin_sub_id"



      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sQuery.ToString)


      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim

      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sQuery
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Return atemptable
    Catch ex As Exception
      ForgottenPassword = Nothing
      Me.class_error = "Error in ForgottenPassword(ByVal username As String) As DataTable " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try
    Return atemptable
  End Function
  ''' <summary>
  ''' This Gets a list of user created projects based on three subscription variables. Always talks to admin connection DB.
  ''' </summary>
  ''' <param name="login_variable">login variable</param>
  ''' <param name="sub_id">subscriber ID</param>
  ''' <param name="seqNo">seq NO</param>
  ''' <returns>datatable</returns>
  ''' <remarks></remarks>
  Public Function GetEvolutionProjectsBySubscription(ByVal login_variable As String, ByVal sub_id As Long, ByVal seqNo As Long) As DataTable
    Dim atemptable As New DataTable
    Dim sQuery As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try
      If sub_id <> 0 And login_variable <> "" And seqNo <> 0 Then
        sQuery = ""
        sQuery = "SELECT sissc_id, sissc_tab, sissc_subject, sissc_description, sissc_data "
        sQuery += " FROM  Subscription_Install_Saved_Search_Criteria"
        sQuery += " WHERE (sissc_sub_id = " & sub_id & ") AND (sissc_login = '" & Trim(login_variable) & "') AND (sissc_seq_no = " & seqNo & ")"
        sQuery += " ORDER BY sissc_tab, sissc_subject"



        clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sQuery.ToString)

        SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim


        SqlConn.Open()
        SqlCommand.Connection = SqlConn


        SqlCommand.CommandText = sQuery
        SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
        SqlCommand.CommandType = CommandType.Text
        SqlCommand.CommandTimeout = 60


        Try
          atemptable.Load(SqlReader)
        Catch constrExc As System.Data.ConstraintException
          Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
        End Try
      End If
    Catch ex As Exception
      GetEvolutionProjectsBySubscription = Nothing
      Me.class_error = "Error in GetEvolutionProjectsBySubscription(ByVal login_variable As String, ByVal sub_id As Long, ByVal seqNo As Long) As DataTable " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try
    Return atemptable
  End Function

  ''' <summary>
  ''' Used on login to verify subscription
  ''' </summary>
  ''' <param name="username">Username, prescreen for gunk</param>
  ''' <param name="password">Password, prescreened for gunk</param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function EvoLoginVerificationCheck(ByVal username As String, ByVal password As String, ByVal yacht As Boolean, ByVal APILogin As Boolean) As DataTable
    Dim atemptable As New DataTable
    Dim sQuery As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try

      sQuery = " SELECT sublogin_sub_id, subins_admin_flag, sub_cloud_notes_database,subins_default_airports, sublogin_values_flag, sub_max_allowed_custom_export, sub_cloud_notes_flag, subins_default_models, sub_yacht_flag, subins_login,subins_seq_no, sub_starreports_flag,  "
      sQuery = sQuery & " sub_comp_id, subins_contact_id, contact_email_address, subins_last_login_date, "
      sQuery = sQuery & " sub_business_aircraft_flag,sub_helicopters_flag,sub_commerical_flag, subins_last_logout_date, "
      sQuery = sQuery & " sub_aerodex_flag,sub_busair_tier_level, sub_frequency, sub_parent_sub_id, sub_sale_price_flag, subins_last_session_date, "
      sQuery = sQuery & " sub_server_side_notes_flag, sub_server_side_dbase_name, sub_server_side_crm_regid, "
      sQuery = sQuery & " contact_first_name, contact_last_name, sub_marketing_flag, sublogin_demo_flag, sub_end_date, subins_install_date, sub_nbr_days_expire,"
      sQuery = sQuery & " subins_platform_os, sub_marketing_flag, sublogin_demo_flag, sub_serv_code,"
      sQuery = sQuery & " subins_default_amod_id, subins_evoview_id, subins_background_image_id, sublogin_allow_local_notes_flag, subins_activex_flag, subins_local_db_flag, "
      sQuery = sQuery & " subins_nbr_rec_per_page, subins_evo_mobile_flag, subins_cell_number, subins_email_replyname, "
      sQuery = sQuery & " subins_email_replyaddress, subins_email_default_format, subins_cell_service, subins_cell_carrier_id, "
      sQuery = sQuery & " sublogin_allow_export_flag, sublogin_allow_projects_flag, sublogin_allow_email_request_flag, sublogin_allow_event_request_flag, sublogin_allow_text_message_flag, "
      sQuery = sQuery & " subins_sms_events, subins_smstxt_models, subins_smstxt_active_flag, subins_local_db_file, subins_display_note_tag_on_aclist_flag, sub_share_by_comp_id_flag, sub_share_by_parent_sub_id_flag "
      sQuery = sQuery & " FROM Subscription WITH(NOLOCK)"
      sQuery = sQuery & " INNER JOIN Subscription_Login WITH(NOLOCK) ON (sublogin_sub_id = sub_id)"
      sQuery = sQuery & " INNER JOIN Subscription_Install WITH(NOLOCK) ON (subins_sub_id = sub_id) and (sublogin_login=subins_login) "
      sQuery = sQuery & " INNER JOIN Company WITH(NOLOCK) ON (comp_id = sub_comp_id) and comp_journ_id = 0 "
      sQuery = sQuery & " INNER JOIN Contact WITH(NOLOCK) ON (contact_comp_id = comp_id) and subins_contact_id = contact_id and contact_journ_id = 0 "
      sQuery = sQuery & " WHERE sublogin_active_flag='Y' AND sub_serv_code not LIKE 'CRM%'"

      If APILogin = False Then
        sQuery = sQuery & " AND sub_serv_code not LIKE 'JIQ%' "
        sQuery = sQuery & " AND sub_serv_code not LIKE '%API%' "
      End If

      If yacht = True Then
        sQuery = sQuery & " and sub_yacht_flag='Y' "
      End If

      sQuery = sQuery & " and (sub_start_date <= GetDate()) AND (sub_end_date IS NULL OR sub_end_date > GetDate())"
      sQuery = sQuery & " and contact_email_address = '" + username.Trim + "' AND sublogin_password = '" + password.Trim + "'"

      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sQuery.ToString)

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />EvoLoginVerificationCheck()<br />" + sQuery

      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
      SqlConn.Open()

      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sQuery
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Return atemptable
    Catch ex As Exception
      EvoLoginVerificationCheck = Nothing
      Me.class_error = "Error in EvoLoginVerificationCheck(ByVal username As String, ByVal password As String) As DataTable " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try


    Return atemptable

  End Function
  ''' <summary>
  ''' This Query in MyEvolution Reloads the Subscription information
  ''' based on Subscription ID, login and Seq #
  ''' </summary>
  ''' <param name="GUID"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function MyEvolutionReloadSubscriptionQuery(ByVal GUID As String) As DataTable
    Dim atemptable As New DataTable
    Dim sQuery As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try

      sQuery = " SELECT sublogin_sub_id, subins_admin_flag, sub_yacht_flag, subins_default_airports, sub_max_allowed_custom_export,sublogin_values_flag,  sub_cloud_notes_database, sub_cloud_notes_flag, subins_default_models, subins_login,subins_seq_no, sub_starreports_flag,  "
      sQuery = sQuery & " sub_comp_id, subins_contact_id, contact_email_address, subins_last_login_date,sub_parent_sub_id, "
      sQuery = sQuery & " sub_business_aircraft_flag,sub_helicopters_flag,sub_commerical_flag, subins_last_logout_date, "
      sQuery = sQuery & " sub_aerodex_flag,sub_busair_tier_level, sub_frequency, sub_sale_price_flag, subins_last_session_date, subins_install_date, sub_nbr_days_expire, "
      sQuery = sQuery & " sub_server_side_notes_flag, sub_server_side_dbase_name, sub_server_side_crm_regid,"
      sQuery = sQuery & " contact_first_name, contact_last_name, sub_marketing_flag, sublogin_demo_flag, "
      sQuery = sQuery & " subins_platform_os, sub_marketing_flag, sublogin_demo_flag, sub_serv_code,"
      sQuery = sQuery & " subins_default_amod_id, subins_evoview_id, subins_background_image_id, sublogin_allow_local_notes_flag, subins_activex_flag, subins_local_db_flag, "
      sQuery = sQuery & " subins_nbr_rec_per_page, subins_evo_mobile_flag, subins_cell_number, subins_email_replyname, "
      sQuery = sQuery & " subins_email_replyaddress, subins_email_default_format, subins_cell_service, subins_cell_carrier_id, "
      sQuery = sQuery & " sublogin_allow_export_flag, sublogin_allow_projects_flag, sublogin_allow_email_request_flag, sublogin_allow_event_request_flag, sublogin_allow_text_message_flag, "
      sQuery = sQuery & " subins_sms_events, subins_smstxt_models, subins_smstxt_active_flag, subins_local_db_file, subins_display_note_tag_on_aclist_flag, sub_share_by_parent_sub_id_flag, sub_share_by_comp_id_flag  "

      sQuery = sQuery & " FROM Subscription_Install WITH(NOLOCK) "
      sQuery = sQuery & " INNER JOIN Subscription_Login WITH(NOLOCK) ON (sublogin_sub_id = subins_sub_id) and (sublogin_login=subins_login) "
      sQuery = sQuery & " INNER JOIN Subscription WITH(NOLOCK) ON (subins_sub_id = sub_id) "

      sQuery = sQuery & " INNER JOIN Company WITH(NOLOCK) ON (comp_id = sub_comp_id) and comp_journ_id = 0 "
      sQuery = sQuery & " INNER JOIN Contact WITH(NOLOCK) ON (contact_comp_id = comp_id) and subins_contact_id = contact_id and contact_journ_id = 0 "

      sQuery = sQuery & " WHERE (subins_session_guid = '" + CStr(GUID) + "') AND (subins_sub_id = " + HttpContext.Current.Session.Item("localUser").crmSubSubID.ToString
      sQuery = sQuery & " AND subins_contact_id = " + HttpContext.Current.Session.Item("localUser").crmUserContactID.ToString
      sQuery = sQuery & " AND subins_seq_no = " + HttpContext.Current.Session.Item("localUser").crmSubSeqNo.ToString
      sQuery = sQuery & " AND subins_login = '" + HttpContext.Current.Session.Item("localUser").crmUserLogin.ToString.Trim + "')"


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sQuery.ToString)


      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sQuery
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Return atemptable
    Catch ex As Exception
      MyEvolutionReloadSubscriptionQuery = Nothing
      Me.class_error = "Error in  MyEvolutionReloadSubscriptionQuery(ByVal GUID As String) As DataTable " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try
    Return atemptable
  End Function

#Region "Default Models for My Evolution"
  ''' <summary>
  ''' This inserts a default model into the Subscription Install Models table.
  ''' </summary>
  ''' <param name="sub_id">Subscription ID</param>
  ''' <param name="sim_login">Subscription LOGIN</param>
  ''' <param name="sim_seq_no">Subscription SEQ NO</param>
  ''' <param name="sim_amod_id">Subscription Model ID</param>
  ''' <returns>A Boolean. true if inserted, false if not.</returns>
  ''' <remarks></remarks>
  Public Function EvoSubscriptionInsertDefaultModel(ByVal sub_id As Long, ByVal sim_login As String, ByVal sim_seq_no As Integer, ByVal sim_amod_id As Long) As Boolean
    Dim InsertQuery As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    EvoSubscriptionInsertDefaultModel = False

    '''''''''''''''''''''''''''''''''''''''''''''''''''
    ''''''''''''''''''Table Schema'''''''''''''''''''''
    'CREATE TABLE [dbo].[Subscription_Install_Models](
    '[sim_id] [int] NOT NULL,
    '[sim_sub_id] [int] NOT NULL,
    '[sim_login] [char](15) NOT NULL,
    '[sim_seq_no] [smallint] NOT NULL,
    '[sim_amod_id] [int] NOT NULL,
    '''''''''''''''''''''''''''''''''''''''''''''''''''
    '''''''''''''''''''''''''''''''''''''''''''''''''''
    Try
      If sub_id <> 0 And sim_login <> "" And sim_amod_id <> 0 Then
        InsertQuery = "insert into subscription_install_models(sim_sub_id, sim_login, sim_seq_no, sim_amod_id) values "
        InsertQuery += " (" & sub_id & ",'" & Trim(sim_login) & "'," & sim_seq_no & "," & sim_amod_id & ")"

        SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
        SqlConn.Open()
        SqlCommand.Connection = SqlConn

        SqlCommand.CommandText = InsertQuery

        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>EvoSubscriptionInsertDefaultModel(ByVal sub_id As Long, ByVal sim_login As String, ByVal sim_seq_no As Integer, ByVal sim_amod_id As Long) As Boolean</b><br />" & InsertQuery

        SqlCommand.ExecuteNonQuery()

        EvoSubscriptionInsertDefaultModel = True
      End If
    Catch ex As Exception
      EvoSubscriptionInsertDefaultModel = False
      Me.class_error = "Error in EvoSubscriptionInsertDefaultModel(ByVal sub_id As Long, ByVal sim_login As String, ByVal sim_seq_no As Integer, ByVal sim_amod_id As Long) As Boolean SQL VERSION: " & ex.Message
    Finally
      SqlConn.Dispose()
      SqlConn.Close()

      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try
  End Function
  ''' <summary>
  ''' This removes all of the default models from the Subscription Install Models table.
  ''' </summary>
  ''' <param name="sub_id">Subscription ID</param>
  ''' <param name="sim_login">Subscription LOGIN</param>
  ''' <param name="sim_seq_no">Subscription SEQ NO</param>
  ''' <returns>A Boolean. true if inserted, false if not.</returns>
  ''' <remarks></remarks>
  Public Function EvoSubscriptionRemoveDefaultModels(ByVal sub_id As Long, ByVal sim_login As String, ByVal sim_seq_no As Integer) As Boolean
    Dim InsertQuery As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    EvoSubscriptionRemoveDefaultModels = False

    Try
      If sub_id <> 0 And sim_login <> "" And sim_seq_no <> 0 Then
        InsertQuery = "delete from subscription_install_models where sim_sub_id = " & sub_id
        InsertQuery = InsertQuery & " and sim_login = '" & Trim(sim_login) & "'"
        InsertQuery = InsertQuery & " and sim_seq_no = " & sim_seq_no


        SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
        SqlConn.Open()
        SqlCommand.Connection = SqlConn

        SqlCommand.CommandText = InsertQuery

        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>EvoSubscriptionRemoveDefaultModels(ByVal sub_id As Long, ByVal sim_login As String, ByVal sim_seq_no As Integer) As Boolean</b><br />" & InsertQuery

        SqlCommand.ExecuteNonQuery()

        EvoSubscriptionRemoveDefaultModels = True
      End If
    Catch ex As Exception
      EvoSubscriptionRemoveDefaultModels = False
      Me.class_error = "Error in EvoSubscriptionRemoveDefaultModels(ByVal sub_id As Long, ByVal sim_login As String, ByVal sim_seq_no As Integer) As Boolean SQL VERSION: " & ex.Message
    Finally
      SqlConn.Dispose()
      SqlConn.Close()

      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try
  End Function

#End Region

#End Region

#Region "Subscription Notifications"

  ''' <summary>
  ''' This function gets the jetnet notifications in the upper corner.
  ''' It is going to be used to create a modal popup. It should be taking place of the
  ''' function below whenever it is finished.
  ''' </summary>
  ''' <param name="release_type">Release Type, only useful for toggling the release type since normally it's R but we're using Z for testing</param>
  ''' <param name="subID">Subscription ID</param>
  ''' <param name="login">login</param>
  ''' <param name="seqNo">Seq Nbr</param>
  ''' <param name="strDate">Date</param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Get_Jetnet_Notifications_Popup(ByVal release_type As String, ByVal subID As Long, ByVal login As String, ByVal seqNo As Integer, ByVal strDate As String) As DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable
    Get_Jetnet_Notifications_Popup = New DataTable


    Try
      sql = " select top 1 evonot_id, evonot_title, evonot_release_date, evonot_announcement, evonot_description, evonot_video, evonot_doc_link  "
      sql = sql & " from Evolution_Notifications with (NOLOCK) "
      sql = sql & " where (evonot_release_type='" & release_type & "' "
      sql = sql & " and evonot_release_date >= '" & strDate & "' "
      sql = sql & " and evonot_active_flag='Y' "
      sql = sql & " and (evonot_sub_id=0 or evonot_sub_id = " & subID & ") "
      sql = sql & " and evonot_id not in (select distinct subnot_evonot_id from Subscription_Notifications with (NOLOCK) "
      sql = sql & " where subnot_sub_id = " & subID & " and subnot_login = '" & login.Trim & "' and subnot_seq_no=" & seqNo & "))"
      sql = sql & " order by evonot_release_date desc"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Jetnet_Notifications_Popup(ByVal release_type As String, ByVal subID As Long, ByVal login As String, ByVal seqNo As Integer, ByVal strDate As String) As DataTable</b><br />" & sql


      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Get_Jetnet_Notifications_Popup = atemptable

    Catch ex As Exception
      Get_Jetnet_Notifications_Popup = Nothing
      Me.class_error = "Error in Get_Jetnet_Notifications_Popup(ByVal release_type As String, ByVal subID As Long, ByVal login As String, ByVal seqNo As Integer, ByVal strDate As String) As DataTable SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Close()
      SqlConn.Dispose()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try
  End Function

  Public Function Get_Jetnet_Program_Hints(ByVal release_type As String, ByVal subID As Long, ByVal login As String, ByVal seqNo As Integer, TabDisplayName As String, ViewDisplay As Boolean, ViewDisplayName As String) As DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable
    Dim strDate As String = Format(DateAdd(DateInterval.Day, -90, Now()), "MM/dd/yyyy")
    Get_Jetnet_Program_Hints = New DataTable


    Try
      sql = " select top 1 evonot_id, evonot_title, evonot_release_date, evonot_announcement, evonot_description, evonot_video, evonot_doc_link  "
      sql = sql & " from Evolution_Notifications with (NOLOCK) "
      sql = sql & " where (evonot_release_type='" & release_type & "' "
      sql = sql & " and evonot_release_date >= (getdate() - 90) "
      sql = sql & " and evonot_release_date <= (getdate() + 1) "
      sql = sql & " and evonot_active_flag='Y' "
      sql = sql & " and (evonot_sub_id=0 or evonot_sub_id = " & subID & ") "

      If ViewDisplay = False Then
        '-- LINE FOR TAB CHECK
        sql = sql & " and evonot_tabs='" & TabDisplayName & "' "
      Else
        '-- LINE FOR VIEWS - EXAMPLE FOR THE MODEL MARKET SUMMARY VIEW
        sql = sql & " and evonot_description = '" & ViewDisplayName & "' "
      End If


      sql = sql & " and evonot_id not in (select distinct subnot_evonot_id from Subscription_Notifications with (NOLOCK) "
      sql = sql & " where subnot_sub_id = " & subID & " and subnot_login = '" & login.Trim & "' and subnot_seq_no=" & seqNo & "))"
      sql = sql & " order by newid()"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Jetnet_Program_Hints(ByVal release_type As String, ByVal subID As Long, ByVal login As String, ByVal seqNo As Integer, TabDisplayName As String, ViewDisplay As Boolean, ViewDisplayName As String) As DataTable</b><br />" & sql


      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Get_Jetnet_Program_Hints = atemptable

    Catch ex As Exception
      Get_Jetnet_Program_Hints = Nothing
      Me.class_error = "Error in Get_Jetnet_Program_Hints(ByVal release_type As String, ByVal subID As Long, ByVal login As String, ByVal seqNo As Integer, TabDisplayName As String, ViewDisplay As Boolean, ViewDisplayName As String) As DataTable SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Close()
      SqlConn.Dispose()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try
  End Function



  ''' <summary>
  ''' This function gets the jetnet notifications in the upper corner
  ''' </summary>
  ''' <param name="subID">Subscription ID</param>
  ''' <param name="login">login</param>
  ''' <param name="seqNo">Seq Nbr</param>
  ''' <param name="strDate">Date</param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Get_Jetnet_Notifications(ByVal subID As Long, ByVal login As String, ByVal seqNo As Integer, ByVal strDate As String) As DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable
    Get_Jetnet_Notifications = New DataTable

    Try
      sql = " select top 1 evonot_id, evonot_title, evonot_release_date "
      sql = sql & " from Evolution_Notifications "
      sql = sql & " where evonot_release_type='R' "
      sql = sql & " and evonot_release_date >= '" & strDate & "' "
      sql = sql & " and evonot_active_flag='Y' "
      sql = sql & " and evonot_id not in (select distinct subnot_evonot_id from Subscription_Notifications"
      sql = sql & " where subnot_sub_id = " & subID & " and subnot_login = '" & login.Trim & "' and subnot_seq_no=" & seqNo & ")"
      sql = sql & " order by evonot_release_date desc"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Jetnet_Notifications(ByVal subID As Long, ByVal login As String, ByVal seqNo As Integer, ByVal strDate As String) As DataTable</b><br />" & sql


      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Get_Jetnet_Notifications = atemptable

    Catch ex As Exception
      Get_Jetnet_Notifications = Nothing
      Me.class_error = "Error in Get_Jetnet_Notifications(ByVal subID As Long, ByVal login As String, ByVal seqNo As Integer, ByVal strDate As String) As DataTable SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Close()
      SqlConn.Dispose()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try
  End Function


  ''' <summary>
  ''' Function to insert into subscription notifications - this will go ahead and clear notice after viewing.
  ''' </summary>
  ''' <param name="subnot_sub_id"></param>
  ''' <param name="subnot_login"></param>
  ''' <param name="subnot_seq_no"></param>
  ''' <param name="subnot_evonot_id"></param>
  ''' <param name="subnot_action_date"></param>
  ''' <param name="subnot_action_type"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function InsertIntoSubscriptionNotifications(ByVal subnot_sub_id As Long, ByVal subnot_login As String, ByVal subnot_seq_no As Long, ByVal subnot_evonot_id As Long, ByVal subnot_action_date As String, ByVal subnot_action_type As String) As Integer
    Dim InsertQuery As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing


    InsertIntoSubscriptionNotifications = 0

    Try
      InsertQuery = "INSERT INTO Subscription_Notifications "
      InsertQuery += " (subnot_sub_id,subnot_login,subnot_seq_no,subnot_evonot_id,subnot_action_date,subnot_action_type)"
      InsertQuery += "  VALUES "
      InsertQuery += " (" & subnot_sub_id & ","
      InsertQuery += " '" & Trim(subnot_login) & "', "
      InsertQuery += " " & subnot_seq_no & ", "
      InsertQuery += " " & subnot_evonot_id & ", "
      InsertQuery += " '" & subnot_action_date & "',"
      InsertQuery += " '" & subnot_action_type & "') "


      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = InsertQuery

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>InsertIntoSubscriptionNotifications(ByVal subnot_sub_id As Long, ByVal subnot_login As Long, ByVal subnot_seq_no As Long, ByVal subnot_evonot_id As Long, ByVal subnot_action_date As String, ByVal subnot_action_type As String) As Integer</b><br />" & InsertQuery


      SqlCommand.ExecuteNonQuery()

      InsertIntoSubscriptionNotifications = 1

    Catch ex As Exception
      InsertIntoSubscriptionNotifications = 0
      Me.class_error = "Error in InsertIntoSubscriptionNotifications(ByVal subnot_sub_id As Long, ByVal subnot_login As Long, ByVal subnot_seq_no As Long, ByVal subnot_evonot_id As Long, ByVal subnot_action_date As String, ByVal subnot_action_type As String) As Integer SQL VERSION: " & ex.Message
    Finally
      SqlConn.Dispose()
      SqlConn.Close()

      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try
  End Function

#End Region
#Region "Mail Queue"
  ''' <summary>
  ''' Function used to insert mail into the mail queue.
  ''' </summary>
  ''' <param name="sub_comp_id">Company ID</param>
  ''' <param name="subins_contact_id">Contact ID</param>
  ''' <param name="sublogon_subid">Subscription ID</param>
  ''' <param name="username">To:</param>
  ''' <param name="HTML_Body">Body of HTML</param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function InsertMailQueue(ByVal sub_comp_id As Long, ByVal subins_contact_id As Long, ByVal sublogon_subid As Long, ByVal username As String, ByVal HTML_Body As String, Optional bSetChangePasswordRequest As Boolean = False, Optional bSetChangePasswordSubject As Boolean = False) As Integer
    Dim InsertQuery As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing


    InsertMailQueue = 0

    Try
      InsertQuery = "INSERT INTO EMail_Queue(emailq_service, emailq_replyname, emailq_replyemail, emailq_smtp_server,"
      InsertQuery = InsertQuery & " emailq_smtp_username, emailq_smtp_password, emailq_status, emailq_onhold_flag, emailq_html_flag,"
      InsertQuery = InsertQuery & " emailq_comp_id, emailq_contact_id, emailq_sub_id, emailq_to, emailq_subject, emailq_body) "

      InsertQuery = InsertQuery & " VALUES('Evolution','Customer Service','customerservice@jetnet.com','smtp.jetnet.com',"

      InsertQuery = InsertQuery & "'customerservice@jetnet.com','cservice123','Open','N','Y',"

      If sub_comp_id > 0 Then
        InsertQuery = InsertQuery & CStr(sub_comp_id) & ","
      Else
        InsertQuery = InsertQuery & "0,"
      End If

      If subins_contact_id > 0 Then
        InsertQuery = InsertQuery & CStr(subins_contact_id) & ","
      Else
        InsertQuery = InsertQuery & "0,"
      End If

      If sublogon_subid > 0 Then
        InsertQuery = InsertQuery & CStr(sublogon_subid) & ","
      Else
        InsertQuery = InsertQuery & "0,"
      End If

      InsertQuery = InsertQuery & "'" & Left(username, 70) & "',"
      If bSetChangePasswordRequest Then
        InsertQuery = InsertQuery & "'JETNET LLC - Password Change Request','" & HTML_Body & "'"
      ElseIf bSetChangePasswordSubject Then
        InsertQuery = InsertQuery & "'JETNET LLC - Password Changed','" & HTML_Body & "'"
      Else
        InsertQuery = InsertQuery & "'JETNET LLC - Evolution Requested Information','" & HTML_Body & "'"
      End If
      InsertQuery = InsertQuery & ")"


      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = InsertQuery

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>InsertMailQueue(ByVal sub_comp_id As Long, ByVal subins_contact_id As Long, ByVal sublogon_subid As Long, ByVal username As String, ByVal HTML_Body As String) As Integer</b><br />" & InsertQuery


      SqlCommand.ExecuteNonQuery()

      InsertMailQueue = 1

    Catch ex As Exception
      InsertMailQueue = 0
      Me.class_error = "Error in InsertMailQueue(ByVal sub_comp_id As Long, ByVal subins_contact_id As Long, ByVal sublogon_subid As Long, ByVal username As String, ByVal HTML_Body As String) As Integer SQL VERSION: " & ex.Message
    Finally
      SqlConn.Dispose()
      SqlConn.Close()

      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try
  End Function


  Public Function InsertCRMMailQueue(ByVal emailq_service As String, ByVal emailq_replyname As String, ByVal emailq_replyemail As String, ByVal emailq_smtp_server As String, ByVal emailq_smtp_username As String, ByVal emailq_smtp_password As String, ByVal emailq_to As String, ByVal emailq_cc As String, ByVal emailq_bcc As String, ByVal emailq_subject As String, ByVal emailq_body As String, ByVal emailq_comp_id As Long, ByVal emailq_sub_id As Long, ByVal emailq_app_name As String, ByVal emailq_host_name As String) As Boolean
    Dim QueryFields As String = ""
    Dim QueryValues As String = ""
    Dim Query As String = ""

    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Dim ResponseCode As Boolean = False
    Try
      '[emailq_service] [varchar](30) NULL,
      QueryFields = "insert into EMail_Queue(emailq_service, "
      QueryValues = " values (@emailq_service,"

      '[emailq_replyname] [varchar](150) NULL,
      QueryFields += "emailq_replyname, "
      QueryValues += "@emailq_replyname,"

      '[emailq_replyemail] [varchar](150) NULL,
      QueryFields += "emailq_replyemail, "
      QueryValues += "@emailq_replyemail,"

      '[emailq_smtp_server] [varchar](70) NULL,
      QueryFields += "emailq_smtp_server, "
      QueryValues += "@emailq_smtp_server,"

      '[emailq_smtp_username] [varchar](150) NULL,
      QueryFields += "emailq_smtp_username, "
      QueryValues += "@emailq_smtp_username,"

      '[emailq_smtp_password] [varchar](70) NULL,
      QueryFields += "emailq_smtp_password, "
      QueryValues += "@emailq_smtp_password,"

      '[emailq_to] [varchar](1500) NULL,
      QueryFields += "emailq_to, "
      QueryValues += "@emailq_to,"

      '[emailq_cc] [varchar](1500) NULL,
      QueryFields += "emailq_cc, "
      QueryValues += "@emailq_cc,"

      '[emailq_bcc] [varchar](1500) NULL,
      QueryFields += "emailq_bcc, "
      QueryValues += "@emailq_bcc,"

      '[emailq_subject] [varchar](300) NULL,
      QueryFields += "emailq_subject, "
      QueryValues += "@emailq_subject,"

      '[emailq_body] [text] NULL,
      QueryFields += "emailq_body, "
      QueryValues += "@emailq_body,"

      '[emailq_entry_date] [datetime] NULL,
      QueryFields += "emailq_entry_date, "
      QueryValues += "@emailq_entry_date,"

      '[emailq_status] [varchar](70) NULL,
      QueryFields += "emailq_status, "
      QueryValues += "@emailq_status,"

      '[emailq_onhold_flag] [varchar](1) NULL,
      QueryFields += "emailq_onhold_flag, "
      QueryValues += "@emailq_onhold_flag,"

      '[emailq_html_flag] [varchar](1) NULL,
      QueryFields += "emailq_html_flag, "
      QueryValues += "@emailq_html_flag,"

      '[emailq_comp_id] [int] NULL,
      QueryFields += "emailq_comp_id, "
      QueryValues += "@emailq_comp_id,"

      '[emailq_sub_id] [int] NULL,
      QueryFields += "emailq_sub_id, "
      QueryValues += "@emailq_sub_id,"


      '[emailq_host_name] [varchar](25) NULL,
      QueryFields += "emailq_host_name, "
      QueryValues += "@emailq_host_name,"

      '[emailq_app_name] [varchar](100) NULL,
      QueryFields += "emailq_app_name) "
      QueryValues += "@emailq_app_name)"


      Query = QueryFields & QueryValues

      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
      SqlConn.Open()


      Dim SqlCommand As New SqlClient.SqlCommand(Query, SqlConn)
      SqlCommand.Parameters.AddWithValue("@emailq_service", Left(emailq_service, 30))
      If emailq_replyemail = "customerservice@jetnet.com" Then
        SqlCommand.Parameters.AddWithValue("@emailq_replyname", "Customer Service")
      Else
        SqlCommand.Parameters.AddWithValue("@emailq_replyname", Left(emailq_replyname, 150))
      End If

      SqlCommand.Parameters.AddWithValue("@emailq_replyemail", Left(emailq_replyemail, 150))
      SqlCommand.Parameters.AddWithValue("@emailq_smtp_server", Left(emailq_smtp_server, 70))
      SqlCommand.Parameters.AddWithValue("@emailq_smtp_username", Left(emailq_smtp_username, 150))
      SqlCommand.Parameters.AddWithValue("@emailq_smtp_password", Left(emailq_smtp_password, 70))
      SqlCommand.Parameters.AddWithValue("@emailq_to", Left(emailq_to, 1500))
      SqlCommand.Parameters.AddWithValue("@emailq_cc", Left(emailq_cc, 1500))
      SqlCommand.Parameters.AddWithValue("@emailq_bcc", Left(emailq_bcc, 1500))
      SqlCommand.Parameters.AddWithValue("@emailq_subject", Left(emailq_subject, 300))
      SqlCommand.Parameters.AddWithValue("@emailq_body", emailq_body)
      SqlCommand.Parameters.AddWithValue("@emailq_entry_date", FormatDateTime(Now(), vbGeneralDate))
      SqlCommand.Parameters.AddWithValue("@emailq_status", "Open")
      SqlCommand.Parameters.AddWithValue("@emailq_onhold_flag", "N")
      SqlCommand.Parameters.AddWithValue("@emailq_html_flag", "Y")
      SqlCommand.Parameters.AddWithValue("@emailq_comp_id", emailq_comp_id)
      SqlCommand.Parameters.AddWithValue("@emailq_sub_id", emailq_sub_id)
      SqlCommand.Parameters.AddWithValue("@emailq_host_name", Left(emailq_host_name, 25))
      SqlCommand.Parameters.AddWithValue("@emailq_app_name", Left(emailq_app_name, 100))

      SqlCommand.ExecuteNonQuery()

      ResponseCode = True

      SqlCommand.Dispose()
      SqlCommand = Nothing


    Catch ex As Exception
      Me.class_error = Me.class_error & "Error in " & System.Reflection.MethodBase.GetCurrentMethod().Name.ToString & ": " & ex.Message & "<br />"
      Return Nothing
    Finally
      'kill everything
      SqlConn.Close()
      SqlConn.Dispose()
      SqlConn = Nothing

    End Try
    Return ResponseCode
  End Function

#End Region
#Region "View Information"
  Public Function Display_View_Information(ByVal view_id As Long) As DataTable

    Dim atemptable As New DataTable
    Dim sQuery = New StringBuilder()

    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader : SqlReader = Nothing
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Dim product_where = New StringBuilder()

    Dim sErrorString As String = ""
    Dim bHasServerNotes As Boolean = False
    Dim bHasStandardCloudNotes As Boolean = False

    Dim bHasHeli As Boolean = False
    Dim bHasBus As Boolean = False
    Dim bHasCom As Boolean = False
    Dim bHasSpi As Boolean = False
    Dim bHasBoat As Boolean = False
    Dim aclsData_Manager_SQL As New clsData_Manager_SQL

    Try

      If HttpContext.Current.Session.Item("localPreferences").loadUserSession(sErrorString, CLng(HttpContext.Current.Session.Item("localUser").crmSubSubID.ToString), HttpContext.Current.Session.Item("localUser").crmUserLogin.ToString, CLng(HttpContext.Current.Session.Item("localUser").crmSubSeqNo.ToString), CLng(HttpContext.Current.Session.Item("localUser").crmUserContactID.ToString)) Then

        bHasStandardCloudNotes = HttpContext.Current.Session.Item("localPreferences").HasCloudNotes
        bHasServerNotes = HttpContext.Current.Session.Item("localPreferences").HasServerNotes

        bHasHeli = HttpContext.Current.Session.Item("localPreferences").UserHelicopterFlag
        bHasBus = HttpContext.Current.Session.Item("localPreferences").UserBusinessFlag
        bHasCom = HttpContext.Current.Session.Item("localPreferences").UserCommercialFlag
        bHasSpi = HttpContext.Current.Session.Item("localPreferences").UserSPIViewFlag
        bHasBoat = HttpContext.Current.Session.Item("localPreferences").UserYachtFlag

      End If


      '1.	In our case for now we only want the views where evoview_seq_no > 2 (this is to eliminate the default and traditional settings)
      '2.	Only get active – as you currently are (there is also a beta flag and test flag that replace this on www.jetnetbeta.com and www.jetnettest.com) 
      '3.	Add standard product blocks – essentially if you are allowed business, then you can see the views flagged for business, etc.
      '4.	Handle the aerodex flag – if subscriber is aerodex, then only can see ones that are aerodex in addition to product flags
      '5.	Handle server notes flag – if not server notes, then say “and evoview_server_side_notes_flag<>’Y’” and you can just leave the requirement off if they have server notes.

      product_where.Append(Constants.cAndClause + "evoview_seq_no > 2" + Constants.cAndClause + "(")

      Dim sSeperator As String = ""

      If HttpContext.Current.Session.Item("jetnetWebHostType") = eWebHostTypes.EVOLUTION Then

        If bHasHeli Then
          product_where.Append("evoview_product_helicopter_flag = 'Y'")
          sSeperator = Constants.cOrClause
        End If

        If bHasBus Then
          product_where.Append(sSeperator + "evoview_product_business_flag = 'Y'")
          sSeperator = Constants.cOrClause
        End If

        If bHasCom Then
          product_where.Append(sSeperator + "evoview_product_commercial_flag = 'Y'")
          sSeperator = Constants.cOrClause
        End If

        If bHasBoat Then
          product_where.Append(sSeperator + "evoview_product_yacht_flag = 'Y'")
          sSeperator = Constants.cOrClause
        End If

        If bHasSpi Then
          product_where.Append(sSeperator + "evoview_id = 12")
          sSeperator = Constants.cOrClause
        End If

      ElseIf HttpContext.Current.Session.Item("jetnetWebHostType") = eWebHostTypes.YACHT Then

        product_where.Append("evoview_product_yacht_flag = 'Y'")
        sSeperator = Constants.cOrClause

        If bHasHeli Or bHasBus Or bHasCom Then
          product_where.Append(sSeperator + "evoview_id = 21 ") ' no other good way to do it , if no business sub - no crossover
        Else ' make sure no crossover if no bus,comm, or heli
          product_where.Append(" and evoview_id <> 21 ")
        End If

      End If

      ' for now only show notes view on test ...
      If ((bHasStandardCloudNotes Or bHasServerNotes) And (HttpContext.Current.Session.Item("jetnetWebSiteType") = eWebSiteTypes.TEST Or HttpContext.Current.Session.Item("jetnetWebSiteType") = eWebSiteTypes.LOCAL)) Then
        product_where.Append(sSeperator + "evoview_id = 25")
      End If

      product_where.Append(")")

      ' exclude view 15 "remiders view" only used on "old evo" at this time
      product_where.Append(Constants.cAndClause + "evoview_id <> 15")

      If bHasSpi Then
      Else
        product_where.Append(Constants.cAndClause + "evoview_id <> 12 ")
        product_where.Append(Constants.cAndClause + "evoview_id <> 27 ")
      End If

      'also exclude "any" view with evoview_crm_only_flag = 'N'
      product_where.Append(Constants.cAndClause + "evoview_crm_only_flag = 'N'")

      'if view is passed:
      If view_id > 0 Then
        product_where.Append(Constants.cAndClause + "evoview_id = " + view_id.ToString)
      End If

      'if this is a live environment and it is not an aerodex user. added local check for testing briefly
      If HttpContext.Current.Session.Item("jetnetWebSiteType") = eWebSiteTypes.LIVE And Not HttpContext.Current.Session("localSubscription").crmAerodexFlag Then
        sQuery.Append("SELECT * FROM Evolution_Views WITH(NOLOCK) WHERE evoview_active_flag = 'Y' " + product_where.ToString.Trim + " ")
        'if the enviroment is a test one and the user is an aerodex user.
      ElseIf (HttpContext.Current.Session.Item("jetnetWebSiteType") = eWebSiteTypes.TEST Or HttpContext.Current.Session.Item("jetnetWebSiteType") = eWebSiteTypes.LOCAL) And Not HttpContext.Current.Session("localSubscription").crmAerodexFlag Then
        sQuery.Append("SELECT * FROM Evolution_Views WITH(NOLOCK) WHERE evoview_test_active_flag = 'Y' " + product_where.ToString.Trim + " ")
        'if the environment is a beta one and the user is an aerodex user.
      ElseIf (HttpContext.Current.Session.Item("jetnetWebSiteType") = eWebSiteTypes.BETA Or HttpContext.Current.Session.Item("jetnetWebSiteType") = eWebSiteTypes.LOCAL) And Not HttpContext.Current.Session("localSubscription").crmAerodexFlag Then
        sQuery.Append("SELECT * FROM Evolution_Views WITH(NOLOCK) WHERE evoview_beta_active_flag = 'Y' " + product_where.ToString.Trim + " ")
        'if the environment is live, test or beta and the user is an aerodex user.

      ElseIf (HttpContext.Current.Session.Item("jetnetWebSiteType") = eWebSiteTypes.TEST) And HttpContext.Current.Session("localSubscription").crmAerodexFlag Then
        sQuery.Append("SELECT * FROM Evolution_Views WITH(NOLOCK) WHERE evoview_test_active_flag = 'Y' AND evoview_aerodex_flag = 'Y' " + product_where.ToString.Trim + " ")

      ElseIf (HttpContext.Current.Session.Item("jetnetWebSiteType") = eWebSiteTypes.LIVE Or HttpContext.Current.Session.Item("jetnetWebSiteType") = eWebSiteTypes.TEST Or HttpContext.Current.Session.Item("jetnetWebSiteType") = eWebSiteTypes.BETA Or HttpContext.Current.Session.Item("jetnetWebSiteType") = eWebSiteTypes.LOCAL) And HttpContext.Current.Session("localSubscription").crmAerodexFlag Then
        sQuery.Append("SELECT * FROM Evolution_Views WITH(NOLOCK) WHERE evoview_active_flag = 'Y' AND evoview_aerodex_flag = 'Y' " + product_where.ToString.Trim + " ")
      End If

      If aclsData_Manager_SQL.is_aerodex_insight() = True Then
      Else
        sQuery.Append(" and evoview_id <> 28 ")
      End If

      'added MSW - if you have evalues show the residual view, otherwise, dont show it 
      If clsGeneral.clsGeneral.isEValuesAvailable() = True Then
      Else
        sQuery.Append(" and evoview_id <> 31 ")
      End If

      sQuery.Append(" ORDER BY evoview_seq_no ")


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Display_View_Information()</b><br />" + sQuery.ToString.Trim

      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sQuery.ToString
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 90

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      SqlReader.Close()

    Catch ex As Exception
      Return Nothing
      Me.class_error = "Error in Display_View_Information() As DataTable SQL VERSION: " & ex.Message

    Finally

      SqlReader = Nothing

      SqlConn.Close()
      SqlConn.Dispose()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing

    End Try

    Return atemptable

  End Function
#End Region
#Region "Airport Queries"
  Public Function AirportList(ByVal field_length As Double, ByVal ICAO_Param As String, ByVal IATA_Param As String) As DataTable
    Dim sql As String = ""
    Dim aTempTable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try
      sql = "select top 1 aport_name, aport_city, aport_state, aport_country, aport_latitude_decimal, aport_longitude_decimal, aport_iata_code, aport_icao_code "
      sql += " from airport WITH(NOLOCK) "
      sql += " where aport_name <> '' "
      sql += " and aport_country <> '' "
      sql += " and aport_latitude_full <> '' "
      sql += " and aport_longitude_full <> '' "

      If field_length <> 0 Then
        sql += " and aport_max_runway_length is not null "
        sql += " and aport_max_runway_length >= " & field_length
      End If

      If IATA_Param <> "" Or ICAO_Param <> "" Then
        sql += " and ("
        If ICAO_Param <> "" Then
          sql += " aport_icao_code = '" & ICAO_Param & "'"
        End If
        If IATA_Param <> "" Then
          sql += " or aport_iata_code = '" & IATA_Param & "'"
        End If
        sql += ") "
      End If

      sql += " order by aport_name asc"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>AirportList(ByVal field_length As Double, ByVal Search_Query_Param As String) As DataTable</b><br />" & sql

      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable

    Catch ex As Exception
      AirportList = Nothing
      Me.class_error = "Error in AirportList(ByVal field_length As Double, ByVal Search_Query_Param As String) SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function
#End Region
#Region "Help Queries"
  ''' <summary>
  ''' Returns HelpData
  ''' </summary>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function HelpData(ByVal type_string As String, ByVal selected As String, ByVal IndividialID As Long, Optional ByVal selected_section As Boolean = False, Optional ByVal amod_id As Integer = 0) As DataTable
    Dim sql As String = ""
    Dim aTempTable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try
      If Trim(type_string) <> "H" And Trim(type_string) <> "YH" Then
        sql = "SELECT evonot_release_date, evonot_tabs, evonot_id, evonot_title, evonot_announcement, evonot_video, evonot_doc_link  "
      Else
        sql = "SELECT evotop_name, evonot_release_date, evonot_id, evonot_title, evonot_announcement, evonot_video, evonot_doc_link "
      End If

      sql += " FROM evolution_notifications "

      If Trim(type_string) = "H" Or Trim(type_string) = "YH" Then
        sql += " left outer join Evolution_Topic_Index on evonot_id=evotopind_evonot_id "
        sql += " left outer join Evolution_Topics on evotopind_evotop_id=evotop_id "
      End If

      If IndividialID <> 0 Then
        sql += " WHERE (evonot_id = " & IndividialID & " "
      Else
        If Trim(type_string) = "G" Then
          sql += " WHERE ((evonot_release_type = '" & type_string & "') "  '  or evonot_release_type = 'R ' commented out MSW - 4/1/19
        Else
          sql += " WHERE (evonot_release_type in ('" & type_string & "') "
        End If
      End If

      If HttpContext.Current.Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.EVO Then
        sql += " and evonot_evo_dotnet_flag = 'Y' "
      End If


      If amod_id > 0 Then
        sql += " and evonot_amod_id = " & amod_id & " "
      End If

      If Trim(type_string) = "JC" Then
        sql += "  and evonot_release_date >= '" & Date.Now() & "' "
      End If

      sql += " and evonot_active_flag = 'Y' "

      If Trim(selected) <> "" Then
        If selected_section = True Then
          sql += " and evotop_id in (" & Trim(selected) & ") "
        Else
          sql += " and evotop_name in (" & Trim(selected) & ") "
        End If

      End If

      sql += " ) "

      'added MSW - 6/21/17 - added to include other news from jetnet global, for JETNET News
      If Trim(type_string) = "N','J" Then
        sql += " or ( evonot_release_type in ('N', 'J') AND NOT evonot_product_crm_flag = 'Y'  AND NOT evonot_evo_dotnet_only_flag = 'Y' ) "
      End If


      If Trim(type_string) = "G" Then
        sql += " order by evonot_release_date desc "
      ElseIf Trim(type_string) = "H" Then
        sql += " and evonot_announcement is not NULL "
        sql += " order by evotop_name, evonot_title desc "
      ElseIf Trim(type_string) = "B" Then
        sql += " order by evonot_release_date desc "
      ElseIf Trim(type_string) = "N','J" Then
        sql += " order by evonot_release_date desc "
      ElseIf Trim(type_string) = "N" Then
        sql += " order by evonot_release_date desc "
      ElseIf Trim(type_string) = "JC" Then
        sql += " order by evonot_release_date asc "
      ElseIf Trim(type_string) = "EF" Then
        sql += " order by evonot_title asc "
      Else
        sql += " order by evonot_release_date desc "
      End If
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>HelpData(ByVal type_string As String, ByVal selected As String) As DataTable</b><br />" & sql

      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable

    Catch ex As Exception
      HelpData = Nothing
      Me.class_error = "Error in HelpData(ByVal type_string As String, ByVal selected As String) As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function

  Public Function Build_AC_Glossary_Based_On_Attributes(ByVal search_term As String) As DataTable
    Dim sql As String = ""
    Dim aTempTable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try

      sql = " select acatt_id as TOPID, left(acatt_name,1) as LETTER,acatt_name as TOPIC, "
      sql &= "case when acatt_description is not null and acatt_description <> '' then acatt_description  else "
      sql &= " replace(replace(STUFF((select acatt_description from Aircraft_Attribute with (NOLOCK) where (a.acatt_synonym_id=acatt_id ) FOR XML PATH('')),1,1,''), '</acatt_description>', '') , 'acatt_description>', '') "
      sql &= " end as DESCRIPTION"


      '-- THIS LINE DETERMINES THE NUMBER OF OVERALL SYNONYMS FOR MY TOPIC
      sql &= ",  replace(replace(STUFF((select acatt_name from Aircraft_Attribute with (NOLOCK) "
      sql &= "where (a.acatt_synonym_id=acatt_id "
      '  sql &= "or actop_id in (select distinct actop_id from aircraft_topic with (NOLOCK)  "
      '   sql &= "where a.actop_reference_id=actop_reference_id and a.actop_reference_id >0 and actop_id<>a.actop_id) "
      '   sql &= "or actop_id in (select distinct actop_id from aircraft_topic with (NOLOCK) "
      '   sql &= "where actop_reference_id=a.actop_id ) "
      sql &= ") FOR XML PATH('')),1,1,''), '</acatt_name>', '') , 'acatt_name>', '') as RELATED_TOPICS  "

      '-- THIS LINE DETERMINES THE NUMBER OF OVERALL SYNONYMS FOR MY TOPIC
      sql &= ",  replace(replace(STUFF((select acatt_name from Aircraft_Attribute with (NOLOCK) "
      sql &= "where (acatt_synonym_id=a.acatt_id "
      '  sql &= "or actop_id in (select distinct actop_id from aircraft_topic with (NOLOCK)  "
      '   sql &= "where a.actop_reference_id=actop_reference_id and a.actop_reference_id >0 and actop_id<>a.actop_id) "
      '   sql &= "or actop_id in (select distinct actop_id from aircraft_topic with (NOLOCK) "
      '   sql &= "where actop_reference_id=a.actop_id ) "
      sql &= ") FOR XML PATH('')),1,1,''), '</acatt_name>', '') , 'acatt_name>', '') as RELATED_TOPICS2  "


      sql &= " from Aircraft_Attribute a with (NOLOCK) "
      '  sql &= " where acatt_description Is Not NULL and datalength(acatt_description)> 0 "
      sql &= " where acatt_glossary = 'Y'  "

      If Trim(search_term) <> "" Then
        sql &= " and (acatt_name like '%" & Trim(search_term) & "%' or acatt_description like '%" & Trim(search_term) & "%') "
      End If

      sql &= " order by acatt_name"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>HelpData(ByVal type_string As String, ByVal selected As String) As DataTable</b><br />" & sql

      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable

    Catch ex As Exception
      Build_AC_Glossary_Based_On_Attributes = Nothing
      Me.class_error = "Error in HelpData(ByVal type_string As String, ByVal selected As String) As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function
  Public Function Build_AC_Glossary(ByVal search_term As String) As DataTable
    Dim sql As String = ""
    Dim aTempTable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try

      sql = " select actop_id as TOPID, left(actop_name,1) as LETTER,actop_name as TOPIC, actop_description as DESCRIPTION"

      '-- THIS LINE DETERMINES THE NUMBER OF OVERALL SYNONYMS FOR MY TOPIC
      sql &= ",  STUFF((select actop_name from aircraft_topic with (NOLOCK) "
      sql &= "where (a.actop_reference_id=actop_id "
      sql &= "or actop_id in (select distinct actop_id from aircraft_topic with (NOLOCK)  "
      sql &= "where a.actop_reference_id=actop_reference_id and a.actop_reference_id >0 and actop_id<>a.actop_id) "
      sql &= "or actop_id in (select distinct actop_id from aircraft_topic with (NOLOCK) "
      sql &= "where actop_reference_id=a.actop_id ) "
      sql &= ") FOR XML PATH('')),1,1,'') as RELATED_TOPICS  "

      sql &= " from aircraft_topic a with (NOLOCK) "
      sql &= " where actop_description Is Not NULL and datalength(actop_description)> 0 "

      If Trim(search_term) <> "" Then
        sql &= " and (actop_name like '%" & Trim(search_term) & "%' or actop_description like '%" & Trim(search_term) & "%') "
      End If

      sql &= " order by actop_name"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>HelpData(ByVal type_string As String, ByVal selected As String) As DataTable</b><br />" & sql

      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable

    Catch ex As Exception
      Build_AC_Glossary = Nothing
      Me.class_error = "Error in HelpData(ByVal type_string As String, ByVal selected As String) As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function
  Public Function Build_Yacht_Glossary(ByVal search_term As String) As DataTable
    Dim sql As String = ""
    Dim aTempTable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try

      sql = " select yttop_id as TOPID, left(yttop_name,1) as LETTER,yttop_name as TOPIC, yttop_description as DESCRIPTION"


      '-- THIS LINE DETERMINES THE NUMBER OF OVERALL SYNONYMS FOR MY TOPIC
      sql &= ",  STUFF((select yttop_name from yacht_topic with (NOLOCK) "
      sql &= "where (a.yttop_reference_id=yttop_id "

      sql &= "or yttop_id in (select distinct yttop_id from yacht_topic with (NOLOCK) "
      sql &= "where a.yttop_reference_id=yttop_reference_id and a.yttop_reference_id >0 and yttop_id<>a.yttop_id)"

      sql &= "or yttop_id in (select distinct yttop_id from yacht_topic with (NOLOCK) "
      sql &= "where yttop_reference_id=a.yttop_id )"
      sql &= ") FOR XML PATH('')),1,1,'') as RELATED_TOPICS "
      sql &= " from Yacht_topic a with (NOLOCK) "


      sql &= " where yttop_description Is Not NULL and datalength(yttop_description)> 0 "


      If Trim(search_term) <> "" Then
        sql &= " and (yttop_name like '%" & Trim(search_term) & "%' or yttop_description like '%" & Trim(search_term) & "%') "
      End If


      sql &= " order by yttop_name"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>HelpData(ByVal type_string As String, ByVal selected As String) As DataTable</b><br />" & sql

      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable

    Catch ex As Exception
      Build_Yacht_Glossary = Nothing
      Me.class_error = "Error in HelpData(ByVal type_string As String, ByVal selected As String) As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function
#End Region
#Region "Analytics"
#Region "Content Stats"
  ''' <summary>
  ''' Inserts a row in the content stat table
  ''' </summary>
  ''' <param name="ContactID"></param>
  ''' <param name="AC_ID"></param>
  ''' <param name="CompanyID"></param>
  ''' <param name="WantedID"></param>
  ''' <param name="JournalID"></param>
  ''' <param name="ViewID"></param>
  ''' <param name="subID"></param>
  ''' <param name="userLogin"></param>
  ''' <param name="seqNO"></param>
  ''' <param name="SubscriptionContactID"></param>
  ''' <returns></returns>
  ''' <remarks></remarks> 
  Public Function Insert_Content_Stat(ByVal Now_Date As System.DateTime, ByVal ContactID As Long, ByVal AC_ID As Long, ByVal ModelID As Long, ByVal CompanyID As Long, ByVal WantedID As Long, ByVal JournalID As Long, ByVal ViewID As Long, ByVal subID As Long, ByVal userLogin As String, ByVal seqNO As Long, ByVal SubscriptionContactID As Long) As Integer
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim strInsert As String = ""

    Try
      'make sure there's a session set.
      If HttpContext.Current.Session.Item("crmUserLogon") = True Then
        If subID <> 0 And userLogin <> "" And seqNO <> 0 Then
          SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
          SqlConn.Open()
          SqlCommand.Connection = SqlConn
          Now_Date = FormatDateTime(Now_Date, vbGeneralDate)

          strInsert = " insert into Evolution_Content_Stats (ecs_sub_id, ecs_login, ecs_seq_no, ecs_subins_contact_id, ecs_datetime, ecs_ac_id, "
          strInsert &= " ecs_comp_id, ecs_contact_id, ecs_wanted_id, ecs_journ_id, ecs_view_id, ecs_amod_id "
          strInsert &= ") values (" & subID & ", '" & Trim(userLogin) & "', " & seqNO & ", " & SubscriptionContactID & ", '" & Now_Date & "', " & AC_ID & ", "
          strInsert &= CompanyID & ", " & ContactID & ", " & WantedID & ", " & JournalID & ", " & ViewID & ", " & ModelID & ")"

          SqlCommand.CommandText = strInsert
          SqlCommand.ExecuteNonQuery()

          clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, strInsert)
          strInsert = ""
          Insert_Content_Stat = 1
        End If
      End If


    Catch ex As Exception
      Insert_Content_Stat = 0
      Me.class_error = "Error in Insert_Content_Stat(ByVal ContactID As Long, ByVal AC_ID As Long, ByVal CompanyID As Long, ByVal WantedID As Long, ByVal JournalID As Long, ByVal ViewID As Long, ByVal subID As Long, ByVal userLogin As String, ByVal seqNO As Long, SubscriptionContactID As long) As Integer " & ex.Message
    Finally
      SqlCommand.Dispose()
      SqlConn.Close()
      SqlConn.Dispose()
    End Try
  End Function
#End Region


  ''' <summary>
  ''' This displays Analytics based on a Company ID of aircraft
  ''' </summary>
  ''' <param name="companyID"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function DisplayACAnalyticInfoBasedOnCompanyID(ByVal companyID As Long, ByVal aircraftID As Long) As DataTable
    Dim aTempTable As New DataTable
    Dim sql As String = ""
    Dim sqlWhere As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Try


      sql = "select distinct amod_make_name, amod_id, amod_model_name, ac_ser_no_full, ac_reg_no, acs_name, ac_id, ac_list_date,"
      'sql += " (select count(*) as tcount from Evolution_Content_Stats where ecs_ac_id=ac_id"
      'sql += " and ecs_sub_id not in (select distinct sub_id from Subscription where sub_comp_id = " & companyID & ")"
      'sql += " and ecs_sub_id not in (select distinct sub_id from Subscription where sub_comp_id = 135887)"
      'sql += ") as tcount "
      sql += "(select count(*) as tcount "
      sql += " from Subscription_Install_Log with (NOLOCK) "
      sql += " where subislog_ac_id = ac_id "
      sql += " and subislog_msg_type='UserStatistics' and (subislog_date >  ac_list_date or  ac_list_date is null) "
      sql += " and subislog_subid not in (select distinct sub_id from Subscription where sub_comp_id = " & companyID & ") "
      sql += " and subislog_subid not in (select distinct sub_id from Subscription where sub_comp_id = 135887)) as tcount "

      sql += " from View_Aircraft_Company_Flat with (NOLOCK) "


      If companyID <> 135887 Or aircraftID = 0 Then
        sqlWhere = " comp_id = " & companyID
      End If

      If aircraftID <> 0 Then
        If sqlWhere <> "" Then
          sqlWhere += " and "
        End If
        sqlWhere += " ac_id = " & aircraftID
      End If

      If sqlWhere <> "" Then
        sqlWhere += " and "
      End If
      sqlWhere += "  ac_lifecycle_stage < 4 and ac_journ_id = 0 "

      If sqlWhere <> "" Then
        sqlWhere = " where " & sqlWhere
      End If
      sql += sqlWhere


      sql += " group by amod_make_name, amod_model_name, ac_ser_no_full, ac_reg_no, acs_name, ac_id, amod_id, ac_list_date"
      sql += " order by amod_make_name, amod_model_name, ac_ser_no_full"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>DisplayACAnalyticInfoBasedOnCompanyID(ByVal companyID As Long) As DataTable</b><br />" & sql


      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable
    Catch ex As Exception
      DisplayACAnalyticInfoBasedOnCompanyID = Nothing
      Me.class_error = "Error in DisplayACAnalyticInfoBasedOnCompanyID(ByVal companyID As Long) As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try


  End Function




  ''' <summary>
  ''' This displays Analytics based on a Company ID for Companies
  ''' </summary>
  ''' <param name="companyID"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function DisplayAnalyticInformationSummarizedByDate(ByVal companyID As Long, ByVal acID As Long, Optional ByVal yacht_id As Long = 0, Optional ByVal bIsDealer As Boolean = False, Optional ByRef has_stats As Boolean = False, Optional ByRef count_since_date_listed As Integer = 0, Optional ByVal days_on_market As String = "") As DataTable
    Dim aTempTable As New DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim temp_count As Integer = 0
    Dim sql_end As String = ""
    Dim sql_count As String = ""
    Dim temp_Date As String = ""

    Try



      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>DisplayAnalyticInformationSummarizedByDate(ByVal companyID As Long, ByVal acID As Long) As DataTable</b><br />" & sql

      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      '--- ADDED MSW - to speed up search - only do if u have ac------
      sql = " select COUNT(*) as tcount from Aircraft_Reference with (NOLOCK) where cref_comp_id = " & companyID.ToString & " and cref_journ_id = 0 and cref_contact_type in ('99','98','93') "

      SqlCommand.CommandText = sql
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 120

      SqlReader = SqlCommand.ExecuteReader()

      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      If Not IsNothing(aTempTable) Then
        If aTempTable.Rows.Count > 0 Then
          For Each r As DataRow In aTempTable.Rows
            If Not IsDBNull(r.Item("tcount")) Then
              temp_count = r.Item("tcount")
              If temp_count > 0 Then
                has_stats = True
              Else
                has_stats = False
              End If
            Else
              has_stats = False
            End If
          Next
        End If
      End If

      aTempTable.Clear()
      SqlReader.Close()
      '---------------------------------------------------------------


      If acID = 0 Then

        If bIsDealer Then
          sql = " SELECT DISTINCT YEAR(subislog_date) AS YTYEAR, MONTH(subislog_date) AS YTMONTH, subislog_comp_id, COUNT(*) AS tcount"
        Else
          sql = " SELECT DISTINCT YEAR(subislog_date) AS YTYEAR, MONTH(subislog_date) AS YTMONTH, COUNT(*) AS tcount"
        End If

        If has_stats = True Then
          If bIsDealer Then
            sql += ", (SELECT count(*) FROM ABI_Content_stats WITH(NOLOCK) WHERE abistat_comp_id = subislog_comp_id AND abistat_ac_id = 0 AND abistat_wanted_id = 0"
          Else
            sql += ", (SELECT count(*) FROM ABI_Content_stats WITH(NOLOCK) WHERE abistat_ac_id = subislog_ac_id"
          End If

          sql += " AND abistat_datetime >= DATEADD(d,-365,getdate())"
          sql += " AND YEAR(abistat_datetime) = YEAR(subislog_date) AND MONTH(abistat_datetime) = MONTH(subislog_date)) AS gcount"
        End If

      Else

        If bIsDealer Then
          sql = " SELECT DISTINCT YEAR(subislog_date) AS YTYEAR, MONTH(subislog_date) AS YTMONTH, COUNT(*) AS tcount"
        End If

        If has_stats = True Then
          If bIsDealer Then
            sql += ", (SELECT count(*) FROM ABI_Content_stats WITH(NOLOCK) WHERE abistat_ac_id = subislog_ac_id"
          End If

          If Trim(days_on_market) <> "" Then
            sql += " AND abistat_datetime >= '" & FormatDateTime(DateAdd(DateInterval.Day, -days_on_market, Date.Now()), DateFormat.ShortDate) & "' "
          Else
            sql += " AND abistat_datetime >= DATEADD(d,-365,getdate())"
          End If

          sql += " AND YEAR(abistat_datetime) = YEAR(subislog_date) AND MONTH(abistat_datetime) = MONTH(subislog_date)) AS gcount"
        End If

      End If






      sql += " FROM Subscription_Install_Log  WITH(NOLOCK) "

      If yacht_id = 0 Then
        If acID = 0 Then
          If companyID <> 0 Then
            sql += " WHERE subislog_comp_id = " + companyID.ToString
            sql += " AND subislog_subid NOT IN (SELECT DISTINCT sub_id FROM Subscription WITH(NOLOCK) WHERE sub_comp_id = 135887 OR sub_comp_id = " + companyID.ToString + ")"
          End If
        End If

        If acID <> 0 Then
          sql += " WHERE subislog_ac_id = " + acID.ToString
          sql += " AND subislog_subid NOT IN (SELECT DISTINCT sub_id FROM Subscription WITH(NOLOCK) WHERE sub_comp_id = 135887"
          sql += " OR sub_comp_id = " + companyID.ToString
          sql += ")"
        End If
      Else
        sql += " WHERE subislog_yt_id = " + yacht_id.ToString
      End If

      sql += " AND subislog_msg_type='UserStatistics'"

      '-----------------ADDED IN MSW - TO COUNT STATS SINCE DATE LISTED----------------
      If Trim(days_on_market) <> "" Then

        temp_Date = DateAdd(DateInterval.Day, -days_on_market, Date.Now())
        ' sql += " and subislog_date >= DATEADD(d,-" & DOMNumber & ",getdate())"
        sql_count += " and subislog_date >= '" & FormatDateTime(temp_Date, DateFormat.ShortDate) & "' "
        'sql_count = " AND subislog_date >= '" & DateAdd(DateInterval.Day, -days_on_market, Date.Now()) & "' "

        If has_stats = False Then
          If bIsDealer Then
            sql_count += " GROUP BY YEAR(subislog_date), month(subislog_date)"
          Else
            sql_count += " GROUP BY YEAR(subislog_date), month(subislog_date)"
          End If
        Else
          If bIsDealer Then
            sql_count += " GROUP BY subislog_ac_id, YEAR(subislog_date), month(subislog_date), subislog_comp_id"
          Else
            sql_count += " GROUP BY subislog_ac_id, YEAR(subislog_date), month(subislog_date)"
          End If
        End If

        SqlCommand.CommandText = sql & sql_count
        SqlCommand.CommandType = CommandType.Text
        SqlCommand.CommandTimeout = 120

        SqlReader = SqlCommand.ExecuteReader()

        Try
          aTempTable.Load(SqlReader)
        Catch constrExc As System.Data.ConstraintException
          Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
        End Try

        If Not IsNothing(aTempTable) Then
          If aTempTable.Rows.Count > 0 Then
            For Each r As DataRow In aTempTable.Rows
              If Not IsDBNull(r.Item("tcount")) Then
                count_since_date_listed = count_since_date_listed + r.Item("tcount")
              End If
            Next
          End If
        End If

        aTempTable.Clear()
        SqlReader.Close()
      End If

      '-----------------ADDED IN MSW - TO COUNT STATS SINCE DATE LISTED---------------- 



      If Trim(days_on_market) <> "" Then
        sql_end = " AND subislog_date >= '" & FormatDateTime(DateAdd(DateInterval.Day, -days_on_market, Date.Now()), DateFormat.ShortDate) & "' "
      Else
        sql_end = " AND subislog_date >= DATEADD(d,-365,getdate())"
      End If





      If has_stats = False Then
        If bIsDealer Then
          sql_end += " GROUP BY YEAR(subislog_date), month(subislog_date), subislog_comp_id"
        Else
          sql_end += " GROUP BY YEAR(subislog_date), month(subislog_date)"
        End If
      Else
        If bIsDealer Then
          sql_end += " GROUP BY subislog_ac_id, YEAR(subislog_date), month(subislog_date), subislog_comp_id"
        Else
          sql_end += " GROUP BY subislog_ac_id, YEAR(subislog_date), month(subislog_date)"
        End If
      End If
      sql_end += " ORDER BY YEAR(subislog_date), month(subislog_date)"

      SqlCommand.CommandText = sql & sql_end
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 120

      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable
    Catch ex As Exception
      DisplayAnalyticInformationSummarizedByDate = Nothing
      Me.class_error = "Error in DisplayAnalyticInformationSummarizedByDate(ByVal companyID As Long, ByVal acID As Long) As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try


  End Function


  ''' <summary>
  ''' Displays AnalyticInformation Comparing Model
  ''' </summary>
  ''' <param name="modelID"></param>
  ''' <param name="acID"></param>
  ''' <returns></returns>
  ''' <remarks></remarks> 
  Public Function DisplayAnalyticInformationComparingModel(ByVal modelID As Long, ByVal acID As Long, ByVal companyID As Long, ByVal DOMNumber As Integer) As DataTable
    Dim aTempTable As New DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim temp_Date As String = ""
    Try


      sql = " select COUNT(*) as totcount, count(distinct subislog_ac_id) as account, "
      sql += " (case when count(distinct subislog_ac_id)=0 then 0 else (COUNT(*)/count(distinct subislog_ac_id)) end)as avgclick  "
      sql += " from Subscription_Install_Log"
      sql += " where subislog_ac_id > 0"
      sql += " and subislog_msg_type='UserStatistics'"
      sql += " and subislog_amod_id = " & modelID
      sql += " and subislog_ac_id <> " & acID
      sql += " and subislog_ac_id in (select distinct ac_id from Aircraft_Flat where amod_id = " & modelID & " and ac_forsale_flag='Y' and ac_journ_id = 0) "
      sql += " and subislog_subid not in (select distinct sub_id from Subscription where sub_comp_id = 135887 or sub_comp_id = " & companyID & ") "


      temp_Date = DateAdd(DateInterval.Day, -DOMNumber, Date.Now())
      ' sql += " and subislog_date >= DATEADD(d,-" & DOMNumber & ",getdate())"
      sql += " and subislog_date >= '" & FormatDateTime(temp_Date, DateFormat.ShortDate) & "' "

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>DisplayAnalyticInformationComparingModel(ByVal modelID As Long, ByVal acID As Long) As DataTable</b><br />" & sql


      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable
    Catch ex As Exception
      DisplayAnalyticInformationComparingModel = Nothing
      Me.class_error = "Error in DisplayAnalyticInformationComparingModel(ByVal modelID As Long, ByVal acID As Long) As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try


  End Function
#End Region
#Region "Custom Export Tab"
  ''' <summary>
  ''' List of tabs based on the main name for the advanced search
  ''' </summary>
  ''' <param name="main_name"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function ListofTabsForCustomSearch(ByVal main_name As String) As DataTable
    Dim sql As String = ""
    Dim aTempTable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try
      sql = "select cefstab_sub_name, cefstab_id"
      sql += " from Custom_Export_Tab "
      sql += " where cefstab_main_name='" & main_name & "'"
      sql += " order by cefstab_order"

      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable

    Catch ex As Exception
      ListofTabsForCustomSearch = Nothing
      Me.class_error = "Error in ListofTabsForCustomSearch(ByVal main_name As String) As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function

  '''' <summary>
  '''' 'This takes a tab ID and displays a list of fields.
  '''' </summary>
  '''' <param name="tabID"></param>
  '''' <returns></returns>
  '''' <remarks></remarks>
  'Public Function ListofTabsFieldsBasedonTabID(ByVal tabID As Integer) As DataTable
  '  Dim sql As String = ""
  '  Dim aTempTable As New DataTable
  '  Dim SqlConn As New SqlClient.SqlConnection
  '  Dim SqlCommand As New SqlClient.SqlCommand
  '  Dim SqlReader As SqlClient.SqlDataReader
  '  Dim SqlException As SqlClient.SqlException : SqlException = Nothing

  '  Try


  '    aTempTable.Columns.Add("cef_id")
  '    aTempTable.Columns.Add("cefsblk_name")
  '    aTempTable.Columns.Add("cef_display")
  '    aTempTable.Columns.Add("cef_evo_field_name")
  '    aTempTable.Columns.Add("cef_sort")
  '    aTempTable.Columns.Add("cef_field_type")
  '    aTempTable.Columns.Add("cef_field_length")
  '    aTempTable.Columns.Add("cef_help_topic_id")
  '    aTempTable.Columns.Add("cef_definition")
  '    aTempTable.Columns.Add("cef_values")
  '    aTempTable.Columns.Add("cef_link")
  '    aTempTable.Columns.Add("cef_list_select_query")

  '    sql = "select cef_id , cefsblk_name, cef_display, cef_list_select_query, cef_evo_field_name, "
  '    sql += " cef_sort, cef_field_type, cef_field_length, cef_help_topic_id, cef_definition,"
  '    sql += " cef_values "
  '    sql += " from Custom_Export_Fields"
  '    sql += " inner join Custom_Export_Tab on cef_export_tab_id = cefstab_id"
  '    sql += " inner join Custom_Export_Block on cef_export_block_id = cefsblk_id"
  '    sql += " where cef_evo_flag = 'Y'"

  '    If HttpContext.Current.Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.YACHT Then
  '      sql += " and cef_product_yacht_flag = 'Y'  "
  '    End If
  '    sql += " and cef_advanced_search_flag='Y'  "
  '    sql += " and cef_evo_field_name <> ''"


  '    sql += " and cef_export_tab_id=" & tabID

  '    If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Then
  '      sql += " and cef_product_aerodex_flag='Y'"
  '    End If

  '    sql += " order by cefsblk_order, cef_sort, cef_display"


  '    clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

  '    SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
  '    SqlConn.Open()
  '    SqlCommand.Connection = SqlConn


  '    SqlCommand.CommandText = sql
  '    SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
  '    SqlCommand.CommandType = CommandType.Text
  '    SqlCommand.CommandTimeout = 60

  '    While SqlReader.Read()
  '      Dim newCustomersRow As DataRow = aTempTable.NewRow()
  '      Dim TemporarySelectQuery As Object = Nothing

  '      newCustomersRow("cef_id") = SqlReader.Item("cef_id")
  '      newCustomersRow("cefsblk_name") = SqlReader.Item("cefsblk_name")
  '      newCustomersRow("cef_display") = SqlReader.Item("cef_display")
  '      newCustomersRow("cef_evo_field_name") = SqlReader.Item("cef_evo_field_name")
  '      newCustomersRow("cef_sort") = SqlReader.Item("cef_sort")
  '      newCustomersRow("cef_field_length") = SqlReader.Item("cef_field_length")
  '      newCustomersRow("cef_help_topic_id") = SqlReader.Item("cef_help_topic_id")
  '      newCustomersRow("cef_definition") = SqlReader.Item("cef_definition")

  '      newCustomersRow("cef_link") = ""

  '      newCustomersRow("cef_values") = SqlReader.Item("cef_values")
  '      newCustomersRow("cef_field_type") = SqlReader.Item("cef_field_type")

  '      TemporarySelectQuery = SqlReader.Item("cef_list_select_query")

  '      If Not IsDBNull(TemporarySelectQuery) Then
  '        If Not String.IsNullOrEmpty(TemporarySelectQuery) Then
  '          newCustomersRow("cef_field_type") = "Char"
  '          Dim TemporarySQL As String = Replace(TemporarySelectQuery, ":", "'")

  '          newCustomersRow("cef_list_select_query") = TemporarySQL
  '          newCustomersRow("cef_values") = RunDynamicCEF_List_Select_Query(TemporarySQL)
  '        End If
  '      End If

  '      aTempTable.Rows.Add(newCustomersRow)
  '      aTempTable.AcceptChanges()
  '    End While

  '    'Try
  '    '    aTempTable.Load(SqlReader)
  '    'Catch constrExc As System.Data.ConstraintException
  '    '    Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
  '    'End Try


  '    'We need to add a generic field to the general tab.
  '    If tabID = 1 Then
  '      Dim newCustomersRow As DataRow = aTempTable.NewRow()
  '      newCustomersRow.Item("cefsblk_name") = "General"
  '      newCustomersRow.Item("cef_id") = "0"
  '      newCustomersRow.Item("cef_display") = "General Details/Avionics"
  '      newCustomersRow.Item("cef_evo_field_name") = "generic_data_description"
  '      newCustomersRow.Item("cef_link") = ""
  '      newCustomersRow.Item("cef_sort") = "0"
  '      newCustomersRow.Item("cef_field_type") = "String"
  '      newCustomersRow.Item("cef_field_length") = "150"
  '      newCustomersRow.Item("cef_help_topic_id") = "0"
  '      newCustomersRow.Item("cef_definition") = "General Details/Avionics Search Criteria"
  '      newCustomersRow.Item("cef_values") = ""
  '      newCustomersRow("cef_list_select_query") = ""
  '      aTempTable.Rows.Add(newCustomersRow)
  '      aTempTable.AcceptChanges()
  '    End If
  '    'And to the Interior Exterior Tab:
  '    If tabID = 5 Then
  '      Dim newCustomersRow As DataRow = aTempTable.NewRow()
  '      newCustomersRow.Item("cefsblk_name") = "Interior/Exterior"
  '      newCustomersRow.Item("cef_id") = "0"
  '      newCustomersRow.Item("cef_display") = "Interior/Exterior Details"
  '      newCustomersRow.Item("cef_evo_field_name") = "int_ext_generic_data_description"
  '      newCustomersRow.Item("cef_link") = ""
  '      newCustomersRow.Item("cef_sort") = "0"
  '      newCustomersRow.Item("cef_field_type") = "String"
  '      newCustomersRow.Item("cef_field_length") = "150"
  '      newCustomersRow.Item("cef_help_topic_id") = "0"
  '      newCustomersRow.Item("cef_definition") = "Interior/Exterior Search Criteria"
  '      newCustomersRow.Item("cef_values") = ""
  '      newCustomersRow("cef_list_select_query") = ""

  '      aTempTable.Rows.InsertAt(newCustomersRow, 0)
  '      aTempTable.AcceptChanges()
  '    End If
  '    'avionics
  '    If tabID = 6 Then
  '      Dim newCustomersRow As DataRow = aTempTable.NewRow()
  '      newCustomersRow.Item("cefsblk_name") = "Avionics/Cockpit"
  '      newCustomersRow.Item("cef_id") = "0"
  '      newCustomersRow.Item("cef_display") = "Avionics/Cockpit Details"
  '      newCustomersRow.Item("cef_evo_field_name") = "avionics_generic_data_description"
  '      newCustomersRow.Item("cef_link") = "MasterLists.aspx?helplist=avionics"
  '      newCustomersRow.Item("cef_sort") = "0"
  '      newCustomersRow.Item("cef_field_type") = "String"
  '      newCustomersRow.Item("cef_field_length") = "150"
  '      newCustomersRow.Item("cef_help_topic_id") = "0"
  '      newCustomersRow.Item("cef_definition") = "Avionics/Cockpit Details Search Criteria"
  '      newCustomersRow.Item("cef_values") = ""
  '      newCustomersRow("cef_list_select_query") = ""

  '      aTempTable.Rows.InsertAt(newCustomersRow, 0)
  '      aTempTable.AcceptChanges()
  '    End If

  '    'GENERIC EQUIPMENT/MAINTENANCE DETAILS SEARCH CRITERIA
  '    If tabID = 7 Then
  '      Dim newCustomersRow As DataRow = aTempTable.NewRow()
  '      newCustomersRow.Item("cefsblk_name") = "Equipment/Maintenance"
  '      newCustomersRow.Item("cef_id") = "0"
  '      newCustomersRow.Item("cef_display") = "Equipment/Maintenance Details"
  '      newCustomersRow.Item("cef_evo_field_name") = "eqp_main_generic_data_description"
  '      newCustomersRow.Item("cef_link") = ""
  '      newCustomersRow.Item("cef_sort") = "0"
  '      newCustomersRow.Item("cef_field_type") = "String"
  '      newCustomersRow.Item("cef_field_length") = "150"
  '      newCustomersRow.Item("cef_help_topic_id") = "0"
  '      newCustomersRow.Item("cef_definition") = "Equipment/Maintenance Details Search Criteria"
  '      newCustomersRow.Item("cef_values") = ""
  '      newCustomersRow("cef_list_select_query") = ""

  '      aTempTable.Rows.InsertAt(newCustomersRow, 0)
  '      aTempTable.AcceptChanges()
  '    End If

  '    Return aTempTable

  '  Catch ex As Exception
  '    ListofTabsFieldsBasedonTabID = Nothing
  '    Me.class_error = "Error in ListofTabsFieldsBasedonTabID(ByVal tabID As Integer) As DataTable: SQL VERSION " & ex.Message
  '  Finally
  '    SqlReader = Nothing

  '    SqlConn.Dispose()
  '    SqlConn.Close()
  '    SqlConn = Nothing

  '    SqlCommand.Dispose()
  '    SqlCommand = Nothing
  '  End Try

  'End Function
  ''' <summary>
  ''' 'Edited - this queries cache as opposed to the database.
  ''' </summary>
  ''' <param name="tabID"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function ListofTabsFieldsBasedonTabID(ByVal tabID As Integer) As DataTable
    Dim sql As String = ""
    Dim sqlSort As String = ""
    Dim aTempTable As New DataTable
    Dim dalTable As New DataTable

    Try
      'First we should make sure cache exists:
      FillCachedAdvancedSearchBoxes() 'This will just check if it's there. If it isn't, it fills it up.

      If Not IsNothing(HttpContext.Current.Cache("CachedAdvancedTabs")) Then
        aTempTable = HttpContext.Current.Cache("CachedAdvancedTabs")
        dalTable = aTempTable.Clone

        sql = " cef_evo_flag = 'Y'"

        If HttpContext.Current.Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.YACHT Then
          sql += " and cef_product_yacht_flag = 'Y'  "
        End If

        sql += " and cef_advanced_search_flag='Y'  "
        sql += " and cef_evo_field_name <> ''"
        sql += " and cef_export_tab_id=" & tabID

        If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True Then
          sql += " and cef_product_aerodex_flag='Y'"
        End If



        sqlSort = " cefsblk_order, cef_sort, cef_display"


        Dim afilteredData As DataRow() = aTempTable.Select(sql, sqlSort)
        ' extract and import
        For Each atmpDataRow In afilteredData
          dalTable.ImportRow(atmpDataRow)
        Next

        'clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, "DataTable Filter on Advanced Search:" & sql & " " & sqlSort)


        'We need to add a generic field to the general tab.
        If tabID = 1 Then
          Dim newCustomersRow As DataRow = dalTable.NewRow()
          newCustomersRow.Item("cefsblk_name") = "General"
          newCustomersRow.Item("cef_id") = "0"
          newCustomersRow.Item("cef_display") = "General Details/Avionics"
          newCustomersRow.Item("cef_evo_field_name") = "generic_data_description"
          newCustomersRow.Item("cef_link") = ""
          newCustomersRow.Item("cef_sort") = "0"
          newCustomersRow.Item("cef_field_type") = "String"
          newCustomersRow.Item("cef_field_length") = "150"
          newCustomersRow.Item("cef_help_topic_id") = "0"
          newCustomersRow.Item("cef_definition") = "General Details/Avionics Search Criteria"
          newCustomersRow.Item("cef_values") = ""
          newCustomersRow("cef_list_select_query") = ""
          dalTable.Rows.Add(newCustomersRow)
          dalTable.AcceptChanges()
        End If
        'And to the Interior Exterior Tab:
        If tabID = 5 Then
          Dim newCustomersRow As DataRow = dalTable.NewRow()
          newCustomersRow.Item("cefsblk_name") = "Interior/Exterior"
          newCustomersRow.Item("cef_id") = "0"
          newCustomersRow.Item("cef_display") = "Interior/Exterior Details"
          newCustomersRow.Item("cef_evo_field_name") = "int_ext_generic_data_description"
          newCustomersRow.Item("cef_link") = ""
          newCustomersRow.Item("cef_sort") = "0"
          newCustomersRow.Item("cef_field_type") = "String"
          newCustomersRow.Item("cef_field_length") = "150"
          newCustomersRow.Item("cef_help_topic_id") = "0"
          newCustomersRow.Item("cef_definition") = "Interior/Exterior Search Criteria"
          newCustomersRow.Item("cef_values") = ""
          newCustomersRow("cef_list_select_query") = ""

          dalTable.Rows.InsertAt(newCustomersRow, 0)
          dalTable.AcceptChanges()
        End If
        'avionics
        If tabID = 6 Then
          Dim newCustomersRow As DataRow = dalTable.NewRow()
          newCustomersRow.Item("cefsblk_name") = "Avionics/Cockpit"
          newCustomersRow.Item("cef_id") = "0"
          newCustomersRow.Item("cef_display") = "Avionics/Cockpit Details"
          newCustomersRow.Item("cef_evo_field_name") = "avionics_generic_data_description"
          newCustomersRow.Item("cef_link") = "MasterLists.aspx?helplist=avionics"
          newCustomersRow.Item("cef_sort") = "0"
          newCustomersRow.Item("cef_field_type") = "String"
          newCustomersRow.Item("cef_field_length") = "150"
          newCustomersRow.Item("cef_help_topic_id") = "0"
          newCustomersRow.Item("cef_definition") = "Avionics/Cockpit Details Search Criteria"
          newCustomersRow.Item("cef_values") = ""
          newCustomersRow("cef_list_select_query") = ""

          dalTable.Rows.InsertAt(newCustomersRow, 0)
          dalTable.AcceptChanges()
        End If

        'GENERIC EQUIPMENT/MAINTENANCE DETAILS SEARCH CRITERIA
        If tabID = 7 Then
          Dim newCustomersRow As DataRow = dalTable.NewRow()
          newCustomersRow.Item("cefsblk_name") = "Equipment/Maintenance"
          newCustomersRow.Item("cef_id") = "0"
          newCustomersRow.Item("cef_display") = "Equipment/Maintenance Details"
          newCustomersRow.Item("cef_evo_field_name") = "eqp_main_generic_data_description"
          newCustomersRow.Item("cef_link") = ""
          newCustomersRow.Item("cef_sort") = "0"
          newCustomersRow.Item("cef_field_type") = "String"
          newCustomersRow.Item("cef_field_length") = "150"
          newCustomersRow.Item("cef_help_topic_id") = "0"
          newCustomersRow.Item("cef_definition") = "Equipment/Maintenance Details Search Criteria"
          newCustomersRow.Item("cef_values") = ""
          newCustomersRow("cef_list_select_query") = ""

          dalTable.Rows.InsertAt(newCustomersRow, 0)
          dalTable.AcceptChanges()
        End If

      End If

      Return dalTable

    Catch ex As Exception
      ListofTabsFieldsBasedonTabID = Nothing
      Me.class_error = "Error in ListofTabsFieldsBasedonTabID(ByVal tabID As Integer) As DataTable: SQL VERSION " & ex.Message
    Finally

    End Try

  End Function

  Public Sub FillCachedAdvancedSearchBoxes()
    If IsNothing(HttpContext.Current.Cache("CachedAdvancedTabs")) Then
      HttpContext.Current.Cache.Insert("CachedAdvancedTabs", TabFieldsCached, Nothing, DateTime.Now.AddDays(1), Cache.NoSlidingExpiration)
    End If
  End Sub

  ''' <summary>
  ''' 'This stores the tab fields in cache.
  ''' </summary>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function TabFieldsCached() As DataTable
    Dim sql As String = ""
    Dim aTempTable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim newCustomersRow As DataRow = aTempTable.NewRow()

    Try

      Dim columnAdd As New DataColumn


      aTempTable.Columns.Add("cef_id")
      aTempTable.Columns.Add("cefsblk_name")
      aTempTable.Columns.Add("cef_display")
      aTempTable.Columns.Add("cef_evo_field_name")

      aTempTable.Columns.Add("cef_field_type")
      aTempTable.Columns.Add("cef_field_length")
      aTempTable.Columns.Add("cef_help_topic_id")
      aTempTable.Columns.Add("cef_definition")
      aTempTable.Columns.Add("cef_values")
      aTempTable.Columns.Add("cef_link")
      aTempTable.Columns.Add("cef_list_select_query")
      aTempTable.Columns.Add("cef_product_yacht_flag")
      aTempTable.Columns.Add("cef_advanced_search_flag")
      aTempTable.Columns.Add("cef_evo_flag")
      aTempTable.Columns.Add("cef_product_aerodex_flag")
      aTempTable.Columns.Add("cef_export_tab_id")

      columnAdd.DataType = System.Type.GetType("System.Int64")
      columnAdd.DefaultValue = 0
      columnAdd.Unique = False
      columnAdd.ColumnName = "cef_sort"
      aTempTable.Columns.Add(columnAdd)

      columnAdd = New DataColumn
      columnAdd.DataType = System.Type.GetType("System.Int64")
      columnAdd.DefaultValue = 0
      columnAdd.Unique = False
      columnAdd.ColumnName = "cefsblk_order"
      aTempTable.Columns.Add(columnAdd)

      sql = "select cef_id , cefsblk_order, cef_advanced_search_flag,cef_export_tab_id, cefsblk_name, cef_product_yacht_flag, cef_display, cef_list_select_query, cef_evo_field_name, "
      sql += " cef_sort, cef_evo_flag, cef_field_type, cef_field_length, cef_help_topic_id, cef_definition, cef_product_aerodex_flag,"
      sql += " cef_values "
      sql += " from Custom_Export_Fields"
      sql += " inner join Custom_Export_Tab on cef_export_tab_id = cefstab_id"
      sql += " inner join Custom_Export_Block on cef_export_block_id = cefsblk_id"
      sql += " where cef_evo_flag = 'Y'"

      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      While SqlReader.Read()
        newCustomersRow = aTempTable.NewRow()
        Dim TemporarySelectQuery As Object = Nothing

        newCustomersRow("cef_id") = SqlReader.Item("cef_id")
        newCustomersRow("cefsblk_name") = SqlReader.Item("cefsblk_name")
        newCustomersRow("cef_display") = SqlReader.Item("cef_display")
        newCustomersRow("cef_evo_field_name") = SqlReader.Item("cef_evo_field_name")
        newCustomersRow("cef_sort") = SqlReader.Item("cef_sort")
        newCustomersRow("cef_field_length") = SqlReader.Item("cef_field_length")
        newCustomersRow("cef_help_topic_id") = SqlReader.Item("cef_help_topic_id")
        newCustomersRow("cef_definition") = SqlReader.Item("cef_definition")

        newCustomersRow("cef_link") = ""

        newCustomersRow("cef_values") = SqlReader.Item("cef_values")
        newCustomersRow("cef_field_type") = SqlReader.Item("cef_field_type")

        newCustomersRow("cef_product_yacht_flag") = SqlReader.Item("cef_product_yacht_flag")
        newCustomersRow("cef_advanced_search_flag") = SqlReader.Item("cef_advanced_search_flag")
        newCustomersRow("cef_evo_flag") = SqlReader.Item("cef_evo_flag")
        newCustomersRow("cef_product_aerodex_flag") = SqlReader.Item("cef_product_aerodex_flag")
        newCustomersRow("cef_export_tab_id") = SqlReader.Item("cef_export_tab_id")
        newCustomersRow("cefsblk_order") = SqlReader.Item("cefsblk_order")

        TemporarySelectQuery = SqlReader.Item("cef_list_select_query")

        If Not IsDBNull(TemporarySelectQuery) Then
          If Not String.IsNullOrEmpty(TemporarySelectQuery) Then

            ' ADDED IN 1/2/18 - MSW - THE USAGE ONE MUST SELECT AND STAY AS A STRING
            ' EVEN THOUGH THE FIELD TYPE TABLE ABOVE IS STRING, IT IS BEING AUTO SET TO CHAR HERE
            ' MSW - 1/28/19 - I HAVE MADE SURE THAT THE MFR NAME SEARCH WORKS - ALSO, FOR THE FUTURE, 
            'SUB SELET SEARCHES THAT ARE NAMED STRINGS AND MARKED WITH 101 WILL BE MADE SURE TO BE KEPT STRINGS
            If Trim(newCustomersRow("cef_display")) = "Usage" Or Trim(newCustomersRow("cef_display")) = "Engine Fuel Type" Or Trim(newCustomersRow("cef_display")) = "Engine MFR Name" Then
              newCustomersRow("cef_field_type") = "String"
            ElseIf Trim(SqlReader.Item("cefsblk_order")) = "String" And Trim(SqlReader.Item("cef_field_length")) = "101" Then
              newCustomersRow("cef_field_type") = "String"
            Else
              newCustomersRow("cef_field_type") = "Char"
            End If

            Dim TemporarySQL As String = Replace(TemporarySelectQuery, ":", "'")

            newCustomersRow("cef_list_select_query") = TemporarySQL
            newCustomersRow("cef_values") = RunDynamicCEF_List_Select_Query(TemporarySQL)
          End If
        End If

        aTempTable.Rows.Add(newCustomersRow)
        aTempTable.AcceptChanges()
      End While

      Return aTempTable

    Catch ex As Exception
      TabFieldsCached = Nothing
      Me.class_error = "Error in TabFieldsCached() as Datatable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function

  Public Function RunDynamicCEF_List_Select_Query(ByVal DatabaseSQL As String) As String
    Dim sql As String = ""
    Dim aTempTable As New DataTable

    Dim returnString As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try

      sql = DatabaseSQL

      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try


      For Each r As DataRow In aTempTable.Rows
        If Not IsDBNull(r(0)) Then
          If Not String.IsNullOrEmpty(r(0)) Then
            'Add a comma if needed.
            If returnString <> "" Then
              returnString += ", "
            End If
            returnString += Replace(r(0), ",", "&#44;")
          End If
        End If
      Next



    Catch ex As Exception
      returnString = ""
      Me.class_error = "Error in RunDynamicCEF_List_Select_Query(ByVal DatabaseSQL As String) As String: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try
    Return returnString
  End Function
#End Region
#Region "Maintenance/Equip Regulation Lookups"
  Public Function MaintenanceRegulationUSOrForeign(ByVal US As Boolean, ByVal Foreign As Boolean, Optional ByVal only_active As Boolean = False) As DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim SqlReader As SqlClient.SqlDataReader
    Dim ReturnTable As New DataTable
    Dim sql As String = ""

    Try

      sql = "SELECT certification_name, certification_usa_flag from Certification with (NOLOCK)  "

      If US Then
        sql += " where certification_usa_flag in ('U','B') "
        If only_active = True Then
          sql += " and certification_active_flag = 'Y' "
        End If
      ElseIf Foreign Then
        sql += " where certification_usa_flag in ('I','B') "
        If only_active = True Then
          sql += " and certification_active_flag = 'Y' "
        End If
      Else
        If only_active = True Then
          sql += " where certification_active_flag = 'Y' "
        End If
      End If



      sql += " order by certification_name"


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        ReturnTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = ReturnTable.GetErrors()
      End Try

    Catch ex As Exception
      MaintenanceRegulationUSOrForeign = Nothing
      Me.class_error = "Error in MaintenanceRegulationUSOrForeign(ByVal US As Boolean, ByVal Foreign As Boolean) As DataTable " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try
    Return ReturnTable
  End Function
  Public Function EngineMaintenanceProgramProviderOrName(ByVal Name As Boolean, ByVal Program As Boolean, ByVal ProviderName As String) As DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim SqlReader As SqlClient.SqlDataReader
    Dim ReturnTable As New DataTable
    Dim sql As String = ""

    Try

      sql = "SELECT distinct "
      sql += " emp_provider_name, emp_program_name"

      sql += " from Engine_Maintenance_Program with (NOLOCK) "

      If ProviderName <> "" Then
        sql += " where emp_provider_name = '" & ProviderName & "'"
      End If

      If Name Then
        sql += " order by emp_provider_name"
      Else
        sql += " order by emp_program_name"
      End If


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        ReturnTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = ReturnTable.GetErrors()
      End Try

    Catch ex As Exception
      EngineMaintenanceProgramProviderOrName = Nothing
      Me.class_error = "Error in EngineMaintenanceProgramProviderOrName(ByVal Name As Boolean, ByVal Program As Boolean, ByVal ProviderName As String) As DataTable " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try
    Return ReturnTable
  End Function

  Public Function APUMaintenanceName(ByVal codePicked As String) As DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim SqlReader As SqlClient.SqlDataReader
    Dim ReturnTable As New DataTable
    Dim sql As String = ""

    Try


      sql = "SELECT emp_name, emp_provider_name, emp_program_name, emp_code FROM Engine_Maintenance_Program WITH(NOLOCK)"
      If codePicked <> "" Then
        sql += " WHERE (emp_code = '" + codePicked + "')"
      End If

      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        ReturnTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = ReturnTable.GetErrors()
      End Try

    Catch ex As Exception
      APUMaintenanceName = Nothing
      Me.class_error = "Error in Public Function APUMaintenanceName(ByVal codePicked As String) As DataTable " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try
    Return ReturnTable
  End Function
  Public Function EngineManagementProgramProviderOrName(ByVal Name As Boolean, ByVal Program As Boolean, ByVal ProviderName As String) As DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim SqlReader As SqlClient.SqlDataReader
    Dim ReturnTable As New DataTable
    Dim sql As String = ""

    Try

      sql = "SELECT distinct "

      sql += " emgp_program_name , emgp_provider_name "

      sql += " from Engine_Management_Program   with (NOLOCK) "

      If ProviderName <> "" Then
        sql += " where emgp_program_name = '" & ProviderName & "'"
      End If

      If Name Then
        sql += " order by emgp_provider_name"
      Else
        sql += " order by emgp_program_name"
      End If


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        ReturnTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = ReturnTable.GetErrors()
      End Try

    Catch ex As Exception
      EngineManagementProgramProviderOrName = Nothing
      Me.class_error = "Error in EngineManagementProgramProviderOrName(ByVal Name As Boolean, ByVal Program As Boolean, ByVal ProviderName As String) As DataTable " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try
    Return ReturnTable
  End Function
  Public Function AirframeMaintenanceProgramProviderOrName(ByVal Name As Boolean, ByVal Program As Boolean, ByVal ProviderName As String) As DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim SqlReader As SqlClient.SqlDataReader
    Dim ReturnTable As New DataTable
    Dim sql As String = ""

    Try
      sql = "SELECT distinct "


      sql += " amp_provider_name, amp_program_name "

      sql += " from Airframe_Maintenance_Program   with (NOLOCK) "

      If ProviderName <> "" Then
        sql += " where amp_program_name = '" & ProviderName & "'"
      End If

      If Name Then
        sql += " order by amp_provider_name"
      Else
        sql += " order by amp_program_name"
      End If


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        ReturnTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = ReturnTable.GetErrors()
      End Try

    Catch ex As Exception
      AirframeMaintenanceProgramProviderOrName = Nothing
      Me.class_error = "Error in AirframeMaintenanceProgramProviderOrName(ByVal Name As Boolean, ByVal Program As Boolean, ByVal ProviderName As String) As DataTable " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try
    Return ReturnTable
  End Function
  Public Function AirframeMaintenanceTrackingProgramProviderOrName(ByVal Name As Boolean, ByVal Program As Boolean, ByVal ProviderName As String) As DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim SqlReader As SqlClient.SqlDataReader
    Dim ReturnTable As New DataTable
    Dim sql As String = ""

    Try
      sql = "SELECT distinct "

      sql += " amtp_provider_name  "
      sql += ", amtp_program_name "


      sql += " from Airframe_Maintenance_Tracking_Program   with (NOLOCK) "

      If ProviderName <> "" Then
        sql += " where amtp_program_name = '" & ProviderName & "'"
      End If

      If Name Then
        sql += " order by amtp_provider_name"
      Else
        sql += " order by amtp_program_name"
      End If


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      Try
        ReturnTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = ReturnTable.GetErrors()
      End Try

    Catch ex As Exception
      AirframeMaintenanceTrackingProgramProviderOrName = Nothing
      Me.class_error = "Error in AirframeMaintenanceTrackingProgramProviderOrName(ByVal Name As Boolean, ByVal Program As Boolean, ByVal ProviderName As String) As DataTable " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try
    Return ReturnTable
  End Function
#End Region

#Region "TOPICS"

  Public Function GetTopicListQueryByArea(ByVal area As String, ByVal appendedWhereClause As String, ByVal AppendedFromClause As String) As DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable
    Dim sqlWhere As String = ""

    Try

      If appendedWhereClause = "" And AppendedFromClause = "" Then
        sql = "select distinct actop_id as TOPID, actop_area as AREA, actop_name as TOPIC, "
        sql += " COUNT(*) as tcount from aircraft_topic with (NOLOCK) "
        sql += " where (actop_query is not null and datalength(actop_query)>0) "
        sql += " and ("

        If HttpContext.Current.Session.Item("localSubscription").crmBusiness_Flag Then
          sqlWhere += " actop_product_business_flag='Y' "
        End If


        If HttpContext.Current.Session.Item("localSubscription").crmCommercial_Flag Then
          sqlWhere += IIf(sqlWhere <> "", " or ", "") & " actop_product_commercial_flag='Y' "
        End If

        If HttpContext.Current.Session.Item("localSubscription").crmHelicopter_Flag Then
          sqlWhere += IIf(sqlWhere <> "", " or ", "") & " actop_product_helicopter_flag='Y' "
        End If

        sql += sqlWhere
        sql += ")"


      Else

        sql = "select distinct actop_id as TOPID,actop_area as AREA, actop_name as TOPIC, COUNT(*) as tcount from aircraft_topic with (NOLOCK)"
        sql += " inner join aircraft_topic_index with (NOLOCK) on actopind_actop_id = actop_id"
        sql += " where (actop_query is not null and datalength(actop_query)>0) and actopind_ac_id in (select distinct ac_id "

        If AppendedFromClause <> "" Then
          sql += AppendedFromClause

          If appendedWhereClause <> "" Then
            sql += appendedWhereClause
          End If
        Else
          sql += " from Aircraft_Flat with (NOLOCK) "

          If appendedWhereClause <> "" Then
            sql += appendedWhereClause
            sql += " and ac_journ_id = 0 "
          Else
            sql += " where ac_journ_id = 0 "
            sql += clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(HttpContext.Current.Session.Item("localSubscription"), False, True)

          End If


        End If


        sql += " )"
      End If

      If area <> "" Then
        sql += " and actop_area = @area "
      End If




      If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag Then
        sql += " and actop_aerodex_flag='Y' "
      End If



      sql += " group by actop_id, actop_area,actop_name"
      sql += " order by actop_area,actop_name"

      'save to session query debug string.
      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      'Opening Connection
      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
      SqlConn.Open()


      Dim SqlCommand As New SqlClient.SqlCommand(sql, SqlConn)

      If area <> "" Then
        SqlCommand.Parameters.AddWithValue("area", area)
      End If


      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      SqlCommand.Dispose()
      SqlCommand = Nothing

      Return atemptable

    Catch ex As Exception
      Return Nothing
      Me.class_error = "Error in GetTopicListQueryByArea(ByVal area As String, ByVal appendedWhereClause As String, ByVal AppendedFromClause As String) As DataTable: " + ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing


    End Try

  End Function
  Public Function GetYachtTopicListQueryByArea(ByVal area As String, ByVal appendedWhereClause As String, ByVal AppendedFromClause As String) As DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable


    Try

      sql = "select distinct yttop_id as TOPID, yttop_area as AREA, yttop_name as TOPIC, COUNT(*) as tcount from yacht_topic with (NOLOCK)"
      sql += " inner join yacht_topic_index with (NOLOCK) on yttopind_yttop_id = yttop_id"
      sql += " where (yttop_query is not null and datalength(yttop_query)>0)  and  yttopind_yt_id in (select distinct yt_id "

      If AppendedFromClause <> "" Then
        sql += AppendedFromClause

        If appendedWhereClause <> "" Then
          sql += appendedWhereClause
        End If
      Else
        sql += " from yacht with (NOLOCK) "

        If appendedWhereClause <> "" Then
          sql += appendedWhereClause
          sql += " and yt_journ_id = 0 "
        Else
          sql += " where yt_journ_id = 0 "
          'sql += clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(HttpContext.Current.Session.Item("localSubscription"), False, True)

        End If


      End If


      sql += " )"

      If area <> "" Then
        sql += " and yttop_area = @area "
      End If


      sql += " group by yttop_id, yttop_area,yttop_name"
      sql += " order by yttop_area,yttop_name"

      'save to session query debug string.
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>GetYachtTopicListQueryByArea(ByVal area As String, ByVal appendedWhereClause As String, ByVal AppendedFromClause As String) As DataTable</b><br />" & sql

      'Opening Connection
      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
      SqlConn.Open()


      Dim SqlCommand As New SqlClient.SqlCommand(sql, SqlConn)

      If area <> "" Then
        SqlCommand.Parameters.AddWithValue("area", area)
      End If


      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      SqlCommand.Dispose()
      SqlCommand = Nothing

      Return atemptable

    Catch ex As Exception
      Return Nothing
      Me.class_error = "Error in GetYachtTopicListQueryByArea(ByVal area As String, ByVal appendedWhereClause As String, ByVal AppendedFromClause As String) As DataTable: " + ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing


    End Try

  End Function
  '  -- ******************************************
  '-- TOPIC LIST QUERY - FOR ALL AIRCRAFT - BY LETTER
  'select distinct actop_id as TOPID, left(actop_name,1) as LETTER, actop_name as TOPIC, COUNT(*) as tcount from aircraft_topic with (NOLOCK)
  'inner join aircraft_topic_index with (NOLOCK) on actopind_actop_id = actop_id
  'where actopind_ac_id in (select distinct ac_id from Aircraft_Flat with (NOLOCK) 
  'where ac_journ_id = 0 )
  'group by actop_id, left(actop_name,1),actop_name
  'order by actop_name
  Public Function GetTopicListQueryByLetter(ByVal AreaString As String, ByVal letter As String, ByVal appendedWhereClause As String, ByVal AppendedFromClause As String) As DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable

    Try

      sql = " select distinct actop_id as TOPID, left(actop_name,1) as LETTER, actop_name as TOPIC, COUNT(*) as tcount from aircraft_topic with (NOLOCK)"
      sql += " inner join aircraft_topic_index with (NOLOCK) on actopind_actop_id = actop_id"
      sql += " where (actop_query is not null and datalength(actop_query)>0)  and actopind_ac_id in (select distinct ac_id "

      If AppendedFromClause <> "" Then
        sql += AppendedFromClause

        If appendedWhereClause <> "" Then
          sql += appendedWhereClause
        End If
      Else
        sql += " from Aircraft_Flat with (NOLOCK) "

        If appendedWhereClause <> "" Then
          sql += appendedWhereClause
          sql += " and ac_journ_id = 0 "
        Else
          sql += " where ac_journ_id = 0 "
          sql += clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(HttpContext.Current.Session.Item("localSubscription"), False, True)
        End If
      End If


      sql += " )"

      If letter <> "" Then
        sql += " and left(actop_name,1) = @letter "
      End If

      If AreaString <> "" Then
        sql += " and actop_area = @area "
      End If

      If HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag Then
        sql += " and actop_aerodex_flag='Y' "
      End If


      sql += " group by actop_id, left(actop_name,1),actop_name"
      sql += " order by actop_name"

      'save to session query debug string.
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>GetTopicListQueryByLetter(ByVal letter As String, ByVal appendedWhereClause As String, ByVal AppendedFromClause As String) As DataTable</b><br />" & sql

      'Opening Connection
      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
      SqlConn.Open()


      Dim SqlCommand As New SqlClient.SqlCommand(sql, SqlConn)

      If letter <> "" Then
        SqlCommand.Parameters.AddWithValue("letter", letter)
      End If

      If AreaString <> "" Then
        SqlCommand.Parameters.AddWithValue("area", AreaString)
      End If



      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      SqlCommand.Dispose()
      SqlCommand = Nothing

      Return atemptable

    Catch ex As Exception
      Return Nothing
      Me.class_error = "Error in GetTopicListQueryByLetter(ByVal letter As String, ByVal appendedWhereClause As String, ByVal AppendedFromClause As String) As DataTable: " + ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing
    End Try

  End Function
  '  -- ******************************************
  '-- TOPIC LIST QUERY - FOR ALL Yacht - BY LETTER
  Public Function GetYachtTopicListQueryByLetter(ByVal AreaString As String, ByVal letter As String, ByVal appendedWhereClause As String, ByVal AppendedFromClause As String) As DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable

    Try

      sql = " select distinct yttop_id as TOPID, left(yttop_name,1) as LETTER, yttop_name as TOPIC, COUNT(*) as tcount from yacht_topic with (NOLOCK)"
      sql += " inner join yacht_topic_index with (NOLOCK) on yttopind_yttop_id = yttop_id"
      sql += " where (yttop_query is not null and datalength(yttop_query)>0)  and yttopind_yt_id in (select distinct yt_id "

      If AppendedFromClause <> "" Then
        sql += AppendedFromClause

        If appendedWhereClause <> "" Then
          sql += appendedWhereClause
        End If
      Else
        sql += " from Yacht with (NOLOCK) "

        If appendedWhereClause <> "" Then
          sql += appendedWhereClause
          sql += " and yt_journ_id = 0 "
        Else
          sql += " where yt_journ_id = 0 "
          'sql += clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(HttpContext.Current.Session.Item("localSubscription"), False, True)
        End If
      End If


      sql += " )"

      If letter <> "" Then
        sql += " and left(yttop_name,1) = @letter "
      End If

      If AreaString <> "" Then
        sql += " and yttop_area = @area "
      End If


      sql += " group by yttop_id, left(yttop_name,1),yttop_name"
      sql += " order by yttop_name"

      'save to session query debug string.
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>GetYachtTopicListQueryByLetter(ByVal letter As String, ByVal appendedWhereClause As String, ByVal AppendedFromClause As String) As DataTable</b><br />" & sql

      'Opening Connection
      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
      SqlConn.Open()


      Dim SqlCommand As New SqlClient.SqlCommand(sql, SqlConn)

      If letter <> "" Then
        SqlCommand.Parameters.AddWithValue("letter", letter)
      End If

      If AreaString <> "" Then
        SqlCommand.Parameters.AddWithValue("area", AreaString)
      End If



      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      SqlCommand.Dispose()
      SqlCommand = Nothing

      Return atemptable

    Catch ex As Exception
      Return Nothing
      Me.class_error = "Error in GetYachtTopicListQueryByLetter(ByVal letter As String, ByVal appendedWhereClause As String, ByVal AppendedFromClause As String) As DataTable: " + ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing
    End Try

  End Function
  Public Function GetTopicQueryByID(ByVal topicID As Long) As DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable

    Try

      sql = " select actop_id as TOPID, actop_area as AREA, actop_name as TOPIC, actop_reference_id as REFID, "
      sql += " actop_query as MYQUERY from aircraft_topic a with (NOLOCK) "
      sql += " where actop_id = @topicID "
      sql += " order by actop_name"


      'save to session query debug string.
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>GetTopicQueryByID(ByVal topicID As Long) As DataTable</b><br />" & sql

      'Opening Connection
      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString.Trim
      SqlConn.Open()


      Dim SqlCommand As New SqlClient.SqlCommand(sql, SqlConn)

      If topicID > 0 Then
        SqlCommand.Parameters.AddWithValue("topicID", topicID)
      End If

      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      SqlCommand.Dispose()
      SqlCommand = Nothing

      Return atemptable

    Catch ex As Exception
      Return Nothing
      Me.class_error = "Error in GetTopicQueryByID(ByVal topicID As Long) As DataTable: " + ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing
    End Try

  End Function
#End Region

#End Region
#Region "CLIENT SIDE"

  Public Function EvolutionCLIENTCompanyListingPageQuery(ByVal CompanyName As String, ByVal CompanyBusinessType As String, ByVal CompanyCertifications As String,
                                              ByVal CompanyRelationship As String, ByVal NotInRelationship As Boolean,
                                              ByVal CompanyCity As String, ByVal CompanyPostal As String,
                                              ByVal CompanyCountry As String, ByVal CompanyContinent As String,
                                              ByVal RegionString As String, ByVal Timezone As String,
                                              ByVal ContactTitle As String, ByVal ContactFirstName As String,
                                              ByVal ContactLastName As String, ByVal DisplayContactInfo As Boolean,
                                              ByVal CompanyAgency As String, ByVal CompanyEmail As String,
                                              ByVal CompanyPhoneNumber As String, ByVal CompanyAddress As String,
                                              ByVal compID As String, ByVal OperatorFlag As String,
                                              ByVal pageSort As String, ByVal BusinessFlag As Boolean,
                                              ByVal HelicopterFlag As Boolean, ByVal CommercialFlag As Boolean,
                                              ByVal Fleet As String, ByVal FleetCondition As String, ByVal FleetValue As String,
                                              ByVal aircraftSalesOnly As Boolean, ByVal contactID As String,
                                              ByVal ContinentString As String, ByVal StateName As String,
                                              ByVal YachtFlag As Boolean, ByVal IncludeInactiveCompanies As Boolean,
                                              ByVal YachtFleet As String, ByVal ac_fleet As String,
                                              ByVal DynamicQueryString As String, ByVal clientIDs As String, ByVal comp_id_list As String, ByVal custom_string As String, ByVal CompanyCertifications2 As String) As DataTable

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing

    Dim TempTable As New DataTable
    Dim query_sql As String = ""
    Dim query_select As String = ""
    Dim query_where As String = ""
    Dim queryFrom As String = ""
    Dim UseAlternate As Boolean = False
    Dim count As Long = 1
    Dim Yacht As Boolean = False 'Variable set whenever you're on the yacht application only. YachtFlag is set on Evo side when you have yacht checkbox checked

    If HttpContext.Current.Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.YACHT Then
      Yacht = True
    End If
    Dim comp_count As DataColumn = New DataColumn("comp_count", Type.GetType("System.Int64"))
    comp_count.AutoIncrement = True
    comp_count.AutoIncrementSeed = 1
    TempTable.Columns.Add(comp_count)

    TempTable.Columns.Add("comp_id")
    TempTable.Columns.Add("comp_name")
    TempTable.Columns.Add("comp_alternate_name")
    TempTable.Columns.Add("comp_alternate_name_type")
    TempTable.Columns.Add("comp_address1")
    TempTable.Columns.Add("comp_address2")
    TempTable.Columns.Add("comp_city")
    TempTable.Columns.Add("comp_state")
    TempTable.Columns.Add("comp_zip_code")
    TempTable.Columns.Add("comp_country")
    TempTable.Columns.Add("comp_agency_type")
    TempTable.Columns.Add("comp_web_address")
    TempTable.Columns.Add("comp_email_address")
    TempTable.Columns.Add("comp_jetnet_comp_id")
    TempTable.Columns.Add("comp_user_id")
    TempTable.Columns.Add("comp_action_date")
    TempTable.Columns.Add("comp_logo_flag")
    TempTable.Columns.Add("source")
    TempTable.Columns.Add("comp_product_helicopter_flag")
    TempTable.Columns.Add("comp_product_business_flag")
    TempTable.Columns.Add("comp_product_commercial_flag")
    TempTable.Columns.Add("comp_phone_office")
    TempTable.Columns.Add("comp_phone_fax")
    TempTable.Columns.Add("contact_first_name")
    TempTable.Columns.Add("contact_middle_initial")
    TempTable.Columns.Add("contact_suffix")
    TempTable.Columns.Add("contact_last_name")
    TempTable.Columns.Add("contact_title")
    TempTable.Columns.Add("contact_id")
    TempTable.Columns.Add("contact_sirname")
    Try

      query_select = "SELECT DISTINCT clicomp_id as comp_id,  clicomp_name as comp_name, clicomp_alternate_name as comp_alternate_name, clicomp_alternate_name_type as comp_alternate_name_type, "
      query_select = query_select & "clicomp_address1 as comp_address1, clicomp_address2 as comp_address2, clicomp_city as comp_city, clicomp_state as comp_state, clicomp_state as state_name, clicomp_zip_code as comp_zip_code, clicomp_country as comp_country, "
      query_select = query_select & " clicomp_agency_type as comp_agency_type, clicomp_web_address as comp_web_address, clicomp_email_address as comp_email_address, clicomp_jetnet_comp_id as "
      query_select = query_select & "comp_jetnet_comp_id, 0 as comp_user_id, clicomp_action_date as comp_action_date,"
      query_select = query_select & "'CLIENT' as source, 'Y' as comp_product_helicopter_flag,	"
      query_select = query_select & " 'Y' as comp_product_business_flag,	'Y' as comp_product_commercial_flag,'N' as comp_logo_flag"

      If DisplayContactInfo Then
        query_select = query_select & ", clicontact_suffix as contact_suffix, clicontact_middle_initial as contact_middle_initial, clicontact_first_name as contact_first_name, clicontact_last_name as contact_last_name, clicontact_title as contact_title, clicontact_id as contact_id, clicontact_sirname as contact_sirname "
      Else
        query_select = query_select & ", '' as contact_suffix, '' as contact_middle_initial, '' as contact_first_name, '' as contact_last_name, '' as contact_title, 0 as contact_id, '' as contact_sirname "
      End If

      If HttpContext.Current.Session.Item("isMobile") = False Then
        query_select = query_select & ", (select clipnum_number as pnum_number_full from Client_Phone_Numbers where clipnum_type ='Office' and clicomp_id = clipnum_comp_id and clipnum_contact_id =0 limit 1) as comp_phone_office,"
        query_select = query_select & " (select clipnum_number from Client_Phone_Numbers where clipnum_type ='Fax' and clicomp_id = clipnum_comp_id and clipnum_contact_id =0 limit 1) as comp_phone_fax"
      Else
        query_select = query_select & ", (select clipnum_number from Client_Phone_Numbers where clipnum_type not like '%Fax%' and clicomp_id = clipnum_comp_id and clipnum_contact_id =0 limit 1) as comp_phone_office, '' as comp_phone_fax "
      End If

      queryFrom = "  From Client_Company "

      'If the yacht relationship is picked, we need this table joined.
      If (CompanyRelationship <> "" Or OperatorFlag <> "") Then
        queryFrom += " INNER JOIN client_aircraft_reference ON clicomp_id = cliacref_comp_id "
      End If

      If DisplayContactInfo Or ContactFirstName <> "" Or ContactLastName <> "" Or ContactTitle <> "" Or CompanyEmail <> "" Then
        queryFrom += " LEFT OUTER JOIN Client_Contact ON (clicomp_id = clicontact_comp_id AND clicontact_status = 'Y')"
      End If

      query_where = " clicomp_status='Y' "
      If DisplayContactInfo = True Or ContactFirstName <> "" Or ContactLastName <> "" Or ContactTitle <> "" Then
        query_where = query_where & " and clicontact_status='Y' "
      End If

            If Trim(comp_id_list) <> "" Then
                If Trim(comp_id_list) <> "clicomp_jetnet_comp_id in ()" Then

                    ' added in MSW - 6/29/20 
                    If InStr(comp_id_list, "clicomp_jetnet_comp_id") > 0 Then
                        query_where = query_where & " and " & Trim(comp_id_list)
                    ElseIf InStr(comp_id_list, "=") > 0 Then
                        query_where = query_where & " and clicomp_jetnet_comp_id " & Trim(comp_id_list)
                    Else
                        query_where = query_where & " and clicomp_jetnet_comp_id in (" & Trim(comp_id_list) & ") "
                    End If
                End If
            End If

            query_where += " AND upper(clicomp_name) <> 'AWAITING DOCUMENTATION'  "


      If CompanyName <> "" Then
        If query_where <> "" Then
          query_where = query_where & " and "
        End If
        query_where = query_where & Replace(Replace(CompanyName, "comp_altname_search", "clicomp_alternate_name"), "comp_name_search", "clicomp_name_search")
      End If

      If CompanyRelationship <> "" Then
        query_where = query_where & " and " & Replace(Replace(CompanyRelationship, "cref_contact_type", "cliacref_contact_type"), "Aircraft_Reference WITH (NOLOCK) WHERE (cref_comp_id = comp_id) AND (cref_journ_id = comp_journ_id) AND ((", "Client_Aircraft_Reference  WHERE (cliacref_comp_id = clicomp_id) AND ((") & ""
      End If


      'comp_accred
      If CompanyCertifications2 <> "" Then
        query_where = query_where & " and clicomp_jetnet_comp_id in (" & Trim(CompanyCertifications2) & ") "
      End If

      'comp_cert
      If CompanyCertifications <> "" Then
        query_where = query_where & " and clicomp_jetnet_comp_id in (" & Trim(CompanyCertifications) & ") "
      End If

      If Timezone <> "" Then
        Dim tempState As String = ""
        Dim queryTable As DataTable = GetStatesByTimezone(Timezone)
        If Not IsNothing(queryTable) Then
          If queryTable.Rows.Count > 0 Then
            For Each r As DataRow In queryTable.Rows
              If tempState <> "" Then
                tempState += ", "
              End If
              tempState += "'" & r("state_code") & "'"
            Next

          End If
        End If
        If tempState <> "" Then
          If query_where <> "" Then
            query_where = query_where & " and "
          End If
          query_where = query_where & " clicomp_state in (" & tempState & ")"
        End If
      End If

      If CompanyPhoneNumber <> "" Then
        If query_where <> "" Then
          query_where += " and "
        End If
        CompanyPhoneNumber = clsGeneral.clsGeneral.CleanUserData(CompanyPhoneNumber, Constants.cEmptyString, Constants.cCommaDelim, True)
        CompanyPhoneNumber = Replace(CompanyPhoneNumber, ".", "_")
        CompanyPhoneNumber = Replace(CompanyPhoneNumber, "(", "_")
        CompanyPhoneNumber = Replace(CompanyPhoneNumber, ")", "_")
        CompanyPhoneNumber = Replace(CompanyPhoneNumber, "-", "_")
        CompanyPhoneNumber = "%" & CompanyPhoneNumber

        query_where += "( "

        ''search company phone office
        query_where += " clicomp_id in (select distinct clipnum_comp_id from Client_Phone_Numbers where "
        query_where += BuildPhoneQueryForCompanySearch(CompanyPhoneNumber, "clipnum_number")
        query_where += ") "

        query_where += " )"
      End If

      If ContactTitle <> "" Then
        query_where = query_where & " and clicontact_title IN (" & ContactTitle & ") "
      End If




      If OperatorFlag <> "" And NotInRelationship = False Then
        query_where = query_where & " and " & Replace(OperatorFlag, "cref_operator_flag", "cliacref_operator_flag") & ""
      End If

      ''Continent
      If ContinentString <> "" Then
        Dim TemporaryCountryTable As DataTable = Get_Jetnet_Country_By_Continent(ContinentString)
        Dim tempCountryList As String = ""
        If Not IsNothing(TemporaryCountryTable) Then
          If TemporaryCountryTable.Rows.Count > 0 Then
            For Each z As DataRow In TemporaryCountryTable.Rows
              If tempCountryList <> "" Then
                tempCountryList += ", "
              End If
              tempCountryList += "'" & z("country_name") & "'"
            Next
          End If
        End If

        tempCountryList = tempCountryList
        If query_where <> "" Then
          query_where = query_where & " AND"
        End If
        query_where = query_where & " clicomp_country in (" & tempCountryList & ")"

      End If

      '' check the country
      If CompanyCountry <> "" And query_where <> "" Then
        query_where = query_where & " AND clicomp_country in (" & CompanyCountry & ")"
      ElseIf CompanyCountry <> "" Then
        query_where = query_where & " clicomp_country in (" & CompanyCountry & ")"
      End If

      ''check the address:
      If CompanyAddress <> "" Then
        If query_where <> "" Then
          query_where = query_where & " AND "
        End If

        query_where = query_where & "( clicomp_address1 LIKE '" & CompanyAddress & "%'"
        query_where = query_where & " or clicomp_address1 LIKE '" & CompanyAddress & "%' )"

      End If


      If ContactFirstName <> "" Then
        If query_where <> "" Then
          query_where += " and "
        End If

        If InStr(ContactFirstName, "*") = 0 Then
          query_where += " clicontact_first_name " & clsGeneral.clsGeneral.PrepQueryString("Begins With", ContactFirstName, "String", False, "clicontact_first_name", True)
        Else
          query_where += " " & clsGeneral.clsGeneral.PrepQueryString("Begins With", ContactFirstName, "String", False, "clicontact_first_name", True)
        End If
      End If




      If compID <> "" And clientIDs <> "" Then
        query_where = query_where & " and ( "
      End If

      ' ''check compID
      'If compID <> "" And query_where <> "" Then
      '  query_where = query_where & " clicomp_jetnet_comp_id in (" & compID & ")"
      'Else
      If compID <> "" Then
        If clientIDs = "" And query_where <> "" Then
          query_where = query_where & " and "
        End If
        query_where = query_where & " clicomp_jetnet_comp_id in (" & compID & ")"
      End If

      ''check client compID
      If clientIDs <> "" And query_where <> "" Then
        If compID <> "" Then
          query_where = query_where & " or "
        Else
          query_where = query_where & " and "
        End If
        query_where = query_where & "  clicomp_id in (" & clientIDs & ")"
      ElseIf clientIDs <> "" Then
        query_where = query_where & " clicomp_id in (" & clientIDs & ")"
      End If


      If compID <> "" And clientIDs <> "" Then
        query_where = query_where & " ) "
      End If

      'check contactID
      If contactID <> "" And query_where <> "" Then
        query_where = query_where & " AND clicontact_jetnet_contact_id in (" & contactID & ")"
      ElseIf contactID <> "" Then
        query_where = query_where & " clicontact_jetnet_contact_id in (" & contactID & ")"
      End If


      If ContactLastName <> "" Then
        If query_where <> "" Then
          query_where += " and "
        End If

        If InStr(ContactLastName, "*") = 0 Then
          query_where += " clicontact_last_name " & clsGeneral.clsGeneral.PrepQueryString("Begins With", ContactLastName, "String", False, "clicontact_last_name", False)
        Else
          query_where += " " & clsGeneral.clsGeneral.PrepQueryString("Begins With", ContactLastName, "String", False, "clicontact_last_name", False)
        End If
      End If

      ''search company email address
      If CompanyEmail <> "" Then
        If query_where <> "" Then
          query_where += " and "
        End If
        query_where += "( "
        CompanyEmail = clsGeneral.clsGeneral.CleanUserData(CompanyEmail, Constants.cEmptyString, Constants.cCommaDelim, True)

        If InStr(CompanyEmail, "*") = 0 Then
          query_where += " clicomp_email_address " & clsGeneral.clsGeneral.PrepQueryString("Begins With", CompanyEmail, "String", False, "clicomp_email_address", True)
        Else
          query_where += " " & clsGeneral.clsGeneral.PrepQueryString("Begins With", CompanyEmail, "String", False, "clicomp_email_address", True)
        End If

        'search contact email address
        If InStr(CompanyEmail, "*") = 0 Then
          query_where += " or clicontact_email_address " & clsGeneral.clsGeneral.PrepQueryString("Begins With", CompanyEmail, "String", False, "clicontact_email_address", True)
        Else
          query_where += " or " & clsGeneral.clsGeneral.PrepQueryString("Begins With", CompanyEmail, "String", False, "clicontact_email_address", True)
        End If

        query_where += " )"
      End If


      '' check the city
      If CompanyCity <> "" Then
        If query_where <> "" Then
          query_where += " and "
        End If
        Dim TemporaryOperator As String = "Begins With"
        CompanyCity = clsGeneral.clsGeneral.CleanUserData(CompanyCity, Constants.cEmptyString, Constants.cCommaDelim, True)

        If InStr(CompanyPostal, "*") = 0 Then
          query_where += " " & "clicomp_city" & " " & clsGeneral.clsGeneral.PrepQueryString(TemporaryOperator, CompanyCity, "String", False, "clicomp_city", True)
        Else
          query_where += " " & clsGeneral.clsGeneral.PrepQueryString(TemporaryOperator, CompanyCity, "String", False, "clicomp_city", True)
        End If
      End If


      '' check the zip
      If CompanyPostal <> "" Then
        If query_where <> "" Then
          query_where += " and "
        End If
        Dim TemporaryOperator As String = "="

        CompanyPostal = clsGeneral.clsGeneral.CleanUserData(CompanyPostal, Constants.cEmptyString, Constants.cCommaDelim, True)

        query_where += " " & clsGeneral.clsGeneral.ZipCodePrepQueryString(TemporaryOperator, CompanyPostal, "String", False, "clicomp_zip_code", True)

      End If


      ''check agency type
      If CompanyAgency <> "" And query_where <> "" Then
        query_where = query_where & " AND clicomp_agency_type = '" & CompanyAgency & "'"
      ElseIf CompanyAgency <> "" Then
        query_where = query_where & " clicomp_agency_type = '" & CompanyAgency & "'"
      End If

      '' check the state
      If StateName <> "" Then
        If query_where <> "" Then
          query_where = query_where & " AND "
        End If

        query_where = query_where & " ((clicomp_state IN ( select distinct client_state_abbr from Client_State where client_state in (" & StateName & ")))"
        query_where &= " or  (clicomp_state IN (" & StateName & ")))"
      End If


      ''cref_business_type
      If CompanyBusinessType <> "" Then
        If query_where <> "" Then
          query_where = query_where & " and "
        End If
        query_where = query_where & " clicomp_jetnet_comp_id in (" & CompanyBusinessType & ") "
      End If



      'add the select and the from
      query_select = query_select + queryFrom
      'store the from
      'HttpContext.Current.Session.Item("MasterCompanyFrom") = queryFrom

      'put all together
      query_sql = query_select & " WHERE " & query_where





      If Trim(custom_string) <> "" Then
        query_sql = query_sql & " " & Replace(Trim(custom_string), "comp_id", "clicomp_jetnet_comp_id")
      End If







      'add sort.
      'If pageSort <> "" Then
      '  query_sql = query_sql & " order by " & pageSort
      'Else
      query_sql = query_sql & " order by clicomp_name"
      'End If

      '  HttpContext.Current.Session.Item("MasterCompanyWhere") = query_where

      query_sql = query_sql
      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, query_sql.ToString)


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      MySqlCommand.CommandText = query_sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        TempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = TempTable.GetErrors()
      End Try



      If DynamicQueryString <> "" Then
        Dim FilterView As New DataView
        Dim displayTable As New DataTable
        FilterView = TempTable.DefaultView

        If pageSort <> "" Then
          FilterView.Sort = pageSort
        Else
          FilterView.Sort = " comp_name"
        End If
        FilterView.RowFilter = DynamicQueryString
        displayTable = FilterView.ToTable()
        TempTable = displayTable
      End If


      Return TempTable
    Catch ex As Exception
      EvolutionCLIENTCompanyListingPageQuery = Nothing
      Me.class_error = "Error in EvolutionCLIENTCompanyListingPageQuery(): Query: " & query_sql & " " & ex.Message
    Finally
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
#Region "Notes"
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: update_localNote 
  ' Purpose: to Update Local Note
  ' Parameters: class clsLocal_Notes
  ' Return: 
  '       Boolean
  ' Change Log
  '           01/03/2012   - Created By: Amanda Vaughn
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function update_localNote(ByVal aclsLocal_Notes As clsLocal_Notes) As Boolean
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim atemptable As New DataTable
    Dim sql As String = ""

    Try

      sql = " update local_notes set lnote_jetnet_ac_id = " & aclsLocal_Notes.lnote_jetnet_ac_id & ","

      sql = sql & " lnote_jetnet_comp_id = " & aclsLocal_Notes.lnote_jetnet_comp_id & ","

      sql = sql & " lnote_client_ac_id = " & aclsLocal_Notes.lnote_client_ac_id & ", lnote_client_comp_id = " & aclsLocal_Notes.lnote_client_comp_id & ","
      sql = sql & " lnote_note = '" & Escape_Single_Quote(aclsLocal_Notes.lnote_note) & "',"

      If Not IsNothing(aclsLocal_Notes.lnote_entry_date) Then
        If IsDate(aclsLocal_Notes.lnote_entry_date) Then
          sql = sql & " lnote_entry_date = '" & Year(aclsLocal_Notes.lnote_entry_date) & "-" & Month(aclsLocal_Notes.lnote_entry_date) & "-" & Day(aclsLocal_Notes.lnote_entry_date) & " " & Hour(aclsLocal_Notes.lnote_entry_date) & ":" & Minute(aclsLocal_Notes.lnote_entry_date) & ":" & Second(aclsLocal_Notes.lnote_entry_date) & "', "
        Else
          sql = sql & " lnote_entry_date = '" & Year(Now()) & "-" & Month(Now()) & "-" & Day(Now()) & " " & Hour(Now()) & ":" & Minute(Now()) & ":" & Second(Now()) & "', "
        End If
      Else
        sql = sql & " lnote_entry_date = '" & Year(Now()) & "-" & Month(Now()) & "-" & Day(Now()) & " " & Hour(Now()) & ":" & Minute(Now()) & ":" & Second(Now()) & "', "
      End If

      If Not IsNothing(aclsLocal_Notes.lnote_action_date) Then
        If IsDate(aclsLocal_Notes.lnote_action_date) Then
          sql = sql & " lnote_action_date = '" & Year(aclsLocal_Notes.lnote_action_date) & "-" & Month(aclsLocal_Notes.lnote_action_date) & "-" & Day(aclsLocal_Notes.lnote_action_date) & " " & Hour(aclsLocal_Notes.lnote_action_date) & ":" & Minute(aclsLocal_Notes.lnote_action_date) & ":" & Second(aclsLocal_Notes.lnote_action_date) & "', "
        Else
          sql = sql & " lnote_action_date = '" & Year(Now()) & "-" & Month(Now()) & "-" & Day(Now()) & " " & Hour(Now()) & ":" & Minute(Now()) & ":" & Second(Now()) & "', "
        End If
      Else
        sql = sql & " lnote_action_date = '" & Year(Now()) & "-" & Month(Now()) & "-" & Day(Now()) & " " & Hour(Now()) & ":" & Minute(Now()) & ":" & Second(Now()) & "', "
      End If

      sql = sql & " lnote_user_login = '" & Left(aclsLocal_Notes.lnote_user_login, 15) & "', lnote_user_name = '" & Left(aclsLocal_Notes.lnote_user_name, 50) & "', lnote_notecat_key = '" & aclsLocal_Notes.lnote_notecat_key & "', lnote_status = '" & Left(aclsLocal_Notes.lnote_status, 1) & "', "

      If Not IsNothing(aclsLocal_Notes.lnote_schedule_start_date) Then
        If IsDate(aclsLocal_Notes.lnote_schedule_start_date) Then
          sql = sql & " lnote_schedule_start_date = '" & Year(aclsLocal_Notes.lnote_schedule_start_date) & "-" & Month(aclsLocal_Notes.lnote_schedule_start_date) & "-" & Day(aclsLocal_Notes.lnote_schedule_start_date) & " " & Hour(aclsLocal_Notes.lnote_schedule_start_date) & ":" & Minute(aclsLocal_Notes.lnote_schedule_start_date) & ":" & Second(aclsLocal_Notes.lnote_schedule_start_date) & "',"
        Else
          sql = sql & "lnote_schedule_start_date = NULL,"
        End If
      Else
        sql = sql & "lnote_schedule_start_date = NULL,"
      End If

      If Not IsNothing(aclsLocal_Notes.lnote_schedule_end_date) Then
        If IsDate(aclsLocal_Notes.lnote_schedule_end_date) Then
          sql = sql & " lnote_schedule_end_date = '" & Year(aclsLocal_Notes.lnote_schedule_end_date) & "-" & Month(aclsLocal_Notes.lnote_schedule_end_date) & "-" & Day(aclsLocal_Notes.lnote_schedule_end_date) & " " & Hour(aclsLocal_Notes.lnote_schedule_end_date) & ":" & Minute(aclsLocal_Notes.lnote_schedule_end_date) & ":" & Second(aclsLocal_Notes.lnote_schedule_end_date) & "'"
        Else
          sql = sql & " lnote_schedule_end_date = NULL"
        End If
      Else
        sql = sql & " lnote_schedule_end_date = NULL"
      End If

      sql = sql & ", lnote_user_id = '" & aclsLocal_Notes.lnote_user_id & "', "
      sql = sql & " lnote_clipri_id = '" & aclsLocal_Notes.lnote_clipri_ID & "', lnote_client_contact_id = " & aclsLocal_Notes.lnote_client_contact_id & ", lnote_jetnet_contact_id = " & aclsLocal_Notes.lnote_jetnet_contact_id & ", lnote_document_flag = '" & Left(aclsLocal_Notes.lnote_document_flag, 1) & "', lnote_jetnet_amod_id = " & aclsLocal_Notes.lnote_jetnet_amod_id & ", lnote_client_amod_id = " & aclsLocal_Notes.lnote_client_amod_id & ", "
      sql = sql & " lnote_document_name = '" & Left(aclsLocal_Notes.lnote_document_name, 200) & "', lnote_opportunity_status = '" & Left(aclsLocal_Notes.lnote_opportunity_status, 1) & "', "

      If Not IsNothing(aclsLocal_Notes.lnote_cash_value) Then
        If IsNumeric(aclsLocal_Notes.lnote_cash_value) Then
          sql = sql & " lnote_cash_value = '" & aclsLocal_Notes.lnote_cash_value & "', "
        Else
          sql = sql & " lnote_cash_value = NULL,"
        End If
      Else
        sql = sql & " lnote_cash_value = NULL,"
      End If

      If Not IsNothing(aclsLocal_Notes.lnote_capture_percentage) Then
        If IsNumeric(aclsLocal_Notes.lnote_capture_percentage) Then
          sql = sql & " lnote_capture_percentage = '" & aclsLocal_Notes.lnote_capture_percentage & "'"
        Else
          sql = sql & " lnote_capture_percentage = NULL"
        End If
      Else
        sql = sql & " lnote_capture_percentage = NULL"
      End If

      sql = sql & ", lnote_wanted_end_year = '" & Left(aclsLocal_Notes.lnote_wanted_end_year, 4) & "', "

      If Not IsNothing(aclsLocal_Notes.lnote_wanted_max_aftt) Then
        If IsNumeric(aclsLocal_Notes.lnote_wanted_max_aftt) Then
          sql = sql & " lnote_wanted_max_aftt = '" & aclsLocal_Notes.lnote_wanted_max_aftt & "', "
        Else
          sql = sql & " lnote_wanted_max_aftt = NULL,"
        End If
      Else
        sql = sql & " lnote_wanted_max_aftt = NULL,"
      End If

      sql = sql & " lnote_wanted_damage_hist = '" & aclsLocal_Notes.lnote_wanted_damage_hist & "', lnote_wanted_damage_cur = '" & aclsLocal_Notes.lnote_wanted_damage_cur & "' ,"
      If Not IsNothing(aclsLocal_Notes.lnote_wanted_max_price) Then
        sql = sql & " lnote_wanted_max_price = '" & aclsLocal_Notes.lnote_wanted_max_price & "',"
      Else
        sql = sql & " lnote_wanted_max_price = NULL,"
      End If

      sql = sql & " lnote_wanted_start_year = '" & Left(aclsLocal_Notes.lnote_wanted_start_year, 4) & "' where lnote_id = " & aclsLocal_Notes.lnote_id & " limit 1"

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>update_localNote(ByVal aclsLocal_Notes As clsLocal_Notes) As Boolean</b><br />" & sql


      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Return True
    Catch ex As Exception
      update_localNote = Nothing
      Me.class_error = "Error in update_localNote(ByVal aclsLocal_Notes As clsLocal_Notes) As Boolean  " & ex.Message
    Finally
      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function


  Public Function Check_If_Note_Exists(ByVal date_today As String, ByVal jetnet_amod_id As Long, ByVal client_amod_id As Long) As Long
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim atemptable As New DataTable
    Dim sql As String = ""
    Dim returned_id As Integer = 0
    Check_If_Note_Exists = 0

    Try



      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      sql = "select lnote_id from local_notes where lnote_action_date = '" & Year(CDate(date_today).Date) & "-" & Month(CDate(date_today).Date) & "-" & Day(CDate(date_today).Date) & "'  "

      sql &= " and (lnote_jetnet_amod_id = " & jetnet_amod_id & " or lnote_client_amod_id= " & client_amod_id & " )"
      MySqlCommand.CommandText = sql

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />Check_If_Note_Exists(ByVal aclsLocal_Notes As clsLocal_Notes) As Integer" & sql

      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      For Each r As DataRow In atemptable.Rows
        Check_If_Note_Exists = r("lnote_id")
      Next



    Catch ex As Exception
      Check_If_Note_Exists = Nothing
      Me.class_error = "Error in Insert_Note(ByVal aclsLocal_Notes As clsLocal_Notes) As Integer  " & ex.Message
    Finally
      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Insert_LocalNote - returns localnoteID, to replace old insert note
  ' Purpose: to Insert Local Note
  ' Parameters: class clsLocal_Notes
  ' Return: 
  '       Boolean
  ' Change Log
  '           12/30/2011   - Created By: Amanda Vaughn
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Insert_Note(ByVal aclsLocal_Notes As clsLocal_Notes) As Integer
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim atemptable As New DataTable
    Dim sql As String = ""
    Dim returned_id As Integer = 0
    Try

      sql = "insert into local_notes(lnote_jetnet_ac_id, lnote_jetnet_comp_id, lnote_client_ac_id, lnote_client_comp_id, lnote_note, lnote_entry_date, lnote_action_date, lnote_user_login, "
      sql = sql & "lnote_user_name, lnote_notecat_key, lnote_status, lnote_schedule_start_date, lnote_schedule_end_date, lnote_user_id, lnote_clipri_ID, lnote_client_contact_id, "
      sql = sql & "lnote_jetnet_contact_id, lnote_document_flag, lnote_jetnet_amod_id, lnote_client_amod_id, lnote_document_name, lnote_opportunity_status, lnote_cash_value, "
      sql = sql & "lnote_capture_percentage, lnote_wanted_end_year, lnote_wanted_max_aftt, lnote_wanted_damage_hist, lnote_wanted_damage_cur, "
      sql = sql & "lnote_wanted_max_price, lnote_wanted_start_year "
      sql = sql & ")"

      sql = sql & "VALUES (" & aclsLocal_Notes.lnote_jetnet_ac_id & ", " & aclsLocal_Notes.lnote_jetnet_comp_id & ","
      sql = sql & " " & aclsLocal_Notes.lnote_client_ac_id & ", " & aclsLocal_Notes.lnote_client_comp_id & ", '" & Escape_Single_Quote(aclsLocal_Notes.lnote_note) & "',"


      If Not IsNothing(aclsLocal_Notes.lnote_entry_date) Then
        If IsDate(aclsLocal_Notes.lnote_entry_date) Then
          sql = sql & " '" & Year(aclsLocal_Notes.lnote_entry_date) & "-" & Month(aclsLocal_Notes.lnote_entry_date) & "-" & Day(aclsLocal_Notes.lnote_entry_date) & " " & Hour(aclsLocal_Notes.lnote_entry_date) & ":" & Minute(aclsLocal_Notes.lnote_entry_date) & ":" & Second(aclsLocal_Notes.lnote_entry_date) & "', "
        Else
          sql = sql & " '" & Year(Now()) & "-" & Month(Now()) & "-" & Day(Now()) & " " & Hour(Now()) & ":" & Minute(Now()) & ":" & Second(Now()) & "', "
        End If
        '"yyyy-MM-dd HH:mm:ss"
      Else
        sql = sql & " '" & Year(Now()) & "-" & Month(Now()) & "-" & Day(Now()) & " " & Hour(Now()) & ":" & Minute(Now()) & ":" & Second(Now()) & "', "
      End If

      If Not IsNothing(aclsLocal_Notes.lnote_action_date) Then
        If IsDate(aclsLocal_Notes.lnote_action_date) Then
          sql = sql & " '" & Year(aclsLocal_Notes.lnote_action_date) & "-" & Month(aclsLocal_Notes.lnote_action_date) & "-" & Day(aclsLocal_Notes.lnote_action_date) & " " & Hour(aclsLocal_Notes.lnote_action_date) & ":" & Minute(aclsLocal_Notes.lnote_action_date) & ":" & Second(aclsLocal_Notes.lnote_action_date) & "', "
        Else
          sql = sql & " '" & Year(Now()) & "-" & Month(Now()) & "-" & Day(Now()) & " " & Hour(Now()) & ":" & Minute(Now()) & ":" & Second(Now()) & "', "
        End If
      Else
        sql = sql & " '" & Year(Now()) & "-" & Month(Now()) & "-" & Day(Now()) & " " & Hour(Now()) & ":" & Minute(Now()) & ":" & Second(Now()) & "', "
      End If

      sql = sql & " '" & Left(aclsLocal_Notes.lnote_user_login, 15) & "', '" & Left(aclsLocal_Notes.lnote_user_name, 50) & "', '" & aclsLocal_Notes.lnote_notecat_key & "', '" & Left(aclsLocal_Notes.lnote_status, 1) & "', "

      If Not IsNothing(aclsLocal_Notes.lnote_schedule_start_date) Then
        If IsDate(aclsLocal_Notes.lnote_schedule_start_date) Then
          sql = sql & "'" & Year(aclsLocal_Notes.lnote_schedule_start_date) & "-" & Month(aclsLocal_Notes.lnote_schedule_start_date) & "-" & Day(aclsLocal_Notes.lnote_schedule_start_date) & " " & Hour(aclsLocal_Notes.lnote_schedule_start_date) & ":" & Minute(aclsLocal_Notes.lnote_schedule_start_date) & ":" & Second(aclsLocal_Notes.lnote_schedule_start_date) & "',"
        Else
          sql = sql & "NULL,"
        End If
      Else
        sql = sql & "NULL,"
      End If

      If Not IsNothing(aclsLocal_Notes.lnote_schedule_end_date) Then
        If IsDate(aclsLocal_Notes.lnote_schedule_end_date) Then
          sql = sql & "'" & Year(aclsLocal_Notes.lnote_schedule_end_date) & "-" & Month(aclsLocal_Notes.lnote_schedule_end_date) & "-" & Day(aclsLocal_Notes.lnote_schedule_end_date) & " " & Hour(aclsLocal_Notes.lnote_schedule_end_date) & ":" & Minute(aclsLocal_Notes.lnote_schedule_end_date) & ":" & Second(aclsLocal_Notes.lnote_schedule_end_date) & "'"
        Else
          sql = sql & "NULL"
        End If
      Else
        sql = sql & "NULL"
      End If

      sql = sql & ", '" & aclsLocal_Notes.lnote_user_id & "', "
      sql = sql & " '" & aclsLocal_Notes.lnote_clipri_ID & "', '" & aclsLocal_Notes.lnote_client_contact_id & "', '" & aclsLocal_Notes.lnote_jetnet_contact_id & "', '" & aclsLocal_Notes.lnote_document_flag & "', '" & aclsLocal_Notes.lnote_jetnet_amod_id & "', '" & aclsLocal_Notes.lnote_client_amod_id & "', "
      sql = sql & " '" & Left(aclsLocal_Notes.lnote_document_name, 200) & "', '" & Left(aclsLocal_Notes.lnote_opportunity_status, 1) & "', "

      If Not IsNothing(aclsLocal_Notes.lnote_cash_value) Then
        If IsNumeric(aclsLocal_Notes.lnote_cash_value) Then
          sql = sql & "'" & aclsLocal_Notes.lnote_cash_value & "', "
        Else
          sql = sql & "NULL,"
        End If
      Else
        sql = sql & "NULL,"
      End If

      If Not IsNothing(aclsLocal_Notes.lnote_capture_percentage) Then
        If IsNumeric(aclsLocal_Notes.lnote_capture_percentage) Then
          sql = sql & " '" & aclsLocal_Notes.lnote_capture_percentage & "'"
        Else
          sql = sql & "NULL"
        End If
      Else
        sql = sql & "NULL"
      End If

      sql = sql & ", '" & Left(aclsLocal_Notes.lnote_wanted_end_year, 4) & "', "

      If Not IsNothing(aclsLocal_Notes.lnote_wanted_max_aftt) Then
        If IsNumeric(aclsLocal_Notes.lnote_wanted_max_aftt) Then
          sql = sql & "'" & aclsLocal_Notes.lnote_wanted_max_aftt & "', "
        Else
          sql = sql & "NULL,"
        End If
      Else
        sql = sql & "NULL,"
      End If

      sql = sql & " '" & Left(aclsLocal_Notes.lnote_wanted_damage_hist, 1) & "','" & Left(aclsLocal_Notes.lnote_wanted_damage_cur, 1) & "' ,"
      If Not IsNothing(aclsLocal_Notes.lnote_wanted_max_price) Then
        If IsNumeric(aclsLocal_Notes.lnote_wanted_max_price) Then
          sql = sql & "'" & aclsLocal_Notes.lnote_wanted_max_price & "',"
        Else
          sql = sql & "NULL,"
        End If
      Else
        sql = sql & "NULL,"
      End If


      sql = sql & " '" & Left(aclsLocal_Notes.lnote_wanted_start_year, 4) & "'"


      sql = sql & ")"

      sql = sql



      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Insert_Note(ByVal aclsLocal_Notes As clsLocal_Notes) As Integer</b><br />" & sql


      sql = "select lnote_id from local_notes order by lnote_id desc"
      MySqlCommand.CommandText = sql

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />Insert_Note(ByVal aclsLocal_Notes As clsLocal_Notes) As Integer" & sql

      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try


      If atemptable.Rows.Count > 0 Then
        returned_id = atemptable.Rows(0).Item("lnote_id")
      End If


    Catch ex As Exception
      Insert_Note = Nothing
      Me.class_error = "Error in Insert_Note(ByVal aclsLocal_Notes As clsLocal_Notes) As Integer  " & ex.Message
    Finally
      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
    Return returned_id
  End Function
  'Public Function Insert_Client_Value_History(ByRef noteID As Long, ByRef valueType As String, ByRef clientAircraftID As Long, ByRef transactionID As Long, ByRef aircraftType As String, ByRef jetnetAircraftID As Long, ByVal asking_price As Long, ByVal take_price As Long, ByVal sold_price As Long) As Integer
  '  Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
  '  Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
  '  Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
  '  Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
  '  Dim atemptable As New DataTable
  '  Dim sql As String = ""
  '  Dim returned_id As Integer = 0
  '  Try

  '    sql = "INSERT INTO client_value_comparables ("
  '    sql += " clival_note_id, "
  '    sql += " clival_type, "
  '    sql += " clival_client_ac_id, "
  '    sql += " clival_clitrans_id, "
  '    sql += " clival_ac_type, "
  '    sql += " clival_jetnet_ac_id, "
  '    sql += "clival_asking_price, clival_est_price, clival_broker_price"
  '    sql += " ) "
  '    sql += " values ("
  '    Note(ID)
  '    sql += noteID.ToString & ","
  '    Value(Type)
  '    sql += "'" & valueType & "',"
  '    Aircraft(ID(client))
  '    sql += clientAircraftID.ToString & ","
  '    Transaction(ID)
  '    sql += transactionID.ToString & ","
  '    Aircraft(Type)
  '    sql += "'" & aircraftType & "',"
  '    Jetnet Aircraft ID
  '    sql += jetnetAircraftID.ToString & ","


  '    sql += "'" & asking_price & "',"
  '    sql += "'" & take_price & "',"
  '    sql += "'" & sold_price & "'"

  '    sql += ")"


  '    sql = sql

  '    MySqlConn.ConnectionString = Me.client_DB
  '    MySqlConn.Open()
  '    MySqlCommand.Connection = MySqlConn
  '    MySqlCommand.CommandType = CommandType.Text
  '    MySqlCommand.CommandTimeout = 60

  '    MySqlCommand.CommandText = sql
  '    MySqlCommand.ExecuteNonQuery()


  '    HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Insert_Note(ByVal aclsLocal_Notes As clsLocal_Notes) As Integer</b><br />" & sql

  '  Catch ex As Exception
  '    Insert_Client_Value_History = Nothing
  '    Me.class_error = "Error in Insert_Client_Value_Comparable(ByRef noteID As Long, ByRef valueType As String, ByRef clientAircraftID As Long, ByRef transactionID As Long, ByRef aircraftType As String, ByRef jetnetAircraftID As Long) As Integer " & ex.Message
  '  Finally
  '    MySqlConn.Close()
  '    MySqlConn.Dispose()
  '    MySqlConn = Nothing
  '    MySqlCommand.Dispose()
  '    MySqlCommand = Nothing
  '  End Try
  '  Return returned_id
  'End Function


  Public Function Update_Client_Value_Comparable(ByRef noteID As Long, ByRef valueType As String, ByRef clientAircraftID As Long, ByRef transactionID As Long, ByRef aircraftType As String, ByRef jetnetAircraftID As Long, ByVal clival_id As Long, ByVal aclsLocal_Notes As clsLocal_Notes) As Integer
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim atemptable As New DataTable
    Dim sql As String = ""
    Dim returned_id As Integer = 0
    Try

      sql = "Update client_value_comparables set "
      sql += " clival_note_id = " & noteID.ToString & ", "
      sql += " clival_type = '" & valueType & "',"
      sql += " clival_client_ac_id = " & clientAircraftID.ToString & ","
      sql += " clival_clitrans_id = " & transactionID.ToString & ","
      sql += " clival_ac_type = '" & aircraftType & "',"
      sql += " clival_jetnet_ac_id = " & jetnetAircraftID.ToString & ","
      sql += " clival_jetnet_amod_id = " & aclsLocal_Notes.lnote_jetnet_amod_id.ToString & ", "

      sql += " clival_asking_price = "



      If Not IsNothing(aclsLocal_Notes.lnote_estval_asking_price) Then
        If IsNumeric(aclsLocal_Notes.lnote_estval_asking_price) Then
          sql = sql & "'" & aclsLocal_Notes.lnote_estval_asking_price & "', "
        Else
          sql = sql & "0,"
        End If
      Else
        sql = sql & "0,"
      End If


      sql += " clival_est_price = "

      If Not IsNothing(aclsLocal_Notes.lnote_estval_take_price) Then
        If IsNumeric(aclsLocal_Notes.lnote_estval_take_price) Then
          sql = sql & "'" & aclsLocal_Notes.lnote_estval_take_price & "', "
        Else
          sql = sql & "0,"
        End If
      Else
        sql = sql & "0,"
      End If


      sql += " clival_broker_price = "



      If Not IsNothing(aclsLocal_Notes.lnote_estval_estimated_value) Then
        If IsNumeric(aclsLocal_Notes.lnote_estval_estimated_value) Then
          sql = sql & "'" & aclsLocal_Notes.lnote_estval_estimated_value & "', "
        Else
          sql = sql & "0,"
        End If
      Else
        sql = sql & "0,"
      End If


      sql += " clival_aftt_hours = "

      If Not IsNothing(aclsLocal_Notes.lnote_estval_aftt) Then
        If IsNumeric(aclsLocal_Notes.lnote_estval_aftt) Then
          sql = sql & "'" & aclsLocal_Notes.lnote_estval_aftt & "', "
        Else
          sql = sql & "0,"
        End If
      Else
        sql = sql & "0,"
      End If


      sql += " clival_total_landings = "



      If Not IsNothing(aclsLocal_Notes.lnote_estval_total_landings) Then
        If IsNumeric(aclsLocal_Notes.lnote_estval_total_landings) Then
          sql = sql & "'" & aclsLocal_Notes.lnote_estval_total_landings & "', "
        Else
          sql = sql & "0,"
        End If
      Else
        sql = sql & "0,"
      End If

      sql += " clival_entry_date = "


      If Not IsNothing(aclsLocal_Notes.lnote_entry_date) Then
        If IsDate(aclsLocal_Notes.lnote_entry_date) = True Then
          sql = sql & "'" & Year(aclsLocal_Notes.lnote_entry_date) & "-" & Month(aclsLocal_Notes.lnote_entry_date) & "-" & Day(aclsLocal_Notes.lnote_entry_date) & "' "
        Else
          sql = sql & "NULL"
        End If
      Else
        sql = sql & "NULL"
      End If

      sql += " where clival_id = " & clival_id


      sql = sql

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Update_Client_Value_Comparable(ByVal aclsLocal_Notes As clsLocal_Notes) As Integer</b><br />" & sql

    Catch ex As Exception
      Update_Client_Value_Comparable = Nothing
      Me.class_error = "Error in Update_Client_Value_Comparable(ByRef noteID As Long, ByRef valueType As String, ByRef clientAircraftID As Long, ByRef transactionID As Long, ByRef aircraftType As String, ByRef jetnetAircraftID As Long) As Integer " & ex.Message
    Finally
      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
    Return returned_id
  End Function

  Public Function Insert_Client_Value_Comparable(ByRef noteID As Long, ByRef valueType As String, ByRef clientAircraftID As Long, ByRef transactionID As Long, ByRef aircraftType As String, ByRef jetnetAircraftID As Long, Optional ByVal aclsLocal_Notes As clsLocal_Notes = Nothing) As Integer
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim atemptable As New DataTable
    Dim sql As String = ""
    Dim returned_id As Integer = 0
    Try

      sql = "INSERT INTO client_value_comparables ("
      sql += " clival_note_id, "
      sql += " clival_type, "
      sql += " clival_client_ac_id, "
      sql += " clival_clitrans_id, "
      sql += " clival_ac_type, "
      sql += " clival_jetnet_ac_id, "
      sql += " clival_jetnet_amod_id"

      If Not IsNothing(aclsLocal_Notes) Then
        ' ADDED IN MSW - 5/31/2016
        sql = sql & ", clival_asking_price, clival_est_price, clival_broker_price, clival_aftt_hours, clival_total_landings, clival_entry_date "
      End If


      sql += ") "
      sql += " values ("
      'Note ID
      sql += noteID.ToString & ","
      'Value Type
      sql += "'" & valueType & "',"
      'Aircraft ID (client)
      sql += clientAircraftID.ToString & ","

      'Transaction ID
      sql += transactionID.ToString & ","
      'Aircraft Type
      sql += "'" & aircraftType & "',"
      'Jetnet Aircraft ID
      sql += jetnetAircraftID.ToString & ","

      sql += aclsLocal_Notes.lnote_jetnet_amod_id.ToString

      If Not IsNothing(aclsLocal_Notes) Then
        sql += ","

        If Not IsNothing(aclsLocal_Notes.lnote_estval_asking_price) Then
          If IsNumeric(aclsLocal_Notes.lnote_estval_asking_price) Then
            sql = sql & "'" & aclsLocal_Notes.lnote_estval_asking_price & "', "
          Else
            sql = sql & "0,"
          End If
        Else
          sql = sql & "0,"
        End If

        If Not IsNothing(aclsLocal_Notes.lnote_estval_take_price) Then
          If IsNumeric(aclsLocal_Notes.lnote_estval_take_price) Then
            sql = sql & "'" & aclsLocal_Notes.lnote_estval_take_price & "', "
          Else
            sql = sql & "0,"
          End If
        Else
          sql = sql & "0,"
        End If

        If Not IsNothing(aclsLocal_Notes.lnote_estval_estimated_value) Then
          If IsNumeric(aclsLocal_Notes.lnote_estval_estimated_value) Then
            sql = sql & "'" & aclsLocal_Notes.lnote_estval_estimated_value & "', "
          Else
            sql = sql & "0,"
          End If
        Else
          sql = sql & "0,"
        End If

        If Not IsNothing(aclsLocal_Notes.lnote_estval_aftt) Then
          If IsNumeric(aclsLocal_Notes.lnote_estval_aftt) Then
            sql = sql & "'" & aclsLocal_Notes.lnote_estval_aftt & "', "
          Else
            sql = sql & "0,"
          End If
        Else
          sql = sql & "0,"
        End If

        If Not IsNothing(aclsLocal_Notes.lnote_estval_total_landings) Then
          If IsNumeric(aclsLocal_Notes.lnote_estval_total_landings) Then
            sql = sql & "'" & aclsLocal_Notes.lnote_estval_total_landings & "', "
          Else
            sql = sql & "0,"
          End If
        Else
          sql = sql & "0,"
        End If

        If Not IsNothing(aclsLocal_Notes.lnote_entry_date) Then
          If IsDate(aclsLocal_Notes.lnote_entry_date) = True Then
            sql = sql & "'" & Year(aclsLocal_Notes.lnote_entry_date) & "-" & Month(aclsLocal_Notes.lnote_entry_date) & "-" & Day(aclsLocal_Notes.lnote_entry_date) & "' "
          Else
            sql = sql & "NULL"
          End If
        Else
          sql = sql & "NULL"
        End If

      End If



      sql += ")"


      sql = sql

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Insert_Note(ByVal aclsLocal_Notes As clsLocal_Notes) As Integer</b><br />" & sql

    Catch ex As Exception
      Insert_Client_Value_Comparable = Nothing
      Me.class_error = "Error in Insert_Client_Value_Comparable(ByRef noteID As Long, ByRef valueType As String, ByRef clientAircraftID As Long, ByRef transactionID As Long, ByRef aircraftType As String, ByRef jetnetAircraftID As Long) As Integer " & ex.Message
    Finally
      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
    Return returned_id
  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Delete_LocalNote
  ' Purpose: to Delete Local Note
  ' Parameters: class clsLocal_Notes
  ' Return: 
  '       Boolean
  ' Change Log
  '           1/24/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Delete_LocalNote(ByVal aclsLocal_Notes As clsLocal_Notes) As Boolean
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim atemptable As New DataTable
    Dim sql As String = ""

    Try

      sql = "DELETE FROM Local_Notes WHERE (lnote_id = " & aclsLocal_Notes.lnote_id & ") limit 1 "
      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Delete_LocalNote(ByVal aclsLocal_Notes As clsLocal_Notes) As Boolean</b><br />" & sql

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Return True

    Catch ex As Exception
      Delete_LocalNote = Nothing
      Me.class_error = "Error in Delete_LocalNote(ByVal aclsLocal_Notes As clsLocal_Notes)  " & ex.Message
    Finally
      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try


  End Function

  Public Function Delete_Client_Value_Comparable(ByVal clival_id As Long) As Boolean
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim atemptable As New DataTable
    Dim sql As String = ""

    Try

      sql = "DELETE FROM client_value_comparables WHERE (clival_id = " & clival_id & ") limit 1 "
      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Delete_LocalNote(ByVal aclsLocal_Notes As clsLocal_Notes) As Boolean</b><br />" & sql

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Return True

    Catch ex As Exception
      Delete_Client_Value_Comparable = Nothing
      Me.class_error = "Error in Delete_LocalNote(ByVal aclsLocal_Notes As clsLocal_Notes)  " & ex.Message
    Finally
      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try


  End Function
  ''' <summary>
  ''' notes query for tabs. 
  ''' </summary>
  ''' <param name="client_ID"></param>
  ''' <param name="jetnet_ID"></param>
  ''' <param name="lnote_status"></param>
  ''' <param name="aircraft"></param>
  ''' <param name="company"></param>
  ''' <returns></returns> 
  ''' <remarks></remarks>
  Public Function Dual_NotesOnlyOne(ByVal client_ID As Integer, ByVal jetnet_ID As Integer, ByVal lnote_status As String, ByVal aircraft As Boolean, ByVal company As Boolean, Optional ByVal get_all_notes As Boolean = False, Optional ByVal contact As Boolean = False) As DataTable

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim aTempTable As New DataTable
    Try
      'Setting up the query strings and some of the parameters. 
      Dim squery As String = ""
      Dim whereClause As String = ""
      Dim order_by As String = " lnote_entry_date desc"
      If lnote_status = "P" Then
        order_by = " lnote_schedule_start_date asc"
      End If

      squery = "SELECT local_notes.lnote_id, local_notes.lnote_jetnet_ac_id, local_notes.lnote_opportunity_status, local_notes.lnote_jetnet_comp_id, local_notes.lnote_client_ac_id, local_notes.lnote_client_comp_id, "
      squery = squery & "local_notes.lnote_jetnet_contact_id, local_notes.lnote_client_contact_id, LEFT(local_notes.lnote_note, 21000) AS lnote_note, local_notes.lnote_entry_date, "
      squery = squery & "local_notes.lnote_action_date, local_notes.lnote_user_login, local_notes.lnote_user_name, local_notes.lnote_notecat_key, local_notes.lnote_status, "
      squery = squery & "local_notes.lnote_schedule_start_date, local_notes.lnote_schedule_end_date, local_notes.lnote_user_id, local_notes.lnote_clipri_ID, "
      squery = squery & "local_notes.lnote_document_flag, local_notes.lnote_jetnet_amod_id, 0 as lnote_jetnet_yacht_id, local_notes.lnote_client_amod_id, local_notes.lnote_document_name, clicomp_name "
      squery = squery & ", oppcat, lnote_capture_percentage, lnote_cash_value "

      squery = squery & "FROM local_notes "

      If lnote_status <> "O" Then
        squery = squery & " INNER JOIN "
        squery = squery & "note_category ON local_notes.lnote_notecat_key = note_category.notecat_key "
      End If
      squery = squery & " LEFT OUTER JOIN "
      squery = squery & "client_user ON local_notes.lnote_user_id = client_user.cliuser_user_id "

      squery = squery & " LEFT OUTER JOIN "
      squery = squery & "client_company  ON client_company.clicomp_jetnet_comp_id = local_notes.lnote_jetnet_comp_id and local_notes.lnote_jetnet_comp_id > 0 "

      squery = squery & " LEFT OUTER JOIN "
      squery = squery & "opportunity_category ON oppcat_key = lnote_notecat_key "


      MySqlConn.ConnectionString = Me.client_DB

      If HttpContext.Current.Session.Item("localUser").crmUserType = eUserTypes.MyNotesOnly Then
        whereClause = " local_notes.lnote_user_id = '" & HttpContext.Current.Session.Item("localUser").crmLocalUserID.ToString & "' and "
      End If


      If lnote_status = "A" Then
        lnote_status = whereClause & " ( local_notes.lnote_status in ('A','E') ) "
        If get_all_notes = False Then
          lnote_status &= " and "
        End If
      ElseIf lnote_status = "" Then
        lnote_status = whereClause & " "
      Else
        lnote_status = whereClause & " (local_notes.lnote_status = '" & lnote_status & "' )  "
        If get_all_notes = False Then
          lnote_status &= " and "
        End If
      End If




      If get_all_notes = True Then
        squery = squery & "WHERE " & lnote_status & ""
        squery = squery & "ORDER BY " & order_by
      ElseIf aircraft = True Then 'Aircraft data
        If client_ID = 0 Then 'Aircraft Jetnet Side Data
          squery = squery & "WHERE " & lnote_status & " (local_notes.lnote_jetnet_ac_id ='" & jetnet_ID & "') "
          squery = squery & "ORDER BY " & order_by

        Else 'Client Side Data
          squery = squery & "WHERE  " & lnote_status & " (local_notes.lnote_client_ac_id = '" & client_ID & "') "
          squery = squery & "ORDER BY " & order_by

        End If
      ElseIf company = True Then
        If client_ID = 0 Then 'Jetnet SIDE Data
          squery = squery & "WHERE  " & lnote_status & " (local_notes.lnote_jetnet_comp_id = '" & jetnet_ID & "') "
          squery = squery & "ORDER BY " & order_by

        Else 'Client Side Data
          squery = squery & "WHERE  " & lnote_status & " (local_notes.lnote_client_comp_id = '" & client_ID & "') "
          squery = squery & "ORDER BY " & order_by
        End If
      ElseIf contact = True Then ' contact must be true, company Data.
        If client_ID = 0 Then 'Jetnet SIDE Data
          squery = squery & "WHERE  " & lnote_status & " (local_notes.lnote_jetnet_contact_id = '" & jetnet_ID & "') "
          squery = squery & "ORDER BY " & order_by

        Else 'Client Side Data
          squery = squery & "WHERE  " & lnote_status & " (local_notes.lnote_client_contact_id = '" & client_ID & "') "
          squery = squery & "ORDER BY " & order_by
        End If
      End If


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Dual_NotesOnlyOne(ByVal client_ID As Integer, ByVal jetnet_ID As Integer, ByVal lnote_status As String, ByVal aircraft As Boolean, ByVal company As Boolean) As DataTable</b><br />" & squery


      MySqlCommand.CommandText = squery
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable
    Catch ex As Exception
      Dual_NotesOnlyOne = Nothing
      Me.class_error = "Error in SQL Dual_NotesOnlyOne(ByVal " & client_ID & " As Integer, ByVal " & jetnet_ID & " As Integer, ByVal " & lnote_status & " As String ): " & ex.Message
    Finally
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
  ''' <summary>
  '''  notes query for tabs. 
  ''' </summary>
  ''' <param name="Aircraft_client_ID"></param>
  ''' <param name="Aircraft_jetnet_ID"></param>
  ''' <param name="Company_client_ID"></param>
  ''' <param name="Company_jetnet_ID"></param>
  ''' <returns></returns>
  ''' <remarks></remarks> 
  Public Function GetListOfValuation(ByVal Aircraft_client_ID As Long, ByVal Aircraft_jetnet_ID As Long, ByVal Company_client_ID As Long, ByVal Company_jetnet_ID As Long) As DataTable

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim aTempTable As New DataTable
    Try
      'Setting up the query strings and some of the parameters. 
      Dim squery As String = "select lnote_id, lnote_action_date,lnote_note, lnote_opportunity_status, "
      squery += " cliaircraft_asking_price, cliaircraft_est_price, cliaircraft_broker_price, "
      squery += " clival_asking_price, clival_est_price, clival_broker_price,"
      squery += " clicomp_name, clicomp_city, clicomp_state, clicomp_country, clicomp_id"
      squery += " from local_notes"
      squery += " left outer join client_aircraft on cliaircraft_id = lnote_client_ac_id"
      squery += " left outer join client_value_comparables on clival_client_ac_id = cliaircraft_id and lnote_id = clival_note_id "
      squery += " left outer join client_company on clicomp_id = lnote_client_comp_id"
      squery += " where (lnote_client_ac_id = " & Aircraft_client_ID & " Or lnote_jetnet_ac_id = " & Aircraft_jetnet_ID & ")"

      If Company_client_ID > 0 Or Company_jetnet_ID > 0 Then

        squery += " and ("
        If Company_client_ID > 0 Then
          squery += " lnote_client_comp_id = " & Company_client_ID & " "
        End If
        If Company_jetnet_ID > 0 Then
          If Company_client_ID > 0 Then
            squery += " and "
          End If
          squery += " lnote_jetnet_comp_id = " & Company_jetnet_ID
        End If
        squery += ")"
      End If

      squery += " and lnote_status='V' and lnote_opportunity_status <> 'T' and clival_ac_type = 'P' "
      squery += " order by lnote_action_date desc "


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Public Function GetListOfValuation(ByVal client_ID As Integer, ByVal jetnet_ID As Integer) As DataTable</b><br />" & squery


      MySqlCommand.CommandText = squery
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable
    Catch ex As Exception
      GetListOfValuation = Nothing
      Me.class_error = "Error in SQL Public Function GetListOfValuation(ByVal client_ID As Integer, ByVal jetnet_ID As Integer) As DataTable: " & ex.Message
    Finally
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  Public Function GetComparableValuesExcludingCertainAC(ByVal Aircraft_ID As Long) As DataTable

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim aTempTable As New DataTable
    Try
      'Setting up the query strings and some of the parameters. 
      Dim squery As String = "SELECT DISTINCT cliamod_make_name, cliamod_model_name, cliaircraft_ser_nbr, lnote_note, lnote_id "
      squery += " FROM local_notes "
      squery += " INNER JOIN client_aircraft ON cliaircraft_id = lnote_client_ac_id"
      squery += " INNER JOIN client_aircraft_model ON cliamod_id = cliaircraft_cliamod_id"
      squery += " WHERE lnote_status = 'V'"
      squery += " AND lnote_opportunity_status = 'O'"
      squery += " AND lnote_client_ac_id <>" & Aircraft_ID.ToString
      squery += " AND lnote_id NOT "
      squery += " IN ("

      squery += " SELECT DISTINCT clival_note_id"
      squery += " FROM client_value_comparables "
      squery += " INNER JOIN local_notes ON lnote_id = clival_note_id"
      squery += " WHERE lnote_opportunity_status = 'O'"
      squery += " AND clival_client_ac_id =" & Aircraft_ID.ToString
      squery += " )"
      squery += " LIMIT 30"




      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Public Function GetComparableValuesExcludingCertainAC(ByVal Aircraft_ID As Long) As DataTable</b><br />" & squery


      MySqlCommand.CommandText = squery
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable
    Catch ex As Exception
      GetComparableValuesExcludingCertainAC = Nothing
      Me.class_error = "Error in SQL Public Function GetComparableValuesExcludingCertainAC(ByVal Aircraft_ID As Long) As DataTable: " & ex.Message
    Finally
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Local_Notes_Client_Contact
  ' Purpose: to get the local notes for a Client Company
  ' Parameters: lnote_client_contact_id 
  ' Return: 
  '       DataTable
  ' Change Log
  '           1/6/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Local_Notes_Client_Contact(ByVal lnote_client_contact_id As Integer) As DataTable
    Dim sql As String = ""

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim aTempTable As New DataTable
    Try
      sql = ""
      sql = "SELECT local_notes.lnote_id, local_notes.lnote_jetnet_ac_id, local_notes.lnote_jetnet_comp_id, "
      sql = sql & " local_notes.lnote_client_ac_id, local_notes.lnote_client_comp_id, "
      sql = sql & " local_notes.lnote_jetnet_contact_id, local_notes.lnote_client_contact_id, LEFT(local_notes.lnote_note, 21000) "
      sql = sql & " AS lnote_note, local_notes.lnote_entry_date, "
      sql = sql & " local_notes.lnote_action_date, local_notes.lnote_user_login, local_notes.lnote_user_name, "
      sql = sql & " local_notes.lnote_notecat_key, local_notes.lnote_status, "
      sql = sql & " local_notes.lnote_schedule_start_date, local_notes.lnote_schedule_end_date, local_notes.lnote_user_id, "
      sql = sql & " local_notes.lnote_clipri_ID, client_priority.clipri_name, "
      sql = sql & " client_priority.clipri_sort_order, local_notes.lnote_document_flag, local_notes.lnote_jetnet_amod_id, "
      sql = sql & " local_notes.lnote_client_amod_id, "
      sql = sql & " local_notes.lnote_document_name, local_notes.lnote_opportunity_status, local_notes.lnote_cash_value, "
      sql = sql & " local_notes.lnote_capture_percentage, "
      sql = sql & " local_notes.lnote_wanted_start_year, local_notes.lnote_wanted_end_year, local_notes.lnote_wanted_max_price, "
      sql = sql & " local_notes.lnote_wanted_max_aftt, "
      sql = sql & " local_notes.lnote_wanted_damage_hist, local_notes.lnote_wanted_damage_cur"
      sql = sql & " FROM  local_notes INNER JOIN"
      sql = sql & " client_priority ON local_notes.lnote_clipri_ID = client_priority.clipri_ID"
      sql = sql & " WHERE (local_notes.lnote_client_contact_id = " & lnote_client_contact_id & " )"

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Local_Notes_Client_Contact(ByVal lnote_client_contact_id As Integer) As DataTable</b><br />" & sql


      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable
    Catch ex As Exception
      Get_Local_Notes_Client_Contact = Nothing
      Me.class_error = "Error in SQL Get_Local_Notes_Client_Contact(ByVal " & lnote_client_contact_id & " As Integer) " & ex.Message
    Finally
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_Note_Category
  ' Purpose: to get all records from the Client_Note_Category table
  ' Parameters: 
  ' Return: 
  '       DataTable
  ' Change Log
  '           019/2009    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Client_Note_Category() As DataTable
    Dim sql As String = ""

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim aTempTable As New DataTable
    Try
      sql = "SELECT * FROM note_category"

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Note_Category() as datatable</b><br />" & sql


      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable
    Catch ex As Exception
      Get_Client_Note_Category = Nothing
      Me.class_error = "Error in SQL Get_Client_Note_Category() " & ex.Message
    Finally
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Opportunity_Categories
  ' Purpose: to get all records from the Get_Opportunity_Categories
  ' Parameters: 
  ' Return: 
  '       DataTable
  ' Change Log
  '           01/11/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Opportunity_Categories() As DataTable
    Dim sql As String = ""

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim aTempTable As New DataTable

    Try

      sql = " SELECT *  FROM opportunity_category order by oppcat"

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Opportunity_Categories() As DataTable</b><br />" & sql

      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable
    Catch ex As Exception
      Get_Opportunity_Categories = Nothing
      Me.class_error = "Error in SQL Get_Opportunity_Categories()) " & ex.Message
    Finally
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  Public Function Get_Service_Categories() As DataTable
    Dim sql As String = ""

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim aTempTable As New DataTable

    Try

      sql = " SELECT *  FROM opportunity_category order by oppcat"

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Opportunity_Categories() As DataTable</b><br />" & sql

      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable
    Catch ex As Exception
      Get_Service_Categories = Nothing
      Me.class_error = "Error in SQL Get_Opportunity_Categories()) " & ex.Message
    Finally
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Local_Notes_Client_LastestByUser
  ' Purpose: to get the local notes based on latest notes by a certain user, and after a certain date
  ' Parameters: lnote_user_login As Integer, ByVal lnote_schedule_start_date As String, ByVal lnote_status
  ' Return: 
  '       DataTable
  ' Change Log
  '           1/18/2011    - Created By: Amanda Vaughn
  Public Function Get_Local_Notes_GetByUserIDStatusLessThanDate(ByVal lnote_user_login As Integer, ByVal lnote_schedule_start_date As String, ByVal lnote_status As String) As DataTable
    Dim sql As String = ""

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim aTempTable As New DataTable
    lnote_schedule_start_date = Format(CDate(lnote_schedule_start_date), "yyyy-MM-dd HH:mm:ss")
    'If Not IsDate(lnote_schedule_start_date) Then
    '    lnote_schedule_start_date = Year(lnote_schedule_start_date) & "-" & Month(lnote_schedule_start_date) & "-" & Day(lnote_schedule_start_date)
    'Else
    '    lnote_schedule_start_date = Year(Now()) & "-" & Month(Now()) & "-" & Day(Now())
    'End If

    Try
      sql = "SELECT local_notes.lnote_id, local_notes.lnote_jetnet_ac_id,0 as lnote_jetnet_yacht_id, local_notes.lnote_jetnet_comp_id, local_notes.lnote_client_ac_id, local_notes.lnote_client_comp_id, "
      sql = sql & " local_notes.lnote_jetnet_contact_id, local_notes.lnote_client_contact_id, LEFT(local_notes.lnote_note, 21000) AS lnote_note, local_notes.lnote_entry_date, "
      sql = sql & " local_notes.lnote_action_date, local_notes.lnote_user_login, local_notes.lnote_user_name, local_notes.lnote_notecat_key, local_notes.lnote_status, "
      sql = sql & " local_notes.lnote_schedule_start_date, local_notes.lnote_schedule_end_date, local_notes.lnote_user_id, local_notes.lnote_clipri_ID, client_priority.clipri_name, "
      sql = sql & " client_priority.clipri_sort_order, local_notes.lnote_document_flag, local_notes.lnote_jetnet_amod_id, local_notes.lnote_client_amod_id, "
      sql = sql & " local_notes.lnote_document_name, local_notes.lnote_opportunity_status, local_notes.lnote_cash_value, local_notes.lnote_capture_percentage, "
      sql = sql & " local_notes.lnote_wanted_start_year, local_notes.lnote_wanted_end_year, local_notes.lnote_wanted_max_price, local_notes.lnote_wanted_max_aftt, "
      sql = sql & " local_notes.lnote_wanted_damage_hist, local_notes.lnote_wanted_damage_cur"
      sql = sql & " FROM local_notes INNER JOIN"
      sql = sql & " client_priority ON local_notes.lnote_clipri_ID = client_priority.clipri_ID"
      sql = sql & " WHERE "

      If lnote_user_login <> 0 Then
        sql = sql & " (local_notes.lnote_user_id = " & lnote_user_login & ") AND "
      End If

      sql = sql & " (local_notes.lnote_schedule_start_date <= '" & lnote_schedule_start_date & "') AND "
      sql = sql & " (local_notes.lnote_status = '" & lnote_status & "')"
      sql = sql & " ORDER BY local_notes.lnote_schedule_start_date"

      'save to session query debug string.
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Local_Notes_GetByUserIDStatusLessThanDate(ByVal lnote_user_login As Integer, ByVal lnote_schedule_start_date As String, ByVal lnote_status As String) As DataTable</b><br />" & sql

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      sql = ""

      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable
    Catch ex As Exception
      Get_Local_Notes_GetByUserIDStatusLessThanDate = Nothing
      Me.class_error = "Error in SQL Get_Local_Notes_GetByUserIDStatusLessThanDate(ByVal lnote_user_login As Integer, ByVal lnote_schedule_start_date As String, ByVal lnote_status As String) " & ex.Message
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />Error in SQL Get_Local_Notes_GetByUserIDStatusLessThanDate(ByVal lnote_user_login As Integer, ByVal lnote_schedule_start_date As String, ByVal lnote_status As String) " & ex.Message

    Finally
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
  'Notes - what search they are. This one is a lot more difficult.
  'Return: 
  '       DataTable
  ' Change Log
  '           12/23/2011    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ''' <summary>
  ''' Notes Search for Mobile and Regular Version
  ''' </summary>
  ''' <param name="note_search">Notes Search Text</param>
  ''' <param name="note_start_date">Notes Start Date - Careful depending on status - the field that this uses changes
  ''' entry date/schedule start date, etc</param>
  ''' <param name="note_end_date">Notes End Date - read start date careful above</param>
  ''' <param name="note_type">Status type = A, E, D? etc</param>
  ''' <param name="category">Note Category</param>
  ''' <param name="jetnet_amod_id">List of Model IDs for Notes - Jetnet Model IDs</param>
  ''' <param name="client_amod_id">List of Model IDs for Notes - Client Model IDs</param>
  ''' <param name="user">User who created the note</param>
  ''' <returns>Datatable</returns>
  ''' <remarks>Once again, datahooks aren't very scaleable, so they weren't used here. </remarks>
  Public Function Notes_Search(ByVal note_search As String, ByVal note_start_date As String, ByVal note_end_date As String, ByVal note_type As String, ByVal category As String, ByVal jetnet_amod_id As String, ByVal client_amod_id As String, ByVal user As String, ByVal opp_status As String, ByVal ClientIDs As String, ByVal JetnetIDs As String, ByVal acSearchField As Integer, ByVal acSearchOperator As Integer, ByVal acSearchText As String, ByVal OnlyModel As Boolean, ByVal OnlyAircraft As Boolean, Optional ByVal FolderType As Long = 3, Optional ByVal PriorityID As String = "") As DataTable
    Dim FieldToPoll As String = "ac"
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing

    Try
      ' create the Select Strings
      Dim aSQL_String_Client_Select As String = ""
      Dim aSQL_String_JETNET_Select As String = ""
      ' create the Where string
      Dim aSQL_String_Client_Where As String = ""
      Dim aSQL_String_JETNET_Where As String = ""
      ' create a data table to hold the company info
      Dim dalTable As New DataTable
      Dim atemptable As New DataTable
      Dim atemptable2 As New DataTable
      Dim dataSet As DataSet = New DataSet("dataSet")
      dataSet.Tables.Add(atemptable)
      dataSet.EnforceConstraints = False
      Dim AircraftSearch As Boolean = False


      If Not String.IsNullOrEmpty(Trim(acSearchText)) Then
        'If the aircraft search field isn't empty.
        'We need to go ahead and add that this is an aircraft search.
        AircraftSearch = True
      End If

      '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
      '----------------------------------------------------------- check to see if we are getting client data---------------------------------------------------
      '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

      '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
      ' ---------------------------------------------------------Setup the Client SQL Strings---------------------------------------------------------------
      '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

      'These are the basic fields needed for the company export. 

      aSQL_String_Client_Select = "SELECT local_notes.lnote_id, local_notes.lnote_jetnet_ac_id, local_notes.lnote_jetnet_comp_id, lnote_opportunity_status, lnote_cash_value, lnote_capture_percentage, "
      aSQL_String_Client_Select = aSQL_String_Client_Select & "local_notes.lnote_client_ac_id, local_notes.lnote_client_comp_id, "
      aSQL_String_Client_Select = aSQL_String_Client_Select & "local_notes.lnote_jetnet_contact_id, local_notes.lnote_client_contact_id, left(local_notes.lnote_note,21000)"
      aSQL_String_Client_Select = aSQL_String_Client_Select & "as lnote_note, local_notes.lnote_entry_date, local_notes.lnote_action_date, "
      aSQL_String_Client_Select = aSQL_String_Client_Select & "local_notes.lnote_user_login, local_notes.lnote_user_name, local_notes.lnote_notecat_key, local_notes.lnote_status, "
      aSQL_String_Client_Select = aSQL_String_Client_Select & "local_notes.lnote_schedule_start_date, "
      aSQL_String_Client_Select = aSQL_String_Client_Select & "local_notes.lnote_schedule_end_date, local_notes.lnote_user_id, local_notes.lnote_clipri_ID, client_priority.clipri_name, "
      aSQL_String_Client_Select = aSQL_String_Client_Select & "client_priority.clipri_sort_order, "
      aSQL_String_Client_Select = aSQL_String_Client_Select & "local_notes.lnote_document_flag, local_notes.lnote_jetnet_amod_id, local_notes.lnote_client_amod_id,lnote_status, "
      aSQL_String_Client_Select = aSQL_String_Client_Select & "local_notes.lnote_document_name "
      aSQL_String_Client_Select = aSQL_String_Client_Select & "FROM  local_notes INNER JOIN "
      aSQL_String_Client_Select = aSQL_String_Client_Select & "client_priority ON local_notes.lnote_clipri_ID = client_priority.clipri_ID"

      'This means that this is an aircraft search
      If AircraftSearch Then
        'So we need to go ahead and add an inner join.
        aSQL_String_Client_Select = aSQL_String_Client_Select & " left outer join client_aircraft on local_notes.lnote_client_ac_id = cliaircraft_id "
      End If

      atemptable.Columns.Add("lnote_id")
      atemptable.Columns.Add("lnote_opportunity_status")
      atemptable.Columns.Add("lnote_cash_value")
      atemptable.Columns.Add("lnote_capture_percentage")
      atemptable.Columns.Add("lnote_jetnet_comp_id")
      atemptable.Columns.Add("lnote_jetnet_ac_id")
      atemptable.Columns.Add("lnote_jetnet_contact_id")
      atemptable.Columns.Add("lnote_client_comp_id")
      atemptable.Columns.Add("lnote_client_ac_id")
      atemptable.Columns.Add("lnote_client_contact_id")
      atemptable.Columns.Add("lnote_note")
      atemptable.Columns.Add("lnote_entry_date")
      atemptable.Columns.Add("lnote_action_date")
      atemptable.Columns.Add("lnote_user_login")
      atemptable.Columns.Add("lnote_user_name")
      atemptable.Columns.Add("lnote_notecat_key")
      atemptable.Columns.Add("lnote_schedule_start_date")
      atemptable.Columns.Add("lnote_schedule_end_date")
      atemptable.Columns.Add("lnote_user_id")
      atemptable.Columns.Add("lnote_clipri_ID")
      atemptable.Columns.Add("lnote_status")
      atemptable.Columns.Add("clipri_name")
      atemptable.Columns.Add("clipri_sort_order")
      atemptable.Columns.Add("lnote_document_flag")
      atemptable.Columns.Add("lnote_jetnet_amod_id")
      atemptable.Columns.Add("lnote_client_amod_id")
      atemptable.Columns.Add("lnote_document_name")

      Dim AndQ As String = ""
      'The Building of the Where Clause 

      If OnlyModel = True Then
        'This is sent on the propsect search, all others are false. This is sent whenever the customer wants to return only prospects with a model attached.
        aSQL_String_Client_Where = aSQL_String_Client_Where & " (lnote_jetnet_amod_id <> 0 or lnote_client_amod_id <> 0 ) " ' and (lnote_jetnet_ac_id = 0 and lnote_client_ac_id = 0 )"
      ElseIf OnlyAircraft = True Then
        'This is sent on the prospect search, all other instances are false. This means the customer wants to return only prospects with an Aircraft attached.
        aSQL_String_Client_Where = aSQL_String_Client_Where & " (lnote_jetnet_ac_id <> 0 or lnote_client_ac_id <> 0 ) "
      End If

      If note_type = "A" Then
        If note_start_date <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & " (lnote_entry_date >= """ & note_start_date & """) "
        End If
        If note_end_date <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (lnote_entry_date <= """ & Format(DateAdd(DateInterval.Day, 1, CDate(note_end_date)), "yyyy-MM-dd") & """)"
        End If
      ElseIf note_type = "P" Then
        If note_start_date <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & " (lnote_schedule_start_date >= """ & note_start_date & """) "
        End If
        If note_end_date <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (lnote_schedule_end_date <= """ & note_end_date & """)"
        End If
      ElseIf note_type = "O" Or note_type = "B','O" Then
        If note_start_date <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & " (lnote_schedule_start_date >= """ & note_start_date & """) "
        End If
        If note_end_date <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (lnote_schedule_start_date <= """ & note_end_date & """)"
        End If
      End If

      If note_search <> "" And note_search <> "%" And note_search <> "%%" Then
        If aSQL_String_Client_Where <> "" Then
          AndQ = " and "
        Else
          AndQ = ""
        End If
        aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (lnote_note like '" & note_search & "')"
      End If

      If opp_status <> "" Then
        If aSQL_String_Client_Where <> "" Then
          AndQ = " and "
        Else
          AndQ = ""
        End If
        aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (lnote_opportunity_status in ('" & opp_status & "'))"
      End If

      If PriorityID <> "" Then
        If aSQL_String_Client_Where <> "" Then
          AndQ = " and "
        Else
          AndQ = ""
        End If
        aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (lnote_clipri_ID in (" & PriorityID.ToString & "))"
      End If
      Select Case FolderType
        Case 2
          FieldToPoll = "contact"
        Case 1
          FieldToPoll = "comp"
      End Select

      If ClientIDs <> "" Then
        AndQ = ""
        If aSQL_String_Client_Where <> "" Then
          AndQ = " and "
        End If
        aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ

        If JetnetIDs <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & "("
        End If

        aSQL_String_Client_Where = aSQL_String_Client_Where & " lnote_client_" & FieldToPoll & "_id in (" & ClientIDs & ")"
      End If


      If JetnetIDs <> "" Then
        AndQ = ""
        If aSQL_String_Client_Where <> "" And ClientIDs = "" Then
          AndQ = " and "
        ElseIf aSQL_String_Client_Select <> "" And ClientIDs <> "" Then
          AndQ = " or "
        End If
        aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " lnote_jetnet_" & FieldToPoll & "_id in (" & JetnetIDs & ")"
        If ClientIDs <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & ")"
        End If
      End If

      If note_type <> "" Then
        If aSQL_String_Client_Where <> "" Then
          AndQ = " and "
        Else
          AndQ = ""
        End If
        If note_type = "A" Then 'emails + notes returned
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (lnote_status in ('E','A'))"
        Else
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (lnote_status in ('" & note_type & "'))"
        End If

      End If

      If category <> 0 Then
        If aSQL_String_Client_Where <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & " AND local_notes.lnote_notecat_key = '" & category & "' "
        Else
          aSQL_String_Client_Where = " local_notes.lnote_notecat_key = '" & category & "' "
        End If
      End If

      If user <> "0" Then
        If aSQL_String_Client_Where <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & " AND local_notes.lnote_user_id = '" & user & "' "
        Else
          aSQL_String_Client_Where = " local_notes.lnote_user_id = '" & user & "' "
        End If
      End If


      If jetnet_amod_id <> "" Then
        If aSQL_String_Client_Where <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & "AND local_notes.lnote_jetnet_amod_id in(" & jetnet_amod_id & ") "
        Else
          aSQL_String_Client_Where = "local_notes.lnote_jetnet_amod_id in(" & jetnet_amod_id & ") "
        End If
      End If
      If client_amod_id <> "" Then
        If aSQL_String_Client_Where <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & "AND local_notes.lnote_client_amod_id in ( " & client_amod_id & ") "
        Else
          aSQL_String_Client_Where = "local_notes.lnote_client_amod_id in (" & client_amod_id & ") "
        End If
      End If


      If AircraftSearch Then
        Dim OperatorChosen As String = "LIKE"

        'Let's set up both the operator and the search text to add percentages if we need them.
        Select Case acSearchOperator
          Case 2 'Like is encapsulated with a percentage.
            OperatorChosen = "LIKE"
            acSearchText = "%" & acSearchText & "%"
          Case 3 'Equals means no percentage here.
            OperatorChosen = " = "
          Case Else 'Begins with/default value means a percentage trails.
            OperatorChosen = "LIKE"
            acSearchText = acSearchText & "%"
        End Select

        'Let's add an and if we need it

        If aSQL_String_Client_Where <> "" Then
          aSQL_String_Client_Where += " and "
        End If

        'We're going to go ahead and surround this with parentheses because that'll make it easier to read.
        aSQL_String_Client_Where += " ( ( "

        Select Case acSearchField
          Case 2
            aSQL_String_Client_Where += " cliaircraft_ser_nbr  " & OperatorChosen & " '" & acSearchText & "'"
          Case 3
            aSQL_String_Client_Where += " cliaircraft_reg_nbr  " & OperatorChosen & " '" & acSearchText & "' "
          Case 4
            aSQL_String_Client_Where += " cliaircraft_id " & OperatorChosen & " '" & acSearchText & "' "
          Case Else
            aSQL_String_Client_Where += " cliaircraft_ser_nbr " & OperatorChosen & " '" & acSearchText & "' or cliaircraft_reg_nbr " & OperatorChosen & " '" & acSearchText & "' "
        End Select

        aSQL_String_Client_Where += ") or (lnote_jetnet_ac_id <> 0 and lnote_client_ac_id = 0) "

        aSQL_String_Client_Where += " )"
      End If


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      Dim sQuery As String = aSQL_String_Client_Select & " WHERE " & aSQL_String_Client_Where

      If note_type = "P" Then
        sQuery = sQuery & " order by lnote_schedule_start_date desc "
      ElseIf note_type = "O" Then
        sQuery = sQuery & " order by lnote_schedule_start_date desc "
      Else
        sQuery = sQuery & " order by lnote_entry_date desc "
      End If
      MySqlCommand.CommandText = sQuery

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Notes_Search(ByVal note_search As String, ByVal note_start_date As String, ByVal note_end_date As String, ByVal note_type As String, ByVal category As String, ByVal jetnet_amod_id As String, ByVal client_amod_id As String, ByVal user As String, ByVal opp_status As String) As DataTable <em>Client Side</em></b><br />" & sQuery


      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      While MySqlReader.Read()
        Dim newCustomersRow As DataRow = atemptable.NewRow()

        newCustomersRow.Item("lnote_id") = MySqlReader.Item("lnote_id")
        newCustomersRow.Item("lnote_jetnet_comp_id") = MySqlReader.Item("lnote_jetnet_comp_id")
        newCustomersRow.Item("lnote_jetnet_ac_id") = MySqlReader.Item("lnote_jetnet_ac_id")
        newCustomersRow.Item("lnote_jetnet_contact_id") = MySqlReader.Item("lnote_jetnet_contact_id")
        newCustomersRow.Item("lnote_client_comp_id") = MySqlReader.Item("lnote_client_comp_id")
        newCustomersRow.Item("lnote_client_ac_id") = MySqlReader.Item("lnote_client_ac_id")
        newCustomersRow.Item("lnote_client_contact_id") = MySqlReader.Item("lnote_client_contact_id")
        newCustomersRow.Item("lnote_note") = MySqlReader.Item("lnote_note")
        newCustomersRow.Item("lnote_entry_date") = MySqlReader.Item("lnote_entry_date")
        newCustomersRow.Item("lnote_action_date") = MySqlReader.Item("lnote_action_date")
        newCustomersRow.Item("lnote_user_login") = MySqlReader.Item("lnote_user_login")
        newCustomersRow.Item("lnote_user_name") = MySqlReader.Item("lnote_user_name")
        newCustomersRow.Item("lnote_notecat_key") = MySqlReader.Item("lnote_notecat_key")
        newCustomersRow.Item("lnote_schedule_start_date") = MySqlReader.Item("lnote_schedule_start_date")
        newCustomersRow.Item("lnote_schedule_end_date") = MySqlReader.Item("lnote_schedule_end_date")
        newCustomersRow.Item("lnote_user_id") = MySqlReader.Item("lnote_user_id")
        newCustomersRow.Item("lnote_status") = MySqlReader.Item("lnote_status")
        newCustomersRow.Item("lnote_clipri_ID") = MySqlReader.Item("lnote_clipri_ID")
        newCustomersRow.Item("clipri_name") = MySqlReader.Item("clipri_name")
        newCustomersRow.Item("clipri_sort_order") = MySqlReader.Item("clipri_sort_order")
        newCustomersRow.Item("lnote_document_flag") = MySqlReader.Item("lnote_document_flag")
        newCustomersRow.Item("lnote_jetnet_amod_id") = MySqlReader.Item("lnote_jetnet_amod_id")
        newCustomersRow.Item("lnote_client_amod_id") = MySqlReader.Item("lnote_client_amod_id")
        newCustomersRow.Item("lnote_document_name") = MySqlReader.Item("lnote_document_name")
        newCustomersRow.Item("lnote_opportunity_status") = MySqlReader.Item("lnote_opportunity_status")
        newCustomersRow.Item("lnote_cash_value") = MySqlReader.Item("lnote_cash_value")
        newCustomersRow.Item("lnote_capture_percentage") = MySqlReader.Item("lnote_capture_percentage")

        atemptable.Rows.Add(newCustomersRow)
        atemptable.AcceptChanges()

      End While



      'if this is a serial #/registration search, we aren't technically finished yet. We need to go ahead and 
      'look at the jetnet only aircraft attached to notes and search them too.
      If AircraftSearch Then
        SearchJetnetSideForACIDPlusNotesACSearch(atemptable, acSearchOperator, acSearchText, acSearchField)
      End If
      Notes_Search = atemptable


      atemptable = Nothing

    Catch ex As Exception
      Notes_Search = Nothing
      Me.class_error = "Error in Notes_Search(): " & ex.Message
    Finally
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing

    End Try
  End Function

  'Notes - what search they are. This one is a lot more difficult.
  'Return: 
  '       DataTable
  ' Change Log
  '           12/23/2011    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ''' <summary>
  ''' Notes Search for Mobile and Regular Version
  ''' </summary>
  ''' <param name="note_search">Notes Search Text</param>
  ''' <param name="note_start_date">Notes Start Date - Careful depending on status - the field that this uses changes
  ''' entry date/schedule start date, etc</param>
  ''' <param name="note_end_date">Notes End Date - read start date careful above</param>
  ''' <param name="note_type">Status type = A, E, D? etc</param>
  ''' <param name="category">Note Category</param>
  ''' <param name="jetnet_amod_id">List of Model IDs for Notes - Jetnet Model IDs</param>
  ''' <param name="client_amod_id">List of Model IDs for Notes - Client Model IDs</param>
  ''' <param name="user">User who created the note</param>
  ''' <returns>Datatable</returns> 
  ''' <remarks>Once again, datahooks aren't very scaleable, so they weren't used here. </remarks>
  Public Function Notes_Search_For_Prospect_View(ByVal note_search As String, ByVal note_start_date As String, ByVal note_end_date As String, ByVal note_type As String, ByVal category As String, ByVal jetnet_amod_id As String, ByVal client_amod_id As String, ByVal user As String, ByVal opp_status As String, ByVal ClientIDs As String, ByVal JetnetIDs As String, ByVal acSearchField As Integer, ByVal acSearchOperator As Integer, ByVal acSearchText As String, ByVal OnlyModel As Boolean, ByVal OnlyAircraft As Boolean, Optional ByVal FolderType As Long = 3, Optional ByVal PriorityID As String = "") As DataTable
    Dim FieldToPoll As String = "ac"
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing

    Try
      ' create the Select Strings
      Dim aSQL_String_Client_Select As String = ""
      Dim aSQL_String_JETNET_Select As String = ""
      ' create the Where string
      Dim aSQL_String_Client_Where As String = ""
      Dim aSQL_String_JETNET_Where As String = ""
      ' create a data table to hold the company info
      Dim dalTable As New DataTable
      Dim atemptable As New DataTable
      Dim atemptable2 As New DataTable
      Dim dataSet As DataSet = New DataSet("dataSet")
      dataSet.Tables.Add(atemptable)
      dataSet.EnforceConstraints = False
      Dim AircraftSearch As Boolean = False


      If Not String.IsNullOrEmpty(Trim(acSearchText)) Then
        'If the aircraft search field isn't empty.
        'We need to go ahead and add that this is an aircraft search.
        AircraftSearch = True
      End If

      '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
      '----------------------------------------------------------- check to see if we are getting client data---------------------------------------------------
      '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

      '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
      ' ---------------------------------------------------------Setup the Client SQL Strings---------------------------------------------------------------
      '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

      'These are the basic fields needed for the company export. 


      aSQL_String_Client_Select = "SELECT local_notes.lnote_id, local_notes.lnote_jetnet_ac_id, local_notes.lnote_jetnet_comp_id, lnote_opportunity_status, lnote_cash_value, lnote_capture_percentage, "
      aSQL_String_Client_Select = aSQL_String_Client_Select & "local_notes.lnote_client_ac_id, local_notes.lnote_client_comp_id, "
      aSQL_String_Client_Select = aSQL_String_Client_Select & "local_notes.lnote_jetnet_contact_id, local_notes.lnote_client_contact_id, left(local_notes.lnote_note,21000)"
      aSQL_String_Client_Select = aSQL_String_Client_Select & "as lnote_note, local_notes.lnote_entry_date, local_notes.lnote_action_date, "
      aSQL_String_Client_Select = aSQL_String_Client_Select & "local_notes.lnote_user_login, local_notes.lnote_user_name, local_notes.lnote_notecat_key, local_notes.lnote_status, "
      aSQL_String_Client_Select = aSQL_String_Client_Select & "local_notes.lnote_schedule_start_date, "
      aSQL_String_Client_Select = aSQL_String_Client_Select & "local_notes.lnote_schedule_end_date, local_notes.lnote_user_id, local_notes.lnote_clipri_ID, client_priority.clipri_name, "
      aSQL_String_Client_Select = aSQL_String_Client_Select & "client_priority.clipri_sort_order, cliuser_first_name, cliuser_last_name, oppcat, "
      aSQL_String_Client_Select = aSQL_String_Client_Select & " clicomp_name as comp_name, clicomp_address1 as comp_address1, clicomp_address2 as comp_address2, clicomp_city as comp_city ,"
      aSQL_String_Client_Select = aSQL_String_Client_Select & " clicomp_state as comp_state, clicomp_country as comp_country, clicomp_zip_code as comp_zip_code, clicomp_id as comp_id, clicomp_description as comp_description, "
      aSQL_String_Client_Select = aSQL_String_Client_Select & " clicomp_email_address as comp_email_address, '' as comp_phone_office, '' as comp_phone_fax , "

      aSQL_String_Client_Select = aSQL_String_Client_Select & " cliamod_model_name as amod_model_name, cliamod_make_name as amod_make_name, cliaircraft_ser_nbr as ac_ser_nbr, cliaircraft_reg_nbr as ac_reg_nbr,"
      aSQL_String_Client_Select = aSQL_String_Client_Select & " cliaircraft_year_mfr as ac_year_mfr, cliaircraft_id as ac_id, cliaircraft_date_purchased as ac_date_purchased, cliaircraft_forsale_flag as ac_forsale_flag, "
      aSQL_String_Client_Select = aSQL_String_Client_Select & " cliaircraft_status as ac_status, cliaircraft_delivery as ac_delivery, cliaircraft_asking_wordage as ac_asking_wordage, cliaircraft_asking_price as ac_asking_price, "
      aSQL_String_Client_Select = aSQL_String_Client_Select & " cliaircraft_est_price as ac_est_price, cliaircraft_date_listed as ac_date_listed, cliaircraft_exclusive_flag as ac_exclusive_flag, cliaircraft_lease_flag as ac_lease_flag, "


      aSQL_String_Client_Select = aSQL_String_Client_Select & "local_notes.lnote_document_flag, local_notes.lnote_jetnet_amod_id, local_notes.lnote_client_amod_id,lnote_status, "
      aSQL_String_Client_Select = aSQL_String_Client_Select & "local_notes.lnote_document_name "
      aSQL_String_Client_Select = aSQL_String_Client_Select & "FROM  local_notes INNER JOIN "
      aSQL_String_Client_Select = aSQL_String_Client_Select & "client_priority ON local_notes.lnote_clipri_ID = client_priority.clipri_ID"
      aSQL_String_Client_Select = aSQL_String_Client_Select & " left outer join client_company on local_notes.lnote_client_comp_id = clicomp_id"
      aSQL_String_Client_Select = aSQL_String_Client_Select & " left outer join client_aircraft on local_notes.lnote_client_ac_id = cliaircraft_id"
      aSQL_String_Client_Select = aSQL_String_Client_Select & " left outer join client_aircraft_model on client_aircraft.cliaircraft_cliamod_id = cliamod_id "
      aSQL_String_Client_Select = aSQL_String_Client_Select & " left outer join client_user on local_notes.lnote_user_id = cliuser_id "
      aSQL_String_Client_Select = aSQL_String_Client_Select & " left outer join opportunity_category on local_notes.lnote_notecat_key = oppcat_key "

      'This means that this is an aircraft search
      If AircraftSearch Then
        'So we need to go ahead and add an inner join.
        aSQL_String_Client_Select = aSQL_String_Client_Select & " left outer join client_aircraft on local_notes.lnote_client_ac_id = cliaircraft_id "
      End If

      atemptable.Columns.Add("lnote_id")
      atemptable.Columns.Add("lnote_opportunity_status")
      atemptable.Columns.Add("lnote_cash_value")
      atemptable.Columns.Add("lnote_capture_percentage")
      atemptable.Columns.Add("lnote_jetnet_comp_id")
      atemptable.Columns.Add("lnote_jetnet_ac_id")
      atemptable.Columns.Add("lnote_jetnet_contact_id")
      atemptable.Columns.Add("lnote_client_comp_id")
      atemptable.Columns.Add("lnote_client_ac_id")
      atemptable.Columns.Add("lnote_client_contact_id")
      atemptable.Columns.Add("lnote_note")
      atemptable.Columns.Add("lnote_entry_date")
      atemptable.Columns.Add("lnote_action_date")
      atemptable.Columns.Add("lnote_user_login")
      atemptable.Columns.Add("lnote_user_name")
      atemptable.Columns.Add("lnote_notecat_key")
      atemptable.Columns.Add("lnote_schedule_start_date")
      atemptable.Columns.Add("lnote_schedule_end_date")
      atemptable.Columns.Add("lnote_user_id")
      atemptable.Columns.Add("lnote_clipri_ID")
      atemptable.Columns.Add("lnote_status")
      atemptable.Columns.Add("clipri_name")
      atemptable.Columns.Add("clipri_sort_order")
      atemptable.Columns.Add("lnote_document_flag")
      atemptable.Columns.Add("lnote_jetnet_amod_id")
      atemptable.Columns.Add("lnote_client_amod_id")
      atemptable.Columns.Add("lnote_document_name")

      atemptable.Columns.Add("cliuser_first_name")
      atemptable.Columns.Add("cliuser_last_name")
      atemptable.Columns.Add("oppcat")

      'Company Tables.
      atemptable.Columns.Add("comp_name")
      atemptable.Columns.Add("comp_address1")
      atemptable.Columns.Add("comp_address2")
      atemptable.Columns.Add("comp_city")
      atemptable.Columns.Add("comp_state")
      atemptable.Columns.Add("comp_country")
      atemptable.Columns.Add("comp_zip_code")
      atemptable.Columns.Add("comp_id")
      atemptable.Columns.Add("comp_description")
      atemptable.Columns.Add("comp_email_address")
      atemptable.Columns.Add("comp_source")
      atemptable.Columns.Add("comp_phone_office")
      atemptable.Columns.Add("comp_phone_fax")

      'Aircraft
      atemptable.Columns.Add("amod_model_name")
      atemptable.Columns.Add("amod_make_name")
      atemptable.Columns.Add("ac_ser_nbr")
      atemptable.Columns.Add("ac_reg_nbr")
      atemptable.Columns.Add("ac_year_mfr")
      atemptable.Columns.Add("ac_id")
      atemptable.Columns.Add("ac_source")
      atemptable.Columns.Add("ac_date_purchased")
      atemptable.Columns.Add("ac_forsale_flag")
      atemptable.Columns.Add("ac_status")
      atemptable.Columns.Add("ac_delivery")
      atemptable.Columns.Add("ac_asking_wordage")
      atemptable.Columns.Add("ac_asking_price")
      atemptable.Columns.Add("ac_est_price")
      atemptable.Columns.Add("ac_date_listed")
      atemptable.Columns.Add("ac_exclusive_flag")
      atemptable.Columns.Add("ac_lease_flag")


      Dim AndQ As String = ""
      'The Building of the Where Clause 

      If OnlyModel = True Then
        'This is sent on the propsect search, all others are false. This is sent whenever the customer wants to return only prospects with a model attached.
        aSQL_String_Client_Where = aSQL_String_Client_Where & " (lnote_jetnet_amod_id <> 0 or lnote_client_amod_id <> 0 ) " ' and (lnote_jetnet_ac_id = 0 and lnote_client_ac_id = 0 )"
      ElseIf OnlyAircraft = True Then
        'This is sent on the prospect search, all other instances are false. This means the customer wants to return only prospects with an Aircraft attached.
        aSQL_String_Client_Where = aSQL_String_Client_Where & " (lnote_jetnet_ac_id <> 0 or lnote_client_ac_id <> 0 ) "
      End If

      If note_type = "A" Then
        If note_start_date <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & " (lnote_entry_date >= """ & note_start_date & """) "
        End If
        If note_end_date <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (lnote_entry_date <= """ & Format(DateAdd(DateInterval.Day, 1, CDate(note_end_date)), "yyyy-MM-dd") & """)"
        End If
      ElseIf note_type = "P" Then
        If note_start_date <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & " (lnote_schedule_start_date >= """ & note_start_date & """) "
        End If
        If note_end_date <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (lnote_schedule_end_date <= """ & note_end_date & """)"
        End If
      ElseIf note_type = "O" Or note_type = "B','O" Then
        If note_start_date <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & " (lnote_schedule_start_date >= """ & note_start_date & """) "
        End If
        If note_end_date <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (lnote_schedule_start_date <= """ & note_end_date & """)"
        End If
      End If

      If note_search <> "" And note_search <> "%" And note_search <> "%%" Then
        If aSQL_String_Client_Where <> "" Then
          AndQ = " and "
        Else
          AndQ = ""
        End If
        aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (lnote_note like '" & note_search & "')"
      End If

      If opp_status <> "" Then
        If aSQL_String_Client_Where <> "" Then
          AndQ = " and "
        Else
          AndQ = ""
        End If
        aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (lnote_opportunity_status in ('" & opp_status & "'))"
      End If

      If PriorityID <> "" Then
        If aSQL_String_Client_Where <> "" Then
          AndQ = " and "
        Else
          AndQ = ""
        End If
        aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (lnote_clipri_ID in (" & PriorityID.ToString & "))"
      End If
      Select Case FolderType
        Case 2
          FieldToPoll = "contact"
        Case 1
          FieldToPoll = "comp"
      End Select

      If ClientIDs <> "" Then
        AndQ = ""
        If aSQL_String_Client_Where <> "" Then
          AndQ = " and "
        End If
        aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ

        If JetnetIDs <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & "("
        End If

        aSQL_String_Client_Where = aSQL_String_Client_Where & " lnote_client_" & FieldToPoll & "_id in (" & ClientIDs & ")"
      End If


      If JetnetIDs <> "" Then
        AndQ = ""
        If aSQL_String_Client_Where <> "" And ClientIDs = "" Then
          AndQ = " and "
        ElseIf aSQL_String_Client_Select <> "" And ClientIDs <> "" Then
          AndQ = " or "
        End If
        aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " lnote_jetnet_" & FieldToPoll & "_id in (" & JetnetIDs & ")"
        If ClientIDs <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & ")"
        End If
      End If

      If note_type <> "" Then
        If aSQL_String_Client_Where <> "" Then
          AndQ = " and "
        Else
          AndQ = ""
        End If
        If note_type = "A" Then 'emails + notes returned
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (lnote_status in ('E','A'))"
        Else
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (lnote_status in ('" & note_type & "'))"
        End If

      End If

      If category <> 0 Then
        If aSQL_String_Client_Where <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & " AND local_notes.lnote_notecat_key = '" & category & "' "
        Else
          aSQL_String_Client_Where = " local_notes.lnote_notecat_key = '" & category & "' "
        End If
      End If

      If user <> "0" Then
        If aSQL_String_Client_Where <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & " AND local_notes.lnote_user_id = '" & user & "' "
        Else
          aSQL_String_Client_Where = " local_notes.lnote_user_id = '" & user & "' "
        End If
      End If


      If jetnet_amod_id <> "" Then
        If aSQL_String_Client_Where <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & "AND local_notes.lnote_jetnet_amod_id in(" & jetnet_amod_id & ") "
        Else
          aSQL_String_Client_Where = "local_notes.lnote_jetnet_amod_id in(" & jetnet_amod_id & ") "
        End If
      End If
      If client_amod_id <> "" Then
        If aSQL_String_Client_Where <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & "AND local_notes.lnote_client_amod_id in ( " & client_amod_id & ") "
        Else
          aSQL_String_Client_Where = "local_notes.lnote_client_amod_id in (" & client_amod_id & ") "
        End If
      End If


      If AircraftSearch Then
        Dim OperatorChosen As String = "LIKE"

        'Let's set up both the operator and the search text to add percentages if we need them.
        Select Case acSearchOperator
          Case 2 'Like is encapsulated with a percentage.
            OperatorChosen = "LIKE"
            acSearchText = "%" & acSearchText & "%"
          Case 3 'Equals means no percentage here.
            OperatorChosen = " = "
          Case Else 'Begins with/default value means a percentage trails.
            OperatorChosen = "LIKE"
            acSearchText = acSearchText & "%"
        End Select

        'Let's add an and if we need it

        If aSQL_String_Client_Where <> "" Then
          aSQL_String_Client_Where += " and "
        End If

        'We're going to go ahead and surround this with parentheses because that'll make it easier to read.
        aSQL_String_Client_Where += " ( ( "

        Select Case acSearchField
          Case 2
            aSQL_String_Client_Where += " cliaircraft_ser_nbr  " & OperatorChosen & " '" & acSearchText & "'"
          Case 3
            aSQL_String_Client_Where += " cliaircraft_reg_nbr  " & OperatorChosen & " '" & acSearchText & "' "
          Case 4
            aSQL_String_Client_Where += " cliaircraft_id " & OperatorChosen & " '" & acSearchText & "' "
          Case Else
            aSQL_String_Client_Where += " cliaircraft_ser_nbr " & OperatorChosen & " '" & acSearchText & "' or cliaircraft_reg_nbr " & OperatorChosen & " '" & acSearchText & "' "
        End Select

        aSQL_String_Client_Where += ") or (lnote_jetnet_ac_id <> 0 and lnote_client_ac_id = 0) "

        aSQL_String_Client_Where += " )"
      End If


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      Dim sQuery As String = aSQL_String_Client_Select & " WHERE " & aSQL_String_Client_Where

      If note_type = "P" Then
        sQuery = sQuery & " order by lnote_schedule_start_date desc "
      ElseIf note_type = "O" Then
        sQuery = sQuery & " order by lnote_schedule_start_date desc "
      Else
        sQuery = sQuery & " order by lnote_entry_date desc "
      End If
      MySqlCommand.CommandText = sQuery

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Notes_Search(ByVal note_search As String, ByVal note_start_date As String, ByVal note_end_date As String, ByVal note_type As String, ByVal category As String, ByVal jetnet_amod_id As String, ByVal client_amod_id As String, ByVal user As String, ByVal opp_status As String) As DataTable <em>Client Side</em></b><br />" & sQuery


      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      While MySqlReader.Read()
        Dim newCustomersRow As DataRow = atemptable.NewRow()

        newCustomersRow.Item("lnote_id") = MySqlReader.Item("lnote_id")
        newCustomersRow.Item("lnote_jetnet_comp_id") = MySqlReader.Item("lnote_jetnet_comp_id")
        newCustomersRow.Item("lnote_jetnet_ac_id") = MySqlReader.Item("lnote_jetnet_ac_id")
        newCustomersRow.Item("lnote_jetnet_contact_id") = MySqlReader.Item("lnote_jetnet_contact_id")
        newCustomersRow.Item("lnote_client_comp_id") = MySqlReader.Item("lnote_client_comp_id")
        newCustomersRow.Item("lnote_client_ac_id") = MySqlReader.Item("lnote_client_ac_id")
        newCustomersRow.Item("lnote_client_contact_id") = MySqlReader.Item("lnote_client_contact_id")
        newCustomersRow.Item("lnote_note") = MySqlReader.Item("lnote_note")
        newCustomersRow.Item("lnote_entry_date") = MySqlReader.Item("lnote_entry_date")
        newCustomersRow.Item("lnote_action_date") = MySqlReader.Item("lnote_action_date")
        newCustomersRow.Item("lnote_user_login") = MySqlReader.Item("lnote_user_login")
        newCustomersRow.Item("lnote_user_name") = MySqlReader.Item("lnote_user_name")
        newCustomersRow.Item("lnote_notecat_key") = MySqlReader.Item("lnote_notecat_key")
        newCustomersRow.Item("lnote_schedule_start_date") = MySqlReader.Item("lnote_schedule_start_date")
        newCustomersRow.Item("lnote_schedule_end_date") = MySqlReader.Item("lnote_schedule_end_date")
        newCustomersRow.Item("lnote_user_id") = MySqlReader.Item("lnote_user_id")
        newCustomersRow.Item("lnote_status") = MySqlReader.Item("lnote_status")
        newCustomersRow.Item("lnote_clipri_ID") = MySqlReader.Item("lnote_clipri_ID")
        newCustomersRow.Item("clipri_name") = MySqlReader.Item("clipri_name")
        newCustomersRow.Item("clipri_sort_order") = MySqlReader.Item("clipri_sort_order")
        newCustomersRow.Item("lnote_document_flag") = MySqlReader.Item("lnote_document_flag")
        newCustomersRow.Item("lnote_jetnet_amod_id") = MySqlReader.Item("lnote_jetnet_amod_id")
        newCustomersRow.Item("lnote_client_amod_id") = MySqlReader.Item("lnote_client_amod_id")
        newCustomersRow.Item("lnote_document_name") = MySqlReader.Item("lnote_document_name")
        newCustomersRow.Item("lnote_opportunity_status") = MySqlReader.Item("lnote_opportunity_status")
        newCustomersRow.Item("lnote_cash_value") = MySqlReader.Item("lnote_cash_value")
        newCustomersRow.Item("lnote_capture_percentage") = MySqlReader.Item("lnote_capture_percentage")

        newCustomersRow.Item("cliuser_first_name") = MySqlReader.Item("cliuser_first_name")
        newCustomersRow.Item("cliuser_last_name") = MySqlReader.Item("cliuser_last_name")
        newCustomersRow.Item("oppcat") = MySqlReader.Item("oppcat")


        newCustomersRow.Item("comp_name") = MySqlReader.Item("comp_name")
        newCustomersRow.Item("comp_address1") = MySqlReader.Item("comp_address1")
        newCustomersRow.Item("comp_address2") = MySqlReader.Item("comp_address2")
        newCustomersRow.Item("comp_city") = MySqlReader.Item("comp_city")
        newCustomersRow.Item("comp_state") = MySqlReader.Item("comp_state")
        newCustomersRow.Item("comp_country") = MySqlReader.Item("comp_country")
        newCustomersRow.Item("comp_zip_code") = MySqlReader.Item("comp_zip_code")
        newCustomersRow.Item("comp_id") = MySqlReader.Item("comp_id")
        newCustomersRow.Item("comp_description") = MySqlReader.Item("comp_description")
        newCustomersRow.Item("comp_email_address") = MySqlReader.Item("comp_email_address")
        newCustomersRow.Item("comp_phone_office") = MySqlReader.Item("comp_phone_office")
        newCustomersRow.Item("comp_phone_fax") = MySqlReader.Item("comp_phone_fax")
        newCustomersRow.Item("amod_model_name") = MySqlReader.Item("amod_model_name")
        newCustomersRow.Item("amod_make_name") = MySqlReader.Item("amod_make_name")
        newCustomersRow.Item("ac_ser_nbr") = MySqlReader.Item("ac_ser_nbr")
        newCustomersRow.Item("ac_reg_nbr") = MySqlReader.Item("ac_reg_nbr")
        newCustomersRow.Item("ac_year_mfr") = MySqlReader.Item("ac_year_mfr")
        newCustomersRow.Item("ac_id") = MySqlReader.Item("ac_id")
        newCustomersRow.Item("ac_date_purchased") = MySqlReader.Item("ac_date_purchased")
        newCustomersRow.Item("ac_forsale_flag") = MySqlReader.Item("ac_forsale_flag")
        newCustomersRow.Item("ac_status") = MySqlReader.Item("ac_status")
        newCustomersRow.Item("ac_delivery") = MySqlReader.Item("ac_delivery")
        newCustomersRow.Item("ac_asking_wordage") = MySqlReader.Item("ac_asking_wordage")
        newCustomersRow.Item("ac_asking_price") = MySqlReader.Item("ac_asking_price")
        newCustomersRow.Item("ac_est_price") = MySqlReader.Item("ac_est_price")
        newCustomersRow.Item("ac_date_listed") = MySqlReader.Item("ac_date_listed")
        newCustomersRow.Item("ac_exclusive_flag") = MySqlReader.Item("ac_exclusive_flag")
        newCustomersRow.Item("ac_lease_flag") = MySqlReader.Item("ac_lease_flag")


        atemptable.Rows.Add(newCustomersRow)
        atemptable.AcceptChanges()

      End While



      'if this is a serial #/registration search, we aren't technically finished yet. We need to go ahead and 
      'look at the jetnet only aircraft attached to notes and search them too.
      If AircraftSearch Then
        SearchJetnetSideForACIDPlusNotesACSearch(atemptable, acSearchOperator, acSearchText, acSearchField)
      End If
      Notes_Search_For_Prospect_View = atemptable


      atemptable = Nothing

    Catch ex As Exception
      Notes_Search_For_Prospect_View = Nothing
      Me.class_error = "Error in Notes_Search(): " & ex.Message
    Finally
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing

    End Try
  End Function
  Public Function Get_User_List_Homebase(ByVal selected_user_id As String, Optional ByVal from_spot As String = "") As DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim aTempTable As New DataTable
    Dim AndQ As String = ""
    Dim where_clause As String = ""

    Try

      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()

      If Trim(selected_user_id) <> "" Then
        where_clause = " and user_id = '" & Trim(selected_user_id) & "' "
      End If

      If Trim(from_spot) = "Prospects_Listing" Then
        where_clause &= "  And exists(SELECT top 1 cprospect_user_id  from [Homebase].jetnet_ra.dbo.company_prospect with (NOLOCK) where company_prospect.cprospect_user_id = user_id )  "
      End If


      If HttpContext.Current.Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.HOMEBASE = True Then
        sql = " SELECT * from [User] where user_email_address <> '' and user_password <> 'inactive' " & where_clause & "  order by user_first_name asc, user_last_name asc  "
      ElseIf HttpContext.Current.Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CUSTOMER_CENTER = True Then
        sql = " SELECT * from [Homebase].jetnet_ra.dbo.[User]  where user_email_address <> '' and user_password <> 'inactive'  " & where_clause & " order by user_first_name asc, user_last_name asc  "
      Else
        sql = " SELECT * from [Homebase].jetnet_ra.dbo.[User]  where user_email_address <> '' and user_password <> 'inactive'  " & where_clause & " order by user_first_name asc, user_last_name asc  "
      End If




      Dim SqlCommand As New SqlClient.SqlCommand(sql, SqlConn)

      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      SqlCommand.Dispose()
      SqlCommand = Nothing

      Return aTempTable
    Catch ex As Exception
      Get_User_List_Homebase = Nothing
      Me.class_error = "Error in Get_User_List_Homebase(ByVal comp_id As Long, ByVal journalID As Long) As DataTable" & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing
    End Try

  End Function
  Public Function Notes_Search_For_Prospect_View_Homebase(ByVal note_search As String, ByVal note_start_date As String, ByVal note_end_date As String, ByVal note_type As String, ByVal service_drop As String, ByVal jetnet_amod_id As String, ByVal client_amod_id As String, ByVal user As String, ByVal opp_status As String, ByVal ClientIDs As String, ByVal JetnetIDs As String, ByVal acSearchField As Integer, ByVal acSearchOperator As Integer, ByVal acSearchText As String, ByVal OnlyModel As Boolean, ByVal OnlyAircraft As Boolean, Optional ByVal active_closed_inactive As String = "", Optional ByVal Type_Drop As String = "", Optional ByVal prospect_id As Long = 0, Optional ByVal comp_id As Long = 0, Optional ByVal Contact_Id As Long = 0, Optional ByVal crmSource_prospect As String = "", Optional ByVal crmReferrel As String = "") As DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim aTempTable As New DataTable
    Dim sqlWhere As String = ""

    Try

      Dim sqlQuery As String = ""
      sqlQuery = "Select comp_id, comp_name, comp_address1, comp_city, comp_state, comp_country, comp_zip_code, cbus_name, "
      sqlQuery = sqlQuery & " cprospect_service, cprospect_type, cprospect_details, cprospect_id,  "
      sqlQuery = sqlQuery & "  cprospect_target_date, LEFT(cprospect_next_action_date,12) as cprospect_next_action_date, substring(cprospect_next_action_date,13,200) as cprospect_next_action, "
      sqlQuery = sqlQuery & " cprospect_value, cprospect_percent_win, cprospect_user_id, cprospect_status, cprospect_contact_id, cprospect_start_date "
      sqlQuery = sqlQuery & " , JETNET, LEFT(LASTNOTE,12) as LASTNOTE,  substring(LASTNOTE,13,200) as LASTNOTE_TEXT   "
      sqlQuery = sqlQuery & " , cpsource_id,cprospect_referrer_user_id, cpsource_name, referrer "

      If HttpContext.Current.Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.HOMEBASE = True Then
        sqlQuery = sqlQuery & " From View_Company_Prospects with (NOLOCK) "
        sqlQuery = sqlQuery & "  inner Join Company_Prospect_Type with (NOLOCK) on cprospect_type = cprostype_name "
      ElseIf HttpContext.Current.Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CUSTOMER_CENTER = True Then
        sqlQuery = sqlQuery & " From [Homebase].jetnet_ra.dbo.View_Company_Prospects with (NOLOCK) "
        sqlQuery = sqlQuery & " inner Join [Homebase].jetnet_ra.dbo.Company_Prospect_Type with (NOLOCK) on cprospect_type = cprostype_name "
      Else
        sqlQuery = sqlQuery & " From View_Company_Prospects with (NOLOCK) "
        sqlQuery = sqlQuery & " inner Join Company_Prospect_Type with (NOLOCK) on cprospect_type = cprostype_name "
      End If


      If HttpContext.Current.Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.HOMEBASE = True Then

      ElseIf HttpContext.Current.Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CUSTOMER_CENTER = True Then

      Else

      End If

      '  sqlQuery = sqlQuery & " inner Join company on comp_id = cprospect_comp_id And comp_journ_id = 0 "
      '  sqlQuery = sqlQuery & " Left outer join Company_Business_Type with (NOLOCK) on cbus_type=comp_business_type "

      sqlQuery = sqlQuery & " where "


      If prospect_id > 0 Then
        sqlWhere = " cprospect_id = " & prospect_id & "  "
      End If


      If Trim(note_start_date) <> "" Then
        If sqlWhere <> "" Then
          sqlWhere += " AND cprospect_target_date  >=   '" & note_start_date & "' "
        Else
          sqlWhere += " cprospect_target_date >=  '" & note_start_date & "' "
        End If
      End If

      If Trim(note_end_date) <> "" Then
        If sqlWhere <> "" Then
          sqlWhere += " AND cprospect_target_date  <=  '" & note_end_date & "' "
        Else
          sqlWhere += " cprospect_target_date <=  '" & note_end_date & "' "
        End If
      End If

      If Contact_Id > 0 Then
        If sqlWhere <> "" Then
          sqlWhere += " AND cprospect_contact_id = " & Contact_Id.ToString & " "
        Else
          sqlWhere += " cprospect_contact_id = " & Contact_Id.ToString & " "
        End If
      End If

      If service_drop <> "0" Then
        If sqlWhere <> "" Then
          sqlWhere += " AND cprospect_service = '" & service_drop & "' "
        Else
          sqlWhere += " cprospect_service = '" & service_drop & "' "
        End If
      End If

      If user <> "0" And Trim(user) <> "" Then
        If sqlWhere <> "" Then
          sqlWhere += " AND cprospect_user_id = '" & user & "' "
        Else
          sqlWhere += " cprospect_user_id = '" & user & "' "
        End If
      End If


      If note_search <> "" And note_search <> "%" And note_search <> "%%" Then
        If sqlWhere <> "" Then
          sqlWhere += " and (cprospect_details like '" & note_search & "')"
        Else
          sqlWhere += " (cprospect_details like '" & note_search & "')"
        End If

      End If

      If Trim(Type_Drop) <> "" Then
        If sqlWhere <> "" Then
          sqlWhere += " AND cprospect_type in (" & Trim(Type_Drop) & ") "
        Else
          sqlWhere += " cprospect_type = (" & Trim(Type_Drop) & ") "
        End If
      ElseIf prospect_id = 0 And comp_id = 0 Then
        If sqlWhere <> "" Then
          sqlWhere += " AND cprospect_type not in ('Nurture') "
        Else
          sqlWhere += " cprospect_type not in ('Nurture') "
        End If
      End If


      If Trim(crmSource_prospect) <> "" And Trim(crmSource_prospect) <> "'0'" Then
        If sqlWhere <> "" Then
          sqlWhere += " AND cpsource_id  in (" & Trim(crmSource_prospect) & ") "
        Else
          sqlWhere += " cpsource_id  = (" & Trim(crmSource_prospect) & ") "
        End If
      End If


      If Trim(crmReferrel) <> "" And Trim(crmReferrel) <> "'0'" Then
        If sqlWhere <> "" Then
          sqlWhere += " AND cprospect_referrer_user_id  in (" & Trim(crmReferrel) & ") "
        Else
          sqlWhere += " cprospect_referrer_user_id  = (" & Trim(crmReferrel) & ") "
        End If
      End If


      If Trim(active_closed_inactive) <> "" Then
        If sqlWhere <> "" Then
          sqlWhere += " AND cprospect_status in (" & Trim(active_closed_inactive) & ") "
        Else
                    sqlWhere += " cprospect_status in (" & Trim(active_closed_inactive) & ") "
                End If
      End If

      If comp_id > 0 Then
        If sqlWhere <> "" Then
          sqlWhere += " AND comp_id =  " & comp_id & "  "
        Else
          sqlWhere += " comp_id =  " & comp_id & "  "
        End If
      End If


      If comp_id > 0 Then
        If sqlWhere <> "" Then
          sqlWhere += " AND cprospect_type <> 'Do Not Market' "
        Else
          sqlWhere += " cprospect_type <> 'Do Not Market' "
        End If
      End If

      sqlWhere += " order by cprostype_sort "


      sqlQuery = sqlQuery & sqlWhere
      'save to session query debug string.

      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sqlQuery.ToString)
      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()

      Dim SqlCommand As New SqlClient.SqlCommand(sqlQuery, SqlConn)

      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      SqlCommand.Dispose()
      SqlCommand = Nothing

      Return aTempTable
    Catch ex As Exception
      Notes_Search_For_Prospect_View_Homebase = Nothing
      Me.class_error = "Error in Notes_Search_For_Prospect_View_Homebase(ByVal comp_id As Long, ByVal journalID As Long) As DataTable" & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing



    End Try

  End Function
  Public Sub Remove_Prospect_View_Homebase(ByVal cprospect_id As Long)

    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try
      Dim sqlQuery As String = ""

      If HttpContext.Current.Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.HOMEBASE = True Then
        sqlQuery = "Delete from Company_Prospect where cprospect_id =  " & cprospect_id
      ElseIf HttpContext.Current.Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CUSTOMER_CENTER = True Then
        sqlQuery = "  Delete from [Homebase].jetnet_ra.dbo.Company_Prospect where cprospect_id =  " & cprospect_id
      Else
        sqlQuery = "Delete from Company_Prospect where cprospect_id =  " & cprospect_id
      End If


      sqlQuery = sqlQuery
      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sqlQuery.ToString)
      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()

      Dim SqlCommand As New SqlClient.SqlCommand(sqlQuery, SqlConn)

      SqlCommand.ExecuteNonQuery()


      SqlCommand.Dispose()
      SqlCommand = Nothing

    Catch ex As Exception
      Me.class_error = "Error in Remove_Prospect_View_Homebase(ByVal comp_id As Long, ByVal journalID As Long) As DataTable" & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing
    End Try


  End Sub

  Public Sub Insert_Update_Notes_Prospect_View_Homebase(ByVal cprospect_id As Long, cprospect_service As String, ByVal cprospect_type As String, ByVal cprospect_details As String, ByVal cprospect_assigned_to As String, ByVal cprospect_target_date As String, ByVal cprospect_next_action_date As String, ByVal cprospect_value As String, ByVal cprospect_percent_win As String, ByVal cprospect_status As String, ByVal cprospect_user_id As String, ByVal cprospect_comp_id As Long, ByVal cprospect_contact_id As Long, ByVal cprospect_start_date As String, ByVal cprospect_cpsource_id As String, ByVal cprospect_referrer_user_id As String)
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim aTempTable As New DataTable
    Dim AndQ As String = ""

    Try

      Dim sqlQuery As String = ""


      If cprospect_id > 0 Then
        If HttpContext.Current.Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.HOMEBASE = True Then
          sqlQuery = "Update Company_Prospect  Set "
        ElseIf HttpContext.Current.Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CUSTOMER_CENTER = True Then
          sqlQuery = "Update [Homebase].jetnet_ra.dbo.Company_Prospect  Set "
        Else
          sqlQuery = "Update Company_Prospect  Set "
        End If

        sqlQuery &= " cprospect_service = '" & cprospect_service & "' "
        sqlQuery &= ", cprospect_type = '" & cprospect_type & "' "
        sqlQuery &= ", cprospect_details = '" & cprospect_details & "' "
        'sqlQuery &= ", cprospect_assigned_to = '" & cprospect_assigned_to & "' "
        sqlQuery &= ", cprospect_target_date = '" & cprospect_target_date & "' "
        ' sqlQuery &= ", cprospect_next_action_date = '" & cprospect_next_action_date & "' "
        sqlQuery &= ", cprospect_value = '" & cprospect_value & "' "
        sqlQuery &= ", cprospect_percent_win = '" & cprospect_percent_win & "' "
        sqlQuery &= ", cprospect_status = '" & cprospect_status & "' "
        sqlQuery &= ", cprospect_user_id = '" & cprospect_user_id & "' "
        sqlQuery &= ", cprospect_comp_id = '" & cprospect_comp_id & "' "
        sqlQuery &= ", cprospect_contact_id = '" & cprospect_contact_id & "' "
        sqlQuery &= ", cprospect_start_date = '" & cprospect_start_date & "' "



        If Trim(cprospect_cpsource_id) <> "ALL" Then
          sqlQuery &= ", cprospect_cpsource_id = '" & cprospect_cpsource_id & "' "
        Else
          sqlQuery &= ", cprospect_cpsource_id = '0' "
        End If



        If Trim(cprospect_referrer_user_id) <> "All" Then
          sqlQuery &= ", cprospect_referrer_user_id = '" & cprospect_referrer_user_id & "' "
        Else
          sqlQuery &= ", cprospect_referrer_user_id = '' "
        End If




        sqlQuery &= " where cprospect_id =  " & cprospect_id
      Else
        If HttpContext.Current.Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.HOMEBASE = True Then
          sqlQuery = " Insert Into Company_Prospect "
        ElseIf HttpContext.Current.Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CUSTOMER_CENTER = True Then
          sqlQuery = "Insert Into [Homebase].jetnet_ra.dbo.Company_Prospect  "
        Else
          sqlQuery = " Insert Into Company_Prospect "
        End If

        sqlQuery &= "  (cprospect_service, cprospect_type, cprospect_details,  "   'cprospect_assigned_to,
        sqlQuery &= "cprospect_target_date,  cprospect_value, cprospect_percent_win, cprospect_status, cprospect_user_id"    ' cprospect_next_action_date,
        sqlQuery &= ", cprospect_comp_id, cprospect_contact_id, cprospect_start_date, cprospect_cpsource_id, cprospect_referrer_user_id "
        sqlQuery &= ")  "
        sqlQuery &= " VALUES ( "
        sqlQuery &= "  '" & cprospect_service & "',"
        sqlQuery &= "  '" & cprospect_type & "',"
        sqlQuery &= "  '" & cprospect_details & "',"
        '   sqlQuery &= "  '" & cprospect_assigned_to & "',"
        sqlQuery &= "  '" & cprospect_target_date & "',"
        '   sqlQuery &= "  '" & cprospect_next_action_date & "',"
        sqlQuery &= "  '" & cprospect_value & "',"
        sqlQuery &= "  '" & cprospect_percent_win & "',"
        sqlQuery &= "  '" & cprospect_status & "', "
        sqlQuery &= "  '" & cprospect_user_id & "', "
        sqlQuery &= "  '" & cprospect_comp_id & "', "
        sqlQuery &= "  '" & cprospect_contact_id & "', "
        sqlQuery &= "  '" & cprospect_start_date & "', "

        If Trim(cprospect_cpsource_id) <> "ALL" Then
          sqlQuery &= "  '" & cprospect_cpsource_id & "', "
        Else
          sqlQuery &= "  '0', "
        End If



        If Trim(cprospect_referrer_user_id) <> "All" Then
          sqlQuery &= "  '" & cprospect_referrer_user_id & "' "
        Else
          sqlQuery &= "  '' "
        End If


        sqlQuery &= " ) "
      End If

      sqlQuery = sqlQuery
      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sqlQuery.ToString)
      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()

      Dim SqlCommand As New SqlClient.SqlCommand(sqlQuery, SqlConn)

      SqlCommand.ExecuteNonQuery()


      SqlCommand.Dispose()
      SqlCommand = Nothing

    Catch ex As Exception

      Me.class_error = "Error in Insert_Update_Notes_Prospect_View_Homebase(ByVal comp_id As Long, ByVal journalID As Long) As DataTable" & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing
    End Try

  End Sub



  Public Sub Fill_Type_Category(ByVal notes_opp As Object, ByVal aclsdata_temp As clsData_Manager_SQL)
    Dim atemptable As New DataTable
    atemptable = Get_Type_Categories_Prospect()
    If Not IsNothing(atemptable) Then
      If atemptable.Rows.Count > 0 Then
        For Each q As DataRow In atemptable.Rows
          notes_opp.Items.Add(New ListItem(q(0), q(0)))
        Next
      End If
    End If
  End Sub
  Public Sub Fill_Service_Category(ByVal notes_opp As DropDownList, ByVal atemptable As DataTable, ByVal aclsdata_temp As clsData_Manager_SQL)
    atemptable = Get_Service_Categories_Prospect()
    If Not IsNothing(atemptable) Then
      If atemptable.Rows.Count > 0 Then
        For Each q As DataRow In atemptable.Rows
          notes_opp.Items.Add(New ListItem(q(0), q(0)))
        Next
      End If
    End If
  End Sub
  Public Sub Fill_Source(ByVal notes_opp As ListBox, ByVal atemptable As DataTable, ByVal aclsdata_temp As clsData_Manager_SQL)
    atemptable = Get_Source()
    If Not IsNothing(atemptable) Then
      If atemptable.Rows.Count > 0 Then
        For Each q As DataRow In atemptable.Rows
          notes_opp.Items.Add(New ListItem(q(1), q(0)))
        Next
      End If
    End If
  End Sub
  Public Sub Fill_Source_Drop(ByVal notes_opp As DropDownList, ByVal atemptable As DataTable, ByVal aclsdata_temp As clsData_Manager_SQL)
    atemptable = Get_Source()
    If Not IsNothing(atemptable) Then
      If atemptable.Rows.Count > 0 Then
        For Each q As DataRow In atemptable.Rows
          notes_opp.Items.Add(New ListItem(q(1), q(0)))
        Next
      End If
    End If
  End Sub
  Public Function Get_Type_Categories_Prospect() As DataTable '(ByVal note_search As String, ByVal note_start_date As String, ByVal note_end_date As String, ByVal note_type As String, ByVal category As String, ByVal jetnet_amod_id As String, ByVal client_amod_id As String, ByVal user As String, ByVal opp_status As String, ByVal ClientIDs As String, ByVal JetnetIDs As String, ByVal acSearchField As Integer, ByVal acSearchOperator As Integer, ByVal acSearchText As String, ByVal OnlyModel As Boolean, ByVal OnlyAircraft As Boolean, Optional ByVal FolderType As Long = 3, Optional ByVal PriorityID As String = "") As DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim aTempTable As New DataTable
    Try

      Dim sqlQuery As String = ""
      sqlQuery = "Select cprostype_name  "

      If HttpContext.Current.Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.HOMEBASE = True Then
        sqlQuery = sqlQuery & " From company_prospect_type with (NOLOCK) "
      ElseIf HttpContext.Current.Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CUSTOMER_CENTER = True Then
        sqlQuery = sqlQuery & " From [Homebase].jetnet_ra.dbo.company_prospect_type with (NOLOCK) "
      Else
        sqlQuery = sqlQuery & " From company_prospect_type with (NOLOCK) "
      End If

      sqlQuery = sqlQuery & " order by cprostype_sort "



      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sqlQuery.ToString)
      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()

      Dim SqlCommand As New SqlClient.SqlCommand(sqlQuery, SqlConn)

      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      SqlCommand.Dispose()
      SqlCommand = Nothing

      Return aTempTable
    Catch ex As Exception
      Get_Type_Categories_Prospect = Nothing
      Me.class_error = "Error in Get_Type_Categories_Prospect(ByVal comp_id As Long, ByVal journalID As Long) As DataTable" & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

    End Try

  End Function
  Public Function Get_Service_Categories_Prospect() As DataTable ' (ByVal note_search As String, ByVal note_start_date As String, ByVal note_end_date As String, ByVal note_type As String, ByVal category As String, ByVal jetnet_amod_id As String, ByVal client_amod_id As String, ByVal user As String, ByVal opp_status As String, ByVal ClientIDs As String, ByVal JetnetIDs As String, ByVal acSearchField As Integer, ByVal acSearchOperator As Integer, ByVal acSearchText As String, ByVal OnlyModel As Boolean, ByVal OnlyAircraft As Boolean, Optional ByVal FolderType As Long = 3, Optional ByVal PriorityID As String = "") As DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim aTempTable As New DataTable
    Try

      Dim sqlQuery As String = ""
      sqlQuery = "Select distinct cprospect_service  "

      If HttpContext.Current.Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.HOMEBASE = True Then
        sqlQuery = sqlQuery & " From Company_Prospect with (NOLOCK) "
      ElseIf HttpContext.Current.Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CUSTOMER_CENTER = True Then
        sqlQuery = sqlQuery & " From  [Homebase].jetnet_ra.dbo.Company_Prospect with (NOLOCK) "
      Else
        sqlQuery = sqlQuery & " From Company_Prospect with (NOLOCK) "
      End If

      ' sqlQuery = sqlQuery & " where cprospect_status = 'Active' "

      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sqlQuery.ToString)
      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()

      Dim SqlCommand As New SqlClient.SqlCommand(sqlQuery, SqlConn)

      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      SqlCommand.Dispose()
      SqlCommand = Nothing

      Return aTempTable
    Catch ex As Exception
      Get_Service_Categories_Prospect = Nothing
      Me.class_error = "Error in Get_Service_Categories_Prospect(ByVal comp_id As Long, ByVal journalID As Long) As DataTable" & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

    End Try

  End Function
  Public Function Get_Source() As DataTable ' (ByVal note_search As String, ByVal note_start_date As String, ByVal note_end_date As String, ByVal note_type As String, ByVal category As String, ByVal jetnet_amod_id As String, ByVal client_amod_id As String, ByVal user As String, ByVal opp_status As String, ByVal ClientIDs As String, ByVal JetnetIDs As String, ByVal acSearchField As Integer, ByVal acSearchOperator As Integer, ByVal acSearchText As String, ByVal OnlyModel As Boolean, ByVal OnlyAircraft As Boolean, Optional ByVal FolderType As Long = 3, Optional ByVal PriorityID As String = "") As DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim aTempTable As New DataTable
    Try

      Dim sqlQuery As String = ""
      sqlQuery = "Select  cpsource_id, cpsource_name  "

      If HttpContext.Current.Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.HOMEBASE = True Then
        sqlQuery = sqlQuery & " From company_prospect_source with (NOLOCK) "
      ElseIf HttpContext.Current.Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CUSTOMER_CENTER = True Then
        sqlQuery = sqlQuery & " From  [Homebase].jetnet_ra.dbo.company_prospect_source with (NOLOCK) "
      Else
        sqlQuery = sqlQuery & " From company_prospect_source with (NOLOCK) "
      End If

      sqlQuery = sqlQuery & " where cpsource_active ='Y' "
      sqlQuery = sqlQuery & " order by cpsource_name "



      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sqlQuery.ToString)
      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()

      Dim SqlCommand As New SqlClient.SqlCommand(sqlQuery, SqlConn)

      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      SqlCommand.Dispose()
      SqlCommand = Nothing

      Return aTempTable
    Catch ex As Exception
      Get_Source = Nothing
      Me.class_error = "Error in Get_Service_Categories_Prospect(ByVal comp_id As Long, ByVal journalID As Long) As DataTable" & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

    End Try

  End Function
  'Public Function Notes_Search_For_Prospect_View_Homebase(ByVal note_search As String, ByVal note_start_date As String, ByVal note_end_date As String, ByVal note_type As String, ByVal category As String, ByVal jetnet_amod_id As String, ByVal client_amod_id As String, ByVal user As String, ByVal opp_status As String, ByVal ClientIDs As String, ByVal JetnetIDs As String, ByVal acSearchField As Integer, ByVal acSearchOperator As Integer, ByVal acSearchText As String, ByVal OnlyModel As Boolean, ByVal OnlyAircraft As Boolean, Optional ByVal FolderType As Long = 3, Optional ByVal PriorityID As String = "") As DataTable
  '    Dim FieldToPoll As String = "ac"
  '    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
  '    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
  '    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
  '    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing

  '    Try
  '        ' create the Select Strings
  '        Dim aSQL_String_Client_Select As String = ""
  '        Dim aSQL_String_JETNET_Select As String = ""
  '        ' create the Where string
  '        Dim aSQL_String_Client_Where As String = ""
  '        Dim aSQL_String_JETNET_Where As String = ""
  '        ' create a data table to hold the company info
  '        Dim dalTable As New DataTable
  '        Dim atemptable As New DataTable
  '        Dim atemptable2 As New DataTable
  '        Dim dataSet As DataSet = New DataSet("dataSet")
  '        dataSet.Tables.Add(atemptable)
  '        dataSet.EnforceConstraints = False
  '        Dim AircraftSearch As Boolean = False


  '        If Not String.IsNullOrEmpty(Trim(acSearchText)) Then
  '            'If the aircraft search field isn't empty.
  '            'We need to go ahead and add that this is an aircraft search.
  '            AircraftSearch = True
  '        End If

  '        '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  '        '----------------------------------------------------------- check to see if we are getting client data---------------------------------------------------
  '        '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

  '        '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  '        ' ---------------------------------------------------------Setup the Client SQL Strings---------------------------------------------------------------
  '        '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

  '        'These are the basic fields needed for the company export. 

  '        aSQL_String_Client_Select = "Select Case comp_id, comp_name, comp_address1, comp_city, comp_state, comp_country, "
  '        aSQL_String_Client_Select = aSQL_String_Client_Select & " cprospect_service, cprospect_type, cprospect_details, "
  '        aSQL_String_Client_Select = aSQL_String_Client_Select & " cprospect_assigned_to, cprospect_target_date, cprospect_next_action_date, "
  '        aSQL_String_Client_Select = aSQL_String_Client_Select & " cprospect_value, cprospect_percent_win "
  '        aSQL_String_Client_Select = aSQL_String_Client_Select & " From Company_Prospect with (NOLOCK) "
  '        aSQL_String_Client_Select = aSQL_String_Client_Select & " inner Join company on comp_id = cprospect_comp_id And comp_journ_id = 0 "
  '        aSQL_String_Client_Select = aSQL_String_Client_Select & " where cprospect_status = 'Active' "




  '        'aSQL_String_Client_Select = "SELECT local_notes.lnote_id, local_notes.lnote_jetnet_ac_id, local_notes.lnote_jetnet_comp_id, lnote_opportunity_status, lnote_cash_value, lnote_capture_percentage, "
  '        'aSQL_String_Client_Select = aSQL_String_Client_Select & "local_notes.lnote_client_ac_id, local_notes.lnote_client_comp_id, "
  '        'aSQL_String_Client_Select = aSQL_String_Client_Select & "local_notes.lnote_jetnet_contact_id, local_notes.lnote_client_contact_id, left(local_notes.lnote_note,21000)"
  '        'aSQL_String_Client_Select = aSQL_String_Client_Select & "as lnote_note, local_notes.lnote_entry_date, local_notes.lnote_action_date, "
  '        'aSQL_String_Client_Select = aSQL_String_Client_Select & "local_notes.lnote_user_login, local_notes.lnote_user_name, local_notes.lnote_notecat_key, local_notes.lnote_status, "
  '        'aSQL_String_Client_Select = aSQL_String_Client_Select & "local_notes.lnote_schedule_start_date, "
  '        'aSQL_String_Client_Select = aSQL_String_Client_Select & "local_notes.lnote_schedule_end_date, local_notes.lnote_user_id, local_notes.lnote_clipri_ID, client_priority.clipri_name, "
  '        'aSQL_String_Client_Select = aSQL_String_Client_Select & "client_priority.clipri_sort_order, cliuser_first_name, cliuser_last_name, oppcat, "
  '        'aSQL_String_Client_Select = aSQL_String_Client_Select & " clicomp_name as comp_name, clicomp_address1 as comp_address1, clicomp_address2 as comp_address2, clicomp_city as comp_city ,"
  '        'aSQL_String_Client_Select = aSQL_String_Client_Select & " clicomp_state as comp_state, clicomp_country as comp_country, clicomp_zip_code as comp_zip_code, clicomp_id as comp_id, clicomp_description as comp_description, "
  '        'aSQL_String_Client_Select = aSQL_String_Client_Select & " clicomp_email_address as comp_email_address, '' as comp_phone_office, '' as comp_phone_fax , "

  '        'aSQL_String_Client_Select = aSQL_String_Client_Select & " cliamod_model_name as amod_model_name, cliamod_make_name as amod_make_name, cliaircraft_ser_nbr as ac_ser_nbr, cliaircraft_reg_nbr as ac_reg_nbr,"
  '        'aSQL_String_Client_Select = aSQL_String_Client_Select & " cliaircraft_year_mfr as ac_year_mfr, cliaircraft_id as ac_id, cliaircraft_date_purchased as ac_date_purchased, cliaircraft_forsale_flag as ac_forsale_flag, "
  '        'aSQL_String_Client_Select = aSQL_String_Client_Select & " cliaircraft_status as ac_status, cliaircraft_delivery as ac_delivery, cliaircraft_asking_wordage as ac_asking_wordage, cliaircraft_asking_price as ac_asking_price, "
  '        'aSQL_String_Client_Select = aSQL_String_Client_Select & " cliaircraft_est_price as ac_est_price, cliaircraft_date_listed as ac_date_listed, cliaircraft_exclusive_flag as ac_exclusive_flag, cliaircraft_lease_flag as ac_lease_flag, "


  '        'aSQL_String_Client_Select = aSQL_String_Client_Select & "local_notes.lnote_document_flag, local_notes.lnote_jetnet_amod_id, local_notes.lnote_client_amod_id,lnote_status, "
  '        'aSQL_String_Client_Select = aSQL_String_Client_Select & "local_notes.lnote_document_name "


  '        'aSQL_String_Client_Select = aSQL_String_Client_Select & "FROM  local_notes INNER JOIN "
  '        'aSQL_String_Client_Select = aSQL_String_Client_Select & "client_priority ON local_notes.lnote_clipri_ID = client_priority.clipri_ID"
  '        'aSQL_String_Client_Select = aSQL_String_Client_Select & " left outer join client_company on local_notes.lnote_client_comp_id = clicomp_id"
  '        'aSQL_String_Client_Select = aSQL_String_Client_Select & " left outer join client_aircraft on local_notes.lnote_client_ac_id = cliaircraft_id"
  '        'aSQL_String_Client_Select = aSQL_String_Client_Select & " left outer join client_aircraft_model on client_aircraft.cliaircraft_cliamod_id = cliamod_id "
  '        'aSQL_String_Client_Select = aSQL_String_Client_Select & " left outer join client_user on local_notes.lnote_user_id = cliuser_id "
  '        'aSQL_String_Client_Select = aSQL_String_Client_Select & " left outer join opportunity_category on local_notes.lnote_notecat_key = oppcat_key "

  '        ''This means that this is an aircraft search
  '        'If AircraftSearch Then
  '        '    'So we need to go ahead and add an inner join.
  '        '    aSQL_String_Client_Select = aSQL_String_Client_Select & " left outer join client_aircraft on local_notes.lnote_client_ac_id = cliaircraft_id "
  '        'End If



  '        aSQL_String_Client_Select = "Select Case comp_id, comp_name, comp_address1, comp_city, comp_state, comp_country, "
  '        aSQL_String_Client_Select = aSQL_String_Client_Select & " cprospect_service, cprospect_type, cprospect_details, "
  '        aSQL_String_Client_Select = aSQL_String_Client_Select & " cprospect_assigned_to, cprospect_target_date, cprospect_next_action_date, "
  '        aSQL_String_Client_Select = aSQL_String_Client_Select & " cprospect_value, cprospect_percent_win "

  '        atemptable.Columns.Add("comp_id")
  '        atemptable.Columns.Add("comp_name")
  '        atemptable.Columns.Add("comp_address1")
  '        atemptable.Columns.Add("comp_city")
  '        atemptable.Columns.Add("comp_state")
  '        atemptable.Columns.Add("comp_country")
  '        atemptable.Columns.Add("cprospect_service")
  '        atemptable.Columns.Add("cprospect_type")
  '        atemptable.Columns.Add("cprospect_details")
  '        atemptable.Columns.Add("cprospect_assigned_to")
  '        atemptable.Columns.Add("cprospect_target_date")
  '        atemptable.Columns.Add("cprospect_next_action_date")
  '        atemptable.Columns.Add("cprospect_value")
  '        atemptable.Columns.Add("cprospect_percent_win")



  '        'atemptable.Columns.Add("lnote_id")
  '        'atemptable.Columns.Add("lnote_opportunity_status")
  '        'atemptable.Columns.Add("lnote_cash_value")
  '        'atemptable.Columns.Add("lnote_capture_percentage")
  '        'atemptable.Columns.Add("lnote_jetnet_comp_id")
  '        'atemptable.Columns.Add("lnote_jetnet_ac_id")
  '        'atemptable.Columns.Add("lnote_jetnet_contact_id")
  '        'atemptable.Columns.Add("lnote_client_comp_id")
  '        'atemptable.Columns.Add("lnote_client_ac_id")
  '        'atemptable.Columns.Add("lnote_client_contact_id")
  '        'atemptable.Columns.Add("lnote_note")
  '        'atemptable.Columns.Add("lnote_entry_date")
  '        'atemptable.Columns.Add("lnote_action_date")
  '        'atemptable.Columns.Add("lnote_user_login")
  '        'atemptable.Columns.Add("lnote_user_name")
  '        'atemptable.Columns.Add("lnote_notecat_key")
  '        'atemptable.Columns.Add("lnote_schedule_start_date")
  '        'atemptable.Columns.Add("lnote_schedule_end_date")
  '        'atemptable.Columns.Add("lnote_user_id")
  '        'atemptable.Columns.Add("lnote_clipri_ID")
  '        'atemptable.Columns.Add("lnote_status")
  '        'atemptable.Columns.Add("clipri_name")
  '        'atemptable.Columns.Add("clipri_sort_order")
  '        'atemptable.Columns.Add("lnote_document_flag")
  '        'atemptable.Columns.Add("lnote_jetnet_amod_id")
  '        'atemptable.Columns.Add("lnote_client_amod_id")
  '        'atemptable.Columns.Add("lnote_document_name")

  '        'atemptable.Columns.Add("cliuser_first_name")
  '        'atemptable.Columns.Add("cliuser_last_name")
  '        'atemptable.Columns.Add("oppcat")

  '        ''Company Tables.
  '        'atemptable.Columns.Add("comp_name")
  '        'atemptable.Columns.Add("comp_address1")
  '        'atemptable.Columns.Add("comp_address2")
  '        'atemptable.Columns.Add("comp_city")
  '        'atemptable.Columns.Add("comp_state")
  '        'atemptable.Columns.Add("comp_country")
  '        'atemptable.Columns.Add("comp_zip_code")
  '        'atemptable.Columns.Add("comp_id")
  '        'atemptable.Columns.Add("comp_description")
  '        'atemptable.Columns.Add("comp_email_address")
  '        'atemptable.Columns.Add("comp_source")
  '        'atemptable.Columns.Add("comp_phone_office")
  '        'atemptable.Columns.Add("comp_phone_fax")

  '        ''Aircraft
  '        'atemptable.Columns.Add("amod_model_name")
  '        'atemptable.Columns.Add("amod_make_name")
  '        'atemptable.Columns.Add("ac_ser_nbr")
  '        'atemptable.Columns.Add("ac_reg_nbr")
  '        'atemptable.Columns.Add("ac_year_mfr")
  '        'atemptable.Columns.Add("ac_id")
  '        'atemptable.Columns.Add("ac_source")
  '        'atemptable.Columns.Add("ac_date_purchased")
  '        'atemptable.Columns.Add("ac_forsale_flag")
  '        'atemptable.Columns.Add("ac_status")
  '        'atemptable.Columns.Add("ac_delivery")
  '        'atemptable.Columns.Add("ac_asking_wordage")
  '        'atemptable.Columns.Add("ac_asking_price")
  '        'atemptable.Columns.Add("ac_est_price")
  '        'atemptable.Columns.Add("ac_date_listed")
  '        'atemptable.Columns.Add("ac_exclusive_flag")
  '        'atemptable.Columns.Add("ac_lease_flag")


  '        'Dim AndQ As String = ""
  '        ''The Building of the Where Clause 

  '        'If OnlyModel = True Then
  '        '    'This is sent on the propsect search, all others are false. This is sent whenever the customer wants to return only prospects with a model attached.
  '        '    aSQL_String_Client_Where = aSQL_String_Client_Where & " (lnote_jetnet_amod_id <> 0 or lnote_client_amod_id <> 0 ) " ' and (lnote_jetnet_ac_id = 0 and lnote_client_ac_id = 0 )"
  '        'ElseIf OnlyAircraft = True Then
  '        '    'This is sent on the prospect search, all other instances are false. This means the customer wants to return only prospects with an Aircraft attached.
  '        '    aSQL_String_Client_Where = aSQL_String_Client_Where & " (lnote_jetnet_ac_id <> 0 or lnote_client_ac_id <> 0 ) "
  '        'End If

  '        'If note_type = "A" Then
  '        '    If note_start_date <> "" Then
  '        '        If aSQL_String_Client_Where <> "" Then
  '        '            AndQ = " and "
  '        '        Else
  '        '            AndQ = ""
  '        '        End If
  '        '        aSQL_String_Client_Where = aSQL_String_Client_Where & " (lnote_entry_date >= """ & note_start_date & """) "
  '        '    End If
  '        '    If note_end_date <> "" Then
  '        '        If aSQL_String_Client_Where <> "" Then
  '        '            AndQ = " and "
  '        '        Else
  '        '            AndQ = ""
  '        '        End If
  '        '        aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (lnote_entry_date <= """ & Format(DateAdd(DateInterval.Day, 1, CDate(note_end_date)), "yyyy-MM-dd") & """)"
  '        '    End If
  '        'ElseIf note_type = "P" Then
  '        '    If note_start_date <> "" Then
  '        '        aSQL_String_Client_Where = aSQL_String_Client_Where & " (lnote_schedule_start_date >= """ & note_start_date & """) "
  '        '    End If
  '        '    If note_end_date <> "" Then
  '        '        If aSQL_String_Client_Where <> "" Then
  '        '            AndQ = " and "
  '        '        Else
  '        '            AndQ = ""
  '        '        End If
  '        '        aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (lnote_schedule_end_date <= """ & note_end_date & """)"
  '        '    End If
  '        'ElseIf note_type = "O" Or note_type = "B','O" Then
  '        '    If note_start_date <> "" Then
  '        '        aSQL_String_Client_Where = aSQL_String_Client_Where & " (lnote_schedule_start_date >= """ & note_start_date & """) "
  '        '    End If
  '        '    If note_end_date <> "" Then
  '        '        If aSQL_String_Client_Where <> "" Then
  '        '            AndQ = " and "
  '        '        Else
  '        '            AndQ = ""
  '        '        End If
  '        '        aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (lnote_schedule_start_date <= """ & note_end_date & """)"
  '        '    End If
  '        'End If

  '        'If note_search <> "" And note_search <> "%" And note_search <> "%%" Then
  '        '    If aSQL_String_Client_Where <> "" Then
  '        '        AndQ = " and "
  '        '    Else
  '        '        AndQ = ""
  '        '    End If
  '        '    aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (lnote_note like '" & note_search & "')"
  '        'End If

  '        'If opp_status <> "" Then
  '        '    If aSQL_String_Client_Where <> "" Then
  '        '        AndQ = " and "
  '        '    Else
  '        '        AndQ = ""
  '        '    End If
  '        '    aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (lnote_opportunity_status in ('" & opp_status & "'))"
  '        'End If

  '        'If PriorityID <> "" Then
  '        '    If aSQL_String_Client_Where <> "" Then
  '        '        AndQ = " and "
  '        '    Else
  '        '        AndQ = ""
  '        '    End If
  '        '    aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (lnote_clipri_ID in (" & PriorityID.ToString & "))"
  '        'End If
  '        'Select Case FolderType
  '        '    Case 2
  '        '        FieldToPoll = "contact"
  '        '    Case 1
  '        '        FieldToPoll = "comp"
  '        'End Select

  '        'If ClientIDs <> "" Then
  '        '    AndQ = ""
  '        '    If aSQL_String_Client_Where <> "" Then
  '        '        AndQ = " and "
  '        '    End If
  '        '    aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ

  '        '    If JetnetIDs <> "" Then
  '        '        aSQL_String_Client_Where = aSQL_String_Client_Where & "("
  '        '    End If

  '        '    aSQL_String_Client_Where = aSQL_String_Client_Where & " lnote_client_" & FieldToPoll & "_id in (" & ClientIDs & ")"
  '        'End If


  '        'If JetnetIDs <> "" Then
  '        '    AndQ = ""
  '        '    If aSQL_String_Client_Where <> "" And ClientIDs = "" Then
  '        '        AndQ = " and "
  '        '    ElseIf aSQL_String_Client_Select <> "" And ClientIDs <> "" Then
  '        '        AndQ = " or "
  '        '    End If
  '        '    aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " lnote_jetnet_" & FieldToPoll & "_id in (" & JetnetIDs & ")"
  '        '    If ClientIDs <> "" Then
  '        '        aSQL_String_Client_Where = aSQL_String_Client_Where & ")"
  '        '    End If
  '        'End If

  '        'If note_type <> "" Then
  '        '    If aSQL_String_Client_Where <> "" Then
  '        '        AndQ = " and "
  '        '    Else
  '        '        AndQ = ""
  '        '    End If
  '        '    If note_type = "A" Then 'emails + notes returned
  '        '        aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (lnote_status in ('E','A'))"
  '        '    Else
  '        '        aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (lnote_status in ('" & note_type & "'))"
  '        '    End If

  '        'End If

  '        'If category <> 0 Then
  '        '    If aSQL_String_Client_Where <> "" Then
  '        '        aSQL_String_Client_Where = aSQL_String_Client_Where & " AND local_notes.lnote_notecat_key = '" & category & "' "
  '        '    Else
  '        '        aSQL_String_Client_Where = " local_notes.lnote_notecat_key = '" & category & "' "
  '        '    End If
  '        'End If

  '        'If user <> "0" Then
  '        '    If aSQL_String_Client_Where <> "" Then
  '        '        aSQL_String_Client_Where = aSQL_String_Client_Where & " AND local_notes.lnote_user_id = '" & user & "' "
  '        '    Else
  '        '        aSQL_String_Client_Where = " local_notes.lnote_user_id = '" & user & "' "
  '        '    End If
  '        'End If


  '        'If jetnet_amod_id <> "" Then
  '        '    If aSQL_String_Client_Where <> "" Then
  '        '        aSQL_String_Client_Where = aSQL_String_Client_Where & "AND local_notes.lnote_jetnet_amod_id in(" & jetnet_amod_id & ") "
  '        '    Else
  '        '        aSQL_String_Client_Where = "local_notes.lnote_jetnet_amod_id in(" & jetnet_amod_id & ") "
  '        '    End If
  '        'End If
  '        'If client_amod_id <> "" Then
  '        '    If aSQL_String_Client_Where <> "" Then
  '        '        aSQL_String_Client_Where = aSQL_String_Client_Where & "AND local_notes.lnote_client_amod_id in ( " & client_amod_id & ") "
  '        '    Else
  '        '        aSQL_String_Client_Where = "local_notes.lnote_client_amod_id in (" & client_amod_id & ") "
  '        '    End If
  '        'End If


  '        'If AircraftSearch Then
  '        '    Dim OperatorChosen As String = "LIKE"

  '        '    'Let's set up both the operator and the search text to add percentages if we need them.
  '        '    Select Case acSearchOperator
  '        '        Case 2 'Like is encapsulated with a percentage.
  '        '            OperatorChosen = "LIKE"
  '        '            acSearchText = "%" & acSearchText & "%"
  '        '        Case 3 'Equals means no percentage here.
  '        '            OperatorChosen = " = "
  '        '        Case Else 'Begins with/default value means a percentage trails.
  '        '            OperatorChosen = "LIKE"
  '        '            acSearchText = acSearchText & "%"
  '        '    End Select

  '        '    'Let's add an and if we need it

  '        '    If aSQL_String_Client_Where <> "" Then
  '        '        aSQL_String_Client_Where += " and "
  '        '    End If

  '        '    'We're going to go ahead and surround this with parentheses because that'll make it easier to read.
  '        '    aSQL_String_Client_Where += " ( ( "

  '        '    Select Case acSearchField
  '        '        Case 2
  '        '            aSQL_String_Client_Where += " cliaircraft_ser_nbr  " & OperatorChosen & " '" & acSearchText & "'"
  '        '        Case 3
  '        '            aSQL_String_Client_Where += " cliaircraft_reg_nbr  " & OperatorChosen & " '" & acSearchText & "' "
  '        '        Case 4
  '        '            aSQL_String_Client_Where += " cliaircraft_id " & OperatorChosen & " '" & acSearchText & "' "
  '        '        Case Else
  '        '            aSQL_String_Client_Where += " cliaircraft_ser_nbr " & OperatorChosen & " '" & acSearchText & "' or cliaircraft_reg_nbr " & OperatorChosen & " '" & acSearchText & "' "
  '        '    End Select

  '        '    aSQL_String_Client_Where += ") or (lnote_jetnet_ac_id <> 0 and lnote_client_ac_id = 0) "

  '        '    aSQL_String_Client_Where += " )"
  '        'End If


  '        MySqlConn.ConnectionString = Me.client_DB
  '        MySqlConn.Open()
  '        MySqlCommand.Connection = MySqlConn
  '        MySqlCommand.CommandType = CommandType.Text
  '        MySqlCommand.CommandTimeout = 60

  '        'Dim sQuery As String = aSQL_String_Client_Select & " WHERE " & aSQL_String_Client_Where

  '        'If note_type = "P" Then
  '        '    sQuery = sQuery & " order by lnote_schedule_start_date desc "
  '        'ElseIf note_type = "O" Then
  '        '    sQuery = sQuery & " order by lnote_schedule_start_date desc "
  '        'Else
  '        '    sQuery = sQuery & " order by lnote_entry_date desc "
  '        'End If
  '        MySqlCommand.CommandText = sQuery

  '        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Notes_Search(ByVal note_search As String, ByVal note_start_date As String, ByVal note_end_date As String, ByVal note_type As String, ByVal category As String, ByVal jetnet_amod_id As String, ByVal client_amod_id As String, ByVal user As String, ByVal opp_status As String) As DataTable <em>Client Side</em></b><br />" & sQuery


  '        MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

  '        While MySqlReader.Read()
  '            Dim newCustomersRow As DataRow = atemptable.NewRow()

  '            newCustomersRow.Item("lnote_id") = MySqlReader.Item("lnote_id")
  '            newCustomersRow.Item("lnote_jetnet_comp_id") = MySqlReader.Item("lnote_jetnet_comp_id")
  '            newCustomersRow.Item("lnote_jetnet_ac_id") = MySqlReader.Item("lnote_jetnet_ac_id")
  '            newCustomersRow.Item("lnote_jetnet_contact_id") = MySqlReader.Item("lnote_jetnet_contact_id")
  '            newCustomersRow.Item("lnote_client_comp_id") = MySqlReader.Item("lnote_client_comp_id")
  '            newCustomersRow.Item("lnote_client_ac_id") = MySqlReader.Item("lnote_client_ac_id")
  '            newCustomersRow.Item("lnote_client_contact_id") = MySqlReader.Item("lnote_client_contact_id")
  '            newCustomersRow.Item("lnote_note") = MySqlReader.Item("lnote_note")
  '            newCustomersRow.Item("lnote_entry_date") = MySqlReader.Item("lnote_entry_date")
  '            newCustomersRow.Item("lnote_action_date") = MySqlReader.Item("lnote_action_date")
  '            newCustomersRow.Item("lnote_user_login") = MySqlReader.Item("lnote_user_login")
  '            newCustomersRow.Item("lnote_user_name") = MySqlReader.Item("lnote_user_name")
  '            newCustomersRow.Item("lnote_notecat_key") = MySqlReader.Item("lnote_notecat_key")
  '            newCustomersRow.Item("lnote_schedule_start_date") = MySqlReader.Item("lnote_schedule_start_date")
  '            newCustomersRow.Item("lnote_schedule_end_date") = MySqlReader.Item("lnote_schedule_end_date")
  '            newCustomersRow.Item("lnote_user_id") = MySqlReader.Item("lnote_user_id")
  '            newCustomersRow.Item("lnote_status") = MySqlReader.Item("lnote_status")
  '            newCustomersRow.Item("lnote_clipri_ID") = MySqlReader.Item("lnote_clipri_ID")
  '            newCustomersRow.Item("clipri_name") = MySqlReader.Item("clipri_name")
  '            newCustomersRow.Item("clipri_sort_order") = MySqlReader.Item("clipri_sort_order")
  '            newCustomersRow.Item("lnote_document_flag") = MySqlReader.Item("lnote_document_flag")
  '            newCustomersRow.Item("lnote_jetnet_amod_id") = MySqlReader.Item("lnote_jetnet_amod_id")
  '            newCustomersRow.Item("lnote_client_amod_id") = MySqlReader.Item("lnote_client_amod_id")
  '            newCustomersRow.Item("lnote_document_name") = MySqlReader.Item("lnote_document_name")
  '            newCustomersRow.Item("lnote_opportunity_status") = MySqlReader.Item("lnote_opportunity_status")
  '            newCustomersRow.Item("lnote_cash_value") = MySqlReader.Item("lnote_cash_value")
  '            newCustomersRow.Item("lnote_capture_percentage") = MySqlReader.Item("lnote_capture_percentage")

  '            newCustomersRow.Item("cliuser_first_name") = MySqlReader.Item("cliuser_first_name")
  '            newCustomersRow.Item("cliuser_last_name") = MySqlReader.Item("cliuser_last_name")
  '            newCustomersRow.Item("oppcat") = MySqlReader.Item("oppcat")


  '            newCustomersRow.Item("comp_name") = MySqlReader.Item("comp_name")
  '            newCustomersRow.Item("comp_address1") = MySqlReader.Item("comp_address1")
  '            newCustomersRow.Item("comp_address2") = MySqlReader.Item("comp_address2")
  '            newCustomersRow.Item("comp_city") = MySqlReader.Item("comp_city")
  '            newCustomersRow.Item("comp_state") = MySqlReader.Item("comp_state")
  '            newCustomersRow.Item("comp_country") = MySqlReader.Item("comp_country")
  '            newCustomersRow.Item("comp_zip_code") = MySqlReader.Item("comp_zip_code")
  '            newCustomersRow.Item("comp_id") = MySqlReader.Item("comp_id")
  '            newCustomersRow.Item("comp_description") = MySqlReader.Item("comp_description")
  '            newCustomersRow.Item("comp_email_address") = MySqlReader.Item("comp_email_address")
  '            newCustomersRow.Item("comp_phone_office") = MySqlReader.Item("comp_phone_office")
  '            newCustomersRow.Item("comp_phone_fax") = MySqlReader.Item("comp_phone_fax")
  '            newCustomersRow.Item("amod_model_name") = MySqlReader.Item("amod_model_name")
  '            newCustomersRow.Item("amod_make_name") = MySqlReader.Item("amod_make_name")
  '            newCustomersRow.Item("ac_ser_nbr") = MySqlReader.Item("ac_ser_nbr")
  '            newCustomersRow.Item("ac_reg_nbr") = MySqlReader.Item("ac_reg_nbr")
  '            newCustomersRow.Item("ac_year_mfr") = MySqlReader.Item("ac_year_mfr")
  '            newCustomersRow.Item("ac_id") = MySqlReader.Item("ac_id")
  '            newCustomersRow.Item("ac_date_purchased") = MySqlReader.Item("ac_date_purchased")
  '            newCustomersRow.Item("ac_forsale_flag") = MySqlReader.Item("ac_forsale_flag")
  '            newCustomersRow.Item("ac_status") = MySqlReader.Item("ac_status")
  '            newCustomersRow.Item("ac_delivery") = MySqlReader.Item("ac_delivery")
  '            newCustomersRow.Item("ac_asking_wordage") = MySqlReader.Item("ac_asking_wordage")
  '            newCustomersRow.Item("ac_asking_price") = MySqlReader.Item("ac_asking_price")
  '            newCustomersRow.Item("ac_est_price") = MySqlReader.Item("ac_est_price")
  '            newCustomersRow.Item("ac_date_listed") = MySqlReader.Item("ac_date_listed")
  '            newCustomersRow.Item("ac_exclusive_flag") = MySqlReader.Item("ac_exclusive_flag")
  '            newCustomersRow.Item("ac_lease_flag") = MySqlReader.Item("ac_lease_flag")


  '            atemptable.Rows.Add(newCustomersRow)
  '            atemptable.AcceptChanges()

  '        End While



  '        'if this is a serial #/registration search, we aren't technically finished yet. We need to go ahead and 
  '        'look at the jetnet only aircraft attached to notes and search them too.
  '        If AircraftSearch Then
  '            SearchJetnetSideForACIDPlusNotesACSearch(atemptable, acSearchOperator, acSearchText, acSearchField)
  '        End If
  '        Notes_Search_For_Prospect_View_Homebase = atemptable


  '        atemptable = Nothing

  '    Catch ex As Exception
  '        Notes_Search_For_Prospect_View_Homebase = Nothing
  '        Me.class_error = "Error in Notes_Search(): " & ex.Message
  '    Finally
  '        MySqlReader.Close()
  '        MySqlReader = Nothing

  '        MySqlConn.Close()
  '        MySqlConn.Dispose()
  '        MySqlConn = Nothing

  '        MySqlCommand.Dispose()
  '        MySqlCommand = Nothing

  '    End Try
  'End Function
  ''' <summary>
  ''' Prospect query for aircraft tab
  ''' </summary>
  ''' <param name="company_client_ID"></param>
  ''' <param name="company_jetnet_ID"></param>
  ''' <param name="ac_client_ID"></param>
  ''' <param name="ac_jetnet_id"></param>
  ''' <param name="model_client_id"></param>
  ''' <param name="model_jetnet_id"></param>
  ''' <param name="OnlyProspectsForAircraft"></param>
  ''' <param name="ProspectsForAircraftModel"></param>
  ''' <param name="ProspectsForOtherAircraftModel"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function ChangeProspectNotesByParameters(ByVal company_client_ID As Long, ByVal company_jetnet_ID As Long, ByVal ac_client_ID As Long, ByVal ac_jetnet_id As Long, ByVal model_client_id As Long, ByVal model_jetnet_id As Long, ByVal OnlyProspectsForAircraft As Boolean, ByVal ProspectsForAircraftModel As Boolean, ByVal ProspectsForOtherAircraftModel As Boolean) As DataTable

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim aTempTable As New DataTable
    Try
      'Setting up the query strings and some of the parameters. 
      Dim squery As String = ""
      Dim lnote_status As String = ""
      Dim order_by As String = " lnote_entry_date desc"

      squery = "SELECT local_notes.lnote_id, local_notes.lnote_jetnet_ac_id, local_notes.lnote_opportunity_status, local_notes.lnote_jetnet_comp_id, local_notes.lnote_client_ac_id, local_notes.lnote_client_comp_id, "
      squery = squery & "local_notes.lnote_jetnet_contact_id, local_notes.lnote_client_contact_id, LEFT(local_notes.lnote_note, 21000) AS lnote_note, local_notes.lnote_entry_date, "
      squery = squery & "local_notes.lnote_action_date, local_notes.lnote_user_login, local_notes.lnote_user_name, local_notes.lnote_notecat_key, local_notes.lnote_status, "
      squery = squery & "local_notes.lnote_schedule_start_date, local_notes.lnote_schedule_end_date, local_notes.lnote_user_id, local_notes.lnote_clipri_ID, "
      squery = squery & "local_notes.lnote_document_flag, local_notes.lnote_jetnet_amod_id, 0 as lnote_jetnet_yacht_id, local_notes.lnote_client_amod_id, local_notes.lnote_document_name "
      squery = squery & "FROM local_notes "


      squery = squery & " LEFT OUTER JOIN "
      squery = squery & "client_user ON local_notes.lnote_user_id = client_user.cliuser_user_id "

      lnote_status = " (local_notes.lnote_status = 'B' ) and  "

      If OnlyProspectsForAircraft Then
        If ac_jetnet_id > 0 Then 'Aircraft Jetnet Side Data
          squery += "WHERE " & lnote_status
          squery += " (local_notes.lnote_jetnet_ac_id ='" & ac_jetnet_id & "') "
          squery += "ORDER BY " & order_by
        ElseIf ac_client_ID > 0 Then 'Client Side Data
          squery += "WHERE  " & lnote_status & " (local_notes.lnote_client_ac_id = '" & ac_client_ID & "') "
          squery += " ORDER BY " & order_by
        End If
      ElseIf ProspectsForAircraftModel Then

        If ac_jetnet_id > 0 Then 'Aircraft Jetnet Side Data
          squery += "WHERE " & lnote_status
          squery += " (local_notes.lnote_jetnet_ac_id ='" & ac_jetnet_id & "' "
        ElseIf ac_client_ID > 0 Then 'Client Side Data
          squery += "WHERE  " & lnote_status & " (local_notes.lnote_client_ac_id = '" & ac_client_ID & "' "
        End If

        squery += " or "
        If model_jetnet_id > 0 Then 'Aircraft Jetnet Side Data
          squery += " (lnote_jetnet_ac_id = 0 and lnote_client_ac_id = 0) and (local_notes.lnote_jetnet_amod_id ='" & model_jetnet_id & "') "
        ElseIf model_client_id > 0 Then 'Client Side Data
          squery += " (lnote_jetnet_ac_id = 0 and lnote_client_ac_id = 0) and (local_notes.lnote_client_amod_id ='" & model_client_id & "') "
        End If

        squery += ")"
        squery += " ORDER BY " & order_by

      ElseIf ProspectsForOtherAircraftModel Then

        squery += "WHERE " & lnote_status

        If model_jetnet_id > 0 Then 'Aircraft Jetnet Side Data
          squery += " (local_notes.lnote_jetnet_amod_id ='" & model_jetnet_id & "') "
        ElseIf model_client_id > 0 Then 'Client Side Data
          squery += " (local_notes.lnote_client_amod_id ='" & model_client_id & "') "
        End If
        squery += " ORDER BY " & order_by
      End If

      If company_jetnet_ID > 0 Then 'Jetnet SIDE Data
        squery += "WHERE  " & lnote_status & " (local_notes.lnote_jetnet_comp_id = '" & company_jetnet_ID & "') "
        squery += "ORDER BY " & order_by
      ElseIf company_client_ID > 0 Then 'Client Side Data
        squery += "WHERE  " & lnote_status & " (local_notes.lnote_client_comp_id = '" & company_client_ID & "') "
        squery += "ORDER BY " & order_by
      End If

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>ChangeProspectNotesByParameters(ByVal company_client_ID As Long, ByVal company_jetnet_ID As Long, ByVal ac_client_ID As Long, ByVal ac_jetnet_id As Long, ByVal model_client_id As Long, ByVal model_jetnet_id As Long, ByVal OnlyProspectsForAircraft As Boolean, ByVal ProspectsForAircraftModel As Boolean, ByVal ProspectsForOtherAircraftModel As Boolean) As DataTable:</b><br />" & squery


      MySqlCommand.CommandText = squery
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable
    Catch ex As Exception
      ChangeProspectNotesByParameters = Nothing
      Me.class_error = "Error in SQL ChangeProspectNotesByParameters(ByVal company_client_ID As Long, ByVal company_jetnet_ID As Long, ByVal ac_client_ID As Long, ByVal ac_jetnet_id As Long, ByVal model_client_id As Long, ByVal model_jetnet_id As Long, ByVal OnlyProspectsForAircraft As Boolean, ByVal ProspectsForAircraftModel As Boolean, ByVal ProspectsForOtherAircraftModel As Boolean) As DataTable: " & ex.Message
    Finally
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function


  ''' <summary>
  ''' This function searches the jetnet side for both the jetnet acIDs that are being sent in the lnote table as well as the ser/reg/etc search + operator + search text that's being sent.
  ''' </summary>
  ''' <param name="LnoteTable"></param>
  ''' <param name="acSearchOperator"></param>
  ''' <param name="acSearchText"></param>
  ''' <param name="acSearchField"></param>
  ''' <remarks></remarks>
  Public Sub SearchJetnetSideForACIDPlusNotesACSearch(ByRef LnoteTable As DataTable, ByRef acSearchOperator As Integer, ByRef acSearchText As String, ByRef acSearchField As Integer)
    Dim TemporaryAircraftTable As New DataTable
    Dim ClientTable As New DataTable
    Dim JetnetTable As New DataTable
    Dim ReturnTable As New DataTable
    Dim acIDs As String = ""
    Dim ReturnSearchacIDs As String = "" 'a list of jetnet ac IDs that count after searched the database - matching the search params.
    Try
      If Not IsNothing(LnoteTable) Then
        'We need  to clone the schema on the table.
        ClientTable = LnoteTable.Clone
        JetnetTable = LnoteTable.Clone
        ReturnTable = LnoteTable.Clone

        'First of all, let's go ahead and filter this one.
        'We only need the rows where the client ID = 0 in the jetnet Table and the jetnetID = 0 in the client table.
        For Each r As DataRow In LnoteTable.Rows
          If r("lnote_client_ac_id") > 0 Then
            ClientTable.ImportRow(r)
          ElseIf r("lnote_jetnet_ac_id") > 0 Then
            JetnetTable.ImportRow(r)
            If acIDs <> "" Then
              acIDs += ","
            End If
            acIDs += r("lnote_jetnet_ac_id").ToString
          End If
        Next

        'We need to put the client table into the return table first.
        ReturnTable = ClientTable.Copy

        If acSearchText <> "" Then
          If acIDs <> "" Then
            'Perform the aircraft search to get the list of IDs from the jetnet (only) data
            TemporaryAircraftTable = AC_Search("AMOD_MAKE_NAME ASC, AMOD_MODEL_NAME ASC, AC_SER_NBR_SORT ASC", "J", "", acIDs, "", acSearchText, "", "", "", "", "", "", "", "", "", HttpContext.Current.Session.Item("localSubscription").crmHelicopter_Flag, HttpContext.Current.Session.Item("localSubscription").crmBusiness_Flag, HttpContext.Current.Session.Item("localSubscription").crmJets_Flag, HttpContext.Current.Session.Item("localSubscription").crmExecutive_Flag, HttpContext.Current.Session.Item("localSubscription").crmTurboprops, HttpContext.Current.Session.Item("localSubscription").crmCommercial_Flag, HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag, "", "", "", "", acSearchField, acSearchOperator.ToString, "", "", "", "", "", "", "", "", "", "", "", "", 0, False)

            'Now that I have the temporary aircraft table of aircraft that count towards this search
            If Not IsNothing(TemporaryAircraftTable) Then
              If TemporaryAircraftTable.Rows.Count > 0 Then
                For Each r As DataRow In TemporaryAircraftTable.Rows
                  If ReturnSearchacIDs <> "" Then
                    ReturnSearchacIDs += ","
                  End If
                  'Store these to the variable.
                  ReturnSearchacIDs += r("ac_id").ToString
                Next
              End If
            End If

            'If  the return search ac IDs are blank, there's no ned to import any jetnet rows into the table because
            'there weren't any that matched.
            If ReturnSearchacIDs <> "" Then
              'Next we need to filter the jetnet table and only get the ones that are in our returnsearchacIds variable.
              Dim afileteredTable As DataRow() = JetnetTable.Select(" lnote_jetnet_ac_id in (" & ReturnSearchacIDs & ")", "")
              ' create another datarow to import the filtered info
              For Each atmpDataRow As DataRow In afileteredTable
                ReturnTable.ImportRow(atmpDataRow)
              Next
            End If


          End If
        End If
      End If
    Catch ex As Exception
      Me.class_error = "Error in SearchJetnetSideForACIDPlusNotesACSearch(): " & ex.Message
    Finally
      TemporaryAircraftTable.Dispose()
      ClientTable.Dispose()
      JetnetTable.Dispose()
    End Try

    LnoteTable = ReturnTable
  End Sub


  Public Function BuildACProspectList(ByVal status As String) As DataTable

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing

    Try
      ' create the Select Strings
      Dim aSQL_String_Client_Select As String = ""
      ' create the Where string
      Dim aSQL_String_Client_Where As String = ""
      Dim atemptable As New DataTable
      Dim ReturnTableSorted As New DataTable



      '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
      '----------------------------------------------------------- check to see if we are getting client data---------------------------------------------------
      '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

      '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
      ' ---------------------------------------------------------Setup the Client SQL Strings---------------------------------------------------------------
      '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

      'These are the basic fields needed for the company export. 

      aSQL_String_Client_Select = "SELECT distinct lnote_jetnet_ac_id, lnote_client_ac_id "
      aSQL_String_Client_Select += "FROM local_notes "


      atemptable.Columns.Add("lnote_jetnet_ac_id")
      atemptable.Columns.Add("lnote_client_ac_id")

      atemptable.Columns.Add("amod_id")
      atemptable.Columns.Add("amod_make_name")
      atemptable.Columns.Add("amod_model_name")
      atemptable.Columns.Add("ac_reg_nbr")
      atemptable.Columns.Add("ac_ser_nbr")
      atemptable.Columns.Add("ac_id")

      Dim AndQ As String = ""
      'The Building of the Where Clause 

      If HttpContext.Current.Session.Item("localUser").crmUserType = eUserTypes.MyNotesOnly Then
        aSQL_String_Client_Where += " local_notes.lnote_user_id = '" & HttpContext.Current.Session.Item("localUser").crmLocalUserID.ToString & "' and "
      End If

      aSQL_String_Client_Where += " (lnote_status = 'B')"

      If status <> "" Then
        aSQL_String_Client_Where += " and (lnote_opportunity_status = '" & status & "')"
      End If


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      Dim sQuery As String = aSQL_String_Client_Select & " WHERE " & aSQL_String_Client_Where


      MySqlCommand.CommandText = sQuery

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Notes_Search(ByVal note_search As String, ByVal note_start_date As String, ByVal note_end_date As String, ByVal note_type As String, ByVal category As String, ByVal jetnet_amod_id As String, ByVal client_amod_id As String, ByVal user As String, ByVal opp_status As String) As DataTable <em>Client Side</em></b><br />" & sQuery


      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      While MySqlReader.Read()
        Dim AircraftInformation As New DataTable

        If MySqlReader.Item("lnote_client_ac_id") <> 0 Then
          Dim newCustomersRow As DataRow = atemptable.NewRow()
          newCustomersRow.Item("lnote_jetnet_ac_id") = MySqlReader.Item("lnote_jetnet_ac_id")
          newCustomersRow.Item("lnote_client_ac_id") = MySqlReader.Item("lnote_client_ac_id")

          'This means that this is attached to a client aircraft and that takes precedence.
          AircraftInformation = Get_Clients_Aircraft_Ser_Model(MySqlReader.Item("lnote_client_ac_id"))
          If Not IsNothing(AircraftInformation) Then
            If AircraftInformation.Rows.Count > 0 Then
              newCustomersRow.Item("amod_make_name") = AircraftInformation.Rows(0).Item("cliamod_make_name")
              newCustomersRow.Item("amod_model_name") = AircraftInformation.Rows(0).Item("cliamod_model_name")
              newCustomersRow.Item("amod_id") = AircraftInformation.Rows(0).Item("cliamod_id")

              newCustomersRow.Item("ac_reg_nbr") = AircraftInformation.Rows(0).Item("cliaircraft_reg_nbr")
              newCustomersRow.Item("ac_ser_nbr") = AircraftInformation.Rows(0).Item("cliaircraft_ser_nbr")
              newCustomersRow.Item("ac_id") = AircraftInformation.Rows(0).Item("cliaircraft_id")
            End If

          End If

          atemptable.Rows.Add(newCustomersRow)
          atemptable.AcceptChanges()

        ElseIf MySqlReader.Item("lnote_jetnet_ac_id") <> 0 Then
          Dim newCustomersRow As DataRow = atemptable.NewRow()
          newCustomersRow.Item("lnote_jetnet_ac_id") = MySqlReader.Item("lnote_jetnet_ac_id")
          newCustomersRow.Item("lnote_client_ac_id") = MySqlReader.Item("lnote_client_ac_id")

          'otherwise this has a jetnet aircraft
          AircraftInformation = GetJETNET_AC_NAME(MySqlReader.Item("lnote_jetnet_ac_id"), "")
          If Not IsNothing(AircraftInformation) Then
            If AircraftInformation.Rows.Count > 0 Then
              newCustomersRow.Item("amod_make_name") = AircraftInformation.Rows(0).Item("amod_make_name")
              newCustomersRow.Item("amod_model_name") = AircraftInformation.Rows(0).Item("amod_model_name")
              newCustomersRow.Item("amod_id") = AircraftInformation.Rows(0).Item("amod_id")

              newCustomersRow.Item("ac_reg_nbr") = AircraftInformation.Rows(0).Item("ac_reg_nbr")
              newCustomersRow.Item("ac_ser_nbr") = AircraftInformation.Rows(0).Item("ac_ser_nbr")
              newCustomersRow.Item("ac_id") = AircraftInformation.Rows(0).Item("ac_id")
            End If
          End If

          atemptable.Rows.Add(newCustomersRow)
          atemptable.AcceptChanges()
        End If


      End While


      ReturnTableSorted = atemptable.Clone
      Dim afileterd As DataRow() = atemptable.Select("", "amod_make_name, amod_model_name, ac_ser_nbr")
      ' create another datarow to import the filtered info
      For Each atmpDataRow As DataRow In afileterd
        ReturnTableSorted.ImportRow(atmpDataRow)
      Next

      BuildACProspectList = ReturnTableSorted

      ReturnTableSorted = Nothing
      atemptable = Nothing

    Catch ex As Exception
      BuildACProspectList = Nothing
      Me.class_error = "Error in BuildACProspectList(): " & ex.Message
    Finally
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing

    End Try
  End Function
  Public Function Notes_FillupSearch_WithoutClient(ByVal notesTable As DataTable, ByVal sortingString As String) As DataTable


    Try
      ' create the Select Strings
      Dim aSQL As String = ""

      ' create a data table to hold the returned info
      Dim returnTable As New DataTable
      Dim returnTableSorted As New DataTable
      '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
      '----------------------------------------------------------- check to see if we are getting client data---------------------------------------------------
      '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

      aSQL = ""

      returnTable.Columns.Add("lnote_id")
      returnTable.Columns.Add("lnote_opportunity_status")
      returnTable.Columns.Add("lnote_cash_value")
      returnTable.Columns.Add("lnote_capture_percentage")
      returnTable.Columns.Add("lnote_jetnet_comp_id")
      returnTable.Columns.Add("lnote_jetnet_ac_id")
      returnTable.Columns.Add("lnote_jetnet_contact_id")
      returnTable.Columns.Add("lnote_client_comp_id")
      returnTable.Columns.Add("lnote_client_ac_id")
      returnTable.Columns.Add("lnote_client_contact_id")
      returnTable.Columns.Add("lnote_note")
      returnTable.Columns.Add("lnote_entry_date")
      returnTable.Columns.Add("lnote_action_date")
      returnTable.Columns.Add("lnote_user_login")
      returnTable.Columns.Add("lnote_user_name")
      returnTable.Columns.Add("lnote_notecat_key")
      returnTable.Columns.Add("lnote_schedule_start_date")
      returnTable.Columns.Add("lnote_schedule_end_date")
      returnTable.Columns.Add("lnote_user_id")
      returnTable.Columns.Add("lnote_clipri_ID")
      returnTable.Columns.Add("lnote_status")
      returnTable.Columns.Add("clipri_name")
      returnTable.Columns.Add("clipri_sort_order")
      returnTable.Columns.Add("lnote_document_flag")
      returnTable.Columns.Add("lnote_jetnet_amod_id")
      returnTable.Columns.Add("lnote_client_amod_id")
      returnTable.Columns.Add("lnote_document_name")
      returnTable.Columns.Add("cliuser_first_name")
      returnTable.Columns.Add("cliuser_last_name")
      returnTable.Columns.Add("oppcat")


      'Company Tables.
      returnTable.Columns.Add("comp_name")
      returnTable.Columns.Add("comp_address1")
      returnTable.Columns.Add("comp_address2")
      returnTable.Columns.Add("comp_city")
      returnTable.Columns.Add("comp_state")
      returnTable.Columns.Add("comp_country")
      returnTable.Columns.Add("comp_zip_code")
      returnTable.Columns.Add("comp_id")
      returnTable.Columns.Add("comp_description")
      returnTable.Columns.Add("comp_email_address")
      returnTable.Columns.Add("comp_source")
      returnTable.Columns.Add("comp_phone_office")
      returnTable.Columns.Add("comp_phone_fax")

      'Aircraft
      returnTable.Columns.Add("amod_model_name")
      returnTable.Columns.Add("amod_make_name")
      returnTable.Columns.Add("ac_ser_nbr")
      returnTable.Columns.Add("ac_reg_nbr")
      returnTable.Columns.Add("ac_year_mfr")
      returnTable.Columns.Add("ac_id")
      returnTable.Columns.Add("ac_source")
      returnTable.Columns.Add("ac_date_purchased")
      returnTable.Columns.Add("ac_forsale_flag")
      returnTable.Columns.Add("ac_status")
      returnTable.Columns.Add("ac_delivery")
      returnTable.Columns.Add("ac_asking_wordage")
      returnTable.Columns.Add("ac_asking_price")
      returnTable.Columns.Add("ac_est_price")
      returnTable.Columns.Add("ac_date_listed")
      returnTable.Columns.Add("ac_exclusive_flag")
      returnTable.Columns.Add("ac_lease_flag")

      'Refinement.
      '1.) We need to loop through the table sent here:
      '2.) We need to check the company information first.
      '2.) a.) We need to check for a client company ID.
      '2.) b.) If there is a client company ID, then we fill our table based on that information we've already grabbed from the database because of joins.
      '2.) c.) If there is not a client company ID, we check for a jetnet company ID.
      '2.) d.) If there is a jetnet company ID, we fill up our table based on information from jetnet.
      '3.) We now check for the aircraft information.
      '3.) a.) If there is a client aircraft ID, then we fill our information based on that information we've already grabbed from the database because of joins.
      '3.) b.) If there is not a client aircraft ID, then we check for a jetnet aircraft ID.
      '4.) c.) If there is a jetnet aircraft ID, we go ahead and search based on that and fill our table up with information based on jetnet.
      '5.) We repeat for however many prospects there are.
      '6.) We sort the information.
      '7.) We send the information back.

      For Each noteElement As DataRow In notesTable.Rows '1.) We need to loop through the table sent here:

        Dim newRow As DataRow = returnTable.NewRow()
        Dim TemporaryCompanyInformation As New DataTable
        Dim TemporaryAircraftInformation As New DataTable
        Dim TemporaryModelInformation As New DataTable

        '2.) We need to check the company information first.
        '2.) a.) We need to check for a client company ID.
        If noteElement("lnote_client_comp_id") > 0 Then
          '2.) b.) If there is a client company ID, then we fill our table based on that information.

          newRow.Item("comp_id") = noteElement("comp_id")
          newRow.Item("comp_source") = "CLIENT"

          newRow.Item("comp_name") = noteElement("comp_name")
          newRow.Item("comp_address1") = noteElement("comp_address1")
          newRow.Item("comp_address2") = noteElement("comp_address2")
          newRow.Item("comp_city") = noteElement("comp_city")
          newRow.Item("comp_state") = noteElement("comp_state")
          newRow.Item("comp_country") = noteElement("comp_country")
          newRow.Item("comp_zip_code") = noteElement("comp_zip_code")
          newRow.Item("comp_description") = noteElement("comp_description")
          newRow.Item("comp_email_address") = noteElement("comp_email_address")

          newRow.Item("comp_phone_office") = noteElement("comp_phone_office")
          newRow.Item("comp_phone_fax") = noteElement("comp_phone_fax")

        ElseIf noteElement("lnote_jetnet_comp_id") > 0 Then
          '2.) d.) If there is a jetnet company ID, we fill up our table based on information from jetnet.
          TemporaryCompanyInformation = GetCompanyInfo_ID_WithPhoneNumber(noteElement("lnote_jetnet_comp_id"), "JETNET", 0)


          If Not IsNothing(TemporaryCompanyInformation) Then
            If TemporaryCompanyInformation.Rows.Count > 0 Then
              newRow.Item("comp_id") = TemporaryCompanyInformation.Rows(0).Item("comp_id")
              newRow.Item("comp_source") = TemporaryCompanyInformation.Rows(0).Item("source")

              newRow.Item("comp_name") = TemporaryCompanyInformation.Rows(0).Item("comp_name")
              newRow.Item("comp_address1") = TemporaryCompanyInformation.Rows(0).Item("comp_address1")
              newRow.Item("comp_address2") = TemporaryCompanyInformation.Rows(0).Item("comp_address2")
              newRow.Item("comp_city") = TemporaryCompanyInformation.Rows(0).Item("comp_city")
              newRow.Item("comp_state") = TemporaryCompanyInformation.Rows(0).Item("comp_state")
              newRow.Item("comp_country") = TemporaryCompanyInformation.Rows(0).Item("comp_country")
              newRow.Item("comp_zip_code") = TemporaryCompanyInformation.Rows(0).Item("comp_zip_code")
              newRow.Item("comp_description") = TemporaryCompanyInformation.Rows(0).Item("clicomp_description")
              newRow.Item("comp_email_address") = TemporaryCompanyInformation.Rows(0).Item("comp_email_address")

              newRow.Item("comp_phone_office") = TemporaryCompanyInformation.Rows(0).Item("comp_phone_office")
              newRow.Item("comp_phone_fax") = TemporaryCompanyInformation.Rows(0).Item("comp_phone_fax")

            End If
          End If
        End If

        '3.) We now check for the aircraft information.
        If noteElement("lnote_client_ac_id") > 0 Then
          '3.) a.) If there is a client aircraft ID, then we fill our information based on that information.
          newRow.Item("amod_model_name") = noteElement("amod_model_name")
          newRow.Item("amod_make_name") = noteElement("amod_make_name")
          newRow.Item("ac_ser_nbr") = noteElement("ac_ser_nbr")
          newRow.Item("ac_reg_nbr") = noteElement("ac_reg_nbr")
          newRow.Item("ac_year_mfr") = noteElement("ac_year_mfr")
          newRow.Item("ac_id") = noteElement("ac_id")
          newRow.Item("ac_source") = "CLIENT"
          newRow.Item("ac_date_purchased") = noteElement("ac_date_purchased")
          newRow.Item("ac_forsale_flag") = noteElement("ac_forsale_flag")
          newRow.Item("ac_status") = noteElement("ac_status")
          newRow.Item("ac_delivery") = noteElement("ac_delivery")
          newRow.Item("ac_asking_wordage") = noteElement("ac_asking_wordage")
          newRow.Item("ac_asking_price") = noteElement("ac_asking_price")
          newRow.Item("ac_est_price") = noteElement("ac_est_price")
          newRow.Item("ac_date_listed") = noteElement("ac_date_listed")
          newRow.Item("ac_exclusive_flag") = noteElement("ac_exclusive_flag")
          newRow.Item("ac_lease_flag") = noteElement("ac_lease_flag")

        ElseIf noteElement("lnote_jetnet_ac_id") > 0 Then
          '3.) b.) If there is not a client aircraft ID, then we check for a jetnet aircraft ID.
          '4.) c.) If there is a jetnet aircraft ID, we go ahead and search based on that and fill our table up with information based on jetnet.
          TemporaryAircraftInformation = GetJETNET_Aircraft_Details_AC_ID(noteElement("lnote_jetnet_ac_id"), "")
          If Not IsNothing(TemporaryAircraftInformation) Then
            If TemporaryAircraftInformation.Rows.Count > 0 Then
              newRow.Item("amod_model_name") = TemporaryAircraftInformation.Rows(0).Item("amod_model_name")
              newRow.Item("amod_make_name") = TemporaryAircraftInformation.Rows(0).Item("amod_make_name")
              newRow.Item("ac_ser_nbr") = TemporaryAircraftInformation.Rows(0).Item("ac_ser_nbr")
              newRow.Item("ac_reg_nbr") = TemporaryAircraftInformation.Rows(0).Item("ac_reg_nbr")
              newRow.Item("ac_year_mfr") = TemporaryAircraftInformation.Rows(0).Item("ac_year_mfr")

              newRow.Item("ac_id") = TemporaryAircraftInformation.Rows(0).Item("ac_id")
              newRow.Item("ac_source") = "JETNET"


              newRow.Item("ac_date_purchased") = TemporaryAircraftInformation.Rows(0).Item("ac_date_purchased")
              newRow.Item("ac_forsale_flag") = TemporaryAircraftInformation.Rows(0).Item("ac_forsale_flag")
              newRow.Item("ac_status") = TemporaryAircraftInformation.Rows(0).Item("ac_status")
              newRow.Item("ac_delivery") = TemporaryAircraftInformation.Rows(0).Item("ac_delivery")
              newRow.Item("ac_asking_wordage") = TemporaryAircraftInformation.Rows(0).Item("ac_asking_wordage")
              newRow.Item("ac_asking_price") = TemporaryAircraftInformation.Rows(0).Item("ac_asking_price")
              newRow.Item("ac_date_listed") = TemporaryAircraftInformation.Rows(0).Item("ac_date_listed")
              newRow.Item("ac_exclusive_flag") = TemporaryAircraftInformation.Rows(0).Item("ac_exclusive_flag")
              newRow.Item("ac_lease_flag") = TemporaryAircraftInformation.Rows(0).Item("ac_lease_flag")
            End If
          End If
        ElseIf noteElement("lnote_jetnet_ac_id") = 0 And noteElement("lnote_client_ac_id") = 0 Then
          If noteElement("lnote_jetnet_amod_id") > 0 Then
            newRow.Item("amod_model_name") = "TEST"

            TemporaryModelInformation = Get_JETNET_Aircraft_Model_amodID(noteElement("lnote_jetnet_amod_id"))
            If Not IsNothing(TemporaryModelInformation) Then
              If TemporaryModelInformation.Rows.Count > 0 Then
                If Not IsDBNull(TemporaryModelInformation.Rows(0).Item("amod_model_name")) Then
                  newRow.Item("amod_model_name") = TemporaryModelInformation.Rows(0).Item("amod_model_name").ToString
                End If
                If Not IsDBNull(TemporaryModelInformation.Rows(0).Item("amod_make_name")) Then
                  newRow.Item("amod_make_name") = TemporaryModelInformation.Rows(0).Item("amod_make_name").ToString
                End If
              End If
            End If
          ElseIf noteElement("lnote_client_amod_id") > 0 Then
            newRow.Item("amod_model_name") = noteElement("cliamod_model_name").ToString
            newRow.Item("amod_make_name") = noteElement("cliamod_make_name").ToString
          End If
        End If



        newRow.Item("lnote_id") = noteElement("lnote_id")
        newRow.Item("lnote_jetnet_comp_id") = noteElement("lnote_jetnet_comp_id")
        newRow.Item("lnote_jetnet_ac_id") = noteElement("lnote_jetnet_ac_id")
        newRow.Item("lnote_jetnet_contact_id") = noteElement("lnote_jetnet_contact_id")
        newRow.Item("lnote_client_comp_id") = noteElement("lnote_client_comp_id")
        newRow.Item("lnote_client_ac_id") = noteElement("lnote_client_ac_id")
        newRow.Item("lnote_client_contact_id") = noteElement("lnote_client_contact_id")
        newRow.Item("lnote_note") = noteElement("lnote_note")
        newRow.Item("lnote_entry_date") = noteElement("lnote_entry_date")
        newRow.Item("lnote_action_date") = noteElement("lnote_action_date")
        newRow.Item("lnote_user_login") = noteElement("lnote_user_login")
        newRow.Item("lnote_user_name") = noteElement("lnote_user_name")
        newRow.Item("lnote_notecat_key") = noteElement("lnote_notecat_key")
        newRow.Item("lnote_schedule_start_date") = noteElement("lnote_schedule_start_date")
        newRow.Item("lnote_schedule_end_date") = noteElement("lnote_schedule_end_date")
        newRow.Item("lnote_user_id") = noteElement("lnote_user_id")
        newRow.Item("lnote_status") = noteElement("lnote_status")
        newRow.Item("lnote_clipri_ID") = noteElement("lnote_clipri_ID")
        newRow.Item("clipri_name") = noteElement("clipri_name")
        newRow.Item("clipri_sort_order") = noteElement("clipri_sort_order")
        newRow.Item("lnote_document_flag") = noteElement("lnote_document_flag")
        newRow.Item("lnote_jetnet_amod_id") = noteElement("lnote_jetnet_amod_id")
        newRow.Item("lnote_client_amod_id") = noteElement("lnote_client_amod_id")
        newRow.Item("lnote_document_name") = noteElement("lnote_document_name")
        newRow.Item("lnote_opportunity_status") = noteElement("lnote_opportunity_status")
        newRow.Item("lnote_cash_value") = noteElement("lnote_cash_value")
        newRow.Item("lnote_capture_percentage") = noteElement("lnote_capture_percentage")

        newRow.Item("cliuser_first_name") = noteElement("cliuser_first_name")
        newRow.Item("cliuser_last_name") = noteElement("cliuser_last_name")
        newRow.Item("oppcat") = noteElement("oppcat")

        returnTable.Rows.Add(newRow)
        returnTable.AcceptChanges()


      Next '5.) We repeat for however many prospects there are.


      returnTableSorted = returnTable.Clone
      Dim afileterd As DataRow() = returnTable.Select("", sortingString)
      ' create another datarow to import the filtered info
      For Each atmpDataRow As DataRow In afileterd
        returnTableSorted.ImportRow(atmpDataRow)
      Next


      Return returnTableSorted '7.) We send the information back.
    Catch ex As Exception
      Notes_FillupSearch_WithoutClient = Nothing
      Me.class_error = "Error in Notes_FillupSearch(): " & ex.Message
    Finally

      notesTable.Dispose()
    End Try
  End Function
  Public Function Notes_FillupSearch(ByVal notesTable As DataTable, ByVal sortingString As String) As DataTable


    Try
      ' create the Select Strings
      Dim aSQL As String = ""

      ' create a data table to hold the returned info
      Dim returnTable As New DataTable
      Dim returnTableSorted As New DataTable
      '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
      '----------------------------------------------------------- check to see if we are getting client data---------------------------------------------------
      '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

      aSQL = ""

      returnTable.Columns.Add("lnote_id")
      returnTable.Columns.Add("lnote_opportunity_status")
      returnTable.Columns.Add("lnote_cash_value")
      returnTable.Columns.Add("lnote_capture_percentage")
      returnTable.Columns.Add("lnote_jetnet_comp_id")
      returnTable.Columns.Add("lnote_jetnet_ac_id")
      returnTable.Columns.Add("lnote_jetnet_contact_id")
      returnTable.Columns.Add("lnote_client_comp_id")
      returnTable.Columns.Add("lnote_client_ac_id")
      returnTable.Columns.Add("lnote_client_contact_id")
      returnTable.Columns.Add("lnote_note")
      returnTable.Columns.Add("lnote_entry_date")
      returnTable.Columns.Add("lnote_action_date")
      returnTable.Columns.Add("lnote_user_login")
      returnTable.Columns.Add("lnote_user_name")
      returnTable.Columns.Add("lnote_notecat_key")
      returnTable.Columns.Add("lnote_schedule_start_date")
      returnTable.Columns.Add("lnote_schedule_end_date")
      returnTable.Columns.Add("lnote_user_id")
      returnTable.Columns.Add("lnote_clipri_ID")
      returnTable.Columns.Add("lnote_status")
      returnTable.Columns.Add("clipri_name")
      returnTable.Columns.Add("clipri_sort_order")
      returnTable.Columns.Add("lnote_document_flag")
      returnTable.Columns.Add("lnote_jetnet_amod_id")
      returnTable.Columns.Add("lnote_client_amod_id")
      returnTable.Columns.Add("lnote_document_name")


      'Company Tables.
      returnTable.Columns.Add("comp_name")
      returnTable.Columns.Add("comp_address1")
      returnTable.Columns.Add("comp_address2")
      returnTable.Columns.Add("comp_city")
      returnTable.Columns.Add("comp_state")
      returnTable.Columns.Add("comp_country")
      returnTable.Columns.Add("comp_zip_code")
      returnTable.Columns.Add("comp_id")
      returnTable.Columns.Add("comp_description")
      returnTable.Columns.Add("comp_email_address")
      returnTable.Columns.Add("comp_source")
      returnTable.Columns.Add("comp_phone_office")
      returnTable.Columns.Add("comp_phone_fax")

      'Aircraft
      returnTable.Columns.Add("amod_model_name")
      returnTable.Columns.Add("amod_make_name")
      returnTable.Columns.Add("ac_ser_nbr")
      returnTable.Columns.Add("ac_reg_nbr")
      returnTable.Columns.Add("ac_year_mfr")
      returnTable.Columns.Add("ac_id")
      returnTable.Columns.Add("ac_source")
      returnTable.Columns.Add("ac_date_purchased")
      returnTable.Columns.Add("ac_forsale_flag")
      returnTable.Columns.Add("ac_status")
      returnTable.Columns.Add("ac_delivery")
      returnTable.Columns.Add("ac_asking_wordage")
      returnTable.Columns.Add("ac_asking_price")
      returnTable.Columns.Add("ac_est_price")
      returnTable.Columns.Add("ac_date_listed")
      returnTable.Columns.Add("ac_exclusive_flag")
      returnTable.Columns.Add("ac_lease_flag")

      'Refinement.
      '1.) We need to loop through the table sent here:
      '2.) We need to check the company information first.
      '2.) a.) We need to check for a client company ID.
      '2.) b.) If there is a client company ID, then we fill our table based on that information.
      '2.) c.) If there is not a client company ID, we check for a jetnet company ID.
      '2.) d.) If there is a jetnet company ID, we fill up our table based on information from jetnet.
      '3.) We now check for the aircraft information.
      '3.) a.) If there is a client aircraft ID, then we fill our information based on that information.
      '3.) b.) If there is not a client aircraft ID, then we check for a jetnet aircraft ID.
      '4.) c.) If there is a jetnet aircraft ID, we go ahead and search based on that and fill our table up with information based on jetnet.
      '5.) We repeat for however many prospects there are.
      '6.) We sort the information.
      '7.) We send the information back.

      For Each noteElement As DataRow In notesTable.Rows '1.) We need to loop through the table sent here:

        Dim newRow As DataRow = returnTable.NewRow()
        Dim TemporaryCompanyInformation As New DataTable
        Dim TemporaryAircraftInformation As New DataTable
        Dim TemporaryModelInformation As New DataTable

        '2.) We need to check the company information first.
        '2.) a.) We need to check for a client company ID.
        If noteElement("lnote_client_comp_id") > 0 Then
          '2.) b.) If there is a client company ID, then we fill our table based on that information.
          TemporaryCompanyInformation = GetCompanyInfo_ID_WithPhoneNumber(noteElement("lnote_client_comp_id"), "CLIENT", 0)
        ElseIf noteElement("lnote_jetnet_comp_id") > 0 Then
          '2.) d.) If there is a jetnet company ID, we fill up our table based on information from jetnet.
          TemporaryCompanyInformation = GetCompanyInfo_ID_WithPhoneNumber(noteElement("lnote_jetnet_comp_id"), "JETNET", 0)
        End If

        If Not IsNothing(TemporaryCompanyInformation) Then
          If TemporaryCompanyInformation.Rows.Count > 0 Then
            newRow.Item("comp_id") = TemporaryCompanyInformation.Rows(0).Item("comp_id")
            newRow.Item("comp_source") = TemporaryCompanyInformation.Rows(0).Item("source")

            newRow.Item("comp_name") = TemporaryCompanyInformation.Rows(0).Item("comp_name")
            newRow.Item("comp_address1") = TemporaryCompanyInformation.Rows(0).Item("comp_address1")
            newRow.Item("comp_address2") = TemporaryCompanyInformation.Rows(0).Item("comp_address2")
            newRow.Item("comp_city") = TemporaryCompanyInformation.Rows(0).Item("comp_city")
            newRow.Item("comp_state") = TemporaryCompanyInformation.Rows(0).Item("comp_state")
            newRow.Item("comp_country") = TemporaryCompanyInformation.Rows(0).Item("comp_country")
            newRow.Item("comp_zip_code") = TemporaryCompanyInformation.Rows(0).Item("comp_zip_code")
            newRow.Item("comp_description") = TemporaryCompanyInformation.Rows(0).Item("clicomp_description")
            newRow.Item("comp_email_address") = TemporaryCompanyInformation.Rows(0).Item("comp_email_address")

            newRow.Item("comp_phone_office") = TemporaryCompanyInformation.Rows(0).Item("comp_phone_office")
            newRow.Item("comp_phone_fax") = TemporaryCompanyInformation.Rows(0).Item("comp_phone_fax")

          End If
        End If

        '3.) We now check for the aircraft information.
        If noteElement("lnote_client_ac_id") > 0 Then
          '3.) a.) If there is a client aircraft ID, then we fill our information based on that information.
          TemporaryAircraftInformation = Get_Clients_Aircraft(noteElement("lnote_client_ac_id"))
          If Not IsNothing(TemporaryAircraftInformation) Then
            If TemporaryAircraftInformation.Rows.Count > 0 Then
              newRow.Item("amod_model_name") = TemporaryAircraftInformation.Rows(0).Item("cliamod_model_name")
              newRow.Item("amod_make_name") = TemporaryAircraftInformation.Rows(0).Item("cliamod_make_name")
              newRow.Item("ac_ser_nbr") = TemporaryAircraftInformation.Rows(0).Item("cliaircraft_ser_nbr")
              newRow.Item("ac_reg_nbr") = TemporaryAircraftInformation.Rows(0).Item("cliaircraft_reg_nbr")
              newRow.Item("ac_year_mfr") = TemporaryAircraftInformation.Rows(0).Item("cliaircraft_year_mfr")
              newRow.Item("ac_id") = TemporaryAircraftInformation.Rows(0).Item("cliaircraft_id")
              newRow.Item("ac_source") = "CLIENT"
              newRow.Item("ac_date_purchased") = TemporaryAircraftInformation.Rows(0).Item("cliaircraft_date_purchased")
              newRow.Item("ac_forsale_flag") = TemporaryAircraftInformation.Rows(0).Item("cliaircraft_forsale_flag")
              newRow.Item("ac_status") = TemporaryAircraftInformation.Rows(0).Item("cliaircraft_status")
              newRow.Item("ac_delivery") = TemporaryAircraftInformation.Rows(0).Item("cliaircraft_delivery")
              newRow.Item("ac_asking_wordage") = TemporaryAircraftInformation.Rows(0).Item("cliaircraft_asking_wordage")
              newRow.Item("ac_asking_price") = TemporaryAircraftInformation.Rows(0).Item("cliaircraft_asking_price")
              newRow.Item("ac_est_price") = TemporaryAircraftInformation.Rows(0).Item("cliaircraft_est_price")
              newRow.Item("ac_date_listed") = TemporaryAircraftInformation.Rows(0).Item("cliaircraft_date_listed")
              newRow.Item("ac_exclusive_flag") = TemporaryAircraftInformation.Rows(0).Item("cliaircraft_exclusive_flag")
              newRow.Item("ac_lease_flag") = TemporaryAircraftInformation.Rows(0).Item("cliaircraft_lease_flag")
            End If
          End If

        ElseIf noteElement("lnote_jetnet_ac_id") > 0 Then
          '3.) b.) If there is not a client aircraft ID, then we check for a jetnet aircraft ID.
          '4.) c.) If there is a jetnet aircraft ID, we go ahead and search based on that and fill our table up with information based on jetnet.
          TemporaryAircraftInformation = GetJETNET_Aircraft_Details_AC_ID(noteElement("lnote_jetnet_ac_id"), "")
          If Not IsNothing(TemporaryAircraftInformation) Then
            If TemporaryAircraftInformation.Rows.Count > 0 Then
              newRow.Item("amod_model_name") = TemporaryAircraftInformation.Rows(0).Item("amod_model_name")
              newRow.Item("amod_make_name") = TemporaryAircraftInformation.Rows(0).Item("amod_make_name")
              newRow.Item("ac_ser_nbr") = TemporaryAircraftInformation.Rows(0).Item("ac_ser_nbr")
              newRow.Item("ac_reg_nbr") = TemporaryAircraftInformation.Rows(0).Item("ac_reg_nbr")
              newRow.Item("ac_year_mfr") = TemporaryAircraftInformation.Rows(0).Item("ac_year_mfr")

              newRow.Item("ac_id") = TemporaryAircraftInformation.Rows(0).Item("ac_id")
              newRow.Item("ac_source") = "JETNET"


              newRow.Item("ac_date_purchased") = TemporaryAircraftInformation.Rows(0).Item("ac_date_purchased")
              newRow.Item("ac_forsale_flag") = TemporaryAircraftInformation.Rows(0).Item("ac_forsale_flag")
              newRow.Item("ac_status") = TemporaryAircraftInformation.Rows(0).Item("ac_status")
              newRow.Item("ac_delivery") = TemporaryAircraftInformation.Rows(0).Item("ac_delivery")
              newRow.Item("ac_asking_wordage") = TemporaryAircraftInformation.Rows(0).Item("ac_asking_wordage")
              newRow.Item("ac_asking_price") = TemporaryAircraftInformation.Rows(0).Item("ac_asking_price")
              newRow.Item("ac_date_listed") = TemporaryAircraftInformation.Rows(0).Item("ac_date_listed")
              newRow.Item("ac_exclusive_flag") = TemporaryAircraftInformation.Rows(0).Item("ac_exclusive_flag")
              newRow.Item("ac_lease_flag") = TemporaryAircraftInformation.Rows(0).Item("ac_lease_flag")
            End If
          End If
        ElseIf noteElement("lnote_jetnet_ac_id") = 0 And noteElement("lnote_client_ac_id") = 0 Then
          If noteElement("lnote_jetnet_amod_id") > 0 Then
            newRow.Item("amod_model_name") = "TEST"

            TemporaryModelInformation = Get_JETNET_Aircraft_Model_amodID(noteElement("lnote_jetnet_amod_id"))
            If Not IsNothing(TemporaryModelInformation) Then
              If TemporaryModelInformation.Rows.Count > 0 Then
                If Not IsDBNull(TemporaryModelInformation.Rows(0).Item("amod_model_name")) Then
                  newRow.Item("amod_model_name") = TemporaryModelInformation.Rows(0).Item("amod_model_name").ToString
                End If
                If Not IsDBNull(TemporaryModelInformation.Rows(0).Item("amod_make_name")) Then
                  newRow.Item("amod_make_name") = TemporaryModelInformation.Rows(0).Item("amod_make_name").ToString
                End If
              End If
            End If
          ElseIf noteElement("lnote_client_amod_id") > 0 Then
            TemporaryModelInformation = Get_Clients_Aircraft_Model_amodID(noteElement("lnote_client_amod_id"))
            If Not IsNothing(TemporaryModelInformation) Then
              If TemporaryModelInformation.Rows.Count > 0 Then
                If Not IsDBNull(TemporaryModelInformation.Rows(0).Item("cliamod_model_name")) Then
                  newRow.Item("amod_model_name") = TemporaryModelInformation.Rows(0).Item("cliamod_model_name").ToString
                End If
                If Not IsDBNull(TemporaryModelInformation.Rows(0).Item("cliamod_make_name")) Then
                  newRow.Item("amod_make_name") = TemporaryModelInformation.Rows(0).Item("cliamod_make_name").ToString
                End If
              End If
            End If
          End If
        End If



        newRow.Item("lnote_id") = noteElement("lnote_id")
        newRow.Item("lnote_jetnet_comp_id") = noteElement("lnote_jetnet_comp_id")
        newRow.Item("lnote_jetnet_ac_id") = noteElement("lnote_jetnet_ac_id")
        newRow.Item("lnote_jetnet_contact_id") = noteElement("lnote_jetnet_contact_id")
        newRow.Item("lnote_client_comp_id") = noteElement("lnote_client_comp_id")
        newRow.Item("lnote_client_ac_id") = noteElement("lnote_client_ac_id")
        newRow.Item("lnote_client_contact_id") = noteElement("lnote_client_contact_id")
        newRow.Item("lnote_note") = noteElement("lnote_note")
        newRow.Item("lnote_entry_date") = noteElement("lnote_entry_date")
        newRow.Item("lnote_action_date") = noteElement("lnote_action_date")
        newRow.Item("lnote_user_login") = noteElement("lnote_user_login")
        newRow.Item("lnote_user_name") = noteElement("lnote_user_name")
        newRow.Item("lnote_notecat_key") = noteElement("lnote_notecat_key")
        newRow.Item("lnote_schedule_start_date") = noteElement("lnote_schedule_start_date")
        newRow.Item("lnote_schedule_end_date") = noteElement("lnote_schedule_end_date")
        newRow.Item("lnote_user_id") = noteElement("lnote_user_id")
        newRow.Item("lnote_status") = noteElement("lnote_status")
        newRow.Item("lnote_clipri_ID") = noteElement("lnote_clipri_ID")
        newRow.Item("clipri_name") = noteElement("clipri_name")
        newRow.Item("clipri_sort_order") = noteElement("clipri_sort_order")
        newRow.Item("lnote_document_flag") = noteElement("lnote_document_flag")
        newRow.Item("lnote_jetnet_amod_id") = noteElement("lnote_jetnet_amod_id")
        newRow.Item("lnote_client_amod_id") = noteElement("lnote_client_amod_id")
        newRow.Item("lnote_document_name") = noteElement("lnote_document_name")
        newRow.Item("lnote_opportunity_status") = noteElement("lnote_opportunity_status")
        newRow.Item("lnote_cash_value") = noteElement("lnote_cash_value")
        newRow.Item("lnote_capture_percentage") = noteElement("lnote_capture_percentage")

        returnTable.Rows.Add(newRow)
        returnTable.AcceptChanges()


      Next '5.) We repeat for however many prospects there are.


      returnTableSorted = returnTable.Clone
      Dim afileterd As DataRow() = returnTable.Select("", sortingString)
      ' create another datarow to import the filtered info
      For Each atmpDataRow As DataRow In afileterd
        returnTableSorted.ImportRow(atmpDataRow)
      Next


      Return returnTableSorted '7.) We send the information back.
    Catch ex As Exception
      Notes_FillupSearch = Nothing
      Me.class_error = "Error in Notes_FillupSearch(): " & ex.Message
    Finally

      notesTable.Dispose()
    End Try
  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Local_Notes_Client_LastestByUser
  ' Purpose: to get the local notes based on latest notes by a certain user, and after a certain date
  ' Parameters: lnote_user_login As Integer, ByVal lnote_entry_date As String, ByVal lnote_status
  ' Return: 
  '       DataTable
  ' Change Log
  '           1/11/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Local_Notes_Client_LastestByUser(ByVal lnote_user_login As Integer, ByVal lnote_entry_date As String, ByVal lnote_status As String) As DataTable

    Dim sql As String = ""

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim aTempTable As New DataTable

    Try
      sql = " SELECT local_notes.lnote_id, local_notes.lnote_jetnet_ac_id, local_notes.lnote_jetnet_comp_id, local_notes.lnote_client_ac_id, local_notes.lnote_client_comp_id, "
      sql = sql & " local_notes.lnote_jetnet_contact_id, local_notes.lnote_client_contact_id, LEFT(local_notes.lnote_note, 21000) AS lnote_note, local_notes.lnote_entry_date, "
      sql = sql & " local_notes.lnote_action_date, local_notes.lnote_user_login, local_notes.lnote_user_name, local_notes.lnote_notecat_key, local_notes.lnote_status, "
      sql = sql & " local_notes.lnote_schedule_start_date, local_notes.lnote_schedule_end_date, local_notes.lnote_user_id, local_notes.lnote_clipri_ID, client_priority.clipri_name, "
      sql = sql & " client_priority.clipri_sort_order, local_notes.lnote_document_flag, local_notes.lnote_jetnet_amod_id, local_notes.lnote_client_amod_id, "
      sql = sql & " local_notes.lnote_document_name, local_notes.lnote_opportunity_status, local_notes.lnote_cash_value, local_notes.lnote_capture_percentage, "
      sql = sql & "  local_notes.lnote_wanted_start_year, local_notes.lnote_wanted_end_year, local_notes.lnote_wanted_max_price, local_notes.lnote_wanted_max_aftt, "
      sql = sql & " local_notes.lnote_wanted_damage_hist, local_notes.lnote_wanted_damage_cur"
      sql = sql & " FROM  local_notes INNER JOIN"
      sql = sql & " client_priority ON local_notes.lnote_clipri_ID = client_priority.clipri_ID"
      sql = sql & " WHERE (local_notes.lnote_user_login = " & lnote_user_login & ") AND (local_notes.lnote_action_date >= '" & lnote_entry_date & "') AND (local_notes.lnote_status = '" & lnote_status & "')"
      sql = sql & " ORDER BY local_notes.lnote_entry_date DESC"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Local_Notes_Client_LastestByUser(ByVal lnote_user_login As Integer, ByVal lnote_entry_date As String, ByVal lnote_status As String) As DataTable</b><br />" & sql



      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql

      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable
    Catch ex As Exception
      Get_Local_Notes_Client_LastestByUser = Nothing
      Me.class_error = "Error in SQL Local_Notes_Client_LastestByUser(ByVal lnote_user_login As Integer, ByVal lnote_entry_date As String, ByVal lnote_status As String)) " & ex.Message
    Finally
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try



  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Local_Notes_NoteID
  ' Purpose: to get the local notes based on a note ID
  ' Parameters: note_id 
  ' Return: 
  '       DataTable
  ' Change Log
  '           1/11/2012   - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Local_Notes_Client_NoteID(ByVal note_id As Integer) As DataTable
    Dim sql As String = ""

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim aTempTable As New DataTable

    Try

      sql = "SELECT local_notes.lnote_id, local_notes.lnote_jetnet_ac_id, local_notes.lnote_jetnet_comp_id, local_notes.lnote_client_ac_id, local_notes.lnote_client_comp_id, "
      sql = sql & " local_notes.lnote_jetnet_contact_id, local_notes.lnote_client_contact_id, LEFT(local_notes.lnote_note, 21000) AS lnote_note, local_notes.lnote_entry_date, "
      sql = sql & " local_notes.lnote_action_date, local_notes.lnote_user_login, local_notes.lnote_user_name, local_notes.lnote_notecat_key, local_notes.lnote_status, "
      sql = sql & " local_notes.lnote_schedule_start_date, local_notes.lnote_schedule_end_date, local_notes.lnote_user_id, local_notes.lnote_clipri_ID, client_priority.clipri_name, "
      sql = sql & " client_priority.clipri_sort_order, local_notes.lnote_document_flag, local_notes.lnote_jetnet_amod_id, local_notes.lnote_client_amod_id, "
      sql = sql & " local_notes.lnote_document_name, local_notes.lnote_opportunity_status, local_notes.lnote_cash_value, local_notes.lnote_capture_percentage, "
      sql = sql & " local_notes.lnote_wanted_start_year, local_notes.lnote_wanted_end_year, local_notes.lnote_wanted_max_price, local_notes.lnote_wanted_max_aftt, "
      sql = sql & " local_notes.lnote_wanted_damage_hist, local_notes.lnote_wanted_damage_cur"
      sql = sql & " FROM  local_notes INNER JOIN"
      sql = sql & " client_priority ON local_notes.lnote_clipri_ID = client_priority.clipri_ID"
      sql = sql & " WHERE (local_notes.lnote_id = " & note_id & ")"

      If HttpContext.Current.Session.Item("localUser").crmUserType = eUserTypes.MyNotesOnly Then
        sql = sql & " and local_notes.lnote_user_id = '" & HttpContext.Current.Session.Item("localUser").crmLocalUserID.ToString & "' "
      End If

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Local_Notes_Client_NoteID(ByVal note_id As Integer) As DataTable</b><br />" & sql



      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable

    Catch ex As Exception
      Get_Local_Notes_Client_NoteID = Nothing
      Me.class_error = "Error in SQL Get_Local_Notes_Client_NoteID(ByVal note_id As Integer) " & ex.Message
    Finally
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try


  End Function






  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: DUAL_Notes_LIMIT
  ' Purpose: to get the local notes for a client AND Jetnet AC. This limits the query by 1. 
  ' The table adapters won't let me limit. This is only in beta. I'm not sure if we'll keep this. Testing speed. 
  ' Parameters: ByVal ac_id As Integer, ByVal lnote_status As String, ByVal ac_source As String
  ' Return: 
  '       DataTable
  ' Change Log
  '           3/24/2010    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  'edited 
  'Get_Local_Notes_Client_AC(x, q)
  'Get_Local_Notes_JETNET_AC(x, q)
  'to use this instead!!
  Public Function DUAL_Notes_LIMIT(ByVal show_type As String, ByVal id As Integer, ByVal lnote_status As String, ByVal source As String, ByVal schedule_date As String, ByVal order_by As String, ByVal limit As Integer, Optional ByVal added_query As String = "", Optional ByVal contact_id As Long = 0) As DataTable

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing

    Dim aDataTable As New DataTable
    Dim aTempTable As DataTable = Nothing

    Try

      Try

        Dim qry As String = ""

        qry = "SELECT  local_notes.lnote_id, local_notes.lnote_jetnet_ac_id, local_notes.lnote_jetnet_comp_id, local_notes.lnote_client_ac_id, local_notes.lnote_client_comp_id,"
        qry = qry & "local_notes.lnote_jetnet_contact_id, local_notes.lnote_client_contact_id, LEFT(local_notes.lnote_note, 21000) AS lnote_note, local_notes.lnote_entry_date,"
        qry = qry & "local_notes.lnote_action_date, local_notes.lnote_user_login, local_notes.lnote_user_name, local_notes.lnote_notecat_key, local_notes.lnote_status, "
        qry = qry & "local_notes.lnote_schedule_start_date, local_notes.lnote_schedule_end_date, local_notes.lnote_user_id, local_notes.lnote_clipri_ID, "
        qry = qry & "local_notes.lnote_document_flag, local_notes.lnote_jetnet_amod_id, local_notes.lnote_client_amod_id, local_notes.lnote_document_name "
        qry = qry & " FROM  local_notes WHERE (local_notes.lnote_status = '" & lnote_status & "') "

        If HttpContext.Current.Session.Item("localUser").crmUserType = eUserTypes.MyNotesOnly Then
          qry = qry & " and local_notes.lnote_user_id = '" & HttpContext.Current.Session.Item("localUser").crmLocalUserID.ToString & "' "
        End If

        If Trim(show_type) = "B" Then
          qry = qry & " and lnote_opportunity_status ='A' "
        End If

        If lnote_status = "P" Then
          qry = qry & " and lnote_schedule_start_date >= " & schedule_date & " "
        End If

        If contact_id > 0 Then
          qry = qry & " and (local_notes.lnote_jetnet_contact_id = " & contact_id & " or local_notes.lnote_client_contact_id = " & contact_id & ") "
        End If


        If show_type = "AC" Then
          If source = "CLIENT" Then
            qry = qry & "AND (local_notes.lnote_client_ac_id = '" & id & "') "
          Else
            qry = qry & "AND (local_notes.lnote_jetnet_ac_id = '" & id & "') "
          End If
        ElseIf show_type = "COMP" Then
          If source = "CLIENT" Then
            qry = qry & " and (local_notes.lnote_client_comp_id = '" & id & "')"
          Else
            qry = qry & "and (local_notes.lnote_jetnet_comp_id = '" & id & "') "
          End If
        ElseIf show_type = "COMP_AC" Then
          If source = "CLIENT" Then
            qry = qry & " and (local_notes.lnote_client_comp_id = '" & id & "')"
            qry = qry & "AND (local_notes.lnote_client_ac_id = '" & id & "') "
          Else
            qry = qry & "and (local_notes.lnote_jetnet_comp_id = '" & id & "') "
            qry = qry & "and (local_notes.lnote_jetnet_comp_id = '" & id & "') "
          End If

        End If


        If Trim(added_query) <> "" Then
          qry = qry & added_query
        End If

        qry = qry & "ORDER BY " & order_by
        If limit <> 5000 Then
          qry = qry & " limit " & limit
        End If
        qry = qry

        Try

          MySqlConn.ConnectionString = Me.client_DB
          MySqlConn.Open()

        Catch MySqlException

          HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Could not open connection to MYSQL [" + MySqlException.Message + "]"

        End Try


        If MySqlConn.State = ConnectionState.Open Then

          MySqlCommand.Connection = MySqlConn

          MySqlCommand.CommandType = CommandType.Text
          MySqlCommand.CommandTimeout = 120
          MySqlCommand.CommandText = qry

          HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>DUAL_Notes_LIMIT(ByVal show_type As String, ByVal id As Integer, ByVal lnote_status As String, ByVal source As String, ByVal schedule_date As String, ByVal order_by As String, ByVal limit As Integer) As DataTable</b><br />" & qry


          MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

          Try
            aDataTable.Load(MySqlReader)
          Catch constrExc As System.Data.ConstraintException
            Dim rowsErr As System.Data.DataRow() = aDataTable.GetErrors()
          End Try

          aTempTable = aDataTable.Clone

          If lnote_status = "P" Then
            Dim afileterd As DataRow() = aDataTable.Select("", "lnote_schedule_start_date asc")
            ' create another datarow to import the filtered info
            For Each atmpDataRow As DataRow In afileterd
              aTempTable.ImportRow(atmpDataRow)
            Next
          Else
            Dim afileterd As DataRow() = aDataTable.Select("", "lnote_entry_date desc")
            ' create another datarow to import the filtered info
            For Each atmpDataRow As DataRow In afileterd
              aTempTable.ImportRow(atmpDataRow)
            Next

          End If

        End If

      Catch mysqlex As MySql.Data.MySqlClient.MySqlException
        aTempTable = Nothing
        Me.class_error = "Mysql Exc: Error in DUAL_Notes_LIMIT(ByVal ac_id " & id & " As Integer, ByVal lnote_status " & lnote_status & " As String, ByVal ac_source " & source & " As String, ByVal schedule_date " & schedule_date & " As String, ByVal order_by " & order_by & " As String) As DataTable: " & mysqlex.Message
      End Try

    Catch ex As Exception
      aTempTable = Nothing
      Me.class_error = "Reg Exc: Error in DUAL_Notes_LIMIT(ByVal ac_id " & id & " As Integer, ByVal lnote_status " & lnote_status & " As String, ByVal ac_source " & source & " As String, ByVal schedule_date " & schedule_date & " As String, ByVal order_by " & order_by & " As String) As DataTable: " & ex.Message
    Finally
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing

    End Try

    Return aTempTable

  End Function

  Public Function AIRCRAFT_LISTING_DUAL_Notes_LIMIT(ByVal show_type As String, ByVal id As Integer, ByVal lnote_status As String, ByVal source As String, ByVal schedule_date As String) As DataTable

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing

    Dim aDataTable As New DataTable

    Try

      Try

        Dim qry As String = ""

        qry = "SELECT  local_notes.lnote_id, local_notes.lnote_jetnet_ac_id, local_notes.lnote_jetnet_comp_id, local_notes.lnote_client_ac_id, local_notes.lnote_client_comp_id,"
        qry = qry & "local_notes.lnote_jetnet_contact_id, local_notes.lnote_client_contact_id, LEFT(local_notes.lnote_note, 21000) AS lnote_note, local_notes.lnote_entry_date,"
        qry = qry & "local_notes.lnote_action_date, local_notes.lnote_user_login, local_notes.lnote_user_name, local_notes.lnote_notecat_key, local_notes.lnote_status, "
        qry = qry & "local_notes.lnote_schedule_start_date, local_notes.lnote_schedule_end_date, local_notes.lnote_user_id, local_notes.lnote_clipri_ID, "
        qry = qry & "local_notes.lnote_document_flag, local_notes.lnote_jetnet_amod_id, local_notes.lnote_client_amod_id, local_notes.lnote_document_name "
        qry = qry & " FROM  local_notes WHERE (local_notes.lnote_status = '" & lnote_status & "') "

        If Trim(show_type) = "B" Then
          qry = qry & " and lnote_opportunity_status ='A' "
        End If

        If lnote_status = "P" Then
          qry = qry & " and lnote_schedule_start_date >= " & schedule_date & " "
        End If


        If show_type = "AC" Then
          If source = "CLIENT" Then
            qry = qry & "AND (local_notes.lnote_client_ac_id = '" & id & "') "
          Else
            qry = qry & "AND (local_notes.lnote_jetnet_ac_id = '" & id & "') "
          End If
        ElseIf show_type = "COMP" Then
          If source = "CLIENT" Then
            qry = qry & " and (local_notes.lnote_client_comp_id = '" & id & "')"
          Else
            qry = qry & "and (local_notes.lnote_jetnet_comp_id = '" & id & "') "
          End If
        ElseIf show_type = "COMP_AC" Then
          If source = "CLIENT" Then
            qry = qry & " and (local_notes.lnote_client_comp_id = '" & id & "')"
            qry = qry & "AND (local_notes.lnote_client_ac_id = '" & id & "') "
          Else
            qry = qry & "and (local_notes.lnote_jetnet_comp_id = '" & id & "') "
            qry = qry & "and (local_notes.lnote_jetnet_comp_id = '" & id & "') "
          End If

        End If


        If lnote_status = "P" Then
          qry = qry & "ORDER BY lnote_schedule_start_date asc"
        Else
          qry = qry & "order by lnote_entry_date desc"
        End If

        qry = qry & " limit 1"

        Try

          MySqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetServerNotesDatabase") 'The main change to this function is here. It's using: Session.Item("jetnetServerNotesDatabase") now.
          MySqlConn.Open()

        Catch MySqlException

          HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "Could not open connection to MYSQL [" + MySqlException.Message + "]"

        End Try

        If MySqlConn.State = ConnectionState.Open Then

          MySqlCommand.Connection = MySqlConn
          MySqlCommand.CommandType = CommandType.Text
          MySqlCommand.CommandTimeout = 120

          MySqlCommand.CommandText = qry

          HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>AIRCRAFT_LISTING_DUAL_Notes_LIMIT(ByVal show_type As String, ByVal id As Integer, ByVal lnote_status As String, ByVal source As String, ByVal schedule_date As String) As DataTable</b><br />" & qry

          MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

          Try
            aDataTable.Load(MySqlReader)
          Catch constrExc As System.Data.ConstraintException
            Dim rowsErr As System.Data.DataRow() = aDataTable.GetErrors()
          End Try

        End If

      Catch mysqlex As MySql.Data.MySqlClient.MySqlException

        aDataTable = Nothing
        Me.class_error = "Mysql Exc: Error in AIRCRAFT_LISTING_DUAL_Notes_LIMIT(ByVal ac_id " & id & " As Integer, ByVal lnote_status " & lnote_status & " As String, ByVal ac_source " & source & " As String, ByVal schedule_date " & schedule_date & " As String) As DataTable: " & mysqlex.Message

      End Try

    Catch ex As Exception

      Me.class_error = "Reg Exc: Error in AIRCRAFT_LISTING_DUAL_Notes_LIMIT(ByVal ac_id " & id & " As Integer, ByVal lnote_status " & lnote_status & " As String, ByVal ac_source " & source & " As String, ByVal schedule_date " & schedule_date & " As String) As DataTable: " & ex.Message
      aDataTable = Nothing

    Finally
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

    Return aDataTable

  End Function
  Public Function ReturnApplicableProspect(ByVal JetnetAcID As Long, ByVal ClientAcID As Long, ByVal JetnetCompanyID As Long, ByVal ClientCompanyID As Long) As DataTable
    Dim aTempTable As New DataTable

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Try

      Dim qry As String = ""
      Dim aDataTable As New DataTable

      qry = "SELECT  local_notes.lnote_id, local_notes.lnote_jetnet_ac_id, local_notes.lnote_jetnet_comp_id, local_notes.lnote_client_ac_id, local_notes.lnote_client_comp_id,"
      qry = qry & "local_notes.lnote_jetnet_contact_id, local_notes.lnote_client_contact_id, LEFT(local_notes.lnote_note, 21000) AS lnote_note, local_notes.lnote_entry_date,"
      qry = qry & "local_notes.lnote_action_date, local_notes.lnote_user_login, local_notes.lnote_user_name, local_notes.lnote_notecat_key, local_notes.lnote_status, "
      qry = qry & "local_notes.lnote_schedule_start_date, local_notes.lnote_schedule_end_date, local_notes.lnote_user_id, local_notes.lnote_clipri_ID, "
      qry = qry & "local_notes.lnote_document_flag, local_notes.lnote_jetnet_amod_id, local_notes.lnote_client_amod_id, local_notes.lnote_document_name "
      qry = qry & " FROM  local_notes WHERE (local_notes.lnote_status = 'B') "
      qry = qry & " and lnote_opportunity_status ='A' "



      If ClientAcID > 0 Then
        qry = qry & " and (local_notes.lnote_client_ac_id = '" & ClientAcID & "')"
      End If

      If JetnetAcID > 0 Then
        qry = qry & "AND (local_notes.lnote_jetnet_ac_id = '" & JetnetAcID & "') "
      End If

      If JetnetCompanyID > 0 Then
        qry = qry & "and (local_notes.lnote_jetnet_comp_id = '" & JetnetCompanyID & "') "
      End If

      If ClientCompanyID > 0 Then
        qry = qry & "and (local_notes.lnote_client_comp_id = '" & ClientCompanyID & "') "
      End If



      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      MySqlCommand.CommandText = qry
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>ReturnApplicableProspect(ByVal JetnetAcID As Long, ByVal ClientAcID As Long, ByVal JetnetCompanyID As Long, ByVal ClientCompanyID As Long) As DataTable</b><br />" & qry

      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try


      Return aTempTable

    Catch ex As Exception
      ReturnApplicableProspect = Nothing
      Me.class_error = "Error in  Public Function ReturnApplicableProspect(ByVal JetnetAcID As Long, ByVal ClientAcID As Long, ByVal JetnetCompanyID As Long, ByVal ClientCompanyID As Long) As DataTable: " & ex.Message
    Finally
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function
  Public Function DUAL_Notes_LIMIT_CRM(ByVal show_type As String, ByVal companyID As Long, ByVal aircraftID As Long, ByVal lnote_status As String, ByVal source As String, ByVal schedule_date As String, ByVal order_by As String, ByVal limit As Integer, ByVal new_connection As String) As DataTable

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Try
      DUAL_Notes_LIMIT_CRM = Nothing
      Dim qry As String = ""
      Dim aDataTable As New DataTable

      qry = "SELECT  local_notes.lnote_id, local_notes.lnote_jetnet_ac_id, local_notes.lnote_jetnet_comp_id, local_notes.lnote_client_ac_id, local_notes.lnote_client_comp_id,"
      qry = qry & "local_notes.lnote_jetnet_contact_id, local_notes.lnote_client_contact_id, LEFT(local_notes.lnote_note, 21000) AS lnote_note, local_notes.lnote_entry_date,"
      qry = qry & "local_notes.lnote_action_date, local_notes.lnote_user_login, local_notes.lnote_user_name, local_notes.lnote_notecat_key, local_notes.lnote_status, "
      qry = qry & "local_notes.lnote_schedule_start_date, local_notes.lnote_schedule_end_date, local_notes.lnote_user_id, local_notes.lnote_clipri_ID, "
      qry = qry & "local_notes.lnote_document_flag, local_notes.lnote_jetnet_amod_id, local_notes.lnote_client_amod_id, local_notes.lnote_document_name "
      qry = qry & " FROM  local_notes WHERE (local_notes.lnote_status = '" & lnote_status & "') "

      If Trim(show_type) = "B" Then
        qry = qry & " and lnote_opportunity_status ='A' "
      End If

      If lnote_status = "P" Then
        qry = qry & " and lnote_schedule_start_date >= " & schedule_date & " "
      End If

      If show_type = "AC" Then
        If source = "CLIENT" Then
          qry = qry & "AND (local_notes.lnote_client_ac_id = '" & aircraftID & "') "
        Else
          qry = qry & "AND (local_notes.lnote_jetnet_ac_id = '" & aircraftID & "') "
        End If
      ElseIf show_type = "COMP" Then
        If source = "CLIENT" Then
          qry = qry & " and (local_notes.lnote_client_comp_id = '" & companyID & "')"
        Else
          qry = qry & "and (local_notes.lnote_jetnet_comp_id = '" & companyID & "') "
        End If
      ElseIf show_type = "COMP_AC" Then
        If source = "CLIENT" Then
          qry = qry & " and (local_notes.lnote_client_comp_id = '" & companyID & "')"
          qry = qry & "AND (local_notes.lnote_client_ac_id = '" & aircraftID & "') "
        Else
          qry = qry & "and (local_notes.lnote_jetnet_comp_id = '" & companyID & "') "
          qry = qry & "and (local_notes.lnote_jetnet_ac_id = '" & aircraftID & "') "
        End If

      End If

      qry = qry & "ORDER BY " & order_by
      If limit <> 5000 Then
        qry = qry & " limit " & limit
      End If
      qry = qry


      Dim aTempTable As New DataTable
      MySqlConn.ConnectionString = new_connection
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      Dim sQuery As String = qry
      MySqlCommand.CommandText = sQuery

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Public Function DUAL_Notes_LIMIT_CRM(ByVal show_type As String, ByVal companyID As Long, ByVal aircraftID As Long, ByVal lnote_status As String, ByVal source As String, ByVal schedule_date As String, ByVal order_by As String, ByVal limit As Integer, ByVal new_connection As String) As DataTable</b><br />" & qry


      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      'DUAL_Notes_LIMIT = aTempTable

      'aTempTable = Nothing

      aDataTable = aTempTable.Clone
      If lnote_status = "P" Then
        Dim afileterd As DataRow() = aTempTable.Select("", "lnote_schedule_start_date asc")
        ' create another datarow to import the filtered info
        For Each atmpDataRow As DataRow In afileterd
          aDataTable.ImportRow(atmpDataRow)
        Next
      Else
        Dim afileterd As DataRow() = aTempTable.Select("", "lnote_entry_date desc")
        ' create another datarow to import the filtered info
        For Each atmpDataRow As DataRow In afileterd
          aDataTable.ImportRow(atmpDataRow)
        Next

      End If

      DUAL_Notes_LIMIT_CRM = aDataTable

    Catch ex As Exception
      DUAL_Notes_LIMIT_CRM = Nothing
      Me.class_error = "Error in DUAL_Notes_LIMIT(ByVal acid " & aircraftID & " As long, compid " & companyID & " As long, ByVal lnote_status " & lnote_status & " As String, ByVal ac_source " & source & " As String, ByVal schedule_date " & schedule_date & " As String, ByVal order_by " & order_by & " As String) As DataTable: " & ex.Message
    Finally
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function
  Public Function get_company_name_fromID_CRM(ByVal nCompanyID As Long,
                                            ByVal nCompanyJournalID As Long,
                                            ByVal bIsDisplay As Boolean,
                                            ByVal bIgnoreHidden As Boolean,
                                            ByRef sExtraCompanyInfo As String) As String
    get_company_name_fromID_CRM = ""

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sOutString As New StringBuilder()

    Try

      Dim qry As String = ""
      Dim aDataTable As New DataTable

      qry = "SELECT  "
      qry = qry & " clicomp_name, clicomp_city, clicomp_state, clicomp_country, clicomp_id "
      qry = qry & " FROM client_company where clicomp_id = " & nCompanyID

      Dim aTempTable As New DataTable
      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      Dim sQuery As String = qry
      MySqlCommand.CommandText = sQuery


      MySqlReader = MySqlCommand.ExecuteReader()

      If MySqlReader.HasRows Then

        Do While MySqlReader.Read()

          If Not (IsDBNull(MySqlReader("clicomp_name"))) Then

            ' If bIsDisplay Then
            'sOutString.Append("<a class='underline' onclick='javascript:openSmallWindowJS(""DisplayCompanyDetail.aspx?compid=" + nCompanyID.ToString + """,""CompanyWindow"");' title='Display Company Details'>" + MySqlReader.Item("clicomp_name").ToString.Trim + "</a>")
            ' Else
            sOutString.Append(MySqlReader.Item("clicomp_name").ToString.Trim)
            '  End If

          End If

          If Not IsNothing(sExtraCompanyInfo) And String.IsNullOrEmpty(sExtraCompanyInfo) Then

            If Not (IsDBNull(MySqlReader("clicomp_city"))) Then
              If Not String.IsNullOrEmpty(MySqlReader.Item("clicomp_city").ToString.Trim) Then
                If String.IsNullOrEmpty(sExtraCompanyInfo) Then

                  sExtraCompanyInfo = MySqlReader.Item("clicomp_city").ToString.Trim

                  If Not (IsDBNull(MySqlReader("clicomp_state"))) Then
                    If Not String.IsNullOrEmpty(MySqlReader.Item("clicomp_state").ToString.Trim) Then
                      If String.IsNullOrEmpty(sExtraCompanyInfo) Then
                        sExtraCompanyInfo += ", " + MySqlReader.Item("clicomp_state").ToString.Trim & " "
                      Else
                        sExtraCompanyInfo += ", " + MySqlReader.Item("clicomp_state").ToString.Trim & " "
                      End If
                    End If
                  End If
                Else

                  sExtraCompanyInfo += ":" + MySqlReader.Item("clicomp_city").ToString.Trim

                  If Not (IsDBNull(MySqlReader("clicomp_state"))) Then
                    If Not String.IsNullOrEmpty(MySqlReader.Item("clicomp_state").ToString.Trim) Then
                      If String.IsNullOrEmpty(sExtraCompanyInfo) Then
                        sExtraCompanyInfo += ", " + MySqlReader.Item("clicomp_state").ToString.Trim & " "
                      Else
                        sExtraCompanyInfo += ", " + MySqlReader.Item("clicomp_state").ToString.Trim & " "
                      End If
                    End If
                  End If
                End If
              Else
                sExtraCompanyInfo = ""

                If Not (IsDBNull(MySqlReader("clicomp_state"))) Then
                  If Not String.IsNullOrEmpty(MySqlReader.Item("clicomp_state").ToString.Trim) Then
                    If String.IsNullOrEmpty(sExtraCompanyInfo) Then
                      sExtraCompanyInfo += "" + MySqlReader.Item("clicomp_state").ToString.Trim & " "
                    Else
                      sExtraCompanyInfo += "" + MySqlReader.Item("clicomp_state").ToString.Trim & " "
                    End If
                  End If
                End If
              End If
            Else
              sExtraCompanyInfo = ""

              If Not (IsDBNull(MySqlReader("clicomp_state"))) Then
                If Not String.IsNullOrEmpty(MySqlReader.Item("clicomp_state").ToString.Trim) Then
                  If String.IsNullOrEmpty(sExtraCompanyInfo) Then
                    sExtraCompanyInfo += "" + MySqlReader.Item("clicomp_state").ToString.Trim & " "
                  Else
                    sExtraCompanyInfo += "" + MySqlReader.Item("clicomp_state").ToString.Trim & " "
                  End If
                End If
              End If
            End If



            If Not (IsDBNull(MySqlReader("clicomp_country"))) Then
              If Not String.IsNullOrEmpty(MySqlReader.Item("clicomp_country").ToString.Trim) Then
                If String.IsNullOrEmpty(sExtraCompanyInfo) Then
                  sExtraCompanyInfo = Replace(MySqlReader.Item("clicomp_country").ToString.Trim, "United States", "USA")
                Else
                  sExtraCompanyInfo += " " + Replace(MySqlReader.Item("clicomp_country").ToString.Trim, "United States", "USA")
                End If
              End If
            End If

          End If

        Loop ' lDataReader.HasRows

      Else
        sOutString.Append("COMPANY NAME NOT FOUND")
      End If


      get_company_name_fromID_CRM = sOutString.ToString

    Catch ex As Exception
      ' DUAL_Notes_LIMIT_CRM = Nothing
      '  Me.class_error = "Error in DUAL_Notes_LIMIT(ByVal acid " & aircraftID & " As long, compid " & companyID & " As long, ByVal lnote_status " & lnote_status & " As String, ByVal ac_source " & source & " As String, ByVal schedule_date " & schedule_date & " As String, ByVal order_by " & order_by & " As String) As DataTable: " & ex.Message
    Finally
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
  Public Function get_contact_name_fromID_CRM(ByVal nContactID As Long,
                                            ByVal nCompanyJournalID As Long) As String
    get_contact_name_fromID_CRM = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sOutString As New StringBuilder()

    Try

      Dim qry As String = ""
      Dim aDataTable As New DataTable

      qry = "SELECT  "
      qry = qry & " clicontact_first_name, clicontact_last_name, clicontact_title FROM client_contact where clicontact_id = " & nContactID

      Dim aTempTable As New DataTable
      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      Dim sQuery As String = qry
      MySqlCommand.CommandText = sQuery


      MySqlReader = MySqlCommand.ExecuteReader()

      If MySqlReader.HasRows Then

        Do While MySqlReader.Read()

          If Not (IsDBNull(MySqlReader("clicontact_first_name"))) Then
            sOutString.Append(MySqlReader.Item("clicontact_first_name").ToString.Trim & " ")
          End If

          If Not (IsDBNull(MySqlReader("clicontact_last_name"))) Then
            sOutString.Append(MySqlReader.Item("clicontact_last_name").ToString.Trim)
          End If

          If Not (IsDBNull(MySqlReader("clicontact_title"))) Then
            If MySqlReader.Item("clicontact_title").ToString.Trim <> "" Then
              sOutString.Append(": " & MySqlReader.Item("clicontact_title").ToString.Trim)
            End If
          End If


        Loop ' lDataReader.HasRows

      Else
        sOutString.Append("")
      End If


      get_contact_name_fromID_CRM = sOutString.ToString

    Catch ex As Exception
      ' DUAL_Notes_LIMIT_CRM = Nothing
      '  Me.class_error = "Error in DUAL_Notes_LIMIT(ByVal acid " & aircraftID & " As long, compid " & companyID & " As long, ByVal lnote_status " & lnote_status & " As String, ByVal ac_source " & source & " As String, ByVal schedule_date " & schedule_date & " As String, ByVal order_by " & order_by & " As String) As DataTable: " & ex.Message
    Finally
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Local_Notes_Schedule_Date
  ' Purpose: to get the JobSeeker details based on schedule_date
  ' Parameters: schedule_date, schedule_date2, timezone_offset, status
  ' Return: 
  '       DataTable
  ' Change Log
  '           1/16/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Local_Notes_Schedule_DateLimitedReturn(ByVal schedule_date As String, ByVal schedule_date2 As String, ByVal timezone_offset As String, ByVal lnote_status As String) As DataTable

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing

    Dim sql As String = ""
    Dim atemptable As New DataTable

    Try
      schedule_date = Year(schedule_date) & "-" & Month(schedule_date) & "-" & Day(schedule_date)
      schedule_date2 = Year(schedule_date2) & "-" & Month(schedule_date2) & "-" & Day(schedule_date2)

      sql = " SELECT local_notes.lnote_schedule_start_date, local_notes.lnote_opportunity_status, lnote_schedule_end_date, "
      sql = sql & " local_notes.lnote_cash_value, local_notes.lnote_capture_percentage, "
      sql = sql & " local_notes.lnote_user_id "
      sql = sql & " FROM local_notes INNER JOIN"
      sql = sql & " client_priority ON local_notes.lnote_clipri_ID = client_priority.clipri_ID"
      sql = sql & " WHERE (local_notes.lnote_schedule_start_date >= '" & schedule_date & "') AND (local_notes.lnote_schedule_start_date <= '" & schedule_date2 & "') AND "
      sql = sql & " (local_notes.lnote_status = '" & lnote_status & "')"
      If HttpContext.Current.Session.Item("localUser").crmUserType = eUserTypes.MyNotesOnly Then
        sql = sql & " and local_notes.lnote_user_id = '" & HttpContext.Current.Session.Item("localUser").crmLocalUserID.ToString & "' "
      End If
      sql = sql & " ORDER BY local_notes.lnote_schedule_start_date"

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Local_Notes_Schedule_DateLimitedReturn(ByVal schedule_date As String, ByVal schedule_date2 As String, ByVal timezone_offset As String, ByVal lnote_status As String) As DataTable</b><br />" & sql

      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      '''''''''''''''''''''''''''''''''
      ' passed -2
      ' can get -3,0,-1,-2,1,0.5,-4,-5
      '''''''''''''''''''''''''''''''''
      ' create a dbnull variable
      Dim aDBNULL As DBNull = Nothing
      ' crate a date/time to hold the start date
      Dim aStart_date As System.DateTime = System.DateTime.Now
      ' create a date/time to hold th end date
      If Not IsNothing(atemptable) Then
        If atemptable.Rows.Count > 0 Then
          ' reset the time fields
          For x As Integer = 0 To atemptable.Rows.Count - 1
            'aStart_date = ""
            aStart_date = IIf(Not IsDBNull(atemptable.Rows(x).Item("lnote_schedule_start_date")), atemptable.Rows(x).Item("lnote_schedule_start_date"), aDBNULL)
            If Not IsDBNull(aStart_date) Then
              aStart_date = aStart_date.AddHours(timezone_offset)
            End If
            atemptable.Rows(x).Item("lnote_schedule_start_date") = aStart_date
          Next
        End If
      End If

      Get_Local_Notes_Schedule_DateLimitedReturn = atemptable
    Catch ex As Exception
      Get_Local_Notes_Schedule_DateLimitedReturn = Nothing
      aError = ex.Message
      Me.class_error = "Error in SQL Get_Local_Notes_Schedule_DateLimitedReturn(ByVal schedule_date " & schedule_date & " As String, ByVal schedule_date2 " & schedule_date2 & " As String, ByVal timezone_offset " & timezone_offset & " As String, status " & lnote_status & " as string): " & ex.Message
    Finally
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: ScheduleDateforCalendar
  ' Purpose: to get the JobSeeker details based on schedule_date
  ' Parameters: schedule_date, schedule_date2, timezone_offset, status
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/21/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function ScheduleDateforCalendar(ByVal schedule_date As String, ByVal schedule_date2 As String, ByVal timezone_offset As String, ByVal lnote_status As String) As DataTable

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing

    Dim sql As String = ""
    Dim atemptable As New DataTable

    Try
      schedule_date = Year(schedule_date) & "-" & Month(schedule_date) & "-" & Day(schedule_date)
      schedule_date2 = Year(schedule_date2) & "-" & Month(schedule_date2) & "-" & Day(schedule_date2)

      sql = " SELECT local_notes.lnote_schedule_start_date, lnote_id, lnote_note, local_notes.lnote_opportunity_status,lnote_status, lnote_schedule_end_date, "
      sql = sql & " local_notes.lnote_cash_value, local_notes.lnote_capture_percentage, lnote_jetnet_comp_id, lnote_client_comp_id, lnote_jetnet_ac_id, lnote_client_ac_id, lnote_client_contact_id, lnote_jetnet_contact_id, "
      sql = sql & " local_notes.lnote_user_id "
      sql = sql & " FROM local_notes INNER JOIN"
      sql = sql & " client_priority ON local_notes.lnote_clipri_ID = client_priority.clipri_ID"
      sql = sql & " WHERE (local_notes.lnote_schedule_start_date >= '" & schedule_date & "') AND (local_notes.lnote_schedule_start_date <= '" & schedule_date2 & "') AND "
      sql = sql & " (local_notes.lnote_status = '" & lnote_status & "')"
      sql = sql & " ORDER BY local_notes.lnote_schedule_start_date"

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>ScheduleDateforCalendar(ByVal schedule_date As String, ByVal schedule_date2 As String, ByVal timezone_offset As String, ByVal lnote_status As String) As DataTable</b><br />" & sql

      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      '''''''''''''''''''''''''''''''''
      ' passed -2
      ' can get -3,0,-1,-2,1,0.5,-4,-5
      '''''''''''''''''''''''''''''''''
      ' create a dbnull variable
      Dim aDBNULL As DBNull = Nothing
      ' crate a date/time to hold the start date
      Dim aStart_date As System.DateTime = System.DateTime.Now
      ' create a date/time to hold th end date
      If Not IsNothing(atemptable) Then
        If atemptable.Rows.Count > 0 Then
          ' reset the time fields
          For x As Integer = 0 To atemptable.Rows.Count - 1
            'aStart_date = ""
            aStart_date = IIf(Not IsDBNull(atemptable.Rows(x).Item("lnote_schedule_start_date")), atemptable.Rows(x).Item("lnote_schedule_start_date"), aDBNULL)
            If Not IsDBNull(aStart_date) Then
              aStart_date = aStart_date.AddHours(timezone_offset)
            End If
            atemptable.Rows(x).Item("lnote_schedule_start_date") = aStart_date
          Next
        End If
      End If

      ScheduleDateforCalendar = atemptable
    Catch ex As Exception
      ScheduleDateforCalendar = Nothing
      aError = ex.Message
      Me.class_error = "Error in SQL ScheduleDateforCalendar(ByVal schedule_date " & schedule_date & " As String, ByVal schedule_date2 " & schedule_date2 & " As String, ByVal timezone_offset " & timezone_offset & " As String, status " & lnote_status & " as string): " & ex.Message
    Finally
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Update_Note_When_Jetnet_Made_Client
  ' Purpose: to update notes when a jetnet AC is made into a client AC
  ' Parameters: client ID, jetnet ID
  ' Return: 
  '       DataTable
  ' Change Log
  '           1/31/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Update_Note_When_Jetnet_Made_Client(ByVal client_id As Integer, ByVal jetnet_id As Integer) As Integer
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Try


      MySqlConn.ConnectionString = Me.client_DB

      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      Dim sQuery As String = "update local_notes set lnote_client_ac_id = " & client_id & " where lnote_jetnet_ac_id = " & jetnet_id

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Update_Note_When_Jetnet_Made_Client(ByVal client_id As Integer, ByVal jetnet_id As Integer) As DataTable</b><br />" & sQuery

      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sQuery
      MySqlCommand.ExecuteNonQuery()
      Update_Note_When_Jetnet_Made_Client = 1

    Catch ex As Exception
      Update_Note_When_Jetnet_Made_Client = 0
      Me.class_error = "Error in Update_Note_When_Jetnet_Made_Client(ByVal client_id As Integer, ByVal jetnet_id As Integer): " & ex.Message
    Finally

      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing

    End Try
  End Function

  Public Function COMP_Update_Note_When_Jetnet_Made_Client(ByVal client_id As Integer, ByVal jetnet_id As Integer) As Integer

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Try
      MySqlConn.ConnectionString = Me.client_DB

      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      Dim sQuery As String = "update local_notes set lnote_jetnet_comp_id = " & jetnet_id & " where lnote_client_comp_id = " & client_id
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>COMP_Update_Note_When_Jetnet_Made_Client(ByVal client_id As Integer, ByVal jetnet_id As Integer)</b><br />" & sQuery

      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sQuery
      MySqlCommand.ExecuteNonQuery()

      COMP_Update_Note_When_Jetnet_Made_Client = 1

      MySqlConn.Dispose()
      MySqlCommand.Dispose()
    Catch ex As Exception
      COMP_Update_Note_When_Jetnet_Made_Client = 0
      Me.class_error = "Error in COMP_Update_Note_When_Jetnet_Made_Client(ByVal client_id As Integer, ByVal jetnet_id As Integer): " & ex.Message
    Finally

      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing

    End Try
  End Function

  Public Function UpdateCompanyNotesWithClientID(ByVal client_id As Long, ByVal jetnet_id As Long) As Integer

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Try
      If jetnet_id > 0 And client_id > 0 Then
        MySqlConn.ConnectionString = Me.client_DB

        MySqlConn.Open()
        MySqlCommand.Connection = MySqlConn
        MySqlCommand.CommandType = CommandType.Text
        MySqlCommand.CommandTimeout = 60

        Dim sQuery As String = "update local_notes set lnote_client_comp_id = " & client_id & " where lnote_client_comp_id = 0 and lnote_jetnet_comp_id = " & jetnet_id
        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>UpdateCompanyNotesWithClientID(ByVal client_id As Long, ByVal jetnet_id As Long) As Integer</b><br />" & sQuery

        MySqlCommand.Connection = MySqlConn
        MySqlCommand.CommandType = CommandType.Text
        MySqlCommand.CommandTimeout = 60

        MySqlCommand.CommandText = sQuery
        MySqlCommand.ExecuteNonQuery()

        UpdateCompanyNotesWithClientID = 1

        MySqlConn.Dispose()
        MySqlCommand.Dispose()
      End If
    Catch ex As Exception
      UpdateCompanyNotesWithClientID = 0
      Me.class_error = "Error in UpdateCompanyNotesWithClientID(ByVal client_id As Long, ByVal jetnet_id As Long) As Integer: " & ex.Message
    Finally

      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing

    End Try
  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Local_Notes_Client_Company
  ' Purpose: to get the local notes for a Client Company
  ' Parameters: lnote_client_company_id 
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/3/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Local_Notes_Client_Company(ByVal lnote_client_company_id As Integer) As DataTable

    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim aTempTable As New DataTable

    Try
      sql = " SELECT  local_notes.lnote_id, local_notes.lnote_jetnet_ac_id, local_notes.lnote_jetnet_comp_id, local_notes.lnote_client_ac_id, local_notes.lnote_client_comp_id, "
      sql = sql & " local_notes.lnote_jetnet_contact_id, local_notes.lnote_client_contact_id, left(local_notes.lnote_note,21000) as lnote_note, local_notes.lnote_entry_date, local_notes.lnote_action_date, "
      sql = sql & " local_notes.lnote_user_login, local_notes.lnote_user_name, local_notes.lnote_notecat_key, local_notes.lnote_status, local_notes.lnote_schedule_start_date, "
      sql = sql & " local_notes.lnote_schedule_end_date, local_notes.lnote_user_id, local_notes.lnote_clipri_ID, client_priority.clipri_name, client_priority.clipri_sort_order, "
      sql = sql & " local_notes.lnote_document_flag, local_notes.lnote_jetnet_amod_id, local_notes.lnote_client_amod_id,  local_notes.lnote_document_name, local_notes.lnote_opportunity_status, local_notes.lnote_cash_value, local_notes.lnote_capture_percentage,"
      sql = sql & " local_notes.lnote_wanted_start_year, local_notes.lnote_wanted_end_year, local_notes.lnote_wanted_max_price, local_notes.lnote_wanted_max_aftt, "
      sql = sql & " local_notes.lnote_wanted_damage_hist, local_notes.lnote_wanted_damage_cur"
      sql = sql & " FROM local_notes INNER JOIN"
      sql = sql & " client_priority ON local_notes.lnote_clipri_ID = client_priority.clipri_ID"
      sql = sql & " WHERE (lnote_client_comp_id = " & lnote_client_company_id & ") "

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Local_Notes_Client_Company(ByVal lnote_client_company_id As Integer) As DataTable</b><br />" & sql


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable
    Catch ex As Exception
      Get_Local_Notes_Client_Company = Nothing
      Me.class_error = "Error in SQL Get_Local_Notes_Client_Company(ByVal lnote_client_company_id As Integer) As DataTable: " & ex.Message
    Finally
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Local_Notes_Action_Date
  ' Purpose: to get the JobSeeker details based on action_date
  ' Parameters: type
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/7/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Local_Notes_Action_Date(ByVal action_date As String, ByVal action_date2 As String) As DataTable

    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim aTempTable As New DataTable

    Try
      sql = "SELECT local_notes.lnote_id, local_notes.lnote_jetnet_ac_id, local_notes.lnote_jetnet_comp_id, local_notes.lnote_client_ac_id, local_notes.lnote_client_comp_id, "
      sql = sql & " local_notes.lnote_jetnet_contact_id, local_notes.lnote_client_contact_id, LEFT(local_notes.lnote_note, 21000) AS lnote_note, local_notes.lnote_entry_date, "
      sql = sql & " local_notes.lnote_action_date, local_notes.lnote_user_login, local_notes.lnote_user_name, local_notes.lnote_notecat_key, local_notes.lnote_status, "
      sql = sql & " local_notes.lnote_schedule_start_date, local_notes.lnote_schedule_end_date, local_notes.lnote_user_id, local_notes.lnote_clipri_ID, client_priority.clipri_name, "
      sql = sql & " client_priority.clipri_sort_order, local_notes.lnote_document_flag, local_notes.lnote_jetnet_amod_id, local_notes.lnote_client_amod_id, "
      sql = sql & " local_notes.lnote_document_name, local_notes.lnote_opportunity_status, local_notes.lnote_cash_value, local_notes.lnote_capture_percentage, "
      sql = sql & " local_notes.lnote_wanted_start_year, local_notes.lnote_wanted_end_year, local_notes.lnote_wanted_max_price, local_notes.lnote_wanted_max_aftt, "
      sql = sql & " local_notes.lnote_wanted_damage_hist, local_notes.lnote_wanted_damage_cur"
      sql = sql & " FROM  local_notes INNER JOIN"
      sql = sql & " client_priority ON local_notes.lnote_clipri_ID = client_priority.clipri_ID"
      sql = sql & " WHERE (local_notes.lnote_action_date >= '" & action_date & "') AND (local_notes.lnote_action_date <= '" & action_date2 & "')"

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Local_Notes_Action_Date(ByVal action_date As String, ByVal action_date2 As String) As DataTable</b><br />" & sql


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable

    Catch ex As Exception
      Get_Local_Notes_Action_Date = Nothing
      Me.class_error = "Error in SQL Get_Local_Notes_Action_Date(ByVal action_date As String, ByVal action_date2 As String) As DataTable: " & ex.Message
    Finally
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
  ''' <summary>
  ''' 
  ''' </summary>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function SelectDistinctJetnetAircraftIDFromNotes(ByVal AircraftNoteDate As String, ByVal client_model_id As String, ByVal jetnet_model_id As String) As DataTable
    Dim ClientTable As New DataTable
    Dim JetnetTable As New DataTable

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing

    Try

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      Dim qry As String = ""

      'Running the first query to return jetnet ac IDs 
      qry = "SELECT distinct lnote_jetnet_ac_id from local_notes where lnote_jetnet_ac_id > 0 and lnote_status = 'A'"
      qry += " and ((lcase(lnote_note) not like ""no answer%"") and (lcase(lnote_note) not like ""message left%"") and (lcase(lnote_note) not like ""left voicemail%"") and (lcase(lnote_note) not like ""left message%""))"

      If Not String.IsNullOrEmpty(Trim(client_model_id)) Or Not String.IsNullOrEmpty(Trim(jetnet_model_id)) Then
        qry += " and ("

        If Not String.IsNullOrEmpty(Trim(client_model_id)) Then
          qry += "lnote_client_amod_id in (" & Trim(client_model_id) & ") "
          If Not String.IsNullOrEmpty(Trim(jetnet_model_id)) Then
            qry += " or "
          End If
        End If

        If Not String.IsNullOrEmpty(Trim(jetnet_model_id)) Then
          qry += " lnote_jetnet_amod_id in (" & Trim(jetnet_model_id) & ")"
        End If

        qry += ")"
      End If

      If AircraftNoteDate <> "" Then
        qry += " and (lnote_entry_date >= """ & AircraftNoteDate & """)"
      End If

      MySqlCommand.CommandText = qry
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>SelectDistinctJetnetAircraftIDFromNotes() As DataTable</b><br />" & qry

      Try
        ClientTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = ClientTable.GetErrors()
      End Try

      Return ClientTable

    Catch ex As Exception
      SelectDistinctJetnetAircraftIDFromNotes = Nothing
      Me.class_error = "Error in  SelectDistinctJetnetAircraftIDFromNotes() As DataTable: " & ex.Message
    Finally
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing

    End Try
  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Local_Notes_Status
  ' Purpose: to get the JobSeeker details based on contact_Id
  ' Parameters: type
  ' Return:  
  '       DataTable
  ' Change Log
  '           2/26/2010    - Created By: Tom Jones
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Local_Notes_Status(ByVal status As String, ByVal lnote_user_id As Integer, ByVal doc_flag As String) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim aTempTable As New DataTable

    Try

      If lnote_user_id = 0 Then
        If doc_flag = "B" Then
          sql = "SELECT local_notes.lnote_id, local_notes.lnote_jetnet_ac_id, local_notes.lnote_jetnet_comp_id, local_notes.lnote_client_ac_id, local_notes.lnote_client_comp_id, "
          sql = sql & " local_notes.lnote_jetnet_contact_id, local_notes.lnote_client_contact_id, LEFT(local_notes.lnote_note, 21000) AS lnote_note, local_notes.lnote_entry_date, "
          sql = sql & " local_notes.lnote_action_date, local_notes.lnote_user_login, local_notes.lnote_user_name, local_notes.lnote_notecat_key, local_notes.lnote_status, "
          sql = sql & " local_notes.lnote_schedule_start_date, local_notes.lnote_schedule_end_date, local_notes.lnote_user_id, local_notes.lnote_clipri_ID, client_priority.clipri_name, "
          sql = sql & " client_priority.clipri_sort_order, local_notes.lnote_document_flag, local_notes.lnote_jetnet_amod_id, local_notes.lnote_client_amod_id, "
          sql = sql & " local_notes.lnote_document_name, local_notes.lnote_opportunity_status, local_notes.lnote_cash_value, local_notes.lnote_capture_percentage, "
          sql = sql & " local_notes.lnote_wanted_end_year, local_notes.lnote_wanted_max_price, local_notes.lnote_wanted_max_aftt, local_notes.lnote_wanted_damage_hist, "
          sql = sql & " local_notes.lnote_wanted_damage_cur, local_notes.lnote_wanted_start_year"
          sql = sql & " FROM local_notes INNER JOIN"
          sql = sql & " client_priority ON local_notes.lnote_clipri_ID = client_priority.clipri_ID"
          sql = sql & " WHERE (local_notes.lnote_status = '" & status & "')"

        Else
          sql = "SELECT local_notes.lnote_id, local_notes.lnote_jetnet_ac_id, local_notes.lnote_jetnet_comp_id, local_notes.lnote_client_ac_id, local_notes.lnote_client_comp_id, "
          sql = sql & " local_notes.lnote_jetnet_contact_id, local_notes.lnote_client_contact_id, LEFT(local_notes.lnote_note, 21000) AS lnote_note, local_notes.lnote_entry_date, "
          sql = sql & " local_notes.lnote_action_date, local_notes.lnote_user_login, local_notes.lnote_user_name, local_notes.lnote_notecat_key, local_notes.lnote_status, "
          sql = sql & " local_notes.lnote_schedule_start_date, local_notes.lnote_schedule_end_date, local_notes.lnote_user_id, local_notes.lnote_clipri_ID, client_priority.clipri_name, "
          sql = sql & " client_priority.clipri_sort_order, local_notes.lnote_document_flag, local_notes.lnote_jetnet_amod_id, local_notes.lnote_client_amod_id, "
          sql = sql & " local_notes.lnote_document_name, local_notes.lnote_opportunity_status, local_notes.lnote_cash_value, local_notes.lnote_wanted_end_year, "
          sql = sql & " local_notes.lnote_wanted_max_price, local_notes.lnote_wanted_max_aftt, local_notes.lnote_wanted_damage_hist, local_notes.lnote_wanted_damage_cur, "
          sql = sql & " local_notes.lnote_wanted_start_year, local_notes.lnote_capture_percentage"
          sql = sql & " FROM  local_notes INNER JOIN"
          sql = sql & " client_priority ON local_notes.lnote_clipri_ID = client_priority.clipri_ID"
          sql = sql & " WHERE (local_notes.lnote_status = '" & status & "') AND (local_notes.lnote_document_flag = '" & doc_flag & "')"

        End If
      Else
        If doc_flag = "B" Then
          sql = "SELECT local_notes.lnote_id, local_notes.lnote_jetnet_ac_id, local_notes.lnote_jetnet_comp_id, local_notes.lnote_client_ac_id, local_notes.lnote_client_comp_id, "
          sql = sql & " local_notes.lnote_jetnet_contact_id, local_notes.lnote_client_contact_id, LEFT(local_notes.lnote_note, 21000) AS lnote_note, local_notes.lnote_entry_date, "
          sql = sql & " local_notes.lnote_action_date, local_notes.lnote_user_login, local_notes.lnote_user_name, local_notes.lnote_notecat_key, local_notes.lnote_status, "
          sql = sql & " local_notes.lnote_schedule_start_date, local_notes.lnote_schedule_end_date, local_notes.lnote_user_id, local_notes.lnote_clipri_ID, client_priority.clipri_name, "
          sql = sql & " client_priority.clipri_sort_order, local_notes.lnote_document_flag, local_notes.lnote_jetnet_amod_id, local_notes.lnote_client_amod_id, "
          sql = sql & " local_notes.lnote_document_name, local_notes.lnote_opportunity_status, local_notes.lnote_cash_value, local_notes.lnote_capture_percentage, "
          sql = sql & " local_notes.lnote_wanted_start_year, local_notes.lnote_wanted_end_year, local_notes.lnote_wanted_max_price, local_notes.lnote_wanted_max_aftt, "
          sql = sql & " local_notes.lnote_wanted_damage_hist, local_notes.lnote_wanted_damage_cur"
          sql = sql & " FROM local_notes INNER JOIN"
          sql = sql & " client_priority ON local_notes.lnote_clipri_ID = client_priority.clipri_ID"
          sql = sql & " WHERE (local_notes.lnote_status = '" & status & "') AND (local_notes.lnote_user_id = '" & lnote_user_id & "')"
        Else
          sql = "SELECT local_notes.lnote_id, local_notes.lnote_jetnet_ac_id, local_notes.lnote_jetnet_comp_id, local_notes.lnote_client_ac_id, local_notes.lnote_client_comp_id, "
          sql = sql & " local_notes.lnote_jetnet_contact_id, local_notes.lnote_client_contact_id, LEFT(local_notes.lnote_note, 21000) AS lnote_note, local_notes.lnote_entry_date, "
          sql = sql & " local_notes.lnote_action_date, local_notes.lnote_user_login, local_notes.lnote_user_name, local_notes.lnote_notecat_key, local_notes.lnote_status, "
          sql = sql & " local_notes.lnote_schedule_start_date, local_notes.lnote_schedule_end_date, local_notes.lnote_user_id, local_notes.lnote_clipri_ID, client_priority.clipri_name, "
          sql = sql & " client_priority.clipri_sort_order, local_notes.lnote_document_flag, local_notes.lnote_jetnet_amod_id, local_notes.lnote_client_amod_id, "
          sql = sql & " local_notes.lnote_document_name, local_notes.lnote_opportunity_status, local_notes.lnote_cash_value, local_notes.lnote_capture_percentage, "
          sql = sql & " local_notes.lnote_wanted_start_year, local_notes.lnote_wanted_end_year, local_notes.lnote_wanted_max_price, local_notes.lnote_wanted_max_aftt, "
          sql = sql & " local_notes.lnote_wanted_damage_hist, local_notes.lnote_wanted_damage_cur"
          sql = sql & " FROM local_notes INNER JOIN"
          sql = sql & " client_priority ON local_notes.lnote_clipri_ID = client_priority.clipri_ID"
          sql = sql & " WHERE (local_notes.lnote_status = '" & status & "') AND (local_notes.lnote_user_id = '" & lnote_user_id & "')"
          sql = sql & " AND (local_notes.lnote_document_flag = '" & doc_flag & "')"

        End If
      End If


      If status = "P" Then
        sql = sql & " order by lnote_schedule_start_date asc"
      End If


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Local_Notes_Status(ByVal status As String, ByVal lnote_user_id As Integer, ByVal doc_flag As String) As DataTable</b><br />" & sql


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable
    Catch ex As Exception
      Get_Local_Notes_Status = Nothing
      Me.class_error = "Error in SQL Get_Local_Notes_Status(ByVal status As String, ByVal lnote_user_id As Integer, ByVal doc_flag As String) As DataTable: " & ex.Message
    Finally
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: GetLocal_Notes_Extender_Opportunities
  ' Purpose: to get the opportunities local notes based on status, lnote, jetnet_amod_id, client_amod_id
  ' Parameters: status, lnote, jetnet_amod_id, client_amod_id
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/8/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function GetLocal_Notes_Extender_Opportunities(ByVal status As String, ByVal lnote As String, ByVal jetnet_amod_id As String, ByVal client_amod_id As String, ByVal category As Integer, ByVal start_date As String, ByVal end_date As String, ByVal user As String) As DataTable

    Dim sql As String = ""
    Dim aSQL_String_Client_Select As String = ""
    Dim aSQL_String_Client_Where As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim aTempTable As New DataTable

    Try
      aSQL_String_Client_Select = " SELECT local_notes.lnote_id, local_notes.lnote_jetnet_ac_id, local_notes.lnote_jetnet_comp_id, local_notes.lnote_client_ac_id, local_notes.lnote_client_comp_id, "
      aSQL_String_Client_Select = aSQL_String_Client_Select & " local_notes.lnote_jetnet_contact_id, local_notes.lnote_client_contact_id, LEFT(local_notes.lnote_note, 21000) AS lnote_note, local_notes.lnote_entry_date, "
      aSQL_String_Client_Select = aSQL_String_Client_Select & " local_notes.lnote_action_date, local_notes.lnote_user_login, local_notes.lnote_user_name, local_notes.lnote_notecat_key, local_notes.lnote_status, "
      aSQL_String_Client_Select = aSQL_String_Client_Select & " local_notes.lnote_schedule_start_date, local_notes.lnote_schedule_end_date, local_notes.lnote_user_id, local_notes.lnote_clipri_ID, client_priority.clipri_name, "
      aSQL_String_Client_Select = aSQL_String_Client_Select & " client_priority.clipri_sort_order, local_notes.lnote_document_flag, local_notes.lnote_jetnet_amod_id, local_notes.lnote_client_amod_id, "
      aSQL_String_Client_Select = aSQL_String_Client_Select & " local_notes.lnote_document_name, local_notes.lnote_opportunity_status, local_notes.lnote_cash_value, local_notes.lnote_capture_percentage, "
      aSQL_String_Client_Select = aSQL_String_Client_Select & "local_notes.lnote_wanted_start_year, local_notes.lnote_wanted_end_year, local_notes.lnote_wanted_max_price, local_notes.lnote_wanted_max_aftt, "
      aSQL_String_Client_Select = aSQL_String_Client_Select & " local_notes.lnote_wanted_damage_hist, local_notes.lnote_wanted_damage_cur"
      aSQL_String_Client_Select = aSQL_String_Client_Select & " FROM local_notes INNER JOIN client_priority ON local_notes.lnote_clipri_ID = client_priority.clipri_ID "

      If status <> "" Then
        aSQL_String_Client_Where = "local_notes.lnote_status = '" & status & "' "
      End If
      If lnote <> "" Then
        If aSQL_String_Client_Where <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & "AND local_notes.lnote_note LIKE '" & lnote & "' "
        Else
          aSQL_String_Client_Where = "local_notes.lnote_note LIKE '" & lnote & "' "
        End If
      End If

      If category <> 0 Then
        If aSQL_String_Client_Where <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & " AND local_notes.lnote_notecat_key = '" & category & "' "
        Else
          aSQL_String_Client_Where = " local_notes.lnote_notecat_key = '" & category & "' "
        End If
      End If


      If start_date <> "" Then
        If aSQL_String_Client_Where <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & " AND local_notes.lnote_entry_date >= '" & start_date & "' "
        Else
          aSQL_String_Client_Where = " local_notes.lnote_entry_date = '" & start_date & "' "
        End If
      End If

      If end_date <> "" Then
        If aSQL_String_Client_Where <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & " AND local_notes.lnote_entry_date <= '" & end_date & "' "
        Else
          aSQL_String_Client_Where = " local_notes.lnote_entry_date <= '" & end_date & "' "
        End If
      End If

      If user <> "0" Then
        If aSQL_String_Client_Where <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & " AND local_notes.lnote_user_id = '" & user & "' "
        Else
          aSQL_String_Client_Where = " local_notes.lnote_user_id = '" & user & "' "
        End If
      End If

      If jetnet_amod_id <> "" Then
        If aSQL_String_Client_Where <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & "AND local_notes.lnote_jetnet_amod_id in(" & jetnet_amod_id & ") "
        Else
          aSQL_String_Client_Where = " local_notes.lnote_jetnet_amod_id in(" & jetnet_amod_id & ") "
        End If
      End If
      If client_amod_id <> "" Then
        If aSQL_String_Client_Where <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & "AND local_notes.lnote_client_amod_id in ( " & client_amod_id & ") "
        Else
          aSQL_String_Client_Where = " local_notes.lnote_client_amod_id in (" & client_amod_id & ") "
        End If
      End If

      sql = aSQL_String_Client_Select

      If aSQL_String_Client_Where <> "" Then
        sql = sql & " where " & aSQL_String_Client_Where
      Else
        sql = sql & " limit 1000"
      End If

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>GetLocal_Notes_Extender_Opportunities(ByVal status As String, ByVal lnote As String, ByVal jetnet_amod_id As String, ByVal client_amod_id As String, ByVal category As Integer, ByVal start_date As String, ByVal end_date As String, ByVal user As String) As DataTable</b><br />" & sql


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable
    Catch ex As Exception
      GetLocal_Notes_Extender_Opportunities = Nothing
      Me.class_error = "Error in SQL GetLocal_Notes_Extender_Opportunities(ByVal status As String, ByVal lnote As String, ByVal jetnet_amod_id As String, ByVal client_amod_id As String, ByVal category As Integer, ByVal start_date As String, ByVal end_date As String, ByVal user As String) As DataTable: " & ex.Message
    Finally
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Local_Notes_Action_Item
  ' Purpose: to get the JobSeeker details based on contact_Id
  ' Parameters: lnote (what is typed in the search box), status (where status <> @status), WhatToOrderBy (which order by clause i.e. DATE, PRI_NAME)
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/8/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Local_Notes_Action_Item(ByVal lnote As String, ByVal status As String, ByVal WhatToOrderBy As String, ByVal lnote_user_id As Integer) As DataTable
    Dim sql As String = ""
    Dim aSQL_String_Client_Select As String = ""
    Dim aSQL_String_Client_Where As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim aTempTable As New DataTable

    Try
      Select Case WhatToOrderBy
        Case "DATE"
          If lnote_user_id = 0 Then
            sql = "SELECT local_notes.lnote_id, local_notes.lnote_jetnet_ac_id, local_notes.lnote_jetnet_comp_id, local_notes.lnote_client_ac_id, local_notes.lnote_client_comp_id, "
            sql = sql & "  local_notes.lnote_jetnet_contact_id, local_notes.lnote_client_contact_id, LEFT(local_notes.lnote_note, 21000) AS lnote_note, local_notes.lnote_entry_date, "
            sql = sql & " local_notes.lnote_action_date, local_notes.lnote_user_login, local_notes.lnote_user_name, local_notes.lnote_notecat_key, local_notes.lnote_status, "
            sql = sql & " local_notes.lnote_schedule_start_date, local_notes.lnote_schedule_end_date, local_notes.lnote_user_id, local_notes.lnote_clipri_ID, client_priority.clipri_name, "
            sql = sql & " client_priority.clipri_sort_order, local_notes.lnote_document_flag, local_notes.lnote_jetnet_amod_id, local_notes.lnote_client_amod_id, "
            sql = sql & " local_notes.lnote_document_name, local_notes.lnote_opportunity_status, local_notes.lnote_cash_value, local_notes.lnote_capture_percentage, "
            sql = sql & " local_notes.lnote_wanted_end_year, local_notes.lnote_wanted_max_price, local_notes.lnote_wanted_max_aftt, local_notes.lnote_wanted_damage_hist, "
            sql = sql & " local_notes.lnote_wanted_damage_cur, local_notes.lnote_wanted_start_year"
            sql = sql & " FROM  local_notes INNER JOIN"
            sql = sql & " client_priority ON local_notes.lnote_clipri_ID = client_priority.clipri_ID"
            sql = sql & " WHERE (local_notes.lnote_note LIKE '" & lnote & "') AND (local_notes.lnote_status not in ('" & status & "', 'E', 'O', 'B'))"
            sql = sql & " ORDER BY local_notes.lnote_schedule_start_date"
          Else
            sql = "SELECT   local_notes.lnote_id, local_notes.lnote_jetnet_ac_id, local_notes.lnote_jetnet_comp_id, local_notes.lnote_client_ac_id, local_notes.lnote_client_comp_id, "
            sql = sql & " local_notes.lnote_jetnet_contact_id, local_notes.lnote_client_contact_id, LEFT(local_notes.lnote_note, 21000) AS lnote_note, local_notes.lnote_entry_date, "
            sql = sql & " local_notes.lnote_action_date, local_notes.lnote_user_login, local_notes.lnote_user_name, local_notes.lnote_notecat_key, local_notes.lnote_status, "
            sql = sql & " local_notes.lnote_schedule_start_date, local_notes.lnote_schedule_end_date, local_notes.lnote_user_id, local_notes.lnote_clipri_ID, client_priority.clipri_name, "
            sql = sql & " client_priority.clipri_sort_order, local_notes.lnote_document_flag, local_notes.lnote_jetnet_amod_id, local_notes.lnote_client_amod_id, "
            sql = sql & " local_notes.lnote_document_name, local_notes.lnote_opportunity_status, local_notes.lnote_cash_value, local_notes.lnote_capture_percentage, "
            sql = sql & " local_notes.lnote_wanted_start_year, local_notes.lnote_wanted_end_year, local_notes.lnote_wanted_max_price, local_notes.lnote_wanted_max_aftt, "
            sql = sql & " local_notes.lnote_wanted_damage_hist, local_notes.lnote_wanted_damage_cur"
            sql = sql & " FROM  local_notes INNER JOIN"
            sql = sql & "  client_priority ON local_notes.lnote_clipri_ID = client_priority.clipri_ID"
            sql = sql & " WHERE (local_notes.lnote_note LIKE '" & lnote & "') AND (local_notes.lnote_status not in ('" & status & "', 'E', 'O', 'B')) AND (local_notes.lnote_user_id = '" & lnote_user_id & "')"
            sql = sql & " ORDER BY local_notes.lnote_schedule_start_date"
          End If
        Case "PRI_NAME"
          If lnote_user_id = 0 Then
            sql = "SELECT local_notes.lnote_id, local_notes.lnote_jetnet_ac_id, local_notes.lnote_jetnet_comp_id, local_notes.lnote_client_ac_id, local_notes.lnote_client_comp_id, "
            sql = sql & " local_notes.lnote_jetnet_contact_id, local_notes.lnote_client_contact_id, LEFT(local_notes.lnote_note, 21000) AS lnote_note, local_notes.lnote_entry_date, "
            sql = sql & " local_notes.lnote_action_date, local_notes.lnote_user_login, local_notes.lnote_user_name, local_notes.lnote_notecat_key, local_notes.lnote_status, "
            sql = sql & " local_notes.lnote_schedule_start_date, local_notes.lnote_schedule_end_date, local_notes.lnote_user_id, local_notes.lnote_clipri_ID, client_priority.clipri_name, "
            sql = sql & " client_priority.clipri_sort_order, local_notes.lnote_document_flag, local_notes.lnote_jetnet_amod_id, local_notes.lnote_client_amod_id, "
            sql = sql & " local_notes.lnote_document_name, local_notes.lnote_opportunity_status, local_notes.lnote_cash_value, local_notes.lnote_capture_percentage, "
            sql = sql & " local_notes.lnote_wanted_start_year, local_notes.lnote_wanted_end_year, local_notes.lnote_wanted_max_price, local_notes.lnote_wanted_max_aftt, "
            sql = sql & " local_notes.lnote_wanted_damage_hist, local_notes.lnote_wanted_damage_cur"
            sql = sql & " FROM local_notes INNER JOIN"
            sql = sql & " client_priority ON local_notes.lnote_clipri_ID = client_priority.clipri_ID"
            sql = sql & " WHERE (local_notes.lnote_note LIKE '" & lnote & "') AND (local_notes.lnote_status not in ('" & status & "', 'E', 'O', 'B'))"
            sql = sql & " ORDER BY client_priority.clipri_name"

          Else
            sql = "SELECT local_notes.lnote_id, local_notes.lnote_jetnet_ac_id, local_notes.lnote_jetnet_comp_id, local_notes.lnote_client_ac_id, local_notes.lnote_client_comp_id, "
            sql = sql & " local_notes.lnote_jetnet_contact_id, local_notes.lnote_client_contact_id, LEFT(local_notes.lnote_note, 21000) AS lnote_note, local_notes.lnote_entry_date, "
            sql = sql & " local_notes.lnote_action_date, local_notes.lnote_user_login, local_notes.lnote_user_name, local_notes.lnote_notecat_key, local_notes.lnote_status, "
            sql = sql & " local_notes.lnote_schedule_start_date, local_notes.lnote_schedule_end_date, local_notes.lnote_user_id, local_notes.lnote_clipri_ID, client_priority.clipri_name, "
            sql = sql & " client_priority.clipri_sort_order, local_notes.lnote_document_flag, local_notes.lnote_jetnet_amod_id, local_notes.lnote_client_amod_id, "
            sql = sql & " local_notes.lnote_document_name, local_notes.lnote_opportunity_status, local_notes.lnote_cash_value, local_notes.lnote_capture_percentage, "
            sql = sql & " local_notes.lnote_wanted_start_year, local_notes.lnote_wanted_end_year, local_notes.lnote_wanted_max_price, local_notes.lnote_wanted_max_aftt, "
            sql = sql & " local_notes.lnote_wanted_damage_hist, local_notes.lnote_wanted_damage_cur"
            sql = sql & " FROM  local_notes INNER JOIN"
            sql = sql & " client_priority ON local_notes.lnote_clipri_ID = client_priority.clipri_ID"
            sql = sql & " WHERE  (local_notes.lnote_note LIKE '" & lnote & "') AND (local_notes.lnote_status not in ('" & status & "', 'E', 'O', 'B')) AND (local_notes.lnote_user_id = '" & lnote_user_id & "')"
            sql = sql & " ORDER BY client_priority.clipri_name"
          End If
      End Select


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Local_Notes_Action_Item(ByVal lnote As String, ByVal status As String, ByVal WhatToOrderBy As String, ByVal lnote_user_id As Integer) As DataTable</b><br />" & sql


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable
    Catch ex As Exception
      Get_Local_Notes_Action_Item = Nothing
      Me.class_error = "Error in SQL Get_Local_Notes_Action_Item(ByVal lnote As String, ByVal status As String, ByVal WhatToOrderBy As String, ByVal lnote_user_id As Integer) As DataTable: " & ex.Message
    Finally
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Close()
      MySqlConn.Dispose()

      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Local_Notes_Schedule_Date_CalDisplay
  ' Purpose: to display the note information on the calendar along with the company name.
  ' Parameters: schedule_date, schedule_date2, timezone_offset
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/8/2012    - Created By: Amanda Jennings
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Local_Notes_Schedule_Date_CalDisplay(ByVal schedule_date As String, ByVal schedule_date2 As String, ByVal timezone_offset As String) As DataTable
    Try
      ' create a dataset for the client
      Dim dsClient As New DataSet
      ' setup the connection string
      Dim atemptable As New DataTable


      ' fill the data set

      atemptable = ScheduleDateforCalendar(schedule_date, schedule_date2, HttpContext.Current.Session("timezone_offset"), "P")

      dsClient.Tables.Add(atemptable)

      '''''''''''''''''''''''''''''''''
      ' passed -2
      ' can get -3,0,-1,-2,1,0.5,-4,-5
      '''''''''''''''''''''''''''''''''
      ' create a dbnull variable
      Dim aDBNULL As DBNull = Nothing
      ' crate a date/time to hold the start date
      Dim aStart_date As System.DateTime = System.DateTime.Now
      ' create a date/time to hold th end date
      Dim aEnd_date As System.DateTime = System.DateTime.Now
      If Not IsNothing(dsClient) Then
        If dsClient.Tables(0).Rows.Count > 0 Then
          ' reset the time fields
          For x As Integer = 0 To dsClient.Tables(0).Rows.Count - 1
            'aStart_date = ""
            aStart_date = IIf(Not IsDBNull(dsClient.Tables(0).Rows(x).Item("lnote_schedule_start_date")), dsClient.Tables(0).Rows(x).Item("lnote_schedule_start_date"), aDBNULL)
            aEnd_date = IIf(Not IsDBNull(dsClient.Tables(0).Rows(x).Item("lnote_schedule_end_date")), dsClient.Tables(0).Rows(x).Item("lnote_schedule_end_date"), aDBNULL)
            If Not IsDBNull(aStart_date) Then
              aStart_date = aStart_date.AddHours(timezone_offset)
            End If
            If Not IsDBNull(aEnd_date) Then
              aEnd_date = aEnd_date.AddHours(timezone_offset)
            End If
            dsClient.Tables(0).Rows(x).Item("lnote_schedule_start_date") = aStart_date
            dsClient.Tables(0).Rows(x).Item("lnote_schedule_end_date") = aEnd_date
          Next
        End If
      End If

      Dim aDataTable As DataTable = dsClient.Tables(0).Clone

      Dim hold_id As Integer = 0
      If Not IsNothing(HttpContext.Current.Session.Item("localUser").crmLocalUserID) Then
        hold_id = HttpContext.Current.Session.Item("localUser").crmLocalUserID
      End If
      ' create a datarow to filter in the rows by make_name
      Dim afileterd As DataRow() = dsClient.Tables(0).Select("lnote_status <> 'D' and lnote_user_id = '" & hold_id & "'", "")

      ' create another datarow to import the filtered info
      For Each atmpDataRow As DataRow In afileterd
        aDataTable.ImportRow(atmpDataRow)
      Next

      Dim dtJETNET As DataTable = aDataTable
      If aDataTable.Rows.Count > 0 Then
        '    ' reset the time fields
        For y As Integer = 0 To aDataTable.Rows.Count - 1

          Dim aDS, aDS1 As New DataSet
          Dim aTempTable2 As New DataTable
          'aDS.Tables.Add(New DataTable)
          'If dtJETNET.Rows(y).Item("lnote_jetnet_comp_id") <> 0 Then
          '    Dim comp_id As Integer = dtJETNET.Rows(y).Item("lnote_jetnet_comp_id")
          '    If Me.bolDisable_JETNET Then
          '        Dim dtEmpty As New crmDataMgrClassLibrary.crmDataSetClass_MySQL.dtJETNET_Aircraft_DetailsDataTable
          '    Else
          '        dtJETNET = GetCompanyInfo_ID(comp_id, "JETNET")
          '        aDS.Tables.Add(dtJETNET)
          '    End If
          'Else
          If aDataTable.Rows(y).Item("lnote_client_comp_id") <> 0 Then
            Dim comp_id As Integer = aDataTable.Rows(y).Item("lnote_client_comp_id")
            dtJETNET = GetCompanyInfo_ID(comp_id, "CLIENT", 0)
            aDS.Tables.Add(dtJETNET)
          End If

          Dim cal_string As String = ""
          cal_string = Left(aDataTable.Rows(y).Item("lnote_note"), 100)
          If aDS.Tables(0).Rows.Count > 0 Then
            ' dtJETNET.Rows(y).Item("lnote_note") = 
            cal_string = cal_string & " (<em style='color:#330099;'>" & aDS.Tables(0).Rows(0).Item("comp_name") & "</em>)"
          End If



          'If dtJETNET.Rows(y).Item("lnote_jetnet_ac_id") <> 0 Then

          '    Dim ac_id As Integer = dtJETNET.Rows(y).Item("lnote_jetnet_ac_id")
          '    If Me.bolDisable_JETNET Then
          '        Dim dtEmpty As New crmDataMgrClassLibrary.crmDataSetClass_MySQL.dtJETNET_Aircraft_DetailsDataTable
          '        aDS1.Tables.Add(dtEmpty)
          '    Else
          '        dtJETNET = New DataTable
          '        dtJETNET = GetJETNET_Aircraft_Details_AC_ID(ac_id, "")
          '        aDS1.Tables.Add(dtJETNET)
          '        If aDS1.Tables(0).Rows.Count > 0 Then
          '            cal_string = cal_string & " <em style='color:#339900;'>(AC Ser #:" & aDS1.Tables(0).Rows(0).Item("ac_ser_nbr") & ", Reg#:" & aDS1.Tables(0).Rows(0).Item("ac_reg_nbr") & ")</em>"
          '        End If
          '    End If

          'Else
          If aDataTable.Rows(y).Item("lnote_client_ac_id") <> 0 Then
            Dim ac_id As Integer = dtJETNET.Rows(y).Item("lnote_client_ac_id")
            dtJETNET = New DataTable
            dtJETNET = Get_Clients_Aircraft(ac_id)
            aDS1.Tables.Add(dtJETNET)

            If aDS1.Tables(0).Rows.Count > 0 Then
              cal_string = cal_string & " <em style='color:#339900;'>(AC Ser #:" & aDS1.Tables(0).Rows(0).Item("cliaircraft_ser_nbr") & ", Reg#:" & aDS1.Tables(0).Rows(0).Item("cliaircraft_reg_nbr") & ")</em>"
            End If
          End If

          If aDataTable.Rows(y).Item("lnote_status") = "C" Then
            cal_string = cal_string & " <em style='color:#ff0000;font-weight:bold;font-style:normal;'>Completed</em>"
          End If

          aDataTable.Rows(y).Item("lnote_note") = cal_string
        Next
      End If

      Get_Local_Notes_Schedule_Date_CalDisplay = aDataTable
    Catch ex As Exception
      Get_Local_Notes_Schedule_Date_CalDisplay = Nothing
      aError = ex.Message
      Me.class_error = "Error in Get_Local_Notes_Schedule_Date_CalDisplay(ByVal schedule_date As String, ByVal schedule_date2 As String, ByVal timezone_offset As String): " & ex.Message
    End Try
  End Function


  Public Function Get_Open_Market_Valuation(ByRef AircraftID As Long, Optional ByVal clival_id As Long = 0) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim aTempTable As New DataTable

    Try

      sql = "SELECT local_notes.lnote_id, local_notes.lnote_jetnet_ac_id, local_notes.lnote_jetnet_comp_id, local_notes.lnote_client_ac_id, local_notes.lnote_client_comp_id, "
      sql = sql & " local_notes.lnote_jetnet_contact_id, local_notes.lnote_client_contact_id, LEFT(local_notes.lnote_note, 21000) AS lnote_note, local_notes.lnote_entry_date, "
      sql = sql & " local_notes.lnote_action_date, local_notes.lnote_user_login, local_notes.lnote_user_name, local_notes.lnote_notecat_key, local_notes.lnote_status, "
      sql = sql & " local_notes.lnote_schedule_start_date, local_notes.lnote_schedule_end_date, local_notes.lnote_user_id, local_notes.lnote_clipri_ID "

      If clival_id > 0 Then
      Else
        sql = sql & ", client_priority.clipri_name , client_priority.clipri_sort_order "
      End If

      sql = sql & ", local_notes.lnote_document_flag, local_notes.lnote_jetnet_amod_id, local_notes.lnote_client_amod_id, "
      sql = sql & " local_notes.lnote_document_name, local_notes.lnote_opportunity_status, local_notes.lnote_cash_value, local_notes.lnote_capture_percentage, "
      sql = sql & " local_notes.lnote_wanted_start_year, local_notes.lnote_wanted_end_year, local_notes.lnote_wanted_max_price, local_notes.lnote_wanted_max_aftt, "
      sql = sql & " local_notes.lnote_wanted_damage_hist, local_notes.lnote_wanted_damage_cur"

      If clival_id > 0 Then
        sql = sql & ", clival_type , clival_asking_price as asking_price, clival_est_price as take_price, clival_broker_price as sold_price, clival_aftt_hours, clival_total_landings, clival_entry_date "
      End If

      sql = sql & " FROM local_notes "

      If clival_id > 0 Then
        sql = sql & " INNER JOIN client_value_comparables on lnote_id = clival_note_id and lnote_status in ('D') "
        sql += " WHERE clival_id = " & clival_id
      Else
        sql = sql & "  INNER JOIN client_priority ON local_notes.lnote_clipri_ID = client_priority.clipri_ID"
        sql = sql & " WHERE (local_notes.lnote_status = 'V') AND (local_notes.lnote_opportunity_status = 'O' or local_notes.lnote_opportunity_status = 'T')"
        sql += " and local_notes.lnote_client_ac_id = " & AircraftID
      End If



      sql = sql & " order by lnote_entry_date asc"



      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Open_Market_Valuation(ByRef AircraftID As Long) As DataTable</b><br />" & sql


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable
    Catch ex As Exception
      Get_Open_Market_Valuation = Nothing
      Me.class_error = "Error in SQL Get_Open_Market_Valuation(ByRef AircraftID As Long) As DataTable: " & ex.Message
    Finally
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
#End Region
#Region "Only Contact Client"
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Delete_Client_Contact
  ' Purpose: to delete a clients transaction info
  ' Parameters: Delete_Client_Contact
  ' Return: 
  '       integer
  ' Change Log
  '           6/29/2010    - Created By: Tom Jones
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Delete_Client_Contact(ByVal clicontact_id As Integer) As Integer
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Delete_Client_Contact = 0
    Try
      sql = "DELETE FROM client_contact WHERE (clicontact_id = " & clicontact_id & ") limit 1 "

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Delete_Client_Contact(ByVal clicontact_id As Integer) As Integer</b><br />" & sql

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Delete_Client_Contact = 1
    Catch ex As Exception
      Delete_Client_Contact = 0
      Me.class_error = "Error in SQL Delete_Client_Contact(ByVal clicontact_id As Integer) as integer  " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: GetLatestContactByUserID
  ' Purpose: to get a specific company based on the ID and source
  ' Parameters: clicontact_user_id
  ' Return: 
  '       DataTable
  ' Change Log
  '           1/11/2012    - Created By: Amanda Jennings

  'SELECT  clicontact_id AS contact_id, clicontact_comp_id AS contact_comp_id, clicontact_sirname AS contact_sirname, clicontact_first_name AS contact_first_name, 
  '                     clicontact_middle_initial AS contact_middle_initial, clicontact_last_name AS contact_last_name, clicontact_suffix AS contact_suffix, clicontact_title AS contact_title, 
  '                     clicontact_email_address AS contact_email_address, clicontact_action_date AS contact_action_date, 'Client' AS contact_type, clicontact_notes, clicontact_email_list, 
  '                     clicontact_preferred_name, clicontact_status, clicontact_jetnet_contact_id, clicontact_user_id
  'FROM            client_contact
  'where clicontact_user_id = @clicontact_user_id order by contact_action_date desc
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function GetLatestContactByUserID(ByVal clicontact_user_id As Integer) As DataTable
    Try

      Dim atemptable As New DataTable
      GetLatestContactByUserID = atemptable

      Dim query As String = ""
      query = " SELECT  clicontact_id AS contact_id, clicontact_comp_id AS contact_comp_id, clicontact_sirname AS contact_sirname, clicontact_first_name AS contact_first_name, "
      query = query & " clicontact_middle_initial AS contact_middle_initial, clicontact_last_name AS contact_last_name, clicontact_suffix AS contact_suffix, clicontact_title AS contact_title, "
      query = query & " clicontact_email_address AS contact_email_address, clicontact_action_date AS contact_action_date, 'Client' AS contact_type, clicontact_notes, clicontact_email_list, "
      query = query & " clicontact_preferred_name, clicontact_status, clicontact_jetnet_contact_id, clicontact_user_id"
      query = query & " FROM client_contact "
      query = query & " where clicontact_user_id = " & clicontact_user_id & " order by contact_action_date desc limit 5"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>GetLatestContactByUserID(ByVal clicontact_user_id As Integer) As DataTable</b><br />" & query



      atemptable.Columns.Add("contact_id")
      atemptable.Columns.Add("contact_comp_id")
      atemptable.Columns.Add("contact_sirname")
      atemptable.Columns.Add("contact_first_name")
      atemptable.Columns.Add("contact_middle_initial")
      atemptable.Columns.Add("contact_last_name")
      atemptable.Columns.Add("contact_suffix")
      atemptable.Columns.Add("contact_title")
      atemptable.Columns.Add("contact_email_address")
      atemptable.Columns.Add("contact_action_date")
      atemptable.Columns.Add("contact_type")
      atemptable.Columns.Add("clicontact_notes")
      atemptable.Columns.Add("clicontact_email_list")
      atemptable.Columns.Add("clicontact_preferred_name")
      atemptable.Columns.Add("clicontact_status")
      atemptable.Columns.Add("clicontact_jetnet_contact_id")
      atemptable.Columns.Add("clicontact_user_id")

      Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
      Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
      Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
      Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
      Try
        MySqlConn.ConnectionString = Me.client_DB

        MySqlConn.Open()
        MySqlCommand.Connection = MySqlConn
        MySqlCommand.CommandType = CommandType.Text
        MySqlCommand.CommandTimeout = 60
        MySqlCommand.CommandText = query
        MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

        While MySqlReader.Read()
          Dim newCustomersRow As DataRow = atemptable.NewRow()
          newCustomersRow("contact_id") = MySqlReader.Item("contact_id")
          newCustomersRow("contact_comp_id") = MySqlReader.Item("contact_comp_id")
          newCustomersRow("contact_sirname") = MySqlReader.Item("contact_sirname")
          newCustomersRow("contact_first_name") = MySqlReader.Item("contact_first_name")
          newCustomersRow("contact_middle_initial") = MySqlReader.Item("contact_middle_initial")
          newCustomersRow("contact_suffix") = MySqlReader.Item("contact_suffix")
          newCustomersRow("contact_title") = MySqlReader.Item("contact_title")
          newCustomersRow("contact_email_address") = MySqlReader.Item("contact_email_address")
          newCustomersRow("contact_action_date") = MySqlReader.Item("contact_action_date")
          newCustomersRow("contact_type") = MySqlReader.Item("contact_type")
          newCustomersRow("clicontact_notes") = MySqlReader.Item("clicontact_notes")
          newCustomersRow("clicontact_email_list") = MySqlReader.Item("clicontact_email_list")
          newCustomersRow("clicontact_preferred_name") = MySqlReader.Item("clicontact_preferred_name")
          newCustomersRow("clicontact_status") = MySqlReader.Item("clicontact_status")
          newCustomersRow("clicontact_jetnet_contact_id") = MySqlReader.Item("clicontact_jetnet_contact_id")
          newCustomersRow("clicontact_user_id") = MySqlReader.Item("clicontact_user_id")

          atemptable.Rows.Add(newCustomersRow)
          atemptable.AcceptChanges()
        End While

      Catch ex As Exception
      Finally
        MySqlReader.Close()
        MySqlReader = Nothing

        MySqlConn.Dispose()
        MySqlConn.Close()
        MySqlConn = Nothing

        MySqlCommand.Dispose()
        MySqlCommand = Nothing
      End Try


      Return atemptable

    Catch ex As Exception
      GetLatestContactByUserID = Nothing
      Me.class_error = "Error in GetLatestContactByUserID(ByVal clicontact_user_id As Integer): " & ex.Message
    End Try
  End Function
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  '' Method name: GetContacts_JetnetID
  '' Return: 
  ''       DataTable
  '' Change Log
  ''           1/31/2012    - Created By: Amanda Vaughn
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function GetContacts_Details_JETNETID(ByVal jetnet_contact_id As Integer) As DataTable
    Dim sql As String = ""
    Dim atemptable As New DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Try
      sql = "SELECT clicontact_id AS contact_id, clicontact_comp_id AS contact_comp_id, "
      sql = sql & " clicontact_sirname AS contact_sirname, clicontact_first_name AS contact_first_name, "
      sql = sql & " clicontact_middle_initial AS contact_middle_initial, clicontact_last_name AS contact_last_name, "
      sql = sql & " clicontact_suffix AS contact_suffix, clicontact_title AS contact_title, "
      sql = sql & " clicontact_email_address AS contact_email_address, clicontact_action_date AS "
      sql = sql & " contact_action_date, clicontact_jetnet_contact_id AS contact_jetnet_contact_id, "
      sql = sql & " clicontact_preferred_name AS contact_preferred_name, clicontact_notes AS contact_notes, "
      sql = sql & " clicontact_email_list AS contact_email_list, clicontact_status, clicontact_user_id "
      sql = sql & " FROM client_contact where clicontact_jetnet_contact_id = " & jetnet_contact_id

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>GetContacts_Details_JETNETID(ByVal jetnet_contact_id As Integer) As DataTable</b><br />" & sql

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Return atemptable
    Catch ex As Exception
      GetContacts_Details_JETNETID = Nothing
      Me.class_error = "Error in GetContacts_Details_JETNETID(ByVal jetnet_contact_id As Integer) As DataTable: " & ex.Message
    Finally
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Insert_Client_Contact
  ' Purpose: to insert a new client record
  ' Parameters: class clsClient_Contact
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/4/2012   - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Insert_Client_Contact(ByVal aclsClient_Contact As clsClient_Contact) As Boolean
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Insert_Client_Contact = False
    Try

      sql = " INSERT INTO client_contact (clicontact_comp_id, clicontact_sirname, clicontact_first_name, clicontact_middle_initial, clicontact_last_name, clicontact_suffix, clicontact_title, clicontact_email_address, clicontact_action_date, clicontact_notes, clicontact_email_list, clicontact_preferred_name, clicontact_status, clicontact_jetnet_contact_id, clicontact_user_id) "
      sql = sql & " VALUES ('" & aclsClient_Contact.clicontact_comp_id & "', "
      sql = sql & "'" & Replace(Left(aclsClient_Contact.clicontact_sirname, 10), "'", "\'") & "', "
      sql = sql & "'" & Replace(Left(aclsClient_Contact.clicontact_first_name, 50), "'", "\'") & "', "
      sql = sql & "'" & Replace(Left(aclsClient_Contact.clicontact_middle_initial, 1), "'", "\'") & "', "
      sql = sql & "'" & Replace(Left(aclsClient_Contact.clicontact_last_name, 50), "'", "\'") & "', "
      sql = sql & "'" & Replace(Left(aclsClient_Contact.clicontact_suffix, 5), "'", "\'") & "', "
      sql = sql & "'" & Replace(Left(aclsClient_Contact.clicontact_title, 40), "'", "\'") & "', "
      sql = sql & "'" & Replace(Left(aclsClient_Contact.clicontact_email_address, 150), "'", "\'") & "', "
      If IsDate(aclsClient_Contact.clicontact_date_updated) Then
        sql = sql & "'" & Format(CDate(aclsClient_Contact.clicontact_date_updated), "yyyy-MM-dd HH:mm:ss") & "', "
      Else
        sql = sql & "NULL, "
      End If
      sql = sql & "'" & Replace(Left(aclsClient_Contact.clicontact_notes, 21845), "'", "\'") & "', "
      sql = sql & "'" & Replace(Left(aclsClient_Contact.clicontact_email_list, 3), "'", "\'") & "', "
      sql = sql & "'" & Replace(Left(aclsClient_Contact.clicontact_preferred_name, 20), "'", "\'") & "', "
      sql = sql & "'" & Replace(Left(aclsClient_Contact.clicontact_status, 1), "'", "\'") & "', "
      sql = sql & "'" & aclsClient_Contact.clicontact_jetnet_contact_id & "', "
      sql = sql & "'" & aclsClient_Contact.clicontact_user_id & "' )"
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Insert_Client_Contact(ByVal aclsClient_Contact As clsClient_Contact) As Boolean</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Insert_Client_Contact = True
    Catch ex As Exception
      Insert_Client_Contact = False
      Me.class_error = "Error in SQL Insert_Client_Contact(ByVal aclsClient_Contact As clsClient_Contact) As Boolean " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Update_Client_Contact
  ' Purpose: to update a new client record
  ' Parameters: class clsClient_Contact
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/6/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Update_Client_Contact(ByVal aclsClient_Contact As clsClient_Contact) As Boolean
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Update_Client_Contact = False
    Try
      sql = "UPDATE client_contact SET clicontact_comp_id = '" & aclsClient_Contact.clicontact_comp_id & "', "
      sql = sql & " clicontact_sirname = '" & Replace(Left(aclsClient_Contact.clicontact_sirname, 10), "'", "\'") & "', "
      sql = sql & " clicontact_first_name = '" & Replace(Left(aclsClient_Contact.clicontact_first_name, 15), "'", "\'") & "', "
      sql = sql & " clicontact_middle_initial = '" & Replace(Left(aclsClient_Contact.clicontact_middle_initial, 1), "'", "\'") & "', "
      sql = sql & " clicontact_last_name = '" & Replace(Left(aclsClient_Contact.clicontact_last_name, 25), "'", "\'") & "', "
      sql = sql & " clicontact_suffix = '" & Replace(Left(aclsClient_Contact.clicontact_suffix, 5), "'", "\'") & "', "
      sql = sql & " clicontact_title = '" & Replace(Left(aclsClient_Contact.clicontact_title, 40), "'", "\'") & "', "
      sql = sql & " clicontact_email_address = '" & Replace(Left(aclsClient_Contact.clicontact_email_address, 70), "'", "\'") & "', "


      sql = sql & " clicontact_action_date = '" & Format(CDate(aclsClient_Contact.clicontact_date_updated), "yyyy-MM-dd HH:mm:ss") & "', "


      sql = sql & " clicontact_notes = '" & Replace(Left(aclsClient_Contact.clicontact_notes, 21845), "'", "\'") & "', "
      sql = sql & " clicontact_email_list = '" & Replace(Left(aclsClient_Contact.clicontact_email_list, 3), "'", "\'") & "', "
      sql = sql & " clicontact_preferred_name = '" & Replace(Left(aclsClient_Contact.clicontact_preferred_name, 20), "'", "\'") & "', "
      sql = sql & " clicontact_status = '" & Replace(Left(aclsClient_Contact.clicontact_status, 3), "'", "\'") & "', "
      sql = sql & " clicontact_jetnet_contact_id = '" & aclsClient_Contact.clicontact_jetnet_contact_id & "', "
      sql = sql & " clicontact_user_id = '" & aclsClient_Contact.clicontact_user_id & "' "
      sql = sql & " WHERE ((clicontact_id = '" & aclsClient_Contact.clicontact_id & "')) limit 1 "

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Update_Client_Contact(ByVal aclsClient_Contact As clsClient_Contact) As Boolean</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Update_Client_Contact = True
    Catch ex As Exception
      Update_Client_Contact = False
      Me.class_error = "Error in SQL Update_Client_Contact(ByVal aclsClient_Contact As clsClient_Contact) As Boolean " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Insert_Client_Contact
  ' Purpose: to get the last record that was inserted into the Client Contact Table
  ' Parameters: compdID of the company inserted, action_date of the company inserted
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/6/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Insert_Client_Contact(ByVal acompID As Integer, ByVal aAction_date As String, ByVal clicontact_status As String) As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Dim sql As String = ""
    Try
      sql = " SELECT clicontact_id AS contact_id, clicontact_comp_id AS contact_comp_id, clicontact_sirname AS contact_sirname, clicontact_first_name AS contact_first_name, "
      sql = sql & " clicontact_middle_initial AS contact_middle_initial, clicontact_last_name AS contact_last_name, clicontact_suffix AS contact_suffix, clicontact_title AS contact_title, "
      sql = sql & " clicontact_email_address AS contact_email_address, clicontact_action_date AS contact_action_date, 'Client' AS contact_type, clicontact_notes, clicontact_email_list, "
      sql = sql & " clicontact_preferred_name, clicontact_status, clicontact_jetnet_contact_id, clicontact_user_id"
      sql = sql & " FROM client_contact WHERE (clicontact_comp_id = '" & acompID & "') AND (clicontact_action_date = '" & aAction_date & "') AND (clicontact_status = '" & clicontact_status & "')"


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Insert_Client_Contact(ByVal acompID As Integer, ByVal aAction_date As String, ByVal clicontact_status As String) As DataTable</b><br />" & sql
      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      Return atemptable
    Catch ex As Exception
      Get_Insert_Client_Contact = Nothing
      Me.class_error = "Error in  SQL Get_Insert_Client_Contact(ByVal acompID As Integer, ByVal aAction_date As String, ByVal clicontact_status As String) As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try


  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Remove_Client_Contact_ByCompany(ByVal clicomp_id As Integer)  
  ' Purpose: to delete client contacts associated with company. 
  ' Parameters: clicomp_id
  ' Return: 
  '       integer
  ' Change Log
  '           2/6/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Remove_Client_Contact_ByCompany(ByVal clicomp_id As Integer) As Integer
    Remove_Client_Contact_ByCompany = 0
    Try
      If clicomp_id <> 0 Then
        Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
        Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
        Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing

        Try
          MySqlConn.ConnectionString = Me.client_DB

          MySqlConn.Open()
          MySqlCommand.Connection = MySqlConn
          MySqlCommand.CommandType = CommandType.Text
          MySqlCommand.CommandTimeout = 60

          Dim sQuery As String = "delete from client_contact where clicontact_comp_id =  " & clicomp_id
          HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Remove_Client_Contact_ByCompany(ByVal clicomp_id As Integer) As Integer</b><br />" & sQuery


          MySqlCommand.CommandText = sQuery
          MySqlCommand.ExecuteNonQuery()
          Return 1
        Finally
          MySqlConn.Dispose()
          MySqlConn.Close()
          MySqlConn = Nothing

          MySqlCommand.Dispose()
          MySqlCommand = Nothing
        End Try
      End If
    Catch ex As Exception
      Remove_Client_Contact_ByCompany = 0
      Me.class_error = "Error in Remove_Client_Contact_ByCompany(ByVal client_ac_id As Integer) : " & ex.Message
    End Try
  End Function
#End Region
#Region "Only Company client"
  ''' <summary>
  ''' Gets client company by jetnet ID
  ''' </summary>
  ''' <param name="comp_id"></param>
  ''' <param name="check_error"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function GetCompanyInfo_JETNET_ID(ByVal comp_id As Integer, ByRef check_error As String) As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim atemptable As New DataTable
    Dim sql As String = ""

    Try
      sql = "SELECT '' AS acref_contact_type, '' AS acref_operator_type, '' AS acref_contact_type, '' AS acref_operator_type, "
      sql = sql & " clicomp_action_date AS comp_action_date, clicomp_address1 AS comp_address1, clicomp_address2 AS comp_address2, "
      sql = sql & " clicomp_agency_type AS comp_agency_type, clicomp_alternate_name AS comp_alternate_name, clicomp_alternate_name_type "
      sql = sql & " AS comp_alternate_name_type, clicomp_category1, clicomp_category2, clicomp_category3, clicomp_category4, clicomp_category5, "
      sql = sql & " clicomp_city AS comp_city, clicomp_country AS comp_country, clicomp_description,  clicomp_user_id as comp_user_id, clicomp_email_address AS "
      sql = sql & " comp_email_address, clicomp_id AS comp_id, clicomp_jetnet_comp_id, clicomp_jetnet_comp_id as jetnet_comp_id, clicomp_mainloc_comp_id, clicomp_name AS comp_name, "
      sql = sql & " clicomp_product_business_flag AS comp_product_business_flag, clicomp_product_commercial_flag AS comp_product_commercial_flag,  "
      sql = sql & " clicomp_product_helicopter_flag AS comp_product_helicopter_flag, clicomp_state AS comp_state, clicomp_status, "
      sql = sql & " (select clipnum_number from client_phone_numbers where clipnum_type='Office' and clipnum_comp_id = clicomp_id and clipnum_contact_id = 0 limit 1) as comp_office_phone, "
      sql = sql & " (select clipnum_number from client_phone_numbers where clipnum_type='Fax' and clipnum_comp_id = clicomp_id and clipnum_contact_id = 0 limit 1) as comp_fax_phone, "

      sql = sql & " clicomp_user_id, clicomp_web_address AS comp_web_address, clicomp_zip_code AS comp_zip_code, 'CLIENT' AS "
      sql = sql & " source FROM client_company WHERE (clicomp_jetnet_comp_id = " & comp_id & ") AND (clicomp_status = 'Y')"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>GetCompanyInfo_JETNET_ID(ByVal comp_id As Integer, ByRef check_error As String) As DataTable</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      Return atemptable
    Catch ex As Exception
      GetCompanyInfo_JETNET_ID = Nothing
      check_error = ex.Message
      Me.class_error = "Error in GetCompanyInfo_JETNET_ID(ByVal comp_id As Integer, ByRef check_error As String): " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try


  End Function
  ''' <summary>
  ''' Gets client company by jetnet ID
  ''' </summary>
  ''' <param name="comp_id"></param>
  ''' <param name="check_error"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function CheckforCompanyBy_JETNET_ID(ByVal comp_id As Long, ByRef check_error As String) As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim atemptable As New DataTable
    Dim sql As String = ""

    Try
      sql = "SELECT  clicomp_id AS comp_id  FROM client_company WHERE (clicomp_jetnet_comp_id = " & comp_id & ") AND (clicomp_status = 'Y')"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>CheckforCompanyBy_JETNET_ID(ByVal comp_id As Integer, ByRef check_error As String) As DataTable</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      Return atemptable
    Catch ex As Exception
      CheckforCompanyBy_JETNET_ID = Nothing
      check_error = ex.Message
      Me.class_error = "Error in CheckforCompanyBy_JETNET_ID(ByVal comp_id As Integer, ByRef check_error As String): " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try


  End Function
  Public Function CheckforCompanyBy_CLIENT_ID(ByVal comp_id As Long, ByRef check_error As String) As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim atemptable As New DataTable
    Dim sql As String = ""

    Try
      sql = "SELECT  clicomp_jetnet_comp_id  FROM client_company WHERE ( clicomp_id  = " & comp_id & ") AND (clicomp_status = 'Y')"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>CheckforCompanyBy_JETNET_ID(ByVal comp_id As Integer, ByRef check_error As String) As DataTable</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      Return atemptable
    Catch ex As Exception
      CheckforCompanyBy_CLIENT_ID = Nothing
      check_error = ex.Message
      Me.class_error = "Error in CheckforCompanyBy_JETNET_ID(ByVal comp_id As Integer, ByRef check_error As String): " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try


  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Latest_Client_CompanyByUserID
  ' Purpose: to  get the last client company that was inserted into the db by user id
  ' Parameters: user ID
  ' Return: 
  '       DataTable
  ' Change Log
  '           10/14/2010    - Created By: Amanda Jennings
  'Edited on 10/12/2011 to not use a table adapter due to failure to enable constraints error
  'when more than 1 of the same company is returned
  'plus added limit 5 which is something table adapters don't seem to be able to do.
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Latest_Client_CompanyByUserID(ByVal clicomp_user_id As Integer) As DataTable

    Dim atemptable As New DataTable
    Get_Latest_Client_CompanyByUserID = atemptable
    Try
      '' set the connection string
      'dtAdapter_Client.Connection.ConnectionString = Me.client_DB
      '' call the Update_Client_Company Function, giving it the class variables

      'Get_Latest_Client_CompanyByUserID = dtAdapter_Client.GetDataBy_LatestClientCompanyByUser(clicomp_user_id)
      Dim query As String = ""
      query = "SELECT clicomp_action_date AS comp_action_date, clicomp_address1 AS comp_address1, "
      query = query & "clicomp_address2 AS comp_address2, clicomp_agency_type AS comp_agency_type, clicomp_alternate_name AS "
      query = query & "comp_alternate_name, clicomp_alternate_name_type AS comp_alternate_name_type, clicomp_category1, "
      query = query & "clicomp_category2, clicomp_category3, clicomp_category4, clicomp_category5, clicomp_city AS comp_city,"
      query = query & " clicomp_country AS comp_country, clicomp_description, clicomp_email_address AS comp_email_address, "
      query = query & "clicomp_id AS comp_id, clicomp_jetnet_comp_id, clicomp_mainloc_comp_id, clicomp_name AS comp_name, "
      query = query & "clicomp_product_business_flag AS comp_product_business_flag, clicomp_product_commercial_flag AS "
      query = query & "comp_product_commercial_flag, clicomp_product_helicopter_flag AS comp_product_helicopter_flag, "
      query = query & "clicomp_state AS comp_state, clicomp_status, clicomp_user_id, clicomp_web_address AS comp_web_address,"
      query = query & " clicomp_zip_code AS comp_zip_code, 'CLIENT' AS source FROM client_company"
      query = query & " WHERE (clicomp_user_id = " & clicomp_user_id & ") ORDER BY clicomp_action_date DESC limit 5"


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Latest_Client_CompanyByUserID(ByVal clicomp_user_id As Integer) As DataTable</b><br />" & query



      atemptable.Columns.Add("comp_action_date")
      atemptable.Columns.Add("comp_address1")
      atemptable.Columns.Add("comp_address2")
      atemptable.Columns.Add("comp_alternate_name")
      atemptable.Columns.Add("comp_alternate_name_type")
      atemptable.Columns.Add("clicomp_category1")
      atemptable.Columns.Add("clicomp_category2")
      atemptable.Columns.Add("clicomp_category3")
      atemptable.Columns.Add("clicomp_category4")
      atemptable.Columns.Add("clicomp_category5")
      atemptable.Columns.Add("comp_city")
      atemptable.Columns.Add("comp_country")
      atemptable.Columns.Add("clicomp_description")
      atemptable.Columns.Add("comp_email_address")
      atemptable.Columns.Add("comp_id")
      atemptable.Columns.Add("clicomp_jetnet_comp_id")
      atemptable.Columns.Add("clicomp_mainloc_comp_id")
      atemptable.Columns.Add("comp_name")
      atemptable.Columns.Add("comp_product_business_flag")
      atemptable.Columns.Add("comp_product_commercial_flag")
      atemptable.Columns.Add("comp_product_helicopter_flag")
      atemptable.Columns.Add("comp_state")
      atemptable.Columns.Add("clicomp_status")
      atemptable.Columns.Add("clicomp_user_id")
      atemptable.Columns.Add("comp_web_address")
      atemptable.Columns.Add("comp_zip_code")
      atemptable.Columns.Add("source")


      Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
      Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
      Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
      Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
      Try
        MySqlConn.ConnectionString = Me.client_DB

        MySqlConn.Open()
        MySqlCommand.Connection = MySqlConn
        MySqlCommand.CommandType = CommandType.Text
        MySqlCommand.CommandTimeout = 60
        MySqlCommand.CommandText = query
        MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

        While MySqlReader.Read()
          Dim newCustomersRow As DataRow = atemptable.NewRow()
          newCustomersRow("comp_action_date") = MySqlReader.Item("comp_action_date")
          newCustomersRow("comp_address1") = MySqlReader.Item("comp_address1")
          newCustomersRow("comp_address2") = MySqlReader.Item("comp_address2")
          newCustomersRow("comp_alternate_name") = MySqlReader.Item("comp_alternate_name")
          newCustomersRow("comp_alternate_name_type") = MySqlReader.Item("comp_alternate_name_type")
          newCustomersRow("clicomp_category1") = MySqlReader.Item("clicomp_category1")
          newCustomersRow("clicomp_category2") = MySqlReader.Item("clicomp_category2")
          newCustomersRow("clicomp_category3") = MySqlReader.Item("clicomp_category3")
          newCustomersRow("clicomp_category4") = MySqlReader.Item("clicomp_category4")
          newCustomersRow("clicomp_category5") = MySqlReader.Item("clicomp_category5")
          newCustomersRow("comp_city") = MySqlReader.Item("comp_city")
          newCustomersRow("comp_country") = MySqlReader.Item("comp_country")
          newCustomersRow("clicomp_description") = MySqlReader.Item("clicomp_description")
          newCustomersRow("comp_email_address") = MySqlReader.Item("comp_email_address")
          newCustomersRow("comp_id") = MySqlReader.Item("comp_id")
          newCustomersRow("clicomp_jetnet_comp_id") = MySqlReader.Item("clicomp_jetnet_comp_id")
          newCustomersRow("clicomp_mainloc_comp_id") = MySqlReader.Item("clicomp_mainloc_comp_id")
          newCustomersRow("comp_name") = MySqlReader.Item("comp_name")
          newCustomersRow("comp_product_business_flag") = MySqlReader.Item("comp_product_business_flag")
          newCustomersRow("comp_product_commercial_flag") = MySqlReader.Item("comp_product_commercial_flag")
          newCustomersRow("comp_product_helicopter_flag") = MySqlReader.Item("comp_product_helicopter_flag")
          newCustomersRow("comp_state") = MySqlReader.Item("comp_state")
          newCustomersRow("clicomp_status") = MySqlReader.Item("clicomp_status")
          newCustomersRow("clicomp_user_id") = MySqlReader.Item("clicomp_user_id")
          newCustomersRow("comp_web_address") = MySqlReader.Item("comp_web_address")
          newCustomersRow("comp_zip_code") = MySqlReader.Item("comp_zip_code")
          newCustomersRow("source") = MySqlReader.Item("source")

          atemptable.Rows.Add(newCustomersRow)
          atemptable.AcceptChanges()
        End While

      Catch ex As Exception
      Finally
        MySqlReader.Close()
        MySqlReader = Nothing

        MySqlConn.Dispose()
        MySqlConn.Close()
        MySqlConn = Nothing

        MySqlCommand.Dispose()
        MySqlCommand = Nothing
      End Try


      Return atemptable
    Catch ex As Exception
      Get_Latest_Client_CompanyByUserID = Nothing
      Me.class_error = "Error in Get_Latest_Client_CompanyByUserID(ByVal clicomp_user_id As Integer): " & ex.Message
    End Try
  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Insert_Client_Company
  ' Purpose: to  get the last client company that was inserted into the db
  ' Parameters: comp_name that was inserted, action_date that was inserted
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/2/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Insert_Client_Company(ByVal acomp_name As String, ByVal aAction_date As String, ByVal status As String) As DataTable
    Dim sql As String = ""
    Dim atemptable As New DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    'aAction_date = Year(aAction_date) & "-" & Month(aAction_date) & "-" & Day(aAction_date) & " " & Hour(aAction_date) & ":" & Minute(aAction_date) & ":" & Second(aAction_date)
    'aAction_date = aAction_date.ToString("MM/dd/yyyy HH:mm:ss tt")
    aAction_date = Format(CDate(aAction_date), "yyyy-MM-dd HH:mm:ss")
    ' 2012-04-05 03:03:25
    Try
      Select Case status
        Case "B"
          sql = "SELECT '' AS acref_contact_type, '' AS acref_operator_type, clicomp_action_date AS "
          sql = sql & " comp_action_date, clicomp_address1 AS comp_address1, clicomp_address2 AS comp_address2, "
          sql = sql & " clicomp_agency_type AS comp_agency_type, clicomp_alternate_name AS comp_alternate_name, "
          sql = sql & " clicomp_alternate_name_type AS comp_alternate_name_type, clicomp_category1, clicomp_category2, "
          sql = sql & " clicomp_category3, clicomp_category4, clicomp_category5, clicomp_city AS comp_city, "
          sql = sql & " clicomp_country AS comp_country, clicomp_description, clicomp_email_address AS "
          sql = sql & " comp_email_address, clicomp_id AS comp_id, clicomp_jetnet_comp_id, clicomp_mainloc_comp_id, "
          sql = sql & " clicomp_name AS comp_name, clicomp_product_business_flag AS comp_product_business_flag, "
          sql = sql & " clicomp_product_commercial_flag AS comp_product_commercial_flag, "
          sql = sql & " clicomp_product_helicopter_flag AS comp_product_helicopter_flag, "
          sql = sql & " clicomp_state AS comp_state, clicomp_status, clicomp_user_id, "
          sql = sql & " clicomp_web_address AS comp_web_address, clicomp_zip_code AS comp_zip_code, "
          sql = sql & " 'CLIENT' AS source FROM client_company WHERE (clicomp_name = '" & Escape_Single_Quote(acomp_name) & "') AND "
          sql = sql & " (clicomp_action_date = '" & aAction_date & "')"

        Case Else
          sql = ""
          sql = "SELECT '' AS acref_contact_type, '' AS acref_operator_type, "
          sql = sql & " clicomp_action_date AS comp_action_date, clicomp_address1 AS comp_address1, "
          sql = sql & " clicomp_address2 AS comp_address2, clicomp_agency_type AS comp_agency_type, "
          sql = sql & " clicomp_alternate_name AS comp_alternate_name, clicomp_alternate_name_type "
          sql = sql & " AS comp_alternate_name_type, clicomp_category1, clicomp_category2, "
          sql = sql & " clicomp_category3, clicomp_category4, clicomp_category5, clicomp_city AS "
          sql = sql & " comp_city, clicomp_country AS comp_country, clicomp_description, "
          sql = sql & " clicomp_email_address AS comp_email_address, clicomp_id AS comp_id, clicomp_jetnet_comp_id, "
          sql = sql & " clicomp_mainloc_comp_id, clicomp_name AS comp_name, clicomp_product_business_flag "
          sql = sql & " AS comp_product_business_flag, clicomp_product_commercial_flag AS comp_product_commercial_flag, "
          sql = sql & " clicomp_product_helicopter_flag AS comp_product_helicopter_flag, clicomp_state AS comp_state, "
          sql = sql & " clicomp_status, clicomp_user_id, clicomp_web_address AS comp_web_address, clicomp_zip_code AS comp_zip_code, "
          sql = sql & " 'CLIENT' AS source FROM client_company WHERE (clicomp_name = '" & Escape_Single_Quote(acomp_name) & "') "
          sql = sql & " AND (clicomp_action_date = '" & aAction_date & "') AND (clicomp_status = '" & status & "')"

      End Select

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Insert_Client_Company(ByVal acomp_name As String, ByVal aAction_date As String, ByVal status As String) As DataTable</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      Return atemptable
    Catch ex As Exception
      Get_Insert_Client_Company = Nothing
      Me.class_error = " Get_Insert_Client_Company(ByVal acomp_name As String, ByVal aAction_date As String, ByVal status As String) As DataTable: " & ex.Message
    Finally


      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  ''' <summary>
  ''' This finds the company "OWNER NOT DEFINED" that's a placeholder company for new client aircraft
  ''' </summary>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function FindNotDefinedOwnerCompany() As DataTable
    Dim sql As String = ""
    Dim atemptable As New DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing

    Try

      sql = "SELECT '' AS acref_contact_type, '' AS acref_operator_type, clicomp_action_date AS "
      sql = sql & " comp_action_date, clicomp_address1 AS comp_address1, clicomp_address2 AS comp_address2, "
      sql = sql & " clicomp_agency_type AS comp_agency_type, clicomp_alternate_name AS comp_alternate_name, "
      sql = sql & " clicomp_alternate_name_type AS comp_alternate_name_type, clicomp_category1, clicomp_category2, "
      sql = sql & " clicomp_category3, clicomp_category4, clicomp_category5, clicomp_city AS comp_city, "
      sql = sql & " clicomp_country AS comp_country, clicomp_description, clicomp_email_address AS "
      sql = sql & " comp_email_address, clicomp_id AS comp_id, clicomp_jetnet_comp_id, clicomp_mainloc_comp_id, "
      sql = sql & " clicomp_name AS comp_name, clicomp_product_business_flag AS comp_product_business_flag, "
      sql = sql & " clicomp_product_commercial_flag AS comp_product_commercial_flag, "
      sql = sql & " clicomp_product_helicopter_flag AS comp_product_helicopter_flag, "
      sql = sql & " clicomp_state AS comp_state, clicomp_status, clicomp_user_id, "
      sql = sql & " clicomp_web_address AS comp_web_address, clicomp_zip_code AS comp_zip_code, "
      sql = sql & " 'CLIENT' AS source FROM client_company WHERE (clicomp_name = 'OWNER NOT DEFINED') "


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>FindNotDefinedOwnerCompany() As DataTable</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      Return atemptable
    Catch ex As Exception
      FindNotDefinedOwnerCompany = Nothing
      Me.class_error = " FindNotDefinedOwnerCompany() As DataTable: " & ex.Message
    Finally


      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
  Public Function Escape_Single_Quote(ByVal input_string As String) As String
    Escape_Single_Quote = Replace(input_string, "'", "\'")
  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Insert_Client_Company
  ' Purpose: to Insert a company record into client database
  ' Parameters: class clsClient_Company
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/4/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Insert_Client_Company(ByVal aclsClient_Company As clsClient_Company) As Boolean
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Insert_Client_Company = False
    Try
      'I wanted to make sure that this would reflect every single insert, in every single instance and yet still make it very easy to find and edit in
      'the possibility that we needed it to be changed.
      'So I added the company name search variable to be declared here and in the update.
      'Since this is never user edited, I didn't think it'd matter. 
      'But if it's put in here - then even if we're creating a client aircraft - that has attached client companies - when it creates
      'those client companies - it will reflect this and won't need to be updated on each place the INSERT or update is used when we create the class.
      'Just here.
      '7/30/12

      aclsClient_Company.clicomp_search_name = clsGeneral.clsGeneral.Get_Name_Search_String(aclsClient_Company.clicomp_name)

      sql = "INSERT INTO client_company (clicomp_name, clicomp_alternate_name_type, clicomp_alternate_name, clicomp_address1, clicomp_address2, clicomp_city, clicomp_state, clicomp_zip_code, "
      sql = sql & " clicomp_country, clicomp_agency_type, clicomp_web_address, clicomp_email_address, clicomp_action_date, clicomp_status, clicomp_jetnet_comp_id, "
      sql = sql & " clicomp_user_id, clicomp_description, clicomp_category1, clicomp_category2, clicomp_category3, clicomp_category4, clicomp_category5, "
      sql = sql & " clicomp_name_search, clicomp_mainloc_comp_id)"

      sql = sql & " VALUES  ('" & Escape_Single_Quote(Left(aclsClient_Company.clicomp_name, 100)) & "', "
      sql = sql & "'" & Escape_Single_Quote(Left(aclsClient_Company.clicomp_alternate_name_type, 4)) & "', "
      sql = sql & " '" & Escape_Single_Quote(Left(aclsClient_Company.clicomp_alternate_name, 100)) & "', "
      sql = sql & " '" & Escape_Single_Quote(Left(aclsClient_Company.clicomp_address1, 50)) & "', "
      sql = sql & " '" & Escape_Single_Quote(Left(aclsClient_Company.clicomp_address2, 50)) & "', "
      sql = sql & " '" & Escape_Single_Quote(Left(aclsClient_Company.clicomp_city, 50)) & "', "
      sql = sql & " '" & Left(aclsClient_Company.clicomp_state, 2) & "', "
      sql = sql & " '" & Left(aclsClient_Company.clicomp_zip_code, 10) & "', "
      sql = sql & " '" & Left(aclsClient_Company.clicomp_country, 25) & "', "
      sql = sql & " '" & Left(aclsClient_Company.clicomp_agency_type, 1) & "', "
      sql = sql & " '" & Left(aclsClient_Company.clicomp_web_address, 150) & "', "
      sql = sql & " '" & Left(aclsClient_Company.clicomp_email_address, 150) & "', "

      If IsDate(aclsClient_Company.clicomp_date_updated) Then
        sql = sql & " '" & Format(CDate(aclsClient_Company.clicomp_date_updated), "yyyy-MM-dd HH:mm:ss") & "', "
      Else
        sql = sql & " NOW(),"
      End If

      sql = sql & " '" & Left(aclsClient_Company.clicomp_status, 3) & "', "
      sql = sql & " '" & aclsClient_Company.clicomp_jetnet_comp_id & "', "
      sql = sql & " '" & aclsClient_Company.clicomp_user_id & "', "
      sql = sql & "  '" & Escape_Single_Quote(Left(aclsClient_Company.clicomp_description, 21845)) & "', "
      sql = sql & "  '" & Escape_Single_Quote(Left(aclsClient_Company.clicomp_category1, 100)) & "', "
      sql = sql & "  '" & Escape_Single_Quote(Left(aclsClient_Company.clicomp_category2, 100)) & "', "
      sql = sql & "  '" & Escape_Single_Quote(Left(aclsClient_Company.clicomp_category3, 100)) & "', "
      sql = sql & "  '" & Escape_Single_Quote(Left(aclsClient_Company.clicomp_category4, 100)) & "', "
      sql = sql & "  '" & Escape_Single_Quote(Left(aclsClient_Company.clicomp_category5, 100)) & "', "
      sql = sql & "  '" & Left(aclsClient_Company.clicomp_search_name, 100) & "', "

      If Not IsDBNull(aclsClient_Company.clicomp_mainloc_comp_id) Then
        If IsNumeric(aclsClient_Company.clicomp_mainloc_comp_id) Then
          sql = sql & "  '" & aclsClient_Company.clicomp_mainloc_comp_id & "' )"
        Else
          sql = sql & " NULL )"
        End If
      Else
        sql = sql & " NULL )"
      End If

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Insert_Client_Company(ByVal aclsClient_Company As clsClient_Company) As Boolean</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Insert_Client_Company = True
    Catch ex As Exception
      Insert_Client_Company = False
      Me.class_error = "Error in SQL Insert_Client_Company(ByVal aclsClient_Company As clsClient_Company, jetnetID: " & aclsClient_Company.clicomp_jetnet_comp_id & ") As Boolean " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Update_Client_Company
  ' Purpose: to update client company info
  ' Parameters: class clsClient_Company
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/4/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Update_Client_Company(ByVal aclsClient_Company As clsClient_Company) As Boolean
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Update_Client_Company = False
    Try
      aclsClient_Company.clicomp_search_name = clsGeneral.clsGeneral.Get_Name_Search_String(aclsClient_Company.clicomp_name)
      sql = " UPDATE client_company "
      sql = sql & " SET  clicomp_name = '" & Escape_Single_Quote(Left(aclsClient_Company.clicomp_name, 100)) & "', "
      sql = sql & " clicomp_name_search = '" & Escape_Single_Quote(Left(aclsClient_Company.clicomp_search_name, 100)) & "', "
      sql = sql & " clicomp_alternate_name_type = '" & Escape_Single_Quote(Left(aclsClient_Company.clicomp_alternate_name_type, 4)) & "', "
      sql = sql & " clicomp_alternate_name = '" & Escape_Single_Quote(Left(aclsClient_Company.clicomp_alternate_name, 100)) & "', "
      sql = sql & " clicomp_address1 = '" & Escape_Single_Quote(Left(aclsClient_Company.clicomp_address1, 50)) & "', "
      sql = sql & " clicomp_address2 = '" & Escape_Single_Quote(Left(aclsClient_Company.clicomp_address2, 50)) & "', "
      sql = sql & " clicomp_city = '" & Escape_Single_Quote(Left(aclsClient_Company.clicomp_city, 50)) & "', "
      sql = sql & " clicomp_state = '" & Escape_Single_Quote(Left(aclsClient_Company.clicomp_state, 2)) & "', "
      sql = sql & " clicomp_zip_code = '" & Escape_Single_Quote(Left(aclsClient_Company.clicomp_zip_code, 10)) & "', "
      sql = sql & " clicomp_country = '" & Escape_Single_Quote(Left(aclsClient_Company.clicomp_country, 25)) & "', "
      sql = sql & " clicomp_agency_type = '" & Escape_Single_Quote(Left(aclsClient_Company.clicomp_agency_type, 1)) & "', "
      sql = sql & " clicomp_web_address = '" & Escape_Single_Quote(Left(aclsClient_Company.clicomp_web_address, 150)) & "', "
      sql = sql & " clicomp_email_address = '" & Escape_Single_Quote(Left(aclsClient_Company.clicomp_email_address, 150)) & "', "

      If IsDate(aclsClient_Company.clicomp_date_updated) Then
        sql = sql & " clicomp_action_date = '" & Format(CDate(aclsClient_Company.clicomp_date_updated), "yyyy-MM-dd HH:mm:ss") & "', "

      Else
        sql = sql & " clicomp_action_date = NULL, "
      End If

      sql = sql & " clicomp_status = '" & Escape_Single_Quote(Left(aclsClient_Company.clicomp_status, 3)) & "', "
      sql = sql & " clicomp_jetnet_comp_id = '" & aclsClient_Company.clicomp_jetnet_comp_id & "', "
      sql = sql & " clicomp_user_id = '" & aclsClient_Company.clicomp_user_id & "', "
      sql = sql & " clicomp_description = '" & Escape_Single_Quote(Left(aclsClient_Company.clicomp_description, 21845)) & "', "
      sql = sql & " clicomp_category1 = '" & Escape_Single_Quote(Left(aclsClient_Company.clicomp_category1, 100)) & "', "
      sql = sql & " clicomp_category2 = '" & Escape_Single_Quote(Left(aclsClient_Company.clicomp_category2, 100)) & "', "
      sql = sql & " clicomp_category3 = '" & Escape_Single_Quote(Left(aclsClient_Company.clicomp_category3, 100)) & "', "
      sql = sql & " clicomp_category4 = '" & Escape_Single_Quote(Left(aclsClient_Company.clicomp_category4, 100)) & "', "
      sql = sql & " clicomp_category5 = '" & Escape_Single_Quote(Left(aclsClient_Company.clicomp_category5, 100)) & "', "
      If Not IsDBNull(aclsClient_Company.clicomp_mainloc_comp_id) Then
        If IsNumeric(aclsClient_Company.clicomp_mainloc_comp_id) Then
          sql = sql & " clicomp_mainloc_comp_id = '" & aclsClient_Company.clicomp_mainloc_comp_id & "' "
        Else
          sql = sql & " clicomp_mainloc_comp_id = NULL "
        End If
      Else
        sql = sql & " clicomp_mainloc_comp_id = NULL "
      End If

      sql = sql & " WHERE  (clicomp_id = '" & aclsClient_Company.clicomp_id & "') limit 1 "


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Update_Client_Company(ByVal aclsClient_Company As clsClient_Company) As Boolean</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Update_Client_Company = True
    Catch ex As Exception
      Update_Client_Company = False
      Me.class_error = "Error in SQL Update_Client_Company(ByVal aclsClient_Company As clsClient_Company) As Boolean " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function



  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Delete_Client_Company(ByVal clicomp_id As Integer) used as a replacement for the previous one. 
  ' Purpose: to delete a client company and all the contacts, phone numbers, references, folder stuff, notes associated with company. 
  ' Parameters: clicomp_id
  ' Return: 
  '       integer
  ' Change Log
  '           2/6/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Remove_Client_Company(ByVal clicomp_id As Integer) As Integer
    Remove_Client_Company = 0
    Try
      If clicomp_id <> 0 Then
        Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
        Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
        Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing

        Try
          MySqlConn.ConnectionString = Me.client_DB

          MySqlConn.Open()
          MySqlCommand.Connection = MySqlConn
          MySqlCommand.CommandType = CommandType.Text
          MySqlCommand.CommandTimeout = 60

          'remove from aircraft table. 
          Dim sQuery As String = "delete from client_company where clicomp_id = " & clicomp_id & " limit 1 "
          HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Remove_Client_Company(ByVal clicomp_id As Integer) As Integer</b><br />" & sQuery

          MySqlCommand.CommandText = sQuery
          MySqlCommand.ExecuteNonQuery()
          'remove from reference
          sQuery = "delete from client_aircraft_reference where cliacref_comp_id = " & clicomp_id
          HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><br />" & sQuery

          MySqlCommand.CommandText = sQuery
          MySqlCommand.ExecuteNonQuery()
          'remove from details
          sQuery = "delete from client_contact where clicontact_comp_id =  " & clicomp_id
          HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><br />" & sQuery
          MySqlCommand.CommandText = sQuery
          MySqlCommand.ExecuteNonQuery()

          'Calling this function opens another connection, so I won't add it to get rid of the above query.
          'Remove_Client_Contact_ByCompany(clicomp_id)

          'remove from details
          sQuery = "delete from client_phone_numbers where clipnum_comp_id = " & clicomp_id
          HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><br />" & sQuery
          MySqlCommand.CommandText = sQuery
          MySqlCommand.ExecuteNonQuery()

          'remove from clientfolderindex
          sQuery = "delete from client_folder_index where cfoldind_client_comp_id = " & clicomp_id
          HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><br />" & sQuery
          MySqlCommand.CommandText = sQuery
          MySqlCommand.ExecuteNonQuery()

          'update notes
          sQuery = "update local_notes set lnote_client_comp_id = 0 where lnote_client_comp_id= " & clicomp_id
          HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><br />" & sQuery
          MySqlCommand.CommandText = sQuery
          MySqlCommand.ExecuteNonQuery()

          Remove_Client_Company = 1

        Finally
          MySqlConn.Dispose()
          MySqlConn.Close()
          MySqlConn = Nothing

          MySqlCommand.Dispose()
          MySqlCommand = Nothing
        End Try
      End If
    Catch ex As Exception
      Remove_Client_Company = 0
      Me.class_error = "Error in Remove_Client_Company(ByVal client_ac_id As Integer) : " & ex.Message
    End Try
  End Function


  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Delete_Client_Company(ByVal clicomp_id As Integer) used for the combine function. 
  ' Purpose: to delete a client company
  ' Parameters: clicomp_id
  ' Return: 
  '       integer
  ' Change Log
  '           2/6/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Delete_Client_Company(ByVal clicomp_id As Integer) As Integer
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Delete_Client_Company = False
    Try
      sql = "DELETE FROM client_company WHERE (clicomp_id = '" & clicomp_id & "') limit 1"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Delete_Client_Company(ByVal clicomp_id As Integer) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Delete_Client_Company = True
    Catch ex As Exception
      Delete_Client_Company = False
      Me.class_error = "Error in SQL Delete_Client_Company(ByVal clicomp_id As Integer) As Integer " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function
#End Region
#Region "Phone #"
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Insert_Client_PhoneNumbers
  ' Purpose: to update the client phone numbers
  ' Parameters: class clsClient_Contact
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/4/2012    - Created By: Amanda Vaughn 
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Insert_Client_PhoneNumbers(ByVal aclsClient_Phone_Numbers As clsClient_Phone_Numbers) As Boolean

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Insert_Client_PhoneNumbers = False
    Try

      sql = "INSERT INTO Client_Phone_Numbers (clipnum_comp_id, clipnum_contact_id, clipnum_type, clipnum_number) VALUES ('" & aclsClient_Phone_Numbers.clipnum_comp_id & "', '" & aclsClient_Phone_Numbers.clipnum_contact_id & "', '" & aclsClient_Phone_Numbers.clipnum_type & "', '" & aclsClient_Phone_Numbers.clipnum_number & "')"


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Insert_Client_PhoneNumbers(ByVal aclsClient_Phone_Numbers As clsClient_Phone_Numbers) As Boolean</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Insert_Client_PhoneNumbers = True
    Catch ex As Exception
      Insert_Client_PhoneNumbers = False
      Me.class_error = "Error in SQL  Insert_Client_PhoneNumbers(ByVal aclsClient_Phone_Numbers As clsClient_Phone_Numbers) As Boolean " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: DeletePhoneNumbers_contactID
  ' Purpose: to delte the phonenumbers in the Client_Phone_Numbers table
  ' Parameters: comp_id
  ' Return: 
  '       Integer
  '             1 - Success
  '             0 - Fail
  ' Change Log
  '           2/6/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function DeletePhoneNumbers_contactID(ByVal contact_id As Integer, ByVal comp_id As Integer) As Integer
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    DeletePhoneNumbers_contactID = 0
    Try


      sql = "DELETE FROM Client_Phone_Numbers WHERE ((clipnum_contact_id = '" & contact_id & "'))"
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>DeletePhoneNumbers_contactID(ByVal contact_id As Integer, ByVal comp_id As Integer) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      DeletePhoneNumbers_contactID = 1
    Catch ex As Exception
      DeletePhoneNumbers_contactID = 0
      Me.class_error = "Error in SQL  DeletePhoneNumbers_contactID(ByVal contact_id As Integer, ByVal comp_id As Integer) As Integer " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function


  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: DeletePhoneNumbers_compID
  ' Purpose: to delte the phonenumbers in the Client_Phone_Numbers table
  ' Parameters: comp_id
  ' Return: 
  '       Integer
  '             1 - Success
  '             0 - Fail
  ' Change Log
  '           2/6/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function DeletePhoneNumbers_compID(ByVal comp_id As Integer) As Integer
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    DeletePhoneNumbers_compID = 0
    Try


      sql = "DELETE FROM Client_Phone_Numbers WHERE ((clipnum_comp_id = '" & comp_id & "' AND clipnum_contact_id = 0))"
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>DeletePhoneNumbers_compID(ByVal comp_id As Integer) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      DeletePhoneNumbers_compID = 1
    Catch ex As Exception
      DeletePhoneNumbers_compID = 0
      Me.class_error = "Error in SQL  DeletePhoneNumbers_compID(ByVal comp_id As Integer) As Integer " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Update_Client_PhoneNumbers
  ' Purpose: to update the client phone numbers
  ' Parameters: class clsClient_Contact
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/6/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Update_Client_PhoneNumbers(ByVal aclsClient_Phone_Numbers As clsClient_Phone_Numbers) As Boolean
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Update_Client_PhoneNumbers = 0
    Try


      sql = "UPDATE Client_Phone_Numbers SET clipnum_comp_id = '" & aclsClient_Phone_Numbers.clipnum_comp_id & "', clipnum_contact_id = '" & aclsClient_Phone_Numbers.clipnum_contact_id & "', "
      sql = sql & " clipnum_type = '" & Left(aclsClient_Phone_Numbers.clipnum_type, 15) & "', clipnum_number = '" & Left(aclsClient_Phone_Numbers.clipnum_number, 28) & "' WHERE ((clipnum_id = '" & aclsClient_Phone_Numbers.clipnum_id & "'))"
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b> Update_Client_PhoneNumbers(ByVal aclsClient_Phone_Numbers As clsClient_Phone_Numbers) As Boolean</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Update_Client_PhoneNumbers = 1
    Catch ex As Exception
      Update_Client_PhoneNumbers = 0
      Me.class_error = "Error in SQL   Update_Client_PhoneNumbers(ByVal aclsClient_Phone_Numbers As clsClient_Phone_Numbers) As Boolean " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function

#End Region

#Region "Client Folders"
  Public Function Get_Client_Folders_Complete(ByVal cfolder_cftype_id As Integer, ByVal UserID As Long) As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Try
      ' create a new instance of Class1
      Get_Client_Folders_Complete = Nothing
      ' create a dataset for the client
      Dim dsClient As New DataSet
      ' create a data set for JETNET
      Dim dsJETNET As New DataSet
      '' setup the connection string
      ' fill the data sets



      Dim squery As String = "SELECT 'CLIENT' as source, 'N' as cfolder_jetnet_run_flag, 'N' as cfolder_operator_flag, 'N' as cfolder_default_flag, '' as cfolder_jetnet_run_reply_username, '' as cfolder_jetnet_run_reply_email, 0 as cfolder_jetnet_run_freq_in_mins, "
      squery += "cfolder_cftype_id as cftype_id, '' as cfttpe_name, cfolder_method, '' as contact_first_name, '' as contact_last_name, '' as cfolder_description, cfolder_data, cfolder_cliuser_id, cfolder_hide_flag, cfolder_id, cfolder_name, cfolder_share, cfolder_sort2 as cfolder_sort , cfolder_sort2 FROM client_folder "
      squery += " WHERE ((cfolder_cftype_id = " & cfolder_cftype_id & ") AND "
      squery += " (cfolder_share = 'Y')) "
      squery += " or ((cfolder_cliuser_id = " & UserID & ") "
      squery += " AND (cfolder_cftype_id = " & cfolder_cftype_id & ") "
      squery += " AND (cfolder_share = 'N' ))"

      squery += " order by cfolder_sort2"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Folders_Complete(ByVal cfolder_cftype_id As Integer, ByVal UserID As Long) As DataTable</b><br />" & squery


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60
      Dim atemptable As New DataTable

      atemptable.Columns.Add("cfolder_jetnet_run_flag")
      atemptable.Columns.Add("cfolder_operator_flag")
      atemptable.Columns.Add("cfolder_default_flag")
      atemptable.Columns.Add("cfolder_jetnet_run_reply_username")
      atemptable.Columns.Add("cfolder_jetnet_run_reply_email")
      atemptable.Columns.Add("source")
      Dim cfolder_jetnet_run_freq_in_mins As DataColumn = atemptable.Columns.Add("cfolder_jetnet_run_freq_in_mins", Type.GetType("System.Int32"))
      cfolder_jetnet_run_freq_in_mins.AllowDBNull = True

      atemptable.Columns.Add("cfttpe_name")
      atemptable.Columns.Add("cfolder_description")

      Dim cftype_id As DataColumn = atemptable.Columns.Add("cftype_id", Type.GetType("System.Int32"))
      cftype_id.AllowDBNull = True

      atemptable.Columns.Add("cfolder_data")
      atemptable.Columns.Add("cfolder_hide_flag")
      atemptable.Columns.Add("cfolder_share")
      atemptable.Columns.Add("cfolder_name")


      Dim cfolder_id As DataColumn = atemptable.Columns.Add("cfolder_id", Type.GetType("System.Int32"))
      cfolder_id.AllowDBNull = True

      atemptable.Columns.Add("cfolder_method")

      Dim cfolder_sort As DataColumn = atemptable.Columns.Add("cfolder_sort", Type.GetType("System.Int16"))

      atemptable.Columns.Add("contact_first_name")
      atemptable.Columns.Add("contact_last_name")

      MySqlCommand.CommandText = squery
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      While MySqlReader.Read()
        Dim newCustomersRow As DataRow = atemptable.NewRow()
        newCustomersRow("source") = MySqlReader.Item("source")
        newCustomersRow("cfolder_jetnet_run_flag") = MySqlReader.Item("cfolder_jetnet_run_flag")
        newCustomersRow("cfolder_operator_flag") = MySqlReader.Item("cfolder_operator_flag")
        newCustomersRow("cfolder_default_flag") = MySqlReader.Item("cfolder_default_flag")
        newCustomersRow("cfolder_jetnet_run_reply_username") = MySqlReader.Item("cfolder_jetnet_run_reply_username")
        newCustomersRow("cfolder_jetnet_run_reply_email") = MySqlReader.Item("cfolder_jetnet_run_reply_email")
        newCustomersRow("cfolder_jetnet_run_freq_in_mins") = MySqlReader.Item("cfolder_jetnet_run_freq_in_mins")
        newCustomersRow("cfttpe_name") = MySqlReader.Item("cfttpe_name")
        newCustomersRow("cfolder_description") = MySqlReader.Item("cfolder_description")
        newCustomersRow("cftype_id") = MySqlReader.Item("cftype_id")
        newCustomersRow("cfolder_data") = MySqlReader.Item("cfolder_data")
        newCustomersRow("cfolder_hide_flag") = MySqlReader.Item("cfolder_hide_flag")
        newCustomersRow("cfolder_share") = MySqlReader.Item("cfolder_share")
        newCustomersRow("cfolder_name") = MySqlReader.Item("cfolder_name")
        newCustomersRow("cfolder_id") = MySqlReader.Item("cfolder_id")
        newCustomersRow("cfolder_method") = MySqlReader.Item("cfolder_method")
        newCustomersRow("cfolder_sort") = MySqlReader.Item("cfolder_sort")
        newCustomersRow("contact_first_name") = MySqlReader.Item("contact_first_name")
        newCustomersRow("contact_last_name") = MySqlReader.Item("contact_last_name")
        atemptable.Rows.Add(newCustomersRow)
        atemptable.AcceptChanges()
      End While
      MySqlReader.Close()
      MySqlReader = Nothing
      Get_Client_Folders_Complete = atemptable


    Catch ex As Exception
      Get_Client_Folders_Complete = Nothing
      Me.class_error = "Error in Get_Client_Folders_Complete(ByVal cfolder_cftype_id As Integer, ByVal UserID As Long): " & ex.Message
    Finally


      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_Folders
  ' Purpose: to get the client folders from the client_crm database
  ' Parameters: none
  ' Return: 
  '       DataTable
  ' Change Log
  '           6/6/2011    - Created By: Amanda Vaughn
  '           6/6/2011    - Modified By: Amanda Vaughn
  'SELECT cfolder_cftype_id, cfolder_cliuser_id, cfolder_hide_flag, cfolder_id, cfolder_name, cfolder_share,
  ' cfolder_sort1, cfolder_sort2 FROM client_folder WHERE (cfolder_cftype_id = @cfolder_cftype_id) AND 
  '(cfolder_share = @cfolder_share) order by cfolder_sort2

  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Client_Folders_Shared(ByVal cfolder_share As String, ByVal cfolder_cftype_id As Integer, ByVal Reorder_List As Boolean) As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Try
      ' create a new instance of Class1
      Get_Client_Folders_Shared = Nothing
      ' create a dataset for the client
      Dim dsClient As New DataSet
      ' create a data set for JETNET
      Dim dsJETNET As New DataSet
      '' setup the connection string
      ' fill the data sets
      If Reorder_List = False Then
        Dim squery As String = "SELECT cfolder_cftype_id, cfolder_method, cfolder_cliuser_id, cfolder_hide_flag, cfolder_id, cfolder_name, cfolder_share, cfolder_sort1, cfolder_sort2 FROM client_folder "
        squery = squery & " WHERE (cfolder_cftype_id = " & cfolder_cftype_id & ") AND "
        squery = squery & " (cfolder_share = '" & cfolder_share & "') order by cfolder_sort2"

        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Folders_Shared(ByVal cfolder_share As String, ByVal cfolder_cftype_id As Integer, ByVal Reorder_List As Boolean) As DataTable</b><br />" & squery


        MySqlConn.ConnectionString = Me.client_DB
        MySqlConn.Open()
        MySqlCommand.Connection = MySqlConn
        MySqlCommand.CommandType = CommandType.Text
        MySqlCommand.CommandTimeout = 60
        Dim atemptable As New DataTable

        atemptable.Columns.Add("cfolder_cftype_id")
        atemptable.Columns.Add("cfolder_cliuser_id")
        atemptable.Columns.Add("cfolder_hide_flag")
        atemptable.Columns.Add("cfolder_id")
        atemptable.Columns.Add("cfolder_name")
        atemptable.Columns.Add("cfolder_method")
        atemptable.Columns.Add("cfolder_share")
        atemptable.Columns.Add("cfolder_sort1")
        atemptable.Columns.Add("cfolder_sort2")
        atemptable.Columns.Add("tcount")

        MySqlCommand.CommandText = squery
        MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
        While MySqlReader.Read()
          Dim newCustomersRow As DataRow = atemptable.NewRow()
          newCustomersRow("cfolder_cftype_id") = MySqlReader.Item("cfolder_cftype_id")
          newCustomersRow("cfolder_cliuser_id") = MySqlReader.Item("cfolder_cliuser_id")
          newCustomersRow("cfolder_hide_flag") = MySqlReader.Item("cfolder_hide_flag")
          newCustomersRow("cfolder_id") = MySqlReader.Item("cfolder_id")
          newCustomersRow("cfolder_name") = MySqlReader.Item("cfolder_name")
          newCustomersRow("cfolder_share") = MySqlReader.Item("cfolder_share")
          newCustomersRow("cfolder_sort1") = MySqlReader.Item("cfolder_sort1")
          newCustomersRow("cfolder_sort2") = MySqlReader.Item("cfolder_sort2")
          newCustomersRow("cfolder_method") = MySqlReader.Item("cfolder_method")
          newCustomersRow("tcount") = 0

          atemptable.Rows.Add(newCustomersRow)
          atemptable.AcceptChanges()
        End While
        MySqlReader.Close()
        MySqlReader = Nothing
        Get_Client_Folders_Shared = atemptable

      ElseIf Reorder_List = True Then


        MySqlConn.ConnectionString = Me.client_DB
        MySqlConn.Open()
        MySqlCommand.Connection = MySqlConn
        MySqlCommand.CommandType = CommandType.Text
        MySqlCommand.CommandTimeout = 60
        Dim atemptable As New DataTable

        atemptable.Columns.Add("cfolder_cftype_id")
        atemptable.Columns.Add("cfolder_cliuser_id")
        atemptable.Columns.Add("cfolder_hide_flag")
        atemptable.Columns.Add("cfolder_id")
        atemptable.Columns.Add("cfolder_name")
        atemptable.Columns.Add("cfolder_share")
        atemptable.Columns.Add("cfolder_sort1")
        atemptable.Columns.Add("cfolder_sort2")
        atemptable.Columns.Add("cfolder_method")
        atemptable.Columns.Add("cfolder_description")
        atemptable.Columns.Add("cfolder_data")
        atemptable.Columns.Add("tcount")


        Dim sQuery As String = "SELECT cfolder_cftype_id, cfolder_data, cfolder_description, cfolder_method, cfolder_cliuser_id, cfolder_hide_flag, cfolder_id, cfolder_name, cfolder_share, cfolder_sort1, cfolder_sort2, (select count(*) from client_folder_index where cfolder_id = cfoldind_cfolder_id) as tcount FROM client_folder WHERE (cfolder_cftype_id = " & cfolder_cftype_id & ") AND (cfolder_share = '" & cfolder_share & "') order by cfolder_sort2"
        MySqlCommand.CommandText = sQuery

        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Folders_Shared(ByVal cfolder_share As String, ByVal cfolder_cftype_id As Integer, ByVal Reorder_List As Boolean) As DataTable</b><br />" & sQuery

        MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
        While MySqlReader.Read()
          Dim newCustomersRow As DataRow = atemptable.NewRow()
          newCustomersRow("cfolder_cftype_id") = MySqlReader.Item("cfolder_cftype_id")
          newCustomersRow("cfolder_cliuser_id") = MySqlReader.Item("cfolder_cliuser_id")
          newCustomersRow("cfolder_hide_flag") = MySqlReader.Item("cfolder_hide_flag")
          newCustomersRow("cfolder_id") = MySqlReader.Item("cfolder_id")
          newCustomersRow("cfolder_name") = MySqlReader.Item("cfolder_name")
          newCustomersRow("cfolder_share") = MySqlReader.Item("cfolder_share")
          newCustomersRow("cfolder_sort1") = MySqlReader.Item("cfolder_sort1")
          newCustomersRow("cfolder_sort2") = MySqlReader.Item("cfolder_sort2")
          newCustomersRow("tcount") = MySqlReader.Item("tcount")
          newCustomersRow("cfolder_data") = MySqlReader.Item("cfolder_data")
          newCustomersRow("cfolder_description") = MySqlReader.Item("cfolder_description")
          newCustomersRow("cfolder_method") = MySqlReader.Item("cfolder_method")

          atemptable.Rows.Add(newCustomersRow)
          atemptable.AcceptChanges()
        End While
        MySqlReader.Close()
        MySqlReader = Nothing
        Get_Client_Folders_Shared = atemptable
      End If

    Catch ex As Exception
      Get_Client_Folders_Shared = Nothing
      Me.class_error = "Error in  Get_Client_Folders_Shared(ByVal cfolder_cftype_id As Integer, ByVal cfolder_cftype_id As Integer): " & ex.Message
    Finally


      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_Folders
  ' Purpose: to get the client folders from the client_crm database
  ' Parameters: none
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/20/2012    - Created By: Amanda Vaughn

  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Client_Folders_Shared_ForNAV(ByVal cfolder_share As String) As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Try
      ' create a new instance of Class1
      Get_Client_Folders_Shared_ForNAV = Nothing
      ' create a dataset for the client
      Dim dsClient As New DataSet
      ' create a data set for JETNET
      Dim dsJETNET As New DataSet
      '' setup the connection string
      ' fill the data sets
      Dim squery As String = "SELECT cfolder_cftype_id, cfolder_method, cfolder_data, cfolder_cliuser_id, cfolder_hide_flag, cfolder_id, cfolder_name, cfolder_share, cfolder_sort1, cfolder_sort2 FROM client_folder "
      squery = squery & " WHERE  "
      squery = squery & " (cfolder_share = '" & cfolder_share & "') order by cfolder_sort2"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Folders_Shared_ForNAV(ByVal cfolder_share As String, ByVal cfolder_cftype_id As Integer) As DataTable</b><br />" & squery


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60
      Dim atemptable As New DataTable

      atemptable.Columns.Add("cfolder_cftype_id")
      atemptable.Columns.Add("cfolder_cliuser_id")
      atemptable.Columns.Add("cfolder_hide_flag")
      atemptable.Columns.Add("cfolder_id")
      atemptable.Columns.Add("cfolder_name")
      atemptable.Columns.Add("cfolder_share")
      atemptable.Columns.Add("cfolder_sort1")
      atemptable.Columns.Add("cfolder_sort2")
      atemptable.Columns.Add("cfolder_method")
      atemptable.Columns.Add("cfolder_data")
      atemptable.Columns.Add("tcount")

      MySqlCommand.CommandText = squery
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      While MySqlReader.Read()
        Dim newCustomersRow As DataRow = atemptable.NewRow()
        newCustomersRow("cfolder_cftype_id") = MySqlReader.Item("cfolder_cftype_id")
        newCustomersRow("cfolder_cliuser_id") = MySqlReader.Item("cfolder_cliuser_id")
        newCustomersRow("cfolder_hide_flag") = MySqlReader.Item("cfolder_hide_flag")
        newCustomersRow("cfolder_id") = MySqlReader.Item("cfolder_id")
        newCustomersRow("cfolder_name") = MySqlReader.Item("cfolder_name")
        newCustomersRow("cfolder_share") = MySqlReader.Item("cfolder_share")
        newCustomersRow("cfolder_sort1") = MySqlReader.Item("cfolder_sort1")
        newCustomersRow("cfolder_sort2") = MySqlReader.Item("cfolder_sort2")
        newCustomersRow("cfolder_method") = MySqlReader.Item("cfolder_method")
        newCustomersRow("cfolder_data") = MySqlReader.Item("cfolder_data")
        newCustomersRow("tcount") = 0

        atemptable.Rows.Add(newCustomersRow)
        atemptable.AcceptChanges()
      End While
      MySqlReader.Close()
      MySqlReader = Nothing
      Get_Client_Folders_Shared_ForNAV = atemptable

    Catch ex As Exception
      Get_Client_Folders_Shared_ForNAV = Nothing
      Me.class_error = "Error in  Get_Client_Folders_Shared_ForNAV(ByVal cfolder_share As String, ByVal cfolder_cftype_id As Integer) As DataTable: " & ex.Message
    Finally


      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_Folders
  ' Purpose: to get the client folders from the client_crm database
  ' Parameters: none
  ' Return: 
  '       DataTable
  ' Change Log
  '           6/6/2011    - Created By: Amanda Vaughn
  '           6/6/2011    - Modified By: Amanda Vaughn
  'SELECT cfolder_cftype_id, cfolder_cliuser_id, cfolder_hide_flag, cfolder_id, cfolder_name, cfolder_share, cfolder_sort1, 
  'cfolder_sort2 FROM client_folder WHERE (cfolder_cliuser_id = @cfolder_cliuser_id) AND (cfolder_cftype_id = @cfolder_cftype_id)
  ' AND (cfolder_share = @cfolder_share) order by cfolder_sort1, cfolder_sort2
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Client_Folders_NonShared(ByVal auser_id As Integer, ByVal cfolder_share As String, ByVal cfolder_cftype_id As Integer, ByVal reorder_list As Boolean) As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable

    Try
      ' create a new instance of Class1
      Get_Client_Folders_NonShared = Nothing

      ' fill the data sets
      If reorder_list = False Then
        Dim sQuery As String = ""
        MySqlConn.ConnectionString = Me.client_DB
        MySqlConn.Open()
        MySqlCommand.Connection = MySqlConn
        MySqlCommand.CommandType = CommandType.Text
        MySqlCommand.CommandTimeout = 60



        atemptable.Columns.Add("cfolder_cftype_id")
        atemptable.Columns.Add("cfolder_cliuser_id")
        atemptable.Columns.Add("cfolder_hide_flag")
        atemptable.Columns.Add("cfolder_id")
        atemptable.Columns.Add("cfolder_name")
        atemptable.Columns.Add("cfolder_share")
        atemptable.Columns.Add("cfolder_sort1")
        atemptable.Columns.Add("cfolder_sort2")
        atemptable.Columns.Add("cfolder_method")
        atemptable.Columns.Add("tcount")

        sQuery = "SELECT cfolder_cftype_id, cfolder_cliuser_id,cfolder_method, cfolder_hide_flag, cfolder_id, "
        sQuery = sQuery & " cfolder_name, cfolder_share, cfolder_sort1, cfolder_sort2 FROM "
        sQuery = sQuery & " client_folder WHERE (cfolder_cliuser_id = " & auser_id & ") "
        sQuery = sQuery & " AND (cfolder_cftype_id = " & cfolder_cftype_id & ") "
        sQuery = sQuery & " AND (cfolder_share = '" & cfolder_share & "' ) order by cfolder_sort1, cfolder_sort2"

        MySqlCommand.CommandText = sQuery

        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Folders_NonShared(ByVal auser_id As Integer, ByVal cfolder_share As String, ByVal cfolder_cftype_id As Integer, ByVal reorder_list As Boolean) As DataTable</b><br />" & sQuery

        MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
        While MySqlReader.Read()
          Dim newCustomersRow As DataRow = atemptable.NewRow()
          newCustomersRow("cfolder_cftype_id") = MySqlReader.Item("cfolder_cftype_id")
          newCustomersRow("cfolder_cliuser_id") = MySqlReader.Item("cfolder_cliuser_id")
          newCustomersRow("cfolder_hide_flag") = MySqlReader.Item("cfolder_hide_flag")
          newCustomersRow("cfolder_id") = MySqlReader.Item("cfolder_id")
          newCustomersRow("cfolder_name") = MySqlReader.Item("cfolder_name")
          newCustomersRow("cfolder_share") = MySqlReader.Item("cfolder_share")
          newCustomersRow("cfolder_sort1") = MySqlReader.Item("cfolder_sort1")
          newCustomersRow("cfolder_sort2") = MySqlReader.Item("cfolder_sort2")
          newCustomersRow("cfolder_method") = MySqlReader.Item("cfolder_method")
          newCustomersRow("tcount") = 0

          atemptable.Rows.Add(newCustomersRow)
          atemptable.AcceptChanges()
        End While
        MySqlReader.Close()
        MySqlReader = Nothing

      ElseIf reorder_list = True Then

        MySqlConn.ConnectionString = Me.client_DB
        MySqlConn.Open()
        MySqlCommand.Connection = MySqlConn
        MySqlCommand.CommandType = CommandType.Text
        MySqlCommand.CommandTimeout = 60

        atemptable.Columns.Add("cfolder_cftype_id")
        atemptable.Columns.Add("cfolder_cliuser_id")
        atemptable.Columns.Add("cfolder_hide_flag")
        atemptable.Columns.Add("cfolder_id")
        atemptable.Columns.Add("cfolder_name")
        atemptable.Columns.Add("cfolder_share")
        atemptable.Columns.Add("cfolder_sort1")
        atemptable.Columns.Add("cfolder_sort2")
        atemptable.Columns.Add("tcount")
        atemptable.Columns.Add("cfolder_data")
        atemptable.Columns.Add("cfolder_description")
        atemptable.Columns.Add("cfolder_method")

        Dim sQuery As String = "SELECT cfolder_cftype_id, cfolder_data, cfolder_method, cfolder_description, cfolder_cliuser_id, cfolder_hide_flag, cfolder_id, cfolder_name, cfolder_share, cfolder_sort1, cfolder_sort2, (select count(*) from client_folder_index where cfolder_id = cfoldind_cfolder_id) as tcount FROM client_folder where (cfolder_cliuser_id = " & auser_id & ") AND (cfolder_cftype_id = " & cfolder_cftype_id & ") "
        If cfolder_share <> "B" Then
          sQuery = sQuery & " and (cfolder_share = '" & cfolder_share & "') "
        End If
        sQuery = sQuery & " order by cfolder_sort1, cfolder_sort2"
        MySqlCommand.CommandText = sQuery
        MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Folders_NonShared(ByVal auser_id As Integer, ByVal cfolder_share As String, ByVal cfolder_cftype_id As Integer, ByVal reorder_list As Boolean) As DataTable</b><br />" & sQuery


        While MySqlReader.Read()
          Dim newCustomersRow As DataRow = atemptable.NewRow()
          newCustomersRow("cfolder_cftype_id") = MySqlReader.Item("cfolder_cftype_id")
          newCustomersRow("cfolder_cliuser_id") = MySqlReader.Item("cfolder_cliuser_id")
          newCustomersRow("cfolder_hide_flag") = MySqlReader.Item("cfolder_hide_flag")
          newCustomersRow("cfolder_id") = MySqlReader.Item("cfolder_id")
          newCustomersRow("cfolder_name") = MySqlReader.Item("cfolder_name")
          newCustomersRow("cfolder_share") = MySqlReader.Item("cfolder_share")
          newCustomersRow("cfolder_sort1") = MySqlReader.Item("cfolder_sort1")
          newCustomersRow("cfolder_sort2") = MySqlReader.Item("cfolder_sort2")
          newCustomersRow("tcount") = MySqlReader.Item("tcount")
          newCustomersRow("cfolder_data") = MySqlReader.Item("cfolder_data")
          newCustomersRow("cfolder_description") = MySqlReader.Item("cfolder_description")
          newCustomersRow("cfolder_method") = MySqlReader.Item("cfolder_method")

          atemptable.Rows.Add(newCustomersRow)
          atemptable.AcceptChanges()
        End While
        MySqlReader.Close()
        MySqlReader = Nothing
        Get_Client_Folders_NonShared = atemptable
      End If
      Return atemptable

    Catch ex As Exception
      Get_Client_Folders_NonShared = Nothing
      Me.class_error = "Error in  Get_Client_Folders_NonShared(ByVal cfolder_cftype_id As Integer, ByVal cfolder_cftype_id As Integer): " & ex.Message
    Finally


      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_Folders
  ' Purpose: to get the client folders from the client_crm database
  ' Parameters: none
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/20/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Client_Folders_NonSharedForLeftNav(ByVal auser_id As Integer, ByVal cfolder_share As String) As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable

    Try
      ' create a new instance of Class1
      Get_Client_Folders_NonSharedForLeftNav = Nothing

      Dim sQuery As String = ""
      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60



      atemptable.Columns.Add("cfolder_cftype_id")
      atemptable.Columns.Add("cfolder_cliuser_id")
      atemptable.Columns.Add("cfolder_hide_flag")
      atemptable.Columns.Add("cfolder_id")
      atemptable.Columns.Add("cfolder_name")
      atemptable.Columns.Add("cfolder_share")
      atemptable.Columns.Add("cfolder_sort1")
      atemptable.Columns.Add("cfolder_sort2")
      atemptable.Columns.Add("cfolder_method")
      atemptable.Columns.Add("cfolder_data")
      atemptable.Columns.Add("tcount")

      sQuery = "SELECT cfolder_cftype_id, cfolder_cliuser_id, cfolder_hide_flag, cfolder_id, "
      sQuery = sQuery & " cfolder_name, cfolder_share, cfolder_sort1, cfolder_method, cfolder_data, cfolder_sort2 FROM "
      sQuery = sQuery & " client_folder WHERE (cfolder_cliuser_id = " & auser_id & ") "
      sQuery = sQuery & " AND (cfolder_share = '" & cfolder_share & "' ) order by cfolder_sort1, cfolder_sort2"

      MySqlCommand.CommandText = sQuery

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Folders_NonSharedForLeftNav(ByVal auser_id As Integer, ByVal cfolder_share As String) As DataTable</b><br />" & sQuery

      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      While MySqlReader.Read()
        Dim newCustomersRow As DataRow = atemptable.NewRow()
        newCustomersRow("cfolder_cftype_id") = MySqlReader.Item("cfolder_cftype_id")
        newCustomersRow("cfolder_cliuser_id") = MySqlReader.Item("cfolder_cliuser_id")
        newCustomersRow("cfolder_hide_flag") = MySqlReader.Item("cfolder_hide_flag")
        newCustomersRow("cfolder_id") = MySqlReader.Item("cfolder_id")
        newCustomersRow("cfolder_name") = MySqlReader.Item("cfolder_name")
        newCustomersRow("cfolder_share") = MySqlReader.Item("cfolder_share")
        newCustomersRow("cfolder_sort1") = MySqlReader.Item("cfolder_sort1")
        newCustomersRow("cfolder_sort2") = MySqlReader.Item("cfolder_sort2")
        newCustomersRow("cfolder_method") = MySqlReader.Item("cfolder_method")
        newCustomersRow("cfolder_data") = MySqlReader.Item("cfolder_data")
        newCustomersRow("tcount") = 0

        atemptable.Rows.Add(newCustomersRow)
        atemptable.AcceptChanges()
      End While
      MySqlReader.Close()
      MySqlReader = Nothing

      Return atemptable
    Catch ex As Exception
      Get_Client_Folders_NonSharedForLeftNav = Nothing
      Me.class_error = "Error in  Get_Client_Folders_NonSharedForLeftNav(ByVal auser_id As Integer, ByVal cfolder_share As String) As DataTable: " & ex.Message
    Finally


      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  Public Function Get_ClientFolderIndex_Search(ByVal cfoldind_cfolder_id As Integer, ByVal cfoldind_jetnet_ac_id As Integer, ByVal cfold_jetnet_comp_id As Integer, ByVal cfold_jetnet_contact_id As Integer, ByVal cfoldind_client_ac_id As Integer, ByVal cfoldnd_client_comp As Integer, ByVal cfoldind_client_contact_id As Integer) As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable

    atemptable.Columns.Add("cfoldind_id")
    atemptable.Columns.Add("cfoldind_cfolder_id")
    atemptable.Columns.Add("cfoldind_jetnet_ac_id")
    atemptable.Columns.Add("cfoldind_jetnet_comp_id")
    atemptable.Columns.Add("cfoldind_jetnet_contact_id")
    atemptable.Columns.Add("cfoldind_client_ac_id")
    atemptable.Columns.Add("cfoldind_client_comp_id")
    atemptable.Columns.Add("cfoldind_client_contact_id")
    atemptable.Columns.Add("cfoldind_lnote_id_id")
    Try
      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60
      Dim squery As String = ""
      squery = "SELECT "
      squery = squery & " cfoldind_id, cfoldind_cfolder_id, cfoldind_jetnet_ac_id, cfoldind_jetnet_comp_id, "
      squery = squery & " cfoldind_jetnet_contact_id, cfoldind_client_ac_id, cfoldind_client_comp_id, "
      squery = squery & " cfoldind_client_contact_id, cfoldind_lnote_id_id"
      squery = squery & " FROM "
      squery = squery & " Client_Folder_Index"
      squery = squery & " where cfoldind_cfolder_id = " & cfoldind_cfolder_id
      squery = squery & " and cfoldind_jetnet_ac_id = " & cfoldind_jetnet_ac_id & " and "
      squery = squery & " cfoldind_jetnet_comp_id = " & cfold_jetnet_comp_id & " and "
      squery = squery & " cfoldind_jetnet_contact_id = " & cfold_jetnet_contact_id & " and "
      squery = squery & " cfoldind_client_ac_id = " & cfoldind_client_ac_id & " and "
      squery = squery & "  cfoldind_client_comp_id = " & cfoldnd_client_comp & " and "
      squery = squery & "  cfoldind_client_contact_id = " & cfoldind_client_contact_id

      MySqlCommand.CommandText = squery

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_ClientFolderIndex_Search(ByVal cfoldind_cfolder_id As Integer, ByVal cfoldind_jetnet_ac_id As Integer, ByVal cfold_jetnet_comp_id As Integer, ByVal cfold_jetnet_contact_id As Integer, ByVal cfoldind_client_ac_id As Integer, ByVal cfoldnd_client_comp As Integer, ByVal cfoldind_client_contact_id As Integer) As DataTable</b><br />" & squery


      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      While MySqlReader.Read()

        Dim newCustomersRow As DataRow = atemptable.NewRow()
        newCustomersRow("cfoldind_id") = MySqlReader.Item("cfoldind_id")
        newCustomersRow("cfoldind_cfolder_id") = MySqlReader.Item("cfoldind_cfolder_id")
        newCustomersRow("cfoldind_jetnet_ac_id") = MySqlReader.Item("cfoldind_jetnet_ac_id")
        newCustomersRow("cfoldind_jetnet_comp_id") = MySqlReader.Item("cfoldind_jetnet_comp_id")
        newCustomersRow("cfoldind_jetnet_contact_id") = MySqlReader.Item("cfoldind_jetnet_contact_id")
        newCustomersRow("cfoldind_client_ac_id") = MySqlReader.Item("cfoldind_client_ac_id")
        newCustomersRow("cfoldind_client_comp_id") = MySqlReader.Item("cfoldind_client_comp_id")
        newCustomersRow("cfoldind_client_contact_id") = MySqlReader.Item("cfoldind_client_contact_id")
        newCustomersRow("cfoldind_lnote_id_id") = MySqlReader.Item("cfoldind_lnote_id_id")

        atemptable.Rows.Add(newCustomersRow)
        atemptable.AcceptChanges()
      End While
      MySqlReader.Close()
      MySqlReader = Nothing
      Return atemptable
    Catch ex As Exception
      Get_ClientFolderIndex_Search = Nothing
      Me.class_error = "Error in  Get_ClientFolderIndex_Search(ByVal cfoldind_cfolder_id As Integer, ByVal cfoldind_jetnet_ac_id As Integer, ByVal cfold_jetnet_comp_id As Integer, ByVal cfold_jetnet_contact_id As Integer, ByVal cfoldind_client_ac_id As Integer, ByVal cfoldnd_client_comp As Integer, ByVal cfoldind_client_contact_id As Integer): " & ex.Message
    Finally


      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Delete_Client_Folder_Index
  ' Purpose: to delete a Delete_Client_Folder_Index
  ' Parameters: ByVal cfoldind_id As Integer, ByVal cfoldind_cfolder_id As Integer
  ' Return: 
  '       integer 1/success 0/fail
  ' Change Log
  '           1/6/2012   - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Delete_Client_Folder_Index(ByVal cfoldind_id As Integer, ByVal cfoldind_cfolder_id As Integer) As Integer
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Delete_Client_Folder_Index = 0
    Try
      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      sql = "DELETE FROM Client_Folder_Index WHERE ((cfoldind_id = " & cfoldind_id & ") "
      sql = sql & " and (cfoldind_cfolder_id = " & cfoldind_cfolder_id & "))"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Delete_Client_Folder_Index(ByVal cfoldind_id As Integer, ByVal cfoldind_cfolder_id As Integer) As Integer</b><br />" & sql


      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Delete_Client_Folder_Index = 1
    Catch ex As Exception
      Delete_Client_Folder_Index = 0
      Me.class_error = "Error in SQL version Delete_Client_Folder_Index(ByVal cfoldind_id As Integer, ByVal cfoldind_cfolder_id As Integer) : " & ex.Message
    Finally

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Insert_Into_Client_Folder_Index
  ' Purpose: to add to the client folder index in the client_crm database
  ' Return: 
  '       integer 1/success 0/fail
  ' Change Log
  '           1/6/2012   - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Insert_Into_Client_Folder_Index(ByVal cfoldind_cfolder_id As Integer, ByVal cfoldind_jetnet_ac_id As Integer, ByVal cfoldind_jetnet_comp_id As Integer, ByVal cfoldind_jetnet_contact_id As Integer, ByVal cfoldind_client_ac_id As Integer, ByVal cfoldind_client_comp_id As Integer, ByVal cfoldind_client_contact_id As Integer, ByVal cfoldind_lnote_id As Integer, ByRef aError As String) As Integer
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Insert_Into_Client_Folder_Index = 0
    Try
      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      sql = " INSERT INTO client_folder_index "
      sql = sql & " (cfoldind_cfolder_id, cfoldind_jetnet_ac_id, cfoldind_jetnet_comp_id, cfoldind_jetnet_contact_id, "
      sql = sql & " cfoldind_client_ac_id, cfoldind_client_comp_id, "
      sql = sql & " cfoldind_client_contact_id, cfoldind_lnote_id_id)"
      sql = sql & " VALUES  (" & cfoldind_cfolder_id & ", " & cfoldind_jetnet_ac_id & ", "
      sql = sql & "  " & cfoldind_jetnet_comp_id & "," & cfoldind_jetnet_contact_id & ", " & cfoldind_client_ac_id & ", "
      sql = sql & "  " & cfoldind_client_comp_id & ", " & cfoldind_client_contact_id & ", " & cfoldind_lnote_id & ")"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Insert_Into_Client_Folder_Index(ByVal cfoldind_cfolder_id As Integer, ByVal cfoldind_jetnet_ac_id As Integer, ByVal cfoldind_jetnet_comp_id As Integer, ByVal cfoldind_jetnet_contact_id As Integer, ByVal cfoldind_client_ac_id As Integer, ByVal cfoldind_client_comp_id As Integer, ByVal cfoldind_client_contact_id As Integer, ByVal cfoldind_lnote_id As Integer, ByRef aError As String) As Integer</b><br />" & sql


      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Insert_Into_Client_Folder_Index = 1
    Catch ex As Exception
      Insert_Into_Client_Folder_Index = 0
      Me.class_error = "Error in SQL version Insert_Into_Client_Folder_Index() : " & ex.Message
    Finally

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function


  ''' <summary>
  ''' Inserts an active folder into the database.
  ''' </summary>
  ''' <param name="cfolder_cftype_id"></param>
  ''' <param name="cfolder_name"></param>
  ''' <param name="auser_id"></param>
  ''' <param name="cfolder_share"></param>
  ''' <param name="cfolder_hide_flag"></param>
  ''' <param name="cfolder_sort1"></param>
  ''' <param name="cfolder_sort2"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Insert_Into_Client_Active_Folder(ByVal cfolder_cftype_id As Integer, ByVal cfolder_name As String, ByVal auser_id As Integer, ByVal cfolder_share As String, ByVal cfolder_hide_flag As String, ByVal cfolder_sort1 As Integer, ByVal cfolder_sort2 As Integer, ByVal cfolder_method As String, ByVal cfolder_data As String, ByVal cfolder_description As String) As Long
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Insert_Into_Client_Active_Folder = 0
    Dim NewFolderID As Long = 0
    Try

      sql = "INSERT INTO client_folder"
      sql = sql & " (cfolder_cftype_id, cfolder_name, cfolder_cliuser_id, cfolder_share, cfolder_hide_flag, "
      sql = sql & " cfolder_sort1, cfolder_sort2, cfolder_data, cfolder_description, cfolder_method, cfolder_entry_date, cfolder_update_date) "
      sql = sql & " VALUES ("
      If IsNumeric(cfolder_cftype_id) Then
        sql = sql & cfolder_cftype_id
      Else
        sql = sql & 0
      End If
      sql = sql & ",'"
      sql = sql & Left(cfolder_name, 100)
      sql = sql & "',"
      If IsNumeric(auser_id) Then
        sql = sql & auser_id
      Else
        sql = sql & 0
      End If
      sql = sql & ",'"
      sql = sql & Left(cfolder_share, 3)
      sql = sql & "','"
      sql = sql & Left(cfolder_hide_flag, 3)
      sql = sql & "',"
      If IsNumeric(cfolder_sort1) Then
        sql = sql & cfolder_sort1
      Else
        sql = sql & 0
      End If

      sql = sql & ","

      If IsNumeric(cfolder_sort2) Then
        sql = sql & cfolder_sort2
      Else
        sql = sql & 0
      End If
      sql = sql & ",'" & cfolder_data & "'"
      sql = sql & ",'" & cfolder_description & "'"
      sql = sql & ",'" & cfolder_method & "', NOW(), NOW()"
      sql = sql & ");SELECT LAST_INSERT_ID();"


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Insert_Into_Client_Folder(ByVal cfolder_cftype_id As Integer, ByVal cfolder_name As String, ByVal auser_id As Integer, ByVal cfolder_share As String, ByVal cfolder_hide_flag As String, ByVal cfolder_sort1 As Integer, ByVal cfolder_sort2 As Integer) As Integer</b><br />" & sql


      MySqlCommand.CommandText = sql
      NewFolderID = MySqlCommand.ExecuteScalar()
      Insert_Into_Client_Active_Folder = NewFolderID
    Catch ex As Exception
      Insert_Into_Client_Active_Folder = 0
      Me.class_error = "Error in SQL version Insert_Into_Client_Active_Folder As Integer : " & ex.Message
    Finally

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function
  ''' <summary>
  ''' Gets a client folder by the ID
  ''' </summary>
  ''' <param name="cliuser_id"></param>
  ''' <param name="cfolderID"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Get_Client_Folders_ByID(ByVal cliuser_id As Integer, ByVal cfolderID As Long) As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Dim sql As String = ""

    Try



      sql = "SELECT client_folder.cfolder_cftype_id, 'N' as cfolder_default_flag, client_folder.cfolder_cliuser_id,cfoldind_jetnet_ac_id,cfoldind_client_ac_id, client_folder.cfolder_hide_flag, "
      sql = sql & " client_folder.cfolder_id, client_folder.cfolder_name, cfolder_data, cfolder_method, cfolder_description, "
      sql = sql & " client_folder.cfolder_share, client_folder.cfolder_sort1, client_folder.cfolder_sort2"
      sql = sql & " FROM  client_folder "
      sql = sql & " left outer join client_folder_index ON client_folder.cfolder_id = client_folder_index.cfoldind_cfolder_id"
      sql = sql & " WHERE ((client_folder.cfolder_id =  " & cfolderID & ") AND (client_folder.cfolder_cliuser_id = " & cliuser_id & ")) "

      sql = sql & " or ((client_folder.cfolder_id =  " & cfolderID & ") AND (client_folder.cfolder_share = 'Y' ))"
      sql = sql & " ORDER BY client_folder.cfolder_cftype_id"


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Folders_ByID(ByVal cliuser_id As Integer, ByVal cfolderID As Long) As DataTable</b><br />" & sql


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)



      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      MySqlReader.Close()
      MySqlReader = Nothing
      Return atemptable
    Catch ex As Exception
      Get_Client_Folders_ByID = Nothing
      Me.class_error = " Get_Client_Folders_ByID(ByVal cliuser_id As Integer, ByVal cfolderID As Long) As DataTable: " & ex.Message
    Finally


      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_Folder_Index
  ' Purpose: to get the client folder index from the client_crm database
  ' Parameters: none
  ' Return: 
  '       DataTable
  ' Change Log
  '           1/10/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Client_Folder_Index(ByVal cfolder_id As Integer) As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Dim sql As String = ""
    Try

      sql = " SELECT cfoldind_cfolder_id, cfoldind_client_ac_id, cfoldind_client_comp_id, cfoldind_client_contact_id, "
      sql = sql & " cfoldind_id, cfoldind_jetnet_ac_id, cfoldind_jetnet_comp_id, cfoldind_jetnet_contact_id, "
      sql = sql & " cfoldind_lnote_id_id FROM client_folder_index WHERE (cfoldind_cfolder_id = " & cfolder_id & " )"

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Folder_Index(ByVal cfolder_id As Integer) As DataTable</b><br />" & sql



      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      Return atemptable
    Catch ex As Exception
      Get_Client_Folder_Index = Nothing
      Me.class_error = "Error in Get_Client_Folder_Index(ByVal cfolder_id As Integer): " & ex.Message
    Finally


      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function


  Public Function Get_Client_Folder_Type() As DataTable
    'building this by hand to avoid needing to talk to the database to get this list.
    Dim aTempTable As New DataTable
    aTempTable.Columns.Add("cftype_id")
    aTempTable.Columns.Add("cfttpe_name")
    aTempTable.Columns.Add("cftype_sort")
    aTempTable.Columns.Add("cftype_url")

    'home
    Dim newCustomersRow As DataRow = aTempTable.NewRow()
    newCustomersRow("cftype_id") = "9"
    newCustomersRow("cfttpe_name") = "Home"
    newCustomersRow("cftype_sort") = "0"
    newCustomersRow("cftype_url") = "../home.aspx"
    aTempTable.Rows.Add(newCustomersRow)
    aTempTable.AcceptChanges()

    'Company
    newCustomersRow = aTempTable.NewRow()
    newCustomersRow("cftype_id") = "1"
    newCustomersRow("cfttpe_name") = "Company"
    newCustomersRow("cftype_sort") = "1"
    newCustomersRow("cftype_url") = "../listing.aspx"
    aTempTable.Rows.Add(newCustomersRow)
    aTempTable.AcceptChanges()

    'Contact 
    newCustomersRow = aTempTable.NewRow()
    newCustomersRow("cftype_id") = "2"
    newCustomersRow("cfttpe_name") = "Contact"
    newCustomersRow("cftype_sort") = "2"
    newCustomersRow("cftype_url") = "../listing_contact.aspx"
    aTempTable.Rows.Add(newCustomersRow)
    aTempTable.AcceptChanges()

    'Aircraft
    newCustomersRow = aTempTable.NewRow()
    newCustomersRow("cftype_id") = "3"
    newCustomersRow("cfttpe_name") = "Aircraft"
    newCustomersRow("cftype_sort") = "3"
    newCustomersRow("cftype_url") = "../listing_air.aspx"
    aTempTable.Rows.Add(newCustomersRow)
    aTempTable.AcceptChanges()

    'Jobs
    newCustomersRow = aTempTable.NewRow()
    newCustomersRow("cftype_id") = "5"
    newCustomersRow("cfttpe_name") = "Jobs"
    newCustomersRow("cftype_sort") = "4"
    newCustomersRow("cftype_url") = "../listing_jobs.aspx"
    aTempTable.Rows.Add(newCustomersRow)
    aTempTable.AcceptChanges()

    'Transactions
    newCustomersRow = aTempTable.NewRow()
    newCustomersRow("cftype_id") = "8"
    newCustomersRow("cfttpe_name") = "Transactions"
    newCustomersRow("cftype_url") = "../listing_transaction.aspx"
    newCustomersRow("cftype_sort") = "4"
    aTempTable.Rows.Add(newCustomersRow)
    aTempTable.AcceptChanges()

    'Notes
    newCustomersRow = aTempTable.NewRow()
    newCustomersRow("cftype_id") = "6"
    newCustomersRow("cfttpe_name") = "Notes"
    newCustomersRow("cftype_url") = "../listing_notes.aspx"
    newCustomersRow("cftype_sort") = "5"
    aTempTable.Rows.Add(newCustomersRow)
    aTempTable.AcceptChanges()

    'Notes
    newCustomersRow = aTempTable.NewRow()
    newCustomersRow("cftype_id") = "16"
    newCustomersRow("cfttpe_name") = "Aircraft Prospects"
    newCustomersRow("cftype_url") = "../listing_notes.aspx"
    newCustomersRow("cftype_sort") = "6"
    aTempTable.Rows.Add(newCustomersRow)
    aTempTable.AcceptChanges()


    'Market Activity
    newCustomersRow = aTempTable.NewRow()
    newCustomersRow("cftype_id") = "10"
    newCustomersRow("cftype_url") = "../market.aspx"
    newCustomersRow("cfttpe_name") = "Market Activity"
    newCustomersRow("cftype_sort") = "7"
    aTempTable.Rows.Add(newCustomersRow)
    aTempTable.AcceptChanges()

    'doc
    newCustomersRow = aTempTable.NewRow()
    newCustomersRow("cftype_id") = "7"
    newCustomersRow("cfttpe_name") = "Documents"
    newCustomersRow("cftype_url") = "../listing_documents.aspx"
    newCustomersRow("cftype_sort") = "8"
    aTempTable.Rows.Add(newCustomersRow)
    aTempTable.AcceptChanges()

    'Opportunities
    newCustomersRow = aTempTable.NewRow()
    newCustomersRow("cftype_id") = "11"
    newCustomersRow("cfttpe_name") = "Opportunities"
    newCustomersRow("cftype_url") = "../listing_opportunities.aspx"
    newCustomersRow("cftype_sort") = "10"
    aTempTable.Rows.Add(newCustomersRow)
    aTempTable.AcceptChanges()

    'Wanteds
    newCustomersRow = aTempTable.NewRow()
    newCustomersRow("cftype_id") = "12"
    newCustomersRow("cfttpe_name") = "Wanteds"
    newCustomersRow("cftype_url") = "../listing_wanted.aspx"
    newCustomersRow("cftype_sort") = "9"
    aTempTable.Rows.Add(newCustomersRow)
    aTempTable.AcceptChanges()



    'Action Items
    newCustomersRow = aTempTable.NewRow()
    newCustomersRow("cftype_id") = "4"
    newCustomersRow("cfttpe_name") = "Action Items"
    newCustomersRow("cftype_url") = "../listing_action.aspx"
    newCustomersRow("cftype_sort") = "11"
    aTempTable.Rows.Add(newCustomersRow)
    aTempTable.AcceptChanges()

    Return aTempTable

  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_Folders_MyAircraft
  ' Purpose: to get the client folders from the client_crm database
  ' Parameters: none
  ' Return: 
  '       DataTable
  ' Change Log
  '           1/16/2012    - Created By: Amanda Jennings
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Client_Folders_MyAircraft(ByVal cfolder_name As String, ByVal cliuser_id As Integer, ByVal if_data As Boolean) As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Dim sql As String = ""

    Try


      atemptable.Columns.Add("cfolder_cftype_id")
      atemptable.Columns.Add("cfolder_cliuser_id")
      atemptable.Columns.Add("cfolder_hide_flag")
      atemptable.Columns.Add("cfolder_id")
      atemptable.Columns.Add("cfolder_name")
      atemptable.Columns.Add("cfolder_share")
      atemptable.Columns.Add("cfolder_sort1")
      atemptable.Columns.Add("cfolder_sort2")


      ' fill the data sets
      If if_data = False Then
        sql = "SELECT cfolder_cftype_id, cfolder_cliuser_id, cfolder_hide_flag, cfolder_id, cfolder_name, cfolder_share, cfolder_sort1, cfolder_sort2"
        sql = sql & " FROM(client_folder)"
        sql = sql & " WHERE        (UCASE(cfolder_name) = '" & cfolder_name & "') AND (cfolder_cliuser_id = " & cliuser_id & ")"
        sql = sql & " ORDER BY cfolder_cftype_id"

      Else

        sql = "SELECT client_folder.cfolder_cftype_id, client_folder.cfolder_cliuser_id, client_folder.cfolder_hide_flag, "
        sql = sql & " client_folder.cfolder_id, client_folder.cfolder_name, "
        sql = sql & " client_folder.cfolder_share, client_folder.cfolder_sort1, client_folder.cfolder_sort2"
        sql = sql & " FROM  client_folder INNER JOIN"
        sql = sql & " client_folder_index ON client_folder.cfolder_id = client_folder_index.cfoldind_cfolder_id"
        sql = sql & " WHERE (UCASE(client_folder.cfolder_name) =  '" & cfolder_name & "') AND (client_folder.cfolder_cliuser_id = " & cliuser_id & ")"
        sql = sql & " ORDER BY client_folder.cfolder_cftype_id"
      End If

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Folders_MyAircraft(ByVal cfolder_name As String, ByVal cliuser_id As Integer, ByVal if_data As Boolean) As DataTable</b><br />" & sql


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)



      While MySqlReader.Read()
        Dim newCustomersRow As DataRow = atemptable.NewRow()
        newCustomersRow("cfolder_cftype_id") = MySqlReader.Item("cfolder_cftype_id")
        newCustomersRow("cfolder_cliuser_id") = MySqlReader.Item("cfolder_cliuser_id")
        newCustomersRow("cfolder_hide_flag") = MySqlReader.Item("cfolder_hide_flag")
        newCustomersRow("cfolder_id") = MySqlReader.Item("cfolder_id")
        newCustomersRow("cfolder_name") = MySqlReader.Item("cfolder_name")
        newCustomersRow("cfolder_share") = MySqlReader.Item("cfolder_share")
        newCustomersRow("cfolder_sort1") = MySqlReader.Item("cfolder_sort1")
        newCustomersRow("cfolder_sort2") = MySqlReader.Item("cfolder_sort2")

        atemptable.Rows.Add(newCustomersRow)
        atemptable.AcceptChanges()
      End While
      MySqlReader.Close()
      MySqlReader = Nothing
      Return atemptable
    Catch ex As Exception
      Get_Client_Folders_MyAircraft = Nothing
      Me.class_error = " Get_Client_Folders_MyAircraft(ByVal " & cfolder_name & " cfolder_name As String, ByVal " & cliuser_id & " cliuser_id As Integer, ByVal " & if_data & " if_data As Boolean): " & ex.Message
    Finally


      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_Folders
  ' Purpose: to get the client folders from the client_crm database
  ' Parameters: none
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/2/2012    - Created By: Tom Jones

  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Client_Folders(ByVal auser_id As Integer, ByVal cfolder_share As String, ByVal cfolder_cftype_id As Integer) As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Dim sql As String = ""

    Try

      sql = " SELECT cfolder_cftype_id, cfolder_cliuser_id, cfolder_method, cfolder_hide_flag, cfolder_id, "
      sql = sql & " cfolder_name, cfolder_share, cfolder_sort1, cfolder_sort2 FROM "
      sql = sql & " client_folder WHERE (cfolder_cliuser_id = " & auser_id & ") AND "
      sql = sql & " (cfolder_cftype_id =  " & cfolder_cftype_id & ") OR (cfolder_cftype_id = " & cfolder_cftype_id & ") "
      sql = sql & " AND (cfolder_share = '" & cfolder_share & "') order by cfolder_sort2"

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Folders(ByVal auser_id As Integer, ByVal cfolder_share As String, ByVal cfolder_cftype_id As Integer) As DataTable</b><br />" & sql


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Return atemptable

    Catch ex As Exception
      Get_Client_Folders = Nothing
      Me.class_error = " Get_Client_Folders(ByVal auser_id As Integer, ByVal cfolder_share As String, ByVal cfolder_cftype_id As Integer) As DataTable: " & ex.Message
    Finally


      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Client_Folder_BadSort
  ' Purpose: to get the client folders from the client_crm database
  ' Parameters: none
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/3/2012    - Created By: Amanda 
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Client_Folder_BadSort() As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Dim sql As String = ""

    Try
      sql = " SELECT cfolder_cftype_id, cfolder_cliuser_id, cfolder_hide_flag, "
      sql = sql & " cfolder_id, cfolder_name, cfolder_share, cfolder_sort1, cfolder_sort2"
      sql = sql & " FROM client_folder "
      sql = sql & " WHERE (cfolder_sort1 = 0)"
      sql = sql & " ORDER BY  cfolder_id"

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Client_Folder_BadSort() As DataTable</b><br />" & sql


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try


      Return atemptable

    Catch ex As Exception
      Client_Folder_BadSort = Nothing
      Me.class_error = " Client_Folder_BadSort() As DataTable: " & ex.Message
    Finally


      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Insert_Into_Client_Folder
  ' Purpose: to add to the client folder index table
  ' Parameters: none
  ' Return: 
  '       Integer: 
  '                 1 - Success
  '                 0 - Fail
  ' Change Log
  '           2/3/2012    - Created By: Amanda
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Insert_Into_Client_Folder(ByVal cfolder_cftype_id As Integer, ByVal cfolder_name As String, ByVal auser_id As Integer, ByVal cfolder_share As String, ByVal cfolder_hide_flag As String, ByVal cfolder_sort1 As Integer, ByVal cfolder_sort2 As Integer) As Integer
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Dim NewFolderID As Long = 0
    Insert_Into_Client_Folder = 0
    Try

      sql = "INSERT INTO client_folder"
      sql = sql & " (cfolder_cftype_id, cfolder_name, cfolder_cliuser_id, cfolder_share, cfolder_hide_flag, "
      sql = sql & " cfolder_sort1, cfolder_sort2) "
      sql = sql & " VALUES ("
      If IsNumeric(cfolder_cftype_id) Then
        sql = sql & cfolder_cftype_id
      Else
        sql = sql & 0
      End If
      sql = sql & ",'"
      sql = sql & Left(cfolder_name, 100)
      sql = sql & "',"
      If IsNumeric(auser_id) Then
        sql = sql & auser_id
      Else
        sql = sql & 0
      End If
      sql = sql & ",'"
      sql = sql & Left(cfolder_share, 3)
      sql = sql & "','"
      sql = sql & Left(cfolder_hide_flag, 3)
      sql = sql & "',"
      If IsNumeric(cfolder_sort1) Then
        sql = sql & cfolder_sort1
      Else
        sql = sql & 0
      End If

      sql = sql & ","

      If IsNumeric(cfolder_sort2) Then
        sql = sql & cfolder_sort2
      Else
        sql = sql & 0
      End If

      sql = sql & ");SELECT LAST_INSERT_ID();"


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Insert_Into_Client_Folder(ByVal cfolder_cftype_id As Integer, ByVal cfolder_name As String, ByVal auser_id As Integer, ByVal cfolder_share As String, ByVal cfolder_hide_flag As String, ByVal cfolder_sort1 As Integer, ByVal cfolder_sort2 As Integer) As Integer</b><br />" & sql


      MySqlCommand.CommandText = sql
      NewFolderID = MySqlCommand.ExecuteScalar()
      Insert_Into_Client_Folder = NewFolderID
    Catch ex As Exception
      Insert_Into_Client_Folder = 0
      Me.class_error = "Error in SQL version Insert_Into_Client_Folder(ByVal cfolder_cftype_id As Integer, ByVal cfolder_name As String, ByVal auser_id As Integer, ByVal cfolder_share As String, ByVal cfolder_hide_flag As String, ByVal cfolder_sort1 As Integer, ByVal cfolder_sort2 As Integer) As Integer : " & ex.Message
    Finally

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Remove Client Folders - Delete Sub Folder!
  ' Purpose: to remove client folders from the client_crm database
  ' Parameters: none
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/3/2012   - Created By:  Amanda
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  'DELETE FROM client_folder WHERE ((cfolder_id = @Original_cfolder_id) AND (cfolder_cftype_id = @Original_cfolder_cftype_id) AND (cfolder_name = @Original_cfolder_name) AND (cfolder_cliuser_id = @Original_cfolder_cliuser_id))
  Public Function Remove_Client_Folders(ByVal original_cfolder_id As Integer, ByVal Original_cfolder_cftype_id As Integer, ByVal Original_cfolder_name As String, ByVal Original_cfolder_cliuser_id As Integer) As Integer
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Remove_Client_Folders = 0
    Try
      sql = "DELETE FROM client_folder WHERE ((cfolder_id = " & original_cfolder_id & ")"
      sql = sql & " AND (cfolder_cftype_id = " & Original_cfolder_cftype_id & ") "
      sql = sql & "AND (cfolder_name = '" & Original_cfolder_name & "') "
      sql = sql & " AND (cfolder_cliuser_id = " & Original_cfolder_cliuser_id & ")) limit 1 "

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Remove_Client_Folders(ByVal original_cfolder_id As Integer, ByVal Original_cfolder_cftype_id As Integer, ByVal Original_cfolder_name As String, ByVal Original_cfolder_cliuser_id As Integer) As Integer</b><br />" & sql


      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Remove_Client_Folders = 1
    Catch ex As Exception
      Remove_Client_Folders = 0
      Me.class_error = "Error in SQL version Remove_Client_Folders(ByVal original_cfolder_id As Integer, ByVal Original_cfolder_cftype_id As Integer, ByVal Original_cfolder_name As String, ByVal Original_cfolder_cliuser_id As Integer) As Integer: " & ex.Message
    Finally

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function
  ''' <summary>
  ''' updates only what's needed on the crm folder editing page.
  ''' </summary>
  ''' <param name="cfolder_name"></param>
  ''' <param name="cfolder_share"></param>
  ''' <param name="cfolder_hide_flag"></param>
  ''' <param name="original_cfolder_id"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Update_Selective_Client_Folders(ByVal cfolder_name As String, ByVal cfolder_share As String, ByVal cfolder_hide_flag As String, ByVal original_cfolder_id As Integer) As Integer
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Update_Selective_Client_Folders = 0
    Try
      sql = "UPDATE client_folder "
      sql = sql & " SET "
      sql = sql & " cfolder_name = '" & Left(Replace(cfolder_name, "'", "\'"), 100) & "', "
      sql = sql & " cfolder_share = '" & Left(cfolder_share, 3) & "', "
      sql = sql & " cfolder_hide_flag = '" & Left(cfolder_hide_flag, 3) & "' "
      sql = sql & " WHERE (cfolder_id = '" & original_cfolder_id & "') limit 1"


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Update_Client_Folders(ByVal cfolder_cftype_id As Integer, ByVal cfolder_name As String, ByVal cfolder_cliuser_id As Integer, ByVal cfolder_share As String, ByVal cfolder_hide_flag As String, ByVal cfolder_sort1 As Integer, ByVal cfolder_sort2 As Integer, ByVal original_cfolder_id As Integer) As Integer</b><br />" & sql


      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Update_Selective_Client_Folders = 1
    Catch ex As Exception
      Update_Selective_Client_Folders = 0
      Me.class_error = "Error in SQL version Update_Client_Folders(ByVal cfolder_cftype_id As Integer, ByVal cfolder_name As String, ByVal cfolder_cliuser_id As Integer, ByVal cfolder_share As String, ByVal cfolder_hide_flag As String, ByVal cfolder_sort1 As Integer, ByVal cfolder_sort2 As Integer, ByVal original_cfolder_id As Integer) As Integer: " & ex.Message
    Finally

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function
  ''' <summary>
  ''' Removes client folder by primary key only
  ''' </summary>
  ''' <param name="original_cfolder_id"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Remove_Client_Folders_ByPrimaryKeyOnly(ByVal original_cfolder_id As Integer) As Integer
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Remove_Client_Folders_ByPrimaryKeyOnly = 0
    Try
      sql = "DELETE FROM client_folder WHERE (cfolder_id = " & original_cfolder_id & ") limit 1 "

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Remove_Client_Folders_ByPrimaryKeyOnly(ByVal original_cfolder_id As Integer) As Integer</b><br />" & sql


      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Remove_Client_Folders_ByPrimaryKeyOnly = 1
    Catch ex As Exception
      Remove_Client_Folders_ByPrimaryKeyOnly = 0
      Me.class_error = "Error in SQL version Remove_Client_Folders_ByPrimaryKeyOnly(ByVal original_cfolder_id As Integer) As Integer: " & ex.Message
    Finally

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Update Client Folders - Update Sub Folder!
  ' Purpose: to update client folders from the client_crm database
  ' Parameters: none
  ' Return: 
  '       DataTable 
  ' Change Log
  '           2/4/2012    - Created By:  Amanda
  Public Function Update_Client_Folders(ByVal cfolder_cftype_id As Integer, ByVal cfolder_name As String, ByVal cfolder_cliuser_id As Integer, ByVal cfolder_share As String, ByVal cfolder_hide_flag As String, ByVal cfolder_sort1 As Integer, ByVal cfolder_sort2 As Integer, ByVal cfolder_data As String, ByVal cfolder_method As String, ByVal cfolder_description As String, ByVal original_cfolder_id As Integer) As Integer
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Update_Client_Folders = 0
    Try
      sql = "UPDATE client_folder "
      sql = sql & " SET cfolder_cftype_id = '" & cfolder_cftype_id & "', "
      sql = sql & " cfolder_name = '" & Left(Replace(cfolder_name, "'", "\'"), 100) & "', "
      sql = sql & " cfolder_cliuser_id = '" & cfolder_cliuser_id & "', "
      sql = sql & " cfolder_data = '" & Replace(cfolder_data, "'", "\'") & "', "
      sql = sql & " cfolder_description = '" & Replace(cfolder_description, "'", "\'") & "', "
      sql = sql & " cfolder_method = '" & cfolder_method & "', "
      sql = sql & " cfolder_share = '" & Left(cfolder_share, 3) & "', "
      sql = sql & " cfolder_hide_flag = '" & Left(cfolder_hide_flag, 3) & "', "
      sql = sql & " cfolder_sort1 = '" & cfolder_sort1 & "', "
      sql = sql & " cfolder_sort2 = '" & cfolder_sort2 & "' WHERE (cfolder_id = '" & original_cfolder_id & "') limit 1"


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Update_Client_Folders(ByVal cfolder_cftype_id As Integer, ByVal cfolder_name As String, ByVal cfolder_cliuser_id As Integer, ByVal cfolder_share As String, ByVal cfolder_hide_flag As String, ByVal cfolder_sort1 As Integer, ByVal cfolder_sort2 As Integer, ByVal original_cfolder_id As Integer) As Integer</b><br />" & sql


      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Update_Client_Folders = 1
    Catch ex As Exception
      Update_Client_Folders = 0
      Me.class_error = "Error in SQL version Update_Client_Folders(ByVal cfolder_cftype_id As Integer, ByVal cfolder_name As String, ByVal cfolder_cliuser_id As Integer, ByVal cfolder_share As String, ByVal cfolder_hide_flag As String, ByVal cfolder_sort1 As Integer, ByVal cfolder_sort2 As Integer, ByVal original_cfolder_id As Integer) As Integer: " & ex.Message
    Finally

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Update Client Folders - Update Sub Folder sort!
  ' Purpose: to update client folders from the client_crm database
  ' Parameters: none
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/4/2012    - Created By:  Amanda
  Public Function Update_Client_Folders_Sort(ByVal cfolder_sort2 As Integer, ByVal cfolder_sort1 As Integer, ByVal original_cfolder_id As Integer, ByVal typeSort As Integer) As Integer

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Update_Client_Folders_Sort = 0
    Try

      If typeSort = 2 Then
        sql = " UPDATE client_folder "
        sql = sql & " SET cfolder_sort2 = '" & cfolder_sort2 & "' "
        sql = sql & " WHERE (cfolder_id = '" & original_cfolder_id & "') limit 1 "
      ElseIf typeSort = 1 Then
        sql = " UPDATE client_folder "
        sql = sql & " SET  cfolder_sort1 = '" & cfolder_sort1 & "' "
        sql = sql & " WHERE (cfolder_id = '" & original_cfolder_id & "' ) limit 1 "


      End If


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Update_Client_Folders_Sort(ByVal cfolder_sort2 As Integer, ByVal cfolder_sort1 As Integer, ByVal original_cfolder_id As Integer, ByVal typeSort As Integer) As Integer</b><br />" & sql


      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Update_Client_Folders_Sort = 1
    Catch ex As Exception
      Update_Client_Folders_Sort = 0
      Me.class_error = "Error in SQL version Update_Client_Folders_Sort(ByVal cfolder_sort2 As Integer, ByVal cfolder_sort1 As Integer, ByVal original_cfolder_id As Integer, ByVal typeSort As Integer) As Integer: " & ex.Message
    Finally

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
#End Region
#Region "Only AC Client"
  Public Function Get_Client_Aircraft_Transaction_as_Jetnet_Fields(ByVal aircraftID As Long, ByVal jetnetTransactionID As Long) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim ReturnTable As New DataTable

    Try
      sql = "SELECT clitrans_jetnet_ac_id as ac_id, clitrans_est_price as broker_price,clitrans_sold_price as ac_sale_price, "
      sql += " clitrans_cliamod_id as ac_amod_id, "
      sql += " client_aircraft_model.cliamod_jetnet_amod_id as jetnet_amod_id,  clitrans_reg_nbr as ac_reg_no, "
      sql += " clitrans_jetnet_trans_id as ac_journ_id, clitrans_reg_nbr as ac_reg_no_search, "
      sql += " '' as ac_delivery_date, "
      sql += " clitrans_lifecycle as ac_lifecycle,  clitrans_lifecycle as ac_lifecycle_stage, "
      sql += "clitrans_ownership as ac_ownership, clitrans_ownership as ac_ownership_type, "
      sql += " '' as ac_usage, "
      sql += " clitrans_ser_nbr as ac_ser_nbr, "
      sql += " '' as ac_alt_ser_nbr, "
      sql += " '' as ac_alt_ser_nbr_full, "
      sql += "  clitrans_reg_nbr as ac_reg_nbr, '' as ac_prev_reg_no, "
      sql += " '' as ac_prev_reg_nbr, "
      sql += " clitrans_country_of_registration as ac_country_of_registration, "
      sql += " (select case when clitrans_newac_flag='Y' then 'N' else 'Y' end) as ac_previously_owned_flag,"
      sql += " clitrans_year_mfr as ac_year_mfr,  clitrans_year_mfr as ac_mfr_year,  "
      sql += " '' as ac_year_dlv,'' as ac_year, "
      sql += " '' as ac_date_purchased, '' as ac_purchase_date, "
      sql += " '' as ac_forsale_flag, "
      sql += " clitrans_date_listed as ac_date_listed, clitrans_date_listed as ac_list_date,"
      sql += " '' as ac_status, "
      sql += " clitrans_est_price as take_price, "
      sql += " '' as ac_delivery, "
      sql += " clitrans_exclusive_flag as ac_exclusive_flag, clitrans_asking_wordage as ac_asking, "
      sql += " clitrans_asking_wordage as ac_asking_wordage,"
      sql += " clitrans_asking_price as ac_asking_price, "
      sql += " '' as ac_lease_flag, "
      sql += " clitrans_airframe_total_hours as ac_airframe_total_hours,  	clitrans_airframe_total_hours as ac_airframe_tot_hrs, clitrans_airframe_total_landings as ac_airframe_tot_landings,"
      sql += " clitrans_airframe_total_landings as ac_airframe_total_landings, "
      sql += " NULL as  ac_date_engine_times_as_of, NULL as ac_times_as_of_date, "
      sql += " clitrans_aport_iata_code as ac_aport_iata_code, "
      sql += " clitrans_aport_icao_code as ac_aport_icao_code, "
      sql += " clitrans_aport_name as ac_aport_name,  "
      sql += " clitrans_aport_state as ac_aport_state, "
      sql += " clitrans_aport_country as ac_aport_country, "
      sql += " clitrans_aport_city as ac_aport_city, "
      sql += " clitrans_aport_private as ac_aport_private, "


      sql += " NULL as custom_1, "
      sql += " NULL as custom_2, "
      sql += " NULL as custom_3, "
      sql += " NULL as custom_4, "
      sql += " NULL as custom_5, "
      sql += " NULL as custom_6, "
      sql += " NULL as custom_7, "
      sql += " NULL as custom_8, "
      sql += " NULL as custom_9, "
      sql += " NULL as custom_10, "

      sql += " clitrans_action_date as ac_action_date ,"
      sql += " '' AS ac_value_description , client_aircraft_model.cliamod_airframe_type as amod_airframe_type_code, "
      sql += " client_aircraft_model.cliamod_airframe_type as amod_airframe_type, client_aircraft_model.cliamod_airframe_type as amod_type_code,"
      sql += " client_aircraft_model.cliamod_make_type as amod_make_type, "
      sql += " client_aircraft_model.cliamod_make_name as amod_make_name, "
      sql += " client_aircraft_model.cliamod_model_name as amod_model_name, "
      sql += " client_aircraft_model.cliamod_manufacturer_name as amod_manufacturer_name, "


      sql += " 'N' as ac_picture_exist_flag, "
      sql += " clitrans_ser_nbr as ac_ser_nbr_sort, "

      'sql += " 'Y' as ac_product_business_flag, "
      'sql += " 'Y' as ac_product_helicopter_flag, "
      'sql += " 'Y' as ac_product_commercial_flag, "
      sql += " clitrans_cliac_id as CLIENT_ID, "

      'Fields unsure of
      sql += " NULL as ac_alt_ser_no_full, "
      sql += " NULL as ac_upd_date, "
      sql += " '' as ac_foreign_currency_name, "
      sql += " NULL as ac_reg_no_expiration_date, "
      sql += " NULL as ac_foreign_currency_price, "
      'sql += " NULL as amod_number_of_engines, "
      sql += " NULL as amod_weight_class, "
      sql += " NULL as ac_aport_faaid_code, "
      sql += " NULL as ac_exclusive_expiration_flag, "
      sql += " NULL as ac_exclusive_date, "
      sql += " NULL as amod_manufacturer_comp_id "

      sql += " FROM client_transactions "
      'This join should be inner
      sql += " INNER JOIN client_aircraft_model ON client_transactions.clitrans_cliamod_id = client_aircraft_model.cliamod_id"
      'Left Outer:
      'sql += " LEFT OUTER JOIN client_aircraft_engine ON client_aircraft.cliaircraft_id = client_aircraft_engine.cliacep_cliac_id"
      'Left Outer:
      'sql += " LEFT OUTER JOIN client_aircraft_propeller ON client_aircraft.cliaircraft_id = client_aircraft_propeller.cliacpr_cliac_id"
      ''Left Outer:
      'sql += " LEFT OUTER JOIN airframe_maintenance_program ON client_aircraft.cliaircraft_airframe_maintenance_program = airframe_maintenance_program.amp_id "
      ''Left Outer:
      'sql += " LEFT OUTER JOIN airframe_maintenance_tracking_program ON client_aircraft.cliaircraft_airframe_maintenance_tracking_program = airframe_maintenance_tracking_program.amtp_id "
      ''Left Outer:
      'sql += " LEFT OUTER JOIN engine_maintenance_program ON client_aircraft_engine.cliacep_engine_maintenance_program = engine_maintenance_program.emp_id "
      ''Left Outer:
      'sql += " LEFT OUTER JOIN engine_management_program ON client_aircraft_engine.cliacep_engine_management_program = engine_management_program.emgp_id "

      sql += " WHERE "
      If aircraftID > 0 Then
        sql += " (clitrans_id = @AircraftID)"
      Else
        sql += " (clitrans_jetnet_trans_id = @JetnetTransID)"
      End If
      MySqlConn.ConnectionString = client_DB
      MySqlConn.Open()

      Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand(sql, MySqlConn)

      If aircraftID > 0 Then
        MySqlCommand.Parameters.AddWithValue("AircraftID", aircraftID)
      Else
        MySqlCommand.Parameters.AddWithValue("JetnetTransID", jetnetTransactionID)
      End If

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Aircraft_Transaction_as_Jetnet_Fields(ByVal aircraftID As Long) As DataTable</b><br />" & sql


      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        ReturnTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = ReturnTable.GetErrors()
      End Try

      MySqlCommand.Dispose()
      MySqlCommand = Nothing


      Return ReturnTable
    Catch ex As Exception
      Get_Client_Aircraft_Transaction_as_Jetnet_Fields = Nothing
      Me.class_error = "Error in Get_Client_Aircraft_Transaction_as_Jetnet_Fields(ByVal aircraftID As Long) As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
    End Try

  End Function

  Public Function CreateClientWithJetnet(ByVal clientTableCopy As DataTable, ByVal jetnetTable As DataTable) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim ReturnTable As New DataTable

    Dim clientTable As New DataTable
    clientTable = clientTableCopy.Clone

    clientTable.Columns.Add("ac_airframe_maintenance_program")
    clientTable.Columns.Add("ac_airframe_maintenance_tracking_program")
    clientTable.Columns.Add("ac_apu_model_name")
    clientTable.Columns.Add("ac_apu_ser_nbr")
    clientTable.Columns.Add("ac_apu_ttsn_hours")
    clientTable.Columns.Add("ac_apu_tsoh_hours")
    clientTable.Columns.Add("ac_apu_tshi_hours")
    clientTable.Columns.Add("ac_apu_ser_no")
    clientTable.Columns.Add("ac_apu_tot_hrs")
    clientTable.Columns.Add("ac_apu_soh_hrs")
    clientTable.Columns.Add("ac_apu_shi_hrs")
    clientTable.Columns.Add("ac_apu_maintance_program")
    clientTable.Columns.Add("ac_damage_flag")
    clientTable.Columns.Add("ac_damage_history_notes")
    clientTable.Columns.Add("ac_interior_rating")
    clientTable.Columns.Add("ac_interior_month_year")
    clientTable.Columns.Add("ac_interior_moyear")
    clientTable.Columns.Add("ac_interior_doneby_name")
    clientTable.Columns.Add("ac_interior_config_name")
    clientTable.Columns.Add("ac_exterior_moyear")
    clientTable.Columns.Add("ac_exterior_rating")
    clientTable.Columns.Add("ac_exterior_month_year")
    clientTable.Columns.Add("ac_exterior_doneby_name")
    clientTable.Columns.Add("ac_passenger_count")
    clientTable.Columns.Add("ac_confidential_notes")
    clientTable.Columns.Add("ac_maintained")
    clientTable.Columns.Add("ac_engine_name")
    clientTable.Columns.Add("ac_engine_tbo_oc_flag")
    clientTable.Columns.Add("ac_engine_noise_rating")
    clientTable.Columns.Add("ac_model_config")
    clientTable.Columns.Add("ac_engine_maintenance_prog_EMP")
    clientTable.Columns.Add("ac_engine_management_prog_EMGP")
    clientTable.Columns.Add("ac_maint_hots_by_name")
    clientTable.Columns.Add("ac_main_eoh_moyear")
    clientTable.Columns.Add("ac_maint_eoh_by_name")
    clientTable.Columns.Add("ac_maint_hots_moyear")
    clientTable.Columns.Add("certifications")


    clientTable.Columns.Add("ac_engine_1_ser_no")
    clientTable.Columns.Add("ac_engine_2_ser_no")
    clientTable.Columns.Add("ac_engine_3_ser_no")
    clientTable.Columns.Add("ac_engine_4_ser_no")
    clientTable.Columns.Add("ac_engine_1_tot_hrs")
    clientTable.Columns.Add("ac_engine_2_tot_hrs")
    clientTable.Columns.Add("ac_engine_3_tot_hrs")
    clientTable.Columns.Add("ac_engine_4_tot_hrs")
    clientTable.Columns.Add("ac_engine_1_soh_hrs")
    clientTable.Columns.Add("ac_engine_2_soh_hrs")
    clientTable.Columns.Add("ac_engine_3_soh_hrs")
    clientTable.Columns.Add("ac_engine_4_soh_hrs")

    clientTable.Columns.Add("ac_engine_1_shi_hrs")
    clientTable.Columns.Add("ac_engine_2_shi_hrs")
    clientTable.Columns.Add("ac_engine_3_shi_hrs")
    clientTable.Columns.Add("ac_engine_4_shi_hrs")

    clientTable.Columns.Add("ac_engine_1_tbo_hrs")
    clientTable.Columns.Add("ac_engine_2_tbo_hrs")
    clientTable.Columns.Add("ac_engine_3_tbo_hrs")
    clientTable.Columns.Add("ac_engine_4_tbo_hrs")

    clientTable.Columns.Add("ac_engine_1_snew_cycles")
    clientTable.Columns.Add("ac_engine_2_snew_cycles")
    clientTable.Columns.Add("ac_engine_3_snew_cycles")
    clientTable.Columns.Add("ac_engine_4_snew_cycles")

    clientTable.Columns.Add("ac_engine_1_soh_cycles")
    clientTable.Columns.Add("ac_engine_2_soh_cycles")
    clientTable.Columns.Add("ac_engine_3_soh_cycles")
    clientTable.Columns.Add("ac_engine_4_soh_cycles")

    clientTable.Columns.Add("ac_engine_1_shs_cycles")
    clientTable.Columns.Add("ac_engine_2_shs_cycles")
    clientTable.Columns.Add("ac_engine_3_shs_cycles")
    clientTable.Columns.Add("ac_engine_4_shs_cycles")

    clientTable.Columns.Add("ac_prop_1_ser_no")
    clientTable.Columns.Add("ac_prop_2_ser_no")
    clientTable.Columns.Add("ac_prop_3_ser_no")
    clientTable.Columns.Add("ac_prop_4_ser_no")

    clientTable.Columns.Add("ac_prop_1_snew_hrs")
    clientTable.Columns.Add("ac_prop_2_snew_hrs")
    clientTable.Columns.Add("ac_prop_3_snew_hrs")
    clientTable.Columns.Add("ac_prop_4_snew_hrs")

    clientTable.Columns.Add("ac_prop_1_soh_hrs")
    clientTable.Columns.Add("ac_prop_2_soh_hrs")
    clientTable.Columns.Add("ac_prop_3_soh_hrs")
    clientTable.Columns.Add("ac_prop_4_soh_hrs")

    clientTable.Columns.Add("ac_prop_1_soh_moyear")
    clientTable.Columns.Add("ac_prop_2_soh_moyear")
    clientTable.Columns.Add("ac_prop_3_soh_moyear")
    clientTable.Columns.Add("ac_prop_4_soh_moyear")


    clientTable.Columns.Add("amp_provider_name")
    clientTable.Columns.Add("amp_program_name")
    clientTable.Columns.Add("amtp_provider_name")
    clientTable.Columns.Add("amtp_program_name")
    clientTable.Columns.Add("emp_program_name")

    clientTable.Columns.Add("emp_provider_name")
    clientTable.Columns.Add("emgp_provider_name")
    clientTable.Columns.Add("emgp_program_name")
    clientTable.Columns.Add("ac_product_business_flag")
    clientTable.Columns.Add("ac_product_helicopter_flag")
    clientTable.Columns.Add("ac_product_commercial_flag")
    clientTable.Columns.Add("acuse_name")
    clientTable.Columns.Add("ac_est_airframe_hrs")

    Try
      clientTable.Constraints.Clear()
      If jetnetTable.Rows.Count > 0 Then
        For Each r As DataRow In clientTableCopy.Rows
          Dim newRow As DataRow = clientTable.NewRow


          newRow.Item("ac_id") = r("ac_id")
          newRow.Item("broker_price") = r("broker_price")
          newRow.Item("ac_sale_price") = r("ac_sale_price")
          newRow.Item("ac_reg_no") = r("ac_reg_no")
          newRow.Item("ac_journ_id") = r("ac_journ_id")
          newRow.Item("ac_reg_no_search") = r("ac_reg_no_search")
          newRow.Item("ac_delivery_date") = r("ac_delivery_date")
          newRow.Item("ac_lifecycle") = r("ac_lifecycle")
          newRow.Item("ac_lifecycle_stage") = r("ac_lifecycle_stage")
          newRow.Item("ac_ownership") = r("ac_ownership")
          newRow.Item("ac_ownership_type") = r("ac_ownership_type")
          newRow.Item("ac_usage") = r("ac_usage")
          newRow.Item("ac_ser_nbr") = r("ac_ser_nbr")
          newRow.Item("ac_alt_ser_nbr") = r("ac_alt_ser_nbr")
          newRow.Item("ac_alt_ser_nbr_full") = r("ac_alt_ser_nbr_full")
          newRow.Item("ac_reg_nbr") = r("ac_reg_nbr")
          newRow.Item("ac_prev_reg_no") = r("ac_prev_reg_no")
          newRow.Item("ac_prev_reg_nbr") = r("ac_prev_reg_nbr")
          newRow.Item("ac_country_of_registration") = r("ac_country_of_registration")
          newRow.Item("ac_previously_owned_flag") = r("ac_previously_owned_flag")
          newRow.Item("ac_year_mfr") = r("ac_year_mfr")
          newRow.Item("ac_mfr_year") = r("ac_mfr_year")
          newRow.Item("ac_year_dlv") = r("ac_year_dlv")
          newRow.Item("ac_year") = r("ac_year")
          newRow.Item("ac_date_purchased") = r("ac_date_purchased")
          newRow.Item("ac_purchase_date") = r("ac_purchase_date")
          newRow.Item("ac_forsale_flag") = r("ac_forsale_flag")
          newRow.Item("ac_date_listed") = r("ac_date_listed")
          newRow.Item("ac_list_date") = r("ac_list_date")
          newRow.Item("ac_status") = r("ac_status")
          newRow.Item("take_price") = r("take_price")
          newRow.Item("ac_delivery") = r("ac_delivery")
          newRow.Item("ac_exclusive_flag") = r("ac_exclusive_flag")
          newRow.Item("ac_asking") = r("ac_asking")
          newRow.Item("ac_asking_wordage") = r("ac_asking_wordage")
          newRow.Item("ac_asking_price") = r("ac_asking_price")
          newRow.Item("ac_lease_flag") = r("ac_lease_flag")
          newRow.Item("ac_airframe_total_hours") = r("ac_airframe_total_hours")
          newRow.Item("ac_airframe_tot_hrs") = r("ac_airframe_tot_hrs")
          newRow.Item("ac_airframe_tot_landings") = r("ac_airframe_tot_landings")
          newRow.Item("ac_airframe_total_landings") = r("ac_airframe_total_landings")
          newRow.Item("ac_date_engine_times_as_of") = r("ac_date_engine_times_as_of")
          newRow.Item("ac_times_as_of_date") = r("ac_times_as_of_date")
          newRow.Item("ac_aport_iata_code") = r("ac_aport_iata_code")
          newRow.Item("ac_aport_icao_code") = r("ac_aport_icao_code")
          newRow.Item("ac_aport_name") = r("ac_aport_name")
          newRow.Item("ac_aport_state") = r("ac_aport_state")
          newRow.Item("ac_aport_country") = r("ac_aport_country")
          newRow.Item("ac_aport_city") = r("ac_aport_city")
          newRow.Item("ac_aport_private") = r("ac_aport_private")

          newRow.Item("custom_1") = r("custom_1")
          newRow.Item("custom_2") = r("custom_2")
          newRow.Item("custom_3") = r("custom_3")
          newRow.Item("custom_4") = r("custom_4")
          newRow.Item("custom_5") = r("custom_5")
          newRow.Item("custom_6") = r("custom_6")
          newRow.Item("custom_7") = r("custom_7")
          newRow.Item("custom_8") = r("custom_8")
          newRow.Item("custom_9") = r("custom_9")
          newRow.Item("custom_10") = r("custom_10")
          newRow.Item("ac_action_date") = r("ac_action_date")
          newRow.Item("ac_value_description") = r("ac_value_description")
          newRow.Item("amod_airframe_type_code") = jetnetTable.Rows(0).Item("amod_airframe_type_code")
          newRow.Item("amod_airframe_type") = jetnetTable.Rows(0).Item("amod_airframe_type")
          newRow.Item("amod_type_code") = jetnetTable.Rows(0).Item("amod_type_code")
          newRow.Item("amod_make_type") = jetnetTable.Rows(0).Item("amod_make_type")
          newRow.Item("amod_make_name") = jetnetTable.Rows(0).Item("amod_make_name")
          newRow.Item("amod_model_name") = jetnetTable.Rows(0).Item("amod_model_name")
          newRow.Item("amod_manufacturer_name") = jetnetTable.Rows(0).Item("amod_manufacturer_name")
          newRow.Item("ac_picture_exist_flag") = r("ac_picture_exist_flag")
          newRow.Item("ac_ser_nbr_sort") = r("ac_ser_nbr_sort")
          newRow.Item("ac_product_business_flag") = jetnetTable.Rows(0).Item("ac_product_business_flag")
          newRow.Item("ac_product_helicopter_flag") = jetnetTable.Rows(0).Item("ac_product_helicopter_flag")
          newRow.Item("ac_product_commercial_flag") = jetnetTable.Rows(0).Item("ac_product_commercial_flag")
          newRow.Item("CLIENT_ID") = r("CLIENT_ID")
          newRow.Item("ac_alt_ser_no_full") = r("ac_alt_ser_no_full")
          newRow.Item("ac_upd_date") = r("ac_upd_date")
          newRow.Item("ac_foreign_currency_name") = r("ac_foreign_currency_name")
          newRow.Item("ac_reg_no_expiration_date") = r("ac_reg_no_expiration_date")
          newRow.Item("ac_foreign_currency_price") = r("ac_foreign_currency_price")
          newRow.Item("amod_weight_class") = r("amod_weight_class")
          newRow.Item("ac_aport_faaid_code") = r("ac_aport_faaid_code")
          newRow.Item("ac_exclusive_expiration_flag") = r("ac_exclusive_expiration_flag")
          newRow.Item("ac_exclusive_date") = r("ac_exclusive_date")
          newRow.Item("amod_manufacturer_comp_id") = r("amod_manufacturer_comp_id")
          newRow.Item("certifications") = jetnetTable.Rows(0).Item("certifications")
          newRow.Item("ac_airframe_maintenance_program") = jetnetTable.Rows(0).Item("ac_airframe_maintenance_program")
          newRow.Item("ac_airframe_maintenance_tracking_program") = jetnetTable.Rows(0).Item("ac_airframe_maintenance_tracking_program")
          newRow.Item("ac_apu_model_name") = jetnetTable.Rows(0).Item("ac_apu_model_name")
          newRow.Item("ac_apu_ser_nbr") = jetnetTable.Rows(0).Item("ac_apu_ser_nbr")
          newRow.Item("ac_apu_ttsn_hours") = jetnetTable.Rows(0).Item("ac_apu_ttsn_hours")
          newRow.Item("ac_apu_tsoh_hours") = jetnetTable.Rows(0).Item("ac_apu_tsoh_hours")
          newRow.Item("ac_apu_tshi_hours") = jetnetTable.Rows(0).Item("ac_apu_tshi_hours")
          newRow.Item("ac_apu_ser_no") = jetnetTable.Rows(0).Item("ac_apu_ser_no")
          newRow.Item("ac_apu_tot_hrs") = jetnetTable.Rows(0).Item("ac_apu_tot_hrs")
          newRow.Item("ac_apu_soh_hrs") = jetnetTable.Rows(0).Item("ac_apu_soh_hrs")
          newRow.Item("ac_apu_shi_hrs") = jetnetTable.Rows(0).Item("ac_apu_shi_hrs")
          newRow.Item("ac_apu_maintance_program") = jetnetTable.Rows(0).Item("ac_apu_maintance_program")
          newRow.Item("ac_damage_flag") = jetnetTable.Rows(0).Item("ac_damage_flag")
          newRow.Item("ac_damage_history_notes") = jetnetTable.Rows(0).Item("ac_damage_history_notes")
          newRow.Item("ac_interior_rating") = jetnetTable.Rows(0).Item("ac_interior_rating")
          newRow.Item("ac_interior_month_year") = jetnetTable.Rows(0).Item("ac_interior_month_year")
          newRow.Item("ac_interior_moyear") = jetnetTable.Rows(0).Item("ac_interior_moyear")
          newRow.Item("ac_interior_doneby_name") = jetnetTable.Rows(0).Item("ac_interior_doneby_name")
          newRow.Item("ac_interior_config_name") = jetnetTable.Rows(0).Item("ac_interior_config_name")
          newRow.Item("ac_exterior_moyear") = jetnetTable.Rows(0).Item("ac_exterior_moyear")
          newRow.Item("ac_exterior_rating") = jetnetTable.Rows(0).Item("ac_exterior_rating")
          newRow.Item("ac_exterior_month_year") = jetnetTable.Rows(0).Item("ac_exterior_month_year")
          newRow.Item("ac_exterior_doneby_name") = jetnetTable.Rows(0).Item("ac_exterior_doneby_name")
          newRow.Item("ac_passenger_count") = jetnetTable.Rows(0).Item("ac_passenger_count")
          newRow.Item("ac_confidential_notes") = jetnetTable.Rows(0).Item("ac_confidential_notes")
          newRow.Item("ac_maintained") = jetnetTable.Rows(0).Item("ac_maintained")
          newRow.Item("ac_engine_name") = jetnetTable.Rows(0).Item("ac_engine_name")
          newRow.Item("ac_engine_tbo_oc_flag") = jetnetTable.Rows(0).Item("ac_engine_tbo_oc_flag")
          newRow.Item("ac_engine_noise_rating") = jetnetTable.Rows(0).Item("ac_engine_noise_rating")
          newRow.Item("ac_model_config") = jetnetTable.Rows(0).Item("ac_model_config")
          newRow.Item("ac_engine_maintenance_prog_EMP") = jetnetTable.Rows(0).Item("ac_engine_maintenance_prog_EMP")
          newRow.Item("ac_engine_management_prog_EMGP") = jetnetTable.Rows(0).Item("ac_engine_management_prog_EMGP")
          newRow.Item("ac_maint_hots_by_name") = jetnetTable.Rows(0).Item("ac_maint_hots_by_name")
          newRow.Item("ac_main_eoh_moyear") = jetnetTable.Rows(0).Item("ac_main_eoh_moyear")
          newRow.Item("ac_maint_eoh_by_name") = jetnetTable.Rows(0).Item("ac_maint_eoh_by_name")
          newRow.Item("ac_maint_hots_moyear") = jetnetTable.Rows(0).Item("ac_maint_hots_moyear")
          newRow.Item("ac_amod_id") = jetnetTable.Rows(0).Item("ac_amod_id")
          newRow.Item("jetnet_amod_id") = jetnetTable.Rows(0).Item("jetnet_amod_id")
          newRow.Item("ac_maint_hots_moyear") = jetnetTable.Rows(0).Item("ac_maint_hots_moyear")

          newRow.Item("ac_engine_1_ser_no") = jetnetTable.Rows(0).Item("ac_engine_1_ser_no")
          newRow.Item("ac_engine_2_ser_no") = jetnetTable.Rows(0).Item("ac_engine_2_ser_no")
          newRow.Item("ac_engine_3_ser_no") = jetnetTable.Rows(0).Item("ac_engine_3_ser_no")
          newRow.Item("ac_engine_4_ser_no") = jetnetTable.Rows(0).Item("ac_engine_4_ser_no")
          newRow.Item("ac_engine_1_tot_hrs") = jetnetTable.Rows(0).Item("ac_engine_1_tot_hrs")
          newRow.Item("ac_engine_2_tot_hrs") = jetnetTable.Rows(0).Item("ac_engine_2_tot_hrs")
          newRow.Item("ac_engine_3_tot_hrs") = jetnetTable.Rows(0).Item("ac_engine_3_tot_hrs")
          newRow.Item("ac_engine_4_tot_hrs") = jetnetTable.Rows(0).Item("ac_engine_4_tot_hrs")
          newRow.Item("ac_engine_1_soh_hrs") = jetnetTable.Rows(0).Item("ac_engine_1_soh_hrs")
          newRow.Item("ac_engine_2_soh_hrs") = jetnetTable.Rows(0).Item("ac_engine_2_soh_hrs")
          newRow.Item("ac_engine_3_soh_hrs") = jetnetTable.Rows(0).Item("ac_engine_3_soh_hrs")
          newRow.Item("ac_engine_4_soh_hrs") = jetnetTable.Rows(0).Item("ac_engine_4_soh_hrs")

          newRow.Item("ac_engine_1_shi_hrs") = jetnetTable.Rows(0).Item("ac_engine_1_shi_hrs")
          newRow.Item("ac_engine_2_shi_hrs") = jetnetTable.Rows(0).Item("ac_engine_2_shi_hrs")
          newRow.Item("ac_engine_3_shi_hrs") = jetnetTable.Rows(0).Item("ac_engine_3_shi_hrs")
          newRow.Item("ac_engine_4_shi_hrs") = jetnetTable.Rows(0).Item("ac_engine_4_shi_hrs")

          newRow.Item("ac_engine_1_tbo_hrs") = jetnetTable.Rows(0).Item("ac_engine_1_tbo_hrs")
          newRow.Item("ac_engine_2_tbo_hrs") = jetnetTable.Rows(0).Item("ac_engine_2_tbo_hrs")
          newRow.Item("ac_engine_3_tbo_hrs") = jetnetTable.Rows(0).Item("ac_engine_3_tbo_hrs")
          newRow.Item("ac_engine_4_tbo_hrs") = jetnetTable.Rows(0).Item("ac_engine_4_tbo_hrs")

          newRow.Item("ac_engine_1_snew_cycles") = jetnetTable.Rows(0).Item("ac_engine_1_snew_cycles")
          newRow.Item("ac_engine_2_snew_cycles") = jetnetTable.Rows(0).Item("ac_engine_2_snew_cycles")
          newRow.Item("ac_engine_3_snew_cycles") = jetnetTable.Rows(0).Item("ac_engine_3_snew_cycles")
          newRow.Item("ac_engine_4_snew_cycles") = jetnetTable.Rows(0).Item("ac_engine_4_snew_cycles")

          newRow.Item("ac_engine_1_soh_cycles") = jetnetTable.Rows(0).Item("ac_engine_1_soh_cycles")
          newRow.Item("ac_engine_2_soh_cycles") = jetnetTable.Rows(0).Item("ac_engine_2_soh_cycles")
          newRow.Item("ac_engine_3_soh_cycles") = jetnetTable.Rows(0).Item("ac_engine_3_soh_cycles")
          newRow.Item("ac_engine_4_soh_cycles") = jetnetTable.Rows(0).Item("ac_engine_4_soh_cycles")

          newRow.Item("ac_engine_1_shs_cycles") = jetnetTable.Rows(0).Item("ac_engine_1_shs_cycles")
          newRow.Item("ac_engine_2_shs_cycles") = jetnetTable.Rows(0).Item("ac_engine_2_shs_cycles")
          newRow.Item("ac_engine_3_shs_cycles") = jetnetTable.Rows(0).Item("ac_engine_3_shs_cycles")
          newRow.Item("ac_engine_4_shs_cycles") = jetnetTable.Rows(0).Item("ac_engine_4_shs_cycles")

          newRow.Item("ac_prop_1_ser_no") = jetnetTable.Rows(0).Item("ac_prop_1_ser_no")
          newRow.Item("ac_prop_2_ser_no") = jetnetTable.Rows(0).Item("ac_prop_2_ser_no")
          newRow.Item("ac_prop_3_ser_no") = jetnetTable.Rows(0).Item("ac_prop_3_ser_no")
          newRow.Item("ac_prop_4_ser_no") = jetnetTable.Rows(0).Item("ac_prop_4_ser_no")

          newRow.Item("ac_prop_1_snew_hrs") = jetnetTable.Rows(0).Item("ac_prop_1_snew_hrs")
          newRow.Item("ac_prop_2_snew_hrs") = jetnetTable.Rows(0).Item("ac_prop_2_snew_hrs")
          newRow.Item("ac_prop_3_snew_hrs") = jetnetTable.Rows(0).Item("ac_prop_3_snew_hrs")
          newRow.Item("ac_prop_4_snew_hrs") = jetnetTable.Rows(0).Item("ac_prop_4_snew_hrs")

          newRow.Item("ac_prop_1_soh_hrs") = jetnetTable.Rows(0).Item("ac_prop_1_soh_hrs")
          newRow.Item("ac_prop_2_soh_hrs") = jetnetTable.Rows(0).Item("ac_prop_2_soh_hrs")
          newRow.Item("ac_prop_3_soh_hrs") = jetnetTable.Rows(0).Item("ac_prop_3_soh_hrs")
          newRow.Item("ac_prop_4_soh_hrs") = jetnetTable.Rows(0).Item("ac_prop_4_soh_hrs")

          newRow.Item("ac_prop_1_soh_moyear") = jetnetTable.Rows(0).Item("ac_prop_1_soh_moyear")
          newRow.Item("ac_prop_2_soh_moyear") = jetnetTable.Rows(0).Item("ac_prop_2_soh_moyear")
          newRow.Item("ac_prop_3_soh_moyear") = jetnetTable.Rows(0).Item("ac_prop_3_soh_moyear")
          newRow.Item("ac_prop_4_soh_moyear") = jetnetTable.Rows(0).Item("ac_prop_4_soh_moyear")



          newRow.Item("amp_provider_name") = jetnetTable.Rows(0).Item("amp_provider_name")
          newRow.Item("amp_program_name") = jetnetTable.Rows(0).Item("amp_program_name")
          newRow.Item("amtp_provider_name") = jetnetTable.Rows(0).Item("amtp_provider_name")
          newRow.Item("amtp_program_name") = jetnetTable.Rows(0).Item("amtp_program_name")
          newRow.Item("emp_program_name") = jetnetTable.Rows(0).Item("emp_program_name")

          newRow.Item("emp_provider_name") = jetnetTable.Rows(0).Item("emp_provider_name")
          newRow.Item("emgp_provider_name") = jetnetTable.Rows(0).Item("emgp_provider_name")
          newRow.Item("emgp_provider_name") = jetnetTable.Rows(0).Item("emgp_provider_name")
          newRow.Item("emgp_program_name") = jetnetTable.Rows(0).Item("emgp_program_name")
          newRow.Item("ac_est_airframe_hrs") = jetnetTable.Rows(0).Item("ac_est_airframe_hrs")

          clientTable.Rows.Add(newRow)
          clientTable.AcceptChanges()
        Next
      End If

      Return clientTable
    Catch ex As Exception
      CreateClientWithJetnet = Nothing
      Me.class_error = "Error in CreateClientWithJetnet(ByVal clientTable As DataTable, ByVal jetnetTable As DataTable) As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
    End Try

  End Function
  Public Function Get_Client_Aircraft_as_Jetnet_Fields_By_JetnetID(ByVal aircraftID As Long) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim ReturnTable As New DataTable

    Try
      sql = "SELECT client_aircraft.cliaircraft_jetnet_ac_id as ac_id, '' as certifications,cliaircraft_broker_price as broker_price, "
      sql += " client_aircraft.cliaircraft_cliamod_id as ac_amod_id, "
      sql += " client_aircraft_model.cliamod_jetnet_amod_id as jetnet_amod_id,  client_aircraft.cliaircraft_reg_nbr as ac_reg_no, "
      sql += " 0 as ac_journ_id, client_aircraft.cliaircraft_reg_nbr as ac_reg_no_search, "
      sql += "client_aircraft.cliaircraft_delivery as ac_delivery_date, "
      sql += " client_aircraft.cliaircraft_lifecycle as ac_lifecycle,  client_aircraft.cliaircraft_lifecycle as ac_lifecycle_stage, "
      sql += "client_aircraft.cliaircraft_ownership as ac_ownership, client_aircraft.cliaircraft_ownership as ac_ownership_type, "
      sql += " client_aircraft.cliaircraft_usage as ac_usage, "
      sql += " client_aircraft.cliaircraft_ser_nbr as ac_ser_nbr, "
      sql += " client_aircraft.cliaircraft_alt_ser_nbr as ac_alt_ser_nbr, "
      sql += " client_aircraft.cliaircraft_alt_ser_nbr as ac_alt_ser_nbr_full, "
      sql += " client_aircraft.cliaircraft_reg_nbr as ac_reg_nbr, client_aircraft.cliaircraft_prev_reg_nbr as ac_prev_reg_no, "
      sql += " client_aircraft.cliaircraft_prev_reg_nbr as ac_prev_reg_nbr, "
      sql += " client_aircraft.cliaircraft_country_of_registration as ac_country_of_registration, "
      sql += " (select case when cliaircraft_new_flag='Y' then 'N' else 'Y' end) as ac_previously_owned_flag,"
      sql += " client_aircraft.cliaircraft_year_mfr as ac_year_mfr,  client_aircraft.cliaircraft_year_mfr as ac_mfr_year,  "
      sql += " client_aircraft.cliaircraft_year_dlv as ac_year_dlv,client_aircraft.cliaircraft_year_dlv as ac_year, "
      sql += " client_aircraft.cliaircraft_date_purchased as ac_date_purchased, client_aircraft.cliaircraft_date_purchased as ac_purchase_date, "
      sql += " client_aircraft.cliaircraft_forsale_flag as ac_forsale_flag, "
      sql += " client_aircraft.cliaircraft_date_listed as ac_date_listed, client_aircraft.cliaircraft_date_listed as ac_list_date,"
      sql += " client_aircraft.cliaircraft_status as ac_status, "
      sql += " client_aircraft.cliaircraft_est_price as take_price, "
      sql += " client_aircraft.cliaircraft_delivery as ac_delivery, "
      sql += " client_aircraft.cliaircraft_exclusive_flag as ac_exclusive_flag, client_aircraft.cliaircraft_asking_wordage as ac_asking, "
      sql += " client_aircraft.cliaircraft_asking_wordage as ac_asking_wordage,"
      sql += " client_aircraft.cliaircraft_asking_price as ac_asking_price, "
      sql += " client_aircraft.cliaircraft_lease_flag as ac_lease_flag, "
      sql += " client_aircraft.cliaircraft_airframe_maintenance_program as ac_airframe_maintenance_program, "
      sql += " client_aircraft.cliaircraft_airframe_maintenance_tracking_program as ac_airframe_maintenance_tracking_program, "
      sql += " client_aircraft.cliaircraft_airframe_total_hours as ac_airframe_total_hours, client_aircraft.cliaircraft_airframe_total_hours as ac_airframe_tot_hrs, client_aircraft.cliaircraft_airframe_total_landings as ac_airframe_tot_landings,"
      sql += " client_aircraft.cliaircraft_airframe_total_landings as ac_airframe_total_landings, "
      sql += " client_aircraft.cliaircraft_date_engine_times_as_of as  ac_date_engine_times_as_of, client_aircraft.cliaircraft_date_engine_times_as_of as ac_times_as_of_date, "
      sql += " client_aircraft.cliaircraft_aport_iata_code as ac_aport_iata_code, "
      sql += " client_aircraft.cliaircraft_aport_icao_code as ac_aport_icao_code, "
      sql += " client_aircraft.cliaircraft_aport_name as ac_aport_name,  "
      sql += " client_aircraft.cliaircraft_aport_state as ac_aport_state, "
      sql += " client_aircraft.cliaircraft_aport_country as ac_aport_country, "
      sql += " client_aircraft.cliaircraft_aport_city as ac_aport_city, "
      sql += " client_aircraft.cliaircraft_aport_private as ac_aport_private, "
      sql += " client_aircraft.cliaircraft_apu_model_name as ac_apu_model_name, "
      sql += " client_aircraft.cliaircraft_apu_ser_nbr as ac_apu_ser_nbr, "
      sql += " client_aircraft.cliaircraft_apu_ttsn_hours as ac_apu_ttsn_hours, "
      sql += " client_aircraft.cliaircraft_apu_tsoh_hours as ac_apu_tsoh_hours, "
      sql += " client_aircraft.cliaircraft_apu_tshi_hours as ac_apu_tshi_hours, "

      sql += " client_aircraft.cliaircraft_custom_1 as custom_1, "
      sql += " client_aircraft.cliaircraft_custom_2 as custom_2, "
      sql += " client_aircraft.cliaircraft_custom_3 as custom_3, "
      sql += " client_aircraft.cliaircraft_custom_4 as custom_4, "
      sql += " client_aircraft.cliaircraft_custom_5 as custom_5, "
      sql += " client_aircraft.cliaircraft_custom_6 as custom_6, "
      sql += " client_aircraft.cliaircraft_custom_7 as custom_7, "
      sql += " client_aircraft.cliaircraft_custom_8 as custom_8, "
      sql += " client_aircraft.cliaircraft_custom_9 as custom_9, "
      sql += " client_aircraft.cliaircraft_custom_10 as custom_10, "



      sql += " client_aircraft.cliaircraft_apu_ser_nbr as ac_apu_ser_no, "
      sql += " client_aircraft.cliaircraft_apu_ttsn_hours as ac_apu_tot_hrs, "
      sql += " client_aircraft.cliaircraft_apu_tsoh_hours as ac_apu_soh_hrs, "
      sql += " client_aircraft.cliaircraft_apu_tshi_hours as ac_apu_shi_hrs, "

      sql += " client_aircraft.cliaircraft_apu_maintance_program as ac_apu_maintance_program, "
      sql += " client_aircraft.cliaircraft_damage_flag as ac_damage_flag, "
      sql += " client_aircraft.cliaircraft_damage_history_notes as ac_damage_history_notes, "
      sql += " client_aircraft.cliaircraft_interior_rating as ac_interior_rating, "
      sql += " client_aircraft.cliaircraft_interior_month_year as ac_interior_month_year, client_aircraft.cliaircraft_interior_month_year as ac_interior_moyear, "
      sql += " client_aircraft.cliaircraft_interior_doneby_name as ac_interior_doneby_name, "
      sql += " client_aircraft.cliaircraft_interior_config_name as ac_interior_config_name, client_aircraft.cliaircraft_exterior_month_year as ac_exterior_moyear, "
      sql += " client_aircraft.cliaircraft_exterior_rating as ac_exterior_rating, "
      sql += " client_aircraft.cliaircraft_exterior_month_year as ac_exterior_month_year, "
      sql += " client_aircraft.cliaircraft_exterior_doneby_name as ac_exterior_doneby_name, "
      sql += " client_aircraft.cliaircraft_passenger_count as ac_passenger_count, "
      sql += " client_aircraft.cliaircraft_confidential_notes as ac_confidential_notes, "
      sql += " client_aircraft.cliaircraft_action_date as ac_action_date ,"
      sql += " client_aircraft.cliaircraft_value_description AS ac_value_description , client_aircraft_model.cliamod_airframe_type as amod_airframe_type_code, "
      sql += " client_aircraft_model.cliamod_airframe_type as amod_airframe_type, client_aircraft_model.cliamod_airframe_type as amod_type_code,"
      sql += " client_aircraft_model.cliamod_make_type as amod_make_type, "
      sql += " client_aircraft_model.cliamod_make_name as amod_make_name, "
      sql += " client_aircraft_model.cliamod_model_name as amod_model_name, "
      sql += " client_aircraft_model.cliamod_manufacturer_name as amod_manufacturer_name, "
      sql += " client_aircraft.cliaircraft_ac_maintained as ac_maintained, "
      sql += " 'N' as ac_picture_exist_flag, "
      sql += " client_aircraft.cliaircraft_ser_nbr_sort as ac_ser_nbr_sort, "
      sql += " client_aircraft_engine.cliacep_engine_name as ac_engine_name, "
      sql += " client_aircraft_engine.cliacep_engine_tbo_oc_flag as ac_engine_tbo_oc_flag, "
      sql += " client_aircraft_engine.cliacep_engine_noise_rating as ac_engine_noise_rating, "
      sql += " client_aircraft_engine.cliacep_engine_model_config as ac_model_config, "
      sql += " client_aircraft_engine.cliacep_engine_maintenance_program as ac_engine_maintenance_prog_EMP, "
      sql += " client_aircraft_engine.cliacep_engine_management_program as ac_engine_management_prog_EMGP, "
      sql += " client_aircraft_engine.cliacep_engine_hot_inspection_done_by_name as ac_maint_hots_by_name, "
      sql += " client_aircraft_engine.cliacep_engine_overhaul_done_month_year as ac_main_eoh_moyear,"
      sql += " client_aircraft_engine.cliacep_engine_overhaul_done_by_name as ac_maint_eoh_by_name,"
      sql += " client_aircraft_engine.cliacep_engine_hot_inspection_done_month_year as ac_maint_hots_moyear, "
      sql += " client_aircraft_engine.cliacep_engine_1_ser_nbr as ac_engine_1_ser_no,"
      sql += " client_aircraft_engine.cliacep_engine_2_ser_nbr as ac_engine_2_ser_no,"
      sql += " client_aircraft_engine.cliacep_engine_3_ser_nbr as ac_engine_3_ser_no,"
      sql += " client_aircraft_engine.cliacep_engine_4_ser_nbr as ac_engine_4_ser_no,"
      sql += " client_aircraft_engine.cliacep_engine_1_ttsn_hours as ac_engine_1_tot_hrs,"
      sql += " client_aircraft_engine.cliacep_engine_2_ttsn_hours as ac_engine_2_tot_hrs,"
      sql += " client_aircraft_engine.cliacep_engine_3_ttsn_hours as ac_engine_3_tot_hrs,"
      sql += " client_aircraft_engine.cliacep_engine_4_ttsn_hours as ac_engine_4_tot_hrs,"
      sql += " client_aircraft_engine.cliacep_engine_1_tsoh_hours as ac_engine_1_soh_hrs,"
      sql += " client_aircraft_engine.cliacep_engine_2_tsoh_hours as ac_engine_2_soh_hrs,"
      sql += " client_aircraft_engine.cliacep_engine_3_tsoh_hours as ac_engine_3_soh_hrs,"
      sql += " client_aircraft_engine.cliacep_engine_4_tsoh_hours as ac_engine_4_soh_hrs,"
      sql += " client_aircraft_engine.cliacep_engine_1_tshi_hours as ac_engine_1_shi_hrs,"
      sql += " client_aircraft_engine.cliacep_engine_2_tshi_hours as ac_engine_2_shi_hrs,"
      sql += " client_aircraft_engine.cliacep_engine_3_tshi_hours as ac_engine_3_shi_hrs,"
      sql += " client_aircraft_engine.cliacep_engine_4_tshi_hours as ac_engine_4_shi_hrs,"
      sql += " client_aircraft_engine.cliacep_engine_1_tbo_hours as ac_engine_1_tbo_hrs,"
      sql += " client_aircraft_engine.cliacep_engine_2_tbo_hours as ac_engine_2_tbo_hrs,"
      sql += " client_aircraft_engine.cliacep_engine_3_tbo_hours as ac_engine_3_tbo_hrs,"
      sql += " client_aircraft_engine.cliacep_engine_4_tbo_hours as ac_engine_4_tbo_hrs,"
      sql += " client_aircraft_engine.cliacep_engine_1_tsn_cycle as ac_engine_1_snew_cycles,"
      sql += " client_aircraft_engine.cliacep_engine_2_tsn_cycle as ac_engine_2_snew_cycles,"
      sql += " client_aircraft_engine.cliacep_engine_3_tsn_cycle as ac_engine_3_snew_cycles,"
      sql += " client_aircraft_engine.cliacep_engine_4_tsn_cycle as ac_engine_4_snew_cycles,"
      sql += " client_aircraft_engine.cliacep_engine_1_tsoh_cycle as ac_engine_1_soh_cycles,"
      sql += " client_aircraft_engine.cliacep_engine_2_tsoh_cycle as ac_engine_2_soh_cycles,"
      sql += " client_aircraft_engine.cliacep_engine_3_tsoh_cycle as ac_engine_3_soh_cycles,"
      sql += " client_aircraft_engine.cliacep_engine_4_tsoh_cycle as ac_engine_4_soh_cycles,"
      sql += " client_aircraft_engine.cliacep_engine_1_tshi_cycle as ac_engine_1_shs_cycles,"
      sql += " client_aircraft_engine.cliacep_engine_2_tshi_cycle as ac_engine_2_shs_cycles,"
      sql += " client_aircraft_engine.cliacep_engine_3_tshi_cycle as ac_engine_3_shs_cycles,"
      sql += " client_aircraft_engine.cliacep_engine_4_tshi_cycle as ac_engine_4_shs_cycles,"
      sql += " client_aircraft_propeller.cliacpr_prop_1_ser_nbr as ac_prop_1_ser_no,"
      sql += " client_aircraft_propeller.cliacpr_prop_2_ser_nbr as ac_prop_2_ser_no,"
      sql += " client_aircraft_propeller.cliacpr_prop_3_ser_nbr as ac_prop_3_ser_no,"
      sql += " client_aircraft_propeller.cliacpr_prop_4_ser_nbr as ac_prop_4_ser_no,"
      sql += " client_aircraft_propeller.cliacpr_prop_1_ttsn_hours as ac_prop_1_snew_hrs,"
      sql += " client_aircraft_propeller.cliacpr_prop_2_ttsn_hours as ac_prop_2_snew_hrs,"
      sql += " client_aircraft_propeller.cliacpr_prop_3_ttsn_hours as ac_prop_3_snew_hrs,"
      sql += " client_aircraft_propeller.cliacpr_prop_4_ttsn_hours as ac_prop_4_snew_hrs,"
      sql += " client_aircraft_propeller.cliacpr_prop_1_tsoh_hours as ac_prop_1_soh_hrs,"
      sql += " client_aircraft_propeller.cliacpr_prop_2_tsoh_hours as ac_prop_2_soh_hrs,"
      sql += " client_aircraft_propeller.cliacpr_prop_3_tsoh_hours as ac_prop_3_soh_hrs,"
      sql += " client_aircraft_propeller.cliacpr_prop_4_tsoh_hours as ac_prop_4_soh_hrs,"
      sql += " client_aircraft_propeller.cliacpr_prop_1_month_year_oh as ac_prop_1_soh_moyear,"
      sql += " client_aircraft_propeller.cliacpr_prop_2_month_year_oh as ac_prop_2_soh_moyear,"
      sql += " client_aircraft_propeller.cliacpr_prop_3_month_year_oh as ac_prop_3_soh_moyear,"
      sql += " client_aircraft_propeller.cliacpr_prop_4_month_year_oh as ac_prop_4_soh_moyear,"
      sql += " client_aircraft.cliaircraft_product_business_flag ac_product_business_flag, "
      sql += " client_aircraft.cliaircraft_product_helicopter_flag ac_product_helicopter_flag, "
      sql += " client_aircraft.cliaircraft_product_commercial_flag ac_product_commercial_flag, "
      sql += " client_aircraft.cliaircraft_id as CLIENT_ID, "
      sql += " airframe_maintenance_program.amp_provider_name, "
      sql += " airframe_maintenance_program.amp_program_name, "
      sql += " airframe_maintenance_tracking_program.amtp_provider_name, "
      sql += " airframe_maintenance_tracking_program.amtp_program_name, "
      sql += " engine_maintenance_program.emp_program_name, "
      sql += " engine_maintenance_program.emp_provider_name, "

      sql += " engine_management_program.emgp_provider_name, "
      sql += " engine_management_program.emgp_program_name, "

      'Fields unsure of
      sql += " NULL as ac_alt_ser_no_full, "
      sql += " NULL as ac_upd_date, "
      sql += " '' as ac_foreign_currency_name, "
      sql += " NULL as ac_reg_no_expiration_date, "
      sql += " NULL as ac_foreign_currency_price, "
      'sql += " NULL as amod_number_of_engines, "
      sql += " NULL as amod_weight_class, "
      sql += " NULL as ac_aport_faaid_code, "
      sql += " NULL as ac_exclusive_expiration_flag, "
      sql += " NULL as ac_exclusive_date, "
      sql += " NULL as amod_manufacturer_comp_id "

      sql += " FROM client_aircraft "
      'This join should be inner
      sql += " INNER JOIN client_aircraft_model ON client_aircraft.cliaircraft_cliamod_id = client_aircraft_model.cliamod_id"
      'Left Outer:
      sql += " LEFT OUTER JOIN client_aircraft_engine ON client_aircraft.cliaircraft_id = client_aircraft_engine.cliacep_cliac_id"
      'Left Outer:
      sql += " LEFT OUTER JOIN client_aircraft_propeller ON client_aircraft.cliaircraft_id = client_aircraft_propeller.cliacpr_cliac_id"
      'Left Outer:
      sql += " LEFT OUTER JOIN airframe_maintenance_program ON client_aircraft.cliaircraft_airframe_maintenance_program = airframe_maintenance_program.amp_id "
      'Left Outer:
      sql += " LEFT OUTER JOIN airframe_maintenance_tracking_program ON client_aircraft.cliaircraft_airframe_maintenance_tracking_program = airframe_maintenance_tracking_program.amtp_id "
      'Left Outer:
      sql += " LEFT OUTER JOIN engine_maintenance_program ON client_aircraft_engine.cliacep_engine_maintenance_program = engine_maintenance_program.emp_id "
      'Left Outer:
      sql += " LEFT OUTER JOIN engine_management_program ON client_aircraft_engine.cliacep_engine_management_program = engine_management_program.emgp_id "

      sql += " WHERE  (client_aircraft.cliaircraft_jetnet_ac_id  = @AircraftID)"

      MySqlConn.ConnectionString = client_DB
      MySqlConn.Open()

      Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand(sql, MySqlConn)

      MySqlCommand.Parameters.AddWithValue("AircraftID", aircraftID)


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Public Function Get_Client_Aircraft_as_Jetnet_Fields_By_JetnetID(ByVal aircraftID As Long) As DataTable</b><br />" & sql


      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        ReturnTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = ReturnTable.GetErrors()
      End Try

      MySqlCommand.Dispose()
      MySqlCommand = Nothing


      Return ReturnTable
    Catch ex As Exception
      Get_Client_Aircraft_as_Jetnet_Fields_By_JetnetID = Nothing
      Me.class_error = "Error in Public Function Get_Client_Aircraft_as_Jetnet_Fields_By_JetnetID(ByVal aircraftID As Long) As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
    End Try

  End Function

  ''' <summary>
  ''' This is the helper query for the Evolution Aircraft Listing Page Query
  ''' </summary>
  ''' <param name="ac_id">AC ID</param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function CRMAircraftListingRelatedCompanies(ByVal ac_id As Long, ByVal aerodex As Boolean, ByVal ApplicableRelationships As String, ByVal AdvancedOperator As Boolean, ByVal CompanyCountriesString As String, ByVal CompanyTimeZoneString As String, ByVal CompanyContinentString As String, ByVal CompanyRegionString As String, ByVal CompanyStateName As String) As DataTable



    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim atemptable As New DataTable
    Dim count As Integer = 1
    Dim sqlWhere As String = ""


    atemptable.Columns.Add("cref_transmit_seq_no")
    atemptable.Columns.Add("cref_contact_type")
    atemptable.Columns.Add("actype_name")
    atemptable.Columns.Add("comp_name")
    atemptable.Columns.Add("comp_address1")
    atemptable.Columns.Add("comp_address2")
    atemptable.Columns.Add("comp_city")
    atemptable.Columns.Add("comp_state")
    atemptable.Columns.Add("comp_country")
    atemptable.Columns.Add("comp_phone_office")
    atemptable.Columns.Add("comp_phone_fax")
    atemptable.Columns.Add("comp_email_address")
    atemptable.Columns.Add("comp_web_address")
    atemptable.Columns.Add("acref_comp_id")
    atemptable.Columns.Add("cref_owner_percent")
    atemptable.Columns.Add("comp_name_alt")
    atemptable.Columns.Add("comp_name_alt_type")

    Try
      If ac_id <> 0 Then
        'client_aircraft_contact_type
        'client_aircraft_reference
        'client_company
        sql = ""
        sql = "SELECT 0 as cref_transmit_seq_no, cliacref_contact_type as cref_contact_type, cliact_name as actype_name, clicomp_name as comp_name, clicomp_alternate_name as comp_name_alt, clicomp_alternate_name_type as comp_name_alt_type, "
        sql += " clicomp_address1 as comp_address1, clicomp_address2 as comp_address2, clicomp_city as comp_city, clicomp_state as comp_state, clicomp_country as comp_country, '' as comp_phone_office,  "
        sql += "  '' as comp_phone_fax, clicomp_email_address as comp_email_address, clicomp_web_address as comp_web_address, clicomp_id as comp_id, cliacref_owner_percentage as cref_owner_percent "
        sql += " FROM client_aircraft_reference inner join client_company on cliacref_comp_id = clicomp_id "
        sql += " left outer join client_aircraft_contact_type on cliacref_contact_type = cliact_type "
        sql += " WHERE "

        'Edited on 10/16/2014 
        'Added regional information to this query to filter the companies based on what was selected for the aircraft search.
        sqlWhere = " cliacref_cliac_id  = " & ac_id & " "

        'If CompanyTimeZoneString <> "" Then
        '  If sqlWhere <> "" Then
        '    sqlWhere += " and "
        '  End If

        '  sqlWhere += " comp_timezone in (SELECT tzone_name FROM Timezone where tzone_id in (" & CompanyTimeZoneString & ")) "
        'End If

        ''Continent
        'If CompanyContinentString <> "" Then
        '  If sqlWhere <> "" Then
        '    sqlWhere += " AND"
        '  End If
        '  sqlWhere += " country_continent_name in (" & CompanyContinentString & ") "
        'End If

        ' check the state
        If CompanyStateName <> "" Then
          If sqlWhere <> "" Then
            sqlWhere += " AND "
          End If
          sqlWhere += " clicomp_state IN (" & CompanyStateName & ")"
        End If


        ' check the country
        If CompanyCountriesString <> "" Then
          If sqlWhere <> "" Then
            sqlWhere += " AND "
          End If
          sqlWhere += " clicomp_country in (" & CompanyCountriesString & ") "
        End If

        'If Not IsNothing(HttpContext.Current.Session.Item("Frac_Percent")) Then
        '  If Trim(HttpContext.Current.Session.Item("Frac_Percent")) <> "" Then
        '    If sqlWhere <> "" Then
        '      sqlWhere &= " AND "
        '    End If
        '    sqlWhere &= HttpContext.Current.Session.Item("Frac_Percent")
        '  End If
        'End If


        ''regions
        'If CompanyRegionString <> "" Then
        '  If sqlWhere <> "" Then
        '    sqlWhere += " AND "
        '  End If
        '  sqlWhere += " comp_country in (select distinct geographic_country_name FROM geographic with (NOLOCK) where geographic_region_name in (" & CompanyRegionString & ")) "

        '  If CompanyStateName <> "" Then
        '    sqlWhere += " and state_name in (select distinct state_name FROM geographic with (NOLOCK) inner join State with (NOLOCK) on state_code=geographic_state_code and state_country=geographic_country_name where geographic_region_name in (" & CompanyRegionString & ")) "
        '  End If
        'End If

        '-- EXCLUDES RESEARCH ONLY AND CHIEF PILOT COMPANIES/REFERENCES
        'If you're searching for a relationship of Chief Pilot, then we go ahead and 
        'remove the exclusion on it. Otherwise - it's excluded just like normal.

        If InStr(ApplicableRelationships, "'44'") = 0 Then
          If aerodex Then
            sqlWhere += " and cliacref_contact_type NOT IN ('93','98','99','71','44', '38') "
          Else
            sqlWhere += " AND cliacref_contact_type NOT IN ('71','44') "
          End If
        Else
          If aerodex Then
            sqlWhere += " and cliacref_contact_type NOT IN ('93','98','99','71', '38') "
          Else
            sqlWhere += " AND cliacref_contact_type NOT IN ('71') "
          End If
        End If


        If ApplicableRelationships <> "" Then
          sqlWhere += " and cliacref_contact_type in (" & ApplicableRelationships & ")"
          'If AdvancedOperator = False Then
          '  sqlWhere += " ) "
          'End If
        End If

        'If AdvancedOperator = True Then
        '  If ApplicableRelationships <> "" Then
        '    sqlWhere += " or "
        '  Else
        '    sqlWhere += " and "
        '  End If

        '  sqlWhere += " cref_operator_flag IN ('Y', 'O') " & " "

        '  If ApplicableRelationships <> "" Then
        '    sqlWhere += " ) "
        '  End If
        'End If

        '-- PART BELOW ADDED BASED ON PRODUCTS USER CAN SEE
        'sqlWhere += " AND (comp_product_helicopter_flag = 'Y' OR comp_product_business_flag = 'Y' "
        'sqlWhere += " OR comp_product_commercial_flag = 'Y') "

        sql += sqlWhere
        sql += " ORDER BY clicomp_name"


        MySqlConn.ConnectionString = client_DB
        MySqlConn.Open()

        Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand(sql, MySqlConn)



        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>CRMAircraftListingRelatedCompanies(ByVal ac_id As Long, ByVal aerodex As Boolean, ByVal ApplicableRelationships As String, ByVal AdvancedOperator As Boolean, ByVal CompanyCountriesString As String, ByVal CompanyTimeZoneString As String, ByVal CompanyContinentString As String, ByVal CompanyRegionString As String, ByVal CompanyStateName As String) As DataTable</b><br />" & sql


        MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)



        While MySqlReader.Read()
          Dim newCustomersRow As DataRow = atemptable.NewRow()
          newCustomersRow("cref_transmit_seq_no") = MySqlReader.Item("cref_transmit_seq_no")
          newCustomersRow("cref_contact_type") = MySqlReader.Item("cref_contact_type")
          newCustomersRow("actype_name") = MySqlReader.Item("actype_name")
          newCustomersRow("comp_name") = MySqlReader.Item("comp_name")
          newCustomersRow("comp_address1") = MySqlReader.Item("comp_address1")
          newCustomersRow("comp_address2") = MySqlReader.Item("comp_address2")
          newCustomersRow("comp_city") = MySqlReader.Item("comp_city")
          newCustomersRow("comp_state") = MySqlReader.Item("comp_state")
          newCustomersRow("comp_country") = MySqlReader.Item("comp_country")
          newCustomersRow("comp_phone_office") = MySqlReader.Item("comp_phone_office")
          newCustomersRow("comp_phone_fax") = MySqlReader.Item("comp_phone_fax")
          newCustomersRow("comp_email_address") = MySqlReader.Item("comp_email_address")
          newCustomersRow("comp_web_address") = MySqlReader.Item("comp_web_address")
          newCustomersRow("acref_comp_id") = MySqlReader.Item("comp_id")
          newCustomersRow("cref_owner_percent") = MySqlReader.Item("cref_owner_percent")
          newCustomersRow("comp_name_alt") = MySqlReader.Item("comp_name_alt")
          newCustomersRow("comp_name_alt_type") = MySqlReader.Item("comp_name_alt_type")

          atemptable.Rows.Add(newCustomersRow)
          atemptable.AcceptChanges()
          count += 1
        End While


        MySqlCommand.Dispose()
        MySqlCommand = Nothing
      End If
    Catch ex As Exception

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "CRMAircraftListingRelatedCompanies(ByVal ac_id As Long, ByVal aerodex As Boolean, ByVal ApplicableRelationships As String, ByVal AdvancedOperator As Boolean, ByVal CompanyCountriesString As String, ByVal CompanyTimeZoneString As String, ByVal CompanyContinentString As String, ByVal CompanyRegionString As String, ByVal CompanyStateName As String) As DataTable " + ex.Message.ToString.Trim
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

    Finally


    End Try

    Return atemptable
    atemptable = Nothing

  End Function

  Public Function Get_Client_Aircraft_as_Jetnet_Fields(ByVal aircraftID As Long) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim ReturnTable As New DataTable

    Try
      sql = "SELECT client_aircraft.cliaircraft_jetnet_ac_id as ac_id, '' as certifications,cliaircraft_broker_price as broker_price, "
      sql += " client_aircraft.cliaircraft_cliamod_id as ac_amod_id, "
      sql += " client_aircraft_model.cliamod_jetnet_amod_id as jetnet_amod_id,  client_aircraft.cliaircraft_reg_nbr as ac_reg_no, "
      sql += " 0 as ac_journ_id, client_aircraft.cliaircraft_reg_nbr as ac_reg_no_search, "
      sql += "client_aircraft.cliaircraft_delivery as ac_delivery_date, "
      sql += " client_aircraft.cliaircraft_lifecycle as ac_lifecycle,  client_aircraft.cliaircraft_lifecycle as ac_lifecycle_stage, "
      sql += "client_aircraft.cliaircraft_ownership as ac_ownership, client_aircraft.cliaircraft_ownership as ac_ownership_type, "
      sql += " client_aircraft.cliaircraft_usage as ac_usage, "
      sql += " client_aircraft.cliaircraft_ser_nbr as ac_ser_nbr, "
      sql += " client_aircraft.cliaircraft_alt_ser_nbr as ac_alt_ser_nbr, "
      sql += " client_aircraft.cliaircraft_alt_ser_nbr as ac_alt_ser_nbr_full, "
      sql += " client_aircraft.cliaircraft_reg_nbr as ac_reg_nbr, client_aircraft.cliaircraft_prev_reg_nbr as ac_prev_reg_no, "
      sql += " client_aircraft.cliaircraft_prev_reg_nbr as ac_prev_reg_nbr, "
      sql += " client_aircraft.cliaircraft_country_of_registration as ac_country_of_registration, "
      sql += " (select case when cliaircraft_new_flag='Y' then 'N' else 'Y' end) as ac_previously_owned_flag,"
      sql += " client_aircraft.cliaircraft_year_mfr as ac_year_mfr,  client_aircraft.cliaircraft_year_mfr as ac_mfr_year,  "
      sql += " client_aircraft.cliaircraft_year_dlv as ac_year_dlv,client_aircraft.cliaircraft_year_dlv as ac_year, "
      sql += " client_aircraft.cliaircraft_date_purchased as ac_date_purchased, client_aircraft.cliaircraft_date_purchased as ac_purchase_date, "
      sql += " client_aircraft.cliaircraft_forsale_flag as ac_forsale_flag, "
      sql += " client_aircraft.cliaircraft_date_listed as ac_date_listed, client_aircraft.cliaircraft_date_listed as ac_list_date,"
      sql += " client_aircraft.cliaircraft_status as ac_status, "
      sql += " client_aircraft.cliaircraft_est_price as take_price, "
      sql += " client_aircraft.cliaircraft_delivery as ac_delivery, "
      sql += " client_aircraft.cliaircraft_exclusive_flag as ac_exclusive_flag, client_aircraft.cliaircraft_asking_wordage as ac_asking, "
      sql += " client_aircraft.cliaircraft_asking_wordage as ac_asking_wordage,"
      sql += " client_aircraft.cliaircraft_asking_price as ac_asking_price, "
      sql += " client_aircraft.cliaircraft_lease_flag as ac_lease_flag, "
      sql += " client_aircraft.cliaircraft_airframe_maintenance_program as ac_airframe_maintenance_program, "
      sql += " client_aircraft.cliaircraft_airframe_maintenance_tracking_program as ac_airframe_maintenance_tracking_program, "
      sql += " client_aircraft.cliaircraft_airframe_total_hours as ac_airframe_total_hours, client_aircraft.cliaircraft_airframe_total_hours as ac_airframe_tot_hrs, client_aircraft.cliaircraft_airframe_total_landings as ac_airframe_tot_landings,"
      sql += " client_aircraft.cliaircraft_airframe_total_landings as ac_airframe_total_landings, "
      sql += " client_aircraft.cliaircraft_date_engine_times_as_of as  ac_date_engine_times_as_of, client_aircraft.cliaircraft_date_engine_times_as_of as ac_times_as_of_date, "
      sql += " client_aircraft.cliaircraft_aport_iata_code as ac_aport_iata_code, "
      sql += " client_aircraft.cliaircraft_aport_icao_code as ac_aport_icao_code, "
      sql += " client_aircraft.cliaircraft_aport_name as ac_aport_name,  "
      sql += " client_aircraft.cliaircraft_aport_state as ac_aport_state, "
      sql += " client_aircraft.cliaircraft_aport_country as ac_aport_country, "
      sql += " client_aircraft.cliaircraft_aport_city as ac_aport_city, "
      sql += " client_aircraft.cliaircraft_aport_private as ac_aport_private, "
      sql += " client_aircraft.cliaircraft_apu_model_name as ac_apu_model_name, "
      sql += " client_aircraft.cliaircraft_apu_ser_nbr as ac_apu_ser_nbr, "
      sql += " client_aircraft.cliaircraft_apu_ttsn_hours as ac_apu_ttsn_hours, "
      sql += " client_aircraft.cliaircraft_apu_tsoh_hours as ac_apu_tsoh_hours, "
      sql += " client_aircraft.cliaircraft_apu_tshi_hours as ac_apu_tshi_hours, "

      sql += " client_aircraft.cliaircraft_custom_1 as custom_1, "
      sql += " client_aircraft.cliaircraft_custom_2 as custom_2, "
      sql += " client_aircraft.cliaircraft_custom_3 as custom_3, "
      sql += " client_aircraft.cliaircraft_custom_4 as custom_4, "
      sql += " client_aircraft.cliaircraft_custom_5 as custom_5, "
      sql += " client_aircraft.cliaircraft_custom_6 as custom_6, "
      sql += " client_aircraft.cliaircraft_custom_7 as custom_7, "
      sql += " client_aircraft.cliaircraft_custom_8 as custom_8, "
      sql += " client_aircraft.cliaircraft_custom_9 as custom_9, "
      sql += " client_aircraft.cliaircraft_custom_10 as custom_10, "



      sql += " client_aircraft.cliaircraft_apu_ser_nbr as ac_apu_ser_no, "
      sql += " client_aircraft.cliaircraft_apu_ttsn_hours as ac_apu_tot_hrs, "
      sql += " client_aircraft.cliaircraft_apu_tsoh_hours as ac_apu_soh_hrs, "
      sql += " client_aircraft.cliaircraft_apu_tshi_hours as ac_apu_shi_hrs, "

      sql += " client_aircraft.cliaircraft_apu_maintance_program as ac_apu_maintance_program, "
      sql += " client_aircraft.cliaircraft_damage_flag as ac_damage_flag, "
      sql += " client_aircraft.cliaircraft_damage_history_notes as ac_damage_history_notes, "
      sql += " client_aircraft.cliaircraft_interior_rating as ac_interior_rating, "
      sql += " client_aircraft.cliaircraft_interior_month_year as ac_interior_month_year, client_aircraft.cliaircraft_interior_month_year as ac_interior_moyear, "
      sql += " client_aircraft.cliaircraft_interior_doneby_name as ac_interior_doneby_name, "
      sql += " client_aircraft.cliaircraft_interior_config_name as ac_interior_config_name, client_aircraft.cliaircraft_exterior_month_year as ac_exterior_moyear, "
      sql += " client_aircraft.cliaircraft_exterior_rating as ac_exterior_rating, "
      sql += " client_aircraft.cliaircraft_exterior_month_year as ac_exterior_month_year, "
      sql += " client_aircraft.cliaircraft_exterior_doneby_name as ac_exterior_doneby_name, "
      sql += " client_aircraft.cliaircraft_passenger_count as ac_passenger_count, "
      sql += " client_aircraft.cliaircraft_confidential_notes as ac_confidential_notes, "
      sql += " client_aircraft.cliaircraft_action_date as ac_action_date ,"
      sql += " client_aircraft.cliaircraft_value_description AS ac_value_description , client_aircraft_model.cliamod_airframe_type as amod_airframe_type_code, "
      sql += " client_aircraft_model.cliamod_airframe_type as amod_airframe_type, client_aircraft_model.cliamod_airframe_type as amod_type_code,"
      sql += " client_aircraft_model.cliamod_make_type as amod_make_type, "
      sql += " client_aircraft_model.cliamod_make_name as amod_make_name, "
      sql += " client_aircraft_model.cliamod_model_name as amod_model_name, "
      sql += " client_aircraft_model.cliamod_manufacturer_name as amod_manufacturer_name, "
      sql += " client_aircraft.cliaircraft_ac_maintained as ac_maintained, "
      sql += " 'N' as ac_picture_exist_flag, "
      sql += " client_aircraft.cliaircraft_ser_nbr_sort as ac_ser_nbr_sort, "
      sql += " client_aircraft_engine.cliacep_engine_name as ac_engine_name, "
      sql += " client_aircraft_engine.cliacep_engine_tbo_oc_flag as ac_engine_tbo_oc_flag, "
      sql += " client_aircraft_engine.cliacep_engine_noise_rating as ac_engine_noise_rating, "
      sql += " client_aircraft_engine.cliacep_engine_model_config as ac_model_config, "
      sql += " client_aircraft_engine.cliacep_engine_maintenance_program as ac_engine_maintenance_prog_EMP, "
      sql += " client_aircraft_engine.cliacep_engine_management_program as ac_engine_management_prog_EMGP, "
      sql += " client_aircraft_engine.cliacep_engine_hot_inspection_done_by_name as ac_maint_hots_by_name, "
      sql += " client_aircraft_engine.cliacep_engine_overhaul_done_month_year as ac_main_eoh_moyear,"
      sql += " client_aircraft_engine.cliacep_engine_overhaul_done_by_name as ac_maint_eoh_by_name,"
      sql += " client_aircraft_engine.cliacep_engine_hot_inspection_done_month_year as ac_maint_hots_moyear, "
      sql += " client_aircraft_engine.cliacep_engine_1_ser_nbr as ac_engine_1_ser_no,"
      sql += " client_aircraft_engine.cliacep_engine_2_ser_nbr as ac_engine_2_ser_no,"
      sql += " client_aircraft_engine.cliacep_engine_3_ser_nbr as ac_engine_3_ser_no,"
      sql += " client_aircraft_engine.cliacep_engine_4_ser_nbr as ac_engine_4_ser_no,"
      sql += " client_aircraft_engine.cliacep_engine_1_ttsn_hours as ac_engine_1_tot_hrs,"
      sql += " client_aircraft_engine.cliacep_engine_2_ttsn_hours as ac_engine_2_tot_hrs,"
      sql += " client_aircraft_engine.cliacep_engine_3_ttsn_hours as ac_engine_3_tot_hrs,"
      sql += " client_aircraft_engine.cliacep_engine_4_ttsn_hours as ac_engine_4_tot_hrs,"
      sql += " client_aircraft_engine.cliacep_engine_1_tsoh_hours as ac_engine_1_soh_hrs,"
      sql += " client_aircraft_engine.cliacep_engine_2_tsoh_hours as ac_engine_2_soh_hrs,"
      sql += " client_aircraft_engine.cliacep_engine_3_tsoh_hours as ac_engine_3_soh_hrs,"
      sql += " client_aircraft_engine.cliacep_engine_4_tsoh_hours as ac_engine_4_soh_hrs,"
      sql += " client_aircraft_engine.cliacep_engine_1_tshi_hours as ac_engine_1_shi_hrs,"
      sql += " client_aircraft_engine.cliacep_engine_2_tshi_hours as ac_engine_2_shi_hrs,"
      sql += " client_aircraft_engine.cliacep_engine_3_tshi_hours as ac_engine_3_shi_hrs,"
      sql += " client_aircraft_engine.cliacep_engine_4_tshi_hours as ac_engine_4_shi_hrs,"
      sql += " client_aircraft_engine.cliacep_engine_1_tbo_hours as ac_engine_1_tbo_hrs,"
      sql += " client_aircraft_engine.cliacep_engine_2_tbo_hours as ac_engine_2_tbo_hrs,"
      sql += " client_aircraft_engine.cliacep_engine_3_tbo_hours as ac_engine_3_tbo_hrs,"
      sql += " client_aircraft_engine.cliacep_engine_4_tbo_hours as ac_engine_4_tbo_hrs,"
      sql += " client_aircraft_engine.cliacep_engine_1_tsn_cycle as ac_engine_1_snew_cycles,"
      sql += " client_aircraft_engine.cliacep_engine_2_tsn_cycle as ac_engine_2_snew_cycles,"
      sql += " client_aircraft_engine.cliacep_engine_3_tsn_cycle as ac_engine_3_snew_cycles,"
      sql += " client_aircraft_engine.cliacep_engine_4_tsn_cycle as ac_engine_4_snew_cycles,"
      sql += " client_aircraft_engine.cliacep_engine_1_tsoh_cycle as ac_engine_1_soh_cycles,"
      sql += " client_aircraft_engine.cliacep_engine_2_tsoh_cycle as ac_engine_2_soh_cycles,"
      sql += " client_aircraft_engine.cliacep_engine_3_tsoh_cycle as ac_engine_3_soh_cycles,"
      sql += " client_aircraft_engine.cliacep_engine_4_tsoh_cycle as ac_engine_4_soh_cycles,"
      sql += " client_aircraft_engine.cliacep_engine_1_tshi_cycle as ac_engine_1_shs_cycles,"
      sql += " client_aircraft_engine.cliacep_engine_2_tshi_cycle as ac_engine_2_shs_cycles,"
      sql += " client_aircraft_engine.cliacep_engine_3_tshi_cycle as ac_engine_3_shs_cycles,"
      sql += " client_aircraft_engine.cliacep_engine_4_tshi_cycle as ac_engine_4_shs_cycles,"
      sql += " client_aircraft_propeller.cliacpr_prop_1_ser_nbr as ac_prop_1_ser_no,"
      sql += " client_aircraft_propeller.cliacpr_prop_2_ser_nbr as ac_prop_2_ser_no,"
      sql += " client_aircraft_propeller.cliacpr_prop_3_ser_nbr as ac_prop_3_ser_no,"
      sql += " client_aircraft_propeller.cliacpr_prop_4_ser_nbr as ac_prop_4_ser_no,"
      sql += " client_aircraft_propeller.cliacpr_prop_1_ttsn_hours as ac_prop_1_snew_hrs,"
      sql += " client_aircraft_propeller.cliacpr_prop_2_ttsn_hours as ac_prop_2_snew_hrs,"
      sql += " client_aircraft_propeller.cliacpr_prop_3_ttsn_hours as ac_prop_3_snew_hrs,"
      sql += " client_aircraft_propeller.cliacpr_prop_4_ttsn_hours as ac_prop_4_snew_hrs,"
      sql += " client_aircraft_propeller.cliacpr_prop_1_tsoh_hours as ac_prop_1_soh_hrs,"
      sql += " client_aircraft_propeller.cliacpr_prop_2_tsoh_hours as ac_prop_2_soh_hrs,"
      sql += " client_aircraft_propeller.cliacpr_prop_3_tsoh_hours as ac_prop_3_soh_hrs,"
      sql += " client_aircraft_propeller.cliacpr_prop_4_tsoh_hours as ac_prop_4_soh_hrs,"
      sql += " client_aircraft_propeller.cliacpr_prop_1_month_year_oh as ac_prop_1_soh_moyear,"
      sql += " client_aircraft_propeller.cliacpr_prop_2_month_year_oh as ac_prop_2_soh_moyear,"
      sql += " client_aircraft_propeller.cliacpr_prop_3_month_year_oh as ac_prop_3_soh_moyear,"
      sql += " client_aircraft_propeller.cliacpr_prop_4_month_year_oh as ac_prop_4_soh_moyear,"
      sql += " client_aircraft.cliaircraft_product_business_flag ac_product_business_flag, "
      sql += " client_aircraft.cliaircraft_product_helicopter_flag ac_product_helicopter_flag, "
      sql += " client_aircraft.cliaircraft_product_commercial_flag ac_product_commercial_flag, "
      sql += " client_aircraft.cliaircraft_id as CLIENT_ID, "
      sql += " airframe_maintenance_program.amp_provider_name, "
      sql += " airframe_maintenance_program.amp_program_name, "
      sql += " airframe_maintenance_tracking_program.amtp_provider_name, "
      sql += " airframe_maintenance_tracking_program.amtp_program_name, "
      sql += " engine_maintenance_program.emp_program_name, "
      sql += " engine_maintenance_program.emp_provider_name, "

      sql += " engine_management_program.emgp_provider_name, "
      sql += " engine_management_program.emgp_program_name, "

      'Fields unsure of
      sql += " NULL as ac_alt_ser_no_full, "
      sql += " NULL as ac_upd_date, "
      sql += " '' as ac_foreign_currency_name, "
      sql += " NULL as ac_reg_no_expiration_date, "
      sql += " NULL as ac_foreign_currency_price, "
      'sql += " NULL as amod_number_of_engines, "
      sql += " NULL as amod_weight_class, "
      sql += " NULL as ac_aport_faaid_code, "
      sql += " NULL as ac_exclusive_expiration_flag, "
      sql += " NULL as ac_exclusive_date, "
      sql += " NULL as amod_manufacturer_comp_id "

      sql += " FROM client_aircraft "
      'This join should be inner
      sql += " INNER JOIN client_aircraft_model ON client_aircraft.cliaircraft_cliamod_id = client_aircraft_model.cliamod_id"
      'Left Outer:
      sql += " LEFT OUTER JOIN client_aircraft_engine ON client_aircraft.cliaircraft_id = client_aircraft_engine.cliacep_cliac_id"
      'Left Outer:
      sql += " LEFT OUTER JOIN client_aircraft_propeller ON client_aircraft.cliaircraft_id = client_aircraft_propeller.cliacpr_cliac_id"
      'Left Outer:
      sql += " LEFT OUTER JOIN airframe_maintenance_program ON client_aircraft.cliaircraft_airframe_maintenance_program = airframe_maintenance_program.amp_id "
      'Left Outer:
      sql += " LEFT OUTER JOIN airframe_maintenance_tracking_program ON client_aircraft.cliaircraft_airframe_maintenance_tracking_program = airframe_maintenance_tracking_program.amtp_id "
      'Left Outer:
      sql += " LEFT OUTER JOIN engine_maintenance_program ON client_aircraft_engine.cliacep_engine_maintenance_program = engine_maintenance_program.emp_id "
      'Left Outer:
      sql += " LEFT OUTER JOIN engine_management_program ON client_aircraft_engine.cliacep_engine_management_program = engine_management_program.emgp_id "

      sql += " WHERE  (client_aircraft.cliaircraft_id = @AircraftID)"

      MySqlConn.ConnectionString = client_DB
      MySqlConn.Open()

      Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand(sql, MySqlConn)

      MySqlCommand.Parameters.AddWithValue("AircraftID", aircraftID)


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Public Function Get_Client_Aircraft_as_Jetnet_Fields(ByVal aircraftID As Long) As DataTable</b><br />" & sql


      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        ReturnTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = ReturnTable.GetErrors()
      End Try

      MySqlCommand.Dispose()
      MySqlCommand = Nothing


      Return ReturnTable
    Catch ex As Exception
      Get_Client_Aircraft_as_Jetnet_Fields = Nothing
      Me.class_error = "Error in Public Function Get_Client_Aircraft_as_Jetnet_Fields(ByVal aircraftID As Long) As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
    End Try

  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Clients_Aircraft_Model_Make_Model
  ' Purpose: to get all client aircraft based on the make / model
  ' Parameters: make model
  ' Return: 
  '       make, model
  ' Change Log
  '           1/05/2010    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Clients_Aircraft_Model_Make_Model(ByVal make As String, ByVal model As String) As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection

    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim aTempTable As New DataTable

    Dim sql As String = ""

    Try
      MySqlConn.ConnectionString = client_DB
      MySqlConn.Open()

      sql = "SELECT cliamod_id, cliamod_airframe_type, cliamod_make_type, cliamod_make_name, cliamod_model_name, "
      sql = sql & " cliamod_manufacturer_name, cliamod_jetnet_amod_id, "
      sql = sql & " cliamod_product_business_flag, cliamod_product_helicopter_flag, cliamod_product_commercial_flag "
      sql = sql & " FROM client_aircraft_model WHERE (cliamod_make_name = @cliamod_make_name) "
      sql = sql & " AND (cliamod_model_name = @cliamod_model_name)"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Clients_Aircraft_Model_Make_Model(ByVal make As String, ByVal model As String) As DataTable</b><br />" & sql

      Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand(sql, MySqlConn)


      MySqlCommand.Parameters.AddWithValue("@cliamod_make_name", make)
      MySqlCommand.Parameters.AddWithValue("@cliamod_model_name", model)

      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    Catch ex As Exception
      Get_Clients_Aircraft_Model_Make_Model = Nothing
      Me.class_error = "Error in Get_Clients_Aircraft_Model_Make_Model(ByVal make As String, ByVal model As String): " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

    End Try


  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Clients_Aircraft_For_Comparable(ByVal ac_id As Long)
  ' Purpose: to get all client aircraft and return fields needed for creation of comparable 
  ' Parameters: client ac_id
  ' Return: 
  '       datatable
  ' Change Log
  '           3/20/2015   - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Clients_Aircraft_For_Comparable(ByVal ac_id As Long) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim aTempTable As New DataTable

    Try

      sql = "SELECT client_aircraft.cliaircraft_action_date, client_aircraft.cliaircraft_airframe_maintenance_program, client_aircraft.cliaircraft_airframe_maintenance_tracking_program, "
      sql = sql & " client_aircraft.cliaircraft_airframe_total_hours, client_aircraft.cliaircraft_airframe_total_landings, client_aircraft.cliaircraft_alt_ser_nbr, "
      sql = sql & " client_aircraft.cliaircraft_aport_city, client_aircraft.cliaircraft_aport_country, client_aircraft.cliaircraft_aport_iata_code, client_aircraft.cliaircraft_aport_icao_code, "
      sql = sql & " client_aircraft.cliaircraft_aport_name, client_aircraft.cliaircraft_aport_private, client_aircraft.cliaircraft_aport_state, client_aircraft.cliaircraft_apu_maintance_program, "
      sql = sql & " client_aircraft.cliaircraft_apu_model_name, client_aircraft.cliaircraft_apu_ser_nbr, client_aircraft.cliaircraft_apu_tshi_hours, client_aircraft.cliaircraft_apu_tsoh_hours,"
      sql = sql & " client_aircraft.cliaircraft_apu_ttsn_hours, client_aircraft.cliaircraft_asking_price, client_aircraft.cliaircraft_asking_wordage, client_aircraft.cliaircraft_cliamod_id, client_aircraft_model.cliamod_jetnet_amod_id, "
      sql = sql & " client_aircraft.cliaircraft_confidential_notes, client_aircraft.cliaircraft_country_of_registration, client_aircraft.cliaircraft_damage_flag, "
      sql = sql & " client_aircraft.cliaircraft_damage_history_notes, client_aircraft.cliaircraft_date_engine_times_as_of, client_aircraft.cliaircraft_date_listed, "
      sql = sql & " client_aircraft.cliaircraft_date_purchased, client_aircraft.cliaircraft_delivery, client_aircraft.cliaircraft_est_price, client_aircraft.cliaircraft_exclusive_flag, "
      sql = sql & " client_aircraft.cliaircraft_exterior_doneby_name, client_aircraft.cliaircraft_exterior_month_year, client_aircraft.cliaircraft_exterior_rating, "
      sql = sql & " client_aircraft.cliaircraft_forsale_flag, client_aircraft.cliaircraft_id, client_aircraft.cliaircraft_interior_config_name, client_aircraft.cliaircraft_interior_doneby_name, "
      sql = sql & " client_aircraft.cliaircraft_interior_month_year, client_aircraft.cliaircraft_interior_rating, client_aircraft.cliaircraft_jetnet_ac_id, client_aircraft.cliaircraft_lease_flag, "
      sql = sql & " client_aircraft.cliaircraft_lifecycle, client_aircraft.cliaircraft_new_flag, client_aircraft.cliaircraft_ownership, client_aircraft.cliaircraft_passenger_count, "
      sql = sql & " client_aircraft.cliaircraft_prev_reg_nbr, client_aircraft.cliaircraft_reg_nbr, client_aircraft.cliaircraft_ser_nbr, client_aircraft.cliaircraft_status, "
      sql = sql & "  client_aircraft.cliaircraft_usage, client_aircraft.cliaircraft_user_id, client_aircraft.cliaircraft_year_dlv, client_aircraft.cliaircraft_year_mfr, "
      sql = sql & "  client_aircraft_model.cliamod_make_name, client_aircraft_model.cliamod_model_name, client_aircraft.cliaircraft_ser_nbr_sort, "
      sql = sql & " client_aircraft.cliaircraft_broker_price, client_aircraft.cliaircraft_ac_maintained, client_aircraft.cliaircraft_value_description, "
      sql = sql & " client_aircraft.cliaircraft_custom_1, client_aircraft.cliaircraft_custom_2, client_aircraft.cliaircraft_custom_3, client_aircraft.cliaircraft_custom_4, client_aircraft.cliaircraft_custom_5,"
      sql = sql & " client_aircraft.cliaircraft_custom_6, client_aircraft.cliaircraft_custom_7, client_aircraft.cliaircraft_custom_8, client_aircraft.cliaircraft_custom_9, client_aircraft.cliaircraft_custom_10"


      sql = sql & " FROM client_aircraft INNER JOIN"
      sql = sql & " client_aircraft_model ON client_aircraft.cliaircraft_cliamod_id = client_aircraft_model.cliamod_id"
      sql = sql & " WHERE  (client_aircraft.cliaircraft_id = " & ac_id & ")"

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Clients_Aircraft_For_Comparable(ByVal ac_id as long) As DataTable</b><br />" & sql

      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable
    Catch ex As Exception
      Get_Clients_Aircraft_For_Comparable = Nothing
      Me.class_error = "Error in Get_Clients_Aircraft_For_Comparable(ByVal ac_id as long): " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  'This gets a client aircraft if there is one based on the jetnet model id. 
  Public Function Get_Client_Aircraft_By_Model(ByRef jetnetModel As Long) As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection

    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Dim sQuery As String = ""
    Try

      MySqlConn.ConnectionString = client_DB
      MySqlConn.Open()

      sQuery = "SELECT DISTINCT cliaircraft_id, cliaircraft_jetnet_ac_id "
      sQuery += " FROM client_aircraft INNER JOIN"
      sQuery += " client_aircraft_model ON client_aircraft.cliaircraft_cliamod_id = client_aircraft_model.cliamod_id "
      sQuery += " WHERE cliamod_jetnet_amod_id =@jetnetModel and cliaircraft_forsale_flag='Y' limit 1"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Aircraft_By_Model(ByRef jetnetModel As Long) As DataTable</b><br />" & sQuery


      Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand(sQuery, MySqlConn)

      MySqlCommand.Parameters.AddWithValue("@jetnetModel", jetnetModel)

      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing

      Get_Client_Aircraft_By_Model = atemptable

    Catch ex As Exception
      Get_Client_Aircraft_By_Model = Nothing
      Me.class_error = "Error in Get_Client_Value_By_Model(ByRef jetnetModel As Long) As DataTable: SQL VERSION " & ex.Message
    Finally

      atemptable.Dispose()
      atemptable = Nothing

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

    End Try

  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Clients_Aircraft
  ' Purpose: to get all client aircraft 
  ' Parameters: client ac_id
  ' Return: 
  '       integer
  ' Change Log
  '           1/6/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Clients_Aircraft(ByVal ac_id) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim aTempTable As New DataTable

    Try

      sql = "SELECT client_aircraft.cliaircraft_action_date, client_aircraft.cliaircraft_airframe_maintenance_program, client_aircraft.cliaircraft_airframe_maintenance_tracking_program, "
      sql = sql & " client_aircraft.cliaircraft_airframe_total_hours, client_aircraft.cliaircraft_airframe_total_landings, client_aircraft.cliaircraft_alt_ser_nbr, "
      sql = sql & " client_aircraft.cliaircraft_aport_city, client_aircraft.cliaircraft_aport_country, client_aircraft.cliaircraft_aport_iata_code, client_aircraft.cliaircraft_aport_icao_code, "
      sql = sql & " client_aircraft.cliaircraft_aport_name, client_aircraft.cliaircraft_aport_private, client_aircraft.cliaircraft_aport_state, client_aircraft.cliaircraft_apu_maintance_program, "
      sql = sql & " client_aircraft.cliaircraft_apu_model_name, client_aircraft.cliaircraft_apu_ser_nbr, client_aircraft.cliaircraft_apu_tshi_hours, client_aircraft.cliaircraft_apu_tsoh_hours,"
      sql = sql & " client_aircraft.cliaircraft_apu_ttsn_hours, client_aircraft.cliaircraft_asking_price, client_aircraft.cliaircraft_asking_wordage, client_aircraft.cliaircraft_cliamod_id, "
      sql = sql & " client_aircraft.cliaircraft_confidential_notes, client_aircraft.cliaircraft_country_of_registration, client_aircraft.cliaircraft_damage_flag, "
      sql = sql & " client_aircraft.cliaircraft_damage_history_notes, client_aircraft.cliaircraft_date_engine_times_as_of, client_aircraft.cliaircraft_date_listed, "
      sql = sql & " client_aircraft.cliaircraft_date_purchased, client_aircraft.cliaircraft_delivery, client_aircraft.cliaircraft_est_price, client_aircraft.cliaircraft_exclusive_flag, "
      sql = sql & " client_aircraft.cliaircraft_exterior_doneby_name, client_aircraft.cliaircraft_exterior_month_year, client_aircraft.cliaircraft_exterior_rating, "
      sql = sql & " client_aircraft.cliaircraft_forsale_flag, client_aircraft.cliaircraft_id, client_aircraft.cliaircraft_interior_config_name, client_aircraft.cliaircraft_interior_doneby_name, "
      sql = sql & " client_aircraft.cliaircraft_interior_month_year, client_aircraft.cliaircraft_interior_rating, client_aircraft.cliaircraft_jetnet_ac_id, client_aircraft.cliaircraft_lease_flag, "
      sql = sql & " client_aircraft.cliaircraft_lifecycle, client_aircraft.cliaircraft_new_flag, client_aircraft.cliaircraft_ownership, client_aircraft.cliaircraft_passenger_count, "
      sql = sql & " client_aircraft.cliaircraft_prev_reg_nbr, client_aircraft.cliaircraft_reg_nbr, client_aircraft.cliaircraft_ser_nbr, client_aircraft.cliaircraft_status, "
      sql = sql & "  client_aircraft.cliaircraft_usage, client_aircraft.cliaircraft_user_id, client_aircraft.cliaircraft_year_dlv, client_aircraft.cliaircraft_year_mfr, "
      sql = sql & "  client_aircraft_model.cliamod_make_name, client_aircraft_model.cliamod_model_name, client_aircraft.cliaircraft_ser_nbr_sort, "
      sql = sql & " client_aircraft.cliaircraft_broker_price, client_aircraft.cliaircraft_ac_maintained, client_aircraft.cliaircraft_value_description, "
      sql = sql & " client_aircraft.cliaircraft_custom_1, client_aircraft.cliaircraft_custom_2, client_aircraft.cliaircraft_custom_3, client_aircraft.cliaircraft_custom_4, client_aircraft.cliaircraft_custom_5,"
      sql = sql & " client_aircraft.cliaircraft_custom_6, client_aircraft.cliaircraft_custom_7, client_aircraft.cliaircraft_custom_8, client_aircraft.cliaircraft_custom_9, client_aircraft.cliaircraft_custom_10"
      sql = sql & ", cliamod_jetnet_amod_id "

      sql = sql & " FROM client_aircraft INNER JOIN"
      sql = sql & " client_aircraft_model ON client_aircraft.cliaircraft_cliamod_id = client_aircraft_model.cliamod_id"
      sql = sql & " WHERE  (client_aircraft.cliaircraft_id = " & ac_id & ")"

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Clients_Aircraft(ByVal ac_id) As DataTable</b><br />" & sql

      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable
    Catch ex As Exception
      Get_Clients_Aircraft = Nothing
      Me.class_error = "Error in Get_Clients_Aircraft(ByVal ac_id): " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Clients_Aircraft
  ' Purpose: to get all client aircraft 
  ' Parameters: client ac_id
  ' Return: 
  '       integer
  ' Change Log
  '           3/1/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Clients_Aircraft_Ser_Model(ByVal ac_id) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim aTempTable As New DataTable

    Try

      sql = "SELECT cliamod_model_name, cliamod_make_name, cliaircraft_year_mfr, cliamod_id, cliaircraft_ser_nbr, cliaircraft_reg_nbr, cliaircraft_id"
      sql = sql & " FROM client_aircraft INNER JOIN"
      sql = sql & " client_aircraft_model ON client_aircraft.cliaircraft_cliamod_id = client_aircraft_model.cliamod_id"
      sql = sql & " WHERE  (client_aircraft.cliaircraft_id = " & ac_id & ")"

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Clients_Aircraft_Ser_Model(ByVal ac_id) As DataTable</b><br />" & sql

      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable
    Catch ex As Exception
      Get_Clients_Aircraft_Ser_Model = Nothing
      Me.class_error = "Error in Get_Clients_Aircraft_Ser_Model(ByVal ac_id) As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try


  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Clients_Aircraft
  ' Purpose: to get all client aircraft 
  ' Parameters: client ac_id
  ' Return: 
  '       integer
  ' Change Log
  '           3/1/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Client_Aircraft_Ser_Model(ByVal ac_id) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim aTempTable As New DataTable

    Try

      sql = "SELECT cliamod_make_name, cliamod_model_name, cliaircraft_ser_nbr "
      sql = sql & " FROM client_aircraft INNER JOIN"
      sql = sql & " client_aircraft_model ON client_aircraft.cliaircraft_cliamod_id = client_aircraft_model.cliamod_id"
      sql = sql & " WHERE  (client_aircraft.cliaircraft_id = " & ac_id & ")"

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Client_Aircraft_Ser_Model(ByVal ac_id) As DataTable</b><br />" & sql

      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable
    Catch ex As Exception
      Client_Aircraft_Ser_Model = Nothing
      Me.class_error = "Error in Client_Aircraft_Ser_Model(ByVal ac_id) As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try


  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_Aircraft_JETNET_AC
  ' Purpose: to see if the JETNET AC ID exists
  ' Parameters: jetnet_ac_id
  ' Return: 
  '       integer
  ' Change Log
  '           1/6/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Client_Aircraft_JETNET_AC(ByVal jetnet_ac_id As Integer) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim aTempTable As New DataTable
    Try


      sql = "SELECT distinct cliaircraft_ac_maintained, cliaircraft_action_date, cliaircraft_airframe_maintenance_program, "
      sql = sql & " cliaircraft_airframe_maintenance_tracking_program, cliaircraft_airframe_total_hours, "
      sql = sql & " cliaircraft_airframe_total_landings, cliaircraft_alt_ser_nbr, cliaircraft_aport_city, "
      sql = sql & " cliaircraft_aport_country, cliaircraft_aport_iata_code, cliaircraft_aport_icao_code, "
      sql = sql & " cliaircraft_aport_name, cliaircraft_aport_private, cliaircraft_aport_state, "
      sql = sql & " cliaircraft_apu_maintance_program, cliaircraft_apu_model_name, cliaircraft_apu_ser_nbr, "
      sql = sql & " cliaircraft_apu_tshi_hours, cliaircraft_apu_tsoh_hours, cliaircraft_apu_ttsn_hours, "
      sql = sql & " cliaircraft_asking_price, cliaircraft_asking_wordage, cliaircraft_broker_price, "
      sql = sql & " cliaircraft_cliamod_id, cliaircraft_confidential_notes, cliaircraft_country_of_registration, "
      sql = sql & " cliaircraft_damage_flag, cliaircraft_damage_history_notes, cliaircraft_date_engine_times_as_of, "
      sql = sql & "  cliaircraft_date_listed, cliaircraft_date_purchased, cliaircraft_delivery, "
      sql = sql & " cliaircraft_est_price, cliaircraft_exclusive_flag, cliaircraft_exterior_doneby_name, "
      sql = sql & " cliaircraft_exterior_month_year, cliaircraft_exterior_rating, cliaircraft_forsale_flag, "
      sql = sql & " cliaircraft_id, cliaircraft_interior_config_name, cliaircraft_interior_doneby_name, "
      sql = sql & " cliaircraft_interior_month_year, cliaircraft_interior_rating, cliaircraft_jetnet_ac_id, "
      sql = sql & " cliaircraft_lease_flag, cliaircraft_lifecycle, cliaircraft_new_flag, cliaircraft_ownership, "
      sql = sql & "  cliaircraft_passenger_count, cliaircraft_prev_reg_nbr, cliaircraft_reg_nbr, cliaircraft_ser_nbr, "
      sql = sql & " cliaircraft_status, cliaircraft_usage, cliaircraft_user_id, cliaircraft_year_dlv, cliaircraft_custom_1, cliaircraft_custom_2, "
      sql = sql & " cliaircraft_custom_3, cliaircraft_custom_4, cliaircraft_custom_5, cliaircraft_custom_6, cliaircraft_custom_7, cliaircraft_custom_8, cliaircraft_custom_9, cliaircraft_custom_10, "
      sql = sql & " cliaircraft_year_mfr, cliaircraft_value_description FROM client_aircraft WHERE (cliaircraft_jetnet_ac_id = " & jetnet_ac_id & ")"


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Aircraft_JETNET_AC(ByVal jetnet_ac_id As Integer) As DataTable</b><br />" & sql


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable
    Catch ex As Exception
      Get_Client_Aircraft_JETNET_AC = Nothing
      Me.class_error = "Error in SQL Get_Client_Aircraft_JETNET_AC(ByVal jetnet_ac_id As Integer): " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_Aircraft_JETNET_AC
  ' Purpose: to see if the JETNET AC ID exists
  ' Parameters: jetnet_ac_id
  ' Return: 
  '       integer
  ' Change Log
  '           2/17/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function CHECKFORClient_Aircraft_JETNET_AC(ByVal jetnet_ac_id As Long) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim aTempTable As New DataTable
    Try

      sql = "SELECT distinct cliaircraft_id, cliaircraft_forsale_flag FROM client_aircraft WHERE (cliaircraft_jetnet_ac_id = " & jetnet_ac_id & ")"


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>CHECKFORClient_Aircraft_JETNET_AC(ByVal jetnet_ac_id As Integer) As DataTable</b><br />" & sql


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable
    Catch ex As Exception
      CHECKFORClient_Aircraft_JETNET_AC = Nothing
      Me.class_error = "Error in SQL CHECKFORClient_Aircraft_JETNET_AC(ByVal jetnet_ac_id As Integer): " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_Aircraft_Propeller
  ' Purpose: to get a clients aircrfaft propeller
  ' Parameters: cliacep_cliac_id
  ' Return: 
  '       DataTable
  ' Change Log
  '           1/9/2011    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Client_Aircraft_Propeller(ByVal cliacpr_cliac_id As Integer) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim aTempTable As New DataTable
    Try
      sql = " SELECT cliacpr_cliac_id, cliacpr_prop_1_ser_nbr, cliacpr_prop_2_ser_nbr, cliacpr_prop_3_ser_nbr, cliacpr_prop_4_ser_nbr, cliacpr_prop_1_ttsn_hours, "
      sql = sql & " cliacpr_prop_2_ttsn_hours, cliacpr_prop_3_ttsn_hours, cliacpr_prop_4_ttsn_hours, cliacpr_prop_1_tsoh_hours, cliacpr_prop_2_tsoh_hours, "
      sql = sql & " cliacpr_prop_3_tsoh_hours, cliacpr_prop_4_tsoh_hours, cliacpr_prop_1_month_year_oh, cliacpr_prop_2_month_year_oh, cliacpr_prop_3_month_year_oh, "
      sql = sql & " cliacpr_prop_4_month_year_oh "
      sql = sql & " FROM(client_aircraft_propeller)"
      sql = sql & " WHERE cliacpr_cliac_id = " & cliacpr_cliac_id

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Aircraft_Propeller(ByVal cliacpr_cliac_id As Integer) As DataTable</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable
    Catch ex As Exception
      Get_Client_Aircraft_Propeller = Nothing
      Me.class_error = "Error in SQL Get_Client_Aircraft_Propeller(ByVal cliacpr_cliac_id As Integer): " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_Aircraft_Key_Features
  ' Purpose: to get a clients aircrfaft propeller
  ' Parameters: cliacep_cliac_id
  ' Return: 
  '       DataTable
  ' Change Log
  '           1/10/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Client_Aircraft_Key_Features(ByVal cliafeat_cliac_id As Integer, ByVal cliafeat_type As String) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim aTempTable As New DataTable
    Try
      sql = " SELECT client_aircraft_key_features.cliafeat_cliac_id, client_aircraft_key_features.cliafeat_type, "
      sql = sql & " client_aircraft_key_features.cliafeat_flag,client_aircraft_key_features.cliafeat_seq_nbr, "
      sql = sql & " client_key_features_flag.clikff_name, client_key_features.clikfeat_name "
      sql = sql & " FROM client_aircraft_key_features"
      sql = sql & " INNER JOIN client_key_features_flag ON client_aircraft_key_features.cliafeat_flag = client_key_features_flag.clikff_flag"
      sql = sql & " INNER JOIN client_key_features ON client_aircraft_key_features.cliafeat_type = client_key_features.clikfeat_type"
      sql = sql & " WHERE  client_aircraft_key_features.cliafeat_cliac_id = " & cliafeat_cliac_id & " AND "
      sql = sql & " client_aircraft_key_features.cliafeat_type = " & cliafeat_type & ""
      sql = sql & " and clikfeat_active_flag = 'Y' "
      sql = sql & " ORDER BY client_aircraft_key_features.cliafeat_seq_nbr"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Aircraft_Key_Features(ByVal cliafeat_cliac_id As Integer, ByVal cliafeat_type As String) As DataTable</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable
    Catch ex As Exception
      Get_Client_Aircraft_Key_Features = Nothing
      Me.class_error = "Error in SQL Get_Client_Aircraft_Key_Features(ByVal cliafeat_cliac_id As Integer, ByVal cliafeat_type As String): " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_Aircraft_Key_Features
  ' Purpose: to get a clients aircrfaft propeller
  ' Parameters: cliacep_cliac_id
  ' Return: 
  '       DataTable
  ' Change Log
  '           1/10/2012   - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Client_Aircraft_Key_Features(ByVal cliafeat_cliac_id As Integer) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim aTempTable As New DataTable
    Try
      sql = " SELECT client_aircraft_key_features.cliafeat_cliac_id, client_aircraft_key_features.cliafeat_type, client_aircraft_key_features.cliafeat_flag,client_aircraft_key_features.cliafeat_seq_nbr, client_key_features_flag.clikff_name, client_key_features.clikfeat_name"
      sql = sql & " FROM(client_aircraft_key_features)"
      sql = sql & " INNER JOIN client_key_features_flag ON client_aircraft_key_features.cliafeat_flag = client_key_features_flag.clikff_flag"
      sql = sql & " INNER JOIN client_key_features ON client_aircraft_key_features.cliafeat_type = client_key_features.clikfeat_type"
      sql = sql & " WHERE  client_aircraft_key_features.cliafeat_cliac_id = " & cliafeat_cliac_id
      sql = sql & " and clikfeat_active_flag = 'Y' "
      sql = sql & " ORDER BY client_aircraft_key_features.cliafeat_seq_nbr"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Aircraft_Key_Features(ByVal cliafeat_cliac_id As Integer) As DataTable</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable
    Catch ex As Exception
      Get_Client_Aircraft_Key_Features = Nothing
      Me.class_error = "Error in SQL Get_Client_Aircraft_Key_Features(ByVal cliafeat_cliac_id As Integer): " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_Aircraft_Engine
  ' Purpose: to get a clients aircrfaft engine
  ' Parameters: cliacep_cliac_id
  ' Return: 
  '       DataTable
  ' Change Log
  '           1/10/2012    - Created By: Tom Jones
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Client_Aircraft_Engine(ByVal cliacep_cliac_id As Integer) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim aTempTable As New DataTable

    Try
      sql = "SELECT cliacep_cliac_id, cliacep_engine_name, cliacep_engine_maintenance_program, cliacep_engine_management_program, cliacep_engine_tbo_oc_flag, "
      sql = sql & " cliacep_engine_noise_rating, cliacep_engine_model_config, cliacep_engine_overhaul_done_by_name, cliacep_engine_overhaul_done_month_year, "
      sql = sql & " cliacep_engine_hot_inspection_done_by_name, cliacep_engine_hot_inspection_done_month_year, cliacep_engine_1_ser_nbr, cliacep_engine_2_ser_nbr, "
      sql = sql & " cliacep_engine_3_ser_nbr, cliacep_engine_4_ser_nbr, cliacep_engine_1_ttsn_hours, cliacep_engine_2_ttsn_hours, cliacep_engine_3_ttsn_hours, "
      sql = sql & " cliacep_engine_4_ttsn_hours, cliacep_engine_1_tsoh_hours, cliacep_engine_2_tsoh_hours, cliacep_engine_3_tsoh_hours, cliacep_engine_4_tsoh_hours, "
      sql = sql & " cliacep_engine_1_tshi_hours, cliacep_engine_2_tshi_hours, cliacep_engine_3_tshi_hours, cliacep_engine_4_tshi_hours, cliacep_engine_1_tbo_hours, "
      sql = sql & " cliacep_engine_2_tbo_hours, cliacep_engine_3_tbo_hours, cliacep_engine_4_tbo_hours, cliacep_engine_1_tsn_cycle, cliacep_engine_2_tsn_cycle, "
      sql = sql & " cliacep_engine_3_tsn_cycle, cliacep_engine_4_tsn_cycle, cliacep_engine_1_tsoh_cycle, cliacep_engine_2_tsoh_cycle, cliacep_engine_3_tsoh_cycle, "
      sql = sql & " cliacep_engine_4_tsoh_cycle, cliacep_engine_1_tshi_cycle, cliacep_engine_2_tshi_cycle, cliacep_engine_3_tshi_cycle, cliacep_engine_4_tshi_cycle "
      sql = sql & " FROM (client_aircraft_engine)"
      sql = sql & " WHERE  cliacep_cliac_id = " & cliacep_cliac_id


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Aircraft_Engine(ByVal cliacep_cliac_id As Integer) As DataTable</b><br />" & sql

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable
    Catch ex As Exception
      Get_Client_Aircraft_Engine = Nothing
      Me.class_error = "Error in SQL Get_Client_Aircraft_Engine(ByVal cliacep_cliac_id As Integer): " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_Aircraft_Avionics
  ' Purpose: to get a clients aircrfaft avionics
  ' Parameters: clsClient_Aircraft_Model
  ' Return: 
  '       integer
  ' Change Log
  '           1/10/2012   - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Client_Aircraft_Avionics(ByVal cliav_cliac_id As Integer) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim aTempTable As New DataTable

    Try
      sql = "SELECT  cliav_cliac_id, cliav_name, cliav_description "
      sql = sql & " FROM client_aircraft_avionics WHERE cliav_cliac_id = " & cliav_cliac_id
      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Aircraft_Avionics(ByVal cliav_cliac_id As Integer) As DataTable</b><br />" & sql

      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable
    Catch ex As Exception
      Get_Client_Aircraft_Avionics = Nothing
      Me.class_error = "Error in SQL Get_Client_Aircraft_Avionics(ByVal cliav_cliac_id As Integer): " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  ''' <summary>
  ''' Returning the avionics for an aircraft with the jetnet field names attached.
  ''' </summary>
  ''' <param name="aircraftID"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Get_Client_Aircraft_Avionics_As_Jetnet_Fields(ByVal aircraftID As Long) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim aTempTable As New DataTable

    Try
      sql = "SELECT  cliav_cliac_id as av_ac_id, cliav_name as av_name, cliav_description as av_description "
      sql = sql & " FROM client_aircraft_avionics WHERE cliav_cliac_id = @aircraftID"

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()

      Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand(sql, MySqlConn)
      MySqlCommand.Parameters.AddWithValue("aircraftID", aircraftID)
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b> Public Function Get_Client_Aircraft_Avionics_As_Jetnet_Fields(ByVal aircraftID As Long) As DataTable</b><br />" & sql


      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    Catch ex As Exception
      Get_Client_Aircraft_Avionics_As_Jetnet_Fields = Nothing
      Me.class_error = "Error in SQL Public Function Get_Client_Aircraft_Avionics_As_Jetnet_Fields(ByVal aircraftID As Long) As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
    End Try

  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_LatestClients_Aircraft_ByUserID
  ' Purpose: to get all client aircraft 
  ' Parameters: user ID
  ' Change Log
  '           1/11/2012   - Created By: Amanda Jennings
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_LatestClients_Aircraft_ByUserID(ByVal cliaircraft_user_id As Integer) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim aTempTable As New DataTable
    Try
      aTempTable.Columns.Add("cliaircraft_ac_maintained")
      aTempTable.Columns.Add("cliaircraft_action_date")
      aTempTable.Columns.Add("cliaircraft_airframe_maintenance_program")
      aTempTable.Columns.Add("cliaircraft_airframe_maintenance_tracking_program")
      aTempTable.Columns.Add("cliaircraft_airframe_total_hours")
      aTempTable.Columns.Add("cliaircraft_airframe_total_landings")
      aTempTable.Columns.Add("cliaircraft_alt_ser_nbr")
      aTempTable.Columns.Add("cliaircraft_aport_city")
      aTempTable.Columns.Add("cliaircraft_aport_country")

      aTempTable.Columns.Add("cliaircraft_aport_iata_code")
      aTempTable.Columns.Add("cliaircraft_aport_icao_code")
      aTempTable.Columns.Add("cliaircraft_aport_name")
      aTempTable.Columns.Add("cliaircraft_aport_private")


      aTempTable.Columns.Add("cliaircraft_aport_state")
      aTempTable.Columns.Add("cliaircraft_apu_maintance_program")
      aTempTable.Columns.Add("cliaircraft_apu_model_name")
      aTempTable.Columns.Add("cliaircraft_apu_ser_nbr")

      aTempTable.Columns.Add("cliaircraft_apu_tshi_hours")
      aTempTable.Columns.Add("cliaircraft_apu_tsoh_hours")
      aTempTable.Columns.Add("cliaircraft_apu_ttsn_hours")
      aTempTable.Columns.Add("cliaircraft_asking_price")

      aTempTable.Columns.Add("cliaircraft_asking_wordage")
      aTempTable.Columns.Add("cliaircraft_broker_price")
      aTempTable.Columns.Add("cliaircraft_cliamod_id")
      aTempTable.Columns.Add("cliaircraft_confidential_notes")
      aTempTable.Columns.Add("cliaircraft_country_of_registration")
      aTempTable.Columns.Add("cliaircraft_damage_flag")

      aTempTable.Columns.Add("cliaircraft_damage_history_notes")
      aTempTable.Columns.Add("cliaircraft_date_engine_times_as_of")


      sql = " SELECT cliaircraft_ac_maintained, cliaircraft_action_date, cliaircraft_airframe_maintenance_program, "
      sql = sql & " cliaircraft_airframe_maintenance_tracking_program, cliaircraft_airframe_total_hours, "
      sql = sql & " cliaircraft_airframe_total_landings, cliaircraft_alt_ser_nbr, cliaircraft_aport_city, "
      sql = sql & " cliaircraft_aport_country, cliaircraft_aport_iata_code, cliaircraft_aport_icao_code, "
      sql = sql & " cliaircraft_aport_name, cliaircraft_aport_private, cliaircraft_aport_state, "
      sql = sql & " cliaircraft_apu_maintance_program, cliaircraft_apu_model_name, cliaircraft_apu_ser_nbr, "
      sql = sql & " cliaircraft_apu_tshi_hours, cliaircraft_apu_tsoh_hours, cliaircraft_apu_ttsn_hours, "
      sql = sql & " cliaircraft_asking_price, cliaircraft_asking_wordage, cliaircraft_broker_price, "
      sql = sql & " cliaircraft_cliamod_id, cliaircraft_confidential_notes, cliaircraft_country_of_registration, "
      sql = sql & " cliaircraft_damage_flag, cliaircraft_damage_history_notes, cliaircraft_date_engine_times_as_of,"

      sql = sql & " cliaircraft_date_listed, cliaircraft_date_purchased, cliaircraft_delivery, cliaircraft_est_price, "
      sql = sql & " cliaircraft_exclusive_flag, cliaircraft_exterior_doneby_name, cliaircraft_exterior_month_year, "


      aTempTable.Columns.Add("cliaircraft_date_listed")
      aTempTable.Columns.Add("cliaircraft_date_purchased")
      aTempTable.Columns.Add("cliaircraft_delivery")
      aTempTable.Columns.Add("cliaircraft_est_price")
      aTempTable.Columns.Add("cliaircraft_exclusive_flag")

      aTempTable.Columns.Add("cliaircraft_exterior_doneby_name")
      aTempTable.Columns.Add("cliaircraft_exterior_month_year")

      aTempTable.Columns.Add("cliaircraft_exterior_rating")
      aTempTable.Columns.Add("cliaircraft_forsale_flag")
      aTempTable.Columns.Add("cliaircraft_id")
      aTempTable.Columns.Add("cliaircraft_interior_config_name")
      aTempTable.Columns.Add("cliaircraft_interior_doneby_name")
      aTempTable.Columns.Add("cliaircraft_interior_month_year")
      aTempTable.Columns.Add("cliaircraft_interior_rating")


      sql = sql & " cliaircraft_exterior_rating, cliaircraft_forsale_flag, cliaircraft_id, "
      sql = sql & " cliaircraft_interior_config_name, cliaircraft_interior_doneby_name, "
      sql = sql & " cliaircraft_interior_month_year, cliaircraft_interior_rating, "

      aTempTable.Columns.Add("cliaircraft_jetnet_ac_id")
      aTempTable.Columns.Add("cliaircraft_lease_flag")
      aTempTable.Columns.Add("cliaircraft_new_flag")
      aTempTable.Columns.Add("cliaircraft_ownership")
      aTempTable.Columns.Add("cliaircraft_passenger_count")
      aTempTable.Columns.Add("cliaircraft_prev_reg_nbr")
      aTempTable.Columns.Add("cliaircraft_reg_nbr")
      aTempTable.Columns.Add("cliaircraft_ser_nbr")
      aTempTable.Columns.Add("cliaircraft_status")
      aTempTable.Columns.Add("cliaircraft_usage")
      aTempTable.Columns.Add("cliaircraft_user_id")
      aTempTable.Columns.Add("cliaircraft_year_dlv")
      aTempTable.Columns.Add("cliaircraft_year_mfr")

      sql = sql & " cliaircraft_jetnet_ac_id, cliaircraft_lease_flag, cliaircraft_lifecycle, "
      sql = sql & " cliaircraft_new_flag, cliaircraft_ownership, cliaircraft_passenger_count, "
      sql = sql & " cliaircraft_prev_reg_nbr, cliaircraft_reg_nbr, cliaircraft_ser_nbr, cliaircraft_status, "
      sql = sql & " cliaircraft_usage, cliaircraft_user_id, cliaircraft_year_dlv, cliaircraft_year_mfr FROM "
      sql = sql & " client_aircraft WHERE (cliaircraft_user_id = " & cliaircraft_user_id & ") ORDER BY cliaircraft_action_date DESC"


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_LatestClients_Aircraft_ByUserID(ByVal cliaircraft_user_id As Integer) As DataTable</b><br />" & sql

      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      While MySqlReader.Read()

        Dim newCustomersRow As DataRow = aTempTable.NewRow()

        newCustomersRow("cliaircraft_ac_maintained") = MySqlReader.Item("cliaircraft_ac_maintained")
        newCustomersRow("cliaircraft_action_date") = MySqlReader.Item("cliaircraft_action_date")
        newCustomersRow("cliaircraft_airframe_maintenance_program") = MySqlReader.Item("cliaircraft_airframe_maintenance_program")
        newCustomersRow("cliaircraft_airframe_maintenance_tracking_program") = MySqlReader.Item("cliaircraft_airframe_maintenance_tracking_program")
        newCustomersRow("cliaircraft_airframe_total_hours") = MySqlReader.Item("cliaircraft_airframe_total_hours")
        newCustomersRow("cliaircraft_airframe_total_landings") = MySqlReader.Item("cliaircraft_airframe_total_landings")
        newCustomersRow("cliaircraft_alt_ser_nbr") = MySqlReader.Item("cliaircraft_alt_ser_nbr")
        newCustomersRow("cliaircraft_aport_city") = MySqlReader.Item("cliaircraft_aport_city")
        newCustomersRow("cliaircraft_aport_country") = MySqlReader.Item("cliaircraft_aport_country")

        newCustomersRow("cliaircraft_aport_iata_code") = MySqlReader.Item("cliaircraft_aport_iata_code")
        newCustomersRow("cliaircraft_aport_icao_code") = MySqlReader.Item("cliaircraft_aport_icao_code")
        newCustomersRow("cliaircraft_aport_name") = MySqlReader.Item("cliaircraft_aport_name")
        newCustomersRow("cliaircraft_aport_private") = MySqlReader.Item("cliaircraft_aport_private")


        newCustomersRow("cliaircraft_aport_state") = MySqlReader.Item("cliaircraft_aport_state")
        newCustomersRow("cliaircraft_apu_maintance_program") = MySqlReader.Item("cliaircraft_apu_maintance_program")
        newCustomersRow("cliaircraft_apu_model_name") = MySqlReader.Item("cliaircraft_apu_model_name")
        newCustomersRow("cliaircraft_apu_ser_nbr") = MySqlReader.Item("cliaircraft_apu_ser_nbr")

        newCustomersRow("cliaircraft_apu_tshi_hours") = MySqlReader.Item("cliaircraft_apu_tshi_hours")
        newCustomersRow("cliaircraft_apu_tsoh_hours") = MySqlReader.Item("cliaircraft_apu_tsoh_hours")
        newCustomersRow("cliaircraft_apu_ttsn_hours") = MySqlReader.Item("cliaircraft_apu_ttsn_hours")
        newCustomersRow("cliaircraft_asking_price") = MySqlReader.Item("cliaircraft_asking_price")

        newCustomersRow("cliaircraft_asking_wordage") = MySqlReader.Item("cliaircraft_asking_wordage")
        newCustomersRow("cliaircraft_broker_price") = MySqlReader.Item("cliaircraft_broker_price")
        newCustomersRow("cliaircraft_cliamod_id") = MySqlReader.Item("cliaircraft_cliamod_id")
        newCustomersRow("cliaircraft_confidential_notes") = MySqlReader.Item("cliaircraft_confidential_notes")
        newCustomersRow("cliaircraft_date_engine_times_as_of") = MySqlReader.Item("cliaircraft_date_engine_times_as_of")
        newCustomersRow("cliaircraft_damage_flag") = MySqlReader.Item("cliaircraft_damage_flag")

        newCustomersRow("cliaircraft_damage_history_notes") = MySqlReader.Item("cliaircraft_damage_history_notes")
        newCustomersRow("cliaircraft_country_of_registration") = MySqlReader.Item("cliaircraft_country_of_registration")

        newCustomersRow("cliaircraft_date_listed") = MySqlReader.Item("cliaircraft_date_listed")
        newCustomersRow("cliaircraft_date_purchased") = MySqlReader.Item("cliaircraft_date_purchased")
        newCustomersRow("cliaircraft_delivery") = MySqlReader.Item("cliaircraft_delivery")
        newCustomersRow("cliaircraft_est_price") = MySqlReader.Item("cliaircraft_est_price")
        newCustomersRow("cliaircraft_exclusive_flag") = MySqlReader.Item("cliaircraft_exclusive_flag")



        newCustomersRow("cliaircraft_exterior_doneby_name") = MySqlReader.Item("cliaircraft_exterior_doneby_name")

        newCustomersRow("cliaircraft_exterior_month_year") = MySqlReader.Item("cliaircraft_exterior_month_year")

        newCustomersRow("cliaircraft_exterior_rating") = MySqlReader.Item("cliaircraft_exterior_rating")

        newCustomersRow("cliaircraft_forsale_flag") = MySqlReader.Item("cliaircraft_forsale_flag")

        newCustomersRow("cliaircraft_id") = MySqlReader.Item("cliaircraft_id")

        newCustomersRow("cliaircraft_interior_config_name") = MySqlReader.Item("cliaircraft_interior_config_name")
        newCustomersRow("cliaircraft_interior_doneby_name") = MySqlReader.Item("cliaircraft_interior_doneby_name")

        newCustomersRow("cliaircraft_interior_month_year") = MySqlReader.Item("cliaircraft_interior_month_year")

        newCustomersRow("cliaircraft_interior_rating") = MySqlReader.Item("cliaircraft_interior_rating")

        newCustomersRow("cliaircraft_jetnet_ac_id") = MySqlReader.Item("cliaircraft_jetnet_ac_id")

        newCustomersRow("cliaircraft_lease_flag") = MySqlReader.Item("cliaircraft_lease_flag")

        newCustomersRow("cliaircraft_new_flag") = MySqlReader.Item("cliaircraft_new_flag")
        newCustomersRow("cliaircraft_ownership") = MySqlReader.Item("cliaircraft_ownership")
        newCustomersRow("cliaircraft_passenger_count") = MySqlReader.Item("cliaircraft_passenger_count")


        newCustomersRow("cliaircraft_prev_reg_nbr") = MySqlReader.Item("cliaircraft_prev_reg_nbr")
        newCustomersRow("cliaircraft_reg_nbr") = MySqlReader.Item("cliaircraft_reg_nbr")
        newCustomersRow("cliaircraft_ser_nbr") = MySqlReader.Item("cliaircraft_ser_nbr")
        newCustomersRow("cliaircraft_status") = MySqlReader.Item("cliaircraft_status")
        newCustomersRow("cliaircraft_usage") = MySqlReader.Item("cliaircraft_usage")
        newCustomersRow("cliaircraft_user_id") = MySqlReader.Item("cliaircraft_user_id")
        newCustomersRow("cliaircraft_year_dlv") = MySqlReader.Item("cliaircraft_year_dlv")
        newCustomersRow("cliaircraft_year_mfr") = MySqlReader.Item("cliaircraft_year_mfr")

        aTempTable.Rows.Add(newCustomersRow)
        aTempTable.AcceptChanges()
      End While
      MySqlReader.Close()
      MySqlReader = Nothing


      Return aTempTable

    Catch ex As Exception
      Get_LatestClients_Aircraft_ByUserID = Nothing
      Me.class_error = "Error in SQL Get_LatestClients_Aircraft_ByUserID(ByVal cliaircraft_user_id As Integer): " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try



  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_Aircraft_Data_Type
  ' Purpose: to get a clients aircrfaft data type
  ' Parameters: cliadt_data_type 
  ' Return: 
  '       integer
  ' Change Log
  '           1/25/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Client_Aircraft_Data_Type(ByVal cliadt_data_type As String) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim aTempTable As New DataTable

    Try

      sql = "SELECT  cliadt_data_type, cliadt_data_name, cliadt_data_length, cliadt_seq_no "
      sql = sql & " FROM client_aircraft_data_type "

      If cliadt_data_type <> "" Then
        sql = sql & " WHERE cliadt_data_type = '" & cliadt_data_type & "'"
      End If

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Aircraft_Data_Type(ByVal cliadt_data_type As String) as Datatable</b><br />" & sql

      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable

    Catch ex As Exception
      Get_Client_Aircraft_Data_Type = Nothing
      Me.class_error = "Error in SQL Get_Client_Aircraft_Data_Type(ByVal cliadt_data_type As String): " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try


  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_Aircraft_Key_Features
  ' Purpose: to get a clients aircrfaft propeller
  ' Parameters: cliacep_cliac_id
  ' Return: 
  '       DataTable
  ' Change Log
  '           1/25/2012    - Created By: Amanda
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Client_Aircraft_Key_Features_List() As DataTable
    'clikfeat_name ASC
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim aTempTable As New DataTable

    Try
      sql = "SELECT clikfeat_name, clikfeat_type FROM client_key_features where clikfeat_active_flag = 'Y' order by clikfeat_name asc"


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Aircraft_Key_Features_List()</b><br />" & sql

      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable
    Catch ex As Exception
      Get_Client_Aircraft_Key_Features_List = Nothing
      Me.class_error = "Error in SQL Get_Client_Aircraft_Key_Features_List(): " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_Aircraft_Key_Features_Flag
  ' Purpose: to get a clients aircrfaft propeller
  ' Parameters: cliacep_cliac_id
  ' Return: 
  '       DataTable
  ' Change Log
  '           1/25/2012   - Created By: Tom Jones
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Client_Aircraft_Key_Features_Flag() As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim aTempTable As New DataTable

    Try
      sql = "SELECT clikff_flag, clikff_name FROM client_key_features_flag"

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Aircraft_Key_Features_Flag()</b><br />" & sql

      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable
    Catch ex As Exception
      Get_Client_Aircraft_Key_Features_Flag = Nothing
      Me.class_error = "Error in SQL Get_Client_Aircraft_Key_Features_Flag(): " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try


  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Update_Client_Aircraft_Avionics
  ' Purpose: to update a clients aircrfaft avionics
  ' Parameters: clsClient_Aircraft_Model
  ' Return: 
  '       integer
  ' Change Log
  '           2/3/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Update_Client_Aircraft_Avionics(ByVal cliav_cliac_id As Integer, ByVal cliav_name As String, ByVal cliav_description As String, ByVal org_cliav_cliac_id As Integer, ByVal org_cliav_name As String, ByVal org_cliav_description As String) As Integer

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Update_Client_Aircraft_Avionics = 0
    Try

      sql = "UPDATE client_aircraft_avionics SET cliav_cliac_id = " & cliav_cliac_id
      sql = sql & ", cliav_name = '" & Left(cliav_name, 45) & "', cliav_description = '" & Left(cliav_description, 75) & "' WHERE ((cliav_cliac_id = " & org_cliav_cliac_id & ") AND (cliav_name = '" & org_cliav_name & "') AND (cliav_description = '" & org_cliav_description & "'))"


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Update_Client_Aircraft_Avionics(ByVal cliav_cliac_id As Integer, ByVal cliav_name As String, ByVal cliav_description As String, ByVal org_cliav_cliac_id As Integer, ByVal org_cliav_name As String, ByVal org_cliav_description As String) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Update_Client_Aircraft_Avionics = 1
    Catch ex As Exception
      Update_Client_Aircraft_Avionics = 0
      Me.class_error = "Error in SQL  Update_Client_Aircraft_Avionics(ByVal cliav_cliac_id As Integer, ByVal cliav_name As String, ByVal cliav_description As String, ByVal org_cliav_cliac_id As Integer, ByVal org_cliav_name As String, ByVal org_cliav_description As String) As Integer " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Delete_Client_Aircraft_Avionics
  ' Purpose: to delete a clients aircrfaft avionics
  ' Parameters: clsClient_Aircraft_Model
  ' Return: 
  '       integer
  ' Change Log
  '           2/3/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Delete_Client_Aircraft_Avionics(ByVal cliav_cliac_id As Integer, ByVal cliav_name As String, ByVal cliav_description As String) As Integer

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Delete_Client_Aircraft_Avionics = 0
    Try
      sql = " DELETE FROM client_aircraft_avionics WHERE ((cliav_cliac_id = " & cliav_cliac_id & ") "
      sql = sql & " AND (cliav_name = '" & cliav_name & "') AND (cliav_description = '" & cliav_description & "')) limit 1"


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Delete_Client_Aircraft_Avionics(ByVal cliav_cliac_id As Integer, ByVal cliav_name As String, ByVal cliav_description As String) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Delete_Client_Aircraft_Avionics = 1
    Catch ex As Exception
      Delete_Client_Aircraft_Avionics = 0
      Me.class_error = "Error in SQL  Delete_Client_Aircraft_Avionics(ByVal cliav_cliac_id As Integer, ByVal cliav_name As String, ByVal cliav_description As String)  As Integer " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Delete_Client_Aircraft_Avionics_All
  ' Purpose: to delete a clients aircrfaft avionics
  ' Parameters: clsClient_Aircraft_Model
  ' Return: 
  '       integer
  ' Change Log
  '           2/6/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Delete_Client_Aircraft_Avionics(ByVal cliav_cliac_id As Integer) As Integer

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Delete_Client_Aircraft_Avionics = 0
    Try
      sql = " DELETE FROM client_aircraft_avionics WHERE (cliav_cliac_id = " & cliav_cliac_id & ") "

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Delete_Client_Aircraft_Avionics(ByVal cliav_cliac_id As Integer, ByVal cliav_name As String, ByVal cliav_description As String) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Delete_Client_Aircraft_Avionics = 1
    Catch ex As Exception
      Delete_Client_Aircraft_Avionics = 0
      Me.class_error = "Error in SQL  Delete_Client_Aircraft_Avionics(ByVal cliav_cliac_id As Integer, ByVal cliav_name As String, ByVal cliav_description As String)  As Integer " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Delete_Client_Aircraft_Reference_by_Client_AC
  ' Purpose: to delete a clients aircrfaft avionics
  ' Parameters: ByVal cliacref_cliac_id As Integer
  ' Return: 
  '       integer
  ' Change Log
  '           2/6/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Delete_Client_Aircraft_Reference_by_Client_AC(ByVal cliacref_cliac_id As Integer) As Boolean

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Delete_Client_Aircraft_Reference_by_Client_AC = 0
    Try
      sql = "DELETE FROM client_aircraft_reference WHERE ((cliacref_cliac_id = '" & cliacref_cliac_id & "'))"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Delete_Client_Aircraft_Reference_by_Client_AC(ByVal cliacref_cliac_id As Integer) As Boolean</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Delete_Client_Aircraft_Reference_by_Client_AC = 1
    Catch ex As Exception
      Delete_Client_Aircraft_Reference_by_Client_AC = 0
      Me.class_error = "Error in SQL  Delete_Client_Aircraft_Reference_by_Client_AC(ByVal cliacref_cliac_id As Integer) As Boolean " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Insert_Client_Aircraft_Avionics
  ' Purpose: to insert a clients aircrfaft avionics
  ' Parameters: clsClient_Aircraft_Model
  ' Return: 
  '       integer
  ' Change Log
  '           2/3/2012    - Created By: Tom Jones
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Insert_Client_Aircraft_Avionics(ByVal cliav_cliac_id As Integer, ByVal cliav_name As String, ByVal cliav_description As String) As Integer

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Insert_Client_Aircraft_Avionics = 0
    Try

      sql = "INSERT INTO client_aircraft_avionics (cliav_cliac_id, cliav_name, cliav_description) VALUES (" & cliav_cliac_id & ",'" & Escape_Single_Quote(Left(cliav_name, 45)) & "','" & Escape_Single_Quote(Left(cliav_description, 75)) & "')"
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Insert_Client_Aircraft_Avionics(ByVal cliav_cliac_id As Integer, ByVal cliav_name As String, ByVal cliav_description As String) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Insert_Client_Aircraft_Avionics = 1
    Catch ex As Exception
      Insert_Client_Aircraft_Avionics = 0
      Me.class_error = "Error in SQL Insert_Client_Aircraft_Avionics(ByVal cliav_cliac_id As Integer, ByVal cliav_name As String, ByVal cliav_description As String) As Integer " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Delete_Client_Aircraft_Details_ALL
  ' Purpose: to delete a clients aircrfaft details
  ' Parameters: cliadet_id, cliadet_cliac_id
  ' Return: 
  '       integer
  ' Change Log
  '           2/3/2012   - Created By: Tom Jones
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Delete_Client_Aircraft_Details_ALL(ByVal cliadet_cliac_id As Integer, ByVal type As String) As Integer

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Delete_Client_Aircraft_Details_ALL = 0
    Try

      sql = " DELETE FROM client_aircraft_details WHERE "
      sql = sql & " ((cliadet_cliac_id = " & cliadet_cliac_id & ") AND "
      sql = sql & "(cliadet_data_type = '" & type & "' ))"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b> Delete_Client_Aircraft_Details_ALL(ByVal cliadet_cliac_id As Integer, ByVal type As String) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Delete_Client_Aircraft_Details_ALL = 1
    Catch ex As Exception
      Delete_Client_Aircraft_Details_ALL = 0
      Me.class_error = "Error in SQL  Delete_Client_Aircraft_Details_ALL(ByVal cliadet_cliac_id As Integer, ByVal type As String) As Integer " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Update_Client_Aircraft_Engine
  ' Purpose: to Update a clients aircrfaft details
  ' Parameters: aclsClient_Aircraft_Engine
  ' Return: 
  '       integer
  ' Change Log
  '           2/4/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Update_Client_Aircraft_Engine(ByVal aclsClient_Aircraft_Engine As clsClient_Aircraft_Engine) As Integer
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Update_Client_Aircraft_Engine = 0
    Try

      sql = " UPDATE client_aircraft_engine SET cliacep_cliac_id = '" & aclsClient_Aircraft_Engine.cliacep_cliac_id & "' "
      sql = sql & ", cliacep_engine_name = '" & Left(aclsClient_Aircraft_Engine.cliacep_engine_name, 30) & "' "
      sql = sql & ", cliacep_engine_maintenance_program = '" & aclsClient_Aircraft_Engine.cliacep_engine_maintenance_program & "' "
      sql = sql & " , cliacep_engine_management_program = '" & aclsClient_Aircraft_Engine.cliacep_engine_management_program & "' "
      sql = sql & ", cliacep_engine_tbo_oc_flag = '" & Left(aclsClient_Aircraft_Engine.cliacep_engine_tbo_oc_flag, 1) & "' "

      If Not IsDBNull(aclsClient_Aircraft_Engine.cliacep_engine_noise_rating) Then
        If IsNumeric(aclsClient_Aircraft_Engine.cliacep_engine_noise_rating) Then
          sql = sql & ", cliacep_engine_noise_rating = '" & aclsClient_Aircraft_Engine.cliacep_engine_noise_rating & "' "
        Else
          sql = sql & ", cliacep_engine_noise_rating = NULL "
        End If
      Else
        sql = sql & ", cliacep_engine_noise_rating = NULL "
      End If


      sql = sql & " , cliacep_engine_model_config = '" & Left(aclsClient_Aircraft_Engine.cliacep_engine_model_config, 4) & "' "
      sql = sql & ", cliacep_engine_overhaul_done_by_name = '" & Left(aclsClient_Aircraft_Engine.cliacep_engine_overhaul_done_by_name, 50) & "' "

      If (aclsClient_Aircraft_Engine.cliacep_engine_overhaul_done_month_year <> "") Then
        sql = sql & ", cliacep_engine_overhaul_done_month_year = '" & aclsClient_Aircraft_Engine.cliacep_engine_overhaul_done_month_year & "' "
      Else
        sql = sql & ", cliacep_engine_overhaul_done_month_year = NULL "
      End If


      sql = sql & " , cliacep_engine_hot_inspection_done_by_name = '" & Left(aclsClient_Aircraft_Engine.cliacep_engine_hot_inspection_done_by_name, 50) & "' "


      If (aclsClient_Aircraft_Engine.cliacep_engine_hot_inspection_done_month_year <> "") Then
        sql = sql & " , cliacep_engine_hot_inspection_done_month_year = '" & aclsClient_Aircraft_Engine.cliacep_engine_hot_inspection_done_month_year & "' "
      Else
        sql = sql & " , cliacep_engine_hot_inspection_done_month_year = NULL "

      End If


      sql = sql & ", cliacep_engine_1_ser_nbr = '" & Left(aclsClient_Aircraft_Engine.cliacep_engine_1_ser_nbr, 14) & "' "
      sql = sql & " , cliacep_engine_2_ser_nbr = '" & Left(aclsClient_Aircraft_Engine.cliacep_engine_2_ser_nbr, 14) & "' "
      sql = sql & " , cliacep_engine_3_ser_nbr = '" & Left(aclsClient_Aircraft_Engine.cliacep_engine_3_ser_nbr, 14) & "' "
      sql = sql & " , cliacep_engine_4_ser_nbr = '" & Left(aclsClient_Aircraft_Engine.cliacep_engine_4_ser_nbr, 14) & "' "

      If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_1_ttsn_hours) Then
        sql = sql & " , cliacep_engine_1_ttsn_hours = '" & aclsClient_Aircraft_Engine.cliacep_engine_1_ttsn_hours & "' "
      Else
        sql = sql & " , cliacep_engine_1_ttsn_hours = NULL "
      End If

      If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_2_ttsn_hours) Then
        sql = sql & " , cliacep_engine_2_ttsn_hours = '" & aclsClient_Aircraft_Engine.cliacep_engine_2_ttsn_hours & "' "
      Else
        sql = sql & " , cliacep_engine_2_ttsn_hours = NULL "
      End If


      If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_3_ttsn_hours) Then
        sql = sql & " , cliacep_engine_3_ttsn_hours = '" & aclsClient_Aircraft_Engine.cliacep_engine_3_ttsn_hours & "' "
      Else
        sql = sql & " , cliacep_engine_3_ttsn_hours = NULL "
      End If


      If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_4_ttsn_hours) Then
        sql = sql & " , cliacep_engine_4_ttsn_hours = '" & aclsClient_Aircraft_Engine.cliacep_engine_4_ttsn_hours & "' "
      Else
        sql = sql & " , cliacep_engine_4_ttsn_hours = NULL "
      End If

      If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_1_tsoh_hours) Then
        sql = sql & " , cliacep_engine_1_tsoh_hours = '" & aclsClient_Aircraft_Engine.cliacep_engine_1_tsoh_hours & "' "
      Else
        sql = sql & " , cliacep_engine_1_tsoh_hours = NULL "
      End If


      If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_2_tsoh_hours) Then
        sql = sql & " , cliacep_engine_2_tsoh_hours = '" & aclsClient_Aircraft_Engine.cliacep_engine_2_tsoh_hours & "' "
      Else
        sql = sql & " , cliacep_engine_2_tsoh_hours = NULL "
      End If

      If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_3_tsoh_hours) Then
        sql = sql & " , cliacep_engine_3_tsoh_hours = '" & aclsClient_Aircraft_Engine.cliacep_engine_3_tsoh_hours & "' "
      Else
        sql = sql & " , cliacep_engine_3_tsoh_hours = NULL "
      End If

      If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_4_tsoh_hours) Then
        sql = sql & " , cliacep_engine_4_tsoh_hours = '" & aclsClient_Aircraft_Engine.cliacep_engine_4_tsoh_hours & "' "
      Else
        sql = sql & " , cliacep_engine_4_tsoh_hours = NULL "
      End If


      If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_1_tshi_hours) Then
        sql = sql & " , cliacep_engine_1_tshi_hours = '" & aclsClient_Aircraft_Engine.cliacep_engine_1_tshi_hours & "' "
      Else
        sql = sql & " , cliacep_engine_1_tshi_hours = NULL "
      End If

      If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_2_tshi_hours) Then
        sql = sql & " , cliacep_engine_2_tshi_hours = '" & aclsClient_Aircraft_Engine.cliacep_engine_2_tshi_hours & "' "
      Else
        sql = sql & " , cliacep_engine_2_tshi_hours = NULL "
      End If

      If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_3_tshi_hours) Then
        sql = sql & " , cliacep_engine_3_tshi_hours = '" & aclsClient_Aircraft_Engine.cliacep_engine_3_tshi_hours & "' "
      Else
        sql = sql & " , cliacep_engine_3_tshi_hours = NULL "
      End If
      If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_4_tshi_hours) Then
        sql = sql & " , cliacep_engine_4_tshi_hours = '" & aclsClient_Aircraft_Engine.cliacep_engine_4_tshi_hours & "' "
      Else
        sql = sql & " , cliacep_engine_4_tshi_hours = NULL "
      End If


      If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_1_tbo_hours) Then
        sql = sql & " , cliacep_engine_1_tbo_hours = '" & aclsClient_Aircraft_Engine.cliacep_engine_1_tbo_hours & "' "
      Else
        sql = sql & " , cliacep_engine_1_tbo_hours = NULL "
      End If

      If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_2_tbo_hours) Then
        sql = sql & " , cliacep_engine_2_tbo_hours = '" & aclsClient_Aircraft_Engine.cliacep_engine_2_tbo_hours & "' "
      Else
        sql = sql & " , cliacep_engine_2_tbo_hours = NULL "
      End If

      If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_3_tbo_hours) Then
        sql = sql & " , cliacep_engine_3_tbo_hours = '" & aclsClient_Aircraft_Engine.cliacep_engine_3_tbo_hours & "' "
      Else
        sql = sql & " , cliacep_engine_3_tbo_hours = NULL "
      End If
      If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_4_tbo_hours) Then
        sql = sql & " , cliacep_engine_4_tbo_hours = '" & aclsClient_Aircraft_Engine.cliacep_engine_4_tbo_hours & "' "
      Else
        sql = sql & " , cliacep_engine_4_tbo_hours = NULL "
      End If

      If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_1_tsn_cycle) Then
        sql = sql & " , cliacep_engine_1_tsn_cycle = '" & aclsClient_Aircraft_Engine.cliacep_engine_1_tsn_cycle & "' "
      Else
        sql = sql & " , cliacep_engine_1_tsn_cycle = NULL "
      End If

      If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_2_tsn_cycle) Then
        sql = sql & " , cliacep_engine_2_tsn_cycle = '" & aclsClient_Aircraft_Engine.cliacep_engine_2_tsn_cycle & "' "
      Else
        sql = sql & " , cliacep_engine_2_tsn_cycle = NULL "
      End If
      If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_3_tsn_cycle) Then
        sql = sql & " , cliacep_engine_3_tsn_cycle = '" & aclsClient_Aircraft_Engine.cliacep_engine_3_tsn_cycle & "' "
      Else
        sql = sql & " , cliacep_engine_3_tsn_cycle = NULL "
      End If
      If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_4_tsn_cycle) Then
        sql = sql & " , cliacep_engine_4_tsn_cycle = '" & aclsClient_Aircraft_Engine.cliacep_engine_4_tsn_cycle & "' "
      Else
        sql = sql & " , cliacep_engine_4_tsn_cycle = NULL "
      End If

      If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_1_tsoh_cycle) Then
        sql = sql & " , cliacep_engine_1_tsoh_cycle = '" & aclsClient_Aircraft_Engine.cliacep_engine_1_tsoh_cycle & "' "
      Else
        sql = sql & " , cliacep_engine_1_tsoh_cycle = NULL "
      End If

      If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_2_tsoh_cycle) Then
        sql = sql & " , cliacep_engine_2_tsoh_cycle = '" & aclsClient_Aircraft_Engine.cliacep_engine_2_tsoh_cycle & "' "
      Else
        sql = sql & " , cliacep_engine_2_tsoh_cycle = NULL "
      End If

      If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_3_tsoh_cycle) Then
        sql = sql & " , cliacep_engine_3_tsoh_cycle = '" & aclsClient_Aircraft_Engine.cliacep_engine_3_tsoh_cycle & "' "
      Else
        sql = sql & " , cliacep_engine_3_tsoh_cycle = NULL "
      End If

      If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_4_tsoh_cycle) Then
        sql = sql & " , cliacep_engine_4_tsoh_cycle = '" & aclsClient_Aircraft_Engine.cliacep_engine_4_tsoh_cycle & "' "
      Else
        sql = sql & " , cliacep_engine_4_tsoh_cycle = NULL "
      End If

      If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_1_tshi_cycle) Then
        sql = sql & " , cliacep_engine_1_tshi_cycle = '" & aclsClient_Aircraft_Engine.cliacep_engine_1_tshi_cycle & "' "
      Else
        sql = sql & " , cliacep_engine_1_tshi_cycle = NULL "
      End If

      If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_2_tshi_cycle) Then
        sql = sql & " , cliacep_engine_2_tshi_cycle = '" & aclsClient_Aircraft_Engine.cliacep_engine_2_tshi_cycle & "' "
      Else
        sql = sql & " , cliacep_engine_2_tshi_cycle = NULL "
      End If
      If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_3_tshi_cycle) Then
        sql = sql & " , cliacep_engine_3_tshi_cycle = '" & aclsClient_Aircraft_Engine.cliacep_engine_3_tshi_cycle & "' "
      Else
        sql = sql & " , cliacep_engine_3_tshi_cycle = NULL "
      End If
      If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_4_tshi_cycle) Then
        sql = sql & " , cliacep_engine_4_tshi_cycle = '" & aclsClient_Aircraft_Engine.cliacep_engine_4_tshi_cycle & "' "
      Else
        sql = sql & " , cliacep_engine_4_tshi_cycle = NULL "
      End If


      sql = sql & " WHERE ((cliacep_cliac_id = '" & aclsClient_Aircraft_Engine.cliacep_cliac_id & "' )) limit 1 "


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Update_Client_Aircraft_Engine(ByVal aclsClient_Aircraft_Engine As clsClient_Aircraft_Engine) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Update_Client_Aircraft_Engine = 1
    Catch ex As Exception
      Update_Client_Aircraft_Engine = 0
      Me.class_error = "Error in SQL Update_Client_Aircraft_Engine(ByVal aclsClient_Aircraft_Engine As clsClient_Aircraft_Engine) As Integer  " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Insert_Client_Aircraft_Engine
  ' Purpose: to insert a clients aircrfaft details
  ' Parameters: aclsClient_Aircraft_Engine
  ' Return: 
  '       integer
  ' Change Log
  '           2/4/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Insert_Client_Aircraft_Engine(ByVal aclsClient_Aircraft_Engine As clsClient_Aircraft_Engine) As Integer
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Insert_Client_Aircraft_Engine = 0
    Try

      sql = "INSERT INTO client_aircraft_engine (cliacep_cliac_id, cliacep_engine_name, cliacep_engine_maintenance_program, cliacep_engine_management_program, cliacep_engine_tbo_oc_flag, cliacep_engine_noise_rating, cliacep_engine_model_config, cliacep_engine_overhaul_done_by_name, cliacep_engine_overhaul_done_month_year, cliacep_engine_hot_inspection_done_by_name, cliacep_engine_hot_inspection_done_month_year, cliacep_engine_1_ser_nbr, cliacep_engine_2_ser_nbr, cliacep_engine_3_ser_nbr, cliacep_engine_4_ser_nbr, cliacep_engine_1_ttsn_hours, cliacep_engine_2_ttsn_hours, cliacep_engine_3_ttsn_hours, cliacep_engine_4_ttsn_hours, cliacep_engine_1_tsoh_hours, cliacep_engine_2_tsoh_hours, cliacep_engine_3_tsoh_hours, cliacep_engine_4_tsoh_hours, cliacep_engine_1_tshi_hours, cliacep_engine_2_tshi_hours, cliacep_engine_3_tshi_hours, cliacep_engine_4_tshi_hours, cliacep_engine_1_tbo_hours, cliacep_engine_2_tbo_hours, cliacep_engine_3_tbo_hours, cliacep_engine_4_tbo_hours, cliacep_engine_1_tsn_cycle, cliacep_engine_2_tsn_cycle, cliacep_engine_3_tsn_cycle, cliacep_engine_4_tsn_cycle, cliacep_engine_1_tsoh_cycle, cliacep_engine_2_tsoh_cycle, cliacep_engine_3_tsoh_cycle, cliacep_engine_4_tsoh_cycle, cliacep_engine_1_tshi_cycle, cliacep_engine_2_tshi_cycle, cliacep_engine_3_tshi_cycle, cliacep_engine_4_tshi_cycle) "
      sql = sql & " VALUES ('" & aclsClient_Aircraft_Engine.cliacep_cliac_id & "', "
      sql = sql & " '" & Left(aclsClient_Aircraft_Engine.cliacep_engine_name, 30) & "', "
      sql = sql & " '" & aclsClient_Aircraft_Engine.cliacep_engine_maintenance_program & "', "
      sql = sql & " '" & aclsClient_Aircraft_Engine.cliacep_engine_management_program & "', "
      sql = sql & " '" & Left(aclsClient_Aircraft_Engine.cliacep_engine_tbo_oc_flag, 1) & "', "


      If Not IsDBNull(aclsClient_Aircraft_Engine.cliacep_engine_noise_rating) Then
        If IsNumeric(aclsClient_Aircraft_Engine.cliacep_engine_noise_rating) Then
          sql = sql & " '" & aclsClient_Aircraft_Engine.cliacep_engine_noise_rating & "', "
        Else
          sql = sql & " NULL, "
        End If
      Else
        sql = sql & " NULL, "
      End If

      sql = sql & " '" & Left(aclsClient_Aircraft_Engine.cliacep_engine_model_config, 4) & "', "

      sql = sql & " '" & Left(aclsClient_Aircraft_Engine.cliacep_engine_overhaul_done_by_name, 50) & "', "



      If (aclsClient_Aircraft_Engine.cliacep_engine_overhaul_done_month_year <> "") Then
        sql = sql & " '" & aclsClient_Aircraft_Engine.cliacep_engine_overhaul_done_month_year & "', "
      Else
        sql = sql & " '" & aclsClient_Aircraft_Engine.cliacep_engine_overhaul_done_month_year & "', "
      End If

      sql = sql & " '" & Left(aclsClient_Aircraft_Engine.cliacep_engine_hot_inspection_done_by_name, 50) & "', "

      If (aclsClient_Aircraft_Engine.cliacep_engine_hot_inspection_done_month_year <> "") Then
        sql = sql & " '" & aclsClient_Aircraft_Engine.cliacep_engine_hot_inspection_done_month_year & "', "
      Else
        sql = sql & " '" & aclsClient_Aircraft_Engine.cliacep_engine_hot_inspection_done_month_year & "', "
      End If

      sql = sql & " '" & Left(aclsClient_Aircraft_Engine.cliacep_engine_1_ser_nbr, 14) & "', "
      sql = sql & " '" & Left(aclsClient_Aircraft_Engine.cliacep_engine_2_ser_nbr, 14) & "', "
      sql = sql & " '" & Left(aclsClient_Aircraft_Engine.cliacep_engine_3_ser_nbr, 14) & "', "
      sql = sql & " '" & Left(aclsClient_Aircraft_Engine.cliacep_engine_4_ser_nbr, 14) & "', "

      If Not (IsDBNull(aclsClient_Aircraft_Engine.cliacep_engine_1_ttsn_hours)) Then
        If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_1_ttsn_hours) Then
          sql = sql & " '" & aclsClient_Aircraft_Engine.cliacep_engine_1_ttsn_hours & "', "
        Else
          sql = sql & " NULL, "
        End If
      Else
        sql = sql & " NULL, "
      End If


      If Not (IsDBNull(aclsClient_Aircraft_Engine.cliacep_engine_2_ttsn_hours)) Then
        If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_2_ttsn_hours) Then
          sql = sql & " '" & aclsClient_Aircraft_Engine.cliacep_engine_2_ttsn_hours & "', "
        Else
          sql = sql & " NULL, "
        End If
      Else
        sql = sql & " NULL, "
      End If

      If Not (IsDBNull(aclsClient_Aircraft_Engine.cliacep_engine_3_ttsn_hours)) Then
        If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_3_ttsn_hours) Then
          sql = sql & " '" & aclsClient_Aircraft_Engine.cliacep_engine_3_ttsn_hours & "', "
        Else
          sql = sql & " NULL, "
        End If
      Else
        sql = sql & " NULL, "
      End If

      If Not (IsDBNull(aclsClient_Aircraft_Engine.cliacep_engine_4_ttsn_hours)) Then
        If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_4_ttsn_hours) Then
          sql = sql & " '" & aclsClient_Aircraft_Engine.cliacep_engine_4_ttsn_hours & "', "
        Else
          sql = sql & " NULL, "
        End If
      Else
        sql = sql & " NULL, "
      End If

      If Not (IsDBNull(aclsClient_Aircraft_Engine.cliacep_engine_1_tsoh_hours)) Then
        If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_1_tsoh_hours) Then
          sql = sql & " '" & aclsClient_Aircraft_Engine.cliacep_engine_1_tsoh_hours & "', "
        Else
          sql = sql & " NULL, "
        End If
      Else
        sql = sql & " NULL, "
      End If

      If Not (IsDBNull(aclsClient_Aircraft_Engine.cliacep_engine_2_tsoh_hours)) Then
        If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_2_tsoh_hours) Then
          sql = sql & " '" & aclsClient_Aircraft_Engine.cliacep_engine_2_tsoh_hours & "', "
        Else
          sql = sql & " NULL, "
        End If
      Else
        sql = sql & " NULL, "
      End If

      If Not (IsDBNull(aclsClient_Aircraft_Engine.cliacep_engine_3_tsoh_hours)) Then
        If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_3_tsoh_hours) Then
          sql = sql & " '" & aclsClient_Aircraft_Engine.cliacep_engine_3_tsoh_hours & "', "
        Else
          sql = sql & " NULL, "
        End If
      Else
        sql = sql & " NULL, "
      End If

      If Not (IsDBNull(aclsClient_Aircraft_Engine.cliacep_engine_4_tsoh_hours)) Then
        If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_4_tsoh_hours) Then
          sql = sql & " '" & aclsClient_Aircraft_Engine.cliacep_engine_4_tsoh_hours & "', "
        Else
          sql = sql & " NULL, "
        End If
      Else
        sql = sql & " NULL, "
      End If

      If Not (IsDBNull(aclsClient_Aircraft_Engine.cliacep_engine_1_tshi_hours)) Then
        If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_1_tshi_hours) Then
          sql = sql & " '" & aclsClient_Aircraft_Engine.cliacep_engine_1_tshi_hours & "', "
        Else
          sql = sql & " NULL, "
        End If
      Else
        sql = sql & " NULL, "
      End If

      If Not (IsDBNull(aclsClient_Aircraft_Engine.cliacep_engine_2_tshi_hours)) Then
        If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_2_tshi_hours) Then
          sql = sql & " '" & aclsClient_Aircraft_Engine.cliacep_engine_2_tshi_hours & "', "
        Else
          sql = sql & " NULL, "
        End If
      Else
        sql = sql & " NULL, "
      End If

      If Not (IsDBNull(aclsClient_Aircraft_Engine.cliacep_engine_3_tshi_hours)) Then
        If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_3_tshi_hours) Then
          sql = sql & " '" & aclsClient_Aircraft_Engine.cliacep_engine_3_tshi_hours & "', "
        Else
          sql = sql & " NULL, "
        End If
      Else
        sql = sql & " NULL, "
      End If

      If Not (IsDBNull(aclsClient_Aircraft_Engine.cliacep_engine_4_tshi_hours)) Then
        If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_4_tshi_hours) Then
          sql = sql & " '" & aclsClient_Aircraft_Engine.cliacep_engine_4_tshi_hours & "', "
        Else
          sql = sql & " NULL, "
        End If
      Else
        sql = sql & " NULL, "
      End If


      If Not (IsDBNull(aclsClient_Aircraft_Engine.cliacep_engine_1_tbo_hours)) Then
        If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_1_tbo_hours) Then
          sql = sql & " '" & aclsClient_Aircraft_Engine.cliacep_engine_1_tbo_hours & "', "
        Else
          sql = sql & " NULL, "
        End If
      Else
        sql = sql & " NULL, "
      End If

      If Not (IsDBNull(aclsClient_Aircraft_Engine.cliacep_engine_2_tbo_hours)) Then
        If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_2_tbo_hours) Then
          sql = sql & " '" & aclsClient_Aircraft_Engine.cliacep_engine_2_tbo_hours & "', "
        Else
          sql = sql & " NULL, "
        End If
      Else
        sql = sql & " NULL, "
      End If

      If Not (IsDBNull(aclsClient_Aircraft_Engine.cliacep_engine_3_tbo_hours)) Then
        If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_3_tbo_hours) Then
          sql = sql & " '" & aclsClient_Aircraft_Engine.cliacep_engine_3_tbo_hours & "', "
        Else
          sql = sql & " NULL, "
        End If
      Else
        sql = sql & " NULL, "
      End If

      If Not (IsDBNull(aclsClient_Aircraft_Engine.cliacep_engine_4_tbo_hours)) Then
        If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_4_tbo_hours) Then
          sql = sql & " '" & aclsClient_Aircraft_Engine.cliacep_engine_4_tbo_hours & "', "
        Else
          sql = sql & " NULL, "
        End If
      Else
        sql = sql & " NULL, "
      End If


      If Not (IsDBNull(aclsClient_Aircraft_Engine.cliacep_engine_1_tsn_cycle)) Then
        If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_1_tsn_cycle) Then
          sql = sql & " '" & aclsClient_Aircraft_Engine.cliacep_engine_1_tsn_cycle & "', "
        Else
          sql = sql & " NULL, "
        End If
      Else
        sql = sql & " NULL, "
      End If


      If Not (IsDBNull(aclsClient_Aircraft_Engine.cliacep_engine_2_tsn_cycle)) Then
        If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_2_tsn_cycle) Then
          sql = sql & " '" & aclsClient_Aircraft_Engine.cliacep_engine_2_tsn_cycle & "', "
        Else
          sql = sql & " NULL, "
        End If
      Else
        sql = sql & " NULL, "
      End If

      If Not (IsDBNull(aclsClient_Aircraft_Engine.cliacep_engine_3_tsn_cycle)) Then
        If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_3_tsn_cycle) Then
          sql = sql & " '" & aclsClient_Aircraft_Engine.cliacep_engine_3_tsn_cycle & "', "
        Else
          sql = sql & " NULL, "
        End If
      Else
        sql = sql & " NULL, "
      End If

      If Not (IsDBNull(aclsClient_Aircraft_Engine.cliacep_engine_4_tsn_cycle)) Then
        If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_4_tsn_cycle) Then
          sql = sql & " '" & aclsClient_Aircraft_Engine.cliacep_engine_4_tsn_cycle & "', "
        Else
          sql = sql & " NULL, "
        End If
      Else
        sql = sql & " NULL, "
      End If

      If Not (IsDBNull(aclsClient_Aircraft_Engine.cliacep_engine_1_tsoh_cycle)) Then
        If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_1_tsoh_cycle) Then
          sql = sql & " '" & aclsClient_Aircraft_Engine.cliacep_engine_1_tsoh_cycle & "', "
        Else
          sql = sql & " NULL, "
        End If
      Else
        sql = sql & " NULL, "
      End If

      If Not (IsDBNull(aclsClient_Aircraft_Engine.cliacep_engine_2_tsoh_cycle)) Then
        If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_2_tsoh_cycle) Then
          sql = sql & " '" & aclsClient_Aircraft_Engine.cliacep_engine_2_tsoh_cycle & "', "
        Else
          sql = sql & " NULL, "
        End If
      Else
        sql = sql & " NULL, "
      End If

      If Not (IsDBNull(aclsClient_Aircraft_Engine.cliacep_engine_3_tsoh_cycle)) Then
        If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_3_tsoh_cycle) Then
          sql = sql & " '" & aclsClient_Aircraft_Engine.cliacep_engine_3_tsoh_cycle & "', "
        Else
          sql = sql & " NULL, "
        End If
      Else
        sql = sql & " NULL, "
      End If

      If Not (IsDBNull(aclsClient_Aircraft_Engine.cliacep_engine_4_tsoh_cycle)) Then
        If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_3_tsoh_cycle) Then
          sql = sql & " '" & aclsClient_Aircraft_Engine.cliacep_engine_4_tsoh_cycle & "', "
        Else
          sql = sql & " NULL, "
        End If
      Else
        sql = sql & " NULL, "
      End If

      If Not (IsDBNull(aclsClient_Aircraft_Engine.cliacep_engine_1_tshi_cycle)) Then
        If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_1_tshi_cycle) Then
          sql = sql & " '" & aclsClient_Aircraft_Engine.cliacep_engine_1_tshi_cycle & "', "
        Else
          sql = sql & " NULL, "
        End If
      Else
        sql = sql & " NULL, "
      End If


      If Not (IsDBNull(aclsClient_Aircraft_Engine.cliacep_engine_2_tshi_cycle)) Then
        If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_2_tshi_cycle) Then
          sql = sql & " '" & aclsClient_Aircraft_Engine.cliacep_engine_2_tshi_cycle & "', "
        Else
          sql = sql & " NULL, "
        End If
      Else
        sql = sql & " NULL, "
      End If

      If Not (IsDBNull(aclsClient_Aircraft_Engine.cliacep_engine_3_tshi_cycle)) Then
        If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_3_tshi_cycle) Then
          sql = sql & " '" & aclsClient_Aircraft_Engine.cliacep_engine_3_tshi_cycle & "', "
        Else
          sql = sql & " NULL, "
        End If
      Else
        sql = sql & " NULL, "
      End If

      If Not (IsDBNull(aclsClient_Aircraft_Engine.cliacep_engine_4_tshi_cycle)) Then
        If Not IsNothing(aclsClient_Aircraft_Engine.cliacep_engine_4_tshi_cycle) Then
          sql = sql & " '" & aclsClient_Aircraft_Engine.cliacep_engine_4_tshi_cycle & "') "
        Else
          sql = sql & " NULL) "
        End If
      Else
        sql = sql & " NULL, "
      End If

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Insert_Client_Aircraft_Engine(ByVal aclsClient_Aircraft_Engine As clsClient_Aircraft_Engine) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Insert_Client_Aircraft_Engine = 1
    Catch ex As Exception
      Insert_Client_Aircraft_Engine = 0
      Me.class_error = "Error in SQL Insert_Client_Aircraft_Engine(ByVal aclsClient_Aircraft_Engine As clsClient_Aircraft_Engine) As Integer  " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Update_Client_Aircraft_Details
  ' Purpose: to udpate a clients aircrfaft details
  ' Parameters: cliadet_id, cliadet_cliac_id, cliadet_data_type, cliadet_data_name, cliadet_data_description, cliadet_action_date
  ' Return: 
  '       integer
  ' Change Log
  '          2/4/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Update_Client_Aircraft_Details(ByVal cliadet_id As Integer, ByVal cliadet_cliac_id As Integer, ByVal cliadet_data_type As String, ByVal cliadet_data_name As String, ByVal cliadet_data_description As String, ByVal cliadet_action_date As String) As Integer

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Update_Client_Aircraft_Details = 0
    Try

      sql = "UPDATE client_aircraft_details SET cliadet_id = " & cliadet_id
      sql = sql & ", cliadet_cliac_id = " & cliadet_cliac_id
      sql = sql & " , cliadet_data_type = '" & cliadet_data_type & "' "
      sql = sql & ", cliadet_data_name = '" & cliadet_data_name & "' "
      sql = sql & " , cliadet_data_description = '" & Replace(cliadet_data_description, "'", "''") & "' "
      sql = sql & " , cliadet_action_date = '" & Format(CDate(cliadet_action_date), "yyyy-MM-dd HH:mm:ss") & "' "
      sql = sql & " WHERE ((cliadet_id = " & cliadet_id & " ) AND (cliadet_cliac_id = '" & cliadet_cliac_id & "' ))"
      sql = sql & " limit 1 "

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Update_Client_Aircraft_Details(ByVal cliadet_id As Integer, ByVal cliadet_cliac_id As Integer, ByVal cliadet_data_type As String, ByVal cliadet_data_name As String, ByVal cliadet_data_description As String, ByVal cliadet_action_date As String) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Update_Client_Aircraft_Details = 1
    Catch ex As Exception
      Update_Client_Aircraft_Details = 0
      Me.class_error = "Error in SQL  Update_Client_Aircraft_Details(ByVal cliadet_id As Integer, ByVal cliadet_cliac_id As Integer, ByVal cliadet_data_type As String, ByVal cliadet_data_name As String, ByVal cliadet_data_description As String, ByVal cliadet_action_date As String) As Integer " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Delete_Client_Aircraft_Details
  ' Purpose: to delete a clients aircrfaft details
  ' Parameters: cliadet_id, cliadet_cliac_id
  ' Return: 
  '       integer
  ' Change Log
  '           2/4/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Delete_Client_Aircraft_Details(ByVal cliadet_id As Integer, ByVal cliadet_cliac_id As Integer) As Integer

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Delete_Client_Aircraft_Details = 0
    Try

      sql = "DELETE FROM client_aircraft_details WHERE ((cliadet_id = '" & cliadet_id & "') AND (cliadet_cliac_id = '" & cliadet_cliac_id & "')) limit 1"


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Delete_Client_Aircraft_Details(ByVal cliadet_id As Integer, ByVal cliadet_cliac_id As Integer) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Delete_Client_Aircraft_Details = 1
    Catch ex As Exception
      Delete_Client_Aircraft_Details = 0
      Me.class_error = "Error in SQL  Delete_Client_Aircraft_Details(ByVal cliadet_id As Integer, ByVal cliadet_cliac_id As Integer) As Integer " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Insert_Client_Aircraft_Details
  ' Purpose: to insert a clients aircrfaft details
  ' Parameters: cliadet_id, cliadet_cliac_id, cliadet_data_type, cliadet_data_name, cliadet_data_description, cliadet_action_date
  ' Return: 
  '       integer
  ' Change Log
  '           2/4/2012   - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Insert_Client_Aircraft_Details(ByVal cliadet_cliac_id As Integer, ByVal cliadet_data_type As String, ByVal cliadet_data_name As String, ByVal cliadet_data_description As String, ByVal cliadet_action_date As String) As Integer

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Insert_Client_Aircraft_Details = 0
    Try

      sql = "INSERT INTO client_aircraft_details (cliadet_cliac_id, cliadet_data_type, cliadet_data_name, cliadet_data_description, cliadet_action_date) VALUES (" & cliadet_cliac_id & ", '" & Escape_Single_Quote(cliadet_data_type) & "', '" & Escape_Single_Quote(cliadet_data_name) & "', '" & Escape_Single_Quote(cliadet_data_description) & "', '" & Format(CDate(cliadet_action_date), "yyyy-MM-dd HH:mm:ss") & "')"


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Insert_Client_Aircraft_Details(ByVal cliadet_id As Integer, ByVal cliadet_cliac_id As Integer, ByVal cliadet_data_type As String, ByVal cliadet_data_name As String, ByVal cliadet_data_description As String, ByVal cliadet_action_date As String) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Insert_Client_Aircraft_Details = 1
    Catch ex As Exception
      Insert_Client_Aircraft_Details = 0
      Me.class_error = "Error in SQL  Insert_Client_Aircraft_Details(ByVal cliadet_id As Integer, ByVal cliadet_cliac_id As Integer, ByVal cliadet_data_type As String, ByVal cliadet_data_name As String, ByVal cliadet_data_description As String, ByVal cliadet_action_date As String) As Integer " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Delete_Client_Aircraft_Key_Features
  ' Purpose: to update a clients aircrfaft propeller
  ' Parameters: cliacpr_cliac_id
  ' Return: 
  '       integer
  ' Change Log
  '           2/4/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Delete_Client_Aircraft_Key_Features(ByVal cliafeat_cliac_id As Integer, ByVal cliafeat_type As String) As Integer

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Delete_Client_Aircraft_Key_Features = 0
    Try

      sql = "DELETE FROM client_aircraft_key_features WHERE ((cliafeat_cliac_id = '" & cliafeat_cliac_id & "') AND (cliafeat_type = '" & cliafeat_type & "')) limit 1"


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Delete_Client_Aircraft_Key_Features(ByVal cliafeat_cliac_id As Integer, ByVal cliafeat_type As String) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Delete_Client_Aircraft_Key_Features = 1
    Catch ex As Exception
      Delete_Client_Aircraft_Key_Features = 0
      Me.class_error = "Error in SQL  Delete_Client_Aircraft_Key_Features(ByVal cliafeat_cliac_id As Integer, ByVal cliafeat_type As String) As Integer " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Update_Client_Aircraft_Key_Features
  ' Purpose: to update a clients aircrfaft propeller
  ' Parameters: cliacpr_cliac_id
  ' Return: 
  '       integer
  ' Change Log
  '           2/4/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Update_Client_Aircraft_Key_Features(ByVal cliafeat_cliac_id As Integer, ByVal cliafeat_type As String, ByVal cliafeat_flag As String, ByVal cliafeat_seq_nbr As Integer, ByVal Org_cliafeat_type As String, ByVal Org_cliafeat_cliac_id As Integer) As Integer

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Update_Client_Aircraft_Key_Features = 0
    Try

      sql = "UPDATE client_aircraft_key_features SET cliafeat_cliac_id = '" & cliafeat_cliac_id & "', cliafeat_type = '" & cliafeat_type & "', "
      sql = sql & " cliafeat_flag = '" & cliafeat_flag & "', cliafeat_seq_nbr = '" & cliafeat_seq_nbr & "' WHERE "
      sql = sql & " ((cliafeat_cliac_id = '" & cliafeat_cliac_id & "') AND (cliafeat_type = '" & cliafeat_type & "')) limit 1"


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Update_Client_Aircraft_Key_Features(ByVal cliafeat_cliac_id As Integer, ByVal cliafeat_type As String, ByVal cliafeat_flag As String, ByVal cliafeat_seq_nbr As Integer, ByVal Org_cliafeat_type As String, ByVal Org_cliafeat_cliac_id As Integer) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Update_Client_Aircraft_Key_Features = 1
    Catch ex As Exception
      Update_Client_Aircraft_Key_Features = 0
      Me.class_error = "Error in SQL  Update_Client_Aircraft_Key_Features(ByVal cliafeat_cliac_id As Integer, ByVal cliafeat_type As String, ByVal cliafeat_flag As String, ByVal cliafeat_seq_nbr As Integer, ByVal Org_cliafeat_type As String, ByVal Org_cliafeat_cliac_id As Integer) As Integer " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Insert_Client_Aircraft_Key_Features
  ' Purpose: to update a clients aircrfaft propeller
  ' Parameters: cliacpr_cliac_id
  ' Return: 
  '       integer
  ' Change Log
  '           2/4/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Insert_Client_Aircraft_Key_Features(ByVal cliafeat_cliac_id As Integer, ByVal cliafeat_type As String, ByVal cliafeat_flag As String, ByVal cliafeat_seq_nbr As Integer) As Integer

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Insert_Client_Aircraft_Key_Features = 0
    Try

      sql = "INSERT INTO client_aircraft_key_features (cliafeat_cliac_id, cliafeat_type, cliafeat_flag, cliafeat_seq_nbr) VALUES ('" & cliafeat_cliac_id & "', '" & cliafeat_type & "', '" & cliafeat_flag & "', '" & cliafeat_seq_nbr & "')"


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Insert_Client_Aircraft_Key_Features(ByVal cliafeat_cliac_id As Integer, ByVal cliafeat_type As String, ByVal cliafeat_flag As String, ByVal cliafeat_seq_nbr As Integer) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Insert_Client_Aircraft_Key_Features = 1
    Catch ex As Exception
      Insert_Client_Aircraft_Key_Features = 0
      Me.class_error = "Error in SQL Insert_Client_Aircraft_Key_Features(ByVal cliafeat_cliac_id As Integer, ByVal cliafeat_type As String, ByVal cliafeat_flag As String, ByVal cliafeat_seq_nbr As Integer) As Integer " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Update_Client_Aircraft_Propeller
  ' Purpose: to update a clients aircrfaft propeller
  ' Parameters: cliacpr_cliac_id
  ' Return: 
  '       integer
  ' Change Log
  '           2/4/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Update_Client_Aircraft_Propeller(ByVal aclsClient_Aircraft_Propeller As clsClient_Aircraft_Propeller) As Integer

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Update_Client_Aircraft_Propeller = 0
    Try

      sql = "UPDATE client_aircraft_propeller SET cliacpr_cliac_id = '" & aclsClient_Aircraft_Propeller.cliacpr_cliac_id & "', "
      sql = sql & " cliacpr_prop_1_ser_nbr = '" & aclsClient_Aircraft_Propeller.cliacpr_prop_1_ser_nbr & "', "
      sql = sql & " cliacpr_prop_2_ser_nbr = '" & aclsClient_Aircraft_Propeller.cliacpr_prop_2_ser_nbr & "', "
      sql = sql & " cliacpr_prop_3_ser_nbr = '" & aclsClient_Aircraft_Propeller.cliacpr_prop_3_ser_nbr & "', "
      sql = sql & " cliacpr_prop_4_ser_nbr = '" & aclsClient_Aircraft_Propeller.cliacpr_prop_4_ser_nbr & "', "
      sql = sql & " cliacpr_prop_1_ttsn_hours = '" & aclsClient_Aircraft_Propeller.cliacpr_prop_1_ttsn_hours & "', "
      sql = sql & " cliacpr_prop_2_ttsn_hours = '" & aclsClient_Aircraft_Propeller.cliacpr_prop_2_ttsn_hours & "', "
      sql = sql & " cliacpr_prop_3_ttsn_hours = '" & aclsClient_Aircraft_Propeller.cliacpr_prop_3_ttsn_hours & "', "
      sql = sql & " cliacpr_prop_4_ttsn_hours = '" & aclsClient_Aircraft_Propeller.cliacpr_prop_4_ttsn_hours & "', "
      sql = sql & " cliacpr_prop_1_tsoh_hours = '" & aclsClient_Aircraft_Propeller.cliacpr_prop_1_tsoh_hours & "', "
      sql = sql & " cliacpr_prop_2_tsoh_hours = '" & aclsClient_Aircraft_Propeller.cliacpr_prop_2_tsoh_hours & "', "
      sql = sql & " cliacpr_prop_3_tsoh_hours = '" & aclsClient_Aircraft_Propeller.cliacpr_prop_3_tsoh_hours & "', "
      sql = sql & " cliacpr_prop_4_tsoh_hours = '" & aclsClient_Aircraft_Propeller.cliacpr_prop_4_tsoh_hours & "', "
      sql = sql & " cliacpr_prop_1_month_year_oh = '" & aclsClient_Aircraft_Propeller.cliacpr_prop_1_month_year_oh & "', "
      sql = sql & " cliacpr_prop_2_month_year_oh = '" & aclsClient_Aircraft_Propeller.cliacpr_prop_2_month_year_oh & "', "
      sql = sql & " cliacpr_prop_3_month_year_oh = '" & aclsClient_Aircraft_Propeller.cliacpr_prop_3_month_year_oh & "', "
      sql = sql & " cliacpr_prop_4_month_year_oh = '" & aclsClient_Aircraft_Propeller.cliacpr_prop_4_month_year_oh & "' "
      sql = sql & " WHERE ((cliacpr_cliac_id = '" & aclsClient_Aircraft_Propeller.cliacpr_cliac_id & "')) limit 1"


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Update_Client_Aircraft_Propeller(ByVal aclsClient_Aircraft_Propeller As clsClient_Aircraft_Propeller) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Update_Client_Aircraft_Propeller = 1
    Catch ex As Exception
      Update_Client_Aircraft_Propeller = 0
      Me.class_error = "Error in SQL Update_Client_Aircraft_Propeller(ByVal aclsClient_Aircraft_Propeller As clsClient_Aircraft_Propeller) As Integer " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Insert_Client_Aircraft_Propeller
  ' Purpose: to insert a clients aircrfaft propeller
  ' Parameters: cliacpr_cliac_id
  ' Return: 
  '       integer
  ' Change Log
  '           2/6/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Insert_Client_Aircraft_Propeller(ByVal aclsClient_Aircraft_Propeller As clsClient_Aircraft_Propeller) As Integer

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Insert_Client_Aircraft_Propeller = 0
    Try

      sql = "INSERT INTO client_aircraft_propeller (cliacpr_cliac_id, cliacpr_prop_1_ser_nbr, cliacpr_prop_2_ser_nbr, cliacpr_prop_3_ser_nbr, cliacpr_prop_4_ser_nbr, cliacpr_prop_1_ttsn_hours, cliacpr_prop_2_ttsn_hours, cliacpr_prop_3_ttsn_hours, cliacpr_prop_4_ttsn_hours, cliacpr_prop_1_tsoh_hours, cliacpr_prop_2_tsoh_hours, cliacpr_prop_3_tsoh_hours, cliacpr_prop_4_tsoh_hours, cliacpr_prop_1_month_year_oh, cliacpr_prop_2_month_year_oh, cliacpr_prop_3_month_year_oh, cliacpr_prop_4_month_year_oh) VALUES "
      sql = sql & " ('" & aclsClient_Aircraft_Propeller.cliacpr_cliac_id & "', '" & aclsClient_Aircraft_Propeller.cliacpr_prop_1_ser_nbr & "', '" & aclsClient_Aircraft_Propeller.cliacpr_prop_2_ser_nbr & "', '" & aclsClient_Aircraft_Propeller.cliacpr_prop_3_ser_nbr & "', '" & aclsClient_Aircraft_Propeller.cliacpr_prop_4_ser_nbr & "', '" & aclsClient_Aircraft_Propeller.cliacpr_prop_1_ttsn_hours & "', '" & aclsClient_Aircraft_Propeller.cliacpr_prop_2_ttsn_hours & "', '" & aclsClient_Aircraft_Propeller.cliacpr_prop_3_ttsn_hours & "', '" & aclsClient_Aircraft_Propeller.cliacpr_prop_4_ttsn_hours & "', '" & aclsClient_Aircraft_Propeller.cliacpr_prop_1_tsoh_hours & "', '" & aclsClient_Aircraft_Propeller.cliacpr_prop_2_tsoh_hours & "', '" & aclsClient_Aircraft_Propeller.cliacpr_prop_3_tsoh_hours & "', '" & aclsClient_Aircraft_Propeller.cliacpr_prop_4_tsoh_hours & "', '" & aclsClient_Aircraft_Propeller.cliacpr_prop_1_month_year_oh & "', '" & aclsClient_Aircraft_Propeller.cliacpr_prop_2_month_year_oh & "', '" & aclsClient_Aircraft_Propeller.cliacpr_prop_3_month_year_oh & "', '" & aclsClient_Aircraft_Propeller.cliacpr_prop_4_month_year_oh & "')"


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Insert_Client_Aircraft_Propeller(ByVal aclsClient_Aircraft_Propeller As clsClient_Aircraft_Propeller) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Insert_Client_Aircraft_Propeller = 1
    Catch ex As Exception
      Insert_Client_Aircraft_Propeller = 0
      Me.class_error = "Error in SQL Insert_Client_Aircraft_Propeller(ByVal aclsClient_Aircraft_Propeller As clsClient_Aircraft_Propeller) As Integer " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Update_Client_Aircraft
  ' Purpose: to update a client aircraft 
  ' Parameters: clsClient_Aircraft
  ' Return: 
  '       integer
  ' Change Log
  '           2/6/2012    - Created By: Amanda
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Update_Client_Aircraft(ByVal aclsClient_Aircraft As clsClient_Aircraft) As Integer
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Update_Client_Aircraft = 0
    Try
      sql = " UPDATE client_aircraft SET "
      If Not IsDBNull(aclsClient_Aircraft.cliaircraft_broker_price) Then
        If IsNumeric(aclsClient_Aircraft.cliaircraft_broker_price) Then
          sql = sql & " cliaircraft_broker_price = '" & aclsClient_Aircraft.cliaircraft_broker_price & "', "
        Else
          sql = sql & " cliaircraft_broker_price = NULL, "
        End If
      Else
        sql = sql & " cliaircraft_broker_price = NULL, "
      End If

      'Update the custom fields:
      sql = sql & " cliaircraft_custom_1 = '" & Left(Escape_Single_Quote(aclsClient_Aircraft.cliaircraft_custom_1), 500) & "', "
      sql = sql & " cliaircraft_custom_2 = '" & Left(Escape_Single_Quote(aclsClient_Aircraft.cliaircraft_custom_2), 500) & "', "
      sql = sql & " cliaircraft_custom_3 = '" & Left(Escape_Single_Quote(aclsClient_Aircraft.cliaircraft_custom_3), 500) & "', "
      sql = sql & " cliaircraft_custom_4 = '" & Left(Escape_Single_Quote(aclsClient_Aircraft.cliaircraft_custom_4), 500) & "', "
      sql = sql & " cliaircraft_custom_5 = '" & Left(Escape_Single_Quote(aclsClient_Aircraft.cliaircraft_custom_5), 500) & "', "
      sql = sql & " cliaircraft_custom_6 = '" & Left(Escape_Single_Quote(aclsClient_Aircraft.cliaircraft_custom_6), 500) & "', "
      sql = sql & " cliaircraft_custom_7 = '" & Left(Escape_Single_Quote(aclsClient_Aircraft.cliaircraft_custom_7), 500) & "', "
      sql = sql & " cliaircraft_custom_8 = '" & Left(Escape_Single_Quote(aclsClient_Aircraft.cliaircraft_custom_8), 500) & "', "
      sql = sql & " cliaircraft_custom_9 = '" & Left(Escape_Single_Quote(aclsClient_Aircraft.cliaircraft_custom_9), 500) & "', "
      sql = sql & " cliaircraft_custom_10 = '" & Left(Escape_Single_Quote(aclsClient_Aircraft.cliaircraft_custom_10), 500) & "', "

      sql = sql & " cliaircraft_cliamod_id = '" & aclsClient_Aircraft.cliaircraft_cliamod_id & "', "
      sql = sql & " cliaircraft_ser_nbr = '" & Escape_Single_Quote(Left(aclsClient_Aircraft.cliaircraft_ser_nbr, 15)) & "', "
      sql = sql & " cliaircraft_reg_nbr = '" & Escape_Single_Quote(Left(aclsClient_Aircraft.cliaircraft_reg_nbr, 12)) & "', "
      sql = sql & " cliaircraft_year_mfr = '" & Left(aclsClient_Aircraft.cliaircraft_year_mfr, 50) & "', "
      sql = sql & " cliaircraft_forsale_flag = '" & Left(aclsClient_Aircraft.cliaircraft_forsale_flag, 1) & "', "
      sql = sql & " cliaircraft_status = '" & Left(aclsClient_Aircraft.cliaircraft_status, 35) & "', "
      sql = sql & " cliaircraft_exclusive_flag = '" & Left(aclsClient_Aircraft.cliaircraft_exclusive_flag, 1) & "', "
      sql = sql & " cliaircraft_asking_wordage = '" & Escape_Single_Quote(Left(aclsClient_Aircraft.cliaircraft_asking_wordage, 10)) & "', "

      If Not IsDBNull(aclsClient_Aircraft.cliaircraft_asking_price) Then
        If IsNumeric(aclsClient_Aircraft.cliaircraft_asking_price) Then
          sql = sql & " cliaircraft_asking_price = '" & aclsClient_Aircraft.cliaircraft_asking_price & "', "
        Else
          sql = sql & " cliaircraft_asking_price = NULL, "
        End If
      Else
        sql = sql & " cliaircraft_asking_price = NULL, "
      End If
      sql = sql & " cliaircraft_lease_flag = '" & Left(aclsClient_Aircraft.cliaircraft_lease_flag, 1) & "', "
      sql = sql & " cliaircraft_delivery = '" & Left(aclsClient_Aircraft.cliaircraft_delivery, 45) & "', "
      sql = sql & " cliaircraft_user_id = '" & aclsClient_Aircraft.cliaircraft_user_id & "', "
      If Not IsDBNull(aclsClient_Aircraft.cliaircraft_action_date) Then
        If IsDate(aclsClient_Aircraft.cliaircraft_action_date) Then
          sql = sql & " cliaircraft_action_date = '" & Format(CDate(aclsClient_Aircraft.cliaircraft_action_date), "yyyy-MM-dd HH:mm:ss") & "', "
        Else
          sql = sql & " cliaircraft_action_date = NOW(), "
        End If
      Else
        sql = sql & " cliaircraft_action_date = NOW(), "
      End If
      sql = sql & " cliaircraft_jetnet_ac_id = '" & aclsClient_Aircraft.cliaircraft_jetnet_ac_id & "', "
      sql = sql & " cliaircraft_lifecycle = '" & aclsClient_Aircraft.cliaircraft_lifecycle & "', "
      sql = sql & " cliaircraft_ownership = '" & Left(aclsClient_Aircraft.cliaircraft_ownership, 1) & "', "

      sql = sql & " cliaircraft_usage = '" & Left(aclsClient_Aircraft.cliaircraft_usage, 1) & "', "
      sql = sql & " cliaircraft_alt_ser_nbr = '" & Left(aclsClient_Aircraft.cliaircraft_alt_ser_nbr, 20) & "', "
      sql = sql & " cliaircraft_prev_reg_nbr = '" & Left(aclsClient_Aircraft.cliaircraft_prev_reg_nbr, 12) & "', "
      sql = sql & " cliaircraft_country_of_registration = '" & Left(aclsClient_Aircraft.cliaircraft_country_of_registration, 25) & "', "
      sql = sql & " cliaircraft_new_flag = '" & Left(aclsClient_Aircraft.cliaircraft_new_flag, 1) & "', "
      sql = sql & " cliaircraft_year_dlv = '" & Left(aclsClient_Aircraft.cliaircraft_year_dlv, 4) & "', "

      If Not IsDBNull(aclsClient_Aircraft.cliaircraft_date_purchased) Then
        If IsDate(aclsClient_Aircraft.cliaircraft_date_purchased) Then
          sql = sql & " cliaircraft_date_purchased = '" & Format(CDate(aclsClient_Aircraft.cliaircraft_date_purchased), "yyyy-MM-dd HH:mm:ss") & "', "
        Else
          sql = sql & " cliaircraft_date_purchased = NULL, "
        End If
      Else
        sql = sql & " cliaircraft_date_purchased = NULL, "
      End If
      If Not IsDBNull(aclsClient_Aircraft.cliaircraft_date_listed) Then
        If IsDate(aclsClient_Aircraft.cliaircraft_date_listed) Then
          sql = sql & " cliaircraft_date_listed = '" & Format(CDate(aclsClient_Aircraft.cliaircraft_date_listed), "yyyy-MM-dd HH:mm:ss") & "', "
        Else
          sql = sql & " cliaircraft_date_listed = NULL, "
        End If
      Else
        sql = sql & " cliaircraft_date_listed = NULL, "
      End If
      sql = sql & " cliaircraft_airframe_maintenance_program = '" & aclsClient_Aircraft.cliaircraft_airframe_maintenance_program & "', "
      sql = sql & " cliaircraft_airframe_maintenance_tracking_program = '" & aclsClient_Aircraft.cliaircraft_airframe_maintenance_tracking_program & "', "
      If Not IsDBNull(aclsClient_Aircraft.cliaircraft_airframe_total_hours) Then
        If IsNumeric(aclsClient_Aircraft.cliaircraft_airframe_total_hours) Then
          sql = sql & " cliaircraft_airframe_total_hours = '" & aclsClient_Aircraft.cliaircraft_airframe_total_hours & "', "
        Else
          sql = sql & " cliaircraft_airframe_total_hours = NULL, "
        End If
      Else
        sql = sql & " cliaircraft_airframe_total_hours = NULL, "
      End If
      If Not IsDBNull(aclsClient_Aircraft.cliaircraft_airframe_total_landings) Then
        If IsNumeric(aclsClient_Aircraft.cliaircraft_airframe_total_landings) Then
          sql = sql & " cliaircraft_airframe_total_landings = '" & aclsClient_Aircraft.cliaircraft_airframe_total_landings & "', "
        Else
          sql = sql & " cliaircraft_airframe_total_landings = NULL, "
        End If
      Else
        sql = sql & " cliaircraft_airframe_total_landings = NULL, "
      End If
      If Not IsDBNull(aclsClient_Aircraft.cliaircraft_date_engine_times_as_of) Then
        If IsDate(aclsClient_Aircraft.cliaircraft_date_engine_times_as_of) Then
          sql = sql & " cliaircraft_date_engine_times_as_of = '" & Format(CDate(aclsClient_Aircraft.cliaircraft_date_engine_times_as_of), "yyyy-MM-dd HH:mm:ss") & "', "
        Else
          sql = sql & " cliaircraft_date_engine_times_as_of = NULL, "
        End If
      Else
        sql = sql & " cliaircraft_date_engine_times_as_of = NULL, "
      End If
      sql = sql & " cliaircraft_aport_iata_code = '" & Escape_Single_Quote(Left(aclsClient_Aircraft.cliaircraft_aport_iata_code, 4)) & "', "
      sql = sql & " cliaircraft_aport_icao_code = '" & Escape_Single_Quote(Left(aclsClient_Aircraft.cliaircraft_aport_icao_code, 4)) & "', "
      sql = sql & " cliaircraft_aport_name = '" & Escape_Single_Quote(Left(aclsClient_Aircraft.cliaircraft_aport_name, 100)) & "', "
      sql = sql & " cliaircraft_aport_state = '" & Left(aclsClient_Aircraft.cliaircraft_aport_state, 2) & "', "
      sql = sql & " cliaircraft_aport_country = '" & Escape_Single_Quote(Left(aclsClient_Aircraft.cliaircraft_aport_country, 50)) & "', "
      sql = sql & " cliaircraft_aport_city = '" & Escape_Single_Quote(Left(aclsClient_Aircraft.cliaircraft_aport_city, 50)) & "', "
      sql = sql & " cliaircraft_aport_private = '" & Left(aclsClient_Aircraft.cliaircraft_aport_private, 1) & "', "
      sql = sql & " cliaircraft_apu_model_name = '" & Left(aclsClient_Aircraft.cliaircraft_apu_model_name, 40) & "', "
      sql = sql & " cliaircraft_apu_ser_nbr = '" & Left(aclsClient_Aircraft.cliaircraft_apu_ser_nbr, 20) & "', "
      sql = sql & " cliaircraft_apu_ttsn_hours = '" & aclsClient_Aircraft.cliaircraft_apu_ttsn_hours & "', "
      sql = sql & " cliaircraft_apu_tsoh_hours = '" & aclsClient_Aircraft.cliaircraft_apu_tsoh_hours & "', "
      sql = sql & " cliaircraft_apu_tshi_hours = '" & aclsClient_Aircraft.cliaircraft_apu_tshi_hours & "', "
      sql = sql & " cliaircraft_apu_maintance_program = '" & aclsClient_Aircraft.cliaircraft_apu_maintance_program & "', "
      sql = sql & " cliaircraft_damage_flag = '" & Left(aclsClient_Aircraft.cliaircraft_damage_flag, 1) & "', "
      sql = sql & " cliaircraft_damage_history_notes = '" & Escape_Single_Quote(Left(aclsClient_Aircraft.cliaircraft_damage_history_notes, 250)) & "', "

      sql = sql & " cliaircraft_interior_rating = '" & aclsClient_Aircraft.cliaircraft_interior_rating & "', "
      sql = sql & " cliaircraft_interior_month_year = '" & Escape_Single_Quote(Left(aclsClient_Aircraft.cliaircraft_interior_month_year, 6)) & "', "
      sql = sql & " cliaircraft_interior_doneby_name = '" & Escape_Single_Quote(Left(aclsClient_Aircraft.cliaircraft_interior_doneby_name, 50)) & "', "
      sql = sql & " cliaircraft_interior_config_name = '" & Escape_Single_Quote(Left(aclsClient_Aircraft.cliaircraft_interior_config_name, 15)) & "', "
      sql = sql & " cliaircraft_exterior_rating = '" & aclsClient_Aircraft.cliaircraft_exterior_rating & "', "
      sql = sql & " cliaircraft_exterior_month_year = '" & Escape_Single_Quote(Left(aclsClient_Aircraft.cliaircraft_exterior_month_year, 6)) & "', "
      sql = sql & " cliaircraft_exterior_doneby_name = '" & Escape_Single_Quote(Left(aclsClient_Aircraft.cliaircraft_exterior_doneby_name, 50)) & "', "
      sql = sql & " cliaircraft_passenger_count = '" & aclsClient_Aircraft.cliaircraft_passenger_count & "', "
      sql = sql & " cliaircraft_confidential_notes = '" & Escape_Single_Quote(aclsClient_Aircraft.cliaircraft_confidential_notes) & "', "
      sql = sql & " cliaircraft_est_price = '" & aclsClient_Aircraft.cliaircraft_est_price & "', "
      sql = sql & " cliaircraft_ser_nbr_sort = '" & aclsClient_Aircraft.cliaircraft_ser_nbr_sort & "', "
      sql = sql & " cliaircraft_ac_maintained ='" & Left(aclsClient_Aircraft.cliaircraft_ac_maintained, 100) & "', "
      sql = sql & " cliaircraft_value_description ='" & Escape_Single_Quote(aclsClient_Aircraft.cliaircraft_value_description) & "' "


      sql = sql & "WHERE  (cliaircraft_id = '" & aclsClient_Aircraft.cliaircraft_id & "') limit 1"


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Update_Client_Aircraft(ByVal aclsClient_Aircraft As clsClient_Aircraft) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Update_Client_Aircraft = 1
    Catch ex As Exception
      Update_Client_Aircraft = 0
      Me.class_error = "Error in SQL Update_Client_Aircraft(ByVal aclsClient_Aircraft As clsClient_Aircraft) As Integer " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Insert_Client_Aircraft
  ' Purpose: to insert a client aircraft 
  ' Parameters: clsClient_Aircraft
  ' Return: 
  '       integer
  ' Change Log
  '           2/6/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Insert_Client_Aircraft(ByVal aclsClient_Aircraft As clsClient_Aircraft) As Integer
    Dim atemptable As New DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim sql As String = ""
    Dim returned_id As Integer = 0
    Insert_Client_Aircraft = 0
    Try


      sql = " INSERT INTO client_aircraft (cliaircraft_cliamod_id, cliaircraft_ser_nbr, cliaircraft_reg_nbr, cliaircraft_year_mfr, cliaircraft_forsale_flag, cliaircraft_status, cliaircraft_exclusive_flag, "
      sql = sql & " cliaircraft_asking_wordage, cliaircraft_asking_price, cliaircraft_lease_flag, cliaircraft_delivery, cliaircraft_user_id, cliaircraft_action_date, cliaircraft_jetnet_ac_id, "
      sql = sql & " cliaircraft_lifecycle, cliaircraft_ownership, cliaircraft_usage, cliaircraft_alt_ser_nbr, cliaircraft_prev_reg_nbr, cliaircraft_country_of_registration, cliaircraft_new_flag, "
      sql = sql & " cliaircraft_year_dlv, cliaircraft_date_purchased, cliaircraft_date_listed, cliaircraft_airframe_maintenance_program,  cliaircraft_airframe_maintenance_tracking_program, cliaircraft_airframe_total_hours, cliaircraft_airframe_total_landings, cliaircraft_date_engine_times_as_of, "
      sql = sql & " cliaircraft_aport_iata_code, cliaircraft_aport_icao_code, cliaircraft_aport_name, cliaircraft_aport_state, cliaircraft_aport_country, cliaircraft_aport_city, "
      sql = sql & " cliaircraft_aport_private, cliaircraft_apu_model_name, cliaircraft_apu_ser_nbr, cliaircraft_apu_ttsn_hours, cliaircraft_apu_tsoh_hours, cliaircraft_apu_tshi_hours, "
      sql = sql & " cliaircraft_apu_maintance_program, cliaircraft_damage_flag, cliaircraft_damage_history_notes, cliaircraft_interior_rating, cliaircraft_interior_month_year, "
      sql = sql & " cliaircraft_interior_doneby_name, cliaircraft_interior_config_name, cliaircraft_exterior_rating, cliaircraft_exterior_month_year, cliaircraft_exterior_doneby_name, "
      sql = sql & " cliaircraft_passenger_count, cliaircraft_confidential_notes, cliaircraft_est_price, cliaircraft_ser_nbr_sort,cliaircraft_broker_price,cliaircraft_ac_maintained, cliaircraft_value_description,"
      sql = sql & " cliaircraft_custom_1, cliaircraft_custom_2, cliaircraft_custom_3, cliaircraft_custom_4, cliaircraft_custom_5, "
      sql = sql & " cliaircraft_custom_6, cliaircraft_custom_7, cliaircraft_custom_8, cliaircraft_custom_9, cliaircraft_custom_10"

      sql = sql & ")"
      sql = sql & " VALUES ('" & aclsClient_Aircraft.cliaircraft_cliamod_id & "', "
      sql = sql & " '" & Escape_Single_Quote(Left(aclsClient_Aircraft.cliaircraft_ser_nbr, 15)) & "', "
      sql = sql & " '" & Escape_Single_Quote(Left(aclsClient_Aircraft.cliaircraft_reg_nbr, 12)) & "', "
      sql = sql & " '" & Left(aclsClient_Aircraft.cliaircraft_year_mfr, 50) & "',"
      sql = sql & " '" & Left(aclsClient_Aircraft.cliaircraft_forsale_flag, 1) & "',"
      sql = sql & " '" & Left(aclsClient_Aircraft.cliaircraft_status, 35) & "',"
      sql = sql & " '" & Left(aclsClient_Aircraft.cliaircraft_exclusive_flag, 1) & "',"
      sql = sql & " '" & Left(aclsClient_Aircraft.cliaircraft_asking_wordage, 10) & " ',"

      If Not IsDBNull(aclsClient_Aircraft.cliaircraft_asking_price) Then
        If IsNumeric(aclsClient_Aircraft.cliaircraft_asking_price) Then
          sql = sql & " '" & aclsClient_Aircraft.cliaircraft_asking_price & "', "
        Else
          sql = sql & " NULL, "
        End If
      Else
        sql = sql & "  NULL, "
      End If

      sql = sql & " '" & aclsClient_Aircraft.cliaircraft_lease_flag & "', "
      sql = sql & " '" & aclsClient_Aircraft.cliaircraft_delivery & "', "
      sql = sql & " '" & aclsClient_Aircraft.cliaircraft_user_id & "', "

      If Not IsDBNull(aclsClient_Aircraft.cliaircraft_action_date) Then
        If IsDate(aclsClient_Aircraft.cliaircraft_action_date) Then
          sql = sql & " '" & Format(CDate(aclsClient_Aircraft.cliaircraft_action_date), "yyyy-MM-dd HH:mm:ss") & "', "
        Else
          sql = sql & " NOW(), "
        End If
      Else
        sql = sql & " NOW(), "
      End If


      sql = sql & " '" & aclsClient_Aircraft.cliaircraft_jetnet_ac_id & "', "
      sql = sql & " '" & aclsClient_Aircraft.cliaircraft_lifecycle & "', "
      sql = sql & " '" & Left(aclsClient_Aircraft.cliaircraft_ownership, 1) & "', "
      sql = sql & " '" & Left(aclsClient_Aircraft.cliaircraft_usage, 1) & "', "
      sql = sql & " '" & Left(aclsClient_Aircraft.cliaircraft_alt_ser_nbr, 20) & "', "
      sql = sql & " '" & Left(aclsClient_Aircraft.cliaircraft_prev_reg_nbr, 12) & "', "
      sql = sql & " '" & Left(aclsClient_Aircraft.cliaircraft_country_of_registration, 25) & "', "
      sql = sql & " '" & Left(aclsClient_Aircraft.cliaircraft_new_flag, 1) & "', "
      sql = sql & " '" & Left(aclsClient_Aircraft.cliaircraft_year_dlv, 4) & "', "

      If Not IsDBNull(aclsClient_Aircraft.cliaircraft_date_purchased) Then
        If IsDate(aclsClient_Aircraft.cliaircraft_date_purchased) Then
          sql = sql & " '" & Format(CDate(aclsClient_Aircraft.cliaircraft_date_purchased), "yyyy-MM-dd HH:mm:ss") & "', "
        Else
          sql = sql & " NULL, "
        End If
      Else
        sql = sql & " NULL, "
      End If

      If Not IsDBNull(aclsClient_Aircraft.cliaircraft_date_listed) Then
        If IsDate(aclsClient_Aircraft.cliaircraft_date_listed) Then
          sql = sql & " '" & Format(CDate(aclsClient_Aircraft.cliaircraft_date_listed), "yyyy-MM-dd HH:mm:ss") & "', "
        Else
          sql = sql & "  NULL, "
        End If
      Else
        sql = sql & " NULL, "
      End If
      sql = sql & " '" & aclsClient_Aircraft.cliaircraft_airframe_maintenance_program & "', "
      sql = sql & " '" & aclsClient_Aircraft.cliaircraft_airframe_maintenance_tracking_program & "', "

      If Not IsDBNull(aclsClient_Aircraft.cliaircraft_airframe_total_hours) Then
        If IsNumeric(aclsClient_Aircraft.cliaircraft_airframe_total_hours) Then
          sql = sql & " '" & aclsClient_Aircraft.cliaircraft_airframe_total_hours & "', "
        Else
          sql = sql & " NULL, "
        End If
      Else
        sql = sql & " NULL, "
      End If
      If Not IsDBNull(aclsClient_Aircraft.cliaircraft_airframe_total_landings) Then
        If IsNumeric(aclsClient_Aircraft.cliaircraft_airframe_total_landings) Then
          sql = sql & " '" & aclsClient_Aircraft.cliaircraft_airframe_total_landings & "', "
        Else
          sql = sql & " NULL, "
        End If
      Else
        sql = sql & " NULL, "
      End If
      If Not IsDBNull(aclsClient_Aircraft.cliaircraft_date_engine_times_as_of) Then
        If IsDate(aclsClient_Aircraft.cliaircraft_date_engine_times_as_of) Then
          sql = sql & " '" & Format(CDate(aclsClient_Aircraft.cliaircraft_date_engine_times_as_of), "yyyy-MM-dd HH:mm:ss") & "', "
        Else
          sql = sql & " NULL, "
        End If
      Else
        sql = sql & " NULL, "
      End If

      sql = sql & " '" & Escape_Single_Quote(Left(aclsClient_Aircraft.cliaircraft_aport_iata_code, 4)) & "', "
      sql = sql & " '" & Escape_Single_Quote(Left(aclsClient_Aircraft.cliaircraft_aport_icao_code, 4)) & "', "
      sql = sql & " '" & Escape_Single_Quote(Left(aclsClient_Aircraft.cliaircraft_aport_name, 100)) & "', "
      sql = sql & " '" & Escape_Single_Quote(Left(aclsClient_Aircraft.cliaircraft_aport_state, 2)) & "', "
      sql = sql & " '" & Escape_Single_Quote(Left(aclsClient_Aircraft.cliaircraft_aport_country, 50)) & "', "
      sql = sql & " '" & Escape_Single_Quote(Left(aclsClient_Aircraft.cliaircraft_aport_city, 50)) & "', "
      sql = sql & " '" & Left(aclsClient_Aircraft.cliaircraft_aport_private, 1) & "', "
      sql = sql & " '" & Left(aclsClient_Aircraft.cliaircraft_apu_model_name, 40) & "', "
      sql = sql & " '" & Left(aclsClient_Aircraft.cliaircraft_apu_ser_nbr, 20) & "', "
      sql = sql & " '" & aclsClient_Aircraft.cliaircraft_apu_ttsn_hours & "', "
      sql = sql & " '" & aclsClient_Aircraft.cliaircraft_apu_tsoh_hours & "', "
      sql = sql & " '" & aclsClient_Aircraft.cliaircraft_apu_tshi_hours & "', "
      sql = sql & " '" & aclsClient_Aircraft.cliaircraft_apu_maintance_program & "', "
      sql = sql & " '" & Left(aclsClient_Aircraft.cliaircraft_damage_flag, 1) & "', "
      sql = sql & " '" & Escape_Single_Quote(Left(aclsClient_Aircraft.cliaircraft_damage_history_notes, 250)) & "', "
      sql = sql & " '" & aclsClient_Aircraft.cliaircraft_interior_rating & "', "
      sql = sql & " '" & Escape_Single_Quote(Left(aclsClient_Aircraft.cliaircraft_interior_month_year, 6)) & "', "
      sql = sql & " '" & Escape_Single_Quote(Left(aclsClient_Aircraft.cliaircraft_interior_doneby_name, 50)) & "', "
      sql = sql & " '" & Escape_Single_Quote(Left(aclsClient_Aircraft.cliaircraft_interior_config_name, 15)) & "', "
      sql = sql & " '" & aclsClient_Aircraft.cliaircraft_exterior_rating & "', "
      sql = sql & " '" & Escape_Single_Quote(Left(aclsClient_Aircraft.cliaircraft_exterior_month_year, 6)) & "', "
      sql = sql & " '" & Escape_Single_Quote(aclsClient_Aircraft.cliaircraft_exterior_doneby_name) & "', "
      sql = sql & " '" & aclsClient_Aircraft.cliaircraft_passenger_count & "', "
      sql = sql & " '" & Escape_Single_Quote(aclsClient_Aircraft.cliaircraft_confidential_notes) & "', "
      sql = sql & " '" & aclsClient_Aircraft.cliaircraft_est_price & "', "
      sql = sql & " '" & aclsClient_Aircraft.cliaircraft_ser_nbr_sort & "', "

      If Not IsDBNull(aclsClient_Aircraft.cliaircraft_broker_price) Then
        If IsNumeric(aclsClient_Aircraft.cliaircraft_broker_price) Then
          sql = sql & " '" & aclsClient_Aircraft.cliaircraft_broker_price & "', "
        Else
          sql = sql & " NULL, "
        End If
      Else
        sql = sql & " NULL, "
      End If


      sql = sql & " '" & Left(aclsClient_Aircraft.cliaircraft_ac_maintained, 100) & "', "
      sql = sql & "'" & Escape_Single_Quote(aclsClient_Aircraft.cliaircraft_value_description) & "',"

      sql = sql & " '" & Left(Escape_Single_Quote(aclsClient_Aircraft.cliaircraft_custom_1), 500) & "', '" & Left(Escape_Single_Quote(aclsClient_Aircraft.cliaircraft_custom_2), 500) & "', '" & Left(Escape_Single_Quote(aclsClient_Aircraft.cliaircraft_custom_3), 500) & "',  '" & Left(Escape_Single_Quote(aclsClient_Aircraft.cliaircraft_custom_4), 500) & "',  '" & Left(Escape_Single_Quote(aclsClient_Aircraft.cliaircraft_custom_5), 500) & "', "
      sql = sql & "  '" & Left(Escape_Single_Quote(aclsClient_Aircraft.cliaircraft_custom_6), 500) & "',  '" & Left(Escape_Single_Quote(aclsClient_Aircraft.cliaircraft_custom_7), 500) & "',  '" & Left(Escape_Single_Quote(aclsClient_Aircraft.cliaircraft_custom_8), 500) & "',  '" & Left(Escape_Single_Quote(aclsClient_Aircraft.cliaircraft_custom_9), 500) & "',  '" & Left(Escape_Single_Quote(aclsClient_Aircraft.cliaircraft_custom_10), 500) & "'"

      sql = sql & " )"




      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Insert_Client_Aircraft(ByVal aclsClient_Aircraft As clsClient_Aircraft) As Integer</b><br />" & sql
      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()






      sql = "select cliaircraft_id from client_aircraft order by cliaircraft_id desc"
      MySqlCommand.CommandText = sql

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />Insert_Client_Aircraft(ByVal aclsClient_Aircraft As clsClient_Aircraft) As Integer " & sql

      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try


      If atemptable.Rows.Count > 0 Then
        returned_id = atemptable.Rows(0).Item("cliaircraft_id")
      End If







      Insert_Client_Aircraft = returned_id
    Catch ex As Exception
      Insert_Client_Aircraft = 0
      Me.class_error = "Error in SQL Insert_Client_Aircraft(ByVal aclsClient_Aircraft As clsClient_Aircraft) As Integer " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function


  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Delete_Client_Aircraft(ByVal client_ac_id As Integer)
  ' Purpose: remove a client aircraft and all of the gunk associated with it. 
  ' Parameters: client_ac_id
  ' Return: 
  '       integer
  ' Change Log
  '           2/6/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Delete_Client_Aircraft(ByVal client_ac_id As Integer) As Integer
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing

    Delete_Client_Aircraft = 0
    Try
      If client_ac_id <> 0 Then


        MySqlConn.ConnectionString = Me.client_DB

        MySqlConn.Open()
        MySqlCommand.Connection = MySqlConn
        MySqlCommand.CommandType = CommandType.Text
        MySqlCommand.CommandTimeout = 60

        'remove from aircraft table. 
        Dim sQuery As String = "delete from client_aircraft where cliaircraft_id = " & client_ac_id & " limit 1 "

        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Delete_Client_Aircraft(ByVal client_ac_id As Integer) As Integer</b><br />" & sQuery


        MySqlCommand.CommandText = sQuery
        MySqlCommand.ExecuteNonQuery()
        'remove from reference
        sQuery = "delete from client_aircraft_reference where cliacref_cliac_id = " & client_ac_id

        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />" & sQuery


        MySqlCommand.CommandText = sQuery
        MySqlCommand.ExecuteNonQuery()
        'remove from details
        sQuery = "delete from client_aircraft_details where cliadet_cliac_id =  " & client_ac_id

        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />" & sQuery

        MySqlCommand.CommandText = sQuery
        MySqlCommand.ExecuteNonQuery()

        'remove from details
        sQuery = "delete from client_aircraft_engine where cliacep_cliac_id = " & client_ac_id


        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />" & sQuery


        MySqlCommand.CommandText = sQuery
        MySqlCommand.ExecuteNonQuery()

        'remove from details
        sQuery = "delete from client_aircraft_avionics where cliav_cliac_id = " & client_ac_id

        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />" & sQuery


        MySqlCommand.CommandText = sQuery
        MySqlCommand.ExecuteNonQuery()

        'remove from details
        sQuery = "delete from client_aircraft_key_features where cliafeat_cliac_id = " & client_ac_id


        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />" & sQuery

        MySqlCommand.CommandText = sQuery
        MySqlCommand.ExecuteNonQuery()

        'remove from propeller
        sQuery = "delete from client_aircraft_propeller where cliacpr_cliac_id = " & client_ac_id

        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />" & sQuery

        MySqlCommand.CommandText = sQuery
        MySqlCommand.ExecuteNonQuery()

        'remove from clientfolderindex
        sQuery = "delete from client_folder_index where cfoldind_client_ac_id = " & client_ac_id
        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />" & sQuery

        MySqlCommand.CommandText = sQuery
        MySqlCommand.ExecuteNonQuery()

        'update notes
        sQuery = "update local_notes set lnote_client_ac_id = 0 where lnote_client_ac_id= " & client_ac_id

        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />" & sQuery

        MySqlCommand.CommandText = sQuery
        MySqlCommand.ExecuteNonQuery()

        Delete_Client_Aircraft = 1


      End If
    Catch ex As Exception
      Delete_Client_Aircraft = 0
      Me.class_error = "Error in Delete_Client_Aircraft(ByVal client_ac_id As Integer) : " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Delete_Client_Aircraft_Key_Features_ALL
  ' Purpose: to update a clients aircrfaft propeller
  ' Parameters: cliacpr_cliac_id
  ' Return: 
  '       integer
  ' Change Log
  '           2/6/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Delete_Client_Aircraft_Key_Features_ALL(ByVal cliafeat_cliac_id As Integer) As Integer

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Delete_Client_Aircraft_Key_Features_ALL = 0
    Try
      sql = "DELETE FROM client_aircraft_key_features WHERE ((cliafeat_cliac_id = '" & cliafeat_cliac_id & "')) "

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Delete_Client_Aircraft_Key_Features_ALL(ByVal cliafeat_cliac_id As Integer) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Delete_Client_Aircraft_Key_Features_ALL = 1
    Catch ex As Exception
      Delete_Client_Aircraft_Key_Features_ALL = 0
      Me.class_error = "Error in SQL Delete_Client_Aircraft_Key_Features_ALL(ByVal cliafeat_cliac_id As Integer) As Integer " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function


  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  'Method name:  Insert_Client_Aircraft_Key_Features_List
  'Purpose: to update a clients aircrfaft propeller
  'Parameters: cliacpr_cliac_id
  'Return: 
  '      integer
  'Change Log
  '          2/6/2012    - Created By: Amanda Vaughn
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Delete_Client_Aircraft_Key_Features_List(ByVal clikfeat_name As String, ByVal clickfeat_type As String) As Integer

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Dim action_date As String = Year(DateTime.Now) & "-" & Month(DateTime.Now) & "-" & Day(DateTime.Now) & " " & Hour(DateTime.Now) & ":" & Minute(DateTime.Now) & ":" & Second(DateTime.Now)


    Delete_Client_Aircraft_Key_Features_List = 0
    Try
      ' changed from delete to inactive - MSW - 10/22/14 
      ' sql = "DELETE FROM client_key_features "
      '  sql = sql & " WHERE (clikfeat_name = '" & clikfeat_name & "') AND (clikfeat_type = '" & clickfeat_type & "') limit 1"

      sql = "Update client_key_features set clikfeat_active_flag = 'N',  clikfeat_action_date = '" & action_date & "' "
      sql = sql & " WHERE (clikfeat_name = '" & clikfeat_name & "') AND (clikfeat_type = '" & clickfeat_type & "') "



      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Delete_Client_Aircraft_Key_Features_List(ByVal clikfeat_name As String, ByVal clickfeat_type As String) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Delete_Client_Aircraft_Key_Features_List = 1
    Catch ex As Exception
      Delete_Client_Aircraft_Key_Features_List = 0
      Me.class_error = "Error in SQL Delete_Client_Aircraft_Key_Features_List(ByVal clikfeat_name As String, ByVal clickfeat_type As String) As Integer " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function

  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  'Method name:  Insert_Client_Aircraft_Key_Features_List
  'Purpose: to update a clients aircrfaft propeller
  'Parameters: cliacpr_cliac_id
  'Return: 
  '      integer
  'Change Log
  '          2/6/2012   - Created By: Amanda Vaughn
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Insert_Client_Aircraft_Key_Features_List(ByVal clikfeat_name As String, ByVal clickfeat_type As String, ByVal clickfeat_description As String) As Integer
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Dim action_date As String = Year(DateTime.Now) & "-" & Month(DateTime.Now) & "-" & Day(DateTime.Now) & " " & Hour(DateTime.Now) & ":" & Minute(DateTime.Now) & ":" & Second(DateTime.Now)
    Dim insert_update_string As String = ""

    Insert_Client_Aircraft_Key_Features_List = 0
    Try
      Dim atemptable As DataTable = CheckBeforeUpdate_Client_Aircraft_Key_Features_List(clikfeat_name, clickfeat_type)
      If Not IsNothing(atemptable) Then
        If atemptable.Rows.Count = 0 Then

          sql = "INSERT INTO client_key_features"
          sql = sql & " (clikfeat_type, clikfeat_name, clikfeat_description, clikfeat_active_flag, clikfeat_source, clikfeat_action_date) "
          sql = sql & " VALUES ('" & clickfeat_type & "', '" & clikfeat_name & "', '" & clickfeat_description & "', 'Y', 'CLIENT', '" & action_date & "')"

          HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Insert_Client_Aircraft_Key_Features_List(ByVal clikfeat_name As String, ByVal clickfeat_type As String, ByVal clickfeat_description As String) As Integer</b><br />" & sql


          MySqlConn.ConnectionString = Me.client_DB
          MySqlConn.Open()
          MySqlCommand.Connection = MySqlConn
          MySqlCommand.CommandType = CommandType.Text
          MySqlCommand.CommandTimeout = 60

          MySqlCommand.CommandText = sql
          MySqlCommand.ExecuteNonQuery()


          insert_update_string = "Insert into client_custom_export (clicexp_type, clicexp_display, clicexp_client_db_name, clicexp_jetnet_db_name, clicexp_sort, clicexp_aerodex_flag"
          insert_update_string &= " , clicexp_header_field_name, clicexp_field_type, clicexp_field_length) "
          insert_update_string &= " VALUES ( "
          insert_update_string &= "'Feature Code', "
          insert_update_string &= "'" & clikfeat_name & "', "
          insert_update_string &= "'(select distinct cliafeat_flag from client_aircraft_key_features where cliafeat_cliac_id=cliaircraft_id and cliafeat_type=''" & clickfeat_type & "'') as " & clickfeat_type & "', "
          insert_update_string &= "''''' as " & clickfeat_type & "', "
          insert_update_string &= "'100', "
          insert_update_string &= "'Y', "


          insert_update_string &= "'" & clickfeat_type & "', "
          insert_update_string &= "'String', "
          insert_update_string &= "'150' "

          insert_update_string &= " ) "

          MySqlCommand.CommandText = insert_update_string
          MySqlCommand.ExecuteNonQuery()


          Insert_Client_Aircraft_Key_Features_List = 1


        End If
      End If
    Catch ex As Exception
      Insert_Client_Aircraft_Key_Features_List = 0
      Me.class_error = "Error in SQL Insert_Client_Aircraft_Key_Features_List(ByVal clikfeat_name As String, ByVal clickfeat_type As String, ByVal clickfeat_description As String) As Integer " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function


  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: UpdateClientListPreference
  ' Purpose: to Update client list preferences
  ' Parameters: clilstpref_id
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/6/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function UpdateClientListPreference(ByVal clilistpref_type As String, ByVal clilistpref_name As String, ByVal clilistpref_selected As String, ByVal clilistpref_order As String, ByVal Original_clilstpref_id As Integer) As Integer

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    UpdateClientListPreference = 0
    Try
      sql = "UPDATE client_list_preference SET clilistpref_type = '" & clilistpref_type & "', "
      sql = sql & " clilistpref_name = '" & clilistpref_name & "', "
      sql = sql & " clilistpref_selected = '" & clilistpref_selected & "', "
      sql = sql & " clilistpref_order = '" & clilistpref_order & "' "
      sql = sql & " WHERE ((clilstpref_id = '" & Original_clilstpref_id & "' )) limit 1 "

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>UpdateClientListPreference(ByVal clilistpref_type As String, ByVal clilistpref_name As String, ByVal clilistpref_selected As String, ByVal clilistpref_order As String, ByVal Original_clilstpref_id As Integer) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      UpdateClientListPreference = 1
    Catch ex As Exception
      UpdateClientListPreference = 0
      Me.class_error = "Error in SQL UpdateClientListPreference(ByVal clilistpref_type As String, ByVal clilistpref_name As String, ByVal clilistpref_selected As String, ByVal clilistpref_order As String, ByVal Original_clilstpref_id As Integer) As Integer " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function




  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  'Method name: CheckBeforeUpdate_Client_Aircraft_Key_Features_List
  'Purpose: to update a clients aircrfaft propeller
  'Parameters: cliacpr_cliac_id
  'Return: 
  '      integer
  'Change Log
  '           2/6/2012   - Created By: Amanda Vaughn
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function CheckBeforeUpdate_Client_Aircraft_Key_Features_List(ByVal clikfeat_name As String, ByVal clickfeat_type As String) As DataTable
    'clikfeat_name ASC
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim aTempTable As New DataTable

    Try
      sql = "SELECT clikfeat_name, clikfeat_type "
      sql = sql & " FROM  client_key_features where clikfeat_name = '" & clikfeat_name & "' and clikfeat_type = '" & clickfeat_type & "' "


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>CheckBeforeUpdate_Client_Aircraft_Key_Features_List(ByVal clikfeat_name As String, ByVal clickfeat_type As String) As DataTable</b><br />" & sql

      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable
    Catch ex As Exception
      CheckBeforeUpdate_Client_Aircraft_Key_Features_List = Nothing
      Me.class_error = "Error in SQL CheckBeforeUpdate_Client_Aircraft_Key_Features_List(ByVal clikfeat_name As String, ByVal clickfeat_type As String) As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

#Region "AC Details"
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_Aircraft_Details
  ' Purpose: to get a clients aircrfaft details
  ' Parameters: cliadet_cliac_id
  ' Return: 
  '       integer
  ' Change Log
  '           1/6/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Client_Aircraft_Details(ByVal cliadet_cliac_id As Integer) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim aTempTable As New DataTable

    Try
      sql = "SELECT cliadet_action_date, cliadet_cliac_id, cliadet_data_description, "
      sql = sql & " cliadet_data_name, cliadet_data_type, cliadet_id FROM client_aircraft_details "
      sql = sql & " WHERE (cliadet_cliac_id = " & cliadet_cliac_id & ") ORDER BY cliadet_cliac_id, cliadet_data_type, cliadet_data_name"

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Aircraft_Details(ByVal cliadet_cliac_id As Integer)</b><br />" & sql

      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable
    Catch ex As Exception
      Get_Client_Aircraft_Details = Nothing
      Me.class_error = "Error in SQL Get_Client_Aircraft_Details(ByVal cliadet_cliac_id As Integer): " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_Aircraft_Details
  ' Purpose: to get a clients aircrfaft details
  ' Parameters: cliadet_cliac_id, cliadet_data_type
  ' Return: 
  '       integer
  ' Change Log
  '           2/23/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Client_Aircraft_Details(ByVal cliadet_cliac_id As Integer, ByVal cliadet_data_type As String) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim aTempTable As New DataTable

    Try
      sql = "SELECT cliadet_action_date, cliadet_cliac_id, cliadet_data_description, "
      sql = sql & " cliadet_data_name, cliadet_data_type, cliadet_id FROM client_aircraft_details "
      sql = sql & " WHERE (cliadet_cliac_id = " & cliadet_cliac_id & " and cliadet_data_type = '" & cliadet_data_type & "') ORDER BY cliadet_cliac_id, cliadet_data_type, cliadet_data_name"

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Aircraft_Details(ByVal cliadet_cliac_id As Integer, ByVal cliadet_data_type As String) As DataTable</b><br />" & sql

      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable
    Catch ex As Exception
      Get_Client_Aircraft_Details = Nothing
      Me.class_error = "Error in SQL Get_Client_Aircraft_Details(ByVal cliadet_cliac_id As Integer, ByVal cliadet_data_type As String) As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  Public Function Get_Client_Aircraft_Details_As_Jetnet_Fields(ByVal cliadet_cliac_id As Integer, ByVal cliadet_data_type As String) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim aTempTable As New DataTable

    Try
      sql = "SELECT cliadet_action_date as adet_action_date, cliadet_cliac_id as adet_ac_id, cliadet_data_description as adet_data_description, "
      sql += " cliadet_data_name as adet_data_name, cliadet_data_type as adet_data_type, cliadet_id as adet_id FROM client_aircraft_details "
      sql += " WHERE (cliadet_cliac_id = @AircraftID and cliadet_data_type in ('" & cliadet_data_type & "')) ORDER BY cliadet_cliac_id, cliadet_data_type, cliadet_data_name"

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()


      Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand(sql, MySqlConn)

      'MySqlCommand.Parameters.AddWithValue("DataType", cliadet_data_type)
      MySqlCommand.Parameters.AddWithValue("AircraftID", cliadet_cliac_id)
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Aircraft_Details_As_Jetnet_Fields(ByVal cliadet_cliac_id As Integer, ByVal cliadet_data_type As String) As DataTable</b><br />" & sql

      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      MySqlCommand.Dispose()
      MySqlCommand = Nothing

      Return aTempTable

    Catch ex As Exception
      Get_Client_Aircraft_Details_As_Jetnet_Fields = Nothing
      Me.class_error = "Error in SQL Get_Client_Aircraft_Details_As_Jetnet_Fields(ByVal cliadet_cliac_id As Integer, ByVal cliadet_data_type As String) As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
    End Try

  End Function
#End Region
#End Region
#Region "AC REFS Client"
  ''' <summary>
  ''' On contact card, ac references for client side.
  ''' </summary>
  ''' <param name="acID"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Get_Aircraft_Reference_Client_acID_Full_Details(ByVal acID As Integer) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim aTempTable As New DataTable
    Try
      aTempTable.Columns.Add("acref_id")
      aTempTable.Columns.Add("cliacref_cliac_id")
      aTempTable.Columns.Add("comp_id")
      aTempTable.Columns.Add("contact_id")
      aTempTable.Columns.Add("acref_contact_type")
      aTempTable.Columns.Add("acref_owner_percentage")
      aTempTable.Columns.Add("cliacref_jetnet_ac_id")
      aTempTable.Columns.Add("acref_date_fraction_purchased")
      aTempTable.Columns.Add("acref_date_fraction_expires")
      aTempTable.Columns.Add("acref_business_type")
      aTempTable.Columns.Add("acref_operator_flag")
      aTempTable.Columns.Add("acref_jetnet_contact_type")
      aTempTable.Columns.Add("cliacref_contact_priority")
      aTempTable.Columns.Add("comp_name")
      aTempTable.Columns.Add("comp_city")
      aTempTable.Columns.Add("comp_country")
      aTempTable.Columns.Add("comp_state")
      aTempTable.Columns.Add("contact_first_name")
      aTempTable.Columns.Add("contact_last_name")
      aTempTable.Columns.Add("contact_title")
      aTempTable.Columns.Add("act_name")
      aTempTable.Columns.Add("source")

      sql = "SELECT client_aircraft_reference.cliacref_id AS acref_id, client_aircraft_reference.cliacref_cliac_id, "
      sql = sql & " client_aircraft_reference.cliacref_comp_id AS comp_id, "
      sql = sql & " client_aircraft_reference.cliacref_contact_id AS contact_id, client_aircraft_reference.cliacref_contact_type AS acref_contact_type, "
      sql = sql & " client_aircraft_reference.cliacref_owner_percentage AS acref_owner_percentage, client_aircraft_reference.cliacref_jetnet_ac_id, "
      sql = sql & " client_aircraft_reference.cliacref_date_fraction_purchased AS acref_date_fraction_purchased, "
      sql = sql & " client_aircraft_reference.cliacref_date_fraction_expires AS acref_date_fraction_expires, "
      sql = sql & " client_aircraft_reference.cliacref_business_type AS acref_business_type, "
      sql = sql & " client_aircraft_reference.cliacref_operator_flag AS acref_operator_flag, "
      sql = sql & " client_aircraft_reference.cliacref_jetnet_contact_type AS acref_jetnet_contact_type, "
      sql = sql & " client_aircraft_reference.cliacref_contact_priority , 'CLIENT' as source, "
      sql = sql & " client_company.clicomp_name AS comp_name, client_company.clicomp_city AS comp_city, clicomp_country AS comp_country, "
      sql = sql & " client_company.clicomp_state AS comp_state, client_contact.clicontact_first_name AS contact_first_name, "
      sql = sql & " client_contact.clicontact_last_name AS contact_last_name,"
      sql = sql & " client_contact.clicontact_title AS contact_title, client_aircraft_contact_type.cliact_name AS act_name"
      sql = sql & " FROM  client_aircraft_reference left outer JOIN"
      sql = sql & " client_aircraft_contact_type ON client_aircraft_reference.cliacref_contact_type = client_aircraft_contact_type.cliact_type "
      sql = sql & " LEFT OUTER JOIN"
      sql = sql & "  client_company ON client_aircraft_reference.cliacref_comp_id = client_company.clicomp_id LEFT OUTER JOIN"
      sql = sql & " client_contact ON client_aircraft_reference.cliacref_contact_id = client_contact.clicontact_id"
      sql = sql & " WHERE (client_aircraft_reference.cliacref_cliac_id = " & acID & ")"
      sql = sql & " ORDER BY  cliacref_contact_priority, cliacref_contact_type"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Aircraft_Reference_Client_acID_Full_Details(ByVal acID As Integer) As DataTable</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      While MySqlReader.Read()

        Dim newCustomersRow As DataRow = aTempTable.NewRow()

        newCustomersRow("acref_id") = MySqlReader.Item("acref_id")
        newCustomersRow("cliacref_cliac_id") = MySqlReader.Item("cliacref_cliac_id")
        newCustomersRow("comp_id") = MySqlReader.Item("comp_id")
        newCustomersRow("contact_id") = MySqlReader.Item("contact_id")
        newCustomersRow("acref_contact_type") = MySqlReader.Item("acref_contact_type")
        newCustomersRow("acref_owner_percentage") = MySqlReader.Item("acref_owner_percentage")

        newCustomersRow("cliacref_jetnet_ac_id") = MySqlReader.Item("cliacref_jetnet_ac_id")
        newCustomersRow("acref_date_fraction_purchased") = MySqlReader.Item("acref_date_fraction_purchased")
        newCustomersRow("acref_date_fraction_expires") = MySqlReader.Item("acref_date_fraction_expires")
        newCustomersRow("acref_business_type") = MySqlReader.Item("acref_business_type")

        newCustomersRow("acref_operator_flag") = MySqlReader.Item("acref_operator_flag")
        newCustomersRow("acref_jetnet_contact_type") = MySqlReader.Item("acref_jetnet_contact_type")
        newCustomersRow("cliacref_contact_priority") = MySqlReader.Item("cliacref_contact_priority")
        newCustomersRow("comp_name") = MySqlReader.Item("comp_name")

        newCustomersRow("comp_city") = MySqlReader.Item("comp_city")
        newCustomersRow("comp_country") = MySqlReader.Item("comp_country")
        newCustomersRow("comp_state") = MySqlReader.Item("comp_state")
        newCustomersRow("contact_first_name") = MySqlReader.Item("contact_first_name")
        newCustomersRow("contact_last_name") = MySqlReader.Item("contact_last_name")
        newCustomersRow("contact_title") = MySqlReader.Item("contact_title")
        newCustomersRow("act_name") = MySqlReader.Item("act_name")

        aTempTable.Rows.Add(newCustomersRow)
        aTempTable.AcceptChanges()
      End While
      MySqlReader.Close()
      MySqlReader = Nothing

      Return aTempTable
    Catch ex As Exception
      Get_Aircraft_Reference_Client_acID_Full_Details = Nothing
      Me.class_error = "Error in  SQL Get_Aircraft_Reference_Client_acID_Full_Details(ByVal acID As Integer): " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try



  End Function
  ''' <summary>
  ''' on contact card, ac references for client side with jetnet ac ID
  ''' </summary>
  ''' <param name="acID"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Get_Aircraft_Reference_Client_JetnetacID_Full_Details(ByVal acID As Integer) As DataTable
    Dim sql As String = ""

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim aTempTable As New DataTable
    Try
      aTempTable.Columns.Add("acref_id")
      aTempTable.Columns.Add("cliacref_cliac_id")
      aTempTable.Columns.Add("comp_id")
      aTempTable.Columns.Add("contact_id")
      aTempTable.Columns.Add("acref_contact_type")
      aTempTable.Columns.Add("acref_owner_percentage")
      aTempTable.Columns.Add("cliacref_jetnet_ac_id")
      aTempTable.Columns.Add("acref_date_fraction_purchased")
      aTempTable.Columns.Add("acref_date_fraction_expires")
      aTempTable.Columns.Add("acref_business_type")
      aTempTable.Columns.Add("acref_operator_flag")
      aTempTable.Columns.Add("acref_jetnet_contact_type")
      aTempTable.Columns.Add("cliacref_contact_priority")
      aTempTable.Columns.Add("comp_name")
      aTempTable.Columns.Add("comp_city")
      aTempTable.Columns.Add("comp_country")
      aTempTable.Columns.Add("comp_state")
      aTempTable.Columns.Add("contact_first_name")
      aTempTable.Columns.Add("contact_last_name")
      aTempTable.Columns.Add("contact_title")
      aTempTable.Columns.Add("act_name")
      aTempTable.Columns.Add("source")
      aTempTable.Columns.Add("comp_jetnet_id")

      sql = " SELECT client_aircraft_reference.cliacref_id AS acref_id, client_aircraft_reference.cliacref_cliac_id, client_aircraft_reference.cliacref_comp_id AS comp_id, "
      sql = sql & " client_aircraft_reference.cliacref_contact_id AS contact_id, client_aircraft_reference.cliacref_contact_type AS acref_contact_type, "
      sql = sql & " client_aircraft_reference.cliacref_owner_percentage AS acref_owner_percentage, client_aircraft_reference.cliacref_jetnet_ac_id, "
      sql = sql & " client_aircraft_reference.cliacref_date_fraction_purchased AS acref_date_fraction_purchased, "
      sql = sql & " client_aircraft_reference.cliacref_date_fraction_expires AS acref_date_fraction_expires, client_aircraft_reference.cliacref_business_type AS acref_business_type, "
      sql = sql & " client_aircraft_reference.cliacref_operator_flag AS acref_operator_flag, client_aircraft_reference.cliacref_jetnet_contact_type AS acref_jetnet_contact_type, "
      sql = sql & " client_aircraft_reference.cliacref_contact_priority, client_company.clicomp_jetnet_comp_id as comp_jetnet_id, client_company.clicomp_name AS comp_name, client_company.clicomp_city AS comp_city, clicomp_country AS comp_country, "
      sql = sql & " client_company.clicomp_state AS comp_state, client_contact.clicontact_first_name AS contact_first_name, client_contact.clicontact_last_name AS contact_last_name,"
      sql = sql & " client_contact.clicontact_title AS contact_title, client_aircraft_contact_type.cliact_name AS act_name, 'CLIENT' as source "
      sql = sql & " FROM client_aircraft_reference INNER JOIN"
      sql = sql & " client_aircraft_contact_type ON client_aircraft_reference.cliacref_contact_type = client_aircraft_contact_type.cliact_type LEFT OUTER JOIN"
      sql = sql & " client_company ON client_aircraft_reference.cliacref_comp_id = client_company.clicomp_id LEFT OUTER JOIN"
      sql = sql & " client_contact ON client_aircraft_reference.cliacref_contact_id = client_contact.clicontact_id"
      sql = sql & " WHERE  (cliacref_jetnet_ac_id = " & acID & ")"
      sql = sql & " ORDER BY  cliacref_contact_priority, cliacref_contact_type "

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Aircraft_Reference_Client_JetnetacID_Full_Details(ByVal acID As Integer) As DataTable</b><br />" & sql


      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      While MySqlReader.Read()

        Dim newCustomersRow As DataRow = aTempTable.NewRow()

        newCustomersRow("acref_id") = MySqlReader.Item("acref_id")
        newCustomersRow("cliacref_cliac_id") = MySqlReader.Item("cliacref_cliac_id")
        newCustomersRow("comp_id") = MySqlReader.Item("comp_id")
        newCustomersRow("contact_id") = MySqlReader.Item("contact_id")
        newCustomersRow("acref_contact_type") = MySqlReader.Item("acref_contact_type")
        newCustomersRow("acref_owner_percentage") = MySqlReader.Item("acref_owner_percentage")

        newCustomersRow("cliacref_jetnet_ac_id") = MySqlReader.Item("cliacref_jetnet_ac_id")
        newCustomersRow("acref_date_fraction_purchased") = MySqlReader.Item("acref_date_fraction_purchased")
        newCustomersRow("acref_date_fraction_expires") = MySqlReader.Item("acref_date_fraction_expires")
        newCustomersRow("acref_business_type") = MySqlReader.Item("acref_business_type")

        newCustomersRow("acref_operator_flag") = MySqlReader.Item("acref_operator_flag")
        newCustomersRow("acref_jetnet_contact_type") = MySqlReader.Item("acref_jetnet_contact_type")
        newCustomersRow("cliacref_contact_priority") = MySqlReader.Item("cliacref_contact_priority")
        newCustomersRow("comp_name") = MySqlReader.Item("comp_name")

        newCustomersRow("comp_city") = MySqlReader.Item("comp_city")
        newCustomersRow("comp_country") = MySqlReader.Item("comp_country")
        newCustomersRow("comp_state") = MySqlReader.Item("comp_state")
        newCustomersRow("contact_first_name") = MySqlReader.Item("contact_first_name")
        newCustomersRow("contact_last_name") = MySqlReader.Item("contact_last_name")
        newCustomersRow("contact_title") = MySqlReader.Item("contact_title")
        newCustomersRow("act_name") = MySqlReader.Item("act_name")
        newCustomersRow("source") = MySqlReader.Item("source")
        newCustomersRow("comp_jetnet_id") = MySqlReader.Item("comp_jetnet_id")
        aTempTable.Rows.Add(newCustomersRow)
        aTempTable.AcceptChanges()
      End While
      MySqlReader.Close()
      MySqlReader = Nothing
      Return aTempTable

    Catch ex As Exception
      Get_Aircraft_Reference_Client_JetnetacID_Full_Details = Nothing
      Me.class_error = "Error in  SQL Get_Aircraft_Reference_Client_JetnetacID_Full_Details(ByVal acID As Integer): " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try


  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_Aircraft_Reference_ContactID
  ' Purpose: to get an aircraft reference record based on the clicref_contact_id
  ' Parameters: clicref_contact_id
  ' Return: 
  '       Boolean
  ' Change Log
  '           1/6/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Client_Aircraft_Reference_ContactID(ByVal clicref_contact_id As Integer) As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim aTempTable As New DataTable
    Dim sql As String = ""

    Try

      sql = "SELECT cliacref_id, cliacref_cliac_id, cliacref_comp_id, cliacref_contact_id, "
      sql = sql & " cliacref_contact_type, cliacref_owner_percentage, cliacref_jetnet_ac_id, "
      sql = sql & " cliacref_date_fraction_purchased, cliacref_date_fraction_expires, "
      sql = sql & " cliacref_business_type, cliacref_operator_flag, cliacref_jetnet_contact_type, "
      sql = sql & " cliacref_contact_priority"
      sql = sql & " FROM  client_aircraft_reference"
      sql = sql & " WHERE (cliacref_contact_id = " & clicref_contact_id & ")"
      sql = sql & " ORDER BY  cliacref_id"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Aircraft_Reference_ContactID(ByVal clicref_contact_id As Integer) As DataTable</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable
    Catch ex As Exception
      Get_Client_Aircraft_Reference_ContactID = Nothing
      Me.class_error = "Error in  SQL Get_Client_Aircraft_Reference_ContactID(ByVal " & clicref_contact_id & " As Integer): " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function


  Public Function Client_Get_Related_Aircraft_Info(ByVal contact_id As String) As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim aTempTable As New DataTable
    Dim sql As String = ""

    Try

      sql = "SELECT cliamod_make_name as amod_make_name, cliacref_cliac_id as ac_id, cliacref_comp_id as comp_id, "
      sql += " cliamod_model_name as amod_model_name, "
      sql += " cliacref_contact_type as actype_name, cliacref_jetnet_ac_id, "
      sql += " cliacref_jetnet_contact_type, cliaircraft_ser_nbr as ac_ser_no_full, cliaircraft_reg_nbr as ac_reg_no, "
      sql += " cliaircraft_asking_price as ac_asking_price, cliaircraft_forsale_flag as ac_forsale_flag, cliaircraft_asking_wordage "
      sql += " as ac_asking_wordage, "
      sql += " cliaircraft_status as ac_status, cliaircraft_date_listed as ac_date_listed, cliaircraft_delivery as ac_delivery, "
      sql += " clicomp_name as comp_name, clicomp_city as comp_city, clicomp_state as comp_state "
      sql += " FROM  client_aircraft_reference"
      sql += " left outer JOIN"
      sql += " client_aircraft_contact_type ON client_aircraft_reference.cliacref_contact_type = client_aircraft_contact_type.cliact_type "
      sql += " left outer join client_aircraft on client_aircraft_reference.cliacref_cliac_id = client_aircraft.cliaircraft_id"
      sql += " left outer join client_aircraft_model on client_aircraft.cliaircraft_cliamod_id = client_aircraft_model.cliamod_id"
      sql += " LEFT OUTER JOIN"
      sql += "  client_company ON client_aircraft_reference.cliacref_comp_id = client_company.clicomp_id  "

      sql += " WHERE cliacref_contact_id in (" & contact_id & ")"
      sql += " order by cliamod_make_name, cliamod_model_name, cliaircraft_ser_nbr"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Aircraft_Reference_ContactID(ByVal clicref_contact_id As Integer) As DataTable</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable
    Catch ex As Exception
      Client_Get_Related_Aircraft_Info = Nothing
      Me.class_error = "Error in  SQL Client_Get_Related_Aircraft_Info(ByVal " & contact_id & " As string): " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_AC_RelationshipByType
  ' Purpose: Grabbing the company name that's associated with a certain type of reference.
  ' Parameters: acID, contactType
  ' Return: 
  '       Datatable
  ' Change Log
  '           3/25/2016   - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Client_AC_RelationshipByType(ByVal acID As Long, ByVal contactType As String, Optional ByRef comp_id_list As String = "") As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim aTempTable As New DataTable
    Dim sql As String = ""

    Try

      sql = "SELECT DISTINCT clicomp_name as comp_name, clicomp_id as comp_id, 0 as cref_transmit_seq_no FROM client_company"
      sql += " INNER JOIN client_Aircraft_Reference ON (clicomp_id = cliacref_comp_id) WHERE "
      sql += " (cliacref_cliac_id = " & acID & " AND cliacref_contact_type IN (" & contactType & ")) AND clicomp_status = 'Y'"

      If Trim(comp_id_list) <> "" Then
        sql &= " and clicomp_jetnet_comp_id not in (" & Trim(comp_id_list) & ") "
      End If


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_AC_RelationshipByType(ByVal acID As Long, ByVal contactType As String) As DataTable</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable
    Catch ex As Exception
      Get_Client_AC_RelationshipByType = Nothing
      Me.class_error = "Error in  SQL Get_Client_AC_RelationshipByType(ByVal acID As Long, ByVal contactType As String) As DataTable" & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Delete_Client_Transactions_aircraft_reference
  ' Purpose: to delete the transaction record from the clitcref_id
  ' Parameters: clitcref_id
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/07/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Delete_Client_Transactions_aircraft_reference(ByVal clitcref_id As Integer) As Integer
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Delete_Client_Transactions_aircraft_reference = 0
    Try
      sql = "DELETE FROM client_transactions_aircraft_reference WHERE ((clitcref_id = '" & clitcref_id & "')) limit 1"
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Delete_Client_Transactions_aircraft_reference(ByVal clitcref_id As Integer) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Delete_Client_Transactions_aircraft_reference = 1
    Catch ex As Exception
      Delete_Client_Transactions_aircraft_reference = 0
      Me.class_error = "Error in SQL Delete_Client_Transactions_aircraft_reference(ByVal clitcref_id As Integer) As Integer  " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Update_Client_Aircraft_Reference
  ' Purpose: to insert a aircraft reference record 
  ' Parameters: aclsClient_Aircraft_Reference
  ' Return: 
  '       Boolean
  ' Change Log
  '           1/6/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Update_Client_Aircraft_Reference(ByVal aclsClient_Aircraft_Reference As clsClient_Aircraft_Reference) As Boolean
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Update_Client_Aircraft_Reference = False
    Try
      sql = " UPDATE client_aircraft_reference "
      sql = sql & " SET cliacref_cliac_id = " & aclsClient_Aircraft_Reference.cliacref_cliac_id

      sql = sql & ","

      sql = sql & " cliacref_comp_id = " & aclsClient_Aircraft_Reference.cliacref_comp_id

      sql = sql & ","

      sql = sql & " cliacref_contact_id = " & aclsClient_Aircraft_Reference.cliacref_contact_id

      sql = sql & ", "

      sql = sql & " cliacref_contact_type = '" & Left(aclsClient_Aircraft_Reference.cliacref_contact_type, 2) & "'"

      sql = sql & ","

      sql = sql & " cliacref_owner_percentage = '" & aclsClient_Aircraft_Reference.cliacref_owner_percentage & "'"

      sql = sql & ", "

      sql = sql & " cliacref_jetnet_ac_id = '" & aclsClient_Aircraft_Reference.cliacref_jetnet_ac_id & "'"

      sql = sql & ", "


      If Not IsDBNull(aclsClient_Aircraft_Reference.cliacref_date_fraction_purchased) Then
        If IsDate(aclsClient_Aircraft_Reference.cliacref_date_fraction_purchased) Then
          sql = sql & " cliacref_date_fraction_purchased = '" & Format(CDate(aclsClient_Aircraft_Reference.cliacref_date_fraction_purchased), "yyyy-MM-dd HH:mm:ss") & "'"
        Else
          sql = sql & " cliacref_date_fraction_purchased = NULL "
        End If
      Else
        sql = sql & " cliacref_date_fraction_purchased = NULL "
      End If

      sql = sql & ","

      If Not IsDBNull(aclsClient_Aircraft_Reference.cliacref_date_fraction_expires) Then
        If IsDate(aclsClient_Aircraft_Reference.cliacref_date_fraction_expires) Then
          sql = sql & " cliacref_date_fraction_expires = '" & Format(CDate(aclsClient_Aircraft_Reference.cliacref_date_fraction_expires), "yyyy-MM-dd HH:mm:ss") & "'"
        Else
          sql = sql & " cliacref_date_fraction_expires = NULL "
        End If
      Else
        sql = sql & " cliacref_date_fraction_expires = NULL "
      End If

      sql = sql & ", "

      sql = sql & " cliacref_business_type = '" & Left(aclsClient_Aircraft_Reference.cliacref_business_type, 2) & "'"

      sql = sql & ","

      sql = sql & " cliacref_operator_flag = '" & Left(aclsClient_Aircraft_Reference.cliacref_operator_flag, 1) & "'"

      sql = sql & ","

      sql = sql & " cliacref_jetnet_contact_type = '" & Left(aclsClient_Aircraft_Reference.cliacref_jetnet_contact_type, 2) & "'"

      sql = sql & ", "

      sql = sql & " cliacref_contact_priority = '" & aclsClient_Aircraft_Reference.cliacref_contact_priority & "' "


      sql = sql & " WHERE (cliacref_id = " & aclsClient_Aircraft_Reference.cliacref_id & ") limit 1 "

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Update_Client_Aircraft_Reference(ByVal aclsClient_Aircraft_Reference As clsClient_Aircraft_Reference) As Boolean</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Update_Client_Aircraft_Reference = True
    Catch ex As Exception
      Update_Client_Aircraft_Reference = False
      Me.class_error = "Error in SQL Update_Client_Aircraft_Reference(ByVal aclsClient_Aircraft_Reference As clsClient_Aircraft_Reference) as boolean  " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Aircraft_Reference_Client_acID
  ' Purpose: to get an aircraft reference record based on the compID
  ' Parameters: acID
  ' Return: 
  '       DataTable
  ' Change Log
  '           1/24/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Aircraft_Reference_Client_acID(ByVal acID As Integer) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Try
      sql = "SELECT  cliacref_id, cliacref_cliac_id, cliacref_comp_id, cliacref_contact_id, cliacref_contact_type, cliacref_owner_percentage, cliacref_jetnet_ac_id, "
      sql = sql & " cliacref_date_fraction_purchased, cliacref_date_fraction_expires, cliacref_business_type, cliacref_operator_flag, cliacref_jetnet_contact_type, "
      sql = sql & " cliacref_contact_priority "
      sql = sql & " FROM (client_aircraft_reference) "
      sql = sql & " WHERE (cliacref_cliac_id = " & acID & ")"
      sql = sql & " ORDER BY  cliacref_id"

      MySqlConn.ConnectionString = client_DB

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Aircraft_Reference_Client_acID(ByVal acID As Integer) As DataTable</b><br />" & sql
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Return atemptable
    Catch ex As Exception
      Get_Aircraft_Reference_Client_acID = Nothing
      Me.class_error = "Error in SQL Get_Aircraft_Reference_Client_acID(ByVal acID As Integer) As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_Aircraft_Reference_CompID
  ' Purpose: to get an aircraft reference record based on the clicref_contact_id
  ' Parameters: clicref_comp_id
  ' Return: 
  '       Boolean
  ' Change Log
  '           1/31/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Client_Aircraft_Reference_CompID(ByVal clicref_comp_id As Integer) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Try
      sql = "SELECT cliacref_id, cliacref_cliac_id, cliacref_comp_id, cliacref_contact_id, cliacref_contact_type, cliacref_owner_percentage, cliacref_jetnet_ac_id, "
      sql = sql & " cliacref_date_fraction_purchased, cliacref_date_fraction_expires, cliacref_business_type, cliacref_operator_flag, cliacref_jetnet_contact_type, "
      sql = sql & " cliacref_contact_priority "
      sql = sql & " FROM client_aircraft_reference "
      sql = sql & " WHERE (cliacref_comp_id = " & clicref_comp_id & ")"
      sql = sql & " ORDER BY  cliacref_id"

      MySqlConn.ConnectionString = client_DB

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Aircraft_Reference_CompID(ByVal clicref_comp_id As Integer) As DataTable</b><br />" & sql
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      Return atemptable

    Catch ex As Exception
      Get_Client_Aircraft_Reference_CompID = Nothing
      Me.class_error = "Error in SQL Get_Client_Aircraft_Reference_CompID(ByVal clicref_comp_id As Integer) As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try


  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Insert_Client_Aircraft_Reference
  ' Purpose: to insert a aircraft reference record 
  ' Parameters: aclsClient_Aircraft_Reference
  ' Return: 
  '       Boolean
  ' Change Log
  '           2/3/2012    - Created By: Tom Jones
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Insert_Client_Aircraft_Reference(ByVal aclsClient_Aircraft_Reference As clsClient_Aircraft_Reference) As Boolean
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing

    Insert_Client_Aircraft_Reference = 0
    Try
      sql = "INSERT INTO client_aircraft_reference (cliacref_cliac_id, cliacref_comp_id, "
      sql = sql & " cliacref_contact_id, cliacref_contact_type, cliacref_owner_percentage, "
      sql = sql & " cliacref_jetnet_ac_id, cliacref_date_fraction_purchased, "
      sql = sql & " cliacref_date_fraction_expires, cliacref_business_type, "
      sql = sql & " cliacref_operator_flag,cliacref_jetnet_contact_type,cliacref_contact_priority) "
      sql = sql & " VALUES ('"
      sql = sql & aclsClient_Aircraft_Reference.cliacref_cliac_id
      sql = sql & "','"
      sql = sql & aclsClient_Aircraft_Reference.cliacref_comp_id
      sql = sql & "','"
      sql = sql & aclsClient_Aircraft_Reference.cliacref_contact_id
      sql = sql & "','"
      sql = sql & Left(aclsClient_Aircraft_Reference.cliacref_contact_type, 2)
      sql = sql & "','"
      sql = sql & aclsClient_Aircraft_Reference.cliacref_owner_percentage
      sql = sql & "','"
      sql = sql & aclsClient_Aircraft_Reference.cliacref_jetnet_ac_id
      sql = sql & "',"

      If Not IsDBNull(aclsClient_Aircraft_Reference.cliacref_date_fraction_purchased) Then
        If IsDate(aclsClient_Aircraft_Reference.cliacref_date_fraction_purchased) Then
          sql = sql & "'" & Format(CDate(aclsClient_Aircraft_Reference.cliacref_date_fraction_purchased), "yyyy-MM-dd HH:mm:ss") & "'"
        Else
          sql = sql & "NULL"
        End If
      Else
        sql = sql & "NULL"
      End If

      sql = sql & ","

      If Not IsDBNull(aclsClient_Aircraft_Reference.cliacref_date_fraction_expires) Then
        If IsDate(aclsClient_Aircraft_Reference.cliacref_date_fraction_expires) Then
          sql = sql & "'" & Format(CDate(aclsClient_Aircraft_Reference.cliacref_date_fraction_expires), "yyyy-MM-dd HH:mm:ss") & "'"
        Else
          sql = sql & "NULL"
        End If
      Else
        sql = sql & "NULL"
      End If

      sql = sql & ",'"
      sql = sql & Left(aclsClient_Aircraft_Reference.cliacref_business_type, 2)
      sql = sql & "','"
      sql = sql & Left(aclsClient_Aircraft_Reference.cliacref_operator_flag, 1)
      sql = sql & "','"
      sql = sql & Left(aclsClient_Aircraft_Reference.cliacref_jetnet_contact_type, 2)
      sql = sql & "','"
      sql = sql & aclsClient_Aircraft_Reference.cliacref_contact_priority
      sql = sql & "')"
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Insert_Client_Aircraft_Reference(ByVal aclsClient_Aircraft_Reference As clsClient_Aircraft_Reference) As Boolean</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Insert_Client_Aircraft_Reference = 1
    Catch ex As Exception
      Insert_Client_Aircraft_Reference = 0
      Me.class_error = "Error in SQL Insert_Client_Aircraft_Reference(ByVal aclsClient_Aircraft_Reference As clsClient_Aircraft_Reference) As Boolean " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function


  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Delete_Client_Aircraft_Reference_cliacref_id
  ' Purpose: to delete an aircraft reference record based on the cliacref_id
  ' Parameters: compID
  ' Return: 
  '       Boolean
  ' Change Log
  '           2/6/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Delete_Client_Aircraft_Reference_cliacref_id(ByVal acliacref_id As Integer) As Boolean
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing

    Delete_Client_Aircraft_Reference_cliacref_id = False
    Try
      sql = "DELETE FROM client_aircraft_reference WHERE ((cliacref_id = '" & acliacref_id & "')) limit 1"
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Delete_Client_Aircraft_Reference_cliacref_id(ByVal acliacref_id As Integer) As Boolean</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Delete_Client_Aircraft_Reference_cliacref_id = True
    Catch ex As Exception
      Delete_Client_Aircraft_Reference_cliacref_id = False
      Me.class_error = "Error in SQL Delete_Client_Aircraft_Reference_cliacref_id(ByVal acliacref_id As Integer) As Boolean " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Aircraft_Reference_Client_JETNET_acID This will sort by comp ID/contact ID. Make sure references dont' go in twice
  ' Purpose: to get an aircraft reference record based on the jetnet acID
  ' Parameters: ac/compID/contactID
  ' Return: 
  '       Boolean
  ' Change Log
  '           2/7/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Aircraft_Reference_Client_JETNET_acID_SORT(ByVal acID As Integer, ByVal compID As Integer, ByVal contactID As Integer) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Try
      sql = "SELECT  cliacref_id, cliacref_cliac_id, cliacref_comp_id, cliacref_contact_id, cliacref_contact_type, cliacref_owner_percentage, cliacref_jetnet_ac_id, "
      sql = sql & " cliacref_date_fraction_purchased, cliacref_date_fraction_expires, cliacref_business_type, cliacref_operator_flag, cliacref_jetnet_contact_type, "
      sql = sql & " cliacref_contact_priority"
      sql = sql & " FROM  client_aircraft_reference WHERE (cliacref_jetnet_ac_id = '" & acID & "')"

      If contactID <> 0 Then
        sql = sql & " and (cliacref_comp_id = '" & compID & "' or cliacref_contact_id = '" & contactID & "')"
      Else
        sql = sql & " and (cliacref_comp_id = '" & compID & "')"
      End If

      MySqlConn.ConnectionString = client_DB

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Aircraft_Reference_Client_JETNET_acID_SORT(ByVal acID As Integer, ByVal compID As Integer, ByVal contactID As Integer) As DataTable</b><br />" & sql
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Return atemptable
    Catch ex As Exception
      Get_Aircraft_Reference_Client_JETNET_acID_SORT = Nothing
      Me.class_error = "Error in SQL Get_Aircraft_Reference_Client_JETNET_acID_SORT(ByVal acID As Integer, ByVal compID As Integer, ByVal contactID As Integer) As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

#End Region
#Region "Users"

  Public Function Get_CRM_Central_Client_User(ByVal cliuser_id As Integer, ByVal regID As Long) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim aTempTable As New DataTable

    Try
      sql = "SELECT cliuser_id, cliuser_session_guid, cliuser_client_regid, cliuser_first_name, cliuser_last_name,"
      sql += " cliuser_login, cliuser_email_address, cliuser_user_id, cliuser_jetnet_contact_id, cliuser_loggedin_flag, cliuser_last_login_date,"
      sql += " cliuser_last_session_date, cliuser_last_logout_date FROM client_user"
      sql += " WHERE (cliuser_user_id = " + cliuser_id.ToString + " AND cliuser_client_regid = " + regID.ToString + ")"

      MySqlConn.ConnectionString = HttpContext.Current.Application.Item("crmMasterDatabase")

      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      MySqlCommand.CommandText = sql

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_CRM_Central_Client_User(ByVal cliuser_id As Integer, ByVal regID As Long) As DataTable</b><br />" + sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable
    Catch ex As Exception
      Get_CRM_Central_Client_User = Nothing
      Me.class_error = "Error in  SQL Get_CRM_Central_Client_User(ByVal cliuser_id As Integer, ByVal regID As Long): " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try



  End Function

  Public Function Insert_Blank_CRM_Central_Client_User(ByVal cliuser_id As Integer, ByVal regID As Long, ByVal uniqueGUID As String, ByVal first_name As String, ByVal last_name As String, ByVal login As String, ByVal email_address As String) As Integer
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing

    Try

      sql = "INSERT INTO client_user (cliuser_session_guid, cliuser_client_regid, cliuser_first_name, cliuser_last_name, cliuser_login, cliuser_email_address,"
      sql += " cliuser_user_id, cliuser_loggedin_flag, cliuser_last_login_date, cliuser_last_session_date, cliuser_last_logout_date)"
      sql += " VALUES ('" + uniqueGUID.Trim + "', " + regID.ToString + ", '" + first_name.Trim + "', '" + last_name.Trim + "','" + login.Trim + "', '" + email_address.Trim + "'," + cliuser_id.ToString + ",'Y',NULL,NULL,NULL)"


      MySqlConn.ConnectionString = HttpContext.Current.Application.Item("crmMasterDatabase")


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Insert_Blank_CRM_Central_Client_User(ByVal cliuser_id As Integer, ByVal regID As Long, ByVal uniqueGUID As String, ByVal first_name As String, ByVal last_name As String, ByVal login As String, ByVal email_address As String) As Integer</b><br />" + sql

      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()


      Return 1
    Catch ex As Exception
      Insert_Blank_CRM_Central_Client_User = 0
      Me.class_error = "Error in  SQL Get_CRM_Central_Client_User(ByVal cliuser_id As Integer, ByVal regID As Long): " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try



  End Function

  Public Function Update_CRM_Central_Client_User(ByVal cliuser_id As Integer, ByVal regID As Long, ByVal cliuser_login As String, ByVal cliuser_seq_no As Integer, ByVal cliuser_contact_id As Integer) As Integer
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlConn2 As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand2 As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing

    Try

      sql = "UPDATE client_user SET"
      sql += " cliuser_jetnet_login = '" + cliuser_login.Trim + "',"
      sql += " cliuser_jetnet_seq_no = " + cliuser_seq_no.ToString + ","
      sql += " cliuser_jetnet_contact_id = " + cliuser_contact_id.ToString
      sql += " WHERE (cliuser_user_id = " + cliuser_id.ToString + ") AND (cliuser_client_regid = " + regID.ToString + ")"


      MySqlConn.ConnectionString = HttpContext.Current.Application.Item("crmMasterDatabase")

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Update_CRM_Central_Client_User(ByVal cliuser_id As Integer, ByVal regID As Long, ByVal cliuser_login As String, ByVal cliuser_seq_no As Integer, ByVal cliuser_contact_id As Integer) As Integer</b><br />" + sql

      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()

      sql = "UPDATE client_user SET"
      sql += " cliuser_jetnet_login = '" + cliuser_login.Trim + "',"
      sql += " cliuser_jetnet_seq_no = " + cliuser_seq_no.ToString + ","
      sql += " cliuser_jetnet_contact_id = " + cliuser_contact_id.ToString
      sql += " WHERE (cliuser_id = " + cliuser_id.ToString + ")"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Update_CRM_Central_Client_User(ByVal cliuser_id As Integer, ByVal regID As Long, ByVal cliuser_login As String, ByVal cliuser_seq_no As Integer, ByVal cliuser_contact_id As Integer) As Integer</b><br />" + sql

      MySqlConn2.ConnectionString = client_DB
      MySqlConn2.Open()

      MySqlCommand2.Connection = MySqlConn2
      MySqlCommand2.CommandType = CommandType.Text
      MySqlCommand2.CommandTimeout = 60

      MySqlCommand2.CommandText = sql
      MySqlCommand2.ExecuteNonQuery()

      Return 1
    Catch ex As Exception
      Update_CRM_Central_Client_User = 0
      Me.class_error = "Error in  SQL Get_CRM_Central_Client_User(ByVal cliuser_id As Integer, ByVal regID As Long): " & ex.Message
    Finally

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing

      MySqlConn2.Dispose()
      MySqlConn2.Close()
      MySqlConn2 = Nothing
      MySqlCommand2.Dispose()
      MySqlCommand2 = Nothing
    End Try



  End Function

  Public Function Update_GUID_Central_Client_User(ByVal cliuser_id As Integer, ByVal regID As Long,
                                                  ByVal uniqueGUID As String, ByVal crmLocalUserFirstName As String,
                                                  ByVal crmLocalUserLastName As String, ByVal crmUserLogin As String,
                                                  ByVal crmLocalUserEmailAddress As String) As Integer
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing

    Try

      sql = "UPDATE client_user SET"
      sql += " cliuser_first_name = '" + crmLocalUserFirstName.Trim + "',"
      sql += " cliuser_last_name = '" + crmLocalUserLastName.Trim + "',"
      sql += " cliuser_login = '" + crmUserLogin.Trim + "',"
      sql += " cliuser_email_address = '" + crmLocalUserEmailAddress.Trim + "',"
      sql += " cliuser_session_guid = '" + uniqueGUID.Trim + "'"
      sql += " WHERE cliuser_client_regid = " + regID.ToString + " AND cliuser_user_id = " + cliuser_id.ToString + " limit 1"""


      MySqlConn.ConnectionString = HttpContext.Current.Application.Item("crmMasterDatabase")

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Update_GUID_Central_Client_User(ByVal cliuser_id As Integer, ByVal regID As Long, ByVal uniqueGUID As String, ByVal crmLocalUserFirstName As String, ByVal crmLocalUserLastName As String, ByVal crmUserLogin As String, ByVal crmLocalUserEmailAddress As String) As Integer</b><br />" & sql

      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()


      Return 1
    Catch ex As Exception
      Update_GUID_Central_Client_User = 0
      Me.class_error = "Error in  SQL Update_GUID_Central_Client_User(ByVal cliuser_id As Integer, ByVal regID As Long, ByVal uniqueGUID As String) As Integer: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try



  End Function

  ''' <summary>
  ''' Update_Client_User_Dates - This updates all the timestamps on the user record depending on the variable what action
  ''' </summary>
  ''' <param name="cliuser_id">user ID</param>
  ''' <param name="logged_status">logged in status</param>
  ''' <param name="what_action">login/dlogout/session</param>
  ''' <returns>integer. 1 = through, 0 = error</returns>
  ''' <remarks></remarks>
  Public Function CRM_Central_Update_Client_User_Dates(ByVal cliuser_id As Integer, ByVal regID As Long, ByVal logged_status As String, ByVal what_action As String, ByVal timestamp As Date) As Integer
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    'Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Try
      If cliuser_id <> 0 And regID <> 0 Then

        MySqlConn.ConnectionString = HttpContext.Current.Application.Item("crmMasterDatabase")


        MySqlConn.Open()
        MySqlCommand.Connection = MySqlConn
        MySqlCommand.CommandType = CommandType.Text
        MySqlCommand.CommandTimeout = 60
        Dim update_string As String = ""
        ' fill the data sets
        'If what_action = "login" Then
        '    'This means that the user is logged in or being logged in. Status needs to be updated
        '    update_string = "UPDATE client_user SET cliuser_last_login_date = '" & Format(timestamp, "yyyy-MM-dd H:mm:ss") & "', cliuser_last_session_date = '" & Format(timestamp, "yyyy-MM-dd H:mm:ss") & "', cliuser_loggedin_flag = '" & logged_status & "' WHERE (cliuser_user_id = " & cliuser_id & ") and (cliuser_client_regid = " & regID & ") limit 1"
        '    MySqlCommand.CommandText = update_string
        '    MySqlCommand.ExecuteNonQuery()
        If what_action = "main_login" Then
          'This means that the user is logged in or being logged in. Status needs to be updated
          update_string = "UPDATE client_user SET cliuser_last_login_date = '" & Format(timestamp, "yyyy-MM-dd H:mm:ss") & "', cliuser_last_session_date = '" & Format(timestamp, "yyyy-MM-dd H:mm:ss") & "', cliuser_loggedin_flag = '" & logged_status & "', cliuser_last_logout_date = NULL WHERE (cliuser_user_id = " & cliuser_id & ") and (cliuser_client_regid = " & regID & ")  limit 1"
          MySqlCommand.CommandText = update_string
          MySqlCommand.ExecuteNonQuery()
        ElseIf what_action = "logout" Then
          update_string = "UPDATE client_user SET cliuser_last_logout_date = '" & Format(timestamp, "yyyy-MM-dd H:mm:ss") & "', cliuser_session_guid = '', cliuser_last_session_date = '" & Format(timestamp, "yyyy-MM-dd H:mm:ss") & "', cliuser_loggedin_flag = '" & logged_status & "' WHERE (cliuser_user_id = " & cliuser_id & ") and (cliuser_client_regid = " & regID & ") limit 1"
          MySqlCommand.CommandText = update_string
          MySqlCommand.ExecuteNonQuery()
        ElseIf what_action = "session" Then
          update_string = "UPDATE client_user SET cliuser_last_session_date = '" & Format(timestamp, "yyyy-MM-dd H:mm:ss") & "' WHERE (cliuser_user_id = " & cliuser_id & ")  and (cliuser_client_regid = " & regID & ") limit 1"
          MySqlCommand.CommandText = update_string
          MySqlCommand.ExecuteNonQuery()
        End If

        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Update_Client_User_Dates(ByVal cliuser_id As Integer, ByVal logged_status As String, ByVal what_action As String, ByVal timestamp As Date) As Integer</b><br />" & update_string

        CRM_Central_Update_Client_User_Dates = 1
      Else
        CRM_Central_Update_Client_User_Dates = 0
      End If
    Catch ex As Exception
      CRM_Central_Update_Client_User_Dates = 0
      Me.class_error = "Error in CRM_Central_Update_Client_User_Dates(ByVal cliuser_id As Integer, ByVal regID As Long, ByVal logged_status As String, ByVal what_action As String, ByVal timestamp As Date) As Integer " & ex.Message
    Finally
      MySqlCommand.Dispose()
      MySqlConn.Close()
      MySqlConn.Dispose()
    End Try
  End Function


  '''' <summary>
  '''' Update_Client_User_Dates - This updates all the timestamps on the user record depending on the variable what action
  '''' </summary>
  '''' <param name="cliuser_id">user ID</param>
  '''' <param name="logged_status">logged in status</param>
  '''' <param name="what_action">login/dlogout/session</param>
  '''' <returns>integer. 1 = through, 0 = error</returns>
  '''' <remarks></remarks>
  'Public Function Update_Client_User_Dates(ByVal cliuser_id As Integer, ByVal logged_status As String, ByVal what_action As String, ByVal timestamp As Date) As Integer
  '    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
  '    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
  '    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
  '    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
  '    Try

  '        MySqlConn.ConnectionString = Me.client_DB
  '        MySqlConn.Open()
  '        MySqlCommand.Connection = MySqlConn
  '        MySqlCommand.CommandType = CommandType.Text
  '        MySqlCommand.CommandTimeout = 60
  '        Dim update_string As String = ""
  '        ' fill the data sets
  '        If what_action = "login" Then
  '            'This means that the user is logged in or being logged in. Status needs to be updated
  '            update_string = "UPDATE client_user SET cliuser_last_login_date = '" & Format(timestamp, "yyyy-MM-dd H:mm:ss") & "', cliuser_last_session_date = '" & Format(timestamp, "yyyy-MM-dd H:mm:ss") & "', cliuser_loggedin_flag = '" & logged_status & "' WHERE (cliuser_id = " & cliuser_id & ") limit 1"
  '            MySqlCommand.CommandText = update_string
  '            MySqlCommand.ExecuteNonQuery()
  '        ElseIf what_action = "logout" Then
  '            update_string = "UPDATE client_user SET cliuser_last_logout_date = '" & Format(timestamp, "yyyy-MM-dd H:mm:ss") & "', cliuser_last_session_date = '" & Format(timestamp, "yyyy-MM-dd H:mm:ss") & "', cliuser_loggedin_flag = '" & logged_status & "' WHERE (cliuser_id = " & cliuser_id & ") limit 1"
  '            MySqlCommand.CommandText = update_string
  '            MySqlCommand.ExecuteNonQuery()
  '        ElseIf what_action = "session" Then
  '            update_string = "UPDATE client_user SET cliuser_last_session_date = '" & Format(timestamp, "yyyy-MM-dd H:mm:ss") & "' WHERE (cliuser_id = " & cliuser_id & ") limit 1"
  '            MySqlCommand.CommandText = update_string
  '            MySqlCommand.ExecuteNonQuery()
  '        End If

  '        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Update_Client_User_Dates(ByVal cliuser_id As Integer, ByVal logged_status As String, ByVal what_action As String, ByVal timestamp As Date) As Integer</b><br />" & update_string

  '        Update_Client_User_Dates = 1

  '    Catch ex As Exception
  '        Update_Client_User_Dates = 0
  '        Me.class_error = "Error in Update_Client_User_Dates(ByVal cliuser_id As Integer, ByVal  logged_status As String, ByVal what_action As String) As Integer " & ex.Message
  '    Finally
  '        MySqlCommand.Dispose()
  '        MySqlConn.Close()
  '        MySqlConn.Dispose()
  '    End Try
  'End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_AllClientUser_Active
  ' Purpose: to get all the active client users
  ' Parameters: 
  ' Return: 
  '       datatable
  ' Change Log
  '           9/8/2011    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_AllClientUser_Active(ByVal cliuser_active_flag As String) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim aTempTable As New DataTable
    Try
      sql = "SELECT cliuser_action_date, cliuser_active_flag, cliuser_admin_flag, "
      sql = sql & " cliuser_email_address, cliuser_end_date, cliuser_first_name, "
      sql = sql & " cliuser_id, cliuser_last_login, cliuser_last_login_date, "
      sql = sql & " cliuser_last_logout_date, cliuser_last_name, cliuser_last_session_date, "
      sql = sql & " cliuser_loggedin_flag, cliuser_login, cliuser_password, cliuser_timezone, "
      sql = sql & " cliuser_user_id FROM client_user "

      If Trim(cliuser_active_flag) = "A" Then
        sql = sql & " WHERE cliuser_password is not NULL " ' dont worry about active or inactive status 
      Else
        sql = sql & " WHERE (cliuser_active_flag = '" & cliuser_active_flag & "' and cliuser_password is not NULL)"
      End If




      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_AllClientUser_Active(ByVal cliuser_active_flag As String) As DataTable</b><br />" & sql


      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable
    Catch ex As Exception
      Get_AllClientUser_Active = Nothing
      Me.class_error = "Error in  SQL Get_AllClientUser_Active(ByVal cliuser_active_flag As String): " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try



  End Function
  '''' <summary>
  '''' compares user login to active dates
  '''' </summary>
  '''' <param name="cliuser_id"></param>
  '''' <returns></returns>
  '''' <remarks></remarks>
  'Public Function Compare_Client_User_Dates(ByVal cliuser_id As Integer) As DataTable
  '    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
  '    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
  '    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
  '    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
  '    Try

  '        MySqlConn.ConnectionString = Me.client_DB
  '        MySqlConn.Open()
  '        MySqlCommand.Connection = MySqlConn
  '        MySqlCommand.CommandType = CommandType.Text
  '        MySqlCommand.CommandTimeout = 60
  '        Dim atemptable As New DataTable

  '        Dim update_string As String = "select cliuser_last_session_date,cliuser_last_login_date, cliuser_last_logout_date from client_user WHERE (cliuser_id = " & cliuser_id & ") limit 1"

  '        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Compare_Client_User_Dates(ByVal cliuser_id As Integer) As DataTable</b><br />" & update_string



  '        MySqlCommand.CommandText = update_string
  '        MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

  '        Try
  '            atemptable.Load(MySqlReader)
  '        Catch constrExc As System.Data.ConstraintException
  '            Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
  '        End Try

  '        Return atemptable

  '    Catch ex As Exception
  '        Compare_Client_User_Dates = Nothing
  '        Me.class_error = "Error in Compare_Client_User_Dates(ByVal cliuser_id As Integer) As Datatable " & ex.Message
  '    Finally
  '        MySqlReader.Close()
  '        MySqlReader = Nothing

  '        MySqlCommand.Dispose()
  '        MySqlConn.Close()
  '        MySqlConn.Dispose()
  '    End Try
  'End Function

  ''' <summary>
  ''' compares user login to active dates
  ''' </summary>
  ''' <param name="cliuser_id"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function CRM_Central_Compare_Client_User_Dates(ByVal cliuser_id As Integer, ByVal regID As Long) As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Try


      MySqlConn.ConnectionString = HttpContext.Current.Application.Item("crmMasterDatabase")

      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60
      Dim atemptable As New DataTable

      Dim update_string As String = "select cliuser_last_session_date,cliuser_last_login_date, cliuser_last_logout_date from client_user WHERE (cliuser_user_id = " & cliuser_id & ") and (cliuser_client_regid = " & regID & ") limit 1"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>CRM_Central_Compare_Client_User_Dates(ByVal cliuser_id As Integer, ByVal regID As Long) As DataTable</b><br />" & update_string



      MySqlCommand.CommandText = update_string
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Return atemptable

    Catch ex As Exception
      CRM_Central_Compare_Client_User_Dates = Nothing
      Me.class_error = "Error in CRM_Central_Compare_Client_User_Dates(ByVal cliuser_id As Integer, ByVal regID As Long) As DataTable " & ex.Message
    Finally
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlCommand.Dispose()
      MySqlConn.Close()
      MySqlConn.Dispose()
    End Try
  End Function


  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_Timezone
  ' Purpose: to get the client users based on the cliuser_id 
  ' Parameters: cliuser_id
  ' Return: 
  '       datatable
  ' Change Log
  '           1/11/2012    - Created By: Tom Jones
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Client_User(ByVal cliuser_id As Integer) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim aTempTable As New DataTable

    Try
      sql = "SELECT cliuser_action_date, cliuser_active_flag, cliuser_admin_flag, cliuser_email_address, cliuser_end_date, cliuser_first_name, cliuser_id, cliuser_last_login, cliuser_last_login_date, cliuser_last_logout_date, cliuser_last_name, cliuser_last_session_date, cliuser_loggedin_flag, cliuser_login, cliuser_password, cliuser_timezone, cliuser_user_id FROM client_user WHERE (cliuser_id = " & cliuser_id & ")"

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_User(ByVal cliuser_id As Integer) As DataTable</b><br />" & sql


      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable
    Catch ex As Exception
      Get_Client_User = Nothing
      Me.class_error = "Error in  SQL Get_Client_User(ByVal cliuser_id As Integer): " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try



  End Function


  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_User
  ' Purpose: to get all the client users
  ' Parameters: 
  ' Return: 
  '       datatable
  ' Change Log
  '           1/12/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Client_User_List(Optional ByVal get_only_active As Boolean = False) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim aTempTable As New DataTable

    Try
      sql = "SELECT cliuser_id, cliuser_first_name, cliuser_last_name, cliuser_login, "
      sql = sql & " cliuser_password, cliuser_admin_flag, cliuser_email_address, cliuser_action_date, "
      sql = sql & " cliuser_user_id, cliuser_timezone, cliuser_last_login, cliuser_loggedin_flag, "
      sql = sql & " cliuser_last_login_date, cliuser_last_session_date, cliuser_last_logout_date, "
      sql = sql & " cliuser_active_flag, cliuser_end_date"
      sql = sql & " FROM client_user "

      If get_only_active = True Then
        sql = sql & " Where cliuser_active_flag = 'Y' "
      End If

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_User() As DataTable</b><br />" & sql

      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable

    Catch ex As Exception
      Get_Client_User_List = Nothing
      Me.class_error = "Error in  SQL Get_Client_User_List(): " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try



  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Update_Client_User
  ' Purpose: to get the client users based on the cliuser_id 
  ' Parameters: cliuser_id
  ' Return: 
  '       datatable
  ' Change Log
  '           2/4/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Update_Client_User(ByVal cliuser_first_name As String, ByVal cliuser_last_name As String, ByVal cliuser_login As String, ByVal cliuser_password As String, ByVal cliuser_admin_flag As String, ByVal cliuser_email_address As String, ByVal cliuser_action_date As String, ByVal cliuser_user_id As Integer, ByVal cliuser_timezone As String, ByVal cliuser_end_date As Nullable(Of System.DateTime), ByVal cliuser_id As Integer) As Integer
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Update_Client_User = 0
    Try
      sql = "UPDATE  client_user"
      sql = sql & " SET cliuser_first_name = '" & Left(cliuser_first_name, 15) & "', "
      sql = sql & " cliuser_last_name = '" & Left(cliuser_last_name, 25) & "', "
      sql = sql & " cliuser_login = '" & Left(cliuser_login, 50) & "', "
      sql = sql & " cliuser_password = '" & Left(cliuser_password, 25) & "', "
      sql = sql & " cliuser_admin_flag = '" & Left(cliuser_admin_flag, 1) & "', "
      sql = sql & " cliuser_email_address = '" & Left(cliuser_email_address, 60) & "', "
      If IsDate(cliuser_action_date) Then
        sql = sql & " cliuser_action_date = '" & Format(CDate(cliuser_action_date), "yyyy-MM-dd H:mm:ss") & "', "
      Else
        sql = sql & " cliuser_action_date = NOW(), "
      End If
      sql = sql & " cliuser_user_id = '" & cliuser_user_id & "', "
      sql = sql & " cliuser_timezone = '" & cliuser_timezone & "', "

      If Not IsDBNull(cliuser_end_date) Then
        If IsDate(cliuser_end_date) Then
          sql = sql & " cliuser_end_date = '" & Format(CDate(cliuser_end_date), "yyyy-MM-dd H:mm:ss") & "' "
        Else
          sql = sql & " cliuser_end_date = NULL "
        End If
      Else
        sql = sql & " cliuser_end_date = NULL "
      End If

      sql = sql & " WHERE (cliuser_id = '" & cliuser_id & "') limit 1 "


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Update_Client_User(ByVal cliuser_first_name As String, ByVal cliuser_last_name As String, ByVal cliuser_login As String, ByVal cliuser_password As String, ByVal cliuser_admin_flag As String, ByVal cliuser_email_address As String, ByVal cliuser_action_date As String, ByVal cliuser_user_id As Integer, ByVal cliuser_timezone As String, ByVal cliuser_end_date As Nullable(Of System.DateTime), ByVal cliuser_id As Integer) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Update_Client_User = 1
    Catch ex As Exception
      Update_Client_User = 0
      Me.class_error = "Error in SQL Update_Client_User(ByVal cliuser_first_name As String, ByVal cliuser_last_name As String, ByVal cliuser_login As String, ByVal cliuser_password As String, ByVal cliuser_admin_flag As String, ByVal cliuser_email_address As String, ByVal cliuser_action_date As String, ByVal cliuser_user_id As Integer, ByVal cliuser_timezone As String, ByVal cliuser_end_date As Nullable(Of System.DateTime), ByVal cliuser_id As Integer) As Integer  " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Update_Client_User_Active_Flag
  ' Purpose: to get all the active client users
  ' Parameters: 
  ' Return: 
  '       datatable
  ' Change Log
  '           2/4/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Update_Client_User_Active_Flag(ByVal cliuser_active_flag As String, ByVal cliuser_id As Integer) As Integer
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Update_Client_User_Active_Flag = 0
    Try
      sql = "UPDATE  client_user"
      sql = sql & " SET cliuser_active_flag = '" & Left(cliuser_active_flag, 1) & "' "

      sql = sql & " WHERE (cliuser_id = '" & cliuser_id & "') limit 1 "


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Update_Client_User_Active_Flag(ByVal cliuser_active_flag As String, ByVal cliuser_id As Integer) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Update_Client_User_Active_Flag = 1
    Catch ex As Exception
      Update_Client_User_Active_Flag = 0
      Me.class_error = "Error in SQL Update_Client_User_Active_Flag(ByVal cliuser_active_flag As String, ByVal cliuser_id As Integer) As Integer  " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Update_Client_User_Password
  ' Purpose: to update only the password
  ' Parameters: 
  ' Return: 
  '       datatable
  ' Change Log
  '           7/26/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Update_Client_User_Password(ByVal cliuser_password As String, ByVal cliuser_recsperpage As Integer, ByVal cliuser_aircraft_relationship As String, ByVal cliuser_timezone As Integer, ByVal cliuser_id As Integer, ByVal cliuser_autolog_flag As String) As Integer
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Dim sql_where As String = ""
    Update_Client_User_Password = 0
    Try
      sql = "UPDATE client_user SET "

      If cliuser_password <> "" Then
        sql_where = " cliuser_password = '" & Left(cliuser_password, 25) & "' "
      End If

      If cliuser_autolog_flag <> "" Then
        If sql_where <> "" Then
          sql_where = sql_where & " , "
        End If
        sql_where = sql_where & " cliuser_autolog_flag = '" & Left(cliuser_autolog_flag, 1) & "' "
      End If

      If cliuser_recsperpage <> 0 Then
        If IsNumeric(cliuser_recsperpage) Then
          If sql_where <> "" Then
            sql_where = sql_where & " , "
          End If
          sql_where = sql_where & " cliuser_recs_per_page = '" & cliuser_recsperpage & "' "
        End If
      End If

      If cliuser_timezone <> 0 Then
        If IsNumeric(cliuser_timezone) Then
          If sql_where <> "" Then
            sql_where = sql_where & " , "
          End If
          sql_where = sql_where & " cliuser_timezone = '" & cliuser_timezone & "' "
        End If
      End If

      If cliuser_aircraft_relationship <> "" Then
        If sql_where <> "" Then
          sql_where = sql_where & " , "
        End If
        If cliuser_aircraft_relationship = "All Companies" Then
          cliuser_aircraft_relationship = ""
        End If
        sql_where = sql_where & " cliuser_aircraft_relationship = '" & Left(cliuser_aircraft_relationship, 40) & "' "
      End If

      sql = sql & sql_where
      sql = sql & " WHERE (cliuser_id = '" & cliuser_id & "') limit 1 "


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Update_Client_User_Password(ByVal cliuser_password As String, ByVal cliuser_id As Integer) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Update_Client_User_Password = 1
    Catch ex As Exception
      Update_Client_User_Password = 0
      Me.class_error = "Error in SQL Update_Client_User_Password(ByVal cliuser_password As String, ByVal cliuser_id As Integer) As Integer  " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try


  End Function

  ''' <summary>
  ''' Searches users for user email address to see if a user with this email address exists.
  ''' </summary>
  ''' <param name="cliuser_email"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Get_Client_User_By_Email_Address(ByVal cliuser_email As String) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim aTempTable As New DataTable

    Try
      sql = "SELECT cliuser_action_date, cliuser_active_flag, cliuser_admin_flag, cliuser_email_address, cliuser_end_date, cliuser_first_name, cliuser_id, cliuser_last_login, cliuser_last_login_date, cliuser_last_logout_date, cliuser_last_name, cliuser_last_session_date, cliuser_loggedin_flag, cliuser_login, cliuser_password, cliuser_timezone, cliuser_user_id FROM client_user WHERE (cliuser_email_address = '" & cliuser_email & "')"

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_User_By_Email_Address(ByVal cliuser_email As String) As DataTable</b><br />" & sql


      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Return aTempTable
    Catch ex As Exception
      Get_Client_User_By_Email_Address = Nothing
      Me.class_error = "Error in  SQL Get_Client_User_By_Email_Address(ByVal cliuser_email As String) As DataTable: " & ex.Message
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />Error in  SQL Get_Client_User_By_Email_Address(ByVal cliuser_email As String) As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try



  End Function



  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Insert_Client_User_Return
  ' Purpose: to get the client users based on the cliuser_id 
  ' Parameters: cliuser_id
  ' Return: 
  '       datatable
  ' Change Log
  '           5/10/2013    - Created By: Amanda Jennings
  'Changed blank password to insert null.

  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Insert_Client_User_Return(ByVal cliuser_first_name As String, ByVal cliuser_last_name As String, ByVal cliuser_login As String, ByVal cliuser_password As String, ByVal cliuser_admin_flag As String, ByVal cliuser_email_address As String, ByVal cliuser_action_date As String, ByVal cliuser_user_id As Integer, ByVal cliuser_timezone As String, ByVal cliuser_end_date As Nullable(Of System.DateTime)) As Integer
    Dim atemptable As New DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim sql As String = ""
    Dim returned_id As Integer = 0
    Insert_Client_User_Return = 0
    Try



      sql = " insert INTO client_user"
      sql = sql & " (cliuser_first_name, cliuser_last_name, cliuser_login, cliuser_password, cliuser_admin_flag, cliuser_email_address, cliuser_action_date, cliuser_user_id, "
      sql = sql & " cliuser_timezone, cliuser_end_date)"
      sql = sql & " VALUES ('" & Left(cliuser_first_name, 15) & "', "
      sql = sql & " '" & Left(cliuser_last_name, 25) & "', "
      sql = sql & " '" & Left(cliuser_login, 50) & "', "
      If cliuser_password <> "" Then
        sql = sql & " '" & Left(cliuser_password, 25) & "', "
      Else
        sql = sql & " NULL, "
      End If
      sql = sql & " '" & Left(cliuser_admin_flag, 1) & "', "
      sql = sql & " '" & Left(cliuser_email_address, 60) & "', "

      If IsDate(cliuser_action_date) Then
        sql = sql & " '" & Format(CDate(cliuser_action_date), "yyyy-MM-dd HH:mm:ss") & "', "
      Else
        sql = sql & " NOW(), "
      End If

      sql = sql & " '" & cliuser_user_id & "',  "
      sql = sql & " '" & cliuser_timezone & "', "

      If Not IsDBNull(cliuser_end_date) Then
        If IsDate(cliuser_end_date) Then
          sql = sql & " '" & Format(CDate(cliuser_end_date), "yyyy-MM-dd HH:mm:ss") & "') "
        Else
          sql = sql & " NULL) "
        End If
      Else
        sql = sql & " NULL) "
      End If



      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Insert_Client_User_Return(ByVal cliuser_first_name As String, ByVal cliuser_last_name As String, ByVal cliuser_login As String, ByVal cliuser_password As String, ByVal cliuser_admin_flag As String, ByVal cliuser_email_address As String, ByVal cliuser_action_date As String, ByVal cliuser_user_id As Integer, ByVal cliuser_timezone As String, ByVal cliuser_end_date As Nullable(Of System.DateTime)) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()


      sql = "select cliuser_id from client_user order by cliuser_id desc"
      MySqlCommand.CommandText = sql

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />Insert_Note(ByVal aclsLocal_Notes As clsLocal_Notes) As Integer" & sql

      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try


      If atemptable.Rows.Count > 0 Then
        returned_id = atemptable.Rows(0).Item("cliuser_id")
      End If

      Insert_Client_User_Return = returned_id

    Catch ex As Exception
      Insert_Client_User_Return = 0
      Me.class_error = "Error in SQL Insert_Client_User_Return(ByVal cliuser_first_name As String, ByVal cliuser_last_name As String, ByVal cliuser_login As String, ByVal cliuser_password As String, ByVal cliuser_admin_flag As String, ByVal cliuser_email_address As String, ByVal cliuser_action_date As String, ByVal cliuser_user_id As Integer, ByVal cliuser_timezone As String, ByVal cliuser_end_date As Nullable(Of System.DateTime)) As Integer " & ex.Message
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />Error in SQL Insert_Client_User_Return(ByVal cliuser_first_name As String, ByVal cliuser_last_name As String, ByVal cliuser_login As String, ByVal cliuser_password As String, ByVal cliuser_admin_flag As String, ByVal cliuser_email_address As String, ByVal cliuser_action_date As String, ByVal cliuser_user_id As Integer, ByVal cliuser_timezone As String, ByVal cliuser_end_date As Nullable(Of System.DateTime)) As Integer " & ex.Message

    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  ''' <summary>
  ''' This only updates the client user default models on the client user table.
  ''' </summary>
  ''' <param name="DefaultModels"></param>
  ''' <param name="cliuser_id"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Update_Client_User_Default_Models(ByVal DefaultModels As String, ByVal cliuser_id As Integer) As Integer
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sqlQuery As String = ""
    Update_Client_User_Default_Models = 0
    Try

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()

      sqlQuery = "UPDATE client_user "
      sqlQuery += " SET cliuser_default_models = @cliuser_default_models "
      sqlQuery += " WHERE (cliuser_id = @cliuser_id) limit 1 "

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Update_Client_User_Default_Models(ByVal DefaultModels As String, ByVal cliuser_id As Integer) As Integer</b><br />" & sqlQuery

      Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand(sqlQuery, MySqlConn)

      MySqlCommand.Parameters.AddWithValue("@cliuser_default_models", Left(DefaultModels, 65535))
      MySqlCommand.Parameters.AddWithValue("@cliuser_id", cliuser_id)

      MySqlCommand.ExecuteNonQuery()
      Update_Client_User_Default_Models = 1

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    Catch ex As Exception
      Update_Client_User_Default_Models = 0
      Me.class_error = "Error in SQL Update_Client_User_Default_Models(ByVal DefaultModels As String, ByVal cliuser_id As Integer) As Integer " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
    End Try
  End Function

#End Region
#Region "RegisterMasterTable, Database Information For Evolution Side Server Notes"

  Public Function Get_Server_Notes_DBInfo_Evo_Side(ByVal regID As Long) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim aTempTable As New DataTable

    Try
      sql = "SELECT client_dbhost, client_dbDatabase, client_dbUID, client_dbPWD FROM Client_Register_Master WHERE client_regID = " & regID & " limit 1 "


      MySqlConn.ConnectionString = HttpContext.Current.Application.Item("crmMasterDatabase")

      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Server_Notes_DBInfo_Evo_Side(ByVal regID As Long) As DataTable</b><br />" & sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      'HttpContext.Current.Session.Item("localUser").crmUser_CRM_Database_Not_Available = False

      Return aTempTable
    Catch ex As Exception
      'HttpContext.Current.Session.Item("localUser").crmUser_CRM_Database_Not_Available = True
      Get_Server_Notes_DBInfo_Evo_Side = Nothing
      Me.class_error = "Error in  SQL Get_Server_Notes_DBInfo_Evo_Side(ByVal regID As Long) As DataTable: " & ex.Message
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />Error in  SQL Get_Server_Notes_DBInfo_Evo_Side(ByVal regID As Long) As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try



  End Function
#End Region
#Region "Only Model Client"
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Insert_Client_Aircraft_Model
  ' Purpose: to insert a client aircraft model
  ' Parameters: clsClient_Aircraft_Model
  ' Return: 
  '       integer
  ' Change Log
  '           1/5/2011    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Insert_Client_Aircraft_Model(ByVal aclsClient_Aircraft_Model As clsClient_Aircraft_Model) As Integer
    Dim sql As String = ""

    Dim returned_id As Integer = 0

    Dim atemptable As New DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Try

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()


      sql = " INSERT INTO client_aircraft_model (cliamod_airframe_type, cliamod_make_type, cliamod_make_name, cliamod_model_name, "
      sql = sql & " cliamod_manufacturer_name, cliamod_jetnet_amod_id) VALUES (@cliamod_airframe_type,"
      sql = sql & "@cliamod_make_type,"
      sql = sql & "@cliamod_make_name,"
      sql = sql & "@cliamod_model_name,"
      sql = sql & "@cliamod_manufacturer_name,"
      sql = sql & "@cliamod_jetnet_amod_id)"

      Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand(sql, MySqlConn)

      MySqlCommand.Parameters.AddWithValue("@cliamod_airframe_type", aclsClient_Aircraft_Model.cliamod_airframe_type)
      MySqlCommand.Parameters.AddWithValue("@cliamod_make_type", aclsClient_Aircraft_Model.cliamod_make_type)
      MySqlCommand.Parameters.AddWithValue("@cliamod_make_name", aclsClient_Aircraft_Model.cliamod_make_name)
      MySqlCommand.Parameters.AddWithValue("@cliamod_model_name", aclsClient_Aircraft_Model.cliamod_model_name)
      MySqlCommand.Parameters.AddWithValue("@cliamod_manufacturer_name", aclsClient_Aircraft_Model.cliamod_manufacturer_name)
      MySqlCommand.Parameters.AddWithValue("@cliamod_jetnet_amod_id", aclsClient_Aircraft_Model.cliamod_jetnet_amod_id)

      MySqlCommand.ExecuteNonQuery()

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Insert_Client_Aircraft_Model(ByVal aclsClient_Aircraft_Model As clsClient_Aircraft_Model) As Integer</b><br />" & sql

      sql = "select cliamod_id from client_aircraft_model order by cliamod_id desc"
      MySqlCommand.CommandText = sql

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Insert_Client_Aircraft_Model(ByVal aclsClient_Aircraft_Model As clsClient_Aircraft_Model) As Integer</b><br />" & sql

      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try


      If atemptable.Rows.Count > 0 Then
        returned_id = atemptable.Rows(0).Item("cliamod_id")
      End If

      Automatically_Fix_Client_Model_Preferences_Upon_Model_Add(aclsClient_Aircraft_Model, returned_id)
      Return returned_id

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    Catch ex As Exception
      Insert_Client_Aircraft_Model = Nothing
      Me.class_error = "Error in Insert_Client_Aircraft_Model(ByVal aclsClient_Aircraft_Model As clsClient_Aircraft_Model) As Integer  " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

    End Try

  End Function

  Public Sub Automatically_Fix_Client_Model_Preferences_Upon_Model_Add(ByVal aclsClient_Aircraft_Model As clsClient_Aircraft_Model, ByVal returnINT As Integer)
    Dim model As Array
    Dim compare_value As String = ""
    Dim new_pref_string As String = ""

    'format will look like this: 18|LOCKHEED|L-1011-500|JETNET|0
    'So.. aclsClient_Aircraft_Model.cliamod_jetnet_amod_i|aclsClient_Aircraft_Model.cliamod_make_name|aclsClient_Aircraft_Model.cliamod_model_name|JETNET|returnINT
    compare_value = "" & aclsClient_Aircraft_Model.cliamod_jetnet_amod_id & "|" & aclsClient_Aircraft_Model.cliamod_make_name & "|" & aclsClient_Aircraft_Model.cliamod_model_name & "|JETNET|0"


    ' For Each r As DataRow In aTempTable.Rows
    If Not IsDBNull(HttpContext.Current.Session.Item("localUser").crmUserDefaultModels) Then
      model = Split(HttpContext.Current.Session.Item("localUser").crmUserDefaultModels, ",")

      For Each item In model
        If compare_value = item Then
          If new_pref_string = "" Then
            new_pref_string = aclsClient_Aircraft_Model.cliamod_jetnet_amod_id & "|" & aclsClient_Aircraft_Model.cliamod_make_name & "|" & aclsClient_Aircraft_Model.cliamod_model_name & "|Both|" & returnINT
          Else
            new_pref_string = new_pref_string & "," & aclsClient_Aircraft_Model.cliamod_jetnet_amod_id & "|" & aclsClient_Aircraft_Model.cliamod_make_name & "|" & aclsClient_Aircraft_Model.cliamod_model_name & "|Both|" & returnINT
          End If
          'We found it!!
        Else
          If new_pref_string = "" Then
            new_pref_string = item
          Else
            new_pref_string = new_pref_string & "," & item
          End If
        End If
      Next

      new_pref_string = new_pref_string


      '          'Alright well now that we have the preference string rebuilt, we really need to update the preference table. 
      '          Dim ac_category1_name As String = ""
      '          Dim ac_category2_name As String = ""
      '          Dim ac_category3_name As String = ""
      '          Dim ac_category4_name As String = ""
      '          Dim ac_category5_name As String = ""
      '          Dim ac_category6_name As String = ""
      '          Dim ac_category7_name As String = ""
      '          Dim ac_category8_name As String = ""
      '          Dim ac_category9_name As String = ""
      '          Dim ac_category10_name As String = ""

      '          Dim ac_category1_use_name As String = ""
      '          Dim ac_category2_use_name As String = ""
      '          Dim ac_category3_use_name As String = ""
      '          Dim ac_category4_use_name As String = ""
      '          Dim ac_category5_use_name As String = ""
      '          Dim ac_category6_use_name As String = ""
      '          Dim ac_category7_use_name As String = ""
      '          Dim ac_category8_use_name As String = ""
      '          Dim ac_category9_use_name As String = ""
      '          Dim ac_category10_use_name As String = ""

      '          Dim clipref_category1_name As String = ""
      '          Dim clipref_category2_name As String = ""
      '          Dim clipref_category3_name As String = ""
      '          Dim clipref_category4_name As String = ""
      '          Dim clipref_category5_name As String = ""

      '          Dim clipref_category1_use As String = ""
      '          Dim clipref_category2_use As String = ""
      '          Dim clipref_category3_use As String = ""
      '          Dim clipref_category4_use As String = ""
      '          Dim clipref_category5_use As String = ""
      '          Dim clipref_default_days As Integer = 0
      '          Dim clipref_maximum_client_export As Double = 0
      '          Dim clipref_id As Integer = 0

      '          clipref_default_days = IIf(Not IsDBNull(atemptable.Rows(0).Item("clipref_activity_default_days")), atemptable.Rows(0).Item("clipref_activity_default_days"), 0)
      '          clipref_id = IIf(Not IsDBNull(atemptable.Rows(0).Item("clipref_id")), atemptable.Rows(0).Item("clipref_id"), 0)
      '          clipref_maximum_client_export = IIf(Not IsDBNull(atemptable.Rows(0).Item("clipref_max_client_export")), atemptable.Rows(0).Item("clipref_max_client_export"), 0)
      '          clipref_category1_use = IIf(Not IsDBNull(atemptable.Rows(0).Item("clipref_category1_use")), atemptable.Rows(0).Item("clipref_category1_use"), "")
      '          clipref_category2_use = IIf(Not IsDBNull(atemptable.Rows(0).Item("clipref_category2_use")), atemptable.Rows(0).Item("clipref_category2_use"), "")
      '          clipref_category3_use = IIf(Not IsDBNull(atemptable.Rows(0).Item("clipref_category3_use")), atemptable.Rows(0).Item("clipref_category3_use"), "")
      '          clipref_category4_use = IIf(Not IsDBNull(atemptable.Rows(0).Item("clipref_category4_use")), atemptable.Rows(0).Item("clipref_category4_use"), "")
      '          clipref_category5_use = IIf(Not IsDBNull(atemptable.Rows(0).Item("clipref_category5_use")), atemptable.Rows(0).Item("clipref_category5_use"), "")

      '          clipref_category1_name = IIf(Not IsDBNull(atemptable.Rows(0).Item("clipref_category1_name")), atemptable.Rows(0).Item("clipref_category1_name"), "")
      '          clipref_category2_name = IIf(Not IsDBNull(atemptable.Rows(0).Item("clipref_category2_name")), atemptable.Rows(0).Item("clipref_category2_name"), "")
      '          clipref_category3_name = IIf(Not IsDBNull(atemptable.Rows(0).Item("clipref_category3_name")), atemptable.Rows(0).Item("clipref_category3_name"), "")
      '          clipref_category4_name = IIf(Not IsDBNull(atemptable.Rows(0).Item("clipref_category4_name")), atemptable.Rows(0).Item("clipref_category4_name"), "")
      '          clipref_category5_name = IIf(Not IsDBNull(atemptable.Rows(0).Item("clipref_category5_name")), atemptable.Rows(0).Item("clipref_category5_name"), "")



      '          ac_category1_name = IIf(Not IsDBNull(atemptable.Rows(0).Item("clipref_ac_custom_1")), atemptable.Rows(0).Item("clipref_ac_custom_1"), "")
      '          ac_category2_name = IIf(Not IsDBNull(atemptable.Rows(0).Item("clipref_ac_custom_2")), atemptable.Rows(0).Item("clipref_ac_custom_2"), "")
      '          ac_category3_name = IIf(Not IsDBNull(atemptable.Rows(0).Item("clipref_ac_custom_3")), atemptable.Rows(0).Item("clipref_ac_custom_3"), "")
      '          ac_category4_name = IIf(Not IsDBNull(atemptable.Rows(0).Item("clipref_ac_custom_4")), atemptable.Rows(0).Item("clipref_ac_custom_4"), "")
      '          ac_category5_name = IIf(Not IsDBNull(atemptable.Rows(0).Item("clipref_ac_custom_5")), atemptable.Rows(0).Item("clipref_ac_custom_5"), "")
      '          ac_category6_name = IIf(Not IsDBNull(atemptable.Rows(0).Item("clipref_ac_custom_6")), atemptable.Rows(0).Item("clipref_ac_custom_6"), "")
      '          ac_category7_name = IIf(Not IsDBNull(atemptable.Rows(0).Item("clipref_ac_custom_7")), atemptable.Rows(0).Item("clipref_ac_custom_7"), "")
      '          ac_category8_name = IIf(Not IsDBNull(atemptable.Rows(0).Item("clipref_ac_custom_8")), atemptable.Rows(0).Item("clipref_ac_custom_8"), "")
      '          ac_category9_name = IIf(Not IsDBNull(atemptable.Rows(0).Item("clipref_ac_custom_9")), atemptable.Rows(0).Item("clipref_ac_custom_9"), "")
      '          ac_category10_name = IIf(Not IsDBNull(atemptable.Rows(0).Item("clipref_ac_custom_10")), atemptable.Rows(0).Item("clipref_ac_custom_10"), "")

      '          ac_category1_use_name = IIf(Not IsDBNull(atemptable.Rows(0).Item("clipref_ac_custom_1_use")), atemptable.Rows(0).Item("clipref_ac_custom_1_use"), "")
      '          ac_category2_use_name = IIf(Not IsDBNull(atemptable.Rows(0).Item("clipref_ac_custom_2_use")), atemptable.Rows(0).Item("clipref_ac_custom_2_use"), "")
      '          ac_category3_use_name = IIf(Not IsDBNull(atemptable.Rows(0).Item("clipref_ac_custom_3_use")), atemptable.Rows(0).Item("clipref_ac_custom_3_use"), "")
      '          ac_category4_use_name = IIf(Not IsDBNull(atemptable.Rows(0).Item("clipref_ac_custom_4_use")), atemptable.Rows(0).Item("clipref_ac_custom_4_use"), "")
      '          ac_category5_use_name = IIf(Not IsDBNull(atemptable.Rows(0).Item("clipref_ac_custom_5_use")), atemptable.Rows(0).Item("clipref_ac_custom_5_use"), "")
      '          ac_category6_use_name = IIf(Not IsDBNull(atemptable.Rows(0).Item("clipref_ac_custom_6_use")), atemptable.Rows(0).Item("clipref_ac_custom_6_use"), "")
      '          ac_category7_use_name = IIf(Not IsDBNull(atemptable.Rows(0).Item("clipref_ac_custom_7_use")), atemptable.Rows(0).Item("clipref_ac_custom_7_use"), "")
      '          ac_category8_use_name = IIf(Not IsDBNull(atemptable.Rows(0).Item("clipref_ac_custom_8_use")), atemptable.Rows(0).Item("clipref_ac_custom_8_use"), "")
      '          ac_category9_use_name = IIf(Not IsDBNull(atemptable.Rows(0).Item("clipref_ac_custom_9_use")), atemptable.Rows(0).Item("clipref_ac_custom_9_use"), "")
      '          ac_category10_use_name = IIf(Not IsDBNull(atemptable.Rows(0).Item("clipref_ac_custom_10_use")), atemptable.Rows(0).Item("clipref_ac_custom_10_use"), "")

      'If Update_Client_Preferences(ac_category1_name, ac_category2_name, ac_category3_name, ac_category4_name, ac_category5_name, ac_category6_name, ac_category7_name, ac_category8_name, ac_category9_name, ac_category10_name, ac_category1_use_name, ac_category2_use_name, ac_category3_use_name, ac_category4_use_name, ac_category5_use_name, ac_category6_use_name, ac_category7_use_name, ac_category8_use_name, ac_category9_use_name, ac_category10_use_name, clipref_category1_name, clipref_category2_name, clipref_category3_name, clipref_category4_name, clipref_category5_name, clipref_category1_use, clipref_category2_use, clipref_category3_use, clipref_category4_use, clipref_category5_use, clipref_default_days, clipref_maximum_client_export, clipref_id) = 1 Then
      '  'updated preferences

      'Else
      '  'no updated preferences.
      '  'the update will give it's own error inside the function
      'End If


      If Update_Client_User_Default_Models(new_pref_string, HttpContext.Current.Session.Item("localUser").crmLocalUserID) = 0 Then
        'no updated preferences.
        'the update will give it's own error inside the function
      Else
        HttpContext.Current.Session.Item("localUser").crmUserDefaultModels = new_pref_string 'update the session variable
      End If


      FixActiveFolders(new_pref_string)

    End If

  End Sub

  Private Sub FixActiveFolders(ByVal new_pref_string As String)

  End Sub

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Clients_Aircraft_Model_amodID
  ' Purpose: to get all client aircraft 
  ' Parameters: clsClient_Aircraft
  ' Return: 
  '       integer
  ' Change Log
  '           1/10/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Clients_Aircraft_Model_amodID(ByVal amod_ID As Integer) As DataTable

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Dim sql As String = ""
    Try
      sql = " SELECT cliamod_id, cliamod_airframe_type, cliamod_make_type, cliamod_make_name, "
      sql = sql & " cliamod_model_name, cliamod_manufacturer_name, cliamod_jetnet_amod_id, "
      sql = sql & " cliamod_product_business_flag, cliamod_product_helicopter_flag, "
      sql = sql & " cliamod_product_commercial_flag FROM client_aircraft_model WHERE (cliamod_id = " & amod_ID & " )"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Clients_Aircraft_Model_amodID(ByVal amod_ID As Integer) As DataTable</b><br />" & sql

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      Return atemptable
    Catch ex As Exception
      Get_Clients_Aircraft_Model_amodID = Nothing
      Me.class_error = "Error in SQL Get_Clients_Aircraft_Model_amodID(ByVal amod_ID As Integer): " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Clients_Aircraft_Model
  ' Purpose: to get all client aircraft 
  ' Parameters: clsClient_Aircraft
  ' Return: 
  '       integer
  ' Change Log
  '           4/16/2010    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Clients_Aircraft_Model_ByJETNETAmod(ByVal jetnet_mod_id As Integer) As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Dim sql As String = ""
    Try
      sql = " SELECT cliamod_id, cliamod_airframe_type, cliamod_make_type, cliamod_make_name, "
      sql = sql & " cliamod_model_name, cliamod_manufacturer_name, cliamod_jetnet_amod_id, "
      sql = sql & " cliamod_product_business_flag, cliamod_product_helicopter_flag, "
      sql = sql & " cliamod_product_commercial_flag FROM client_aircraft_model WHERE (cliamod_jetnet_amod_id = " & jetnet_mod_id & " )"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Clients_Aircraft_Model_ByJETNETAmod(ByVal jetnet_mod_id As Integer) As DataTable</b><br />" & sql

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      Return atemptable
    Catch ex As Exception
      Get_Clients_Aircraft_Model_ByJETNETAmod = Nothing
      Me.class_error = "Error in SQL Get_Clients_Aircraft_Model_ByJETNETAmod(ByVal jetnet_mod_id As Integer) As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try



  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Clients_Aircraft_Model
  ' Purpose: to get all client aircraft 
  ' Parameters: clsClient_Aircraft
  ' Return: 
  '       integer
  ' Change Log
  '           1/31/2012   - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Clients_Aircraft_Model() As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Dim sql As String = ""
    Try
      sql = " SELECT cliamod_id, cliamod_airframe_type, cliamod_make_type, cliamod_make_name, cliamod_model_name, cliamod_manufacturer_name, cliamod_jetnet_amod_id, "
      sql = sql & " cliamod_product_business_flag, cliamod_product_helicopter_flag, cliamod_product_commercial_flag"
      sql = sql & " FROM client_aircraft_model"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Clients_Aircraft_Model() As DataTable</b><br />" & sql

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      Return atemptable
    Catch ex As Exception
      Get_Clients_Aircraft_Model = Nothing
      Me.class_error = "Error in SQL Get_Clients_Aircraft_Model() As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try



  End Function
#End Region
#Region "Insert Error"
  ''' <summary>
  ''' This function inserts into the crm master database - a logged error.
  ''' </summary>
  ''' <param name="clierror_location">location domain of code</param>
  ''' <param name="clierror_desc">description of error</param>
  ''' <param name="clierror_time">time of error</param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function LogError(ByVal clierror_location As String, ByVal clierror_desc As String, ByVal clierror_time As String) As Boolean
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    LogError = False
    Try

      MySqlConn.ConnectionString = HttpContext.Current.Application.Item("crmMasterDatabase")

      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60



      If clierror_location <> "LOCALHOST" Then
        If InStr(UCase(clierror_location), "WWW") = 0 Then
          clierror_location = UCase("WWW." & clierror_location)
        End If
      End If

      Dim sql As String = ""
      sql = "INSERT INTO client_error_log (clierror_location, clierror_desc, clierror_time) "
      sql = sql & " VALUES ('" & clierror_location & "', '" & Replace(clierror_desc, "'", "") & " User:" & HttpContext.Current.Session.Item("localUser").crmLocalUserName & "', NOW())"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>LogError(ByVal clierror_location As String, ByVal clierror_desc As String, ByVal clierror_time As String) As Boolean</b><br />" & sql

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Return True
    Catch ex As Exception
      Return False
      LogError = Nothing
      Me.class_error = "Error in LogError(ByVal clierror_location As String, ByVal clierror_desc As String, ByVal clierror_time As String): " & ex.Message
    Finally


      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function
  ''' <summary>
  ''' Insert crm Event
  ''' </summary>
  ''' <param name="clievent_type">Event type</param>
  ''' <param name="clievent_location">Location of domain of code</param>
  ''' <param name="clievent_description">Description of event</param>
  ''' <param name="clievent_login">Login</param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Insert_CRM_Event(ByVal clievent_type As String, ByVal clievent_location As String, ByVal clievent_description As String, ByVal clievent_login As String) As Boolean

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Try



      MySqlConn.ConnectionString = HttpContext.Current.Application.Item("crmMasterDatabase")

      If clievent_location <> "LOCALHOST" Then
        If InStr(UCase(clievent_location), "WWW") = 0 Then
          clievent_location = UCase("WWW." & clievent_location)
        End If
      End If


      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      ' fill the data sets
      'This means that the user is logged in or being logged in. Status needs to be updated
      Dim update_string As String = "insert into client_event_log (clievent_type, clievent_location, clievent_desc, clievent_time, clievent_login) values ('" & clievent_type & "','" & clievent_location & "','" & clievent_description & "',NOW(),'" & clievent_login & "')"
      MySqlCommand.CommandText = update_string
      MySqlCommand.ExecuteNonQuery()

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Insert_CRM_Event(ByVal clievent_type As String, ByVal clievent_location As String, ByVal clievent_description As String) As Boolean</b><br />" & update_string


      Insert_CRM_Event = True

    Catch ex As Exception
      Insert_CRM_Event = False
      Me.class_error = "Error in Insert_CRM_Event(ByVal clievent_type As String, ByVal clievent_location As String, ByVal clievent_description As String): " & ex.Message
    Finally
      MySqlCommand.Dispose()
      MySqlConn.Close()
      MySqlConn.Dispose()
    End Try
  End Function
  ''' <summary>
  ''' View Crm Event Log for Administrators.
  ''' </summary>
  ''' <param name="clievent_type"></param>
  ''' <param name="clievent_location"></param>
  ''' <param name="clievent_login"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function View_CRM_Event(ByVal clievent_type As String, ByVal clievent_location As String, ByVal clievent_login As String) As DataTable
    View_CRM_Event = New DataTable
    Dim atemptable As New DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Try


      MySqlConn.ConnectionString = HttpContext.Current.Application.Item("crmMasterDatabase")

      If clievent_location <> "LOCALHOST" Then
        If InStr(UCase(clievent_location), "WWW") = 0 Then
          clievent_location = UCase("WWW." & clievent_location)
        End If
      End If

      ' fill the data sets
      'This means that the user is logged in or being logged in. Status needs to be updated
      Dim sql_string As String = "select * from client_event_log "
      sql_string += " where clievent_location = '" & clievent_location & "' "

      If clievent_type <> "" Then
        sql_string += " and clievent_type = '" & clievent_type & "' "
      End If
      If clievent_login <> "" Then
        sql_string += " and clievent_login = '" & clievent_login & "' "
      End If

      sql_string += " order by clievent_time "
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>View_CRM_Event(ByVal clievent_type As String, ByVal clievent_location As String, ByVal clievent_login As String) As DataTable</b><br />" & sql_string


      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60
      MySqlCommand.CommandText = sql_string

      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Return atemptable

    Catch ex As Exception
      View_CRM_Event = Nothing
      Me.class_error = "Error in View_CRM_Event(ByVal clievent_type As String, ByVal clievent_location As String, ByVal clievent_login As String) As DataTable: " & ex.Message
    Finally
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Close()
      MySqlCommand.Dispose()
      MySqlConn.Dispose()
    End Try
  End Function
#End Region
#Region "Preferences"
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_Preferences
  ' Purpose: to get all the client prefs
  ' Parameters: 
  ' Return: 
  '       datatable
  ' Change Log
  '           1/4/2012    - Created By: Amanda Jennings
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Client_Preferences() As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim squery As String = ""
    Dim atemptable As New DataTable

    Try
      squery = " SELECT * FROM  client_preference"

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = squery

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Preferences() As DataTable</b><br />" & squery


      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      Return atemptable

    Catch ex As Exception
      Get_Client_Preferences = Nothing
      Me.class_error = "Error in SQL Get_Client_Preferences(): " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
  Public Function Get_Client_AC_IDS_With_Custom_AC_FIELDS(ByVal custom_field As Integer, ByVal custom_text As String) As String
    Dim temp_string As String = ""
    Dim temp_table As New DataTable

    Try

      temp_table = Get_Client_AC_IDS_With_Custom_AC(custom_field, custom_text)

      If Not IsNothing(temp_table) Then
        If temp_table.Rows.Count > 0 Then
          For Each r As DataRow In temp_table.Rows
            If Trim(temp_string) <> "" Then
              temp_string &= ", "
            End If

            temp_string &= r.Item("cliaircraft_jetnet_ac_id")
          Next
        End If
      End If
      ' **** MATT Stop doing this use "RETURN" for functions 
      'Get_Client_AC_IDS_With_Custom_Top = 

    Catch ex As Exception
      Return ""
    End Try

    Return temp_string

  End Function
  Public Function Get_Client_AC_IDS_With_Custom_AC(ByVal custom_field As Integer, ByVal custom_text As String) As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim squery As String = ""
    Dim atemptable As New DataTable

    Try
      squery = " select cliaircraft_jetnet_ac_id from client_aircraft where cliaircraft_custom_" & Trim(custom_field) & "  like'%" & custom_text & "%' and cliaircraft_jetnet_ac_id > 0 "

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = squery

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_AC_IDS_With_Custom_AC() As DataTable</b><br />" & squery


      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      Return atemptable

    Catch ex As Exception
      Get_Client_AC_IDS_With_Custom_AC = Nothing
      Me.class_error = "Error in SQL Get_Client_Preferences(): " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
  Public Function Get_Client_AC_IDS_With_Custom_Top(ByVal custom_field As Integer, ByVal custom_text As String) As String
    Dim temp_string As String = ""
    Dim temp_table As New DataTable

    Try

      temp_table = Get_Client_AC_IDS_With_Custom(custom_field, custom_text)

      If Not IsNothing(temp_table) Then
        If temp_table.Rows.Count > 0 Then
          For Each r As DataRow In temp_table.Rows
            If Trim(temp_string) <> "" Then
              temp_string &= ", "
            End If

            temp_string &= r.Item("clicomp_jetnet_comp_id")
          Next
        End If
      End If
      ' **** MATT Stop doing this use "RETURN" for functions 
      'Get_Client_AC_IDS_With_Custom_Top = 

    Catch ex As Exception
      Return ""
    End Try

    Return temp_string

  End Function

  Public Function Get_Client_AC_IDS_With_Custom(ByVal custom_field As Integer, ByVal custom_text As String) As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim squery As String = ""
    Dim atemptable As New DataTable

    Try
      squery = " select clicomp_jetnet_comp_id from client_company where clicomp_category" & Trim(custom_field) & "  like'%" & custom_text & "%' and clicomp_jetnet_comp_id > 0 "

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = squery

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_AC_IDS_With_Custom() As DataTable</b><br />" & squery


      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      Return atemptable

    Catch ex As Exception
      Get_Client_AC_IDS_With_Custom = Nothing
      Me.class_error = "Error in SQL Get_Client_Preferences(): " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: GetClientListPreferenceSelected
  ' Purpose: to get client list preferences by type, selection
  ' Parameters: clilistpref_type, selection
  ' Return: 
  '       DataTable
  ' Change Log
  '           12/30/2010    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function GetClientListPreferenceSelected(ByVal clilistpref_type As String, ByVal clilistpref_selected As String) As DataTable
    Dim sql As String = ""
    sql = "SELECT  clilstpref_id, clilistpref_type, clilistpref_name, clilistpref_selected, clilistpref_order "
    sql = sql & " FROM client_list_preference "
    sql = sql & " WHERE (clilistpref_type = '" & clilistpref_type & "') and  (clilistpref_selected = '" & clilistpref_selected & "') order by clilistpref_order"
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Try
      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>GetClientListPreferenceSelected(ByVal clilistpref_type As String, ByVal clilistpref_selected As String) As DataTable</b><br />" & sql
      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      Return atemptable
    Catch ex As Exception
      GetClientListPreferenceSelected = Nothing
      Me.class_error = "Error in  SQL GetClientListPreferenceSelected(ByVal clilistpref_type As String, ByVal clilistpref_selected As String) As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  Public Function Delete_Client_Custom_Exports(ByVal type_of_export As String, Optional ByVal sort_no As String = "") As Boolean

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Delete_Client_Custom_Exports = False
    Try


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      sql = " delete from client_custom_export where clicexp_type = '" & Trim(type_of_export) & "' "

      If Trim(sort_no) <> "" Then
        sql &= " and clicexp_sort = '10" & Trim(sort_no) & "' "
      End If

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Delete_Client_Custom_Exports = True
    Catch ex As Exception
      Delete_Client_Custom_Exports = False
      Me.class_error = "Error in SQL Delete_Client_Custom_Exports(ByVal type_of_export As String) As Boolean " & ex.Message
    Finally

      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function
  Public Function Delete_client_project_reference(ByVal export_id As String) As Boolean

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Delete_client_project_reference = False
    Try


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      sql = " delete from client_project_reference where clipref_exp_id = " & Trim(export_id) & " "
      sql &= " and clipref_source = 'CLIENT' "

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Delete_client_project_reference = True
    Catch ex As Exception
      Delete_client_project_reference = False
      Me.class_error = "Error in SQL Delete_Client_Custom_Exports(ByVal type_of_export As String) As Boolean " & ex.Message
    Finally

      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function
  Function Find_Client_Custom_Export_id(ByVal type_of_export As String, ByVal sort_no As String) As Long
    Find_Client_Custom_Export_id = 0
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Dim sQuery As String = ""
    Try
      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      sQuery = " select clicexp_id from client_custom_export where clicexp_type = '" & Trim(type_of_export) & "' "

      sQuery &= " and clicexp_sort = '10" & Trim(sort_no) & "' "

      If sQuery <> "" Then
        MySqlCommand.CommandText = sQuery
        MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

        Try
          atemptable.Load(MySqlReader)
        Catch constrExc As System.Data.ConstraintException
          Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
        End Try
        MySqlReader.Close()
        MySqlReader = Nothing

        If atemptable.Rows.Count > 0 Then
          For Each r As DataRow In atemptable.Rows
            Find_Client_Custom_Export_id = r("clicexp_id")
          Next
        End If

      End If
    Finally

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function


  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Insert_Client_Preferences
  ' Purpose: to get the Client Preferences based on the clipref_id 
  ' Parameters: clipref_id
  ' Return: 
  '       datatable
  ' Change Log
  '           2/6/2012    - Created By: Amanda Jennings
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Insert_Client_Preferences(ByVal ac_category1_name As String, ByVal ac_category2_name As String, ByVal ac_category3_name As String, ByVal ac_category4_name As String, ByVal ac_category5_name As String, ByVal ac_category6_name As String, ByVal ac_category7_name As String, ByVal ac_category8_name As String, ByVal ac_category9_name As String, ByVal ac_category10_name As String, ByVal ac_category1_use_name As String, ByVal ac_category2_use_name As String, ByVal ac_category3_use_name As String, ByVal ac_category4_use_name As String, ByVal ac_category5_use_name As String, ByVal ac_category6_use_name As String, ByVal ac_category7_use_name As String, ByVal ac_category8_use_name As String, ByVal ac_category9_use_name As String, ByVal ac_category10_use_name As String, ByVal clipref_category1_name As String, ByVal clipref_category2_name As String, ByVal clipref_category3_name As String, ByVal clipref_category4_name As String, ByVal clipref_category5_name As String, ByVal clipref_category1_use As String, ByVal clipref_category2_use As String, ByVal clipref_category3_use As String, ByVal clipref_category4_use As String, ByVal clipref_category5_use As String, ByVal clipref_activity_default_days As String, ByVal clipref_max_client_export As Long, ByVal clipref_value_format As String) As Integer

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Insert_Client_Preferences = 0
    Try

      sql = "INSERT INTO client_preference (clipref_ac_custom_1, clipref_ac_custom_2, clipref_ac_custom_3, clipref_ac_custom_4, clipref_ac_custom_5, "
      sql = sql & "clipref_ac_custom_6, clipref_ac_custom_7, clipref_ac_custom_8, clipref_ac_custom_9, clipref_ac_custom_10, "

      sql = sql & "clipref_ac_custom_1_use, clipref_ac_custom_2_use, clipref_ac_custom_3_use, clipref_ac_custom_4_use, "
      sql = sql & "clipref_ac_custom_5_use, clipref_ac_custom_6_use, clipref_ac_custom_7_use, clipref_ac_custom_8_use, clipref_ac_custom_9_use,clipref_ac_custom_10_use, "


      sql = sql & " clipref_category1_name, clipref_category2_name, clipref_category3_name, clipref_category4_name, clipref_category5_name, clipref_category1_use, clipref_category2_use, clipref_category3_use, clipref_category4_use, clipref_category5_use, clipref_activity_default_days,  clipref_max_client_export, clipref_value_format) "

      sql = sql & " VALUES  ("

      sql = sql & "'" & Left(ac_category1_name, 60) & "','" & Left(ac_category2_name, 60) & "','" & Left(ac_category3_name, 60) & "','" & Left(ac_category4_name, 60) & "','" & Left(ac_category5_name, 60) & "',"
      sql = sql & "'" & Left(ac_category6_name, 60) & "','" & Left(ac_category7_name, 60) & "','" & Left(ac_category8_name, 60) & "','" & Left(ac_category9_name, 60) & "','" & Left(ac_category10_name, 60) & "',"

      sql = sql & "'" & Left(ac_category1_use_name, 1) & "','" & Left(ac_category2_use_name, 1) & "','" & Left(ac_category3_use_name, 1) & "','" & Left(ac_category4_use_name, 1) & "','" & Left(ac_category5_use_name, 1) & "',"
      sql = sql & "'" & Left(ac_category6_use_name, 1) & "','" & Left(ac_category7_use_name, 1) & "','" & Left(ac_category8_use_name, 1) & "','" & Left(ac_category9_use_name, 1) & "','" & Left(ac_category10_use_name, 1) & "',"

      sql = sql & "'" & Left(clipref_category1_name, 60) & "', '" & Left(clipref_category2_name, 60) & "', '" & Left(clipref_category3_name, 60) & "', "
      sql = sql & " '" & Left(clipref_category4_name, 60) & "', '" & Left(clipref_category5_name, 60) & "', '" & Left(clipref_category1_use, 1) & "', "
      sql = sql & " '" & Left(clipref_category2_use, 1) & "', '" & Left(clipref_category3_use, 1) & "', '" & Left(clipref_category4_use, 1) & "', "
      sql = sql & "'" & Left(clipref_category5_use, 1) & "', '" & clipref_activity_default_days & "', "
      sql = sql & " " & clipref_max_client_export & ",'" & Trim(clipref_value_format) & "')"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Insert_Client_Preferences(ByVal clipref_category1_name As String, ByVal clipref_category2_name As String, ByVal clipref_category3_name As String, ByVal clipref_category4_name As String, ByVal clipref_category5_name As String, ByVal clipref_category1_use As String, ByVal clipref_category2_use As String, ByVal clipref_category3_use As String, ByVal clipref_category4_use As String, ByVal clipref_category5_use As String, ByVal clipref_activity_default_days As String, clipref_max_client_export as long) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Insert_Client_Preferences = 1
    Catch ex As Exception
      Insert_Client_Preferences = 0
      Me.class_error = "Error in SQL Insert_Client_Preferences(ByVal clipref_category1_name As String, ByVal clipref_category2_name As String, ByVal clipref_category3_name As String, ByVal clipref_category4_name As String, ByVal clipref_category5_name As String, ByVal clipref_category1_use As String, ByVal clipref_category2_use As String, ByVal clipref_category3_use As String, ByVal clipref_category4_use As String, ByVal clipref_category5_use As String, ByVal clipref_activity_default_days As String,  clipref_max_client_export as long) As Integer " & ex.Message
    Finally

      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Update_Client_Preferences
  ' Purpose: to get the Client Preferences based on the clipref_id 
  ' Parameters: clipref_id
  ' Return: 
  '       datatable
  ' Change Log
  '           2/6/2012    - Created By: Amanda Jennings
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Update_Client_Preferences(ByVal ac_category1_name As String, ByVal ac_category2_name As String, ByVal ac_category3_name As String, ByVal ac_category4_name As String, ByVal ac_category5_name As String, ByVal ac_category6_name As String, ByVal ac_category7_name As String, ByVal ac_category8_name As String, ByVal ac_category9_name As String, ByVal ac_category10_name As String, ByVal ac_category1_use_name As String, ByVal ac_category2_use_name As String, ByVal ac_category3_use_name As String, ByVal ac_category4_use_name As String, ByVal ac_category5_use_name As String, ByVal ac_category6_use_name As String, ByVal ac_category7_use_name As String, ByVal ac_category8_use_name As String, ByVal ac_category9_use_name As String, ByVal ac_category10_use_name As String, ByVal clipref_category1_name As String, ByVal clipref_category2_name As String, ByVal clipref_category3_name As String, ByVal clipref_category4_name As String, ByVal clipref_category5_name As String, ByVal clipref_category1_use As String, ByVal clipref_category2_use As String, ByVal clipref_category3_use As String, ByVal clipref_category4_use As String, ByVal clipref_category5_use As String, ByVal clipref_activity_default_days As String, ByVal clipref_max_client_export As Long, ByVal Original_clipref_id As Integer, ByVal clipref_value_format As String)

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Update_Client_Preferences = 0
    Try
      sql = "UPDATE  client_preference"
      sql = sql & " SET clipref_category1_name = '" & Left(clipref_category1_name, 60) & "', clipref_category2_name = '" & Left(clipref_category2_name, 60) & "', clipref_category3_name = '" & Left(clipref_category3_name, 60) & "', "
      sql = sql & " clipref_category4_name = '" & Left(clipref_category4_name, 60) & "', clipref_category5_name = '" & Left(clipref_category5_name, 60) & "', clipref_category1_use = '" & Left(clipref_category1_use, 1) & "', "
      sql = sql & " clipref_category2_use = '" & Left(clipref_category2_use, 1) & "', clipref_category3_use = '" & Left(clipref_category3_use, 1) & "', clipref_category4_use = '" & Left(clipref_category4_use, 1) & "', "

      'aircraft preferences: 
      sql = sql & " clipref_ac_custom_1  = '" & Replace(Left(ac_category1_name, 60), "'", "''") & "', clipref_ac_custom_1_use = '" & Left(ac_category1_use_name, 1) & "',"
      sql = sql & " clipref_ac_custom_2  = '" & Replace(Left(ac_category2_name, 60), "'", "''") & "', clipref_ac_custom_2_use = '" & Left(ac_category2_use_name, 1) & "',"
      sql = sql & " clipref_ac_custom_3  = '" & Replace(Left(ac_category3_name, 60), "'", "''") & "', clipref_ac_custom_3_use = '" & Left(ac_category3_use_name, 1) & "',"
      sql = sql & " clipref_ac_custom_4  = '" & Replace(Left(ac_category4_name, 60), "'", "''") & "', clipref_ac_custom_4_use = '" & Left(ac_category4_use_name, 1) & "',"
      sql = sql & " clipref_ac_custom_5  = '" & Replace(Left(ac_category5_name, 60), "'", "''") & "', clipref_ac_custom_5_use = '" & Left(ac_category5_use_name, 1) & "',"
      sql = sql & " clipref_ac_custom_6  = '" & Replace(Left(ac_category6_name, 60), "'", "''") & "', clipref_ac_custom_6_use = '" & Left(ac_category6_use_name, 1) & "',"
      sql = sql & " clipref_ac_custom_7  = '" & Replace(Left(ac_category7_name, 60), "'", "''") & "', clipref_ac_custom_7_use = '" & Left(ac_category7_use_name, 1) & "',"
      sql = sql & " clipref_ac_custom_8  = '" & Replace(Left(ac_category8_name, 60), "'", "''") & "', clipref_ac_custom_8_use = '" & Left(ac_category8_use_name, 1) & "',"
      sql = sql & " clipref_ac_custom_9  = '" & Replace(Left(ac_category9_name, 60), "'", "''") & "', clipref_ac_custom_9_use = '" & Left(ac_category9_use_name, 1) & "',"
      sql = sql & " clipref_ac_custom_10  = '" & Replace(Left(ac_category10_name, 60), "'", "''") & "', clipref_ac_custom_10_use = '" & Left(ac_category10_use_name, 1) & "',"
      sql = sql & " clipref_value_format  = '" & Trim(clipref_value_format) & "',"



      sql = sql & " clipref_category5_use = '" & Left(clipref_category5_use, 1) & "', clipref_activity_default_days ='" & clipref_activity_default_days & "', "
      sql = sql & " clipref_max_client_export = '" & clipref_max_client_export & "'"

      sql = sql & " WHERE  (clipref_id = '" & Original_clipref_id & "') limit 1"


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Update_Client_Preferences(ByVal clipref_category1_name As String, ByVal clipref_category2_name As String, ByVal clipref_category3_name As String, ByVal clipref_category4_name As String, ByVal clipref_category5_name As String, ByVal clipref_category1_use As String, ByVal clipref_category2_use As String, ByVal clipref_category3_use As String, ByVal clipref_category4_use As String, ByVal clipref_category5_use As String, ByVal clipref_activity_default_days As String, clipref_max_client_export As Double, ByVal Original_clipref_id As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Update_Client_Preferences = 1
    Catch ex As Exception
      Update_Client_Preferences = 0
      Me.class_error = "Error in SQL Update_Client_Preferences(ByVal clipref_category1_name As String, ByVal clipref_category2_name As String, ByVal clipref_category3_name As String, ByVal clipref_category4_name As String, ByVal clipref_category5_name As String, ByVal clipref_category1_use As String, ByVal clipref_category2_use As String, ByVal clipref_category3_use As String, ByVal clipref_category4_use As String, ByVal clipref_category5_use As String, ByVal clipref_activity_default_days As String, clipref_max_client_export As Double, ByVal Original_clipref_id As Integer " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function

  Public Function Update_Single_Client_Preferences(ByVal ac_category_name As String, ByVal ac_category_use_name As String, ByVal number_of As String, ByVal Original_clipref_id As Long)

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Update_Single_Client_Preferences = 0
    Try
      sql = "UPDATE  client_preference"
      sql = sql & " SET clipref_ac_custom_" & Trim(number_of) & "  = '" & Replace(Left(ac_category_name, 60), "'", "''") & "', clipref_ac_custom_" & Trim(number_of) & "_use = '" & Left(ac_category_use_name, 1) & "' "

      sql = sql & " WHERE  (clipref_id = '" & Original_clipref_id & "') limit 1"


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Update_Client_Preferences(ByVal clipref_category1_name As String, ByVal clipref_category2_name As String, ByVal clipref_category3_name As String, ByVal clipref_category4_name As String, ByVal clipref_category5_name As String, ByVal clipref_category1_use As String, ByVal clipref_category2_use As String, ByVal clipref_category3_use As String, ByVal clipref_category4_use As String, ByVal clipref_category5_use As String, ByVal clipref_activity_default_days As String, clipref_max_client_export As Double, ByVal Original_clipref_id As Integer</b><br />" & sql

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Update_Single_Client_Preferences = 1
    Catch ex As Exception
      Update_Single_Client_Preferences = 0
      Me.class_error = "Error in SQL Update_Client_Preferences(ByVal clipref_category1_name As String, ByVal clipref_category2_name As String, ByVal clipref_category3_name As String, ByVal clipref_category4_name As String, ByVal clipref_category5_name As String, ByVal clipref_category1_use As String, ByVal clipref_category2_use As String, ByVal clipref_category3_use As String, ByVal clipref_category4_use As String, ByVal clipref_category5_use As String, ByVal clipref_activity_default_days As String, clipref_max_client_export As Double, ByVal Original_clipref_id As Integer " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function
#End Region
#Region "Client Lookup Tables"
  ''' <summary>
  ''' Look up the airframe maintenance program
  ''' maintenance tracking program
  ''' engine maintenance program
  ''' engine management program
  ''' looks up either by ID or a list of these
  ''' </summary>
  ''' <param name="program">ID to be returned</param>
  ''' <param name="tracking">ID to be returned</param>
  ''' <param name="management">ID to be returned</param>
  ''' <param name="type">Type of information to be returned</param>
  ''' <param name="all">Whole List or single ID?</param>
  ''' <returns>Returns datatable</returns>
  ''' <remarks>This was the simplest way to return all this information using only one simple function</remarks>
  Function lookupAirframeEngine_Mait(ByVal program As Integer, ByVal tracking As Integer, ByVal management As Integer, ByVal type As String, ByVal all As Boolean)
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Try
      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      Dim sQuery As String = ""
      If type = "Airframe" Then
        If program <> 0 And all = False Then
          sQuery = "select * from airframe_maintenance_program where amp_id = " & program
        ElseIf tracking <> 0 And all = False Then
          sQuery = "select * from airframe_maintenance_tracking_program where amtp_id = " & tracking
        ElseIf all = True And program <> 0 Then
          sQuery = "select * from airframe_maintenance_program order by amp_provider_name, amp_program_name"
        ElseIf all = True And tracking <> 0 Then
          sQuery = "select * from airframe_maintenance_tracking_program order by amtp_provider_name, amtp_program_name"
        End If
      ElseIf type = "Engine" Then
        If program <> 0 And all = False Then
          sQuery = "select * from engine_maintenance_program where emp_id = " & program
        ElseIf management <> 0 And all = False Then
          sQuery = "select * from engine_management_program where emgp_id = " & management
        ElseIf program <> 0 And all = True Then
          sQuery = "select * from engine_maintenance_program order by emp_program_name, emp_provider_name"
        ElseIf management <> 0 And all = True Then
          sQuery = "select * from engine_management_program order by emgp_provider_name, emgp_program_name"
        End If
      End If

      If sQuery <> "" Then
        MySqlCommand.CommandText = sQuery
        MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>lookupAirframeEngine_Mait(ByVal program As Integer, ByVal tracking As Integer, ByVal management As Integer, ByVal type As String, ByVal all As Boolean)</b><br />" & sQuery

        Try
          atemptable.Load(MySqlReader)
        Catch constrExc As System.Data.ConstraintException
          Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
        End Try
        MySqlReader.Close()
        MySqlReader = Nothing

      End If
    Finally

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
    lookupAirframeEngine_Mait = atemptable
    atemptable = Nothing

  End Function
  ''' <summary>
  ''' list of make types
  ''' </summary>
  ''' <returns></returns>
  ''' <remarks>1-31-2012 - Amanda Vaughn</remarks>
  Function lookupMake_Types() As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Try
      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      Dim sQuery As String = ""

      sQuery = "select * from client_aircraft_make_type "
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>lookupMake_Types() As DataTable</b><br />" & sQuery

      If sQuery <> "" Then
        MySqlCommand.CommandText = sQuery
        MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

        Try
          atemptable.Load(MySqlReader)
        Catch constrExc As System.Data.ConstraintException
          Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
        End Try
        MySqlReader.Close()
        MySqlReader = Nothing

      End If

      lookupMake_Types = atemptable
      atemptable = Nothing

    Catch ex As Exception
      lookupMake_Types = Nothing
      Me.class_error = "Error in lookupMake_Types() As DataTable: SQL VERSION " & ex.Message
    Finally

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_Aircraft_Airframe_Type()
  ' Purpose: to get the client airframe type
  ' Parameters:  
  ' Return: 
  '       DataTable
  ' Change Log
  '           1/31/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Client_Aircraft_Airframe_Type() As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Try
      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      Dim sQuery As String = ""

      sQuery = "SELECT  cliaft_type, cliaft_name FROM client_aircraft_airframe_type"
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Aircraft_Airframe_Type() As DataTable</b><br />" & sQuery

      If sQuery <> "" Then
        MySqlCommand.CommandText = sQuery
        MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

        Try
          atemptable.Load(MySqlReader)
        Catch constrExc As System.Data.ConstraintException
          Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
        End Try
        MySqlReader.Close()
        MySqlReader = Nothing

      End If
      Get_Client_Aircraft_Airframe_Type = atemptable
      atemptable = Nothing
    Catch ex As Exception
      Get_Client_Aircraft_Airframe_Type = Nothing
      Me.class_error = "Error in Get_Client_Aircraft_Airframe_Type() As DataTable: SQL VERSION " & ex.Message
    Finally

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Opportunity_Categories_ID
  ' Purpose: to get all records from the Get_Opportunity_Categories by ID
  ' Parameters: catID
  ' Return: 
  '       DataTable
  ' Change Log
  '           01/11/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Opportunity_Categories_ID(ByVal oppcat_key As Integer) As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Dim sql As String = ""
    Try
      sql = "SELECT oppcat_key, oppcat"
      sql = sql & " FROM(opportunity_category)"
      sql = sql & " WHERE (oppcat_key = " & oppcat_key & ")"
      sql = sql & " ORDER BY oppcat"

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Opportunity_Categories_ID(ByVal oppcat_key As Integer) As DataTable</b><br />" & sql

      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      Return atemptable

    Catch ex As Exception
      Get_Opportunity_Categories_ID = Nothing
      Me.class_error = "Error in  SQL Get_Opportunity_Categories_ID(ByVal oppcat_key As Integer): " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try


  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_Note_Category
  ' Purpose: to get all records from the Client_Note_Category table
  ' Parameters: 
  ' Return: 
  '       DataTable
  ' Change Log
  '    '           01/11/2012   - Created By: amanda vaughn
  '    SELECT        notecat_key, notecat_type_key, notecat_order, notecat_name, notecat_document_flag, notecat_aircraft_flag, notecat_company_flag, notecat_contact_flag
  'FROM            note_category
  'WHERE        (notecat_document_flag = @notecat_document_flag)
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Client_Note_Document_Category(ByVal notecat_document_flag As String, Optional ByVal sortBy As String = "") As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Dim sql As String = ""
    Try

      sql = " SELECT  notecat_key, notecat_type_key, notecat_order, notecat_name, notecat_document_flag, notecat_aircraft_flag, notecat_company_flag, notecat_contact_flag"
      sql = sql & " FROM note_category WHERE (notecat_document_flag = '" & notecat_document_flag & "')"

      If sortBy <> "" Then
        sql += " order by " & sortBy
      End If


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Note_Document_Category(ByVal notecat_document_flag As String) As DataTable</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      Return atemptable

    Catch ex As Exception
      Get_Client_Note_Document_Category = Nothing
      Me.class_error = "Error in  SQL Get_Client_Note_Document_Category(ByVal notecat_document_flag As String): " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_Timezone
  ' Purpose: to get all the client timezone records based on the clitzone_id
  ' Parameters: clitzone_id
  ' Return: 
  '       datatable
  ' Change Log
  '           1/12/2012   - Created By: Tom Jones
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Client_Timezone(ByVal clitzone_id As Integer) As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Dim sql As String = ""
    Try
      sql = "SELECT clitzone_id, clitzone_name, clitzone_sort_num, clitzone_time_vs_eastern, clitzone_time_vs_gmt, clitzone_name_short"
      sql = sql & " FROM client_timezone "
      sql = sql & " WHERE clitzone_id = " & clitzone_id


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Timezone(ByVal clitzone_id As Integer) As DataTable</b><br />" & sql
      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      Return atemptable
    Catch ex As Exception
      Get_Client_Timezone = Nothing
      Me.class_error = "Error in  SQL Get_Client_Timezone(ByVal clitzone_id As Integer): " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try


  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_Timezone
  ' Purpose: to get all the client timezone records
  ' Parameters: 
  ' Return: 
  '       datatable
  ' Change Log
  '           1/26/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Client_Timezone() As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Dim sql As String = ""
    Try
      sql = "SELECT clitzone_id, clitzone_name, clitzone_sort_num, clitzone_time_vs_eastern, clitzone_time_vs_gmt, clitzone_name_short"
      sql = sql & " FROM client_timezone "



      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Timezone() As DataTable</b><br />" & sql
      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      Return atemptable
    Catch ex As Exception
      Get_Client_Timezone = Nothing
      Me.class_error = "Error in  SQL Get_Client_Timezone(): " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try


  End Function

  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  'Method name: Insert_Opportunity_Categories
  'Purpose: to insert a clients opportunity category
  'Parameters: category As String
  'Return: 
  '      integer
  'Change Log
  '          1/20/2012    - Created By: Amanda Vaughn
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Insert_Opportunity_Categories(ByVal category As String) As Integer
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""

    Try
      sql = "INSERT INTO opportunity_category (oppcat) VALUES ('" & Escape_Single_Quote(category) & "')"

      MySqlCommand.CommandText = sql

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />Insert_Opportunity_Categories(ByVal category As String) as Integer" & sql

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Insert_Opportunity_Categories = 1

    Catch ex As Exception
      Insert_Opportunity_Categories = 0
      Me.class_error = "Error in Insert_Opportunity_Categories(ByVal category As String) as Integer  " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  Public Function Update_Opportunity_Category(ByVal oppcat As String, ByVal oppcat_key As Integer) As Integer

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Update_Opportunity_Category = 0
    Try
      sql = "UPDATE opportunity_category SET oppcat = '" & clsGeneral.clsGeneral.StripChars(oppcat, False) & "' "
      sql = sql & " WHERE ((oppcat_key = '" & oppcat_key & "' )) limit 1 "

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Update_Opportunity_Category(ByVal oppcat As String, ByVal oppcat_key As Integer) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Update_Opportunity_Category = 1
    Catch ex As Exception
      Update_Opportunity_Category = 0
      Me.class_error = "Error in SQL Update_Opportunity_Category(ByVal oppcat As String, ByVal oppcat_key As Integer) As Integer " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_NOT_Note_Category
  ' Purpose: to get all records from the Client_Note_Category table
  ' Parameters: 
  ' Return: 
  '       DataTable
  ' Change Log
  '    '           1/20/2012   - Created By: amanda vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Client_NOT_Note_Document_Category(ByVal notecat_document_flag As String, Optional ByRef orderBy As String = "") As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Try

      sql = "SELECT notecat_key, notecat_type_key, notecat_order, notecat_name, notecat_document_flag, notecat_aircraft_flag, notecat_company_flag, notecat_contact_flag"
      sql = sql & " FROM note_category "
      sql = sql & " WHERE (notecat_document_flag <> '" & notecat_document_flag & "')"

      If orderBy <> "" Then
        sql += " order by " & orderBy
      End If

      MySqlConn.ConnectionString = client_DB

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_NOT_Note_Document_Category(ByVal notecat_document_flag As String) As DataTable</b><br />" & sql
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      Return atemptable

    Catch ex As Exception
      Get_Client_NOT_Note_Document_Category = Nothing
      Me.class_error = "Error in  SQL Get_Client_NOT_Note_Document_Category(ByVal notecat_document_flag As String) As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Time_Table()
  ' Purpose: to get the client time table
  ' Parameters:  
  ' Return: 
  '       DataTable
  ' Change Log
  '           1/20/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Time_Table() As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Try
      sql = "SELECT  clitim_time, clitim_sort"
      sql = sql & " FROM client_time order by clitim_sort asc"

      MySqlConn.ConnectionString = client_DB

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Time_Table() As DataTable</b><br />" & sql
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Return atemptable
    Catch ex As Exception
      Get_Time_Table = Nothing
      Me.class_error = "Error in  SQL Get_Time_Table() As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try


  End Function

  'supdoc_id 	int(11) 			No 		auto_increment 	Browse distinct values 	Change 	Drop 	Primary 	Unique 	Index 	Fulltext
  'supdoc_title 	varchar(200) 	latin1_swedish_ci 		No 			Browse distinct values 	Change 	Drop 	Primary 	Unique 	Index 	Fulltext
  'supdoc_area 	varchar(100) 	latin1_swedish_ci 		No 			Browse distinct values 	Change 	Drop 	Primary 	Unique 	Index 	Fulltext
  'supdoc_file_name 	varchar(200) 	latin1_swedish_ci 		No 			Browse distinct values 	Change 	Drop 	Primary 	Unique 	Index 	Fulltext
  'supdoc_order 	int(11) 			No 			Browse distinct values 	Change 	Drop 	Primary 	Unique 	Index 	Fulltext
  'supdoc_file_type 	varchar(5) 	latin1_swedish_ci 		Yes 	NULL 		Browse distinct values 	Change 	Drop 	Primary 	Unique 	Index 	Fulltext'
  'support documents
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: SupportDocuments()
  ' Purpose: Insert_ErrorLog
  ' Parameters: Insert_ErrorLog
  ' Return: 
  '       DataTable
  ' Change Log
  '           1/27/2012    - Created By: Amanda Jennings
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function SupportDocuments() As DataTable

    Dim sql As String = "select * from support_documents order by supdoc_order"

    HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>SupportDocuments() As DataTable</b><br />" & sql

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Try
      MySqlConn.ConnectionString = Me.client_DB


      MySqlConn.ConnectionString = HttpContext.Current.Application.Item("crmMasterDatabase")


      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn

      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      Dim atemptable As New DataTable
      atemptable.Columns.Add("supdoc_id")
      atemptable.Columns.Add("supdoc_title")
      atemptable.Columns.Add("supdoc_area")
      atemptable.Columns.Add("supdoc_file_name")
      atemptable.Columns.Add("supdoc_order")
      atemptable.Columns.Add("supdoc_file_type")

      While MySqlReader.Read()
        Dim newCustomersRow As DataRow = atemptable.NewRow()
        newCustomersRow("supdoc_id") = MySqlReader.Item("supdoc_id")
        newCustomersRow("supdoc_title") = MySqlReader.Item("supdoc_title")
        newCustomersRow("supdoc_area") = MySqlReader.Item("supdoc_area")
        newCustomersRow("supdoc_file_name") = MySqlReader.Item("supdoc_file_name")
        newCustomersRow("supdoc_order") = MySqlReader.Item("supdoc_order")
        newCustomersRow("supdoc_file_type") = MySqlReader.Item("supdoc_file_type")

        atemptable.Rows.Add(newCustomersRow)
        atemptable.AcceptChanges()
      End While


      SupportDocuments = atemptable
    Catch ex As Exception
      SupportDocuments = Nothing
      Me.class_error = "Error in SupportDocuments(): " & ex.Message
    Finally
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function

  Public Function get_help_topics() As DataTable

    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable
    Try

      sql = " select evotop_name, evonot_title, evonot_doc_link, evonot_id "
      sql &= " from Evolution_Notifications with (NOLOCK) "
      sql &= " inner join Evolution_Topic_Index with (NOLOCK) on evotopind_evonot_id = evonot_id "
      sql &= " inner join Evolution_Topics with (NOLOCK) on evotopind_evotop_id = evotop_id "
      sql &= " where evonot_release_type='MH' "
      sql &= " and evonot_product_crm_flag='Y' "
      sql &= " order by evotop_name, evonot_title "

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Company_Relationships(ByVal compID As Integer)</b><br />" & sql

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Return atemptable
    Catch ex As Exception
      get_help_topics = Nothing
      Me.class_error = "Error in Get_Company_Relationships(ByVal comp_id As Integer): SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function
  Public Function get_latest_releases() As DataTable

    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable
    Try

      sql = " select evonot_title, evonot_doc_link, evonot_id "
      sql &= " from Evolution_Notifications with (NOLOCK) "
      sql &= " where evonot_release_type='MG' "
      sql &= " and evonot_product_crm_flag='Y'"
      sql &= " order by evonot_release_date desc "


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Company_Relationships(ByVal compID As Integer)</b><br />" & sql

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Return atemptable
    Catch ex As Exception
      get_latest_releases = Nothing
      Me.class_error = "Error in Get_Company_Relationships(ByVal comp_id As Integer): SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_Transactions_Category_Code
  ' Purpose: to get all the client transaction category info
  ' Parameters: clitcat_code
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/2/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Client_Transactions_Category_Code(ByVal clitcat_code As String) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Try
      sql = " SELECT clitcat_code, clitcat_name, clitcat_type, clitcat_tofrom_businesstype"
      sql = sql & " FROM client_transaction_category"
      sql = sql & " WHERE clitcat_code = '" & clitcat_code & "'"
      sql = sql & " ORDER BY clitcat_type"
      MySqlConn.ConnectionString = client_DB

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Transactions_Category_Code(ByVal clitcat_code As String) As DataTable</b><br />" & sql
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Return atemptable
    Catch ex As Exception
      Get_Client_Transactions_Category_Code = Nothing
      Me.class_error = "Error in  SQL Get_Client_Transactions_Category_Code(ByVal clitcat_code As String) As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Transaction_DealType()
  ' Purpose: to get all the client transaction deal types
  ' Parameters: none
  ' Return: 
  '       DataTable
  ' Change Log
  '           1/2/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Transaction_DealType() As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Try
      sql = "SELECT clitdeal_type_name FROM client_transaction_deal_type"
      MySqlConn.ConnectionString = client_DB

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Transaction_DealType() as Datatable</b><br />" & sql
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Return atemptable
    Catch ex As Exception
      Get_Transaction_DealType = Nothing
      Me.class_error = "Error in  SQL Get_Transaction_DealType() As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
#End Region
#Region "Jobs"
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: GetClient_JobSeeker_contactID
  ' Purpose: to get the JobSeeker info based on contact_id
  ' Parameters: contact_id
  ' Return: 
  '       DataTable
  ' Change Log
  '           1/6/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function GetClient_JobSeeker_contactID(ByVal contact_id As Integer) As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Dim atemptable As New DataTable
    Try
      atemptable.Columns.Add("clicontact_first_name")
      atemptable.Columns.Add("clicontact_last_name")
      atemptable.Columns.Add("clicomp_address1")
      atemptable.Columns.Add("clicomp_city")
      atemptable.Columns.Add("clicomp_state")
      atemptable.Columns.Add("clicomp_zip_code")
      atemptable.Columns.Add("clicomp_country")
      atemptable.Columns.Add("clicontact_email_address")
      atemptable.Columns.Add("jobseek_date_posted")
      atemptable.Columns.Add("jobseek_type")
      atemptable.Columns.Add("jobsind_model_name")
      atemptable.Columns.Add("jobsind_ser_no")
      atemptable.Columns.Add("jobsind_model_experience_type")
      atemptable.Columns.Add("jobsind_model_experience")
      atemptable.Columns.Add("clicomp_id")
      atemptable.Columns.Add("clicontact_id")
      atemptable.Columns.Add("jobseek_status")

      sql = " SELECT  Client_Contact.clicontact_first_name, Client_Contact.clicontact_last_name, "
      sql = sql & " Client_Company.clicomp_address1, Client_Company.clicomp_city, "
      sql = sql & " Client_Company.clicomp_state, Client_Company.clicomp_zip_code, "
      sql = sql & " Client_Company.clicomp_country, Client_Contact.clicontact_email_address, "
      sql = sql & " Client_Jobseekers.jobseek_date_posted, Client_Jobseekers.jobseek_type, "
      sql = sql & " Client_Jobseeker_Index.jobsind_model_name, Client_Jobseeker_Index.jobsind_ser_no, "
      sql = sql & " Client_Jobseeker_Index.jobsind_model_experience_type, Client_Jobseeker_Index.jobsind_model_experience, "
      sql = sql & " Client_Company.clicomp_id, Client_Contact.clicontact_id, Client_Jobseekers.jobseek_status"
      sql = sql & " FROM  (client_jobseeker_index INNER JOIN"
      sql = sql & " ((client_company INNER JOIN"
      sql = sql & " client_contact ON client_company.clicomp_id = client_contact.clicontact_comp_id) INNER JOIN"
      sql = sql & " client_jobseekers ON client_contact.clicontact_id = client_jobseekers.jobseek_clicontact_id) ON "
      sql = sql & " client_jobseeker_Index.jobsind_contact_id = client_contact.clicontact_id)"
      sql = sql & " WHERE clicontact_id = " & contact_id

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>GetClient_JobSeeker_contactID(ByVal contact_id As Integer) As DataTable</b><br />" & sql



      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      While MySqlReader.Read()

        Dim newCustomersRow As DataRow = atemptable.NewRow()
        newCustomersRow("clicontact_first_name") = MySqlReader.Item("clicontact_first_name")
        newCustomersRow("clicontact_last_name") = MySqlReader.Item("clicontact_last_name")
        newCustomersRow("clicomp_address1") = MySqlReader.Item("clicomp_address1")
        newCustomersRow("clicomp_city") = MySqlReader.Item("clicomp_city")
        newCustomersRow("clicomp_state") = MySqlReader.Item("clicomp_state")
        newCustomersRow("clicomp_zip_code") = MySqlReader.Item("clicomp_zip_code")

        newCustomersRow("clicomp_country") = MySqlReader.Item("clicomp_country")
        newCustomersRow("clicontact_email_address") = MySqlReader.Item("clicontact_email_address")
        newCustomersRow("jobseek_date_posted") = MySqlReader.Item("jobseek_date_posted")
        newCustomersRow("jobseek_type") = MySqlReader.Item("jobseek_type")
        newCustomersRow("jobsind_model_name") = MySqlReader.Item("jobsind_model_name")
        newCustomersRow("jobsind_ser_no") = MySqlReader.Item("jobsind_ser_no")
        newCustomersRow("jobsind_model_experience_type") = MySqlReader.Item("jobsind_model_experience_type")
        newCustomersRow("jobsind_model_experience") = MySqlReader.Item("jobsind_model_experience")
        newCustomersRow("jobseek_date_posted") = MySqlReader.Item("jobseek_date_posted")
        newCustomersRow("clicomp_id") = MySqlReader.Item("clicomp_id")
        newCustomersRow("clicontact_id") = MySqlReader.Item("clicontact_id")
        newCustomersRow("jobseek_status") = MySqlReader.Item("jobseek_status")

        atemptable.Rows.Add(newCustomersRow)
        atemptable.AcceptChanges()
      End While
      MySqlReader.Close()
      MySqlReader = Nothing

      Return atemptable

    Catch ex As Exception
      GetClient_JobSeeker_contactID = Nothing
      Me.class_error = "Error in GetClient_JobSeeker_contactID(ByVal contact_id As Integer): " & ex.Message
    Finally


      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try


  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: GetClient_JobSeeker_Details
  ' Purpose: to get the JobSeeker details based on contact_Id
  ' Parameters: type
  ' Return: 
  '       DataTable
  ' Change Log
  '           1/6/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function GetClient_JobSeeker_Details(ByVal contact_id As String, ByRef aError As String) As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Dim atemptable As New DataTable
    atemptable.Columns.Add("jobseek_airline_pilot")
    atemptable.Columns.Add("jobseek_clicontact_id")
    atemptable.Columns.Add("jobseek_contract_avail")
    atemptable.Columns.Add("jobseek_date_posted")
    atemptable.Columns.Add("jobseek_education")
    atemptable.Columns.Add("jobseek_employment")
    atemptable.Columns.Add("jobseek_general")
    atemptable.Columns.Add("jobseek_id")
    atemptable.Columns.Add("jobseek_rating")
    atemptable.Columns.Add("jobseek_referred")
    atemptable.Columns.Add("jobseek_special")
    atemptable.Columns.Add("jobseek_status")
    atemptable.Columns.Add("jobseek_type")
    atemptable.Columns.Add("jobseek_website")
    Try

      sql = "SELECT jobseek_airline_pilot, jobseek_clicontact_id, jobseek_contract_avail, "
      sql = sql & " jobseek_date_posted, jobseek_education, jobseek_employment, jobseek_general, "
      sql = sql & " jobseek_id, jobseek_rating, jobseek_referred, jobseek_special, jobseek_status, "
      sql = sql & " jobseek_type, jobseek_website FROM client_jobseekers WHERE (jobseek_clicontact_id = " & contact_id & ")"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>GetClient_JobSeeker_Details(ByVal contact_id As String, ByRef aError As String) As DataTable</b><br />" & sql



      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      While MySqlReader.Read()

        Dim newCustomersRow As DataRow = atemptable.NewRow()

        newCustomersRow("jobseek_airline_pilot") = MySqlReader.Item("jobseek_airline_pilot")
        newCustomersRow("jobseek_clicontact_id") = MySqlReader.Item("jobseek_clicontact_id")
        newCustomersRow("jobseek_contract_avail") = MySqlReader.Item("jobseek_contract_avail")
        newCustomersRow("jobseek_date_posted") = MySqlReader.Item("jobseek_date_posted")
        newCustomersRow("jobseek_education") = MySqlReader.Item("jobseek_education")
        newCustomersRow("jobseek_employment") = MySqlReader.Item("jobseek_employment")

        newCustomersRow("jobseek_general") = MySqlReader.Item("jobseek_general")
        newCustomersRow("jobseek_id") = MySqlReader.Item("jobseek_id")
        newCustomersRow("jobseek_rating") = MySqlReader.Item("jobseek_rating")
        newCustomersRow("jobseek_referred") = MySqlReader.Item("jobseek_referred")

        newCustomersRow("jobseek_special") = MySqlReader.Item("jobseek_special")
        newCustomersRow("jobseek_status") = MySqlReader.Item("jobseek_status")
        newCustomersRow("jobseek_type") = MySqlReader.Item("jobseek_type")
        newCustomersRow("jobseek_website") = MySqlReader.Item("jobseek_website")

        atemptable.Rows.Add(newCustomersRow)
        atemptable.AcceptChanges()
      End While
      MySqlReader.Close()
      MySqlReader = Nothing

      Return atemptable
    Catch ex As Exception
      GetClient_JobSeeker_Details = Nothing
      aError = ex.Message
      Me.class_error = "Error in SQL GetClient_JobSeeker_Details(ByVal contact_id As String, ByRef aError As String): " & ex.Message
    Finally


      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try


  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: GetClient_JobSeeker
  ' Purpose: to get all the JobSeeker info
  ' Parameters: none
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/26/2010    - Created By: Tom Jones
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function GetClient_JobSeeker() As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Dim atemptable As New DataTable
    Try
      atemptable.Columns.Add("clicontact_first_name")
      atemptable.Columns.Add("clicontact_last_name")
      atemptable.Columns.Add("clicomp_address1")
      atemptable.Columns.Add("clicomp_city")
      atemptable.Columns.Add("clicomp_state")
      atemptable.Columns.Add("clicomp_zip_code")
      atemptable.Columns.Add("clicomp_country")
      atemptable.Columns.Add("clicontact_email_address")
      atemptable.Columns.Add("jobseek_date_posted")
      atemptable.Columns.Add("jobseek_type")
      atemptable.Columns.Add("jobsind_model_name")
      atemptable.Columns.Add("jobsind_ser_no")
      atemptable.Columns.Add("jobsind_model_experience_type")
      atemptable.Columns.Add("jobsind_model_experience")
      atemptable.Columns.Add("clicomp_id")
      atemptable.Columns.Add("clicontact_id")
      atemptable.Columns.Add("jobseek_status")

      sql = "SELECT  Client_Contact.clicontact_first_name, Client_Contact.clicontact_last_name, Client_Company.clicomp_address1, Client_Company.clicomp_city, "
      sql = sql & " Client_Company.clicomp_state, Client_Company.clicomp_zip_code, Client_Company.clicomp_country, Client_Contact.clicontact_email_address, "
      sql = sql & " Client_Jobseekers.jobseek_date_posted, Client_Jobseekers.jobseek_type, Client_Jobseeker_Index.jobsind_model_name, Client_Jobseeker_Index.jobsind_ser_no, "
      sql = sql & " Client_Jobseeker_Index.jobsind_model_experience_type, Client_Jobseeker_Index.jobsind_model_experience, "
      sql = sql & " Client_Company.clicomp_id, Client_Contact.clicontact_id, Client_Jobseekers.jobseek_status"
      sql = sql & " FROM (client_jobseeker_index INNER JOIN"
      sql = sql & " ((client_company INNER JOIN"
      sql = sql & " client_contact ON client_company.clicomp_id = client_contact.clicontact_comp_id) INNER JOIN"
      sql = sql & " client_jobseekers ON client_contact.clicontact_id = client_jobseekers.jobseek_clicontact_id) ON "
      sql = sql & " client_jobseeker_Index.jobsind_contact_id = client_contact.clicontact_id)"

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>GetClient_JobSeeker() As DataTable</b><br />" & sql

      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      While MySqlReader.Read()

        Dim newCustomersRow As DataRow = atemptable.NewRow()
        newCustomersRow("clicontact_first_name") = MySqlReader.Item("clicontact_first_name")
        newCustomersRow("clicontact_last_name") = MySqlReader.Item("clicontact_last_name")
        newCustomersRow("clicomp_address1") = MySqlReader.Item("clicomp_address1")
        newCustomersRow("clicomp_city") = MySqlReader.Item("clicomp_city")
        newCustomersRow("clicomp_state") = MySqlReader.Item("clicomp_state")
        newCustomersRow("clicomp_zip_code") = MySqlReader.Item("clicomp_zip_code")

        newCustomersRow("clicomp_country") = MySqlReader.Item("clicomp_country")
        newCustomersRow("clicontact_email_address") = MySqlReader.Item("clicontact_email_address")
        newCustomersRow("jobseek_date_posted") = MySqlReader.Item("jobseek_date_posted")
        newCustomersRow("jobseek_type") = MySqlReader.Item("jobseek_type")
        newCustomersRow("jobsind_model_name") = MySqlReader.Item("jobsind_model_name")
        newCustomersRow("jobsind_ser_no") = MySqlReader.Item("jobsind_ser_no")
        newCustomersRow("jobsind_model_experience_type") = MySqlReader.Item("jobsind_model_experience_type")
        newCustomersRow("jobsind_model_experience") = MySqlReader.Item("jobsind_model_experience")
        newCustomersRow("jobseek_date_posted") = MySqlReader.Item("jobseek_date_posted")
        newCustomersRow("clicomp_id") = MySqlReader.Item("clicomp_id")
        newCustomersRow("clicontact_id") = MySqlReader.Item("clicontact_id")
        newCustomersRow("jobseek_status") = MySqlReader.Item("jobseek_status")

        atemptable.Rows.Add(newCustomersRow)
        atemptable.AcceptChanges()
      End While
      MySqlReader.Close()
      MySqlReader = Nothing
      Return atemptable
    Catch ex As Exception
      aError = ex.Message
      GetClient_JobSeeker = Nothing
      Me.class_error = "Error in GetClient_JobSeeker() As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: GetClient_JobSeeker_status
  ' Purpose: to get the JobSeeker info based on the status
  ' Parameters: status
  ' Return: 
  '       DataTable
  ' Change Log
  '           1/18/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function GetClient_JobSeeker_status(ByVal status As String, ByRef aError As String) As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Dim atemptable As New DataTable
    Try
      atemptable.Columns.Add("clicontact_first_name")
      atemptable.Columns.Add("clicontact_last_name")
      atemptable.Columns.Add("clicomp_address1")
      atemptable.Columns.Add("clicomp_city")
      atemptable.Columns.Add("clicomp_state")
      atemptable.Columns.Add("clicomp_zip_code")
      atemptable.Columns.Add("clicomp_country")
      atemptable.Columns.Add("clicontact_email_address")
      atemptable.Columns.Add("jobseek_date_posted")
      atemptable.Columns.Add("jobseek_type")
      atemptable.Columns.Add("jobsind_model_name")
      atemptable.Columns.Add("jobsind_ser_no")
      atemptable.Columns.Add("jobsind_model_experience_type")
      atemptable.Columns.Add("jobsind_model_experience")
      atemptable.Columns.Add("clicomp_id")
      atemptable.Columns.Add("clicontact_id")
      atemptable.Columns.Add("jobseek_status")

      sql = "SELECT  Client_Contact.clicontact_first_name, Client_Contact.clicontact_last_name, Client_Company.clicomp_address1, Client_Company.clicomp_city, "
      sql = sql & " Client_Company.clicomp_state, Client_Company.clicomp_zip_code, Client_Company.clicomp_country, Client_Contact.clicontact_email_address, "
      sql = sql & " Client_Jobseekers.jobseek_date_posted, Client_Jobseekers.jobseek_type, Client_Jobseeker_Index.jobsind_model_name, Client_Jobseeker_Index.jobsind_ser_no, "
      sql = sql & " Client_Jobseeker_Index.jobsind_model_experience_type, Client_Jobseeker_Index.jobsind_model_experience, "
      sql = sql & " Client_Company.clicomp_id, Client_Contact.clicontact_id, Client_Jobseekers.jobseek_status"
      sql = sql & " FROM (client_jobseeker_index INNER JOIN"
      sql = sql & " ((client_company INNER JOIN"
      sql = sql & " client_contact ON client_company.clicomp_id = client_contact.clicontact_comp_id) INNER JOIN"
      sql = sql & " client_jobseekers ON client_contact.clicontact_id = client_jobseekers.jobseek_clicontact_id) ON "
      sql = sql & " client_jobseeker_Index.jobsind_contact_id = client_contact.clicontact_id)"
      sql = sql & " WHERE jobseek_status = '" & status & "'"

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>GetClient_JobSeeker_contactID(ByVal contact_id As Integer) As DataTable</b><br />" & sql



      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      While MySqlReader.Read()

        Dim newCustomersRow As DataRow = atemptable.NewRow()
        newCustomersRow("clicontact_first_name") = MySqlReader.Item("clicontact_first_name")
        newCustomersRow("clicontact_last_name") = MySqlReader.Item("clicontact_last_name")
        newCustomersRow("clicomp_address1") = MySqlReader.Item("clicomp_address1")
        newCustomersRow("clicomp_city") = MySqlReader.Item("clicomp_city")
        newCustomersRow("clicomp_state") = MySqlReader.Item("clicomp_state")
        newCustomersRow("clicomp_zip_code") = MySqlReader.Item("clicomp_zip_code")

        newCustomersRow("clicomp_country") = MySqlReader.Item("clicomp_country")
        newCustomersRow("clicontact_email_address") = MySqlReader.Item("clicontact_email_address")
        newCustomersRow("jobseek_date_posted") = MySqlReader.Item("jobseek_date_posted")
        newCustomersRow("jobseek_type") = MySqlReader.Item("jobseek_type")
        newCustomersRow("jobsind_model_name") = MySqlReader.Item("jobsind_model_name")
        newCustomersRow("jobsind_ser_no") = MySqlReader.Item("jobsind_ser_no")
        newCustomersRow("jobsind_model_experience_type") = MySqlReader.Item("jobsind_model_experience_type")
        newCustomersRow("jobsind_model_experience") = MySqlReader.Item("jobsind_model_experience")
        newCustomersRow("jobseek_date_posted") = MySqlReader.Item("jobseek_date_posted")
        newCustomersRow("clicomp_id") = MySqlReader.Item("clicomp_id")
        newCustomersRow("clicontact_id") = MySqlReader.Item("clicontact_id")
        newCustomersRow("jobseek_status") = MySqlReader.Item("jobseek_status")

        atemptable.Rows.Add(newCustomersRow)
        atemptable.AcceptChanges()
      End While
      MySqlReader.Close()
      MySqlReader = Nothing
      Return atemptable
    Catch ex As Exception
      aError = ex.Message
      GetClient_JobSeeker_status = Nothing
      Me.class_error = "Error in GetClient_JobSeeker_status(ByVal status As String, ByRef aError As String): " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: GetClient_JobSeeker_status
  ' Purpose: to get the JobSeeker info based on the type
  ' Parameters: type
  ' Return: 
  '       DataTable
  ' Change Log
  '           1/27/2012  - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function GetClient_JobSeeker_Type(ByVal type As String, ByRef aError As String) As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Dim atemptable As New DataTable
    Try
      atemptable.Columns.Add("clicontact_first_name")
      atemptable.Columns.Add("clicontact_last_name")
      atemptable.Columns.Add("clicomp_address1")
      atemptable.Columns.Add("clicomp_city")
      atemptable.Columns.Add("clicomp_state")
      atemptable.Columns.Add("clicomp_zip_code")
      atemptable.Columns.Add("clicomp_country")
      atemptable.Columns.Add("clicontact_email_address")
      atemptable.Columns.Add("jobseek_date_posted")
      atemptable.Columns.Add("jobseek_type")
      atemptable.Columns.Add("jobsind_model_name")
      atemptable.Columns.Add("jobsind_ser_no")
      atemptable.Columns.Add("jobsind_model_experience_type")
      atemptable.Columns.Add("jobsind_model_experience")
      atemptable.Columns.Add("clicomp_id")
      atemptable.Columns.Add("clicontact_id")
      atemptable.Columns.Add("jobseek_status")

      sql = "SELECT  Client_Contact.clicontact_first_name, Client_Contact.clicontact_last_name, Client_Company.clicomp_address1, Client_Company.clicomp_city, "
      sql = sql & " Client_Company.clicomp_state, Client_Company.clicomp_zip_code, Client_Company.clicomp_country, Client_Contact.clicontact_email_address, "
      sql = sql & " Client_Jobseekers.jobseek_date_posted, Client_Jobseekers.jobseek_type, Client_Jobseeker_Index.jobsind_model_name, Client_Jobseeker_Index.jobsind_ser_no, "
      sql = sql & " Client_Jobseeker_Index.jobsind_model_experience_type, Client_Jobseeker_Index.jobsind_model_experience, "
      sql = sql & " Client_Company.clicomp_id, Client_Contact.clicontact_id, Client_Jobseekers.jobseek_status"
      sql = sql & " FROM (client_jobseeker_index INNER JOIN"
      sql = sql & " ((client_company INNER JOIN"
      sql = sql & " client_contact ON client_company.clicomp_id = client_contact.clicontact_comp_id) INNER JOIN"
      sql = sql & " client_jobseekers ON client_contact.clicontact_id = client_jobseekers.jobseek_clicontact_id) ON "
      sql = sql & " client_jobseeker_Index.jobsind_contact_id = client_contact.clicontact_id)"
      sql = sql & " WHERE jobseek_type = '" & type & "'"

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>GetClient_JobSeeker_Type(ByVal type As String, ByRef aError As String) As DataTable</b><br />" & sql

      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      While MySqlReader.Read()

        Dim newCustomersRow As DataRow = atemptable.NewRow()
        newCustomersRow("clicontact_first_name") = MySqlReader.Item("clicontact_first_name")
        newCustomersRow("clicontact_last_name") = MySqlReader.Item("clicontact_last_name")
        newCustomersRow("clicomp_address1") = MySqlReader.Item("clicomp_address1")
        newCustomersRow("clicomp_city") = MySqlReader.Item("clicomp_city")
        newCustomersRow("clicomp_state") = MySqlReader.Item("clicomp_state")
        newCustomersRow("clicomp_zip_code") = MySqlReader.Item("clicomp_zip_code")

        newCustomersRow("clicomp_country") = MySqlReader.Item("clicomp_country")
        newCustomersRow("clicontact_email_address") = MySqlReader.Item("clicontact_email_address")
        newCustomersRow("jobseek_date_posted") = MySqlReader.Item("jobseek_date_posted")
        newCustomersRow("jobseek_type") = MySqlReader.Item("jobseek_type")
        newCustomersRow("jobsind_model_name") = MySqlReader.Item("jobsind_model_name")
        newCustomersRow("jobsind_ser_no") = MySqlReader.Item("jobsind_ser_no")
        newCustomersRow("jobsind_model_experience_type") = MySqlReader.Item("jobsind_model_experience_type")
        newCustomersRow("jobsind_model_experience") = MySqlReader.Item("jobsind_model_experience")
        newCustomersRow("jobseek_date_posted") = MySqlReader.Item("jobseek_date_posted")
        newCustomersRow("clicomp_id") = MySqlReader.Item("clicomp_id")
        newCustomersRow("clicontact_id") = MySqlReader.Item("clicontact_id")
        newCustomersRow("jobseek_status") = MySqlReader.Item("jobseek_status")

        atemptable.Rows.Add(newCustomersRow)
        atemptable.AcceptChanges()
      End While
      MySqlReader.Close()
      MySqlReader = Nothing
      Return atemptable
    Catch ex As Exception
      aError = ex.Message
      GetClient_JobSeeker_Type = Nothing
      Me.class_error = "Error in GetClient_JobSeeker_Type(ByVal type As String, ByRef aError As String) As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
#End Region
#Region "Transactions"
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_Transactions_ACid
  ' Purpose: to get a clients transaction info
  ' Parameters: clitrans_id, clitrans_jetnet_trans_id
  ' Return: 
  '       integer
  ' Change Log
  '           1/10/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Client_Transactions_ACid(ByVal ac_id As Long, ByVal jetnetID As Long) As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Dim sql As String = ""
    Try
      atemptable.Columns.Add("clitrans_action_date")
      atemptable.Columns.Add("clitrans_airframe_total_hours")
      atemptable.Columns.Add("clitrans_airframe_total_landings")
      atemptable.Columns.Add("clitrans_aport_city")
      atemptable.Columns.Add("clitrans_aport_country")
      atemptable.Columns.Add("clitrans_aport_iata_code")
      atemptable.Columns.Add("clitrans_aport_icao_code")
      atemptable.Columns.Add("clitrans_aport_name")
      atemptable.Columns.Add("clitrans_aport_private")
      atemptable.Columns.Add("clitrans_aport_state")
      atemptable.Columns.Add("clitrans_asking_price")
      atemptable.Columns.Add("clitrans_asking_wordage")
      atemptable.Columns.Add("clitrans_cliac_id")
      atemptable.Columns.Add("clitrans_cliamod_id")
      atemptable.Columns.Add("clitrans_country_of_registration")
      atemptable.Columns.Add("clitrans_customer_note")
      atemptable.Columns.Add("clitrans_date")
      atemptable.Columns.Add("clitrans_date_listed")
      atemptable.Columns.Add("clitrans_deal_type")
      atemptable.Columns.Add("clitrans_est_price")
      atemptable.Columns.Add("clitrans_exclusive_flag")
      atemptable.Columns.Add("clitrans_id")
      atemptable.Columns.Add("clitrans_internal_trans_flag")
      atemptable.Columns.Add("clitrans_jetnet_ac_id")
      atemptable.Columns.Add("clitrans_jetnet_trans_id")
      atemptable.Columns.Add("clitrans_lifecycle")
      atemptable.Columns.Add("clitrans_newac_flag")
      atemptable.Columns.Add("clitrans_ownership")
      atemptable.Columns.Add("clitrans_reg_nbr")
      atemptable.Columns.Add("clitrans_ser_nbr")
      atemptable.Columns.Add("clitrans_sold_price")
      atemptable.Columns.Add("clitrans_sold_price_type")
      atemptable.Columns.Add("clitrans_subject")
      atemptable.Columns.Add("clitrans_type")
      atemptable.Columns.Add("clitrans_year_mfr")

      sql = "SELECT clitrans_action_date, clitrans_airframe_total_hours, clitrans_airframe_total_landings, "
      sql = sql & " clitrans_aport_city, clitrans_aport_country, clitrans_aport_iata_code, clitrans_aport_icao_code, "
      sql = sql & " clitrans_aport_name, clitrans_aport_private, clitrans_aport_state, clitrans_asking_price,"
      sql = sql & "  clitrans_asking_wordage, clitrans_cliac_id, clitrans_cliamod_id, clitrans_country_of_registration, "
      sql = sql & " clitrans_customer_note, clitrans_date, clitrans_date_listed, clitrans_deal_type, clitrans_est_price, "
      sql = sql & " clitrans_exclusive_flag, clitrans_id, clitrans_internal_trans_flag, clitrans_jetnet_ac_id, "
      sql = sql & " clitrans_jetnet_trans_id, clitrans_lifecycle, clitrans_newac_flag, clitrans_ownership, "
      sql = sql & " clitrans_reg_nbr, clitrans_ser_nbr, clitrans_sold_price, clitrans_sold_price_type, "
      sql = sql & " clitrans_subject, clitrans_type, clitrans_year_mfr FROM client_transactions WHERE "

      If ac_id > 0 Then
        sql = sql & " (clitrans_cliac_id = " & ac_id & " )"
        If jetnetID > 0 Then
          sql = sql & "  or "
        End If
      End If

      If jetnetID > 0 Then
        sql = sql & " (clitrans_jetnet_ac_id = " & jetnetID & " )"
      End If

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Transactions_ACid(ByVal ac_id As Integer) As DataTable</b><br />" & sql



      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      While MySqlReader.Read()

        Dim newCustomersRow As DataRow = atemptable.NewRow()

        newCustomersRow("clitrans_action_date") = MySqlReader.Item("clitrans_action_date")
        newCustomersRow("clitrans_airframe_total_hours") = MySqlReader.Item("clitrans_airframe_total_hours")
        newCustomersRow("clitrans_airframe_total_landings") = MySqlReader.Item("clitrans_airframe_total_landings")
        newCustomersRow("clitrans_aport_city") = MySqlReader.Item("clitrans_aport_city")
        newCustomersRow("clitrans_aport_country") = MySqlReader.Item("clitrans_aport_country")
        newCustomersRow("clitrans_aport_iata_code") = MySqlReader.Item("clitrans_aport_iata_code")
        newCustomersRow("clitrans_aport_icao_code") = MySqlReader.Item("clitrans_aport_icao_code")
        newCustomersRow("clitrans_aport_name") = MySqlReader.Item("clitrans_aport_name")
        newCustomersRow("clitrans_aport_private") = MySqlReader.Item("clitrans_aport_private")
        newCustomersRow("clitrans_aport_state") = MySqlReader.Item("clitrans_aport_state")
        newCustomersRow("clitrans_asking_price") = MySqlReader.Item("clitrans_asking_price")
        newCustomersRow("clitrans_asking_wordage") = MySqlReader.Item("clitrans_asking_wordage")
        newCustomersRow("clitrans_cliac_id") = MySqlReader.Item("clitrans_cliac_id")
        newCustomersRow("clitrans_cliamod_id") = MySqlReader.Item("clitrans_cliamod_id")
        newCustomersRow("clitrans_country_of_registration") = MySqlReader.Item("clitrans_country_of_registration")
        newCustomersRow("clitrans_customer_note") = MySqlReader.Item("clitrans_customer_note")
        newCustomersRow("clitrans_date") = MySqlReader.Item("clitrans_date")
        newCustomersRow("clitrans_date_listed") = MySqlReader.Item("clitrans_date_listed")
        newCustomersRow("clitrans_deal_type") = MySqlReader.Item("clitrans_deal_type")
        newCustomersRow("clitrans_est_price") = MySqlReader.Item("clitrans_est_price")
        newCustomersRow("clitrans_exclusive_flag") = MySqlReader.Item("clitrans_exclusive_flag")
        newCustomersRow("clitrans_id") = MySqlReader.Item("clitrans_id")
        newCustomersRow("clitrans_internal_trans_flag") = MySqlReader.Item("clitrans_internal_trans_flag")
        newCustomersRow("clitrans_jetnet_ac_id") = MySqlReader.Item("clitrans_jetnet_ac_id")
        newCustomersRow("clitrans_jetnet_trans_id") = MySqlReader.Item("clitrans_jetnet_trans_id")
        newCustomersRow("clitrans_lifecycle") = MySqlReader.Item("clitrans_lifecycle")
        newCustomersRow("clitrans_newac_flag") = MySqlReader.Item("clitrans_newac_flag")
        newCustomersRow("clitrans_ownership") = MySqlReader.Item("clitrans_ownership")
        newCustomersRow("clitrans_reg_nbr") = MySqlReader.Item("clitrans_reg_nbr")
        newCustomersRow("clitrans_ser_nbr") = MySqlReader.Item("clitrans_ser_nbr")
        newCustomersRow("clitrans_sold_price") = MySqlReader.Item("clitrans_sold_price")
        newCustomersRow("clitrans_sold_price_type") = MySqlReader.Item("clitrans_sold_price_type")
        newCustomersRow("clitrans_subject") = MySqlReader.Item("clitrans_subject")
        newCustomersRow("clitrans_type") = MySqlReader.Item("clitrans_type")
        newCustomersRow("clitrans_year_mfr") = MySqlReader.Item("clitrans_year_mfr")


        atemptable.Rows.Add(newCustomersRow)
        atemptable.AcceptChanges()
      End While
      MySqlReader.Close()
      MySqlReader = Nothing
      Return atemptable
    Catch ex As Exception
      Get_Client_Transactions_ACid = Nothing
      Me.class_error = "Error in  SQL Get_Client_Transactions_ACid(ByVal ac_id As Integer): " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  Public Function Get_Client_Transactions_CompID(ByVal compID As Long, ByVal viewAll As Boolean) As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Dim sql As String = ""
    Try
      atemptable.Columns.Add("clitrans_action_date")
      atemptable.Columns.Add("clitrans_airframe_total_hours")
      atemptable.Columns.Add("clitrans_airframe_total_landings")
      atemptable.Columns.Add("clitrans_aport_city")
      atemptable.Columns.Add("clitrans_aport_country")
      atemptable.Columns.Add("clitrans_aport_iata_code")
      atemptable.Columns.Add("clitrans_aport_icao_code")
      atemptable.Columns.Add("clitrans_aport_name")
      atemptable.Columns.Add("clitrans_aport_private")
      atemptable.Columns.Add("clitrans_aport_state")
      atemptable.Columns.Add("clitrans_asking_price")
      atemptable.Columns.Add("clitrans_asking_wordage")
      atemptable.Columns.Add("clitrans_cliac_id")
      atemptable.Columns.Add("clitrans_cliamod_id")
      atemptable.Columns.Add("clitrans_country_of_registration")
      atemptable.Columns.Add("clitrans_customer_note")
      atemptable.Columns.Add("clitrans_date")
      atemptable.Columns.Add("clitrans_date_listed")
      atemptable.Columns.Add("clitrans_deal_type")
      atemptable.Columns.Add("clitrans_est_price")
      atemptable.Columns.Add("clitrans_exclusive_flag")
      atemptable.Columns.Add("clitrans_id")
      atemptable.Columns.Add("clitrans_internal_trans_flag")
      atemptable.Columns.Add("clitrans_jetnet_ac_id")
      atemptable.Columns.Add("clitrans_jetnet_trans_id")
      atemptable.Columns.Add("clitrans_lifecycle")
      atemptable.Columns.Add("clitrans_newac_flag")
      atemptable.Columns.Add("clitrans_ownership")
      atemptable.Columns.Add("clitrans_reg_nbr")
      atemptable.Columns.Add("clitrans_ser_nbr")
      atemptable.Columns.Add("clitrans_sold_price")
      atemptable.Columns.Add("clitrans_sold_price_type")
      atemptable.Columns.Add("clitrans_subject")
      atemptable.Columns.Add("clitrans_type")
      atemptable.Columns.Add("clitrans_year_mfr")
      atemptable.Columns.Add("cliamod_make_name")
      atemptable.Columns.Add("cliamod_model_name")
      sql = "SELECT clitrans_action_date, clitrans_airframe_total_hours, clitrans_airframe_total_landings, "
      sql = sql & " clitrans_aport_city, clitrans_aport_country, clitrans_aport_iata_code, clitrans_aport_icao_code, "
      sql = sql & " clitrans_aport_name, clitrans_aport_private, clitrans_aport_state, clitrans_asking_price,"
      sql = sql & "  clitrans_asking_wordage, clitrans_cliac_id, clitrans_cliamod_id, clitrans_country_of_registration, "
      sql = sql & " clitrans_customer_note, clitrans_date, clitrans_date_listed, clitrans_deal_type, clitrans_est_price, "
      sql = sql & " clitrans_exclusive_flag, clitrans_id, clitrans_internal_trans_flag, clitrans_jetnet_ac_id,  cliamod_make_name, cliamod_model_name, "
      sql = sql & " clitrans_jetnet_trans_id, clitrans_lifecycle, clitrans_newac_flag, clitrans_ownership, "
      sql = sql & " clitrans_reg_nbr, clitrans_ser_nbr, clitrans_sold_price, clitrans_sold_price_type, "
      sql = sql & " clitrans_subject, clitrans_type, clitrans_year_mfr FROM client_transactions inner join client_transactions_aircraft_reference on clitcref_client_trans_id = clitrans_id inner join client_aircraft_model on cliamod_id = clitrans_cliamod_id WHERE "

      If compID > 0 Then
        sql = sql & " (clitcref_client_comp_id = " & compID & " )"
      End If

      If viewAll = False Then
        Dim DateLastYear As Date = DateAdd(DateInterval.Year, -1, Now())
        ' >= '2016-11-18'
        sql = sql & " AND clitrans_date >= '" & Year(DateLastYear) & "-" & Month(DateLastYear) & "-" & Day(DateLastYear) & "'"
      End If

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Transactions_ACid(ByVal ac_id As Integer) As DataTable</b><br />" & sql



      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      While MySqlReader.Read()

        Dim newCustomersRow As DataRow = atemptable.NewRow()

        newCustomersRow("clitrans_action_date") = MySqlReader.Item("clitrans_action_date")
        newCustomersRow("clitrans_airframe_total_hours") = MySqlReader.Item("clitrans_airframe_total_hours")
        newCustomersRow("clitrans_airframe_total_landings") = MySqlReader.Item("clitrans_airframe_total_landings")
        newCustomersRow("clitrans_aport_city") = MySqlReader.Item("clitrans_aport_city")
        newCustomersRow("clitrans_aport_country") = MySqlReader.Item("clitrans_aport_country")
        newCustomersRow("clitrans_aport_iata_code") = MySqlReader.Item("clitrans_aport_iata_code")
        newCustomersRow("clitrans_aport_icao_code") = MySqlReader.Item("clitrans_aport_icao_code")
        newCustomersRow("clitrans_aport_name") = MySqlReader.Item("clitrans_aport_name")
        newCustomersRow("clitrans_aport_private") = MySqlReader.Item("clitrans_aport_private")
        newCustomersRow("clitrans_aport_state") = MySqlReader.Item("clitrans_aport_state")
        newCustomersRow("clitrans_asking_price") = MySqlReader.Item("clitrans_asking_price")
        newCustomersRow("clitrans_asking_wordage") = MySqlReader.Item("clitrans_asking_wordage")
        newCustomersRow("clitrans_cliac_id") = MySqlReader.Item("clitrans_cliac_id")
        newCustomersRow("clitrans_cliamod_id") = MySqlReader.Item("clitrans_cliamod_id")
        newCustomersRow("clitrans_country_of_registration") = MySqlReader.Item("clitrans_country_of_registration")
        newCustomersRow("clitrans_customer_note") = MySqlReader.Item("clitrans_customer_note")
        newCustomersRow("clitrans_date") = MySqlReader.Item("clitrans_date")
        newCustomersRow("clitrans_date_listed") = MySqlReader.Item("clitrans_date_listed")
        newCustomersRow("clitrans_deal_type") = MySqlReader.Item("clitrans_deal_type")
        newCustomersRow("clitrans_est_price") = MySqlReader.Item("clitrans_est_price")
        newCustomersRow("clitrans_exclusive_flag") = MySqlReader.Item("clitrans_exclusive_flag")
        newCustomersRow("clitrans_id") = MySqlReader.Item("clitrans_id")
        newCustomersRow("clitrans_internal_trans_flag") = MySqlReader.Item("clitrans_internal_trans_flag")
        newCustomersRow("clitrans_jetnet_ac_id") = MySqlReader.Item("clitrans_jetnet_ac_id")
        newCustomersRow("clitrans_jetnet_trans_id") = MySqlReader.Item("clitrans_jetnet_trans_id")
        newCustomersRow("clitrans_lifecycle") = MySqlReader.Item("clitrans_lifecycle")
        newCustomersRow("clitrans_newac_flag") = MySqlReader.Item("clitrans_newac_flag")
        newCustomersRow("clitrans_ownership") = MySqlReader.Item("clitrans_ownership")
        newCustomersRow("clitrans_reg_nbr") = MySqlReader.Item("clitrans_reg_nbr")
        newCustomersRow("clitrans_ser_nbr") = MySqlReader.Item("clitrans_ser_nbr")
        newCustomersRow("clitrans_sold_price") = MySqlReader.Item("clitrans_sold_price")
        newCustomersRow("clitrans_sold_price_type") = MySqlReader.Item("clitrans_sold_price_type")
        newCustomersRow("clitrans_subject") = MySqlReader.Item("clitrans_subject")
        newCustomersRow("clitrans_type") = MySqlReader.Item("clitrans_type")
        newCustomersRow("clitrans_year_mfr") = MySqlReader.Item("clitrans_year_mfr")

        newCustomersRow("cliamod_make_name") = MySqlReader.Item("cliamod_make_name")
        newCustomersRow("cliamod_model_name") = MySqlReader.Item("cliamod_model_name")
        atemptable.Rows.Add(newCustomersRow)
        atemptable.AcceptChanges()
      End While
      MySqlReader.Close()
      MySqlReader = Nothing
      Return atemptable
    Catch ex As Exception
      Get_Client_Transactions_CompID = Nothing
      Me.class_error = "Error in  SQL Get_Client_Transactions_CompID(ByVal compID As Integer): " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_Client_Transactions
  ' Purpose: to get a clients transaction info
  ' Parameters: clitrans_id, clitrans_jetnet_trans_id
  ' Return: 
  '       integer
  ' Change Log
  '           1/10/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Client_Client_Transactions(ByVal clitrans_id As Integer, ByVal clitrans_jetnet_trans_id As Integer) As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Dim sql As String = ""
    Try
      atemptable.Columns.Add("clitrans_action_date")
      atemptable.Columns.Add("clitrans_airframe_total_hours")
      atemptable.Columns.Add("clitrans_airframe_total_landings")
      atemptable.Columns.Add("clitrans_aport_city")
      atemptable.Columns.Add("clitrans_aport_country")
      atemptable.Columns.Add("clitrans_aport_iata_code")
      atemptable.Columns.Add("clitrans_aport_icao_code")
      atemptable.Columns.Add("clitrans_aport_name")
      atemptable.Columns.Add("clitrans_aport_private")
      atemptable.Columns.Add("clitrans_aport_state")
      atemptable.Columns.Add("clitrans_asking_price")
      atemptable.Columns.Add("clitrans_asking_wordage")
      atemptable.Columns.Add("clitrans_cliac_id")
      atemptable.Columns.Add("clitrans_cliamod_id")
      atemptable.Columns.Add("clitrans_country_of_registration")
      atemptable.Columns.Add("clitrans_customer_note")
      atemptable.Columns.Add("clitrans_date")
      atemptable.Columns.Add("clitrans_date_listed")
      atemptable.Columns.Add("clitrans_deal_type")
      atemptable.Columns.Add("clitrans_est_price")
      atemptable.Columns.Add("clitrans_exclusive_flag")
      atemptable.Columns.Add("clitrans_id")
      atemptable.Columns.Add("clitrans_internal_trans_flag")
      atemptable.Columns.Add("clitrans_jetnet_ac_id")
      atemptable.Columns.Add("clitrans_jetnet_trans_id")
      atemptable.Columns.Add("clitrans_lifecycle")
      atemptable.Columns.Add("clitrans_newac_flag")
      atemptable.Columns.Add("clitrans_ownership")
      atemptable.Columns.Add("clitrans_reg_nbr")
      atemptable.Columns.Add("clitrans_ser_nbr")
      atemptable.Columns.Add("clitrans_sold_price")
      atemptable.Columns.Add("clitrans_sold_price_type")
      atemptable.Columns.Add("clitrans_subject")
      atemptable.Columns.Add("clitrans_type")
      atemptable.Columns.Add("clitrans_year_mfr")
      atemptable.Columns.Add("clitrans_value_description")
      atemptable.Columns.Add("clitrans_subcategory_code")
      atemptable.Columns.Add("clitrans_subcat_code_part1")
      atemptable.Columns.Add("clitrans_subcat_code_part2")
      atemptable.Columns.Add("clitrans_subcat_code_part3")
      atemptable.Columns.Add("clitrans_retail_flag")

      If clitrans_jetnet_trans_id = 0 Then
        sql = " SELECT clitrans_retail_flag, clitrans_subcategory_code, clitrans_subcategory_code, clitrans_subcat_code_part1, clitrans_subcat_code_part2, clitrans_subcat_code_part3, clitrans_action_date, clitrans_value_description, clitrans_airframe_total_hours, clitrans_airframe_total_landings, clitrans_aport_city, "
        sql = sql & " clitrans_aport_country, clitrans_aport_iata_code, clitrans_aport_icao_code, clitrans_aport_name, "
        sql = sql & " clitrans_aport_private, clitrans_aport_state, clitrans_asking_price, clitrans_asking_wordage, "
        sql = sql & " clitrans_cliac_id, clitrans_cliamod_id, clitrans_country_of_registration, clitrans_customer_note, "
        sql = sql & " clitrans_date, clitrans_date_listed, clitrans_deal_type, clitrans_est_price, "
        sql = sql & " clitrans_exclusive_flag, clitrans_id, clitrans_internal_trans_flag, clitrans_jetnet_ac_id, "
        sql = sql & " clitrans_jetnet_trans_id, clitrans_lifecycle, clitrans_newac_flag, clitrans_ownership, "
        sql = sql & " clitrans_reg_nbr, clitrans_ser_nbr, clitrans_sold_price, clitrans_sold_price_type, "
        sql = sql & " clitrans_subject, clitrans_type, clitrans_year_mfr FROM client_transactions WHERE (clitrans_id = " & clitrans_id & " )"
      Else
        sql = " SELECT clitrans_retail_flag, clitrans_subcategory_code, clitrans_subcategory_code, clitrans_subcat_code_part1, clitrans_subcat_code_part2, clitrans_subcat_code_part3, clitrans_action_date, clitrans_value_description, clitrans_airframe_total_hours, clitrans_airframe_total_landings, "
        sql = sql & " clitrans_aport_city, clitrans_aport_country, clitrans_aport_iata_code, "
        sql = sql & " clitrans_aport_icao_code, clitrans_aport_name, clitrans_aport_private, "
        sql = sql & " clitrans_aport_state, clitrans_asking_price, clitrans_asking_wordage, "
        sql = sql & " clitrans_cliac_id, clitrans_cliamod_id, clitrans_country_of_registration, "
        sql = sql & " clitrans_customer_note, clitrans_date, clitrans_date_listed, clitrans_deal_type, "
        sql = sql & " clitrans_est_price, clitrans_exclusive_flag, clitrans_id, "
        sql = sql & " clitrans_internal_trans_flag, clitrans_jetnet_ac_id, "
        sql = sql & " clitrans_jetnet_trans_id, clitrans_lifecycle, clitrans_newac_flag, "
        sql = sql & " clitrans_ownership, clitrans_reg_nbr, clitrans_ser_nbr, "
        sql = sql & " clitrans_sold_price, clitrans_sold_price_type, clitrans_subject, "
        sql = sql & " clitrans_type, clitrans_year_mfr FROM client_transactions WHERE (clitrans_jetnet_trans_id = " & clitrans_jetnet_trans_id & ")"
      End If

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Client_Transactions(ByVal clitrans_id As Integer, ByVal clitrans_jetnet_trans_id As Integer) As DataTable</b><br />" & sql

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      While MySqlReader.Read()

        Dim newCustomersRow As DataRow = atemptable.NewRow()
        newCustomersRow("clitrans_value_description") = MySqlReader.Item("clitrans_value_description")
        newCustomersRow("clitrans_action_date") = MySqlReader.Item("clitrans_action_date")
        newCustomersRow("clitrans_airframe_total_hours") = MySqlReader.Item("clitrans_airframe_total_hours")
        newCustomersRow("clitrans_airframe_total_landings") = MySqlReader.Item("clitrans_airframe_total_landings")
        newCustomersRow("clitrans_aport_city") = MySqlReader.Item("clitrans_aport_city")
        newCustomersRow("clitrans_aport_country") = MySqlReader.Item("clitrans_aport_country")
        newCustomersRow("clitrans_aport_iata_code") = MySqlReader.Item("clitrans_aport_iata_code")
        newCustomersRow("clitrans_aport_icao_code") = MySqlReader.Item("clitrans_aport_icao_code")
        newCustomersRow("clitrans_aport_name") = MySqlReader.Item("clitrans_aport_name")
        newCustomersRow("clitrans_aport_private") = MySqlReader.Item("clitrans_aport_private")
        newCustomersRow("clitrans_aport_state") = MySqlReader.Item("clitrans_aport_state")
        newCustomersRow("clitrans_asking_price") = MySqlReader.Item("clitrans_asking_price")
        newCustomersRow("clitrans_asking_wordage") = MySqlReader.Item("clitrans_asking_wordage")
        newCustomersRow("clitrans_cliac_id") = MySqlReader.Item("clitrans_cliac_id")
        newCustomersRow("clitrans_cliamod_id") = MySqlReader.Item("clitrans_cliamod_id")
        newCustomersRow("clitrans_country_of_registration") = MySqlReader.Item("clitrans_country_of_registration")
        newCustomersRow("clitrans_customer_note") = MySqlReader.Item("clitrans_customer_note")
        newCustomersRow("clitrans_date") = MySqlReader.Item("clitrans_date")
        newCustomersRow("clitrans_date_listed") = MySqlReader.Item("clitrans_date_listed")
        newCustomersRow("clitrans_deal_type") = MySqlReader.Item("clitrans_deal_type")
        newCustomersRow("clitrans_est_price") = MySqlReader.Item("clitrans_est_price")
        newCustomersRow("clitrans_exclusive_flag") = MySqlReader.Item("clitrans_exclusive_flag")
        newCustomersRow("clitrans_id") = MySqlReader.Item("clitrans_id")
        newCustomersRow("clitrans_internal_trans_flag") = MySqlReader.Item("clitrans_internal_trans_flag")
        newCustomersRow("clitrans_jetnet_ac_id") = MySqlReader.Item("clitrans_jetnet_ac_id")
        newCustomersRow("clitrans_jetnet_trans_id") = MySqlReader.Item("clitrans_jetnet_trans_id")
        newCustomersRow("clitrans_lifecycle") = MySqlReader.Item("clitrans_lifecycle")
        newCustomersRow("clitrans_newac_flag") = MySqlReader.Item("clitrans_newac_flag")
        newCustomersRow("clitrans_ownership") = MySqlReader.Item("clitrans_ownership")
        newCustomersRow("clitrans_reg_nbr") = MySqlReader.Item("clitrans_reg_nbr")
        newCustomersRow("clitrans_ser_nbr") = MySqlReader.Item("clitrans_ser_nbr")
        newCustomersRow("clitrans_sold_price") = MySqlReader.Item("clitrans_sold_price")
        newCustomersRow("clitrans_sold_price_type") = MySqlReader.Item("clitrans_sold_price_type")
        newCustomersRow("clitrans_subject") = MySqlReader.Item("clitrans_subject")
        newCustomersRow("clitrans_type") = MySqlReader.Item("clitrans_type")
        newCustomersRow("clitrans_year_mfr") = MySqlReader.Item("clitrans_year_mfr")
        newCustomersRow("clitrans_retail_flag") = MySqlReader.Item("clitrans_retail_flag")
        newCustomersRow("clitrans_subcategory_code") = MySqlReader.Item("clitrans_subcategory_code")
        newCustomersRow("clitrans_subcat_code_part1") = MySqlReader.Item("clitrans_subcat_code_part1")
        newCustomersRow("clitrans_subcat_code_part2") = MySqlReader.Item("clitrans_subcat_code_part2")
        newCustomersRow("clitrans_subcat_code_part3") = MySqlReader.Item("clitrans_subcat_code_part3")

        atemptable.Rows.Add(newCustomersRow)
        atemptable.AcceptChanges()
      End While
      MySqlReader.Close()
      MySqlReader = Nothing
      Return atemptable
    Catch ex As Exception
      Get_Client_Client_Transactions = Nothing
      Me.class_error = "Error in  SQL Get_Client_Client_Transactions(ByVal clitrans_id As Integer, ByVal clitrans_jetnet_trans_id As Integer): " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try


  End Function


  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_Transactions_aircraft_reference
  ' Purpose: to get all the client transaction aircraft references
  ' Parameters: clitcref_id
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/2/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Client_Transactions_aircraft_reference_clitcref_id(ByVal clitcref_id As Integer) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Try
      sql = "SELECT clitcref_id, clitcref_client_ac_id, clitcref_client_trans_id, clitcref_client_comp_id, clitcref_client_contact_id, clitcref_contact_type, clitcref_owner_percentage, "
      sql = sql & " clitcref_date_fraction_expires, clitcref_business_type, clitcref_operator_flag"
      sql = sql & " FROM client_transactions_aircraft_reference "
      sql = sql & " WHERE clitcref_id = " & clitcref_id

      MySqlConn.ConnectionString = client_DB

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Transactions_aircraft_reference_clitcref_id(ByVal clitcref_id As Integer) As DataTable</b><br />" & sql
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      Return atemptable
    Catch ex As Exception
      Get_Client_Transactions_aircraft_reference_clitcref_id = Nothing
      Me.class_error = "Error in SQL Get_Client_Transactions_aircraft_reference_clitcref_id(ByVal clitcref_id As Integer) As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_Transactions_aircraft_reference
  ' Purpose: to get all the client transaction aircraft references
  ' Parameters: clitcref_client_trans_id
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/1/2012   - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Client_Transactions_aircraft_reference_clitcref_client_trans_id(ByVal clitcref_client_trans_id As Integer) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Try
      sql = "SELECT clitcref_id, clitcref_client_ac_id, clitcref_client_trans_id, clitcref_client_comp_id, clitcref_client_contact_id, clitcref_contact_type, clitcref_owner_percentage, "
      sql = sql & " clitcref_date_fraction_expires, clitcref_business_type, clitcref_operator_flag"
      sql = sql & " FROM client_transactions_aircraft_reference "
      sql = sql & " WHERE clitcref_client_trans_id = " & clitcref_client_trans_id

      MySqlConn.ConnectionString = client_DB

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Transactions_aircraft_reference_clitcref_client_trans_id(ByVal clitcref_client_trans_id As Integer) As DataTable</b><br />" & sql
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Return atemptable
    Catch ex As Exception
      Get_Client_Transactions_aircraft_reference_clitcref_client_trans_id = Nothing
      Me.class_error = "Error in SQL Get_Client_Transactions_aircraft_reference_clitcref_client_trans_id(ByVal clitcref_client_trans_id As Integer) As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_Transactions_aircraft_reference_Company_Exists
  ' Purpose: to get all the client transaction aircraft references
  ' Parameters: ByVal clitcref_client_trans_id As Integer, ByVal clitcref_client_comp_id As Integer
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/2/2012    - Created By: Amanda Jennings
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Client_Transactions_aircraft_reference_Company_Exists(ByVal clitcref_client_trans_id As Integer, ByVal clitcref_client_comp_id As Integer) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Try
      sql = "SELECT clitcref_id, clitcref_client_ac_id, clitcref_client_trans_id, clitcref_client_comp_id, clitcref_client_contact_id, clitcref_contact_type, clitcref_owner_percentage, "
      sql = sql & " clitcref_date_fraction_expires, clitcref_business_type, clitcref_operator_flag"
      sql = sql & " FROM client_transactions_aircraft_reference "
      sql = sql & " WHERE clitcref_client_trans_id = " & clitcref_client_trans_id & " and clitcref_client_comp_id = " & clitcref_client_comp_id


      MySqlConn.ConnectionString = client_DB

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Transactions_aircraft_reference_Company_Exists(ByVal clitcref_client_trans_id As Integer, ByVal clitcref_client_comp_id As Integer) As DataTable</b><br />" & sql
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Return atemptable
    Catch ex As Exception
      Get_Client_Transactions_aircraft_reference_Company_Exists = Nothing
      Me.class_error = "Error in SQL Get_Client_Transactions_aircraft_reference_Company_Exists(ByVal clitcref_client_trans_id As Integer, ByVal clitcref_client_comp_id As Integer) As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_Transactions_Company
  ' Purpose: to get all the client transaction company info
  ' Parameters: clitcomp_id
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/2/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Client_Transactions_Company(ByVal clitcomp_id As Integer, ByVal clitcomp_trans_id As Integer) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Try
      sql = " SELECT clitcomp_action_date, clitcomp_address1, clitcomp_address2, clitcomp_agency_type, clitcomp_alternate_name, "
      sql = sql & " clitcomp_alternate_name_type, clitcomp_city, clitcomp_country, clitcomp_email_address, clitcomp_id, clitcomp_name, "
      sql = sql & " clitcomp_state, clitcomp_trans_id, clitcomp_web_address, clitcomp_zip_code FROM client_transactions_company WHERE "
      sql = sql & " (clitcomp_id = " & clitcomp_id & " and clitcomp_trans_id = " & clitcomp_trans_id & " )"

      MySqlConn.ConnectionString = client_DB

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Transactions_Company(ByVal clitcomp_id As Integer, ByVal clitcomp_trans_id As Integer) As DataTable</b><br />" & sql
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      Return atemptable

    Catch ex As Exception
      Get_Client_Transactions_Company = Nothing
      Me.class_error = "Error in SQL Get_Client_Transactions_Company(ByVal clitcomp_id As Integer, ByVal clitcomp_trans_id As Integer) As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_Transactions_Contact_ContactID
  ' Purpose: to get all the client transaction contact info
  ' Parameters: clitcontact_id
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/2/2012    - Created By: Tom Jones 
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Client_Transactions_Contact_ContactID(ByVal clitcontact_id As Integer, ByVal clitcontact_trans_id As Integer) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Try
      sql = " SELECT clitcontact_id, clitcontact_trans_id, clitcontact_comp_id, clitcontact_sirname, clitcontact_first_name, "
      sql = sql & " clitcontact_middle_initial, clitcontact_last_name, "
      sql = sql & " clitcontact_suffix, clitcontact_title, clitcontact_email_address, clitcontact_action_date"
      sql = sql & " FROM client_transactions_contact "
      sql = sql & " WHERE clitcontact_id = " & clitcontact_id & " and clitcontact_trans_id = " & clitcontact_trans_id
      MySqlConn.ConnectionString = client_DB

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Transactions_Contact_ContactID(ByVal clitcontact_id As Integer, ByVal clitcontact_trans_id As Integer) As DataTable</b><br />" & sql
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Return atemptable
    Catch ex As Exception
      Get_Client_Transactions_Contact_ContactID = Nothing
      Me.class_error = "Error in SQL Get_Client_Transactions_Contact_ContactID(ByVal clitcontact_id As Integer, ByVal clitcontact_trans_id As Integer) As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Get_Client_Transactions_aircraft_reference by highest ID
  ' Purpose: to get all the client transaction aircraft references
  ' Parameters: none
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/2/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Get_Client_Transactions_aircraft_reference_highestID() As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Try

      sql = "SELECT  clitcref_id, clitcref_client_ac_id, clitcref_client_trans_id, clitcref_client_comp_id, "
      sql = sql & " clitcref_client_contact_id, clitcref_contact_type, clitcref_owner_percentage, "
      sql = sql & " clitcref_date_fraction_expires, clitcref_business_type, clitcref_operator_flag"
      sql = sql & " FROM client_transactions_aircraft_reference order by clitcref_id desc"

      MySqlConn.ConnectionString = client_DB

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Transactions_aircraft_reference_highestID() As DataTable</b><br />" & sql
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Return atemptable
    Catch ex As Exception
      Get_Client_Transactions_aircraft_reference_highestID = Nothing
      Me.class_error = "Error in SQL Get_Client_Transactions_aircraft_reference_highestID() As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try


  End Function
  ''' <summary>
  ''' On Create Export Page - this sets up the default list for the transaction export. 
  ''' </summary>
  ''' <returns>Returns a datatable</returns>
  ''' <remarks>Grabs specific fields from the client export table. Not a datathook because this is forseen to
  ''' be changing quite often</remarks>
  ''' '2-3-12
  Function export_default_transaction_columns()

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Try
      'swapped out with live crm central db
      If HttpContext.Current.Session.Item("jetnetWebSiteType") = eWebSiteTypes.TEST Or HttpContext.Current.Session.Item("jetnetWebSiteType") = eWebSiteTypes.LOCAL Then

        MySqlConn.ConnectionString = Me.client_DB
      Else

        MySqlConn.ConnectionString = HttpContext.Current.Application.Item("crmMasterDatabase")
      End If
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      Dim sQuery As String = "select cliexp_display,cliexp_type, cliexp_id, cliexp_client_db_name, cliexp_jetnet_db_name, cliexp_header_field_name, 'client' as source from client_export where cliexp_client_db_name in ('clitrans_date','cliamod_make_name','cliamod_model_name','clitrans_year_mfr','clitrans_ser_nbr','clitrans_date_listed','clitrans_asking_price','clitrans_sold_price','clitrans_est_price as takeprice','clitrans_deal_type') and cliexp_type in ('Transaction Aircraft','Transaction') or cliexp_display in ('Purchaser','Seller', 'Registered as Owner', 'Registered as Purchaser')"
      MySqlCommand.CommandText = sQuery
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      export_default_transaction_columns = atemptable
      atemptable = Nothing
    Finally
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try


  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Delete_Client_Transactions
  ' Purpose: to delete a clients transaction info
  ' Parameters: Insert_Client_Transactions
  ' Return: 
  '       integer
  ' Change Log
  '           2/7/2012   - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Delete_Client_Transactions(ByVal Original_clitrans_id As Integer) As Integer
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing

    Delete_Client_Transactions = 0
    Try
      sql = "DELETE FROM client_transactions WHERE ((clitrans_id = '" & Original_clitrans_id & "')) limit 1"
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Delete_Client_Transactions(ByVal Original_clitrans_id As Integer) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Delete_Client_Transactions = 1
    Catch ex As Exception
      Delete_Client_Transactions = 0
      Me.class_error = "Error in SQL Delete_Client_Transactions(ByVal Original_clitrans_id As Integer) As Integer " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Delete_Client_Transactions_Company
  ' Purpose: to delete the transaction record from the company table
  ' Parameters: clitcomp_id, clitcomp_trans_ID
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/07/2012    - Created By: Amanda
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Delete_Client_Transactions_Company(ByVal clitcomp_id As Integer, ByVal clitcomp_trans_ID As Integer) As Integer
    'DELETE FROM client_transactions_company WHERE ((clitcomp_id = @Original_clitcomp_id) AND 
    '(clitcomp_trans_id = @Original_clitcomp_trans_id))
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing

    Delete_Client_Transactions_Company = 0
    Try
      sql = "DELETE FROM client_transactions_company WHERE ((clitcomp_id = " & clitcomp_id & "') AND (clitcomp_trans_id = '" & clitcomp_trans_ID & "')) "
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Delete_Client_Transactions_Company(ByVal clitcomp_id As Integer, ByVal clitcomp_trans_ID As Integer) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Delete_Client_Transactions_Company = 1
    Catch ex As Exception
      Delete_Client_Transactions_Company = 0
      Me.class_error = "Error in SQL Delete_Client_Transactions_Company(ByVal clitcomp_id As Integer, ByVal clitcomp_trans_ID As Integer) As Integer " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Delete_Client_Transactions_Contact_ByCompany
  ' Purpose: to delete the transaction contact record(s) from the transaction_contact table
  ' Parameters: ByVal Original_clitcontact_trans_id As Integer, ByVal Original_clitcontact_comp_id As Integer
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/7/2012    - Created By: Amanda Jennings
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Delete_Client_Transactions_Contact_ByCompany(ByVal Original_clitcontact_trans_id As Integer, ByVal Original_clitcontact_comp_id As Integer) As Integer
    'DELETE FROM client_transactions_contact
    'WHERE 
    '(clitcontact_trans_id = @Original_clitcontact_trans_id) AND (clitcontact_comp_id = @Original_clitcontact_comp_id)
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing

    Delete_Client_Transactions_Contact_ByCompany = 0
    Try
      sql = "DELETE FROM client_transactions_contact WHERE (clitcontact_trans_id = '" & Original_clitcontact_trans_id & "') AND (clitcontact_comp_id = '" & Original_clitcontact_comp_id & "')"
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Delete_Client_Transactions_Contact_ByCompany(ByVal Original_clitcontact_trans_id As Integer, ByVal Original_clitcontact_comp_id As Integer) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Delete_Client_Transactions_Contact_ByCompany = 1
    Catch ex As Exception
      Delete_Client_Transactions_Contact_ByCompany = 0
      Me.class_error = "Error in SQL Delete_Client_Transactions_Contact_ByCompany(ByVal Original_clitcontact_trans_id As Integer, ByVal Original_clitcontact_comp_id As Integer) As Integer " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function

  Public Function CHECK_IF_TRANS_RECORD_EXISTS(ByVal journ_id As String) As Boolean
    Dim sql As String = ""
    Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
    Dim SqlConn As New System.Data.SqlClient.SqlConnection
    Dim SqlCommand As New System.Data.SqlClient.SqlCommand
    Dim sqlreader As SqlClient.SqlDataReader : sqlreader = Nothing
    Dim atemptable As New DataTable
    Dim jetnet_user_conn As String = My.Settings.DEFAULT_LIVE_MSSQL_DEBUG
    Dim contact_name As String = ""
    Dim jetnet_amod As Long = 0
    Dim jetnet_amod_table As New DataTable
    Dim aclsLocal_Notes As New clsLocal_Notes
    Dim trans_date As String = ""
    Dim do_insert As Boolean = False

    CHECK_IF_TRANS_RECORD_EXISTS = 0

    Try


      contact_name = HttpContext.Current.Session.Item("localUser").crmLocalUserFirstName.ToString & " " & HttpContext.Current.Session.Item("localUser").crmLocalUserLastName.ToString


      SqlConn.ConnectionString = jetnet_user_conn

      SqlConn.Open()

      SqlCommand.Connection = SqlConn
      SqlCommand.CommandType = System.Data.CommandType.Text
      SqlCommand.CommandTimeout = 60


      sql = " select * from Aircraft_Value with (NOLOCK) where acval_sub_id = '" & HttpContext.Current.Session.Item("localSubscription").crmSubscriptionID & "' "
      sql = sql & " and acval_contact_name = '" & Trim(contact_name) & "' "
      ' sql &= " and acval_asking_price = " & aclsClient_Transactions.clitrans_asking_price & " "
      ' sql &= " and acval_take_price = " & aclsClient_Transactions.clitrans_est_price & "" 'acval_take_price 
      sql &= " and acval_est_price = 0 "
      '  sql &= " and acval_sale_price = " & aclsClient_Transactions.clitrans_sold_price & ""
      sql &= " and acval_journ_id = " & journ_id

      SqlCommand.CommandText = sql
      sqlreader = SqlCommand.ExecuteReader()
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(sqlreader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      CHECK_IF_TRANS_RECORD_EXISTS = False

      If Not IsNothing(atemptable) Then
        If atemptable.Rows.Count > 0 Then
          CHECK_IF_TRANS_RECORD_EXISTS = True
        Else
        End If
      End If

    Catch ex As Exception
      CHECK_IF_TRANS_RECORD_EXISTS = 0
      Me.class_error = "Error in SQL CHECK_IF_TRANS_RECORD_EXISTS(ByVal aclsClient_Transactions As clsClient_Transactions) As Integer " & ex.Message
    Finally

      SqlConn.Close()
      SqlConn.Dispose()
      SqlCommand.Dispose()

      SqlCommand = Nothing
      SqlConn = Nothing
    End Try

  End Function

  Public Function Delete_Aircraft_Value(ByVal acval_id As Long) As Integer
    Dim sql As String = ""
    Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
    Dim SqlConn As New System.Data.SqlClient.SqlConnection
    Dim SqlCommand As New System.Data.SqlClient.SqlCommand
    Dim sqlreader As SqlClient.SqlDataReader : sqlreader = Nothing
    Dim atemptable As New DataTable
    Dim jetnet_user_conn As String = My.Settings.DEFAULT_LIVE_MSSQL_DEBUG
    Dim contact_name As String = ""
    Dim jetnet_amod As Long = 0
    Dim jetnet_amod_table As New DataTable
    Dim aclsLocal_Notes As New clsLocal_Notes
    Dim trans_date As String = ""
    Dim do_insert As Boolean = False

    Delete_Aircraft_Value = 0

    Try

      contact_name = HttpContext.Current.Session.Item("localUser").crmLocalUserFirstName.ToString & " " & HttpContext.Current.Session.Item("localUser").crmLocalUserLastName.ToString


      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString

      SqlConn.Open()

      SqlCommand.Connection = SqlConn
      SqlCommand.CommandType = System.Data.CommandType.Text
      SqlCommand.CommandTimeout = 60


      sql &= " Update Aircraft_Value set "
      sql &= " acval_type = 'DELETED ESTIMATED PRICE'"


      sql &= ", acval_webaction_date = '1/1/1900'"

      sql &= " where acval_id = " & acval_id & "  "

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Delete_Aircraft_Value(ByVal aclsClient_Transactions As clsClient_Transactions) As Integer</b><br />" & sql

      sql = sql

      SqlCommand.CommandText = sql
      SqlCommand.ExecuteNonQuery()
      Delete_Aircraft_Value = 1


    Catch ex As Exception
      Delete_Aircraft_Value = 0
      Me.class_error = "Error in SQL Delete_Aircraft_Value(ByVal aclsClient_Transactions As clsClient_Transactions) As Integer " & ex.Message
    Finally

      SqlConn.Close()
      SqlConn.Dispose()
      SqlCommand.Dispose()

      SqlCommand = Nothing
      SqlConn = Nothing
    End Try


  End Function

  Public Function Update_Aircraft_Value(ByVal aclsClient_Transactions As clsClient_Transactions, ByVal journ_id As String, ByVal acval_id As Long) As Integer
    Dim sql As String = ""
    Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
    Dim SqlConn As New System.Data.SqlClient.SqlConnection
    Dim SqlCommand As New System.Data.SqlClient.SqlCommand
    Dim sqlreader As SqlClient.SqlDataReader : sqlreader = Nothing
    Dim atemptable As New DataTable
    Dim jetnet_user_conn As String = My.Settings.DEFAULT_LIVE_MSSQL_DEBUG
    Dim contact_name As String = ""
    Dim jetnet_amod As Long = 0
    Dim jetnet_amod_table As New DataTable
    Dim aclsLocal_Notes As New clsLocal_Notes
    Dim trans_date As String = ""
    Dim do_insert As Boolean = False

    Update_Aircraft_Value = 0

    Try

      contact_name = HttpContext.Current.Session.Item("localUser").crmLocalUserFirstName.ToString & " " & HttpContext.Current.Session.Item("localUser").crmLocalUserLastName.ToString


      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString

      SqlConn.Open()

      SqlCommand.Connection = SqlConn
      SqlCommand.CommandType = System.Data.CommandType.Text
      SqlCommand.CommandTimeout = 60


      sql = ""
      sql &= " Update Aircraft_Value set "
      ' sql &= " acval_type = 'ESTIMATED PRICE'"

      sql &= "acval_entry_date = "


      'acval_entry_date
      If IsDate(aclsClient_Transactions.clitrans_action_date) Then
        sql = sql & "'" & Format(CDate(aclsClient_Transactions.clitrans_action_date), "yyyy-MM-dd H:mm:ss") & "' "
      Else
        sql = sql & "NOW() "
      End If

      sql &= ",acval_date = "

      ' acval_date
      If Not IsDBNull(aclsClient_Transactions.clitrans_date) Then
        If IsDate(aclsClient_Transactions.clitrans_date) Then
          trans_date = Format(CDate(aclsClient_Transactions.clitrans_date), "yyyy-MM-dd")
          sql = sql & "'" & trans_date & "'"
        Else
          sql = sql & "NULL,"
        End If
      Else
        sql = sql & "NULL"
      End If

      sql &= ",acval_sub_id = "

      sql &= "'" & HttpContext.Current.Session.Item("localSubscription").crmSubscriptionID & "' " ' acval_sub_id  


      'sql &= ",acval_login"
      'sql &= ",acval_seq_no"
      sql &= ",acval_contact_name = "
      sql &= "'" & Trim(contact_name) & "' " ' acval_contact_name "   '

      sql &= ",acval_amod_id = "

      jetnet_amod = aclsClient_Transactions.clitrans_cliamod_id ' faked in the cliamod to = jetnet amod
      sql &= "" & jetnet_amod & "" ' acval_amod_id "   ?  ?

      sql &= ",acval_ac_id = "

      sql &= "" & aclsClient_Transactions.clitrans_jetnet_ac_id & ""

      sql &= ",acval_journ_id = "
      sql &= "" & journ_id & ""  'acval_journ_id "   'aclsClient_Transactions.clitrans_jetnet_trans_id   ' aclsClient_Transactions.clitrans_id


      sql &= ",acval_airframe_tot_hrs = "
      sql &= "" & aclsClient_Transactions.clitrans_airframe_total_hours & " "

      sql &= ",acval_airframe_tot_landings = "
      sql &= "" & aclsClient_Transactions.clitrans_airframe_total_landings & " "

      sql &= ",acval_asking_price = "
      sql &= "" & aclsClient_Transactions.clitrans_asking_price & " "

      sql &= ",acval_take_price = "
      sql &= "" & aclsClient_Transactions.clitrans_est_price & "" 'acval_take_price

      sql &= ",acval_est_price = "
      sql &= " 0" ' acval_est_price 

      sql &= ",acval_sale_price = "
      sql &= "" & aclsClient_Transactions.clitrans_sold_price & "" ' acval_sale_price

      sql &= ",acval_webaction_date = "
      sql &= "'1/1/1900' "

      sql &= ",acval_notes = "
      sql &= "'" & Escape_Single_Quote(aclsClient_Transactions.clitrans_value_description) & "' "


      sql &= ",acval_display_flag ='Y'  "


      sql &= " where acval_id = " & acval_id

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Insert_Into_Aircraft_Value(ByVal aclsClient_Transactions As clsClient_Transactions) As Integer</b><br />" & sql

      sql = sql

      SqlCommand.CommandText = sql
      SqlCommand.ExecuteNonQuery()
      Update_Aircraft_Value = 1


    Catch ex As Exception
      Update_Aircraft_Value = 0
      Me.class_error = "Error in SQL Insert_Into_Aircraft_Value(ByVal aclsClient_Transactions As clsClient_Transactions) As Integer " & ex.Message
    Finally

      SqlConn.Close()
      SqlConn.Dispose()
      SqlCommand.Dispose()

      SqlCommand = Nothing
      SqlConn = Nothing
    End Try


  End Function

  Public Function Find_Aircraft_Value_ID(ByVal aclsClient_Transactions As clsClient_Transactions, ByVal journ_id As String) As Integer
    Dim sql As String = ""
    Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
    Dim SqlConn As New System.Data.SqlClient.SqlConnection
    Dim SqlCommand As New System.Data.SqlClient.SqlCommand
    Dim sqlreader As SqlClient.SqlDataReader : sqlreader = Nothing
    Dim atemptable As New DataTable
    Dim jetnet_user_conn As String = My.Settings.DEFAULT_LIVE_MSSQL_DEBUG
    Dim contact_name As String = ""
    Dim jetnet_amod As Long = 0
    Dim jetnet_amod_table As New DataTable
    Dim aclsLocal_Notes As New clsLocal_Notes
    Dim trans_date As String = ""
    Dim do_insert As Boolean = False

    Find_Aircraft_Value_ID = 0

    Try


      contact_name = HttpContext.Current.Session.Item("localUser").crmLocalUserFirstName.ToString & " " & HttpContext.Current.Session.Item("localUser").crmLocalUserLastName.ToString


      SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString

      SqlConn.Open()

      SqlCommand.Connection = SqlConn
      SqlCommand.CommandType = System.Data.CommandType.Text
      SqlCommand.CommandTimeout = 60


      sql = " select acval_id from Aircraft_Value with (NOLOCK) where acval_sub_id = '" & HttpContext.Current.Session.Item("localSubscription").crmSubscriptionID & "' "
      sql &= " and acval_asking_price = " & aclsClient_Transactions.clitrans_asking_price & " "
      sql &= " and acval_take_price = " & aclsClient_Transactions.clitrans_est_price & "" 'acval_take_price 
      sql &= " and acval_sale_price = " & aclsClient_Transactions.clitrans_sold_price & ""
      sql &= " and acval_ac_id = " & aclsClient_Transactions.clitrans_jetnet_ac_id & ""
      sql &= " and acval_date= '" & aclsClient_Transactions.clitrans_date & "' "


      SqlCommand.CommandText = sql
      sqlreader = SqlCommand.ExecuteReader()
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        atemptable.Load(sqlreader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try


      If Not IsNothing(atemptable) Then
        If atemptable.Rows.Count = 0 Then
          Find_Aircraft_Value_ID = 0
        Else
          For Each r As DataRow In atemptable.Rows
            Find_Aircraft_Value_ID = r("acval_id")
          Next
        End If
      End If



    Catch ex As Exception
      Find_Aircraft_Value_ID = 0
      Me.class_error = "Error in SQL Find_Aircraft_Value_ID(ByVal aclsClient_Transactions As clsClient_Transactions) As Integer " & ex.Message
    Finally

      SqlConn.Close()
      SqlConn.Dispose()
      SqlCommand.Dispose()

      SqlCommand = Nothing
      SqlConn = Nothing
    End Try

  End Function


  Public Function Insert_Into_Aircraft_Value(ByVal aclsClient_Transactions As clsClient_Transactions, ByVal journ_id As String, ByVal cleared_source As Boolean, ByVal type_of_insert As String) As Integer
    Dim sql As String = ""
    Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
    Dim SqlConn As New System.Data.SqlClient.SqlConnection
    Dim SqlCommand As New System.Data.SqlClient.SqlCommand
    Dim sqlreader As SqlClient.SqlDataReader : sqlreader = Nothing
    Dim atemptable As New DataTable
    Dim jetnet_user_conn As String = My.Settings.DEFAULT_LIVE_MSSQL_DEBUG
    Dim contact_name As String = ""
    Dim jetnet_amod As Long = 0
    Dim jetnet_amod_table As New DataTable
    Dim aclsLocal_Notes As New clsLocal_Notes
    Dim trans_date As String = ""
    Dim do_insert As Boolean = False

    Insert_Into_Aircraft_Value = 0

    If Trim(aclsClient_Transactions.clitrans_type) = "Full Sale" Or Trim(type_of_insert) = "est_value" Then
      Try


        contact_name = HttpContext.Current.Session.Item("localUser").crmLocalUserFirstName.ToString & " " & HttpContext.Current.Session.Item("localUser").crmLocalUserLastName.ToString


        SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetAdminDatabase").ToString

        SqlConn.Open()

        SqlCommand.Connection = SqlConn
        SqlCommand.CommandType = System.Data.CommandType.Text
        SqlCommand.CommandTimeout = 60


        sql = " select * from Aircraft_Value with (NOLOCK) where acval_sub_id = '" & HttpContext.Current.Session.Item("localSubscription").crmSubscriptionID & "' "
        sql &= " and acval_contact_name = '" & Trim(contact_name) & "' "
        sql &= " and acval_comp_id = '" & HttpContext.Current.Session.Item("localUser").crmUserCompanyID & "' "
        sql &= " and acval_asking_price = " & aclsClient_Transactions.clitrans_asking_price & " "
        sql &= " and acval_take_price = " & aclsClient_Transactions.clitrans_est_price & "" 'acval_take_price 
        sql &= " and acval_est_price = 0 "
        sql &= " and acval_sale_price = " & aclsClient_Transactions.clitrans_sold_price & ""

        SqlCommand.CommandText = sql
        sqlreader = SqlCommand.ExecuteReader()
        SqlCommand.CommandType = CommandType.Text
        SqlCommand.CommandTimeout = 60

        Try
          atemptable.Load(sqlreader)
        Catch constrExc As System.Data.ConstraintException
          Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
        End Try


        If Not IsNothing(atemptable) Then
          If atemptable.Rows.Count = 0 Then
            do_insert = True
          Else
            For Each r As DataRow In atemptable.Rows
              If Not IsDBNull(r("acval_sale_price")) Then
                If CInt(r("acval_sale_price")) = 0 Then
                  do_insert = False
                  cleared_source = True
                End If
              End If
            Next
          End If


          If do_insert = True Then

            sql = ""
            sql &= " INSERT INTO Aircraft_Value ("
            sql &= " acval_type"
            sql &= ",acval_entry_date"
            sql &= ",acval_date"
            sql &= ",acval_sub_id"
            sql &= ",acval_login"
            sql &= ",acval_seq_no"
            sql &= ",acval_contact_name"
            sql &= ",acval_amod_id"
            sql &= ",acval_ac_id"
            sql &= ",acval_journ_id"
            sql &= ",acval_airframe_tot_hrs"
            sql &= ",acval_airframe_tot_landings"
            sql &= ",acval_asking_price"
            sql &= ",acval_take_price"
            sql &= ",acval_est_price"
            sql &= ",acval_sale_price"
            sql &= ",acval_webaction_date"
            sql &= ",acval_notes"
            sql &= ",acval_display_flag"
            sql &= ",acval_comp_id"
            sql &= " )"
            sql &= " VALUES ("

            If Trim(type_of_insert) = "est_value" Then
              sql &= " 'ESTIMATED PRICE'"
            Else
              sql &= " 'SOLD'"   ' acval_type  ' " & & "
            End If


            'acval_entry_date
            If IsDate(aclsClient_Transactions.clitrans_action_date) Then
              sql = sql & ",'" & Format(CDate(aclsClient_Transactions.clitrans_action_date), "yyyy-MM-dd H:mm:ss") & "' "
            Else
              sql = sql & ",NOW() "
            End If

            ' acval_date
            If Not IsDBNull(aclsClient_Transactions.clitrans_date) Then
              If IsDate(aclsClient_Transactions.clitrans_date) Then
                trans_date = Format(CDate(aclsClient_Transactions.clitrans_date), "yyyy-MM-dd")
                sql = sql & ",'" & trans_date & "'"
              Else
                sql = sql & ",NULL,"
              End If
            Else
              sql = sql & ",NULL"
            End If

            sql &= ",'" & HttpContext.Current.Session.Item("localSubscription").crmSubscriptionID & "' " ' acval_sub_id  
            sql &= ",'' " ' acval_login     ' CStr(Trim(HttpContext.Current.Session.Item("localUser").crmUserLogin))
            sql &= ",'1' " 'acval_seq_no "      ' Trim(HttpContext.Current.Session.Item("localUser").crmSubSeqNo)
            sql &= ",'" & Trim(contact_name) & "' " ' acval_contact_name "   '

            If Trim(type_of_insert) = "est_value" Then
              jetnet_amod = aclsClient_Transactions.clitrans_cliamod_id ' faked in the cliamod to = jetnet amod
            Else
              jetnet_amod_table = Get_Clients_Aircraft_Model_amodID(aclsClient_Transactions.clitrans_cliamod_id)

              If Not IsNothing(jetnet_amod_table) Then
                If jetnet_amod_table.Rows.Count > 0 Then
                  For Each r As DataRow In jetnet_amod_table.Rows
                    jetnet_amod = r("cliamod_jetnet_amod_id")
                  Next
                End If
              End If
            End If



            sql &= "," & jetnet_amod & "" ' acval_amod_id "   ?  ?

            sql &= "," & aclsClient_Transactions.clitrans_jetnet_ac_id & ""
            sql &= "," & journ_id & ""  'acval_journ_id "   'aclsClient_Transactions.clitrans_jetnet_trans_id   ' aclsClient_Transactions.clitrans_id
            sql &= "," & aclsClient_Transactions.clitrans_airframe_total_hours & " "
            sql &= "," & aclsClient_Transactions.clitrans_airframe_total_landings & " "
            sql &= "," & aclsClient_Transactions.clitrans_asking_price & " "
            sql &= "," & aclsClient_Transactions.clitrans_est_price & "" 'acval_take_price  
            sql &= ",0" ' acval_est_price 
            sql &= "," & aclsClient_Transactions.clitrans_sold_price & "" ' acval_sale_price 
            sql &= ",'1/1/1900' "
            sql &= ",'" & Escape_Single_Quote(aclsClient_Transactions.clitrans_value_description) & " (Entered By: " & Trim(contact_name) & ")' "
            sql &= ",'Y' "
            sql &= ", " & HttpContext.Current.Session.Item("localUser").crmUserCompanyID 'ac val comp ID
            sql &= ")  "

            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Insert_Into_Aircraft_Value(ByVal aclsClient_Transactions As clsClient_Transactions) As Integer</b><br />" & sql

            sql = sql

            SqlCommand.CommandText = sql
            SqlCommand.ExecuteNonQuery()
            Insert_Into_Aircraft_Value = 1

            ' INSERT NOTE ---------------------- 
            aclsLocal_Notes.lnote_action_date = Date.Today
            aclsLocal_Notes.lnote_client_ac_id = aclsClient_Transactions.clitrans_cliac_id
            aclsLocal_Notes.lnote_jetnet_ac_id = aclsClient_Transactions.clitrans_jetnet_ac_id
            aclsLocal_Notes.lnote_note = "Submitted Data for Transaction Dated " & trans_date & " to JETNET for use."
            aclsLocal_Notes.lnote_notecat_key = 20
            aclsLocal_Notes.lnote_user_name = Trim(contact_name)
            aclsLocal_Notes.lnote_status = "A"
            aclsLocal_Notes.lnote_user_login = HttpContext.Current.Session.Item("localUser").crmLocalUserID
            aclsLocal_Notes.lnote_user_id = HttpContext.Current.Session.Item("localUser").crmLocalUserID
            aclsLocal_Notes.lnote_clipri_ID = 1
            Call Insert_Note(aclsLocal_Notes)
          End If

        End If

      Catch ex As Exception
        Insert_Into_Aircraft_Value = 0
        Me.class_error = "Error in SQL Insert_Into_Aircraft_Value(ByVal aclsClient_Transactions As clsClient_Transactions) As Integer " & ex.Message
      Finally

        SqlConn.Close()
        SqlConn.Dispose()
        SqlCommand.Dispose()

        SqlCommand = Nothing
        SqlConn = Nothing
      End Try





    End If

  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Update_Client_Transactions
  ' Purpose: to update a clients transaction info
  ' Parameters: Insert_Client_Transactions
  ' Return: 
  '       integer
  ' Change Log
  '           2/7/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Update_Client_Transactions(ByVal aclsClient_Transactions As clsClient_Transactions) As Integer
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing

    Update_Client_Transactions = 0
    Try
      sql = "UPDATE client_transactions SET clitrans_id = '" & aclsClient_Transactions.clitrans_id & "', "
      sql = sql & " clitrans_jetnet_trans_id = '" & aclsClient_Transactions.clitrans_jetnet_trans_id & "', "
      sql = sql & " clitrans_cliac_id = '" & aclsClient_Transactions.clitrans_cliac_id & "', "
      sql = sql & " clitrans_jetnet_ac_id = '" & aclsClient_Transactions.clitrans_jetnet_ac_id & "', "
      sql = sql & " clitrans_cliamod_id = '" & aclsClient_Transactions.clitrans_cliamod_id & "', "
      sql = sql & " clitrans_deal_type = '" & aclsClient_Transactions.clitrans_deal_type & "',"
      sql = sql & " clitrans_year_mfr = '" & aclsClient_Transactions.clitrans_year_mfr & "', "
      sql = sql & " clitrans_lifecycle = '" & aclsClient_Transactions.clitrans_lifecycle & "', "
      sql = sql & "clitrans_ownership = '" & aclsClient_Transactions.clitrans_ownership & "', "
      sql = sql & "clitrans_subcat_code_part1 = '" & aclsClient_Transactions.clitrans_subcat_code_part1 & "', "
      sql = sql & "clitrans_subcat_code_part2 = '" & aclsClient_Transactions.clitrans_subcat_code_part2 & "', "
      sql = sql & "clitrans_subcat_code_part3 = '" & aclsClient_Transactions.clitrans_subcat_code_part3 & "', "
      sql = sql & "clitrans_subcategory_code = '" & aclsClient_Transactions.clitrans_subcategory_code & "', "
      sql = sql & "clitrans_retail_flag = '" & aclsClient_Transactions.clitrans_retail_flag & "', "

      If Not IsDBNull(aclsClient_Transactions.clitrans_date) Then
        If IsDate(aclsClient_Transactions.clitrans_date) Then
          sql = sql & " clitrans_date = '" & Format(CDate(aclsClient_Transactions.clitrans_date), "yyyy-MM-dd H:mm:ss") & "',"
        Else
          sql = sql & " clitrans_date = NULL,"
        End If
      Else
        sql = sql & " clitrans_date = NULL,"
      End If

      sql = sql & " clitrans_subject = '" & Left(aclsClient_Transactions.clitrans_subject, 200) & "',"
      sql = sql & " clitrans_customer_note = '" & Left(aclsClient_Transactions.clitrans_customer_note, 250) & "', "
      sql = sql & " clitrans_newac_flag = '" & Left(aclsClient_Transactions.clitrans_newac_flag, 1) & "',"
      sql = sql & " clitrans_internal_trans_flag = '" & Left(aclsClient_Transactions.clitrans_internal_trans_flag, 1) & "', "

      If Not IsDBNull(aclsClient_Transactions.clitrans_date_listed) Then
        If IsDate(aclsClient_Transactions.clitrans_date_listed) Then
          sql = sql & " clitrans_date_listed = '" & Format(CDate(aclsClient_Transactions.clitrans_date_listed), "yyyy-MM-dd H:mm:ss") & "', "
        Else
          sql = sql & " clitrans_date_listed = NULL, "
        End If
      Else
        sql = sql & " clitrans_date_listed = NULL, "
      End If

      sql = sql & " clitrans_exclusive_flag = '" & Left(aclsClient_Transactions.clitrans_exclusive_flag, 1) & "', "
      sql = sql & " clitrans_asking_wordage = '" & Left(aclsClient_Transactions.clitrans_asking_wordage, 10) & "', "

      If IsNumeric(aclsClient_Transactions.clitrans_asking_price) Then
        sql = sql & " clitrans_asking_price = '" & aclsClient_Transactions.clitrans_asking_price & "', "
      Else
        sql = sql & " clitrans_asking_price = NULL, "
      End If

      sql = sql & " clitrans_ser_nbr = '" & Left(aclsClient_Transactions.clitrans_ser_nbr, 20) & "', "
      sql = sql & " clitrans_reg_nbr = '" & Left(aclsClient_Transactions.clitrans_reg_nbr, 12) & "', "

      sql = sql & " clitrans_country_of_registration = '" & Left(aclsClient_Transactions.clitrans_country_of_registration, 25) & "', "

      If Not IsDBNull(aclsClient_Transactions.clitrans_airframe_total_hours) Then
        If IsNumeric(aclsClient_Transactions.clitrans_airframe_total_hours) Then
          sql = sql & " clitrans_airframe_total_hours = '" & aclsClient_Transactions.clitrans_airframe_total_hours & "',"
        Else
          sql = sql & " clitrans_airframe_total_hours = NULL,"
        End If
      Else
        sql = sql & " clitrans_airframe_total_hours = NULL,"
      End If

      If Not IsDBNull(aclsClient_Transactions.clitrans_airframe_total_landings) Then
        If IsNumeric(aclsClient_Transactions.clitrans_airframe_total_landings) Then
          sql = sql & " clitrans_airframe_total_landings = '" & aclsClient_Transactions.clitrans_airframe_total_landings & "',"
        Else
          sql = sql & " clitrans_airframe_total_landings = NULL,"
        End If
      Else
        sql = sql & " clitrans_airframe_total_landings = NULL,"
      End If


      sql = sql & " clitrans_aport_iata_code = '" & Left(aclsClient_Transactions.clitrans_aport_iata_code, 4) & "', "
      sql = sql & " clitrans_value_description = '" & Escape_Single_Quote(aclsClient_Transactions.clitrans_value_description) & "', "

      sql = sql & " clitrans_aport_icao_code = '" & Left(aclsClient_Transactions.clitrans_aport_icao_code, 4) & "', "
      sql = sql & " clitrans_aport_name = '" & Left(aclsClient_Transactions.clitrans_aport_name, 100) & "',"
      sql = sql & " clitrans_aport_state = '" & Left(aclsClient_Transactions.clitrans_aport_state, 2) & "', "
      sql = sql & " clitrans_aport_country = '" & Left(aclsClient_Transactions.clitrans_aport_country, 50) & "', "
      sql = sql & " clitrans_aport_city = '" & Left(aclsClient_Transactions.clitrans_aport_city, 50) & "', "
      sql = sql & " clitrans_aport_private = '" & Left(aclsClient_Transactions.clitrans_aport_private, 1) & "', "

      If IsDate(aclsClient_Transactions.clitrans_action_date) Then
        sql = sql & " clitrans_action_date = '" & Format(CDate(aclsClient_Transactions.clitrans_action_date), "yyyy-MM-dd H:mm:ss") & "', "
      Else
        sql = sql & " clitrans_action_date = NOW(), "
      End If
      sql = sql & " clitrans_sold_price = '" & aclsClient_Transactions.clitrans_sold_price & "', "
      sql = sql & " clitrans_sold_price_type = '" & Left(aclsClient_Transactions.clitrans_sold_price_type, 1) & "', "
      sql = sql & " clitrans_est_price = '" & aclsClient_Transactions.clitrans_est_price & "', "
      sql = sql & " clitrans_type = '" & Left(aclsClient_Transactions.clitrans_type, 40) & "' WHERE ((clitrans_id = '" & aclsClient_Transactions.clitrans_id & "')) limit 1 "
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Update_Client_Transactions(ByVal aclsClient_Transactions As clsClient_Transactions) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Update_Client_Transactions = 1
    Catch ex As Exception
      Update_Client_Transactions = 0
      Me.class_error = "Error in SQL Update_Client_Transactions(ByVal aclsClient_Transactions As clsClient_Transactions) As Integer " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function



  Public Function Insert_Client_Transactions(ByVal aclsClient_Transactions As clsClient_Transactions) As Integer
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim atemptable As New DataTable
    Dim sql As String = ""
    Dim returned_id As Integer = 0
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing

    Insert_Client_Transactions = 0
    Try


      sql = " INSERT INTO client_transactions (clitrans_jetnet_trans_id, clitrans_cliac_id, clitrans_cliamod_id, clitrans_lifecycle, clitrans_ownership, clitrans_date, clitrans_value_description, clitrans_subject, "
      sql += " clitrans_customer_note, clitrans_newac_flag, clitrans_internal_trans_flag, clitrans_date_listed, clitrans_exclusive_flag, clitrans_asking_wordage, "
      sql += " clitrans_asking_price, clitrans_ser_nbr, clitrans_reg_nbr, clitrans_country_of_registration, clitrans_airframe_total_hours, clitrans_airframe_total_landings, "
      sql += " clitrans_aport_iata_code, clitrans_aport_icao_code, clitrans_aport_name, clitrans_aport_state, clitrans_aport_country, clitrans_aport_city, clitrans_aport_private, "
      sql += " clitrans_action_date, clitrans_sold_price, clitrans_sold_price_type, clitrans_est_price, clitrans_type, clitrans_deal_type, clitrans_year_mfr, clitrans_jetnet_ac_id, "
      sql += " clitrans_subcat_code_part1, clitrans_subcat_code_part2, clitrans_subcat_code_part3, clitrans_subcategory_code, clitrans_retail_flag "
      sql += ")"
      sql += " VALUES"
      sql += " ('" & aclsClient_Transactions.clitrans_jetnet_trans_id & "', '" & aclsClient_Transactions.clitrans_cliac_id & "', '" & aclsClient_Transactions.clitrans_cliamod_id & "', '" & aclsClient_Transactions.clitrans_lifecycle & "', '" & aclsClient_Transactions.clitrans_ownership & "', "


      If Not IsDBNull(aclsClient_Transactions.clitrans_date) Then
        If IsDate(aclsClient_Transactions.clitrans_date) Then
          sql += " '" & Format(CDate(aclsClient_Transactions.clitrans_date), "yyyy-MM-dd HH:mm:ss") & "',"
        Else
          sql += " NULL,"
        End If
      Else
        sql += " NULL,"
      End If

      sql += " '" & Escape_Single_Quote(aclsClient_Transactions.clitrans_value_description) & "', "

      sql += " '" & Escape_Single_Quote(Left(aclsClient_Transactions.clitrans_subject, 200)) & "', "
      sql += " '" & Escape_Single_Quote(Left(aclsClient_Transactions.clitrans_customer_note, 250)) & "', "
      sql += " '" & Left(aclsClient_Transactions.clitrans_newac_flag, 1) & "', "
      sql += " '" & Left(aclsClient_Transactions.clitrans_internal_trans_flag, 1) & "', "

      If Not IsDBNull(aclsClient_Transactions.clitrans_date_listed) Then
        If IsDate(aclsClient_Transactions.clitrans_date_listed) Then
          sql += " '" & Format(CDate(aclsClient_Transactions.clitrans_date_listed), "yyyy-MM-dd HH:mm:ss") & "', "
        Else
          sql += "  NULL, "
        End If
      Else
        sql += " NULL, "
      End If


      sql += " '" & Left(aclsClient_Transactions.clitrans_exclusive_flag, 1) & "',"
      sql += " '" & Escape_Single_Quote(Left(aclsClient_Transactions.clitrans_asking_wordage, 10)) & "',"

      If IsNumeric(aclsClient_Transactions.clitrans_asking_price) Then
        sql += " '" & aclsClient_Transactions.clitrans_asking_price & "', "
      Else
        sql += " NULL, "
      End If


      sql += " '" & Escape_Single_Quote(Left(aclsClient_Transactions.clitrans_ser_nbr, 20)) & "', "
      sql += " '" & Escape_Single_Quote(Left(aclsClient_Transactions.clitrans_reg_nbr, 12)) & "', "
      sql += " '" & Escape_Single_Quote(Left(aclsClient_Transactions.clitrans_country_of_registration, 25)) & "', "

      If Not IsDBNull(aclsClient_Transactions.clitrans_airframe_total_hours) Then
        If IsNumeric(aclsClient_Transactions.clitrans_airframe_total_hours) Then
          sql += " '" & aclsClient_Transactions.clitrans_airframe_total_hours & "',"
        Else
          sql += " NULL,"
        End If
      Else
        sql += " NULL,"
      End If

      If Not IsDBNull(aclsClient_Transactions.clitrans_airframe_total_landings) Then
        If IsNumeric(aclsClient_Transactions.clitrans_airframe_total_landings) Then
          sql += " '" & aclsClient_Transactions.clitrans_airframe_total_landings & "',"
        Else
          sql += " NULL,"
        End If
      Else
        sql += " NULL,"
      End If



      sql += " '" & Escape_Single_Quote(Left(aclsClient_Transactions.clitrans_aport_iata_code, 4)) & "', "
      sql += " '" & Escape_Single_Quote(Left(aclsClient_Transactions.clitrans_aport_icao_code, 4)) & "', "
      sql += " '" & Escape_Single_Quote(Left(aclsClient_Transactions.clitrans_aport_name, 100)) & "', "
      sql += " '" & Escape_Single_Quote(Left(aclsClient_Transactions.clitrans_aport_state, 2)) & "', "
      sql += " '" & Escape_Single_Quote(Left(aclsClient_Transactions.clitrans_aport_country, 50)) & "', "
      sql += " '" & Escape_Single_Quote(Left(aclsClient_Transactions.clitrans_aport_city, 50)) & "',"
      sql += " '" & Escape_Single_Quote(Left(aclsClient_Transactions.clitrans_aport_private, 1)) & "', "

      If IsDate(aclsClient_Transactions.clitrans_action_date) Then
        sql += " '" & Format(CDate(aclsClient_Transactions.clitrans_action_date), "yyyy-MM-dd HH:mm:ss") & "', "
      Else
        sql += " NOW(), "
      End If

      sql += " '" & aclsClient_Transactions.clitrans_sold_price & "',"
      sql += " '" & Left(aclsClient_Transactions.clitrans_sold_price_type, 1) & "', "
      sql += " '" & aclsClient_Transactions.clitrans_est_price & "',"
      sql += " '" & Left(aclsClient_Transactions.clitrans_type, 40) & "', "
      sql += " '" & aclsClient_Transactions.clitrans_deal_type & "', "
      sql += " '" & aclsClient_Transactions.clitrans_year_mfr & "',"
      sql += " '" & aclsClient_Transactions.clitrans_jetnet_ac_id & "',"
      sql += "'" & Escape_Single_Quote(aclsClient_Transactions.clitrans_subcat_code_part1) & "',"
      sql += "'" & Escape_Single_Quote(aclsClient_Transactions.clitrans_subcat_code_part2) & "', "
      sql += "'" & Escape_Single_Quote(aclsClient_Transactions.clitrans_subcat_code_part3) & "',"
      sql += "'" & Escape_Single_Quote(aclsClient_Transactions.clitrans_subcategory_code) & "',"
      sql += "'" & Escape_Single_Quote(aclsClient_Transactions.clitrans_retail_flag) & "'"

      sql += ")"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Insert_Client_Transactions(ByVal aclsClient_Transactions As clsClient_Transactions) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()


      sql = "select clitrans_id from client_transactions order by clitrans_id desc"
      MySqlCommand.CommandText = sql

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br />Insert_Client_Transactions(ByVal aclsClient_Transactions As clsClient_Transactions) As Integer " & sql

      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try


      If atemptable.Rows.Count > 0 Then
        returned_id = atemptable.Rows(0).Item("clitrans_id")
      End If


      Insert_Client_Transactions = returned_id


    Catch ex As Exception
      Insert_Client_Transactions = 0
      Me.class_error = "Error in SQL Insert_Client_Transactions(ByVal aclsClient_Transactions As clsClient_Transactions) As Integer " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try


  End Function


  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Insert_Client_Transactions_Company
  ' Purpose: to update the transaction record from the company table
  ' Parameters: clsClient_Transactions_Company
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/7/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Insert_Client_Transactions_Company(ByVal aclsClient_Transactions_Company As clsClient_Transactions_Company) As Integer
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing

    Insert_Client_Transactions_Company = 0
    Try
      sql = "INSERT INTO client_transactions_company (clitcomp_id, clitcomp_trans_id, clitcomp_name, clitcomp_alternate_name_type, clitcomp_alternate_name, clitcomp_address1, clitcomp_address2, clitcomp_city, clitcomp_state, clitcomp_zip_code, clitcomp_country, clitcomp_agency_type, clitcomp_web_address, clitcomp_email_address, clitcomp_action_date) VALUES "
      sql = sql & " ('" & aclsClient_Transactions_Company.clitcomp_id & "', "
      sql = sql & " '" & aclsClient_Transactions_Company.clitcomp_trans_id & "', "
      sql = sql & " '" & Replace(Left(aclsClient_Transactions_Company.clitcomp_name, 40), "'", "\'") & "', "
      sql = sql & " '" & Replace(Left(aclsClient_Transactions_Company.clitcomp_alternate_name_type, 4), "'", "\'") & "', "
      sql = sql & " '" & Replace(Left(aclsClient_Transactions_Company.clitcomp_alternate_name, 40), "'", "\'") & "', "
      sql = sql & " '" & Replace(Left(aclsClient_Transactions_Company.clitcomp_address1, 50), "'", "\'") & "', "
      sql = sql & " '" & Replace(Left(aclsClient_Transactions_Company.clitcomp_address2, 50), "'", "\'") & "', "
      sql = sql & " '" & Replace(Left(aclsClient_Transactions_Company.clitcomp_city, 50), "'", "\'") & "', "
      sql = sql & " '" & Replace(Left(aclsClient_Transactions_Company.clitcomp_state, 2), "'", "\'") & "', "
      sql = sql & " '" & Replace(Left(aclsClient_Transactions_Company.clitcomp_zip_code, 10), "'", "\'") & "', "
      sql = sql & " '" & Replace(Left(aclsClient_Transactions_Company.clitcomp_country, 25), "'", "\'") & "', "
      sql = sql & " '" & Left(aclsClient_Transactions_Company.clitcomp_agency_type, 1) & "', "
      sql = sql & " '" & Replace(Left(aclsClient_Transactions_Company.clitcomp_web_address, 70), "'", "\'") & "', "
      sql = sql & " '" & Replace(Left(aclsClient_Transactions_Company.clitcomp_email_address, 70), "'", "\'") & "', "

      If IsDate(aclsClient_Transactions_Company.clitcomp_action_date) Then
        sql = sql & " '" & Format(CDate(aclsClient_Transactions_Company.clitcomp_action_date), "yyyy-MM-dd HH:mm:ss") & "')"
      Else
        sql = sql & " NOW())"
      End If

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Insert_Client_Transactions_Company(ByVal aclsClient_Transactions_Company As clsClient_Transactions_Company) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Insert_Client_Transactions_Company = 1
    Catch ex As Exception
      Insert_Client_Transactions_Company = 0
      Me.class_error = "Error in SQL Insert_Client_Transactions_Company(ByVal aclsClient_Transactions_Company As clsClient_Transactions_Company) As Integer " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Insert_Client_Transactions_PhoneNbrs
  ' Purpose: to update the transaction record from the phoneNbrs table
  ' Parameters: aclsClient_Transactions_Phone_Numbers
  ' Return: 
  '       Integer
  ' Change Log
  '           2/7/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Insert_Client_Transactions_PhoneNbrs(ByVal aclsClient_Transactions_Phone_Numbers As clsClient_Transactions_Phone_Numbers) As Integer
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing

    Insert_Client_Transactions_PhoneNbrs = 0
    Try
      sql = "INSERT INTO client_transactions_phone_numbers (clitpnum_comp_id, clitpnum_contact_id, clitpnum_trans_id, clitpnum_type, clitpnum_number) VALUES "
      sql = sql & " ('" & aclsClient_Transactions_Phone_Numbers.clitpnum_comp_id & "', '" & aclsClient_Transactions_Phone_Numbers.clitpnum_contact_id & "', "
      sql = sql & " '" & aclsClient_Transactions_Phone_Numbers.clitpnum_trans_id & "', '" & Left(aclsClient_Transactions_Phone_Numbers.clitpnum_type, 15) & "', "
      sql = sql & " '" & Left(aclsClient_Transactions_Phone_Numbers.clitpnum_number, 28) & "')"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Insert_Client_Transactions_PhoneNbrs(ByVal aclsClient_Transactions_Phone_Numbers As clsClient_Transactions_Phone_Numbers) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Insert_Client_Transactions_PhoneNbrs = 1
    Catch ex As Exception
      Insert_Client_Transactions_PhoneNbrs = 0
      Me.class_error = "Error in SQL Insert_Client_Transactions_PhoneNbrs(ByVal aclsClient_Transactions_Phone_Numbers As clsClient_Transactions_Phone_Numbers) As Integer " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Insert_Client_Transactions_Contact
  ' Purpose: to delete the transaction record from the contact table
  ' Parameters: clsclient_transactions_contact
  ' Return: 
  '       Integer
  ' Change Log
  '           2/07/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Insert_Client_Transactions_Contact(ByVal aclsclient_transactions_contact As clsclient_transactions_contact) As Boolean
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing

    Insert_Client_Transactions_Contact = False
    Try

      sql = "INSERT INTO client_transactions_contact (clitcontact_id, clitcontact_trans_id, clitcontact_comp_id, clitcontact_sirname, clitcontact_first_name, clitcontact_middle_initial, clitcontact_last_name, clitcontact_suffix, clitcontact_title, clitcontact_email_address, clitcontact_action_date) VALUES "
      sql = sql & " ('" & aclsclient_transactions_contact.clitcontact_id & "', "
      sql = sql & " '" & aclsclient_transactions_contact.clitcontact_trans_id & "', "
      sql = sql & " '" & aclsclient_transactions_contact.clitcontact_comp_id & "', "
      sql = sql & " '" & Replace(Left(aclsclient_transactions_contact.clitcontact_sirname, 10), "'", "\'") & "', "
      sql = sql & " '" & Replace(Left(aclsclient_transactions_contact.clitcontact_first_name, 15), "'", "\'") & "', "
      sql = sql & " '" & Replace(Left(aclsclient_transactions_contact.clitcontact_middle_initial, 1), "'", "\'") & "', "
      sql = sql & " '" & Replace(Left(aclsclient_transactions_contact.clitcontact_last_name, 25), "'", "\'") & "', "
      sql = sql & " '" & Replace(Left(aclsclient_transactions_contact.clitcontact_suffix, 5), "'", "\'") & "', "
      sql = sql & " '" & Replace(Left(aclsclient_transactions_contact.clitcontact_title, 40), "'", "\'") & "', "
      sql = sql & " '" & Replace(Left(aclsclient_transactions_contact.clitcontact_email_address, 70), "'", "\'") & "', "

      If IsDate(aclsclient_transactions_contact.clitcontact_action_date) Then
        sql = sql & " '" & Format(CDate(aclsclient_transactions_contact.clitcontact_action_date), "yyyy-MM-dd HH:mm:ss") & "')"
      Else
        sql = sql & " NOW())"
      End If
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Insert_Client_Transactions_Contact(ByVal aclsclient_transactions_contact As clsclient_transactions_contact) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Insert_Client_Transactions_Contact = True
    Catch ex As Exception
      Insert_Client_Transactions_Contact = False
      Me.class_error = "Error in SQL Insert_Client_Transactions_Contact(ByVal aclsclient_transactions_contact As clsclient_transactions_contact) As Integer " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Insert_Client_Transactions_aircraft_reference
  ' Purpose: to update the Client Transaction aircraft reference record
  ' Parameters: clsClient_Aircraft_Reference
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/07/2012   - Created By: Amanda
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Insert_Client_Transactions_aircraft_reference(ByVal aclsClient_Transaction_Aircraft_Reference As clsClient_Transactions_Sircraft_Reference) As Integer
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing

    Insert_Client_Transactions_aircraft_reference = 0
    Try

      sql = "INSERT INTO client_transactions_aircraft_reference (clitcref_id, clitcref_client_ac_id, clitcref_client_trans_id, clitcref_client_comp_id, clitcref_client_contact_id, clitcref_contact_type, clitcref_owner_percentage, clitcref_date_fraction_expires, clitcref_business_type, clitcref_operator_flag) VALUES "
      sql = sql & " ('" & aclsClient_Transaction_Aircraft_Reference.clitcref_id & "', '" & aclsClient_Transaction_Aircraft_Reference.clitcref_client_ac_id & "', '" & aclsClient_Transaction_Aircraft_Reference.clitcref_client_trans_id & "', '" & aclsClient_Transaction_Aircraft_Reference.clitcref_client_comp_id & "', '" & aclsClient_Transaction_Aircraft_Reference.clitcref_client_contact_id & "', "
      sql = sql & " '" & Left(aclsClient_Transaction_Aircraft_Reference.clitcref_contact_type, 2) & "', "
      sql = sql & " '" & aclsClient_Transaction_Aircraft_Reference.clitcref_owner_percentage & "', "
      If IsDate(aclsClient_Transaction_Aircraft_Reference.clitcref_date_fraction_expires) Then
        sql = sql & " '" & Format(CDate(aclsClient_Transaction_Aircraft_Reference.clitcref_date_fraction_expires), "yyyy-MM-dd HH:mm:ss") & "', "
      Else
        sql = sql & " NULL, "
      End If
      sql = sql & " '" & Left(aclsClient_Transaction_Aircraft_Reference.clitcref_business_type, 2) & "', "
      sql = sql & " '" & Left(aclsClient_Transaction_Aircraft_Reference.clitcref_operator_flag, 1) & "')"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Insert_Client_Transactions_aircraft_reference(ByVal aclsClient_Transaction_Aircraft_Reference As clsClient_Transactions_Sircraft_Reference) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Insert_Client_Transactions_aircraft_reference = 1
    Catch ex As Exception
      Insert_Client_Transactions_aircraft_reference = 0
      Me.class_error = "Error in SQL Insert_Client_Transactions_aircraft_reference(ByVal aclsClient_Transaction_Aircraft_Reference As clsClient_Transactions_Sircraft_Reference) As Integer " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function
#End Region
#Region "Projects"
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Build Export
  ' Purpose: Polls the company database Cliexp_type
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/2/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ''' <summary>
  ''' Polls the client export table based on cliexp_type
  ''' </summary>
  ''' <param name="cliexp_type">String</param>
  ''' <returns>Datatable</returns>
  ''' <remarks></remarks>
  Public Function Build_Export(ByVal cliexp_type As String, ByVal sub_type As String, Optional ByVal is_aerodex As Boolean = False) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Try
      sql = " SELECT distinct cliexp_id, cliexp_type, cliexp_display, cliexp_client_db_name, cliexp_jetnet_db_name,  'JETNET' as source "

      sql = sql & ", cliexp_header_field_name, cliexp_field_type, cliexp_field_length, cliexp_sub_group "
      sql = sql & " FROM client_export"

      'If Trim(cliexp_type) = "Feature Code" Then
      '  sql = sql & " inner join  client_key_features on concat('Feature ', clikfeat_type ) = cliexp_display and clikfeat_active_flag = 'Y' "
      '  sql = sql & " WHERE (cliexp_type = '" & cliexp_type & "')"
      '  sql = sql & " and clikfeat_active_flag = 'Y' "
      'Else
      sql = sql & " WHERE (cliexp_type = '" & cliexp_type & "')"
      ' End If


      '  If Trim(sub_type) = "Features" Then 
      'sql = sql & " and (cliexp_sub_group = 'Feature Code')"
      '  Else
      If Trim(sub_type) <> "" And Trim(sub_type) <> "All" Then
        sql = sql & " and (cliexp_sub_group = '" & sub_type & "')"
      End If




      If is_aerodex Then
        sql = sql & " and cliexp_aerodex_flag = 'Y' "
      End If

      sql = sql & "  order by cliexp_sub_group asc, cliexp_type, cliexp_sort "

      'switched out for crm central database
      If HttpContext.Current.Session.Item("jetnetWebSiteType") = eWebSiteTypes.TEST Then  '  Or HttpContext.Current.Session.Item("jetnetWebSiteType") = eWebSiteTypes.LOCAL 
        MySqlConn.ConnectionString = client_DB
      Else
        MySqlConn.ConnectionString = HttpContext.Current.Application.Item("crmMasterDatabase")
      End If
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Build_Export(ByVal cliexp_type As String) As DataTable</b><br />" & sql
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Return atemptable
    Catch ex As Exception
      Build_Export = Nothing
      Me.class_error = "Error in  SQL Build_Export(ByVal cliexp_type As String) As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  Public Function Build_Custom_Export(ByVal cliexp_type As String, ByVal sub_type As String) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Try
      sql = " SELECT distinct clicexp_id as cliexp_id, clicexp_type as cliexp_type, clicexp_display as cliexp_display, clicexp_client_db_name as cliexp_client_db_name, clicexp_jetnet_db_name as cliexp_jetnet_db_name, clicexp_sort as cliexp_sort, 'CLIENT' as source "

      sql = sql & ", clicexp_header_field_name as cliexp_header_field_name, clicexp_field_type as cliexp_field_type, clicexp_field_length as cliexp_header_field_length, '' as cliexp_sub_group "
      sql = sql & " FROM client_custom_export"
      If Trim(cliexp_type) = "Feature Code" Then
        sql = sql & " inner join  client_key_features on clikfeat_name = clicexp_display and clikfeat_active_flag = 'Y'  and clikfeat_source = 'CLIENT'  "
      End If

      sql = sql & " WHERE (clicexp_type = '" & cliexp_type & "')"

      '   If Trim(sub_type) <> "Custom" And Trim(sub_type) <> "All" Then
      '    sql = sql & " and clicexp_id = 0 " ' MAKE THIS SELECT NONE 
      ' End If

      '  If Trim(sub_type) = "Features" Then
      '    sql = sql & " and (clicexp_sub_group = 'Feature Code')"
      '  ElseIf Trim(sub_type) <> "" And Trim(sub_type) <> "All" Then
      '    sql = sql & " and (clicexp_sub_group = '" & sub_type & "')"
      ' End If


      sql = sql & "  order by clicexp_type, clicexp_sort "

      'switched out for crm central database
      MySqlConn.ConnectionString = client_DB

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Build_Export(ByVal cliexp_type As String) As DataTable</b><br />" & sql
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Return atemptable
    Catch ex As Exception
      Build_Custom_Export = Nothing
      Me.class_error = "Error in  SQL Build_Export(ByVal cliexp_type As String) As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function


  ''' <summary>
  ''' Basically takes the client Export table and searches by the cliexpID
  ''' </summary>
  ''' <param name="cliexp_id">integer, client export ID</param>
  ''' <returns>Datatable</returns>
  ''' <remarks></remarks>
  Public Function Build_Export_byID(ByVal cliexp_id As Integer) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Try
      sql = " SELECT cliexp_id, cliexp_type, cliexp_display,cliexp_client_primary_db_name, cliexp_client_db_name, cliexp_jetnet_db_name"
      sql = sql & ", cliexp_header_field_name, cliexp_field_type, cliexp_field_length, cliexp_sub_group "
      sql = sql & " FROM client_export "
      sql = sql & " WHERE (cliexp_id = " & cliexp_id & ")"

      'changed to read from crm central database
      If HttpContext.Current.Session.Item("jetnetWebSiteType") = eWebSiteTypes.TEST Or HttpContext.Current.Session.Item("jetnetWebSiteType") = eWebSiteTypes.LOCAL Then
        MySqlConn.ConnectionString = client_DB
      Else
        MySqlConn.ConnectionString = HttpContext.Current.Application.Item("crmMasterDatabase")
      End If

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Build_Export_byID(ByVal cliexp_id As Integer) As DataTable</b><br />" & sql
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Return atemptable
    Catch ex As Exception
      Build_Export_byID = Nothing
      Me.class_error = "Error in  SQL Build_Export_byID(ByVal cliexp_id As Integer) As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
  Public Function Build_Custom_Export_byID(ByVal cliexp_id As Integer) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Try
      sql = " SELECT distinct clicexp_id as cliexp_id, clicexp_type as cliexp_type, clicexp_display as cliexp_display, clicexp_client_primary_db_name as cliexp_client_primary_db_name, clicexp_client_db_name as cliexp_client_db_name, clicexp_jetnet_db_name as cliexp_jetnet_db_name, clicexp_sort as cliexp_sort"

      sql = sql & ", clicexp_header_field_name as cliexp_header_field_name, clicexp_field_type as cliexp_field_type, clicexp_field_length as cliexp_field_length, '' as cliexp_sub_group "

      sql = sql & " FROM client_custom_export "
      sql = sql & " WHERE (clicexp_id = " & cliexp_id & ")"


      MySqlConn.ConnectionString = client_DB


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Build_Export_byID(ByVal cliexp_id As Integer) As DataTable</b><br />" & sql
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Return atemptable
    Catch ex As Exception
      Build_Custom_Export_byID = Nothing
      Me.class_error = "Error in  SQL Build_Export_byID(ByVal cliexp_id As Integer) As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  '----------------------------------------------------------All Functions Involving Client Project Reference Class------------------------------------------------------------------
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Client_Project_Details_By_User_ID
  ' Purpose: to get all the Client_Project_Fields based on user id
  ' Parameters: @clipref_cliproj_id
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/2/2012    - Created By: Amanda Vaughn
  'Query: SELECT clipref_id, clipref_cliproj_id, clipref_exp_id, clipref_sort_order
  'FROM  client_project_reference
  'WHERE (clipref_cliproj_id = @clipref_cliproj_id)
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

  Public Function Client_Project_Reference_Details_By_Project_ID(ByVal clipref_cliproj_id As Integer)
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Try
      sql = "SELECT clipref_id, clipref_cliproj_id, clipref_exp_id, clipref_sort_order, clipref_source "
      sql = sql & " FROM(client_project_reference)"
      sql = sql & " WHERE (clipref_cliproj_id = " & clipref_cliproj_id & ") order by clipref_sort_order"

      MySqlConn.ConnectionString = client_DB

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Client_Project_Reference_Details_By_Project_ID(ByVal clipref_cliproj_id As Integer) as Datatable</b><br />" & sql
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Return atemptable
    Catch ex As Exception
      Client_Project_Reference_Details_By_Project_ID = Nothing
      Me.class_error = "Error in  SQL Client_Project_Reference_Details_By_Project_ID(ByVal clipref_cliproj_id As Integer) As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try


  End Function

  Public Function Client_Project_EXISTS_By_Project_ID(ByVal clipref_cliproj_id As Integer)
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Try
      sql = "SELECT cliproj_id "
      sql = sql & " FROM client_projects  "
      sql = sql & " WHERE (cliproj_id = " & clipref_cliproj_id & ")  "

      MySqlConn.ConnectionString = client_DB

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Client_Project_Reference_Details_By_Project_ID(ByVal clipref_cliproj_id As Integer) as Datatable</b><br />" & sql
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Return atemptable
    Catch ex As Exception
      Client_Project_EXISTS_By_Project_ID = Nothing
      Me.class_error = "Error in  SQL Client_Project_EXISTS_By_Project_ID(ByVal clipref_cliproj_id As Integer) As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try


  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Client_Project_Details_By_User_ID
  ' Purpose: to get all the Client_Project_Fields based on user id
  ' Parameters: @cliproj_user_id
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/3/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Client_Project_Details_By_User_ID(ByVal cliproj_user_id As Integer, Optional ByVal amod_id As Integer = 0, Optional ByVal type_of_export As String = "")
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Try
      sql = "SELECT cliproj_id, cliproj_name, cliproj_market_default, cliproj_description, cliproj_user_id, "
      sql = sql & " cliproj_shared, cliproj_action_date, cliproj_type, cliproj_source, cliproj_jetnet_model, cliproj_client_model, cliproj_model_default "
      sql = sql & " FROM client_projects "
      sql = sql & " WHERE ((cliproj_user_id = " & cliproj_user_id & " ) or cliproj_shared = 'Y' )"

      If amod_id > 0 Then
        sql = sql & " and (cliproj_jetnet_model = " & amod_id
        sql = sql & ")"

      End If

      If Trim(type_of_export) <> "" Then
        sql = sql & " and cliproj_source = '" & Trim(type_of_export) & "' "
      End If

      sql = sql & " order by cliproj_name asc  "

      MySqlConn.ConnectionString = client_DB

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Client_Project_Details_By_User_ID(ByVal cliproj_user_id As Integer) as Datatable</b><br />" & sql
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      Return atemptable

    Catch ex As Exception
      Client_Project_Details_By_User_ID = Nothing
      Me.class_error = "Error in  SQL Client_Project_Details_By_User_ID(ByVal cliproj_user_id As Integer) As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try


  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Client_Project_Details_By_User_ID
  ' Purpose: to get all the Client_Project_Fields based on user id
  ' Parameters: @cliproj_user_id
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/3/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Client_Project_Details_By_MarketDefault(ByVal cliproj_user_id As Integer, Optional ByVal amod_id As Integer = 0, Optional ByVal type_of_export As String = "")
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Try
      sql = "SELECT cliproj_id, cliproj_name, cliproj_market_default, cliproj_description, cliproj_user_id, "
      sql = sql & " cliproj_shared, cliproj_action_date, cliproj_type, cliproj_source, cliproj_jetnet_model, cliproj_client_model, cliproj_model_default "
      sql = sql & " FROM client_projects "
      sql = sql & " WHERE  cliproj_market_default = 'Y' "

      If Trim(type_of_export) <> "" Then
        sql = sql & " and cliproj_source = '" & Trim(type_of_export) & "' "
      End If
      sql = sql & " order by cliproj_name asc  "

      MySqlConn.ConnectionString = client_DB

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Client_Project_Details_By_User_ID(ByVal cliproj_user_id As Integer) as Datatable</b><br />" & sql
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try
      Return atemptable

    Catch ex As Exception
      Client_Project_Details_By_MarketDefault = Nothing
      Me.class_error = "Error in  SQL Client_Project_Details_By_User_ID(ByVal cliproj_user_id As Integer) As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try


  End Function
  Public Function Get_JETNET_Models_For_Drop(ByVal jetnet_amod_id_string As String, ByVal jetnet_amod_id As Integer, ByVal is_for_lookup As Boolean) As DataTable
    Get_JETNET_Models_For_Drop = Nothing
    Dim JETNET_SqlConn2 As New SqlClient.SqlConnection
    Dim JETNET_SqlCommand2 As New SqlClient.SqlCommand
    Dim JETNET_SqlException2 As SqlClient.SqlException : JETNET_SqlException2 = Nothing
    Dim JETNET_SqlReader2 As SqlClient.SqlDataReader : JETNET_SqlReader2 = Nothing
    Dim jetnet_query As String = ""
    Dim jetnet As New DataTable

    Try


      JETNET_SqlConn2.ConnectionString = JETNET_DB


      JETNET_SqlConn2.Open()
      JETNET_SqlCommand2.Connection = JETNET_SqlConn2
      JETNET_SqlCommand2.CommandType = CommandType.Text
      JETNET_SqlCommand2.CommandTimeout = 60


      jetnet_query = "select '0' as cliamod_id, amod_id, amod_make_name, amod_model_name, 'jetnet' as source "
      jetnet_query = jetnet_query & " from aircraft_model with (NOLOCK) "


      If Trim(jetnet_amod_id_string) <> "" Then
        jetnet_query = jetnet_query & " where amod_id not in (" & jetnet_amod_id_string & ") "
      End If

      ' for loading
      If jetnet_amod_id > 0 And Trim(jetnet_amod_id_string) = "" Then
        jetnet_query = jetnet_query & " where amod_id = " & Trim(jetnet_amod_id) & " "
      End If

      jetnet_query = jetnet_query & " order by amod_make_name asc, amod_model_name asc"


      ' if its for lookup, it needs id
      If (is_for_lookup = False) Or jetnet_amod_id > 0 Then

        jetnet = New DataTable
        JETNET_SqlCommand2.CommandText = jetnet_query
        JETNET_SqlReader2 = JETNET_SqlCommand2.ExecuteReader()
        Try
          jetnet.Load(JETNET_SqlReader2)
        Catch constrExc As System.Data.ConstraintException
          Dim rowsErr As System.Data.DataRow() = jetnet.GetErrors()
        End Try


        Get_JETNET_Models_For_Drop = jetnet
      Else
        Get_JETNET_Models_For_Drop = Nothing
      End If


    Catch ex As Exception
    Finally
      JETNET_SqlConn2.Dispose()
      JETNET_SqlConn2.Close()
      JETNET_SqlConn2 = Nothing

      JETNET_SqlCommand2.Dispose()
      JETNET_SqlCommand2 = Nothing
    End Try
  End Function

  Public Function Get_Client_Models_For_Drop(ByRef jetnet_amod_id_string As String, ByVal client_amod_id As Integer) As DataTable
    Get_Client_Models_For_Drop = Nothing
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Try
      sql = "SELECT cliamod_id as cliamod_id, cliamod_jetnet_amod_id as amod_id, cliamod_make_name as amod_make_name, cliamod_model_name as amod_model_name, 'client' as source "
      sql = sql & " FROM client_aircraft_model "
      sql = sql & " order by cliamod_make_name asc, cliamod_model_name asc "

      MySqlConn.ConnectionString = client_DB

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Client_Project_Details_By_User_ID(ByVal cliproj_user_id As Integer) as Datatable</b><br />" & sql
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try




      If atemptable.Rows.Count > 0 Then
        For Each r As DataRow In atemptable.Rows

          If Trim(jetnet_amod_id_string) = "" Then
            jetnet_amod_id_string = jetnet_amod_id_string & "'" & r("amod_id") & "' "
          Else
            jetnet_amod_id_string = jetnet_amod_id_string & ",'" & r("amod_id") & "' "
          End If
        Next
      End If


      Get_Client_Models_For_Drop = atemptable
    Catch ex As Exception
      Me.class_error = "Error in  SQL Get_Client_Models: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try


  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Client_Project_Details_By_Shared_Flag
  ' Purpose: to get all the Client_Project_Fields based on shared_flag
  ' Parameters: @cliproj_shared
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/03/2012    - Created By: Amanda Vaughn
  'Query : SELECT cliproj_id, cliproj_name, cliproj_description, cliproj_user_id, cliproj_shared, cliproj_action_date, cliproj_type, cliproj_source
  'FROM   client_projects
  'WHERE  (cliproj_shared = @cliproj_shared)
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Client_Project_Details_By_Shared_Flag(ByVal cliproj_shared As String, Optional ByVal amod_id As Integer = 0, Optional ByVal exclude_user_id As Long = 0) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Try
      sql = "SELECT cliproj_id, cliproj_name, cliproj_description,"
      sql = sql & " cliproj_user_id, cliproj_shared, cliproj_action_date, cliproj_type, cliproj_source, cliproj_jetnet_model, cliproj_client_model "
      sql = sql & " FROM client_projects "
      sql = sql & " WHERE (cliproj_shared = '" & cliproj_shared & "')"

      If amod_id > 0 Then
        sql = sql & " and cliproj_jetnet_model = " & amod_id
      End If

      If exclude_user_id <> 0 Then
        sql = sql & " and cliproj_user_id <> " & exclude_user_id
      End If

      sql = sql & " order by cliproj_name asc  "

      MySqlConn.ConnectionString = client_DB

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Client_Project_Details_By_Shared_Flag(ByVal cliproj_shared As String) as Datatable</b><br />" & sql
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Return atemptable
    Catch ex As Exception
      Client_Project_Details_By_Shared_Flag = Nothing
      Me.class_error = "Error in  SQL Client_Project_Details_By_Shared_Flag(ByVal cliproj_shared As String) As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  '----------------------------------------------------------All Functions Involving Client Project Class------------------------------------------------------------------
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Client_Project_Details_By_ID
  ' Purpose: to get all the Client_Project_Fields based on individual project ID
  ' Parameters: @cliproj_id
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/3/2012   - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Client_Project_Details_By_Project_ID(ByVal cliproj_id As Integer) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Try
      sql = "SELECT cliproj_id, cliproj_name, cliproj_description, "
      sql = sql & " cliproj_user_id, cliproj_shared, cliproj_action_date, cliproj_type, cliproj_source, cliproj_jetnet_model, cliproj_client_model, cliproj_model_default, cliproj_market_default"
      sql = sql & " FROM client_projects "
      sql = sql & " WHERE (cliproj_id = " & cliproj_id & ")"

      MySqlConn.ConnectionString = client_DB

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Client_Project_Details_By_Project_ID(ByVal cliproj_id As Integer) as Datatable</b><br />" & sql
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Return atemptable
    Catch ex As Exception
      Client_Project_Details_By_Project_ID = Nothing
      Me.class_error = "Error in  SQL Client_Project_Details_By_Project_ID(ByVal cliproj_id As Integer) As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function


  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Client_Project_Details_By_Name
  ' Purpose: to get all the Client_Project_Fields based on user id
  ' Parameters: @cliproj_name
  ' Return: 
  '       DataTable
  ' Change Log
  '           2/3/2012    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Client_Project_Details_By_Name(ByVal cliproj_id As String) As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Try
      sql = " SELECT  cliproj_id, cliproj_name, cliproj_description, "
      sql = sql & " cliproj_user_id, cliproj_shared, cliproj_action_date, cliproj_type, cliproj_source"
      sql = sql & " FROM client_projects "
      sql = sql & " WHERE (cliproj_id = " & cliproj_id & " )"

      MySqlConn.ConnectionString = client_DB

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Client_Project_Details_By_Name(ByVal cliproj_name As String) as Datatable</b><br />" & sql
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Return atemptable
    Catch ex As Exception
      Client_Project_Details_By_Name = Nothing
      Me.class_error = "Error in  SQL Client_Project_Details_By_Name(ByVal cliproj_name As String) As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Delete_Client_Project_Reference
  ' Purpose: to delete a client_project row by project id
  ' Parameters: clipref_cliproj_id
  ' Return: 
  '       Integer
  ' Change Log
  '           5/03/2011   - Created By: Amanda Vaughn
  'Query : DELETE FROM `client_project_reference` WHERE (`clipref_cliproj_id` = @Original_clipref_cliproj_id) 
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Client_Project_Reference_Delete(ByVal clipref_cliproj_id As Integer) As Integer
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Client_Project_Reference_Delete = 0
    Try
      sql = "DELETE FROM client_project_reference WHERE (clipref_cliproj_id = '" & clipref_cliproj_id & "') limit 200"
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Client_Project_Reference_Delete(ByVal clipref_cliproj_id As Integer) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Client_Project_Reference_Delete = 1
    Catch ex As Exception
      Client_Project_Reference_Delete = 0
      Me.class_error = "Error in SQL Client_Project_Reference_Delete(ByVal clipref_cliproj_id As Integer) As Integer  " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Client_Project_Delete
  ' Purpose: to Delete a client_project row
  ' Parameters: ByVal cliproj_id As Integer, ByVal cliproj_user_id As Integer
  ' Return: 
  '       Integer
  ' Change Log
  '           2/03/2012   - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  'Query: DELETE FROM client_projects WHERE (cliproj_id = @Original_cliproj_id) AND (cliproj_user_id = @Original_cliproj_user_id)
  Public Function Client_Project_Delete(ByVal cliproj_id As Integer, ByVal cliproj_user_id As Integer) As Integer
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Client_Project_Delete = 0
    Try

      If HttpContext.Current.Session.Item("localUser").crmUserType = eUserTypes.ADMINISTRATOR Or cliproj_user_id > 0 Then



        sql = "DELETE FROM client_projects"
        sql = sql & " WHERE (cliproj_id = " & cliproj_id & " ) "

        If cliproj_user_id > 0 Then
          sql = sql & " AND  cliproj_user_id = " & cliproj_user_id & " "
        End If

        sql = sql & " limit 1"
        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Client_Project_Delete(ByVal cliproj_id As Integer, ByVal cliproj_user_id As Integer) As Integer</b><br />" & sql


        MySqlConn.ConnectionString = Me.client_DB
        MySqlConn.Open()
        MySqlCommand.Connection = MySqlConn
        MySqlCommand.CommandType = CommandType.Text
        MySqlCommand.CommandTimeout = 60

        MySqlCommand.CommandText = sql
        MySqlCommand.ExecuteNonQuery()
        Client_Project_Delete = 1
      End If

    Catch ex As Exception
      Client_Project_Delete = 0
      Me.class_error = "Error in SQL Client_Project_Delete(ByVal cliproj_id As Integer, ByVal cliproj_user_id As Integer) As Integer  " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Client_Project_Insert
  ' Purpose: to insert a client_project row
  ' Parameters: clsclient_project
  ' Return: 
  '       Integer
  ' Change Log
  '           2/03/2011   - Created By: Amanda Vaughn
  'Query : INSERT INTO `client_projects` (`cliproj_name`, `cliproj_description`, `cliproj_user_id`, `cliproj_shared`, `cliproj_action_date`, `cliproj_type`, `cliproj_source`) VALUES (@cliproj_name, @cliproj_description, @cliproj_user_id, @cliproj_shared, @cliproj_action_date, @cliproj_type, @cliproj_source)
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Client_Project_Insert(ByVal aclclient_project As clsClient_Project) As Integer
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim sql As String = ""
    Dim atemptable As New DataTable
    Dim returned As Integer = 0
    Client_Project_Insert = 0
    Try
      sql = "INSERT INTO client_projects (cliproj_name, cliproj_description, cliproj_user_id, cliproj_shared, cliproj_action_date, cliproj_type, cliproj_source, cliproj_jetnet_model, cliproj_client_model, cliproj_model_default, cliproj_market_default) VALUES ('" & aclclient_project.cliproj_name & "', '" & aclclient_project.cliproj_description & "', '" & aclclient_project.cliproj_user_id & "', '" & aclclient_project.cliproj_shared & "', NOW(), '" & aclclient_project.cliproj_type & "', '" & aclclient_project.cliproj_source & "', '" & aclclient_project.cliproj_jetnet_model & "', '" & aclclient_project.cliproj_client_model & "', '" & aclclient_project.cliproj_model_default & "', '" & aclclient_project.cliproj_market_default & "'   )"



      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Client_Project_Insert(ByVal aclclient_project As clsClient_Project) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()



      sql = " SELECT last_insert_id() as 'cliaproj_id'"


      MySqlCommand.CommandText = sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      If atemptable.Rows.Count > 0 Then
        returned = atemptable.Rows(0).Item("cliaproj_id")
      End If

      Client_Project_Insert = returned
    Catch ex As Exception
      Client_Project_Insert = 0
      Me.class_error = "Error in SQL Client_Project_Insert(ByVal aclclient_project As clsClient_Project) As Integer  " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function
  Public Function UPDATE_DEFAULT_MODELS(ByVal model_id As Long, ByVal type_of As String, ByVal cliproj_id As Long, ByVal user_id As Long) As Boolean
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Dim atemptable As New DataTable
    UPDATE_DEFAULT_MODELS = False
    Try


      sql = "UPDATE client_projects"
      sql = sql & " SET cliproj_model_default = 'N' "
      sql = sql & " WHERE (cliproj_id <> '" & cliproj_id & "' and cliproj_source = '" & type_of & "' and cliproj_jetnet_model = " & model_id & " and cliproj_user_id = " & user_id & ")"
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Client_Project_Update(ByVal aclclient_project As clsClient_Project) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()

      UPDATE_DEFAULT_MODELS = True
    Catch ex As Exception
      UPDATE_DEFAULT_MODELS = False
      Me.class_error = "Error in SQL UPDATE_DEFAULT_MODELS(ByVal aclclient_project As clsClient_Project) As Integer  " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Client_Project_Update
  ' Purpose: to Update a client_project row
  ' Parameters: clsclient_project
  ' Return: 
  '       Integer
  ' Change Log
  '           2/07/2012   - Created By: Amanda Vaughn
  'Query: UPDATE  client_projects SET cliproj_name = @cliproj_name, cliproj_description = @cliproj_description, cliproj_user_id = @cliproj_user_id, cliproj_shared = @cliproj_shared, cliproj_action_date = @cliproj_action_date, cliproj_type = @cliproj_type, cliproj_source = @cliproj_source WHERE (cliproj_id = @Original_cliproj_id)
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Client_Project_Update(ByVal aclclient_project As clsClient_Project) As Integer
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Dim atemptable As New DataTable
    Client_Project_Update = 0
    Try


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60



      If Trim(aclclient_project.cliproj_market_default) = "Y" Then
        sql = "UPDATE client_projects SET cliproj_market_default = 'N'  "
        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Client_Project_Update(ByVal aclclient_project As clsClient_Project) As Integer</b><br />" & sql

        MySqlCommand.CommandText = sql
        MySqlCommand.ExecuteNonQuery()
      End If



      sql = "UPDATE client_projects"
      sql = sql & " SET cliproj_name = '" & aclclient_project.cliproj_name & "', "
      sql = sql & " cliproj_description = '" & aclclient_project.cliproj_description & "', "
      sql = sql & " cliproj_user_id = '" & aclclient_project.cliproj_user_id & "', "
      sql = sql & " cliproj_shared = '" & aclclient_project.cliproj_shared & "', "
      sql = sql & " cliproj_jetnet_model = '" & aclclient_project.cliproj_jetnet_model & "', "
      sql = sql & " cliproj_client_model = '" & aclclient_project.cliproj_client_model & "', "
      sql = sql & " cliproj_model_default = '" & aclclient_project.cliproj_model_default & "', "
      sql = sql & " cliproj_market_default = '" & aclclient_project.cliproj_market_default & "', "

      If IsDate(aclclient_project) Then
        sql = sql & " cliproj_action_date = '" & Format(aclclient_project.cliproj_action_date, "yyyy-MM-dd H:mm:ss") & "', "
      Else
        sql = sql & " cliproj_action_date = NOW(), "
      End If
      sql = sql & " cliproj_type = '" & aclclient_project.cliproj_type & "', "
      sql = sql & " cliproj_source = '" & aclclient_project.cliproj_source & "' "
      sql = sql & " WHERE (cliproj_id = '" & aclclient_project.cliproj_id & "' )"
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Client_Project_Update(ByVal aclclient_project As clsClient_Project) As Integer</b><br />" & sql

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()

      Client_Project_Update = 1
    Catch ex As Exception
      Client_Project_Update = 0
      Me.class_error = "Error in SQL Client_Project_Update(ByVal aclclient_project As clsClient_Project) As Integer  " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Client_Project_Reference_Insert
  ' Purpose: to insert a client_project_reference row
  ' Parameters: clsclient_project_reference
  ' Return: 
  '       Integer
  ' Change Log
  '           2/07/2011   - Created By: Amanda Vaughn
  'Query : INSERT INTO `client_project_reference` (`clipref_cliproj_id`, `clipref_exp_id`, `clipref_sort_order`) VALUES (@clipref_cliproj_id, @clipref_exp_id, @clipref_sort_order)
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Client_Project_Reference_Insert(ByVal aclClient_Project_Reference As clsClient_Project_Reference) As Integer
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim sql As String = ""
    Dim atemptable As New DataTable
    Client_Project_Reference_Insert = 0
    Try

      sql = "INSERT INTO client_project_reference (clipref_cliproj_id, clipref_exp_id, clipref_sort_order, clipref_source) VALUES "
      sql = sql & " ('" & aclClient_Project_Reference.clipref_cliproj_id & "', '" & aclClient_Project_Reference.clipref_exp_id & "', '" & aclClient_Project_Reference.clipref_sort_order & "',"
      sql = sql & "'" & aclClient_Project_Reference.clipref_source & "' "
      sql = sql & ")"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Client_Project_Reference_Insert(ByVal aclClient_Project_Reference As clsClient_Project_Reference) As Integer</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()

      Client_Project_Reference_Insert = 1
    Catch ex As Exception
      Client_Project_Reference_Insert = 0
      Me.class_error = "Error in SQL Client_Project_Reference_Insert(ByVal aclClient_Project_Reference As clsClient_Project_Reference) As Integer  " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function
#End Region

#Region "Administration Queries"
  ''' <summary>
  ''' Function that returns counts on the client database tables
  ''' </summary>
  ''' <returns></returns>
  ''' <remarks></remarks>

  Public Function GetMasterClientDBTotals() As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Try

      sql = "select count(clicomp_id) as company_count, (select count(clicontact_id) from client_contact) as contact_count, (select count(cliaircraft_id) from client_aircraft) as ac_count, (select count(lnote_id) from local_notes where lnote_status = 'W') as wanted_count, (select count(lnote_id) from local_notes where lnote_status = 'A') as note_count, (select count(lnote_id) from local_notes where lnote_status = 'P') as action_count, (select count(lnote_id) from local_notes where lnote_status = 'O') as opp_count, (select count(clitrans_id) from client_transactions) as trans_count from client_company"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>GetMasterClientDBTotals() As DataTable</b><br />" & sql

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql

      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Return atemptable
    Catch ex As Exception
      GetMasterClientDBTotals = Nothing
      Me.class_error = "Error in  SQL GetMasterClientDBTotals() As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
  Public Function GetMasterClientAircraft() As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Try


      sql = "   select cliamod_make_name, cliamod_model_name, cliamod_jetnet_amod_id, "
      sql = sql & " (select count(*) from client_aircraft afs where afs.cliaircraft_forsale_flag = 'Y' and afs.cliaircraft_cliamod_id = cliamod_id) as fs_count,"
      sql = sql & " (select count(*) from client_aircraft anfs where anfs.cliaircraft_forsale_flag = 'N' and anfs.cliaircraft_cliamod_id = cliamod_id) as nfs_count"
      sql = sql & "   from client_aircraft "
      sql = sql & " inner join client_aircraft_model on cliamod_id = cliaircraft_cliamod_id"
      'sql = sql & " where cliamod_model_name = '604'  "
      sql = sql & " group by cliamod_make_name, cliamod_model_name, cliamod_jetnet_amod_id"
      sql = sql & " order by cliamod_make_name, cliamod_model_name, cliamod_jetnet_amod_id"


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>GetMasterClientDBTotals() As DataTable</b><br />" & sql

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql

      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Return atemptable
    Catch ex As Exception
      GetMasterClientAircraft = Nothing
      Me.class_error = "Error in  SQL GetMasterClientDBTotals() As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  ''' <summary>
  ''' Function used on the home page to run the master list of user totals for the CRM.
  ''' </summary>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function GetMasterUserNoteCountList() As DataTable
    Dim sql As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Try
      Dim StartDate As Date = CDate(Year(Now()) & "-" & Month(Now()) & "-1")
      Dim month_one As Date = DateAdd(DateInterval.Month, -1, StartDate)
      Dim month_two As Date = DateAdd(DateInterval.Month, -2, StartDate)
      Dim month_three As Date = DateAdd(DateInterval.Month, -3, StartDate)
      Dim month_four As Date = DateAdd(DateInterval.Month, -4, StartDate)
      Dim month_five As Date = DateAdd(DateInterval.Month, -5, StartDate)
      Dim month_six As Date = DateAdd(DateInterval.Month, -6, StartDate)


      sql = "select cliuser_first_name, cliuser_last_name, cliuser_email_address,"
      sql = sql & " (select COUNT(lnote_id) from local_notes where lnote_status='A' and cliuser_id = lnote_user_id and lnote_entry_date >= '" & Year(month_one) & "-" & Month(month_one) & "-" & Day(month_one) & "' and lnote_entry_date < '" & Year(StartDate) & "-" & Month(StartDate) & "-" & Day(StartDate) & "') as month_one_count,"
      sql = sql & " (select COUNT(lnote_id) from local_notes where lnote_status='A' and cliuser_id = lnote_user_id and lnote_entry_date >= '" & Year(month_two) & "-" & Month(month_two) & "-" & Day(month_two) & "' and lnote_entry_date < '" & Year(month_one) & "-" & Month(month_one) & "-" & Day(month_one) & "') as month_two_count, "
      sql = sql & " (select COUNT(lnote_id) from local_notes where lnote_status='A' and cliuser_id = lnote_user_id and lnote_entry_date >= '" & Year(month_three) & "-" & Month(month_three) & "-" & Day(month_three) & "' and lnote_entry_date < '" & Year(month_two) & "-" & Month(month_two) & "-" & Day(month_two) & "') as month_three_count, "
      sql = sql & " (select COUNT(lnote_id) from local_notes where lnote_status='A' and cliuser_id = lnote_user_id and lnote_entry_date >= '" & Year(month_four) & "-" & Month(month_four) & "-" & Day(month_four) & "' and lnote_entry_date < '" & Year(month_three) & "-" & Month(month_three) & "-" & Day(month_three) & "') as month_four_count, "
      sql = sql & " (select COUNT(lnote_id) from local_notes where lnote_status='A' and cliuser_id = lnote_user_id and lnote_entry_date >= '" & Year(month_five) & "-" & Month(month_five) & "-" & Day(month_five) & "' and lnote_entry_date < '" & Year(month_four) & "-" & Month(month_four) & "-" & Day(month_four) & "') as month_five_count, "
      sql = sql & " (select COUNT(lnote_id) from local_notes where lnote_status='A' and cliuser_id = lnote_user_id and lnote_entry_date >= '" & Year(month_six) & "-" & Month(month_six) & "-" & Day(month_six) & "' and lnote_entry_date < '" & Year(month_five) & "-" & Month(month_five) & "-" & Day(month_five) & "') as month_six_count, "
      sql = sql & " (select COUNT(lnote_id) from local_notes where lnote_status='A' and cliuser_id = lnote_user_id) as total_note_count, "
      sql = sql & " (select COUNT(lnote_id) from local_notes where lnote_status='P' and cliuser_id = lnote_user_id) as total_action_count,"
      sql = sql & " (select COUNT(lnote_id) from local_notes where lnote_status='O' and cliuser_id = lnote_user_id ) as total_opp_count "
      sql = sql & " from client_user"
      sql = sql & " where cliuser_active_flag = 'Y'"


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>GetMasterUserNoteCountList() As DataTable</b><br />" & sql

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql

      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      Return atemptable
    Catch ex As Exception
      GetMasterUserNoteCountList = Nothing
      Me.class_error = "Error in  SQL GetMasterUserNoteCountList() As DataTable: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
  Public Function Create_Aircraft_Maintenance(ByVal cliac_id As Long) As String
    'Client AC ID
    'Client(Make)
    'Client(Model)
    'Client(Serial#)
    'JETNET(Serial#)
    'JETNET AC ID
    'Action (if any)

    'For first pass on this it is ok if you just print out every update and I will review a few by hand.
    '1.	Get list of all client aircraft records
    '2.	If JETNET aircraft id > 0 then
    '2.1.	if JETNET aircraft does not exist in JETNET database then
    '2.1.1.	then set jetnet ac id on client record to 0 [and potentially run check #3 below]
    '2.2.	if JETNET aircraft exists in JETNET database then
    '2.2.1.	check serial number sort field – if not the same then set the client serial number sort equal to the JETNET serial number sort
    '2.2.2.	check serial number full field – if not the same then print out the id’s and differences in the serial numbers
    '3.	if JETNET aircraft id = 0 then
    '3.1.	check to see if we have an aircraft with the same model and serial number and if so put in a list with a link to fix.
    Dim client As New DataTable
    Dim client_sql As String = ""
    Dim query_string_return As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim string_hold As String = ""
    '''''''''''''''''''''''''''''''''''''''
    'execution query connection.
    Dim exeQuery As String = ""
    'Dim ExeConn As New MySql.Data.MySqlClient.MySqlConnection
    'Dim ExeCommand As New MySql.Data.MySqlClient.MySqlCommand
    'Dim ExeException As MySql.Data.MySqlClient.MySqlException : ExeException = Nothing
    'ExeConn.ConnectionString = Me.client_DB 'client DB
    'ExeConn.Open()
    'ExeCommand.Connection = MySqlConn
    'ExeCommand.CommandType = CommandType.Text
    'ExeCommand.CommandTimeout = 60
    ''''''''''''''''''''''''''''''''''''''''''''''''''''''''

    'jetnet connection
    Dim jetnet_sql As String = ""
    Dim counter As Integer = 0
    counter = 0
    Dim jetnet As New DataTable
    Dim JETNET_SqlConn2 As New SqlClient.SqlConnection
    Dim JETNET_SqlCommand2 As New SqlClient.SqlCommand
    Dim JETNET_SqlException2 As SqlClient.SqlException : JETNET_SqlException2 = Nothing
    Dim JETNET_SqlReader2 As SqlClient.SqlDataReader : JETNET_SqlReader2 = Nothing

    'initialize mysql connection
    MySqlConn.ConnectionString = Me.client_DB
    MySqlConn.Open()
    MySqlCommand.Connection = MySqlConn
    MySqlCommand.CommandType = CommandType.Text
    MySqlCommand.CommandTimeout = 60

    query_string_return = "<table width='100%' cellpadding='3' cellspacing='0' border='1' style='color:#ff0000;font-weight:normal;'>"
    query_string_return = query_string_return & "<tr><td align='left' valign='top' width='90'><u><b>Client AC ID</b></u></td>"
    query_string_return = query_string_return & "<td align='left' valign='top' width='120'><u><b>Client Make</b></u></td>"
    query_string_return = query_string_return & "<td align='left' valign='top' width='100'><u><b>Client Model</b></u></td>"
    query_string_return = query_string_return & "<td align='left' valign='top' width='120'><u><b>Client Serial#</b></u></td>"
    query_string_return = query_string_return & "<td align='left' valign='top' width='120'><u><b>Jetnet Serial#</b></u></td>"
    query_string_return = query_string_return & "<td align='left' valign='top' width='90'><u><b>Jetnet AC ID</b></u></td>"
    query_string_return = query_string_return & "<td align='left' valign='top'><u><b>Action</b></u></td></tr>"
    Try
      client_sql = "select cliaircraft_id, cliamod_make_name, cliamod_model_name, cliaircraft_ser_nbr, cliaircraft_ser_nbr_sort, cliamod_jetnet_amod_id, cliaircraft_jetnet_ac_id "
      client_sql &= " from client_aircraft inner join client_aircraft_model on cliaircraft_cliamod_id = cliamod_id "

      If cliac_id > 0 Then
        client_sql &= " where cliaircraft_id = " & cliac_id
      End If

      client_sql &= " order by cliaircraft_jetnet_ac_id desc "

      MySqlCommand.CommandText = client_sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      Try
        client.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = client.GetErrors()
      End Try
      If client.Rows.Count > 0 Then
        For Each r As DataRow In client.Rows
          jetnet = New DataTable
          counter = 0
          string_hold = ""
          'Start the first part of this table response.
          string_hold = string_hold & "<tr><td align='left' valign='top'><a href='details.aspx?ac_ID=" & r("cliaircraft_id") & "&source=CLIENT&type=3' target='new'>" & r("cliaircraft_id") & "</a></td>"
          string_hold = string_hold & "<td align='left' valign='top'>" & r("cliamod_make_name") & "</td>"
          string_hold = string_hold & "<td align='left' valign='top'>" & r("cliamod_model_name") & "</td>"
          string_hold = string_hold & "<td align='left' valign='top'>" & r("cliaircraft_ser_nbr") & "</td>"

          If r("cliaircraft_jetnet_ac_id") > 0 Then

            '2.	If JETNET aircraft id > 0 then
            '2.1.	if JETNET aircraft does not exist in JETNET database then
            '2.1.1.	then set jetnet ac id on client record to 0 [and potentially run check #3 below]
            '2.2.	if JETNET aircraft exists in JETNET database then
            '2.2.1.	check serial number sort field – if not the same then set the client serial number sort equal to the JETNET serial number sort
            '2.2.2.	check serial number full field – if not the same then print out the id’s and differences in the serial numbers

            jetnet_sql = ""
            jetnet_sql = "Select DISTINCT "
            jetnet_sql = jetnet_sql & "aircraft.ac_id, aircraft.ac_ser_no_sort, "
            jetnet_sql = jetnet_sql & " aircraft.ac_ser_no_full as ac_ser_nbr, aircraft.ac_reg_no as ac_reg_nbr, "
            jetnet_sql = jetnet_sql & " aircraft.ac_mfr_year as ac_year_mfr, "
            jetnet_sql = jetnet_sql & "aircraft_model.amod_make_name, aircraft_model.amod_model_name "
            jetnet_sql = jetnet_sql & ", aircraft_maintenance.acmaint_name, aircraft_maintenance.acmaint_complied_date, aircraft_maintenance.acmaint_complied_hrs "
            jetnet_sql = jetnet_sql & ", aircraft_maintenance.acmaint_due_date, aircraft_maintenance.acmaint_due_hrs "
            jetnet_sql = jetnet_sql & ", aircraft_maintenance.acmaint_notes, aircraft_maintenance.acmaint_date_type "
            jetnet_sql = jetnet_sql & "FROM aircraft with (NOLOCK)"
            jetnet_sql = jetnet_sql & " INNER JOIN aircraft_model WITH(NOLOCK) ON aircraft.ac_amod_id = aircraft_model.amod_id "
            jetnet_sql = jetnet_sql & " INNER JOIN aircraft_maintenance WITH(NOLOCK) ON aircraft.ac_id = aircraft_maintenance.acmaint_ac_id "

            jetnet_sql = jetnet_sql & " WHERE (aircraft.ac_id = '" & r("cliaircraft_jetnet_ac_id") & "') and ac_journ_id = 0 "

            ''initialize sql connection
            JETNET_SqlConn2.ConnectionString = JETNET_DB
            JETNET_SqlConn2.Open()
            JETNET_SqlCommand2.Connection = JETNET_SqlConn2
            JETNET_SqlCommand2.CommandType = CommandType.Text
            JETNET_SqlCommand2.CommandTimeout = 60
            JETNET_SqlCommand2.CommandText = jetnet_sql
            JETNET_SqlReader2 = JETNET_SqlCommand2.ExecuteReader(CommandBehavior.CloseConnection)

            Try
              jetnet.Load(JETNET_SqlReader2)
            Catch constrExc As System.Data.ConstraintException
              Dim rowsErr As System.Data.DataRow() = jetnet.GetErrors()
            End Try

            If jetnet.Rows.Count > 0 Then
              string_hold = string_hold & "<td align='left' valign='top'>" & jetnet.Rows(0).Item("ac_ser_nbr") & "</td>"
              string_hold = string_hold & "<td align='left' valign='top'><a href='details.aspx?ac_ID=" & jetnet.Rows(0).Item("ac_id") & "&source=JETNET&type=3' target='new'>" & jetnet.Rows(0).Item("ac_id") & "</a></td>"
              string_hold = string_hold & "<td align='left' valign='top'>"

              For Each k As DataRow In jetnet.Rows

                If k.Item("ac_id") > 0 Then
                  exeQuery = "Insert Into Client_Aircraft_Maintenance ( "
                  exeQuery &= "cliacmaint_jetnet_ac_id, "
                  exeQuery &= "cliacmaint_cliac_id, "
                  exeQuery &= "cliacmaint_name, "
                  exeQuery &= "cliacmaint_complied_date, "
                  exeQuery &= "cliacmaint_complied_hrs, "
                  exeQuery &= "cliacmaint_due_date, "
                  exeQuery &= "cliacmaint_due_hrs, "
                  exeQuery &= "cliacmaint_notes, "
                  exeQuery &= "cliacmaint_date_type"
                  exeQuery &= ") VALUES ("
                  exeQuery &= " '" & k.Item("ac_id") & "', "
                  exeQuery &= " '" & r("cliaircraft_id") & "', "
                  exeQuery &= " '" & k.Item("acmaint_name") & "', "
                  If Not IsDBNull(k.Item("acmaint_complied_date")) Then
                    exeQuery &= " '" & Year(k.Item("acmaint_complied_date")) & "-" & Month(k.Item("acmaint_complied_date")) & "-" & Day(k.Item("acmaint_complied_date")) & "', "
                  Else
                    exeQuery &= " NULL, "
                  End If

                  exeQuery &= " '" & k.Item("acmaint_complied_hrs") & "', "

                  If Not IsDBNull(k.Item("acmaint_due_date")) Then
                    exeQuery &= " '" & Year(k.Item("acmaint_due_date")) & "-" & Month(k.Item("acmaint_due_date")) & "-" & Day(k.Item("acmaint_due_date")) & "', "
                  Else
                    exeQuery &= " NULL, "
                  End If

                  exeQuery &= " '" & k.Item("acmaint_due_hrs") & "', "
                  exeQuery &= " '" & k.Item("acmaint_notes") & "', "
                  exeQuery &= " '" & k.Item("acmaint_date_type") & "' "

                  exeQuery &= " )"



                  string_hold = string_hold & "<em>Maintenance Record Inserted</em><br />" & exeQuery & ""
                  MySqlConn.Close()

                  MySqlConn.ConnectionString = Me.client_DB
                  MySqlConn.Open()
                  MySqlCommand.Connection = MySqlConn
                  MySqlCommand.CommandType = CommandType.Text
                  MySqlCommand.CommandTimeout = 60

                  MySqlCommand.CommandText = exeQuery
                  MySqlCommand.ExecuteNonQuery()
                  counter = 1
                End If

              Next

              string_hold = string_hold & "</td>"

            Else

            End If
            string_hold = string_hold & "</tr>"

            JETNET_SqlReader2.Close()
            JETNET_SqlReader2 = Nothing

          Else

          End If

          If counter = 1 Then
            'display this
            query_string_return = query_string_return & string_hold
          End If

        Next
      End If
      query_string_return = query_string_return & "</table>"
      Return query_string_return
    Catch ex As Exception
      Create_Aircraft_Maintenance = ""
      Me.class_error = "Error in Consolidate_Aircraft_Fixes: " & ex.Message
    Finally
      client = Nothing
      jetnet = Nothing
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing

      'ExeConn.Dispose()
      'ExeConn.Close()
      'ExeConn = Nothing
      'ExeCommand.Dispose()
      'ExeCommand = Nothing

      JETNET_SqlConn2.Dispose()
      JETNET_SqlConn2.Close()
      JETNET_SqlConn2 = Nothing

      JETNET_SqlCommand2.Dispose()
      JETNET_SqlCommand2 = Nothing
    End Try
  End Function
  Public Function Consolidate_Aircraft_Fixes() As String
    'Client AC ID
    'Client(Make)
    'Client(Model)
    'Client(Serial#)
    'JETNET(Serial#)
    'JETNET AC ID
    'Action (if any)

    'For first pass on this it is ok if you just print out every update and I will review a few by hand.
    '1.	Get list of all client aircraft records
    '2.	If JETNET aircraft id > 0 then
    '2.1.	if JETNET aircraft does not exist in JETNET database then
    '2.1.1.	then set jetnet ac id on client record to 0 [and potentially run check #3 below]
    '2.2.	if JETNET aircraft exists in JETNET database then
    '2.2.1.	check serial number sort field – if not the same then set the client serial number sort equal to the JETNET serial number sort
    '2.2.2.	check serial number full field – if not the same then print out the id’s and differences in the serial numbers
    '3.	if JETNET aircraft id = 0 then
    '3.1.	check to see if we have an aircraft with the same model and serial number and if so put in a list with a link to fix.
    Dim client As New DataTable
    Dim client_sql As String = ""
    Dim query_string_return As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim string_hold As String = ""
    '''''''''''''''''''''''''''''''''''''''
    'execution query connection.
    Dim exeQuery As String = ""
    'Dim ExeConn As New MySql.Data.MySqlClient.MySqlConnection
    'Dim ExeCommand As New MySql.Data.MySqlClient.MySqlCommand
    'Dim ExeException As MySql.Data.MySqlClient.MySqlException : ExeException = Nothing
    'ExeConn.ConnectionString = Me.client_DB 'client DB
    'ExeConn.Open()
    'ExeCommand.Connection = MySqlConn
    'ExeCommand.CommandType = CommandType.Text
    'ExeCommand.CommandTimeout = 60
    ''''''''''''''''''''''''''''''''''''''''''''''''''''''''

    'jetnet connection
    Dim jetnet_sql As String = ""
    Dim counter As Integer = 0
    counter = 0
    Dim jetnet As New DataTable
    Dim JETNET_SqlConn2 As New SqlClient.SqlConnection
    Dim JETNET_SqlCommand2 As New SqlClient.SqlCommand
    Dim JETNET_SqlException2 As SqlClient.SqlException : JETNET_SqlException2 = Nothing
    Dim JETNET_SqlReader2 As SqlClient.SqlDataReader : JETNET_SqlReader2 = Nothing

    'initialize mysql connection
    MySqlConn.ConnectionString = Me.client_DB
    MySqlConn.Open()
    MySqlCommand.Connection = MySqlConn
    MySqlCommand.CommandType = CommandType.Text
    MySqlCommand.CommandTimeout = 60

    query_string_return = "<table width='100%' cellpadding='3' cellspacing='0' border='1' style='color:#ff0000;font-weight:normal;'>"
    query_string_return = query_string_return & "<tr><td align='left' valign='top' width='90'><u><b>Client AC ID</b></u></td>"
    query_string_return = query_string_return & "<td align='left' valign='top' width='120'><u><b>Client Make</b></u></td>"
    query_string_return = query_string_return & "<td align='left' valign='top' width='100'><u><b>Client Model</b></u></td>"
    query_string_return = query_string_return & "<td align='left' valign='top' width='120'><u><b>Client Serial#</b></u></td>"
    query_string_return = query_string_return & "<td align='left' valign='top' width='120'><u><b>Jetnet Serial#</b></u></td>"
    query_string_return = query_string_return & "<td align='left' valign='top' width='90'><u><b>Jetnet AC ID</b></u></td>"
    query_string_return = query_string_return & "<td align='left' valign='top'><u><b>Action</b></u></td></tr>"
    Try
      client_sql = "select cliaircraft_id, cliamod_make_name, cliamod_model_name, cliaircraft_ser_nbr, cliaircraft_ser_nbr_sort, cliamod_jetnet_amod_id, cliaircraft_jetnet_ac_id from client_aircraft inner join client_aircraft_model on cliaircraft_cliamod_id = cliamod_id order by cliaircraft_jetnet_ac_id desc "

      MySqlCommand.CommandText = client_sql
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      Try
        client.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = client.GetErrors()
      End Try
      If client.Rows.Count > 0 Then
        For Each r As DataRow In client.Rows
          jetnet = New DataTable
          counter = 0
          string_hold = ""
          'Start the first part of this table response.
          string_hold = string_hold & "<tr><td align='left' valign='top'><a href='details.aspx?ac_ID=" & r("cliaircraft_id") & "&source=CLIENT&type=3' target='new'>" & r("cliaircraft_id") & "</a></td>"
          string_hold = string_hold & "<td align='left' valign='top'>" & r("cliamod_make_name") & "</td>"
          string_hold = string_hold & "<td align='left' valign='top'>" & r("cliamod_model_name") & "</td>"
          string_hold = string_hold & "<td align='left' valign='top'>" & r("cliaircraft_ser_nbr") & "</td>"

          If r("cliaircraft_jetnet_ac_id") > 0 Then

            '2.	If JETNET aircraft id > 0 then
            '2.1.	if JETNET aircraft does not exist in JETNET database then
            '2.1.1.	then set jetnet ac id on client record to 0 [and potentially run check #3 below]
            '2.2.	if JETNET aircraft exists in JETNET database then
            '2.2.1.	check serial number sort field – if not the same then set the client serial number sort equal to the JETNET serial number sort
            '2.2.2.	check serial number full field – if not the same then print out the id’s and differences in the serial numbers

            jetnet_sql = ""
            jetnet_sql = "Select DISTINCT "
            jetnet_sql = jetnet_sql & "aircraft.ac_id, aircraft.ac_ser_no_sort, "
            jetnet_sql = jetnet_sql & " aircraft.ac_ser_no_full as ac_ser_nbr, aircraft.ac_reg_no as ac_reg_nbr, "
            jetnet_sql = jetnet_sql & " aircraft.ac_mfr_year as ac_year_mfr, "
            jetnet_sql = jetnet_sql & "aircraft_model.amod_make_name, aircraft_model.amod_model_name "
            jetnet_sql = jetnet_sql & "FROM aircraft with (NOLOCK) INNER JOIN "
            jetnet_sql = jetnet_sql & "aircraft_model WITH(NOLOCK) ON aircraft.ac_amod_id = aircraft_model.amod_id "
            jetnet_sql = jetnet_sql & " WHERE (aircraft.ac_id = '" & r("cliaircraft_jetnet_ac_id") & "') and ac_journ_id = 0 "

            ''initialize sql connection
            JETNET_SqlConn2.ConnectionString = JETNET_DB
            JETNET_SqlConn2.Open()
            JETNET_SqlCommand2.Connection = JETNET_SqlConn2
            JETNET_SqlCommand2.CommandType = CommandType.Text
            JETNET_SqlCommand2.CommandTimeout = 60
            JETNET_SqlCommand2.CommandText = jetnet_sql
            JETNET_SqlReader2 = JETNET_SqlCommand2.ExecuteReader(CommandBehavior.CloseConnection)

            Try
              jetnet.Load(JETNET_SqlReader2)
            Catch constrExc As System.Data.ConstraintException
              Dim rowsErr As System.Data.DataRow() = jetnet.GetErrors()
            End Try

            If jetnet.Rows.Count > 0 Then
              string_hold = string_hold & "<td align='left' valign='top'>" & jetnet.Rows(0).Item("ac_ser_nbr") & "</td>"
              string_hold = string_hold & "<td align='left' valign='top'><a href='details.aspx?ac_ID=" & jetnet.Rows(0).Item("ac_id") & "&source=JETNET&type=3' target='new'>" & jetnet.Rows(0).Item("ac_id") & "</a></td>"
              'ac_ser_no_sort = cliaircraft_ser_nbr_sort?
              '2.2.1.	check serial number sort field – if not the same then set the client serial number sort equal to the JETNET serial number sort
              If r("cliaircraft_ser_nbr_sort") <> jetnet.Rows(0).Item("ac_ser_no_sort") Then
                exeQuery = "update client_aircraft set cliaircraft_ser_nbr_sort = '" & jetnet.Rows(0).Item("ac_ser_no_sort") & "' where cliaircraft_id = '" & r("cliaircraft_id") & "' limit 1"
                string_hold = string_hold & "<td align='left' valign='top'><em>Serial # Sort Difference:</em><br />" & exeQuery & "</td>"
                MySqlConn.Close()

                MySqlConn.ConnectionString = Me.client_DB
                MySqlConn.Open()
                MySqlCommand.Connection = MySqlConn
                MySqlCommand.CommandType = CommandType.Text
                MySqlCommand.CommandTimeout = 60

                MySqlCommand.CommandText = exeQuery
                MySqlCommand.ExecuteNonQuery()
                counter = 1
              End If

              '2.2.2.	check serial number full field – if not the same then print out the id’s and differences in the serial numbers
              If r("cliaircraft_ser_nbr") <> jetnet.Rows(0).Item("ac_ser_nbr") Then
                string_hold = string_hold & "<td align='left' valign='top'><em>Serial # Difference</em></td>"
                counter = 1
              End If

            Else
              counter = 1
              string_hold = string_hold & "<td align='left' valign='top'>-</td>"
              string_hold = string_hold & "<td align='left' valign='top'>" & r("cliaircraft_jetnet_ac_id") & "</td>"
              ''2.1.	if JETNET aircraft does not exist in JETNET database then
              '2.1.1.	then set jetnet ac id on client record to 0 [and potentially run check #3 below]
              exeQuery = "Update client_aircraft set cliaircraft_jetnet_ac_id = 0 where cliaircraft_id = '" & r("cliaircraft_id") & "' limit 1"
              string_hold = string_hold & "<td align='left' valign='top'><em>Jetnet ID does not exist:</em><br />" & exeQuery & "</td>"

              MySqlConn.Close()

              MySqlConn.ConnectionString = Me.client_DB
              MySqlConn.Open()
              MySqlCommand.Connection = MySqlConn
              MySqlCommand.CommandType = CommandType.Text
              MySqlCommand.CommandTimeout = 60

              MySqlCommand.CommandText = exeQuery
              MySqlCommand.ExecuteNonQuery()
            End If
            string_hold = string_hold & "</tr>"

          Else
            '3.1.	check to see if we have an aircraft with the same model and serial number and if so put in a list with a link to fix.
            jetnet_sql = ""
            jetnet_sql = "Select DISTINCT "
            jetnet_sql = jetnet_sql & "aircraft.ac_id, "
            jetnet_sql = jetnet_sql & " aircraft.ac_ser_no as ac_ser_nbr, aircraft.ac_reg_no as ac_reg_nbr, "
            jetnet_sql = jetnet_sql & " aircraft.ac_mfr_year as ac_year_mfr, "
            jetnet_sql = jetnet_sql & "aircraft_model.amod_make_name, aircraft_model.amod_model_name "
            jetnet_sql = jetnet_sql & "FROM aircraft with (NOLOCK) INNER JOIN "
            jetnet_sql = jetnet_sql & "aircraft_model WITH(NOLOCK) ON aircraft.ac_amod_id = aircraft_model.amod_id "
            jetnet_sql = jetnet_sql & " WHERE (aircraft.ac_ser_no_full = '" & r("cliaircraft_ser_nbr") & "') and amod_id = " & r("cliamod_jetnet_amod_id") & " and ac_journ_id = 0 "

            ''initialize sql connection
            JETNET_SqlConn2.ConnectionString = JETNET_DB
            JETNET_SqlConn2.Open()
            JETNET_SqlCommand2.Connection = JETNET_SqlConn2
            JETNET_SqlCommand2.CommandType = CommandType.Text
            JETNET_SqlCommand2.CommandTimeout = 60
            JETNET_SqlCommand2.CommandText = jetnet_sql
            JETNET_SqlReader2 = JETNET_SqlCommand2.ExecuteReader(CommandBehavior.CloseConnection)

            Try
              jetnet.Load(JETNET_SqlReader2)
            Catch constrExc As System.Data.ConstraintException
              Dim rowsErr As System.Data.DataRow() = jetnet.GetErrors()
            End Try

            If jetnet.Rows.Count > 0 Then
              string_hold = string_hold & "<td align='left' valign='top'>" & jetnet.Rows(0).Item("ac_ser_nbr") & "</td>"
              string_hold = string_hold & "<td align='left' valign='top'><a href='details.aspx?ac_ID=" & jetnet.Rows(0).Item("ac_id") & "&source=JETNET&type=3' target='new'>" & jetnet.Rows(0).Item("ac_id") & "</a></td>"
              string_hold = string_hold & "<td align='left' valign='top'><a href='crmAdministration_Worker.aspx?jetnet_ID=" & jetnet.Rows(0).Item("ac_id") & "&client_ID=" & r("cliaircraft_id") & "&update_orphan=true' target='new'>Link Aircraft if you think they Match</a></td>"
              counter = 1
            End If
            string_hold = string_hold & "</tr>"
          End If

          If counter = 1 Then
            'display this
            query_string_return = query_string_return & string_hold
          End If
          JETNET_SqlReader2.Close()
          JETNET_SqlReader2 = Nothing
        Next
      End If
      query_string_return = query_string_return & "</table>"
      Return query_string_return
    Catch ex As Exception
      Consolidate_Aircraft_Fixes = ""
      Me.class_error = "Error in Consolidate_Aircraft_Fixes: " & ex.Message
    Finally
      client = Nothing
      jetnet = Nothing
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing

      'ExeConn.Dispose()
      'ExeConn.Close()
      'ExeConn = Nothing
      'ExeCommand.Dispose()
      'ExeCommand = Nothing

      JETNET_SqlConn2.Dispose()
      JETNET_SqlConn2.Close()
      JETNET_SqlConn2 = Nothing

      JETNET_SqlCommand2.Dispose()
      JETNET_SqlCommand2 = Nothing
    End Try
  End Function
  ''' <summary>
  ''' fixes the jetnet ac id on a client aircraft record if a button is clicked.
  ''' </summary>
  ''' <param name="jetnet_ID"></param>
  ''' <param name="client_ID"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function FIX_Potential_Orphaned_Client_Aircraft_Records(ByVal jetnet_ID As Integer, ByVal client_ID As Integer) As String
    Dim query_string_return As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing

    Try
      Dim client_sql As String = ""
      client_sql = " update client_aircraft set cliaircraft_jetnet_ac_id = " & jetnet_ID & " where cliaircraft_id = " & client_ID & " limit 1 " 'This is a query for aircraft that could potentially be orphaned

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = client_sql
      MySqlCommand.ExecuteNonQuery()
      Return client_sql
    Catch ex As Exception
      FIX_Potential_Orphaned_Client_Aircraft_Records = ""
      Me.class_error = "Error in FIX_Potential_Orphaned_Client_Aircraft_Records: " & ex.Message
    Finally
      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function

  ''' <summary>
  ''' The purpose of this function
  ''' 'Is to:
  ''' 1.) Find all of the client aircraft that have a jetnet ac ID of 0. 
  ''' 2.) Then go through each one and search for a potential match on the jetnet side. 
  ''' </summary>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Identify_Potential_Orphaned_Client_Aircraft_Records() As String
    Dim query_string_return As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlReader2 As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader2 = Nothing
    'jetnet connection
    Dim JETNET_SqlConn2 As New SqlClient.SqlConnection
    Dim JETNET_SqlCommand2 As New SqlClient.SqlCommand
    Dim JETNET_SqlException2 As SqlClient.SqlException : JETNET_SqlException2 = Nothing
    Dim JETNET_SqlReader2 As SqlClient.SqlDataReader : JETNET_SqlReader2 = Nothing
    Dim client As New DataTable
    Dim counter As Integer = 0
    Dim jetnet_sql As String = ""
    Dim jetnet As New DataTable

    JETNET_SqlConn2.ConnectionString = JETNET_DB
    JETNET_SqlConn2.Open()
    JETNET_SqlCommand2.Connection = JETNET_SqlConn2
    JETNET_SqlCommand2.CommandType = CommandType.Text
    JETNET_SqlCommand2.CommandTimeout = 60

    MySqlConn.ConnectionString = Me.client_DB
    MySqlConn.Open()
    MySqlCommand.Connection = MySqlConn
    MySqlCommand.CommandType = CommandType.Text
    MySqlCommand.CommandTimeout = 60
    Try
      Dim client_sql As String = ""
      client_sql = "select * from client_aircraft inner join client_aircraft_model on cliamod_id = cliaircraft_cliamod_id where cliaircraft_jetnet_ac_id = 0 " 'This is a query for aircraft that could potentially be orphaned

      MySqlCommand.CommandText = client_sql
      MySqlReader = MySqlCommand.ExecuteReader()
      Try
        client.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = client.GetErrors()
      End Try
      query_string_return = "<table width='100%' cellpadding='3' cellspacing='0'><tr><td align='left' valign='top'>Client Aircraft ID</td><td align='left' valign='top'>Jetnet Aircraft Model ID</td><td align='left' valign='top'>Client Aircraft Serial #</td><td align='left' valign='top'>Potential Match (jetnet AC ID)</td><td align='left' valign='top'>Link Match Up?</td></tr>"
      If client.Rows.Count > 0 Then
        For Each r As DataRow In client.Rows
          jetnet = New DataTable
          jetnet_sql = ""

          'these means there are rows for this.
          query_string_return = query_string_return & "<tr><td align='left' valign='top'><a href='details.aspx?ac_ID=" & r("cliaircraft_id") & "&type=3&source=CLIENT' target='new'>" & r("cliaircraft_id") & "</a></td><td align='left' valign='top'>" & r("cliamod_jetnet_amod_id") & "</td><td align='left' valign='top'>" & r("cliaircraft_ser_nbr") & "</td><td align='left' valign='top'>"

          jetnet_sql = "Select DISTINCT "
          jetnet_sql = jetnet_sql & "aircraft.ac_id, "
          jetnet_sql = jetnet_sql & " aircraft.ac_ser_no as ac_ser_nbr, aircraft.ac_reg_no as ac_reg_nbr, "
          jetnet_sql = jetnet_sql & " aircraft.ac_mfr_year as ac_year_mfr, "
          jetnet_sql = jetnet_sql & "aircraft_model.amod_make_name, aircraft_model.amod_model_name "
          jetnet_sql = jetnet_sql & "FROM aircraft with (NOLOCK) INNER JOIN "
          jetnet_sql = jetnet_sql & "aircraft_model WITH(NOLOCK) ON aircraft.ac_amod_id = aircraft_model.amod_id "
          jetnet_sql = jetnet_sql & " WHERE (aircraft.ac_ser_no = '" & r("cliaircraft_ser_nbr") & "') and amod_id = " & r("cliamod_jetnet_amod_id") & " and ac_journ_id = 0 "

          JETNET_SqlCommand2.CommandText = jetnet_sql
          JETNET_SqlReader2 = JETNET_SqlCommand2.ExecuteReader()
          Try
            jetnet.Load(JETNET_SqlReader2)
          Catch constrExc As System.Data.ConstraintException
            Dim rowsErr As System.Data.DataRow() = jetnet.GetErrors()
          End Try

          If jetnet.Rows.Count > 0 Then
            query_string_return = query_string_return & "<a href='details.aspx?ac_ID=" & jetnet.Rows(0).Item("ac_id") & "&type=3&source=JETNET' target='new'>" & jetnet.Rows(0).Item("ac_id") & "</a></td><td align='left' valign='top'><a href='crmAdministration_Worker.aspx?jetnet_ID=" & jetnet.Rows(0).Item("ac_id") & "&client_ID=" & r("cliaircraft_id") & "&update_orphan=true' target='new'>Create Link</a></td>"
          Else
            query_string_return = query_string_return & "-" & "</td><td align='left' valign='top'>-"
          End If
        Next
      End If
      query_string_return = query_string_return & "</td></tr></table>"
      Return query_string_return
    Catch ex As Exception
      Identify_Potential_Orphaned_Client_Aircraft_Records = ""
      Me.class_error = "Error in Identify_Potential_Orphaned_Client_Aircraft_Records: " & ex.Message
    Finally
      client = Nothing
      jetnet = Nothing
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
      MySqlReader2 = Nothing

      JETNET_SqlConn2.Dispose()
      JETNET_SqlConn2.Close()
      JETNET_SqlConn2 = Nothing

      JETNET_SqlCommand2.Dispose()
      JETNET_SqlCommand2 = Nothing
    End Try
  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Fix_Client_Notes_Models()
  ' Purpose: Fix client notes that do not store the model ID
  ' Parameters: none, Fix client notes that do not store the model ID
  ' Return: 
  '       integer
  ' Change Log
  '           7/12/2011    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Fix_Client_Notes_Models() As String

    Dim query_string_return As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlReader2 As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader2 = Nothing

    Dim client As New DataTable
    Dim client2 As New DataTable

    MySqlConn.ConnectionString = Me.client_DB
    Dim counter As Integer = 0
    MySqlConn.Open()
    MySqlCommand.Connection = MySqlConn
    MySqlCommand.CommandType = CommandType.Text
    MySqlCommand.CommandTimeout = 60

    'jetnet connection
    Dim JETNET_SqlConn2 As New SqlClient.SqlConnection
    Dim JETNET_SqlCommand2 As New SqlClient.SqlCommand
    Dim JETNET_SqlException2 As SqlClient.SqlException : JETNET_SqlException2 = Nothing
    Dim JETNET_SqlReader2 As SqlClient.SqlDataReader : JETNET_SqlReader2 = Nothing

    Dim jetnet As New DataTable
    JETNET_SqlConn2.ConnectionString = JETNET_DB

    JETNET_SqlConn2.Open()
    JETNET_SqlCommand2.Connection = JETNET_SqlConn2
    JETNET_SqlCommand2.CommandType = CommandType.Text
    JETNET_SqlCommand2.CommandTimeout = 60
    Try
      Dim sQuery As String = "select lnote_id, lnote_jetnet_ac_id, lnote_client_ac_id from local_notes where (lnote_client_ac_id <> 0 or lnote_jetnet_ac_id <> 0) and (lnote_client_amod_id = 0 or lnote_jetnet_amod_id = 0) "

      query_string_return = query_string_return & "'----------------------------------------------------<br />"
      query_string_return = query_string_return & "'-- SELECT NOTES WHERE THE MODEL ID ISN'T FILLED IN <br />"
      query_string_return = query_string_return & "'-- ACTION: LOOKUP EITHER THE JETNET MODEL ID OR THE CLIENT MODEL ID<br />"
      query_string_return = query_string_return & sQuery & "<br /><br />"
      query_string_return = query_string_return & "'----------------------------------------------------<br /><br />"

      MySqlCommand.CommandText = sQuery
      MySqlReader = MySqlCommand.ExecuteReader()
      Try
        client.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = client.GetErrors()
      End Try

      If client.Rows.Count > 0 Then
        For Each r As DataRow In client.Rows

          If r("lnote_jetnet_ac_id") <> 0 Then
            Dim jetnet_query As String = "select ac_amod_id from aircraft with (NOLOCK) where ac_id = '" & r("lnote_jetnet_ac_id") & "' and ac_journ_id = 0"
            jetnet = New DataTable
            JETNET_SqlCommand2.CommandText = jetnet_query
            JETNET_SqlReader2 = JETNET_SqlCommand2.ExecuteReader()
            Try
              jetnet.Load(JETNET_SqlReader2)
            Catch constrExc As System.Data.ConstraintException
              Dim rowsErr As System.Data.DataRow() = jetnet.GetErrors()
            End Try

            If jetnet.Rows.Count > 0 Then
              Dim jetnet_model As Integer = jetnet.Rows(0).Item("ac_amod_id")
              Dim client_model As Integer = 0
              'search for the client aircraft model.
              Dim client_query As String = "select cliamod_id from client_aircraft_model where cliamod_jetnet_amod_id = " & jetnet_model
              client2 = New DataTable
              MySqlReader2 = Nothing
              MySqlCommand.CommandText = client_query
              MySqlReader2 = MySqlCommand.ExecuteReader()
              Try
                client2.Load(MySqlReader2)
              Catch constrExc As System.Data.ConstraintException
                Dim rowsErr As System.Data.DataRow() = client2.GetErrors()
              End Try

              If client2.Rows.Count > 0 Then
                client_model = client2.Rows(0).Item("cliamod_id")
              End If

              Dim update_string = "update local_notes set lnote_jetnet_amod_id = '" & jetnet_model & "', lnote_client_amod_id = '" & client_model & "' where lnote_id = '" & r("lnote_id") & "' limit 1"
              MySqlCommand.CommandText = update_string
              MySqlCommand.ExecuteNonQuery()
              counter = counter + 1
              query_string_return = query_string_return & "'----------------------------------------------------<br />"
              query_string_return = query_string_return & update_string & "<br /><br />"
              query_string_return = query_string_return & "'----------------------------------------------------<br />"

            End If
            MySqlReader2.Close()
            'Get the 
          ElseIf r("lnote_client_ac_id") <> 0 Then
            Dim client_query As String = "select cliaircraft_cliamod_id as ac_amod_id, cliamod_jetnet_amod_id from client_aircraft inner join client_aircraft_model on cliaircraft_cliamod_id = cliamod_id where cliaircraft_id = '" & r("lnote_client_ac_id") & "' limit 1"
            client2 = New DataTable
            MySqlCommand.CommandText = client_query
            MySqlReader2 = MySqlCommand.ExecuteReader()
            Try
              client2.Load(MySqlReader2)
            Catch constrExc As System.Data.ConstraintException
              Dim rowsErr As System.Data.DataRow() = client2.GetErrors()
            End Try

            If client2.Rows.Count > 0 Then
              Dim client_model = client2.Rows(0).Item("ac_amod_id")
              Dim jetnet_model = client2.Rows(0).Item("cliamod_jetnet_amod_id")

              Dim update_string = "update local_notes set lnote_client_amod_id = '" & client2.Rows(0).Item("ac_amod_id") & "', lnote_jetnet_amod_id = '" & jetnet_model & "' where lnote_id = '" & r("lnote_id") & "' limit 1"
              MySqlCommand.CommandText = update_string
              MySqlCommand.ExecuteNonQuery()
              counter = counter + 1
              query_string_return = query_string_return & "'----------------------------------------------------<br />"
              query_string_return = query_string_return & update_string & "<br /><br />"
              query_string_return = query_string_return & "'----------------------------------------------------<br />"


            End If
            MySqlReader2.Close()
          End If


        Next
      End If


      Fix_Client_Notes_Models = "<p align='center' class='attention'>" & counter & " Notes have been fixed.</p>" & query_string_return
    Catch ex As Exception
      Fix_Client_Notes_Models = ""
      Me.class_error = "Error in Fix_Client_Notes_Models: " & ex.Message
    Finally
      client2 = Nothing
      client = Nothing
      jetnet = Nothing
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
      MySqlReader2 = Nothing

      JETNET_SqlConn2.Dispose()
      JETNET_SqlConn2.Close()
      JETNET_SqlConn2 = Nothing

      JETNET_SqlCommand2.Dispose()
      JETNET_SqlCommand2 = Nothing

    End Try
  End Function

  Public Function List_Bad_Client_AC_Matches() As String
    Dim counter As Integer = 0
    Dim query_string_return As String = ""
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlReader2 As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader2 = Nothing

    Dim client As New DataTable
    Dim updates_string As String = ""
    MySqlConn.ConnectionString = Me.client_DB
    MySqlConn.Open()
    MySqlCommand.Connection = MySqlConn
    MySqlCommand.CommandType = CommandType.Text
    MySqlCommand.CommandTimeout = 60

    'jetnet connection
    Dim JETNET_SqlConn2 As New SqlClient.SqlConnection
    Dim JETNET_SqlCommand2 As New SqlClient.SqlCommand
    Dim JETNET_SqlException2 As SqlClient.SqlException : JETNET_SqlException2 = Nothing
    Dim JETNET_SqlReader2 As SqlClient.SqlDataReader : JETNET_SqlReader2 = Nothing

    Dim jetnet As New DataTable
    JETNET_SqlConn2.ConnectionString = JETNET_DB

    JETNET_SqlConn2.Open()
    JETNET_SqlCommand2.Connection = JETNET_SqlConn2
    JETNET_SqlCommand2.CommandType = CommandType.Text
    JETNET_SqlCommand2.CommandTimeout = 60
    Try
      Dim query As String = ""
      query = "select cliaircraft_id, cliaircraft_jetnet_ac_id, cliaircraft_ser_nbr from client_aircraft where cliaircraft_jetnet_ac_id <> 0 "

      MySqlCommand.CommandText = query
      MySqlReader = MySqlCommand.ExecuteReader()
      Try
        client.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = client.GetErrors()
      End Try
      query_string_return = "<table border='0' cellpadding='3' cellspacing='0'>"
      query_string_return = query_string_return & "<tr><td align='left' valign='top'></td><td align='left' valign='top' width='90'><u>Client ID#</u></td><td align='left' valign='top' width='90'><u>Jetnet ID#</u></td><td align='left' valign='top' width='90'><u>Client Serial#</u></td><td align='left' valign='top' width='90'><u>Jetnet Serial#</u></td></tr>"
      For Each r As DataRow In client.Rows
        counter = counter + 1
        'This is where I poll the database for a difference
        Dim jetnet_query As String = ""
        jetnet = New DataTable
        jetnet_query = "Select ac_id, ac_ser_no_full from aircraft with (NOLOCK) where ac_journ_id = 0 and ac_id = " & r("cliaircraft_jetnet_ac_id")

        JETNET_SqlCommand2.CommandText = jetnet_query
        JETNET_SqlReader2 = JETNET_SqlCommand2.ExecuteReader()
        Try
          jetnet.Load(JETNET_SqlReader2)
        Catch constrExc As System.Data.ConstraintException
          Dim rowsErr As System.Data.DataRow() = jetnet.GetErrors()
        End Try

        If jetnet.Rows.Count > 0 Then
          If jetnet.Rows(0).Item("ac_ser_no_full") <> r("cliaircraft_ser_nbr") Then
            'updates_string = updates_string & "update client_aircraft set cliaircraft_jetnet_ac_id = 0 where cliaircraft_id = " & r("cliaircraft_id") & " limit 1<br />"
            query_string_return = query_string_return & "<tr><td align='left' valign='top'>" & counter & ".)</td><td align='left' valign='top'>" & r("cliaircraft_id") & "</td><td align='left' valign='top'>" & jetnet.Rows(0).Item("ac_id") & "</td><td align='left' valign='top'>" & r("cliaircraft_ser_nbr") & "</td><td align='left' valign='top'>" & jetnet.Rows(0).Item("ac_ser_no_full") & "</td></tr>"
          End If
        ElseIf jetnet.Rows.Count = 0 Then
          updates_string = updates_string & "update client_aircraft set cliaircraft_jetnet_ac_id = 0 where cliaircraft_id = " & r("cliaircraft_id") & " limit 1<br />"
        End If

      Next
      query_string_return = query_string_return & "</table><h2>Update Statements (to be ran)</h2>" & updates_string
      updates_string = ""
      Return query_string_return
    Catch ex As Exception
      List_Bad_Client_AC_Matches = ""
      Me.class_error = "Error in Fix_Client_Notes_Models: " & ex.Message
    Finally

      client = Nothing
      jetnet = Nothing
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
      MySqlReader2 = Nothing

      JETNET_SqlConn2.Dispose()
      JETNET_SqlConn2.Close()
      JETNET_SqlConn2 = Nothing

      JETNET_SqlCommand2.Dispose()
      JETNET_SqlCommand2 = Nothing

    End Try
  End Function


  Public Function Synchronize_Jetnet_Feature_Codes() As String


    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim client As New DataTable
    Dim client_2 As New DataTable


    Dim JETNET_SqlConn2 As New SqlClient.SqlConnection
    Dim JETNET_SqlCommand2 As New SqlClient.SqlCommand
    Dim JETNET_SqlException2 As SqlClient.SqlException : JETNET_SqlException2 = Nothing
    Dim JETNET_SqlReader2 As SqlClient.SqlDataReader : JETNET_SqlReader2 = Nothing

    Dim counterc As Integer = 0
    Dim counteri As Integer = 0
    Dim counteru As Integer = 0
    Dim query_string_return As String = ""
    Dim sQuery As String = ""
    Dim jetnet As New DataTable
    Dim jetnet_query As String = ""
    Dim insert_update_string As String = ""
    Dim action_date As String = Year(DateTime.Now) & "-" & Month(DateTime.Now) & "-" & Day(DateTime.Now) & " " & Hour(DateTime.Now) & ":" & Minute(DateTime.Now) & ":" & Second(DateTime.Now)
    Dim temp_desc As String = ""

    Try


      MySqlConn.ConnectionString = Me.client_DB

      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      ' JETNET_SqlConn2.ConnectionString = Me.ref_DB
      JETNET_SqlConn2.ConnectionString = JETNET_DB


      JETNET_SqlConn2.Open()
      JETNET_SqlCommand2.Connection = JETNET_SqlConn2
      JETNET_SqlCommand2.CommandType = CommandType.Text
      JETNET_SqlCommand2.CommandTimeout = 60


      jetnet_query = "select * from Key_Feature with (NOLOCK) "
      jetnet = New DataTable
      JETNET_SqlCommand2.CommandText = jetnet_query
      JETNET_SqlReader2 = JETNET_SqlCommand2.ExecuteReader()
      Try
        jetnet.Load(JETNET_SqlReader2)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = jetnet.GetErrors()
      End Try




      If jetnet.Rows.Count > 0 Then
        For Each r As DataRow In jetnet.Rows

          insert_update_string = ""

          temp_desc = ""
          If Not IsDBNull(r("kfeat_description")) Then
            temp_desc = r("kfeat_description")
          End If


          If Not IsDBNull(r("kfeat_code")) Then

            sQuery = " select * from client_key_features where clikfeat_type = '" & r("kfeat_code") & "' "
            MySqlCommand.CommandText = sQuery
            MySqlReader = MySqlCommand.ExecuteReader()
            Try
              client.Rows.Clear()
              client.Load(MySqlReader)
            Catch constrExc As System.Data.ConstraintException
              Dim rowsErr As System.Data.DataRow() = client.GetErrors()
            End Try

            If client.Rows.Count > 0 Then
              For Each s As DataRow In client.Rows


                If Not IsDBNull(r("kfeat_inactive_date")) Then
                  ' if its active, or client, then change to be jetnet 
                  If Trim(s("clikfeat_active_flag")) = "Y" Or Trim(s("clikfeat_source")) = "CLIENT" Then
                    ' UPDATE THE CLIENT RECORD ACTIVE FLAG = N 
                    insert_update_string = "Update client_key_features set clikfeat_active_flag = 'N', clikfeat_source = 'JETNET', clikfeat_description = '" & Replace(Trim(temp_desc), "'", "''") & "', clikfeat_action_date = '" & action_date & "' where clikfeat_type = '" & r("kfeat_code") & "' LIMIT 1"
                    counteru = counteru + 1
                  End If
                Else
                  If Trim(s("clikfeat_active_flag")) = "N" Or Trim(s("clikfeat_source")) = "CLIENT" Then
                    insert_update_string = "Update client_key_features set clikfeat_active_flag = 'Y', clikfeat_source = 'JETNET', clikfeat_description = '" & Replace(Trim(temp_desc), "'", "''") & "', clikfeat_action_date = '" & action_date & "' where clikfeat_type = '" & r("kfeat_code") & "' LIMIT 1"
                    counteru = counteru + 1
                  End If
                End If


              Next
            Else
              If Not IsDBNull(r("kfeat_inactive_date")) Then
                '  DO NOT INSERT AN ALREADY INACTIVE FEATURE CODE
                insert_update_string = ""
              Else
                ' INSERT INTO DB, NEW JETNET FEATURE CODE, ACTIVE = Y
                insert_update_string = "Insert into client_key_features (clikfeat_type, clikfeat_name, clikfeat_description, clikfeat_active_flag, clikfeat_source, clikfeat_action_date)"
                insert_update_string &= " VALUES ("
                insert_update_string &= "'" & r("kfeat_code") & "','" & r("kfeat_name") & "', '" & Replace(Trim(temp_desc), "'", "''") & "',  'Y','JETNET', '" & action_date & "' "
                insert_update_string &= ") "
                counteri = counteri + 1
              End If
            End If


            If Trim(insert_update_string) <> "" Then
              MySqlCommand.CommandText = insert_update_string
              MySqlCommand.ExecuteNonQuery()
            End If


          End If


        Next
      End If


      '-----------------------------------------------------------------------------
      ' INSERT INTO CUSTOM EXPORT FIELD FOR ALL CLIENT
      insert_update_string = ""

      sQuery = " select * from client_key_features where clikfeat_source = 'CLIENT' and clikfeat_active_flag = 'Y' "
      MySqlCommand.CommandText = sQuery
      MySqlReader = MySqlCommand.ExecuteReader()
      Try
        client.Rows.Clear()
        client.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = client.GetErrors()
      End Try

      If client.Rows.Count > 0 Then
        For Each s As DataRow In client.Rows

          sQuery = " select * from client_custom_export where clicexp_type = 'Feature Code' and clicexp_display = 'Feature " & s("clikfeat_type") & "' "
          MySqlCommand.CommandText = sQuery
          MySqlReader = MySqlCommand.ExecuteReader()
          Try
            client_2.Rows.Clear()
            client_2.Load(MySqlReader)
          Catch constrExc As System.Data.ConstraintException
            Dim rowsErr As System.Data.DataRow() = client.GetErrors()
          End Try

          If client_2.Rows.Count = 0 Then
            insert_update_string = "Insert into client_custom_export (clicexp_type, clicexp_display, clicexp_client_db_name, clicexp_jetnet_db_name, clicexp_sort, clicexp_aerodex_flag) "
            insert_update_string &= " VALUES ( "
            insert_update_string &= "'Feature Code', "
            insert_update_string &= "'Feature " & s("clikfeat_type") & "', "
            insert_update_string &= "'(select distinct cliafeat_flag from client_aircraft_key_features where cliafeat_cliac_id=cliaircraft_id and cliafeat_type=''" & s("clikfeat_type") & "'') as " & s("clikfeat_type") & "', "
            insert_update_string &= "''''' as " & s("clikfeat_type") & "', "
            insert_update_string &= "'100', "
            insert_update_string &= "'Y' "
            insert_update_string &= " ) "

            MySqlCommand.CommandText = insert_update_string
            MySqlCommand.ExecuteNonQuery()
            counterc = counterc + 1
          End If


        Next
      End If
      '-----------------------------------------------------------------------------






      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
      JETNET_SqlReader2 = Nothing



      JETNET_SqlCommand2.Dispose()
      JETNET_SqlCommand2 = Nothing

      query_string_return = ""
      query_string_return = "<br>Records Inserted: " & counteri
      query_string_return &= "<br>Records Updated: " & counteru
      query_string_return &= "<br>Custom Export Records Created: " & counterc

      Synchronize_Jetnet_Feature_Codes = query_string_return
    Catch ex As Exception
      Synchronize_Jetnet_Feature_Codes = "ERROR"
      Me.class_error = "Error in Synchronize_Jetnet_Feature_Codes(): " & ex.Message
    Finally

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      JETNET_SqlConn2.Dispose()
      JETNET_SqlConn2.Close()
      JETNET_SqlConn2 = Nothing
    End Try


  End Function


  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Fix_Client_Transaction_Categories
  ' Purpose: Fix_Client transactions with jetnet transaction cat codes
  ' Parameters: none, Fix all client transactions so the transaction category codes/retail flags are set.
  ' Return: 
  '       string
  ' Change Log
  '           5/6/2015    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Fix_Client_Transaction_Categories() As String
    'Declaring Client Connection Variables
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim client As New DataTable
    Dim ClientQuery As String = ""
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand()

    'Declaring Jetnet Variables
    Dim jetnet As New DataTable

    Try
      Dim counter As Integer = 0
      Dim query_string_return As String = ""

      'Setting ClientQuery
      ClientQuery = "SELECT * FROM client_transactions WHERE clitrans_jetnet_trans_id > 0 and (clitrans_subcategory_code='' or clitrans_subcategory_code is NULL) "

      'Opening Client Connection/Running Connection
      MySqlCommand = New MySql.Data.MySqlClient.MySqlCommand(ClientQuery, MySqlConn)
      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlReader = MySqlCommand.ExecuteReader()

      Try
        client.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = client.GetErrors()
      End Try

      query_string_return += "'----------------------------------------------------<br />"
      query_string_return += "'-- SELECT TRANSACTION WHERE JETNET TRANSACTION ID IS GREATER THAN 0 <br />"
      query_string_return += "'-- ACTION: GET THE CORRESPONDING JETNET RECORD AND UPDATE THE CLIENT RECORD CATEGORY CODES<br />"
      query_string_return += ClientQuery & "<br /><br />"
      query_string_return += "'----------------------------------------------------<br /><br />"
      query_string_return += "'--TRANSACTION IDS FIXED:<br />"

      If client.Rows.Count > 0 Then
        For Each r As DataRow In client.Rows

          If r("clitrans_jetnet_trans_id") > 0 Then

            'query_string_return += r("clitrans_jetnet_trans_id").ToString & "<br />"
            jetnet = Get_JETNET_Transactions_transID(r("clitrans_jetnet_trans_id"))

            If Not IsNothing(jetnet) Then
              If jetnet.Rows.Count > 0 Then
                Dim update_string As String = ""
                Dim value_string As String = ""
                Dim DisplayableUpdateString As String = ""
                Dim clitrans_subcategory_code As String = ""
                Dim clitrans_subcat_code_part1 As String = ""
                Dim clitrans_subcat_code_part2 As String = ""
                Dim clitrans_subcat_code_part3 As String = ""
                Dim clitrans_retail_flag As String = "N"

                If Not IsDBNull(jetnet.Rows(0).Item("journ_subcategory_code")) Then
                  clitrans_subcategory_code = jetnet.Rows(0).Item("journ_subcategory_code")
                End If
                If Not IsDBNull(jetnet.Rows(0).Item("journ_subcat_code_part1")) Then
                  clitrans_subcat_code_part1 = jetnet.Rows(0).Item("journ_subcat_code_part1")
                End If
                If Not IsDBNull(jetnet.Rows(0).Item("journ_subcat_code_part2")) Then
                  clitrans_subcat_code_part2 = jetnet.Rows(0).Item("journ_subcat_code_part2")
                End If
                If Not IsDBNull(jetnet.Rows(0).Item("journ_subcat_code_part3")) Then
                  clitrans_subcat_code_part3 = jetnet.Rows(0).Item("journ_subcat_code_part3")
                  clitrans_retail_flag = clsGeneral.clsGeneral.TransSetRetailFlag((jetnet.Rows(0).Item("journ_subcat_code_part3")))
                End If

                'starting update string
                update_string = "update client_transactions set "
                'building value clause
                If Not String.IsNullOrEmpty(clitrans_subcategory_code) Then
                  value_string = " clitrans_subcategory_code = @clitrans_subcategory_code "
                End If
                If Not String.IsNullOrEmpty(clitrans_subcat_code_part1) Then
                  If value_string <> "" Then
                    value_string += ","
                  End If
                  value_string += " clitrans_subcat_code_part1 = @clitrans_subcat_code_part1 "
                End If
                If Not String.IsNullOrEmpty(clitrans_subcat_code_part2) Then
                  If value_string <> "" Then
                    value_string += ","
                  End If
                  value_string += " clitrans_subcat_code_part2 = @clitrans_subcat_code_part2 "
                End If
                If Not String.IsNullOrEmpty(clitrans_subcat_code_part3) Then
                  If value_string <> "" Then
                    value_string += ","
                  End If
                  value_string += " clitrans_subcat_code_part3 = @clitrans_subcat_code_part3 "
                End If

                If Not String.IsNullOrEmpty(clitrans_retail_flag) Then
                  If value_string <> "" Then
                    value_string += ","
                  End If
                  value_string += " clitrans_retail_flag = @clitrans_retail_flag "
                End If


                update_string += value_string
                update_string += " where clitrans_id = @clitrans_id and clitrans_jetnet_trans_id = @clitrans_jetnet_trans_id limit 1"

                DisplayableUpdateString = update_string

                DisplayableUpdateString = Replace(DisplayableUpdateString, "@clitrans_subcategory_code", "'" & clitrans_subcategory_code & "'")
                DisplayableUpdateString = Replace(DisplayableUpdateString, "@clitrans_subcat_code_part1", "'" & clitrans_subcat_code_part1 & "'")
                DisplayableUpdateString = Replace(DisplayableUpdateString, "@clitrans_subcat_code_part2", "'" & clitrans_subcat_code_part2 & "'")
                DisplayableUpdateString = Replace(DisplayableUpdateString, "@clitrans_subcat_code_part3", "'" & clitrans_subcat_code_part3 & "'")
                DisplayableUpdateString = Replace(DisplayableUpdateString, "@clitrans_retail_flag", "'" & clitrans_retail_flag & "'")
                DisplayableUpdateString = Replace(DisplayableUpdateString, "@clitrans_id", "" & r("clitrans_id") & "")
                DisplayableUpdateString = Replace(DisplayableUpdateString, "@clitrans_jetnet_trans_id", "" & r("clitrans_jetnet_trans_id") & "")

                query_string_return += DisplayableUpdateString & "<br />"

                MySqlCommand = New MySql.Data.MySqlClient.MySqlCommand(update_string, MySqlConn)

                If Not String.IsNullOrEmpty(clitrans_subcategory_code) Then
                  MySqlCommand.Parameters.AddWithValue("clitrans_subcategory_code", clitrans_subcategory_code)
                End If
                If Not String.IsNullOrEmpty(clitrans_subcat_code_part1) Then
                  MySqlCommand.Parameters.AddWithValue("clitrans_subcat_code_part1", clitrans_subcat_code_part1)
                End If
                If Not String.IsNullOrEmpty(clitrans_subcat_code_part2) Then
                  MySqlCommand.Parameters.AddWithValue("clitrans_subcat_code_part2", clitrans_subcat_code_part2)
                End If
                If Not String.IsNullOrEmpty(clitrans_subcat_code_part3) Then
                  MySqlCommand.Parameters.AddWithValue("clitrans_subcat_code_part3", clitrans_subcat_code_part3)
                End If
                If Not String.IsNullOrEmpty(clitrans_retail_flag) Then
                  MySqlCommand.Parameters.AddWithValue("clitrans_retail_flag", clitrans_retail_flag)
                End If

                MySqlCommand.Parameters.AddWithValue("clitrans_id", r("clitrans_id"))
                MySqlCommand.Parameters.AddWithValue("clitrans_jetnet_trans_id", r("clitrans_jetnet_trans_id"))

                MySqlCommand.ExecuteNonQuery()

                counter = counter + 1
              End If
            End If

            query_string_return += "'----------------------------------------------------<br /><br />"
          End If
        Next
      End If

      Fix_Client_Transaction_Categories = query_string_return
    Catch ex As Exception
      Me.class_error = "Error in Fix_Client_Transaction_Categories() As String: " & ex.Message
      Fix_Client_Transaction_Categories = Me.class_error
    Finally
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function


  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Fix_Jetnet_Based_Client_Aircraft_Without_Sort()
  ' Purpose: Fix_Jetnet_Based_Client_Aircraft_Without_Sort
  ' Parameters: none, Fix all client aircraft without sort and with jetnet ac ID
  ' Return: 
  '       integer
  ' Change Log
  '           6/23/2011    - Created By: Tom Jones
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Fix_Jetnet_Based_Client_Aircraft_Without_Sort() As String
    Try
      Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
      Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
      Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
      Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
      Dim client As New DataTable

      MySqlConn.ConnectionString = Me.client_DB
      Dim counter As Integer = 0
      Dim query_string_return As String = ""

      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      'jetnet connection
      'jetnet connection
      Dim JETNET_SqlConn2 As New SqlClient.SqlConnection
      Dim JETNET_SqlCommand2 As New SqlClient.SqlCommand
      Dim JETNET_SqlException2 As SqlClient.SqlException : JETNET_SqlException2 = Nothing
      Dim JETNET_SqlReader2 As SqlClient.SqlDataReader : JETNET_SqlReader2 = Nothing

      Dim jetnet As New DataTable
      ' JETNET_SqlConn2.ConnectionString = Me.ref_DB
      JETNET_SqlConn2.ConnectionString = JETNET_DB


      JETNET_SqlConn2.Open()
      JETNET_SqlCommand2.Connection = JETNET_SqlConn2
      JETNET_SqlCommand2.CommandType = CommandType.Text
      JETNET_SqlCommand2.CommandTimeout = 60

      Dim sQuery As String = "select cliaircraft_id, cliaircraft_jetnet_ac_id from client_aircraft where cliaircraft_ser_nbr_sort is null or cliaircraft_ser_nbr_sort = '' "
      MySqlCommand.CommandText = sQuery
      MySqlReader = MySqlCommand.ExecuteReader()
      Try
        client.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = client.GetErrors()
      End Try

      query_string_return = query_string_return & "'----------------------------------------------------<br />"
      query_string_return = query_string_return & "'-- SELECT AIRCRAFT WHERE SERIAL # SORT IS BLANK OR NULL <br />"
      query_string_return = query_string_return & "'-- ACTION: GET THE CORRESPONDING JETNET RECORD AND UPDATE THE CLIENT RECORD<br />"
      query_string_return = query_string_return & sQuery & "<br /><br />"
      query_string_return = query_string_return & "'----------------------------------------------------<br /><br />"
      query_string_return = query_string_return & "'--SERIAL # SORT'S FIXED:<br />"

      If client.Rows.Count > 0 Then
        For Each r As DataRow In client.Rows

          If r("cliaircraft_jetnet_ac_id") <> 0 Then

            query_string_return = query_string_return & r("cliaircraft_id") & "<br />"
            Dim jetnet_query As String = "select ac_ser_no_sort as ac_ser_nbr_sort from aircraft with (NOLOCK) where ac_id = '" & r("cliaircraft_jetnet_ac_id") & "' and ac_journ_id = 0"
            jetnet = New DataTable
            JETNET_SqlCommand2.CommandText = jetnet_query
            JETNET_SqlReader2 = JETNET_SqlCommand2.ExecuteReader()
            Try
              jetnet.Load(JETNET_SqlReader2)
            Catch constrExc As System.Data.ConstraintException
              Dim rowsErr As System.Data.DataRow() = jetnet.GetErrors()
            End Try

            If jetnet.Rows.Count > 0 Then

              Dim update_string = "update client_aircraft set cliaircraft_ser_nbr_sort = '" & jetnet.Rows(0).Item("ac_ser_nbr_sort") & "' where cliaircraft_id = '" & r("cliaircraft_id") & "' and cliaircraft_jetnet_ac_id = '" & r("cliaircraft_jetnet_ac_id") & "' limit 1"
              query_string_return = query_string_return & update_string & "<br />"
              MySqlCommand.CommandText = update_string
              MySqlCommand.ExecuteNonQuery()
              counter = counter + 1
            End If
            JETNET_SqlReader2.Close()
            query_string_return = query_string_return & "'----------------------------------------------------<br /><br />"
          End If
        Next
      End If
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
      JETNET_SqlReader2 = Nothing

      JETNET_SqlConn2.Dispose()
      JETNET_SqlConn2.Close()
      JETNET_SqlConn2 = Nothing

      JETNET_SqlCommand2.Dispose()
      JETNET_SqlCommand2 = Nothing


      Fix_Jetnet_Based_Client_Aircraft_Without_Sort = query_string_return
    Catch ex As Exception
      Fix_Jetnet_Based_Client_Aircraft_Without_Sort = "ERROR"
      Me.class_error = "Error in Fix_Jetnet_Based_Client_Aircraft_Without_Sort(ByVal aclsClient_Aircraft As clsClient_Aircraft): " & ex.Message
    End Try
  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Clean_Orphaned_Aircraft()
  ' Purpose: Clean_Orphaned_Aircraft
  ' Parameters: none, Get rid of orphaned Aircraft
  ' Return: 
  '       integer
  ' Change Log
  '           7/5/2011    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Clean_Orphaned_Aircraft_Table_Rows() As String
    Try
      Dim query_string_return As String = ""
      Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
      Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
      Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
      Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
      Dim client As New DataTable

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60
      '---------------------------------------------
      'First references.
      '-- SELECT REFERENCES RELATED TO AIRCRAFT 
      '-- ACTION: SET THE CLIENT AIRCRAFT = 0
      'select * from client_aircraft_reference
      'where (cliacref_cliac_id not in (
      'select distinct cliaircraft_id from client_aircraft) and cliacref_cliac_id > 0);
      query_string_return = query_string_return & "'----------------------------------------------------<br />"
      query_string_return = query_string_return & "'-- SELECT REFERENCES RELATED TO AIRCRAFT <br />"
      query_string_return = query_string_return & "'-- ACTION: SET THE CLIENT AIRCRAFT = 0<br />"
      Dim sQuery As String = "update client_aircraft_reference set cliacref_cliac_id = 0 where (cliacref_cliac_id not in (select distinct cliaircraft_id from client_aircraft) and cliacref_cliac_id > 0)"
      MySqlCommand.CommandText = sQuery
      MySqlCommand.ExecuteNonQuery()
      query_string_return = query_string_return & sQuery & "<br /><br />"
      query_string_return = query_string_return & "'----------------------------------------------------<br />"

      '---------------------------------------------
      'Next Avionics
      '-- SELECT AVIONICS RELATED TO AIRCRAFT  THAT ARE MISSING
      '-- ACTION: REMOVE THE CLIENT AVIONICS RECORD
      'select cliav_cliac_id, cliav_name
      'from client_aircraft_avionics
      'where cliav_cliac_id not in (
      'select distinct cliaircraft_id from client_aircraft);
      query_string_return = query_string_return & "'----------------------------------------------------<br />"
      query_string_return = query_string_return & "'-- SELECT AVIONICS RELATED TO AIRCRAFT  THAT ARE MISSING<br />"
      query_string_return = query_string_return & "'--ACTION: REMOVE THE CLIENT AVIONICS RECORD<br />"
      sQuery = "delete from client_aircraft_avionics where cliav_cliac_id not in (select distinct cliaircraft_id from client_aircraft)"
      MySqlCommand.CommandText = sQuery
      MySqlCommand.ExecuteNonQuery()
      query_string_return = query_string_return & sQuery & "<br /><br />"
      query_string_return = query_string_return & "'----------------------------------------------------<br />"

      '---------------------------------------------

      'Next Details
      '-- SELECT DETAILS RELATED TO AIRCRAFT  THAT ARE MISSING
      '-- ACTION: REMOVE THE CLIENT AIRCRAFT DETAILS RECORD
      'select cliadet_cliac_id, cliadet_data_type, cliadet_data_name
      'from client_aircraft_details
      'where cliadet_cliac_id not in (
      'select distinct cliaircraft_id from client_aircraft);
      query_string_return = query_string_return & "'----------------------------------------------------<br />"
      query_string_return = query_string_return & "'-- SELECT DETAILS RELATED TO AIRCRAFT  THAT ARE MISSING<br />"
      query_string_return = query_string_return & "'-- ACTION: REMOVE THE CLIENT AIRCRAFT DETAILS RECORD<br />"
      sQuery = "delete from client_aircraft_details where cliadet_cliac_id not in (select distinct cliaircraft_id from client_aircraft)"
      MySqlCommand.CommandText = sQuery
      MySqlCommand.ExecuteNonQuery()
      query_string_return = query_string_return & sQuery & "<br /><br />"
      query_string_return = query_string_return & "'----------------------------------------------------<br />"

      '---------------------------------------------
      'Next Key Features
      '-- SELECT KEY FEATURES RELATED TO AIRCRAFT  THAT ARE MISSING
      '-- ACTION: REMOVE THE CLIENT AIRCRAFT KEY FEATURES RECORD
      'select cliafeat_cliac_id, cliafeat_type
      'from client_aircraft_key_features
      'where cliafeat_cliac_id not in (
      'select distinct cliaircraft_id from client_aircraft);
      query_string_return = query_string_return & "'----------------------------------------------------<br />"
      query_string_return = query_string_return & "'-- SELECT KEY FEATURES RELATED TO AIRCRAFT  THAT ARE MISSING<br />"
      query_string_return = query_string_return & "'-- ACTION: REMOVE THE CLIENT AIRCRAFT KEY FEATURES RECORD<br />"

      sQuery = "delete from client_aircraft_key_features where cliafeat_cliac_id not in (select distinct cliaircraft_id from client_aircraft)"
      MySqlCommand.CommandText = sQuery
      MySqlCommand.ExecuteNonQuery()
      query_string_return = query_string_return & sQuery & "<br /><br />"
      query_string_return = query_string_return & "'----------------------------------------------------<br />"

      '---------------------------------------------
      'Next Engine
      '-- SELECT ENGINE RELATED TO AIRCRAFT  THAT ARE MISSING
      '-- ACTION: REMOVE THE CLIENT ENGINE RECORD
      'select *
      'from client_aircraft_engine
      'where cliacep_cliac_id not in (
      'select distinct cliaircraft_id from client_aircraft);
      query_string_return = query_string_return & "'----------------------------------------------------<br />"
      query_string_return = query_string_return & "'-- SELECT ENGINE RELATED TO AIRCRAFT  THAT ARE MISSING<br />"
      query_string_return = query_string_return & "'-- ACTION: REMOVE THE CLIENT ENGINE RECORD<br />"

      sQuery = "delete from client_aircraft_engine where cliacep_cliac_id not in (select distinct cliaircraft_id from client_aircraft);"
      MySqlCommand.CommandText = sQuery
      MySqlCommand.ExecuteNonQuery()
      query_string_return = query_string_return & sQuery & "<br /><br />"
      query_string_return = query_string_return & "'----------------------------------------------------<br />"


      '---------------------------------------------
      'Next Propeller
      '-- SELECT Propeller RELATED TO AIRCRAFT  THAT ARE MISSING
      '-- ACTION: REMOVE THE CLIENT Propeller RECORD
      'select *
      'from client_aircraft_propeller
      'where cliacpr_cliac_id not in (
      'select distinct cliaircraft_id from client_aircraft);
      query_string_return = query_string_return & "'----------------------------------------------------<br />"
      query_string_return = query_string_return & "'-- SELECT Propeller RELATED TO AIRCRAFT  THAT ARE MISSING<br />"
      query_string_return = query_string_return & "'-- ACTION: REMOVE THE CLIENT Propeller RECORD<br />"
      sQuery = "delete from client_aircraft_propeller where cliacpr_cliac_id not in (select distinct cliaircraft_id from client_aircraft)"
      MySqlCommand.CommandText = sQuery
      MySqlCommand.ExecuteNonQuery()
      query_string_return = query_string_return & sQuery & "<br /><br />"
      query_string_return = query_string_return & "'----------------------------------------------------<br />"


      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing

      Clean_Orphaned_Aircraft_Table_Rows = query_string_return
    Catch ex As Exception
      Clean_Orphaned_Aircraft_Table_Rows = ""
      Me.class_error = "Error in Clean_Orphaned_Aircraft_Table_Rows(): " & ex.Message
    End Try
  End Function

  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Clean_Orphaned_Contacts_Phones_References()
  ' Purpose: Clean_Orphaned_Contacts_Phones
  ' Parameters: none, Get rid of orphaned contacts, phone numbers, references
  ' Return: 
  '       integer
  ' Change Log
  '           7/5/2011    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Clean_Orphaned_Contacts_Phones_References() As String
    Try
      Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
      Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
      Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
      Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
      Dim client As New DataTable
      Dim query_string_return As String = ""
      MySqlConn.ConnectionString = Me.client_DB
      Dim counter As Integer = 0
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60
      '---------------------------------------------
      'First Contacts.
      '-- SELECT  CONTACTS RELATED TO COMPANIES THAT ARE MISSING
      '-- ACTION: REMOVE CONTACTS WITH NO COMPANY
      'select clicontact_id, clicontact_comp_id
      'from client_contact
      'where clicontact_comp_id not in (
      'select distinct clicomp_id from client_company);
      query_string_return = query_string_return & "'----------------------------------------------------<br />"
      query_string_return = query_string_return & "'-- SELECT  CONTACTS RELATED TO COMPANIES THAT ARE MISSING<br />"
      query_string_return = query_string_return & "'-- ACTION: REMOVE CONTACTS WITH NO COMPANY<br />"
      Dim sQuery As String = "delete from client_contact where clicontact_comp_id not in (select distinct clicomp_id from client_company)"
      query_string_return = query_string_return & sQuery & "<br /><br />"
      MySqlCommand.CommandText = sQuery
      MySqlCommand.ExecuteNonQuery()
      query_string_return = query_string_return & "'----------------------------------------------------<br />"
      '---------------------------------------------
      'Next Company Phones not related to existing company.
      '-- SELECT PHONE NUMBERS RELATED TO COMPANIES THAT ARE MISSING
      '-- ACTION REMOVE PHONE NUMBERS NOT CONNECTED TO COMPANIES
      'select clipnum_comp_id, clipnum_contact_id
      'from client_phone_numbers
      'where clipnum_comp_id not in (
      'select distinct clicomp_id from client_company);
      query_string_return = query_string_return & "'----------------------------------------------------<br />"
      query_string_return = query_string_return & "'-- SELECT PHONE NUMBERS RELATED TO COMPANIES THAT ARE MISSING<br />"
      query_string_return = query_string_return & "'-- ACTION REMOVE PHONE NUMBERS NOT CONNECTED TO COMPANIES<br />"
      sQuery = "delete from client_phone_numbers where clipnum_comp_id not in (select distinct clicomp_id from client_company)"
      query_string_return = query_string_return & sQuery & "<br /><br />"
      query_string_return = query_string_return & "'----------------------------------------------------<br />"
      MySqlCommand.CommandText = sQuery
      MySqlCommand.ExecuteNonQuery()
      '---------------------------------------------
      'Next contact phones where contact ID doesn't exist
      '-- SELECT PHONE NUMBERS RELATED TO CONTACTS THAT ARE MISSING
      '-- ACTION: REMOVE PHONE NUMBERS NOT RELATED TO CONTACTS
      'select clipnum_comp_id, clipnum_contact_id
      'from client_phone_numbers
      'where clipnum_contact_id > 0 and clipnum_contact_id not in (
      'select distinct clicontact_id from client_contact);
      query_string_return = query_string_return & "'----------------------------------------------------<br />"
      query_string_return = query_string_return & "'-- SELECT PHONE NUMBERS RELATED TO CONTACTS THAT ARE MISSING<br />"
      query_string_return = query_string_return & "'-- ACTION REMOVE PHONE NUMBERS NOT CONNECTED TO CONTACTS<br />"
      sQuery = "delete from client_phone_numbers where clipnum_contact_id > 0 and clipnum_contact_id not in (select distinct clicontact_id from client_contact)"
      MySqlCommand.CommandText = sQuery
      query_string_return = query_string_return & sQuery & "<br /><br />"
      query_string_return = query_string_return & "'----------------------------------------------------<br />"


      MySqlCommand.ExecuteNonQuery()


      '---------------------------------------------
      'Next references 
      '-- SELECT REFERENCES RELATED TO AIRCRAFT 
      '-- ACTION: SET THE CLIENT COMPANY = 0
      'select * from client_aircraft_reference
      'where (cliacref_comp_id not in (
      'select distinct clicomp_id from client_company) and cliacref_comp_id > 0);
      query_string_return = query_string_return & "'----------------------------------------------------<br />"
      query_string_return = query_string_return & "'-- SELECT REFERENCES RELATED TO AIRCRAFT <br />"
      query_string_return = query_string_return & "'-- ACTION: SET THE CLIENT COMPANY = 0<br />"
      sQuery = "update client_aircraft_reference set cliacref_comp_id = 0 where (cliacref_comp_id not in (select distinct clicomp_id from client_company) and cliacref_comp_id > 0)"
      MySqlCommand.CommandText = sQuery
      query_string_return = query_string_return & sQuery & "<br /><br />"
      query_string_return = query_string_return & "'----------------------------------------------------<br />"

      MySqlCommand.ExecuteNonQuery()


      '---------------------------------------------

      '-- SELECT REFERENCES NOT CONNECTED TO ANYTHING
      '-- ACTION: REMOVE THE REFERENCE RECORD
      'select * from client_aircraft_reference
      'where cliacref_comp_id=0 AND cliacref_cliac_id=0 AND cliacref_jetnet_ac_id=0;
      query_string_return = query_string_return & "'----------------------------------------------------<br />"
      query_string_return = query_string_return & "'-- SELECT REFERENCES RELATED TO AIRCRAFT <br />"
      query_string_return = query_string_return & "'-- ACTION: SET THE CLIENT COMPANY = 0<br />"
      sQuery = "delete from client_aircraft_reference where cliacref_comp_id=0 AND cliacref_cliac_id=0 AND cliacref_jetnet_ac_id=0"
      MySqlCommand.CommandText = sQuery
      query_string_return = query_string_return & sQuery & "<br /><br />"

      query_string_return = query_string_return & "'----------------------------------------------------<br />"


      MySqlCommand.ExecuteNonQuery()


      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing

      Clean_Orphaned_Contacts_Phones_References = query_string_return
    Catch ex As Exception
      Clean_Orphaned_Contacts_Phones_References = ""
      Me.class_error = "Error in Clean_Orphaned_Contacts_Phones_References(): " & ex.Message
    End Try
  End Function


  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: Clean_Orphaned_Notes_Folders()
  ' Purpose: Clean_Orphaned_Notes_Folders
  ' Parameters: none, Get rid of orphaned notes and folder index references
  ' Return: 
  '       integer
  ' Change Log
  '           7/5/2011    - Created By: Amanda Vaughn
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function Clean_Orphaned_Notes_Folders() As String
    Try
      Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
      Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
      Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
      Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
      Dim client As New DataTable
      Dim query_string_return As String = ""
      MySqlConn.ConnectionString = Me.client_DB
      Dim counter As Integer = 0
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60
      '---------------------------------------------
      'First Folder Index Records
      '-- SELECT ORPHANED FOLDER INDEX RECORDS - NOT CONNTECTED TO AIRCRAFT, COMPANIES,
      '-- CONTACTS, OR FOLDERS
      '-- SINCE FOLDER REFERENCES ARE ONLY CREATED TO CONNECT TO THESE
      '-- ACTION: REMOVE THE CLIENT FOLDER INDEX RECORDS
      'select * from client_folder_index
      'where (cfoldind_client_ac_id not in (
      'select distinct cliaircraft_id from client_aircraft) and cfoldind_client_ac_id>0)
      'or 
      '(cfoldind_client_comp_id not in (
      'select distinct clicomp_id from client_company) and cfoldind_client_comp_id>0)
      'or
      '(cfoldind_client_contact_id not in (
      'select distinct clicontact_id from client_contact) and cfoldind_client_contact_id>0)
      'or
      '(cfoldind_cfolder_id not in (
      'select distinct cfolder_id from client_folder));

      query_string_return = "'----------------------------------------------------<br />"
      query_string_return = query_string_return & "'-- SELECT ORPHANED FOLDER INDEX RECORDS - NOT CONNTECTED TO AIRCRAFT, COMPANIES,<br />"
      query_string_return = query_string_return & "'-- CONTACTS, OR FOLDERS<br />"
      query_string_return = query_string_return & "'-- SINCE FOLDER REFERENCES ARE ONLY CREATED TO CONNECT TO THESE<br />"
      query_string_return = query_string_return & "'-- ACTION: REMOVE THE CLIENT FOLDER INDEX RECORDS<br />"
      Dim sQuery As String = "delete from client_folder_index where (cfoldind_client_ac_id not in ("
      sQuery = sQuery & "select distinct cliaircraft_id from client_aircraft) and cfoldind_client_ac_id>0)"
      sQuery = sQuery & " or (cfoldind_client_comp_id not in (select distinct clicomp_id from client_company) and cfoldind_client_comp_id>0)"
      sQuery = sQuery & " or (cfoldind_client_contact_id not in (select distinct clicontact_id from client_contact) and cfoldind_client_contact_id>0)"
      sQuery = sQuery & " or (cfoldind_cfolder_id not in (select distinct cfolder_id from client_folder))"

      MySqlCommand.CommandText = sQuery
      MySqlCommand.ExecuteNonQuery()
      query_string_return = query_string_return & sQuery & "<br /><br />"
      query_string_return = query_string_return & "'----------------------------------------------------<br />"
      '----------------------------------------------------------------------------------------------------------
      'Next Local Notes not Connected to Client AC
      '-- SELECT LOCAL NOTES NOT CONNECTED TO CLIENT AIRCRAFT.
      '-- ACTION: SET THE CLIENT AC ID = 0
      'select * from local_notes
      'where (lnote_client_ac_id not in (
      'select distinct cliaircraft_id from client_aircraft) and lnote_client_ac_id>0);
      query_string_return = query_string_return & "'----------------------------------------------------<br />"
      query_string_return = query_string_return & "'-- SELECT LOCAL NOTES NOT CONNECTED TO CLIENT AIRCRAFT<br />"
      query_string_return = query_string_return & "'-- ACTION: SET THE CLIENT AC ID = 0<br />"
      sQuery = "update local_notes set lnote_client_ac_id = 0 where (lnote_client_ac_id not in (select distinct cliaircraft_id from client_aircraft) and lnote_client_ac_id>0);"
      query_string_return = query_string_return & sQuery & "<br /><br />"
      MySqlCommand.CommandText = sQuery
      MySqlCommand.ExecuteNonQuery()
      query_string_return = query_string_return & "'----------------------------------------------------<br />"
      '----------------------------------------------------------------------------------------------------------
      'Next local notes not connected to client company
      '-- SELECT LOCAL NOTES NOT CONNECTED TO CLIENT COMPANY.
      '-- ACTION: SET THE CLIENT COMP ID = 0
      'select * from local_notes
      'WHERE (lnote_client_comp_id not in (
      'select distinct clicomp_id from client_company) and lnote_client_comp_id>0);
      query_string_return = query_string_return & "'----------------------------------------------------<br />"
      query_string_return = query_string_return & "'-- SELECT LOCAL NOTES NOT CONNECTED TO CLIENT COMPANY<br />"
      query_string_return = query_string_return & "'-- ACTION: SET THE CLIENT COMP ID = 0<br />"
      sQuery = "update local_notes set lnote_client_comp_id = 0 where (lnote_client_comp_id not in (select distinct clicomp_id from client_company) and lnote_client_comp_id>0)"
      query_string_return = query_string_return & sQuery & "<br /><br />"
      MySqlCommand.CommandText = sQuery
      MySqlCommand.ExecuteNonQuery()
      query_string_return = query_string_return & "'----------------------------------------------------<br />"
      '----------------------------------------------------------------------------------------------------------
      'Next local notes not connected to client contact
      '-- SELECT LOCAL NOTES NOT CONNECTED TO CLIENT CONTACT.
      '-- ACTION: SET THE CLIENT CONTACT ID = 0
      'select * from local_notes
      'WHERE (lnote_client_contact_id not in (
      'select distinct clicontact_id from client_contact) and lnote_client_contact_id>0);
      query_string_return = query_string_return & "'----------------------------------------------------<br />"
      query_string_return = query_string_return & "'-- SELECT LOCAL NOTES NOT CONNECTED TO CLIENT CONTACT<br />"
      query_string_return = query_string_return & "'-- ACTION: SET THE CLIENT CONTACT ID = 0<br />"
      sQuery = "update local_notes set lnote_client_contact_id = 0 where (lnote_client_contact_id not in (select distinct clicontact_id from client_contact) and lnote_client_contact_id>0)"
      query_string_return = query_string_return & sQuery & "<br /><br />"
      MySqlCommand.CommandText = sQuery
      MySqlCommand.ExecuteNonQuery()
      query_string_return = query_string_return & "'----------------------------------------------------<br />"
      '----------------------------------------------------------------------------------------------------------
      '-- AFTER THE ABOVE CLEANUP IS COMPLETED
      '-- SEE IF THERE ARE ANY NOTES NOT CONNECTED TO ANYTHING.
      '-- THESE ARE TRUELY ORPHANED AND EVEN THOUGH MAY BE GOOD DATA CANNOT BE FIXED
      '-- ACTION: REMOTE THE NOTES RECORDS
      'select * from local_notes
      'WHERE (lnote_client_contact_id =0 AND lnote_client_comp_id=0 and lnote_client_ac_id=0
      'and lnote_jetnet_contact_id =0 AND lnote_jetnet_comp_id=0 and lnote_jetnet_ac_id=0)
      'order by lnote_entry_date desc;
      query_string_return = query_string_return & "'----------------------------------------------------<br />"
      query_string_return = query_string_return & "'-- AFTER THE ABOVE CLEANUP IS COMPLETED<br />"
      query_string_return = query_string_return & "'-- SEE IF THERE ARE ANY NOTES NOT CONNECTED TO ANYTHING.<br />"
      query_string_return = query_string_return & "'-- THESE ARE TRUELY ORPHANED AND EVEN THOUGH MAY BE GOOD DATA CANNOT BE FIXED.<br />"
      query_string_return = query_string_return & "'-- ACTION: REMOTE THE NOTES RECORDS.<br />"

      sQuery = "delete from local_notes WHERE (lnote_client_contact_id =0 AND lnote_client_comp_id=0 and lnote_client_ac_id=0 and lnote_jetnet_contact_id =0 AND lnote_jetnet_comp_id=0 and lnote_jetnet_ac_id=0) order by lnote_entry_date desc"
      query_string_return = query_string_return & sQuery & "<br /><br />"
      MySqlCommand.CommandText = sQuery
      MySqlCommand.ExecuteNonQuery()
      query_string_return = query_string_return & "'----------------------------------------------------<br />"

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing

      Clean_Orphaned_Notes_Folders = query_string_return
    Catch ex As Exception
      Clean_Orphaned_Notes_Folders = ""
      Me.class_error = "Error in Clean_Orphaned_Notes_Folders(): " & ex.Message
    End Try
  End Function


  Public Function Fix_Client_Transaction_Records() As String
    Dim query_string_return As String = ""

    Try
      Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
      Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
      Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
      Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
      Dim client As New DataTable
      Dim jetnet As New DataTable
      Dim ClientAircraftTable As New DataTable
      Dim ClientModelTable As New DataTable
      Dim counter As Integer = 0
      Dim mainTransactionQuery As String = ""

      query_string_return = "<h3>Fixing Client Transactions</h3>"

      query_string_return &= "'----------------------------------------------------<br />"
      query_string_return &= "'-- SELECT EACH CLIENT TRANSACTION<br />"
      query_string_return &= "'-- Action: FIX THE TRANSACTION RECORD WITH JETNET TRANSACTION DATA.<br />"
      query_string_return &= "'-- STEP 1: Select the JETNET AC ID from the jetnet transaction based on the clitrans_jetnet_trans_id.<br />"
      query_string_return &= "'-- STEP 2: Fix Client Transactions with No JETNET AC ID - Update the client transaction to have the correct clitrans_jetnet_ac_id.<br />"
      query_string_return &= "'-- STEP 3: Client Transactions with Wrong Client AC ID - For the JETNET AC ID – see if we have a corresponding client aircraft record by matching on select cliaircraft_id, cliaircraft_cliamot from client_aircaft where cliaircraft_jetnet_ac_id = XXX.<br />"
      query_string_return &= "'-- a: If we get a record then copy the client aircraft id and client model id on to the client transaction record.<br />"
      query_string_return &= "'-- b: If we don’t then make sure that the client aircraft id and client model are 0 on the client transaction.<br />"

      query_string_return &= "<br /><br />"
      query_string_return &= "'----------------------------------------------------<br /><br />"
      query_string_return &= "'--FIX LOG:<br />"

      'STEP 1 QUERY:
      mainTransactionQuery = "SELECT * FROM client_transactions ORDER BY clitrans_id DESC "
      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = mainTransactionQuery
      MySqlReader = MySqlCommand.ExecuteReader()

      Try
        client.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = client.GetErrors()
      End Try

      query_string_return &= "STEP 1 Query: " & mainTransactionQuery & "<br />"
      query_string_return &= "Total Records Returned: " & client.Rows.Count.ToString & "<br /><br />"


      'Fixing Client Transactions
      '1.	For each client transaction
      'a.	Select the JETNET AC ID from the jetnet transaction based on the clitrans_jetnet_trans_id 
      'b.	Fix Client Transactions with No JETNET AC ID - Update the client transaction to have the correct clitrans_jetnet_ac_id
      'c.	Client Transactions with Wrong Client AC ID - For the JETNET AC ID – see if we have a corresponding client aircraft record by matching on select cliaircraft_id, cliaircraft_cliamot from client_aircaft where cliaircraft_jetnet_ac_id = XXX
      'i.	If we get a record then copy the client aircraft id and client model id on to the client transaction record.
      'ii.	If we don’t then make sure that the client aircraft id and client model are 0 on the client transaction.

      query_string_return &= "STEP 2: For Each Client Transaction (that has a clitrans_jetnet_trans_id - otherwise it's a client only transaction:<br />"
      If client.Rows.Count > 0 Then
        For Each r As DataRow In client.Rows
          Dim JetnetACID As Long = 0
          jetnet = New DataTable

          JetnetACID = r("clitrans_jetnet_ac_id")


          If r("clitrans_jetnet_trans_id") <> 0 Then
            query_string_return &= "==============================================================================================<br />"
            query_string_return &= "Transaction ID #" & r("clitrans_id").ToString & " has a jetnet transaction ID. Let's verify information.<br />"

            'Fix Client Transactions with No Jetnet AC ID
            If JetnetACID = 0 Then
              query_string_return &= "------This Transaction has no JETNET AC ID: We need to use the transaction ID to fix the record.<br />"

              jetnet = Get_JETNET_Transactions_transID(r("clitrans_jetnet_trans_id"))
              If Not IsNothing(jetnet) Then
                If jetnet.Rows.Count > 0 Then
                  JetnetACID = jetnet.Rows(0).Item("journ_ac_id")
                  Dim jetnetAircraftIDQuery As String = "UPDATE client_transactions SET clitrans_jetnet_ac_id = '" & JetnetACID.ToString & "' WHERE clitrans_id =" & r("clitrans_id") & " LIMIT 1"

                  query_string_return &= "------This Jetnet Aircraft Id should be: " & JetnetACID.ToString & ".<br />"

                  MySqlCommand.CommandText = jetnetAircraftIDQuery
                  MySqlCommand.ExecuteNonQuery()

                  query_string_return &= "------Update Statement ran for this Transaction Record: " & jetnetAircraftIDQuery & "<br /><br />"
                Else
                  query_string_return &= "------This Jetnet Transaction does not exist.<br />"
                End If
              Else
                query_string_return &= class_error & "<br />"
              End If

              query_string_return = query_string_return & "<br /><br />'----------------------------------------------------<br /><br />"
            End If

            'Client Transactions with the wrong Client AC ID:
            If JetnetACID > 0 Then
              ClientAircraftTable = New DataTable
              Dim ClientModelID As Long = 0
              Dim ClientAircraftID As Long = 0

              query_string_return &= "------We need to use the jetnet aircraft ID to determine if the client AC ID is correct or not.<br />"

              ClientAircraftTable = Get_Client_Aircraft_JETNET_AC(JetnetACID)

              If Not IsNothing(ClientAircraftTable) Then
                If ClientAircraftTable.Rows.Count > 0 Then
                  query_string_return &= "------A client aircraft record has been found for jetnet aircraft ID #" & JetnetACID & "<br />"
                  ClientModelID = ClientAircraftTable.Rows(0).Item("cliaircraft_cliamod_id")
                  ClientAircraftID = ClientAircraftTable.Rows(0).Item("cliaircraft_id")
                Else
                  ClientModelTable = New DataTable

                  ClientAircraftID = 0
                  ClientModelID = 0

                  query_string_return &= "------A client aircraft record has NOT been found for jetnet aircraft ID #" & JetnetACID & "<br />"
                  query_string_return &= "------If we don’t find the specific client ac then do a model check using the jetnet model id<br />"

                  'We only really need to look up the jetnet transaction ID if we haven't before up above.
                  If jetnet.Rows.Count = 0 Then
                    jetnet = Get_JETNET_Transactions_transID(r("clitrans_jetnet_trans_id"))
                  End If

                  If Not IsNothing(jetnet) Then
                    If jetnet.Rows.Count > 0 Then
                      'This checks for a clientModel based on the jetnet model ID on the transaction record.
                      ClientModelTable = Get_Clients_Aircraft_Model_ByJETNETAmod(jetnet.Rows(0).Item("ac_amod_id"))

                      If Not IsNothing(ClientModelTable) Then
                        If ClientModelTable.Rows.Count > 0 Then
                          'Storing that model ID.
                          ClientModelID = ClientModelTable.Rows(0).Item("cliamod_id")
                        Else
                          ClientModelID = 0
                        End If
                      Else
                        query_string_return &= class_error & "<br />"
                      End If
                    Else
                      query_string_return &= "------This Jetnet Transaction does not exist.<br />"
                    End If
                  Else
                    query_string_return &= class_error & "<br />"
                  End If

                End If

                Dim clientAircraftIDQuery As String = "UPDATE client_transactions SET clitrans_cliamod_id = '" & ClientModelID.ToString & "',clitrans_cliac_id= '" & ClientAircraftID.ToString & "'  WHERE clitrans_id =" & r("clitrans_id") & " LIMIT 1"

                'query_string_return &= "++++++++++The Client Aircraft for this transaction is: " & ClientAircraftID.ToString & "<br />"
                'query_string_return &= "++++++++++The Client Model for this transaction is: " & ClientModelID.ToString & "<br />"

                MySqlCommand.CommandText = clientAircraftIDQuery
                MySqlCommand.ExecuteNonQuery()

                query_string_return &= "++++++++++Update Statement for client AC/Model info ran for this Transaction Record: <br />" & clientAircraftIDQuery & "<br /><br />"
              Else
                query_string_return &= class_error & "<br />"
              End If
              query_string_return &= "==============================================================================================<br /><br /><br />"
            End If

          End If
        Next
      End If

      'Client Connection being closed: 
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing

      Fix_Client_Transaction_Records = query_string_return
    Catch ex As Exception
      query_string_return &= ex.Message
      Fix_Client_Transaction_Records = query_string_return
      Me.class_error = "Error in Fix_Client_Transaction_Records() As String: " & ex.Message
    End Try

  End Function


  Public Function Fix_Client_Transaction_ClientAC_References_Records() As String
    Dim query_string_return As String = ""

    Try
      Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
      Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
      Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
      Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
      Dim client As New DataTable
      Dim jetnet As New DataTable
      Dim ClientAircraftTable As New DataTable
      Dim ClientModelTable As New DataTable
      Dim counter As Integer = 0
      Dim mainTransactionQuery As String = ""

      query_string_return = "<h3>Fixing Client AC References on Transactions</h3>"

      query_string_return &= "'----------------------------------------------------<br />"
      query_string_return &= "'-- List of client transactions where the client aircraft id does not exist.  These should be set to 0. <br /> "
      query_string_return &= "'-- Note that westfield has 53 of these.  Most likely when we remove a client aircraft we are not cleaning up <br /> "
      query_string_return &= "'-- client transactions referencing that client aircraft.<br /> "

      query_string_return &= "<br /><br />"
      query_string_return &= "'----------------------------------------------------<br /><br />"
      query_string_return &= "'--FIX LOG:<br />"

      'STEP 1 QUERY:
      mainTransactionQuery = "SELECT * FROM client_transactions "
      mainTransactionQuery += " WHERE(clitrans_cliac_id > 0) "
      mainTransactionQuery += " and clitrans_cliac_id not in ( "
      mainTransactionQuery += " select distinct cliaircraft_id from client_aircraft) "

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = mainTransactionQuery
      MySqlReader = MySqlCommand.ExecuteReader()

      Try
        client.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = client.GetErrors()
      End Try

      query_string_return &= "STEP 1 Query: " & mainTransactionQuery & "<br />"
      query_string_return &= "Total Records Returned: " & client.Rows.Count.ToString & "<br /><br />"


      'Fixing Client Transactions
      '1.	For each client transaction
      'a.	Update the client transaction record to have a client AC ID of Zero

      query_string_return &= "STEP 2: FOR EACH CLIENT TRANSACTION, UDPATE THE CLIENT TRANSACTION RECORD TO HAVE A CLIENT AC ID OF 0<br /><br />"
      If client.Rows.Count > 0 Then
        For Each r As DataRow In client.Rows
          query_string_return &= "Transaction #" & r("clitrans_id").ToString & " has an incorrect clitrans_cliac_id of: " & r("clitrans_cliac_id").ToString & "<br />"
          Dim jetnetAircraftIDQuery As String = "UPDATE client_transactions SET clitrans_cliac_id = '0' WHERE clitrans_id =" & r("clitrans_id") & " LIMIT 1"

          MySqlCommand.CommandText = jetnetAircraftIDQuery
          MySqlCommand.ExecuteNonQuery()

          query_string_return &= "------Update Statement ran for this Transaction Record: " & jetnetAircraftIDQuery & "<br /><br />"

        Next
      End If



      'STEP 2 QUERY:
      client = New DataTable

      mainTransactionQuery = "SELECT * FROM client_transactions "
      mainTransactionQuery += " WHERE clitrans_cliamod_id >0 "
      mainTransactionQuery += " and clitrans_cliamod_id not in ( "
      mainTransactionQuery += " select distinct cliamod_id from client_aircraft_model) "

      MySqlCommand.CommandText = mainTransactionQuery
      MySqlReader = MySqlCommand.ExecuteReader()

      Try
        client.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = client.GetErrors()
      End Try

      query_string_return &= "STEP 3 Query: " & mainTransactionQuery & "<br />"
      query_string_return &= "Total Records Returned: " & client.Rows.Count.ToString & "<br /><br />"

      query_string_return &= "STEP 3: FOR EACH CLIENT TRANSACTION, UDPATE THE CLIENT TRANSACTION RECORD TO HAVE A CLIENT MODEL ID OF 0<br /><br />"
      If client.Rows.Count > 0 Then
        For Each r As DataRow In client.Rows
          query_string_return &= "Transaction #" & r("clitrans_id").ToString & " has an incorrect clitrans_cliamod_id of: " & r("clitrans_cliamod_id").ToString & "<br />"
          Dim jetnetAircraftIDQuery As String = "UPDATE client_transactions SET clitrans_cliamod_id = '0' WHERE clitrans_id =" & r("clitrans_id") & " LIMIT 1"

          MySqlCommand.CommandText = jetnetAircraftIDQuery
          MySqlCommand.ExecuteNonQuery()

          query_string_return &= "------Update Statement ran for this Transaction Record: " & jetnetAircraftIDQuery & "<br /><br />"

        Next
      End If


      'Client Connection being closed: 
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing

      Fix_Client_Transaction_ClientAC_References_Records = query_string_return
    Catch ex As Exception
      query_string_return &= ex.Message
      Fix_Client_Transaction_ClientAC_References_Records = query_string_return
      Me.class_error = "Error in  Fix_Client_Transaction_ClientAC_References_Records() As String: " & ex.Message
    End Try

  End Function
#End Region
#Region "Value Analysis Queries"
  Public Function Get_Client_Current_Market_Comparables(ByRef lnoteID As Long) As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Try
      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      Dim sQuery As String = ""


      sQuery = "SELECT CONCAT(cliamod_make_name, ' ', cliamod_model_name , ' ', cliaircraft_ser_nbr) as 'Comparing' , cliaircraft_year_mfr as 'Year Mfr', cliaircraft_reg_nbr as 'Reg #', cliaircraft_asking_price as 'Asking', clival_ac_type, cliaircraft_est_price as 'Take', cliaircraft_broker_price as 'Broker', clival_client_ac_id as 'AC ID', cliaircraft_value_description as 'Value Desc.' FROM client_value_comparables INNER JOIN client_aircraft ON clival_client_ac_id = cliaircraft_id INNER JOIN client_aircraft_model ON cliaircraft_cliamod_id = cliamod_id WHERE clival_note_id = " & lnoteID & " AND clival_type = 'F' AND clival_ac_type = 'C' order by cliamod_make_name, cliamod_make_name, cliaircraft_ser_nbr"
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Current_Market_Comparables(ByRef lnoteID As Long) As DataTable</b><br />" & sQuery

      If sQuery <> "" Then
        MySqlCommand.CommandText = sQuery
        MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

        Try
          atemptable.Load(MySqlReader)
        Catch constrExc As System.Data.ConstraintException
          Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
        End Try
        MySqlReader.Close()
        MySqlReader = Nothing

      End If
      Get_Client_Current_Market_Comparables = atemptable
    Catch ex As Exception
      Get_Client_Current_Market_Comparables = Nothing
      Me.class_error = "Error in Get_Client_Current_Market_Comparables(ByRef lnoteID As Long) As DataTable: SQL VERSION " & ex.Message
    Finally

      atemptable.Dispose()
      atemptable = Nothing

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
  Public Function Get_Client_Sold_Comparables(ByRef lnoteID As Long) As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Try
      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      Dim sQuery As String = ""


      sQuery = "SELECT CONCAT(cliamod_make_name, ' ', cliamod_model_name, ' ' ,clitrans_ser_nbr) as 'Comparing' , clitrans_year_mfr as 'Year Mfr', clitrans_reg_nbr as 'Reg #', clitrans_asking_price as 'Asking', clitrans_est_price as 'Take', clitrans_sold_price as 'Sold', clitrans_date as 'Sold Date',  clival_client_ac_id as 'AC ID', clival_value_description as 'Value Desc.' FROM client_value_comparables INNER JOIN client_transactions ON clitrans_id = clival_clitrans_id INNER JOIN client_aircraft_model ON cliamod_id = clitrans_cliamod_id WHERE clival_note_id = " & lnoteID & " AND clival_type = 'S' AND clival_ac_type = 'C' order by clitrans_date asc"
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Sold_Comparables() As DataTable</b><br />" & sQuery

      If sQuery <> "" Then
        MySqlCommand.CommandText = sQuery
        MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

        Try
          atemptable.Load(MySqlReader)
        Catch constrExc As System.Data.ConstraintException
          Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
        End Try
        MySqlReader.Close()
        MySqlReader = Nothing

      End If
      Get_Client_Sold_Comparables = atemptable

    Catch ex As Exception
      Get_Client_Sold_Comparables = Nothing
      Me.class_error = "Error in Get_Client_Sold_Comparables(ByRef lnoteID As Long) As DataTable: SQL VERSION " & ex.Message
    Finally

      atemptable.Dispose()
      atemptable = Nothing

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  Public Function Get_Fields_To_Compare(ByRef lnoteID As Long) As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Try
      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      Dim sQuery As String = ""


      sQuery = "SELECT clivalfld_order, clivalfld_name  from client_value_fields  where clivalfld_val_id = " & lnoteID & " order by clivalfld_order"
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Fields_To_Compare(ByRef lnoteID As Long) As DataTable</b><br />" & sQuery

      If sQuery <> "" Then
        MySqlCommand.CommandText = sQuery
        MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

        Try
          atemptable.Load(MySqlReader)
        Catch constrExc As System.Data.ConstraintException
          Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
        End Try
        MySqlReader.Close()
        MySqlReader = Nothing

      End If
      Get_Fields_To_Compare = atemptable

    Catch ex As Exception
      Get_Fields_To_Compare = Nothing
      Me.class_error = "Error in Get_Fields_To_Compare(ByRef lnoteID As Long) As DataTable: SQL VERSION " & ex.Message
    Finally

      atemptable.Dispose()
      atemptable = Nothing

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  Public Function Remove_Client_Comparables(ByRef lnoteID As Long, ByVal acType As String) As Integer
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing

    Try

      Dim sql As String = ""
      Dim insert As String = ""
      Dim values As String = ""

      sql = "delete from client_value_comparables where clival_note_id = " & lnoteID & " and clival_type = 'F' and clival_ac_type = '" & acType & "'"


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Current_Market_Comparables(ByRef lnoteID As Long) As DataTable</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Remove_Client_Comparables = 1


    Catch ex As Exception
      Remove_Client_Comparables = Nothing
      Me.class_error = "Error in Remove_Client_Comparables(ByRef lnoteID As Long) As Integer: SQL VERSION " & ex.Message
    Finally

      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
  Public Function Get_Client_Primary_Comparable(ByRef lnoteID As Long) As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Try
      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60


      Dim sQuery As String = ""


      sQuery = "SELECT CONCAT(cliamod_make_name, ' ', cliamod_model_name , ' ', cliaircraft_ser_nbr) as 'Comparing' , cliaircraft_year_mfr as 'Year Mfr', cliaircraft_reg_nbr as 'Reg #', cliaircraft_asking_price as 'Asking', clival_ac_type, cliaircraft_est_price as 'Take', cliaircraft_broker_price as 'Broker', clival_client_ac_id as 'AC ID', cliaircraft_value_description as 'Value Desc.' FROM client_value_comparables INNER JOIN client_aircraft ON clival_client_ac_id = cliaircraft_id INNER JOIN client_aircraft_model ON cliaircraft_cliamod_id = cliamod_id WHERE clival_note_id = " & lnoteID & " AND clival_type = 'F' AND clival_ac_type = 'P' order by cliamod_make_name, cliamod_make_name, cliaircraft_ser_nbr"
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Current_Market_Comparables(ByRef lnoteID As Long) As DataTable</b><br />" & sQuery

      If sQuery <> "" Then
        MySqlCommand.CommandText = sQuery
        MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

        Try
          atemptable.Load(MySqlReader)
        Catch constrExc As System.Data.ConstraintException
          Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
        End Try
        MySqlReader.Close()
        MySqlReader = Nothing

      End If
      Get_Client_Primary_Comparable = atemptable
    Catch ex As Exception
      Get_Client_Primary_Comparable = Nothing
      Me.class_error = "Error in Get_Client_Primary_Comparable(ByRef lnoteID As Long) As DataTable: SQL VERSION " & ex.Message
    Finally

      atemptable.Dispose()
      atemptable = Nothing

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function
  Public Function Insert_Client_Comparables(ByRef lnoteID As Long, ByRef AircraftInformation As clsClient_Aircraft, ByVal SerSort As String, ByVal clientModelID As Long, ByVal jetnetModelID As Long, ByVal acType As String) As Integer
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing

    Try

      Dim sql As String = ""
      Dim insert As String = ""
      Dim values As String = ""

      insert = "clival_note_id, "
      values = lnoteID.ToString & ","

      insert += "clival_type, "
      values += "'F',"

      insert += "clival_client_ac_id, "
      values += AircraftInformation.cliaircraft_id.ToString & ","

      insert += "clival_ac_type, "
      values += "'" & acType & "',"

      insert += "clival_cliamod_id, "
      values += clientModelID.ToString & ","

      insert += "clival_jetnet_amod_id, "
      values += jetnetModelID.ToString & ","

      insert += "clival_ser_nbr, "
      values += "'" & Escape_Single_Quote(Left(AircraftInformation.cliaircraft_ser_nbr, 15)) & "',"

      insert += "clival_ser_nbr_sort,"
      values += "'" & SerSort & "',"

      'insert += "clival_reg_nbr, "
      'values += "'" & Escape_Single_Quote(Left(AircraftInformation.cliaircraft_reg_nbr, 12)) & "',"

      'insert += "clival_year_mfr, "
      'values += "'" & Left(AircraftInformation.cliaircraft_year_mfr, 50) & "',"

      'insert += "clival_forsale_flag, "
      'values += "'" & Left(AircraftInformation.cliaircraft_forsale_flag, 1) & "',"

      'insert += "clival_status, "
      'values += "'" & Left(AircraftInformation.cliaircraft_status, 35) & "', "

      'insert += "clival_exclusive_flag, "
      'values += "'" & Left(AircraftInformation.cliaircraft_exclusive_flag, 1) & "', "

      'insert += "clival_asking_wordage, "
      'values += "'" & Left(AircraftInformation.cliaircraft_asking_wordage, 10) & "', "

      If Not IsDBNull(AircraftInformation.cliaircraft_asking_price) Then
        If IsNumeric(AircraftInformation.cliaircraft_asking_price) Then
          insert += "clival_asking_price, "
          values += AircraftInformation.cliaircraft_asking_price.ToString & ","
        Else
          insert += "clival_asking_price, "
          values += "NULL,"
        End If
      Else
        insert += "clival_asking_price, "
        values += "NULL,"
      End If


      'insert += "clival_lease_flag, "
      'values += "'" & AircraftInformation.cliaircraft_lease_flag & "',"

      'insert += "clival_delivery, "
      'values += "'" & AircraftInformation.cliaircraft_delivery & "',"

      'insert += "clival_user_id, "
      'values += AircraftInformation.cliaircraft_user_id.ToString & ", "

      'If IsDate(AircraftInformation.cliaircraft_action_date) Then
      '    insert += "clival_action_date, "
      '    values += "'" & Format(CDate(AircraftInformation.cliaircraft_action_date), "yyyy-MM-dd HH:mm:ss") & "', "
      'End If


      insert += "clival_jetnet_ac_id, "
      values += AircraftInformation.cliaircraft_jetnet_ac_id.ToString & ","

      'insert += "clival_lifecycle, "
      'values += AircraftInformation.cliaircraft_lifecycle.ToString & ","

      'insert += "clival_ownership, "
      'values += "'" & Left(AircraftInformation.cliaircraft_ownership, 1) & "',"

      'insert += "clival_usage, "
      'values += "'" & Left(AircraftInformation.cliaircraft_usage, 1) & "',"

      'insert += "clival_alt_ser_nbr, "
      'values += "'" & Left(AircraftInformation.cliaircraft_alt_ser_nbr, 20) & "',"

      'insert += "clival_prev_reg_nbr, "
      'values += "'" & Left(AircraftInformation.cliaircraft_prev_reg_nbr, 12) & "',"

      'insert += "clival_country_of_registration, "
      'values += "'" & Left(AircraftInformation.cliaircraft_country_of_registration, 25) & "',"

      'insert += "clival_new_flag, "
      'values += "'" & Left(AircraftInformation.cliaircraft_new_flag, 1) & "',"

      'insert += "clival_year_dlv, "
      'values += "'" & Left(AircraftInformation.cliaircraft_year_dlv, 4) & "',"


      'insert += "clival_date_purchased, "
      'If Not IsDBNull(AircraftInformation.cliaircraft_date_purchased) Then
      '    If IsDate(AircraftInformation.cliaircraft_date_purchased) Then
      '        values += " '" & Format(CDate(AircraftInformation.cliaircraft_date_purchased), "yyyy-MM-dd HH:mm:ss") & "', "
      '    Else
      '        values += " NULL, "
      '    End If
      'Else
      '    values += " NULL, "
      'End If

      'insert += "clival_date_listed, "
      'If Not IsDBNull(AircraftInformation.cliaircraft_date_listed) Then
      '    If IsDate(AircraftInformation.cliaircraft_date_listed) Then
      '        values += " '" & Format(CDate(AircraftInformation.cliaircraft_date_listed), "yyyy-MM-dd HH:mm:ss") & "', "
      '    Else
      '        values += "  NULL, "
      '    End If
      'Else
      '    values += " NULL, "
      'End If

      'insert += "clival_airframe_maintenance_program, "
      'values += AircraftInformation.cliaircraft_airframe_maintenance_program & ","

      'insert += "clival_airframe_maintenance_tracking_program, "
      'values += AircraftInformation.cliaircraft_airframe_maintenance_tracking_program & ","

      'insert += "clival_airframe_total_hours, "
      'If Not IsDBNull(AircraftInformation.cliaircraft_airframe_total_hours) Then
      '    If IsNumeric(AircraftInformation.cliaircraft_airframe_total_hours) Then
      '        values += " '" & AircraftInformation.cliaircraft_airframe_total_hours & "', "
      '    Else
      '        values += " NULL, "
      '    End If
      'Else
      '    values += " NULL, "
      'End If

      'insert += "clival_airframe_total_landings, "
      'If Not IsDBNull(AircraftInformation.cliaircraft_airframe_total_landings) Then
      '    If IsNumeric(AircraftInformation.cliaircraft_airframe_total_landings) Then
      '        values += " '" & AircraftInformation.cliaircraft_airframe_total_landings & "', "
      '    Else
      '        values += " NULL, "
      '    End If
      'Else
      '    values += " NULL, "
      'End If


      'insert += "clival_date_engine_times_as_of, "
      'If Not IsDBNull(AircraftInformation.cliaircraft_date_engine_times_as_of) Then
      '    If IsDate(AircraftInformation.cliaircraft_date_engine_times_as_of) Then
      '        values += " '" & Format(CDate(AircraftInformation.cliaircraft_date_engine_times_as_of), "yyyy-MM-dd HH:mm:ss") & "', "
      '    Else
      '        values += " NULL, "
      '    End If
      'Else
      '    values += " NULL, "
      'End If

      'insert += "clival_aport_iata_code, "
      'values += "'" & Escape_Single_Quote(Left(AircraftInformation.cliaircraft_aport_iata_code, 4)) & "',"

      'insert += "clival_aport_icao_code, "
      'values += "'" & Escape_Single_Quote(Left(AircraftInformation.cliaircraft_aport_icao_code, 4)) & "',"

      'insert += "clival_aport_name, "
      'values += "'" & Escape_Single_Quote(Left(AircraftInformation.cliaircraft_aport_name, 100)) & "',"

      'insert += "clival_aport_state, "
      'values += "'" & Escape_Single_Quote(Left(AircraftInformation.cliaircraft_aport_name, 2)) & "',"

      'insert += "clival_aport_country, "
      'values += "'" & Escape_Single_Quote(Left(AircraftInformation.cliaircraft_aport_country, 50)) & "',"

      'insert += "clival_aport_city, "
      'values += "'" & Escape_Single_Quote(Left(AircraftInformation.cliaircraft_aport_city, 50)) & "',"

      'insert += "clival_aport_private, "
      'values += "'" & Left(AircraftInformation.cliaircraft_aport_private, 1) & "',"

      'insert += "clival_apu_model_name, "
      'values += "'" & Left(AircraftInformation.cliaircraft_apu_model_name, 40) & "',"

      'insert += "clival_apu_ser_nbr, "
      'values += "'" & Left(AircraftInformation.cliaircraft_apu_ser_nbr, 20) & "',"

      'insert += "clival_apu_ttsn_hours, "
      'values += AircraftInformation.cliaircraft_apu_ttsn_hours.ToString & ","

      'insert += "clival_apu_tsoh_hours, "
      'values += AircraftInformation.cliaircraft_apu_tsoh_hours.ToString & ","

      'insert += "clival_apu_tshi_hours, "
      'values += AircraftInformation.cliaircraft_apu_tshi_hours.ToString & ","

      'insert += "clival_apu_maintance_program, "
      'values += "'" & Left(AircraftInformation.cliaircraft_apu_maintance_program.ToString, 1) & "',"

      'insert += "clival_damage_flag, "
      'values += "'" & Left(AircraftInformation.cliaircraft_damage_flag.ToString, 1) & "',"

      'insert += "clival_damage_history_notes, "
      'values += "'" & Escape_Single_Quote(Left(AircraftInformation.cliaircraft_damage_history_notes, 250)) & "',"

      'insert += "clival_interior_rating, "
      'values += AircraftInformation.cliaircraft_interior_rating.ToString & ","

      'insert += "clival_interior_month_year, "
      'values += "'" & Escape_Single_Quote(Left(AircraftInformation.cliaircraft_interior_month_year, 6)) & "',"

      'insert += "clival_interior_doneby_name, "
      'values += "'" & Escape_Single_Quote(Left(AircraftInformation.cliaircraft_interior_doneby_name, 50)) & "',"

      'insert += "clival_interior_config_name, "
      'values += "'" & Escape_Single_Quote(Left(AircraftInformation.cliaircraft_interior_config_name, 15)) & "',"

      'insert += "clival_exterior_rating, "
      'values += AircraftInformation.cliaircraft_exterior_rating.ToString & ","

      'insert += "clival_exterior_month_year, "
      'values += "'" & Escape_Single_Quote(Left(AircraftInformation.cliaircraft_exterior_month_year, 6)) & "',"

      'insert += "clival_exterior_doneby_name, "
      'values += "'" & Escape_Single_Quote(Left(AircraftInformation.cliaircraft_exterior_doneby_name, 50)) & "',"

      'insert += "clival_passenger_count, "
      'values += AircraftInformation.cliaircraft_passenger_count.ToString & ","

      'insert += "clival_confidential_notes, "
      'values += "'" & Escape_Single_Quote(AircraftInformation.cliaircraft_confidential_notes) & "',"

      insert += "clival_est_price, "
      values += AircraftInformation.cliaircraft_est_price.ToString & ","

      insert += "clival_broker_price "
      If Not IsDBNull(AircraftInformation.cliaircraft_broker_price) Then
        If IsNumeric(AircraftInformation.cliaircraft_broker_price) Then
          values += " '" & AircraftInformation.cliaircraft_broker_price & "' "
        Else
          values += " NULL "
        End If
      Else
        values += " NULL "
      End If


      'insert += "clival_ac_maintained, "
      'values += "'" & Escape_Single_Quote(Left(AircraftInformation.cliaircraft_ac_maintained, 100)) & "',"

      'insert += "clival_value_description, "
      'values += "'" & Escape_Single_Quote(AircraftInformation.cliaircraft_value_description) & "',"

      'insert += "clival_custom_1, "
      'values += "'" & Left(Escape_Single_Quote(AircraftInformation.cliaircraft_custom_1), 150) & "',"

      'insert += "clival_custom_2, "
      'values += "'" & Left(Escape_Single_Quote(AircraftInformation.cliaircraft_custom_2), 150) & "',"

      'insert += "clival_custom_3, "
      'values += "'" & Left(Escape_Single_Quote(AircraftInformation.cliaircraft_custom_3), 150) & "',"

      'insert += "clival_custom_4, "
      'values += "'" & Left(Escape_Single_Quote(AircraftInformation.cliaircraft_custom_4), 150) & "',"

      'insert += "clival_custom_5, "
      'values += "'" & Left(Escape_Single_Quote(AircraftInformation.cliaircraft_custom_5), 150) & "',"

      'insert += "clival_custom_6, "
      'values += "'" & Left(Escape_Single_Quote(AircraftInformation.cliaircraft_custom_6), 150) & "',"

      'insert += "clival_custom_7, "
      'values += "'" & Left(Escape_Single_Quote(AircraftInformation.cliaircraft_custom_7), 150) & "',"

      'insert += "clival_custom_8, "
      'values += "'" & Left(Escape_Single_Quote(AircraftInformation.cliaircraft_custom_8), 150) & "',"

      'insert += "clival_custom_9, "
      'values += "'" & Left(Escape_Single_Quote(AircraftInformation.cliaircraft_custom_9), 150) & "',"

      'insert += "clival_custom_10 "
      'values += "'" & Left(Escape_Single_Quote(AircraftInformation.cliaircraft_custom_10), 150) & "'"

      'insert += "clival_engine_maint_prog, "
      'values += AircraftInformation.cliaircraft_engine_maint_prog & ","

      'insert += "clival_engine_mgmt_prog, "
      'values += AircraftInformation.cliaircraft_engine_mgmt_prog & ","

      sql = "insert into client_value_comparables ( " & insert & ") values (" & values & ")"


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Current_Market_Comparables(ByRef lnoteID As Long) As DataTable</b><br />" & sql


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql
      MySqlCommand.ExecuteNonQuery()
      Insert_Client_Comparables = 1


    Catch ex As Exception
      Insert_Client_Comparables = Nothing
      Me.class_error = "Error in Insert_Client_Comparables(ByRef lnoteID As Long, ByRef AircraftInformation As clsClient_Aircraft) As DataTable: SQL VERSION " & ex.Message
    Finally

      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing
      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try

  End Function

  Public Function Get_Client_Value_By_Model(ByRef jetnetModel As Long) As DataTable
    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection

    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim atemptable As New DataTable
    Dim sQuery As String = ""
    Try

      MySqlConn.ConnectionString = client_DB
      MySqlConn.Open()

      sQuery = "SELECT DISTINCT cliaircraft_ser_nbr, lnote_note, lnote_id "
      sQuery += " FROM local_notes "
      sQuery += " INNER JOIN client_aircraft ON cliaircraft_id = lnote_client_ac_id "
      sQuery += " WHERE lnote_status = 'V' "
      sQuery += " AND lnote_opportunity_status in ('O', 'T') "
      sQuery += " AND lnote_jetnet_amod_id =@jetnetModel limit 1"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Value_By_Model(ByRef jetnetModel As Long) As DataTable</b><br />" & sQuery


      Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand(sQuery, MySqlConn)

      MySqlCommand.Parameters.AddWithValue("@jetnetModel", jetnetModel)

      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        atemptable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing

      Get_Client_Value_By_Model = atemptable

    Catch ex As Exception
      Get_Client_Value_By_Model = Nothing
      Me.class_error = "Error in Get_Client_Value_By_Model(ByRef jetnetModel As Long) As DataTable: SQL VERSION " & ex.Message
    Finally

      atemptable.Dispose()
      atemptable = Nothing

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

    End Try

  End Function

#End Region
#End Region
#Region "A Combination of both, for the model functions"
  Function Jetnet_Model_DataTable() As DataTable
    Dim aTempTable As New DataTable
    aTempTable.Columns.Add("amod_id")
    aTempTable.Columns.Add("amod_make_name")
    aTempTable.Columns.Add("amod_model_name")
    aTempTable.Columns.Add("source")
    aTempTable.Columns.Add("amod_airframe_type")
    aTempTable.Columns.Add("amod_make_type")
    aTempTable.Columns.Add("amod_manufacturer_name")
    aTempTable.Columns.Add("amod_jetnet_amod_id")
    aTempTable.Columns.Add("client_id")

    Return aTempTable
  End Function
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  ' Method name: GetAircraft_MakeModels
  ' Purpose: to get an Aircraft Listing page with Model/Make, Ser/Reg, Owner Tot_hrs, Status
  ' Parameters: none
  ' Return: 
  '       DataTable
  ' Change Log
  '           1/27/2010    - Created By: Tom Jones
  '           7/13/2010    - Updated By: Tom Jones **Added code to merge client/jetnet with both amod_ids**
  '           Changed 10/27/10 by Amanda to take into Consideration Flags
  '       Complete overvamp on 2-29-11 to handle merging of  client dataset with jetnet evolution database.
  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
  Public Function GetCombined_Models(ByVal Helicopter As Boolean, ByVal Business As Boolean, ByVal Commercial As Boolean, ByVal Jets As Boolean, ByVal Executive As Boolean, ByVal Turboprops As Boolean) As DataTable
    Try

      'Changed 10/27/10 by Amanda to take into Consideration Flags.

      ' create a dataset for the client
      Dim dsClient As New DataSet
      ' create a data set for JETNET
      Dim dsJETNET As New DataSet
      dsClient.Tables.Add(Get_Client_Models)

      dsJETNET.Tables.Add(GetAircraft_MakeModels("", "", HttpContext.Current.Session.Item("localSubscription").crmHelicopter_Flag, HttpContext.Current.Session.Item("localSubscription").crmBusiness_Flag, HttpContext.Current.Session.Item("localSubscription").crmCommercial_Flag, HttpContext.Current.Session.Item("localSubscription").crmJets_Flag, HttpContext.Current.Session.Item("localSubscription").crmExecutive_Flag, HttpContext.Current.Session.Item("localSubscription").crmTurboprops, ""))
      'dsJETNET.Tables.Add(Jetnet_Model_DataTable)
      ' create a dtHolderDataTable from dalAircraft
      Dim dalTable_JETNET As New DataTable
      Dim dalTable_Client As New DataTable

      dalTable_Client = dsClient.Tables(0)
      dalTable_JETNET = dsJETNET.Tables(0)


      Dim aTempTable_Jetnet As DataTable = dsJETNET.Tables(0)
      Dim aTempTable_Client As DataTable = dsClient.Tables(0)


      ' cleanup the variables
      dsClient.Dispose()
      dsJETNET.Dispose()
      ''''''''''''''''''''''''''''''''''''''''''''''''''''''''
      ' compare the records and import them accordingly
      ''''''''''''''''''''''''''''''''''''''''''''''''''''''''
      ' create the datatable to hold the client_amod_id and the jetnet_amod_id
      Dim aDataTable As New DataTable
      ' create a small datatable to hold the imported rows
      Dim dtImport As New DataTable
      aDataTable = Jetnet_Model_DataTable()
      dtImport = Jetnet_Model_DataTable()

      ' create an integer to hold the count of the smaller table
      Dim small_count As Integer = 0
      ' create a boolean to hold the igonre smaller table
      ' this is done when the count of the bigger table exceeds the count of the smaller table
      Dim bolIgnore_Table As Boolean = False
      ' create a string to hold make_model name
      Dim aMake_Model As String = ""
      ' add the rows to aDataTable, that we are rebuilding with both sets of info
      '********************************************************************************************************************************************************
      ' there has to be a better way to add the rows
      ' you have to increment your row in the aDataTable for every record you add or you could erase added rows when you return to the top of the loop
      ' old way had it adding a row for either JETNET/Client then i.e. row 23 then + 1 makes row 24 at the top of the loop you are at row 24 and you added to that erasing what you got.
      '*********************************************************************************************************************************************************
      For x As Integer = 0 To ((dalTable_JETNET.Rows.Count + dalTable_Client.Rows.Count) * 2) - 1
        aDataTable.Rows.Add()
      Next
      'aDataTable.Columns.Add("client_id")
      'see which record set is bigger
      If dalTable_Client.Rows.Count > dalTable_JETNET.Rows.Count Then
        ' use the client for the main loop
        small_count = dalTable_JETNET.Rows.Count
        For Client_DT_Row_Count As Integer = 0 To dalTable_Client.Rows.Count - 1
          '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
          ' make sure you haven't reach the row count for the smaller table
          '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
          If Client_DT_Row_Count > small_count - 1 Then
            bolIgnore_Table = True
          End If
          ' check the boolean to see if we can compare
          'If Not bolIgnore_Table Then
          ' create a data row to query the table
          Dim drQuery As DataRow()
          If dalTable_JETNET.Rows.Count > 0 Then
            drQuery = dalTable_JETNET.Select("amod_make_name = '" & Replace(dalTable_Client.Rows(Client_DT_Row_Count).Item("amod_make_name"), "'", "''") & "' AND amod_model_name = '" & Replace(dalTable_Client.Rows(Client_DT_Row_Count).Item("amod_model_name"), "'", "''") & "'", "amod_make_name ASC")
          Else
            drQuery = dalTable_JETNET.Select("", "")
          End If
          Dim drImport_Client As DataRow
          ' compare make model name
          If _
          drQuery.Length > 0 Then
            For Each drImport_Client In drQuery
              dtImport.ImportRow(drImport_Client)
            Next
            aDataTable.Rows(Client_DT_Row_Count + 1).Item("amod_id") = dalTable_JETNET.Rows(Client_DT_Row_Count).Item("amod_id")
            ' set the rest of the data
            aDataTable.Rows(Client_DT_Row_Count + 1).Item("amod_make_name") = dtImport.Rows(Client_DT_Row_Count).Item("amod_make_name")
            aDataTable.Rows(Client_DT_Row_Count + 1).Item("amod_model_name") = dtImport.Rows(Client_DT_Row_Count).Item("amod_model_name")
            aDataTable.Rows(Client_DT_Row_Count + 1).Item("source") = "Both"
            If Not bolIgnore_Table Then
              aDataTable.Rows(Client_DT_Row_Count + 1).Item("amod_airframe_type") = dalTable_JETNET.Rows(Client_DT_Row_Count).Item("amod_airframe_type_code")
              aDataTable.Rows(Client_DT_Row_Count + 1).Item("amod_make_type") = dalTable_JETNET.Rows(Client_DT_Row_Count).Item("amod_make_type")
              aDataTable.Rows(Client_DT_Row_Count + 1).Item("amod_manufacturer_name") = dalTable_JETNET.Rows(Client_DT_Row_Count).Item("amod_manufacturer_name")
              ' if the names match grab the jetnet_amod_id and stuff it into the new table
              aDataTable.Rows(Client_DT_Row_Count + 1).Item("amod_jetnet_amod_id") = dalTable_JETNET.Rows(Client_DT_Row_Count).Item("amod_id")
              aDataTable.Rows(Client_DT_Row_Count + 1).Item("client_id") = dtImport.Rows(Client_DT_Row_Count).Item("amod_id")
            Else
              aDataTable.Rows(Client_DT_Row_Count + 1).Item("amod_airframe_type") = dalTable_Client.Rows(Client_DT_Row_Count).Item("amod_airframe_type_code")
              aDataTable.Rows(Client_DT_Row_Count + 1).Item("amod_make_type") = dalTable_Client.Rows(Client_DT_Row_Count).Item("amod_make_type")
              aDataTable.Rows(Client_DT_Row_Count + 1).Item("amod_manufacturer_name") = dalTable_Client.Rows(Client_DT_Row_Count).Item("amod_manufacturer_name")
              ' if the names match grab the jetnet_amod_id and stuff it into the new table
              aDataTable.Rows(Client_DT_Row_Count + 1).Item("amod_jetnet_amod_id") = 0
              aDataTable.Rows(Client_DT_Row_Count + 1).Item("client_id") = dtImport.Rows(Client_DT_Row_Count).Item("amod_id")
            End If


          Else
            ' if the don't grab both rows and stuff them into the new table
            '''''''''''''''''''''''''
            ' Client
            '''''''''''''''''''''''''
            aDataTable.Rows(Client_DT_Row_Count + 1).Item("amod_id") = dalTable_Client.Rows(Client_DT_Row_Count).Item("amod_id")
            ' set the rest of the data
            aDataTable.Rows(Client_DT_Row_Count + 1).Item("amod_make_name") = dalTable_Client.Rows(Client_DT_Row_Count).Item("amod_make_name")
            aDataTable.Rows(Client_DT_Row_Count + 1).Item("amod_model_name") = dalTable_Client.Rows(Client_DT_Row_Count).Item("amod_model_name")
            aDataTable.Rows(Client_DT_Row_Count + 1).Item("source") = "Client"
            aDataTable.Rows(Client_DT_Row_Count + 1).Item("amod_airframe_type") = dalTable_Client.Rows(Client_DT_Row_Count).Item("amod_airframe_type")
            aDataTable.Rows(Client_DT_Row_Count + 1).Item("amod_make_type") = dalTable_Client.Rows(Client_DT_Row_Count).Item("amod_make_type")
            aDataTable.Rows(Client_DT_Row_Count + 1).Item("amod_manufacturer_name") = dalTable_Client.Rows(Client_DT_Row_Count).Item("amod_manufacturer_name")
            ' if the names match grab the jetnet_amod_id and stuff it into the new table
            aDataTable.Rows(Client_DT_Row_Count + 1).Item("amod_jetnet_amod_id") = 0
            aDataTable.Rows(Client_DT_Row_Count + 1).Item("client_id") = dalTable_Client.Rows(Client_DT_Row_Count).Item("amod_id")
            '''''''''''''''''''''''''''''
            ' JETNET
            '''''''''''''''''''''''''''''
            If Not bolIgnore_Table Then
              aDataTable.Rows(Client_DT_Row_Count + 1).Item("amod_id") = dalTable_JETNET.Rows(Client_DT_Row_Count).Item("amod_id")
              ' set the rest of the data
              aDataTable.Rows(Client_DT_Row_Count + 1).Item("amod_make_name") = dalTable_JETNET.Rows(Client_DT_Row_Count).Item("amod_make_name")
              aDataTable.Rows(Client_DT_Row_Count + 1).Item("amod_model_name") = dalTable_JETNET.Rows(Client_DT_Row_Count).Item("amod_model_name")
              aDataTable.Rows(Client_DT_Row_Count + 1).Item("source") = "JETNET"
              aDataTable.Rows(Client_DT_Row_Count + 1).Item("amod_airframe_type") = dalTable_JETNET.Rows(Client_DT_Row_Count).Item("amod_airframe_type")
              aDataTable.Rows(Client_DT_Row_Count + 1).Item("amod_make_type") = dalTable_JETNET.Rows(Client_DT_Row_Count).Item("amod_make_type")
              aDataTable.Rows(Client_DT_Row_Count + 1).Item("amod_manufacturer_name") = dalTable_JETNET.Rows(Client_DT_Row_Count).Item("amod_manufacturer_name")
              ' if the names match grab the jetnet_amod_id and stuff it into the new table
              aDataTable.Rows(Client_DT_Row_Count + 1).Item("amod_jetnet_amod_id") = 0
              aDataTable.Rows(Client_DT_Row_Count + 1).Item("client_id") = 0
            End If
          End If
        Next

      Else
        small_count = dalTable_Client.Rows.Count
        ' use the JETNET for the main loop

        For JETNET_DT_Row_Count As Integer = 0 To dalTable_JETNET.Rows.Count - 1

          '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
          ' make sure you haven't reach the row count for the smaller table
          '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
          bolIgnore_Table = False
          If JETNET_DT_Row_Count > small_count - 1 Then
            bolIgnore_Table = True
          End If
          ' check the boolean to see if we can compare
          ' create a data row to query the table
          Dim drQuery As DataRow()
          If dalTable_Client.Rows.Count > 0 Then
            drQuery = dalTable_Client.Select("amod_make_name = '" & Replace(dalTable_JETNET.Rows(JETNET_DT_Row_Count).Item("amod_make_name"), "'", "''") & "' AND amod_model_name = '" & Replace(dalTable_JETNET.Rows(JETNET_DT_Row_Count).Item("amod_model_name"), "'", "''") & "'", "amod_make_name ASC")
          Else
            drQuery = dalTable_Client.Select("", "")
          End If
          aMake_Model = dalTable_JETNET.Rows(JETNET_DT_Row_Count).Item("amod_make_name") & " " & dalTable_JETNET.Rows(JETNET_DT_Row_Count).Item("amod_model_name")
          ' a single data row for importing to the dalTable
          Dim drImport_Client As DataRow
          ' compare make model name
          If _
          drQuery.Length > 0 Then
            For Each drImport_Client In drQuery
              dtImport.ImportRow(drImport_Client)
            Next

            aDataTable.Rows(JETNET_DT_Row_Count + 1).Item("amod_id") = dalTable_JETNET.Rows(JETNET_DT_Row_Count).Item("amod_id")
            ' set the rest of the data
            aDataTable.Rows(JETNET_DT_Row_Count + 1).Item("amod_make_name") = dtImport.Rows(0).Item("amod_make_name")
            aDataTable.Rows(JETNET_DT_Row_Count + 1).Item("amod_model_name") = dtImport.Rows(0).Item("amod_model_name")
            aDataTable.Rows(JETNET_DT_Row_Count + 1).Item("source") = "Both"
            aDataTable.Rows(JETNET_DT_Row_Count + 1).Item("amod_airframe_type") = dalTable_JETNET.Rows(JETNET_DT_Row_Count).Item("amod_airframe_type_code")
            aDataTable.Rows(JETNET_DT_Row_Count + 1).Item("amod_make_type") = dalTable_JETNET.Rows(JETNET_DT_Row_Count).Item("amod_make_type_code")
            aDataTable.Rows(JETNET_DT_Row_Count + 1).Item("amod_manufacturer_name") = "" 'dalTable_JETNET.Rows(JETNET_DT_Row_Count).Item("amod_manufacturer_name")
            ' if the names match grab the jetnet_amod_id and stuff it into the new table
            aDataTable.Rows(JETNET_DT_Row_Count + 1).Item("amod_jetnet_amod_id") = dalTable_JETNET.Rows(JETNET_DT_Row_Count).Item("amod_id")
            aDataTable.Rows(JETNET_DT_Row_Count + 1).Item("client_id") = dtImport.Rows(0).Item("amod_id")
            dtImport.Rows.Clear()

          Else
            ' if the don't grab both rows and stuff them into the new table
            '''''''''''''''''''''''''
            ' Client
            '''''''''''''''''''''''''
            If Not bolIgnore_Table Then
              aDataTable.Rows(JETNET_DT_Row_Count + 1).Item("amod_id") = dalTable_Client.Rows(JETNET_DT_Row_Count).Item("amod_id")
              ' set the rest of the data
              aDataTable.Rows(JETNET_DT_Row_Count + 1).Item("amod_make_name") = dalTable_Client.Rows(JETNET_DT_Row_Count).Item("amod_make_name")
              aDataTable.Rows(JETNET_DT_Row_Count + 1).Item("amod_model_name") = dalTable_Client.Rows(JETNET_DT_Row_Count).Item("amod_model_name")
              aDataTable.Rows(JETNET_DT_Row_Count + 1).Item("source") = "Client"
              aDataTable.Rows(JETNET_DT_Row_Count + 1).Item("amod_airframe_type") = dalTable_Client.Rows(JETNET_DT_Row_Count).Item("amod_airframe_type")
              aDataTable.Rows(JETNET_DT_Row_Count + 1).Item("amod_make_type") = dalTable_Client.Rows(JETNET_DT_Row_Count).Item("amod_make_type")
              aDataTable.Rows(JETNET_DT_Row_Count + 1).Item("amod_manufacturer_name") = "" ' dalTable_Client.Rows(JETNET_DT_Row_Count).Item("amod_manufacturer_name")
              ' if the names match grab the jetnet_amod_id and stuff it into the new table
              aDataTable.Rows(JETNET_DT_Row_Count + 1).Item("amod_jetnet_amod_id") = 0
              aDataTable.Rows(JETNET_DT_Row_Count + 1).Item("client_id") = dalTable_Client.Rows(JETNET_DT_Row_Count).Item("amod_id")
            End If

            '''''''''''''''''''''''''''''
            ' JETNET
            '''''''''''''''''''''''''''''

            aDataTable.Rows(JETNET_DT_Row_Count + 1).Item("amod_id") = dalTable_JETNET.Rows(JETNET_DT_Row_Count).Item("amod_id")
            ' set the rest of the data
            aDataTable.Rows(JETNET_DT_Row_Count + 1).Item("amod_make_name") = dalTable_JETNET.Rows(JETNET_DT_Row_Count).Item("amod_make_name")
            aDataTable.Rows(JETNET_DT_Row_Count + 1).Item("amod_model_name") = dalTable_JETNET.Rows(JETNET_DT_Row_Count).Item("amod_model_name")
            aDataTable.Rows(JETNET_DT_Row_Count + 1).Item("source") = "JETNET"
            aDataTable.Rows(JETNET_DT_Row_Count + 1).Item("amod_airframe_type") = dalTable_JETNET.Rows(JETNET_DT_Row_Count).Item("amod_airframe_type_code")
            aDataTable.Rows(JETNET_DT_Row_Count + 1).Item("amod_make_type") = dalTable_JETNET.Rows(JETNET_DT_Row_Count).Item("amod_make_type_code")
            aDataTable.Rows(JETNET_DT_Row_Count + 1).Item("amod_manufacturer_name") = "" ' dalTable_JETNET.Rows(JETNET_DT_Row_Count).Item("amod_manufacturer_name")
            ' if the names match grab the jetnet_amod_id and stuff it into the new table
            aDataTable.Rows(JETNET_DT_Row_Count + 1).Item("amod_jetnet_amod_id") = 0
            aDataTable.Rows(JETNET_DT_Row_Count + 1).Item("client_id") = 0

          End If ' to the make model 
        Next

      End If

      'one more check 
      'added 11/2/10 by Amanda
      'This will add the client AC that have no related jetnet ac models to them.
      dalTable_Client.Columns.Add("client_id")
      dalTable_Client.PrimaryKey = Nothing
      Dim afileterd7 As DataRow() = dalTable_Client.Select("amod_jetnet_amod_id = 0", "amod_make_name ASC")

      dtImport = dalTable_Client.Clone
      Dim count As Integer = aDataTable.Rows.Count

      Dim c As Integer = 0
      ' create another datarow to import the filtered info
      For Each atmpDataRow3 As DataRow In afileterd7

        dtImport.ImportRow(atmpDataRow3)
        atmpDataRow3.Item("amod_id") = 0
        atmpDataRow3.Item("amod_make_name") = dtImport.Rows(c).Item("amod_make_name")
        atmpDataRow3.Item("amod_model_name") = dtImport.Rows(c).Item("amod_model_name")
        atmpDataRow3.Item("source") = "Client"
        atmpDataRow3.Item("amod_airframe_type") = dtImport.Rows(c).Item("amod_airframe_type")
        atmpDataRow3.Item("amod_make_type") = dtImport.Rows(c).Item("amod_make_type")
        atmpDataRow3.Item("amod_manufacturer_name") = dtImport.Rows(c).Item("amod_manufacturer_name")
        ' if the names match grab the jetnet_amod_id and stuff it into the new table
        atmpDataRow3.Item("amod_jetnet_amod_id") = 0
        atmpDataRow3.Item("client_id") = dtImport.Rows(c).Item("amod_id")
        aDataTable.ImportRow(atmpDataRow3)
        c = c + 1
        count = count + 1
      Next



      '' cleanut variables
      dalTable_Client.Dispose()
      dalTable_JETNET.Dispose()

      '' return the new datatable
      ' GetAircraft_MakeModels = aDataTable
      ''Exit Function
      '' clean the table for the dupes
      '' create the Dictionary to filter out the duplicate rows, based on amod_jetnet_amod_id and amod_id
      Dim dupe As New Dictionary(Of Long, String)
      ' create a new data table to import the rows into
      Dim aDataTable2 As New DataTable
      aDataTable2 = aDataTable.Clone
      ' sort by amod_jetnet_amod_id DESC so you get all the ones that are dupes at the top of the dataset
      Dim afileterd As DataRow() = aDataTable.Select("", "amod_jetnet_amod_id DESC")
      ' create a datarow to start importing the row
      Dim atmpDataRow2 As DataRow
      ' aDataTable2.Columns.Add("client_id")
      ' run the loop and begin to import the rows
      For Each atmpDataRow2 In afileterd
        ' check to see if the item in the row is not NULL
        If Not IsDBNull(atmpDataRow2.ItemArray(0)) Then
          ' check to see if the value was added to the dictionary, based on amod_id
          ' since we ordered by the jetnet ones first well get the amod_id

          If Not dupe.ContainsKey(atmpDataRow2.ItemArray(0)) Then
            ' add the info to the dictionary
            dupe.Add(atmpDataRow2.ItemArray(0), atmpDataRow2.ItemArray(1).ToString)
            ' import the row
            aDataTable2.ImportRow(atmpDataRow2)
          End If
        End If
      Next ' repeat
      '' cleanup the variables
      aDataTable.Dispose()
      dupe.Clear()
      'GetAircraft_MakeModels = aDataTable2
      ' now create another table to hold the dataset by the make_name
      Dim aDataTable3 As DataTable = aDataTable2.Clone

      ' create a datarow to filter in the rows by make_name
      Dim afileterd2 As DataRow() = aDataTable2.Select("", "amod_make_name ASC, amod_model_name ASC")

      ' create another datarow to import the filtered info
      For Each atmpDataRow3 As DataRow In afileterd2
        aDataTable3.ImportRow(atmpDataRow3)

      Next
      ' cleanup the variables
      aDataTable2.Dispose()
      ' return the new datatable
      GetCombined_Models = aDataTable3
      'cleanut(variables)
      aDataTable3.Dispose()
    Catch ex As Exception
      GetCombined_Models = Nothing
      Me.class_error = "Error in GetCombined_Models: " & ex.Message
    End Try
  End Function


  ''' <summary>
  ''' This is to replace the function GetCombined_Models (up above):
  ''' 
  ''' The main goal of this function is to take the Client model list and Jetnet Model list and combine then into a big list. The rules of this datatable are going to look like this:
  '''
  ''' If a Client Record with Matching Jetnet Record:
  ''' Source = "Both"
  ''' amod_id = jetnet model ID
  ''' amod_jetnet_amod_id = jetnet model ID
  ''' client_id = client ID
  ''' 
  ''' If Client Record with no matching Jetnet Record:
  ''' Source = "Client"
  ''' amod_id = 0
  ''' amod_jetnet_amod_id = 0
  ''' client_id = client ID
  ''' 
  ''' If Jetnet Record with no matching Client Record:
  ''' Source = "JETNET"
  ''' amod_id = jetnet model ID
  ''' amod_jetnet_amod_id = jetnet model ID
  ''' client_id = 0
  ''' </summary>
  ''' <param name="Helicopter"></param>
  ''' <param name="Business"></param>
  ''' <param name="Commercial"></param>
  ''' <param name="Jets"></param>
  ''' <param name="Executive"></param>
  ''' <param name="Turboprops"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Get_Combination_Models(ByVal Helicopter As Boolean, ByVal Business As Boolean, ByVal Commercial As Boolean, ByVal Jets As Boolean, ByVal Executive As Boolean, ByVal Turboprops As Boolean) As DataTable
    Dim ReturnedTable As New DataTable
    Dim JetnetTable As New DataTable
    Dim JetnetTableFilterForClient As New DataTable
    Dim ClientTable As New DataTable
    Dim JetnetIDStoExclude As String = ""

    Try
      'What does this function need to do?
      '1.) It needs to get a list of Client Models.
      '2.) It needs to get a list of Jetnet Models.
      '3.) It needs to loop through each Client Model and make a determination.
      '3.a) Does it have a jetnet amod ID? If it does, you need to find the matching row and remove it from the Jetnet Table. Change the Source to BOTH.
      '3.b) If it does not, you change source to CLIENT.
      '4.) After you go through each client record and combine them all, then you take what's left of the jetnet table, throw it together. All of the remaining jetnet records without matching client IDs will have a source of JETNET.
      '5.) Sort table.

      'Getting a list of Client Models
      ClientTable = Get_Client_Models()

      'Getting a list of Jetnet Models
      JetnetTable = GetAircraft_MakeModels("", "", HttpContext.Current.Session.Item("localSubscription").crmHelicopter_Flag, HttpContext.Current.Session.Item("localSubscription").crmBusiness_Flag, HttpContext.Current.Session.Item("localSubscription").crmCommercial_Flag, HttpContext.Current.Session.Item("localSubscription").crmJets_Flag, HttpContext.Current.Session.Item("localSubscription").crmExecutive_Flag, HttpContext.Current.Session.Item("localSubscription").crmTurboprops, "")

      'Setting up The returnedTable schema
      ReturnedTable = Jetnet_Model_DataTable()


      If Not IsNothing(ClientTable) Then
        If ClientTable.Rows.Count > 0 Then
          For Each r As DataRow In ClientTable.Rows
            Dim newRow As DataRow = ReturnedTable.NewRow()
            'Setting up the base model row.
            newRow.Item("amod_make_name") = r("amod_make_name")
            newRow.Item("amod_model_name") = r("amod_model_name")
            newRow.Item("amod_airframe_type") = r("amod_airframe_type")
            newRow.Item("amod_make_type") = r("amod_make_type")
            newRow.Item("amod_manufacturer_name") = r("amod_manufacturer_name")

            'Setting up the filter table to be a fresh copy of the jetnetTable (all the models)
            If Not IsNothing(JetnetTable) Then
              JetnetTableFilterForClient = JetnetTable.Copy
            End If

            'Looping through each client model to figure out of there is a jetnet model.
            If Not IsNothing(JetnetTableFilterForClient) Then
              Dim JetnetFilteredRowForClient As DataRow() = JetnetTableFilterForClient.Select("amod_make_name = '" & Replace(r("amod_make_name"), "'", "''") & "' AND amod_model_name = '" & Replace(r("amod_model_name"), "'", "''") & "'", "amod_make_name ASC")


              If JetnetFilteredRowForClient.Length > 0 Then
                For Each dataR As DataRow In JetnetFilteredRowForClient
                  'This means you have a "BOTH" row
                  newRow.Item("source") = "Both"
                  newRow.Item("amod_jetnet_amod_id") = dataR.Item("amod_id")
                  newRow.Item("client_id") = r("amod_id")
                  newRow.Item("amod_id") = dataR.Item("amod_id")

                  'We need to alter this variable to hold the jetnet IDs that are being added to the table already.
                  'Then as we go back later, we can exclude these as we bring in the rest of the jetnet IDs (the ones without
                  'a matching client ID).
                  If JetnetIDStoExclude <> "" Then
                    JetnetIDStoExclude += ","
                  End If

                  JetnetIDStoExclude += dataR.Item("amod_id").ToString
                Next
              Else 'This means that there was no corresponding jetnet row, so
                'This means you have a "CLIENT" row
                newRow.Item("amod_id") = 0
                newRow.Item("source") = "Client"
                newRow.Item("amod_jetnet_amod_id") = 0
                newRow.Item("client_id") = r("amod_id")
              End If
            Else
              'This means you have a "CLIENT" row because the jetnettableforfilter had nothing
              newRow.Item("amod_id") = 0
              newRow.Item("source") = "Client"
              newRow.Item("amod_jetnet_amod_id") = 0
              newRow.Item("client_id") = r("amod_id")
            End If

            'Finally we need to go ahead and add the row.
            ReturnedTable.Rows.Add(newRow)
          Next
        End If
      End If

      'The next step is to take all of the jetnet rows, exclude the ones we've already added, and import them into returned table.
      If JetnetIDStoExclude <> "" Then
        If Not IsNothing(JetnetTable) Then
          If JetnetTable.Rows.Count > 0 Then
            'Looping through each client model to figure out of there is a jetnet model.
            Dim JetnetFilteredRowForExclude As DataRow() = JetnetTable.Select("amod_id not in (" & JetnetIDStoExclude & ")", "amod_make_name ASC")
            If JetnetFilteredRowForExclude.Length > 0 Then
              For Each dataR As DataRow In JetnetFilteredRowForExclude
                Dim newRow As DataRow = ReturnedTable.NewRow()

                'This means you have a "JETNET" row
                newRow.Item("amod_make_name") = dataR.Item("amod_make_name")
                newRow.Item("amod_model_name") = dataR.Item("amod_model_name")
                newRow.Item("amod_airframe_type") = dataR.Item("amod_airframe_type_code")
                newRow.Item("amod_make_type") = dataR.Item("amod_make_type_code")

                newRow.Item("amod_manufacturer_name") = ""
                newRow.Item("source") = "JETNET"
                newRow.Item("amod_jetnet_amod_id") = dataR.Item("amod_id")
                newRow.Item("client_id") = 0
                newRow.Item("amod_id") = dataR.Item("amod_id")

                'Adding the row:
                ReturnedTable.Rows.Add(newRow)
              Next
            End If
          End If
        End If
      Else 'if the IDS to exclude are blank, just go ahead and import the full table.
        For Each dataR As DataRow In JetnetTable.Rows
          Dim newRow As DataRow = ReturnedTable.NewRow()
          'This means you have a "JETNET" row
          newRow.Item("amod_make_name") = dataR.Item("amod_make_name")
          newRow.Item("amod_model_name") = dataR.Item("amod_model_name")
          newRow.Item("amod_airframe_type") = dataR.Item("amod_airframe_type_code")
          newRow.Item("amod_make_type") = dataR.Item("amod_make_type_code")
          newRow.Item("amod_manufacturer_name") = ""
          newRow.Item("source") = "JETNET"
          newRow.Item("amod_jetnet_amod_id") = dataR.Item("amod_id")
          newRow.Item("client_id") = 0
          newRow.Item("amod_id") = dataR.Item("amod_id")

          'Adding the row:
          ReturnedTable.Rows.Add(newRow)
        Next
      End If

      'Let's go ahead and sort:
      'Change to a dataview
      Dim Returned_DV As New DataView(ReturnedTable)
      'Sort the view
      Returned_DV.Sort = "amod_make_name ASC, amod_model_name ASC"
      'Change back to a table
      ReturnedTable = Returned_DV.ToTable

    Catch ex As Exception
      Me.class_error = "Get_Combination_Models() as Datatable Error: " & ex.Message
      Return Nothing
    Finally
      'Dispose not needed tables
      ClientTable.Dispose()
      JetnetTable.Dispose()
      JetnetTableFilterForClient.Dispose()
    End Try

    Return ReturnedTable
  End Function



  Public Function Get_Client_Models() As DataTable
    Dim sql As String = ""

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Dim aTempTable As New DataTable

    Try

      sql = "SELECT  cliamod_id AS amod_id, cliamod_make_name AS amod_make_name, cliamod_model_name AS amod_model_name, 'Client' AS source, "
      sql = sql & " cliamod_airframe_type AS amod_airframe_type, cliamod_make_type AS amod_make_type, cliamod_manufacturer_name AS amod_manufacturer_name, "
      sql = sql & " cliamod_product_business_flag as amod_product_business_flag, cliamod_product_helicopter_flag as amod_product_helicopter_flag, "
      sql = sql & " cliamod_product_commercial_flag as amod_product_commercial_flag,cliamod_jetnet_amod_id as amod_jetnet_amod_id "
      sql = sql & " FROM  client_aircraft_model "


      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      MySqlCommand.CommandText = sql

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_Client_Models() As DataTable</b><br />" & sql

      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try


    Catch ex As Exception
      Get_Client_Models = Nothing
      Me.class_error = "Error in SQL Get_Client_Models() As DataTable " & ex.Message
    Finally
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
    Return aTempTable
  End Function
#End Region
#Region "The Export Function"
  ''' <summary>
  ''' Exporting Notes.. This has to be done seperately because notes are not stored in dual databases.
  ''' </summary>
  ''' <param name="first_column">Column Sorted By</param>
  ''' <param name="client_string">Client Selection Fields</param>
  ''' <param name="jetnet_string">Jetnet Selection Fields</param>
  ''' <param name="company">Company Boolean - export company info?</param>
  ''' <param name="contact">Contact boolean - export contact info?</param>
  ''' <param name="aircraft">Aircraft boolean - export ac info?</param>
  ''' <param name="transaction">Transaction boolean - export any transaction information?</param>
  ''' <param name="originating_type">Type of origin. Notes in this case</param>
  ''' <param name="note_search">Notes search text</param>
  ''' <param name="note_start_date">Notes start date</param>
  ''' <param name="note_end_date">Notes End Date</param>
  ''' <param name="note_type">Notes Type</param>
  ''' <param name="columnlist">list of columns</param>
  ''' <returns>returns datatable</returns>
  ''' <remarks>started building this as a way to export notes and breaking it off from the other export_all function
  ''' , however not all the features are possible, so we're only returning the bare minimum. Mostly because the queries would be incredibly complicated and 
  ''' expensive to look up all the corresponding information for every note considering some clients have 50,000 notes and the search isn't limiting how many they can
  ''' export at once. 50,000 notes x 3 (aircraft, contact, company information) is 150,000 lookups per search at a maximum.</remarks>
  Public Function Export_Notes(ByVal first_column As String, ByVal client_string As String, ByVal jetnet_string As String, ByVal company As Boolean, ByVal contact As Boolean, ByVal aircraft As Boolean, ByVal transaction As Boolean, ByVal originating_type As String, ByVal note_search As String, ByVal note_start_date As String, ByVal note_end_date As String, ByVal note_type As String, ByVal client_model_id As String, ByVal jetnet_model_id As String, ByVal user As String, ByVal category As String, ByVal opp_status As String, ByVal Order As String, ByVal columnlist As String, ByVal noteIds As String, ByVal OnlyModel As Boolean, ByVal OnlyAircraft As Boolean, ByVal ClientIDs As String, ByVal JetnetIDs As String, Optional ByVal TypeOfFolder As Long = 3) As DataTable
    Try
      Dim FieldToPoll As String = "ac"
      ' create the Select Strings
      Dim aSQL_String_Client_Select As String = ""
      Dim aSQL_String_JETNET_Select As String = ""
      ' create the Where string
      Dim aSQL_String_Client_Where As String = ""
      Dim aSQL_String_JETNET_Where As String = ""
      ' create a data table to hold the company info
      Dim dalTable As New DataTable
      Dim atemptable As New DataTable
      Dim atemptable2 As New DataTable
      Dim dataSet As DataSet = New DataSet("dataSet")
      dataSet.Tables.Add(atemptable)
      dataSet.Tables.Add(atemptable2)
      dataSet.Tables.Add(dalTable)
      dataSet.EnforceConstraints = False

      '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
      '----------------------------------------------------------- check to see if we are getting client data---------------------------------------------------
      '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

      '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
      ' ---------------------------------------------------------Setup the Client SQL Strings---------------------------------------------------------------
      '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

      'These are the basic fields needed for the company export. 

      aSQL_String_Client_Select = "SELECT DISTINCT "
      aSQL_String_Client_Select = aSQL_String_Client_Select & client_string

      '  If originating_type = 6 Or originating_type = 4 Then
      aSQL_String_Client_Select = aSQL_String_Client_Select & " ,lnote_jetnet_ac_id, lnote_client_ac_id FROM local_notes "
      If company = True Then
        aSQL_String_Client_Select = aSQL_String_Client_Select & " left outer join client_company on lnote_client_comp_id = clicomp_id "
      End If
      '  End If



      If contact = True Or originating_type = 2 Then
        If originating_type = 8 Then

        Else
          If company = False Then ' then we need to include company still
            aSQL_String_Client_Select = aSQL_String_Client_Select & " left outer join client_company on lnote_client_comp_id = clicomp_id  "
          End If
          aSQL_String_Client_Select = aSQL_String_Client_Select & " left outer join client_contact on clicontact_id = local_notes.lnote_client_contact_id "
        End If
      End If

      If aircraft = True Then

        '   If originating_type = 6 Then
        aSQL_String_Client_Select = aSQL_String_Client_Select & " LEFT OUTER JOIN client_aircraft_model On client_aircraft_model.cliamod_id = local_notes.lnote_client_amod_id "
        aSQL_String_Client_Select = aSQL_String_Client_Select & " LEFT OUTER JOIN client_aircraft ON client_aircraft.cliaircraft_id = local_notes.lnote_client_ac_id "
        aSQL_String_Client_Select = aSQL_String_Client_Select & " LEFT OUTER JOIN client_aircraft_reference on client_aircraft_reference.cliacref_cliac_id = client_aircraft.cliaircraft_id "
        aSQL_String_Client_Select = aSQL_String_Client_Select & " LEFT OUTER JOIN client_aircraft_contact_type ON client_aircraft_reference.cliacref_contact_type = client_aircraft_contact_type.cliact_type"
        'End If
      End If

      Dim AndQ As String = ""
      'The Building of the Where Clause 

      If note_type = "A" Then
        If note_start_date <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & " (lnote_entry_date >= """ & note_start_date & """) "
        End If
        If note_end_date <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (lnote_entry_date <= """ & note_end_date & " 23:59:59"")"
        End If
      ElseIf note_type = "P" Then
        If note_start_date <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & " (lnote_schedule_start_date >= """ & note_start_date & """) "
        End If
        If note_end_date <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (lnote_schedule_end_date <= """ & note_end_date & " 23:59:59"")"
        End If
      End If

      If opp_status <> "" Then
        If aSQL_String_Client_Where <> "" Then
          AndQ = " and "
        Else
          AndQ = ""
        End If
        aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (lnote_opportunity_status = '" & opp_status & "')"
      End If

      Select Case TypeOfFolder
        Case 2
          FieldToPoll = "contact"
        Case 1
          FieldToPoll = "comp"
      End Select

      If ClientIDs <> "" Then
        AndQ = ""
        If aSQL_String_Client_Where <> "" Then
          AndQ = " and "
        End If
        aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ

        If JetnetIDs <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & "("
        End If

        aSQL_String_Client_Where = aSQL_String_Client_Where & " lnote_client_" & FieldToPoll & "_id in (" & ClientIDs & ")"
      End If


      If JetnetIDs <> "" Then
        AndQ = ""
        If aSQL_String_Client_Where <> "" And ClientIDs = "" Then
          AndQ = " and "
        ElseIf aSQL_String_Client_Select <> "" And ClientIDs <> "" Then
          AndQ = " or "
        End If
        aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " lnote_jetnet_" & FieldToPoll & "_id in (" & JetnetIDs & ")"
        If ClientIDs <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & ")"
        End If
      End If



      If OnlyModel = True Then
        If aSQL_String_Client_Where <> "" Then
          AndQ = " and "
        Else
          AndQ = ""
        End If
        'This is sent on the propsect search, all others are false. This is sent whenever the customer wants to return only prospects with a model attached.
        aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (lnote_jetnet_amod_id <> 0 or lnote_client_amod_id <> 0 ) "
        'and (lnote_jetnet_ac_id = 0 and lnote_client_ac_id = 0 )"   - changed 
      ElseIf OnlyAircraft = True Then
        If aSQL_String_Client_Where <> "" Then
          AndQ = " and "
        Else
          AndQ = ""
        End If
        'This is sent on the prospect search, all other instances are false. This means the customer wants to return only prospects with an Aircraft attached.
        aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (lnote_jetnet_ac_id <> 0 or lnote_client_ac_id <> 0 ) "
      End If


      If category <> "" And category <> "0" Then
        If aSQL_String_Client_Where <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & " AND local_notes.lnote_notecat_key = '" & category & "' "
        Else
          aSQL_String_Client_Where = " local_notes.lnote_notecat_key = '" & category & "' "
        End If
      End If

      If jetnet_model_id <> "" Then
        If aSQL_String_Client_Where <> "" Then
          AndQ = " and "
        Else
          AndQ = ""
        End If
        aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (lnote_jetnet_amod_id in (" & jetnet_model_id & "))"
      End If

      If user <> "0" And user <> "" Then
        If aSQL_String_Client_Where <> "" Then
          AndQ = " and "
        Else
          AndQ = ""
        End If
        aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (lnote_user_id = " & user & ")"
      End If

      If client_model_id <> "" Then
        If aSQL_String_Client_Where <> "" Then
          AndQ = " and "
        Else
          AndQ = ""
        End If
        aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (lnote_client_amod_id in (" & client_model_id & "))"
      End If


      If note_search <> "" And note_search <> "%%" Then
        If aSQL_String_Client_Where <> "" Then
          AndQ = " and "
        Else
          AndQ = ""
        End If
        aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (lnote_note like '" & note_search & "')"
      End If

      If note_type <> "" Then
        If aSQL_String_Client_Where <> "" Then
          AndQ = " and "
        Else
          AndQ = ""
        End If

        If Trim(note_type) = "A" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (lnote_status in ('A','E')  )"
        Else
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (lnote_status in ('" & note_type & "')  )"
        End If



      End If

      'Adding one parameter here.
      'Generally this is only going to be filled in when we come from an export of notes that
      'is using an aircraft search field.
      If noteIds <> "" Then
        If aSQL_String_Client_Where <> "" Then
          aSQL_String_Client_Where += " and "
        End If
        aSQL_String_Client_Where += " (lnote_id in (" & noteIds & "))"
      End If



      Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
      Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
      Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader
      Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing

      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      Dim sQuery As String = aSQL_String_Client_Select & " WHERE " & aSQL_String_Client_Where '& " order by " & Order

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Export_Notes() as DataTable - Client Side Side</b><br />" & aSQL_String_Client_Select & " WHERE " & aSQL_String_Client_Where & " order by " & Order


      MySqlCommand.CommandText = sQuery
      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

      Try
        Dim id As Integer = 0
        Dim fieldcount As Integer = MySqlReader.FieldCount - 3

        Dim field_name As Array = Split(columnlist, "|")

        Dim ub As Integer = UBound(field_name)
        Dim jetnet_column As String = ""
        For x = 0 To fieldcount
          Dim splitTypeField As Array = Split(field_name(x), "&&&")
          'splitTypeField0 = type
          'splitTypeField1 = column name
          atemptable.Columns.Add(splitTypeField(1))

          Dim TypeOfColumn As String = UCase(splitTypeField(0))
          If InStr(TypeOfColumn, "AIRCRAFT") > 0 Then
            If x = fieldcount Then
              jetnet_column = jetnet_column & splitTypeField(1)
            Else
              jetnet_column = jetnet_column & splitTypeField(1) & "|"
            End If
          End If

        Next

        While MySqlReader.Read()
          id = MySqlReader.Item("lnote_jetnet_ac_id")

          Dim newCustomersRow As DataRow = atemptable.NewRow()
          For x = 0 To fieldcount
            newCustomersRow.Item(x) = MySqlReader.Item(x)
          Next

          If jetnet_string <> "" Then
            If MySqlReader.Item("lnote_client_ac_id") = 0 Then
              If id <> 0 Then
                Dim SqlConn As New SqlClient.SqlConnection
                Dim SqlCommand As New SqlClient.SqlCommand
                Dim SqlReader As SqlClient.SqlDataReader
                Dim SqlException As SqlClient.SqlException : SqlException = Nothing

                SqlConn.ConnectionString = JETNET_DB

                SqlConn.Open()
                SqlCommand.Connection = SqlConn

                Dim jQuery As String = "select " & jetnet_string & ", ac_id  "
                jQuery = jQuery & " FROM aircraft WITH (NOLOCK) "
                jQuery = jQuery & " inner JOIN aircraft_model WITH (NOLOCK) ON aircraft.ac_amod_id = aircraft_model.amod_id "
                jQuery = jQuery & " where (ac_id = " & id & " And ac_journ_id = 0) "

                HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Export_All() as DataTable - Jetnet Side</b><br />" & jQuery

                SqlCommand.CommandText = jQuery
                SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
                SqlCommand.CommandType = CommandType.Text
                SqlCommand.CommandTimeout = 60


                Dim jetnet_field_name As Array = Split(jetnet_column, "|")
                While SqlReader.Read()
                  If SqlReader.HasRows Then
                    For x = 0 To SqlReader.FieldCount - 2
                      newCustomersRow.Item(jetnet_field_name(x)) = SqlReader.Item(x)
                    Next
                  End If
                End While
                SqlConn.Close()
                SqlConn = Nothing
                SqlReader.Close()
                SqlReader = Nothing
              End If
            End If
          End If

          atemptable.Rows.Add(newCustomersRow)
          atemptable.AcceptChanges()

          '    newCustomersRow("ac_amod_id") = MySqlReader.Item("ac_amod_id")
        End While

      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      dataSet.EnforceConstraints = False

      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Dispose()
      MySqlConn.Close()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing

      Export_Notes = atemptable
      atemptable = Nothing
      atemptable2 = Nothing
      dalTable = Nothing
    Catch ex As Exception
      Export_Notes = Nothing
      Me.class_error = "Error in Export_Notes(): " & ex.Message
    End Try

  End Function



  ''' <summary>
  '''Function that drives the export Process for company, contact, aircraft, transaction
  ''' </summary>
  ''' <param name="first_column">column sorted by</param>
  ''' <param name="client_string">since the export fields are dynamic, here's the sql client string generated by the client,
  ''' meaning fields selected</param>
  ''' <param name="jetnet_string">since the export fields are dynamic, here's the sql jetnet string generated by the client,
  ''' meaning fields selected</param>
  ''' <param name="company">Company boolean, company info being exported?</param>
  ''' <param name="contact">Contact Boolean, contact information being exported?</param>
  ''' <param name="aircraft">Aircraft boolean, ac information being exported?</param>
  ''' <param name="transaction">Transaction boolean, transaction information being exported?</param>
  ''' <param name="data_subset">Subset of data we're exporting, jetnet, client, both?</param>
  ''' <param name="special_field">Special field for company information used</param>
  ''' <param name="special_field_txt">Special field search</param>
  ''' <param name="comp_name">Company Name</param>
  ''' <param name="status">Status for client side, Y/N?</param>
  ''' <param name="country">Country for company</param>
  ''' <param name="state">State for company</param>
  ''' <param name="operator_type">Type of Operators included in export</param>
  ''' <param name="include_phone">Include phones in export?</param>
  ''' <param name="f_name">First Name for contact</param>
  ''' <param name="l_name">Last Name for contact</param>
  ''' <param name="ID_SQL_IN_JETNET">SQL ID's for subfolders, comp IDs, ac IDs, etc - Jetnets</param>
  ''' <param name="ID_SQL_IN_CLIENT">SQL ID's for subfolders, comp IDs, ac IDs, etc - Clients</param>
  ''' <param name="originating_type">LISTING ID That the export originates from.. What type of export 
  ''' is it oringally? Like an export of an aircraft that's exporting ac contacts. Aircraft is the originator.</param>
  ''' <param name="ac_search">Aircraft Search text</param>
  ''' <param name="market_status">Aircraft Market Status</param>
  ''' <param name="airport_name">Airport Name for Aircraft</param>
  ''' <param name="icao_code">ICAO code for ac</param>
  ''' <param name="iata_code">IATA Code for ac</param>
  ''' <param name="ac_city">Aircraft airport city</param>
  ''' <param name="ac_country">Aircraft airport country</param>
  ''' <param name="ac_state">Aircraft airport State</param>
  ''' <param name="ac_owners">Aircraft types of owners</param>
  ''' <param name="client_models">Client Model IDs for Airports</param>
  ''' <param name="jetnet_models">Jetnet Model IDs for Airports</param>
  ''' <param name="helicopter">Helicopter Security Flag</param>
  ''' <param name="business">Business Security Flag</param>
  ''' <param name="jets">Jets Security Flag</param>
  ''' <param name="executive">Executive Security Flag</param>
  ''' <param name="turboprops">Turboprops security Flag</param>
  ''' <param name="commercial">Commercial Security Flag</param>
  ''' <param name="on_exclusive">On Exclusive Flag for Aircraft</param>
  ''' <param name="on_lease">On Lease Flag for Aircraft</param>
  ''' <param name="trans_search">Transaction Search Term</param>
  ''' <param name="trans_jetnet_model">Transaction Jetnet Model IDs</param>
  ''' <param name="trans_client_model">Transaction Client Model IDs</param>
  ''' <param name="trans_trans_type">Type of Transaction</param>
  ''' <param name="trans_start_date">Transaction Start Date</param>
  ''' <param name="trans_end_date">Transaction End Date</param>
  ''' <param name="note_search">Notes Search Term</param>
  ''' <param name="note_start_date">Notes Start Date</param>
  ''' <param name="note_end_date">Notes End Date</param>
  ''' <param name="note_type">Notes Type -  Status</param>
  ''' <param name="year_start">Year Start - Aircraft Transaction year_mfr</param>
  ''' <param name="year_end">Year End - Aircraft/Transaction year_mfr</param>
  ''' <param name="internal">Internal Transactions Flag</param>
  ''' <param name="awaiting">Awaiting TransactionsFlag</param>
  ''' <param name="aircraftNotesSearch">0 means ignore, 1 means with notes, 2 means without notes</param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Export_All(ByVal first_column As String, ByVal client_string As String, ByVal jetnet_string As String, ByVal company As Boolean, ByVal contact As Boolean, ByVal aircraft As Boolean, ByVal transaction As Boolean, ByVal data_subset As String, ByVal special_field As String, ByVal special_field_txt As String, ByVal comp_name As String, ByVal status As String, ByVal country As String, ByVal state As String, ByVal operator_type As String, ByVal include_phone As Boolean, ByVal f_name As String, ByVal l_name As String, ByVal ID_SQL_IN_JETNET As String, ByVal ID_SQL_IN_CLIENT As String, ByVal originating_type As Integer, ByVal ac_search As String, ByVal market_status As String, ByVal airport_name As String, ByVal icao_code As String, ByVal iata_code As String, ByVal ac_city As String, ByVal ac_country As String, ByVal ac_state As String, ByVal ac_owners As String, ByVal client_models As String, ByVal jetnet_models As String, ByVal helicopter As Boolean, ByVal business As Boolean, ByVal jets As Boolean, ByVal executive As Boolean, ByVal turboprops As Boolean, ByVal commercial As Boolean, ByVal on_exclusive As String, ByVal on_lease As String, ByVal trans_search As String, ByVal trans_jetnet_model As String, ByVal trans_client_model As String, ByVal trans_trans_type As String, ByVal trans_start_date As String, ByVal trans_end_date As String, ByVal note_search As String, ByVal note_start_date As String, ByVal note_end_date As String, ByVal note_type As String, ByVal year_start As String, ByVal year_end As String, ByVal internal As String, ByVal awaiting As String, ByVal contact_email_address As String, ByVal jetnet_comp_id As String, ByVal client_comp_id As String, ByVal lifecycle As String, ByVal ownership As String, ByVal companyCity As String, Optional ByVal order_by_string As String = "", Optional ByVal merge_lists As Boolean = False, Optional ByVal aircraftNotesSearch As Integer = 0) As DataTable
    Try
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText = ""
      ' create the Select Strings
      Dim aSQL_String_Client_Select As String = ""
      Dim aSQL_String_JETNET_Select As String = ""
      ' create the Where string
      Dim aSQL_String_Client_Where As String = ""
      Dim aSQL_String_JETNET_Where As String = ""
      ' create a data table to hold the company info
      Dim dalTable As New DataTable
      Dim atemptable As New DataTable
      Dim atemptable2 As New DataTable
      Dim dataSet As DataSet = New DataSet("dataSet")
      Dim i As Integer = 0
      dataSet.Tables.Add(atemptable)
      dataSet.Tables.Add(atemptable2)
      dataSet.Tables.Add(dalTable)
      dataSet.EnforceConstraints = False


      Dim client_ids_to_exclude As String = ""
      Dim added_client_id_to_select As Boolean = False


      Dim transaction_category As Array = Split(trans_trans_type, "|")
      Dim jetnet_transaction_category As String = ""
      Dim client_transaction_category As String = ""

      If UBound(transaction_category) = 1 Then
        jetnet_transaction_category = transaction_category(1)
        client_transaction_category = transaction_category(0)
      End If


      If special_field = "" Then
        'keep subset the same
      Else
        data_subset = "C"
      End If

      If status = "N" Then
        data_subset = "C"
      End If

      '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
      '----------------------------------------------------------- check to see if we are getting client data---------------------------------------------------
      '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
      If (data_subset = "C" Or data_subset = "JC" Or data_subset = "B") Then
        '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
        ' ---------------------------------------------------------Setup the Client SQL Strings---------------------------------------------------------------
        '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

        'These are the basic fields needed for the company export. 

        aSQL_String_Client_Select = "SELECT DISTINCT "
        aSQL_String_Client_Select = aSQL_String_Client_Select & client_string


        If originating_type = 8 Then
          aSQL_String_Client_Select = aSQL_String_Client_Select & " FROM client_transactions "
          aSQL_String_Client_Select = aSQL_String_Client_Select & " LEFT OUTER JOIN client_transactions_aircraft_reference ON client_transactions_aircraft_reference.clitcref_client_trans_id = client_transactions.clitrans_id "
          aSQL_String_Client_Select = aSQL_String_Client_Select & " LEFT OUTER JOIN client_aircraft_contact_type ON client_transactions_aircraft_reference.clitcref_contact_type = client_aircraft_contact_type.cliact_type"
          aSQL_String_Client_Select = aSQL_String_Client_Select & " LEFT OUTER JOIN client_aircraft_model ON client_transactions.clitrans_cliamod_id = client_aircraft_model.cliamod_id"
          If company = True Then
            aSQL_String_Client_Select = aSQL_String_Client_Select & " Left outer join client_transactions_company on client_transactions_aircraft_reference.clitcref_client_comp_id = client_transactions_company.clitcomp_id and client_transactions_company.clitcomp_trans_id = client_transactions.clitrans_id "
          End If
          If contact = True Then
            aSQL_String_Client_Select = aSQL_String_Client_Select & " left outer join client_transactions_contact on clitcref_client_contact_id = clitcontact_id and clitcref_client_trans_id = clitcontact_trans_id "
          End If
        Else

          If originating_type = 6 Then
            aSQL_String_Client_Select = aSQL_String_Client_Select & " ,lnote_jetnet_ac_id FROM local_notes "
            If company = True Then
              aSQL_String_Client_Select = aSQL_String_Client_Select & " left outer join client_company on lnote_client_comp_id = clicomp_id "
            End If
          Else

            ' COMMENTED OUT  - MSW - NOT SURE OF WHY IT WAS IN THERE
            If ((operator_type <> "") Or (aircraft = True Or originating_type = 3)) Then
              If InStr(Trim(aSQL_String_Client_Select), "cliaircraft_jetnet_ac_id") = 0 Then
                aSQL_String_Client_Select &= ", cliaircraft_jetnet_ac_id "
                added_client_id_to_select = True
              End If
            End If

            aSQL_String_Client_Select = aSQL_String_Client_Select & " FROM client_company"
            If operator_type <> "" Then
              aSQL_String_Client_Select = aSQL_String_Client_Select & " LEFT OUTER JOIN client_aircraft_reference on clicomp_id = cliacref_comp_id "
              aSQL_String_Client_Select = aSQL_String_Client_Select & "LEFT OUTER JOIN client_aircraft on cliacref_cliac_id = cliaircraft_id"
            End If
          End If



          If contact = True Or originating_type = 2 Then
            If originating_type = 8 Then

            Else
              aSQL_String_Client_Select = aSQL_String_Client_Select & " left outer join client_contact on clicomp_id = clicontact_comp_id "
            End If
          End If

          If aircraft = True Or originating_type = 3 Then


            If originating_type = 6 Then
              aSQL_String_Client_Select = aSQL_String_Client_Select & " LEFT OUTER JOIN client_aircraft ON client_aircraft.cliaircraft_id = local_notes.lnote_client_ac_id "
              aSQL_String_Client_Select = aSQL_String_Client_Select & " LEFT OUTER JOIN client_aircraft_reference on client_aircraft_reference.cliacref_cliac_id = client_aircraft.cliaircraft_id "
              aSQL_String_Client_Select = aSQL_String_Client_Select & " LEFT OUTER JOIN client_aircraft_contact_type ON client_aircraft_reference.cliacref_contact_type = client_aircraft_contact_type.cliact_type"
              aSQL_String_Client_Select = aSQL_String_Client_Select & " LEFT OUTER JOIN client_aircraft_model ON client_aircraft.cliaircraft_cliamod_id = client_aircraft_model.cliamod_id"
            Else
              aSQL_String_Client_Select = aSQL_String_Client_Select & " LEFT OUTER JOIN client_aircraft_reference on client_aircraft_reference.cliacref_comp_id = client_company.clicomp_id "
              aSQL_String_Client_Select = aSQL_String_Client_Select & " LEFT OUTER JOIN client_aircraft ON client_aircraft.cliaircraft_id = client_aircraft_reference.cliacref_cliac_id "
              aSQL_String_Client_Select = aSQL_String_Client_Select & " LEFT OUTER JOIN client_aircraft_contact_type ON client_aircraft_reference.cliacref_contact_type = client_aircraft_contact_type.cliact_type"
              aSQL_String_Client_Select = aSQL_String_Client_Select & " LEFT OUTER JOIN client_aircraft_model ON client_aircraft.cliaircraft_cliamod_id = client_aircraft_model.cliamod_id"
            End If

          End If

        End If
        'The Building of the Where Clause 
        'This means that company IDs were passed in a company search. IE Subfolder.
        If ID_SQL_IN_CLIENT <> "" And originating_type = 1 Then
          aSQL_String_Client_Where = " clicomp_id in (" & ID_SQL_IN_CLIENT & ")"
        End If

        If client_comp_id <> "" Then
          aSQL_String_Client_Where = " clicomp_id in (" & client_comp_id & ")"
        End If

        'This means that contact IDs were passed in a contact search. IE Subfolder.
        If ID_SQL_IN_CLIENT <> "" And originating_type = 2 Then
          aSQL_String_Client_Where = " clicontact_id in (" & ID_SQL_IN_CLIENT & ")"
        End If
        'This means that AC IDs were passed in a contact search. IE Subfolder.
        If ID_SQL_IN_CLIENT <> "" And originating_type = 3 Then
          If aircraftNotesSearch = 2 Then 'This is the only time this ever gets changed. You must pass a 2 to it, that means it's without notes.
            'Otherwise it just runs as normal.
            aSQL_String_Client_Where = " cliaircraft_id not in (" & ID_SQL_IN_CLIENT & ")"
          Else
            aSQL_String_Client_Where = " cliaircraft_id in (" & ID_SQL_IN_CLIENT & ")"
          End If

        End If

        'Company Search - Special field is the category search dropdown. Special field txt is the category field search that appears upon selection.
        If special_field = "" Then
          'Comp_name is the search field. 
          If comp_name <> "" And comp_name <> "%%" And comp_name <> "%" Then
            Select Case status 'Status flag is whether the company is active or inactive. 
              Case "B"
                If aSQL_String_Client_Where <> "" Then
                  aSQL_String_Client_Where = " and clicomp_name_search LIKE '" & comp_name & "'"
                Else
                  aSQL_String_Client_Where = " clicomp_name_search LIKE '" & comp_name & "'"
                End If

              Case Else
                If status <> "" Then
                  aSQL_String_Client_Where = " clicomp_name_search LIKE '" & comp_name & "' AND clicomp_status = '" & status & "'"
                End If
            End Select
          End If
        Else 'Category Company Search (see above)
          aSQL_String_Client_Where = " " & special_field & " LIKE '%" & special_field_txt & "%'"
        End If
        ' check the country
        If country <> "" And aSQL_String_Client_Where <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & " AND clicomp_country = '" & country & "'"
        ElseIf country <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & " clicomp_country = '" & country & "'"
        End If
        ' check the state
        If state <> "" And country <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & " AND clicomp_state IN(" & state & ")"
        ElseIf state <> "" And aSQL_String_Client_Where <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & " AND clicomp_state IN(" & state & ")"
        ElseIf state <> "" Then
          aSQL_String_Client_Where = aSQL_String_Client_Where & " clicomp_state IN(" & state & ")"
        End If

        If Trim(companyCity) <> "" Then
          If aSQL_String_Client_Where <> "" Then
            aSQL_String_Client_Where += " and "
          End If
          Dim TemporaryOperator As String = "Begins With"
          companyCity = clsGeneral.clsGeneral.CleanUserData(companyCity, Constants.cEmptyString, Constants.cCommaDelim, True)

          If InStr(companyCity, "*") = 0 Then
            aSQL_String_Client_Where += " " & "clicomp_city" & " " & clsGeneral.clsGeneral.PrepQueryString(TemporaryOperator, companyCity, "String", False, "clicomp_city", True)
          Else
            aSQL_String_Client_Where += " " & clsGeneral.clsGeneral.PrepQueryString(TemporaryOperator, companyCity, "String", False, "clicomp_city", True)
          End If
        End If

        ' check the operator_type 
        'If operator_type <> "" And aSQL_String_Client_Where <> "" Then
        '    Select Case operator_type
        '        Case "whole"
        '            aSQL_String_Client_Where = aSQL_String_Client_Where & " AND cliacref_contact_type in ('00')"
        '        Case "all"
        '            aSQL_String_Client_Where = aSQL_String_Client_Where & " AND cliacref_contact_type in ('00','97','08','56')"
        '        Case "operators"
        '            aSQL_String_Client_Where = aSQL_String_Client_Where & " AND cliacref_operator_flag='Y'"
        '    End Select
        'ElseIf operator_type <> "" Then
        '    Select Case operator_type
        '        Case "whole"
        '            aSQL_String_Client_Where = aSQL_String_Client_Where & " cliacref_contact_type in ('00')"
        '        Case "all"
        '            aSQL_String_Client_Where = aSQL_String_Client_Where & " cliacref_contact_type in ('00','97','08','56', '17')"
        '        Case "operators"
        '            aSQL_String_Client_Where = aSQL_String_Client_Where & " cliacref_operator_flag='Y'"
        '            ' aSQL_String_Client_Where = aSQL_String_Client_Where & " cliacref_contact_type in ('31','94','11','12', '1P', '36','18','39')"
        '    End Select
        'End If
        If operator_type <> "" Then
          If aSQL_String_Client_Where <> "" Then
            aSQL_String_Client_Where += " and "
          End If
          If operator_type = "all" Then 'all owners
            aSQL_String_Client_Where += " cliacref_contact_type in ('00','08','97','17','99','56')"
          ElseIf operator_type = "whole" Then 'whole owners
            aSQL_String_Client_Where += " cliacref_contact_type in ('56','99', '00')"
          ElseIf operator_type = "fractional" Then 'fractional owners
            aSQL_String_Client_Where += " cliacref_contact_type in ('97','17')"
          ElseIf operator_type = "shared" Then 'shared owners
            aSQL_String_Client_Where += " cliacref_contact_type in ('08')"
          ElseIf operator_type = "operators" Then 'operators
            aSQL_String_Client_Where += " cliacref_operator_flag in ('Y','O') "
          End If
        End If

        If f_name <> "%%" And f_name <> "%" Then
          If aSQL_String_Client_Where <> "" Then
            aSQL_String_Client_Where = aSQL_String_Client_Where & " and clicontact_first_name LIKE '" & f_name & "'"
          Else
            aSQL_String_Client_Where = aSQL_String_Client_Where & " clicontact_first_name LIKE '" & f_name & "'"
          End If
        End If

        If contact_email_address <> "%%" And contact_email_address <> "%" And contact_email_address <> "" Then
          If aSQL_String_Client_Where <> "" Then
            aSQL_String_Client_Where = aSQL_String_Client_Where & " and (clicontact_email_address LIKE '" & contact_email_address & "' or clicomp_email_address like '" & contact_email_address & "') "
          Else
            aSQL_String_Client_Where = aSQL_String_Client_Where & " (clicontact_email_address LIKE '" & contact_email_address & "' or clicomp_email_address like '" & contact_email_address & "') "
          End If
        End If

        If l_name <> "%%" And l_name <> "%" Then
          If aSQL_String_Client_Where <> "" Then
            aSQL_String_Client_Where = aSQL_String_Client_Where & " and clicontact_last_name LIKE '" & l_name & "'"
          Else
            aSQL_String_Client_Where = aSQL_String_Client_Where & " clicontact_last_name LIKE '" & l_name & "'"
          End If
        End If

        If status <> "B" And Trim(status) <> "" Then
          If aSQL_String_Client_Where <> "" Then
            If contact = True Then
              aSQL_String_Client_Where = aSQL_String_Client_Where & " and clicontact_status = '" & status & "'"

              'aSQL_String_Client_Where = aSQL_String_Client_Where & " and clicomp_status = '" & status & "' and clicontact_status = '" & status & "'"
            Else
              aSQL_String_Client_Where = aSQL_String_Client_Where & " and clicomp_status = '" & status & "' "
            End If
          Else
            If contact = True Then
            ElseIf company = True Then
              If status <> "" Then
                aSQL_String_Client_Where = aSQL_String_Client_Where & " clicomp_status = '" & status & "' "
              End If
            End If
          End If
        End If

        Dim AndQ As String = ""


        If originating_type = 3 Then

          If ownership <> "" Then
            If aSQL_String_Client_Where <> "" Then
              aSQL_String_Client_Where += " and "
            End If
            aSQL_String_Client_Where += " cliaircraft_ownership in ('" & ownership & "') "
          End If



          If lifecycle <> "" Then
            If aSQL_String_Client_Where <> "" Then
              aSQL_String_Client_Where += " and "
            End If

            If lifecycle = "4" Then
              aSQL_String_Client_Where = aSQL_String_Client_Where & " (cliaircraft_lifecycle = '4' AND lower(cliaircraft_status) <> 'withdrawn from use - stored') "
            ElseIf lifecycle = "5" Then
              aSQL_String_Client_Where = aSQL_String_Client_Where & " (cliaircraft_lifecycle = '4' AND lower(cliaircraft_status) = 'withdrawn from use - stored') "
            Else
              aSQL_String_Client_Where = aSQL_String_Client_Where & " (cliaircraft_lifecycle = '" & lifecycle & "') "
            End If
          End If



          If year_start <> "" Then
            If aSQL_String_Client_Where <> "" Then
              AndQ = " and "
            Else
              AndQ = ""
            End If
            aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_year_mfr >= '" & year_start & "' "
          End If

          If year_end <> "" Then
            If aSQL_String_Client_Where <> "" Then
              AndQ = " and "
            Else
              AndQ = ""
            End If
            aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_year_mfr <= '" & year_end & "' "
          End If
        ElseIf originating_type = 8 Then

          If internal <> "" Then
            If aSQL_String_Client_Where <> "" Then
              AndQ = " and "
            Else
              AndQ = ""
            End If
            aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " clitrans_internal_trans_flag = '" & internal & "' "
          End If


          If year_start <> "" Then
            If aSQL_String_Client_Where <> "" Then
              AndQ = " and "
            Else
              AndQ = ""
            End If
            aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " clitrans_year_mfr >= '" & year_start & "' "
          End If

          If year_end <> "" Then
            If aSQL_String_Client_Where <> "" Then
              AndQ = " and "
            Else
              AndQ = ""
            End If
            aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " clitrans_year_mfr <= '" & year_end & "' "
          End If
        End If


        If on_exclusive <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_exclusive_flag = '" & on_exclusive & "' "
        End If

        If on_lease <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_lease_flag like '" & on_lease & "' "
        End If

        If airport_name <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_aport_name like '%" & airport_name & "%' "
        End If

        If icao_code <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_aport_icao_code like '%" & icao_code & "%' "
        End If

        If iata_code <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_aport_iata_code like '%" & iata_code & "%' "
        End If

        If ac_city <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_aport_city like '%" & ac_city & "%' "
        End If

        If ac_country <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_aport_country in (" & ac_country & ") "
        End If

        If ac_state <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_aport_state IN(" & ac_state & ") "
        End If


        If client_models <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliamod_id in (" & client_models & ") "
        End If

        If ac_search <> "%" And ac_search <> "%%" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If

          ' If client_models = "" Then
          If ac_search <> "%%" Then
            aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & "(cliaircraft_ser_nbr like '" & ac_search & "' or cliaircraft_reg_nbr like '" & ac_search & "' or cliamod_make_name = '" & ac_search & "' or cliamod_make_type = '" & ac_search & "')"
          End If
          'End If

          Select Case market_status
            Case "For Sale"
              aSQL_String_Client_Where = aSQL_String_Client_Where & " and cliaircraft_forsale_flag = 'Y'"
            Case "Not For Sale"
              aSQL_String_Client_Where = aSQL_String_Client_Where & " and cliaircraft_forsale_flag = 'N'"
            Case "For Sale Exclusive"
              aSQL_String_Client_Where = aSQL_String_Client_Where & " and cliaircraft_exclusive_flag = 'Y'"
            Case "Lease"
              aSQL_String_Client_Where = aSQL_String_Client_Where & " and cliaircraft_lease_flag = 'Y'"
          End Select
        Else
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If

          Select Case market_status
            Case "For Sale"
              aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_forsale_flag = 'Y'"
            Case "Not For Sale"
              aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_forsale_flag = 'N'"
            Case "For Sale Exclusive"
              aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_exclusive_flag = 'Y'"
            Case "Lease"
              aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " cliaircraft_lease_flag = 'Y'"
          End Select
        End If

        If awaiting = "Y" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (client_transactions.clitrans_subject like '%Awaiting Documentation')  "
        End If

        If trans_start_date <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (client_transactions.clitrans_date >= """ & trans_start_date & """) "
        End If
        If trans_end_date <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (client_transactions.clitrans_date <= """ & trans_end_date & """)"
        End If

        If client_transaction_category <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (client_transactions.clitrans_type = '" & client_transaction_category & "') "
        End If

        If trans_client_model <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " clitrans_cliamod_id in(" & trans_client_model & ") "
        End If

        If trans_search <> "" And (trans_search <> "%%" And trans_search <> "%") Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (clitrans_subject like '" & trans_search & "' or clitrans_ser_nbr like '" & trans_search & "' or clitrans_reg_nbr like '" & trans_search & "')"
        End If


        If note_type = "P" Then
          If note_start_date <> "" Then
            aSQL_String_Client_Where = aSQL_String_Client_Where & " (lnote_entry_date >= """ & note_start_date & """) "
          End If
          If note_end_date <> "" Then
            If aSQL_String_Client_Where <> "" Then
              AndQ = " and "
            Else
              AndQ = ""
            End If
            aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (lnote_entry_date <= """ & note_end_date & """)"
          End If
        ElseIf note_type = "A" Then
          If note_start_date <> "" Then
            aSQL_String_Client_Where = aSQL_String_Client_Where & " (lnote_schedule_start_date >= """ & note_start_date & """) "
          End If
          If note_end_date <> "" Then
            If aSQL_String_Client_Where <> "" Then
              AndQ = " and "
            Else
              AndQ = ""
            End If
            aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (lnote_schedule_end_date <= """ & note_end_date & """)"
          End If
        End If

        If note_search <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (lnote_note like '" & note_search & "')"
        End If

        If note_type <> "" Then
          If aSQL_String_Client_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_Client_Where = aSQL_String_Client_Where & AndQ & " (lnote_status = '" & note_type & "')"
        End If



        Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
        Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
        Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader
        Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing

        MySqlConn.ConnectionString = Me.client_DB
        MySqlConn.Open()
        MySqlCommand.Connection = MySqlConn
        MySqlCommand.CommandType = CommandType.Text
        MySqlCommand.CommandTimeout = 60

        Dim sQuery As String = aSQL_String_Client_Select

        If Trim(aSQL_String_Client_Where) <> "" Then
          sQuery += " WHERE " & aSQL_String_Client_Where
        End If

        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Export_All() as DataTable - Client Side</b><br />" & sQuery



        MySqlCommand.CommandText = sQuery
        MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

        Try
          atemptable.Load(MySqlReader)
        Catch constrExc As System.Data.ConstraintException
          Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
        End Try

        dataSet.EnforceConstraints = False
        MySqlReader.Close()
        MySqlReader = Nothing

        MySqlConn.Dispose()
        MySqlConn.Close()
        MySqlConn = Nothing

        MySqlCommand.Dispose()
        MySqlCommand = Nothing


        If merge_lists = True Then
          If InStr(Trim(aSQL_String_Client_Select), "cliaircraft_jetnet_ac_id") > 0 Then
            If Not IsNothing(atemptable) Then
              If atemptable.Rows.Count > 0 Then
                For Each r As DataRow In atemptable.Rows
                  If Trim(client_ids_to_exclude) <> "" Then
                    client_ids_to_exclude = client_ids_to_exclude & ","
                  End If
                  client_ids_to_exclude = client_ids_to_exclude & r("cliaircraft_jetnet_ac_id")
                Next
              End If
            End If
          End If
        End If

      End If ' If (data_subset = "C" Or data_subset = "JC") Then



      '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
      '------------------------------------------------------------------ check to see if we are getting JETNET data---------------------------------------------
      '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
      If (data_subset = "J" Or data_subset = "JC" Or data_subset = "B") Then
        '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
        '--------------------------------------------------------------------- Setup the JETNET SQL Strings-----------------------------------------------------
        '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
        'The basic company fields
        aSQL_String_JETNET_Select = "SELECT DISTINCT "
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & jetnet_string

        If originating_type = 8 Then 'transaction

          aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " FROM journal with (NOLOCK) "

          aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " INNER JOIN journal_category with (NOLOCK) ON journal.journ_subcategory_code = journal_category.jcat_subcategory_code "
          aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " INNER JOIN aircraft on journ_ac_id = ac_id and ac_journ_id = journ_id"
          aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " inner join aircraft_model on ac_amod_id = amod_id"
          aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " inner join aircraft_reference with (NOLOCK) ON journal.journ_id = aircraft_reference.cref_journ_id and journ_ac_id = aircraft_reference.cref_ac_id "

          If company = True Then
            aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " inner join company with (NOLOCK) on aircraft_reference.cref_comp_id = comp_id and cref_journ_id = comp_journ_id   "
            aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " inner JOIN aircraft_contact_type WITH (NOLOCK) ON aircraft_reference.cref_contact_type = aircraft_contact_type.actype_code "
          End If
          If contact = True Then
            aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " left outer join contact with (NOLOCK) on cref_contact_id "
            aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " = contact_id and contact_journ_id = cref_journ_id and contact_active_flag='Y' and  contact_hide_flag='N'   "
          End If

          aSQL_String_JETNET_Where = "  amod_customer_flag = 'Y' "

        Else

          If aircraft = True Or originating_type = 3 Then 'aircraft


            If aircraft = True And company = False And contact = False Then
              aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " FROM view_aircraft_flat WITH (NOLOCK) "
            ElseIf aircraft = True And company = True Then
              aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " FROM View_Aircraft_Company_Flat WITH (NOLOCK) "
            ElseIf aircraft = True And contact = True Then
              aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " FROM View_Aircraft_Company_Flat WITH (NOLOCK) "
            Else
              aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " FROM aircraft WITH (NOLOCK) "
              aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " inner JOIN aircraft_reference WITH (NOLOCK) ON aircraft_reference.cref_ac_id = ac_id and cref_journ_id = ac_journ_id "
              aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " inner JOIN company with (NOLOCK) on  aircraft_reference.cref_comp_id = comp_id and cref_journ_id = comp_journ_id "
              aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " inner JOIN aircraft_model WITH (NOLOCK) ON aircraft.ac_amod_id = aircraft_model.amod_id "
              aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " inner JOIN aircraft_contact_type WITH (NOLOCK) ON aircraft_reference.cref_contact_type = aircraft_contact_type.actype_code "

              If contact = True Or originating_type = 2 Then
                aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " left outer join contact with (NOLOCK) on cref_contact_id = contact_id and cref_journ_id = contact_journ_id and contact_active_flag='Y' and contact_hide_flag='N' "
              End If
            End If





          Else 'company or contact based.

            aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " FROM company WITH (NOLOCK) "


            If originating_type = 2 Then
              aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " inner join contact with (NOLOCK) on comp_id = contact_comp_id and comp_journ_id = contact_journ_id and contact_active_flag='Y' and contact_hide_flag='N'   "
            ElseIf contact = True Then
              aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " left outer join contact with (NOLOCK) on comp_id = contact_comp_id and comp_journ_id = contact_journ_id "
            End If


            If aircraft = True Or originating_type = 3 Then 'aircraft
              aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " LEFT OUTER JOIN aircraft_reference WITH (NOLOCK) ON aircraft_reference.cref_comp_id = company.comp_id and cref_journ_id = comp_journ_id "
              aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " LEFT OUTER JOIN aircraft WITH (NOLOCK) ON aircraft.ac_id = aircraft_reference.cref_ac_id and ac_journ_id = cref_journ_id "

              aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " LEFT OUTER JOIN aircraft_contact_type WITH (NOLOCK) ON aircraft_reference.cref_contact_type = aircraft_contact_type.actype_code "
              aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " LEFT OUTER JOIN aircraft_model WITH (NOLOCK) ON aircraft.ac_amod_id = aircraft_model.amod_id"

              'aSQL_String_JETNET_Where = " (Aircraft_Reference.acref_contact_type IN ('00', '97', '08')) "
            ElseIf operator_type <> "" Then
              aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " LEFT OUTER JOIN aircraft_reference with (nolock) "
              aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " on comp_id = cref_comp_id and comp_journ_id = "
              aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " cref_journ_id LEFT OUTER JOIN aircraft with (nolock) on cref_ac_id = "
              aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " ac_id and cref_journ_id = ac_journ_id "

            End If

          End If

          'contact



        End If
        '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
        '-----------------------------------------------------------------The Building of the Where Clause----------------------------------------------------
        '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

        If ID_SQL_IN_JETNET <> "" And originating_type = 1 Then
          If aSQL_String_JETNET_Where <> "" Then
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " and  comp_id in (" & ID_SQL_IN_JETNET & ")"
          Else
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & "  comp_id in (" & ID_SQL_IN_JETNET & ")"
          End If
        End If




        If jetnet_comp_id <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " and  comp_id in (" & jetnet_comp_id & ")"
          Else
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & "  comp_id in (" & jetnet_comp_id & ")"
          End If
        End If

        If ID_SQL_IN_JETNET <> "" And originating_type = 2 Then
          If aSQL_String_JETNET_Where <> "" Then
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " and contact_id in (" & ID_SQL_IN_JETNET & ")"
          Else
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & "  contact_id in (" & ID_SQL_IN_JETNET & ")"
          End If
        End If

        If ID_SQL_IN_JETNET <> "" And originating_type = 3 Then

          If aSQL_String_JETNET_Where <> "" Then
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " and "
          End If

          If aircraftNotesSearch = 2 Then 'The only time this gets called differently is when it's not in (parameter is 2). Otherwise
            'It runs as normal with the folders
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & "  ac_id not in (" & ID_SQL_IN_JETNET & ")"
          Else
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & "  ac_id in (" & ID_SQL_IN_JETNET & ")"
          End If


        End If

        If originating_type = 3 And aircraft = True Then
          If aSQL_String_JETNET_Where <> "" Then
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " and ac_journ_id = 0 "
          Else
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " ac_journ_id = 0 "
          End If
        End If
        If special_field = "" Then
          If comp_name <> "" And comp_name <> "%" And comp_name <> "%%" Then
            If aSQL_String_JETNET_Where <> "" Then
              aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " and comp_name_search LIKE '" & comp_name & "'"
            Else
              aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " comp_name_search LIKE '" & comp_name & "'"
            End If
          End If
        Else
          aSQL_String_Client_Where = " " & special_field & " LIKE '" & comp_name & "'"
        End If
        ' check the country
        If country <> "" And aSQL_String_JETNET_Where <> "" Then
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " AND comp_country = '" & country & "'"
        ElseIf country <> "" Then
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " comp_country = '" & country & "'"
        End If
        ' check the state
        If state <> "" And country <> "" Then
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " AND comp_state IN(" & state & ")"
        ElseIf state <> "" And aSQL_String_JETNET_Where <> "" Then
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " AND comp_state IN(" & state & ")"
        ElseIf state <> "" Then
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " comp_state IN(" & state & ")"
        End If

        If Trim(companyCity) <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            aSQL_String_JETNET_Where += " and "
          End If
          Dim TemporaryOperator As String = "Begins With"
          companyCity = clsGeneral.clsGeneral.CleanUserData(companyCity, Constants.cEmptyString, Constants.cCommaDelim, True)

          If InStr(companyCity, "*") = 0 Then
            aSQL_String_JETNET_Where += " " & "comp_city" & " " & clsGeneral.clsGeneral.PrepQueryString(TemporaryOperator, companyCity, "String", False, "comp_city", True)
          Else
            aSQL_String_JETNET_Where += " " & clsGeneral.clsGeneral.PrepQueryString(TemporaryOperator, companyCity, "String", False, "comp_city", True)
          End If
        End If

        ' check the operator_type 
        'If operator_type <> "" And aSQL_String_JETNET_Where <> "" Then
        '    Select Case operator_type
        '        Case "whole"
        '            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " AND cref_contact_type in ('00')"
        '        Case "all"
        '            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " AND cref_contact_type in ('00','97','08','56', '17')"
        '        Case "operators"
        '            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " and cref_operator_flag ='Y' "
        '            'aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " AND cref_contact_type in ('31','94','11','12', '1P', '36','18','39')"
        '    End Select
        'ElseIf operator_type <> "" Then
        '    Select Case operator_type
        '        Case "whole"
        '            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " cref_contact_type in ('00')"
        '        Case "all"
        '            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " cref_contact_type in ('00','97','08','56', '17')"
        '        Case "operators"
        '            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " cref_operator_flag ='Y' "
        '            '   aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " cref_contact_type in ('31','94','11','12', '1P', '36','18','39')"
        '    End Select
        'End If
        If operator_type <> "" Then
          If aSQL_String_Client_Where <> "" Then
            aSQL_String_JETNET_Where += " and "
          End If
          If operator_type = "all" Then 'all owners
            aSQL_String_JETNET_Where += " cref_contact_type in ('00','08','97','17','99','56')"
          ElseIf operator_type = "whole" Then 'whole owners
            aSQL_String_JETNET_Where += " cref_contact_type in ('56','99', '00')"
          ElseIf operator_type = "fractional" Then 'fractional owners
            aSQL_String_JETNET_Where += " cref_contact_type in ('97','17')"
          ElseIf operator_type = "shared" Then 'shared owners
            aSQL_String_JETNET_Where += " cref_contact_type in ('08')"
          ElseIf operator_type = "operators" Then 'operators
            aSQL_String_JETNET_Where += " cref_operator_flag in ('Y','O') "
          End If
        End If

        If f_name <> "%%" And f_name <> "%" Then
          If aSQL_String_JETNET_Where <> "" Then
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " and contact_first_name LIKE '" & f_name & "'"
          Else
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " contact_first_name LIKE '" & f_name & "'"
          End If

        End If
        If contact_email_address <> "%%" And contact_email_address <> "%" And contact_email_address <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " and (contact_email_address LIKE '" & contact_email_address & "' or comp_email_address LIKE '" & contact_email_address & "')"
          Else
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " (contact_email_address LIKE '" & contact_email_address & "' or comp_email_address LIKE '" & contact_email_address & "')"
          End If

        End If
        If l_name <> "%%" And l_name <> "%" Then
          If aSQL_String_JETNET_Where <> "" Then
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & "  AND  contact_last_name LIKE '" & l_name & "'"
          Else
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " contact_last_name LIKE '" & l_name & "'"
          End If
        End If

        Dim AndQ As String = ""

        If originating_type = 3 Then
          If ownership <> "" Then
            If aSQL_String_JETNET_Where <> "" Then
              aSQL_String_JETNET_Where += " and "
            End If
            aSQL_String_JETNET_Where += " ac_ownership_type in ('" & ownership & "') "
          End If



          If lifecycle <> "" Then
            If aSQL_String_JETNET_Where <> "" Then
              aSQL_String_JETNET_Where += " and "
            End If
            If lifecycle = "4" Then
              aSQL_String_JETNET_Where += " (ac_lifecycle_stage = '4' AND lower(ac_status) <> 'withdrawn from use - stored') "
            ElseIf lifecycle = "5" Then
              aSQL_String_JETNET_Where += " (ac_lifecycle_stage = '4' AND lower(ac_status) = 'withdrawn from use - stored') "
            Else
              aSQL_String_JETNET_Where += " (ac_lifecycle_stage = '" & lifecycle & "') "
            End If
          End If

          If year_start <> "" Then
            If aSQL_String_JETNET_Where <> "" Then
              AndQ = " and "
            Else
              AndQ = ""
            End If
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_mfr_year >= '" & year_start & "' "
          End If

          If year_end <> "" Then
            If aSQL_String_JETNET_Where <> "" Then
              AndQ = " and "
            Else
              AndQ = ""
            End If
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_mfr_year <= '" & year_end & "' "
          End If
        ElseIf originating_type = 8 Then

          If awaiting = "Y" Then
            If aSQL_String_JETNET_Where <> "" Then
              AndQ = " and "
            Else
              AndQ = ""
            End If
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " (journ_subject like '%Awaiting Documentation')  "
          End If


          If internal <> "" Then
            If aSQL_String_JETNET_Where <> "" Then
              AndQ = " and "
            Else
              AndQ = ""
            End If
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " journ_internal_trans_flag = '" & internal & "' "
          End If

          If year_start <> "" Then
            If aSQL_String_JETNET_Where <> "" Then
              AndQ = " and "
            Else
              AndQ = ""
            End If
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_mfr_year >= '" & year_start & "' "
          End If

          If year_end <> "" Then
            If aSQL_String_JETNET_Where <> "" Then
              AndQ = " and "
            Else
              AndQ = ""
            End If
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_mfr_year <= '" & year_end & "' "
          End If
        End If

        If airport_name <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_aport_name like '%" & airport_name & "%' "
        End If

        If on_exclusive <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_exclusive_flag = '" & on_exclusive & "' "
        End If

        If on_lease <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_lease_flag = '" & on_lease & "' "
        End If
        If icao_code <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_aport_icao_code like '%" & icao_code & "%' "
        End If

        If iata_code <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_aport_iata_code like '%" & iata_code & "%' "
        End If

        If ac_city <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_aport_city like '%" & ac_city & "%' "
        End If

        If ac_country <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_aport_country in (" & ac_country & ") "
        End If

        If ac_state <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_aport_state IN(" & ac_state & ") "
        End If


        If jetnet_models <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " amod_id in (" & jetnet_models & ") "
        End If

        If ac_search <> "%" And ac_search <> "%%" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If

          ' If jetnet_models = "" Then
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & "(ac_ser_no like '" & ac_search & "' or ac_ser_no like '" & ac_search & "' or amod_make_name = '" & ac_search & "' or amod_make_name = '" & ac_search & "')"
          'End If

          Select Case market_status
            Case "For Sale"
              aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " and ac_forsale_flag = 'Y'"
            Case "Not For Sale"
              aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " and ac_forsale_flag = 'N'"
            Case "For Sale Exclusive"
              aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " and ac_exclusive_flag = 'Y'"
            Case "Lease"
              aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " and ac_lease_flag = 'Y'"
          End Select
        Else
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If

          Select Case market_status
            Case "For Sale"
              aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_forsale_flag = 'Y'"
            Case "Not For Sale"
              aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_forsale_flag = 'N'"
            Case "For Sale Exclusive"
              aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_exclusive_flag = 'Y'"
            Case "Lease"
              aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_lease_flag = 'Y'"
          End Select
        End If

        'commercial = True
        'helicopter = False
        'jets = False
        'turboprops = True
        If aircraft = True And (company = True Or contact = True) Then
          ' if these are both true, then we will not be needing the journal ids cause we will be using the flat table
        Else


          If originating_type <> 8 Then ' You can't have a journ id as 0 if it's a transaction
            If company = True Then 'filters for company
              If aSQL_String_JETNET_Where <> "" Then
                AndQ = " and "
              Else
                AndQ = ""
              End If

              aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " comp_journ_id = 0 "
            End If
          End If


          If contact = True Then 'filters for contact
            If aSQL_String_JETNET_Where <> "" Then
              AndQ = " and "
            Else
              AndQ = ""
            End If

            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " contact_journ_id = 0 "
          End If

        End If


        If originating_type = 8 Then
          If company = True Then
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " " & Replace(clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(HttpContext.Current.Session.Item("localSubscription"), True, False), "AND comp_active_flag = 'Y'", "")
          End If
          If aircraft = True Then
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(HttpContext.Current.Session.Item("localSubscription"), False, True)

          End If
        End If
        If company = True And originating_type <> 8 Then

          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " " & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(HttpContext.Current.Session.Item("localSubscription"), True, False)

          'If helicopter = True Or business = True Or commercial = True Then
          '    If aSQL_String_JETNET_Where <> "" Then
          '        AndQ = " and "
          '    Else
          '        AndQ = ""
          '    End If
          '    aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ
          'End If

          'If helicopter = True Then
          '    aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " (comp_product_helicopter_flag = 'Y' "
          'End If

          'If business = True Then
          '    If helicopter = True Then
          '        aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " or comp_product_business_flag = 'Y' "
          '    Else
          '        aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " (comp_product_business_flag = 'Y' "
          '    End If
          'End If


          'If commercial = True Then
          '    If helicopter = True Or business = True Then
          '        aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & "or comp_product_commercial_flag = 'Y') "
          '    Else
          '        aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " (comp_product_commercial_flag = 'Y') "
          '    End If
          'Else
          '    If helicopter = True Or business = True Then
          '        aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & ")"
          '    End If
          'End If

        End If


        If aircraft = True Then 'filters for AC

          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " " & clsGeneral.clsGeneral.GenerateProductCodeSelectionQuery_CRM(HttpContext.Current.Session.Item("localSubscription"), False, True)

          'If helicopter = True Or business = True Or commercial = True Then
          '    If aSQL_String_JETNET_Where <> "" Then
          '        AndQ = " and "
          '    Else
          '        AndQ = ""
          '    End If
          '    aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ
          'End If

          'If helicopter = True Then
          '    aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " (ac_product_helicopter_flag = 'Y'  "
          'End If

          'If business = True Then

          '    If helicopter = True Then
          '        aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " or ac_product_business_flag = 'Y' "
          '    Else
          '        aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " ( ac_product_business_flag = 'Y' "
          '    End If


          '    If jets = True Or executive = True Or turboprops = True Then
          '        aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " and ("
          '    End If
          '    If jets = True Then
          '        aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " amod_make_type = 'J' "
          '    End If

          '    If jets <> True And turboprops <> True And executive = True Then
          '        aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " amod_make_type = 'E' "
          '    ElseIf executive = True Then
          '        aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " or amod_make_type = 'E' "
          '    End If

          '    If jets <> True And executive <> True And turboprops = True Then
          '        aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " amod_make_type = 'T' "
          '    ElseIf turboprops = True Then
          '        aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " or amod_make_type = 'T' "
          '    End If


          '    If jets = True Or executive = True Or turboprops = True Then
          '        aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " )"
          '    End If

          'End If
          'If helicopter = True Or business = True Then
          '    If commercial = False Then
          '        aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & ")"
          '    End If
          'End If
          'If commercial = True Then
          '    If helicopter = True Or business = True Then
          '        aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & "or ac_product_commercial_flag = 'Y')"
          '    Else
          '        aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & " (ac_product_commercial_flag = 'Y')"
          '    End If

          'End If
        End If

        If trans_start_date <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " (journ_date >= '" & trans_start_date & "') "
        End If
        If trans_end_date <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " (journ_date <= '" & trans_end_date & "')"
        End If
        If jetnet_transaction_category <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " (journ_subcat_code_part1 = '" & jetnet_transaction_category & "') "
        End If

        If trans_jetnet_model <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_amod_id in(" & trans_jetnet_model & ") "
        End If

        If trans_search <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          If trans_search <> "%%" And trans_search <> "%" Then
            aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ( journ_subject like '" & trans_search & "' or ac_ser_no like '" & trans_search & "' or ac_reg_no like '" & trans_search & "' )"
          End If
        End If

        If Trim(client_ids_to_exclude) <> "" Then
          If aSQL_String_JETNET_Where <> "" Then
            AndQ = " and "
          Else
            AndQ = ""
          End If
          aSQL_String_JETNET_Where = aSQL_String_JETNET_Where & AndQ & " ac_id not in (" & client_ids_to_exclude & ")"
        End If


        Dim sQuery As String = aSQL_String_JETNET_Select & " WHERE " & aSQL_String_JETNET_Where
        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Export_All() as DataTable - Jetnet Side</b><br />" & aSQL_String_JETNET_Select & " WHERE " & aSQL_String_JETNET_Where

        ' If originating_type = 3 Or originating_type = 1 Or originating_type = 2 Then
        Dim SqlConn As New SqlClient.SqlConnection
        Dim SqlCommand As New SqlClient.SqlCommand
        Dim SqlReader As SqlClient.SqlDataReader
        Dim SqlException As SqlClient.SqlException : SqlException = Nothing

        SqlConn.ConnectionString = JETNET_DB

        SqlConn.Open()
        SqlCommand.Connection = SqlConn

        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Export_All() as DataTable - Jetnet Side</b><br />" & aSQL_String_JETNET_Select & " WHERE " & aSQL_String_JETNET_Where

        SqlCommand.CommandType = CommandType.Text
        SqlCommand.CommandTimeout = 60
        SqlCommand.CommandText = sQuery
        SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


        dataSet.EnforceConstraints = False
        atemptable.PrimaryKey = Nothing
        atemptable.Constraints.Clear()


        Try
          atemptable.Load(SqlReader)
        Catch constrExc As System.Data.ConstraintException
          Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
        End Try

        dataSet.EnforceConstraints = False
        SqlReader.Close()
        SqlReader = Nothing

        SqlConn.Dispose()
        SqlConn.Close()
        SqlConn = Nothing

        SqlCommand.Dispose()
        SqlCommand = Nothing
        'End If

      End If ' If (data_subset = "J" Or data_subset = "JC") Then
      dalTable = atemptable.Clone
      dataSet.EnforceConstraints = False
      dalTable.PrimaryKey = Nothing
      dalTable.Constraints.Clear()

      For i = 0 To dalTable.Columns.Count - 1
        If dalTable.Columns(i).DataType.ToString.ToLower = "system.string" Then
          dalTable.Columns(i).MaxLength = 1000
        End If
      Next

      If Trim(order_by_string) <> "" Then
      Else
        order_by_string = first_column & " asc"
      End If

      Dim afiltered_BOTH As DataRow() = atemptable.Select("", order_by_string)

      ' extract and import
      For Each atmpDataRow_JETNET In afiltered_BOTH
        dalTable.ImportRow(atmpDataRow_JETNET)
      Next

      If added_client_id_to_select = True Then
        dalTable.Columns.Remove("cliaircraft_jetnet_ac_id")
      End If


      If dalTable.Columns.Count = 1 Then
        Export_All = CheckDataTableColumn(dalTable)
      Else
        Export_All = dalTable
      End If


      'If originating_type = 8 Then
      'Export_All = New DataTable
      'End If
    Catch ex As Exception
      Export_All = Nothing
      Me.class_error = "Error in Export_All(): " & ex.Message
    End Try
  End Function

  ''' <summary>
  ''' exports the performance and operating costs
  ''' </summary>
  ''' <param name="performance_specs">whether or not performance is being exported</param>
  ''' <param name="operating_costs">whether or not operating costs are exported</param>
  ''' <param name="first_column">First column in export</param>
  ''' <param name="jetnet_fields">Jetnet fields</param>
  ''' <param name="jetnet_ids">jetnet model Ids</param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function View_Exports(ByVal first_column As String, ByVal jetnet_fields As String, ByVal jetnet_ids As String, ByVal performance_specs As Boolean, ByVal operating_costs As Boolean) As String
    'This is going to start out as a very simple function.
    Dim query As String = ""
    Try
      query = "SELECT " & jetnet_fields & " FROM Aircraft_Model WITH(NOLOCK) "
      query = query & " WHERE amod_id IN(" & jetnet_ids & ") "
      Return query
    Catch ex As Exception
      View_Exports = Nothing
      Me.class_error = "Error in SQL View_Exports(ByVal performance_specs As Boolean, ByVal operating_costs As Boolean) As DataTable " & ex.Message
    Finally
      'Make sure every thing is closed in here!!!!!!
    End Try
  End Function
  Private Function CheckDataTableColumn(ByVal dt As DataTable) As DataTable
    Dim flag As Boolean = False
    Dim counter As Integer = 0
[EXIT]:
    Try
      For i As Integer = counter To dt.Columns.Count - 1
        For x As Integer = 0 To dt.Rows.Count - 1
          If String.IsNullOrEmpty(dt.Rows(x)(i).ToString()) Then
            'means there is an empty value
            flag = True
          Else
            'means if it found non null or empty in rows of a particular column
            flag = False
            counter = i + 1
            GoTo [EXIT]
          End If
        Next

        If flag = True Then
          dt.Columns.Remove(dt.Columns(i))
          i -= 1
        End If
      Next
    Catch
      Return dt
    End Try
    Return dt
  End Function
#End Region
#Region "The EVO Export Stuff!"
  'these were created specifically for the page evo_exporter.aspx.vb
  ''' <summary>
  ''' This is a very simple function that's going to return a datatable based on the table
  ''' in the jetnet live database called Custom_Export_Fields.
  ''' SELECT cef_main_group, cef_sub_group, cef_display, cef_evo_field_name
  '''FROM Custom_Export_Fields WITH (NOLOCK)
  '''WHERE (cef_evo_flag = 'Y')
  '''ORDER BY cef_main_group, cef_sub_group, cef_sort, cef_display
  ''' </summary>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Fill_Available_Data_Fields(ByVal tab As String) As DataTable
    Dim jetnet_query As String = ""
    Dim temptable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try
      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      jetnet_query = "SELECT distinct cef_main_group "
      jetnet_query = jetnet_query & " FROM Custom_Export_Fields WITH (NOLOCK) "
      jetnet_query = jetnet_query & " WHERE (cef_evo_flag = 'Y')"

      If tab <> "" Then
        jetnet_query = jetnet_query & " and cef_export_tab = '" & tab & "' "
      End If
      jetnet_query = jetnet_query & "  and cef_evo_field_name <> '' "
      jetnet_query = jetnet_query & " ORDER BY cef_main_group "

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Fill_Available_Data_Fields As DataTable</b><br />" & jetnet_query

      SqlCommand.CommandText = jetnet_query
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        temptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = temptable.GetErrors()
      End Try

      Return temptable
    Catch ex As Exception
      Fill_Available_Data_Fields = Nothing
      Me.class_error = "Error in Fill_Available_Data_Fields: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function



  '    select webrep_title from Web_Report
  'where webrep_area = 'Aircraft'
  'and webrep_status='Y'
  'order by webrep_title
  Public Function Fill_Common_Exports(ByVal tab As String) As DataTable
    Dim jetnet_query As String = ""
    Dim temptable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try
      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      'jetnet_query = "select webrep_title "
      ' jetnet_query = jetnet_query & " FROM Web_Report WITH (NOLOCK) "
      ' jetnet_query = jetnet_query & " WHERE (webrep_status = 'Y')"



      jetnet_query = " select sise_subject, sise_description, sise_id "
      jetnet_query = jetnet_query & "from subscription_install_saved_exports WITH (NOLOCK) "
      jetnet_query = jetnet_query & "where sise_sub_id = '6266' AND sise_login = 'exporttemplates'  "
      jetnet_query = jetnet_query & "and sise_seq_no = '1' "
      If Trim(tab) <> "" Then
        jetnet_query = jetnet_query & "and sise_tab = '" & Trim(tab) & "' "
      End If
      jetnet_query = jetnet_query & " ORDER BY sise_id desc "


      '    If tab <> "" Then
      'jetnet_query = jetnet_query & " and webrep_area = '" & tab & "' "
      '   End If



      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Fill_Common_Exports</b><br />" & jetnet_query

      SqlCommand.CommandText = jetnet_query
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        temptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = temptable.GetErrors()
      End Try

      Return temptable
    Catch ex As Exception
      Fill_Common_Exports = Nothing
      Me.class_error = "Error in Fill_Common_Exports: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function

  'these were created specifically for the page evo_exporter.aspx.vb
  ''' <summary>
  ''' This is a very simple function that's going to return a datatable based on the table
  ''' in the jetnet live database called Custom_Export_Fields.
  ''' SELECT cef_main_group, cef_sub_group, cef_display, cef_evo_field_name
  '''FROM Custom_Export_Fields WITH (NOLOCK)
  '''WHERE (cef_evo_flag = 'Y')
  '''ORDER BY cef_main_group, cef_sub_group, cef_sort, cef_display
  ''' </summary>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Fill_Available_Data_Fields_Based_On_Main_Group(ByVal cef_main_section As String, ByVal summary As Boolean, ByVal isaerodex As Boolean) As DataTable
    Dim jetnet_query As String = ""
    Dim temptable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try
      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      'jetnet_query = "SELECT distinct cef_sub_group_sort, cef_sub_group "
      'jetnet_query = jetnet_query & " FROM Custom_Export_Fields WITH (NOLOCK) "
      'jetnet_query = jetnet_query & " WHERE (cef_evo_flag = 'Y')"

      'If summary = True Then
      '    jetnet_query = jetnet_query & " and cef_sub_total_flag='Y' "
      'End If

      'If cef_main_group <> "" Then
      '    jetnet_query = jetnet_query & " and cef_main_group = '" & cef_main_group & "' "
      'End If

      'If tab <> "" Then
      '    jetnet_query = jetnet_query & " and cef_export_tab = '" & tab & "' "
      'End If
      'jetnet_query = jetnet_query & " and cef_evo_field_name <> '' "

      'jetnet_query = jetnet_query & " order by cef_sub_group_sort, cef_sub_group"



      jetnet_query = " select distinct cefstab_id ,cefstab_main_name, cefstab_sub_name, cefstab_order "
      jetnet_query = jetnet_query & "  from custom_export_tab  with (NOLOCK)  "
      jetnet_query = jetnet_query & "  inner join Custom_Export_Fields with (NOLOCK) on cefstab_id = cef_export_tab_id"
      ' aircraft history and events tabs allow aircraft based criteria 

      If Trim(cef_main_section) = "YACHTEVENTS" Then
        jetnet_query = jetnet_query & " where (cefstab_main_name = 'Yacht' or cefstab_main_name = 'Yacht Events') "
      ElseIf Trim(cef_main_section) = "YACHTHISTORY" Then
        jetnet_query = jetnet_query & " where (cefstab_main_name = 'Yacht' or cefstab_main_name = 'Yacht History') "
      ElseIf Trim(LCase(cef_main_section)) = "aircraft" Or Trim(LCase(cef_main_section)) = "history" Or Trim(LCase(cef_main_section)) = "events" Then
        jetnet_query = jetnet_query & " where cefstab_main_name = 'Aircraft' "

        If Trim(LCase(cef_main_section)) <> "aircraft" Then
          jetnet_query = jetnet_query & " or cefstab_main_name = '" & cef_main_section & "' "
        End If
      ElseIf Trim(LCase(cef_main_section)) <> "aircraft" Then
        jetnet_query = jetnet_query & " where cefstab_main_name = '" & cef_main_section & "' "
      End If

      If isaerodex = True Then
        jetnet_query = jetnet_query & " and cef_product_aerodex_flag='Y' "
      End If

      jetnet_query = jetnet_query & " order by cefstab_order "


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Fill_Available_Data_Fields_Based_On_Main_Group</b><br />" & jetnet_query

      SqlCommand.CommandText = jetnet_query
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        temptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = temptable.GetErrors()
      End Try

      Return temptable
    Catch ex As Exception
      Fill_Available_Data_Fields_Based_On_Main_Group = Nothing
      Me.class_error = "Error in Fill_Available_Data_Fields_Based_On_Main_Group: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function


  'these were created specifically for the page evo_exporter.aspx.vb
  ''' <summary>
  ''' This is a very simple function that's going to return a datatable based on the table
  ''' in the jetnet live database called Custom_Export_Fields.
  ''' SELECT cef_main_group, cef_sub_group, cef_display, cef_evo_field_name
  '''FROM Custom_Export_Fields WITH (NOLOCK)
  '''WHERE (cef_evo_flag = 'Y')
  '''ORDER BY cef_main_group, cef_sub_group, cef_sort, cef_display
  ''' </summary>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Fill_Available_Data_Fields_Based_On_Sub_Group(ByVal cef_sub_group As String, ByVal summary As Boolean, ByVal tab As String, ByVal header_name As String, ByVal report_id As Long, ByVal is_aerodex As Boolean) As DataTable
    Dim jetnet_query As String = ""
    Dim temptable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try
      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      'jetnet_query = "SELECT cef_id, cef_display, cef_header_field_name, cef_evo_field_name, cef_main_group "
      'jetnet_query = jetnet_query & " FROM Custom_Export_Fields WITH (NOLOCK) "
      'jetnet_query = jetnet_query & " WHERE (cef_evo_flag = 'Y')"

      'If summary = True Then
      '    jetnet_query = jetnet_query & " and cef_sub_total_flag='Y' "
      'End If

      'If cef_sub_group <> "" Then
      '    jetnet_query = jetnet_query & " and cef_sub_group = '" & cef_sub_group & "' "
      'End If

      'If cef_main_group <> "" Then
      '    jetnet_query = jetnet_query & " and cef_main_group = '" & cef_main_group & "' "
      'End If

      'If header_name <> "" Then
      '    jetnet_query = jetnet_query & " and cef_header_field_name = '" & header_name & "' "
      'End If


      'If tab <> "" Then
      '    jetnet_query = jetnet_query & " and cef_export_tab = '" & tab & "' "
      'End If
      'jetnet_query = jetnet_query & " and cef_evo_field_name <> '' "
      'jetnet_query = jetnet_query & " ORDER BY cef_sort, cef_display"


      jetnet_query = " select cef_display, cef_id, cef_client_field_name, cef_evo_field_name, cef_main_group, cef_header_field_name"
      jetnet_query = jetnet_query & " from Custom_Export_Fields "
      jetnet_query = jetnet_query & " INNER JOIN Custom_Export_Block on cef_export_block_id = cefsblk_id "
      jetnet_query = jetnet_query & " where cef_evo_field_name <> '' "


      '?	NOT THAT THE LINE BELOW MAY HAVE ONE OR MANY TAB ID’S
      If Trim(cef_sub_group) <> "" Then
        jetnet_query = jetnet_query & " and cef_export_tab_id in (" & cef_sub_group & ") "
      End If

      ' If Trim(header_name) <> "" Then
      'jetnet_query = jetnet_query & " and cef_header_field_name = '" & header_name & "' "
      '   End If


      If is_aerodex = True Then
        jetnet_query = jetnet_query & " and cef_product_aerodex_flag='Y' "
      End If

      If summary = True Then
        jetnet_query = jetnet_query & " and cef_sub_total_flag='Y' "
      End If

      If report_id > 0 Then
        jetnet_query = jetnet_query & " and cef_id = " & report_id & " "
      End If

      If Trim(UCase(tab)) = "HISTORY" Then
        jetnet_query = jetnet_query & " and cef_id not in (1192,1193, 1194)  "  ' parent company information 
      End If

      jetnet_query = jetnet_query & " and cef_id not in (1109,316, 1112,247,250)  "  ' 247 and 250 are interior and exterior moyear

      '   If Trim(tab) <> "History" Then
      '     jetnet_query = jetnet_query & " and cef_id <> 1024 "
      '   End If

      'if we are not in history, dont include 1183 which is current company phone number - 5/20/19
      If Trim(tab) <> "HISTORY" Then
        jetnet_query = jetnet_query & " and cef_id <> 1183 "
      End If


      ' IF WE ARE ON THE HISTORY TAB - THEN MAKE SURE WE DO THIS - SWITCH PHONE NUMBERS
      If Trim(tab) = "HISTORY" Then
        jetnet_query = jetnet_query & " and cef_id not in (12,16,17,1181) "    ' current number removal
        jetnet_query = jetnet_query & " and cef_id not in (18,19,20) "    '  contact number removal
      Else
        jetnet_query = jetnet_query & " and cef_id not in (1183,1197,1198,1199) "   ' making sure the ones labeled ' current ' are not in the listing 
        jetnet_query = jetnet_query & " and cef_id not in (1200, 1201,1202) "    ' dont include the "current" contact data 
      End If




      jetnet_query = jetnet_query & " order by cefsblk_order, cef_sort "


      '

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Fill_Available_Data_Fields_Based_On_Sub_Group</b><br />" & jetnet_query

      SqlCommand.CommandText = jetnet_query
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        temptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = temptable.GetErrors()
      End Try

      Return temptable
    Catch ex As Exception
      Fill_Available_Data_Fields_Based_On_Sub_Group = Nothing
      Me.class_error = "Error in Fill_Available_Data_Fields_Based_On_Sub_Group: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function

  '''' <summary>
  ''''Function that drives the export Process for company, contact, aircraft, transaction
  '''' </summary>
  '''' <param name="first_column">column sorted by</param>
  '''' <param name="client_string">since the export fields are dynamic, here's the sql client string generated by the client,
  '''' meaning fields selected</param>
  '''' <param name="jetnet_string">since the export fields are dynamic, here's the sql jetnet string generated by the client,
  '''' meaning fields selected</param>
  '''' <param name="company">Company boolean, company info being exported?</param>
  '''' <param name="contact">Contact Boolean, contact information being exported?</param>
  '''' <param name="aircraft">Aircraft boolean, ac information being exported?</param>
  '''' <param name="transaction">Transaction boolean, transaction information being exported?</param>
  '''' <param name="data_subset">Subset of data we're exporting, jetnet, client, both?</param>
  '''' <param name="special_field">Special field for company information used</param>
  '''' <param name="special_field_txt">Special field search</param>
  '''' <param name="comp_name">Company Name</param>
  '''' <param name="status">Status for client side, Y/N?</param>
  '''' <param name="country">Country for company</param>
  '''' <param name="state">State for company</param>
  '''' <param name="operator_type">Type of Operators included in export</param>
  '''' <param name="include_phone">Include phones in export?</param>
  '''' <param name="f_name">First Name for contact</param>
  '''' <param name="l_name">Last Name for contact</param>
  '''' <param name="originating_type">LISTING ID That the export originates from.. What type of export 
  '''' is it oringally? Like an export of an aircraft that's exporting ac contacts. Aircraft is the originator.</param>
  '''' <param name="ac_search">Aircraft Search text</param>
  '''' <param name="market_status">Aircraft Market Status</param>
  '''' <param name="airport_name">Airport Name for Aircraft</param>
  '''' <param name="icao_code">ICAO code for ac</param>
  '''' <param name="iata_code">IATA Code for ac</param>
  '''' <param name="ac_city">Aircraft airport city</param>
  '''' <param name="ac_country">Aircraft airport country</param>
  '''' <param name="ac_state">Aircraft airport State</param>
  '''' <param name="ac_owners">Aircraft types of owners</param>
  '''' <param name="client_models">Client Model IDs for Airports</param>
  '''' <param name="jetnet_models">Jetnet Model IDs for Airports</param>
  '''' <param name="on_exclusive">On Exclusive Flag for Aircraft</param>
  '''' <param name="on_lease">On Lease Flag for Aircraft</param>
  '''' <param name="trans_search">Transaction Search Term</param>
  '''' <param name="trans_jetnet_model">Transaction Jetnet Model IDs</param>
  '''' <param name="trans_client_model">Transaction Client Model IDs</param>
  '''' <param name="trans_trans_type">Type of Transaction</param>
  '''' <param name="trans_start_date">Transaction Start Date</param>
  '''' <param name="trans_end_date">Transaction End Date</param>
  '''' <param name="year_start">Year Start - Aircraft Transaction year_mfr</param>
  '''' <param name="year_end">Year End - Aircraft/Transaction year_mfr</param>
  '''' <param name="internal">Internal Transactions Flag</param>
  '''' <param name="awaiting">Awaiting TransactionsFlag</param>
  '''' <returns></returns>
  '''' <remarks></remarks>
  Public Function Export_Evo(ByVal first_column As String, ByVal client_string As String, ByVal jetnet_string As String, ByVal company As Boolean, ByVal contact As Boolean, ByVal aircraft As Boolean, ByVal transaction As Boolean, ByVal data_subset As String, ByVal comp_name As String, ByVal status As String, ByVal country As String, ByVal state As String, ByVal operator_type As String, ByVal include_phone As Boolean, ByVal f_name As String, ByVal l_name As String, ByVal originating_type As Integer, ByVal ac_search As String, ByVal market_status As String, ByVal airport_name As String, ByVal icao_code As String, ByVal iata_code As String, ByVal ac_city As String, ByVal ac_country As String, ByVal ac_state As String, ByVal ac_owners As String, ByVal client_models As String, ByVal jetnet_models As String, ByVal on_exclusive As String, ByVal on_lease As String, ByVal trans_search As String, ByVal trans_jetnet_model As String, ByVal trans_client_model As String, ByVal trans_trans_type As String, ByVal trans_start_date As String, ByVal trans_end_date As String, ByVal year_start As String, ByVal year_end As String, ByVal internal As String, ByVal awaiting As String, ByVal group_by As String, ByVal summary As Boolean, ByVal is_comp_needed As String, ByVal order_by_string As String, ByVal info_to_export As ListBox, ByVal tab As String, ByVal current_history As String, Optional ByVal is_count As Boolean = False) As DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim replace_string As String = ""

    Try
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText = ""
      ' create the Select Strings

      Dim aSQL_String_JETNET_Select As String = ""
      ' create the Where string
      Dim aSQL_String_JETNET_Where As String = ""
      ' create a data table to hold the company info
      Dim dalTable As New DataTable
      Dim atemptable As New DataTable
      Dim atemptable2 As New DataTable
      Dim dataSet As DataSet = New DataSet("dataSet")
      Dim i As Integer = 0
      dataSet.Tables.Add(atemptable)
      dataSet.Tables.Add(atemptable2)
      dataSet.Tables.Add(dalTable)
      dataSet.EnforceConstraints = False
      Dim splitstring As Array
      Dim transaction_category As Array = Split(trans_trans_type, "|")
      Dim jetnet_transaction_category As String = ""
      Dim lease_start_date_sub As String = ""
      Dim must_be_leased As Boolean = False

      If UBound(transaction_category) = 1 Then
        jetnet_transaction_category = transaction_category(1)
      End If

      If Trim(UCase(tab)) = "HISTORY" Then
        If InStr(jetnet_string, "DATEDIFF(D,AC_LIST_DATE,GETDATE())") > 0 Then
          jetnet_string = Replace(jetnet_string, "DATEDIFF(D,AC_LIST_DATE,GETDATE())", "DATEDIFF(D,AC_LIST_DATE, JOURN_DATE)")
        End If
      End If

      ' HttpContext.Current.Session.Item("MasterAircraftSelect").ToString = ""
      '  HttpContext.Current.Session.Item("MasterAircraftFrom").ToString = ""
      '  HttpContext.Current.Session.Item("MasterAircraftWhere").ToString = ""
      '  HttpContext.Current.Session.Item("MasterAircraftSort").ToString = ""


      If IsNothing(HttpContext.Current.Session.Item("MasterAircraftEventsWhere")) Then
        HttpContext.Current.Session.Item("MasterAircraftEventsWhere") = ""
      End If

      If InStr(jetnet_string, "AC_SER_NO_FULL AS") > 0 Then
        jetnet_string = Replace(jetnet_string, "AC_SER_NO_FULL AS", "';.;' + AC_SER_NO_FULL AS")
      End If

      If Trim(UCase(tab)) = "HISTORY" Then
        jetnet_string = Replace(jetnet_string, "LEASE_START_DATE", "journ_date")
      ElseIf InStr(jetnet_string, "LEASE_START_DATE") > 0 Then
        must_be_leased = True
        lease_start_date_sub &= " (select top 1 journ_date from Journal with (NOLOCK) "
        lease_start_date_sub &= " inner join Journal_Category with (NOLOCK) on jcat_subcategory_code  = journ_subcategory_code "
        lease_start_date_sub &= " where journ_ac_id = ac_id "
        lease_start_date_sub &= " and jcat_subcategory_transtype in ('Lease','Lease Internal', 'Helo Lease', 'Commercial A/C Lease') order by journ_date desc) "

        jetnet_string = Replace(jetnet_string, "LEASE_START_DATE", lease_start_date_sub)
      End If

      If InStr(jetnet_string, "EXTERNAL_LAV ") > 0 Then
        jetnet_string = Replace(jetnet_string, "EXTERNAL_LAV ", "(case when  (select top 1 adet_data_description FROM Aircraft_Details with (NOLOCK) WHERE (((Aircraft_Details.adet_data_description LIKE '%external%service%') AND (Aircraft_Details.adet_data_name = 'Lavatory')) or  (Aircraft_Details.adet_data_description LIKE '%external lav service%') ) AND (Aircraft_Details.adet_journ_id = 0) and (Aircraft_Details.adet_ac_id = VIEW_AIRCRAFT_FLAT.ac_id)) is not null then 'Yes' else 'No' end)")
      End If

      If InStr(jetnet_string, "AC_LIST_DATE ") > 0 Then
        jetnet_string = Replace(jetnet_string, "AC_LIST_DATE ", "  ('  ' + cast(CAST(AC_LIST_DATE AS DATE) as varchar(20))) ")
      End If

      ' aSQL_String_JETNET_Select = HttpContext.Current.Session.Item("MasterAircraftSelect").ToString()

      If Trim(UCase(tab)) = "YACHT" Then
        If is_count Then
          ' if only counting, replace the subselect for manufacturer
          jetnet_string = Replace(UCase(jetnet_string), UCase("(select comp_name from Company where comp_id = ym_mfr_comp_id and comp_journ_id = 0)"), "")

          If InStr(UCase(jetnet_string), "COMP") > 0 Then
            aSQL_String_JETNET_Select = "SELECT  count(distinct yr_id) as tcount "
          Else
            aSQL_String_JETNET_Select = "SELECT  count(distinct yt_id) as tcount "
          End If
        Else
          aSQL_String_JETNET_Select = "SELECT DISTINCT "

          aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & jetnet_string
        End If
      Else
        If is_count Then
          aSQL_String_JETNET_Select = "SELECT "
          aSQL_String_JETNET_Select += " count(*) as tcount "
        Else
          aSQL_String_JETNET_Select = "SELECT DISTINCT "

          aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & jetnet_string
        End If
      End If


      ' If Trim(is_comp_needed) = "Y" Then
      'aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " from View_Aircraft_Company_Flat "
      ' Else
      '     aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " from View_Aircraft_Flat "
      ' End If
      'View_Aircraft_History_Flat



      'aircraft_company_history_flat
      If Trim(UCase(tab)) = "YACHT" Or Trim(UCase(tab)) = "YACHTHISTORY" Then


        If InStr(aSQL_String_JETNET_Select, "YT_HULL_MFR_NBR ") > 0 Then
          aSQL_String_JETNET_Select = Replace(aSQL_String_JETNET_Select, "YT_HULL_MFR_NBR ", "'&nbsp;' + YT_HULL_MFR_NBR + ''")
        End If


        If Not IsNothing(HttpContext.Current.Session.Item("MasterYachtFrom")) Then
          If Trim(HttpContext.Current.Session.Item("MasterYachtFrom").ToString()) <> "" Then
            aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & Trim(HttpContext.Current.Session.Item("MasterYachtFrom").ToString())
          Else
            aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " from Yacht WITH(NOLOCK) "
            aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " inner join Yacht_Model WITH(NOLOCK) on ym_model_id = yt_model_id "
          End If

          aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & HttpContext.Current.Session.Item("MasterYachtWhere").ToString()
        End If

        'aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " inner join yacht_category_size on  ycs_motor_type = ym_motor_type and ycs_category_size = ym_category_size "
        'aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " inner join yacht_motor_type on  ymt_motor_type = ym_motor_type  "
        'aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " inner join yacht_classification_society_types on ycst_code = yt_class_id  "



      ElseIf Trim(UCase(tab)) = "YACHTEVENTS" Then

        If Not IsNothing(HttpContext.Current.Session.Item("MasterYachtEventsFrom")) Then
          If Trim(HttpContext.Current.Session.Item("MasterYachtEventsFrom").ToString()) <> "" Then
            If Trim(HttpContext.Current.Session.Item("MasterYachtEventsFrom").ToString()) <> "" Then
              aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & Trim(HttpContext.Current.Session.Item("MasterYachtEventsFrom").ToString())
              aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & HttpContext.Current.Session.Item("MasterYachtEventsWhere").ToString()
            End If
          End If
        End If



        'else if there is a comp_ cref_ or contact_ in the select list then there must be View_Aircraft_Company_Flat
      ElseIf (InStr(UCase(jetnet_string), "COMP_") > 0 Or InStr(UCase(jetnet_string), "CREF_") > 0 Or InStr(UCase(jetnet_string), "CONTACT_") > 0 Or InStr(UCase(jetnet_string), "ACTYPE_NAME") > 0) And (Trim(UCase(tab)) = "HISTORY" Or Trim(UCase(tab)) = "AIRCRAFT") Then



        If Trim(UCase(tab)) = "HISTORY" Then
          aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " from View_Aircraft_Company_History_Flat WITH(NOLOCK) "

          aSQL_String_JETNET_Select = Replace(aSQL_String_JETNET_Select, "VIEW_AIRCRAFT_FLAT", "View_Aircraft_Company_History_Flat")

          ' check to see if there is a this in the where clause, if so, its using out used search
          If InStr(HttpContext.Current.Session.Item("MasterAircraftWhere").ToString, "View_Aircraft_History_Flat") > 0 Then
            aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & Replace(HttpContext.Current.Session.Item("MasterAircraftWhere").ToString(), "View_Aircraft_History_Flat", "View_Aircraft_Company_History_Flat")
          Else
            aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & HttpContext.Current.Session.Item("MasterAircraftWhere").ToString()
          End If


        ElseIf Trim(UCase(tab)) = "AIRCRAFT" Then


          replace_string = ""

          If InStr(UCase(aSQL_String_JETNET_Select), "(SELECT TOP 1 ADOC_DOC_DATE FROM COMPANY WITH (NOLOCK)INNER JOIN AIRCRAFT_DOCUMENT WITH (NOLOCK) ON ADOC_INFAVOR_COMP_ID = COMP_ID AND ADOC_JOURN_ID = COMP_JOURN_ID WHERE (ADOC_AC_ID = AC_ID) AND (ADOC_INFAVOR_COMP_ID IS NOT NULL) AND (ADOC_DOC_DATE >= AC_PURCHASE_DATE) AND (ADOC_ONBEHALF_COMP_ID IN (SELECT CREF_COMP_ID FROM AIRCRAFT_REFERENCE WITH (NOLOCK)WHERE (CREF_AC_ID = AC_ID) AND (CREF_JOURN_ID = AC_JOURN_ID) AND (CREF_TRANSMIT_SEQ_NO = 1) )) ORDER BY ADOC_DOC_DATE DESC) AS ""DOCDATE""") Then
            aSQL_String_JETNET_Select = Replace(aSQL_String_JETNET_Select, ",(SELECT TOP 1 ADOC_DOC_DATE FROM COMPANY WITH (NOLOCK)INNER JOIN AIRCRAFT_DOCUMENT WITH (NOLOCK) ON ADOC_INFAVOR_COMP_ID = COMP_ID AND ADOC_JOURN_ID = COMP_JOURN_ID WHERE (ADOC_AC_ID = AC_ID) AND (ADOC_INFAVOR_COMP_ID IS NOT NULL) AND (ADOC_DOC_DATE >= AC_PURCHASE_DATE) AND (ADOC_ONBEHALF_COMP_ID IN (SELECT CREF_COMP_ID FROM AIRCRAFT_REFERENCE WITH (NOLOCK)WHERE (CREF_AC_ID = AC_ID) AND (CREF_JOURN_ID = AC_JOURN_ID) AND (CREF_TRANSMIT_SEQ_NO = 1) )) ORDER BY ADOC_DOC_DATE DESC) AS ""DOCDATE""", "")
            If Trim(replace_string) <> "" Then
              replace_string &= ", "
            End If
            replace_string &= "(SELECT TOP 1 ADOC_DOC_DATE FROM COMPANY WITH (NOLOCK)INNER JOIN AIRCRAFT_DOCUMENT WITH (NOLOCK) ON ADOC_INFAVOR_COMP_ID = COMP_ID AND ADOC_JOURN_ID = COMP_JOURN_ID WHERE (ADOC_AC_ID = AC_ID) AND (ADOC_INFAVOR_COMP_ID IS NOT NULL) AND (ADOC_DOC_DATE >= AC_PURCHASE_DATE) AND (ADOC_ONBEHALF_COMP_ID IN (SELECT CREF_COMP_ID FROM AIRCRAFT_REFERENCE WITH (NOLOCK)WHERE (CREF_AC_ID = AC_ID) AND (CREF_JOURN_ID = AC_JOURN_ID) AND (CREF_TRANSMIT_SEQ_NO = 1) )) ORDER BY ADOC_DOC_DATE DESC) AS ""DOCDATE"""
          End If

          If InStr(UCase(aSQL_String_JETNET_Select), "(SELECT TOP 1 ADOC_DOC_TYPE FROM COMPANY WITH (NOLOCK)INNER JOIN AIRCRAFT_DOCUMENT WITH (NOLOCK) ON ADOC_INFAVOR_COMP_ID = COMP_ID AND ADOC_JOURN_ID = COMP_JOURN_ID WHERE (ADOC_AC_ID = AC_ID) AND (ADOC_INFAVOR_COMP_ID IS NOT NULL) AND (ADOC_DOC_DATE >= AC_PURCHASE_DATE) AND (ADOC_ONBEHALF_COMP_ID IN (SELECT CREF_COMP_ID FROM AIRCRAFT_REFERENCE WITH (NOLOCK)WHERE (CREF_AC_ID = AC_ID) AND (CREF_JOURN_ID = AC_JOURN_ID) AND (CREF_TRANSMIT_SEQ_NO = 1) )) ORDER BY ADOC_DOC_DATE DESC) AS ""DOCTYPE""") Then
            aSQL_String_JETNET_Select = Replace(aSQL_String_JETNET_Select, ",(SELECT TOP 1 ADOC_DOC_TYPE FROM COMPANY WITH (NOLOCK)INNER JOIN AIRCRAFT_DOCUMENT WITH (NOLOCK) ON ADOC_INFAVOR_COMP_ID = COMP_ID AND ADOC_JOURN_ID = COMP_JOURN_ID WHERE (ADOC_AC_ID = AC_ID) AND (ADOC_INFAVOR_COMP_ID IS NOT NULL) AND (ADOC_DOC_DATE >= AC_PURCHASE_DATE) AND (ADOC_ONBEHALF_COMP_ID IN (SELECT CREF_COMP_ID FROM AIRCRAFT_REFERENCE WITH (NOLOCK)WHERE (CREF_AC_ID = AC_ID) AND (CREF_JOURN_ID = AC_JOURN_ID) AND (CREF_TRANSMIT_SEQ_NO = 1) )) ORDER BY ADOC_DOC_DATE DESC) AS ""DOCTYPE""", "")
            If Trim(replace_string) <> "" Then
              replace_string &= ", "
            End If
            replace_string &= "(SELECT TOP 1 ADOC_DOC_TYPE FROM COMPANY WITH (NOLOCK)INNER JOIN AIRCRAFT_DOCUMENT WITH (NOLOCK) ON ADOC_INFAVOR_COMP_ID = COMP_ID AND ADOC_JOURN_ID = COMP_JOURN_ID WHERE (ADOC_AC_ID = AC_ID) AND (ADOC_INFAVOR_COMP_ID IS NOT NULL) AND (ADOC_DOC_DATE >= AC_PURCHASE_DATE) AND (ADOC_ONBEHALF_COMP_ID IN (SELECT CREF_COMP_ID FROM AIRCRAFT_REFERENCE WITH (NOLOCK)WHERE (CREF_AC_ID = AC_ID) AND (CREF_JOURN_ID = AC_JOURN_ID) AND (CREF_TRANSMIT_SEQ_NO = 1) )) ORDER BY ADOC_DOC_DATE DESC) AS ""DOCTYPE"""
          End If

          If InStr(UCase(aSQL_String_JETNET_Select), "(SELECT TOP 1 ADOC_DOC_AMOUNT FROM COMPANY WITH (NOLOCK)INNER JOIN AIRCRAFT_DOCUMENT WITH (NOLOCK) ON ADOC_INFAVOR_COMP_ID = COMP_ID AND ADOC_JOURN_ID = COMP_JOURN_ID WHERE (ADOC_AC_ID = AC_ID) AND (ADOC_INFAVOR_COMP_ID IS NOT NULL) AND (ADOC_DOC_DATE >= AC_PURCHASE_DATE) AND (ADOC_ONBEHALF_COMP_ID IN (SELECT CREF_COMP_ID FROM AIRCRAFT_REFERENCE WITH (NOLOCK)WHERE (CREF_AC_ID = AC_ID) AND (CREF_JOURN_ID = AC_JOURN_ID) AND (CREF_TRANSMIT_SEQ_NO = 1) )) ORDER BY ADOC_DOC_DATE DESC)  AS ""DOCAMOUNT""") Then
            aSQL_String_JETNET_Select = Replace(aSQL_String_JETNET_Select, ",(SELECT TOP 1 ADOC_DOC_AMOUNT FROM COMPANY WITH (NOLOCK)INNER JOIN AIRCRAFT_DOCUMENT WITH (NOLOCK) ON ADOC_INFAVOR_COMP_ID = COMP_ID AND ADOC_JOURN_ID = COMP_JOURN_ID WHERE (ADOC_AC_ID = AC_ID) AND (ADOC_INFAVOR_COMP_ID IS NOT NULL) AND (ADOC_DOC_DATE >= AC_PURCHASE_DATE) AND (ADOC_ONBEHALF_COMP_ID IN (SELECT CREF_COMP_ID FROM AIRCRAFT_REFERENCE WITH (NOLOCK)WHERE (CREF_AC_ID = AC_ID) AND (CREF_JOURN_ID = AC_JOURN_ID) AND (CREF_TRANSMIT_SEQ_NO = 1) )) ORDER BY ADOC_DOC_DATE DESC)  AS ""DOCAMOUNT""", "")
            If Trim(replace_string) <> "" Then
              replace_string &= ", "
            End If
            replace_string &= "(SELECT TOP 1 ADOC_DOC_AMOUNT FROM COMPANY WITH (NOLOCK)INNER JOIN AIRCRAFT_DOCUMENT WITH (NOLOCK) ON ADOC_INFAVOR_COMP_ID = COMP_ID AND ADOC_JOURN_ID = COMP_JOURN_ID WHERE (ADOC_AC_ID = AC_ID) AND (ADOC_INFAVOR_COMP_ID IS NOT NULL) AND (ADOC_DOC_DATE >= AC_PURCHASE_DATE) AND (ADOC_ONBEHALF_COMP_ID IN (SELECT CREF_COMP_ID FROM AIRCRAFT_REFERENCE WITH (NOLOCK)WHERE (CREF_AC_ID = AC_ID) AND (CREF_JOURN_ID = AC_JOURN_ID) AND (CREF_TRANSMIT_SEQ_NO = 1) )) ORDER BY ADOC_DOC_DATE DESC)  AS ""DOCAMOUNT"""
          End If

          If InStr(UCase(aSQL_String_JETNET_Select), "(SELECT TOP 1 COMP_NAME FROM COMPANY WITH (NOLOCK)INNER JOIN AIRCRAFT_DOCUMENT WITH (NOLOCK) ON ADOC_INFAVOR_COMP_ID = COMP_ID AND ADOC_JOURN_ID = COMP_JOURN_ID WHERE (ADOC_AC_ID = AC_ID) AND (ADOC_INFAVOR_COMP_ID IS NOT NULL) AND (ADOC_DOC_DATE >= AC_PURCHASE_DATE) AND (ADOC_ONBEHALF_COMP_ID IN (SELECT CREF_COMP_ID FROM AIRCRAFT_REFERENCE WITH (NOLOCK)WHERE (CREF_AC_ID = AC_ID) AND (CREF_JOURN_ID = AC_JOURN_ID) AND (CREF_TRANSMIT_SEQ_NO = 1) )) ORDER BY ADOC_DOC_DATE DESC)  AS ""DOCINFAVOR""") Then
            aSQL_String_JETNET_Select = Replace(aSQL_String_JETNET_Select, ",(SELECT TOP 1 COMP_NAME FROM COMPANY WITH (NOLOCK)INNER JOIN AIRCRAFT_DOCUMENT WITH (NOLOCK) ON ADOC_INFAVOR_COMP_ID = COMP_ID AND ADOC_JOURN_ID = COMP_JOURN_ID WHERE (ADOC_AC_ID = AC_ID) AND (ADOC_INFAVOR_COMP_ID IS NOT NULL) AND (ADOC_DOC_DATE >= AC_PURCHASE_DATE) AND (ADOC_ONBEHALF_COMP_ID IN (SELECT CREF_COMP_ID FROM AIRCRAFT_REFERENCE WITH (NOLOCK)WHERE (CREF_AC_ID = AC_ID) AND (CREF_JOURN_ID = AC_JOURN_ID) AND (CREF_TRANSMIT_SEQ_NO = 1) )) ORDER BY ADOC_DOC_DATE DESC)  AS ""DOCINFAVOR""", "")
            If Trim(replace_string) <> "" Then
              replace_string &= ", "
            End If
            replace_string &= "(SELECT TOP 1 COMP_NAME FROM COMPANY WITH (NOLOCK)INNER JOIN AIRCRAFT_DOCUMENT WITH (NOLOCK) ON ADOC_INFAVOR_COMP_ID = COMP_ID AND ADOC_JOURN_ID = COMP_JOURN_ID WHERE (ADOC_AC_ID = AC_ID) AND (ADOC_INFAVOR_COMP_ID IS NOT NULL) AND (ADOC_DOC_DATE >= AC_PURCHASE_DATE) AND (ADOC_ONBEHALF_COMP_ID IN (SELECT CREF_COMP_ID FROM AIRCRAFT_REFERENCE WITH (NOLOCK)WHERE (CREF_AC_ID = AC_ID) AND (CREF_JOURN_ID = AC_JOURN_ID) AND (CREF_TRANSMIT_SEQ_NO = 1) )) ORDER BY ADOC_DOC_DATE DESC)  AS ""DOCINFAVOR"""
          End If




          ' if if is still in there 
          If (InStr(UCase(aSQL_String_JETNET_Select), "COMP_") > 0 Or InStr(UCase(aSQL_String_JETNET_Select), "CREF_") > 0 Or InStr(UCase(aSQL_String_JETNET_Select), "CONTACT_") > 0 Or InStr(UCase(aSQL_String_JETNET_Select), "ACTYPE_NAME") > 0) And (Trim(UCase(tab)) = "HISTORY" Or Trim(UCase(tab)) = "AIRCRAFT") Then
            If Trim(replace_string) <> "" And Trim(aSQL_String_JETNET_Select) <> "SELECT DISTINCT" Then
              aSQL_String_JETNET_Select &= ", " & replace_string
            ElseIf Trim(replace_string) <> "" Then
              aSQL_String_JETNET_Select &= " " & replace_string
            End If
            aSQL_String_JETNET_Select = Replace(aSQL_String_JETNET_Select, "VIEW_AIRCRAFT_FLAT", "View_Aircraft_Company_Flat")
            aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " from View_Aircraft_Company_Flat WITH(NOLOCK) "
            ' replace the fields in the sub select that reference the fields in the select. I did the dot in case is a sub select that uses one of those tables
            aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & Replace(HttpContext.Current.Session.Item("MasterAircraftWhere").ToString(), "View_Aircraft_Flat.", "View_Aircraft_Company_Flat.")

          Else
            If Trim(replace_string) <> "" And Trim(aSQL_String_JETNET_Select) <> "SELECT DISTINCT" Then
              aSQL_String_JETNET_Select &= ", " & replace_string
            ElseIf Trim(replace_string) <> "" Then
              aSQL_String_JETNET_Select &= " " & replace_string
            End If
            aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " from View_Aircraft_Flat WITH(NOLOCK) "
            aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & HttpContext.Current.Session.Item("MasterAircraftWhere").ToString()
          End If


          ' commented out msw - 6/22/17
          '  If must_be_leased = True Then
          '    aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " and ac_lease_flag = 'Y' "
          '  End If
        End If


      ElseIf Trim(UCase(tab)) = "HISTORY" Then

        If InStr(HttpContext.Current.Session.Item("MasterAircraftWhere").ToString(), "comp_") > 0 Or InStr(HttpContext.Current.Session.Item("MasterAircraftWhere").ToString(), "cref_") > 0 Then
          aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " from View_Aircraft_Company_History_Flat WITH(NOLOCK) "
          aSQL_String_JETNET_Select = Replace(aSQL_String_JETNET_Select, "VIEW_AIRCRAFT_FLAT", "View_Aircraft_Company_History_Flat")
          aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & HttpContext.Current.Session.Item("MasterAircraftWhere").ToString()
        Else
          aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " from View_Aircraft_History_Flat WITH(NOLOCK) "
          aSQL_String_JETNET_Select = Replace(aSQL_String_JETNET_Select, "VIEW_AIRCRAFT_FLAT", "View_Aircraft_History_Flat")
          aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & HttpContext.Current.Session.Item("MasterAircraftWhere").ToString()
        End If


      ElseIf Trim(UCase(tab)) = "AIRCRAFT" Then

        If (InStr(UCase(HttpContext.Current.Session.Item("MasterAircraftWhere").ToString()), "COMP_") > 0 Or InStr(UCase(HttpContext.Current.Session.Item("MasterAircraftWhere").ToString()), "CREF_") > 0 Or InStr(UCase(HttpContext.Current.Session.Item("MasterAircraftWhere").ToString()), "CONTACT_") > 0 Or InStr(UCase(HttpContext.Current.Session.Item("MasterAircraftWhere").ToString()), "STATE_NAME") > 0) Then
          aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " from View_Aircraft_Company_Flat WITH(NOLOCK) "
        Else
          aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " from View_Aircraft_Flat WITH(NOLOCK) "
        End If

        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & HttpContext.Current.Session.Item("MasterAircraftWhere").ToString()

      ElseIf Trim(UCase(tab)) = "YACHT COMPANY EXPORT" Then

        If Not IsNothing(HttpContext.Current.Session.Item("Yacht_Crossover_Select")) Then
          If Trim(HttpContext.Current.Session.Item("Yacht_Crossover_Select")) <> "" Then
            aSQL_String_JETNET_Select = Trim(HttpContext.Current.Session.Item("Yacht_Crossover_Select"))
          End If
        End If

      ElseIf Trim(UCase(tab)) = "YACHT COMPANY MODEL EXPORT" Then

        If Not IsNothing(HttpContext.Current.Session.Item("Yacht_Crossover_Model_Select")) Then
          If Trim(HttpContext.Current.Session.Item("Yacht_Crossover_Model_Select")) <> "" Then
            aSQL_String_JETNET_Select = Trim(HttpContext.Current.Session.Item("Yacht_Crossover_Model_Select"))
          End If
        End If
      ElseIf Trim(UCase(tab)) = "YACHT COMPANY YACHT EXPORT" Then

        If Not IsNothing(HttpContext.Current.Session.Item("Yacht_Crossover_Yacht_Select")) Then
          If Trim(HttpContext.Current.Session.Item("Yacht_Crossover_Yacht_Select")) <> "" Then
            aSQL_String_JETNET_Select = Trim(HttpContext.Current.Session.Item("Yacht_Crossover_Yacht_Select"))
          End If
        End If

      ElseIf Trim(UCase(tab)) = "YACHT COMPANY NO YACHT EXPORT" Then

        If Not IsNothing(HttpContext.Current.Session.Item("Yacht_Crossover_AC_Select")) Then
          If Trim(HttpContext.Current.Session.Item("Yacht_Crossover_AC_Select")) <> "" Then
            aSQL_String_JETNET_Select = Trim(HttpContext.Current.Session.Item("Yacht_Crossover_AC_Select"))
          End If
        End If

      ElseIf Trim(UCase(tab)) = "YACHT COMPANY" Then


        If Not IsNothing(HttpContext.Current.Session.Item("MasterCompanyFrom")) Then
          aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & HttpContext.Current.Session.Item("MasterCompanyFrom").ToString
          If InStr(UCase(Left(HttpContext.Current.Session.Item("MasterCompanyWhere").ToString, 10)), "WHERE") = 0 Then
            aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " WHERE "
          End If
          aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & HttpContext.Current.Session.Item("MasterCompanyWhere").ToString()

        Else
          aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " from View_Aircraft_Company_Flat WITH(NOLOCK) "
          If InStr(UCase(Left(HttpContext.Current.Session.Item("MasterCompanyWhere").ToString, 10)), "WHERE") = 0 Then
            aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " WHERE "
          End If
          aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & Replace(HttpContext.Current.Session.Item("MasterCompanyWhere").ToString(), "comp_journ_id", "cref_journ_id")
        End If


        If Not IsNothing(HttpContext.Current.Session.Item("MasterContactWhere")) Then
          If Trim(HttpContext.Current.Session.Item("MasterContactWhere")) <> "" Then
            aSQL_String_JETNET_Select &= " and contact_id in (" & HttpContext.Current.Session.Item("MasterContactWhere") & ") "
          End If
        End If


        If InStr(aSQL_String_JETNET_Select, "(SELECT TOP 1 YCT_NAME FROM YACHT_REFERENCE WITH (NOLOCK) INNER JOIN YACHT_CONTACT_TYPE WITH (NOLOCK) ON YCT_CODE = YR_CONTACT_TYPE WHERE YR_COMP_ID = COMPANY.COMP_ID ORDER BY YCT_SEQ_NO ASC)") > 0 Then
          aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " and (SELECT TOP 1 YCT_NAME FROM YACHT_REFERENCE WITH (NOLOCK) INNER JOIN YACHT_CONTACT_TYPE WITH (NOLOCK) ON YCT_CODE = YR_CONTACT_TYPE WHERE YR_COMP_ID = COMPANY.COMP_ID ORDER BY YCT_SEQ_NO ASC) <> 'Research Only' "
        End If

        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " and contact_research_flag = 'N' "


      ElseIf Trim(UCase(tab)) = "COMPANY" Then

        If Not IsNothing(HttpContext.Current.Session.Item("MasterCompanyFrom")) Then
          aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & HttpContext.Current.Session.Item("MasterCompanyFrom").ToString

          If InStr(UCase(Left(HttpContext.Current.Session.Item("MasterCompanyWhere").ToString, 10)), "WHERE") = 0 Then
            aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " WHERE "
          End If
          aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & HttpContext.Current.Session.Item("MasterCompanyWhere").ToString()

          If InStr(Trim(aSQL_String_JETNET_Select), "CONTACT_COMP_ID = PNUM_COMP_ID") > 0 Then
            aSQL_String_JETNET_Select = Replace(aSQL_String_JETNET_Select, "CONTACT_COMP_ID = PNUM_COMP_ID", "COMP_ID = PNUM_COMP_ID")
          End If

        Else
          aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " from View_Aircraft_Company_Flat WITH(NOLOCK) "
          If InStr(UCase(Left(HttpContext.Current.Session.Item("MasterCompanyWhere").ToString, 10)), "WHERE") = 0 Then
            aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " WHERE "
          End If
          aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & Replace(HttpContext.Current.Session.Item("MasterCompanyWhere").ToString(), "comp_journ_id", "cref_journ_id")
        End If


        If Not IsNothing(HttpContext.Current.Session.Item("MasterContactWhere")) Then
          If Trim(HttpContext.Current.Session.Item("MasterContactWhere")) <> "" Then
            aSQL_String_JETNET_Select &= " and contact_id in (" & HttpContext.Current.Session.Item("MasterContactWhere") & ") "
          End If
        End If



      ElseIf Trim(UCase(tab)) = "EVENTS" Then
        'aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " FROM Priority_Events WITH(NOLOCK) "
        'aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " inner join Priority_Events_Category WITH(NOLOCK) on priorev_category_code=priorevcat_category_code"
        'If (InStr(UCase(jetnet_string), "COMP_") > 0 Or InStr(UCase(jetnet_string), "CREF_") > 0 Or InStr(UCase(jetnet_string), "CONTACT_") > 0) Then
        '    aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " LEFT OUTER JOIN View_Aircraft_Company_Flat WITH(NOLOCK) ON (priorev_ac_id = ac_id AND ac_journ_id = 0) "
        'Else
        '    aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " LEFT OUTER JOIN View_Aircraft_Flat WITH(NOLOCK) ON (priorev_ac_id = ac_id AND ac_journ_id = 0) "
        'End If

        If (InStr(UCase(HttpContext.Current.Session.Item("MasterAircraftEventsFrom").ToString()), "LEFT OUTER JOIN COMPANY") > 0) Or (InStr(LCase(HttpContext.Current.Session.Item("MasterAircraftEventsFrom").ToString()), "view_aircraft_company_flat") > 0) Then
          aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & HttpContext.Current.Session.Item("MasterAircraftEventsFrom").ToString()
        Else



          aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " FROM Priority_Events WITH(NOLOCK) "
          aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " inner join Priority_Events_Category WITH(NOLOCK) on priorev_category_code=priorevcat_category_code"
          If (InStr(UCase(jetnet_string), "COMP_") > 0 Or InStr(UCase(jetnet_string), "CREF_") > 0 Or InStr(UCase(jetnet_string), "CONTACT_") > 0) Then
            aSQL_String_JETNET_Select = Replace(aSQL_String_JETNET_Select, "VIEW_AIRCRAFT_FLAT.", "View_Aircraft_Company_Flat.")
            aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " LEFT OUTER JOIN View_Aircraft_Company_Flat WITH(NOLOCK) ON (priorev_ac_id = ac_id AND ac_journ_id = 0) "
          Else
            aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " LEFT OUTER JOIN View_Aircraft_Flat WITH(NOLOCK) ON (priorev_ac_id = ac_id AND ac_journ_id = 0) "
          End If
        End If





        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " WHERE "
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & HttpContext.Current.Session.Item("MasterAircraftEventsWhere").ToString()



      ElseIf Trim(UCase(tab)) = "WANTED" Then
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & HttpContext.Current.Session.Item("MasterAircraftWantedFrom").ToString()
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " WHERE "
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & HttpContext.Current.Session.Item("MasterAircraftWantedWhere").ToString()
      ElseIf Trim(UCase(tab)) = "PERFORMANCE SPECS" Then
        If Not IsNothing(HttpContext.Current.Session.Item("MasterAircraftPerformanceSpecsFrom")) Then
          aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & HttpContext.Current.Session.Item("MasterAircraftPerformanceSpecsFrom").ToString()
        Else
          aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " FROM Aircraft_Model WITH(NOLOCK) "
        End If
        If InStr(UCase(HttpContext.Current.Session.Item("MasterAircraftPerformanceSpecsWhere").ToString), "WHERE") = 0 Then
          aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " WHERE "
        End If
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & HttpContext.Current.Session.Item("MasterAircraftPerformanceSpecsWhere").ToString()
      ElseIf Trim(UCase(tab)) = "OPERATING COST" Then
        If Not IsNothing(HttpContext.Current.Session.Item("MasterAircraftOperatingCostFrom")) Then
          aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & HttpContext.Current.Session.Item("MasterAircraftOperatingCostFrom").ToString()
        Else
          aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " FROM Aircraft_Model WITH(NOLOCK) "
        End If
        If InStr(UCase(HttpContext.Current.Session.Item("MasterAircraftOperatingCostWhere").ToString), "WHERE") = 0 Then
          aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " WHERE "
        End If
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & HttpContext.Current.Session.Item("MasterAircraftOperatingCostWhere").ToString()
      Else
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & HttpContext.Current.Session.Item("MasterAircraftFrom").ToString()
        If InStr(UCase(HttpContext.Current.Session.Item("MasterAircraftWhere").ToString), "WHERE") = 0 Then
          aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " WHERE "
        End If
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & HttpContext.Current.Session.Item("MasterAircraftWhere").ToString() '
      End If


      ' if the where clause has View_Aircraft_Company_Flat in it then we must use View_Aircraft_Company_Flat 




      If is_count Then
        ' if its count then dont do any order by 

      ElseIf InStr(jetnet_string, "count") > 0 Then
        order_by_string = ""
        'order_by_string = Left(Trim(order_by_string), Len(Trim(order_by_string)) - 1)
        For i = 0 To info_to_export.Items.Count - 1

          splitstring = Split(info_to_export.Items(i).Value, "|")

          order_by_string = order_by_string & splitstring(1) & ", "
        Next

        If Trim(order_by_string) <> "" Then
          order_by_string = Left(Trim(order_by_string), Len(Trim(order_by_string)) - 1)
        End If

        'TBD NEED TO ADD BACK IN FOR SUMMARY
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " group by " & order_by_string
        aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " order by " & order_by_string
        ' aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & HttpContext.Current.Session.Item("MasterAircraftSort").ToString()
      Else
        If Trim(UCase(tab)) = "YACHT" Then

        ElseIf Trim(order_by_string) <> "" Then
          aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " order by " & order_by_string
        ElseIf Trim(UCase(tab)) = "YACHT COMPANY EXPORT" Then
        ElseIf Trim(UCase(tab)) = "YACHT COMPANY MODEL EXPORT" Then
        ElseIf Trim(UCase(tab)) = "YACHT COMPANY YACHT EXPORT" Then
        ElseIf Trim(UCase(tab)) = "YACHT COMPANY NO YACHT EXPORT" Then
        Else
          If Trim(UCase(tab)) = "EVENTS" Then
            aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & "  "
          ElseIf Trim(is_comp_needed) = "Y" Then
            aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " order by AMOD_MAKE_NAME, AMOD_MODEL_NAME, AC_SER_NO_FULL "
          Else
            aSQL_String_JETNET_Select = aSQL_String_JETNET_Select & " order by AMOD_MAKE_NAME, AMOD_MODEL_NAME, AC_SER_NO_FULL "
          End If
        End If

      End If



      '  HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Export_All() as DataTable - Jetnet Side</b><br />" & sQuery
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Export_All() as DataTable - Jetnet Side</b><br />" & aSQL_String_JETNET_Select


      '  If originating_type <> 1 Then
      ' Dim test As String = ""
      SqlConn.ConnectionString = JETNET_DB

      SqlConn.Open()
      SqlCommand.Connection = SqlConn



      ' SqlCommand.CommandText = sQuery  ' commented out msw 3/8/2013
      SqlCommand.CommandText = aSQL_String_JETNET_Select
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 600
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)


      dataSet.EnforceConstraints = False
      atemptable.PrimaryKey = Nothing
      atemptable.Constraints.Clear()

      ' if you are counting then just count, otherwise, load in 


      Try
        atemptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
      End Try

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Export_All() as DataTable - Datatable Loaded</b><br />"


      dataSet.EnforceConstraints = False
      SqlReader.Close()
      SqlReader = Nothing


      If Trim(UCase(tab)) = "YACHT COMPANY EXPORT" Then
        Export_Evo = atemptable
      ElseIf Trim(UCase(tab)) = "YACHT COMPANY MODEL EXPORT" Then
        Export_Evo = atemptable
      ElseIf Trim(UCase(tab)) = "YACHT COMPANY YACHT EXPORT" Then
        Export_Evo = atemptable
      ElseIf Trim(UCase(tab)) = "YACHT COMPANY NO YACHT EXPORT" Then
        Export_Evo = atemptable
      ElseIf is_count Or Trim(UCase(tab)) = "YACHT" Then
        Export_Evo = atemptable
      Else
        dalTable = atemptable.Clone
        dataSet.EnforceConstraints = False
        dalTable.PrimaryKey = Nothing
        dalTable.Constraints.Clear()

        '  If originating_type <> 1 Then
        Dim afiltered_BOTH As DataRow() = atemptable.Select("", first_column & " asc")
        ' extract and import
        For Each atmpDataRow_JETNET In afiltered_BOTH
          dalTable.ImportRow(atmpDataRow_JETNET)
        Next

        If dalTable.Columns.Count = 1 Then
          Export_Evo = CheckDataTableColumn(dalTable)
        Else
          Export_Evo = dalTable
        End If
      End If

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Export_All() as DataTable - Exiting Function/b><br />"

      'Else
      ''If originating_type = 8 Then
      'Export_Evo = New DataTable
      ''End If
      'End If
    Catch ex As Exception
      Export_Evo = Nothing
      Me.class_error = "Error in Export_Evo(): " & ex.Message
      Call commonLogFunctions.Log_User_Event_Data("UserError", "User Error During Export:" & Trim(ex.Message), Nothing)
    Finally
      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try
  End Function

  Public Function find_rename_field_for_export(ByVal rename_field_string As String) As String

    find_rename_field_for_export = ""

    Dim jetnet_query As String = ""
    Dim strDate As System.DateTime = Now()
    Dim temptable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim return_id As Integer = 0
    Try
      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      jetnet_query = ""
      jetnet_query = "select cef_evo_field_name from Custom_Export_Fields where cef_client_field_name = '" & rename_field_string & "' "
      SqlCommand.CommandText = jetnet_query
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        temptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = temptable.GetErrors()
      End Try

      If temptable.Rows.Count > 0 Then
        find_rename_field_for_export = temptable.Rows(0).Item("cef_evo_field_name")
      End If

      SqlReader.Close()
      SqlReader = Nothing

      Return find_rename_field_for_export
    Catch ex As Exception
      find_rename_field_for_export = Nothing
      Me.class_error = "Error in Insert_Subscription_Install_Saved_Exports: SQL VERSION " & ex.Message
    Finally
      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function
  ''' <summary>
  ''' Insert into subscription index table
  ''' </summary>
  ''' <param name="subscription_id">subscription ID for jetnet</param>
  ''' <param name="subscription_login">login for Jetnet</param>
  ''' <param name="subscription_sequence">seq # for jetnet</param>
  ''' <param name="subject">subject for custom export</param>
  ''' <param name="description">description for custom export</param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function Insert_Subscription_Install_Saved_Exports(ByVal subscription_id As Long, ByVal subscription_login As String, ByVal subscription_sequence As Long, ByVal subject As String, ByVal description As String, ByVal default_flag As String, ByVal tab As String, ByVal tab_type As String, ByVal export_type As String, ByVal is_shared As Boolean) As Integer
    Dim jetnet_query As String = ""
    Dim strDate As System.DateTime = Now()
    Dim temptable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim return_id As Integer = 0
    Try
      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      If Trim(UCase(export_type)) = "SUMMARY" Then
        export_type = "S"
      ElseIf Trim(UCase(export_type)) = "INDIVIDUAL" Then
        export_type = "D"
      End If

      description = FormatForSQL(description)
      subject = FormatForSQL(subject)


      jetnet_query = "insert into subscription_install_saved_exports (sise_sub_id, sise_login, sise_seq_no, sise_tab, " &
      " sise_subject, sise_description, sise_entry_date, sise_update_date, sise_default_flag, sise_web_action_date, sise_tab_type, sise_export_type, sise_share_flag) " &
      " values('" & subscription_id & "','" & subscription_login & "','" & subscription_sequence & "'  " &
      " ,'" & tab & "','" & subject & "','" & description & "','" & strDate & "','" & strDate & "','" & default_flag & "','" & strDate & "', '" & tab_type & "', '" & export_type & "'"
      If is_shared = True Then
        jetnet_query = jetnet_query & ",'Y'"
      Else
        jetnet_query = jetnet_query & ",'N'"
      End If



      jetnet_query = jetnet_query & ")" ' 

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Insert_Subscription_Install_Saved_Exports</b><br />" & jetnet_query

      SqlCommand.CommandText = jetnet_query
      SqlCommand.ExecuteNonQuery()

      jetnet_query = ""
      jetnet_query = "select sise_id from subscription_install_saved_exports where sise_login = '" & subscription_login & "' and sise_sub_id = '" & subscription_id & "' and sise_seq_no = '" & subscription_sequence & "' order by sise_id desc"
      SqlCommand.CommandText = jetnet_query
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        temptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = temptable.GetErrors()
      End Try

      If temptable.Rows.Count > 0 Then
        return_id = temptable.Rows(0).Item("sise_id")
      End If

      SqlReader.Close()
      SqlReader = Nothing

      Return return_id
    Catch ex As Exception
      Insert_Subscription_Install_Saved_Exports = Nothing
      Me.class_error = "Error in Insert_Subscription_Install_Saved_Exports: SQL VERSION " & ex.Message
    Finally
      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function

  Public Function ListAll_Subscription_Install_Saved_Exports(ByVal subscription_id As Long, ByVal subscription_login As String, ByVal subscription_sequence As Long, ByVal default_flag As String, ByVal tab As String, Optional ByVal temp_type As String = "") As DataTable
    Dim jetnet_query As String = ""
    Dim temptable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim return_id As Integer = 0
    Try
      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      jetnet_query = ""
      jetnet_query = "select sise_subject, sise_description, sise_id, sise_share_flag, sise_login, contact_first_name, contact_last_name "
      jetnet_query &= " from subscription_install_saved_exports WITH (NOLOCK) "
      jetnet_query &= " inner join Subscription with (NOLOCK) on sise_sub_id=sub_id "
      jetnet_query &= " LEFT OUTER JOIN Subscription_Install with (NOLOCK) on subins_sub_id = sise_sub_id and subins_login=sise_login and subins_seq_no = sise_seq_no "
      jetnet_query &= " left outer join Contact with (NOLOCK) on subins_contact_id = contact_id and contact_journ_id = 0 "

      jetnet_query &= Build_Subscription_Select_String("Exports", temp_type, subscription_id, subscription_login, tab, subscription_sequence)



      jetnet_query &= " order by sise_subject asc "

      SqlCommand.CommandText = jetnet_query
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>ListAll_Subscription_Install_Saved_Exports</b><br />" & jetnet_query

      Try
        temptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = temptable.GetErrors()
      End Try

      SqlReader.Close()
      SqlReader = Nothing

      Return temptable
    Catch ex As Exception
      ListAll_Subscription_Install_Saved_Exports = Nothing
      Me.class_error = "Error in ListAll_Subscription_Install_Saved_Exports: SQL VERSION " & ex.Message
    Finally
      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function

  Public Function Build_Subscription_Select_String(ByVal SHARED_TYPE As String, ByVal temp_type As String, ByVal subscription_id As Long, ByVal subscription_login As String, ByVal TAB As String, ByVal subscription_sequence As String) As String
    Dim jetnet_query As String = ""
    Dim prefix_temp As String = ""
    Dim type_of_selection As String = ""
    Dim shared_selected As String = ""

    If Trim(SHARED_TYPE) = "Folders" Then
      prefix_temp = "cfolder"
      type_of_selection = "cfolder_cftype_id"
      shared_selected = "cfolder_share"
    ElseIf Trim(SHARED_TYPE) = "Exports" Then
      prefix_temp = "sise"
      type_of_selection = "sise_tab"
      shared_selected = "sise_share_flag"
    End If





    If Trim(temp_type) = "" Then
      jetnet_query &= " where ((" & prefix_temp & "_login = '" & subscription_login & "' and " & prefix_temp & "_sub_id = '" & subscription_id & "' and " & prefix_temp & "_seq_no = '" & subscription_sequence & "' and " & type_of_selection & " = '" & TAB & "') "

      Select Case HttpContext.Current.Session.Item("localSubscription").crmSubscriptionShareType
        Case eSubscriptionShareType.MY_PARENT_COMPANY
          '-- BLOCK 3.C - GET MY FOLDERS AND THOSE SHARED FOR MY PARENT COMPANY 
          '    where (( cfolder_sub_id = 777 and cfolder_login = 'mvintech' and cfolder_seq_no = 1) 
          ' or (sub_comp_id = 135887 and cfolder_share='Y' and sub_share_by_comp_id_flag = 'Y')) 
          jetnet_query &= " or (sub_comp_id  = " & HttpContext.Current.Session.Item("localUser").crmUserCompanyID & " and " & shared_selected & "='Y' and sub_share_by_comp_id_flag = 'Y' and " & type_of_selection & " = '" & TAB & "'))"
        Case eSubscriptionShareType.MY_PARENT_SUBSCRIPTION
          ' -- BLOCK 3.B - GET MY FOLDERS AND THOSE SHARED FOR MY PARENT SUBSCRIPTION 
          '  where (( cfolder_sub_id = 777 and cfolder_login = 'mvintech' and cfolder_seq_no = 1) 
          '  or (sub_parent_sub_id = 777 and cfolder_share='Y' and sub_share_by_parent_sub_id_flag = 'Y' )) 
          jetnet_query &= " or (sub_parent_sub_id  = " & HttpContext.Current.Session.Item("localUser").crmSubParentID & " and " & shared_selected & "='Y' and sub_share_by_parent_sub_id_flag = 'Y' and " & type_of_selection & " = '" & TAB & "'))"
        Case Else
          jetnet_query &= " or (" & prefix_temp & "_sub_id = " & subscription_id & " and " & shared_selected & "='Y' and " & type_of_selection & " = '" & TAB & "')) "
      End Select
    Else

      If HttpContext.Current.Session.Item("localUser").crmUserType = eUserTypes.ADMINISTRATOR Then

        If Trim(temp_type) = "MY" Then
          jetnet_query &= " where ((" & prefix_temp & "_login = '" & subscription_login & "' and " & prefix_temp & "_sub_id = '" & subscription_id & "' and " & prefix_temp & "_seq_no = '" & subscription_sequence & "' and " & type_of_selection & " = '" & TAB & "') "

          Select Case HttpContext.Current.Session.Item("localSubscription").crmSubscriptionShareType
            Case eSubscriptionShareType.MY_PARENT_COMPANY
              '-- BLOCK 3.C - GET MY FOLDERS A ND THOSE SHARED FOR MY PARENT COMPANY 
              jetnet_query &= " or (sub_comp_id  = " & HttpContext.Current.Session.Item("localUser").crmUserCompanyID & " and " & shared_selected & "='Y' and sub_share_by_comp_id_flag = 'Y' and " & type_of_selection & " = '" & TAB & "'))"
            Case eSubscriptionShareType.MY_PARENT_SUBSCRIPTION
              ' -- BLOCK 3.B - GET MY FOLDERS AND THOSE SHARED FOR MY PARENT SUBSCRIPTION 
              jetnet_query &= " or (sub_parent_sub_id  = " & HttpContext.Current.Session.Item("localUser").crmSubParentID & " and " & shared_selected & "='Y' and sub_share_by_parent_sub_id_flag = 'Y' and " & type_of_selection & " = '" & TAB & "'))"
            Case Else
              jetnet_query &= " or (" & prefix_temp & "_sub_id = " & subscription_id & " and " & shared_selected & "='Y' and " & type_of_selection & " = '" & TAB & "')) "
          End Select
        ElseIf Trim(temp_type) = "ALL" Then
          jetnet_query &= " where ((" & prefix_temp & "_login = '" & subscription_login & "' and " & prefix_temp & "_sub_id = '" & subscription_id & "' and " & prefix_temp & "_seq_no = '" & subscription_sequence & "' and " & type_of_selection & " = '" & TAB & "') "

          Select Case HttpContext.Current.Session.Item("localSubscription").crmSubscriptionShareType
            Case eSubscriptionShareType.MY_PARENT_COMPANY
              '-- BLOCK 3.C - GET MY FOLDERS A ND THOSE SHARED FOR MY PARENT COMPANY 
              jetnet_query &= " or (sub_comp_id  = " & HttpContext.Current.Session.Item("localUser").crmUserCompanyID & " and sub_share_by_comp_id_flag = 'Y' and " & type_of_selection & " = '" & TAB & "'))"
            Case eSubscriptionShareType.MY_PARENT_SUBSCRIPTION
              ' -- BLOCK 3.B - GET MY FOLDERS AND THOSE SHARED FOR MY PARENT SUBSCRIPTION 
              jetnet_query &= " or (sub_parent_sub_id  = " & HttpContext.Current.Session.Item("localUser").crmSubParentID & " and sub_share_by_parent_sub_id_flag = 'Y' and " & type_of_selection & " = '" & TAB & "'))"
            Case Else
              jetnet_query &= " or (" & prefix_temp & "_sub_id = " & subscription_id & " and " & type_of_selection & " = '" & TAB & "')) "
          End Select
        ElseIf Trim(temp_type) = "ALS" Then
          jetnet_query &= " where ((" & prefix_temp & "_login = '" & subscription_login & "' and " & prefix_temp & "_sub_id = '" & subscription_id & "' and " & prefix_temp & "_seq_no = '" & subscription_sequence & "' and " & type_of_selection & " = '" & TAB & "' and " & shared_selected & "='Y') "

          Select Case HttpContext.Current.Session.Item("localSubscription").crmSubscriptionShareType
            Case eSubscriptionShareType.MY_PARENT_COMPANY
              '-- BLOCK 3.C - GET MY FOLDERS A ND THOSE SHARED FOR MY PARENT COMPANY 
              jetnet_query &= " or (sub_comp_id  = " & HttpContext.Current.Session.Item("localUser").crmUserCompanyID & " and " & shared_selected & "='Y' and sub_share_by_comp_id_flag = 'Y' and " & type_of_selection & " = '" & TAB & "'))"
            Case eSubscriptionShareType.MY_PARENT_SUBSCRIPTION
              ' -- BLOCK 3.B - GET MY FOLDERS AND THOSE SHARED FOR MY PARENT SUBSCRIPTION 
              jetnet_query &= " or (sub_parent_sub_id  = " & HttpContext.Current.Session.Item("localUser").crmSubParentID & " and " & shared_selected & "='Y' and sub_share_by_parent_sub_id_flag = 'Y' and " & type_of_selection & " = '" & TAB & "'))"
            Case Else
              jetnet_query &= " or (" & prefix_temp & "_sub_id = " & subscription_id & " and " & shared_selected & "='Y' and " & type_of_selection & " = '" & TAB & "')) "
          End Select
        ElseIf Trim(temp_type) = "ALP" Then
          jetnet_query &= " where ((" & prefix_temp & "_login = '" & subscription_login & "' and " & prefix_temp & "_sub_id = '" & subscription_id & "' and " & prefix_temp & "_seq_no = '" & subscription_sequence & "' and " & type_of_selection & " = '" & TAB & "' and " & shared_selected & "='N') "

          Select Case HttpContext.Current.Session.Item("localSubscription").crmSubscriptionShareType
            Case eSubscriptionShareType.MY_PARENT_COMPANY
              '-- BLOCK 3.C - GET MY FOLDERS A ND THOSE SHARED FOR MY PARENT COMPANY 
              jetnet_query &= " or (sub_comp_id  = " & HttpContext.Current.Session.Item("localUser").crmUserCompanyID & " and " & shared_selected & "='N' and sub_share_by_comp_id_flag = 'Y' and " & type_of_selection & " = '" & TAB & "'))"
            Case eSubscriptionShareType.MY_PARENT_SUBSCRIPTION
              ' -- BLOCK 3.B - GET MY FOLDERS AND THOSE SHARED FOR MY PARENT SUBSCRIPTION 
              jetnet_query &= " or (sub_parent_sub_id  = " & HttpContext.Current.Session.Item("localUser").crmSubParentID & " and " & shared_selected & "='N' and sub_share_by_parent_sub_id_flag = 'Y' and " & type_of_selection & " = '" & TAB & "'))"
            Case Else
              jetnet_query &= " or (" & prefix_temp & "_sub_id = " & subscription_id & " and " & shared_selected & "='N' and " & type_of_selection & " = '" & TAB & "')) "
          End Select
        End If

      Else

        If Trim(temp_type) = "MY" Then
          jetnet_query &= " where ((" & prefix_temp & "_login = '" & subscription_login & "' and " & prefix_temp & "_sub_id = '" & subscription_id & "' and " & prefix_temp & "_seq_no = '" & subscription_sequence & "' and " & type_of_selection & " = '" & TAB & "') "

          Select Case HttpContext.Current.Session.Item("localSubscription").crmSubscriptionShareType
            Case eSubscriptionShareType.MY_PARENT_COMPANY
              '-- BLOCK 3.C - GET MY FOLDERS A ND THOSE SHARED FOR MY PARENT COMPANY 
              jetnet_query &= " or (sub_comp_id  = " & HttpContext.Current.Session.Item("localUser").crmUserCompanyID & " and " & shared_selected & "='Y' and sub_share_by_comp_id_flag = 'Y' and " & type_of_selection & " = '" & TAB & "'))"
            Case eSubscriptionShareType.MY_PARENT_SUBSCRIPTION
              ' -- BLOCK 3.B - GET MY FOLDERS AND THOSE SHARED FOR MY PARENT SUBSCRIPTION 
              jetnet_query &= " or (sub_parent_sub_id  = " & HttpContext.Current.Session.Item("localUser").crmSubParentID & " and " & shared_selected & "='Y' and sub_share_by_parent_sub_id_flag = 'Y' and " & type_of_selection & " = '" & TAB & "'))"
            Case Else
              jetnet_query &= " or (" & prefix_temp & "_sub_id = " & subscription_id & " and " & shared_selected & "='Y' and " & type_of_selection & " = '" & TAB & "')) "
          End Select
        ElseIf Trim(temp_type) = "MYP" Then
          jetnet_query &= " where (" & prefix_temp & "_login = '" & subscription_login & "' and " & prefix_temp & "_sub_id = '" & subscription_id & "' and " & prefix_temp & "_seq_no = '" & subscription_sequence & "' and " & type_of_selection & " = '" & TAB & "' and " & shared_selected & "='N') "

        ElseIf Trim(temp_type) = "ALLS" Then
          jetnet_query &= " where ((" & prefix_temp & "_login = '" & subscription_login & "' and " & prefix_temp & "_sub_id = '" & subscription_id & "' and " & prefix_temp & "_seq_no = '" & subscription_sequence & "' and " & type_of_selection & " = '" & TAB & "' and " & shared_selected & "='Y') "

          Select Case HttpContext.Current.Session.Item("localSubscription").crmSubscriptionShareType
            Case eSubscriptionShareType.MY_PARENT_COMPANY
              '-- BLOCK 3.C - GET MY FOLDERS A ND THOSE SHARED FOR MY PARENT COMPANY 
              jetnet_query &= " or (sub_comp_id  = " & HttpContext.Current.Session.Item("localUser").crmUserCompanyID & " and " & shared_selected & "='Y' and sub_share_by_comp_id_flag = 'Y' and " & type_of_selection & " = '" & TAB & "'))"
            Case eSubscriptionShareType.MY_PARENT_SUBSCRIPTION
              ' -- BLOCK 3.B - GET MY FOLDERS AND THOSE SHARED FOR MY PARENT SUBSCRIPTION 
              jetnet_query &= " or (sub_parent_sub_id  = " & HttpContext.Current.Session.Item("localUser").crmSubParentID & " and " & shared_selected & "='Y' and sub_share_by_parent_sub_id_flag = 'Y' and " & type_of_selection & " = '" & TAB & "'))"
            Case Else
              jetnet_query &= " or (" & prefix_temp & "_sub_id = " & subscription_id & " and " & shared_selected & "='Y' and " & type_of_selection & " = '" & TAB & "')) "
          End Select
        End If


      End If

    End If


    Build_Subscription_Select_String = jetnet_query

  End Function

  Public Function Insert_Subscription_Install_Saved_Export_Fields(ByVal subscription_export_id As Integer, ByVal header_field_name As String, ByVal seq_no As Long) As Integer
    Dim jetnet_query As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try
      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      jetnet_query = "insert into Subscription_Install_Saved_Export_Fields (sisef_sise_id, sisef_header_field_name, sisef_seq_no) values('" & subscription_export_id & "','" & Replace(header_field_name, "'", "''") & "','" & seq_no & "')"

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Insert_Subscription_Install_Saved_Export_Fields</b><br />" & jetnet_query
      SqlCommand.CommandText = jetnet_query
      SqlCommand.ExecuteNonQuery()

      Return 1
    Catch ex As Exception
      Return Nothing
      Insert_Subscription_Install_Saved_Export_Fields = ""
      Me.class_error = "Error in Insert_Subscription_Install_Saved_Export_Fields: SQL VERSION " & ex.Message
    Finally
      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try


  End Function


  Public Function Delete_Saved_Export(ByVal custom_export_id As Long) As Integer
    Dim jetnet_query As String = ""
    Dim remove_query As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing


    Delete_Saved_Export = 0

    Try
      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      remove_query = "  delete from subscription_install_saved_exports where sise_id = " & custom_export_id & "  "


      SqlCommand.CommandText = remove_query
      SqlCommand.ExecuteNonQuery()
      SqlCommand.Dispose()



      remove_query = "delete from subscription_install_saved_export_fields where sisef_sise_id = " & custom_export_id & "  "


      SqlCommand.CommandText = remove_query
      SqlCommand.ExecuteNonQuery()
      SqlCommand.Dispose()





      Return 1 '& "<br /><br />" & remove_query
    Catch ex As Exception
      Return Nothing
      Delete_Saved_Export = 0
      Me.class_error = "Error in Update_Saved_Export_Fields: SQL VERSION " & ex.Message
    Finally
      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try
  End Function


  Public Sub Fill_Open_Box(ByRef project_box As DropDownList, ByVal user_id As String, ByRef listing As String, ByRef selected_value As Integer, ByVal amod_id As Integer, ByVal type_of_export As String, Optional ByRef default_model_id_string As String = "", Optional ByVal use_default As Boolean = False)
    Dim TempTableCombine As New DataTable
    Dim aTempTable As New DataTable
    Dim aTempTable2 As New DataTable
    Dim aTempTable3 As New DataTable
    Dim temp_model As String = ""
    Dim temp_proj As String = ""
    Dim MarketDefaultOverride As Boolean = False
    Try


      aTempTable = Client_Project_Details_By_User_ID(user_id, amod_id, type_of_export)

      If type_of_export = "3" Then
        Dim TemporaryTable As New DataTable

        TemporaryTable = aTempTable.Clone
        TempTableCombine = Client_Project_Details_By_MarketDefault(user_id, amod_id, type_of_export)

        For Each drClient As DataRow In TempTableCombine.Rows
          TemporaryTable.ImportRow(drClient)
        Next

        For Each drClient As DataRow In aTempTable.Rows
          TemporaryTable.ImportRow(drClient)
        Next

        aTempTable = TemporaryTable
      End If




      'aTempTable3 = Client_Project_Details_By_Shared_Flag("Y", amod_id, user_id)
      'For Each drClient As DataRow In aTempTable3.Rows
      '  aTempTable.ImportRow(drClient)
      'Next

      'Dim afiltered_Client As DataRow() = aTempTable.Select("", "cliproj_name asc")
      'aTempTable.Rows.Clear()
      '' extract and import
      'For Each atmpDataRow_Client In afiltered_Client
      '  aTempTable.ImportRow(atmpDataRow_Client) 
      'Next


      If Not IsNothing(aTempTable) Then
        If aTempTable.Rows.Count > 0 Then
          For Each q As DataRow In aTempTable.Rows
            If listing = q("cliproj_source") Then
              ' If ((q("cliproj_shared") = "N") Or (q("cliproj_market_default") = "Y")) Then

              temp_proj = q("cliproj_name")

              If amod_id = 0 Then
                aTempTable2 = Get_JETNET_Models_For_Drop("", q("cliproj_jetnet_model"), True)
                temp_model = ""
                If Not IsNothing(aTempTable2) Then
                  If aTempTable2.Rows.Count > 0 Then
                    For Each j As DataRow In aTempTable2.Rows
                      temp_model = j("amod_make_name") & " " & j("amod_model_name")
                    Next
                  End If
                End If


                If Trim(temp_model) <> "" And amod_id = 0 Then
                  temp_proj &= " (" & temp_model & ")"
                End If
              End If

              If Not IsNothing(project_box) Then
                If q("cliproj_market_default") = "Y" Then
                  project_box.Items.Insert(0, New ListItem(temp_proj, q("cliproj_name") & "++++++" & q("cliproj_id")))
                  If use_default = True Then
                    default_model_id_string = q("cliproj_name") & "++++++" & q("cliproj_id")
                    selected_value = CDbl(q("cliproj_id"))
                    MarketDefaultOverride = True
                  End If
                Else
                  project_box.Items.Add(New ListItem(temp_proj, q("cliproj_name") & "++++++" & q("cliproj_id")))
                End If
              End If


              If use_default = True Then
                If Not IsDBNull(q("cliproj_model_default")) Then
                  If Trim(q("cliproj_model_default")) = "Y" Then
                    If MarketDefaultOverride = False Then
                      default_model_id_string = q("cliproj_name") & "++++++" & q("cliproj_id")
                      selected_value = CDbl(q("cliproj_id"))
                    End If
                  End If
                End If
              End If

              If Not IsNothing(project_box) Then
                If CDbl(selected_value) = CDbl(q("cliproj_id")) Then
                  project_box.SelectedValue = q("cliproj_name") & "++++++" & q("cliproj_id")
                End If
              End If
              'End If

            End If
          Next
        End If
      End If

      'Projects this person can access via sharing.

      'If Not IsNothing(aTempTable) Then
      '  If aTempTable.Rows.Count > 0 Then
      '    For Each q As DataRow In aTempTable.Rows
      '      ' If q("cliproj_user_id") <> Session.Item("localUser").crmLocalUserID Then
      '      If listing = q("cliproj_source") Then

      '        temp_proj = q("cliproj_name")
      '        If amod_id = 0 Then
      '          aTempTable2 = Get_JETNET_Models_For_Drop("", q("cliproj_jetnet_model"), True)
      '          temp_model = ""
      '          If Not IsNothing(aTempTable2) Then
      '            If aTempTable2.Rows.Count > 0 Then
      '              For Each j As DataRow In aTempTable2.Rows
      '                temp_model = j("amod_make_name") & " " & j("amod_model_name")
      '              Next
      '            End If
      '          End If

      '          If Trim(temp_model) <> "" Then
      '            temp_proj &= " (" & temp_model & ")"
      '          End If
      '        End If

      '        If Not IsNothing(project_box) Then
      '          project_box.Items.Add(New ListItem(temp_proj, q("cliproj_name") & "++++++" & q("cliproj_id")))
      '          If CDbl(selected_value) = CDbl(q("cliproj_id")) Then
      '            project_box.SelectedValue = q("cliproj_name") & "++++++" & q("cliproj_id")
      '          End If
      '        End If
      '      End If
      '      'End If
      '    Next
      '  End If
      'End If
    Catch ex As Exception
    Finally
      aTempTable = Nothing
      aTempTable2 = Nothing
    End Try
  End Sub

  Public Function Update_Saved_Export_Fields(ByVal subscription_id As Long, ByVal subscription_login As String, ByVal subscription_sequence As Long, ByVal sise_id As Integer, ByVal sise_subject As String, ByVal sise_description As String, ByVal export_type As String, ByVal is_shared As Boolean) As Integer
    Dim jetnet_query As String = ""
    Dim remove_query As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try
      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      If Trim(UCase(export_type)) = "SUMMARY" Then
        export_type = "S"
      ElseIf Trim(UCase(export_type)) = "INDIVIDUAL" Then
        export_type = "D"
      End If

      jetnet_query = "update subscription_install_saved_exports set sise_subject = '" & sise_subject & "', sise_description = '" & sise_description & "', sise_export_type = '" & export_type & "' "
      If is_shared = True Then
        jetnet_query = jetnet_query & ", sise_share_flag = 'Y' "
      Else
        jetnet_query = jetnet_query & ", sise_share_flag ='N' "
      End If


      If HttpContext.Current.Session.Item("localUser").crmUserType = eUserTypes.ADMINISTRATOR = True Then
        jetnet_query &= " where sise_id = '" & sise_id & "'  "
      Else
        jetnet_query &= " where sise_login = '" & subscription_login & "' and sise_sub_id = '" & subscription_id & "' and sise_seq_no = '" & subscription_sequence & "' and sise_id = '" & sise_id & "'  "
      End If


      SqlCommand.CommandText = jetnet_query
      SqlCommand.ExecuteNonQuery()

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Update_Saved_Export_Fields</b><br />" & jetnet_query


      remove_query = "delete from Subscription_Install_Saved_Export_Fields where sisef_sise_id = '" & sise_id & "'"

      SqlCommand.CommandText = remove_query
      SqlCommand.ExecuteNonQuery()


      Return 1 '& "<br /><br />" & remove_query
    Catch ex As Exception
      Return Nothing
      Update_Saved_Export_Fields = 0
      Me.class_error = "Error in Update_Saved_Export_Fields: SQL VERSION " & ex.Message
    Finally
      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try
  End Function


  Public Function Select_Subscription_Install(ByVal subscription_id As Long, ByVal subscription_login As String, ByVal subscription_sequence As Long, ByVal ID As Integer, ByRef dropdown1 As DropDownList, ByVal is_just_to_display As Boolean, ByRef creator_login As String, ByRef sise_description As String, ByRef sise_subject As String, ByRef sise_id As Long, ByRef sise_share_flag As String, ByRef created_user_login As String) As DataTable
    Dim jetnet_query As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim SqlReader As SqlClient.SqlDataReader
    Dim temptable As New DataTable
    Dim temp_type As String = "D"

    Try
      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      jetnet_query = " select sise_subject, sise_export_type, sise_description, sise_share_flag, sise_id, sise_login, contact_first_name, contact_last_name "
      jetnet_query &= " from subscription_install_saved_exports with (NOLOCK) "
      jetnet_query &= " left outer join Subscription_Install with (NOLOCK) on subins_sub_id =sise_sub_id  "
      jetnet_query &= " and subins_login=sise_login and subins_seq_no=sise_seq_no "
      jetnet_query &= " left outer join Contact on subins_contact_id = contact_id "
      jetnet_query &= " where sise_id = " & ID & " "
      ' jetnet_query = "select sise_export_type, sise_description, sise_subject, sise_id, sise_share_flag from subscription_install_saved_exports where sise_id = " & ID & " "
      SqlCommand.CommandText = jetnet_query
      SqlReader = SqlCommand.ExecuteReader()
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60
      If SqlReader.HasRows Then
        SqlReader.Read()
        temp_type = SqlReader("sise_export_type")
        If Not IsDBNull(SqlReader("contact_first_name")) And Not IsDBNull(SqlReader("contact_last_name")) Then
          creator_login = SqlReader("contact_first_name") & " " & SqlReader("contact_last_name")
        Else
          creator_login = ""
        End If

        sise_description = SqlReader("sise_description")
        sise_subject = SqlReader("sise_subject")
        sise_id = SqlReader("sise_id")
        sise_share_flag = SqlReader("sise_share_flag")
        created_user_login = SqlReader("sise_login")

      End If
      SqlReader.Close()



      If Trim(temp_type) <> "" Then

        If Trim(UCase(temp_type)) = "S" Then
          dropdown1.SelectedIndex = 1
        ElseIf Trim(UCase(temp_type)) = "D" Then
          dropdown1.SelectedIndex = 0
        End If

      End If

      jetnet_query = "select sisef_header_field_name, sisef_seq_no, sub_share_by_comp_id_flag, sise_share_flag "
      jetnet_query &= " from subscription_install_saved_exports "
      jetnet_query &= " inner join Subscription with (NOLOCK) on sise_sub_id=sub_id  "
      jetnet_query &= " left outer join subscription_install_saved_export_fields WITH (NOLOCK) on sisef_sise_id = sise_id "
      jetnet_query &= " where sise_id = " & ID & " "

      If HttpContext.Current.Session.Item("localUser").crmUserType = eUserTypes.ADMINISTRATOR Then
        ' show all 
        jetnet_query &= " order by sisef_seq_no asc "
      Else
        If is_just_to_display = True Then
        Else
          jetnet_query &= " and sise_login = '" & subscription_login & "' and sise_sub_id = '" & subscription_id & "' "
          jetnet_query &= " and sise_seq_no = '" & subscription_sequence & "'  order by sisef_seq_no asc"
        End If
      End If
      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Select_Subscription_Install</b><br />" & jetnet_query

      SqlCommand.CommandText = jetnet_query
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        temptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = temptable.GetErrors()
      End Try

      Return temptable
      SqlReader.Close()
      SqlReader = Nothing

    Catch ex As Exception
      Return Nothing

      Me.class_error = "Error in Select_Subscription_Install: SQL VERSION " & ex.Message
    Finally
      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function

#End Region
#Region "NEEDED LOOKUPS FOR YACHT"

  Public Shared Function generateMYSQLConnectionString(ByVal hostName As String, ByVal dataBase As String, ByVal userID As String, ByVal passWD As String) As String
    Return "Connect Timeout=45;Allow User Variables=True;Default Command Timeout=3600;Persist Security Info=True;server=" + hostName.Trim + ";User Id=" + userID.Trim + ";password=" + passWD.Trim + ";database=" + dataBase.Trim
  End Function

  Public Shared Function generateMSSQLConnectionString(ByVal hostName As String, ByVal dataBase As String, ByVal userID As String, ByVal passWD As String) As String
    Return "server=" + hostName.Trim + ";initial catalog=" + dataBase.Trim + ";Persist Security Info=False;User Id=" + userID.Trim + ";Password=" + passWD.Trim + ";"
  End Function
  <System.Serializable(), FlagsAttribute()> Public Enum eProductCodeTypes As Integer

    NULL = 0
    B = 1 ' Business     ** check tier level for make/model selection
    H = 2 ' Helicopters  ** ignore tier level
    C = 4 ' Commercial   ** check tier level for make/model selection
    R = 8 ' Regional     ** ignore tier level
    F = 16 ' Fortune 1000 ** not used
    A = 32 ' Aviation Business Index     ** ignore tier level
    P = 64 ' AirBP     ** ignore tier level
    S = 128 ' STAR Reports     ** ignore tier level
    I = 256 ' SPI View     ** ignore tier level
    Y = 512 ' Yacht     ** ignore tier level

  End Enum
  <System.Serializable(), FlagsAttribute()> Public Enum eTierLevelTypes As Integer

    NULL = 0
    JETS = 1
    TURBOS = 2
    ALL = 4

  End Enum
  Public Function parseUserAgentString(ByVal inUserAgentString As String) As String

    Dim osString As String = ""
    Dim browserString As String = ""

    osString = "other  "
    browserString = "unknown"

    If Not String.IsNullOrEmpty(inUserAgentString) Then

      inUserAgentString = inUserAgentString.ToLower

      If inUserAgentString.Contains("windows") Then
        osString = "win    "
      ElseIf inUserAgentString.Contains("ipad") Then
        osString = "ipad   "
      ElseIf inUserAgentString.Contains("iphone") Then
        osString = "iphone "
      ElseIf inUserAgentString.Contains("mac") Then
        osString = "mac    "
      ElseIf inUserAgentString.Contains("android") Then
        osString = "droid  "
      ElseIf inUserAgentString.Contains("blackberry") Then
        osString = "blackb "
      ElseIf inUserAgentString.Contains("red hat") Then
        osString = "linux  "
      ElseIf inUserAgentString.Contains("linux") Then
        osString = "linux  "
      End If

      If Trim(osString) = "" Then
        If inUserAgentString.Contains("mobile") Then
          osString = "mobile "
        ElseIf inUserAgentString.Contains("tablet") Then
          osString = "tablet "
        Else
          osString = "other  "
        End If
      End If

      If inUserAgentString.Contains("chrome") Then
        browserString = "chrome"
      ElseIf inUserAgentString.Contains("opera") Then
        browserString = "opera"
      ElseIf inUserAgentString.Contains("safari") Then
        browserString = "safari"
      ElseIf inUserAgentString.Contains("mobile safari") Then
        browserString = "safarim"
      ElseIf inUserAgentString.Contains("firefox") Then
        browserString = "firefox"
      ElseIf inUserAgentString.Contains("fennec") Then
        browserString = "firefoxm"
      ElseIf inUserAgentString.Contains("applewebkit") Then
        browserString = "mozilla"
      ElseIf inUserAgentString.Contains("msie") Then
        browserString = "msie"
      Else
        browserString = "unknown"
      End If
    Else
      inUserAgentString = "Blank User Agent String"
    End If

    Return osString + browserString

  End Function
  Public Shared Function FormatForSQL(ByVal sInString As String) As String
    Return Replace(Replace(sInString, "’", "'"), "'", "''")
  End Function
#End Region
#Region "Yacht"

  Public Shared Function Retrieving_Database_Connection(ByVal app_name As String, ByVal frequency As String) As DataTable
    Dim atemptable As New DataTable
    Dim str As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try
      If frequency <> "" Then

        'app_name = "CRMLIVE"

        str = " select serfreqan_database_name as connectdb,"
        str = str & " serfreqan_sqlserver_name as connectserver, "
        str = str & " serfreqan_user_id as connectuser, "
        str = str & " serfreqan_password as connectpw "
        str = str & " from Service_Frequency_AppName "
        str = str & " where serfreqan_appname='" & app_name & "' "
        str = str & " and serfreqan_frequency='" & frequency & "' "


        SqlConn.ConnectionString = My.Settings.DEFAULT_LIVE_MSSQL.ToString
        SqlConn.Open()
        SqlCommand.Connection = SqlConn


        SqlCommand.CommandText = str
        SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
        SqlCommand.CommandType = CommandType.Text
        SqlCommand.CommandTimeout = 60


        Try
          atemptable.Load(SqlReader)
        Catch constrExc As System.Data.ConstraintException
          Dim rowsErr As System.Data.DataRow() = atemptable.GetErrors()
        End Try
      End If

    Catch ex As Exception
      Retrieving_Database_Connection = Nothing
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try
    Return atemptable
  End Function

  Public Function CRM_GUID_VALIDATION(ByVal securityToken As String, ByRef MyAppState As HttpApplicationState) As Integer
    'The GUID Validation should be a multiple step process.
    'If first 3 chars of GUID are not "CRM" or "EVO" then just display "Unauthorized Page Access: Invalid Source" and end the page
    Select Case Left(securityToken, 3)
      Case "CRM" 'this means that the security token is a CRM GUID, it means that we should carry on validating it against the CRM central database.
        'First thing is first - we need to validate that this is an actual GUID that exists in our central database.
        'First let's open up a database connection to our CRM central database.
        'I am initializing my connection to databases up top. This will allow me to try catch finally function
        Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
        Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
        Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader
        Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
        Dim aTempTable As New DataTable
        Dim ReturnTable As New DataTable
        Dim sql_string As String = ""
        Dim ts As New TimeSpan

        'This is just in case, I want to make sure this is definitely parsed for mysql.
        securityToken = FormatForSQL(securityToken)

        Try
          'This is basically going to toggle the database connection to the CRM central based on if you're on
          'the server or if you're on local.
          'One uses an ip (server), one doesn't (domain).
          If MyAppState.Item("webHostObject").evoWebHostType <> eWebSiteTypes.LOCAL Then
            If MyAppState.Item("webHostObject").evoClientHostName.ToString.ToUpper.Contains("JETNET12") Then
              MySqlConn.ConnectionString = HttpContext.Current.Application.Item("crmMasterDatabase")
            Else
              MySqlConn.ConnectionString = HttpContext.Current.Application.Item("crmMasterDatabase")
            End If
          Else
            MySqlConn.ConnectionString = HttpContext.Current.Application.Item("crmMasterDatabase")
          End If
          'opening the connection to the database.
          MySqlConn.Open()
          'This is the sql string for querying the master database.
          sql_string = " SELECT * FROM client_user inner join client_register_master on client_regID = cliuser_client_regid WHERE cliuser_session_guid = '" & securityToken & "'  limit 1"
          'setting the command connection, type, timeout, sql string
          MySqlCommand.Connection = MySqlConn
          MySqlCommand.CommandType = CommandType.Text
          MySqlCommand.CommandTimeout = 60
          MySqlCommand.CommandText = sql_string
          'executing, closing connection
          MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
          'Filling a datatable up with the results to be used.
          Try
            aTempTable.Load(MySqlReader)
          Catch constrExc As System.Data.ConstraintException
            Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
          End Try

          If Not IsNothing(aTempTable) Then
            If aTempTable.Rows.Count > 0 Then
              'This means that there is a guid like this in our database.
              'That is the first step.
              'The second step is to verify that the person is actually logged in, we'll have to do this in two ways.
              'The logged in flag needs to be Y, but not only that
              'The timestamp on their record has to be within the last 10 minutes.

              If Not IsDBNull(aTempTable.Rows(0).Item("cliuser_last_session_date")) Then
                ts = Now().Subtract(aTempTable.Rows(0).Item("cliuser_last_session_date"))
                If ts.TotalMinutes <= 10 Then
                  'There is a guid like this, with a session date in the last 10 minutes.
                  'Let's do one more check for now - make sure that the logged in flag is Y
                  If aTempTable.Rows(0).Item("cliuser_loggedin_flag").ToString = "Y" Then
                    'This person is really logged in!!
                    'We're going to very quickly set the flags
                    'grabbing the productCode from the database and splitting into an array.
                    Dim product_type As Array = Split(Replace(aTempTable.Rows(0).Item("client_regProductCode").ToString, " ", ""), ",")
                    'starting the array of productcode types
                    Dim sProductList() As eProductCodeTypes = Nothing
                    'looping through each array item
                    For x As Integer = 0 To UBound(product_type)
                      Select Case product_type(x)
                        Case "H" 'this is for the helicopters
                          ReDim Preserve sProductList(x) 'redimming array each time to keep values
                          sProductList(x) = eProductCodeTypes.H 'setting array to include helicopters
                        Case "B" 'business
                          ReDim Preserve sProductList(x) 'redimming array each time to keep values
                          sProductList(x) = eProductCodeTypes.B 'setting array to include business

                          Dim tier_type As Array = Split(Replace(aTempTable.Rows(0).Item("client_regTierLevel").ToString, " ", ""), ",") 'these are for the tier types
                          For y As Integer = 0 To UBound(tier_type) 'looping through each tier type.
                            Select Case tier_type(y)
                              Case "J" 'jet's
                                HttpContext.Current.Session.Item("localSubscription").evoTierlevel = eTierLevelTypes.JETS
                              Case "T" 'turbo
                                HttpContext.Current.Session.Item("localSubscription").evoTierlevel = eTierLevelTypes.TURBOS
                              Case "ALL" 'all
                                HttpContext.Current.Session.Item("localSubscription").evoTierlevel = eTierLevelTypes.ALL
                            End Select
                          Next

                        Case "C" 'commercial
                          ReDim Preserve sProductList(x) 'redimming array each time to keep values
                          sProductList(x) = eProductCodeTypes.C
                      End Select
                    Next

                    If Not IsDBNull(aTempTable.Rows(0).Item("client_regFrequency")) Then
                      ReturnTable = Retrieving_Database_Connection("CRMLIVE", aTempTable.Rows(0).Item("client_regFrequency").ToString())
                      If Not IsNothing(ReturnTable) Then
                        If ReturnTable.Rows.Count > 0 Then
                          HttpContext.Current.Session.Item("localSubscription").evoUserDatabaseConn = "Data Source=" & ReturnTable.Rows(0).Item("connectserver") & ";Initial Catalog=" & ReturnTable.Rows(0).Item("connectdb") & ";Persist Security Info=False;User ID=" & ReturnTable.Rows(0).Item("connectuser") & ";Password=" & ReturnTable.Rows(0).Item("connectpw")
                        End If
                      End If
                    End If

                    ReturnTable = Nothing

                    HttpContext.Current.Session.Item("localSubscription").evoProductCode = sProductList 'this finally sets the product code
                    'This is the only correct return
                    Return 1

                  Else
                    'this person is not logged in
                    Return 2 'this person is not logged in, attempt is invalid.
                  End If
                Else
                  'the timespan is greater than 10 minutes, this is an invalid attempt.
                  Return 3 'this person hasn't been logged in in more than 10 minutes, login is not active.
                End If
              Else
                'there is no session date, this is an invalid attempt.
                'This means there isn't a session date
                'This is also an invalid attempt
                Return 4
              End If
            Else
              'there are no rows, this is an invalid security token.
              'The security token is not valid
              Return 5
            End If
          Else
            'table hasn't been initalized
            'Connection hasn't succeeded
            Return 6
          End If

        Catch MySqlException
          MySqlConn.Dispose()
          MySqlCommand.Dispose()
        Finally
          MySqlConn.Close()
          MySqlCommand.Dispose()
          MySqlConn.Dispose()
        End Try

      Case "EVO", "EVM" 'this means that the security token is an EVO/EVM token and we are holding off on validating this for now.
      Case Else
        'This means that the attempt has an invalid source.
        Return 7
    End Select
  End Function

  ''' <summary>
  ''' Below is the basic company yacht query and example table display for a list of yachts for a company.
  ''' </summary>
  ''' <param name="companyID"></param>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function DisplayYachtForGivenCompanyByCompanyID(ByVal companyID As Long, Optional ByVal contact_list As String = "", Optional ByVal journ_id As Long = 0, Optional ByVal order_by As String = "") As DataTable
    Dim aTempTable As New DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Try

      If Trim(contact_list) <> "" Then
        sql += " select distinct ym_brand_name, ym_model_name,yt_yacht_name, yt_year_mfr, yt_hull_mfr_nbr, yct_name, yt_id, "
        sql += " comp_id, comp_name, comp_city, comp_state, comp_address1, comp_address2, comp_country"
        sql += " from View_Yacht_Company_Flat "
        sql += " where yr_journ_id = " & journ_id & " "
      Else
        sql = "select ym_brand_name, ym_model_name, yt_yacht_name, yct_name,  yt_year_mfr, yt_hull_mfr_nbr, yt_forsale_flag, "
        sql += " yt_forsale_status, yt_asking_price, yt_central_agent_flag, yr_contact_type, yt_id, yt_for_charter_flag, yt_for_lease_flag"
        sql += " from Yacht_Reference with (NOLOCK) "
        sql += " inner join Yacht_Contact_Type with (NOLOCK) on yr_contact_type=yct_code "
        sql += " inner join Yacht with (NOLOCK) on yr_yt_id = yt_id and yr_journ_id = yt_journ_id"
        sql += " inner join Yacht_Model with (NOLOCK) on yt_model_id = ym_model_id"
        sql += " where yr_journ_id =  " & journ_id & " "
      End If



      If Trim(contact_list) <> "" Then
        sql += " And yr_contact_id in (" & contact_list & ") "
      ElseIf companyID > 0 And Trim(contact_list) = "" Then
        sql += " And yr_comp_id = " & companyID & " "
        ' ElseIf companyID > 0 And Trim(contact_list) <> "" Then
        '     sql += " And (yr_comp_id = " & companyID & " or yr_contact_id in (" & contact_list & ")) "
        ' Else
      End If
      sql += " and yct_name <> 'Research Only' "

      If Trim(order_by) <> "" Then
        sql += " order by " & Trim(order_by) & " asc "
      Else
        sql += " order by ym_brand_name, ym_model_name, yt_yacht_name"
      End If

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>DisplayYachtForGivenCompanyByCompanyID(ByVal companyID As Long) As DataTable</b><br />" & sql


      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable
    Catch ex As Exception
      DisplayYachtForGivenCompanyByCompanyID = Nothing
      Me.class_error = "Error in DisplayYachtForGivenCompanyByCompanyID(ByVal companyID As Long) As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try


  End Function
  Public Function DisplayRelatedACTransactionsByContactID(ByVal contact_id_list As String) As DataTable
    Dim aTempTable As New DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Try

      sql = "SELECT journ_id, journ_yacht_id, journ_date, journ_subject, jcat_subcategory_name,"
      sql += " journ_subcategory_code, journ_customer_note, ac_id, cref_comp_id, cref_contact_id,"
      sql += " cref_contact_type, actype_name, contact_first_name, contact_last_name, amod_make_name, amod_model_name, ac_ser_no "
      sql += " FROM Journal WITH(NOLOCK) INNER JOIN Journal_Category WITH(NOLOCK) ON journ_subcategory_code = jcat_subcategory_code"
      sql += " inner join Aircraft WITH(NOLOCK) on journ_ac_id = ac_id and journ_id = ac_journ_id"
      sql += " inner join Aircraft_model WITH(NOLOCK) on ac_amod_id = amod_id "
      sql += " inner join Aircraft_Reference WITH(NOLOCK) on cref_ac_id = ac_id and cref_journ_id = ac_journ_id"
      sql += " inner join Aircraft_Contact_Type WITH(NOLOCK) on cref_contact_type=actype_code"
      sql += " inner join Contact WITH(NOLOCK) on cref_contact_id=contact_id and cref_journ_id = contact_journ_id"
      sql += " WHERE jcat_category_code = 'AH'"
      sql += " and journ_subcategory_code not in ('OM','MA')"
      sql += " AND cref_contact_id in (" & contact_id_list & ") "


      sql += " ORDER BY journ_date DESC, journ_id DESC"


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>DisplayRelatedACTransactionsByContactID(ByVal companyID As Long) As DataTable</b><br />" & sql


      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable
    Catch ex As Exception
      DisplayRelatedACTransactionsByContactID = Nothing
      Me.class_error = "Error in DisplayRelatedACTransactionsByContactID(ByVal companyID As Long) As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try


  End Function

  Public Function Get_Yacht_History(ByVal yt_id As Long, ByVal comp_id As Long, ByVal contact_id As Long, ByVal in_JournalID As Long, ByVal CRMView As Boolean, ByRef journ_date_as_of As String) As String

    Get_Yacht_History = ""

    Dim out_HistoricalRs As New DataTable
    Dim htmlOut As StringBuilder = New StringBuilder()
    Dim SqlReader As System.Data.SqlClient.SqlDataReader = Nothing
    Dim sQuery As String = ""

    Dim BGColor As String = ""
    Dim fJourn_date As String = ""
    Dim fJcat_subcategory_name As String = ""
    Dim fJourn_id As Long = 0
    Dim fJourn_subject As String = ""
    Dim fJourn_customer_note As String = ""
    Dim fJcat_auto_subject_flag As String = ""
    Dim isFromJFWAFW As Boolean = False

    Dim SqlCommand As New System.Data.SqlClient.SqlCommand
    Dim SqlConnection As New System.Data.SqlClient.SqlConnection
    Dim SqlConn As New SqlClient.SqlConnection

    Try

      sQuery = "SELECT journ_id, journ_yacht_id, journ_date, journ_subject, jcat_subcategory_name, "
      sQuery = sQuery & " jcat_auto_subject_flag, journ_subcategory_code, journ_customer_note"
      If yt_id > 0 Then
        sQuery = sQuery & ", yt_id"
      End If

      sQuery = sQuery & " FROM Journal WITH(NOLOCK) INNER JOIN Journal_Category WITH(NOLOCK) ON journ_subcategory_code = jcat_subcategory_code "
      If yt_id > 0 Then
        sQuery = sQuery & " inner join yacht WITH(NOLOCK)  on journ_yacht_id = yt_id and journ_id = yt_journ_id "
      End If
      sQuery = sQuery & " WHERE jcat_category_code = 'YH' "
      sQuery = sQuery & " AND RIGHT(journ_subcategory_code, 4) <> 'CORR' "

      '  If comp_id > 0 Then
      '      sQuery = sQuery & " AND journ_comp_id = " & comp_id
      ' Else
      If yt_id > 0 Then
        sQuery = sQuery & " AND journ_yacht_id = " & yt_id
      Else
      End If

      ' If contact_id > 0 Then
      '   sQuery = sQuery & " AND journ_contact_id = " & contact_id
      '  End If


      If in_JournalID > 0 Then
        sQuery = sQuery & " AND journ_id = " & in_JournalID
      End If


      sQuery = sQuery & " ORDER BY journ_date DESC, journ_id DESC"
      '• Compliance & Certifications Tab – make sure to add the journal ID below – we are getting duplicate records
      ' - select * from Yacht_Compliance where yc_yt_id = 3 and yc_journ_id = 0


      ' sQuery = "SELECT * FROM Journal WITH(NOLOCK) INNER JOIN Journal_Category WITH(NOLOCK) ON Journal.journ_subcategory_code = Journal_Category.jcat_subcategory_code"
      ' sQuery = sQuery & " AND Journal_Category.jcat_category_code = 'AH' AND SUBSTRING(Journal.journ_subcategory_code, 3, 6) <> 'CORR' "
      '  sQuery = sQuery & " AND journ_yacht_id = " & yacht_id


      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sQuery
      SqlReader = SqlCommand.ExecuteReader()
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        out_HistoricalRs.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = out_HistoricalRs.GetErrors()
      End Try



      If Not IsNothing(out_HistoricalRs) Then

        If out_HistoricalRs.Rows.Count > 0 Then
          htmlOut.Append("<div class=""Box""><div class=""subHeader"">HISTORY INFORMATION</div><table class='formatTable blue' cellpadding='0' cellspacing='0' width='100%'>")


          For Each r As DataRow In out_HistoricalRs.Rows

            If BGColor = "engine_6" Then
              BGColor = "engine_5"
            Else
              BGColor = "engine_6"
            End If

            If Not IsDBNull(r("journ_date")) And Not String.IsNullOrEmpty(r("journ_date").ToString) Then
              fJourn_date = FormatDateTime(r("journ_date").ToString.Trim, DateFormat.ShortDate)
              journ_date_as_of = fJourn_date
            End If

            If Not IsDBNull(r("jcat_subcategory_name")) And Not String.IsNullOrEmpty(r("jcat_subcategory_name").ToString) Then
              fJcat_subcategory_name = r("jcat_subcategory_name").ToString.Trim
            End If

            If Not IsDBNull(r("journ_id")) And Not String.IsNullOrEmpty(r("journ_id").ToString) Then
              fJourn_id = CLng(r("journ_id").ToString)
            End If

            If Not IsDBNull(r("journ_subject")) And Not String.IsNullOrEmpty(r("journ_subject").ToString) Then
              fJourn_subject = r("journ_subject").ToString.Trim
            End If

            If Not IsDBNull(r("journ_customer_note")) And Not String.IsNullOrEmpty(r("journ_customer_note").ToString) Then
              fJourn_customer_note = r("journ_customer_note").ToString.Trim
            End If

            If Not IsDBNull(r("jcat_auto_subject_flag")) And Not String.IsNullOrEmpty(r("jcat_auto_subject_flag").ToString) Then
              fJcat_auto_subject_flag = r("jcat_auto_subject_flag").ToString.ToUpper.Trim
            End If

            If isFromJFWAFW Then
              htmlOut.Append("<tr><td valign='top' align='left' class='" & BGColor & " date_block'><span class='date_text'>" + fJourn_date + "</span></td>")
              htmlOut.Append("<td valign='top' align='left' class='" & BGColor & "'><span class='url_link'>")
            Else
              htmlOut.Append("<tr><td valign='top' align='left' class='" & BGColor & " date_block'>")
              htmlOut.Append("<span>")
              If CRMView = True Then
                htmlOut.Append("<span ")
              Else
                If yt_id > 0 Then
                  htmlOut.Append("<a " + DisplayFunctions.WriteYachtDetailsLink(yt_id, False, "", "date_text", "&jid=" & fJourn_id & ""))
                Else
                  htmlOut.Append("<span ")
                End If
              End If

              htmlOut.Append(">" + fJourn_date)

              If CRMView = True Then
                htmlOut.Append("</span></span></td>")
              Else
                If yt_id > 0 Then
                  htmlOut.Append("</a></span></td>")
                Else
                  htmlOut.Append("</span></span></td>")
                End If
              End If

              htmlOut.Append("<td valign='top' align='left' class='" & BGColor & "'><span class='url_link'>")

              If CRMView = True Then
                htmlOut.Append("<span")
              Else
                If yt_id > 0 Then
                  htmlOut.Append("<a " & DisplayFunctions.WriteYachtDetailsLink(yt_id, False, "", "date_text", "&jid=" & fJourn_id & ""))
                Else
                  htmlOut.Append("<span")
                End If
              End If
              htmlOut.Append(">")
            End If



            If fJcat_auto_subject_flag = "Y" Then

              htmlOut.Append(Constants.cSingleSpace + fJcat_subcategory_name)

              'If fJcat_subcategory_name.ToLower.Contains("fractional sale") Then
              '    htmlOut.Append(Constants.cSingleSpace + CommonAircraftFunctions.GetFractionPercent(MySesState, fJourn_id, False))
              'End If

              htmlOut.Append(" - " + fJourn_subject)

            Else
              htmlOut.Append(Constants.cSingleSpace + fJourn_subject)
            End If




            If isFromJFWAFW Then
              '  htmlOut.Append("</td><td valign='top' align='left'  class='" & BGColor & "'>")
            Else
              htmlOut.Append("</a>")
              ' htmlOut.Append("</a></td><td valign='top' align='left' class='" & BGColor & "'>")
            End If
            htmlOut.Append("</span>")
            htmlOut.Append("<br />")


            htmlOut.Append("</td></tr>")

            If Trim(fJourn_customer_note) <> "" Then
              htmlOut.Append("<tr><td colspan='2' align='left'>" & fJourn_customer_note & "</td></tr>")
            End If

          Next
          htmlOut.Append("</table></div>")
        End If

      End If


      Get_Yacht_History = htmlOut.ToString

    Catch ex As Exception

    End Try
  End Function
  Public Function DisplayRelatedYachtTransactionsByContactID(ByVal contact_id_list As String, ByVal comp_id As Long, ByVal journ_id As Long) As DataTable
    Dim aTempTable As New DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Try


      sql = "SELECT journ_id, journ_yacht_id, journ_date, journ_subject, jcat_subcategory_name, "
      sql += " journ_subcategory_code, journ_customer_note, yt_id, yr_comp_id, yr_contact_id,"
      sql += " yr_contact_type, yct_name, yt_yacht_name, ym_brand_name, ym_model_name "
      If comp_id = 0 Then
        sql += ", contact_first_name, contact_last_name "
      End If
      sql += " FROM Journal WITH(NOLOCK) INNER JOIN Journal_Category WITH(NOLOCK) ON journ_subcategory_code = jcat_subcategory_code "
      sql += " inner join Yacht WITH(NOLOCK)  on journ_yacht_id = yt_id and journ_id = yt_journ_id "
      sql += " inner join Yacht_Model WITH(NOLOCK)  on ym_model_id = yt_model_id "
      sql += " inner join Yacht_Reference WITH(NOLOCK)  on yr_yt_id = yt_id and yr_journ_id = yt_journ_id"
      sql += " inner join Yacht_Contact_Type WITH(NOLOCK)  on yr_contact_type=yct_code"
      If comp_id = 0 Then
        sql += " inner join Contact WITH(NOLOCK)  on yr_contact_id=contact_id and yr_journ_id = contact_journ_id"
      End If
      sql += " WHERE jcat_category_code = 'YH' "
      sql += " AND RIGHT(journ_subcategory_code, 4) <> 'CORR' "

      If comp_id = 0 Then
        sql += " AND yr_contact_id in (" & contact_id_list & ") "
      Else
        sql += " AND yr_comp_id = " & comp_id & ""
      End If



      If journ_id > 0 Then
        sql += " AND journ_id = " & journ_id & ""
      End If



      sql += " and yct_name <> 'Research Only' "

      sql += " ORDER BY journ_date DESC, journ_id DESC, yr_seq_no"


      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>DisplayRelatedYachtTransactionsByContactID</b><br />" & sql


      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        aTempTable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try
      Return aTempTable
    Catch ex As Exception
      DisplayRelatedYachtTransactionsByContactID = Nothing
      Me.class_error = "Error in DisplayRelatedYachtTransactionsByContactID(ByVal companyID As Long) As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try


  End Function
  ''' <summary>
  ''' Displays a list of Yacht Brands
  ''' </summary>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function ListOfYachtBrands() As DataTable
    'sql
    Dim temptable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim sql As String = ""
    Try

      sql = " select distinct ym_brand_name from yacht_model with (NOLOCK) "
      sql += " group by ym_brand_name"
      sql += " order by ym_brand_name"

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>ListOfYachtBrands() As DataTable</b><br />" & sql

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        temptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = temptable.GetErrors()
      End Try
      Return temptable
    Catch ex As Exception
      ListOfYachtBrands = Nothing
      Me.class_error = "Error in ListOfYachtBrands() As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try


  End Function

  ''' <summary>
  ''' Displays a list of Yacht Brands
  ''' </summary>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function ListOfYachtStagesStatusCombined() As DataTable
    'sql
    Dim temptable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim sql As String = ""
    Try

      sql = "select yl_lifecycle_name, yls_lifecycle_status, yl_lifecyle_id "
      sql += " from Yacht_Lifecycle with (NOLOCK)"
      sql += " inner join Yacht_Lifecycle_Status WITH(NOLOCK)  on yl_lifecyle_id = yls_lifecycle_stage"
      sql += " order by yl_lifecycle_seqnbr asc, yls_lifecycle_stage, yls_lifecycle_status"
      'sql += " order by yls_lifecycle_stage, yls_lifecycle_status"


      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>ListOfYachtStagesStatusCombined() As DataTable</b><br />" & sql

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        temptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = temptable.GetErrors()
      End Try
      Return temptable
    Catch ex As Exception
      ListOfYachtStagesStatusCombined = Nothing
      Me.class_error = "Error in ListOfYachtStagesStatusCombined() As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try


  End Function

  ''' <summary>
  ''' Displays Yacht Specifications by ID
  ''' </summary>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function DisplayYachtSpecificationsByID(ByVal yacht_id As Long) As DataTable
    Dim temptable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim sql As String = ""
    Try

      sql = "SELECT *, (select yp_port_name from yacht_port where yp_id = yt_port_registered_id) as reg_port "
      sql += " , (select yp_port_name from yacht_port where yp_id = yt_lying_port_id) as ly_port "
      sql += " , (select yp_port_name from yacht_port where yp_id = yt_home_port_id) as home_port "
      sql += " FROM yacht WITH(NOLOCK) "
      sql += " inner join yacht_model WITH(NOLOCK)  on ym_model_id = yt_model_id "
      sql += " inner join yacht_category_size WITH(NOLOCK)  on  ycs_motor_type = ym_motor_type and ycs_category_size = ym_category_size "
      sql += " inner join yacht_motor_type WITH(NOLOCK)  on  ymt_motor_type = ym_motor_type  "
      sql += " inner join yacht_classification_society_types WITH(NOLOCK)  on ycst_code = yt_class_id  "
      sql += " WHERE yt_id = " & yacht_id
      sql += " AND yt_journ_id = 0 "

      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>DisplayYachtSpecificationsByID(ByVal yacht_id As Long) As DataTable</b><br />" & sql

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        temptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = temptable.GetErrors()
      End Try
      Return temptable
    Catch ex As Exception
      DisplayYachtSpecificationsByID = Nothing
      Me.class_error = "Error in DisplayYachtSpecificationsByID(ByVal yacht_id As Long) As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try


  End Function

  ''' <summary>
  ''' Displays a list of categories.
  ''' </summary>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function ListOfYachtCategorySize() As DataTable
    'sql
    Dim temptable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim sql As String = ""
    Try

      sql = " select distinct ycs_description, ymt_description, ym_motor_type, ym_category_size from yacht_model with (NOLOCK) "
      sql += " inner join Yacht_Motor_Type with (NOLOCK) on ymt_motor_type=ym_motor_type "
      sql += " inner join Yacht_Category_size with (NOLOCK) on ym_category_size=ycs_category_size and ym_motor_type=ycs_motor_type "
      sql += " group by ycs_description, ymt_description, ym_motor_type, ym_category_size"
      sql += " order by ycs_description, ymt_description"


      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>ListOfYachtCategorySize() As DataTable</b><br />" & sql

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        temptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = temptable.GetErrors()
      End Try
      Return temptable

    Catch ex As Exception
      ListOfYachtCategorySize = Nothing
      Me.class_error = "Error in ListOfYachtCategorySize() As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try


  End Function


  ''' <summary>
  ''' This function is a list of the top ten news events for the home page (on the yacht side).
  ''' </summary>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function ListOfYachtNews(ByVal YachtID As Long) As DataTable
    Dim temptable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim sql As String = ""
    Try

      If YachtID = 0 Then
        sql = "select top 100 * from View_Yacht_News where ytnews_date >= '" & DateAdd(DateInterval.Day, -14, Date.Now) & "' order by ytnews_date desc"
      Else
        sql = "select * from View_Yacht_News where yt_id = " & YachtID & " order by ytnews_date desc"
      End If

      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>ListOfYachtNews() As DataTable</b><br />" & sql

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        temptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = temptable.GetErrors()
      End Try
      Return temptable

    Catch ex As Exception
      ListOfYachtNews = Nothing
      Me.class_error = "Error in ListOfYachtNews() As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try


  End Function

  ''' <summary>
  ''' This is a function that's going to display yacht information by ID.
  ''' This query can be worked on or modified. I just took a modified version of the query that shows on the yacht details page.
  ''' </summary>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function DisplayYachtByID(ByVal YachtID As Long) As DataTable
    Dim temptable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim sql As String = ""
    Try


      sql = "SELECT *"
      sql += " FROM yacht WITH(NOLOCK) "
      sql += " inner join yacht_model WITH(NOLOCK)  on ym_model_id = yt_model_id "
      sql += " inner join yacht_category_size  WITH(NOLOCK) on  ycs_motor_type = ym_motor_type and ycs_category_size = ym_category_size "
      sql += " inner join yacht_motor_type WITH(NOLOCK) on  ymt_motor_type = ym_motor_type  "
      sql += " WHERE yt_id = " & YachtID
      sql += " AND yt_journ_id = 0 "

      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        temptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = temptable.GetErrors()
      End Try
      Return temptable

    Catch ex As Exception
      DisplayYachtByID = Nothing
      Me.class_error = "Error in DisplayYachtByID(ByVal YachtID As Long) As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try


  End Function
  Public Function DisplayYachtByIDClause(ByVal YachtIDs As String) As DataTable
    Dim temptable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim sql As String = ""
    Try


      sql = "SELECT yt_id, yt_yacht_name, yt_hull_mfr_nbr "
      sql += " FROM yacht WITH(NOLOCK) "
      sql += " inner join yacht_model WITH(NOLOCK)  on ym_model_id = yt_model_id "
      sql += " inner join yacht_category_size  WITH(NOLOCK) on  ycs_motor_type = ym_motor_type and ycs_category_size = ym_category_size "
      sql += " inner join yacht_motor_type WITH(NOLOCK) on  ymt_motor_type = ym_motor_type  "
      sql += " WHERE yt_id in (" & YachtIDs & ")"
      sql += " AND yt_journ_id = 0 "

      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        temptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = temptable.GetErrors()
      End Try
      Return temptable

    Catch ex As Exception
      DisplayYachtByIDClause = Nothing
      Me.class_error = "Error in DisplayYachtByIDClause(ByVal YachtIDs As String) As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try


  End Function

  ''' <summary>
  ''' Displays a list of yacht market categories.
  ''' </summary>
  ''' <returns></returns>
  ''' <remarks></remarks>
  Public Function ListOfYachtMarketCategories() As DataTable
    'sql
    Dim temptable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim sql As String = ""
    Try

      sql = "select distinct ypec_category from Yacht_Priority_Events_Category  WITH(NOLOCK) order by ypec_category"


      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>ListOfYachtMarketCategories() As DataTable</b><br />" & sql

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        temptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = temptable.GetErrors()
      End Try
      Return temptable

    Catch ex As Exception
      ListOfYachtMarketCategories = Nothing
      Me.class_error = "Error in ListOfYachtMarketCategories() As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try


  End Function

  Public Function ListOfYachtMarketTypes(ByVal category As String) As DataTable
    'sql
    Dim temptable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim sql As String = ""
    Try

      sql = "select distinct ypec_category_name from Yacht_Priority_Events_Category  where ypec_category in (" & category & ") order by ypec_category_name"


      SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
      SqlConn.Open()
      SqlCommand.Connection = SqlConn

      HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>ListOfYachtMarketTypes(ByVal category As String) As DataTable</b><br />" & sql

      SqlCommand.CommandText = sql
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60

      Try
        temptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = temptable.GetErrors()
      End Try
      Return temptable

    Catch ex As Exception
      ListOfYachtMarketTypes = Nothing
      Me.class_error = "Error in ListOfYachtMarketTypes(ByVal category As String) As DataTable: SQL VERSION " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try


  End Function
  '#Region "Yacht View Queries"
  '    ''' <summary>
  '    ''' Summarizes the Yacht Fleet Lifecycle
  '    ''' </summary>
  '    ''' <returns></returns>
  '    ''' <remarks></remarks>
  '    Public Function YachtFleetSummary() As DataTable
  '        'sql
  '        Dim temptable As New DataTable
  '        Dim SqlConn As New SqlClient.SqlConnection
  '        Dim SqlCommand As New SqlClient.SqlCommand
  '        Dim SqlReader As SqlClient.SqlDataReader
  '        Dim SqlException As SqlClient.SqlException : SqlException = Nothing
  '        Dim sql As String = ""
  '        Try

  '            sql = " select distinct yl_lifecycle_name, yt_lifecycle_id, count(*) as tcount"
  '            sql += " from yacht"
  '            sql += " inner join Yacht_Lifecycle with (NOLOCK) on yt_lifecycle_id=yl_lifecyle_id "
  '            sql += " where yt_journ_id = 0 "
  '            sql += " group by yl_lifecycle_name, yt_lifecycle_id"
  '            sql += " order by yt_lifecycle_id"

  '            SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
  '            SqlConn.Open()
  '            SqlCommand.Connection = SqlConn

  '            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>YachtFleetSummary() As DataTable</b><br />" & sql

  '            SqlCommand.CommandText = sql
  '            SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
  '            SqlCommand.CommandType = CommandType.Text
  '            SqlCommand.CommandTimeout = 60

  '            Try
  '                temptable.Load(SqlReader)
  '            Catch constrExc As System.Data.ConstraintException
  '                Dim rowsErr As System.Data.DataRow() = temptable.GetErrors()
  '            End Try
  '            Return temptable
  '        Catch ex As Exception
  '            YachtFleetSummary = Nothing
  '            Me.class_error = "Error in YachtFleetSummary() As DataTable: SQL VERSION " & ex.Message
  '        Finally
  '            SqlReader = Nothing

  '            SqlConn.Dispose()
  '            SqlConn.Close()
  '            SqlConn = Nothing

  '            SqlCommand.Dispose()
  '            SqlCommand = Nothing
  '        End Try


  '    End Function

  '    ''' <summary>
  '    ''' Summarizes the Yachts by Year
  '    ''' </summary>
  '    ''' <returns></returns>
  '    ''' <remarks></remarks>
  '    Public Function YachtYearSummary() As DataTable
  '        'sql
  '        Dim temptable As New DataTable
  '        Dim SqlConn As New SqlClient.SqlConnection
  '        Dim SqlCommand As New SqlClient.SqlCommand
  '        Dim SqlReader As SqlClient.SqlDataReader
  '        Dim SqlException As SqlClient.SqlException : SqlException = Nothing
  '        Dim sql As String = ""
  '        Try

  '            sql = " select distinct yt_year_mfr, count(*) as tcount"
  '            sql += " from yacht"
  '            sql += " where yt_journ_id = 0 "
  '            sql += " group by yt_year_mfr"
  '            sql += " order by yt_year_mfr"

  '            SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
  '            SqlConn.Open()
  '            SqlCommand.Connection = SqlConn

  '            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>YachtYearSummary() As DataTable</b><br />" & sql

  '            SqlCommand.CommandText = sql
  '            SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
  '            SqlCommand.CommandType = CommandType.Text
  '            SqlCommand.CommandTimeout = 60

  '            Try
  '                temptable.Load(SqlReader)
  '            Catch constrExc As System.Data.ConstraintException
  '                Dim rowsErr As System.Data.DataRow() = temptable.GetErrors()
  '            End Try
  '            Return temptable
  '        Catch ex As Exception
  '            YachtYearSummary = Nothing
  '            Me.class_error = "Error in YachtYearSummary() As DataTable: SQL VERSION " & ex.Message
  '        Finally
  '            SqlReader = Nothing

  '            SqlConn.Dispose()
  '            SqlConn.Close()
  '            SqlConn = Nothing

  '            SqlCommand.Dispose()
  '            SqlCommand = Nothing
  '        End Try


  '    End Function

  '    ''' <summary>
  '    ''' Summarizes the Yachts by Brand
  '    ''' </summary>
  '    ''' <returns></returns>
  '    ''' <remarks></remarks>
  '    Public Function YachtBrandSummary() As DataTable
  '        'sql
  '        Dim temptable As New DataTable
  '        Dim SqlConn As New SqlClient.SqlConnection
  '        Dim SqlCommand As New SqlClient.SqlCommand
  '        Dim SqlReader As SqlClient.SqlDataReader
  '        Dim SqlException As SqlClient.SqlException : SqlException = Nothing
  '        Dim sql As String = ""
  '        Try

  '            sql = " select distinct ym_brand_name, count(*) as tcount"
  '            sql += " from yacht"
  '            sql += " inner join yacht_model on ym_model_id = yt_model_id "
  '            sql += " where yt_journ_id = 0 "
  '            sql += " group by ym_brand_name"
  '            sql += " order by ym_brand_name"

  '            SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
  '            SqlConn.Open()
  '            SqlCommand.Connection = SqlConn

  '            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>YachtBrandSummary() As DataTable</b><br />" & sql

  '            SqlCommand.CommandText = sql
  '            SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
  '            SqlCommand.CommandType = CommandType.Text
  '            SqlCommand.CommandTimeout = 60

  '            Try
  '                temptable.Load(SqlReader)
  '            Catch constrExc As System.Data.ConstraintException
  '                Dim rowsErr As System.Data.DataRow() = temptable.GetErrors()
  '            End Try
  '            Return temptable
  '        Catch ex As Exception
  '            YachtBrandSummary = Nothing
  '            Me.class_error = "Error in YachtBrandSummary() As DataTable: SQL VERSION " & ex.Message
  '        Finally
  '            SqlReader = Nothing

  '            SqlConn.Dispose()
  '            SqlConn.Close()
  '            SqlConn = Nothing

  '            SqlCommand.Dispose()
  '            SqlCommand = Nothing
  '        End Try


  '    End Function

  '    ''' <summary>
  '    ''' Summarize Yachts by Motor Type
  '    ''' </summary>
  '    ''' <param name="TypeDesignation"></param>
  '    ''' <returns></returns>
  '    ''' <remarks></remarks>
  '    Public Function SummarizeYachtsByType(ByVal TypeDesignation As String) As DataTable
  '        Dim temptable As New DataTable
  '        Dim SqlConn As New SqlClient.SqlConnection
  '        Dim SqlCommand As New SqlClient.SqlCommand
  '        Dim SqlReader As SqlClient.SqlDataReader
  '        Dim SqlException As SqlClient.SqlException : SqlException = Nothing
  '        Dim sql As String = ""
  '        Try

  '            sql = "select distinct ymt_description, ym_motor_type, ycs_seqnbr, ycs_description, ym_category_size, count(*) as tcount,"
  '            sql += " (select COUNT(*) from Yacht with (NOLOCK)"
  '            sql += " inner join Yacht_Model with (NOLOCK) on yt_model_id=ym_model_id"
  '            sql += " where ym_motor_type=m.ym_motor_type and ym_category_size = m.ym_category_size and yt_forsale_flag='Y') as yforsale"
  '            sql += " from yacht "
  '            sql += " inner join Yacht_Model m with (NOLOCK) on yt_model_id=ym_model_id"
  '            sql += " inner join Yacht_Category_size with (NOLOCK) on ym_category_size=ycs_category_size and ym_motor_type=ycs_motor_type"
  '            sql += " inner join Yacht_Motor_Type with (NOLOCK) on ymt_motor_type=ym_motor_type"
  '            sql += " where yt_journ_id = 0 "
  '            sql += " AND ymt_motor_type = '" & TypeDesignation & "'"
  '            sql += " group by ymt_description, ym_motor_type, ycs_seqnbr, ycs_description, ym_category_size "
  '            sql += " order by ymt_description, ym_motor_type, ycs_seqnbr, ycs_description, ym_category_size"

  '            SqlConn.ConnectionString = JETNET_DB 'My.Settings.DEFAULT_LIVE_MSSQL_DEBUG.ToString
  '            SqlConn.Open()
  '            SqlCommand.Connection = SqlConn

  '            HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>SummarizeYachtsByType(ByVal TypeDesignation As String) As DataTable:</b><br />" & sql

  '            SqlCommand.CommandText = sql
  '            SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
  '            SqlCommand.CommandType = CommandType.Text
  '            SqlCommand.CommandTimeout = 60

  '            Try
  '                temptable.Load(SqlReader)
  '            Catch constrExc As System.Data.ConstraintException
  '                Dim rowsErr As System.Data.DataRow() = temptable.GetErrors()
  '            End Try
  '            Return temptable
  '        Catch ex As Exception
  '            SummarizeYachtsByType = Nothing
  '            Me.class_error = "Error in SummarizeYachtsByType(ByVal TypeDesignation As String) As DataTable: SQL VERSION " & ex.Message
  '        Finally
  '            SqlReader = Nothing

  '            SqlConn.Dispose()
  '            SqlConn.Close()
  '            SqlConn = Nothing

  '            SqlCommand.Dispose()
  '            SqlCommand = Nothing
  '        End Try


  '    End Function
  '#End Region
#End Region

#Region "Cloud Notes Database Queries"
  Public Function CloudNotesDetailsACDistinct(ByVal ModelString As String, ByVal subID As Long, ByVal login As String, ByVal aircraftNoteDate As String) As DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim aTempTable As New DataTable
    Try
      If HttpContext.Current.Session.Item("localSubscription").crmCloudNotesDBName.ToString <> "" Then
        'Setting up the query strings and some of the parameters. 
        Dim squery As String = ""

        squery = "SELECT "
        squery += " distinct cn_ac_id as lnote_jetnet_ac_id "
        squery += " from " & HttpContext.Current.Session.Item("localSubscription").crmCloudNotesDBName.ToString & " "

        squery += " WHERE (cn_status in ('A','E') ) "

        squery += " and ( "
        squery += " (cn_notes not like 'no answer%') and (cn_notes not like 'message left%') and (cn_notes not like 'left voicemail%') and (cn_notes not like 'left message%') "
        squery += " )"

        'If subID <> 0 Then
        '  squery += " AND (cn_user_sub_id = " & subID & ")  "
        'End If
        'If Login <> "" Then
        '  squery += " AND (cn_user_login = '" & Trim(login) & "') "
        'End If


        If ModelString <> "" Then
          squery += " and cn_amod_id in (" & ModelString & ") "
        End If
        squery += " and cn_ac_id > 0 "

        If aircraftNoteDate <> "" Then
          squery += " and (cn_entry_date >= '" & aircraftNoteDate & "')"
        End If

        clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, squery.ToString)

        SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString
        SqlConn.Open()
        SqlCommand.CommandTimeout = 60
        SqlCommand.Connection = SqlConn


        SqlCommand.CommandText = squery
        SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
        SqlCommand.CommandType = CommandType.Text


        Try
          aTempTable.Load(SqlReader)
        Catch constrExc As System.Data.ConstraintException
          Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
        End Try

      End If
      Return aTempTable
    Catch ex As Exception
      CloudNotesDetailsACDistinct = Nothing
      Me.class_error = "Error in SQL CloudNotesDetailsACDistinct(): " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function


  Public Function Get_CloudNotes_GetByUserIDStatusLessThanDate(ByVal subID As Long, ByVal login As String, ByVal start_date As String, ByVal status As String, Optional ByVal is_export_all_notes As Boolean = False) As DataTable
    Dim sql As String = ""
    Dim aTempTable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    If Trim(start_date) <> "" Then
      start_date = Format(CDate(start_date), "yyyy-MM-dd HH:mm:ss")
    End If

    Try
      If HttpContext.Current.Session.Item("localSubscription").crmCloudNotesDBName.ToString <> "" Then
        '[cn_id] [int] IDENTITY(1,1) NOT NULL,
        '[cn_ac_id] [int] NOT NULL,
        '[cn_comp_id] [int] NOT NULL,
        '[cn_contact_id] [int] NOT NULL,
        '[cn_notes] [text] NOT NULL,
        '[cn_entry_date] [datetime] NULL,
        '[cn_action_date] [datetime] NULL,
        '[cn_user_comp_id] [int] NOT NULL,
        '[cn_user_sub_id] [int] NOT NULL,
        '[cn_user_login] [varchar](100) NOT NULL,
        '[cn_user_email] [varchar](150) NOT NULL,
        '[cn_user_name] [varchar](100) NOT NULL,
        '[cn_user_contact_id] [int] NOT NULL,
        '[cn_status] [char](1) NOT NULL,
        '[cn_schedule_start_date] [datetime] NULL,
        '[cn_schedule_end_date] [datetime] NULL,
        '[cn_clipri_ID] [int] NOT NULL,
        '[cn_amod_id] [int] NOT NULL,
        '[cn_ym_model_id] [int] NOT NULL,
        '[cn_yt_id] [int] NOT NULL

        sql = "SELECT "
        sql = sql & " cn_id as lnote_id, cn_ac_id as lnote_jetnet_ac_id, cn_yt_id as lnote_jetnet_yacht_id,cn_comp_id as lnote_jetnet_comp_id, '0' as lnote_client_ac_id, '0' as lnote_client_comp_id, "
        sql = sql & " cn_contact_id as lnote_jetnet_contact_id, '0' as lnote_client_contact_id, cn_notes as lnote_note, cn_entry_date as lnote_entry_date, "
        sql = sql & "  cn_action_date as lnote_action_date, cn_user_login as lnote_user_login, cn_user_name as lnote_user_name, '25' as lnote_notecat_key, cn_status as lnote_status, "
        sql = sql & " cn_schedule_start_date as lnote_schedule_start_date, cn_schedule_end_date as lnote_schedule_end_date, "
        sql = sql & " cn_user_contact_id as lnote_user_id, '0' as lnote_clipri_ID, '' as clipri_name, "
        sql = sql & " '0' as clipri_sort_order, 'N' as lnote_document_flag, cn_amod_id as lnote_jetnet_amod_id, '0' as lnote_client_amod_id, "
        sql = sql & " '' as lnote_document_name, '' as lnote_opportunity_status, '0' as lnote_cash_value, '0' as lnote_capture_percentage, "
        sql = sql & " '' as lnote_wanted_start_year, '' as lnote_wanted_end_year, '0' as lnote_wanted_max_price, '0' as lnote_wanted_max_aftt, "
        sql = sql & "  '' as lnote_wanted_damage_hist, '' as lnote_wanted_damage_cur"
        sql = sql & " from " & HttpContext.Current.Session.Item("localSubscription").crmCloudNotesDBName.ToString


        If is_export_all_notes = True Then
          sql = sql & " ORDER BY cn_schedule_start_date"
        Else
          sql = sql & " WHERE "

          If subID <> 0 Then
            sql = sql & " (cn_user_sub_id = " & subID & ") AND "
          End If
          If login <> "" Then
            sql = sql & " (cn_user_login = '" & Trim(login) & "') AND "
          End If

          'If the user is on a yacht application, we go ahead and ignore the aircraft notes
          If HttpContext.Current.Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.YACHT Then
            sql = sql & " (cn_ac_id = 0) AND "
          Else
            sql = sql & " (cn_yt_id = 0) AND "
          End If


          If Trim(start_date) <> "" Then
            sql = sql & " (cn_schedule_start_date <= '" & start_date & "') AND "
          End If

          sql = sql & " (cn_status = '" & status & "')"
          sql = sql & " ORDER BY cn_schedule_start_date"
        End If


        'save to session query debug string.
        clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sql.ToString)

        SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString
        SqlConn.Open()
        SqlCommand.CommandTimeout = 60
        SqlCommand.Connection = SqlConn


        SqlCommand.CommandText = sql
        SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
        SqlCommand.CommandType = CommandType.Text


        Try
          aTempTable.Load(SqlReader)
        Catch constrExc As System.Data.ConstraintException
          Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
        End Try

      End If
      Return aTempTable
    Catch ex As Exception
      Get_CloudNotes_GetByUserIDStatusLessThanDate = Nothing
      Me.class_error = "Error in SQL Get_CloudNotes_GetByUserIDStatusLessThanDate(ByVal subID As Long, ByVal login As String, ByVal start_date As String, ByVal status As String) As DataTable " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function

  Public Function CloudNotesDetailsNoteListingQuery(ByVal jetnet_ID As Long, ByVal lnote_status As String, ByVal aircraft As Boolean, ByVal company As Boolean, ByVal Yacht As Boolean, ByVal limit As Boolean) As DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim aTempTable As New DataTable
    Try
      If HttpContext.Current.Session.Item("localSubscription").crmCloudNotesDBName.ToString <> "" Then
        'Setting up the query strings and some of the parameters. 
        Dim squery As String = ""

        Dim order_by As String = " cn_entry_date desc"
        If lnote_status = "P" Then
          order_by = " cn_schedule_start_date asc"
        End If

        squery = "SELECT "
        If limit Then
          squery = squery & " top 1 "
        End If
        squery = squery & " cn_id as lnote_id, cn_ac_id as lnote_jetnet_ac_id, cn_yt_id as lnote_jetnet_yacht_id, cn_comp_id as lnote_jetnet_comp_id, '0' as lnote_client_ac_id, '0' as lnote_client_comp_id, "
        squery = squery & " cn_contact_id as lnote_jetnet_contact_id, '0' as lnote_client_contact_id, cn_notes as lnote_note, cn_entry_date as lnote_entry_date, "
        squery = squery & " cn_action_date as lnote_action_date, cn_user_login as lnote_user_login, cn_user_name as lnote_user_name, '25' as lnote_notecat_key, cn_status as lnote_status, "
        squery = squery & " cn_schedule_start_date as lnote_schedule_start_date, cn_schedule_end_date as lnote_schedule_end_date, cn_user_contact_id as lnote_user_id, '0' as lnote_clipri_ID, "
        squery = squery & " 'N' as lnote_document_flag,  cn_amod_id as lnote_jetnet_amod_id, '0' as lnote_client_amod_id, '' as lnote_document_name "
        squery = squery & " from " & HttpContext.Current.Session.Item("localSubscription").crmCloudNotesDBName.ToString & " "


        If lnote_status = "A" Then
          lnote_status = " (cn_status in ('A','E') )  "
        ElseIf lnote_status = "" Then
          lnote_status = ""
        Else
          lnote_status = " (cn_status = '" & lnote_status & "' )   "
        End If


        If aircraft = True Then 'Aircraft data
          squery = squery & "WHERE " & lnote_status & ""

          If jetnet_ID <> 0 Then 'Aircraft Jetnet Side Data
            If lnote_status <> "" Then
              squery = squery & " and "
            End If
            squery = squery & " (cn_ac_id ='" & jetnet_ID & "') "
          End If

          squery = squery & "ORDER BY " & order_by
        ElseIf Yacht = True Then 'Yacht data
          squery = squery & "WHERE " & lnote_status & ""

          If jetnet_ID <> 0 Then 'Yacht Jetnet Side Data
            If lnote_status <> "" Then
              squery = squery & " and "
            End If
            squery = squery & " (cn_yt_id ='" & jetnet_ID & "') "
          End If

          squery = squery & "ORDER BY " & order_by
        Else ' company must be true, company Data.
          squery = squery & "WHERE " & lnote_status & ""

          If jetnet_ID <> 0 Then 'Aircraft Jetnet Side Data
            If lnote_status <> "" Then
              squery = squery & " and "
            End If
            squery = squery & " (cn_comp_id ='" & jetnet_ID & "') "
          End If

          squery = squery & "ORDER BY " & order_by
        End If

        clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, squery.ToString)

        SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString
        SqlConn.Open()
        SqlCommand.CommandTimeout = 60
        SqlCommand.Connection = SqlConn


        SqlCommand.CommandText = squery
        SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
        SqlCommand.CommandType = CommandType.Text


        Try
          aTempTable.Load(SqlReader)
        Catch constrExc As System.Data.ConstraintException
          Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
        End Try

      End If
      Return aTempTable
    Catch ex As Exception
      CloudNotesDetailsNoteListingQuery = Nothing
      Me.class_error = "Error in SQL CloudNotesDetailsNoteListingQuery(ByVal " & jetnet_ID & " As Long, ByVal " & lnote_status & " As String, ByVal " & aircraft.ToString & " As Boolean, ByVal " & company.ToString & " As Boolean): " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function

  Public Function Get_CloudNotes_ByID(ByVal subID As Long, ByVal login As String, ByVal noteID As Long) As DataTable
    Dim sql As String = ""
    Dim aTempTable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Try
      If HttpContext.Current.Session.Item("localSubscription").crmCloudNotesDBName.ToString <> "" Then

        sql = "SELECT "
        sql = sql & " cn_id as lnote_id, cn_ac_id as lnote_jetnet_ac_id, cn_comp_id as lnote_jetnet_comp_id, '0' as lnote_client_ac_id, '0' as lnote_client_comp_id, "
        sql = sql & " cn_contact_id as lnote_jetnet_contact_id, '0' as lnote_client_contact_id, cn_notes as lnote_note, cn_entry_date as lnote_entry_date, "
        sql = sql & "  cn_action_date as lnote_action_date, cn_user_login as lnote_user_login, cn_user_name as lnote_user_name, '25' as lnote_notecat_key, cn_status as lnote_status, "
        sql = sql & " cn_schedule_start_date as lnote_schedule_start_date, cn_schedule_end_date as lnote_schedule_end_date, "
        sql = sql & " cn_user_contact_id as lnote_user_id, '0' as lnote_clipri_ID, '' as clipri_name, "
        sql = sql & " '0' as clipri_sort_order, 'N' as lnote_document_flag, cn_amod_id as lnote_jetnet_amod_id, '0' as lnote_client_amod_id, "
        sql = sql & " '' as lnote_document_name, '' as lnote_opportunity_status, '0' as lnote_cash_value, '0' as lnote_capture_percentage, "
        sql = sql & " '' as lnote_wanted_start_year, '' as lnote_wanted_end_year, '0' as lnote_wanted_max_price, '0' as lnote_wanted_max_aftt, "
        sql = sql & "  '' as lnote_wanted_damage_hist, '' as lnote_wanted_damage_cur"
        sql = sql & " from " & HttpContext.Current.Session.Item("localSubscription").crmCloudNotesDBName.ToString

        sql = sql & " WHERE "

        If subID <> 0 Then
          sql = sql & " (cn_user_sub_id = " & subID & ") AND "
        End If
        If login <> "" Then
          sql = sql & " (cn_user_login = '" & Trim(login) & "') AND "
        End If

        sql = sql & " (cn_id = " & noteID & ") "
        sql = sql & " ORDER BY cn_schedule_start_date"

        'save to session query debug string.
        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Get_CloudNotes_ByID(ByVal subID As Long, ByVal login As String, ByVal noteID As Long) As DataTable</b><br />" & sql

        SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString
        SqlConn.Open()
        SqlCommand.CommandTimeout = 60
        SqlCommand.Connection = SqlConn


        SqlCommand.CommandText = sql
        SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
        SqlCommand.CommandType = CommandType.Text


        Try
          aTempTable.Load(SqlReader)
        Catch constrExc As System.Data.ConstraintException
          Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
        End Try

      End If
      Return aTempTable
    Catch ex As Exception
      Get_CloudNotes_ByID = Nothing
      Me.class_error = "Error in SQL Get_CloudNotes_ByID(ByVal subID As Long, ByVal login As String, ByVal noteID As Long) As DataTable " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function

  Public Function Insert_StandardCloudNote(ByVal aclsLocal_Notes As clsLocal_Notes) As Integer
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing

    Dim atemptable As New DataTable
    Dim sql As String = ""
    Dim returned_id As Integer = 0
    Try
      If HttpContext.Current.Session.Item("localSubscription").crmCloudNotesDBName.ToString <> "" Then
        sql = "insert into " & HttpContext.Current.Session.Item("localSubscription").crmCloudNotesDBName.ToString & "(cn_ac_id, "
        sql = sql & " cn_comp_id,  cn_notes, cn_entry_date, cn_action_date, cn_user_login, "
        sql = sql & "cn_user_name, cn_status, cn_schedule_start_date, cn_schedule_end_date, cn_user_contact_id,   "
        sql = sql & "cn_contact_id,  cn_amod_id, cn_user_email, cn_clipri_ID, cn_ym_model_id, cn_yt_id, cn_user_sub_id) "

        sql = sql & "VALUES (" & aclsLocal_Notes.lnote_jetnet_ac_id & ", " & aclsLocal_Notes.lnote_jetnet_comp_id & ","
        sql = sql & " '" & Replace(aclsLocal_Notes.lnote_note, "'", "''") & "',"


        If Not IsNothing(aclsLocal_Notes.lnote_entry_date) Then
          If IsDate(aclsLocal_Notes.lnote_entry_date) Then
            sql = sql & " '" & Year(aclsLocal_Notes.lnote_entry_date) & "-" & Month(aclsLocal_Notes.lnote_entry_date) & "-" & Day(aclsLocal_Notes.lnote_entry_date) & " " & Hour(aclsLocal_Notes.lnote_entry_date) & ":" & Minute(aclsLocal_Notes.lnote_entry_date) & ":" & Second(aclsLocal_Notes.lnote_entry_date) & "', "
          Else
            sql = sql & " '" & Year(Now()) & "-" & Month(Now()) & "-" & Day(Now()) & " " & Hour(Now()) & ":" & Minute(Now()) & ":" & Second(Now()) & "', "
          End If
        Else
          sql = sql & " '" & Year(Now()) & "-" & Month(Now()) & "-" & Day(Now()) & " " & Hour(Now()) & ":" & Minute(Now()) & ":" & Second(Now()) & "', "
        End If

        If Not IsNothing(aclsLocal_Notes.lnote_action_date) Then
          If IsDate(aclsLocal_Notes.lnote_action_date) Then
            sql = sql & " '" & Year(aclsLocal_Notes.lnote_action_date) & "-" & Month(aclsLocal_Notes.lnote_action_date) & "-" & Day(aclsLocal_Notes.lnote_action_date) & " " & Hour(aclsLocal_Notes.lnote_action_date) & ":" & Minute(aclsLocal_Notes.lnote_action_date) & ":" & Second(aclsLocal_Notes.lnote_action_date) & "', "
          Else
            sql = sql & " '" & Year(Now()) & "-" & Month(Now()) & "-" & Day(Now()) & " " & Hour(Now()) & ":" & Minute(Now()) & ":" & Second(Now()) & "', "
          End If
        Else
          sql = sql & " '" & Year(Now()) & "-" & Month(Now()) & "-" & Day(Now()) & " " & Hour(Now()) & ":" & Minute(Now()) & ":" & Second(Now()) & "', "
        End If

        sql = sql & " '" & Trim(HttpContext.Current.Session.Item("localUser").crmUserLogin.ToString) & "', '" & Left(aclsLocal_Notes.lnote_user_name, 50) & "', '" & Left(aclsLocal_Notes.lnote_status, 1) & "', "

        If Not IsNothing(aclsLocal_Notes.lnote_schedule_start_date) Then
          If IsDate(aclsLocal_Notes.lnote_schedule_start_date) Then
            sql = sql & "'" & Year(aclsLocal_Notes.lnote_schedule_start_date) & "-" & Month(aclsLocal_Notes.lnote_schedule_start_date) & "-" & Day(aclsLocal_Notes.lnote_schedule_start_date) & " " & Hour(aclsLocal_Notes.lnote_schedule_start_date) & ":" & Minute(aclsLocal_Notes.lnote_schedule_start_date) & ":" & Second(aclsLocal_Notes.lnote_schedule_start_date) & "',"
          Else
            sql = sql & "NULL,"
          End If
        Else
          sql = sql & "NULL,"
        End If

        If Not IsNothing(aclsLocal_Notes.lnote_schedule_end_date) Then
          If IsDate(aclsLocal_Notes.lnote_schedule_end_date) Then
            sql = sql & "'" & Year(aclsLocal_Notes.lnote_schedule_end_date) & "-" & Month(aclsLocal_Notes.lnote_schedule_end_date) & "-" & Day(aclsLocal_Notes.lnote_schedule_end_date) & " " & Hour(aclsLocal_Notes.lnote_schedule_end_date) & ":" & Minute(aclsLocal_Notes.lnote_schedule_end_date) & ":" & Second(aclsLocal_Notes.lnote_schedule_end_date) & "'"
          Else
            sql = sql & "NULL"
          End If
        Else
          sql = sql & "NULL"
        End If

        sql = sql & ", '" & aclsLocal_Notes.lnote_user_id & "', "
        sql = sql & "  '" & aclsLocal_Notes.lnote_jetnet_contact_id & "', '" & aclsLocal_Notes.lnote_jetnet_amod_id & "', '" & HttpContext.Current.Session.Item("localUser").crmLocalUserName.ToString & "', "
        sql = sql & "'" & aclsLocal_Notes.lnote_clipri_ID & "'," & aclsLocal_Notes.lnote_jetnet_yacht_model_id & ", " & aclsLocal_Notes.lnote_jetnet_yacht_id & ", " & HttpContext.Current.Session.Item("localUser").crmSubSubID.ToString & ")"


        SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString
        SqlConn.Open()
        SqlCommand.Connection = SqlConn

        SqlCommand.CommandText = sql

        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Insert_StandardCloudNote(ByVal aclsLocal_Notes As clsLocal_Notes) As Integer</b><br />" & sql



        SqlCommand.ExecuteNonQuery()

        returned_id = 1



      End If
    Catch ex As Exception
      Insert_StandardCloudNote = Nothing
      Me.class_error = "Error in Insert_StandardCloudNote(ByVal aclsLocal_Notes As clsLocal_Notes) As Integer  " & ex.Message
    Finally
      SqlConn.Dispose()
      SqlConn.Close()

      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try
    Return returned_id
  End Function

  Public Function UpdateStandardCloudNoteForUser(ByVal aclsLocal_Notes As clsLocal_Notes) As Boolean
    Dim atemptable As New DataTable
    Dim sql As String = ""
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim returnVar As Boolean = False
    Try
      If HttpContext.Current.Session.Item("localSubscription").crmCloudNotesDBName.ToString <> "" Then
        sql = " update " & HttpContext.Current.Session.Item("localSubscription").crmCloudNotesDBName.ToString
        sql = sql & " set cn_ac_id = " & aclsLocal_Notes.lnote_jetnet_ac_id & ","

        sql = sql & " cn_comp_id = " & aclsLocal_Notes.lnote_jetnet_comp_id & ","

        sql = sql & " cn_notes = '" & Replace(aclsLocal_Notes.lnote_note, "'", "''") & "',"


        If Not IsNothing(aclsLocal_Notes.lnote_entry_date) Then
          If IsDate(aclsLocal_Notes.lnote_entry_date) Then
            sql = sql & " cn_entry_date = '" & Year(aclsLocal_Notes.lnote_entry_date) & "-" & Month(aclsLocal_Notes.lnote_entry_date) & "-" & Day(aclsLocal_Notes.lnote_entry_date) & " " & Hour(aclsLocal_Notes.lnote_entry_date) & ":" & Minute(aclsLocal_Notes.lnote_entry_date) & ":" & Second(aclsLocal_Notes.lnote_entry_date) & "', "
          Else
            sql = sql & " cn_entry_date = '" & Year(Now()) & "-" & Month(Now()) & "-" & Day(Now()) & " " & Hour(Now()) & ":" & Minute(Now()) & ":" & Second(Now()) & "', "
          End If
        Else
          sql = sql & " cn_entry_date = '" & Year(Now()) & "-" & Month(Now()) & "-" & Day(Now()) & " " & Hour(Now()) & ":" & Minute(Now()) & ":" & Second(Now()) & "', "
        End If

        If Not IsNothing(aclsLocal_Notes.lnote_action_date) Then
          If IsDate(aclsLocal_Notes.lnote_action_date) Then
            sql = sql & " cn_action_date = '" & Year(aclsLocal_Notes.lnote_action_date) & "-" & Month(aclsLocal_Notes.lnote_action_date) & "-" & Day(aclsLocal_Notes.lnote_action_date) & " " & Hour(aclsLocal_Notes.lnote_action_date) & ":" & Minute(aclsLocal_Notes.lnote_action_date) & ":" & Second(aclsLocal_Notes.lnote_action_date) & "', "
          Else
            sql = sql & " cn_action_date = '" & Year(Now()) & "-" & Month(Now()) & "-" & Day(Now()) & " " & Hour(Now()) & ":" & Minute(Now()) & ":" & Second(Now()) & "', "
          End If
        Else
          sql = sql & " cn_action_date = '" & Year(Now()) & "-" & Month(Now()) & "-" & Day(Now()) & " " & Hour(Now()) & ":" & Minute(Now()) & ":" & Second(Now()) & "', "
        End If

        sql = sql & " cn_clipri_ID = '" & aclsLocal_Notes.lnote_notecat_key & "', cn_status = '" & Left(aclsLocal_Notes.lnote_status, 1) & "', "

        If Not IsNothing(aclsLocal_Notes.lnote_schedule_start_date) Then
          If IsDate(aclsLocal_Notes.lnote_schedule_start_date) Then
            sql = sql & " cn_schedule_start_date = '" & Year(aclsLocal_Notes.lnote_schedule_start_date) & "-" & Month(aclsLocal_Notes.lnote_schedule_start_date) & "-" & Day(aclsLocal_Notes.lnote_schedule_start_date) & " " & Hour(aclsLocal_Notes.lnote_schedule_start_date) & ":" & Minute(aclsLocal_Notes.lnote_schedule_start_date) & ":" & Second(aclsLocal_Notes.lnote_schedule_start_date) & "',"
          Else
            sql = sql & "cn_schedule_start_date = NULL,"
          End If
        Else
          sql = sql & "cn_schedule_start_date = NULL,"
        End If

        If Not IsNothing(aclsLocal_Notes.lnote_schedule_end_date) Then
          If IsDate(aclsLocal_Notes.lnote_schedule_end_date) Then
            sql = sql & " cn_schedule_end_date = '" & Year(aclsLocal_Notes.lnote_schedule_end_date) & "-" & Month(aclsLocal_Notes.lnote_schedule_end_date) & "-" & Day(aclsLocal_Notes.lnote_schedule_end_date) & " " & Hour(aclsLocal_Notes.lnote_schedule_end_date) & ":" & Minute(aclsLocal_Notes.lnote_schedule_end_date) & ":" & Second(aclsLocal_Notes.lnote_schedule_end_date) & "'"
          Else
            sql = sql & " cn_schedule_end_date = NULL"
          End If
        Else
          sql = sql & " cn_schedule_end_date = NULL"
        End If
        sql = sql & ", cn_yt_id = " & aclsLocal_Notes.lnote_jetnet_yacht_id & " "
        sql = sql & ", cn_ym_model_id = " & aclsLocal_Notes.lnote_jetnet_yacht_model_id & " "

        sql = sql & ", cn_user_contact_id = '" & aclsLocal_Notes.lnote_user_id & "' "
        sql = sql & ", cn_user_name = '" & Left(aclsLocal_Notes.lnote_user_name, 50) & "', "
        sql = sql & " cn_contact_id = " & aclsLocal_Notes.lnote_jetnet_contact_id & " "
        sql = sql & ", cn_amod_id = " & aclsLocal_Notes.lnote_jetnet_amod_id & ""

        sql = sql & " where (cn_id = " & aclsLocal_Notes.lnote_id & ")  "

        'Editing 3/27/15.
        'We need to remove the cn_user_login if the user is administrator.
        'if they aren't administrator, then go ahead and continue on as normal.
        'This will allow administrators (only) to edit other users (under their subscriptions) notes.
        If HttpContext.Current.Session.Item("localUser").crmUserType = eUserTypes.ADMINISTRATOR Then
          'Purposely nothing here.
        Else
          sql = sql & " and (cn_user_login = '" & Trim(HttpContext.Current.Session.Item("localUser").crmUserLogin.ToString) & "') "
        End If

        ' sql = sql & " (cn_user_sub_id =  " & HttpContext.Current.Session.Item("localUser").crmSubSubID.ToString & ")"


        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>UpdateStandardCloudNoteForUser(ByVal aclsLocal_Notes As clsLocal_Notes) As Boolean</b><br />" & sql


        SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString
        SqlConn.Open()
        SqlCommand.Connection = SqlConn

        SqlCommand.CommandText = sql

        SqlCommand.ExecuteNonQuery()


        returnVar = True

      End If

      Return returnVar
    Catch ex As Exception
      UpdateStandardCloudNoteForUser = Nothing
      Me.class_error = "Error in UpdateStandardCloudNoteForUser(ByVal aclsLocal_Notes As clsLocal_Notes) As Boolean  " & ex.Message
    Finally
      SqlConn.Dispose()
      SqlConn.Close()

      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function

  Public Function Delete_StandardCloudNote(ByVal aclsLocal_Notes As clsLocal_Notes) As Boolean
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim atemptable As New DataTable
    Dim sql As String = ""
    Dim returnVar As Boolean = False
    Try
      If HttpContext.Current.Session.Item("localSubscription").crmCloudNotesDBName.ToString <> "" Then
        sql = "DELETE FROM " & HttpContext.Current.Session.Item("localSubscription").crmCloudNotesDBName.ToString & " "
        sql = sql & " where (cn_id = " & aclsLocal_Notes.lnote_id & ") "

        'Editing 3/27/15.
        'We need to remove the cn_user_login if the user is administrator.
        'if they aren't administrator, then go ahead and continue on as normal.
        'This will allow administrators (only) to remove other users (under their subscriptions) notes.
        If HttpContext.Current.Session.Item("localUser").crmUserType = eUserTypes.ADMINISTRATOR Then
          'Purposely nothing here.
        Else
          sql = sql & " and (cn_user_login = '" & Trim(HttpContext.Current.Session.Item("localUser").crmUserLogin.ToString) & "') "
        End If

        'sql = sql & " and (cn_user_sub_id =  " & HttpContext.Current.Session.Item("localUser").crmSubSubID.ToString & ")"

        HttpContext.Current.Session.Item("localUser").crmUser_DebugText += "<br /><br /><b>Delete_StandardCloudNote(ByVal aclsLocal_Notes As clsLocal_Notes) As Boolean</b><br />" & sql

        SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetCloudNotesDatabase").ToString
        SqlConn.Open()
        SqlCommand.Connection = SqlConn

        SqlCommand.CommandText = sql

        SqlCommand.ExecuteNonQuery()


        returnVar = True
      End If
      Return returnVar
    Catch ex As Exception
      Delete_StandardCloudNote = Nothing
      Me.class_error = "Error in Delete_StandardCloudNote(ByVal aclsLocal_Notes As clsLocal_Notes) As Boolean  " & ex.Message
    Finally
      SqlConn.Dispose()
      SqlConn.Close()

      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try


  End Function
#End Region

  Public Shared Function Check_Sub_Info_For_Export(ByVal sub_id As Long, ByVal sub_login As String) As Boolean
    Check_Sub_Info_For_Export = False

    Dim text_to_display_for_title As String = "Users Logged In"
    Dim select_query As String = ""

    Dim SqlException As System.Data.SqlClient.SqlException : SqlException = Nothing
    Dim SqlConn As New System.Data.SqlClient.SqlConnection
    Dim SqlCommand As New System.Data.SqlClient.SqlCommand
    Dim es As System.Data.SqlClient.SqlDataReader : es = Nothing
    Dim jetnet_count As Integer = 0
    Dim demo_count As Integer = 0
    Dim new_total_count As Integer = 0
    Dim customer_total As Integer = 0
    Dim temp_string As String = ""


    Dim jetnet_user_conn As String = My.Settings.DEFAULT_LIVE_MSSQL_DEBUG


    Dim master_user_conn2 As String
    '  If InStr(HttpContext.Current.Server.MapPath(""), "C:\inetpub\wwwroot\CRM_EVO") > 0 Then
    master_user_conn2 = HttpContext.Current.Application.Item("crmMasterDatabase")
    ' Else
    'master_user_conn2 = My.Settings.DEFAULT_LIVE_MYSQL
    'End If


    Try



      SqlConn.ConnectionString = jetnet_user_conn

      SqlConn.Open()

      SqlCommand.Connection = SqlConn
      SqlCommand.CommandType = System.Data.CommandType.Text
      SqlCommand.CommandTimeout = 60

      '-- ********************************************************* 
      select_query = "SELECT sublogin_demo_flag, sublogin_allow_export_flag  "
      select_query = select_query & " FROM Subscription WITH(NOLOCK) "
      select_query = select_query & " INNER JOIN Subscription_Login WITH(NOLOCK) ON (sublogin_sub_id = sub_id) "
      select_query = select_query & " INNER JOIN Subscription_Install WITH(NOLOCK) ON (subins_sub_id = sub_id) and sublogin_login = subins_login "
      select_query = select_query & " INNER JOIN Company WITH(NOLOCK) ON (comp_id = sub_comp_id) and comp_journ_id = 0 "
      select_query = select_query & " INNER JOIN Contact WITH(NOLOCK) ON (contact_comp_id = sub_comp_id) and subins_contact_id = contact_id and contact_journ_id = 0 "
      select_query = select_query & " WHERE sublogin_demo_flag = 'N' and sublogin_allow_export_flag ='Y'  "
      select_query = select_query & " and sub_id = " & sub_id & " and sublogin_login = '" & sub_login & "' "

      '**********************************************************************************************	
      ' ---------------------------------------------------------------------------------------------	


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, "clsData_Manager_SQL.vb", select_query.ToString)

      SqlCommand.CommandText = select_query
      es = SqlCommand.ExecuteReader()

      If es.HasRows Then
        Do While es.Read
          Check_Sub_Info_For_Export = True
        Loop
      Else
        Check_Sub_Info_For_Export = False
      End If
      es.Close()



    Catch ex As Exception

    Finally
      SqlConn.Close()
      SqlConn.Dispose()
      SqlCommand.Dispose()

      SqlCommand = Nothing
      SqlConn = Nothing
    End Try



  End Function

  Public Function Find_Client_Analysis_Note(ByVal ac_id As Long, ByVal note_id As Long, ByVal open_or_closed As String, ByVal jetnet_ac_id As Long) As DataTable

    Dim MySqlConn As New MySql.Data.MySqlClient.MySqlConnection
    Dim MySqlCommand As New MySql.Data.MySqlClient.MySqlCommand
    Dim MySqlReader As MySql.Data.MySqlClient.MySqlDataReader : MySqlReader = Nothing
    Dim MySqlException As MySql.Data.MySqlClient.MySqlException : MySqlException = Nothing
    Try
      Find_Client_Analysis_Note = Nothing
      Dim qry As String = ""
      Dim aDataTable As New DataTable

      qry = "select * from client_value_comparables "
      qry = qry & " where clival_note_id = " & note_id

      If ac_id > 0 Then
        qry = qry & " and clival_client_ac_id = " & ac_id
      Else
        qry = qry & " and clival_jetnet_ac_id = " & jetnet_ac_id
      End If


      qry = qry & " and clival_type = '" & open_or_closed & "' "


      Dim aTempTable As New DataTable
      MySqlConn.ConnectionString = Me.client_DB
      MySqlConn.Open()
      MySqlCommand.Connection = MySqlConn
      MySqlCommand.CommandType = CommandType.Text
      MySqlCommand.CommandTimeout = 60

      Dim sQuery As String = qry
      MySqlCommand.CommandText = sQuery


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, sQuery.ToString)


      MySqlReader = MySqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      Try
        aTempTable.Load(MySqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = aTempTable.GetErrors()
      End Try

      Find_Client_Analysis_Note = aTempTable

    Catch ex As Exception
      Find_Client_Analysis_Note = Nothing
      Me.class_error = "Error in Find_Client_Analysis_Note " & ex.Message
    Finally
      MySqlReader.Close()
      MySqlReader = Nothing

      MySqlConn.Close()
      MySqlConn.Dispose()
      MySqlConn = Nothing

      MySqlCommand.Dispose()
      MySqlCommand = Nothing
    End Try
  End Function


  Public Function GET_All_Client_Notes(ByVal subscription_id As Long, ByVal subscription_login As String, ByVal subscription_sequence As Long) As DataTable
    Dim jetnet_query As String = ""
    Dim temptable As New DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlCommand As New SqlClient.SqlCommand
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim return_id As Integer = 0
    Try
      SqlConn.ConnectionString = JETNET_DB
      SqlConn.Open()
      SqlCommand.Connection = SqlConn


      jetnet_query = ""
      jetnet_query = " select * from local_notes  "

      jetnet_query &= " where lnote_user_login = '" & subscription_login & "' "
      ' jetnet_query &= " and lnote_user_login = '" & subscription_login & "' "
      ' jetnet_query &= " and lnote_user_login = '" & subscription_login & "' "

      '()"
      ' jetnet_query &= "subscription_login"
      '  jetnet_query &= " subscription_sequence()"

      jetnet_query &= " order by lnote_entry_date desc"

      SqlCommand.CommandText = jetnet_query
      SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)
      SqlCommand.CommandType = CommandType.Text
      SqlCommand.CommandTimeout = 60


      clsGeneral.clsGeneral.Build_Debug_Text(System.Reflection.MethodBase.GetCurrentMethod().Name.ToString, Me.GetType().FullName, jetnet_query.ToString)

      Try
        temptable.Load(SqlReader)
      Catch constrExc As System.Data.ConstraintException
        Dim rowsErr As System.Data.DataRow() = temptable.GetErrors()
      End Try

      SqlReader.Close()
      SqlReader = Nothing

      Return temptable
    Catch ex As Exception
      GET_All_Client_Notes = Nothing
      Me.class_error = "Error in ListAll_Subscription_Install_Saved_Exports: SQL VERSION " & ex.Message
    Finally
      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing

      SqlCommand.Dispose()
      SqlCommand = Nothing
    End Try

  End Function

  Public Function is_aerodex_insight() As Boolean

    '  If HttpContext.Current.Session.Item("jetnetWebSiteType") = eWebSiteTypes.TEST Or HttpContext.Current.Session.Item("jetnetWebSiteType") = eWebSiteTypes.LOCAL Then
    If (HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = True And HttpContext.Current.Session.Item("localSubscription").crmFrequency = "Live") Or (HttpContext.Current.Session.Item("localSubscription").crmAerodexFlag = False) Then
      'If HttpContext.Current.Session.Item("localSubscription").crmFrequency = "Live" Then
      is_aerodex_insight = True
      'End If
    End If

  End Function

  Public Function GET_MTREND_CHANGES(ByVal amod_id As Long, ByVal date_search As Long, Optional ByVal amod_id_list As String = "") As DataTable
    Dim SqlConn As New SqlClient.SqlConnection
    Dim SqlReader As SqlClient.SqlDataReader
    Dim SqlException As SqlClient.SqlException : SqlException = Nothing
    Dim TempTable As New DataTable
    Dim query As String = ""
    Dim temp_date As String = ""

    Try

      If amod_id <> 0 Or Trim(amod_id_list) <> "" Then

        'Opening Connection
        SqlConn.ConnectionString = HttpContext.Current.Session.Item("jetnetClientDatabase").ToString
        SqlConn.Open()

        query = ""
        query &= " select mtrend_year,  mtrend_month, "
        query &= " case when mtrend_year = YEAR(dateadd(m, -1, GETDATE())) and mtrend_month = MONTH(dateadd(m, -1, GETDATE()))  then 'LAST MONTH'"
        query &= " when mtrend_year = YEAR(dateadd(YYYY, -1, GETDATE())) and mtrend_month = MONTH(dateadd(YYYY, -1, GETDATE())) then '1 YEAR AGO' "
        query &= " when mtrend_year = YEAR(dateadd(YYYY, -2, GETDATE())) and mtrend_month = MONTH(dateadd(YYYY, -2, GETDATE())) then '2 YEARS AGO' "
        query &= " when mtrend_year = YEAR(dateadd(YYYY, -3, GETDATE())) and mtrend_month = MONTH(dateadd(YYYY, -3, GETDATE())) then '3 YEARS AGO' "
        query &= " when mtrend_year = YEAR(dateadd(m, -3, GETDATE())) and mtrend_month = MONTH(dateadd(m, -3, GETDATE())) then '3 MONTHS AGO' "
        query &= " when mtrend_year = YEAR(dateadd(m, -6, GETDATE())) and mtrend_month = MONTH(dateadd(m, -6, GETDATE())) then '6 MONTHS AGO' "
        query &= " when mtrend_year = YEAR(dateadd(m, -9, GETDATE())) and mtrend_month = MONTH(dateadd(m, -9, GETDATE())) then '9 MONTHS AGO' "
        query &= " end as THELABEL,"
        query &= " mtrend_total_aircraft_for_sale as FORSALE, "
        query &= " mtrend_sold_total_count as NUMSOLD,"
        query &= " mtrend_avg_asking_price as AVGASKPRICE,"
        query &= " mtrend_avg_selling_price as AVGSALEPRICE,"
        query &= " mtrend_avg_market_days as AVGDAYSONMARKET,  AC14.ac14_forsale_avg_dom as AVGDOM,  "
        query &= " mtrend_lifecycle_3_count as IN_OP_COUNT "
        query &= " from Aircraft_Model_Trend with (NOLOCK)"
        query &= "  INNER JOIN star_reports.dbo.Aircraft_14 AS AC14 ON AC14.ac14_amod_id = mtrend_amod_id AND YEAR(AC14.ac14_start_date) = mtrend_year AND MONTH(AC14.ac14_start_date) = mtrend_month "

        If Trim(amod_id_list) <> "" And amod_id = 0 Then
          query &= "  where mtrend_amod_id in ( " & amod_id_list & ") "
        Else
          query &= "  where mtrend_amod_id = " & amod_id & " "
        End If



        query &= " and ("
        'query &= " (mtrend_year = YEAR(GETDATE()-30) and mtrend_month = MONTH(GETDATE()-30))"
        '  query &= " OR"
        query &= " (mtrend_year = YEAR(dateadd(m, -" & date_search & ", GETDATE())) and mtrend_month = MONTH(dateadd(m, -" & date_search & ", GETDATE())))"
        query &= " )"

        temp_date = DateAdd(DateInterval.Month, -date_search, Date.Now())

        query &= " and ((mtrend_year >= '" & Year(temp_date) & "' and mtrend_month >= '" & Month(temp_date) & "') or mtrend_year >= '" & Year(Date.Now()) & "') "

        query &= " order by mtrend_year, mtrend_month"

        Dim SqlCommand As New SqlClient.SqlCommand(query, SqlConn)
        SqlReader = SqlCommand.ExecuteReader(CommandBehavior.CloseConnection)

        Try
          TempTable.Load(SqlReader)
        Catch constrExc As System.Data.ConstraintException
          Dim rowsErr As System.Data.DataRow() = TempTable.GetErrors()
        End Try

        SqlCommand.Dispose()
        SqlCommand = Nothing
      End If




    Catch ex As Exception
      GET_MTREND_CHANGES = Nothing
      'Me.class_error = "Error in GetAircraftStartingTable(ByVal amod_id As Long) As DataTable SQL VERSION: " & ex.Message
    Finally
      SqlReader = Nothing

      SqlConn.Dispose()
      SqlConn.Close()
      SqlConn = Nothing


    End Try
    Return TempTable
  End Function

  Public Shared Function get_site_name() As String
    Dim temp_link As String = ""
    Try

      temp_link = HttpContext.Current.Request.Url.AbsoluteUri.ToString

      If InStr(temp_link, "//") > 0 Then
        temp_link = Left(Trim(temp_link), InStr(Trim(temp_link), ".com") + 3)
      End If

      If HttpContext.Current.Session.Item("jetnetWebSiteType") = eWebSiteTypes.LOCAL Or
        HttpContext.Current.Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CUSTOMER_CENTER Or
        HttpContext.Current.Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.HOMEBASE Or
        HttpContext.Current.Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.ABI Or
        HttpContext.Current.Session.Item("jetnetAppVersion") = Constants.ApplicationVariable.CRM Then
        temp_link = "https://www.jetnetevolution.com"
      End If
    Catch ex As Exception

    End Try

    Return temp_link

  End Function

  Public Function BuildPhoneQueryForCompanySearch(ByVal CompanyPhoneNumber As String, ByVal CompanyFieldName As String) As String
    Dim Query_Where As String = ""
    If InStr(CompanyPhoneNumber, "*") = 0 Then
      Query_Where += " " & CompanyFieldName & " " & clsGeneral.clsGeneral.PrepQueryString("Begins With", CompanyPhoneNumber, "String", False, CompanyFieldName, True)
    Else
      Query_Where += " " & clsGeneral.clsGeneral.PrepQueryString("Begins With", CompanyPhoneNumber, "String", False, CompanyFieldName, True)
    End If

    Return Query_Where
  End Function

End Class
